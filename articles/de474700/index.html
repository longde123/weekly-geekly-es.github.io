<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚞 🤸🏽 🤵🏼 Cloud Smart Home. Teil 2: Cloud-Service 🎣 👏🏼 👨🏻‍🍳</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich setze die Serie von drei Artikeln über das Cloud Smart Home fort. 

 In einem früheren Artikel wurden Geräte zum Erfassen eines Smart Homes sowie ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cloud Smart Home. Teil 2: Cloud-Service</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474700/"><img src="https://habrastorage.org/webt/iq/e3/kt/iqe3kte_k_di5dqmevpvprwojee.jpeg" alt="Bild"><br><br>  Ich setze die Serie von drei Artikeln über das Cloud Smart Home fort. <br><br>  In einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">früheren Artikel</a> wurden Geräte zum Erfassen eines Smart Homes sowie Algorithmen zum Umwandeln von Sensordaten in Steuerbefehle für ausführende Geräte betrachtet.  Die Hauptkomponente eines Smart Homes ist ein Controller, der die meiste Zeit autonom gemäß der in der Einrichtungsphase festgelegten Logik arbeitet.  An die Steuerung sind verschiedene Geräte (IP-Kameras, Sensoren, Aktoren) angeschlossen, die die von diesen Geräten empfangenen Daten an die Cloud senden. <br><br>  Lassen Sie uns nun über die Architektur eines Cloud-Dienstes zum Speichern und Verarbeiten von Informationen von Sensoren und Kameras sprechen. <br><a name="habracut"></a><br><h2>  Vorteile des Cloud-Service </h2><br>  Ein Smart-Home-Cloud-Dienst bietet eine einfache, flexible und kostengünstige Möglichkeit zum Speichern und Zugreifen auf Daten, die von Smart-Home-Geräten empfangen werden.  Der Benutzer des Cloud-Dienstes muss sich nicht um die Sicherheit seiner Daten kümmern.  Die Funktionen eines Multiprozessor-Medienservers, der mit einem Festplattenkorb mit einem RAID-Array von mehreren 10 bis 12 TB-Laufwerken ausgestattet ist, übersteigen die Kapazität einer SD- oder Flash-Karte in einem Smart Home-Controller bei weitem.  Darüber hinaus sind Speicherkarten unzuverlässig, da sie eine begrenzte Anzahl von Umschreibzyklen aufweisen und häufig ausfallen.  Die Tiefe der Datenspeicherung in der Cloud wird durch den Tarif des Benutzers bestimmt und kann einfach in seinem persönlichen Konto konfiguriert werden. <br><br>  Für den Zugriff auf die Daten ist keine „Portweiterleitung“ auf dem Router des Benutzers erforderlich, wenn Smart-Home-Geräte durch das NAT-Protokoll vor externen Netzwerken verborgen sind.  In Ihrem persönlichen Konto, auf das Sie über mobile Geräte zugreifen können, können Sie die Konfiguration und Logik des Smart Homes einfach konfigurieren. <br><br>  Es ist praktisch, Daten nicht nur in der Cloud zu speichern, sondern auch zu verarbeiten, um dem Benutzer Statistiken für verschiedene Zeiträume zur Verfügung zu stellen.  Im Folgenden wird ein Beispiel für die Berechnung der durchschnittlichen Raumtemperatur pro Woche anhand von Multisensormessungen betrachtet. <br><br><h2>  Cloud-Service-Architektur </h2><br>  In einem früheren Artikel haben wir über einen Smart-Home-Controller gesprochen, der auf der Benutzerseite installiert ist und über verschiedene Protokolle mit einem Cloud-Dienst interagiert: <br><br><ul><li>  MQTT wird zum Austauschen von JSON-Nachrichten zwischen dem Controller und dem Business Logic Server verwendet. </li><li>  HTTP, um die IP-Adresse des am wenigsten belasteten Medienservers vom Load Balancer des Medienserver-Clusters abzurufen. </li><li>  RTMP zum Übertragen des H.264 + AAC-Streams auf den Medienserver. </li></ul><br>  Nun werden wir den Cloud-Service eines Smart Homes betrachten - die Hauptkomponenten, aus denen er besteht, und wie die Interaktion mit dem Smart Home-Controller erfolgt. <br><br> <a href=""><img src="https://habrastorage.org/webt/os/bd/xi/osbdxiktvu-cla3sizuxjoaxbfu.png"></a> <br>  <font color="grey">(Klicken Sie auf das Bild, um es in höherer Auflösung zu öffnen.)</font> <br><br>  <b>Der Business Logic Server</b> ist ein Schlüsselelement im gesamten Schema des Informationsaustauschs innerhalb des Cloud-Dienstes.  Der Hauptzweck besteht darin, verschiedene Serversubsysteme über die RESTful-API-Schnittstellen zu verwalten.  Es implementiert die Logik des Cloud-Dienstes basierend auf <b>dem Benutzermodell</b> : Aufzeichnen eines Videoarchivs und Sensormessungen in Abhängigkeit vom ausgewählten Tarif, Interaktion zwischen dem Benutzer und dem Smart Home-Controller usw. <br><br>  <b>Der MQTT-Broker wird</b> für den Austausch von JSON-Nachrichten zwischen den auf der Clientseite installierten Smart Home-Controllern und dem Business Logic Server benötigt.  Clients abonnieren Themen innerhalb des Brokers, die als Nachrichtenkanäle dienen.  Als MQTT-Broker wird <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Eclipse Mosquitto verwendet</a> . <br><br>  <b>Ein Medienserver-Cluster</b> ist ein verteiltes System zum Speichern, Verarbeiten, Suchen und Wiedergeben von Videoinformationen für IP-Kameras eines bewölkten Smart Homes.  Ein spezieller Load Balancer sammelt Informationen über die aktuelle Leistung jedes Servers im Cluster, berechnet die geringste Belastung und meldet seine IP-Adresse an den Smart Home Controller, der das Video von den Kameras an diesen überträgt. <br><br>  <b>Eine Cloud-Datenbank wird</b> benötigt, um das Benutzermodell des Cloud-Dienstes, die Konfiguration und den aktuellen Status seiner Geräte sowie Metainformationen zu den Videoarchiveinträgen zu speichern.  Als Implementierung der Cloud-Datenbank wird das MySQL-DBMS verwendet. <br><br>  <b>Touch Database</b> ist eine nicht relationale NoSQL-Datenbank.  Es speichert Ereignisse und Messungen von Smart-Home-Sensoren, geordnet nach Zeit.  Die Verwendung von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">InfluxDB</a> DBMS, das für die Arbeit mit dieser Art von Daten optimiert ist, verbessert die Leistung des Cloud-Dienstes erheblich. <br><br>  <b>Das Backend der Clientanwendung</b> ist eine Serveranwendung, deren Hauptfunktion darin besteht, von der Cloud- und Touch-Datenbank empfangene Daten in einem praktischen Format für die spätere Anzeige durch die Clientanwendung auf dem Gerät des Benutzers bereitzustellen.  Das Backend generiert außerdem Steuerbefehle im JSON-Format für den Smart Home-Controller.  Das Backend basiert auf dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Laravel</a> PHP Framework.  Dies wird im nächsten Artikel zu einer Clientanwendung für die Interaktion mit einem Cloud-Smart-Home ausführlicher erläutert. <br><br>  <b>Der Push-Benachrichtigungsanbieter</b> sendet Nachrichten über die Ereignisse des Smart Homes an das mobile Gerät des Benutzers, damit dieser schnell in die Situation eingreifen kann (z. B. wenn ein Wasserleck oder Rauch auftritt, rufen Sie die entsprechenden Antwortdienste an).  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Der OneSignal-</a> Dienst wurde als Anbieter von Push-Benachrichtigungen ausgewählt, der über eine praktische RESTful-API-Schnittstelle und die Funktion zur Identifizierung mobiler Geräte verfügt, die für den ordnungsgemäßen Betrieb von Benachrichtigungen im persönlichen Konto des Benutzers erforderlich sind. <br><br><h2>  Geschäftslogik-Server </h2><br>  Wie bereits erwähnt, ist der Business Logic Server eine Schlüsselkomponente des Cloud Smart Home.  Basierend auf <b>dem Benutzermodell</b> (Informationsbeschreibung des Systembenutzers, einschließlich System-, persönlicher, finanzieller und logischer Funktionen) verwaltet er eine Vielzahl von Diensten in der Cloud, die unterschiedliche Implementierungen und Funktionen aufweisen und über RESTful-API-Schnittstellen miteinander kommunizieren. <br><br><img src="https://habrastorage.org/webt/m0/vl/vj/m0vlvjztjnmvtrckqgvefi2ht80.png"><br><br>  Das Geschäftslogikmodul im Server ist für die folgenden Vorgänge verantwortlich: <br><br><ol><li>  Verwaltung der Speicherung von Messwerten von Sensoren und Ereignissen von Bewegungsmeldern von IP-Kameras eines Smart Homes in einer Touch-Datenbank; </li><li>  Verwalten der Aufzeichnung des Medienstroms der IP-Kamera, die vom Smart-Home-Controller gesendet wird, im Archiv des Medienservers (Konstante / Bewegungsmelder); </li><li>  Übersetzung von Befehlen von der Client-Anwendung zum Smart-Home-Controller; </li><li>  Broadcast der Konfiguration des Smart-Home-Controllers (angeschlossene Geräte, vom Benutzer festgelegte Produktionslogikregeln); </li><li>  Senden von Push-Benachrichtigungen über den Status des Smart Home-Controllers und der angeschlossenen Geräte an die Client-Anwendung. </li></ol><br>  Eine Funktion des Geschäftslogikservers ist die Interprozesskommunikation mit Remoteanwendungen, die auf mehreren Servern im Internet ausgeführt werden.  Die meiste Zeit ist die Business-Logik-Server-Anwendung für E / A-Sperren inaktiv, daher basiert sie auf einer Multithread-Architektur und besteht aus einer Reihe endlicher Unteraufgaben. <br><br>  Um maximale Effizienz zu gewährleisten, sollte die interne Implementierung des Business Logic Servers am einfachsten sein ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">KISS-Prinzip</a> ).  Da das Benutzermodell vollständig deterministisch ist und keine sich ändernden Beziehungen zwischen Attributen enthält, ist kein flexibler Inferenzmechanismus erforderlich (wie bei einem Smart Home-Controller, bei dem die Benutzerlogik vom Benutzer konfiguriert wird).  Daher kann der Betrieb des Geschäftslogikmoduls innerhalb des Servers durch ein herkömmliches algorithmisches Blockdiagramm mit bedingten Übergängen beschrieben werden. <br><br> <a href=""><img src="https://habrastorage.org/webt/fh/xf/70/fhxf703hqjqjjhzg9i_uuxv2qqo.png"></a> <br>  <font color="grey">(Klicken Sie auf das Bild, um es in höherer Auflösung zu öffnen.)</font> <br><br>  Unmittelbar nach dem Start wechselt der Business Logic Server mithilfe der MQTT-Protokolle (von Smart-Home-Controllern) und HTTP (vom Back-End der Client-Anwendung) in den Wartezustand für Nachrichten.  Wenn die Nachricht über HTTP eingeht, bedeutet dies, dass der Benutzer mit der Clientanwendung interagiert und Befehle an den Smart Home-Controller sendet oder dessen Konfiguration aktualisiert.  Damit die Nachricht vom Client in den Smart-Home-Controller <b>gelangt</b> , wird sie vom Business-Logic-Server an das entsprechende Thema des MQTT-Brokers übertragen, für den der Controller abonniert ist ( <b>Unteraufgabe SendGatewayMessage</b> ). <br><br>  In der Initialisierungsphase wartet der Smart Home-Controller darauf, dass der Benutzer ihn in seinem persönlichen Konto registriert.  Daher wird die Unteraufgabe <b>CheckGatewayExistance ausgeführt</b> , die den entsprechenden Status in der MySQL-Cloud-Datenbank überprüft.  Um sich in Ihrem persönlichen Konto zu registrieren, sendet der Controller seine vollständige Konfiguration an den Geschäftslogikserver, der sein Backend an die Clientanwendung ( <b>SendBackend-Unteraufgabe</b> ) <b>sendet</b> , die Konfigurationsdatensätze in der Cloud und in Touch-Datenbanken erstellt und aktualisiert. <br><br>  Wenn der Smart Home-Controller erfolgreich im persönlichen Konto des Benutzers registriert ist, lädt der Geschäftslogikserver das Benutzermodell aus der Cloud-Datenbank in seinen RAM und beginnt mit der Verarbeitung von Nachrichten von IP-Kameras und Z-Wave-Sensoren gemäß dem folgenden Geschäftslogik-Algorithmus. <br><br>  JSON-Nachricht vom Z-Wave-Sensor mit Informationsfeldern: <br><br><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"vendor"</span></span>: <span class="hljs-string"><span class="hljs-string">"*****"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"timestampMs"</span></span>: <span class="hljs-string"><span class="hljs-string">"1571754749561"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"clientType"</span></span>: <span class="hljs-string"><span class="hljs-string">"gateway"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceId"</span></span>: <span class="hljs-string"><span class="hljs-string">"c8e8de37-d301-45f4-ba01-************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceType"</span></span>: <span class="hljs-string"><span class="hljs-string">"sensor"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"zwave"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"messageType"</span></span>: <span class="hljs-string"><span class="hljs-string">"sensorData"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"homeId"</span></span>: <span class="hljs-string"><span class="hljs-string">"0xefa0cfa7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nodeId"</span></span>: <span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sensorType"</span></span>: <span class="hljs-string"><span class="hljs-string">"SENSOR MULTILEVEL"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"label"</span></span>: <span class="hljs-string"><span class="hljs-string">"Temperature"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sensorData"</span></span>: <span class="hljs-string"><span class="hljs-string">"26.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"units"</span></span>: <span class="hljs-string"><span class="hljs-string">"C"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"gatewayId"</span></span>: <span class="hljs-string"><span class="hljs-string">"6774f85a-0a5b-4059-9b68-************"</span></span> }</code> </pre> <br>  Wenn eine Nachricht vom Z-Wave-Sensor über das MQTT-Protokoll eingeht, werden die folgenden Unteraufgaben ausgeführt: <br><br><ul><li>  <b>StoreSensorDataMySQL</b> aktualisiert (UPDATE) einen vorhandenen Datensatz in der MySQL-Cloud-Datenbank, in dem Informationen zum aktuellen Status und zu den Messungen des Sensors gespeichert werden.  Dies ist für eine Clientanwendung erforderlich, die dem Benutzer den aktuellen Status des Smart Homes anzeigt. </li><li>  <b>StoreSensorDataInfluxDB</b> fügt der InfluxDB-Touch-Datenbank einen neuen Datensatz hinzu (INSERT), in dem der Verlauf der Messungen vom Sensor gespeichert wird.  Diese Informationen werden bei der Berechnung statistischer Daten für verschiedene Zeiträume (z. B. Energieverbrauch pro Tag, Monat oder Jahr) verwendet und in der Clientanwendung in Form von Grafiken und Tabellen angezeigt. </li><li>  <b>SendPushNotification</b> generiert eine JSON-Nachricht mit einem Zeitstempel, einem <b>Sensornamen</b> , einer <b>Textbeschreibung</b> des Ereignisses, der Kennung des Smartphones des Benutzers, mit dem er in sein persönliches Konto gegangen ist, der internen Kennung der Anwendung im System des OneSignal-Anbieters.  Darüber hinaus wird diese Nachricht über die RESTful-API <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://onesignal.com/api/v1/notifications</a> an den Push-Benachrichtigungsanbieter gesendet, der sie an das Smartphone des Benutzers übermittelt. </li></ul><br>  Ein Beispiel für eine JSON-Nachricht von einer IP-Kamera mit Informationsfeldern: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"vendor"</span></span>: <span class="hljs-string"><span class="hljs-string">"*****"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"timestampMs"</span></span>: <span class="hljs-string"><span class="hljs-string">"1571753150317"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"clientType"</span></span>: <span class="hljs-string"><span class="hljs-string">"gateway"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceId"</span></span>: <span class="hljs-string"><span class="hljs-string">"1616453d-30cd-44b7-9bf0-************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceType"</span></span>: <span class="hljs-string"><span class="hljs-string">"camera"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"onvif"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"messageType"</span></span>: <span class="hljs-string"><span class="hljs-string">"deviceState"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceState"</span></span>: <span class="hljs-string"><span class="hljs-string">"streamingOn"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"mediaserverIp"</span></span>: <span class="hljs-string"><span class="hljs-string">"***.***.***.***"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applicationName"</span></span>: <span class="hljs-string"><span class="hljs-string">"rtp-live-iot"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"gatewayId"</span></span>: <span class="hljs-string"><span class="hljs-string">"6774f85a-0a5b-4059-9b68-************"</span></span> }</code> </pre><br>  Wenn eine Nachricht über das MQTT-Protokoll von der IP-Kamera eingeht, extrahiert der Geschäftslogikserver ihren Typ aus dem Feld <b>messageType</b> .  Abhängig vom Wert dieses Felds werden die folgenden Aktionen ausgeführt: <br><br><ul><li>  <b>"MessageType": "deviceState"</b> - Die Nachricht enthält Informationen zur Statusänderung der IP-Kamera.  Die Unteraufgabe <b>UpdateCameraState wird ausgeführt</b> und aktualisiert die Informationen in der Cloud-Datenbank.  Wenn das Feld <b>deviceState entweder</b> <b>StreamingOn</b> oder <b>StreamingOff ist</b> (die IP-Kamera sendet / stoppt den Datenstrom an den Medienserver), wird die <b>Unteraufgabe RecordMediaStream ausgeführt</b> , die einen Befehl zum Aktivieren / Deaktivieren des Archivaufzeichnungsmodus generiert und unter Berücksichtigung des Benutzermodells an den Medienserver sendet. </li><li>  <b>"MessageType": "sensorData"</b> - Informationen zum Betrieb des Bewegungsmelders an der IP-Kamera.  Wenn im Benutzermodell der Archivaufzeichnungsmodus auf "vom Bewegungsmelder" eingestellt ist, wird die <b>Unteraufgabe</b> RecordMediaStream <b>ausgeführt</b> .  Als Nächstes werden die <b>Unteraufgaben StoreSensorDataInfluxDB</b> (Speichern des Verlaufs des Detektors in der Touch-Datenbank) und <b>SendPushNotification</b> (Senden von Push-Benachrichtigungen über den Anbieter) ausgeführt. </li><li>  <b>"MessageType": "preview"</b> - Die Nachricht enthält einen Frame eines Miniaturbilds von der IP-Kamera, das regelmäßig an die Cloud gesendet wird.  Die Unteraufgabe <b>StorePreview</b> speichert sie in einer Cloud-Datenbank.  Dann wird es in der Client-Anwendung verwendet, wenn eine Liste von Kameras angezeigt wird. </li><li>  <b>"Nachrichtentyp": "Befehl"</b> - Ein Befehl, der vom Smart Home-Controller gesendet wird, wenn der Benutzer seine Einstellungen über die Webschnittstelle ändert.  Es wird die Unteraufgabe <b>RecordMediaStream ausgeführt</b> , die je nach Benutzermodell den Aufzeichnungsmodus auf dem Medienserver <b>ein- und</b> ausschaltet. </li></ul><br> <a href=""><img src="https://habrastorage.org/webt/8o/_u/gy/8o_ugygyf5hm0nlyd6aw8zwge8s.png"></a> <br>  <font color="grey">(Klicken Sie auf das Bild, um es in höherer Auflösung zu öffnen.)</font> <br><br>  Als Ergebnis der Arbeit des Geschäftslogikmoduls wird eine <b>Aufgabenwarteschlange</b> gebildet - eine Folge von minimalen Codeabschnitten, die unabhängig voneinander ausgeführt werden.  Die Task-Warteschlange wird an den <b>Thread-Pool übergeben</b> , der die Tasks auf die freien Kerne des Zentralprozessors verteilt.  Wenn während der Ausführung eine E / A-Sperre auftritt, wird der Thread angehalten und wechselt in den Ruhezustand. Dadurch wird der Kern des Zentralprozessors freigegeben, sodass der Thread-Pool die sofortige Ausführung der nächsten Task aus der Warteschlange starten kann.  In dem Moment, in dem die E / A-Sperre aufgehoben wird, ändert der blockierte Thread seinen Status und funktioniert weiter, sobald einer der Kerne des Zentralprozessors freigegeben wird. <br><br>  Durch Zerlegen der Geschäftslogikaufgabe in viele separate Unteraufgaben, die gleichzeitig ausgeführt werden, wird somit die Leistung des Geschäftslogikservers erhöht.  Die Systemskalierung wird erreicht, indem die Anzahl der Kerne des Zentralprozessors und die Anzahl der Geschäftslogikserver im System erhöht werden. <br><br>  Die Business Logic Server-Anwendung wurde in C ++ entwickelt und wird als <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">systemd-</a> Dienst des Linux Debian Sarge-Betriebssystems ausgeführt.  Für die zusätzliche Leistungsüberwachung wird das Überwachungssystem zur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Überwachung von</a> Ressourcen verwendet, das den Dienst bei Leistungsproblemen neu startet. <br><br>  Derzeit führt der Cloud-Dienst einen Geschäftslogikserver aus, der auf der virtuellen Yandex. Cloud-Maschine ausgeführt wird.  Parameter der virtuellen Maschine - 4 vCPU-Kerne mit einem garantierten Anteil von 20%, 2 GB RAM, 100 GB Festplatte.  Den Berechnungen zufolge reicht diese Leistung aus, um Nachrichten von ~ 1000 Smart Home-Controllern mit jeweils 3 IP-Kameras und 5 Z-Wave-Sensoren zu verarbeiten (die Berechnungen werden während des Systembetriebs geklärt). <br><br><h2>  Medienserver </h2><br>  Ein Medienserver ist ein dedizierter Server, auf dem spezielle Software installiert ist für: <br><br><ul><li>  Empfangen von Video- und Audiodatenströmen von Codiergeräten unter Verwendung spezialisierter Netzwerkprotokolle; </li><li>  Speichern von Daten in Form von Archivdateien in seinem Dateisystem; </li><li>  Übertragen Sie Informationen aus Archivdateien in einem Standard-Streaming-Format für die Wiedergabe auf Clientgeräten. </li></ul><br>  Die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wowza Streaming Engine 4.7.2</a> mit zusätzlichen Modulen, die in der Java-Sprache entwickelt wurden, wird als Medienserver im Cloud-Smart-Home-System zum Aufzeichnen von Streaming-Daten in ein Dateiarchiv und zum Arbeiten mit einer Cloud-Datenbank verwendet. <br><br> <a href=""><img src="https://habrastorage.org/webt/va/du/c-/vaduc-wwi67k2367aoez0bnqx_s.png"></a> <br>  <font color="grey">(Klicken Sie auf das Bild, um es in höherer Auflösung zu öffnen.)</font> <br><br>  Der Medienstrom vom Smart-Home-Controller im RTMP-Format gelangt in den Medienserver und wird mit Zeitstempeln im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Jitterpuffer abgeglichen</a> .  Dies ist erforderlich, um den Effekt von Netzwerkpaketverzögerungen bei der Übertragung des Datenflusses über das Internet zu kompensieren. <br><br>  Um den Videostream als MP4-Datei im Medienserver-Dateisystem aufzuzeichnen, sendet der Business Logic Server den folgenden Befehl über die RESTful HTTP-API an den Medienserver: <br><br><pre> <code class="json hljs">http://&lt;mediaserverIp&gt;:&lt;port&gt;/v<span class="hljs-number"><span class="hljs-number">2</span></span>/servers/_defaultServer_/vhosts/_defaultVHost_/applications/rtp-live-iot/instances/_definst_/streamrecorders/<span class="hljs-number"><span class="hljs-number">1616453</span></span>d<span class="hljs-number"><span class="hljs-number">-30</span></span>cd<span class="hljs-number"><span class="hljs-number">-44</span></span>b<span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-number"><span class="hljs-number">-9</span></span>bf<span class="hljs-number"><span class="hljs-number">0</span></span>-************ { <span class="hljs-attr"><span class="hljs-attr">"instanceName"</span></span>: <span class="hljs-string"><span class="hljs-string">"_definst_"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fileVersionDelegateName"</span></span>: <span class="hljs-string"><span class="hljs-string">"CustomFileVersionDelegate"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"serverName"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"recorderName"</span></span>: <span class="hljs-string"><span class="hljs-string">"1616453d-30cd-44b7-9bf0-************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentSchedule"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"outputPath"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"currentFile"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applicationName"</span></span>: <span class="hljs-string"><span class="hljs-string">"rtp-live-iot"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fileTemplate"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentationType"</span></span>: <span class="hljs-string"><span class="hljs-string">"SegmentByDuration"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fileFormat"</span></span>: <span class="hljs-string"><span class="hljs-string">"MP4"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"recorderState"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"option"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"currentSize"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentSize"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentDuration"</span></span>: <span class="hljs-string"><span class="hljs-string">"1800000"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"backBufferTime"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"currentDuration"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"startOnKeyFrame"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"recordData"</span></span>: <span class="hljs-string"><span class="hljs-string">"false"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"moveFirstVideoFrameToZero"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"defaultRecorder"</span></span>: <span class="hljs-string"><span class="hljs-string">"false"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"splitOnTcDiscontinuity"</span></span>: <span class="hljs-string"><span class="hljs-string">"false"</span></span> }</code> </pre><br>  Im Feld <b>recorderName</b> wird der Name des Videostreams (IP-Kamera- <b>ID</b> auf dem Smart Home-Controller) im Feld <b>fileVersionDelegateName</b> der Name der geerbten Klasse zur Bestimmung des <b>Ordnerpfads</b> und des Dateinamens angegeben.  Der Java-Klassencode wird in der folgenden Liste angezeigt: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.File; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Calendar; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.TimeZone; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.wowza.wms.livestreamrecord.manager.IStreamRecorder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.wowza.wms.livestreamrecord.manager.IStreamRecorderFileVersionDelegate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.wowza.wms.logging.WMSLoggerFactory; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomFileVersionDelegate</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IStreamRecorderFileVersionDelegate</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFilename</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IStreamRecorder recorder)</span></span></span><span class="hljs-function"> </span></span>{ String sDisk = GetDisk(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sDisk == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { WMSLoggerFactory.getLogger(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>).error(<span class="hljs-string"><span class="hljs-string">"CustomFileVersionDelegate::getFilename(): No drive chosen"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } String sStreamName = recorder.getStreamName(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nCameraId = Integer.parseUnsignedInt(ServiceQueries.GetCameraId(sStreamName)); TimeZone tz = TimeZone.getTimeZone(<span class="hljs-string"><span class="hljs-string">"Europe/Moscow"</span></span>); Calendar now = Calendar.getInstance(tz); String sDirPath = ServerParams.m_sServerContentPath + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + sDisk + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + Integer.toString(nCameraId / <span class="hljs-number"><span class="hljs-number">200</span></span>) + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + sStreamName + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + String.format(<span class="hljs-string"><span class="hljs-string">"%1$tY/%1$tm/%1$td"</span></span>, now); String sFullFilePath = sDirPath + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + sStreamName + <span class="hljs-string"><span class="hljs-string">"_"</span></span> + String.format(<span class="hljs-string"><span class="hljs-string">"%1$tH_%1$tM_%1$tS"</span></span>, now) + <span class="hljs-string"><span class="hljs-string">".mp4"</span></span>; File dirs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(sDirPath); dirs.setExecutable(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); dirs.setWritable(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); dirs.mkdirs(); WMSLoggerFactory.getLogger(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>).info( <span class="hljs-string"><span class="hljs-string">"CustomFileVersionDelegate::getFilename(): Filename created: "</span></span> + sFullFilePath); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sFullFilePath; } }</code> </pre><br>  In der <b>CustomFileVersionDelegate-</b> Klasse ist die virtuelle <b>getFilename-</b> Funktion der <b>IStreamRecorderFileVersionDelegate-</b> Basisklasse <b>überladen</b> , die vom Medienserver aufgerufen wird, bevor der Stream in die Datei geschrieben wird.  Die Funktion erstellt einen Ordner auf der Festplatte mit dem Pfad <b>sDirPath</b> und gibt den vollständigen Pfad zur Datei <b>sFullFilePath zurück</b> . <br><br>  Da das Volumen der Mediendaten sehr groß ist, enthält das Dateisystem mehrere physische Festplatten mit großem Volumen (8 - 12 TB), die als Unterverzeichnisse bereitgestellt werden.  Die Disc mit der größten Menge an freiem Speicherplatz wird während der Aufnahme als Zieldisk ausgewählt.  Für einen optimalen Betrieb des Dateisystems beim Zugriff auf die Datei wird der Pfad zum Zielordner wie folgt gebildet: <br><br><pre> <code class="plaintext hljs">/content/&lt;diskId&gt;/&lt;cameraIdDivideBy200&gt;/&lt;streamUuid&gt;/&lt;year&gt;/&lt;month&gt;/&lt;day&gt;/</code> </pre><br>  wobei <b>diskId</b> die Kennung der Festplatte ist (gemounteter Ordner), <br>  <b>cameraIdDivideBy200</b> - das Ergebnis einer ganzzahligen Division der Kamera- <b>ID</b> durch 200, <br>  <b>streamUuid</b> - Medienstromkennung, <br>  <b>Jahr, Monat, Tag</b> - Jahr, Monat und Tag der Aufnahme. <br><br>  Dies vermeidet eine große Anzahl von Unterordnern innerhalb eines Ordners und dementsprechend einen dramatischen Leistungsabfall des gesamten Dateisystems mit einer Zunahme der Anzahl von IP-Kameras in wolkigen Smart Homes. <br><br>  Informationen über die IP-Adresse des Medienservers, den Pfad zu der Datei mit den Mediendaten, den Beginn und das Ende des Schreibens in die Datei werden in der Cloud-Datenbank gespeichert und von der Client-Anwendung verwendet, um die Archivzeitachse anzuzeigen, auf der das Video ausgewählt und abgespielt werden kann. <br><br>  Um den Videostream abzurufen, greift das Front-End der Clientanwendung auf den Medienserver zu und sendet die folgenden Befehle über das HTTP-Protokoll.  Für einen "Live" -Videostream: <br><br><pre> <code class="plaintext hljs">https://&lt;mediaserverIp&gt;:&lt;port&gt;/rtp-live-iot/&lt;streamUuid&gt;/playlist.m3u8</code> </pre><br>  Für archivierten Videostream: <br><br><pre> <code class="plaintext hljs">https://&lt;mediaserverIp&gt;:&lt;port&gt;/vod/_definst_/mp4:&lt;diskId&gt;/&lt;cameraIdDivideBy200&gt;/&lt;streamUuid&gt;/&lt;year&gt;/&lt;month&gt;/&lt;day&gt;/&lt;fileName&gt;/playlist.m3u8?wowzaplaystart=&lt;offsetMs&gt;&amp;wowzaplayduration=&lt;durationMs&gt;</code> </pre><br>  Dabei ist <b>Dateiname</b> der Name der Archivdatei auf der Festplatte. <br>  <b>offsetMs</b> - Wiedergabeversatz relativ zum Dateianfang in Millisekunden, <br>  <b>durationMs</b> - Dauer der Wiedergabe in Millisekunden. <br><br>  Der Medienserver sendet einen Stream im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">HLS-</a> Format, mit dem Sie H.264 + AAC-Videos in allen modernen Browsern und Mobilgeräten mit iOS- und Android-Betriebssystemen anzeigen können.  Der HLS-Paketierer codiert den Stream in Form separater Chunks und sendet ihn über HTTP als Antwort auf eine Anfrage einer mobilen Anwendung. <br><br>  Um die Speicherkosten und den Zugriff auf Archivdateien zu optimieren, wurde der Cloud-Smart-Home-Medienserver auf der Hardwareplattform Supermicro CSE-825TQ, Motherboard X8DT6, 2xCPU Intel Xeon E5645, 2,4 GHz, 32 GB RAM, 44 TB HDD Adaptec AAC-RAID entwickelt.  Der Medienserver wird als dedizierter Server auf der Hosting-Site installiert und stellt eine Verbindung zum Internetkanal mit einer garantierten Breite von 400 Mbit / s her.  Die Leistung eines Medienservers reicht aus, um Medienströme von ~ 400 IP-Kameras mit dem H.264-Codec, einer Frame-Auflösung von 720p und einer Bitrate von 1 Mbit / s zu verarbeiten. <br><br><img src="https://habrastorage.org/webt/zr/-n/sy/zr-nsyuedb8wtbakou5rzfnsyo8.png"><br><br>  Dementsprechend müssen 3 Medienserver installiert und die Last gleichmäßig auf diese verteilt werden, um Streams von 1000 IP-Kameras verarbeiten zu können.  Hierzu wird ein Load Balancer verwendet, der als separates <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">AddOn-</a> Plugin für den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dynamischen Lastausgleich</a> mit dem Wowza Streaming Engine-Medienserver verbunden ist.  Dies unterscheidet in der Tat den Load Balancer (oder <b>Ursprungsserver</b> ), der regelmäßig die Leistungsmetriken von den endgültigen Medienservern (oder <b>Edgeservern</b> ) empfängt und basierend auf diesen Informationen den am wenigsten belasteten Server im Cluster findet. <br><br>  Der Smart-Home-Controller greift über HTTP auf den Balancer zu und empfängt daraufhin die IP-Adresse dieses Servers, an den der Controller den Medienstrom von der IP-Kamera über RTMP überträgt.  Die Leistungsmetrik umfasst die Anzahl der hergestellten Verbindungen zu Quellen und Verbrauchern von Medienströmen sowie die aktuelle Bandbreite des Internetkanals auf dem Server.  In den Einstellungen des Balancers können Sie auch die Auswahl des Edgeservers unter Berücksichtigung seiner räumlichen Position festlegen. Auf diese Weise können Sie Server in verschiedenen Städten und Ländern hosten, um ein verteiltes Netzwerk für die Bereitstellung von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CDN-</a> Inhalten zu erstellen. <br><br><h2>  Berühren Sie die Datenbank </h2><br>  Wie bereits im vorherigen Artikel erwähnt, werden die Messwerte der Z-Wave-Sensoren sowie der aktuelle Status und die Ereignisse der IP-Kameras vom Smart Home-Controller mithilfe des MQTT-Protokolls im JSON-Format an die Cloud gesendet.  Der Business Logic Server decodiert diese Nachrichten und führt die <b>StoreSensorDataInfluxDB-</b> Subtask aus, die Daten über HTTP an die Touch-Datenbank überträgt. <br><br> <a href=""><img src="https://habrastorage.org/webt/14/lv/rv/14lvrvrra0js_mzifmrwszu9c68.png"></a> <br>  <font color="grey">(Klicken Sie auf das Bild, um es in höherer Auflösung zu öffnen.)</font> <br><br>  Die Cloud-Datenbank des Smart Home basiert auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">InfluxDB 1.7.x</a> - einem Open-Source-Datenbankverwaltungssystem für die Arbeit mit Zeitsequenzen, das in vielen Projekten des Internet der Dinge zum Speichern von Daten von Sensoren und Analysen verwendet wird.  Abfragen an die Touch-Datenbank werden in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">InfluxQL-</a> Sprache ähnlich wie bei herkömmlichem SQL generiert. <br><br>  Die Datenspeicherzeit im Cloud Smart Home wird durch den ausgewählten Tarif gemäß dem Benutzermodell bestimmt.  Aufgrund der erheblichen Unterschiede in der Menge der Videodaten und Sensordaten ist deren Speicherzeit unterschiedlich.  Die Größe des Videoarchivs wird in Tagen (7, 14, 30 Tage mit unterschiedlichen Raten) und die Größe des Sensorarchivs in Jahren (3, 5, 7 Jahre) gemessen.  Daher werden für jeden Smart-Home-Controller, wenn er im persönlichen Konto des Benutzers registriert ist, zwei separate Datenbanken mit unterschiedlichen Aufbewahrungsrichtlinien in der Touch-Datenbank erstellt: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">720</span></span>h SHARD <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>h; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_sensors"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">61320</span></span>h SHARD <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span>h;</code> </pre><br>  Das Backend der Client-Anwendung ist für das Erstellen, Bearbeiten und Löschen der Datenbank in der Touch-Datenbank verantwortlich.  Wenn beispielsweise ein Cloud-Smart-Home-Benutzer den Tarif ändert, sendet das Backend die folgenden Befehle, um Änderungen an der Speicherrichtlinie vorzunehmen: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETENTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">POLICY</span></span> <span class="hljs-string"><span class="hljs-string">"autogen"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">168</span></span>h SHARD <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>h;</code> </pre><br>  Wenn Sie den Smart Home Controller aus dem persönlichen Konto des Benutzers entfernen, löscht das Backend die entsprechenden Datenbanken: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_sensors"</span></span>;</code> </pre><br>  Beim Empfang einer Informationsnachricht vom Smart-Home-Controller führt der Business-Logik-Server eine Anforderung zum Einfügen von Daten in die Touch-Datenbank aus: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> device_20873eb0_dd5e_4213_a175_************,<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=METER,label=Energy,units=kWh value_float=<span class="hljs-number"><span class="hljs-number">0.05</span></span> <span class="hljs-number"><span class="hljs-number">1572194550125</span></span>;</code> </pre><br>  Ein Beispiel für eine Tabelle mit Daten von Z-Wave-Sensoren für einen Smart Home-Controller: <br><br><img src="https://habrastorage.org/webt/bc/ic/ht/bcicht3izpojrvpo2bsp2347p5w.png"><br><br>  Eine der nützlichsten Funktionen eines Cloud-Hauses ist die Berechnung von Statistiken basierend auf den empfangenen Daten.  Der Benutzer muss die durchschnittliche Temperatur im Raum kennen oder wissen, wie viel Strom er pro Monat verbraucht hat. <br><br>  Mit der InfluxQL-Sprache können Sie Abfragen mithilfe von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Analysefunktionen</a> ausführen.  Um beispielsweise die Durchschnittstemperatur für eine Woche zu berechnen, müssen Sie die folgende Abfrage ausführen: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MEAN(<span class="hljs-string"><span class="hljs-string">"value_float"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> device_63c660da_f0e8_4eca_8d5f_************ <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> label = <span class="hljs-string"><span class="hljs-string">'Temperature'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &gt;= <span class="hljs-string"><span class="hljs-string">'2019-10-21T00:00:00.000Z'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &lt;= <span class="hljs-string"><span class="hljs-string">'2019-10-27T23:59:59.999Z'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>d) fill(<span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre><br>  Die Ergebnisse dieser Abfrage werden in der Tabelle angezeigt: <br><br><img src="https://habrastorage.org/webt/ze/ac/wb/zeacwb7cqvnei_raajemgoebauq.png"><br><br>  Im nächsten Artikel, der sich ausschließlich der Client-Anwendung widmet, werden wir die Berechnung von Statistiken für verschiedene Parameter und die darauf basierende Erstellung von Tabellen und Grafiken im Detail betrachten. <br><br>  Im Cloud-Smart-Home-System wird das InfluxDB-DBMS auf einer virtuellen Yandex-Cloud-Maschine mit den folgenden Parametern bereitgestellt: 4 vCPU-Kerne mit einem garantierten Anteil von 20%, 2 GB RAM, 100 GB Festplatte.  Nach den Berechnungen dieser Konfiguration ist es ausreichend, die Sensordaten von 3.000 IP-Kameras und 5.000 Z-Wave-Sensoren 7 Jahre lang zu speichern. <br><br><h2>  Fazit </h2><br>  Der Artikel untersuchte die Architektur eines Cloud-Dienstes für ein Smart Home, den Algorithmus eines Geschäftslogikservers, die Architektur eines Medienservers zum Aufzeichnen, Speichern und Wiedergeben von Medienströmen von IP-Kameras sowie die Architektur einer Touch-Datenbank zum Speichern und Analysieren von Daten von Smart Home-Sensoren.  Das Cloud-Service-System funktioniert sowohl auf dedizierten als auch auf virtuellen Servern und sorgt so für mehr Stabilität auf verschiedenen Hosting-Sites.  Das System wird derzeit getestet. <br><br>  Je älter die in der Cloud gespeicherten Daten sind, desto seltener greift der Benutzer darauf zu.  In der nächsten Version des Cloud-Dienstes wird vorgeschlagen, den Mechanismus der Ausdünnung (oder Überabtastung) von Daten mithilfe von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">InfluxDB Continuous Queries</a> zu verwenden, um die mithilfe von Aggregationsfunktionen gespeicherte Datenmenge zu reduzieren und dadurch die Kapazität der Touch-Datenbank zu erhöhen. <br><br><img src="https://habrastorage.org/webt/4x/s-/jl/4xs-jlindsjesrddtgfb8nbstxu.png"><br><br>  Außerdem wird in der nächsten Version des Cloud-Dienstes ein Cluster von Business-Logik-Servern nach dem in diesem Artikel erläuterten Prinzip eines Clusters von Medienservern implementiert.  Die Abbildung zeigt die Architektur eines solchen Clusters, bei dem mehrere Edgeserver (von denen jeder über einen separaten MQTT-Broker und eine Business Logic Server-Software verfügt) Leistungsmetriken an den Ursprungsserver senden, der die IP-Adresse des am wenigsten belasteten Servers berechnet.  Auf diese Weise können Sie das System in größerem Umfang skalieren und die bestehende Grenze von 1000 Smart Homes überwinden. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de474700/">https://habr.com/ru/post/de474700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de474690/index.html">Erstellen einer Konsole mit variabler Höhe für komfortableres Arbeiten am Computer</a></li>
<li><a href="../de474692/index.html">Skaffold Review für Kubernetes Development</a></li>
<li><a href="../de474694/index.html">Wie wir das Framework für Leistungstests ausgewählt und verdreht haben</a></li>
<li><a href="../de474696/index.html">Ein Ticket für die Ölindustrie oder Rosneft fordert die Seismic Challenge</a></li>
<li><a href="../de474698/index.html">Verwenden von modalen Fenstern in Benutzeroberflächen</a></li>
<li><a href="../de474702/index.html">Funktionale Programmierung aus Sicht von EcmaScript. Reine Funktionen, Lambdas, Immunität</a></li>
<li><a href="../de474704/index.html">Playboy Interview: Steve Jobs, Teil 2</a></li>
<li><a href="../de474706/index.html">TextRadar Fuzzy Search Algorithmus - Grundlegende Ansätze</a></li>
<li><a href="../de474708/index.html">Das Internet ist fragmentierter als je zuvor: Woher kommen täglich mehr als eine Million neue Benutzer? Teil 1</a></li>
<li><a href="../de474710/index.html">c.tech: Frontend Meetup # 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>