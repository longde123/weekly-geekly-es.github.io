<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíº üë©‚Äçüë©‚Äçüëß‚Äçüë¶ üî• Hackeando uma pulseira barata de fitness üö• üõí üñ®Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esta √© uma tradu√ß√£o. Artigo publicado em 27 de maio de 2018 


 Rastreador de fitness antes e depois da desmontagem 

 Quando cheguei √† empresa atual,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hackeando uma pulseira barata de fitness</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413895/">  <font color="gray">Esta √© uma tradu√ß√£o.</font>  <font color="gray"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Artigo</a> publicado em 27 de maio de 2018</font> <br><br><img src="https://habrastorage.org/webt/4n/-9/ah/4n-9ah3fvyxx23aobpo2tvx0jg4.jpeg"><br>  <i><font color="gray">Rastreador de fitness antes e depois da desmontagem</font></i> <br><br>  Quando cheguei √† empresa atual, no primeiro dia, recebi um conjunto de presentes.  Entre eles estava esta pulseira com um rastreador de fitness.  Independentemente do seu amor pelo exerc√≠cio, este √© um gadget incrivelmente legal do ponto de vista puramente t√©cnico: <br><br><ul><li>  um fator de forma realmente pequeno (aproximadamente 15 √ó 40 mm); </li><li>  Baixa energia Bluetooth (BLE); </li><li>  Tela OLED (96 √ó 32 pixels); </li><li>  bateria </li><li>  Carga USB </li><li>  aceler√¥metro; </li><li>  motor de vibra√ß√£o; </li><li>  o pre√ßo √© de cerca de US $ 10 (!). </li></ul><a name="habracut"></a><br>  L√° fora, o √∫nico identificador no painel traseiro √© o adesivo ‚ÄúFCC ID: 2AHFTID115‚Äù.  Se voc√™ pesquisar no Google, ele parece corresponder ao dispositivo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ID115</a> e voc√™ pode at√© encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√°rias fotos de</a> seu interior.  Olhando para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uma dessas fotografias</a> , se voc√™ se esfor√ßar, pode ver o nome do maior circuito integrado (IC): N51822.  Isso sugere que pode haver um microcontrolador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">n√≥rdico</a> (MCU) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nRF51822</a> , um processador ARM M0 de 32 bits com suporte BLE integrado, o que √© teoricamente bastante f√°cil de programar para outras coisas que uma pulseira deve fazer. <br><br>  Antes de desmontar o gadget, fui ao Google um pouco mais e descobri que em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">algumas pulseiras semelhantes</a> o mesmo chip est√° instalado e as pessoas o programaram com sucesso. <br><br>  Abrir o estojo n√£o foi t√£o f√°cil.  A tampa de pl√°stico preta √© colada ao fundo cinza.  Tentei um secador de cabelo para amolecer a cola e pacientemente a cortei com uma faca pequena, tentando n√£o danificar muito o pl√°stico.  Ap√≥s a abertura, verifiquei se realmente existe o nRF51822.  Mais tarde, comprei uma pulseira MCU quase id√™ntica da Texas Instrument.  Lembre-se de que existem op√ß√µes. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/2e6/0af/a75/2e60afa757e9f5859408e49d7f76e54f.jpg"></a> <br>  <i><font color="gray">nRF51822 e caneta esferogr√°fica para balan√ßa</font></i> <br><br><h1>  Encontrar uma maneira de se comunicar </h1><br>  A <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> diz que o chip pode ser programado / depurado usando a interface de dois pinos do ARM <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Serial Wire Debug</a> (SWD).  Se queremos estabelecer um canal de comunica√ß√£o com um chip, isso significa duas coisas: <br><br><ul><li>  Precisamos de um programador SWD (por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Segger J-Link</a> ). </li><li>  N√≥s precisaremos acessar os dois pinos SWD no microcontrolador, a saber SWDIO (dados) e SWDCLK (pulsos de clock). </li></ul><br>  Felizmente, existem v√°rios pain√©is dispon√≠veis no quadro.  Embora sua exist√™ncia seja explicada claramente pela necessidade de depura√ß√£o, teste e verifica√ß√£o, prefiro pensar que algum engenheiro legal os deixou l√° como pequenos presentes para pessoas como n√≥s.  Nem todos eles est√£o devidamente rotulados, por isso sugiro os seguintes c√≥digos: <br><br><img src="https://habrastorage.org/webt/fc/gd/y9/fcgdy9fj-73b3cdtcsbgdqdjovw.jpeg"><br><br><img src="https://habrastorage.org/webt/et/-t/_4/et-t_46am8apprgxc3mtkyyg0gq.jpeg"><br>  <i><font color="gray">Lados dianteiro e traseiro da placa de circuito.</font></i>  <i><font color="gray">Caneta esferogr√°fica para escala e nomes semi-arbitr√°rios para blocos abertos</font></i> <br><br>  Usando o mesmo <a href="">microsc√≥pio USB</a> barato <a href="">,</a> tirei v√°rias fotos da frente e de tr√°s da placa e tentei rastrear as faixas do microcontrolador at√© as almofadas. <br><br><img src="https://habrastorage.org/webt/pc/oe/-h/pcoe-ha9fus65p5oenznunhxx30.jpeg"><br><br><img src="https://habrastorage.org/webt/nk/hy/ed/nkhyedqu2al7dvuxmbqs8ns9g9u.jpeg"><br>  <i><font color="gray">Faixas para os pinos SWDIO e SWDCLK na frente e atr√°s da placa</font></i> <br><br>  Observe que esta √© uma placa de circuito impresso de v√°rias camadas com orif√≠cios passantes, portanto verifique as faixas nos dois lados da placa.  A partir dessas fotos, voc√™ pode acompanhar as faixas dos contatos SWDIO e SWDCLK no chip at√© os blocos IO e CLK.  Portanto, garantiremos que a marca CLK na placa corresponda ao SWDCLK no MCU e o contato n√£o marcado seja o pino SWDIO.  Agora voc√™ pode preparar nossa primeira tabela de mapeamento: <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Parque infantil </th><th>  Descri√ß√£o do produto </th></tr><tr><td>  SWDIO </td><td>  IO </td><td>  Sa√≠da de dados para programa√ß√£o de SWD </td></tr><tr><td>  SWDCLK </td><td>  CLK </td><td>  Sa√≠da de rel√≥gio para programa√ß√£o SWD </td></tr></tbody></table><br><h1>  Cirurgia post-mortem </h1><br>  Tendo obtido acesso a dois blocos de SWD, eu soldava fios muito finos a eles e a todos os outros contatos dispon√≠veis. <br><br> <a href=""><img src="https://habrastorage.org/webt/hf/cm/6j/hfcm6jaswn6gf08oxc8ypaehmtu.jpeg"></a> <br><br><h1>  Pisque um pouco </h1><br>  A pr√≥xima tarefa √© tentar programar o dispositivo para alguma tarefa.  Para executar o programa mais simples, precisamos garantir o seguinte: <br><br><ul><li>  N√≥s rastreamos corretamente os contatos do SWDIO / SWDCLK. </li><li>  O programador SWD est√° em execu√ß√£o e o computador pode emitir comandos. </li><li>  Podemos compilar o programa Arm e usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Nordic SDK</a> corretamente. </li><li>  Podemos exibir o programa compilado no chip. </li><li>  O chip funciona corretamente e carrega o nosso programa. </li></ul><br>  Nesse caso, ‚Äúol√°, mundo‚Äù pode ser um programa que liga e desliga o LED.  E mesmo isso n√£o √© fundamental, porque n√£o h√° LED embutido na placa e, se voc√™ adicionar um externo, ainda precisar√° descobrir com o que conect√°-lo.  Isso adiciona outra dimens√£o ao modelo espacial do problema.  De acordo com a falta de teorema do queijo livre, acabei de conectar dois LEDs aos pinos <code>P1</code> e <code>P2</code> com a esperan√ßa de que pud√©ssemos chegar a esses blocos com o MCU. <br><br> <a href=""><img src="https://habrastorage.org/webt/vj/t0/ab/vjt0abxchpbfjiyq87acqsyq4n4.jpeg"></a> <br>  <i><font color="gray">Dia ruim</font></i> <br><br>  Drivers e programas de linha de comando para o programador J-Link SWD est√£o localizados no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">site da Segger</a> .  Se voc√™ estiver no macOS e estiver usando o Homebrew, procure a f√≥rmula Cask em <code>caskroom/drivers/segger-jlink</code> .  A comunica√ß√£o com o programador SWD √© estabelecida no <code>JLinkExe</code> linha de comando <code>JLinkExe</code> . <br><br>  Ent√£o baixei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Nordic nRF5 SDK</a> (estou usando a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vers√£o 12.3.0</a> ).  A partir dos exemplos do SDK, fica claro que precisamos de um compilador capaz de compilar programas Arm.  Ent√£o eu instalei o <code>gcc-arm-embedded</code> (tamb√©m dispon√≠vel no Homebrew). <br><br>  Depois de examinar a documenta√ß√£o do SDK e os f√≥runs de desenvolvedores n√≥rdicos, descobri que seus SDKs s√£o usados ‚Äã‚Äãcom mais freq√º√™ncia em placas de desenvolvimento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">como essa</a> .  O SDK √© pr√©-configurado para v√°rias variantes dessas placas.  Como estamos em contato direto com o controlador, voc√™ ter√° que configurar alguns par√¢metros do SDK. <br><br>  Passei <i>muito</i> tempo entendendo o ecossistema nRF5, mas no final ainda era capaz de executar o programa em um chip!  O <a href="">v√≠deo</a> mostra dois LEDs piscando.  Nesse ponto, criei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um reposit√≥rio do Github</a> e joguei um programa com um <code>Makefile</code> funcionamento.  Um dos principais segredos foi que, de fato, existem v√°rias op√ß√µes para o nRF51822 e, no meu, existem apenas 16 KB de mem√≥ria.  Ent√£o, eu ainda tinha que <a href="">corrigir o script do vinculador</a> . <br><br><h1>  Entrada / sa√≠da digital </h1><br>  Como eu j√° disse, a tarefa com LEDs piscando forneceu algumas esperan√ßas e um m√©todo de pux√£o, quais dos contatos do MCU levam a <code>P1</code> e <code>P2</code> , onde os LEDs est√£o conectados.  A estrat√©gia mais simples √© conectar todas as sa√≠das e aplicar alta e baixa tens√£o por sua vez.  Para minha surpresa, os dois LEDs acenderam!  Fiquei ainda mais surpreso quando o vibromotor come√ßou a funcionar! <br><br>  Portanto, o m√©todo poke adicionado √† tabela: <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Parque infantil </th><th>  Descri√ß√£o do produto </th></tr><tr><td>  P0.30 </td><td>  P1 </td><td>  GPIO digital </td></tr><tr><td>  P0.00 </td><td>  P2 </td><td>  GPIO digital </td></tr><tr><td>  P0.01 </td><td>  - </td><td>  Motor de vibra√ß√£o </td></tr></tbody></table><br><h1>  printf </h1><br>  A capacidade de transferir dados para um computador √© indispens√°vel para depura√ß√£o.  O programador J-Link suporta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">transmiss√£o em tempo real (RTT)</a> para enviar e receber dados do chip.  Para usar o RTT, voc√™ precisa <code>#include "SEGGER_RTT.h"</code> e chamar <code>SEGGER_RTT_WriteString()</code> .  Para receber dados em um computador, chame a <code>jlinkrttlogger</code> linha de comandos <code>jlinkrttlogger</code> , fornecida com o J-Link. <br><br><h1>  OLED </h1><br>  Outro desafio √© fazer o OLED funcionar.  O OLED mais comum no mercado executa o driver / controlador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ssd1306</a> , e geralmente a comunica√ß√£o com o MCU √© via interface serial usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SPI</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">I¬≤C</a> .  Aqui est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um exemplo de Adafruit</a> . <br><br>  Eu n√£o encontrei essa exibi√ß√£o em nenhuma loja comum.  E o tamanho de 96 √ó 32 n√£o √© padr√£o.  Uma pesquisa pelo identificador QT1316P01A no visor fornece sites chineses como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aliexpress</a> , mas n√£o h√° documenta√ß√£o, exceto os nomes das conclus√µes: <br><br><img src="https://habrastorage.org/webt/jh/we/dj/jhwedjuvdabshgmklscu3wk6edi.png"><br>  <i><font color="gray">Nomea√ß√£o de pinos OLED com Aliexpress</font></i> <br><br>  Se a lista n√£o aparecer, os contatos <code>SCL</code> , <code>SDA</code> e <code>RES#</code> nos dizem que essa √© uma op√ß√£o de I¬≤C.  Se houver faixas entre os tr√™s pinos do nRF51822 e esses tr√™s pinos do OLED, daremos um passo √† frente.  Vamos voltar ao microsc√≥pio. <br><br><img src="https://habrastorage.org/webt/vw/dg/9d/vwdg9dxuopykb2umzrjt1zskvv4.jpeg"><br><br><img src="https://habrastorage.org/webt/zq/zl/ym/zqzlymrnmspwkcroh4argcj_udo.jpeg"><br>  <i><font color="gray">Faixas de contato de dados OLED</font></i> <br><br>  Atualizamos a tabela de correspond√™ncia: <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Parque infantil </th><th>  Descri√ß√£o do produto </th></tr><tr><td>  P0.21 </td><td>  - </td><td>  Sa√≠da OLED SDA </td></tr><tr><td>  P0.22 </td><td>  - </td><td>  Pino OLED SCL </td></tr><tr><td>  P0.24 </td><td>  - </td><td>  Sa√≠da OLED RES # </td></tr></tbody></table><br>  O protocolo I¬≤C √© muito mais avan√ßado do que qualquer protocolo serial simples como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">UART</a> .  Uma das vantagens √© que ele suporta v√°rios dispositivos mestre e escravo no mesmo barramento.  Isso complica um pouco as coisas: pelo menos voc√™ precisa dizer ao MCU para o qual os comandos escravos s√£o emitidos.  Portanto, em um n√≠vel alto, al√©m dos contatos f√≠sicos, h√° tamb√©m um endere√ßo "l√≥gico" do display OLED. <br><br>  Felizmente, um exemplo no nRF5 SDK √© o scanner I¬≤C.  Ele interroga a partir de todos os endere√ßos l√≥gicos e relat√≥rios poss√≠veis, se algo estiver instalado l√°.  Minha vers√£o modificada est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  Produz o seguinte log: <br><br> <code>$ make <br> # ... <br> $ make flash <br> # ... <br> $ make log <br> # ... <br> TWI scanner. <br> TWI device detected at 0x3c.</code> <br> <br>  Boas not√≠cias!  Temos boas raz√µes para acreditar que a tela est√° corretamente identificada e que √© realmente uma variante de I¬≤C.  Uma pesquisa no <code>0x3c</code> diz que <code>0x3c</code> √© um endere√ßo t√≠pico para esses dispositivos. <br><br>  Agora estamos prontos para enviar alguns pixels para a tela.  Nesse n√≠vel, n√£o h√° abstra√ß√£o na biblioteca.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Consulte a</a> documenta√ß√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ssd1306</a> para uma maneira de baixo n√≠vel de transfer√™ncia de dados.  O processo consiste em uma sequ√™ncia de comandos de configura√ß√£o que definem a orienta√ß√£o da tela, modo de grava√ß√£o, tamanho, etc.  Em seguida, uma sequ√™ncia de bytes que √© exibida na tela √© enviada para a mem√≥ria gr√°fica (GDDRAM). <br><br>  Para a configura√ß√£o correta, estudei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a biblioteca ssd1306 da Adafruit</a> e tentei emular comandos semelhantes.  Foi isso que levou a maior parte do tempo neste projeto.  Descobrir todos os detalhes acabou sendo uma tarefa muito demorada, e ainda n√£o consigo explicar algumas coisas.  No entanto, funciona! <br><br> <a href=""><img src="https://habrastorage.org/webt/lr/ix/r7/lrixr7dxh_7j9098jx677drocxm.jpeg"></a> <br>  <i><font color="gray">Exibir um bitmap codificado</font></i> <br><br>  O c√≥digo para este exemplo est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Com essas configura√ß√µes, a exibi√ß√£o √© dividida em 4 linhas (p√°ginas) e 96 colunas.  Portanto, as p√°ginas t√™m 8 pixels de altura.  O primeiro byte enviado ser√° localizado "verticalmente" na primeira coluna da primeira p√°gina.  O segundo byte ocupar√° a segunda coluna, depois a terceira e assim por diante, at√© a 96¬™ coluna, quando <i>retornar</i> e iniciar a partir da primeira coluna na segunda p√°gina. <br><br>  Esse √© o comportamento <i>esperado</i> .  Como <a href="">mostrado no v√≠deo</a> , o comportamento <i>observado</i> √© diferente: primeiro as colunas √≠mpares s√£o preenchidas, depois as pares e, somente ent√£o, retorna √† segunda p√°gina. <br><br>  Gastei muito tempo para entender o motivo de um comportamento t√£o est√∫pido de exibi√ß√£o e, em seguida, mais tempo para configur√°-lo para corrigi-lo.  No final, engoli meu orgulho e ainda implementei uma l√≥gica de renderiza√ß√£o t√£o estranha no programa para finaliz√°-lo. <br><br><h1>  Viajar para Arduino </h1><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Investigando a biblioteca Adafruit ssd1306</a> para Arduino, sempre achei que seria bom ter uma maneira de "simular" bits espec√≠ficos do Arduino para test√°-los no nRF51822.  Acontece que pessoas muito mais experientes tamb√©m pensaram neste t√≥pico - √© isso que o incr√≠vel projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sandeepmistry / arduino-nRF5 faz</a> .  Ele implementa as principais bibliotecas do Arduino usando o nRF5 SDK. <br><br>  Com este projeto, podemos abrir o IDE do Arduino, selecionar a placa nRF5 e usar o rico ecossistema do Arduino.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bifurquei o projeto</a> e adicionei suporte para o quadro usando nossa pulseira.  Voc√™ pode selecion√°-lo no menu suspenso <code>Tools &gt; Board &gt; ID115 Fitness Bracelet (nRF51822)</code> . <br><br> <a href=""><img src="https://habrastorage.org/webt/jx/ts/2h/jxts2hki_rpefinf1cjd2ms7k1w.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/50/gn/dm/50gndm8tzezp_frgdrile7la5hs.jpeg"></a> <br>  <i><font color="gray">Biblioteca Adafruit ssd1306 em sua forma original (acima) e com um patch (abaixo)</font></i> <br><br>  Isso tamb√©m significa que agora podemos usar a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca OLED</a> da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Adafruit</a> .  Para minha surpresa e al√≠vio, o mesmo comportamento estranho aconteceu com o preenchimento de colunas OLED pares e √≠mpares primeiro!  De bom grado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bifurquei a</a> biblioteca e implementei o mesmo hack.  Comparado √† abordagem de baixo n√≠vel, agora temos acesso a uma variedade de abstra√ß√µes interessantes, como a sa√≠da de texto: <br><br> <a href=""><img src="https://habrastorage.org/webt/gd/62/xf/gd62xfqutmoq_szmosnzvpbdu1i.jpeg"></a> <br>  <i><font color="gray">O mais familiar "Ol√°, mundo!"</font></i> <br><br><h1>  Entrada / sa√≠da anal√≥gica </h1><br>  Al√©m dos sinais on / off digitais, o nRF51822 possui 10 pinos para entrada anal√≥gica.  Isso √© √∫til, por exemplo, para ler a carga atual da bateria.  A julgar pela documenta√ß√£o, a leitura de contatos anal√≥gicos produz um valor de 10 bits.  Portanto, se houver <code>0V</code> na entrada, leremos <code>0</code> e, se houver <code>VCC</code> , leremos <code>1023</code> com valores intermedi√°rios entre eles. <br><br>  Li periodicamente os valores das entradas anal√≥gicas e tracei os sinais mais interessantes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/483/446/36c/48344636cddd789c9c1f86c15ffca411.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b3c/3ab/38c/b3c3ab38ce708082b19a67ed9cdb30ae.png"><br>  <i><font color="gray">O efeito de agitar a placa e carregar a bateria de acordo com os dados das entradas anal√≥gicas</font></i> <br><br>  Estou convencido de que o contato <code>P0.05</code> se refere √† carga da bateria, porque o valor aumenta e diminui √† medida que carrega e descarrega.  Suspeito que o pino <code>P0.26</code> conectado a uma das sa√≠das do aceler√¥metro, pois fica louco quando voc√™ sacode a placa.  Os contatos <code>P0.04</code> e <code>P0.04</code> tamb√©m <i>podem</i> ser conectados a v√°rias sa√≠das do aceler√¥metro, mas aqui um certo efeito de segunda ordem √© provavelmente sobreposto ao sinal da entrada.  Por exemplo, no primeiro gr√°fico, observe como o n√≠vel da bateria (pino 5) muda quando o aceler√¥metro precisa de mais energia.  Este √© um exemplo de um efeito de segunda ordem. <br><br>  O c√≥digo pode ser encontrado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste esbo√ßo</a> .  Os dados de origem e o script gr√°fico est√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  Agora podemos adicionar v√°rias linhas √† nossa tabela de correspond√™ncia: <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Parque infantil </th><th>  Descri√ß√£o do produto </th></tr><tr><td>  P0.05 </td><td>  - </td><td>  Entrada Anal√≥gica - Conectada √† Bateria </td></tr><tr><td>  P0.26 </td><td>  - </td><td>  Entrada Anal√≥gica - Aceler√¥metro de Um Eixo </td></tr><tr><td>  P0.03 </td><td>  - </td><td>  Entrada anal√≥gica - um eixo do aceler√¥metro (prov√°vel) </td></tr><tr><td>  P0.04 </td><td>  - </td><td>  Entrada anal√≥gica - um eixo do aceler√¥metro (prov√°vel) </td></tr></tbody></table><br><h1>  Bot√£o </h1><br>  No firmware original, tocar na pulseira em um determinado momento liga o visor.  Manter esse ponto inicia o cron√¥metro, se bem me lembro.  Este n√£o √© um bot√£o f√≠sico, mas algum tipo de toque capacitivo que funciona surpreendentemente bem.  Utilizando a mesma abordagem usada para procurar sa√≠das digitais, <a href="">encontrei um local para conectar ao MCU (v√≠deo)</a> . <br><br>  O c√≥digo est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Parque infantil </th><th>  Descri√ß√£o do produto </th></tr><tr><td>  P0.10 </td><td>  - </td><td>  Entrada Digital - Bot√£o Integrado </td></tr></tbody></table><br><h1>  Baixa energia Bluetooth (BLE) </h1><br>  A funcionalidade BLE nos chips nRF5 √© implementada atrav√©s de algo chamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SoftDevice</a> .  Este √© um bin√°rio pr√©-compilado com uma pilha BLE.  √â costurado independentemente da aplica√ß√£o.  Existem muitas vers√µes do SoftDevice, dependendo da vers√£o do SDK e da vers√£o do chip. <br><br>  A <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> fornece uma certa matriz de depend√™ncia (infelizmente, voc√™ n√£o pode colocar um link direto para ela).  Ele mostra com qual SDK as diferentes vers√µes do chip s√£o fornecidas - e qual √© a vers√£o do SoftDevice.  No nosso caso, o chip est√° marcado como QFAAH0, este chip possui 256 KB de mem√≥ria flash, 16 KB de RAM e a compatibilidade com o SoftDevice s130 √© declarada. <br><br>  Meu SDK vers√£o 12.3 j√° cont√©m alguns exemplos de uso do SoftDevice s130.  Comparado aos programas anteriores conectados diretamente em microchips a partir do endere√ßo <code>0x0</code> , agora voc√™ precisa atualizar o SoftDevice a partir do endere√ßo <code>0x0</code> e o pr√≥prio programa a partir do endere√ßo <code>0x1b000</code> .  Ap√≥s o carregamento e a inicializa√ß√£o, o arquivo bin√°rio SoftDevice ir√° para esse endere√ßo e transferir√° o controle para o nosso programa.  Para ilustrar, tomei o mesmo exemplo com LEDs piscando, mas mudei para o firmware SoftDevice ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">c√≥digo</a> ).  O comportamento observado n√£o foi alterado, exceto pelo pr√©-flash do SoftDevice: <br><br> <code>$ make <br> # ... <br> $ make flash-softdevice <br> # ... <br> $ make flash <br> # ... <br> $ make log <br> # ... <br> Hello, world!</code> <br> <br>  Talvez o aplicativo mais simples para Bluetooth seja transformar o dispositivo em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">farol</a> .  O dispositivo apenas transmite sua presen√ßa.  Um exemplo est√° no SDK chamado <code>ble_app_beacon</code> .  Parte do princ√≠pio que o SoftDevice <code>s130</code> j√° <code>s130</code> . <br><br>  Aqui, tamb√©m, a comunica√ß√£o de baixo n√≠vel com o chip complica tudo em compara√ß√£o √† programa√ß√£o via SDK.  Al√©m de ajustar o tamanho da RAM (esse conhecimento foi dif√≠cil para mim no exemplo com LEDs), outro problema dif√≠cil de rastrear foi revelado.  Como se viu, a pilha BLE usa um gerador de rel√≥gio para executar tarefas sens√≠veis ao tempo.  Nos exemplos do SDK, √© assumido um oscilador de cristal externo.  Quando percebi isso depois de milhares de tentativas de <code>printf</code> , mudei o sinalizador de configura√ß√£o para usar um gerador de rel√≥gio sint√©tico e o problema foi resolvido.  O c√≥digo fonte do farol est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><h1>  BLE + Arduino </h1><br>  Quando o exemplo BLE trabalhou com o nRF5 SDK, conhecendo as armadilhas com RAM e um gerador, olhei novamente para o ambiente do Arduino.  E, novamente, houve o glorioso projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sandeepmistry / arduino-BLEPeripheral</a> (do mesmo cara que o arduino-nRF5!), Que fornece excelentes abstra√ß√µes sobre as configura√ß√µes internas do BLE. <br><br>  Para minha surpresa, nem precisei bifurcar a biblioteca.  O autor do projeto arduino-nrf5 gastou tempo e adicionou a configura√ß√£o de todas as placas e configura√ß√µes; agora, a escolha do gerador de clock certo para o SoftDevice se resume a uma escolha simples no menu suspenso <code>Tools &gt; Low Frequency Clock &gt; Synthesized</code> .  Awesome.  Eu rapidamente escrevi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um exemplo</a> com o LED verde aceso via Bluetooth (com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">este aplicativo</a> ).  Seu trabalho √© <a href="">mostrado no v√≠deo</a> . <br><br><h1>  Planos adicionais </h1><br>  Depois de mexer nesta prancha por in√∫meras horas, minhas m√£os co√ßam por v√°rias semanas para coloc√°-la mais longe na m√°quina de lavar e esquec√™-la por um tempo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt413895/">https://habr.com/ru/post/pt413895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt413881/index.html">Imagem do docker de 5,94 metros com Telegram MTProxy</a></li>
<li><a href="../pt413885/index.html">Avalia√ß√£o Cavium ThunderX2: O sonho do Arm Server se torna realidade (Parte 1, Introdu√ß√£o)</a></li>
<li><a href="../pt413889/index.html">Prazo n√£o cumprido ou por que mais da metade das empresas n√£o estava pronta para o RGPD</a></li>
<li><a href="../pt413891/index.html">Como √© organizado o Registro Estadual Unificado de Pessoas Jur√≠dicas - um registro estadual unificado de pessoas jur√≠dicas</a></li>
<li><a href="../pt413893/index.html">Um buraco como ferramenta de seguran√ßa - 2, ou como capturar a ‚Äúisca viva‚Äù do APT</a></li>
<li><a href="../pt413897/index.html">Unity3D ECS e sistema de tarefas</a></li>
<li><a href="../pt413899/index.html">Dados pessoais biom√©tricos de russos</a></li>
<li><a href="../pt413901/index.html">Controlar o rob√¥ de auto balanceamento EduMip usando o joystick do PS4 Dualshock 4 via ROS</a></li>
<li><a href="../pt413903/index.html">Como o Cambridge Analytica transforma cliques em vozes</a></li>
<li><a href="../pt413907/index.html">O resumo de materiais interessantes para o desenvolvedor de dispositivos m√≥veis # 256 (4 a 12 de junho)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>