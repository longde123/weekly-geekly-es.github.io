<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöâ üöº üÜî Ausdrucksb√§ume f√ºr die Unternehmensentwicklung ‚öõÔ∏è üëßüèΩ üèéÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="F√ºr die meisten Entwickler ist die Verwendung des Ausdrucksbaums auf Lambda-Ausdr√ºcke in LINQ beschr√§nkt. Oft legen wir keinen Wert darauf, wie die Te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ausdrucksb√§ume f√ºr die Unternehmensentwicklung</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/423891/">  F√ºr die meisten Entwickler ist die Verwendung des Ausdrucksbaums auf Lambda-Ausdr√ºcke in LINQ beschr√§nkt.  Oft legen wir keinen Wert darauf, wie die Technologie ‚Äûunter der Haube‚Äú funktioniert. <br><br>  In diesem Artikel zeige ich Ihnen fortgeschrittene Techniken f√ºr die Arbeit mit Ausdrucksb√§umen: Eliminieren von Codeduplizierungen in LINQ, Codegenerierung, Metaprogrammierung, Transpilation und Testautomatisierung. <br><br>  Sie lernen, wie Sie den Ausdrucksbaum direkt verwenden, welche Fallstricke die Technologie vorbereitet hat und wie Sie sie umgehen k√∂nnen. <br><br><img src="https://habrastorage.org/webt/e5/qh/tt/e5qhttxqyi5a27s-4dtlt2jq1mo.png"><br><br>  Unter dem Schnitt - Video- und Textprotokoll <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">meines Berichts</a> mit DotNext 2018 Piter. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/J2XzsCoJM4o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Mein Name ist Maxim Arshinov, ich bin Mitbegr√ºnder des Outsourcing-Unternehmens der Hi-Tech Group.  Wir entwickeln Software f√ºr Unternehmen und heute werde ich dar√ºber sprechen, wie die Ausdrucksbaumtechnologie in der t√§glichen Arbeit verwendet wurde und wie sie uns zu helfen begann. <br><br>  Ich wollte nie speziell die interne Struktur von Ausdrucksb√§umen untersuchen. Es schien, dass dies eine Art interne Technologie f√ºr das .NET-Team war, damit LINQ funktioniert, und Anwendungsprogrammierer mussten die API nicht kennen.  Es stellte sich heraus, dass einige angewandte Probleme gel√∂st werden mussten.  Damit mir die L√∂sung gefiel, musste ich in den Darm klettern. <br><br>  Diese ganze Geschichte ist zeitlich gespannt, es gab verschiedene Projekte, verschiedene F√§lle.  Es kam etwas heraus, und ich beendete es, aber ich werde mir erlauben, die historische Wahrhaftigkeit zugunsten einer k√ºnstlerischeren Pr√§sentation zu opfern, sodass alle Beispiele auf demselben Themenmodell basieren - einem Online-Shop. <br><br><img src="https://habrastorage.org/webt/g5/yf/cr/g5yfcrf13ptoovmcheym1x15fdk.png"><br><br>  Stellen Sie sich vor, wir schreiben alle einen Online-Shop.  Es hat Produkte und ein H√§kchen "Zum Verkauf" im Admin-Bereich.  Wir zeigen nur Produkte an, bei denen dieses H√§kchen im √∂ffentlichen Teil markiert ist. <br><br><img src="https://habrastorage.org/webt/cg/_e/jt/cg_ejtgmxn1u0hq12ezlonenue8.png"><br><br>  Wir nehmen etwas DbContext oder NHibernate, wir schreiben Where (), wir geben IsForSale aus. <br><br>  Alles ist in Ordnung, aber die Gesch√§ftsregeln sind nicht die gleichen, so dass wir sie ein f√ºr alle Mal schreiben.  Sie entwickeln sich im Laufe der Zeit.  Ein Manager kommt und sagt, dass wir immer noch den Kontostand √ºberwachen und nur Waren anzeigen m√ºssen, die einen Kontostand im √∂ffentlichen Teil haben, ohne das H√§kchen zu vergessen. <br><br><img src="https://habrastorage.org/webt/8e/b1/mz/8eb1mzde7casnjrrilroqxpp8ku.png"><br><br>  Wir f√ºgen leicht eine solche Eigenschaft hinzu.  Jetzt sind unsere Gesch√§ftsregeln gekapselt und k√∂nnen wiederverwendet werden. <br><br><img src="https://habrastorage.org/webt/6s/yj/09/6syj09lcwmeiktufuwl4a4wzvyq.png"><br><br>  Versuchen wir, LINQ zu bearbeiten.  Ist hier alles in Ordnung? <br>  Nein, dies funktioniert nicht, da IsAvailable nicht der Datenbank zugeordnet ist. Dies ist unser Code, und der Abfrageanbieter wei√ü nicht, wie er analysiert werden soll. <br><br><img src="https://habrastorage.org/webt/qb/yt/dp/qbytdpgh5ybdiua4kjpc-rouxbs.png"><br><br>  Wir k√∂nnen ihm sagen, dass unser Eigentum eine solche Geschichte hat.  Aber jetzt wird dieses Lambda sowohl im linq-Ausdruck als auch in der Eigenschaft dupliziert. <br><br><pre><code class="cs hljs">Where(x =&gt; x.IsForSale &amp;&amp; x.InStock &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) IsAvailable =&gt; IsForSale &amp;&amp; InStock &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre> <br>  Wenn sich dieses Lambda das n√§chste Mal √§ndert, m√ºssen wir f√ºr das Projekt Strg + Umschalt + F dr√ºcken.  Nat√ºrlich werden wir alle nicht finden - Fehler und Zeit.  Ich m√∂chte das vermeiden. <br><br><img src="https://habrastorage.org/webt/8b/8b/j8/8b8bj8voopaagucck7rcl1j9tcg.png"><br><br>  Wir k√∂nnen von dieser Seite gehen und eine weitere ToList () vor Where () setzen.  Dies ist eine schlechte Entscheidung, denn wenn sich eine Million Waren in der Datenbank befinden, steigt jeder in den Arbeitsspeicher und filtert dort. <br><br><img src="https://habrastorage.org/webt/ca/2t/2g/ca2t2gbdetsmcijcefubnokpfeu.png"><br><br>  Wenn Sie drei Produkte in einem Gesch√§ft haben, ist die L√∂sung gut, aber im E-Commerce gibt es normalerweise mehr.  Dies funktionierte nur, weil Lambdas trotz der √Ñhnlichkeit miteinander einen v√∂llig anderen Typ haben.  Im ersten Fall ist dies ein Func-Delegat und im zweiten ein Ausdrucksbaum.  Es sieht gleich aus, die Typen sind unterschiedlich, der Bytecode ist v√∂llig unterschiedlich. <br><br><img src="https://habrastorage.org/webt/2l/qi/ya/2lqiya8v9axdrfchqrdqtrxbe4o.png"><br><br>  Um vom Ausdruck zum Delegaten zu wechseln, m√ºssen Sie nur die Compile () -Methode aufrufen.  Diese API bietet .NET: Es gibt Ausdruck kompiliert, einen Delegaten erhalten. <br><br>  Aber wie geht es zur√ºck?  Gibt es in .NET etwas, um von einem Delegaten zu Ausdrucksb√§umen zu wechseln?  Wenn Sie beispielsweise mit LISP vertraut sind, gibt es einen Zitiermechanismus, mit dem der Code als Datenstruktur interpretiert werden kann, in .NET jedoch nicht. <br><br><h1>  Express oder Delegierte? </h1><br>  Wenn man bedenkt, dass wir zwei Arten von Lambdas haben, k√∂nnen wir philosophieren, was prim√§r ist: Ausdrucksbaum oder Delegierte. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// so slo-oooooo-ow var delegateLambda = expressionLambda.Compile();</span></span></code> </pre> <br>  Auf den ersten Blick ist die Antwort offensichtlich: Da es eine wunderbare Compile () -Methode gibt, ist der Ausdrucksbaum prim√§r.  Und wir sollten den Delegaten empfangen, indem wir den Ausdruck kompilieren.  Das Kompilieren ist jedoch ein langsamer Prozess, und wenn wir dies √ºberall tun, kommt es zu Leistungseinbu√üen.  Dar√ºber hinaus erhalten wir es an zuf√§lligen Stellen, an denen der Ausdruck zu einem Delegaten kompiliert werden musste. Es kommt zu einem Leistungsabfall.  Sie k√∂nnen diese Orte finden, sie wirken sich jedoch zuf√§llig auf die Antwortzeit des Servers aus. <br><br><img src="https://habrastorage.org/webt/ur/jw/y_/urjwy_veoqpl7udanxvc3-ddsl8.png"><br><br>  Daher m√ºssen sie irgendwie zwischengespeichert werden.  Wenn Sie einen Vortrag √ºber gleichzeitige Datenstrukturen geh√∂rt haben, kennen Sie ConcurrentDictionary (oder wissen es einfach).  Ich werde Details zu Caching-Methoden weglassen (mit Sperren, nicht mit Sperren).  Es ist nur so, dass ConcurrentDictionary eine einfache GetOrAdd () -Methode hat. Die einfachste Implementierung besteht darin, sie in ConcurrentDictionary einzuf√ºgen und zwischenzuspeichern.  Das erste Mal bekommen wir die Kompilierung, aber dann wird alles schnell gehen, da der Delegat bereits kompiliert wurde. <br><br><img src="https://habrastorage.org/webt/h1/wp/gb/h1wpgbo_5pi3xhnfaivvvjsz4ks.png"><br><br>  Dann k√∂nnen Sie eine solche Erweiterungsmethode verwenden, unseren Code mit IsAvailable () verwenden und umgestalten, den Ausdruck beschreiben, die Eigenschaften von IsAvailable () kompilieren und ihn relativ zum aktuellen Objekt aufrufen. <br><br>  Es gibt mindestens zwei Pakete, die dies implementieren: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Microsoft.Linq.Translations</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Signum Framework</a> (Open Source Framework, das von einem kommerziellen Unternehmen geschrieben wurde).  Sowohl dort als auch dort gibt es ungef√§hr die gleiche Geschichte mit der Zusammenstellung von Delegierten.  Eine etwas andere API, aber alles, wie ich auf der vorherigen Folie gezeigt habe. <br><br>  Dies ist jedoch nicht der einzige Ansatz, und Sie k√∂nnen von Delegaten zu Ausdr√ºcken wechseln.  Seit langem gibt es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einen Artikel</a> √ºber den Habre √ºber den Delegate Decompiler, in dem der Autor behauptet, dass alle Zusammenstellungen schlecht sind, weil f√ºr eine lange Zeit. <br><br>  Im Allgemeinen standen Delegaten vor Ausdr√ºcken, und Sie k√∂nnen von Delegaten zu ihnen wechseln.  Zu diesem Zweck verwendet der Autor die MethodeBody.GetILAsByteArray ().  from Reflection, das wirklich den gesamten IL-Code der Methode als Array von Bytes zur√ºckgibt.  Wenn Sie es weiter in Reflection einf√ºgen, k√∂nnen Sie eine Objektdarstellung dieses Falls abrufen, mit einer Schleife durchgehen und einen Ausdrucksbaum erstellen.  Somit ist auch ein umgekehrter √úbergang m√∂glich, der jedoch von Hand erfolgen muss. <br><br><img src="https://habrastorage.org/webt/_r/pp/d5/_rppd5sfv3tmy9mfacmg6wydi3k.png"><br><br>  Um nicht alle Eigenschaften zu durchlaufen, schl√§gt der Autor vor, das Attribut "Berechnet" aufzuh√§ngen, um anzuzeigen, dass diese Eigenschaft inline sein muss.  Vor der Anforderung klettern wir in IsAvailable (), ziehen den IL-Code heraus, konvertieren ihn in den Ausdrucksbaum und ersetzen den Aufruf von IsAvailable () durch das, was in diesem Getter geschrieben ist.  Es stellt sich heraus, dass ein solches manuelles Inlining vorliegt. <br><br><img src="https://habrastorage.org/webt/nt/jx/g1/ntjxg17v2olokmu7ebckzs7v_uq.png"><br><br>  Damit dies funktioniert, rufen wir die spezielle Methode Decompile () auf, bevor wir alles an ToList () √ºbergeben.  Es bietet einen Dekorator f√ºr das Original abfragbar und Inlining.  Erst danach √ºbergeben wir alles an den Abfrageanbieter, und bei uns ist alles in Ordnung. <br><br><img src="https://habrastorage.org/webt/ze/cz/qw/zeczqw8mzr-k72ivpyfzqrpuhrm.png"><br><br>  Das einzige Problem bei diesem Ansatz ist, dass Delegate Decompiler 0.23.0 nicht weiterentwickelt wird, es keine Core-Unterst√ºtzung gibt und der Autor selbst sagt, dass dies Deep Alpha ist, es gibt viele unvollendete, sodass Sie es nicht in der Produktion verwenden k√∂nnen.  Obwohl wir auf dieses Thema zur√ºckkommen werden. <br><br><h1>  Boolesche Operationen </h1><br>  Es stellt sich heraus, dass wir das Problem der Verdoppelung bestimmter Bedingungen gel√∂st haben. <br><br><img src="https://habrastorage.org/webt/gc/-u/5n/gc-u5nh7vip9kn5cq1d5gn3ivxm.png"><br><br>  Bedingungen m√ºssen jedoch h√§ufig mithilfe der Booleschen Logik kombiniert werden.  Wir hatten IsForSale (), InStock ()&gt; 0 und dazwischen die Bedingung "AND".  Wenn eine andere Bedingung vorliegt oder eine ODER-Bedingung erforderlich ist. <br><br><img src="https://habrastorage.org/webt/9f/xu/hy/9fxuhyfzinahcrlertade-zam2s.png"><br><br>  Im Fall von "Und" k√∂nnen Sie die gesamte Arbeit des Abfrageanbieters betr√ºgen und ausgeben, dh viel Where () hintereinander schreiben, er wei√ü, wie es geht. <br><br><img src="https://habrastorage.org/webt/dd/hp/c9/ddhpc9tfdvmeiadkmyfmswnr4h8.png"><br><br>  Wenn "ODER" erforderlich ist, funktioniert dies nicht, da WhereOr () nicht in LINQ enthalten ist und der Operator | | nicht mit Ausdr√ºcken √ºberladen ist. <br><br><h1>  Technische Daten </h1><br>  Wenn Sie mit Evans 'DDD-Buch vertraut sind oder nur etwas √ºber das Spezifikationsmuster wissen, dh ein speziell daf√ºr entwickeltes Entwurfsmuster.  Es gibt mehrere Gesch√§ftsregeln, und Sie m√∂chten Operationen in der Booleschen Logik kombinieren - implementieren Sie die Spezifikation. <br><br><img src="https://habrastorage.org/webt/nj/cb/4n/njcb4n2xt0g8dk3joumhmsgmuyg.png"><br><br>  Eine Spezifikation ist ein solcher Begriff, ein altes Muster aus Java.  Und in Java, insbesondere in der alten, gab es kein LINQ, so dass es dort nur in Form der isSatisfiedBy () -Methode implementiert wurde, dh nur in Form von Delegaten, aber es wurde nicht √ºber Ausdr√ºcke gesprochen.  Im Internet gibt es eine Implementierung namens <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">LinqSpecs</a> . Auf der Folie sehen Sie sie.  Ich habe es ein bisschen f√ºr mich selbst abgelegt, aber die Idee geh√∂rt zur Bibliothek. <br><br>  Hier sind alle Booleschen Operatoren √ºberladen, die wahren und falschen Operatoren sind √ºberladen, so dass die beiden Operatoren "&amp;&amp;" und "||" funktionieren, ohne die nur ein einziges kaufm√§nnisches Und funktioniert. <br><br><img src="https://habrastorage.org/webt/nh/8b/16/nh8b16hfmjec4t6yotlcmu5nbzi.png"><br><br>  Als N√§chstes f√ºgen wir implizite Anweisungen hinzu, die den Compiler davon ausgehen lassen, dass die Spezifikation sowohl Ausdr√ºcke als auch Delegaten ist.  An jeder Stelle, an der Expression &lt;&gt; oder Func &lt;&gt; in die Funktion aufgenommen werden soll, k√∂nnen Sie die Spezifikation √ºbergeben.  Da der implizite Operator √ºberladen ist, analysiert und ersetzt der Compiler entweder die Expression- oder die IsSatisfiedBy-Eigenschaften. <br><br><img src="https://habrastorage.org/webt/pd/-t/jk/pd-tjkx5uxieorm3go74act-2gc.png"><br><br>  IsSatisfiedBy () kann implementiert werden, indem der kommende Ausdruck zwischengespeichert wird.  In jedem Fall stellt sich heraus, dass wir von Expression kommen, der Delegat entspricht ihm, wir haben Unterst√ºtzung f√ºr Boolesche Operatoren hinzugef√ºgt.  Jetzt kann das alles arrangiert werden.  Gesch√§ftsregeln k√∂nnen in statische Spezifikationen aufgenommen, deklariert und kombiniert werden. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Spec&lt;Product&gt; IsForSaleSpec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Spec&lt;Product&gt;(x =&gt; x.IsForSale); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Spec&lt;Product&gt; IsInStockSpec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Spec&lt;Product&gt;(x =&gt; x.InStock &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br><img src="https://habrastorage.org/webt/ru/ju/ya/rujuyaoj1ogssqq_resyqjmkutm.png"><br><br>  Jede Gesch√§ftsregel wird nur einmal geschrieben, sie geht nirgendwo verloren, sie wird nicht dupliziert, sie kann kombiniert werden.  Leute, die zum Projekt kommen, k√∂nnen sehen, was Sie haben, welche Bedingungen, das Themenmodell verstehen. <br><br><img src="https://habrastorage.org/webt/td/5l/zi/td5lzi5sx9bcq522numfdrylehg.png"><br><br>  Es gibt ein kleines Problem: Expression verf√ºgt nicht √ºber die Methoden And (), Or () und Not ().  Dies sind Erweiterungsmethoden, die unabh√§ngig voneinander implementiert werden m√ºssen. <br><br><img src="https://habrastorage.org/webt/l9/go/tj/l9gotjytui3drpptkcdtbyeymcc.png"><br><br>  Der erste Umsetzungsversuch war dieser.  √úber den Ausdrucksbaum gibt es im Internet eine ganze Menge Dokumentation, und alles ist nicht detailliert.  Deshalb habe ich versucht, nur Expression zu nehmen, Strg + Leertaste gedr√ºckt, OrElse () gesehen und dar√ºber gelesen.  Zwei Ausdr√ºcke bestanden, um Lambda zu kompilieren und zu erhalten.  Dies wird nicht funktionieren. <br><br><img src="https://habrastorage.org/webt/v4/p3/8u/v4p38uvzgxubb2y8olt38ivbipq.png"><br><br>  Tatsache ist, dass dieser Ausdruck aus zwei Teilen besteht: Parameter und K√∂rper.  Die zweite besteht ebenfalls aus einem Parameter und einem K√∂rper.  In OrElse () m√ºssen Sie die Ausdrucksk√∂rper √ºbergeben, dh es ist sinnlos, Lambdas mit "AND" und "OR" zu vergleichen. Dies funktioniert nicht.  Wir beheben, aber es wird nicht wieder funktionieren. <br><br>  Aber wenn es das letzte Mal eine NotSupportedException gab, dass das Lambda nicht unterst√ºtzt wurde, gibt es jetzt eine seltsame Geschichte √ºber Parameter 1, Parameter 2, "etwas stimmt nicht, ich werde nicht arbeiten". <br><br><h1>  C # 7.0 auf den Punkt gebracht </h1><br>  Dann dachte ich, dass die wissenschaftliche Poke-Methode nicht funktionieren w√ºrde, ich muss es herausfinden.  Er begann zu googeln und fand die Seite von Albaharis Buch " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">C # 7.0 in a Nutshell</a> ". <br><br><img src="https://habrastorage.org/webt/m6/0b/ag/m60bagpqsrrcakt5wz-p05lcfyq.png"><br><br>  Joseph Albahari, der auch Entwickler der beliebten LINQKit-Bibliothek und des LINQPad ist, beschreibt dieses Problem nur.  dass Sie nicht nur Expression nehmen und kombinieren k√∂nnen, und wenn Sie den magischen Expression.Invoke () nehmen, wird es funktionieren. <br><br>  Frage: Was ist Expression.Invoke ()?  Gehen Sie erneut zu Google.  Es wird ein InvocationExpression erstellt, der einen Delegaten- oder Lambda-Ausdruck auf die Argumentliste anwendet. <br><br><img src="https://habrastorage.org/webt/br/du/mh/brdumhygufxqwgu5hfly1nlac0a.png"><br><br>  Wenn ich Ihnen diesen Code jetzt vorlese, wo wir Expression.Invoke () verwenden, √ºbergeben wir die Parameter, dann wird dasselbe in Englisch geschrieben.  Es wird nicht klarer.  Es gibt einige magische Expression.Invoke (), die aus irgendeinem Grund dieses Problem mit Parametern l√∂sen.  Wir m√ºssen glauben, es ist nicht notwendig zu verstehen. <br><br><img src="https://habrastorage.org/webt/ja/88/po/ja88po-nxrjqtzdya6f8xxnfwre.png"><br><br>  Wenn Sie versuchen, EFs wie diesen kombinierten Ausdruck zu f√ºttern, wird er erneut fallen und sagen, dass Expression.Invoke () nicht unterst√ºtzt wird.  √úbrigens begann EF Core zu unterst√ºtzen, aber EF 6 h√§lt nicht.  Aber Albahari bietet nur an, AsExpandable () zu schreiben, und alles funktioniert. <br><br><img src="https://habrastorage.org/webt/z5/4s/lq/z54slqaaitigetkidixpw-0a408.png"><br><br>  Und Sie k√∂nnen in Ausdrucksunterabfragen ersetzen, wenn wir einen Delegaten ben√∂tigen.  Damit sie √ºbereinstimmen, schreiben wir Compile (). Wenn wir jedoch AsExpandable () schreiben, wie Albahari vorschl√§gt, wird Compile () nicht tats√§chlich ausgef√ºhrt, aber alles wird auf magische Weise korrekt ausgef√ºhrt. <br><br><img src="https://habrastorage.org/webt/u_/bd/wo/u_bdwop-dd-1gf_xvq3e_d9hbj8.png"><br><br>  Ich glaubte kein Wort und stieg in die Quelle.  Was ist die AsExpandable () -Methode?  Es hat Abfrage und QueryOptimizer.  Wir werden das zweite aus Klammern herauslassen, da es uninteressant ist, aber einfach klebt. Ausdruck: Wenn es 3 + 5 gibt, wird es 8 setzen. <br><br><img src="https://habrastorage.org/webt/l6/8j/tw/l68jtwqse6njinyczxh7xs3ilmw.png"><br><br>  Es ist interessant, dass die Expand () -Methode sp√§ter aufgerufen wird, danach der queryOptimizer, und dann alles an den Abfrageanbieter √ºbergeben wird, der nach der Expand () -Methode irgendwie √ºberarbeitet wurde. <br><br><img src="https://habrastorage.org/webt/pr/dv/oc/prdvockxs8plz7f2lyciiyu0s5y.png"><br><br>  Wir √∂ffnen es, es ist Besucher, im Inneren sehen wir das nicht originale Compile (), das etwas anderes kompiliert.  Ich werde Ihnen nicht genau sagen, obwohl dies eine bestimmte Bedeutung hat, aber wir entfernen eine Zusammenstellung und ersetzen sie durch eine andere.  Gro√üartig, aber es riecht nach Level 80-Marketing, weil die Auswirkungen auf die Leistung nirgendwo hin gehen. <br><br><h1>  Auf der Suche nach einer Alternative </h1><br>  Ich dachte, dass dies nicht funktionieren w√ºrde und suchte nach einer anderen L√∂sung.  Und fand es.  Es gibt solchen Pete Montgomery, der auch √ºber dieses Problem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">schreibt</a> und behauptet, Albahari habe vorget√§uscht. <br><img src="https://habrastorage.org/webt/k9/pu/hy/k9puhyrru6xqi3hyozftlav_lvk.png"><br>  Pete sprach mit den Entwicklern von EF und sie lehrten ihn, alles ohne Expression.Evoke () zu kombinieren.  Die Idee ist sehr einfach: Der Hinterhalt war mit den Parametern.  Tatsache ist, dass es bei der Kombination Ausdruck einen Parameter des ersten Ausdrucks und einen Parameter des zweiten gibt.  Sie stimmen nicht √ºberein.  Die K√∂rper wurden zusammengeklebt, aber die Parameter blieben in der Luft h√§ngen.  Sie m√ºssen richtig verbunden werden. <br><br>  Dazu m√ºssen Sie ein W√∂rterbuch kompilieren, indem Sie die Parameter der Ausdr√ºcke betrachten, wenn das Lambda nicht aus einem Parameter stammt.  Wir erstellen ein W√∂rterbuch und binden alle Parameter des zweiten wieder an die Parameter des ersten, so dass die Anfangsparameter in Expression eingegeben werden. Fahren Sie durch den gesamten K√∂rper, den wir zusammengeklebt haben. <br><img src="https://habrastorage.org/webt/yn/ct/37/ynct37iynt07424au-grgvhhz1o.png"><br>  Mit einer so einfachen Methode k√∂nnen Sie mit Expression.Invoke () alle Hinterhalte beseitigen.  Dar√ºber hinaus wird dies bei der Implementierung von Pete Montgomery noch cooler.  Es verf√ºgt √ºber eine Compose () -Methode, mit der Sie einen beliebigen Ausdruck kombinieren k√∂nnen. <br><br><img src="https://habrastorage.org/webt/wc/of/fv/wcoffvtu4s62gggy_qqykowjtns.png"><br><br>  Wir nehmen Ausdruck und durch AndAlso verbinden wir uns, arbeiten ohne Expandable ().  Diese Implementierung wird in Booleschen Operationen verwendet. <br><br><h1>  Technische Daten und Einheiten </h1><br>  Alles war in Ordnung, bis klar wurde, dass Aggregate in der Natur existieren.  F√ºr diejenigen, die nicht vertraut sind, erkl√§re ich: Wenn Sie ein Dom√§nenmodell haben und alle miteinander in Beziehung stehenden Entit√§ten in Form von B√§umen darstellen, ist ein separat h√§ngender Baum ein Aggregat.  Die Bestellung wird zusammen mit den Bestellpositionen als Aggregat bezeichnet, und die Bestellessenz ist die Aggregationswurzel. <br><br><img src="https://habrastorage.org/webt/zr/vr/6a/zrvr6af-865n3tluhcoivfjn68g.png"><br><br>  Wenn es neben Produkten noch Kategorien gibt, f√ºr die eine Gesch√§ftsregel in Form einer Spezifikation deklariert ist, dass es eine bestimmte Bewertung gibt, die mehr als 50 betragen sollte, wie Vermarkter sagten, und wir sie auf diese Weise verwenden m√∂chten, dann ist dies gut. <br><br><img src="https://habrastorage.org/webt/tp/vh/u-/tpvhu-12wisjnbsdhnmddkqpkw4.png"><br><br>  Aber wenn wir die Waren aus einer guten Kategorie herausziehen wollen, ist es wiederum schlecht, weil unsere Typen nicht √ºbereinstimmten.  Spezifikation f√ºr die Kategorie, aber Produkte werden ben√∂tigt. <br><br><img src="https://habrastorage.org/webt/yz/cj/wp/yzcjwpjtf0jvuwff1dae8jef7ha.png"><br><br>  Wieder m√ºssen wir das Problem irgendwie l√∂sen.  Die erste Option: Ersetzen Sie Select () durch SelectMany ().  Zwei Dinge mag ich hier nicht.  Erstens wei√ü ich nicht, wie die SelectMany () - Unterst√ºtzung in allen g√§ngigen Abfrageanbietern implementiert ist.  Zweitens, wenn jemand einen Abfrageanbieter schreibt, schreibt er als erstes eine nicht implementierte Ausnahme und SelectMany ().  Und der dritte Punkt: Die Leute denken, dass SelectMany () entweder Funktionalit√§t oder Joins ist, die normalerweise nicht mit einer SELECT-Abfrage verkn√ºpft sind. <br><br><h1>  Zusammensetzung </h1><br>  Ich m√∂chte Select () verwenden, nicht SelectMany (). <br><br><img src="https://habrastorage.org/webt/-_/bv/qm/-_bvqmi8jssf1sva8boyiuh1vsg.png"><br><br>  Etwa zur gleichen Zeit las ich √ºber Kategorietheorie, √ºber funktionale Zusammensetzung und dachte, wenn es Spezifikationen vom Produkt im Bool unten gibt, gibt es eine Funktion, die vom Produkt zur Kategorie gehen kann, es gibt eine Spezifikation bez√ºglich der Kategorie, die dann die erste ersetzt Als Argument der zweiten erhalten wir, was wir brauchen, eine Spezifikation bez√ºglich des Produkts.  Absolut das Gleiche wie funktionale Komposition, jedoch f√ºr Ausdrucksb√§ume. <br><br><img src="https://habrastorage.org/webt/hg/wp/7h/hgwp7h8a0nrpv2xsfphtltel160.png"><br><br>  Dann w√§re es m√∂glich, eine solche Where () -Methode zu schreiben, dass es notwendig ist, von Produkten zu Kategorien zu wechseln und die Spezifikation auf diese verwandte Entit√§t anzuwenden.  Eine solche Syntax f√ºr meinen subjektiven Geschmack sieht ziemlich verst√§ndlich aus. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IQueryable&lt;T&gt; Where&lt;T, TParam&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQueryable&lt;T&gt; queryable, Expression&lt;Func&lt;T, TParam&gt;&gt; prop, Expression&lt;Func&lt;TParam, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> queryable.Where(prop.Compose(<span class="hljs-keyword"><span class="hljs-keyword">where</span></span>)); }</code> </pre> <br>  Mit der Compose () -Methode kann dies auch einfach durchgef√ºhrt werden.  Wir nehmen den eingegebenen Ausdruck aus den Produkten und kombinieren ihn mit den Spezifikationen f√ºr das Produkt und das wars. <br><br><img src="https://habrastorage.org/webt/5p/5k/re/5p5krejfyvexk6c-hf50hymykss.png"><br><br>  Jetzt k√∂nnen Sie ein solches Where () schreiben.  Dies funktioniert, wenn Sie eine Maschine beliebiger L√§nge haben.  Kategorie hat eine Superkategorie und eine beliebige Anzahl weiterer Eigenschaften, die ersetzt werden k√∂nnen. <br><br>  ‚ÄûDa wir ein Werkzeug f√ºr die funktionale Komposition haben, es kompilieren und dynamisch zusammenstellen k√∂nnen, riecht es nach Metaprogrammierung!‚Äú, Dachte ich. <br><br><h1>  Projektionen </h1><br>  Wo k√∂nnen wir Metaprogrammierung anwenden, damit wir weniger Code schreiben m√ºssen? <br><br><img src="https://habrastorage.org/webt/z6/dw/gi/z6dwgivuday4edqii5me2z0yuw0.png"><br><br>  Die erste Option ist die Projektion.  Das Herausziehen eines ganzen Unternehmens ist oft zu teuer.  Meistens geben wir es an die Front weiter, serialisieren JSON.  Aber es braucht nicht die ganze Essenz zusammen mit dem Aggregat.  Sie k√∂nnen dies mit LINQ so effizient wie m√∂glich tun, indem Sie Select () manuell schreiben.  Nicht schwer, aber langweilig. <br><br><img src="https://habrastorage.org/webt/1r/co/xd/1rcoxdmbzmuplg1vyuvkz5hrrqg.png"><br><br>  Stattdessen schlage ich vor, dass jeder ProjectToType () verwendet.  Zumindest gibt es zwei Bibliotheken, die dies tun k√∂nnen: Automapper und Mapster.  Aus irgendeinem Grund wissen sehr viele Leute, dass AutoMapper Mapping im Speicher durchf√ºhren kann, aber nicht jeder wei√ü, dass es abfragbare Erweiterungen hat, es hat auch Ausdruck und es kann einen SQL-Ausdruck erstellen.  Wenn Sie immer noch manuelle Abfragen schreiben und LINQ verwenden, macht es keinen Sinn, dies mit Ihren H√§nden zu tun, da dies keine besonders schwerwiegenden Leistungsbeschr√§nkungen sind. Dies ist die Arbeit der Maschine, nicht der Person. <br><br><h1>  Filtern </h1><br>  Wenn wir dies mit Projektionen tun k√∂nnen, warum nicht zum Filtern. <br><br><img src="https://habrastorage.org/webt/wg/ei/pd/wgeipdnvwwusix--gk7_zch9nhs.png"><br><br>  Hier ist auch der Code.  Ein Filter kommt herein.  Viele Gesch√§ftsanwendungen sehen folgenderma√üen aus: Ein Filter kam, f√ºge Where () hinzu, ein anderer Filter kam, f√ºge Where () hinzu.  Wie viele Filter gibt es, so viele und wiederholen.  Nichts kompliziertes, aber viel Kopieren und Einf√ºgen. <br><br><img src="https://habrastorage.org/webt/fd/7r/wl/fd7rwlnpkuiluiadq0zppn7_t-y.png"><br><br>  Wenn wir als AutoMapper AutoFilter, Project und Filter schreiben, damit er alles selbst macht, w√§re das cool - weniger Code. <br><br><img src="https://habrastorage.org/webt/9g/es/tg/9gestgfo-ouzbolexklhu78gv8q.png"><br><br>  Das ist nichts kompliziertes.  Nehmen Sie Expression.Property, gehen Sie durch das DTO und im Wesentlichen.  Wir finden gemeinsame Eigenschaften, die identisch genannt werden.  Wenn sie gleich hei√üen, sieht es aus wie ein Filter. <br><br>  Als N√§chstes m√ºssen Sie nach null suchen, eine Konstante verwenden, um den Wert von DTO abzurufen, ihn im Ausdruck zu ersetzen und die Konvertierung hinzuzuf√ºgen, falls Sie Int und NullableInt oder eine andere Nullable haben, damit die Typen √ºbereinstimmen.  Und setzen Sie zum Beispiel Equals (), einen Filter, der auf Gleichheit pr√ºft. <br><br><img src="https://habrastorage.org/webt/09/x6/me/09x6mep3p-rrvwo0vodcnke_8eo.png"><br><br>  Sammeln Sie dann Lambda und gehen Sie f√ºr jede Eigenschaft durch: Wenn es viele davon gibt, sammeln Sie entweder durch ‚ÄûUND‚Äú oder ‚ÄûODER‚Äú, je nachdem, wie der Filter f√ºr Sie funktioniert. <br><br><img src="https://habrastorage.org/webt/ha/vw/en/havwen3xvrbraul6plgdadjjusy.png"><br><br>  Dasselbe kann f√ºr das Sortieren getan werden, ist jedoch etwas komplizierter, da die OrderBy () -Methode zwei Generika enth√§lt. Sie m√ºssen sie also mit Ihren H√§nden ausf√ºllen, mithilfe von Reflections die OrderBy () -Methode aus zwei Generika erstellen und den Typ der Entit√§t einf√ºgen, die wir verwenden, den Typ der Sortierbarkeit Eigentum.  Im Allgemeinen k√∂nnen Sie dies auch tun, es ist nicht schwierig. <br><br>  Es stellt sich die Frage: Wo soll Where () platziert werden - auf Unternehmensebene, wie die Spezifikationen angek√ºndigt wurden, oder nach der Projektion, und dort und dort wird es funktionieren. <br><br><img src="https://habrastorage.org/webt/e1/4g/4g/e14g4gelsidqhaeq7avs0wgp51i.png"><br><br>  Es ist beides wahr, und so, weil die Spezifikationen per Definition Gesch√§ftsregeln sind und wir sie sch√§tzen und sch√§tzen m√ºssen und keinen Fehler mit ihnen machen m√ºssen.  Dies ist eine eindimensionale Schicht.  Bei Filtern geht es mehr um die Benutzeroberfl√§che, dh sie filtern nach DTO.  Daher k√∂nnen Sie zwei Where () einf√ºgen.  Es gibt wahrscheinlichere Fragen, wie gut der Abfrageanbieter damit umgehen wird, aber ich glaube, dass ORM-L√∂sungen sowieso schlechtes SQL schreiben, und es wird nicht viel schlimmer sein.  Wenn Ihnen das sehr wichtig ist, dann handelt diese Geschichte √ºberhaupt nicht von Ihnen. <br><br><img src="https://habrastorage.org/webt/46/wn/kc/46wnkcjkjayv9boma0pot5of0rs.png"><br><br>  Wie sie sagen, ist es besser, einmal zu sehen als hundertmal zu h√∂ren. <br>  Jetzt hat der Laden drei Produkte: Snickers, Subaru Impreza und Mars.  Seltsamer Laden.  Versuchen wir, Snickers zu finden.  Es gibt.  Mal sehen, was hundert Rubel.  Auch Snickers.  Und f√ºr 500?  Vergr√∂√üern, da ist nichts.  Und f√ºr den 100500 Subaru Impreza.  Gro√üartig, das gleiche gilt f√ºr das Sortieren. <br><br>  Alphabetisch und nach Preis sortieren.  Der Code dort ist genauso geschrieben wie er war.  Diese Filter funktionieren f√ºr alle Klassen.  Wenn Sie versuchen, nach Namen zu suchen, ist auch Subaru vorhanden.  Und in meiner Pr√§sentation war Equals ().  Wie so?  Tatsache ist, dass der Code hier und in der Pr√§sentation etwas anders ist.  Ich habe die Zeile √ºber Equals () auskommentiert und eine spezielle Stra√üenmagie hinzugef√ºgt.  Wenn wir den String-Typ haben, brauchen wir nicht Equals (), sondern rufen StartWith () auf, das ich auch erhalten habe.  Daher wird f√ºr die Zeilen ein anderer Filter erstellt. <br><br><img src="https://habrastorage.org/webt/t7/fa/kp/t7fakpf7peg_v2swpq2xwksiecu.png"><br><br>  Dies bedeutet, dass Sie hier Strg + Umschalt + R dr√ºcken, die Methode ausw√§hlen und nicht wenn schreiben, sondern wechseln k√∂nnen, oder sogar das Muster ‚ÄûStrategie‚Äú implementieren und dann verr√ºckt werden k√∂nnen.  Sie k√∂nnen alle W√ºnsche bez√ºglich des Betriebs von Filtern verwirklichen.  Es h√§ngt alles von den Typen ab, mit denen Sie arbeiten.  Am wichtigsten ist, dass Filter gleich funktionieren. <br><br>  Sie k√∂nnen zustimmen, dass Filter in allen UI-Elementen folgenderma√üen funktionieren sollten: Zeichenfolgen werden auf eine Weise durchsucht, Geld wird auf eine andere Weise durchsucht.  Koordinieren Sie dies alles, schreiben Sie einmal, alles wird in verschiedenen Schnittstellen korrekt ausgef√ºhrt, und kein anderer Entwickler wird es besch√§digen, da sich dieser Code nicht auf Anwendungsebene befindet, sondern irgendwo entweder in einer externen Bibliothek oder in Ihrem Kernel. <br><br><h1>  Validierung </h1><br>  Zus√§tzlich zum Filtern und Projizieren k√∂nnen Sie eine Validierung durchf√ºhren.  Die JS-Bibliothek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">TComb.validation</a> hatte diese Idee.  TComb ist eine Abk√ºrzung f√ºr Typkombinatoren und basiert auf einem Typsystem und so weiter. refinement', . <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// null and undefined validate('a', t.Nil).isValid(); // =&gt; false validate(null, t.Nil).isValid(); // =&gt; true validate(undefined, t.Nil).isValid(); // =&gt; true // strings validate(1, t.String).isValid(); // =&gt; false validate('a', t.String).isValid(); // =&gt; true // numbers validate('a', t.Number).isValid(); // =&gt; false validate(1, t.Number).isValid(); // =&gt; true</span></span></code> </pre> <br>   ,    JS,    nill,   undefined,  . <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// a predicate is a function with signature: (x) -&gt; boolean var predicate = function (x) { return x &gt;= 0; }; // a positive number var Positive = t.refinement(t.Number, predicate); validate(-1, Positive).isValid(); // =&gt; false validate(1, Positive).isValid(); // =&gt; true</span></span></code> </pre> <br>   .       .      ,    x &gt;= 0   ,   Positive.         . , ,   -. <br><br><img src="https://habrastorage.org/webt/ha/wx/lj/hawxljvmttn1bc0rhh5k4fvtywe.png"><br><br>  .    refinement,    C#,   IsValid(),   Expression , .       . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RefinementAttribute</span></span>: <span class="hljs-title"><span class="hljs-title">ValidationAttribute</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IValidator&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; Refinement { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RefinementAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type refinmentType</span></span></span><span class="hljs-function">)</span></span> { Refinement = (IValidator&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;) Activator.CreateInstance(refinmentType); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsValid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> =&gt; Refinement.Validate(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>).IsValid(); }</code> </pre> <br>     DataAnnotations  ASP.NET MVC,      .  RefinementAttribute(),    .   ,  RefinementAttribute ,      ,        .NET,  . <br><br><img src="https://habrastorage.org/webt/ml/e7/j9/mle7j92pbchiswi1ni7zfvizgou.png"><br><br>     . AdultRefinement,    18. <br><br><img src="https://habrastorage.org/webt/cp/2o/yt/cp2oytz1rrhql042hddkb3va8ug.png"><br><br>    ,        .  NoJS   JS   ,  . ,   C#     ,        JS.       JSX, ES6     JavaScript.   ?  Visitor, ,      JavaScript. <br><br><img src="https://habrastorage.org/webt/lg/qe/9y/lgqe9yl63oz8p8wmlkrmyfmkkky.png"><br><br>     ‚Äî   ,    .    regexp,  StringBuilder,  regexp.      ,   JS ‚Äî    ,      bool ,      .  ,   . <br><br><pre> <code class="cs hljs">{ predicate: ‚Äúx=&gt; (x &gt;= <span class="hljs-number"><span class="hljs-number">18</span></span>)‚Äù, errorMessage: ‚ÄúFor adults only¬ª }</code> </pre> <br>   ,    ,    ,    JS    errorMessage ¬´For adults only¬ª.   .  . ,   . <br><br>  React,       UserRefinment() Expression  errorMessage,  refinment  number,  eval,   .        ,    number,    JS.  , .  ,   ,  false . <br><br><img src="https://habrastorage.org/webt/km/vw/ls/kmvwlsxxw5csttfvkh_rxrpbwpe.png"><br><br>    alert.   onSubmit, alert ,    .      . <br><br><img src="https://habrastorage.org/webt/xj/hm/mz/xjhmmznmn7xgzlcxedk_tgvdzcu.png"><br><br>    Ok(ModelState.IsValid),  User,       JavaScript.    Refinement. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DemoApp.Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">User</span></span>: <span class="hljs-title"><span class="hljs-title">HasNameBase</span></span> { [Refinement(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(AdultRefinement))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Age { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre><br>       ,     .      JavaScript. ,  -  C#,     ,  .   NoJS,    . <br><br><h1>  Testen </h1><br><img src="https://habrastorage.org/webt/jz/fm/y0/jzfmy0ngjejazfvdrf5ld9y8cc4.png"><br><br>         .,   -,   Moq.    mock  -   ‚Äî  moq,    fluent-.  ,             . <br><br>    moq ‚Äî   Expression,  .     ,        Castle.DynamicProxy.       .      . <br><br><img src="https://habrastorage.org/webt/tc/xo/fk/tcxofk6igzdettbtprnfewltn_q.png"><br><br>     ,     Core -  WCF.  ,   WebAPI.     WebAPI,   WCF  WSDL  .  WebAPI   swagger.  swagger ‚Äî   ,       ,  API    .   WCF,   WSDL,     API,  . <br><br>     ,    ,    .    moq    GetResponse&lt;&gt;()    ProductController,  ,    ,  .   ,   ,  Ctrl+Space    ,     ,  ,   , dll  .  Intellisense,   ,    . <br><br> ,  Moq,     ,     ,   ,    API    .   ,  -   ,     ,      ,   POST-  GET-,   ,        ,    Intellisense  expression tree      . ,    ,      Web-. <br><br>  Reflection <br><br>    -,    Reflection. <br><br><img src="https://habrastorage.org/webt/gr/bq/r_/grbqr_q2oqe0rulsblvpejylomk.png"><br><br>  ,  Reflection ,    .        Expression.  ‚Äî   CreateInstance.      ,    Expression.New(),      ,      . <br><br><img src="https://habrastorage.org/webt/8u/me/lv/8umelvrhhu0ctn0gaunjp1ldmxg.png"><br><br>          .     - .  Activator,     ,     . Constructor_Invoke,    .   ‚Äî New  compiled-.       ,   ,   ,   ,     . <br><br><img src="https://habrastorage.org/webt/yr/sv/7k/yrsv7kspmbbmnfjxc1slzkemvx4.png"><br><br>         . <br><br><img src="https://habrastorage.org/webt/gf/2d/4e/gf2d4ebwaltmazxfjicoupxwrbk.png"><br><br>   .    -    Fast Memember    Fast Reflect,     ,    .  ,       , -    .  ,   ,       . <br><br><img src="https://habrastorage.org/webt/hi/x1/e7/hix1e7peelljkkm6kewh4blyhgq.png"><br><br>   ,   ,   , .       ,       ,     .   ,    , -     ,     ,  ,       ,   DSL, Little Languages  -,  . <br><br>       ,   -           ,   .  ,       ,  ,    .       DLR,   ,     IronPython, IronRuby. Expression tree        CLR.      -,            . <br><br><h1>  Zusammenfassung </h1><br>      ,         .   ,     .    ,    ,  -  ,   . <br><br>   ‚Äî    .    100    ,    .    ,     ,       ,      .    Expression Trees,  -      . <br><br>    ,   ,     ,     ,     ,    . <br><br>      ,       ,             .        ,     . <br><br>   ,        ,         Expression, Reflection,  ,  ,      .    ,  ,    API,    ,  Expression    .    . <br><br>      Expression.Compile()    .        ,  Expression' ,    Dictionary  .  -  ,    ,    ,    ,    ,     Compile()   .  ,   . <br><br>    ‚Äî     C#-,    ,   ,    Where(), - implicit- .     MSDN,  .    , ,    ,        ,          ,        ,  StackOverflow   ,     - . <br><br>  ,  ,      .   ,    ,  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>  .     ,        ‚Äî   . <br><blockquote> 22-23     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DotNext 2018 Moscow</a> .       , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>     ( <b>  </b>   ). </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de423891/">https://habr.com/ru/post/de423891/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de423877/index.html">29. bis 31. Oktober: Erstellen eines produktionsbereiten Kubernetes-Clusters</a></li>
<li><a href="../de423879/index.html">Ist es einfach, dem alten Framework neue Funktionen hinzuzuf√ºgen? Mehl der Wahl am Beispiel der Entwicklung von SObjectizer</a></li>
<li><a href="../de423881/index.html">Was waren die Schwei√üer f√ºr Optik (Teil zwei)</a></li>
<li><a href="../de423885/index.html">Eine Einladung zu einer Lichtshow und ein kleiner Insider von der zuk√ºnftigen Circle of Light-Plattform in Moskau</a></li>
<li><a href="../de423889/index.html">Meine Entt√§uschung √ºber Software</a></li>
<li><a href="../de423893/index.html">Hallo Welt f√ºr den Empfang von Daten von einem Bluetooth (BLE) -Ger√§t √ºber C #</a></li>
<li><a href="../de423895/index.html">Sie brauchen keinen Anwalt. Das ist aber nicht sicher</a></li>
<li><a href="../de423897/index.html">N√ºtzliche Tipps zur Verwendung des HyperLynx DDR-Assistenten f√ºr die QDR4-Analyse</a></li>
<li><a href="../de423901/index.html">Wenn Geschwindigkeit und Skalierung ben√∂tigt werden: Server von verteilten iOS-Ger√§ten</a></li>
<li><a href="../de423903/index.html">Eintauchen in AD: Wir analysieren erweiterte Angriffe auf Microsoft Active Directory und wie sie erkannt werden</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>