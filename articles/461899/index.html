<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëñ üò∑ ‚ú® Event Generation, CQRS y Laravel üèùÔ∏è üôéüèø ü§öüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Se prepar√≥ la traducci√≥n del art√≠culo para los estudiantes del curso profesional "Framework Laravel" 
 



 Introduccion 
 Este art√≠culo est√° dedicado...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Event Generation, CQRS y Laravel</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/461899/">  <i>Se prepar√≥ la traducci√≥n del art√≠culo para los estudiantes del curso profesional <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Framework Laravel"</a></i> <i><br></i> <br><img src="https://habrastorage.org/webt/h8/4u/y5/h84uy5i5spnt3rdmpaiw2aynd0s.png"><br><br><hr><br><h2>  Introduccion </h2><br>  Este art√≠culo est√° dedicado a los conceptos b√°sicos de la creaci√≥n de sistemas CQRS de eventos en el lenguaje PHP y en el marco Laravel.  Se supone que est√° familiarizado con el esquema de desarrollo que utiliza el bus de comandos y tiene una idea de los eventos (en particular, la publicaci√≥n de eventos para una variedad de oyentes).  Para actualizar este conocimiento, puede usar el servicio Laracasts.  Adem√°s, se supone que tiene cierta comprensi√≥n del principio CQRS.  Si no, recomiendo escuchar dos conferencias: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Taller de Mathias Verraes sobre Generaci√≥n de eventos</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CQRS y Generaci√≥n de eventos de Greg Young</a> . <br><a name="habracut"></a><br>  ¬°No use el c√≥digo que se proporciona aqu√≠ en sus proyectos!  Es una plataforma de aprendizaje para comprender las ideas detr√°s de CQRS.  Este c√≥digo no se puede llamar confiable, est√° mal probado y, adem√°s, rara vez programo interfaces, por lo que ser√° mucho m√°s dif√≠cil cambiar partes individuales del c√≥digo.  Un ejemplo mucho mejor de un paquete CQRS que puede usar es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Broadway, desarrollado por Qandidate Lab</a> .  Este es un c√≥digo limpio y vagamente acoplado, sin embargo, algunas abstracciones dejan en claro si nunca se ha encontrado con sistemas de eventos. <br><br>  Y el √∫ltimo: mi c√≥digo est√° conectado con eventos y el bus de comando Laravel.  Quer√≠a ver c√≥mo se ver√≠a el c√≥digo en Laravel (generalmente uso este marco para proyectos de peque√±as agencias), sin embargo, mirando hacia atr√°s, creo que deber√≠a crear mis propias implementaciones.  Espero que mi c√≥digo sea claro incluso para aquellos que no usan frameworks. <br><br>  En github, el c√≥digo se encuentra en <a href="">https://github.com/scazz/cqrs-tutorial.git</a> , y en nuestra gu√≠a consideraremos sus componentes para aumentar la l√≥gica. <br><br>  Crearemos un sistema de registro inicial para una escuela de surf.  Con su ayuda, los clientes escolares pueden registrarse para las clases.  Para el proceso de grabaci√≥n, formulamos las siguientes reglas: <br><br><ul><li>  Cada lecci√≥n debe tener al menos un cliente ... </li><li>  ... pero no m√°s de tres. </li></ul><br>  Una de las caracter√≠sticas m√°s impresionantes de los sistemas CQRS basados ‚Äã‚Äãen eventos es la creaci√≥n de modelos de lectura espec√≠ficos para cada m√©trica requerida del sistema.  Encontrar√° ejemplos de proyecci√≥n de modelos de lectura en ElasticSearch, y Greg Young ha implementado un lenguaje orientado a temas en su tienda de eventos para manejar eventos complejos.  Sin embargo, por simplicidad, nuestra proyecci√≥n de lectura ser√° una base de datos SQL est√°ndar para usar con Eloquent.  Como resultado, tendremos una tabla para clases y otra para clientes. <br><br>  El concepto de generaci√≥n de eventos tambi√©n le permite procesar eventos fuera de l√≠nea.  Pero en este art√≠culo me adherir√© al m√°ximo a los modelos de desarrollo "tradicionales" (nuevamente por simplicidad), y nuestras proyecciones de lectura se actualizar√°n en tiempo real, inmediatamente despu√©s de que los eventos se almacenen en el repositorio. <br><br><h2>  Configuraci√≥n del proyecto y primera prueba </h2><br><pre><code class="plaintext hljs">git clone https://github.com/scazz/cqrs-tutorial</code> </pre> <br>  Cree un nuevo proyecto de Laravel 5 <br><br><pre> <code class="plaintext hljs">$&gt; laravel new cqrs-tutorial</code> </pre> <br>  Y para empezar, necesitamos una prueba.  Utilizaremos la prueba de integraci√≥n, que asegurar√° que el registro del cliente para las clases conduzca al hecho de que la lecci√≥n se crea en nuestro modelo Eloquent. <br><br>  Listado de pruebas / CQRSTest.php: <br><br><pre> <code class="plaintext hljs">use Illuminate\Foundation\Bus\DispatchesCommands; class CQRSTest extends TestCase { use DispatchesCommands;</code> </pre><br><pre> <code class="bash hljs">/** *  ,   BookLesson       * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> void */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFiringEventUpdatesReadModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span> = <span class="hljs-string"><span class="hljs-string">'123e4567-e89b-12d3-a456-426655440000'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>); <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertNotNull(Lesson::find(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>)); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals( Lesson::find(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>)-&gt;clientName, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> ); } }</code> </pre> <br>  Asignamos previamente la nueva actividad a una ID, creamos un equipo para inscribirse en una nueva actividad y le decimos a Laravel que la env√≠e.  En la tabla de la lecci√≥n, necesitamos crear un nuevo registro que podamos leer usando el modelo Eloquent.  Necesitamos una base de datos, as√≠ que complete su archivo .env correctamente. <br><br>  Cada evento registrado en nuestra tienda de eventos se adjunta a la ra√≠z del agregado, que simplemente llamaremos entidad (Entidad); una abstracci√≥n con fines educativos solo agrega confusi√≥n.  ID es un identificador √∫nico universal (UUID).  A la tienda de eventos no le importa si el evento se aplica a la lecci√≥n o al cliente.  Solo sabe que est√° asociado con una identificaci√≥n. <br><br>  En funci√≥n de los errores identificados durante las pruebas, podemos crear clases faltantes.  Primero, crearemos la clase LessonId, luego el comando BookLesson (no se preocupe por el m√©todo del controlador todav√≠a, simplemente contin√∫e ejecutando la prueba).  La clase Lecci√≥n es un modelo de lectura fuera del espacio de nombres de la Lecci√≥n.  Un modelo de lectura exclusivo: la l√≥gica del √°rea tem√°tica nunca se almacenar√° aqu√≠.  En conclusi√≥n, necesitaremos crear una migraci√≥n para la tabla de lecciones. <br><br>  Para mantener la claridad del c√≥digo, usar√© la biblioteca de verificaci√≥n de afirmaciones.  Se puede agregar con el siguiente comando: <br><br><pre> <code class="plaintext hljs">$&gt; composer require beberlei/assert</code> </pre> <br>  Considere el proceso que debe iniciar este comando: <br><br><ol><li>  Validaci√≥n: los comandos imperativos pueden fallar, y los eventos ya han ocurrido y, por lo tanto, no deber√≠an fallar. </li><li>  Cree un nuevo evento LessonWasBooked (se inscribi√≥ en una lecci√≥n). </li><li>  Actualiza el estado de la actividad.  (El modelo de registro debe conocer el estado del modelo para que pueda realizar la validaci√≥n). </li><li>  Agregue este evento a la secuencia de eventos no confirmados almacenados en el modelo de registro de actividad. </li><li>  Guarde la secuencia de eventos no confirmados en el repositorio. </li><li>  Genere el evento LessonWasBooked a nivel mundial para informar a todos los proyectores de lectura para actualizar la tabla de lecciones. </li></ol><br>  Primero necesita crear un modelo de grabaci√≥n para la lecci√≥n.  Usaremos el m√©todo est√°tico de f√°brica <code>Lesson::bookClientOntoNewLesson()</code> .  Genera un nuevo evento <code>LessonWasOpened</code> (la lecci√≥n est√° abierta), aplica este evento a s√≠ mismo (solo establece su ID), agrega el nuevo evento a la lista de eventos no confirmados en forma de <code>DomainEventMessage</code> (el evento m√°s algunos metadatos que usamos al guardar en el almac√©n de eventos). <br><br>  El proceso se repite para agregar un cliente al evento.  Al aplicar el evento <code>ClientWasBookedOntoLesson</code> (el cliente se inscribi√≥ en la lecci√≥n), el modelo de grabaci√≥n no rastrea los nombres de los clientes, sino solo el n√∫mero de clientes registrados.  Los modelos de registro no necesitan conocer los nombres de los clientes para garantizar la coherencia. <br><br>  Los m√©todos <code>applyLessonWasOpened</code> y <code>applyClientWasBookedOntoLesson</code> pueden parecer un poco extra√±os en <code>applyClientWasBookedOntoLesson</code> momento.  Los utilizaremos m√°s adelante cuando necesitemos reproducir eventos antiguos para formar el estado del modelo de grabaci√≥n.  No es f√°cil de explicar, as√≠ que le dar√© un c√≥digo que lo ayudar√° a comprender este proceso.  M√°s adelante extraeremos el c√≥digo que procesa eventos no comprometidos y genera mensajes de eventos de dominio. <br><br><pre> <code class="bash hljs">app/School/Lesson/Lesson.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> openLesson( LessonId <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ) { /*      ,      ,       */ <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;apply( new LessonWasOpened( <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>) ); } protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyLessonWasOpened( LessonWasOpened <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId = <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;getLessonId(); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients = 0; } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> bookClient( <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients &gt;= 3) { throw new TooManyClientsAddedToLesson(); } <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;apply( new ClientBookedOntoLesson( <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>) ); } /** *       ‚Äî *  ,       *      ,       , *      . */ protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyClientBookedOntoLesson( ClientBookedOntoLesson <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients++; }</code> </pre> <br>  Podemos extraer los componentes CQRS de nuestro modelo de grabaci√≥n: fragmentos de la clase involucrados en el procesamiento de eventos no confirmados.  Tambi√©n podemos borrar la API para una entidad generada por eventos creando una funci√≥n segura <code>apply()</code> que acepte el evento, llame al m√©todo <code>applyEventName()</code> correspondiente y agregue un nuevo evento <code>DomainEventMessage</code> a la lista de eventos no confirmados.  La clase extra√≠da es un detalle de la implementaci√≥n de CQRS y no contiene l√≥gica de dominio, por lo que podemos crear un nuevo espacio de nombres: App \ CQRS: <br><br>  <i>Presta atenci√≥n al c√≥digo de la <code>app/CQRS/EventSourcedEntity.php</code></i> <i><br></i>  <i>Para que el c√≥digo funcione, necesitamos agregar la clase <code>DomainEventMessage</code> , que es un DTO simple; se puede encontrar en <code>app/CQRS/DomainEventMessage.php</code></i> <br><br>  Por lo tanto, obtuvimos un sistema que genera eventos para cada intento de escritura y utiliza eventos para registrar los cambios necesarios para evitar invariantes.  El siguiente paso es guardar estos eventos en la tienda (EventStore).  En primer lugar, es necesario crear este repositorio de eventos.  Para simplificar, usaremos el modelo Eloquent, una tabla simple de SQL con los siguientes campos: * <code>UUID</code> (para saber a qu√© entidad aplicar el evento) * <code>event_payload</code> (mensaje serializado que contiene todo lo necesario para recrear el evento) * <code>event_payload</code> - timestamp para saber cu√°ndo el evento sucedi√≥  Si revisa cuidadosamente el c√≥digo, ver√° que cre√© dos comandos: para crear y destruir nuestra tabla de almacenamiento de eventos: <br><br><ul><li>  php artisan eloquenteventstore: create (App \ CQRS \ EloquentEventStore \ CreateEloquentEventStore) </li><li>  php artisan eloquenteventstore: drop (App \ CQRS \ EloquentEventStore \ DropEloquentEventStore) (no olvide agregarlos a App \ Console \ Kernel.php para que se carguen). </li></ul><br>  Hay dos muy buenas razones para no usar SQL como un almac√©n de eventos: no implementa el modelo de solo agregado (solo agrega datos, los eventos deben ser inmutables) y tambi√©n porque SQL no es un lenguaje de consulta ideal para bases de datos temporales.  Programamos la interfaz para facilitar el reemplazo de la tienda de eventos en publicaciones posteriores. <br><br>  Para guardar eventos, use el repositorio.  Cada vez que se llama <code>save()</code> para el modelo de grabaci√≥n, guardamos la lista de eventos no comprometidos en el almac√©n de eventos.  Para almacenar eventos, necesitamos un mecanismo para su serializaci√≥n y deserializaci√≥n.  Crea un serializador para esto.  Necesitamos metadatos, como una clase de evento (por ejemplo, <code>App\School\Lesson\Events\LessonWasOpened</code> ) y una carga √∫til del evento (datos necesarios para reconstruir un evento). <br><br>  Todo esto se codificar√° en formato JSON y luego se escribir√° en nuestra base de datos junto con el UUID de la entidad y la marca de tiempo.  Queremos actualizar nuestros modelos de lectura despu√©s de capturar eventos, por lo que el repositorio activar√° cada evento despu√©s de guardar.  El serializador ser√° responsable de escribir la clase de evento, mientras que el evento ser√° responsable de serializar su carga √∫til.  Un evento completamente serializado se ver√° as√≠: <br><br><pre> <code class="plaintext hljs"> { class: "App\\School\\Lesson\\Events\\", event: $event-&gt;serialize() }</code> </pre> <br>  Dado que todos los eventos requieren un m√©todo de serializaci√≥n y deserializaci√≥n, podemos crear una interfaz <code>SerializableEvent</code> y agregar una indicaci√≥n del tipo de valor esperado.  Actualice nuestro evento <code>LessonWasOpened</code> : <br><br><pre> <code class="bash hljs">app/School/Lesson/Events/LessonWasOpened.php class LessonWasOpened implements SerializableEvent { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array( <span class="hljs-string"><span class="hljs-string">'lessonId'</span></span>=&gt; (string) <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getLessonId() ); } }</code> </pre> <br>  Crear un repositorio de <code>LessonRepository</code> .  Podemos refactorizar y extraer los componentes centrales de CQRS m√°s adelante. <br><br> <code>app/School/Lesson/LessonRepository.php</code> <br> <pre> <code class="plaintext hljs">eventStoreRepository = new EloquentEventStoreRepository( new EventSerializer() ); } public function save(Lesson $lesson) { /** @var DomainEventMessage $domainEventMessage */ foreach( $lesson-&gt;getUncommittedDomainEvents() as $domainEventMessage ) { $this-&gt;eventStoreRepository-&gt;append( $domainEventMessage-&gt;getId(), $domainEventMessage-&gt;getEvent(), $domainEventMessage-&gt;getRecordedAt() ); Event::fire($domainEventMessage-&gt;getEvent()); } } }</code> </pre> <br>  Si ejecuta la prueba de integraci√≥n nuevamente y luego verifica la tabla SQL <code>domain_events</code> , deber√≠a ver dos eventos en la base de datos. <br><br>  Nuestro paso final para pasar la prueba con √©xito es escuchar los eventos de transmisi√≥n y actualizar la proyecci√≥n del modelo de lectura de la Lecci√≥n.  Los eventos de transmisi√≥n de la lecci√≥n ser√°n interceptados por el <code>LessonProjector</code> , que aplicar√° los cambios necesarios a <code>LessonProjection</code> (modelos <code>LessonProjection</code> de la tabla de la lecci√≥n): <br><br><pre> <code class="bash hljs"> app/School/Lesson/Projections/LessonProjector.php class LessonProjector { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyLessonWasOpened( LessonWasOpened <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span> = new LessonProjection(); <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span>-&gt;id = <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;getLessonId(); <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span>-&gt;save(); } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> subscribe(Dispatcher <span class="hljs-variable"><span class="hljs-variable">$events</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$fullClassName</span></span> = self::class; <span class="hljs-variable"><span class="hljs-variable">$events</span></span>-&gt;listen( LessonWasOpened::class, <span class="hljs-variable"><span class="hljs-variable">$fullClassName</span></span>.<span class="hljs-string"><span class="hljs-string">'@applyLessonWasOpened'</span></span>); } }  app/School/Lesson/Projections/LessonProjection.php class LessonProjection extends Model { public <span class="hljs-variable"><span class="hljs-variable">$timestamps</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; protected <span class="hljs-variable"><span class="hljs-variable">$table</span></span> = <span class="hljs-string"><span class="hljs-string">"lessons"</span></span>; }</code> </pre> <br>  Si ejecuta la prueba, ver√° que se ha producido un error de SQL: <br><br><pre> <code class="plaintext hljs">Unknown column 'clientName' in 'field list'</code> </pre> <br>  Tan pronto como creamos una migraci√≥n para agregar <code>clientName</code> a la tabla de lecciones, pasaremos la prueba con √©xito.  Hemos implementado la funcionalidad b√°sica de CQRS: los equipos crean eventos que se utilizan para generar modelos de lectura. <br><br><h2>  Mejorando el modelo de lectura con enlaces </h2><br>  ¬°Hemos alcanzado un hito significativo, pero eso no es todo!  Hasta ahora, el modelo de lectura solo admite un cliente (especificamos tres en nuestras reglas de dominio).  Los cambios que hacemos en el modelo de lectura son bastante simples: solo creamos un modelo de proyecci√≥n de Cliente y un <code>ClientProjector</code> que <code>ClientBookedOntoLesson</code> evento <code>ClientBookedOntoLesson</code> .  Primero, actualizamos nuestra prueba para reflejar los cambios que queremos ver en nuestro modelo de lectura: <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFiringEventUpdatesReadModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals( <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;id, (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ); <span class="hljs-variable"><span class="hljs-variable">$client</span></span> = <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients()-&gt;first(); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals(<span class="hljs-variable"><span class="hljs-variable">$client</span></span>-&gt;name, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); }</code> </pre><br>  Esta es una demostraci√≥n clara de la facilidad con que puede cambiar los modelos de lectura.  Todo, hasta el repositorio de eventos, permanece sin cambios.  Como beneficio adicional, cuando usamos el sistema de eventos, obtenemos datos para pruebas b√°sicas: al cambiar el proyector del modelo de lectura, escuchamos cada evento que alguna vez ha sucedido en nuestro sistema. <br><br>  Reproducimos estos eventos usando el nuevo proyector, verificamos las excepciones y comparamos los resultados con proyecciones anteriores.  Despu√©s de que el sistema haya estado funcionando durante alg√∫n tiempo, tendremos una selecci√≥n bastante representativa de eventos para probar nuestros proyectores. <br><br>  Nuestro modelo de grabaci√≥n actualmente no tiene la capacidad de cargar el estado actual.  Si queremos agregar un segundo cliente a la lecci√≥n, simplemente podemos crear un segundo evento ClientWasAddedToLesson, pero no podemos proporcionar protecci√≥n contra los invariantes.  Para mayor claridad, propongo escribir una segunda prueba simulando la grabaci√≥n de dos clientes por lecci√≥n. <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testLoadingWriteModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span> = <span class="hljs-string"><span class="hljs-string">"Fred"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertClientCollectionContains(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients, <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertClientCollectionContains(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients, <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span>); }</code> </pre> <br>  Para nuestro modelo de grabaci√≥n, necesitamos implementar un m√©todo para "cargar" una entidad para la cual los eventos ya se aplican en la tienda de eventos.  Podemos lograr esto reproduciendo cada evento que se refiere al UUID de la entidad.  En t√©rminos generales, el proceso es el siguiente: <br><br><ol><li>  Recibimos todos los mensajes de eventos relevantes de la tienda de eventos. </li><li>  Para cada mensaje, recreamos el evento correspondiente. </li><li>  Creamos un nuevo modelo de registro de entidad y reproducimos cada evento. </li></ol><br>  Por el momento, nuestras pruebas arrojan excepciones, por lo que comenzaremos creando el <code>BookClientOntoLesson</code> necesario (registre un cliente para la lecci√≥n), utilizando el comando <code>BookLesson</code> como plantilla.  El m√©todo del controlador se ver√° as√≠: <br><br><pre> <code class="bash hljs"> app/School/Lesson/Commands/BookClientOntoLesson.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> handle(LessonRepository <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>) { /** @var Lesson <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> */ <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>-&gt;load(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;bookClient(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;clientName); <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>-&gt;save(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>); }      : app/School/Lesson/LessonRepository.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> load(LessonId <span class="hljs-variable"><span class="hljs-variable">$id</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$events</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;eventStoreRepository-&gt;load(<span class="hljs-variable"><span class="hljs-variable">$id</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = new Lesson(); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;initializeState(<span class="hljs-variable"><span class="hljs-variable">$events</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>; }</code> </pre> <br>  La funci√≥n de carga del repositorio devuelve una matriz de eventos recreados.  Para hacer esto, primero encuentra mensajes sobre eventos en el repositorio y luego los pasa al <code>Serializer</code> para convertir cada mensaje en un evento.  <code>Serializer</code> crea mensajes a partir de eventos, por lo que debemos agregar el m√©todo <code>deserialize()</code> para realizar la transformaci√≥n inversa.  Recuerde que el <code>Serializer</code> se pasa a cada evento para serializar los datos del evento (por ejemplo, el nombre del cliente).  Haremos lo mismo para realizar la transformaci√≥n inversa, mientras que nuestra interfaz <code>SerializableEvent</code> debe actualizarse utilizando el m√©todo <code>deserialize()</code> .  Miremos el c√≥digo para que todo encaje en su lugar.  Primero est√° la <code>EventStoreRepository</code> carga <code>EventStoreRepository</code> : <br><br><pre> <code class="bash hljs">app/CQRS/EloquentEventStore/EloquentEventStoreRepository.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> load(<span class="hljs-variable"><span class="hljs-variable">$uuid</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$eventMessages</span></span> = EloquentEventStoreModel::<span class="hljs-built_in"><span class="hljs-built_in">where</span></span>(<span class="hljs-string"><span class="hljs-string">'uuid'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$uuid</span></span>)-&gt;get(); <span class="hljs-variable"><span class="hljs-variable">$events</span></span> = []; foreach(<span class="hljs-variable"><span class="hljs-variable">$eventMessages</span></span> as <span class="hljs-variable"><span class="hljs-variable">$eventMessage</span></span>) { /*       event_payload,        . */ <span class="hljs-variable"><span class="hljs-variable">$events</span></span>[] = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;eventSerializer-&gt;deserialize( json_decode(<span class="hljs-variable"><span class="hljs-variable">$eventMessage</span></span>-&gt;event_payload)); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$events</span></span>; }</code> </pre><br>  Usando la funci√≥n de deserializaci√≥n apropiada en <code>eventSerializer</code> : <br><br><pre> <code class="bash hljs">app/CQRS/Serializer/EventSerializer.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> serialize( SerializableEvent <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array( <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; get_class(<span class="hljs-variable"><span class="hljs-variable">$event</span></span>), <span class="hljs-string"><span class="hljs-string">'payload'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;serialize() ); } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> deserialize( <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$eventClass</span></span> = <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span>-&gt;class; <span class="hljs-variable"><span class="hljs-variable">$eventPayload</span></span> = <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span>-&gt;payload; <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$eventClass</span></span>::deserialize(<span class="hljs-variable"><span class="hljs-variable">$eventPayload</span></span>); }</code> </pre> <br>  En conclusi√≥n, utilizaremos el m√©todo de f√°brica est√°tico <code>deserialize()</code> en <code>LessonWasOpened</code> (necesitamos agregar este m√©todo a cada evento) <br><br><pre> <code class="bash hljs">app/School/Lesson/Events/LessonWasOpened.php public static <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> deserialize(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>-&gt;lessonId); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> new self(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>); }</code> </pre> <br>  Ahora tenemos una matriz de todos los eventos que acabamos de reproducir en relaci√≥n con nuestro modelo de registro de entidad para inicializar el estado en el m√©todo <code>initializeState</code> en <code>app/CQRS/EventSouredEntity.php</code> <br><br>  Ahora ejecuta nuestra prueba.  Bingo! <br>  De hecho, por el momento no tenemos una prueba para verificar el cumplimiento de nuestras reglas de dominio, as√≠ que escrib√°moslo: <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMoreThan3ClientsCannotBeAddedToALesson</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"bob"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"george"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"fred"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;setExpectedException( TooManyClientsAddedToLesson::class ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"emma"</span></span>) ); }</code> </pre> <br>  Tenga en cuenta que solo necesitamos <code>lessonId</code> : esta prueba reinicializa el estado de la lecci√≥n durante cada comando. <br><br>  Por el momento, simplemente transferimos <code>UUID</code> creados manualmente, mientras que en realidad queremos generarlos autom√°ticamente.  Voy a usar el paquete <code>Ramsy\UUID</code> , as√≠ que vamos a instalarlo con el <code>composer</code> : <br><br><pre> <code class="plaintext hljs">$&gt; composer require ramsey/uuid</code> </pre> <br>  Ahora actualice nuestras pruebas para usar el nuevo paquete: <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testEntityCreationWithUUIDGenerator</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"bob"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertInstanceOf( Lesson::class, Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>) ); }</code> </pre><br>  Ahora el nuevo desarrollador del proyecto puede mirar el c√≥digo, ver <code>App\School\ReadModels</code> , que contiene un conjunto de modelos Eloquent, y usar estos modelos para escribir cambios en la tabla de lecciones.  Podemos evitar esto creando una clase <code>ImmutableModel</code> que ampl√≠e la clase Eloquent Model y anule el m√©todo de guardar en <code>app/CQRS/ReadModelImmutableModel.php</code> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/461899/">https://habr.com/ru/post/461899/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461885/index.html">EDS es otro tipo de fraude</a></li>
<li><a href="../461887/index.html">Entrando en Aeronet Episodio 2: Homing Drone</a></li>
<li><a href="../461891/index.html">C√≥mo nos hicimos amigos en la infraestructura bancaria usando ManageIQ</a></li>
<li><a href="../461895/index.html">Aprenda mientras viaja: c√≥mo conducimos el 1er D√≠a Europeo del An√°lisis Empresarial</a></li>
<li><a href="../461897/index.html">C√≥mo mantenemos la estabilidad de la aplicaci√≥n Lamoda</a></li>
<li><a href="../461901/index.html">Tres a√±os de autotest: c√≥mo aumentar la velocidad y no solo</a></li>
<li><a href="../461903/index.html">Adversario misterioso: pr√©stamos borrosos</a></li>
<li><a href="../461905/index.html">Tic Tac Toe, parte 7: pytest y Travis CI</a></li>
<li><a href="../461907/index.html">An√°lisis de productos en un estudio de ciclo completo.</a></li>
<li><a href="../461913/index.html">Usabilidad m√≥vil en comercio electr√≥nico: an√°lisis de las tiendas en l√≠nea TOP-20 en Rusia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>