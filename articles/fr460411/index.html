<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏻‍🔬 🤲🏻 🏉 Mad Converter GIF'ok en autocollants animés pour Telegram 🏇 🏽 💿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Au lieu de mille mots ... 


 xZibit est également content, car ici les GIF sont insérés dans des autocollants pour être insérés dans des GIF pour KDP...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mad Converter GIF'ok en autocollants animés pour Telegram</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460411/">  <i>Au lieu de mille mots ...</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z_/rg/73/z_rg73ltg3tgl4zh602urowmjps.gif"></div><br>  <i>xZibit est également content, car ici les GIF sont insérés dans des autocollants pour être insérés dans des GIF pour KDPV!</i> <br><br>  Et maintenant sur les détails de mise en œuvre. <br><a name="habracut"></a><br>  Tout a commencé par une discussion dans le chat du développeur Telegram sur la fonctionnalité à venir: <br><br><img src="https://habrastorage.org/webt/zu/s5/x1/zus5x1ydd89sejezp98ztbnygto.png" alt="Bohdan Horbeshko, [04/04/19 20:21] Hmm, mais le bot n'acceptera probablement que des gifs, puis convertira ... | Vitaly, [07/04/19 20:22] du gif à Jason? J'aurais regardé :))) | Bohdan Horbeshko, [04.07.19 20:22] Et pourquoi pas? Il existe un éditeur de modèles PlayCanvas dans JSON. | Vitaly, [04/04/19 8:23 pm] et comment est le gif? exporter pixel par pixel? :) | Bohdan Horbeshko, [04/04/19 20:24] Bien sûr, le monde informatique a vu et ne tolérera pas de telles distorsions."><br><br>  Un homme a dit - un homme l'a fait!  Le premier prototype dans Pillow et svgwrite, analysant les GIF en pixels et les convertissant en carrés vectoriels avec des aperçus en SVG, a été écrit en un jour de congé. <br><br>  Le plaisir a commencé plus loin ... <br><br><h3>  JSON est un format ouvert, ils ont dit ... </h3><br>  Jusqu'à présent, avec les formats de Telegram, ils ne cessaient de tromper.  Prise en charge des animations GIF - en fait, elles sont converties en vidéo MP4.  Prise en charge des autocollants - ils sont téléchargés en PNG, mais convertis en WebP.  Cette fois, tout est plus honnête: celui à l'entrée, puis à la sortie. <br><br>  Pour les autocollants animés, Telegram n'utilise pas de GIF, de vidéos ou même un format graphique vectoriel bien établi tel que SVG, ou, Dieu nous en préserve Cthulhu!  - Flash.  Il utilise un nouveau format issu de l'aile d'Airbnb - Lottie.  Jusqu'à présent, il avait une certaine renommée parmi les développeurs mobiles, mais grâce à Telegram, il pourrait gagner en popularité. <br><br>  Essentiellement, les fichiers Lottie sont des projets Adobe After Effects sérialisés en JSON qui maximisent toutes les fonctionnalités de ce programme.  Avec l'écran, hélas, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tout n'est pas si rose</a> .  Bien qu'il existe de nombreuses implémentations «officielles» de la bibliothèque pour le rendu de Lottie, uniquement pour les plates-formes couvertes par Telegram: Android, iOS, Qt et Web - seule une partie des capacités du format est implémentée dans chacune d'elles.  Telegram est allé encore plus loin et a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">limité la</a> liste des fonctionnalités prises en charge, ainsi que "est venu" avec son propre format, qui diffère de l'habituel Lottie juste en emballant dans GZip et le paramètre <code>"tgs": 1</code> .  Je pense que je sais où Denis Popov travaille maintenant!  :-) <br><br>  Et si tout va bien avec la documentation des bibliothèques pour différentes plates-formes, alors, hélas, il n'a pas été possible de trouver au moins une description du périphérique de formatage - uniquement le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">schéma JSON</a> dans les sources de lottie-web.  J'ai dû bricoler en cours de route dans des animations existantes afin de comprendre les concepts généraux du format.  Il y avait également des écarts entre les fichiers réels et le schéma: en particulier, dans les <a href="">couches de type 4</a> , selon le schéma, les objets imbriqués sont stockés dans la propriété <code>"it"</code> - cependant, dans les fichiers réels, la clé est appelée <code>"shapes"</code> et <code>"it"</code> ne fonctionne pas. <br><br>  Les nuances clarifiées du format: <br><br><ul><li>  Un fichier est composé de couches.  Contrairement au GIF, chaque couche peut avoir une heure de début et de fin arbitraire pour l'affichage.  Différentes transformations peuvent <b>être</b> appliquées au calque (plus précisément, <b>c'est nécessaire</b> ): mise à l'échelle, rotation, changement de transparence, etc.  Les couches peuvent même être tridimensionnelles (interdites pour Telegram). </li><li>  Un calque est constitué de «formes».  Ils ont de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nombreux</a> types, certains ne peuvent pas être utilisés dans Telegram.  En pratique, pour qu'un calque apparaisse, il doit comprendre trois formes: un chemin (dans les animations terminées, il s'agit généralement du type <code>"sh"</code> - courbes de Bézier; le convertisseur utilise jusqu'à présent uniquement le type <code>"rc"</code> - rectangles), le remplissage (le type <code>"fl"</code> ) et la transformation ( tapez <code>"tr"</code> ). </li><li>  Vous pouvez même inclure des éléments raster, créer des calques de texte et établir des relations entre les paramètres de calque et de forme via des expressions.  Tous ces goodies sont également interdits sur Telegram. </li></ul><br>  Le premier problème découle directement d'ici: la <b>redondance</b> .  Bien que des valeurs par défaut pour les paramètres de transformation aient récemment été ajoutées au schéma JSON, elles ne sont pas implémentées dans les bibliothèques.  Il est donc toujours nécessaire de leur demander explicitement. <br><br>  Il semblerait que ce ne soit pas du tout un problème?  Même un simple GZip fait un bon travail de compression des données qui se répètent de manière flagrante, et 1 Mo de JSON brut se transforme comme par magie en quelques dizaines de kilo-octets, qui se glissent tranquillement dans la limite déclarée de 64 Ko.  Ça y était! <br><br>  Je charge, ce qui signifie une animation joufflue qui affiche calmement lottie-web dans Telegram - et ici au lieu d'un pixel art conditionnellement beau, le regard flou statique qui me regarde est le suivant: <br><br><img src="https://habrastorage.org/webt/vd/10/_x/vd10_xlbyqsapibkpdsqndlplai.png"><br><br>  Qu'est-ce que c'est?!  Mais il s'est avéré qu'il y a clairement une <b>limite</b> non spécifiée <b>de 1 Mo</b> sur les données décompressées.  Un représentant de l'équipe Telegram l'a rapidement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">confirmé</a> et a annoncé la prochaine augmentation de la limite à 2 Mo. <br><br>  Même s'ils résolvent ces problèmes, les autocollants qui dépassent 1 Mo de données non compressées et ne contiennent pas de transformations seront inaccessibles aux utilisateurs des anciennes versions de Telegram.  Il devra donc probablement se conformer aux restrictions à l'avenir. <br><br><h3>  La transparence est importante. </h3><br>  Pillow, avec OpenCV, peut être appelé la norme industrielle pour le traitement d'image en Python.  De plus, il est également bien affiné pour les fonctionnalités GIF: il prend en charge les couleurs indexées et donne accès à la palette.  Il prend en charge la conversion d'une carte de pixels en un tableau NumPy, ce qui est important pour un traitement productif.  Recueille même des statistiques sur les couleurs!  Mais il y avait aussi des inconvénients: <br><br><ol><li>  Il n'y avait aucun moyen documenté d'obtenir l'indice de couleur transparent.  J'ai dû supposer comme solution temporaire que la couleur transparente est la plus courante, mais dans les vrais GIF, ce n'est pas toujours le cas. </li><li>  La même chose avec un délai entre les images: Pillow ne donne que les images elles-mêmes comme une séquence d'images, sans information sur les délais. </li><li>  Parfois, des trames partielles sont incorrectement superposées. </li></ol><br>  J'ai donc dû chercher un remplaçant.  Le module <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gif2numpy a</a> agi comme tel.  Il est «affiné» pour les fonctionnalités GIF et donne accès à toutes les propriétés techniques de l'image et des cadres individuels, y compris <abbr title="Extension de contrôle graphique">GCE</abbr> .  Ainsi, il résout le problème des retards de lecture. <br><br>  La transparence, comme il s'est avéré, gif2numpy ne la prend pas en charge du tout: les couleurs sont immédiatement converties en trois canaux avec une profondeur de bits en octets, sans prendre en compte la profondeur de bits et enregistrer les indices de couleur.  Heureusement, le module se compose d'un fichier, il n'a donc pas été difficile de l'inclure dans le projet et de le modifier en réservant la couleur <code>#FE00FE</code> pour la transparence. <br><br>  Le problème de trame partielle n'était pas trivial à résoudre.  gif2numpy <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">essaie de superposer de</a> telles images sur la précédente, mais il ne vérifie pas les paramètres de superposition, c'est pourquoi le résultat correct ne sort pas toujours.  Afin de ne pas <code>gifsicle</code> avec les drapeaux, un traitement d'image préliminaire à l'aide de <code>gifsicle</code> avec la clé <code>--unoptimize</code> est <code>--unoptimize</code> - il convertit les images partielles en images complètes.  Et en même temps, cela les conduit à utiliser la palette globale, ce qui a éliminé la nécessité de traiter séparément la couleur transparente lors de l'utilisation de votre propre palette de cadres. <br><br><h3>  Serre-moi plus fort </h3><br>  Les carrés sont bons, mais avec de telles limitations, vous devez faire preuve de plus d'imagination, sinon même les GIF miniatures ne «glisseront» pas dans Telegram. <br><br>  Quelque chose de similaire à <abbr title="Encodage de longueur de course">RLE a été utilisé en premier</abbr> : les carrés adjacents horizontalement de la même couleur sont combinés en un seul rectangle. <br><br>  Ensuite, l'exploitation des fonctionnalités de Lottie.  Étant donné que chaque couche a une heure de début et de fin arbitraire, vous pouvez appliquer une technique qui a longtemps été utilisée par les codecs vidéo, et en partie dans GIF lui-même: les carrés qui restent au même endroit pour plusieurs images peuvent être fusionnés en une seule couche, pendant laquelle l'affichage change plusieurs autres.  Ce qui n'est mis en œuvre jusqu'à présent que pour des paires de couches adjacentes. <br><br><h3>  Plans de développement </h3><br>  Les idées qui peuvent être appliquées ici sont en vrac: <br><br><ul><li>  <b>Reconnaissez les zones monochromes de toute taille.</b>  Vous pouvez les diviser en un ensemble de rectangles, pour lesquels il existe un <a href="">bon algorithme</a> .  Il est également conseillé de les convertir en contour, mais cela est éclipsé par la nécessité d'indiquer tous les points des courbes de Bézier en Lottie - les rectangles dans certains cas peuvent être plus avantageux. </li><li>  <b>Reconnaissez le mouvement.</b>  Encore une fois, la technique est utilisée dans les codecs vidéo.  Si le même contour ne change pas de forme d'un cadre à l'autre, mais uniquement les coordonnées - au lieu de le dupliquer sur plusieurs couches, placez-le sur une couche avec transformation. </li><li>  <b>Reconnaître la «couverture» d'une zone avec une autre.</b>  Un exemple: <br><br><pre> <code class="plaintext hljs">...... .O..O. ...... .OOOO. ......</code> </pre><br>  Les pixels d'une couleur différente sont superposés sur un rectangle d'une couleur.  Au lieu de casser ce rectangle en un tas de petits, ou de le transformer en un contour de forme complexe - vous pouvez simplement les superposer sur le rectangle entier. </li><li>  <b>Vectorisation des courbes et ellipses, reconnaissance des gradients.</b>  Cela gâchera le charme des pixels, mais cela améliorera la compressibilité de certains GIF par ordre de grandeur.  Les dégradés sont même dans les "Koloboks" antédiluviens, je vous le garantis! <img src="https://habrastorage.org/getpro/habr/post_images/98f/cc9/e83/98fcc9e832a79a6a2ffeb8f7fd2a64ae.gif" alt=": D"></li><li>  <b>Compression avec perte.</b>  Tout d'abord, l'élimination du tramage, et même dans des images excessivement lisses, n'entravera pas la modération des couleurs.  Le gifsicle susmentionné s'en occupera probablement. </li></ul><br><h3>  Les références </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sources</a> .  Effrayant par endroits. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Chaîne</a> sur laquelle je télécharge des packs de GIF convertis avec succès. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460411/">https://habr.com/ru/post/fr460411/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460397/index.html">Démarrage rapide avec WebComponents</a></li>
<li><a href="../fr460399/index.html">Indicateur de chargement SVG sur Vue.js</a></li>
<li><a href="../fr460403/index.html">Avantages et inconvénients des HugePages</a></li>
<li><a href="../fr460405/index.html">Pourquoi avez-vous besoin de mécanismes de jeu cachés</a></li>
<li><a href="../fr460409/index.html">Arduino et claviers (guide complet)</a></li>
<li><a href="../fr460413/index.html">7 sites et applications utiles pour apprendre l'anglais</a></li>
<li><a href="../fr460415/index.html">Apple Watch 4 (44 mm, 2019) vs Pebble Steel Classic (2014)</a></li>
<li><a href="../fr460419/index.html">Récupération de chaleur des fumées: respectueuse de l'environnement</a></li>
<li><a href="../fr460421/index.html">Commutateur optique TP-Link T2600G-28SQ pour les fournisseurs de services: un examen détaillé</a></li>
<li><a href="../fr460423/index.html">WAL dans PostgreSQL: 3. Checkpoint</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>