<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçüî¨ ü§≤üèª üèâ Mad Converter GIF'ok en autocollants anim√©s pour Telegram üèá üèΩ üíø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Au lieu de mille mots ... 


 xZibit est √©galement content, car ici les GIF sont ins√©r√©s dans des autocollants pour √™tre ins√©r√©s dans des GIF pour KDP...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mad Converter GIF'ok en autocollants anim√©s pour Telegram</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460411/">  <i>Au lieu de mille mots ...</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z_/rg/73/z_rg73ltg3tgl4zh602urowmjps.gif"></div><br>  <i>xZibit est √©galement content, car ici les GIF sont ins√©r√©s dans des autocollants pour √™tre ins√©r√©s dans des GIF pour KDPV!</i> <br><br>  Et maintenant sur les d√©tails de mise en ≈ìuvre. <br><a name="habracut"></a><br>  Tout a commenc√© par une discussion dans le chat du d√©veloppeur Telegram sur la fonctionnalit√© √† venir: <br><br><img src="https://habrastorage.org/webt/zu/s5/x1/zus5x1ydd89sejezp98ztbnygto.png" alt="Bohdan Horbeshko, [04/04/19 20:21] Hmm, mais le bot n'acceptera probablement que des gifs, puis convertira ... | Vitaly, [07/04/19 20:22] du gif √† Jason? J'aurais regard√© :))) | Bohdan Horbeshko, [04.07.19 20:22] Et pourquoi pas? Il existe un √©diteur de mod√®les PlayCanvas dans JSON. | Vitaly, [04/04/19 8:23 pm] et comment est le gif? exporter pixel par pixel? :) | Bohdan Horbeshko, [04/04/19 20:24] Bien s√ªr, le monde informatique a vu et ne tol√©rera pas de telles distorsions."><br><br>  Un homme a dit - un homme l'a fait!  Le premier prototype dans Pillow et svgwrite, analysant les GIF en pixels et les convertissant en carr√©s vectoriels avec des aper√ßus en SVG, a √©t√© √©crit en un jour de cong√©. <br><br>  Le plaisir a commenc√© plus loin ... <br><br><h3>  JSON est un format ouvert, ils ont dit ... </h3><br>  Jusqu'√† pr√©sent, avec les formats de Telegram, ils ne cessaient de tromper.  Prise en charge des animations GIF - en fait, elles sont converties en vid√©o MP4.  Prise en charge des autocollants - ils sont t√©l√©charg√©s en PNG, mais convertis en WebP.  Cette fois, tout est plus honn√™te: celui √† l'entr√©e, puis √† la sortie. <br><br>  Pour les autocollants anim√©s, Telegram n'utilise pas de GIF, de vid√©os ou m√™me un format graphique vectoriel bien √©tabli tel que SVG, ou, Dieu nous en pr√©serve Cthulhu!  - Flash.  Il utilise un nouveau format issu de l'aile d'Airbnb - Lottie.  Jusqu'√† pr√©sent, il avait une certaine renomm√©e parmi les d√©veloppeurs mobiles, mais gr√¢ce √† Telegram, il pourrait gagner en popularit√©. <br><br>  Essentiellement, les fichiers Lottie sont des projets Adobe After Effects s√©rialis√©s en JSON qui maximisent toutes les fonctionnalit√©s de ce programme.  Avec l'√©cran, h√©las, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tout n'est pas si rose</a> .  Bien qu'il existe de nombreuses impl√©mentations ¬´officielles¬ª de la biblioth√®que pour le rendu de Lottie, uniquement pour les plates-formes couvertes par Telegram: Android, iOS, Qt et Web - seule une partie des capacit√©s du format est impl√©ment√©e dans chacune d'elles.  Telegram est all√© encore plus loin et a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">limit√© la</a> liste des fonctionnalit√©s prises en charge, ainsi que "est venu" avec son propre format, qui diff√®re de l'habituel Lottie juste en emballant dans GZip et le param√®tre <code>"tgs": 1</code> .  Je pense que je sais o√π Denis Popov travaille maintenant!  :-) <br><br>  Et si tout va bien avec la documentation des biblioth√®ques pour diff√©rentes plates-formes, alors, h√©las, il n'a pas √©t√© possible de trouver au moins une description du p√©riph√©rique de formatage - uniquement le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sch√©ma JSON</a> dans les sources de lottie-web.  J'ai d√ª bricoler en cours de route dans des animations existantes afin de comprendre les concepts g√©n√©raux du format.  Il y avait √©galement des √©carts entre les fichiers r√©els et le sch√©ma: en particulier, dans les <a href="">couches de type 4</a> , selon le sch√©ma, les objets imbriqu√©s sont stock√©s dans la propri√©t√© <code>"it"</code> - cependant, dans les fichiers r√©els, la cl√© est appel√©e <code>"shapes"</code> et <code>"it"</code> ne fonctionne pas. <br><br>  Les nuances clarifi√©es du format: <br><br><ul><li>  Un fichier est compos√© de couches.  Contrairement au GIF, chaque couche peut avoir une heure de d√©but et de fin arbitraire pour l'affichage.  Diff√©rentes transformations peuvent <b>√™tre</b> appliqu√©es au calque (plus pr√©cis√©ment, <b>c'est n√©cessaire</b> ): mise √† l'√©chelle, rotation, changement de transparence, etc.  Les couches peuvent m√™me √™tre tridimensionnelles (interdites pour Telegram). </li><li>  Un calque est constitu√© de ¬´formes¬ª.  Ils ont de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nombreux</a> types, certains ne peuvent pas √™tre utilis√©s dans Telegram.  En pratique, pour qu'un calque apparaisse, il doit comprendre trois formes: un chemin (dans les animations termin√©es, il s'agit g√©n√©ralement du type <code>"sh"</code> - courbes de B√©zier; le convertisseur utilise jusqu'√† pr√©sent uniquement le type <code>"rc"</code> - rectangles), le remplissage (le type <code>"fl"</code> ) et la transformation ( tapez <code>"tr"</code> ). </li><li>  Vous pouvez m√™me inclure des √©l√©ments raster, cr√©er des calques de texte et √©tablir des relations entre les param√®tres de calque et de forme via des expressions.  Tous ces goodies sont √©galement interdits sur Telegram. </li></ul><br>  Le premier probl√®me d√©coule directement d'ici: la <b>redondance</b> .  Bien que des valeurs par d√©faut pour les param√®tres de transformation aient r√©cemment √©t√© ajout√©es au sch√©ma JSON, elles ne sont pas impl√©ment√©es dans les biblioth√®ques.  Il est donc toujours n√©cessaire de leur demander explicitement. <br><br>  Il semblerait que ce ne soit pas du tout un probl√®me?  M√™me un simple GZip fait un bon travail de compression des donn√©es qui se r√©p√®tent de mani√®re flagrante, et 1 Mo de JSON brut se transforme comme par magie en quelques dizaines de kilo-octets, qui se glissent tranquillement dans la limite d√©clar√©e de 64 Ko.  √áa y √©tait! <br><br>  Je charge, ce qui signifie une animation joufflue qui affiche calmement lottie-web dans Telegram - et ici au lieu d'un pixel art conditionnellement beau, le regard flou statique qui me regarde est le suivant: <br><br><img src="https://habrastorage.org/webt/vd/10/_x/vd10_xlbyqsapibkpdsqndlplai.png"><br><br>  Qu'est-ce que c'est?!  Mais il s'est av√©r√© qu'il y a clairement une <b>limite</b> non sp√©cifi√©e <b>de 1 Mo</b> sur les donn√©es d√©compress√©es.  Un repr√©sentant de l'√©quipe Telegram l'a rapidement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">confirm√©</a> et a annonc√© la prochaine augmentation de la limite √† 2 Mo. <br><br>  M√™me s'ils r√©solvent ces probl√®mes, les autocollants qui d√©passent 1 Mo de donn√©es non compress√©es et ne contiennent pas de transformations seront inaccessibles aux utilisateurs des anciennes versions de Telegram.  Il devra donc probablement se conformer aux restrictions √† l'avenir. <br><br><h3>  La transparence est importante. </h3><br>  Pillow, avec OpenCV, peut √™tre appel√© la norme industrielle pour le traitement d'image en Python.  De plus, il est √©galement bien affin√© pour les fonctionnalit√©s GIF: il prend en charge les couleurs index√©es et donne acc√®s √† la palette.  Il prend en charge la conversion d'une carte de pixels en un tableau NumPy, ce qui est important pour un traitement productif.  Recueille m√™me des statistiques sur les couleurs!  Mais il y avait aussi des inconv√©nients: <br><br><ol><li>  Il n'y avait aucun moyen document√© d'obtenir l'indice de couleur transparent.  J'ai d√ª supposer comme solution temporaire que la couleur transparente est la plus courante, mais dans les vrais GIF, ce n'est pas toujours le cas. </li><li>  La m√™me chose avec un d√©lai entre les images: Pillow ne donne que les images elles-m√™mes comme une s√©quence d'images, sans information sur les d√©lais. </li><li>  Parfois, des trames partielles sont incorrectement superpos√©es. </li></ol><br>  J'ai donc d√ª chercher un rempla√ßant.  Le module <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gif2numpy a</a> agi comme tel.  Il est ¬´affin√©¬ª pour les fonctionnalit√©s GIF et donne acc√®s √† toutes les propri√©t√©s techniques de l'image et des cadres individuels, y compris <abbr title="Extension de contr√¥le graphique">GCE</abbr> .  Ainsi, il r√©sout le probl√®me des retards de lecture. <br><br>  La transparence, comme il s'est av√©r√©, gif2numpy ne la prend pas en charge du tout: les couleurs sont imm√©diatement converties en trois canaux avec une profondeur de bits en octets, sans prendre en compte la profondeur de bits et enregistrer les indices de couleur.  Heureusement, le module se compose d'un fichier, il n'a donc pas √©t√© difficile de l'inclure dans le projet et de le modifier en r√©servant la couleur <code>#FE00FE</code> pour la transparence. <br><br>  Le probl√®me de trame partielle n'√©tait pas trivial √† r√©soudre.  gif2numpy <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">essaie de superposer de</a> telles images sur la pr√©c√©dente, mais il ne v√©rifie pas les param√®tres de superposition, c'est pourquoi le r√©sultat correct ne sort pas toujours.  Afin de ne pas <code>gifsicle</code> avec les drapeaux, un traitement d'image pr√©liminaire √† l'aide de <code>gifsicle</code> avec la cl√© <code>--unoptimize</code> est <code>--unoptimize</code> - il convertit les images partielles en images compl√®tes.  Et en m√™me temps, cela les conduit √† utiliser la palette globale, ce qui a √©limin√© la n√©cessit√© de traiter s√©par√©ment la couleur transparente lors de l'utilisation de votre propre palette de cadres. <br><br><h3>  Serre-moi plus fort </h3><br>  Les carr√©s sont bons, mais avec de telles limitations, vous devez faire preuve de plus d'imagination, sinon m√™me les GIF miniatures ne ¬´glisseront¬ª pas dans Telegram. <br><br>  Quelque chose de similaire √† <abbr title="Encodage de longueur de course">RLE a √©t√© utilis√© en premier</abbr> : les carr√©s adjacents horizontalement de la m√™me couleur sont combin√©s en un seul rectangle. <br><br>  Ensuite, l'exploitation des fonctionnalit√©s de Lottie.  √âtant donn√© que chaque couche a une heure de d√©but et de fin arbitraire, vous pouvez appliquer une technique qui a longtemps √©t√© utilis√©e par les codecs vid√©o, et en partie dans GIF lui-m√™me: les carr√©s qui restent au m√™me endroit pour plusieurs images peuvent √™tre fusionn√©s en une seule couche, pendant laquelle l'affichage change plusieurs autres.  Ce qui n'est mis en ≈ìuvre jusqu'√† pr√©sent que pour des paires de couches adjacentes. <br><br><h3>  Plans de d√©veloppement </h3><br>  Les id√©es qui peuvent √™tre appliqu√©es ici sont en vrac: <br><br><ul><li>  <b>Reconnaissez les zones monochromes de toute taille.</b>  Vous pouvez les diviser en un ensemble de rectangles, pour lesquels il existe un <a href="">bon algorithme</a> .  Il est √©galement conseill√© de les convertir en contour, mais cela est √©clips√© par la n√©cessit√© d'indiquer tous les points des courbes de B√©zier en Lottie - les rectangles dans certains cas peuvent √™tre plus avantageux. </li><li>  <b>Reconnaissez le mouvement.</b>  Encore une fois, la technique est utilis√©e dans les codecs vid√©o.  Si le m√™me contour ne change pas de forme d'un cadre √† l'autre, mais uniquement les coordonn√©es - au lieu de le dupliquer sur plusieurs couches, placez-le sur une couche avec transformation. </li><li>  <b>Reconna√Ætre la ¬´couverture¬ª d'une zone avec une autre.</b>  Un exemple: <br><br><pre> <code class="plaintext hljs">...... .O..O. ...... .OOOO. ......</code> </pre><br>  Les pixels d'une couleur diff√©rente sont superpos√©s sur un rectangle d'une couleur.  Au lieu de casser ce rectangle en un tas de petits, ou de le transformer en un contour de forme complexe - vous pouvez simplement les superposer sur le rectangle entier. </li><li>  <b>Vectorisation des courbes et ellipses, reconnaissance des gradients.</b>  Cela g√¢chera le charme des pixels, mais cela am√©liorera la compressibilit√© de certains GIF par ordre de grandeur.  Les d√©grad√©s sont m√™me dans les "Koloboks" ant√©diluviens, je vous le garantis! <img src="https://habrastorage.org/getpro/habr/post_images/98f/cc9/e83/98fcc9e832a79a6a2ffeb8f7fd2a64ae.gif" alt=": D"></li><li>  <b>Compression avec perte.</b>  Tout d'abord, l'√©limination du tramage, et m√™me dans des images excessivement lisses, n'entravera pas la mod√©ration des couleurs.  Le gifsicle susmentionn√© s'en occupera probablement. </li></ul><br><h3>  Les r√©f√©rences </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sources</a> .  Effrayant par endroits. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cha√Æne</a> sur laquelle je t√©l√©charge des packs de GIF convertis avec succ√®s. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460411/">https://habr.com/ru/post/fr460411/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460397/index.html">D√©marrage rapide avec WebComponents</a></li>
<li><a href="../fr460399/index.html">Indicateur de chargement SVG sur Vue.js</a></li>
<li><a href="../fr460403/index.html">Avantages et inconv√©nients des HugePages</a></li>
<li><a href="../fr460405/index.html">Pourquoi avez-vous besoin de m√©canismes de jeu cach√©s</a></li>
<li><a href="../fr460409/index.html">Arduino et claviers (guide complet)</a></li>
<li><a href="../fr460413/index.html">7 sites et applications utiles pour apprendre l'anglais</a></li>
<li><a href="../fr460415/index.html">Apple Watch 4 (44 mm, 2019) vs Pebble Steel Classic (2014)</a></li>
<li><a href="../fr460419/index.html">R√©cup√©ration de chaleur des fum√©es: respectueuse de l'environnement</a></li>
<li><a href="../fr460421/index.html">Commutateur optique TP-Link T2600G-28SQ pour les fournisseurs de services: un examen d√©taill√©</a></li>
<li><a href="../fr460423/index.html">WAL dans PostgreSQL: 3. Checkpoint</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>