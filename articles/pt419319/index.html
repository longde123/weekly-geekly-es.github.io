<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåº ‚ú°Ô∏è ü§úüèΩ Como iniciar o Istio usando o Kubernetes na produ√ß√£o. Parte 1 üî∞ üçµ üì∫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O que √© o Istio ? Essa √© a chamada malha de servi√ßo, uma tecnologia que adiciona uma camada de abstra√ß√£o na rede. Interceptamos todo ou parte do tr√°fe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como iniciar o Istio usando o Kubernetes na produ√ß√£o. Parte 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/419319/">  O que √© o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Istio</a> ?  Essa √© a chamada malha de servi√ßo, uma tecnologia que adiciona uma camada de abstra√ß√£o na rede.  Interceptamos todo ou parte do tr√°fego no cluster e executamos um conjunto espec√≠fico de opera√ß√µes com ele.  Qual?  Por exemplo, fazemos roteamento inteligente ou implementamos a abordagem do disjuntor, podemos organizar uma "implanta√ß√£o de can√°rio", alternando parcialmente o tr√°fego para uma nova vers√£o do servi√ßo e podemos limitar as intera√ß√µes externas e controlar todas as viagens do cluster para a rede externa.  √â poss√≠vel definir regras de pol√≠tica para controlar campanhas entre diferentes microsservi√ßos.  Por fim, podemos obter todo o mapa de intera√ß√£o pela rede e tornar a cole√ß√£o unificada de m√©tricas completamente transparente para aplicativos. <br><br>  Sobre o mecanismo de trabalho pode ser encontrado na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o oficial</a> .  O Istio √© uma ferramenta realmente poderosa que pode resolver muitos problemas e problemas.  Neste artigo, gostaria de responder √†s perguntas b√°sicas que geralmente surgem no in√≠cio do trabalho com o Istio.  Isso ajudar√° voc√™ a lidar com isso mais rapidamente. <br><br><img src="https://habrastorage.org/webt/cg/g_/dm/cgg_dmyxbtcrlna9cjib_vzazdm.png"><br><a name="habracut"></a><br><h3>  Princ√≠pio de funcionamento </h3><br>  O Istio consiste em duas zonas principais - plano de controle e plano de dados.  O plano de controle cont√©m os principais componentes que garantem a opera√ß√£o correta do restante.  Na vers√£o atual (1.0), o plano de controle possui tr√™s componentes principais: Pilot, Mixer, Citadel.  N√£o consideraremos o Citadel, √© necess√°rio gerar certificados para garantir TLS m√∫tuo entre os servi√ßos.  Vamos dar uma olhada no dispositivo e na finalidade do Pilot and Mixer. <br><br><img src="https://habrastorage.org/webt/bz/eb/pz/bzebpzcfxr7himr5du7j1cm18zg.png"><br><br>  O piloto √© o principal componente de controle que divulga todas as informa√ß√µes sobre o que temos no cluster - servi√ßos, seus pontos de extremidade e regras de roteamento (por exemplo, regras para implanta√ß√£o do Canary ou regras do disjuntor). <br><br>  Misturador - um componente opcional do plano de controle, que fornece a capacidade de coletar m√©tricas, logs e qualquer informa√ß√£o sobre intera√ß√µes na rede.  Ele tamb√©m monitora a conformidade com as regras da pol√≠tica e a conformidade com os limites de taxa. <br><br>  O plano de dados √© implementado usando cont√™ineres proxy de side-car.  Por padr√£o, o poderoso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">servidor proxy enviado √© usado</a> .  Pode ser substitu√≠do por outra implementa√ß√£o, por exemplo nginx (nginmesh). <br><br>  Para que o Istio funcione de forma totalmente transparente para aplicativos, existe um sistema de inje√ß√£o autom√°tica.  A implementa√ß√£o mais recente √© adequada para vers√µes do Kubernetes 1.9+ (webhook de admiss√£o mutacional).  Para as vers√µes 1.7, 1.8 do Kubernetes, √© poss√≠vel usar o Inicializador. <br><br>  Os cont√™ineres laterais s√£o conectados ao Pilot por meio do protocolo GRPC, que permite otimizar o modelo de envio das mudan√ßas que ocorrem no cluster.  O GRPC come√ßou a ser usado no Envoy desde a vers√£o 1.6, no Istio, desde a vers√£o 0.8 e √© um agente piloto - um inv√≥lucro no golang sobre o enviado que configura os par√¢metros de inicializa√ß√£o. <br><br>  Piloto e Mixer s√£o componentes completamente sem estado, todo o estado √© mantido na mem√≥ria.  A configura√ß√£o para eles √© especificada como Recursos Personalizados do Kubernetes, que s√£o salvos no etcd. <br>  O Istio-agent recebe o endere√ßo Pilot e abre um fluxo GRPC para ele. <br><br>  Como eu disse, o Istio implementa toda a funcionalidade completamente transparente para os aplicativos.  Vamos descobrir como.  O algoritmo √© o seguinte: <br><br><ol><li>  Implante uma nova vers√£o do servi√ßo. </li><li>  Dependendo da abordagem de inje√ß√£o do cont√™iner lateral, um cont√™iner istio-init e um cont√™iner istio-agente (enviado) s√£o adicionados no est√°gio de aplica√ß√£o da configura√ß√£o ou j√° podem ser inseridos manualmente na descri√ß√£o do Pod da entidade Kubernetes. </li><li> O cont√™iner istio-init √© um script que aplica as regras do iptables para a lareira.  H√° duas op√ß√µes para configurar a quebra de tr√°fego no cont√™iner istio-agent: use as regras de redirecionamento de iptables ou <a href="">TPROXY</a> .  No momento da escrita, √© usada a abordagem padr√£o com regras de redirecionamento.  No istio-init, √© poss√≠vel configurar qual tr√°fego precisa ser interceptado e roteado para o istio-agent.  Por exemplo, para interceptar todo o tr√°fego de entrada e sa√≠da, voc√™ precisa definir os par√¢metros <code>-i</code> e <code>-b</code> como <code>*</code> .  Voc√™ pode especificar portas espec√≠ficas a serem interceptadas.  Para n√£o interceptar uma sub-rede espec√≠fica, voc√™ pode especific√°-la usando o sinalizador <code>-x</code> . </li><li>  Ap√≥s a execu√ß√£o dos cont√™ineres init, os principais s√£o lan√ßados, incluindo o piloto-agente (enviado).  Ele se conecta ao Pilot j√° implantado via GRPC e recebe informa√ß√µes sobre todos os servi√ßos e pol√≠ticas de roteamento existentes no cluster.  De acordo com os dados recebidos, ele configura os clusters e os atribui diretamente aos pontos finais de nossos aplicativos no cluster Kubernetes.  Tamb√©m vale a pena notar um ponto importante: o enviado configura dinamicamente ouvintes (IP, pares de portas) que ele come√ßa a ouvir.  Portanto, quando as solicita√ß√µes entram no pod, elas s√£o redirecionadas usando as regras de redirecionamento de iptables no side-car, o enviado j√° pode processar com √™xito essas conex√µes e entender onde o tr√°fego de proxy deve ser continuado.  Tamb√©m nesta fase, as informa√ß√µes s√£o enviadas para o Mixer, que discutiremos mais adiante, e enviando intervalos de rastreamento. </li></ol><br>  Como resultado, obtemos toda uma rede de servidores proxy enviados, que podemos configurar a partir de um ponto (Pilot).  Todas as solicita√ß√µes de entrada e sa√≠da passam pelo enviado.  Al√©m disso, apenas o tr√°fego TCP √© interceptado.  Isso significa que o IP do servi√ßo Kubernetes resolve usando o kube-dns sobre UDP sem alterar.  Em seguida, ap√≥s a resolu√ß√£o, a solicita√ß√£o de sa√≠da √© interceptada e processada pelo enviado, que j√° decide para qual terminal enviar a solicita√ß√£o (ou n√£o, no caso de pol√≠ticas de acesso ou acionamento de algoritmos de disjuntor). <br><br>  Com o Pilot resolvido, agora voc√™ precisa entender como o Mixer funciona e por que ele √© necess√°rio.  Voc√™ pode ler a documenta√ß√£o oficial <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  O misturador em sua forma atual consiste em dois componentes: istio-telemetria, istio-policy (antes da vers√£o 0.8, era um componente do istio-mixer).  Ambos s√£o misturadores, cada um dos quais √© respons√°vel por sua tarefa.  A telemetria Istio recebe via GRPC do sidecar Report containers informa√ß√µes sobre quem vai aonde e com quais par√¢metros.  O Istio-policy aceita pedidos de verifica√ß√£o para verificar se as regras de pol√≠tica s√£o atendidas.  As verifica√ß√µes poilicy s√£o realizadas, √© claro, n√£o para cada solicita√ß√£o, mas s√£o armazenadas em cache no cliente (no side-car) por um certo tempo.  As verifica√ß√µes de relat√≥rio s√£o enviadas por solicita√ß√µes em lote.  Veremos um pouco mais tarde como configurar e quais par√¢metros voc√™ precisa enviar. <br><br>  O Mixer deve ser um componente altamente dispon√≠vel que fornece trabalho ininterrupto na coleta e processamento de dados de telemetria.  O sistema √© um buffer de v√°rios n√≠veis.  Inicialmente, os dados s√£o armazenados em buffer no lado lateral dos cont√™ineres, depois no lado do misturador e depois enviados para os chamados backends do misturador.  Como resultado, se algum componente do sistema falhar, o buffer aumenta e trava ap√≥s a recupera√ß√£o do sistema.  Os backends do misturador s√£o os pontos finais para o envio de dados de telemetria: statsd, newrelic etc.  Voc√™ pode escrever seu back-end, √© bem simples, e veremos como faz√™-lo. <br><br><img src="https://habrastorage.org/webt/pz/qy/a_/pzqya_uanc5lmnd1kdv8ddu-frc.png"><br><br>  Resumindo, o esquema de trabalho com istio-telemetria √© o seguinte. <br><br><ol><li>  O servi√ßo 1 envia uma solicita√ß√£o para o servi√ßo 2. </li><li>  Ao sair do servi√ßo 1, a solicita√ß√£o √© agrupada em seu pr√≥prio carro lateral. </li><li>  O enviado do side-car monitora como a solicita√ß√£o de servi√ßo 2 passa e prepara as informa√ß√µes necess√°rias. </li><li>  Em seguida, envia-o para istio-telemetria usando a solicita√ß√£o de relat√≥rio. </li><li>  A Istio-telemetria determina se deve enviar este relat√≥rio para back-end, para quais dados e quais dados enviar. </li><li>  A Istio-telemetria envia os dados do relat√≥rio para o back-end, se necess√°rio. </li></ol><br>  Agora vamos ver como implantar no sistema Istio, consistindo apenas dos componentes principais (piloto e enviado lateral). <br><br>  Primeiro, vejamos a configura√ß√£o principal (malha) que o Pilot l√™: <br><br><pre> <code class="plaintext hljs">apiVersion: v1 kind: ConfigMap metadata: name: istio namespace: istio-system labels: app: istio service: istio data: mesh: |- #      tracing  (pilot  envoy'  ,     ) enableTracing: false #     mixer endpoint',  sidecar      #mixerCheckServer: istio-policy.istio-system:15004 #mixerReportServer: istio-telemetry.istio-system:15004 #   ,    envoy  Pilot (    envoy proxy) rdsRefreshDelay: 5s # default   envoy sidecar defaultConfig: #   rdsRefreshDelay discoveryRefreshDelay: 5s #    (     envoy) configPath: "/etc/istio/proxy" binaryPath: "/usr/local/bin/envoy" #    sidecar  (, ,      tracing span') serviceCluster: istio-proxy # ,    envoy  ,        drainDuration: 45s parentShutdownDuration: 1m0s #    REDIRECT  iptables.    TPROXY. #interceptionMode: REDIRECT # ,     admin   sidecar  (envoy) proxyAdminPort: 15000 # ,     trace'  zipkin  (     ,       ) zipkinAddress: tracing-collector.tracing:9411 # statsd     envoy  () # statsdUdpAddress: aggregator:8126 #    Mutual TLS controlPlaneAuthPolicy: NONE # ,     istio-pilot  ,     service discovery  sidecar  discoveryAddress: istio-pilot.istio-system:15007</code> </pre><br>  Todos os principais componentes do plano de controle est√£o localizados no sistema de namespace istio no Kubernetes. <br><br>  No m√≠nimo, precisamos implantar apenas o Pilot.  Para fazer isso, usaremos <a href="">essa configura√ß√£o.</a> <br><br>  E configure manualmente o carro lateral de inje√ß√£o do cont√™iner. <br><br>  Container inicial: <br><br><pre> <code class="plaintext hljs">initContainers: - name: istio-init args: - -p - "15001" - -u - "1337" - -m - REDIRECT - -i - '*' - -b - '*' - -d - "" image: istio/proxy_init:1.0.0 imagePullPolicy: IfNotPresent resources: limits: memory: 128Mi securityContext: capabilities: add: - NET_ADMIN</code> </pre><br>  E carro lateral: <br><br><pre> <code class="plaintext hljs"> name: istio-proxy args: - "bash" - "-c" - | exec /usr/local/bin/pilot-agent proxy sidecar \ --configPath \ /etc/istio/proxy \ --binaryPath \ /usr/local/bin/envoy \ --serviceCluster \ service-name \ --drainDuration \ 45s \ --parentShutdownDuration \ 1m0s \ --discoveryAddress \ istio-pilot.istio-system:15007 \ --discoveryRefreshDelay \ 1s \ --connectTimeout \ 10s \ --proxyAdminPort \ "15000" \ --controlPlaneAuthPolicy \ NONE env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace - name: INSTANCE_IP valueFrom: fieldRef: fieldPath: status.podIP - name: ISTIO_META_POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: ISTIO_META_INTERCEPTION_MODE value: REDIRECT image: istio/proxyv2:1.0.0 imagePullPolicy: IfNotPresent resources: requests: cpu: 100m memory: 128Mi limits: memory: 2048Mi securityContext: privileged: false readOnlyRootFilesystem: true runAsUser: 1337 volumeMounts: - mountPath: /etc/istio/proxy name: istio-envoy</code> </pre><br>  Para que tudo comece com sucesso, voc√™ precisa obter ServiceAccount, ClusterRole, ClusterRoleBinding, CRD for Pilot, cujas descri√ß√µes podem ser encontradas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Como resultado, o servi√ßo no qual injetamos o side-car com enviado deve iniciar com √™xito, obter toda a descoberta do piloto e processar as solicita√ß√µes. <br><br>  √â importante entender que todos os componentes do plano de controle s√£o aplicativos sem estado e podem ser dimensionados horizontalmente sem problemas.  Todos os dados est√£o no etcd como descri√ß√µes personalizadas dos recursos do Kubernetes. <br><br>  O Istio tamb√©m (at√© agora experimentalmente) tem a capacidade de executar fora do cluster e a capacidade de observar e se atrapalhar na descoberta de servi√ßos entre v√°rios clusters do Kubernetes.  Voc√™ pode ler mais sobre isso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Para uma instala√ß√£o com v√°rios clusters, as seguintes restri√ß√µes devem ser consideradas: <br><br><ol><li>  O CIDR do pod e o CIDR de servi√ßo devem ser exclusivos em todos os clusters e n√£o devem se sobrepor. </li><li>  Todos os CIDRs de Pods devem estar dispon√≠veis em qualquer CIDRs de Pods entre clusters. </li><li>  Todos os servidores da API do Kubernetes devem estar acess√≠veis um ao outro. </li></ol><br>  Esta √© a informa√ß√£o inicial para ajud√°-lo a come√ßar com o Istio.  No entanto, ainda existem muitas armadilhas.  Por exemplo, recursos de roteamento de tr√°fego externo (para a parte externa do cluster), abordagens para depura√ß√£o de sidecar, cria√ß√£o de perfil, configura√ß√£o de um mixer e grava√ß√£o de um backend de mixer personalizado, configura√ß√£o de um mecanismo de rastreamento e sua opera√ß√£o usando o enviado. <br>  Vamos considerar tudo isso nas seguintes publica√ß√µes.  Fa√ßa suas perguntas, tentarei cobri-las. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt419319/">https://habr.com/ru/post/pt419319/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt419307/index.html">Roskomnadzor se interessa por conex√µes comerciais do Facebook</a></li>
<li><a href="../pt419309/index.html">JavaScript Medium Color</a></li>
<li><a href="../pt419311/index.html">Lumin√°rias industriais de fabricantes nacionais Effest com um bom √≠ndice de reprodu√ß√£o de cores</a></li>
<li><a href="../pt419313/index.html">Testamento de Buffett ou sobre o que os consultores financeiros n√£o falam</a></li>
<li><a href="../pt419315/index.html">Vida √∫til do motor ap√≥s a morte de um foguete</a></li>
<li><a href="../pt419321/index.html">SamsPcbGuide Parte 7: Rastreando linhas de sinal. Pares diferenciais</a></li>
<li><a href="../pt419323/index.html">Instale o Kubernetes no Hetzner Cloud</a></li>
<li><a href="../pt419325/index.html">Realocar aluno para a Fran√ßa</a></li>
<li><a href="../pt419327/index.html">Guia de lista de interfaces no MikroTik</a></li>
<li><a href="../pt419329/index.html">Eventos digitais em Moscou, de 6 a 12 de agosto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>