<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤟🏻 🦆 👨🏿‍🤝‍👨🏻 VK bot en su rodilla, o cómo complacer a las personas el 14 de febrero 🤳🏾 👐🏿 🔢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Por supuesto, cada uno de nosotros ama los regalos, pero sobre todo amamos los deseos que los acompañan. Y, hasta hace poco, no teníamos la oportunida...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>VK bot en su rodilla, o cómo complacer a las personas el 14 de febrero</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439218/">  Por supuesto, cada uno de nosotros ama los regalos, pero sobre todo amamos los deseos que los acompañan.  Y, hasta hace poco, no teníamos la oportunidad de sorprender gratamente a una persona con palabras cálidas hasta que se me ocurrió la idea: ¿qué pasa si le damos a las personas la oportunidad de intercambiar valentines (de todos modos, el 14 de febrero) sin abandonar el marco de la forma habitual? comunicación - sala de chat de redes sociales? <br><br>  Palabra por palabra, y aquí está: ¡un plan comercial listo para crear el ambiente de las vacaciones del Día de San Valentín!  ¿Haremos felices a las personas? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dl/mp/13/dlmp134rko91zu7m-evwm5mlhem.jpeg" width="70%"></div><br><a name="habracut"></a><h2>  ¡Por la idea de la luna! </h2><br>  Por supuesto, en primer lugar era necesario elaborar un plan de acción y describir la idea.  Debido al hecho de que las personas se han vuelto más tímidas y no siempre están listas para confiar en nadie, la elección recayó en escribir un bot de moda y conveniente para VK, que tiene una interfaz familiar, siempre estará a mano, y el anonimato de los mensajes estará codificado en el código del programa. <br>  Desafortunadamente, además de todas las ventajas anteriores, las comunidades tienen dos inconvenientes: bajo ancho de banda (número de mensajes por segundo) y una prohibición de iniciar un diálogo con un usuario aleatorio (el usuario debe <b>primero</b> y <b>explícitamente</b> aceptar recibir mensajes en nombre de la comunidad). <br><br>  Entonces, tenemos un usuario que está listo para enviar una tarjeta de San Valentín a su alma gemela, un destinatario y un intermediario en forma de un bot de chat.  El esquema de interacción es simple, el bot debería: ofrecer el envío → reconocer al destinatario → guardar hasta el 14 de febrero → entregar → repetir. <br><br>  Pero esto, por supuesto, no fue suficiente para la voraz imaginación de la mente y, para aumentar la actividad y la participación de la audiencia, se pensó en un esquema de otra interacción que permitiera a las personas familiarizarse dentro del sistema y enviar mensajes a personas aleatorias.  Estas "valentines al azar" se pueden apreciar, y si las valentines de dos personas se gustan, les damos la oportunidad de chatear. <br><br><h4>  Descargo de responsabilidad </h4><br>  <i>Este proyecto fue creado puramente por el entusiasmo de dos personas, un programador <s>medio educado</s> (yo) y un inspirador ideológico (Stepan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">sadfun</a> Popov), no tiene el objetivo de enseñarle algo (aunque puede ayudarlo a comprender la esencia del universo), solo cuente una historia interesante de creación y siga el camino de una idea a una implementación ingenua.</i> <br><br><hr><br><h2>  Aprendiendo a hablar con VK </h2><br>  Después de <b>pasar</b> por 3-4 bibliotecas diferentes a pedido de <b>"NodeJS VK API"</b> , me di cuenta de que no hay bibliotecas simples y funcionales que nos permitan usar promesas, así como trabajar durante la ejecución.  ¿Recuerdas uno de los problemas descritos anteriormente?  Sí, la ejecución de solicitudes a VKontakte no es directa, pero en lotes de 25 le permite aumentar <b>significativamente el</b> rendimiento. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/v3/fl/bp/v3flbpnqymqn0wy51ohjddwenmo.png" width="70%"></div><br>  <i>Capacidad comparativa de varios métodos de solicitudes a VKontakte</i> <br><br>  Por lo tanto, se decidió escribir algo propio, una solución confiable y no muy precisa, basada en la biblioteca de <b>búsqueda de nodos</b> . <br><br>  Para no dar todo el código aquí, simplemente describiré la lógica del trabajo. <br><br>  Dado que las solicitudes del programa deben empaquetarse en una ejecución, se recopilan en la cola LIFO y luego se envían si: <br><br><ul><li>  Llamadas de 25 o más (ejecución máxima) </li><li>  Ha pasado suficiente tiempo desde el último envío, no menos de 50 milisegundos, pero no más de 150 (para que la cola se mueva, a pesar del pequeño tamaño) </li></ul><br>  Las solicitudes de la cola se compilan en el código VK Script, que (en esta implementación) se ve así: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> returnables = []; returnables[<span class="hljs-number"><span class="hljs-number">0</span></span>] = API.messages.send({<span class="hljs-string"><span class="hljs-string">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">", !"</span></span>, <span class="hljs-string"><span class="hljs-string">"peer_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"random_id"</span></span>: <span class="hljs-number"><span class="hljs-number">561427</span></span>}); returnables[<span class="hljs-number"><span class="hljs-number">1</span></span>] = API.users.get({<span class="hljs-string"><span class="hljs-string">"user_ids"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"fields"</span></span>: <span class="hljs-string"><span class="hljs-string">"sex"</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> returnables;</code> </pre> <br>  Después de que el código se ejecuta mediante una solicitud a VK, el resultado de cada solicitud (por los <i>retornables de</i> índice) vuelve a su devolución de llamada, bellamente envuelto en Promise.  La eficacia del enfoque es abrumadora: cuantos <b>más</b> usuarios (y, por lo tanto, más solicitudes a VKontakte para enviar), <b>menor es la</b> demora en la respuesta.  Para mantener el límite bajo control, el sistema de envío tiene un contador que muestra el número de solicitudes restantes para este segundo, lo que le permite procesar rápidamente una oleada de visitantes. <br><br><h2>  Aprendiendo a escuchar VK </h2><br>  Hay dos formas de recibir notificaciones de eventos de VKontakte: <b>Longpoll-request</b> y <b>Callback-server</b> .  Su servidor es conveniente porque no requiere gestos especiales para su uso, y también le permite recibir notificaciones perdidas (por ejemplo, cuando reinicia el servidor).  Dicho servidor se puede escribir en varias líneas utilizando la clase nativa <b>http.Server</b> . <br><br>  Todo esto crea un ecosistema ideal para la lógica del programa, que es conveniente de usar. <br><br><h2>  Todo termina </h2><br>  Dado que el usuario es libre de hacer cualquier cosa en el chat y no podemos detenerlo, debemos limitarlo a una cantidad razonable.  La máquina de estado hace un gran trabajo al hacer esto, configurando cada transición posible dentro del sistema y usando los botones (parámetro de <b>teclado</b> en messages.send) hará que usar el bot sea tan simple como un simple toque en la pantalla. <br><br>  Aquí está la interacción del usuario con el bot: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sz/1o/fw/sz1ofwuethupwaiet4syf6ahl4u.png"></div><br>  Todo esto se convierte en un conjunto de estados ("Menú principal", "Entrada de San Valentín", etc.), las transiciones entre las cuales se configuran y transmiten en botones, o se conocen inicialmente y no cambian. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cq/dz/ml/cqdzmlalb1t2o-xpdet5mvfnnek.png"></div><br>  Por cierto, sobre los botones.  Su gama de colores no es invariable ( <b>4 colores</b> para todas las ocasiones), pero son los botones los que permiten minimizar la cantidad de errores del usuario.  Sobre su base, puede construir absolutamente cualquier sistema no lineal, por lo que se utilizan en todas partes.  Y en este proyecto también. <br><br>  Pero debe comprender: si está apuntando a una gran audiencia, debería considerar otra forma de interactuar, porque alguien puede tener una aplicación antigua ( <b>VK para iPad</b> , por ejemplo, no se ha actualizado durante mucho tiempo, no mentiré, pero parece que ha pasado más de un año, y el soporte de teclado no está allí).  Y sucede (sí, sucede, lo comprobé) que las personas, sin darse cuenta de que se puede hacer clic en los botones, simplemente reescriben su contenido (y luego el parámetro del botón de carga útil, por supuesto, no se transmite, y todo puede romperse). <br><br>  Cabe señalar que no todo sucede tan bien como se describe en el diagrama, y ​​a veces ocurren casos curiosos.  Por ejemplo, el sistema para determinar el enlace VKontakte procesó incorrectamente a los usuarios cuyos enlaces cortos comenzaron con <b>id</b> y lo cortaron.  La sorpresa de las personas que se encontraron con este error no se puede describir, porque escribieron Valentine Valentine, pero resultó que Olezhka. <br><blockquote>  <b>¿Qué olezhka ????</b> </blockquote><h2>  Los accidentes no son accidentales </h2><br>  Entonces, si todo está claro con el día de San Valentín ordinario, hay un destinatario y un remitente, ¿cómo reducir a dos extraños?  Necesitas intercambiar sus tarjetas de San Valentín, y si a la gente le gustan las tarjetas de San Valentín, ¡deberían presentarse!  ¡Aquí está, la fórmula del amor! <br><br>  Aunque esto suena patético, funciona, y se vuelve más interesante para las personas trabajar con el bot: obtendrán una respuesta positiva si hay al menos una persona (que, por supuesto, el bot se encargará). <br><br>  Esto lleva a una gran ventaja: cuantas más personas aprovechen esta oportunidad, más oportunidades tendrán de conocerse y, por lo tanto, esto, como un juego, mantiene a una persona en un chat.  Vale la pena confesar que la sesión promedio del usuario es de ~ 7 minutos, pero existe el potencial de restringir a una persona entre <b>10 y 15</b> por el simple hecho de esta característica. <br><br>  La distribución misma de los mensajes forzó un esquema separado, ya que hay varias opciones para usar este bot, el usuario puede perder de vista algo y el bot le recordará cuidadosamente esto. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pj/8a/bw/pj8abwsu2zjmkhotgiffi0jldse.jpeg"></div><br>  Es interesante cómo se resolvió el segundo problema, con la incapacidad de la comunidad para iniciar un diálogo con el usuario primero: ahora este problema se resuelve mediante dicho mensaje. <br><blockquote>  Pero tengo una condición!  Para que el destinatario reciba su Valentine, también debe escribirme.  Tu tarea ahora es convencerlo de que me escriba algo.  ¡Esto se hace para que no tengas miedo de hablar con él! </blockquote>  En general, el tradicional "¡No es un error, sino una característica!" <br><br><h2>  Fuegos artificiales al final </h2><br>  Eso es todo!  Si no tiene en cuenta algunas dificultades para comprender la lógica de la API de VK, así como para confirmar la cuenta con uno de los proveedores, todo salió demasiado bien. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-7/gb/yt/-7gbythuuwaf87k6c-v4k5-shok.png"></div><br>  <i>Ejemplo de chat con un bot</i> <br><br>  El bot funciona y hará las delicias de las personas con San Valentín, haciéndolos felices.  Esto se hace para ayudar a las personas a ser más amables entre sí.  Puede evaluar todo esto usted mismo en la comunidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Valentinych: vk.com/verylovebot</a> , si lo desea.  Gracias por su atencion! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/439218/">https://habr.com/ru/post/439218/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../439204/index.html">Mejora de la eficiencia de la fotosíntesis por modificación genética de plantas.</a></li>
<li><a href="../439206/index.html">¿Cómo resolvimos el problema de continuar las listas de reproducción en RecSys Challenge y obtuvimos el 3er lugar?</a></li>
<li><a href="../439208/index.html">Oh, mi código: cómo funciona MAPS.ME</a></li>
<li><a href="../439210/index.html">Java después de la erupción volcánica</a></li>
<li><a href="../439216/index.html">base de datos incrustable de 500 filas de pudge en golang</a></li>
<li><a href="../439220/index.html">Gran ciudad para dispositivos móviles en Unity. Experiencia en desarrollo y optimización.</a></li>
<li><a href="../439222/index.html">¿Qué es la gestión de API?</a></li>
<li><a href="../439224/index.html">De nuevo sobre los diagramas de Voronoi</a></li>
<li><a href="../439226/index.html">Scala + MXNet = Microservicio con neurona en prod</a></li>
<li><a href="../439232/index.html">JAMstack: Cómo crear tu propio blog usando Gatsby + Contentful + Netlify</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>