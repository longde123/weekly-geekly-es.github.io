<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑 🈹 👨🏾‍🤝‍👨🏼 Script untuk menambahkan server dari Google Cloud ke config ssh 🈁 😻 ㊙️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anotasi Artikel tentang skrip yang sangat sederhana yang membentuk konfigurasi untuk ssh Linux dari daftar server. Diuji pada Ubuntu 18, menggunakan G...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Script untuk menambahkan server dari Google Cloud ke config ssh</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484500/"><p>  Anotasi  Artikel tentang skrip yang sangat sederhana yang membentuk konfigurasi untuk ssh Linux dari daftar server.  Diuji pada Ubuntu 18, menggunakan Goodle Cloud SDK, Python 2.7, Bash. </p><br><p>  Setelah peningkatan tajam dalam jumlah server yang harus saya kerjakan, saya menyadari bahwa penyimpanan kata sandi dan CMDB tidak lagi menyediakan akses operasional seperti itu, seperti pada masa itu ketika saya hanya mengingat semua ip dan detail dengan hati.  Mungkin karena CMDB yang belum kita kuasai.  Namun demikian, bagaimanapun juga perlu untuk memecahkan masalah akses cepat melalui SSH ke sejumlah besar server. </p><br><p>  Berikutnya - dari sudut pandang terminal Linux (dilakukan pada Ubuntu 18).  Mungkin bekerja di distribusi lain dan, mungkin, bahkan ada analog pada Windows - saya tidak melihat. </p><br><p>  Persyaratan utama: </p><br><ul><li>  Mudah diulang.  Beberapa administrator <br>  dan Anda memerlukan kemampuan untuk mengonfigurasi yang sama untuk semua orang.  Selain itu, kami mengizinkan pekerjaan jarak jauh - setidaknya setiap laptop memiliki situasi, tetapi kadang-kadang Anda tidak bekerja di komputer "lama yang disetel dan disadap" seperti biasanya. </li><li>  Server ditambahkan, dihapus, alamat diubah.  Ini harus dipertimbangkan. </li></ul><br><p> Untuk melakukan ini, saya memutuskan untuk menggunakan alias host di pengaturan ssh, mendapatkan daftar server melalui klien gcloud cli GCP, dan mengotomatisasi semua ini menggunakan Python 2.7 (karena secara default di Ubuntu dan saya memutuskan untuk mempelajarinya bekerja dengan data).  Script itu sendiri dengan deskripsi di bawah potongan. </p><a name="habracut"></a><br><h1 id="postanovka-zadachi">  Pernyataan masalah </h1><br><p>  Idenya adalah ini: simpan daftar alias server komunikasi dan alamat mereka saat ini sedemikian rupa sehingga hanya nama yang dapat digunakan untuk membuat koneksi.  Pada saat yang sama, daftar itu sendiri secara berkala diperbarui dari GCP oleh API. </p><br><p>  Akibatnya, ada beberapa tugas: </p><br><ol><li>  Menghubungkan ke host dengan mengetik hanya nama yang mudah diingat (kami biasanya membentuk nama sesuai dengan aturan yang ketat, sehingga cukup untuk mengetahui klien dan sistem untuk hampir pasti menebak nama server).  Nama bisa nyata (jika server dibuat sepenuhnya oleh kami) atau alias di dalam cmdb kami (jika server dibuat oleh klien dan nama tersebut diberikan sesuai dengan aturan klien).  Bagaimanapun, mengingat nama lebih mudah daripada alamat.  Alamatnya juga berubah. </li><li>  Mendapatkan daftar host saat ini dengan alamat yang valid.  Karena  platform utama adalah GCP dan 90% dari server ada, maka masalah ini akan diselesaikan melalui API mereka, dan bukan dengan alat pemantauan. </li><li>  Cari berdasarkan nama host.  Meskipun lebih mudah diingat, angkanya bertambah, dan ingatannya tidak terbatas :) Ya, dan administrator baru lebih mudah. </li><li>  Perbarui alias bundel - alamat hanya ketika alamat berubah.  Ini diperlukan untuk meninggalkan penulisan ulang lengkap semua bundel.  Ini akan memungkinkan penyimpanan bundel tidak hanya untuk server GCP.  Sejauh ini masalah ini belum terpecahkan :( </li></ol><br><h1 id="opisanie-resheniya">  Deskripsi Solusi </h1><br><h2 id="alias-dlya-podklyucheniya">  Alias ​​untuk terhubung </h2><br><p>  Semuanya di sini cukup sederhana dan tidak diputuskan oleh saya.  Utilitas ssh Linux mendukung konfigurasi alias dalam file konfigurasi. </p><br><p>  Lokasi File: ~ / .ssh / config </p><br><p>  Format file yang kami gunakan sangat dangkal, tetapi sebenarnya kemungkinannya jauh lebih luas: </p><br><pre><code class="plaintext hljs">HOST alias_ HostName ip__-</code> </pre> <br><p>  Anda dapat membaca lebih lanjut tentang opsi konfigurasi di <a href="https://linuxize.com/post/using-the-ssh-config-file/" rel="nofollow">sini</a> , di <a href="https://www.cyberciti.biz/faq/create-ssh-config-file-on-linux-unix/" rel="nofollow">sini</a> atau di <a href="https://www.ssh.com/ssh/config" rel="nofollow">dokumentasi resmi</a> . </p><br><h3 id="dalneyshie-shagi">  Langkah selanjutnya </h3><br><ol><li>  Gunakan tombol yang berbeda untuk terhubung ke grup host yang berbeda.  Sedikit paranoia dalam hal keamanan tidak akan sakit. </li><li>  Berikan cadangan file ini untuk melindungi dari perubahan yang tidak disengaja dan memperbarui kesalahan skrip. </li></ol><br><h2 id="poisk-po-imenam-hostov">  Cari nama host </h2><br><p>  Di sini keputusan itu bukan milik saya sama sekali, tetapi untuk <a href="https://ben.lobaugh.net/" rel="nofollow">Ben Lobaugh</a> dan dijelaskan <a href="https://ben.lobaugh.net/blog/203195/quickly-list-all-hosts-in-your-ssh-config" rel="nofollow">dalam artikelnya</a> . <br>  Singkat kata, saya menggunakan sed, yang, untuk memudahkan memulai (aturan yang sangat panjang dalam parameter) disingkat via alias: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> sshhosts=<span class="hljs-string"><span class="hljs-string">"sed -rn 's/^\s*HOST\s+(.*)\s*/\1/ip' ~/.ssh/config"</span></span></code> </pre> <br><p>  Jika Anda perlu menemukan host dengan bagian nama, maka skrip ini sepenuhnya dilengkapi oleh utilitas grep dan hasilnya ternyata seperti ini: </p><br><pre> <code class="bash hljs">sshhost | grep <span class="hljs-string"><span class="hljs-string">'---'</span></span></code> </pre> <br><p>  Ada opsi lain, misalnya, seperti dijelaskan di <a href="https://www.jamesridgway.co.uk/blog/list-ssh-hosts-from-your-ssh-config" rel="nofollow">sini</a> . </p><br><h3 id="avtozapolnenie-imeni-hosta">  Nama host autocomplete </h3><br><p>  <strong>Terima kasih atas solusinya <a href="https://habr.com/ru/users/onix74/" class="user_link">onix74</a> !</strong> <br>  Tambahkan baris ke ~ / .bash_completion: </p><br><pre> <code class="bash hljs">complete -W <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(grep "^HOST " ~/.ssh/config | grep -v "\*" | sed 's/[^ ]* *\(.*\)/\1/')</span></span></span><span class="hljs-string">"</span></span> ssh</code> </pre> <br><p>  Untuk perintah ssh, pelengkapan otomatis akan berfungsi sesuai dengan daftar server alias.  Yaitu  Anda dapat menggunakan ssh untuk mengganti nama server ssh.  Ini bekerja di bash. <br></p><h3 id="dalneyshie-shagi-1">  Langkah selanjutnya </h3><br><p>  Saya berencana untuk membagi host menjadi grup sehingga Anda dapat memilih semua server klien tertentu atau dengan aplikasi tertentu.  Tampaknya fitur ini akan menarik untuk eksekusi skrip massal dan koneksi Ansible;  serta membuat detail koneksi yang berbeda untuk grup yang berbeda.  Tetapi seberapa banyak hal itu benar-benar masuk akal masih harus dilihat. </p><br><h2 id="poluchit-spisok-hostov-iz-gcp">  Dapatkan daftar host dari GCP </h2><br><p>  Pada langkah ini, semuanya cukup sederhana, kecuali untuk pengaturan parameter (meskipun ini adalah masalah pengalaman).  Saya memutuskan untuk menggunakan SDK GCloud untuk mendapatkan data, karena  sementara saya jarang menggunakannya, tapi saya kira kadang-kadang ini akan memungkinkan saya untuk menggunakan antarmuka grafis semakin dan semakin menyederhanakan rutin administrasi.  Oleh karena itu, argumen utamanya adalah untuk mendapatkan pengalaman. <br>  Mungkin, hal yang sama dapat dilakukan dengan menggunakan curl dan API REST GCP, dan kemudian solusinya akan lebih universal (karena GCloud SDK membutuhkan instalasi dan inisialisasi terpisah, yang tidak begitu rumit, tetapi masih diperlukan). </p><br><p>  Untuk mendapatkan informasi yang diperlukan, saya harus menggunakan format json.  Meskipun ini sangat menyederhanakan pemrosesan lebih lanjut dari jawaban yang diterima, itu membuat orang berpikir sedikit tentang pengaturan parameter format di SDK. <br>  Sebagai hasilnya, saya menerima perintah berikut: </p><br><pre> <code class="bash hljs">gcloud compute instances list --filter=<span class="hljs-string"><span class="hljs-string">"status:running"</span></span> --format=<span class="hljs-string"><span class="hljs-string">"json(name, status, networkInterfaces[].accessConfigs[])"</span></span></code> </pre> <br><p>  Ini hanya mengembalikan server yang saat ini aktif (tidak masuk akal untuk terhubung ke yang lain) dengan informasi tentang nama dan antarmuka jaringan mereka.  Sejauh ini, hanya satu antarmuka eksternal yang digunakan untuk setiap server. </p><br><p>  Hasil akhir tiba di json: </p><br><pre> <code class="json hljs">[ ---...---- { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"-"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"networkInterfaces"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"accessConfigs"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"kind"</span></span>: <span class="hljs-string"><span class="hljs-string">"compute#accessConfig"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"External NAT"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"natIP"</span></span>: <span class="hljs-string"><span class="hljs-string">"ip-"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"networkTier"</span></span>: <span class="hljs-string"><span class="hljs-string">"PREMIUM"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"ONE_TO_ONE_NAT"</span></span> } ] } ], <span class="hljs-attr"><span class="hljs-attr">"status"</span></span>: <span class="hljs-string"><span class="hljs-string">"RUNNING"</span></span> }, ----...--- ]</code> </pre> <br><h3 id="dalneyshie-shagi-2">  Langkah selanjutnya </h3><br><p>  Temukan format yang outputnya akan meminimalkan atau bahkan menghilangkan pemrosesan selanjutnya. </p><br><h2 id="skript-sozdaniya-spiska-alias-po-dannym-iz-gcp">  Script untuk membuat daftar alias berdasarkan data dari GCP </h2><br><p>  Script ditulis dengan python 2.7 karena dua alasan: </p><br><ol><li>  Saya memutuskan untuk mempelajarinya karena bekerja dengan data; </li><li>  python 2.7 secara default pada sebagian besar sistem yang menjalankan linux - tidak akan ada masalah menggunakannya di tempat lain.  Mengingat bahwa bahkan menang sekarang memungkinkan Anda untuk menempatkan sistem kedua dan menggunakan Ubuntu sebagai terminal. </li></ol><br><p>  Algoritma adalah sebagai berikut: </p><br><ol><li>  Kami mendapatkan daftar server dari Google Cloud menggunakan SDK, memulai eksekusi perintah di konsol dari python. </li><li>  Kami mem-parsing JSON yang dihasilkan menjadi tipe yang ramah-python. </li><li>  Kami memberikan output dalam format yang diperlukan untuk pengaturan ssh (jika perlu, output skrip dialihkan ke ~ / .ssh / config atau ke beberapa file perantara). </li></ol><br><div class="spoiler">  <b class="spoiler_title">Lihat skrip</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python import commands import json sComputeListOutput = commands.getoutput('gcloud compute instances list --filter="status:running" --format="json(name, status, networkInterfaces[].accessConfigs[])" ') s = json.loads(sComputeListOutput) for server in s: print 'HOST ',server['name'] print ' HostName ',server['networkInterfaces'][0]['accessConfigs'][0]['natIP']</span></span></code> </pre> </div></div><br><h2 id="obnovlenie-tolko-izmenennyh-dannyh">  Memperbarui Hanya Data Yang Dimodifikasi </h2><br><p>  Tugas ini masih dalam proses.  Saya berencana untuk membaca file ssh / config dalam skrip yang sama, membandingkannya dengan nilai yang diterima, dan kemudian menulis kembali seluruh hasilnya.  Atau buat file baru secara terpisah dan lakukan perbandingan menggunakan beberapa jenis diff - ini memungkinkan Anda untuk mengonfirmasi semua perubahan secara manual. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id484500/">https://habr.com/ru/post/id484500/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id484486/index.html">Komputer yang menolak mati</a></li>
<li><a href="../id484488/index.html">Seberapa membingungkan sistem kuantum? Jawabannya mungkin tidak bisa dihitung.</a></li>
<li><a href="../id484492/index.html">Kelas PHP untuk mengunduh dan mengunggah file ke server</a></li>
<li><a href="../id484496/index.html">Menggunakan Cura pada Printer 3D SLA Photon</a></li>
<li><a href="../id484498/index.html">Sistem AI memperingatkan pejalan kaki di headphone tentang mobil yang mendekat</a></li>
<li><a href="../id484502/index.html">Facebook memaksa moderator untuk mendokumentasikan jam kerja mereka hingga detik - bahkan pergi ke toilet</a></li>
<li><a href="../id484504/index.html">Membuat ionizer udara kurang dari $ 10</a></li>
<li><a href="../id484506/index.html">Saya seorang fotografer dan saya akan menjadikan diri saya alat yang berfungsi</a></li>
<li><a href="../id484512/index.html">TOP 25 ICO terbesar: ada apa dengan mereka sekarang?</a></li>
<li><a href="../id484514/index.html">Routing Universal untuk Aplikasi Bereaksi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>