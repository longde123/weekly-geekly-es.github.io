<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò∂ ‚õπüèº üéÖüèº Kami mengumpulkan log firewall Mikrotik dalam database üòâ üò° üé∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Selamat siang 

 Saya ingin memberi tahu Anda betapa mudah dan alami Anda dapat mengonfigurasi server pengumpulan metadata lalu lintas jaringan untuk ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kami mengumpulkan log firewall Mikrotik dalam database</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427159/">  Selamat siang <br><br>  Saya ingin memberi tahu Anda betapa mudah dan alami Anda dapat mengonfigurasi server pengumpulan metadata lalu lintas jaringan untuk router Mikrotik. <br><br>  <b>Tujuan:</b> Tujuannya adalah untuk menyimpan log firewall "dikunyah" dalam database untuk analisis lebih lanjut. <br><br>  <b>Berarti:</b> Setiap distribusi Linux baru dengan rsyslogd v8 dan lebih tinggi cocok untuk implementasi, mungkin sintaks yang diusulkan akan bekerja pada v7 juga.  Kami juga membutuhkan DBMS, saya memilih mariadb.  Pertumbuhan basis data akan bervariasi dari jumlah aturan yang dicatat, karena ukuran drive sesuai keinginan Anda, dalam kasus saya, 30-40 aturan dicatat, yaitu sekitar 1200 ribu baris per hari.  Selama bulan menggunakan database, termasuk indeks, itu tumbuh menjadi 3,8 GB. <br><br>  <b>Mekanika:</b> Router mengirim log ke server jauh melalui UDP.  Dengan menggunakan ekspresi reguler, server rsyslog membersihkan serangkaian informasi yang tidak perlu, menghasilkan insert SQL dan mengirimkannya ke DBMS.  DBMS, menggunakan pemicu sebelum penyisipan, melakukan pembersihan tambahan dan pemisahan bidang yang tidak dapat diuraikan dalam rsyslog. <br><a name="habracut"></a><br><h4>  <b>Konfigurasikan RSYSLOG</b> </h4><br>  Mengedit file /etc/rsyslog.conf <br>  Tambahkan baris berikut di sana: <br><br><pre><code class="plaintext hljs">module(load="ommysql") module(load="imudp") input(type="imudp" port="514")</code> </pre> <br>  Dengan demikian, kami memuat modul yang diperlukan dan membuka port UDP 514. <br><br>  Baris log dari Mikrotik terlihat seperti ini: <br><br><pre> <code class="plaintext hljs">20180927155341 BLOCKSMKNETS forward: in:ether6 - LocalTORF out:VLAN55 - RT_INET, src-mac 00:15:17:31:b8:d7, proto TCP (SYN), 192.168.0.234:2457-&gt;192.168.6.14:65535, len 60</code> </pre> <br>  Seperti yang Anda lihat, banyak tambahan untuk penyimpanan dalam database dan pemilihan yang jelas akan sulit. <br>  Secara teori, saya perlu menambahkan data seperti: <br><br><pre> <code class="plaintext hljs">20180927155341 ether6 VLAN5 192.168.0.234 2457 192.168.6.14 65535 00:15:17:31:b8:d7 TCP SYN forward BLOCKSMKNETS 60</code> </pre> <br>  Saya tidak bisa mendapatkan baris seperti itu hanya dengan menggunakan satu rsyslog.  Pelanggan tetap Rsyslog menggunakan POSIX ERE / BRE, jadi tidak ada cara untuk menerapkan fitur seperti lookahead atau lookbehind. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Ada</a> alat yang memungkinkan Anda untuk men-debug pelanggan tetap, coba, mungkin Anda dapat memisahkan port dari alamat, serta nama antarmuka dari dalam: dan keluar:.  Perlu diingat bahwa beberapa protokol olahraga dan olahraga hilang. <br><br>  Secara umum, output saya adalah sebagai berikut: <br><br><pre> <code class="plaintext hljs">20180927155341 in:ether6 out:VLAN5 192.168.0.234:2457 192.168.6.14:65535 00:15:17:31:b8:d7 TCP (SYN) forward BLOCKSMKNETS 60</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Ada</a> dokumentasi tentang cara memasak pelanggan tetap rsyslog. <br><br>  Dalam bentuk terakhir, file konfigurasi untuk menerima log dari Mikrotik /etc/rsyslog.d/20-remote.conf akan terlihat seperti ini: <br><br><pre> <code class="plaintext hljs">$template tpl_traflog,"insert into traflog.traffic (datetime, inif, outif, src, dst, smac, proto, flags, chain, logpref, len) values ('%timereported:::date-mysql%', '%msg:R,ERE,0,DFLT,0:in:[a-zA-Z]+[0-9]+|in:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%', '%msg:R,ERE,0,BLANK,0:out:[a-zA-Z]+[0-9]+|out:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%', '%msg:R,ERE,0,DFLT,0:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%', '%msg:R,ERE,0,DFLT,1:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%', '%msg:R,ERE,0,BLANK:([0-f]+:){5}[0-f]+--end%', '%msg:R,ERE,0,BLANK:\b[AX]{3,4}\b--end%', '%msg:R,ERE,0,BLANK:\([AZ]+\)|\(([AZ]+\,){1,3}[AZ]+\)--end%', '%msg:R,ERE,0,DFLT:[ax]+--end%', '%msg:F,32:2%', '%msg:R,ERE,0,DFLT:[0-9]+$--end%' )",SQL if ($fromhost-ip == '192.168.0.230') and ($syslogtag contains "firewall") then {action(type="ommysql" server="localhost" serverport="3306" db="traflog" uid="rsyslogger" pwd="rsyslogger" template="tpl_traflog") stop}</code> </pre><br>  Di baris pertama, deskripsi templat (templat) adalah sebaris kode SQL untuk mentransfernya ke DBMS. <br>  Baris kedua adalah kondisi ketika tindakan akan terjadi, yaitu catatan dalam DBMS. <br>  Kondisinya terlihat seperti ini: jika sumber log = 192.168.0.230 ( <code>if ($fromhost-ip == '192.168.0.230')</code> ) Dan jika baris msg berisi "firewall" (dan ($ syslogtag berisi "firewall")), maka gunakan modul ommysql dengan parameter koneksi ( <code>then {action(type="ommysql" server="localhost" serverport="3306" db="traflog" uid="rsyslogger" pwd="..."</code> ) kami memanggil template tpl_traflog ( <code>template="tpl_traflog")</code> ), dan setelah itu kami berhenti memproses baris lebih lanjut ( <code>stop}</code> ). <br><br>  Ada kemungkinan bahwa dalam kasus Anda ada sesuatu yang salah, itu mungkin karena nama antarmuka atau awalan log, mungkin sesuatu yang lain.  Untuk debugging, kami akan melakukan yang berikut, mengomentari baris kedua, menambahkan templat baru dan dua ketentuan baru: <br><br><pre> <code class="plaintext hljs">$template tpl_traflog_test,"%timereported:::date-mysql% %msg:R,ERE,0,DFLT,0:in:[a-zA-Z]+[0-9]+|in:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end% %msg:R,ERE,0,BLANK,0:out:[a-zA-Z]+[0-9]+|out:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end% %msg:R,ERE,0,DFLT,0:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end% %msg:R,ERE,0,DFLT,1:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end% %msg:R,ERE,0,BLANK:([0-f]+:){5}[0-f]+--end% %msg:R,ERE,0,BLANK:\b[AX]{3,4}\b--end% %msg:R,ERE,0,BLANK:\([AZ]+\)|\(([AZ]+\,){1,3}[AZ]+\)--end% %msg:R,ERE,0,DFLT:[ax]+--end% %msg:F,32:2% %msg:R,ERE,0,DFLT:[0-9]+$--end%\n" if ($fromhost-ip == '192.168.0.230') then {action(type="omfile" file="/var/log/remote/192.168.0.230.log" )} if ($fromhost-ip == '192.168.0.230') then {action(type="omfile" file="/var/log/remote/192.168.0.230.log" template="tpl_traflog_test" ) stop}</code> </pre> <br>  Mulai ulang logger. <br><br>  Templat tpl_traflog_test mirip dengan tpl_traflog, tetapi tanpa SQL INSERT. <br><br>  Kondisi pertama menambahkan baris yang tidak diproses% msg% ke file /var/log/remote/192.168.0.230.log, karena templat tidak ditentukan. <br><br>  Kondisi kedua menambahkan baris yang diproses ke file yang sama. <br>  Jadi akan lebih mudah untuk membandingkan. <br>  Selanjutnya, siapkan database. <br><br><h4>  <b>Kami menyiapkan DB</b> </h4><br>  Kami akan menurunkan pengaturan DBMS, semuanya standar di sini. <br><br>  Kami memulai konsol mysql dan menjalankan kode berikut: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   create database traflog character set utf8 collate utf8_bin; use traflog; --  create table traffic (id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY, datetime DATETIME, inif VARCHAR(20), outif VARCHAR(20), src VARCHAR(21), sport INT(5), dst VARCHAR(21), dport INT(5), smac VARCHAR(17), proto VARCHAR(4), flags VARCHAR(11), chain VARCHAR(8), logpref VARCHAR(24), len INT(5)) ENGINE=MYISAM; --  create user rsyslogger@localhost identified by '...'; grant all privileges on traflog.* to rsyslogger@localhost;</span></span></code> </pre><br>  Tabel sudah siap, pengguna siap. <br><br>  Sekarang tambahkan pemicu, itu akan melakukan apa yang gagal logger memisahkan alamat dari port, membersihkan nama-nama antarmuka, menghapus tanda kurung dari bendera: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   traffic DELIMITER // create TRIGGER delim_ip_port_flags BEFORE insert ON traffic FOR EACH ROW begin set NEW.inif = REGEXP_REPLACE ((NEW.inif), 'in:', '' ); set NEW.outif = REGEXP_REPLACE ((NEW.outif), 'out:', '' ); set NEW.sport = REGEXP_REPLACE ((NEW.src), '([0-9]+\.){3}[0-9]+:|([0-9]+\.){3}[0-9]+', '' ); set NEW.src = REGEXP_REPLACE ((NEW.src), ':[0-9]+', '' ); set NEW.dport = REGEXP_REPLACE ((NEW.dst), '([0-9]+\.){3}[0-9]+:|([0-9]+\.){3}[0-9]+', '' ); set NEW.dst = REGEXP_REPLACE ((NEW.dst), ':[0-9]+', '' ); set NEW.flags = REGEXP_REPLACE ((NEW.flags), '\\(|\\)', '' ); end // delimiter ;</span></span></code> </pre> <br>  REGEXP_REPLACE mencari parameter kedua setelah titik desimal (musim reguler) dan menggantinya dengan parameter ketiga, dalam kasus kami tidak ada tanda kutip, oleh karena itu, hanya menghapus apa yang ditemukannya. <br><br>  Mari kita membuat sisipan uji, mirip dengan bagaimana pencatat akan melakukan: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   insert into traffic (datetime, inif, outif, src, dst, smac, proto, chain, logpref) values (20180730075437, 'in:ether6', 'out:VLAN55', '192.168.0.234:4997', '192.168.6.18:65535', '00:15:17:31:b8:d7', 'TCP', '(SYN)', 'forward', 'BLOCKSMKNETS');</span></span></code> </pre> <br>  Mari kita lihat apa yang terjadi: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tarffic;</code> </pre> <br>  Jika semuanya benar, maka pindah.  Jika tidak, cari kesalahannya. <br><br>  Tambahkan setidaknya satu indeks.  Saya bukan ahli dalam membuat indeks, tetapi seperti yang saya pahami, di mysql lebih tepat menggunakan indeks dengan bidang gabungan yang berbeda untuk kueri yang berbeda, karena satu kueri hanya dapat menggunakan satu indeks (atau apakah saya salah?).  Jika Anda mengerti, lakukan sesuai keinginan Anda. <br>  Saya sering harus membuat permintaan dengan awalan tertentu, jadi saya menambahkan indeks ini: <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--  create index traffic_index on traffic (datetime,logpref,src);</span></span></code> </pre> <br>  Selesai <br><br>  Sekarang Anda harus mulai mengirim pada router, tambahkan pengaturan server log jauh dan bertindak untuk itu, tambahkan opsi log ke salah satu aturan firewall, tambahkan awalan tidak lebih dari 24 karakter. <br><br>  Di konsol Mikrotik, tampilannya seperti ini: <br><br><pre> <code class="plaintext hljs">/system logging action set 3 remote=192.168.0.94 src-address=192.168.0.230 add name=remote2 remote=192.168.0.19 syslog-facility=local6 target=remote /system logging add action=remote topics=error,account,critical,event,info add action=remote2 topics=firewall /ip firewall filter ... add action=drop chain=input comment="drop ssh brute forcers" dst-port=22,8291 log=yes log-prefix=DROP_SSH_BRUTE protocol=tcp src-address-list=ssh_blacklist ...</code> </pre><br>  Di mana 192.168.0.230 adalah alamat router, 192.168.0.19 adalah alamat server log untuk log firewall, dan 192.168.0.94 adalah server log lain, saya memiliki log sistem Mikrotik di sana, kami tidak memerlukannya sekarang.  Pengaturan kami adalah remote2. <br><br>  Selanjutnya, lihat apa yang termasuk dalam file: <br><br><pre> <code class="plaintext hljs">tail -f /var/log/remote/192.168.0.230.log</code> </pre> <br>  Baris dari router harus dimasukkan ke dalam file, kecuali jika aturan Anda dipicu cukup sering. <br><br>  Jika beberapa bidang tidak ada, yaitu urutan datetime, inif, outif, src, dst, smac, proto, flag, chain, logpref, len tidak diikuti, maka Anda dapat mencoba mengubah parameter dalam template debugging dari logger, ganti BLANK dengan DLFT.  Kemudian, alih-alih kekosongan bidang apa pun, beberapa surat akan muncul, saya tidak ingat yang mana.  Jika ini terjadi, maka ada yang salah dengan jadwal reguler dan Anda harus memperbaikinya. <br><br>  Jika semuanya berjalan sebagaimana mestinya, maka matikan kondisi pengujian dan templat. <br><br>  Anda juga perlu menjalankan konfigurasi default di /etc/rsyslog.d/ di bawah ini, saya menamainya menjadi 50-default.conf sehingga log jarak jauh tidak dituangkan ke log sistem / var / log / message <br>  Mulai ulang logger. <br><br>  Mari kita tunggu sebentar sampai database kita penuh.  Lalu kita bisa memulai seleksi. <br><br>  <b>Beberapa pertanyaan untuk contoh:</b> <br><br><div class="spoiler">  <b class="spoiler_title">Untuk melihat ukuran basis data dan jumlah baris:</b> <div class="spoiler_text"><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> table_schema <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"database"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_length + index_length)/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"size Mb"</span></span>, TABLE_ROWS <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"count rows"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> information_schema.tables <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> table_schema; +<span class="hljs-comment"><span class="hljs-comment">--------------------+---------+------------+ | database | size Mb | count rows | +--------------------+---------+------------+ | information_schema | 0.17 | NULL | | traflog | 3793.39 | 21839553 | +--------------------+---------+------------+ 2 rows in set (0.48 sec)</span></span></code> </pre><br>  Hampir 4GB telah tumbuh dalam sebulan, tetapi itu tergantung pada jumlah dan properti aturan firewall yang dicatat <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Jumlah awalan yang dicatat</b> <div class="spoiler_text">  Jumlah awalan yang dicatat tidak sama dengan jumlah aturan, beberapa aturan bekerja dengan satu awalan, tetapi masih berapa total awalan?  dan berapa banyak aturan yang telah dibuat untuk mereka?: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> logpref,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(logpref) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> logpref <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(logpref) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; +<span class="hljs-comment"><span class="hljs-comment">----------------------+----------------+ | logpref | count(logpref) | +----------------------+----------------+ | ACCEPT_TORF_INET | 14582602 | | ACCEPT_SMK_PPP | 1085791 | | DROP_FORWARD_INVALID | 982374 | | REJECT_BNK01 | 961503 | | ACCEPT_MMAX_TORF | 802455 | | ACCEPT_TORF_PPP | 736803 | | SMTP_DNAT | 689533 | | ACCEPT_SMK_INET | 451411 | | ACCEPT_INET_TORF | 389857 | | BLOCK_SMKNETS | 335424 | | DROP_SMTP_BRUTE | 285850 | | ACCEPT_ROZN_TORF | 154811 | | ACCEPT_TORF_MMAX | 148393 | | DROP_ETHALL_ETHALL | 80679 | | ACCEPT_SMTP | 48921 | | DROP_SMTP_DDOS | 32190 | | RDP_DNAT | 28757 | | ACCEPT_TORF_ROZN | 18456 | | SIP_DNAT | 15494 | | 1CWEB_DNAT | 6406 | | BLOCKSMKNETS | 5789 | | DROP_SSH_BRUTE | 3162 | | POP_DNAT | 1997 | | DROP_RDP_BRUTE | 442 | | DROP_BNK01 | 291 | | DROPALL | 138 | | ACCEPT_RTP_FORWARD | 90 | | REJECT_SMTP_BRUTE | 72 | | L2TP_INPUT_ACCEPT | 33 | +----------------------+----------------+ 29 rows in set (2 min 51.03 sec)</span></span></code> </pre> <br>  ACCEPT_TORF_INET berada di depan, dengan awalan ini Anda dapat menemukan semua orang yang pergi ke Internet dari jaringan lokal kami, protokol dan port dicatat, waktunya akan tiba dan akses akan ditutup untuk beberapa.  Ada data referensi untuk pekerjaan bug di masa mendatang. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Pemimpin tombak Smtp</b> <div class="spoiler_text">  Mari kita lihat siapa yang hari ini mencoba untuk masuk ke server smtp: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'SMTP_DNAT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> datetime &gt; <span class="hljs-string"><span class="hljs-string">'2018101600000000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>; +<span class="hljs-comment"><span class="hljs-comment">----------------+--------------+ | src | count(dport) | +----------------+--------------+ | 191.96.249.92 | 12440 | | 191.96.249.24 | 4556 | | 191.96.249.61 | 4537 | | 185.255.31.122 | 3119 | | 178.57.79.250 | 226 | | 185.36.81.174 | 216 | | 185.234.219.32 | 211 | | 89.248.162.145 | 40 | | 45.125.66.157 | 32 | | 188.165.124.31 | 21 | +----------------+--------------+ 10 rows in set, 1 warning (21.36 sec)</span></span></code> </pre> <br>  Jelas, simpul 191.96.249.92 adalah pemenang hari ini.  Mari kita lihat di aturan mana dia masih muncul: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,dport,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport),logpref <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> src=<span class="hljs-string"><span class="hljs-string">'191.96.249.92'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> logpref <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; +<span class="hljs-comment"><span class="hljs-comment">---------------+-------+--------------+-----------------+ | src | dport | count(dport) | logpref | +---------------+-------+--------------+-----------------+ | 191.96.249.92 | 25 | 226989 | SMTP_DNAT | | 191.96.249.92 | 25 | 170714 | DROP_SMTP_BRUTE | | 191.96.249.92 | 25 | 2907 | DROP_SMTP_DDOS | | 191.96.249.92 | 25 | 2061 | ACCEPT_SMTP | +---------------+-------+--------------+-----------------+ 4 rows in set (10 min 44.21 sec)</span></span></code> </pre><br>  Yang ini mengkhususkan hanya pada smtp, ~ 1% dari hit untuk mencoba menebak kata sandi atau mencoba mengirim sampah, sisanya pergi ke pemandian. <br><br>  Permintaan butuh 10 menit, ini banyak, indeks saat ini tidak cocok untuk itu, atau Anda dapat memformulasikan ulang permintaan, tetapi sekarang kami tidak akan membicarakannya. <br></div></div><br>  Di masa depan, direncanakan untuk mengacaukan antarmuka web dengan kueri dan formulir standar. <br>  Vektor diberikan, saya harap artikel ini bermanfaat. <br><br>  Terima kasih semuanya! <br><br>  <b>Referensi:</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dokumentasi rsyslog</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dokumentasi Mysql</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dokumentasi logging mikrotik</a> <br><br>  Terima kasih kepada komunitas LOR untuk <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tipsnya.</a> <br><br>  <b>UPD.1</b> <br>  Menambahkan bidang bendera ke database, sekarang Anda dapat melacak durasi koneksi dengan menangkap SYN, FIN. <br>  Memperbaiki beberapa bug di rsyslog tetap, serta pemicu mysql. <br><br>  Anehnya, aturan default defconf: drop invalid menjatuhkan semua paket akhir koneksi TCP, sebagai akibatnya, semua node yang mencoba untuk menutup koneksi dalam sains gagal, mengirim beberapa FIN.  Apakah ini benar <br><br>  Saya menambahkan aturan yang memungkinkan TCP traversal dengan ACK, flag FIN. <br><br>  Di bawah SQL spoiler, prosedur yang menunjukkan waktu koneksi TCP dalam lima menit terakhir <br><div class="spoiler">  <b class="spoiler_title">koneksi_list ()</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> connections_list; DELIMITER // <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> connections_list() <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> logid <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> done <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> datefin DATETIME; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> datesyn DATETIME; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conntime <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> connsport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conndport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> connsrc <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conndst <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> cur <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>,datetime,src,sport,dst,dport <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> conn_syn_fin <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> flags=<span class="hljs-string"><span class="hljs-string">'SYN'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> CONTINUE <span class="hljs-keyword"><span class="hljs-keyword">HANDLER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOUND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> done=<span class="hljs-literal"><span class="hljs-literal">TRUE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> conn_syn_fin; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> connless; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> connless(datestart DATETIME,dateend DATETIME,<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>,src <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>),sport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>,dst <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>),dport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> conn_syn_fin (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> datetime &gt; <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime &gt; <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'TCP_FIN'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%SYN%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); OPEN cur; read_loop: LOOP FETCH cur INTO logid,datesyn,connsrc,connsport,conndst,conndport; IF done THEN LEAVE read_loop; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> datefin=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> conn_syn_fin <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&gt;logid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> src=connsrc <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> sport=connsport <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dst=conndst <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dport=conndport <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> conntime=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timediff</span></span>(datefin,datesyn)); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> connless (datestart,dateend,<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>,src,sport,dst,dport) <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> (datesyn,datefin,conntime,connsrc,connsport,conndst,conndport); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; CLOSE cur; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> connless; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; // DELIMITER ;</code> </pre><br></div></div><br>  Sebagai hasil dari prosedur, dua tabel sementara akan dibuat. <br>  Tabel <b>conn_syn_fin</b> berisi entri log dengan bendera SYN dan FIN, kemudian pencarian dilakukan menggunakan kursor dalam tabel ini. <br>  Tabel <b>connless</b> berisi daftar koneksi, terbuka dan selesai, selesai memiliki durasi terbuka, masing-masing, no. <br>  Perhatikan waktu pengambilan sampel dikurangi lima menit dari waktu saat ini.  Permintaan saya lambat.  Perlahan-lahan ia pergi melalui pencarian kursor, memproses sekitar 10 catatan per detik, mencoba mempercepatnya dalam segala hal, tetapi waktu eksekusi selalu hampir sama. <br>  Perhatikan juga bahwa prosedur ini hanya untuk tujuan demonstrasi.  Jika Anda perlu menentukan pilihan untuk src / sport / dst / dport tertentu, lebih baik membuat prosedur terpisah yang serupa dengan yang ini.  Jika Anda adalah master sql, maka Anda dapat menulis kueri Anda dengan lebih baik. <br><br><div class="spoiler">  <b class="spoiler_title">panggil koneksi_list ();</b> <div class="spoiler_text"><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> connections_list(); +<span class="hljs-comment"><span class="hljs-comment">---------------------+---------------------+----------+---------------+-------+-----------------+-------+ | datestart | dateend | duration | src | sport | dst | dport | +---------------------+---------------------+----------+---------------+-------+-----------------+-------+ | 2019-03-20 14:12:19 | 2019-03-20 14:13:14 | 00:00:55 | 192.168.0.81 | 41868 | 87.250.250.207 | 443 | | 2019-03-20 14:12:25 | NULL | NULL | 192.168.0.65 | 49311 | 52.5.23.125 | 443 | | 2019-03-20 14:12:31 | 2019-03-20 14:12:51 | 00:00:20 | 192.168.0.104 | 54433 | 217.69.139.42 | 443 | | 2019-03-20 14:12:31 | 2019-03-20 14:12:51 | 00:00:20 | 192.168.0.104 | 54434 | 217.69.139.42 | 443 | | 2019-03-20 14:12:32 | NULL | NULL | 192.168.0.119 | 37977 | 209.85.233.95 | 443 | ... | 2019-03-20 14:17:12 | NULL | NULL | 192.168.0.119 | 39331 | 91.213.158.131 | 443 | | 2019-03-20 14:17:13 | NULL | NULL | 192.168.0.90 | 63388 | 87.240.185.236 | 443 | +---------------------+---------------------+----------+---------------+-------+-----------------+-------+ 399 rows in set (33.17 sec) Query OK, 0 rows affected (33.18 sec)</span></span></code> </pre><br></div></div><br><br>  Setelah prosedur selesai, tabel sementara <b>conn_syn_fin</b> dan <b>connless</b> tetap, Anda dapat melihatnya secara lebih terperinci jika Anda menemukan sesuatu yang mencurigakan atau tidak dapat diandalkan.  Setelah memulai prosedur, tabel lama dihapus dan yang baru muncul.  Tulis jika Anda menemukan kesalahan. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id427159/">https://habr.com/ru/post/id427159/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id427147/index.html">‚ÄúModel Referensi BIAN‚Äù untuk industri perbankan atau cara berhenti menciptakan kembali roda</a></li>
<li><a href="../id427149/index.html">Speaker RADIOTEHNIKA S-30 lama ke baru</a></li>
<li><a href="../id427151/index.html">Proses pendidikan di bidang TI: Olimpiade, beasiswa, program pendukung, dan komunitas Universitas ITMO</a></li>
<li><a href="../id427153/index.html">DNA Mekanisme untuk menyimpan dan memproses informasi. Bagian II</a></li>
<li><a href="../id427155/index.html">Southampton Filter Bus - Langkah Pertama Untuk Membersihkan Kota</a></li>
<li><a href="../id427163/index.html">Bahan baru akan membantu membuat pembangkit listrik tenaga surya termal lebih efisien</a></li>
<li><a href="../id427165/index.html">Bagaimana mengembangkan tes integrasi untuk Atlassian Jira Server (jira-func-test-plugin)</a></li>
<li><a href="../id427169/index.html">Tesla dengan tenang menghapus opsi autopilot penuh</a></li>
<li><a href="../id427171/index.html">Keamanan meninggalkan Anda</a></li>
<li><a href="../id427173/index.html">Apakah telepon lebih murah daripada gratis?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>