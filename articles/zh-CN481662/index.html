<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¶ğŸ½ ğŸ¤ŸğŸ» ğŸ§” å°è¯•åœ¨Kubernetesä¸­æ„å»ºå’Œè‡ªåŠ¨åŒ–éƒ¨ç½²çš„æ–°å·¥å…· ğŸ¤²ğŸ¾ â›³ï¸ ğŸ¹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä½ å¥½ æœ€è¿‘ï¼Œå·²ç»å‘å¸ƒäº†è®¸å¤šå¾ˆé…·çš„è‡ªåŠ¨åŒ–å·¥å…·ï¼Œç”¨äºæ„å»ºDockeræ˜ åƒä»¥åŠå°†å…¶éƒ¨ç½²åˆ°Kubernetesã€‚ åœ¨è¿™æ–¹é¢ï¼Œæˆ‘å†³å®šä½¿ç”¨gitlabï¼Œç ”ç©¶å¦‚ä½•ç ”ç©¶å®ƒçš„åŠŸèƒ½ï¼Œå½“ç„¶è¿˜è¦é…ç½®ç®¡é“ã€‚ 


 è¿™é¡¹å·¥ä½œçš„çµæ„Ÿæ¥è‡ªç½‘ç«™kubernetes.io ï¼Œè¯¥ç½‘ç«™æ˜¯ä»æºä»£ç è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå¯¹äºæ¯ä¸ªå‘é€çš„æ± ï¼Œæœºå™¨äººä¼šè‡ªåŠ¨...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å°è¯•åœ¨Kubernetesä¸­æ„å»ºå’Œè‡ªåŠ¨åŒ–éƒ¨ç½²çš„æ–°å·¥å…·</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481662/"><p><img src="https://habrastorage.org/webt/fu/wy/ia/fuwyia7huxrflvry8lzz2dbl2tw.png"></p><br><p> ä½ å¥½ æœ€è¿‘ï¼Œå·²ç»å‘å¸ƒäº†è®¸å¤šå¾ˆé…·çš„è‡ªåŠ¨åŒ–å·¥å…·ï¼Œç”¨äºæ„å»ºDockeræ˜ åƒä»¥åŠå°†å…¶éƒ¨ç½²åˆ°Kubernetesã€‚ åœ¨è¿™æ–¹é¢ï¼Œæˆ‘å†³å®šä½¿ç”¨gitlabï¼Œç ”ç©¶å¦‚ä½•ç ”ç©¶å®ƒçš„åŠŸèƒ½ï¼Œå½“ç„¶è¿˜è¦é…ç½®ç®¡é“ã€‚ </p><br><p> è¿™é¡¹å·¥ä½œçš„çµæ„Ÿæ¥è‡ªç½‘ç«™<a href="https://kubernetes.io/" rel="nofollow">kubernetes.io</a> ï¼Œè¯¥ç½‘ç«™æ˜¯ä»<a href="http://github.com/kubernetes/website" rel="nofollow">æºä»£ç </a>è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå¯¹äºæ¯ä¸ªå‘é€çš„æ± ï¼Œæœºå™¨äººä¼šè‡ªåŠ¨ç”ŸæˆåŒ…å«æ‚¨<a href="https://kubernetes.io/" rel="nofollow">æ‰€åš</a>æ›´æ”¹çš„ç½‘ç«™é¢„è§ˆç‰ˆæœ¬ï¼Œå¹¶æä¾›æŸ¥çœ‹é“¾æ¥ã€‚ </p><br><p> æˆ‘å°è¯•ä»å¤´å¼€å§‹æ„å»ºä¸€ä¸ªç±»ä¼¼çš„è¿‡ç¨‹ï¼Œä½†å®Œå…¨åŸºäºGitlab CIå’Œæˆ‘ç”¨æ¥åœ¨Kubernetesä¸­éƒ¨ç½²åº”ç”¨ç¨‹åºçš„å…è´¹å·¥å…·ã€‚ ä»Šå¤©ï¼Œæˆ‘æœ€ç»ˆå°†å‘æ‚¨è¯¦ç»†ä»‹ç»å®ƒä»¬ã€‚ </p><br><p> æœ¬æ–‡å°†è€ƒè™‘ä»¥ä¸‹å·¥å…·ï¼š <br>  <strong>Hugo</strong> ï¼Œ <strong>qbec</strong> ï¼Œ <strong>kaniko</strong> ï¼Œ <strong>git-crypt</strong>å’Œ<strong>GitLab CI</strong>ä»¥åŠåŠ¨æ€ç¯å¢ƒçš„åˆ›å»ºã€‚ </p><a name="habracut"></a><br><hr><br><h1 id="coderzhanie"> ç›®å½•å†…å®¹ </h1><br><ol><li>  <a href="https://habr.com/ru/post/481662/"><strong>é›¨æœç®€ä»‹</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>å‡†å¤‡Dockerfile</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>ä¸kanikoç›¸è¯†</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>qbecç®€ä»‹</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>ç”¨Kubernetes-executorå°è¯•Gitlab-runner</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>ä½¿ç”¨qbecéƒ¨ç½²Helmå›¾è¡¨</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>å¼•å…¥git-crypt</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>åˆ›å»ºå·¥å…·ç®±å›¾åƒ</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç®¡é“å’Œæ ‡ç­¾çš„å›¾åƒç»„è£…</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>éƒ¨ç½²è‡ªåŠ¨åŒ–</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>å·¥ä»¶å’Œæ¨å…¥æ„å»ºå¤§å¸ˆ</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>åŠ¨æ€ç¯å¢ƒ</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>è¯„è®ºåº”ç”¨</strong></a> </li></ol><br><hr><br><h1 id="1-znakomstvo-s-hugoanchorhugoanchor">  1.é›¨æœç®€ä»‹ <a name="hugo"></a></h1><br><p> ä½œä¸ºæˆ‘ä»¬é¡¹ç›®çš„ä¸€ä¸ªç¤ºä¾‹ï¼Œæˆ‘ä»¬å°†å°è¯•åˆ›å»ºä¸€ä¸ªç½‘ç«™æ¥å‘å¸ƒåŸºäºHugoçš„æ–‡æ¡£ã€‚  Hugoæ˜¯é™æ€å†…å®¹ç”Ÿæˆå™¨ã€‚ </p><br><p> å¯¹äºé‚£äº›ä¸ç†Ÿæ‚‰é™æ€ç”Ÿæˆå™¨çš„äººï¼Œæˆ‘ä¼šå‘Šè¯‰æ‚¨æ›´å¤šæœ‰å…³å®ƒä»¬çš„ä¿¡æ¯ã€‚ ä¸å¸¸è§„æ•°æ®åº“ç«™ç‚¹å¼•æ“å’ŒæŸäº›phpå¼•æ“ä¸åŒï¼Œå½“ç”¨æˆ·æç¤ºæ—¶ï¼Œå®ƒä»¬ä¼šå³æ—¶ç”Ÿæˆé¡µé¢ï¼Œè€Œé™æ€ç”Ÿæˆå™¨çš„æ’åˆ—æ–¹å¼ç•¥æœ‰ä¸åŒã€‚ å®ƒä»¬å…è®¸æ‚¨è·å–æºï¼Œé€šå¸¸å®ƒæ˜¯Markdownæ ‡è®°å’Œä¸»é¢˜æ¨¡æ¿ä¸­çš„ä¸€ç»„æ–‡ä»¶ï¼Œç„¶åå°†å®ƒä»¬ç¼–è¯‘æˆä¸€ä¸ªå®Œæ•´çš„ç½‘ç«™ã€‚ </p><br><p> ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¾“å‡ºä¸­ï¼Œæ‚¨å°†è·å¾—ç›®å½•ç»“æ„å’Œä¸€ç»„ç”Ÿæˆçš„htmlæ–‡ä»¶ï¼Œå¯ä»¥å°†å…¶ç®€å•åœ°ä¸Šè½½åˆ°ä»»ä½•ä¾¿å®œçš„ä¸»æœºå¹¶è·å¾—ä¸€ä¸ªå·¥ä½œç«™ç‚¹ã€‚ </p><br><p> é›¨æœå¯ä»¥åœ¨æœ¬åœ°å®‰è£…å¹¶è¯•ç”¨ï¼š </p><br><p> æˆ‘ä»¬åˆå§‹åŒ–æ–°ç«™ç‚¹ï¼š </p><br><pre><code class="bash hljs">hugo new site docs.example.org</code> </pre> <br><p> å¹¶åŒæ—¶gitå­˜å‚¨åº“ï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> docs.example.org git init</code> </pre> <br><p> åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„ç½‘ç«™æ˜¯åŸå§‹çš„ï¼Œè¦ä½¿å®ƒé¦–å…ˆå‡ºç°åœ¨å…¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å…³è”ä¸€ä¸ªä¸»é¢˜ï¼Œä¸€ä¸ªä¸»é¢˜-å®ƒåªæ˜¯ç”Ÿæˆæˆ‘ä»¬ç½‘ç«™æ‰€ç”¨çš„ä¸€ç»„æ¨¡æ¿å’Œé¢„è®¾è§„åˆ™ã€‚ </p><br><p> ä½œä¸ºä¸»é¢˜ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<a href="https://themes.gohugo.io/hugo-theme-learn/" rel="nofollow"><strong>Learn</strong></a> ï¼Œæˆ‘è®¤ä¸ºå®ƒæœ€é€‚åˆåŒ…å«æ–‡æ¡£çš„ç½‘ç«™ã€‚ </p><br><p> æˆ‘è¦ç‰¹åˆ«æ³¨æ„ä¸€ä¸ªäº‹å®ï¼Œæˆ‘ä»¬ä¸éœ€è¦å°†ä¸»é¢˜æ–‡ä»¶ä¿å­˜åœ¨æˆ‘ä»¬é¡¹ç›®çš„å­˜å‚¨åº“ä¸­ï¼Œè€Œæ˜¯å¯ä»¥ä½¿ç”¨<strong>git submodule</strong>è¿›è¡Œç®€å•è¿æ¥ï¼š </p><br><pre> <code class="bash hljs">git submodule add https://github.com/matcornic/hugo-theme-learn themes/learn</code> </pre> <br><p> å› æ­¤ï¼Œåœ¨æˆ‘ä»¬çš„å­˜å‚¨åº“ä¸­å°†åªæœ‰ä¸é¡¹ç›®ç›´æ¥ç›¸å…³çš„æ–‡ä»¶ï¼Œå¹¶ä¸”è¿æ¥çš„ä¸»é¢˜å°†ä¿æŒä¸ºæŒ‡å‘ç‰¹å®šå­˜å‚¨åº“çš„é“¾æ¥çš„å½¢å¼å¹¶åœ¨å…¶ä¸­æäº¤ï¼Œå³å§‹ç»ˆå¯ä»¥å°†å…¶ä»åŸå§‹æºä¸­æ‹‰å‡ºè€Œä¸å¿…æ‹…å¿ƒæ›´æ”¹ä¸å…¼å®¹ã€‚ </p><br><p> ä¿®å¤<strong>config.toml</strong>é…ç½®ï¼š </p><br><pre> <code class="plaintext hljs">baseURL = "http://docs.example.org/" languageCode = "en-us" title = "My Docs Site" theme = "learn"</code> </pre> <br><p> åœ¨æ­¤é˜¶æ®µï¼Œæ‚¨å¯ä»¥è¿è¡Œï¼š </p><br><pre> <code class="bash hljs">hugo server</code> </pre> <br><p> åœ¨<a href="http://localhost:1313/" rel="nofollow">httpï¼š// localhostï¼š1313 /</a>æ£€æŸ¥æˆ‘ä»¬æ–°åˆ›å»ºçš„ç«™ç‚¹ï¼Œå¯¹ç›®å½•æ‰€åšçš„æ‰€æœ‰æ›´æ”¹éƒ½ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œå¹¶ä¸”åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€é¡µé¢éå¸¸æ–¹ä¾¿ï¼ </p><br><p> è®©æˆ‘ä»¬å°è¯•åœ¨<strong>content / _index.mdä¸­</strong>åˆ›å»ºå°é¢ï¼š </p><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># My docs site ## Welcome to the docs! You will be very smart :-)</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">æ–°å»ºé¡µé¢çš„å±å¹•æˆªå›¾</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/gb/yx/nv/gbyxnvagfs6bks4iqbwcrrovumu.png"></p></div></div><br><p> è¦ç”Ÿæˆä¸€ä¸ªç«™ç‚¹ï¼Œåªéœ€è¿è¡Œï¼š </p><br><pre> <code class="bash hljs">hugo</code> </pre> <br><p>  <strong>public /</strong>ç›®å½•çš„å†…å®¹å°†æˆä¸ºæ‚¨çš„ç«™ç‚¹ã€‚ <br> æ˜¯çš„ï¼Œé¡ºä¾¿è¯´ä¸€å¥ï¼Œè®©æˆ‘ä»¬ç«‹å³å°†å…¶æ·»åŠ åˆ°<strong>.gitignore</strong> ï¼š </p><br><pre> <code class="plaintext hljs">echo /public &gt; .gitignore</code> </pre> <br><p> ä¸è¦å¿˜è®°æäº¤æˆ‘ä»¬çš„æ›´æ”¹ï¼š </p><br><pre> <code class="plaintext hljs">git add . git commit -m "New site created"</code> </pre> <br><hr><br><h1 id="2-podgotovka-dockerfileanchordockerfileanchor">  2.å‡†å¤‡Dockerfile <a name="dockerfile"></a></h1><br><p> ç°åœ¨æ˜¯ç¡®å®šå­˜å‚¨åº“ç»“æ„çš„æ—¶å€™äº†ã€‚ é€šå¸¸æˆ‘ä½¿ç”¨ç±»ä¼¼ï¼š </p><br><pre> <code class="plaintext hljs">. â”œâ”€â”€ deploy â”‚ â”œâ”€â”€ app1 â”‚ â””â”€â”€ app2 â””â”€â”€ dockerfiles â”œâ”€â”€ image1 â””â”€â”€ image2</code> </pre> <br><ul><li>  <strong>dockerfiles--</strong>åŒ…å«Dockerfilesç›®å½•ä»¥åŠæ„å»ºdockeræ˜ åƒæ‰€éœ€çš„ä¸€åˆ‡ã€‚ </li><li>  <strong>deploy /</strong> -åŒ…å«ç”¨äºå°†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°Kubernetesçš„ç›®å½• </li></ul><br><p> å› æ­¤ï¼Œæˆ‘ä»¬å°†æ²¿ç€è·¯å¾„<strong>dockerfiles / website / Dockerfile</strong>åˆ›å»ºæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ª<strong>Dockerfileã€‚</strong> </p><br><pre> <code class="bash hljs">FROM alpine:3.11 as builder ARG HUGO_VERSION=0.62.0 RUN wget -O- https://github.com/gohugoio/hugo/releases/download/v<span class="hljs-variable"><span class="hljs-variable">${HUGO_VERSION}</span></span>/hugo_<span class="hljs-variable"><span class="hljs-variable">${HUGO_VERSION}</span></span>_linux-64bit.tar.gz | tar -xz -C /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin ADD . /src RUN hugo -s /src FROM alpine:3.11 RUN apk add --no-cache darkhttpd COPY --from=builder /src/public /var/www ENTRYPOINT [ <span class="hljs-string"><span class="hljs-string">"/usr/bin/darkhttpd"</span></span> ] CMD [ <span class="hljs-string"><span class="hljs-string">"/var/www"</span></span> ]</code> </pre> <br><p> å¦‚æ‚¨æ‰€è§ï¼ŒDockerfileåŒ…å«ä¸¤ä¸ªFROMï¼Œæ­¤åŠŸèƒ½ç§°ä¸º<a href="https://docs.docker.com/develop/develop-images/multistage-build/" rel="nofollow"><strong>å¤šé˜¶æ®µæ„å»º</strong></a> ï¼Œå¯è®©æ‚¨ä»æœ€ç»ˆdockeræ˜ åƒä¸­æ’é™¤æ‰€æœ‰ä¸å¿…è¦çš„å†…å®¹ã€‚ <br> å› æ­¤ï¼Œæœ€ç»ˆå›¾åƒå°†ä»…åŒ…å«<strong>darkhttpd</strong> ï¼ˆè½»é‡çº§HTTPæœåŠ¡å™¨ï¼‰å’Œ<strong>public /</strong> -é™æ€ç”Ÿæˆçš„ç«™ç‚¹çš„å†…å®¹ã€‚ </p><br><p> ä¸è¦å¿˜è®°æäº¤æˆ‘ä»¬çš„æ›´æ”¹ï¼š </p><br><pre> <code class="plaintext hljs">git add dockerfiles/website git commit -m "Add Dockerfile for website"</code> </pre> <br><hr><br><h1 id="3-znakomstvo-s-kanikoanchorkanikoanchor">  3.è®¤è¯†åŠ å°¼å­ <a name="kaniko"></a></h1><br><p> ä½œä¸º<strong><a href="https://github.com/GoogleContainerTools/kaniko" rel="nofollow">docker</a></strong>æ˜ åƒçš„æ”¶é›†è€…ï¼Œæˆ‘å†³å®šä½¿ç”¨<strong><a href="https://github.com/GoogleContainerTools/kaniko" rel="nofollow">kaniko</a></strong> ï¼Œå› ä¸ºå®ƒä¸éœ€è¦<strong><a href="https://github.com/GoogleContainerTools/kaniko" rel="nofollow">docker</a></strong>å®ˆæŠ¤è¿›ç¨‹æ¥å·¥ä½œï¼Œå¹¶ä¸”ç¨‹åºé›†æœ¬èº«å¯ä»¥åœ¨ä»»ä½•è®¡ç®—æœºä¸Šæ‰§è¡Œå¹¶å°†ç¼“å­˜ç›´æ¥å­˜å‚¨åœ¨æ³¨å†Œè¡¨ä¸­ï¼Œä»è€Œæ¶ˆé™¤äº†å¯¹å®Œæ•´æŒä¹…æ€§å­˜å‚¨çš„éœ€æ±‚ã€‚ ã€‚ </p><br><p> è¦æ„å»ºæ˜ åƒï¼Œåªéœ€ä½¿ç”¨<strong>kaniko executor</strong>å¯åŠ¨å®¹å™¨å¹¶å°†å½“å‰çš„æ„å»ºä¸Šä¸‹æ–‡ä¼ é€’ç»™å®ƒï¼Œæ‚¨å¯ä»¥é€šè¿‡<strong>docker</strong>åœ¨æœ¬åœ°æ‰§è¡Œæ­¤æ“ä½œï¼š </p><br><pre> <code class="bash hljs">docker run -ti --rm \ -v <span class="hljs-variable"><span class="hljs-variable">$PWD</span></span>:/workspace \ -v ~/.docker/config.json:/kaniko/.docker/config.json:ro \ gcr.io/kaniko-project/executor:v0.15.0 \ --cache \ --dockerfile=dockerfiles/website/Dockerfile \ --destination=registry.gitlab.com/kvaps/docs.example.org/website:v0.0.1</code> </pre> <br><p> å…¶ä¸­<strong>registry.gitlab.com/kvaps/docs.example.org/website</strong>æ˜¯æ‚¨çš„æ³Šåçª—æ˜ åƒçš„åç§°ï¼Œåœ¨ç»„è£…åå®ƒå°†è¢«è‡ªåŠ¨æ¨é€åˆ°æ³Šåçª—å¯„å­˜å™¨ä¸­ã€‚ </p><br><p>  <strong>--cache</strong>å‚æ•°å…è®¸æ‚¨åœ¨<strong>docker</strong>æ³¨å†Œè¡¨ä¸­ç¼“å­˜å›¾å±‚ï¼Œå¯¹äºç»™å®šçš„ç¤ºä¾‹ï¼Œå®ƒä»¬å°†ä¿å­˜åœ¨<strong>Registry.gitlab.com/kvaps/docs.example.org/website/cacheä¸­</strong> ï¼Œä½†æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨<strong>--cache-</strong>å‚æ•°æŒ‡å®šå…¶ä»–è·¯å¾„<strong>å›è´­</strong> </p><br><div class="spoiler">  <b class="spoiler_title">å±å¹•æˆªå›¾docker-registry</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/0-/31/qx/0-31qxfta2gk7-colutf2l_qtmm.png"></p></div></div><br><hr><br><h1 id="4-znakomstvo-s-qbecanchorqbecanchor">  4.è®¤è¯†qbec <a name="qbec"></a></h1><br><p>  <a href="https://qbec.io/" rel="nofollow">Qbec</a>æ˜¯ä¸€ä¸ªéƒ¨ç½²å·¥å…·ï¼Œå¯è®©æ‚¨å£°æ˜æ€§åœ°æè¿°åº”ç”¨ç¨‹åºçš„æ¸…å•å¹¶å°†å…¶éƒ¨ç½²åˆ°Kubernetesã€‚ ä½¿ç”¨Jsonnetä½œä¸ºä¸»è¦è¯­æ³•ï¼Œå¯ä»¥å¤§å¤§ç®€åŒ–å‡ ç§ç¯å¢ƒä¸‹å·®å¼‚çš„æè¿°ï¼Œå¹¶ä¸”å‡ ä¹å®Œå…¨æ¶ˆé™¤äº†ä»£ç çš„å¯é‡å¤æ€§ã€‚ </p><br><p> åœ¨éœ€è¦å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°å…·æœ‰ä¸åŒå‚æ•°çš„å¤šä¸ªé›†ç¾¤ä¸­å¹¶ä¸”æƒ³è¦åœ¨Gitä¸­å£°æ˜æ€§åœ°æè¿°å®ƒä»¬çš„æƒ…å†µä¸‹ï¼Œå°¤å…¶å¦‚æ­¤ã€‚ </p><br><p>  Qbecè¿˜å…è®¸æ‚¨é€šè¿‡ä¼ é€’å¿…è¦çš„å‚æ•°å¹¶éšåå¯¹å…¶è¿›è¡Œæ“ä½œä»¥åŠæ­£å¸¸çš„å£°æ˜ï¼ˆåŒ…æ‹¬å¯ä»¥å åŠ åœ¨å…¶ä¸Šçš„å„ç§çªå˜ï¼‰æ¥æ¸²æŸ“Helmå›¾è¡¨ï¼Œä»è€Œæ¶ˆé™¤äº†ä½¿ç”¨ChartMuseumçš„éœ€è¦ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‚¨å¯ä»¥ç›´æ¥ä»gitæ‰€åœ¨çš„ä½ç½®å­˜å‚¨å’Œæ¸²æŸ“å›¾è¡¨ã€‚ </p><br><p> å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰éƒ¨ç½²å­˜å‚¨åœ¨<strong>deploy /</strong>ç›®å½•ä¸­ï¼š </p><br><pre> <code class="bash hljs">mkdir deploy <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> deploy</code> </pre> <br><p> è®©æˆ‘ä»¬åˆå§‹åŒ–ç¬¬ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼š </p><br><pre> <code class="bash hljs">qbec init website <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> website</code> </pre> <br><p> ç°åœ¨ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="plaintext hljs">. â”œâ”€â”€ components â”œâ”€â”€ environments â”‚  â”œâ”€â”€ base.libsonnet â”‚  â””â”€â”€ default.libsonnet â”œâ”€â”€ params.libsonnet â””â”€â”€ qbec.yaml</code> </pre> <br><p> æŸ¥çœ‹<strong>qbec.yaml</strong>æ–‡ä»¶ï¼š </p><br><pre> <code class="plaintext hljs">apiVersion: qbec.io/v1alpha1 kind: App metadata: name: website spec: environments: default: defaultNamespace: docs server: https://kubernetes.example.org:8443 vars: {}</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸»è¦å¯¹<strong>spec.environments</strong>æ„Ÿå…´è¶£ï¼Œqbecå·²ç»ä¸ºæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤ç¯å¢ƒï¼Œå¹¶è·å–äº†æœåŠ¡å™¨åœ°å€ä»¥åŠå½“å‰kubeconfigä¸­çš„åç§°ç©ºé—´ã€‚ <br> ç°åœ¨ï¼Œå½“éƒ¨ç½²åˆ°<strong>é»˜è®¤</strong>ç¯å¢ƒæ—¶ï¼Œqbecå°†å§‹ç»ˆåªéƒ¨ç½²åˆ°æŒ‡å®šçš„Kubernetesé›†ç¾¤å’ŒæŒ‡å®šçš„åç§°ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‚¨å°†ä¸å†éœ€è¦åœ¨ä¸Šä¸‹æ–‡å’Œåç§°ç©ºé—´ä¹‹é—´åˆ‡æ¢æ¥æ‰§è¡Œéƒ¨ç½²ã€‚ <br> å¦‚æœ‰å¿…è¦ï¼Œæ‚¨å§‹ç»ˆå¯ä»¥æ›´æ–°æ­¤æ–‡ä»¶ä¸­çš„è®¾ç½®ã€‚ </p><br><p> æ‚¨çš„æ‰€æœ‰ç¯å¢ƒéƒ½åœ¨<strong>qbec.yaml</strong>å’Œ<strong>params.libsonnet</strong>æ–‡ä»¶ä¸­è¿›è¡Œäº†<strong>æè¿°</strong> ï¼Œå…¶ä¸­æŒ‡å‡ºäº†éœ€è¦åœ¨å…¶ä¸­è·å–å‚æ•°çš„ä½ç½®ã€‚ </p><br><p> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸¤ä¸ªç›®å½•ï¼š </p><br><ul><li>  <strong>ç»„ä»¶/</strong> -æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„æ‰€æœ‰æ¸…å•éƒ½å°†å­˜å‚¨åœ¨æ­¤å¤„ï¼Œå®ƒä»¬å¯ä»¥åœ¨jsonnetå’Œæ™®é€šyamlæ–‡ä»¶ä¸­è¿›è¡Œæè¿° </li><li>  <strong>ç¯å¢ƒ/</strong> -åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†æè¿°<strong>ç¯å¢ƒçš„</strong>æ‰€æœ‰å˜é‡ï¼ˆå‚æ•°ï¼‰ã€‚ </li></ul><br><p> é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼š </p><br><ul><li>  <strong>ç¯å¢ƒ/ base.libsonnet-</strong>å°†åŒ…å«æ‰€æœ‰ç¯å¢ƒçš„å¸¸è§„å‚æ•° </li><li>  <strong>ç¯å¢ƒ/ default.libsonnet-</strong>åŒ…å«<strong>é»˜è®¤</strong>ç¯å¢ƒä¸­è¦†ç›–çš„å‚æ•° </li></ul><br><p> è®©æˆ‘ä»¬æ‰“å¼€<strong>ç¯å¢ƒ/ base.libsonnet</strong>å¹¶åœ¨<strong>æ­¤å¤„</strong>æ·»åŠ ç¬¬ä¸€ä¸ªç»„ä»¶çš„å‚æ•°ï¼š </p><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { <span class="hljs-attr"><span class="hljs-attr">website</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'example-docs'</span></span>, <span class="hljs-attr"><span class="hljs-attr">image</span></span>: <span class="hljs-string"><span class="hljs-string">'registry.gitlab.com/kvaps/docs.example.org/website:v0.0.1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">replicas</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">containerPort</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">servicePort</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">nodeSelector</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">tolerations</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">ingressClass</span></span>: <span class="hljs-string"><span class="hljs-string">'nginx'</span></span>, <span class="hljs-attr"><span class="hljs-attr">domain</span></span>: <span class="hljs-string"><span class="hljs-string">'docs.example.org'</span></span>, }, }, }</code> </pre> <br><p> æˆ‘ä»¬è¿˜å°†åˆ›å»ºæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç»„ä»¶<strong>component / website.jsonnet</strong> ï¼š </p><br><pre> <code class="javascript hljs">local env = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/env'</span></span>), <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/defaultNs'</span></span>), }; local p = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../params.libsonnet'</span></span>; local params = p.components.website; [ { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'apps/v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Deployment'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">spec</span></span>: { <span class="hljs-attr"><span class="hljs-attr">replicas</span></span>: params.replicas, <span class="hljs-attr"><span class="hljs-attr">selector</span></span>: { <span class="hljs-attr"><span class="hljs-attr">matchLabels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, }, <span class="hljs-attr"><span class="hljs-attr">template</span></span>: { <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name }, }, <span class="hljs-attr"><span class="hljs-attr">spec</span></span>: { <span class="hljs-attr"><span class="hljs-attr">containers</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'darkhttpd'</span></span>, <span class="hljs-attr"><span class="hljs-attr">image</span></span>: params.image, <span class="hljs-attr"><span class="hljs-attr">ports</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">containerPort</span></span>: params.containerPort, }, ], }, ], <span class="hljs-attr"><span class="hljs-attr">nodeSelector</span></span>: params.nodeSelector, <span class="hljs-attr"><span class="hljs-attr">tolerations</span></span>: params.tolerations, <span class="hljs-attr"><span class="hljs-attr">imagePullSecrets</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'regsecret'</span></span> }], }, }, }, }, { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Service'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">spec</span></span>: { <span class="hljs-attr"><span class="hljs-attr">selector</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">ports</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">port</span></span>: params.servicePort, <span class="hljs-attr"><span class="hljs-attr">targetPort</span></span>: params.containerPort, }, ], }, }, { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'extensions/v1beta1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Ingress'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">annotations</span></span>: { <span class="hljs-string"><span class="hljs-string">'kubernetes.io/ingress.class'</span></span>: params.ingressClass, }, <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">spec</span></span>: { <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">host</span></span>: params.domain, <span class="hljs-attr"><span class="hljs-attr">http</span></span>: { <span class="hljs-attr"><span class="hljs-attr">paths</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">backend</span></span>: { <span class="hljs-attr"><span class="hljs-attr">serviceName</span></span>: params.name, <span class="hljs-attr"><span class="hljs-attr">servicePort</span></span>: params.servicePort, }, }, ], }, }, ], }, }, ]</code> </pre> <br><p> åœ¨æ­¤æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ç«‹å³æè¿°äº†ä¸‰ä¸ªKuberneteså®ä½“ï¼Œå®ƒä»¬æ˜¯ï¼š <strong>Deployment</strong> ï¼Œ <strong>Service</strong>å’Œ<strong>Ingress</strong> ã€‚ å¦‚æœéœ€è¦ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬åŒ…å«åœ¨ä¸åŒçš„ç»„ä»¶ä¸­ï¼Œä½†æ˜¯åœ¨æ­¤é˜¶æ®µï¼Œä¸€ä¸ªå°±è¶³å¤Ÿäº†ã€‚ </p><br><p>  <strong>jsonnet</strong>è¯­æ³•ä¸å¸¸è§„jsonéå¸¸ç›¸ä¼¼ï¼ŒåŸåˆ™ä¸Šå¸¸è§„jsonå·²ç»æ˜¯æœ‰æ•ˆçš„jsonnetï¼Œå› æ­¤é¦–å…ˆä½¿ç”¨<strong>yaml2jsonä¹‹</strong>ç±»çš„åœ¨çº¿æœåŠ¡å°†æ‚¨é€šå¸¸çš„yamlè½¬æ¢ä¸ºjsonå¯èƒ½ä¼šæ›´å®¹æ˜“ï¼Œæˆ–è€…å¦‚æœæ‚¨çš„ç»„ä»¶ä¸åŒ…å«ä»»ä½•å˜é‡ï¼Œé‚£ä¹ˆå®ƒä»¬å¯ä»¥ä»¥æ™®é€šYamlçš„å½¢å¼æè¿°ã€‚ </p><br><blockquote> ä½¿ç”¨<strong>jsonnetæ—¶ï¼Œ</strong>å¼ºçƒˆå»ºè®®æ‚¨ä¸ºç¼–è¾‘å™¨å®‰è£…ä¸€ä¸ªæ’ä»¶ <br><br> ä¾‹å¦‚ï¼Œå¯¹äºvimï¼Œæœ‰ä¸€ä¸ª<strong>vim-jsonnetæ’ä»¶</strong>å¯ä»¥æ‰“å¼€è¯­æ³•çªå‡ºæ˜¾ç¤ºåŠŸèƒ½ï¼Œå¹¶åœ¨æ¯æ¬¡ä¿å­˜æ—¶è‡ªåŠ¨æ‰§è¡Œ<strong>jsonnet fmt</strong> ï¼ˆå®ƒéœ€è¦å®‰è£…jsonnetï¼‰ã€‚ </blockquote><p> ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹éƒ¨ç½²äº†ï¼š </p><br><p> è¦æŸ¥çœ‹å‘ç”Ÿäº†ä»€ä¹ˆï¼Œæˆ‘ä»¬å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š </p><br><pre> <code class="bash hljs">qbec show default</code> </pre> <br><p> åœ¨è¾“å‡ºä¸­ï¼Œæ‚¨å°†çœ‹åˆ°æ¸²æŸ“çš„Yamlæ¸…å•ï¼Œè¿™äº›æ¸…å•å°†åº”ç”¨äºé»˜è®¤é›†ç¾¤ã€‚ </p><br><p> å¥½çš„ï¼Œç°åœ¨ç”³è¯·ï¼š </p><br><pre> <code class="bash hljs">qbec apply default</code> </pre> <br><p> åœ¨å‡ºå£å¤„ï¼Œæ‚¨å°†å§‹ç»ˆçœ‹åˆ°é›†ç¾¤ä¸­å°†æ‰§è¡Œçš„æ“ä½œï¼Œqbecå°†è¦æ±‚æ‚¨æ¥å—æ›´æ”¹ï¼Œé€šè¿‡é”®å…¥<strong>y</strong>å¯ä»¥ç¡®è®¤æ‚¨çš„æ„å›¾ã€‚ </p><br><p> å®Œæˆï¼Œç°åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå·²åœé ï¼ </p><br><p> å¦‚æœè¿›è¡Œæ›´æ”¹ï¼Œåˆ™å§‹ç»ˆå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š </p><br><pre> <code class="bash hljs">qbec diff default</code> </pre> <br><p> äº†è§£è¿™äº›æ›´æ”¹å°†å¦‚ä½•å½±å“å½“å‰éƒ¨ç½² </p><br><p> ä¸è¦å¿˜è®°æäº¤æˆ‘ä»¬çš„æ›´æ”¹ï¼š </p><br><pre> <code class="plaintext hljs">cd ../.. git add deploy/website git commit -m "Add deploy for website"</code> </pre> <br><hr><br><h1 id="5-probuem-gitlab-runner-s-kubernetes-executoranchorgitlab-runneranchor">  5.ä½¿ç”¨Kubernetes-executorå°è¯•Gitlab-runner <a name="gitlab-runner"></a></h1><br><p> ç›´åˆ°æœ€è¿‘ï¼Œæˆ‘ä»…åœ¨å¸¦æœ‰shellæˆ–docker-executorçš„é¢„å…ˆå‡†å¤‡å¥½çš„æœºå™¨ï¼ˆLXCå®¹å™¨ï¼‰ä¸Šä½¿ç”¨æ™®é€šçš„<strong>gitlab-runner</strong> ã€‚ æœ€åˆï¼Œæˆ‘ä»¬åœ¨hitlabä¸­å…¨å±€å®šä¹‰äº†å…¶ä¸­ä¸€äº›è·‘æ­¥è€…ã€‚ ä»–ä»¬æ”¶é›†äº†æ‰€æœ‰é¡¹ç›®çš„dockeræ˜ åƒã€‚ </p><br><p> ä½†æ˜¯ï¼Œæ­£å¦‚å®è·µæ‰€ç¤ºï¼Œä»å®ç”¨æ€§å’Œå®‰å…¨æ€§è§’åº¦æ¥çœ‹ï¼Œæ­¤é€‰é¡¹éƒ½ä¸æ˜¯æœ€ç†æƒ³çš„é€‰æ‹©ã€‚ ä¸ºæ¯ä¸ªé¡¹ç›®ç”šè‡³ä¸ºæ¯ä¸ªç¯å¢ƒéƒ¨ç½²å•ç‹¬çš„è¿è¡Œå™¨ä¼šæ›´å¥½ï¼Œå¹¶ä¸”åœ¨æ€æƒ³ä¸Šæ›´æ­£ç¡®ã€‚ </p><br><p> å¹¸è¿çš„æ˜¯ï¼Œè¿™æ ¹æœ¬ä¸æ˜¯é—®é¢˜ï¼Œå› ä¸ºç°åœ¨æˆ‘ä»¬å°†ç›´æ¥å°†<strong>gitlab-runner</strong>ä½œä¸ºæˆ‘ä»¬é¡¹ç›®çš„ä¸€éƒ¨åˆ†ç›´æ¥éƒ¨ç½²åˆ°Kubernetesã€‚ </p><br><p>  Gitlabæä¾›äº†ä¸€ä¸ªç°æˆçš„èˆµå›¾ï¼Œç”¨äºåœ¨Kubernetesä¸­éƒ¨ç½²gitlab-runnerã€‚ å› æ­¤ï¼Œæ‚¨éœ€è¦åšçš„å°±æ˜¯åœ¨<strong>è®¾ç½®-&gt; CI / CD-&gt; Runnersä¸­</strong>æ‰¾åˆ°æˆ‘ä»¬é¡¹ç›®çš„<strong>æ³¨å†Œä»¤ç‰Œ</strong> ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™å¤´ç›”ï¼š </p><br><pre> <code class="bash hljs">helm repo add gitlab https://charts.gitlab.io helm install gitlab-runner \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> gitlabUrl=https://gitlab.com \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> runnerRegistrationToken=yga8y-jdCusVDn_t4Wxc \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> rbac.create=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ gitlab/gitlab-runner</code> </pre> <br><p> å…¶ä¸­ï¼š </p><br><ul><li>  <strong><a href="https://gitlab.com/" rel="nofollow">https://gitlab.com</a></strong>æ˜¯æ‚¨çš„GitlabæœåŠ¡å™¨çš„åœ°å€ã€‚ </li><li>  <strong>yga8y-jdCusVDn_t4Wxc-</strong>é¡¹ç›®çš„æ³¨å†Œä»¤ç‰Œã€‚ </li><li>  <strong>rbac.create = true-</strong>ä¸ºè·‘æ­¥è€…æä¾›æ‰€éœ€æ•°é‡çš„ç‰¹æƒï¼Œä½¿å…¶èƒ½å¤Ÿä½¿ç”¨kubernetes-executoråˆ›å»ºåŠèˆ±ä»¥æ‰§è¡Œæˆ‘ä»¬çš„ä»»åŠ¡ã€‚ </li></ul><br><p> å¦‚æœä¸€åˆ‡æ­£ç¡®å®Œæˆï¼Œåˆ™åº”è¯¥åœ¨é¡¹ç›®è®¾ç½®çš„â€œè¿è¡Œ<strong>è€…â€</strong>éƒ¨åˆ†ä¸­çœ‹åˆ°å·²æ³¨å†Œçš„è¿è¡Œ<strong>è€…</strong> ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">æ·»åŠ çš„è·‘æ­¥è€…çš„å±å¹•æˆªå›¾</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/at/lx/g_/atlxg_u6rjn4n0pkcpn8--2gare.png"></p></div></div><br><p> è¿™ä¹ˆç®€å•å—ï¼Ÿ  -æ˜¯çš„ï¼Œå¾ˆç®€å•ï¼ æ‰‹åŠ¨æ³¨å†Œè·‘æ­¥è€…ä¸å†éº»çƒ¦ï¼Œä»ç°åœ¨å¼€å§‹ï¼Œè·‘æ­¥è€…å°†è¢«è‡ªåŠ¨åˆ›å»ºå’Œé”€æ¯ã€‚ </p><br><hr><br><h1 id="6-deploy-helm-chartov-s-qbecanchorqbec-helmanchor">  6.ä½¿ç”¨QBECéƒ¨ç½²Helmå›¾è¡¨ <a name="qbec-helm"></a></h1><br><p> ç”±äºæˆ‘ä»¬å†³å®šè€ƒè™‘å°†<strong>gitlab-runner</strong>çº³å…¥é¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤è¯¥åœ¨æˆ‘ä»¬çš„Gitå­˜å‚¨åº“ä¸­å¯¹å…¶è¿›è¡Œæè¿°äº†ã€‚ </p><br><p> æˆ‘ä»¬å¯ä»¥å°†å…¶æè¿°ä¸º<strong>ç½‘ç«™çš„</strong>ä¸€ä¸ªå•ç‹¬ç»„ä»¶ï¼Œä½†æ˜¯å°†æ¥ï¼Œæˆ‘ä»¬è®¡åˆ’éå¸¸é¢‘ç¹åœ°éƒ¨ç½²<strong>ç½‘ç«™çš„</strong>ä¸åŒå‰¯æœ¬ï¼Œè¿™ä¸<strong>gitlab-runner</strong>ä¸åŒï¼Œåè€…å¯¹äºæ¯ä¸ªKubernetesé›†ç¾¤ä»…éƒ¨ç½²ä¸€æ¬¡ã€‚ å› æ­¤ï¼Œè®©æˆ‘ä»¬ä¸ºå…¶åˆå§‹åŒ–ä¸€ä¸ªå•ç‹¬çš„åº”ç”¨ç¨‹åºï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> deploy qbec init gitlab-runner <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> gitlab-runner</code> </pre> <br><p> è¿™æ¬¡æˆ‘ä»¬å°†ä¸å†æ‰‹åŠ¨æè¿°Kuberneteså®ä½“ï¼Œè€Œæ˜¯é‡‡ç”¨ç°æˆçš„Helmå›¾è¡¨ã€‚  qbecçš„ä¼˜ç‚¹ä¹‹ä¸€æ˜¯èƒ½å¤Ÿç›´æ¥ä»Gitå­˜å‚¨åº“ä¸­å‘ˆç°Helmå›¾è¡¨ã€‚ </p><br><p> è®©æˆ‘ä»¬ä½¿ç”¨gitå­æ¨¡å—å°†å…¶æ’å…¥ï¼š </p><br><pre> <code class="bash hljs">git submodule add https://gitlab.com/gitlab-org/charts/gitlab-runner vendor/gitlab-runner</code> </pre> <br><p> ç°åœ¨ï¼Œ <strong>vendor / gitlab-runner</strong>ç›®å½•åŒ…å«æˆ‘ä»¬çš„å­˜å‚¨åº“ä»¥åŠgitlab-runnerçš„å›¾è¡¨ã€‚ </p><br><blockquote> åŒæ ·ï¼Œæ‚¨å¯ä»¥è¿æ¥å…¶ä»–å­˜å‚¨åº“ï¼Œä¾‹å¦‚ï¼Œæ•´ä¸ªå­˜å‚¨åº“ä¸å®˜æ–¹å›¾è¡¨<strong><a href="https://github.com/helm/charts" rel="nofollow">https://github.com/helm/charts</a></strong> </blockquote><p> è®©æˆ‘ä»¬æè¿°<strong>ç»„ä»¶/ gitlab-runner.jsonnetç»„ä»¶</strong> ï¼š </p><br><pre> <code class="javascript hljs">local env = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/env'</span></span>), <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/defaultNs'</span></span>), }; local p = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../params.libsonnet'</span></span>; local params = p.components.gitlabRunner; std.native(<span class="hljs-string"><span class="hljs-string">'expandHelmTemplate'</span></span>)( <span class="hljs-string"><span class="hljs-string">'../vendor/gitlab-runner'</span></span>, params.values, { <span class="hljs-attr"><span class="hljs-attr">nameTemplate</span></span>: params.name, <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: env.namespace, <span class="hljs-attr"><span class="hljs-attr">thisFile</span></span>: std.thisFile, <span class="hljs-attr"><span class="hljs-attr">verbose</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, } )</code> </pre> <br><p>  <strong>expandHelmTemplate</strong>çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¼ é€’è·¯å¾„åˆ°å›¾è¡¨ï¼Œç„¶åæ˜¯<strong>params.values</strong> ï¼Œå®ƒæ˜¯ä»ç¯å¢ƒå‚æ•°ä¸­è·å–çš„ï¼Œç„¶åæ˜¯ä¸€ä¸ªå¸¦æœ‰ </p><br><ul><li>  <strong>nameTemplate-</strong>å‘å¸ƒåç§° </li><li>  <strong>åç§°ç©ºé—´</strong> -ä¼ é€’ç»™èˆµæœºçš„<strong>åç§°</strong>ç©ºé—´ </li><li>  <strong>thisFile-</strong>å°†è·¯å¾„ä¼ é€’åˆ°å½“å‰æ–‡ä»¶çš„å¿…éœ€å‚æ•° </li><li>  <strong>è¯¦ç»†</strong> -å‘ˆç°å›¾è¡¨æ—¶æ˜¾ç¤ºå¸¦æœ‰æ‰€æœ‰å‚æ•°çš„<strong>helmæ¨¡æ¿</strong>å‘½ä»¤ </li></ul><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å°†åœ¨<strong>ç¯å¢ƒ/ base.libsonnetä¸­</strong>æè¿°ç»„ä»¶çš„å‚æ•°ï¼š </p><br><pre> <code class="javascript hljs">local secrets = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../secrets/base.libsonnet'</span></span>; { <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { <span class="hljs-attr"><span class="hljs-attr">gitlabRunner</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'gitlab-runner'</span></span>, <span class="hljs-attr"><span class="hljs-attr">values</span></span>: { <span class="hljs-attr"><span class="hljs-attr">gitlabUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'https://gitlab.com/'</span></span>, <span class="hljs-attr"><span class="hljs-attr">rbac</span></span>: { <span class="hljs-attr"><span class="hljs-attr">create</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">runnerRegistrationToken</span></span>: secrets.runnerRegistrationToken, }, }, }, }</code> </pre> <br><p> æ³¨æ„æˆ‘ä»¬ä»å¤–éƒ¨<strong>secrets / base.libsonnetæ–‡ä»¶ä¸­è·å–çš„RunnerRegistrationToken</strong> ï¼Œè®©æˆ‘ä»¬åˆ›å»ºå®ƒï¼š </p><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">runnerRegistrationToken</span></span>: <span class="hljs-string"><span class="hljs-string">'yga8y-jdCusVDn_t4Wxc'</span></span>, }</code> </pre> <br><p> æ£€æŸ¥ä¸€åˆ‡æ˜¯å¦æ­£å¸¸ï¼š </p><br><pre> <code class="bash hljs">qbec show default</code> </pre> <br><p> å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡Helmç‰ˆæœ¬åˆ é™¤è¾ƒæ—©çš„ç‰ˆæœ¬ï¼š </p><br><pre> <code class="bash hljs">helm uninstall gitlab-runner</code> </pre> <br><p> å¹¶éƒ¨ç½²å®ƒï¼Œä½†æ˜¯å·²ç»é€šè¿‡qbecè¿›è¡Œäº†éƒ¨ç½²ï¼š </p><br><pre> <code class="bash hljs">qbec apply default</code> </pre> <br><hr><br><h1 id="7-znakomstvo-s-git-cryptanchorgit-cryptanchor">  7.å¼•å…¥git-crypt <a name="git-crypt"></a></h1><br><p>  <strong><a href="https://github.com/AGWA/git-crypt" rel="nofollow">Git-crypt</a></strong>æ˜¯ä¸€ç§å·¥å…·ï¼Œå¯è®©æ‚¨ä¸ºå­˜å‚¨åº“è®¾ç½®é€æ˜åŠ å¯†ã€‚ </p><br><p> ç›®å‰ï¼Œæˆ‘ä»¬gitlab-runnerçš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š </p><br><pre> <code class="plaintext hljs">. â”œâ”€â”€ components â”‚  â”œâ”€â”€ gitlab-runner.jsonnet â”œâ”€â”€ environments â”‚  â”œâ”€â”€ base.libsonnet â”‚  â””â”€â”€ default.libsonnet â”œâ”€â”€ params.libsonnet â”œâ”€â”€ qbec.yaml â”œâ”€â”€ secrets â”‚  â””â”€â”€ base.libsonnet â””â”€â”€ vendor â””â”€â”€ gitlab-runner (submodule)</code> </pre> <br><p> ä½†æ˜¯åœ¨Gitä¸­ä¿å¯†å¹¶ä¸å®‰å…¨ï¼Œå¯¹å—ï¼Ÿ å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œé€‚å½“çš„åŠ å¯†ã€‚ </p><br><blockquote> é€šå¸¸ï¼Œä¸ºäº†å•ä¸ªå˜é‡ï¼Œè¿™å¹¶ä¸æ€»æ˜¯æœ‰æ„ä¹‰ã€‚ æ‚¨å¯ä»¥å°†æœºå¯†ä¼ é€’ç»™<strong>qbec</strong>å¹¶é€šè¿‡CIç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ã€‚ <br> ä½†æ˜¯ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿˜æœ‰æ›´å¤æ‚çš„é¡¹ç›®å¯ä»¥åŒ…å«æ›´å¤šçš„ç§˜å¯†ï¼›é€šè¿‡ç¯å¢ƒå˜é‡å°†å®ƒä»¬å…¨éƒ¨è½¬ç§»å°†æä¸ºå›°éš¾ã€‚ <br><br> å¦å¤–ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘å°†æ— æ³•å‘Šè¯‰æ‚¨æœ‰å…³<strong>git-cryptä¹‹</strong>ç±»çš„å‡ºè‰²å·¥å…·çš„ä¿¡æ¯ã€‚ <br><br>  <strong>git-crypt</strong>ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œå› ä¸ºå®ƒå…è®¸æ‚¨ä¿å­˜æ‰€æœ‰ç§˜å¯†å†å²è®°å½•ï¼Œä»¥åŠä»¥ä¸ä»¥å‰åœ¨Gitæƒ…å†µä¸‹ç›¸åŒçš„æ–¹å¼æ¯”è¾ƒï¼Œåˆå¹¶å’Œè§£å†³å†²çªã€‚ </blockquote><p> é¦–å…ˆï¼Œåœ¨å®‰è£…<strong>git-cryptä¹‹åï¼Œ</strong>æˆ‘ä»¬éœ€è¦ä¸ºå­˜å‚¨åº“ç”Ÿæˆå¯†é’¥ï¼š </p><br><pre> <code class="plaintext hljs">git crypt init</code> </pre> <br><p> å¦‚æœæ‚¨å…·æœ‰PGPå¯†é’¥ï¼Œåˆ™å¯ä»¥ç«‹å³å°†è‡ªå·±æ·»åŠ ä¸ºè¯¥é¡¹ç›®çš„åä½œè€…ï¼š </p><br><pre> <code class="plaintext hljs">git-crypt add-gpg-user kvapss@gmail.com</code> </pre> <br><p> å› æ­¤ï¼Œæ‚¨å§‹ç»ˆå¯ä»¥ä½¿ç”¨ç§é’¥è§£å¯†è¯¥å­˜å‚¨åº“ã€‚ </p><br><p> å¦‚æœæ‚¨æ²¡æœ‰PGPå¯†é’¥å¹¶ä¸”ä¸æœŸæœ›ä½¿ç”¨ï¼Œåˆ™å¯ä»¥é‡‡ç”¨å¦ä¸€ç§æ–¹æ³•å¯¼å‡ºé¡¹ç›®å¯†é’¥ï¼š </p><br><pre> <code class="plaintext hljs">git crypt export-key /path/to/keyfile</code> </pre> <br><p> è¿™æ ·ï¼Œæ‹¥æœ‰å¯¼å‡º<strong>å¯†é’¥æ–‡ä»¶çš„</strong>ä»»ä½•äººéƒ½å¯ä»¥è§£å¯†æ‚¨çš„å­˜å‚¨åº“ã€‚ </p><br><p> ç°åœ¨æ˜¯è®¾ç½®æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç§˜å¯†çš„æ—¶å€™äº†ã€‚ <br> è®©æˆ‘æé†’æ‚¨ï¼Œæˆ‘ä»¬ä»ç„¶ä½äº<strong>deploy / gitlab-runner /</strong>ç›®å½•ä¸­ï¼Œåœ¨è¯¥ç›®å½•ä¸­æœ‰<strong>secrets /</strong>ç›®å½•ï¼Œè®©æˆ‘ä»¬åŠ å¯†å…¶ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬åˆ›å»ºå…·æœ‰ä»¥ä¸‹å†…å®¹çš„<strong>secrets / .gitattributesæ–‡ä»¶</strong> ï¼š </p><br><pre> <code class="plaintext hljs">* filter=git-crypt diff=git-crypt .gitattributes !filter !diff</code> </pre> <br><p> æ­£å¦‚æ‚¨ä»å†…å®¹ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼Œé™¤<strong>.gitattributes</strong>æœ¬èº«ä¹‹å¤–ï¼Œæ‰€æœ‰å¸¦æ©ç <strong>*çš„</strong>æ–‡ä»¶éƒ½å°†é€šè¿‡<strong>git-crypt</strong>è¿è¡Œ </p><br><p> æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡ŒéªŒè¯ï¼š </p><br><pre> <code class="bash hljs">git crypt status -e</code> </pre> <br><p> åœ¨è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬è·å¾—å­˜å‚¨åº“ä¸­å·²å¯ç”¨åŠ å¯†çš„æ‰€æœ‰æ–‡ä»¶çš„åˆ—è¡¨ </p><br><p> å°±æ˜¯è¿™æ ·ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°è¿›è¡Œæ›´æ”¹äº†ï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../.. git add . git commit -m <span class="hljs-string"><span class="hljs-string">"Add deploy for gitlab-runner"</span></span></code> </pre> <br><p> ä¸ºäº†é˜»æ­¢å­˜å‚¨åº“ï¼Œåªéœ€æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š </p><br><pre> <code class="bash hljs">git crypt lock</code> </pre> <br><p> ç„¶åæ‰€æœ‰åŠ å¯†çš„æ–‡ä»¶éƒ½å˜æˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°†æ— æ³•è¯»å–å®ƒä»¬ã€‚ <br> è¦è§£å¯†å­˜å‚¨åº“ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š </p><br><pre> <code class="bash hljs">git crypt unlock</code> </pre> <br><hr><br><h1 id="8-sozdayom-toolbox-obrazanchortoolboxanchor">  8.åˆ›å»ºå·¥å…·ç®±å›¾åƒ <a name="toolbox"></a></h1><br><p> å·¥å…·ç®±æ˜ åƒå°±æ˜¯åŒ…å«ç”¨äºéƒ¨ç½²é¡¹ç›®çš„æ‰€æœ‰å·¥å…·çš„æ˜ åƒã€‚  gitlabè¿è¡Œç¨‹åºå°†ä½¿ç”¨å®ƒæ¥æ‰§è¡Œå…¸å‹çš„éƒ¨ç½²ä»»åŠ¡ã€‚ </p><br><p> è¿™é‡Œçš„ä¸€åˆ‡éƒ½å¾ˆç®€å•ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå…·æœ‰ä»¥ä¸‹å†…å®¹çš„æ–°<strong>dockerfiles / toolbox / Dockerfile</strong> ï¼š </p><br><pre> <code class="bash hljs">FROM alpine:3.11 RUN apk add --no-cache git git-crypt RUN QBEC_VER=0.10.3 \ &amp;&amp; wget -O- https://github.com/splunk/qbec/releases/download/v<span class="hljs-variable"><span class="hljs-variable">${QBEC_VER}</span></span>/qbec-linux-amd64.tar.gz \ | tar -C /tmp -xzf - \ &amp;&amp; mv /tmp/qbec /tmp/jsonnet-qbec /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/ RUN KUBECTL_VER=1.17.0 \ &amp;&amp; wget -O /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/kubectl \ https://storage.googleapis.com/kubernetes-release/release/v<span class="hljs-variable"><span class="hljs-variable">${KUBECTL_VER}</span></span>/bin/linux/amd64/kubectl \ &amp;&amp; chmod +x /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/kubectl RUN HELM_VER=3.0.2 \ &amp;&amp; wget -O- https://get.helm.sh/helm-v<span class="hljs-variable"><span class="hljs-variable">${HELM_VER}</span></span>-linux-amd64.tar.gz \ | tar -C /tmp -zxf - \ &amp;&amp; mv /tmp/linux-amd64/helm /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/helm</code> </pre> <br><p> å¦‚æ‚¨æ‰€è§ï¼Œåœ¨æ­¤å›¾ä¸­ï¼Œæˆ‘ä»¬å®‰è£…äº†ç”¨äºéƒ¨ç½²åº”ç”¨ç¨‹åºçš„æ‰€æœ‰å®ç”¨ç¨‹åºã€‚ æˆ‘ä»¬<strong>åœ¨è¿™é‡Œ</strong>ä¸éœ€è¦<strong>kubectl</strong> ï¼Œä½†æ˜¯æ‚¨å¯èƒ½æƒ³åœ¨ç®¡é“è®¾ç½®é˜¶æ®µä½¿ç”¨å®ƒã€‚ </p><br><p> å¦å¤–ï¼Œä¸ºäº†èƒ½å¤Ÿä¸Kubernetesé€šä¿¡å¹¶åœ¨å…¶ä¸­è¿›è¡Œéƒ¨ç½²ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºgitlab-runnerç”Ÿæˆçš„podé…ç½®è§’è‰²ã€‚ </p><br><p> ä¸ºæ­¤ï¼Œè¯·ä½¿ç”¨gitlab-runnerè½¬åˆ°ç›®å½•ï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> deploy/gitlab-runner</code> </pre> <br><p> å¹¶æ·»åŠ ä¸€ä¸ªæ–°çš„ç»„ä»¶<strong>components / rbac.jsonnet</strong> ï¼š </p><br><pre> <code class="javascript hljs">local env = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/env'</span></span>), <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/defaultNs'</span></span>), }; local p = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../params.libsonnet'</span></span>; local params = p.components.rbac; [ { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'ServiceAccount'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, }, { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'rbac.authorization.k8s.io/v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Role'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">apiGroups</span></span>: [ <span class="hljs-string"><span class="hljs-string">'*'</span></span>, ], <span class="hljs-attr"><span class="hljs-attr">resources</span></span>: [ <span class="hljs-string"><span class="hljs-string">'*'</span></span>, ], <span class="hljs-attr"><span class="hljs-attr">verbs</span></span>: [ <span class="hljs-string"><span class="hljs-string">'*'</span></span>, ], }, ], }, { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'rbac.authorization.k8s.io/v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'RoleBinding'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">roleRef</span></span>: { <span class="hljs-attr"><span class="hljs-attr">apiGroup</span></span>: <span class="hljs-string"><span class="hljs-string">'rbac.authorization.k8s.io'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Role'</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">subjects</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'ServiceAccount'</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: env.namespace, }, ], }, ]</code> </pre> <br><p> æˆ‘ä»¬è¿˜å°†åœ¨<strong>ç¯å¢ƒ/ base.libsonnetä¸­</strong>æè¿°æ–°å‚æ•°ï¼Œç°åœ¨çœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><pre> <code class="javascript hljs">local secrets = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../secrets/base.libsonnet'</span></span>; { <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { <span class="hljs-attr"><span class="hljs-attr">gitlabRunner</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'gitlab-runner'</span></span>, <span class="hljs-attr"><span class="hljs-attr">values</span></span>: { <span class="hljs-attr"><span class="hljs-attr">gitlabUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'https://gitlab.com/'</span></span>, <span class="hljs-attr"><span class="hljs-attr">rbac</span></span>: { <span class="hljs-attr"><span class="hljs-attr">create</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">runnerRegistrationToken</span></span>: secrets.runnerRegistrationToken, <span class="hljs-attr"><span class="hljs-attr">runners</span></span>: { <span class="hljs-attr"><span class="hljs-attr">serviceAccountName</span></span>: $.components.rbac.name, <span class="hljs-attr"><span class="hljs-attr">image</span></span>: <span class="hljs-string"><span class="hljs-string">'registry.gitlab.com/kvaps/docs.example.org/toolbox:v0.0.1'</span></span>, }, }, }, <span class="hljs-attr"><span class="hljs-attr">rbac</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'gitlab-runner-deploy'</span></span>, }, }, }</code> </pre> <br><p> æ³¨æ„<strong>$ .components.rbac.name</strong>æ˜¯æŒ‡<strong>rbac</strong>ç»„ä»¶çš„<strong>åç§°</strong> </p><br><p> è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹å‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–ï¼š </p><br><pre> <code class="bash hljs">qbec diff default</code> </pre> <br><p> å¹¶å°†æˆ‘ä»¬çš„æ›´æ”¹åº”ç”¨äºKubernetesï¼š </p><br><pre> <code class="bash hljs">qbec apply default</code> </pre> <br><p> å¦å¤–ï¼Œä¸è¦å¿˜è®°å°†æ›´æ”¹æäº¤åˆ°gitï¼š </p><br><pre> <code class="plaintext hljs">cd ../.. git add dockerfiles/toolbox git commit -m "Add Dockerfile for toolbox" git add deploy/gitlab-runner git commit -m "Configure gitlab-runner to use toolbox"</code> </pre> <br><hr><br><h1 id="9-nash-pervyy-payplayn-i-sborka-obrazov-po-tegamanchorpipeline-buildanchor">  9.æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæµæ°´çº¿å’ŒæŒ‰æ ‡ç­¾ç»„è£…å›¾åƒ <a name="pipeline-build"></a></h1><br><p> åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºå…·æœ‰ä»¥ä¸‹å†…å®¹çš„<strong>.gitlab-ci.yml</strong> ï¼š </p><br><pre> <code class="plaintext hljs">.build_docker_image: stage: build image: name: gcr.io/kaniko-project/executor:debug-v0.15.0 entrypoint: [""] before_script: - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" &gt; /kaniko/.docker/config.json build_toolbox: extends: .build_docker_image script: - /kaniko/executor --cache --context $CI_PROJECT_DIR/dockerfiles/toolbox --dockerfile $CI_PROJECT_DIR/dockerfiles/toolbox/Dockerfile --destination $CI_REGISTRY_IMAGE/toolbox:$CI_COMMIT_TAG only: refs: - tags build_website: extends: .build_docker_image variables: GIT_SUBMODULE_STRATEGY: normal script: - /kaniko/executor --cache --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/dockerfiles/website/Dockerfile --destination $CI_REGISTRY_IMAGE/website:$CI_COMMIT_TAG only: refs: - tags</code> </pre> <br><p> è¯·æ³¨æ„ï¼Œå¯¹äºé‚£äº›éœ€è¦åœ¨æ‰§è¡Œä¹‹å‰æ˜¾å¼åˆå§‹åŒ–å­æ¨¡å—çš„ä½œä¸šï¼Œæˆ‘ä»¬ä½¿ç”¨<strong>GIT_SUBMODULE_STRATEGYï¼šnormal</strong> ã€‚ </p><br><p> ä¸è¦å¿˜è®°æäº¤æˆ‘ä»¬çš„æ›´æ”¹ï¼š </p><br><pre> <code class="plaintext hljs">git add .gitlab-ci.yml git commit -m "Automate docker build"</code> </pre> <br><p> æˆ‘è®¤ä¸ºæ‚¨å¯ä»¥æ”¾å¿ƒåœ°å°†å…¶<strong>å‘½åä¸ºv0.0.1</strong>ç‰ˆæœ¬å¹¶æŒ‚ä¸€ä¸ªæ ‡ç­¾ï¼š </p><br><pre> <code class="bash hljs">git tag v0.0.1</code> </pre> <br><p> æ¯å½“éœ€è¦å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šæŒ‚èµ·æ ‡ç­¾ã€‚  Dockeræ˜ åƒä¸­çš„æ ‡ç­¾å°†ç»‘å®šåˆ°Gitæ ‡ç­¾ã€‚ å¸¦æœ‰æ–°æ ‡ç­¾çš„æ¯æ¬¡æ¨é€éƒ½ä¼šåˆå§‹åŒ–å¸¦æœ‰è¯¥æ ‡ç­¾çš„å›¾åƒé›†åˆã€‚ </p><br><p> è¿è¡Œ<strong>git push --tags</strong> ï¼Œç„¶åçœ‹ä¸€ä¸‹æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç®¡é“ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ç¬¬ä¸€æ¡ç®¡é“çš„å±å¹•æˆªå›¾</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/5u/ce/fg/5ucefgejcfjz7jpwvou206mwufy.png"></p></div></div><br><blockquote> å€¼å¾—å…³æ³¨çš„äº‹å®æ˜¯ï¼ŒæŒ‰æ ‡ç­¾ç»„è£…é€‚ç”¨äºç»„è£…Dockeræ˜ åƒï¼Œä½†ä¸é€‚ç”¨äºåœ¨Kubernetesä¸­éƒ¨ç½²åº”ç”¨ç¨‹åºã€‚ ç”±äºæ–°æ ‡ç­¾ä¹Ÿå¯ä»¥åˆ†é…ç»™æ—§æäº¤ï¼Œå› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹å®ƒä»¬çš„ç®¡é“åˆå§‹åŒ–å°†å¯¼è‡´æ—§ç‰ˆæœ¬çš„éƒ¨ç½²ã€‚ <br><br> ä¸ºäº†è§£å†³æ­¤é—®é¢˜ï¼Œé€šå¸¸å°†docker-imagesçš„ç¨‹åºé›†é™„åŠ åˆ°æ ‡ç­¾ï¼Œç„¶åå°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°<strong>master</strong>åˆ†æ”¯ï¼Œåœ¨è¯¥åˆ†æ”¯ä¸­ï¼Œæ‰€æ”¶é›†æ˜ åƒçš„ç‰ˆæœ¬å°†è¿›è¡Œç¡¬ç¼–ç ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç®€å•çš„è¿˜åŸ<strong>ä¸»</strong>æ ‡ç­¾æ¥åˆå§‹åŒ–å›æ»šã€‚ </blockquote><br><hr><br><h1 id="10-avtomatizaciya-deployaanchorpipeline-deployanchor">  10.éƒ¨ç½²è‡ªåŠ¨åŒ– <a name="pipeline-deploy"></a></h1><br><p> ä¸ºäº†è®©Gitlab-runnerè§£å¯†æˆ‘ä»¬çš„æœºå¯†ï¼Œæˆ‘ä»¬éœ€è¦å¯¼å‡ºå­˜å‚¨åº“å¯†é’¥ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°CIçš„ç¯å¢ƒå˜é‡ä¸­ï¼š </p><br><pre> <code class="plaintext hljs">git crypt export-key /tmp/docs-repo.key base64 -w0 /tmp/docs-repo.key; echo</code> </pre> <br><p> å°†ç»“æœå­—ç¬¦ä¸²ä¿å­˜åœ¨Gitlabä¸­ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†è½¬åˆ°é¡¹ç›®çš„è®¾ç½®ï¼š <br>  <strong>è®¾ç½®-&gt; CI / CD-&gt;å˜é‡</strong> </p><br><p>    : </p><br><div class="scrollable-table"><table><thead><tr><th> Type </th><th> Key </th><th> Value </th><th> Protected </th><th> Masked </th><th> Scope </th></tr></thead><tbody><tr><td> <code>File</code> </td> <td> <code>GITCRYPT_KEY</code> </td> <td> <code>&lt;your string&gt;</code> </td> <td> <code>true</code> <em>(     <code>false</code> )</em> </td><td> <code>true</code> </td> <td> <code>All environments</code> </td> </tr></tbody></table></div><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/vj/li/ea/vjliealfwwsmiy4-nvjfvcf89ig.png"></p></div></div><br><p>    <strong>.gitlab-ci.yml</strong>   : </p><br><pre> <code class="plaintext hljs">.deploy_qbec_app: stage: deploy only: refs: - master deploy_gitlab_runner: extends: .deploy_qbec_app variables: GIT_SUBMODULE_STRATEGY: normal before_script: - base64 -d "$GITCRYPT_KEY" | git-crypt unlock - script: - qbec apply default --root deploy/gitlab-runner --force:k8s-context __incluster__ --wait --yes deploy_website: extends: .deploy_qbec_app script: - qbec apply default --root deploy/website --force:k8s-context __incluster__ --wait --yes</code> </pre> <br><p>        qbec: </p><br><ul><li> <strong>--root some/app</strong> â€”      </li><li> <strong>--force:k8s-context __incluster__</strong> â€”   ,             gtilab-runner.   ,      qbec     Kubernetes-   kubeconfig </li><li> <strong>--wait</strong> â€”  qbec ,        Ready       exit-code. </li><li> <strong>--yes</strong> â€”     <strong>Are you sure?</strong>  . </li></ul><br><p>     : </p><br><pre> <code class="plaintext hljs">git add .gitlab-ci.yml git commit -m "Automate deploy"</code> </pre> <br><p>   <strong>git push</strong>       : </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/0p/aj/vs/0pajvs-a-lrxvfuw8zylnj6lleg.png"></p></div></div><br><hr><br><h1 id="11-artefakty-i-sborka-pri-push-v-masteranchorartifactsanchor"> 11.     push  master <a name="artifacts"></a></h1><br><p>            ,             .           digest  master-. </p><br><p>  :    <strong>website</strong>      push  <strong>master</strong> ,       Kubernetes. </p><br><p>        <strong>.gitlab-ci.yml</strong> : </p><br><pre> <code class="plaintext hljs">build_website: extends: .build_docker_image variables: GIT_SUBMODULE_STRATEGY: normal script: - mkdir -p $CI_PROJECT_DIR/artifacts - /kaniko/executor --cache --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/dockerfiles/website/Dockerfile --destination $CI_REGISTRY_IMAGE/website:$CI_COMMIT_REF_NAME --digest-file $CI_PROJECT_DIR/artifacts/website.digest artifacts: paths: - artifacts/ only: refs: - master - tags deploy_website: extends: .deploy_qbec_app script: - DIGEST="$(cat artifacts/website.digest)" - qbec apply default --root deploy/website --force:k8s-context __incluster__ --wait --yes --vm:ext-str digest="$DIGEST"</code> </pre> <br><p>  ,    <strong>master</strong>  <strong>refs</strong>   <strong>build_website</strong>     <strong>$CI_COMMIT_REF_NAME</strong>  <strong>$CI_COMMIT_TAG</strong> ,        Git           .  ,        ,           docker-registry. </p><br><p>   docker-       ,        Kubernetes,           ,         . </p><br><p>  <strong>--vm:ext-str digest="$DIGEST"</strong>  qbec â€”      jsonnet.            .   ,     ,     ,               . </p><br><p>     Kaniko  digest    ( <strong>--digest-file</strong> ) <br>          . </p><br><p>     <strong>deploy/website/environments/base.libsonnet</strong>     : </p><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { <span class="hljs-attr"><span class="hljs-attr">website</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'example-docs'</span></span>, <span class="hljs-attr"><span class="hljs-attr">image</span></span>: <span class="hljs-string"><span class="hljs-string">'registry.gitlab.com/kvaps/docs.example.org/website@'</span></span> + std.extVar(<span class="hljs-string"><span class="hljs-string">'digest'</span></span>), <span class="hljs-attr"><span class="hljs-attr">replicas</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">containerPort</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">servicePort</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">nodeSelector</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">tolerations</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">ingressClass</span></span>: <span class="hljs-string"><span class="hljs-string">'nginx'</span></span>, <span class="hljs-attr"><span class="hljs-attr">domain</span></span>: <span class="hljs-string"><span class="hljs-string">'docs.example.org'</span></span>, }, }, }</code> </pre> <br><p> ,     <strong>master</strong>   docker-  <strong>website</strong> ,      Kubernetes. </p><br><p>     : </p><br><pre> <code class="bash hljs">git add . git commit -m <span class="hljs-string"><span class="hljs-string">"Configure dynamic build"</span></span></code> </pre> <br><p> ,  <strong>git push</strong>    - : </p><br><div class="spoiler"> <b class="spoiler_title">   master</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/7_/ry/nh/7_rynh5lgu_8hqnnl_gasx73zwq.png"></p></div></div><br><p>       gitlab-runner   push, , ,      ,     <strong>.gitlab-ci.yml</strong> : </p><br><pre> <code class="plaintext hljs">deploy_gitlab_runner: extends: .deploy_qbec_app variables: GIT_SUBMODULE_STRATEGY: normal before_script: - base64 -d "$GITCRYPT_KEY" | git-crypt unlock - script: - qbec apply default --root deploy/gitlab-runner --force:k8s-context __incluster__ --wait --yes only: changes: - deploy/gitlab-runner/**/*</code> </pre> <br><p> <strong>changes</strong>      <strong>deploy/gitlab-runner/</strong>          </p><br><p>     : </p><br><pre> <code class="bash hljs">git add .gitlab-ci.yml git commit -m <span class="hljs-string"><span class="hljs-string">"Reduce gitlab-runner deploy"</span></span></code> </pre> <br><p> <strong>git push</strong> , - : </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/-t/9b/3m/-t9b3mtofbunu7xfogpmb0pacsm.png"></p></div></div><br><hr><br><h1 id="12-dynamic-environmentsanchordynamic-environmentsanchor"> 12. Dynamic environments <a name="dynamic-environments"></a></h1><br><p>       . </p><br><p>     <strong>build_website</strong>   <strong>.gitlab-ci.yml</strong> ,     <strong>only</strong> ,   Gitlab        : </p><br><pre> <code class="plaintext hljs">build_website: extends: .build_docker_image variables: GIT_SUBMODULE_STRATEGY: normal script: - mkdir -p $CI_PROJECT_DIR/artifacts - /kaniko/executor --cache --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/dockerfiles/website/Dockerfile --destination $CI_REGISTRY_IMAGE/website:$CI_COMMIT_REF_NAME --digest-file $CI_PROJECT_DIR/artifacts/website.digest artifacts: paths: - artifacts/</code> </pre> <br><p>    <strong>deploy_website</strong> ,    <strong>environment</strong> : </p><br><pre> <code class="plaintext hljs">deploy_website: extends: .deploy_qbec_app environment: name: prod url: https://docs.example.org script: - DIGEST="$(cat artifacts/website.digest)" - qbec apply default --root deploy/website --force:k8s-context __incluster__ --wait --yes --vm:ext-str digest="$DIGEST"</code> </pre> <br><p>   Gitlab    <strong>prod</strong>       . </p><br><p>     : </p><br><pre> <code class="plaintext hljs">deploy_website: extends: .deploy_qbec_app environment: name: prod url: https://docs.example.org script: - DIGEST="$(cat artifacts/website.digest)" - qbec apply default --root deploy/website --force:k8s-context __incluster__ --wait --yes --vm:ext-str digest="$DIGEST" deploy_review: extends: .deploy_qbec_app environment: name: review/$CI_COMMIT_REF_NAME url: http://$CI_ENVIRONMENT_SLUG.docs.example.org on_stop: stop_review script: - DIGEST="$(cat artifacts/website.digest)" - qbec apply review --root deploy/website --force:k8s-context __incluster__ --wait --yes --vm:ext-str digest="$DIGEST" --vm:ext-str subdomain="$CI_ENVIRONMENT_SLUG" --app-tag "$CI_ENVIRONMENT_SLUG" only: refs: - branches except: refs: - master stop_review: extends: .deploy_qbec_app environment: name: review/$CI_COMMIT_REF_NAME action: stop stage: deploy before_script: - git clone "$CI_REPOSITORY_URL" master - cd master script: - qbec delete review --root deploy/website --force:k8s-context __incluster__ --yes --vm:ext-str digest="$DIGEST" --vm:ext-str subdomain="$CI_ENVIRONMENT_SLUG" --app-tag "$CI_ENVIRONMENT_SLUG" variables: GIT_STRATEGY: none only: refs: - branches except: refs: - master when: manual</code> </pre> <br><p>     push     master    preview  . </p><br><p>      qbec: <strong>--app-tag</strong> â€”             ,       Kubernetes qbec    . <br>           review,       . </p><br><p>      <strong>qbec apply review</strong> ,  <strong>qbec apply default</strong> â€”               (review  default): </p><br><p>  <strong>review</strong>   <strong>deploy/website/qbec.yaml</strong> </p><br><pre> <code class="plaintext hljs">spec: environments: review: defaultNamespace: docs server: https://kubernetes.example.org:8443</code> </pre> <br><p>     <strong>deploy/website/params.libsonnet</strong> : </p><br><pre> <code class="javascript hljs">local env = std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/env'</span></span>); local paramsMap = { <span class="hljs-attr"><span class="hljs-attr">_</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./environments/base.libsonnet'</span></span>, <span class="hljs-attr"><span class="hljs-attr">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./environments/default.libsonnet'</span></span>, <span class="hljs-attr"><span class="hljs-attr">review</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./environments/review.libsonnet'</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> std.objectHas(paramsMap, env) then paramsMap[env] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> error <span class="hljs-string"><span class="hljs-string">'environment '</span></span> + env + <span class="hljs-string"><span class="hljs-string">' not defined in '</span></span> + std.thisFile</code> </pre> <br><p>        <strong>deploy/website/environments/review.libsonnet</strong> : </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// this file has the param overrides for the default environment local base = import './base.libsonnet'; local slug = std.extVar('qbec.io/tag'); local subdomain = std.extVar('subdomain'); base { components+: { website+: { name: 'example-docs-' + slug, domain: subdomain + '.docs.example.org', }, }, }</span></span></code> </pre> <br><p>       <strong>stop_review</strong> ,         gitlab    checkout    <strong>GIT_STRATEGY: none</strong> ,    <strong>master</strong> -   review  . <br>  ,        . <br>       review   ,     . </p><br><p>     : </p><br><pre> <code class="plaintext hljs">git add . git commit -m "Enable automatic review"</code> </pre> <br><p> <strong>git push</strong> , <strong>git checkout -b test</strong> , <strong>git push origin test</strong> , : </p><br><div class="spoiler"> <b class="spoiler_title">  environments  Gitlab</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/wc/pz/ce/wcpzcedcwgfqvr0h_thgcw4ylqk.png"></p></div></div><br><p>  ? â€” ,    : <strong>git checkout master</strong> , <strong>git push origin :test</strong> ,      environment   . </p><br><blockquote>    ,        ,     <strong>.gitlab-ci.yml</strong>       . <br>          protected-,   <strong>master</strong> ,        . </blockquote><br><hr><br><h1 id="13-review-appsanchorreview-appsanchor"> 13. Review Apps <a name="review-apps"></a></h1><br><p> <strong><a href="https://docs.gitlab.com/ee/ci/review_apps/" rel="nofollow">Review Apps</a></strong>    ,                . </p><br><p>      ,    <strong>.gitlab/route-map.yml</strong>       ,       : </p><br><pre> <code class="plaintext hljs"># Indices - source: /content\/(.+?)_index\.(md|html)/ public: '\1' # Pages - source: /content\/(.+?)\.(md|html)/ public: '\1/'</code> </pre> <br><p>     : </p><br><pre> <code class="plaintext hljs">git add .gitlab/ git commit -m "Enable review apps"</code> </pre> <br><p> <strong>git push</strong> ,  : </p><br><div class="spoiler"> <b class="spoiler_title">  Review App</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ns/wi/za/nswizajvjjozyoluazo21pzq7t8.png"></p></div></div><br><h1 id="job-is-done"> Job is done! </h1><br><p> <strong> :</strong> </p><br><ul><li>  Gitlab: <a href="" rel="nofollow">https://gitlab.com/kvaps/docs.example.org</a> </li><li>  GitHub: <a href="" rel="nofollow">https://github.com/kvaps/docs.example.org</a> </li></ul><br><p>   ,    <img src="https://habrastorage.org/getpro/habr/post_images/cd7/2c7/9c3/cd72c79c3eeb7355e20bba58e9088654.gif" alt="å›¾ç‰‡"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN481662/">https://habr.com/ru/post/zh-CN481662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN481644/index.html">å¦‚ä½•åœ¨21ä¸–çºªçš„SQLæ•°æ®åº“ä¸­ç”Ÿå­˜ï¼šäº‘ï¼ŒKuberneteså’ŒPostgreSQLå¤šä¸»æœº</a></li>
<li><a href="../zh-CN481648/index.html">åœ¨Junos PyEZä¸Šæ‰¾åˆ°å…è´¹çš„ipv4å­ç½‘çš„ä»»åŠ¡ç¤ºä¾‹</a></li>
<li><a href="../zh-CN481652/index.html">åœ¨BlackBerry Androidæ™ºèƒ½æ‰‹æœºä¸Šçš„åé—¨ï¼ˆï¼Ÿï¼‰</a></li>
<li><a href="../zh-CN481654/index.html">è´¨é‡ä¿è¯å·¥ç¨‹å¸ˆå¦‚ä½•ä½¿ç”¨Bot Frameworkåœ¨Test ITçš„å¸®åŠ©ä¸‹ä½¿æ‚¨çš„ç”Ÿæ´»æ›´è½»æ¾çš„æ•…äº‹</a></li>
<li><a href="../zh-CN481656/index.html">PagerDutyï¼Œæˆ–è€…ä¸ºä»€ä¹ˆè¿è¥éƒ¨é—¨æ™šä¸Šæ— æ³•å…¥ç¡</a></li>
<li><a href="../zh-CN481664/index.html">æ— æœåŠ¡å™¨å®šä»·å’Œæˆæœ¬ï¼šAWS Lambda</a></li>
<li><a href="../zh-CN481666/index.html">è‡ªå®šä¹‰SwiftLintè§„åˆ™</a></li>
<li><a href="../zh-CN481668/index.html">ç¬¬ä¸€ä¸ªè§‚ä¼—é—®é¢˜ï¼Œæˆ–å°†WebRTCè§†é¢‘æµè½¬æ¢ä¸ºHLSçš„å›°éš¾</a></li>
<li><a href="../zh-CN481670/index.html">ä½¿ç”¨AWS Cloud Adoption Frameworkåˆ›å»ºè¡ŒåŠ¨è®¡åˆ’</a></li>
<li><a href="../zh-CN481672/index.html">æµè§ˆå™¨ä¸­çš„å…ƒèƒè‡ªåŠ¨æœº</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>