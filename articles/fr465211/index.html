<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚ÄçüöÄ üîº üë®üèª‚Äçüåæ √âchapper au fourr√© des tests: cr√©er un raccourci d'un appareil vers une assertion üë®üèª‚Äç‚úàÔ∏è „äóÔ∏è üóÇÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je voudrais proposer une alternative au style de conception de test traditionnel en utilisant des concepts de programmation fonction...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√âchapper au fourr√© des tests: cr√©er un raccourci d'un appareil vers une assertion</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/465211/"><p><img src="https://habrastorage.org/webt/mu/ll/ar/mullaroquhqtdb05ygvb82nmghu.jpeg"></p><br><p>  Dans cet article, je voudrais proposer une alternative au style de conception de test traditionnel en utilisant des concepts de programmation fonctionnelle dans Scala.  Cette approche a √©t√© inspir√©e par de nombreux mois de douleur dus au maintien de dizaines de tests √©chou√©s et √† un d√©sir ardent de les rendre plus simples et plus compr√©hensibles. </p><br><p>  M√™me si le code est en Scala, les id√©es propos√©es conviennent aux d√©veloppeurs et aux ing√©nieurs d'assurance qualit√© qui utilisent des langages prenant en charge la programmation fonctionnelle.  Vous pouvez trouver un lien Github avec la solution compl√®te et un exemple √† la fin de l'article. </p><a name="habracut"></a><br><h2 id="the-problem">  Le probl√®me </h2><br><p>  Si vous avez d√©j√† d√ª faire face √† des tests (peu importe lesquels: tests unitaires, int√©gratifs ou fonctionnels), ils ont probablement √©t√© √©crits sous la forme d'un ensemble d'instructions s√©quentielles.  Par exemple: </p><br><pre><code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// The following tests describe a simple internet store. // Depending on their role, bonus amount and the order's // subtotal, users may receive a discount of some size. "If user's role is 'customer'" - { import TestHelper._ "And if subtotal &lt; 250 after bonuses - no discount" in { val db: Database = Database.forURL(TestConfig.generateNewUrl()) migrateDb(db) insertUser(db, id = 1, name = "test", role = "customer") insertPackage(db, id = 1, name = "test", userId = 1, status = "new") insertPackageItems(db, id = 1, packageId = 1, name = "test", price = 30) insertPackageItems(db, id = 2, packageId = 1, name = "test", price = 20) insertPackageItems(db, id = 3, packageId = 1, name = "test", price = 40) val svc = new SomeProductionLogic(db) val result = svc.calculatePrice(packageId = 1) result shouldBe 90 } "And if subtotal &gt;= 250 after bonuses - 10% off" in { val db: Database = Database.forURL(TestConfig.generateNewUrl()) migrateDb(db) insertUser(db, id = 1, name = "test", role = "customer") insertPackage(db, id = 1, name = "test", userId = 1, status = "new") insertPackageItems(db, id = 1, packageId = 1, name = "test", price = 100) insertPackageItems(db, id = 2, packageId = 1, name = "test", price = 120) insertPackageItems(db, id = 3, packageId = 1, name = "test", price = 130) insertBonus(db, id = 1, packageId = 1, bonusAmount = 40) val svc = new SomeProductionLogic(db) val result = svc.calculatePrice(packageId = 1) result shouldBe 279 } } "If user's role is 'vip'" - {/*...*/}</span></span></code> </pre> <br><p>  D'apr√®s mon exp√©rience, cette fa√ßon d'√©crire des tests est pr√©f√©r√©e par la plupart des d√©veloppeurs.  Notre projet compte environ un millier de tests √† diff√©rents niveaux d'isolement, et tous ont √©t√© √©crits dans un tel style jusqu'√† tout r√©cemment.  Au fur et √† mesure que le projet progressait, nous avons commenc√© √† remarquer de graves probl√®mes et des ralentissements dans la maintenance de ces tests: les corriger prendrait au moins le m√™me temps que l'√©criture du code de production. </p><br><p>  Lors de l'√©criture de nouveaux tests, nous avons toujours d√ª trouver des moyens de pr√©parer les donn√©es √† partir de z√©ro, g√©n√©ralement en copiant et en collant les √©tapes des tests voisins.  En cons√©quence, lorsque le mod√®le de donn√©es de l'application changerait, le ch√¢teau de cartes s'effondrerait et nous devions r√©parer chaque test qui √©chouait: dans le pire des cas - en plongeant profond√©ment dans chaque test et en le r√©√©crivant. </p><br><p>  Lorsqu'un test √©choue ¬´honn√™tement¬ª - c'est-√†-dire en raison d'un bug r√©el dans la logique m√©tier - comprendre ce qui s'est mal pass√© sans d√©bogage est impossible.  Parce que les tests √©taient si difficiles √† comprendre, personne n'avait toujours la connaissance compl√®te de la fa√ßon dont le syst√®me est cens√© se comporter. </p><br><p>  Toute cette douleur, √† mon avis, est un sympt√¥me des deux probl√®mes les plus profonds de cette conception de test: </p><br><ol><li>  Il n'y a pas de structure claire et pratique pour les tests.  Chaque test est un flocon de neige unique.  Le manque de structure conduit √† la verbosit√©, qui consomme beaucoup de temps et d√©motive.  Des d√©tails insignifiants d√©tournent l'attention de ce qui est le plus important - l'exigence que le test affirme.  Le copier-coller devient la principale approche pour √©crire de nouveaux cas de test. </li><li>  Les tests n'aident pas les d√©veloppeurs √† localiser les d√©fauts;  ils signalent seulement qu'il y a un probl√®me quelconque.  Pour comprendre l'√©tat dans lequel le test est ex√©cut√©, vous devez le tracer dans votre t√™te ou utiliser un d√©bogueur. </li></ol><br><h2 id="modeling">  Mod√©lisation </h2><br><p>  Pouvons-nous faire mieux?  (Alerte spoiler: nous le pouvons.) Voyons quel type de structure ce test peut avoir. </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> db: <span class="hljs-type"><span class="hljs-type">Database</span></span> = <span class="hljs-type"><span class="hljs-type">Database</span></span>.forURL(<span class="hljs-type"><span class="hljs-type">TestConfig</span></span>.generateNewUrl()) migrateDb(db) insertUser(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, role = <span class="hljs-string"><span class="hljs-string">"customer"</span></span>) insertPackage(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, userId = <span class="hljs-number"><span class="hljs-number">1</span></span>, status = <span class="hljs-string"><span class="hljs-string">"new"</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">30</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">2</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">20</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">3</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">40</span></span>)</code> </pre> <br><p>  En r√®gle g√©n√©rale, le code test√© attend certains param√®tres explicites (identifiants, tailles, montants, filtres, pour n'en nommer que quelques-uns), ainsi que certaines donn√©es externes (√† partir d'une base de donn√©es, d'une file d'attente ou d'un autre service du monde r√©el).  Pour que notre test fonctionne de mani√®re fiable, il a besoin d'un <em>appareil</em> - un √©tat pour mettre le syst√®me, les fournisseurs de donn√©es, ou les deux. </p><br><p>  Avec ce luminaire, nous pr√©parons une <em>d√©pendance</em> pour initialiser le code sous test - remplir une base de donn√©es, cr√©er une file d'attente d'un type particulier, etc. </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> svc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">SomeProductionLogic</span></span>(db) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = svc.calculatePrice(packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  Apr√®s avoir ex√©cut√© le code sous test sur certains param√®tres d'entr√©e, nous recevons une <em>sortie</em> - √† la fois explicite (retourn√©e par le code sous test) et implicite (les changements d'√©tat). </p><br><pre> <code class="scala hljs">result shouldBe <span class="hljs-number"><span class="hljs-number">90</span></span></code> </pre> <br><p>  Enfin, nous v√©rifions que la sortie est conforme aux attentes, en terminant le test avec une ou plusieurs <em>assertions</em> . </p><br><p><img src="https://habrastorage.org/webt/em/aa/rb/emaarb5ltmnme4-wpda0ebakueq.jpeg"></p><br><p>  On peut conclure que les tests se composent g√©n√©ralement des m√™mes √©tapes: pr√©paration des entr√©es, ex√©cution du code et assertion des r√©sultats.  Nous pouvons utiliser ce fait pour nous d√©barrasser du <strong>premier probl√®me de nos tests</strong> , c'est-√†-dire une forme trop lib√©rale, en divisant explicitement le corps d'un test en √©tapes.  Une telle id√©e n'est pas nouvelle, comme on peut le voir dans les tests de style BDD ( <em>d√©veloppement ax√© sur le comportement</em> ). </p><br><p>  Qu'en est-il de l'extensibilit√©?  Toute √©tape du processus de test peut, √† son tour, contenir n'importe quelle quantit√© d'interm√©diaires.  Par exemple, nous pourrions prendre une grande et compliqu√©e √©tape, comme construire un luminaire, et le diviser en plusieurs, encha√Æn√©s les uns apr√®s les autres.  De cette fa√ßon, le processus de test peut √™tre extensible √† l'infini, mais en fin de compte toujours compos√© des m√™mes quelques √©tapes g√©n√©rales. </p><br><p><img src="https://habrastorage.org/webt/55/qf/zl/55qfzlhkl99txyyhizbvzg48yhs.jpeg"></p><br><h2 id="running-tests">  Ex√©cution de tests </h2><br><p>  Essayons d'impl√©menter l'id√©e de diviser le test en √©tapes, mais d'abord, nous devons d√©terminer quel type de r√©sultat nous aimerions voir. </p><br><p>  Dans l'ensemble, nous aimerions que la r√©daction et la maintenance des tests deviennent moins laborieuses et plus agr√©ables.  Moins un test contient d'instructions explicites non uniques, moins il faudrait y apporter de modifications apr√®s avoir chang√© de contrat ou refactoris√©, et moins il faudrait de temps pour lire le test.  La conception du test doit favoriser la r√©utilisation des extraits de code courants et d√©courager le copier-coller insens√©.  Il serait √©galement int√©ressant que les tests aient une forme unifi√©e.  La pr√©visibilit√© am√©liore la lisibilit√© et fait gagner du temps.  Par exemple, imaginez combien de temps encore faudrait-il aux aspirants scientifiques pour apprendre toutes les formules si les manuels les faisaient √©crire librement dans un langage commun, par opposition aux math√©matiques. </p><br><p>  Ainsi, notre objectif est de cacher tout ce qui est g√™nant et inutile, en ne laissant que ce qui est d'une importance cruciale pour la compr√©hension: ce qui est test√©, quelles sont les entr√©es et les sorties attendues. </p><br><p>  Revenons √† notre mod√®le de structure du test. </p><br><p><img src="https://habrastorage.org/webt/em/aa/rb/emaarb5ltmnme4-wpda0ebakueq.jpeg"></p><br><p>  Techniquement, chaque √©tape peut √™tre repr√©sent√©e par un type de donn√©es, et chaque transition - par une fonction.  Pour passer du type de donn√©es initial au type final, il est possible d'appliquer chaque fonction au r√©sultat de la pr√©c√©dente.  En d'autres termes, en utilisant la composition des fonctions de pr√©paration des donn√©es (appelons-les <code>prepare</code> ), l'ex√©cution de code ( <code>execute</code> ) et la v√©rification du r√©sultat attendu ( <code>check</code> ).  L'entr√©e pour cette composition serait la toute premi√®re √©tape - le luminaire.  Appelons la fonction r√©sultante d'ordre sup√©rieur la <strong>fonction de cycle de vie de test</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">Tester la fonction de cycle de vie</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runTestCycle</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">FX</span></span>, <span class="hljs-type"><span class="hljs-type">DEP</span></span>, <span class="hljs-type"><span class="hljs-type">OUT</span></span>, <span class="hljs-type"><span class="hljs-type">F</span></span>[_]]( fixture: <span class="hljs-type"><span class="hljs-type">FX</span></span>, prepare: <span class="hljs-type"><span class="hljs-type">FX</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">DEP</span></span>, execute: <span class="hljs-type"><span class="hljs-type">DEP</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">OUT</span></span>, check: <span class="hljs-type"><span class="hljs-type">OUT</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">Assertion</span></span>] ): <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">Assertion</span></span>] = <span class="hljs-comment"><span class="hljs-comment">// In Scala instead of writing check(execute(prepare(fixture))) // one can use a more readable version using the andThen function: (prepare andThen execute andThen check) (fixture)</span></span></code> </pre> </div></div><br><p>  Une question se pose, d'o√π viennent ces certaines fonctions?  Eh bien, en ce qui concerne la pr√©paration des donn√©es, il n'y a qu'un nombre limit√© de fa√ßons de le faire - remplir une base de donn√©es, se moquer, etc.  Ainsi, il est pratique d'√©crire des variantes sp√©cialis√©es de la fonction de <code>prepare</code> partag√©es entre tous les tests.  En cons√©quence, il serait plus facile de cr√©er des fonctions de cycle de vie de test sp√©cialis√©es pour chaque cas, ce qui masquerait les mises en ≈ìuvre concr√®tes de la pr√©paration des donn√©es.  √âtant donn√© que l'ex√©cution et les assertions de code sont plus ou moins uniques pour chaque test (ou groupe de tests), l' <code>execute</code> et la <code>check</code> doivent √™tre √©crites √† chaque fois explicitement. </p><br><div class="spoiler">  <b class="spoiler_title">Fonction de test du cycle de vie adapt√©e pour les tests d'int√©gration sur une base de donn√©es</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// Sets up the fixture ‚Äî implemented separately def prepareDatabase[DB](db: Database): DbFixture =&gt; DB def testInDb[DB, OUT]( fixture: DbFixture, execute: DB =&gt; OUT, check: OUT =&gt; Future[Assertion], db: Database = getDatabaseHandleFromSomewhere(), ): Future[Assertion] = runTestCycle(fixture, prepareDatabase(db), execute, check)</span></span></code> </pre> </div></div><br><p>  En d√©l√©guant toutes les nuances administratives √† la fonction de cycle de vie du test, nous avons la possibilit√© d'√©tendre le processus de test sans toucher √† un test donn√©.  En utilisant la composition des fonctions, nous pouvons interf√©rer √† n'importe quelle √©tape du processus et extraire ou ajouter des donn√©es. </p><br><p>  Pour mieux illustrer les capacit√©s d'une telle approche, r√©solvons <strong>le deuxi√®me probl√®me de notre test initial</strong> - le manque d'informations suppl√©mentaires pour identifier les probl√®mes.  Ajoutons la journalisation de l'ex√©cution du code retourn√©e.  Notre journalisation ne changera pas le type de donn√©es;  cela ne produit <em>qu'un effet secondaire</em> - la sortie d'un message sur la console.  Apr√®s l'effet secondaire, nous le renvoyons tel quel. </p><br><div class="spoiler">  <b class="spoiler_title">Test de la fonction de cycle de vie avec journalisation</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logged</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> loggedT: <span class="hljs-type"><span class="hljs-type">Logged</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]): <span class="hljs-type"><span class="hljs-type">T</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">T</span></span> = (that: <span class="hljs-type"><span class="hljs-type">T</span></span>) =&gt; { <span class="hljs-comment"><span class="hljs-comment">// By passing an instance of the Logged typeclass for T as an argument, // we get an ability to ‚Äúadd‚Äù behavior log() to the abstract ‚Äúthat‚Äù member. // More on typeclasses later on. loggedT.log(that) // We could even do: that.log() that // The object gets returned unaltered } def runTestCycle[FX, DEP, OUT, F[_]]( fixture: FX, prepare: FX =&gt; DEP, execute: DEP =&gt; OUT, check: OUT =&gt; F[Assertion] )(implicit loggedOut: Logged[OUT]): F[Assertion] = // Insert logged right after receiving the result - after execute() (prepare andThen execute andThen logged andThen check) (fixture)</span></span></code> </pre> </div></div><br><p>  Avec cette simple modification, nous avons ajout√© la journalisation de la sortie du code ex√©cut√© <strong>dans chaque test</strong> .  L'avantage de ces petites fonctions est qu'elles sont faciles √† comprendre, √† composer et √† √©liminer en cas de besoin. </p><br><p><img src="https://habrastorage.org/webt/ti/2t/l9/ti2tl9pk8wkd4hp8pqevf74hdn4.jpeg"></p><br><p>  En cons√©quence, notre test ressemble maintenant √† ceci: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> fixture: <span class="hljs-type"><span class="hljs-type">SomeMagicalFixture</span></span> = ??? <span class="hljs-comment"><span class="hljs-comment">// Comes from somewhere else def runProductionCode(id: Int): Database =&gt; Double = (db: Database) =&gt; new SomeProductionLogic(db).calculatePrice(id) def checkResult(expected: Double): Double =&gt; Future[Assertion] = (result: Double) =&gt; result shouldBe expected // The creation and filling of Database is hidden in testInDb "If user's role is 'customer'" in testInDb( state = fixture, execute = runProductionCode(id = 1), check = checkResult(90) )</span></span></code> </pre> <br><p>  Le corps du test est devenu concis, le montage et les contr√¥les peuvent √™tre r√©utilis√©s dans d'autres tests, et nous ne pr√©parons plus la base de donn√©es manuellement nulle part.  Un seul petit probl√®me subsiste ... </p><br><h2 id="fixture-preparation">  Pr√©paration du luminaire </h2><br><p>  Dans le code ci-dessus, nous travaillions en supposant que le luminaire nous serait donn√© de quelque part.  √âtant donn√© que les donn√©es sont l'ingr√©dient essentiel des tests maintenables et simples, nous devons aborder la fa√ßon de les rendre facilement. </p><br><p>  Supposons que notre magasin en cours de test poss√®de une base de donn√©es relationnelle de taille moyenne (par souci de simplicit√©, dans cet exemple, il n'a que 4 tables, mais en r√©alit√©, il peut en avoir des centaines).  Certaines tables contiennent des donn√©es r√©f√©rentielles, d'autres des donn√©es m√©tier, et tout cela peut √™tre logiquement regroup√© en une ou plusieurs entit√©s complexes.  Les relations sont li√©es avec <em>des cl√©s √©trang√®res</em> , pour cr√©er un <code>Bonus</code> , un <code>Package</code> est n√©cessaire, qui √† son tour a besoin d'un <code>User</code> , etc. </p><br><p><img src="https://habrastorage.org/webt/3z/of/sy/3zofsyjoygierusjtmlu_okrmh0.png"></p><br><p>  Les solutions de contournement et les hacks ne conduisent qu'√† une incoh√©rence des donn√©es et, par cons√©quent, √† des heures et des heures de d√©bogage.  Pour cette raison, nous n'apportons aucune modification au sch√©ma. </p><br><p>  Nous pourrions utiliser certaines m√©thodes de production pour le remplir, mais m√™me sous un examen superficiel, cela soul√®ve beaucoup de questions difficiles.  Qu'est-ce qui pr√©parera les donn√©es des tests pour ce code de production?  Devrions-nous r√©√©crire les tests si le contrat de ce code change?  Que se passe-t-il si les donn√©es proviennent enti√®rement d'un autre endroit et qu'aucune m√©thode n'est utilis√©e?  Combien de demandes faudrait-il pour cr√©er une entit√© qui d√©pend de bien d'autres? </p><br><div class="spoiler">  <b class="spoiler_title">Base de donn√©es remplissant le test initial</b> <div class="spoiler_text"><pre> <code class="scala hljs">insertUser(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, role = <span class="hljs-string"><span class="hljs-string">"customer"</span></span>) insertPackage(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, userId = <span class="hljs-number"><span class="hljs-number">1</span></span>, status = <span class="hljs-string"><span class="hljs-string">"new"</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">30</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">2</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">20</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">3</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">40</span></span>)</code> </pre> </div></div><br><p>  Les m√©thodes auxiliaires dispers√©es, comme celles de notre tout premier exemple, sont le m√™me probl√®me sous une apparence diff√©rente.  Ils nous confient la responsabilit√© de g√©rer les d√©pendances que nous essayons d'√©viter. </p><br><p>  Id√©alement, nous aimerions une structure de donn√©es qui pr√©senterait l'√©tat de l'ensemble du syst√®me en un coup d'≈ìil.  Un bon candidat serait une table (ou un <em>ensemble de donn√©es</em> , comme en PHP ou Python) qui n'aurait rien de plus que des champs critiques pour la logique m√©tier.  S'il change, la maintenance des tests serait facile: nous modifions simplement les champs dans l'ensemble de donn√©es.  Exemple: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">DataRow</span></span>] = <span class="hljs-type"><span class="hljs-type">Table</span></span>( (<span class="hljs-string"><span class="hljs-string">"Package ID"</span></span>, <span class="hljs-string"><span class="hljs-string">"Customer's role"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item prices"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bonus value"</span></span>, <span class="hljs-string"><span class="hljs-string">"Expected final price"</span></span>) , (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">90.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">225.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) , <span class="hljs-number"><span class="hljs-number">210.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) , <span class="hljs-number"><span class="hljs-number">279.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"vip"</span></span> , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">252.0</span></span>) )</code> </pre> <br><p><img src="https://habrastorage.org/webt/5j/dt/2p/5jdt2pdn7hdzhepaut_bhukkcgm.jpeg"></p><br><p>  √Ä partir de notre table, nous cr√©ons des <em>cl√©s</em> - liens d'entit√© par ID.  Si une entit√© d√©pend d'une autre, une cl√© pour cette autre entit√© est √©galement cr√©√©e.  Il peut arriver que deux entit√©s diff√©rentes cr√©ent une d√©pendance avec le m√™me ID, ce qui peut entra√Æner <em>une violation de cl√© primaire</em> .  Cependant, √† ce stade, il est incroyablement bon march√© de d√©dupliquer les cl√©s - car elles ne contiennent que des ID, nous pouvons les placer dans une collection qui fait la d√©duplication pour nous, par exemple, un <code>Set</code> .  Si cela s'av√®re insuffisant, nous pouvons toujours impl√©menter une d√©duplication plus intelligente en tant que fonction distincte et la composer dans la fonction de cycle de vie de test. </p><br><div class="spoiler">  <b class="spoiler_title">Cl√©s (exemple)</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, userId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageItemKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BonusKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span></span></code> </pre> </div></div><br><p>  La g√©n√©ration de fausses donn√©es pour les champs (par exemple, les noms) est d√©l√©gu√©e √† une classe distincte.  Ensuite, en utilisant cette classe et les r√®gles de conversion pour les cl√©s, nous obtenons les objets Row destin√©s √† √™tre ins√©r√©s dans la base de donn√©es. </p><br><div class="spoiler">  <b class="spoiler_title">Lignes (exemple)</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleData</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"test name"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">role</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"customer"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">price</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> = <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bonusAmount</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">status</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"new"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, userId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, status: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageItemRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, price: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, role: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BonusRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, bonusAmount: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span></span></code> </pre> </div></div><br><p>  Les fausses donn√©es ne sont g√©n√©ralement pas suffisantes, nous avons donc besoin d'un moyen de remplacer des champs sp√©cifiques.  Heureusement, les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lentilles</a> sont exactement ce dont nous avons besoin - nous pouvons les utiliser pour parcourir toutes les lignes cr√©√©es et modifier uniquement les champs dont nous avons besoin.  Les verres √©tant des fonctions d√©guis√©es, nous pouvons les composer comme d'habitude, ce qui est leur point fort. </p><br><div class="spoiler">  <b class="spoiler_title">Lense (exemple)</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeUserRole</span></span></span></span>(userId: <span class="hljs-type"><span class="hljs-type">Int</span></span>, newRole: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>] =&gt; <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>] = (rows: <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>]) =&gt; rows.modifyAll(_.each.when[<span class="hljs-type"><span class="hljs-type">UserRow</span></span>]) .using(r =&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.id == userId) r.modify(_.role).setTo(newRole) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> r)</code> </pre> </div></div><br><p>  Gr√¢ce √† la composition, nous pouvons appliquer diff√©rentes optimisations et am√©liorations √† l'int√©rieur du processus: par exemple, nous pourrions regrouper des lignes par la table pour les ins√©rer avec un seul <code>INSERT</code> pour r√©duire le temps d'ex√©cution du test ou enregistrer l'int√©gralit√© de l'√©tat de la base de donn√©es. </p><br><div class="spoiler">  <b class="spoiler_title">Fonction de pr√©paration du luminaire</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeFixture</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">STATE</span></span>, <span class="hljs-type"><span class="hljs-type">FX</span></span>, <span class="hljs-type"><span class="hljs-type">ROW</span></span>, <span class="hljs-type"><span class="hljs-type">F</span></span>[_]]( state: <span class="hljs-type"><span class="hljs-type">STATE</span></span>, applyOverrides: <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">ROW</span></span>] =&gt; <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">ROW</span></span>] = x =&gt; x ): <span class="hljs-type"><span class="hljs-type">FX</span></span> = (extractKeys andThen deduplicateKeys andThen enrichWithSampleData andThen applyOverrides andThen logged andThen buildFixture) (state)</code> </pre> </div></div><br><p>  Enfin, le tout nous fournit un appareil.  Dans le test lui-m√™me, rien de plus n'est affich√©, √† l'exception du jeu de donn√©es initial - tous les d√©tails sont masqu√©s par la composition de la fonction. </p><br><p><img src="https://habrastorage.org/webt/b3/wz/cq/b3wzcqmqj3gomn-s-zycrakuegy.jpeg"></p><br><p>  Notre suite de tests ressemble maintenant √† ceci: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">DataRow</span></span>] = <span class="hljs-type"><span class="hljs-type">Table</span></span>( (<span class="hljs-string"><span class="hljs-string">"Package ID"</span></span>, <span class="hljs-string"><span class="hljs-string">"Customer's role"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item prices"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bonus value"</span></span>, <span class="hljs-string"><span class="hljs-string">"Expected final price"</span></span>) , (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">90.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">225.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) , <span class="hljs-number"><span class="hljs-number">210.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) , <span class="hljs-number"><span class="hljs-number">279.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"vip"</span></span> , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">252.0</span></span>) ) <span class="hljs-string"><span class="hljs-string">"If the buyer's role is"</span></span> - { <span class="hljs-string"><span class="hljs-string">"a customer"</span></span> - { <span class="hljs-string"><span class="hljs-string">"And the total price of items"</span></span> - { <span class="hljs-string"><span class="hljs-string">"&lt; 250 after applying bonuses - no discount"</span></span> - { <span class="hljs-string"><span class="hljs-string">"(case: no bonuses)"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"(case: has bonuses)"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">3</span></span>) } <span class="hljs-string"><span class="hljs-string">"&gt;= 250 after applying bonuses"</span></span> - { <span class="hljs-string"><span class="hljs-string">"If there are no bonuses - 10% off on the subtotal"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"If there are bonuses - 10% off on the subtotal after applying bonuses"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">4</span></span>) } } } <span class="hljs-string"><span class="hljs-string">"a vip - then they get a 20% off before applying bonuses and then all the other rules apply"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">5</span></span>) }</code> </pre> <br><p>  Et le code d'assistance: </p><br><div class="spoiler">  <b class="spoiler_title">Code d'assistance</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// Reusable test's body def calculatePriceFor(table: Seq[DataRow], idx: Int) = testInDb( state = makeState(table.row(idx)), execute = runProductionCode(table.row(idx)._1), check = checkResult(table.row(idx)._5) ) def makeState(row: DataRow): Logger =&gt; DbFixture = { val items: Map[Int, Int] = ((1 to row._3.length) zip row._3).toMap val bonuses: Map[Int, Int] = ((1 to row._4.length) zip row._4).toMap MyFixtures.makeFixture( state = PackageRelationships .minimal(id = row._1, userId = 1) .withItems(items.keys) .withBonuses(bonuses.keys), overrides = changeRole(userId = 1, newRole = row._2) andThen items.map { case (id, newPrice) =&gt; changePrice(id, newPrice) }.foldPls andThen bonuses.map { case (id, newBonus) =&gt; changeBonus(id, newBonus) }.foldPls ) } def runProductionCode(id: Int): Database =&gt; Double = (db: Database) =&gt; new SomeProductionLogic(db).calculatePrice(id) def checkResult(expected: Double): Double =&gt; Future[Assertion] = (result: Double) =&gt; result shouldBe expected</span></span></code> </pre></div></div><br><p>  L'ajout de nouveaux cas de test dans le tableau est une t√¢che triviale qui nous permet de nous concentrer sur la <strong>couverture de plus de cas marginaux</strong> et non sur l'√©criture de code standard. </p><br><h2 id="reusing-fixture-preparation-on-different-projects">  R√©utilisation de la pr√©paration des luminaires sur diff√©rents projets </h2><br><p>  D'accord, nous avons donc √©crit beaucoup de code pour pr√©parer des appareils dans un projet sp√©cifique, en passant un certain temps dans le processus.  Et si nous avons plusieurs projets?  Sommes-nous condamn√©s √† r√©inventer le tout √† partir de z√©ro √† chaque fois? </p><br><p>  Nous pouvons r√©sumer la pr√©paration du luminaire sur un mod√®le de domaine concret.  Dans le monde de la programmation fonctionnelle, il existe un concept de <em>typeclasses</em> .  Sans entrer dans les d√©tails, elles ne sont pas comme des classes dans la POO, mais plut√¥t comme des interfaces dans la mesure o√π elles d√©finissent un certain comportement d'un certain groupe de types.  La diff√©rence fondamentale est qu'ils ne sont pas h√©rit√©s mais plut√¥t instanci√©s comme des variables.  Cependant, comme pour l'h√©ritage, la r√©solution des instances de classe de types se produit <em>au moment de la compilation</em> .  En ce sens, les classes de types peuvent √™tre appr√©hend√©es comme les <em>m√©thodes d'extension</em> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kotlin</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">C #</a> . </p><br><p>  Pour enregistrer un objet, nous n'avons pas besoin de savoir ce qu'il contient, ses champs et ses m√©thodes.  Tout ce qui nous importe, c'est d'avoir un <code>log()</code> comportements <code>log()</code> avec une signature particuli√®re.  L'extension de chaque classe avec une interface <code>Logged</code> serait extr√™mement fastidieuse et m√™me impossible dans de nombreux cas - par exemple, pour les biblioth√®ques ou les classes standard.  Avec les classes de caract√®res, c'est beaucoup plus facile.  Nous pouvons cr√©er une instance d'une classe de type appel√©e Logged, par exemple, pour un appareil pour la consigner dans un format lisible par l'homme.  Pour tout le reste qui n'a pas d'instance de <code>Logged</code> nous pouvons fournir une solution de secours: une instance de type <code>Any</code> qui utilise gratuitement une m√©thode standard <code>toString()</code> pour enregistrer chaque objet dans sa repr√©sentation interne. </p><br><div class="spoiler">  <b class="spoiler_title">Un exemple de la classe de types Logged et ses instances</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Logged</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span></span>(a: <span class="hljs-type"><span class="hljs-type">A</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> logger: <span class="hljs-type"><span class="hljs-type">Logger</span></span>): <span class="hljs-type"><span class="hljs-type">A</span></span> } <span class="hljs-comment"><span class="hljs-comment">// For all Futures implicit def futureLogged[T]: Logged[Future[T]] = new Logged[Future[T]] { override def log(futureT: Future[T])(implicit logger: Logger): Future[T] = { futureT.map { t =&gt; // map on a Future lets us modify its result after it finishes logger.info(t.toString()) t } } } // Fallback in case there are no suitable implicits in scope implicit def anyNoLogged[T]: Logged[T] = new Logged[T] { override def log(t: T)(implicit logger: Logger): T = { logger.info(t.toString()) t } }</span></span></code> </pre> </div></div><br><p>  Outre la journalisation, nous pouvons utiliser cette approche tout au long du processus de fabrication des luminaires.  Notre solution propose une mani√®re abstraite de faire des montages de base de donn√©es et un ensemble de classes de types pour aller avec.  C'est le projet qui utilise la responsabilit√© de la solution pour impl√©menter les instances de ces classes de type pour que tout fonctionne. </p><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// Fixture preparation function def makeFixture[STATE, FX, ROW, F[_]]( state: STATE, applyOverrides: F[ROW] =&gt; F[ROW] = x =&gt; x ): FX = (extractKeys andThen deduplicateKeys andThen enrichWithSampleData andThen applyOverrides andThen logged andThen buildFixture) (state) override def extractKeys(implicit toKeys: ToKeys[DbState]): DbState =&gt; Set[Key] = (db: DbState) =&gt; db.toKeys() override def enrichWithSampleData(implicit enrich: Enrich[Key]): Key =&gt; Set[Row] = (key: Key) =&gt; key.enrich() override def buildFixture(implicit insert: Insertable[Set[Row]]): Set[Row] =&gt; DbFixture = (rows: Set[Row]) =&gt; rows.insert() // Behavior of splitting something (eg a dataset) into keys trait ToKeys[A] { def toKeys(a: A): Set[Key] // Something =&gt; Set[Key] } // ...converting keys into rows trait Enrich[A] { def enrich(a: A): Set[Row] // Set[Key] =&gt; Set[Row] } // ...and inserting rows into the database trait Insertable[A] { def insert(a: A): DbFixture // Set[Row] =&gt; DbFixture } // To be implemented in our project (see the example at the end of the article) implicit val toKeys: ToKeys[DbState] = ??? implicit val enrich: Enrich[Key] = ??? implicit val insert: Insertable[Set[Row]] = ???</span></span></code> </pre> <br><p>  Lors de la conception de cet outil de pr√©paration de luminaire, j'ai utilis√© les <em>principes SOLID</em> comme boussole pour m'assurer qu'il est maintenable et extensible: </p><br><ul><li>  <em>Le principe de responsabilit√© unique</em> : chaque classe de type d√©crit un et un seul comportement d'un type. </li><li>  <em>Le principe ouvert / ferm√©</em> : nous ne modifions aucune des classes de production;  √† la place, nous les √©tendons avec des instances de typeclasses. </li><li>  <em>Le principe de substitution de Liskov</em> ne s'applique pas ici car nous n'utilisons pas d'h√©ritage. </li><li>  <em>Le principe de s√©gr√©gation des interfaces</em> : nous utilisons de nombreuses classes de caract√®res sp√©cialis√©es par opposition √† une classe globale. </li><li>  <em>Le principe d'inversion des d√©pendances</em> : la fonction de pr√©paration des luminaires ne d√©pend pas des types concrets, mais plut√¥t des classes de types abstraites. </li></ul><br><p>  Apr√®s avoir v√©rifi√© que tous les principes sont satisfaits, nous pouvons supposer en toute s√©curit√© que notre solution est suffisamment maintenable et extensible pour √™tre utilis√©e dans diff√©rents projets. </p><br><p>  Apr√®s avoir √©crit la fonction de cycle de vie des tests et la solution pour la pr√©paration des luminaires, qui est √©galement ind√©pendante d'un mod√®le de domaine concret sur une application donn√©e, nous sommes tous pr√™ts √† am√©liorer tous les tests restants. </p><br><h2 id="bottom-line">  Conclusion </h2><br><p>  Nous sommes pass√©s du style de conception de test traditionnel (√©tape par √©tape) au style fonctionnel.  Le style √©tape par √©tape est utile d√®s le d√©but et dans les projets de plus petite taille, car il ne limite pas les d√©veloppeurs et ne n√©cessite aucune connaissance sp√©cialis√©e.  Cependant, lorsque le nombre de tests devient trop important, un tel style a tendance √† tomber.  L'√©criture de tests dans le style fonctionnel ne r√©soudra probablement pas tous vos probl√®mes de test, mais cela pourrait consid√©rablement am√©liorer la mise √† l'√©chelle et la maintenance des tests dans les projets, o√π il y en a des centaines ou des milliers.  Les tests qui sont √©crits dans le style fonctionnel se r√©v√®lent plus concis et ax√©s sur les √©l√©ments essentiels (tels que les donn√©es, le code sous test et le r√©sultat attendu), pas sur les √©tapes interm√©diaires. </p><br><p>  De plus, nous avons explor√© √† quel point la composition fonctionnelle et les classes de caract√®res peuvent √™tre puissantes dans la programmation fonctionnelle.  Avec leur aide, il est assez simple de concevoir des solutions en pensant √† l'extensibilit√© et √† la r√©utilisabilit√©. </p><br><p>  Depuis l'adoption du style il y a plusieurs mois, notre √©quipe a d√ª faire des efforts d'adaptation, mais au final, nous avons appr√©ci√© le r√©sultat.  Les nouveaux tests sont √©crits plus rapidement, les journaux rendent la vie beaucoup plus confortable et les ensembles de donn√©es sont pratiques pour v√©rifier chaque fois qu'il y a des questions sur les subtilit√©s de certaines logiques.  Notre √©quipe vise √† passer progressivement tous les tests √† ce nouveau style. </p><br><hr><br><p>  Lien vers la solution et un exemple complet peut √™tre trouv√© ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Github</a> .  Amusez-vous avec vos tests! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr465211/">https://habr.com/ru/post/fr465211/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr465189/index.html">√âquipe de d√©veloppement Workflow One Sprint</a></li>
<li><a href="../fr465191/index.html">Formation Cisco 200-125 CCNA v3.0. Jour 25. √âtude approfondie de l'IPv6</a></li>
<li><a href="../fr465193/index.html">Construire un projet Android dans un conteneur Docker</a></li>
<li><a href="../fr465203/index.html">√âl√©phant d'entreprise</a></li>
<li><a href="../fr465209/index.html">Nous apprenons les donn√©es du passeport d'une personne par son nom (s'il y a une garantie)</a></li>
<li><a href="../fr465215/index.html">Que lire chef d'√©quipe et station-service: une s√©lection de 50 livres avec notes et plus</a></li>
<li><a href="../fr465217/index.html">Acronis True Image 2020: nouveaux sch√©mas de r√©plication et protection am√©lior√©e</a></li>
<li><a href="../fr465221/index.html">√Ä quoi pourraient ressembler les registres dans 1C en pr√©sence de POO</a></li>
<li><a href="../fr465223/index.html">Comment faire un usage pratique de la s√©curit√© du papier, ou pourquoi avons-nous besoin de la conformit√© avec 152-–§–ó et PCI DSS dans un nuage</a></li>
<li><a href="../fr465227/index.html">R√©alit√© augment√©e dans le commerce en ligne</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>