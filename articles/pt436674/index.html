<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï† ü¶Ü ü§ñ Engenharia reversa Fantastic Dizzy üìú ‚ö±Ô∏è üí©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Fantastic Dizzy √© um jogo de plataformas criado em 1991 pela Codemasters. Ela faz parte da s√©rie Dizzy . Apesar do fato de que a s√©rie Dizzy ainda √© p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Engenharia reversa Fantastic Dizzy</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/436674/"> Fantastic Dizzy √© um jogo de plataformas criado em 1991 pela Codemasters.  Ela faz parte da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">s√©rie Dizzy</a> .  Apesar do fato de que a s√©rie Dizzy ainda √© popular e cria jogos amadores ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dizzy Age</a> ), parece que ningu√©m esteve envolvido no desenvolvimento reverso dos jogos originais. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/466/2bd/953/4662bd9537c41cceb388a841523b8669.png"></div><br>  Escrevi algumas ferramentas simples para extrair, visualizar e empacotar os recursos do jogo original.  Ferramentas postadas no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> . <br><br><h2>  Descompactando EXE </h2><br>  O arquivo bin√°rio PCDIZZY.EXE √© compactado no formato Microsoft <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">EXEPack</a> .  Embora existam muitas ferramentas Linux que podem descompactar esses execut√°veis, nenhum deles parece suportar a vers√£o usada para o Fantastic Dizzy.  Portanto, para descompactar o arquivo execut√°vel, usei a vers√£o DOS do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">UNP</a> .  Ap√≥s descompactar o arquivo execut√°vel, ele pode ser baixado no IDA.  Convenientemente, a vers√£o descompactada do arquivo bin√°rio ainda funcionava bem, para que pudesse ser depurada usando o depurador DOSBox. <br><a name="habracut"></a><br><h2>  Arquivos de dados </h2><br>  Existem dois arquivos de dados no jogo: DIZZY.NDX e DIZZY.RES.  Extens√µes, bem como tamanhos de arquivo, nos d√£o uma dica sobre o que elas podem conter.  O arquivo NDX tem aproximadamente 8 KB e o arquivo RES √© aproximadamente 800 KB.  Como o jogo √© escrito em C, podemos procurar chamadas abertas na IDA para ver onde os arquivos de dados s√£o abertos.  Nos jogos do DOS escritos em assembler, para isso, √© necess√°rio procurar instru√ß√µes int 21h (para abrir o arquivo ah = 3d).  O bin√°rio Dizzy cont√©m uma fun√ß√£o de wrapper em torno do fopen que permite especificar o nome principal e a extens√£o do arquivo.  Isso nos leva ao seguinte bloco de c√≥digo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d50/2a5/cdc/d502a5cdc3e09675a1edf6aac432ecc5.png"></div><br>  Carrega os arquivos DIZZY.RES e DIZZY.NDX e tamb√©m salva ponteiros de arquivo em vari√°veis ‚Äã‚Äãglobais.  Quando os bin√°rios do DOS s√£o de engenharia reversa, surge um problema irritante: os registros neles s√£o de 16 bits, mas em alguns casos os indicadores podem ser de 32 bits.  Aqui, os ponteiros FILE * t√™m tamanho de 32 bits e s√£o retornados de do_open_file para ax: dx.  Observe que as strings tamb√©m s√£o ponteiros de 32 bits e dizzy_basename √© passado para a fun√ß√£o de chamada na pilha (e essa confusa an√°lise autom√°tica de IDA - foi considerado um argumento de modo para fopen). <br><br>  Pesquisando as ocorr√™ncias de g_dizzy_res / ndx em refexs, voc√™ pode encontrar onde os arquivos s√£o lidos.  O depurador DOSBox √© √∫til neste momento, porque h√° uma alta probabilidade de muitas opera√ß√µes aleat√≥rias de leitura de arquivos e o uso do IDA para determinar as compensa√ß√µes de leitura seria um processo bastante mon√≥tono.  Uma boa orienta√ß√£o sobre como criar e usar o depurador DOSBox pode ser encontrada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Ao usar o IDA e o depurador DOSBox juntos, torna-se aparente que o arquivo NDX √© usado como um √≠ndice para o arquivo RES.  Cada entrada no arquivo NDX leva 16 bytes;  Ele armazena o identificador do fragmento, seu tamanho e deslocamento no arquivo RES.  Observando como os dados do RES s√£o lidos, voc√™ pode ver que o byte do sinalizador √© verificado primeiro no arquivo NDX.  Se o bit 0x80 n√£o estiver definido, os dados ser√£o lidos diretamente do arquivo RES, caso contr√°rio, um caminho de c√≥digo mais complexo ser√° executado.  O sinalizador √© definido para a maioria dos fragmentos, portanto, com um alto grau de probabilidade, podemos assumir que denota algum tipo de compacta√ß√£o usada para esses fragmentos. <br><br><h2>  Compress√£o </h2><br>  O caminho de compacta√ß√£o come√ßa lendo da base do fragmento RES duas palavras de 32 bits, indicando os tamanhos inicial e final e, em seguida, a fun√ß√£o de descompress√£o √© chamada.  Em 1991, a codifica√ß√£o simples de comprimento de execu√ß√£o (RLE) e a compacta√ß√£o de dicion√°rio eram populares, como v√°rios algoritmos Liv-Zempel.  O in√≠cio do ciclo de descompacta√ß√£o √© assim: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/244/d0e/e15/244d0ee1533c6191ad5b6aed18b97081.png"></div><br>  Os tokens para descompactar s√£o obtidos usando a fun√ß√£o get_next_token, que l√™ a pr√≥xima parte dos dados de origem em ax: dx com um deslocamento por cl.  O registro cl √© usado como a posi√ß√£o da troca de bits, retornando a zero ap√≥s atingir oito.  No in√≠cio do ciclo, o token √© lido e o bit inferior √© verificado.  Se o sinalizador estiver definido, o c√≥digo ser√° simples: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c43/1cb/a2b/c431cba2b710290e6dab47b4b711b6d1.png"></div><br>  Ele apenas salva o byte atual, recebe o pr√≥ximo token e continua a trabalhar.  Se o sinalizador estiver limpo, um caminho de c√≥digo mais longo √© selecionado, que termina com a instru√ß√£o rep movsb.  Isso indica que algum tipo de dicion√°rio √© usado na compacta√ß√£o. <br><br>  O algoritmo de compacta√ß√£o √© interessante por v√°rios motivos.  Em primeiro lugar, ele usa codifica√ß√£o de tamanho de bit vari√°vel.  O valor absoluto √© codificado como 1 sinalizador e um valor de dados de 8 bits.  Curiosamente, o fluxo de bits √© codificado como pouco endian.  Isso complica um pouco a an√°lise da descompress√£o, observando o arquivo RES em um editor hexadecimal.  Por exemplo, se os tr√™s primeiros bytes de um fragmento forem codificados como valores absolutos, os dados ser√£o organizados da seguinte maneira: <br><br><pre> <code class="hljs">: AAAAAAAA BBBBBBBB CCCCCCCC DDDDDDDD  1: 6543210F 7  2: 543210F 76  3: 43210F 765</code> </pre> <br>  Al√©m disso, o desempacotador pode pular o byte ao ler, se o contador cl voltar a zero ap√≥s o recebimento do pr√≥ximo token.  N√£o sei se isso √© otimiza√ß√£o, um bug ou um hack criado pelo desenvolvedor do jogo para corrigir o problema com minhas ferramentas. <br><br>  Se o sinalizador for limpo, o desempacotador realiza a c√≥pia da parte inicial dos dados desempacotados.  Nesse caso, os seguintes bits codificam o comprimento e o deslocamento do qual copiar.  O deslocamento √© codificado em 10 ou 13 bits e a op√ß√£o desejada indica o sinalizador.  Parece uma escolha muito estranha, porque complica um pouco o c√≥digo e, na melhor das hip√≥teses, economiza apenas 2 bits. <br><br>  Codificar o comprimento da s√©rie parece um pouco estranho.  O desempacotador l√™ os bits at√© atingir o bit zero.  Ent√£o, o n√∫mero de bits usado para codificar o comprimento √© dois mais o n√∫mero de bits diferentes de zero.  Por exemplo, ao codificar um comprimento de 58 (0x3a), o fluxo de bits fica assim: <br><br><pre> <code class="hljs">11110 111010</code> </pre> <br>  A codifica√ß√£o requer 11 bits.  Comprimentos pequenos s√£o melhor codificados porque o tamanho m√≠nimo de bit √© 2. C√≥pias de at√© 3 requerem apenas 3 bits para codifica√ß√£o, at√© 7 requerem 5 bits e assim por diante.  N√£o sei ao certo se esse tipo de codifica√ß√£o √© uma t√©cnica comum. <br><br>  O depurador DOSBox tamb√©m √© muito √∫til para reconstruir o algoritmo de descompress√£o.  Se voc√™ n√£o souber como devem ser os dados descompactados, ser√° dif√≠cil entender se o desempacotador funciona corretamente.  Usando o depurador, voc√™ pode percorrer todo o algoritmo de descompress√£o e salvar um despejo de mem√≥ria descompactada para compara√ß√£o. <br><br>  Outro recurso √∫til √© o sinalizador no arquivo NDX, indicando que o recurso est√° compactado.  Como o jogo original suporta recursos descompactados, podemos reembalar o arquivo RES sem a necessidade de um algoritmo de compacta√ß√£o.  Modificar e reembalar fragmentos com o lan√ßamento subsequente do jogo √© uma boa maneira de testar nossas suposi√ß√µes sobre os formatos de dados. <br><br><h2>  N√≠veis </h2><br>  Fantastic Dizzy √© um jogo com um mundo aberto.  N√≠veis s√£o √°reas com rolagem vertical ou horizontal.  O jogador se move entre os n√≠veis, chegando ao final do n√≠vel ou entrando e saindo de edif√≠cios.  Embora as refer√™ncias aos fragmentos no arquivo RES sejam feitas por meio de identificadores (IDs) de 16 bits, o arquivo bin√°rio do jogo realmente cont√©m uma tabela de nomes de n√≠veis correspondentes aos identificadores de fragmento.  Cada n√≠vel consiste em v√°rios fragmentos: um t√≠tulo, uma ou mais camadas, um conjunto de pe√ßas e uma paleta.  H√° pouca redund√¢ncia aqui, porque alguns n√≠veis usam a mesma paleta e conjunto de pe√ßas, mas n√£o reutilizam os mesmos fragmentos; portanto, o arquivo RES cont√©m muitos recursos duplicados. <br><br>  Camadas codificam blocos para um n√≠vel.  Para diferentes partes do mundo ou para camadas de fundo, voc√™ pode usar camadas adicionais.  Por exemplo, no n√≠vel do tree1.stg, existem oito camadas para diferentes partes do topo das √°rvores e uma camada de fundo comum.  No entanto, os n√≠veis subaqu√°ticos s√£o divididos em sea1.stg e sea2.stg, cada um com uma camada em primeiro plano e uma em segundo plano. <br><br>  As camadas de fundo s√£o fundos de largura fixa sem rolagem, por exemplo, uma floresta em uma parte de um jogo com copas de √°rvores.  Os blocos de primeiro e segundo plano, localizados na frente e atr√°s do personagem, s√£o codificados na mesma camada dos blocos em que voc√™ pode caminhar.  Por exemplo, a captura de tela mostra o n√≠vel das copas das √°rvores desde o in√≠cio do jogo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/466/2bd/953/4662bd9537c41cceb388a841523b8669.png"></div><br>  <i>N√≠vel das copas das √°rvores</i> <br><br>  √â a s√©tima camada do tree1.stg: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f5b/240/54a/f5b24054aa7e9ff6abb055a47c069109.png"></div><br>  <i>S√©timo n√≠vel da camada tree1.stg</i> <br><br>  Vale ressaltar que o jogador pode passar na frente da cabana, mas atr√°s de duas √°rvores.  Todas as informa√ß√µes de bloco est√£o contidas em uma matriz de mapa de bloco localizada em uma camada.  Os blocos nos fragmentos da camada s√£o codificados em dois bytes e os 9 bits inferiores s√£o usados ‚Äã‚Äãpara o √≠ndice do bloco.  N√£o entendi completamente os bits superiores, mas pelo menos eles cont√™m informa√ß√µes sobre a mudan√ßa da paleta para o bloco e, provavelmente, informa√ß√µes sobre colis√µes. <br><br>  Como n√≠veis no jogo, cenas, retratos de personagens e uma tela de controle de invent√°rio tamb√©m s√£o armazenados.  Parece que essa t√©cnica √© padr√£o para jogos do DOS, provavelmente porque minimiza a quantidade de c√≥digo necess√°ria. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/39a/4f6/1e9/39a4f61e972a82f34d44f5d5781345ad.png"></div><br>  <i>"N√≠vel" de gerenciamento de invent√°rio</i> <br><br><h2>  Sprites </h2><br>  O formato do sprite n√£o √© particularmente interessante.  Cada sprite √© um bitmap com um byte por pixel, mas com apenas 16 cores por sprite.  O uso de um n√∫mero limitado de cores era uma t√©cnica comum na era do VGA de 256 cores, porque para sprites era f√°cil executar a troca de paleta ou us√°-la em n√≠veis com outras paletas;  al√©m disso, economizou o espa√ßo alocado para sprites. <br><br>  Os sprites t√™m tamanhos diferentes, portanto, um fragmento separado cont√©m informa√ß√µes sobre o tamanho do sprite e seus deslocamentos em x e y.  Os sprites s√£o agrupados em conjuntos, mas o agrupamento parece bastante arbitr√°rio.  Por exemplo, um conjunto de sprites cont√©m gr√°ficos de prote√ß√£o de tela, objetos de invent√°rio e alguns personagens que n√£o s√£o jogadores.  Isso torna a visualiza√ß√£o de conjuntos de sprites um pouco complicada, porque a paleta n√£o √© a mesma para todos os sprites. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/107/fa0/1a2/107fa01a2c5bbd0ecd53df2ba4e70b43.png"></div><br>  <i>Sprites de Personagem do Jogador</i> <br><br><h2>  O que mais resta? </h2><br>  Resta fazer a engenharia reversa de mais algumas coisas.  Principalmente, estou interessado em formatos de arquivo de dados, mas h√° alguns aspectos que n√£o entendo: <br><br><ul><li>  Onde est√£o os locais dos objetos (chaves, frutas, etc.).  Parece que eles n√£o est√£o escritos em fragmentos de n√≠vel.  Talvez eles estejam armazenados no arquivo bin√°rio do jogo, porque o jogador pode pegar um objeto em um n√≠vel e jog√°-lo em outro. </li><li>  Como as colis√µes de n√≠vel funcionam.  Um jogador pode andar na frente ou atr√°s de alguns ladrilhos, e o piso pode ser plano ou inclinado. </li><li>  Como os n√≠veis est√£o conectados.  Esta informa√ß√£o pode ser armazenada no bin√°rio do jogo. </li><li>  A mudan√ßa da paleta para blocos nos n√≠veis n√£o est√° totalmente correta.  Alguns blocos exibem cores incorretas. </li><li>  Cada conjunto de sprites possui tr√™s fragmentos: cabe√ßalho, tabela e dados.  Fragmentos com uma tabela e dados s√£o claros para mim, mas algumas informa√ß√µes sobre sprites est√£o inclu√≠das no cabe√ßalho, por exemplo, o deslocamento em x e y.  N√£o entendi completamente o formato. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt436674/">https://habr.com/ru/post/pt436674/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt436660/index.html">O Roteiro do VS Code 2019 - DRAFT</a></li>
<li><a href="../pt436662/index.html">1 de fevereiro de 2019 - seu site pode parar de funcionar</a></li>
<li><a href="../pt436664/index.html">Apresentando o .NET Community Standup Series</a></li>
<li><a href="../pt436668/index.html">As estat√≠sticas podem ser lidas com uma pequena quantidade de dados?</a></li>
<li><a href="../pt436670/index.html">Como rolar atualiza√ß√µes na produ√ß√£o automaticamente</a></li>
<li><a href="../pt436676/index.html">Como fazer DDoS em todo o pa√≠s</a></li>
<li><a href="../pt436682/index.html">N√£o crie sua pr√≥pria JL (DSL) para expandir a funcionalidade do aplicativo</a></li>
<li><a href="../pt436684/index.html">Anivers√°rio Android 10 (Q). O que se sabe agora?</a></li>
<li><a href="../pt436686/index.html">JPEG do mundo 3D. O que √© glTF?</a></li>
<li><a href="../pt436688/index.html">A gigante de TI sai do mercado de chips para data centers - conte-nos o que isso significa para a ind√∫stria</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>