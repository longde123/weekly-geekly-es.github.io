<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òùüèΩ üë®üèº‚ÄçüöÄ ü§ñ La historia de un peque√±o estudio de c√≥digo heredado üé¨ ü§µüèø ü§∞üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Es bueno cuando hay alguien m√°s experimentado en el equipo que mostrar√° qu√© y c√≥mo hacer, qu√© rastrillo y qu√© √°ngulo est√°n esperando, y d√≥nde descarga...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>La historia de un peque√±o estudio de c√≥digo heredado</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450384/">  Es bueno cuando hay alguien m√°s experimentado en el equipo que mostrar√° qu√© y c√≥mo hacer, qu√© rastrillo y qu√© √°ngulo est√°n esperando, y d√≥nde descargar los mejores dibujos de bicicletas para 2007 en DVD.  Esta historia trata sobre c√≥mo se dio el deseo como v√°lido, cu√°l fue el resultado y c√≥mo se super√≥ la crisis. <br><br>  Esto sucedi√≥ en un momento en que, teniendo, me parec√≠a, una experiencia mediocre en el desarrollo, estaba buscando un lugar donde se pueda evolucionar (o mutar) de un no junior a un junior seguro.  En formas misteriosas del Se√±or, se encontr√≥ un lugar as√≠, se adjunt√≥ un proyecto al lugar y al programador de la "vieja escuela", que escribi√≥ m√°s que las ni√±as sobre su carrera en sistemas.  ‚ÄúGenial!  El proyecto, y por lo tanto hay dinero para la solicitud de propuesta, el mentor est√° adjunto, ¬°vivimos!  Pens√©, pero luego, como en la descripci√≥n de un horror t√≠pico, los h√©roes en la oscuridad oscura enfrentaron un horror terrible ... <br><a name="habracut"></a><br>  Primero lo primero: <br><br><h4>  1. El tama√±o importa </h4><br>  Comenzamos el desarrollo en un motor php que alguna vez fue propietario, utilizado para almacenar datos (aqu√≠ podr√≠a pensar MySQL \ PostgreSQL \ SQLite \ MongoDB \ Something-else-but-necesariamente-with-suffix DB-else- chicos, no entiendo, pero no lo adivinaron) api-gateway. <br><br>  ‚ÄúJaja, usando php, ¬øle adjuntas otra puerta de enlace api y almacenas datos en ella?  ¬øNo es m√°s f√°cil trabajar con api directamente desde js-code?  ¬øO utilizar DBMS + PHP?  - Preg√∫ntale al lector experimentado.  Y tendr√° raz√≥n.  Pero en ese momento, yo, que a√∫n no hab√≠a visto la especie, no lo cre√≠a, bueno, qui√©n sabe, los chicos geniales probablemente lo hacen, y los programadores de la "vieja escuela" lo saben mejor. <br><br>  Como me explicaron m√°s a fondo: <br><br><ol><li>  Gateway = seguridad, nadie entrar√° y saldr√° as√≠ </li><li>  Gateway = almacenamiento de datos seguro, simplemente no puede acceder a √©l, + copias de seguridad </li><li>  Gateway = velocidad, funciona r√°pidamente y sin fallas, probado en el tiempo </li><li>  El punto de vista autorizado de los programadores de la "vieja escuela" es que su php est√° lleno de agujeros, cualquier aplicaci√≥n web est√° pirateada de forma predeterminada, por lo que no hay nada para almacenar datos al lado </li></ol><br>  Una caracter√≠stica de la puerta de enlace api era que los datos json se transmit√≠an en una solicitud get.  S√≠, s√≠, esos encantadores objetos json, fueron sometidos a codificaci√≥n url y se colocaron en la cadena de consulta.  Y todo estar√≠a bien, cuando de repente un d√≠a ... la duraci√≥n de la solicitud de recepci√≥n dej√≥ de ser suficiente.  ¬°Est√∫pidamente, el json codificado en url, kanalya, no encajaba all√≠!  El programador de la "vieja escuela", rasc√°ndose la cabeza, pregunt√≥: <br>  ‚Äú¬øQu√© vamos a hacer?  Nuestro json ha crecido, pero no nos hemos dado cuenta ... " <br>  "Bueno, uh, ¬øtal vez los publicaremos en la publicaci√≥n?"  Suger√≠, por lo que parece ser m√°s correcto. <br>  "Ok, pase para publicar". <br>  Era como el n√∫mero uno. <br><br><h4>  2. Gesti√≥n de tiempo y respaldo </h4><br>  Para atornillar una nueva funcionalidad al proyecto, fue necesario implementar <br>  solicitudes CRUD correspondientes en la puerta de enlace, que es exactamente lo que realmente hizo nuestro compa√±ero de la "vieja escuela".  El problema era que hac√≠a esto una vez cada 3 d√≠as, dando "Hecho, cheque".  Los controles a veces mostraron que no todo funcion√≥, por ejemplo, obtener la lista est√° bien, agregar un nuevo elemento no est√° bien.  Tom√≥ alg√∫n tiempo arreglar y refinar, despu√©s de lo cual fue posible liberar la funcionalidad en el acceso masivo.  La propuesta de participar en la implementaci√≥n de consultas en la puerta de enlace usted mismo, porque es al menos m√°s r√°pida, fue rechazada, porque "es dif√≠cil all√≠, no lo entender√°".  El resultado de este enfoque fue el cierre del trabajo "sobre m√≠ mismo".  Si, por ejemplo, fue necesario arreglar algo en masa en la base de datos, entonces, eligiendo entre 3 d√≠as de espera y la implementaci√≥n de correcciones por medio de consultas, eleg√≠ la segunda opci√≥n.  A los clientes no les gustaba especialmente esperar, el nuevo lanzamiento vol√≥ de manera estable.  Una de esas introductorias, a saber, la colocaci√≥n masiva de un letrero a los usuarios de alg√∫n letrero, me fue encomendada para implementar, hubo una hora para todo sobre todo, las autoridades estaban esperando un hermoso informe.  Aqu√≠ nos espera atas n√∫mero dos-s. <br><br>  El hecho es que el formato de los datos json transmitidos en las solicitudes implicaba solo unos pocos campos obligatorios, todos los dem√°s eran arbitrarios, no exist√≠a una estructura clara y final.  Por ejemplo, para agregar un usuario, pas√© un json del formulario: <br><br><pre><code class="json hljs">POST /api/users { <span class="hljs-attr"><span class="hljs-attr">"email"</span></span>:<span class="hljs-string"><span class="hljs-string">"ivanov@mail.ru"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"myEmailIsVeryBig"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name_last"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name_first"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name_middle"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"birth"</span></span>:<span class="hljs-string"><span class="hljs-string">"01.01.1961"</span></span>, //     ,    -    <span class="hljs-attr"><span class="hljs-attr">"living_at"</span></span>:<span class="hljs-string"><span class="hljs-string">"., .3 .4 .24"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"phone_num"</span></span>:<span class="hljs-string"><span class="hljs-string">"+70000000000"</span></span> }</code> </pre> <br>  La parte opcional que se transmiti√≥ en las solicitudes de agregar / actualizar se guard√≥ y se proporcion√≥ en su totalidad (a continuaci√≥n, explicar√© c√≥mo se implement√≥).  La conclusi√≥n es que, el tiempo no se detiene, ser√≠a necesario resolver el problema: actualizar a los usuarios, colocar sus etiquetas.  ¬øPero no conduces toda la estructura cada vez?  Debe verificar!  Lo prob√© en m√≠ mismo: transmit√≠ solo un campo en la solicitud de actualizaci√≥n, verifiqu√©, apareci√≥ el campo, el resto de los datos est√° en su lugar.  El punto es peque√±o: realiza un bucle y actualiza el resto. <br><br>  El gui√≥n resopl√≥ suavemente, recibiendo y transmitiendo datos, y todo parec√≠a ir bien ... cuando de repente, una llamada.  "¬°No vemos el nombre de los usuarios en el sistema!"  - Informe desde ese extremo del cable.  "Vamos!  ¬°Pues funcion√≥!  - Un escalofr√≠o desagradable me recorri√≥ la espalda.  La investigaci√≥n adicional mostr√≥ que, de hecho, el nombre "" se indicaba en el nombre, aunque todos los dem√°s datos estaban en su lugar.  ¬øQu√© hacer en tal situaci√≥n?  Implementar copia de seguridad! <br><br>  Programador "camarada" de la vieja escuela ", ¬°sin problemas!  Necesita respaldo!  ¬øCu√°ndo se hace lo √∫ltimo relevante?  - pregunto <br><br>  "Uhh ... ya ver√© ...  No, no hay bakapa ". <br><br>  La situaci√≥n se salv√≥ por el hecho de que un par de horas antes finalic√© y prob√© el m√≥dulo con informes, tuve un csv-box con todos los datos necesarios, el pedido se restableci√≥ en otra hora. <br><br>  Falta de documentaci√≥n inteligible, descripciones de algoritmos de trabajo, verificaciones de validez de entrada y, lo m√°s importante, copias de seguridad de bases de datos, atas n√∫mero dos. <br><br>  Desde entonces, las copias de seguridad comenzaron a eliminarse todos los d√≠as. <br><br><h4>  3. Golpe profundo </h4><br>  Tembloroso, pero el trabajo se mov√≠a, los problemas se resolvieron, algunos m√°s r√°pido, otros m√°s lentamente, cuando de repente ... los clientes se dieron cuenta de que el sistema no era entendido por los servidores de otra persona, y por esa actitud hacia PD y la organizaci√≥n de actividades de ZI en ISPD No acariciar√°n la cabeza.  Es necesario transferir el servidor a usted mismo. <br><br>  ¬øPor qu√© el sistema no se transfiri√≥ originalmente?  El liderazgo ten√≠a una pasi√≥n: la centralizaci√≥n.  ¬°La gerencia so√±√≥ con un sistema que har√≠a todo!  ¬øNecesitas unir a un ni√±o a la escuela?  Entras al sistema, en una oficina especial, all√≠ env√≠as una solicitud.  Debe, por ejemplo, pedir una pizza: ingresa al sistema, a otra oficina especial, solicita pizza.  ¬øQuiz√°s quisiste comunicarte con hermosas damas / caballeros?  A su servicio hay un tercer gabinete especial: tambi√©n est√° presentando una solicitud all√≠, y as√≠ sucesivamente hasta el infinito. <br><br>  Ventajas: un nombre de usuario y contrase√±a para todo, los datos se almacenan de forma segura en la puerta de enlace.  Incluso hay copias de seguridad.  Y, f√≠jate, ¬°nadie nos quitar√° este sistema!  E incluso si se lo quita, ¬øqu√© sigue?  De todos modos, no entender√°n el sistema de protecci√≥n contra los programadores de la "vieja escuela": todo es complicado all√≠. <br><br>  VDS con el sistema fue descargado, atribuido a los clientes, lo implementaron, todos bailan y cantan, ¬°belleza! <br><br>  Y luego una ola de curiosidad y algunas sospechas me cubrieron. <br><br>  Si nuestra aplicaci√≥n web est√° llena de agujeros, ¬ød√≥nde est√°n los datos?  ¬øRealmente te has quedado en otros servidores?  ¬øY si deciden cerrar el sistema desde afuera, entonces todo colapsar√°? <br><br>  Una simple comprobaci√≥n mostr√≥ que los datos, as√≠ como los procesadores de la puerta de enlace, estaban en el mismo servidor.  Y no, no fueron transferidos all√≠ debido a la transferencia del servidor, siempre estuvieron all√≠. <br>  Ahora ten√≠a a esa disposici√≥n el desarrollo muy secreto de la "vieja escuela", que me puse a investigar.  Por supuesto, la ingenier√≠a inversa genial al estilo de los art√≠culos de la revista Hacker, con ollydbg, compensaciones y otras cosas interesantes no funcion√≥, as√≠ que estoy compartiendo lo que tengo. <br>  El desarrollo en s√≠ se implement√≥ en python, solo hab√≠a archivos .pyc que pod√≠an descompilarse f√°cilmente en c√≥digo legible.  Francamente, tom√≥ mucho tiempo, hasta 25 minutos, descubrir c√≥mo funciona. <br><br>  Entonces, el complejo sistema desarrollado por el programador de la "vieja escuela", que pocos pueden entender, consiste en: <br><br><ol><li>  El script procesado por Apache, que realmente recibi√≥ la solicitud.  ¬øQu√© hizo este gui√≥n?  Abri√≥ una conexi√≥n a un puerto localhost espec√≠fico y pas√≥ una solicitud all√≠ con todos sus datos.  Eso es todo.  Los intereses van m√°s all√°. </li><li>  La parte del servidor que proces√≥ las solicitudes del script.  La l√≥gica de sus acciones fue bastante interesante.  En primer lugar, no hab√≠a manipulaci√≥n de datos en el c√≥digo ni consultas en la base de datos; en su lugar, se llamaron a las funciones de la base de datos en PL \ SQL.  Toda l√≥gica, controles, etc., todo se estableci√≥ en la funci√≥n de base de datos.  El 50% de la secuencia de comandos era un diccionario que conten√≠a el nombre de la solicitud, la funci√≥n asociada a ella y los nombres de los par√°metros de la funci√≥n que deber√≠an corresponder a los datos pasados ‚Äã‚Äãen la l√≠nea de obtenci√≥n de solicitud.  Los datos JSON, si es necesario, se pasaron como un par√°metro separado.  Una caracter√≠stica de la organizaci√≥n de la parte del servidor fue la conexi√≥n de respaldo durante la autenticaci√≥n del usuario.  Si se encontr√≥ el nombre de usuario y la contrase√±a en la base de datos, se gener√≥ la ID de sesi√≥n y la instancia de conexi√≥n abierta se dobl√≥ en el diccionario (y se elimin√≥ por el tiempo de espera de 10 minutos para que no se eliminara; hab√≠a un m√©todo especial para extender la vida √∫til de la sesi√≥n), la clave era la ID de sesi√≥n, que est√° directamente en la base de datos no almacenado  ¬øC√≥mo se asocia exactamente la ID de sesi√≥n con los datos del usuario?  Despu√©s de todo, ¬øhay una solicitud de datos en la que no se transmite la ID de usuario?  Funciona, lo que significa que algo est√° mal aqu√≠. </li></ol><br>  Se dio un desarrollo muy dif√≠cil a la conciencia con dificultad y no tuvo prisa por revelar los secretos perdidos hace mucho tiempo de los maestros del pasado. <br><br>  Incre√≠ble (Ir a&gt; Definici√≥n, gracias a PhpStorm por comprender PL \ SQL), incomprensible para la mente del laico que sufre Verdadero conocimiento de la civilizaci√≥n perdida de los programadores de la vieja escuela.  En general, cuando se conectaba, se generaba una tabla temporal en la funci√≥n de verificaci√≥n de datos de autenticaci√≥n, en la que se almacenaba la identificaci√≥n del usuario. <br><br>  Esto fue solo el comienzo, se encontr√≥ una lista indicativa de vulnerabilidades graves: <br><br><ul><li>  DDoS utilizando autenticaci√≥n masiva (las conexiones estaban reservadas y, por lo tanto, descansaban en el l√≠mite de conexi√≥n DBMS, lo que, dada la posibilidad de extender el tiempo de vida de la sesi√≥n, hizo posible llenar completamente la memoria con conexiones, y el trabajo de los nuevos usuarios en el sistema ser√≠a imposible); </li><li>  falta de protecci√≥n contra la fuerza bruta (el n√∫mero de intentos fallidos de inicio de sesi√≥n no se detecta, no se almacena, no se verifica; </li><li>  falta de control sobre las acciones con entidades (por ejemplo, la lista de documentos solicitados por el usuario se emiti√≥ teniendo en cuenta la organizaci√≥n a la que est√° adjunto el usuario, y si conoce el ID del documento, puede completar con √©xito la solicitud para actualizar / eliminar el documento, y la lista de usuarios es buena incluso sin las contrase√±as, que, por cierto, se almacenaron en la base de datos en claro, sin hashing, podr√≠an ser recibidas por cualquier persona). </li></ul><br>  Y otro problema grave no es un esquema formal de almacenamiento de datos.  Como promet√≠ anteriormente, estoy hablando de almacenar "cualquier campo" de JSON.  No, no se almacenaron como una fila en la tabla.  Se dividieron en pares clave-valor y se almacenaron en una tabla separada.  Por ejemplo, para los usuarios hab√≠a 2 tablas, usuarios y usuarios_datos (clave de cadena, valor de cadena), donde los datos se almacenaron realmente.  El resultado de este enfoque fue un aumento en el tiempo con muestras complejas de la base de datos. <br><br>  En realidad, esto fue suficiente para tomar e implementar la decisi√≥n de transferir el sistema a una nueva API, comprensible, documentada y respaldada. <br><br><h4>  Moraleja </h4><br>  Quiz√°s este sistema es "Legacy", y el programador de la "vieja escuela" que lo cre√≥ es la esencia de Legacy. <br><br>  Sin embargo, las conclusiones son las siguientes: <br><br><ol><li>  Si le dicen "all√≠ es dif√≠cil, no lo entender√°", significa que hay un atas completo </li><li>  Si son aplastados por la autoridad, entonces algo es impuro </li><li>  Conf√≠e, pero verifique: la seguridad no es un estado, la seguridad es un proceso continuo, por lo tanto, es mejor verificar las cualidades declaradas de la realidad que descubrir m√°s tarde que todos los usuarios de repente se convirtieron en "Ivanov Ivanov Ivanitch", pero no hay bacaps. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/450384/">https://habr.com/ru/post/450384/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450368/index.html">Obtenga tasas absolutas de los tipos de cambio de divisas cruzados emparejados</a></li>
<li><a href="../450372/index.html">C√≥mo los algoritmos de Amazon determinan qui√©n es el momento de descartar</a></li>
<li><a href="../450374/index.html">Tarjeta de expansi√≥n RAM para Apple IIgs</a></li>
<li><a href="../450376/index.html">C√≥mo Yandex.Taxi busca autos cuando no est√°n</a></li>
<li><a href="../450378/index.html">GitLab 11.10</a></li>
<li><a href="../450386/index.html">Interfaces como tipos de datos abstractos en Go</a></li>
<li><a href="../450394/index.html">Investigaci√≥n de un archivo desconocido</a></li>
<li><a href="../450396/index.html">C√≥mo mejorar tu ingl√©s escrito: consejos pr√°cticos y herramientas √∫tiles</a></li>
<li><a href="../450398/index.html">Los venenos m√°s valientes</a></li>
<li><a href="../450410/index.html">Terraformer - Infraestructura para codificar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>