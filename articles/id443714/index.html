<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ò∫Ô∏è üî≤ ‚õîÔ∏è ControlValueAccessor dan contenteditable di Angular üèÑ üç≥ üíï</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pernahkah Anda bertanya-tanya bagaimana kombinasi bentuk Angular dan elemen HTML di mana pengguna memasukkan data bekerja? 


 Sejak awal kami menggun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ControlValueAccessor dan contenteditable di Angular</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/443714/"><p>  Pernahkah Anda bertanya-tanya bagaimana kombinasi bentuk Angular dan elemen HTML di mana pengguna memasukkan data bekerja? </p><br><p> Sejak awal kami menggunakan <code>ControlValueAccessor</code> , antarmuka khusus yang hanya terdiri dari 4 metode: </p><br><pre> <code class="javascript hljs">interface ControlValueAccessor { writeValue(value: any): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> registerOnChange(fn: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value: any</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> registerOnTouched(fn: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> setDisabledState(isDisabled: boolean)?: <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> }</code> </pre> <br><p>  Di luar kotak, Angular memiliki beberapa pengakses seperti itu: untuk kotak centang dan tombol radio, untuk input dan seleksi.  Namun, jika Anda mengembangkan obrolan di mana Anda perlu memberi kesempatan untuk menulis dalam huruf miring, membuat teks tebal atau, katakanlah, masukkan emotikon, Anda kemungkinan besar akan menggunakan atribut <code>contenteditable</code> untuk membuat konten yang diformat. </p><br><p>  Angular tidak mendukung penggunaan formulir bersama dengan <code>contenteditable</code> , jadi Anda harus menulis sendiri. </p><br><p><img src="https://habrastorage.org/webt/dj/hg/y5/djhgy57odnjfoa4fwxjmzhrxjtc.png"></p><a name="habracut"></a><br><h1 id="controlvalueaccessor">  ControlValueAccessor </h1><br><p>  Arahan yang kami tulis akan bekerja mirip dengan pengakses built-in - itu akan menanggapi atribut <code>contenteditable</code> .  Agar templat dan formulir reaktif menerimanya melalui injeksi dependensi, cukup untuk menyediakan <code>InjectionToken</code> : </p><br><pre> <code class="javascript hljs">@Directive({ <span class="hljs-attr"><span class="hljs-attr">selector</span></span>: <span class="hljs-string"><span class="hljs-string">'[contenteditable][formControlName],'</span></span> + <span class="hljs-string"><span class="hljs-string">'[contenteditable][formControl],'</span></span> + <span class="hljs-string"><span class="hljs-string">'[contenteditable][ngModel]'</span></span>, <span class="hljs-attr"><span class="hljs-attr">providers</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">provide</span></span>: NG_VALUE_ACCESSOR, <span class="hljs-attr"><span class="hljs-attr">useExisting</span></span>: forwardRef(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> ContenteditableValueAccessor), <span class="hljs-attr"><span class="hljs-attr">multi</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, ], }) <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContenteditableValueAccessor</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ControlValueAccessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  Antarmuka <code>ControlValueAccessor</code> membutuhkan 3 metode dan memiliki 1 metode opsional: </p><br><ul><li>  <code>registerOnChange</code> - sebuah fungsi akan masuk ke metode ini selama inisialisasi.  Itu disebut dengan nilai baru ketika pengguna telah memasukkan sesuatu ke dalam komponen kami sehingga data baru dimasukkan ke dalam kontrol. </li><li>  <code>registerOnTouched</code> - sebuah fungsi akan masuk ke metode ini selama inisialisasi.  Itu harus dipanggil ketika pengguna meninggalkan komponen kami agar kontrol menjadi <code>touched</code> .  Ini digunakan untuk validasi. </li><li>  <code>writeValue</code> - metode ini akan dipanggil oleh kontrol untuk meneruskan nilai ke komponen kami.  Ini digunakan jika nilai berubah melalui kode di luar ( <code>setValue</code> atau mengubah variabel yang terkait <code>ngModel</code> ), serta untuk mengatur nilai awal. <br><blockquote>  Perlu dicatat bahwa, tidak seperti bentuk reaktif, <code>ngModel</code> berperilaku <code>ngModel</code> - khususnya, nilai awal di dalamnya diinisialisasi dengan penundaan, dan metode <code>writeValue</code> "berkedut" dua kali, pertama kali dengan <code>null</code> : <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/angular/angular/issues/14988</a> <br></blockquote></li><li>  <code>setDisabledState</code> <em>(opsional)</em> - metode ini akan dipanggil oleh kontrol ketika keadaan <code>disabled</code> berubah.  Meskipun metode ini opsional, lebih baik untuk merespons ini di komponen Anda. </li></ul><br><h1 id="realizaciya-interfeysa">  Implementasi antarmuka </h1><br><p>  Untuk bekerja dengan elemen DOM, kita perlu <code>Renderer2</code> dan, pada kenyataannya, elemen itu sendiri, jadi tambahkan mereka ke konstruktor: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( @Inject(ElementRef) private readonly elementRef: ElementRef, @Inject(Renderer2) private readonly renderer: Renderer2, ) {}</code> </pre> <br><p>  Kami menyimpan metode yang akan diberikan kontrol kepada kami di bidang pribadi kelas: </p><br><pre> <code class="javascript hljs">private onTouched = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> {}; private onChange: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value: string</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> {}; registerOnChange(onChange: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value: string</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onChange = onChange; } registerOnTouched(onTouched: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onTouched = onTouched; }</code> </pre> <br><p>  keadaan <code>disabled</code> untuk komponen <code>contenteditable</code> setara dengan menonaktifkan mode edit - <code>contenteditable="false"</code> .  Menyetel nilai dari luar sama dengan mengganti DOM <code>innerHTML</code> elemen, dan memperbarui nilai oleh pengguna dan meninggalkan komponen dapat dipantau dengan berlangganan ke acara yang sesuai: </p><br><pre> <code class="javascript hljs">@HostListener(<span class="hljs-string"><span class="hljs-string">'input'</span></span>) onInput() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onChange(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.elementRef.nativeElement.innerHTML); } @HostListener(<span class="hljs-string"><span class="hljs-string">'blur'</span></span>) onBlur() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onTouched(); } setDisabledState(disabled: boolean) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.renderer.setAttribute( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.elementRef.nativeElement, <span class="hljs-string"><span class="hljs-string">'contenteditable'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>(!disabled), ); } writeValue(value: string) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.renderer.setProperty( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.elementRef.nativeElement, <span class="hljs-string"><span class="hljs-string">'innerHTML'</span></span>, value, ); }</code> </pre> <br><p>  Faktanya, itu saja.  Ini cukup untuk implementasi dasar pekerjaan bentuk Angular dan elemen yang dapat <code>contenteditable</code> . </p><br><h1 id="internet-explorer">  Penjelajah internet </h1><br><p>  Namun, ada beberapa tapi. </p><br><p>  Pertama, nilai awal kosong dari formulir adalah <code>null</code> , dan setelah <code>writeValue</code> di <code>writeValue</code> , kita akan melihat <code>null</code> di templat.  Untuk mengimplementasikan pekerjaan dengan benar, kita perlu menormalkan nilai: </p><br><pre> <code class="javascript hljs">writeValue(value: string | <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.renderer.setProperty( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.elementRef.nativeElement, <span class="hljs-string"><span class="hljs-string">'innerHTML'</span></span>, ContenteditableValueAccessor.processValue(value), ); } private <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> processValue(value: string | <span class="hljs-literal"><span class="hljs-literal">null</span></span>): string { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> processed = value || <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> processed.trim() === <span class="hljs-string"><span class="hljs-string">'&lt;br&gt;'</span></span> ? <span class="hljs-string"><span class="hljs-string">''</span></span> : processed; }</code> </pre> <br><p>  Di sini kita juga akan menangani situasi berikut.  Bayangkan bahwa konten suatu elemen memiliki tag HTML.  Jika kita hanya memilih semuanya dan menghapusnya, itu tidak akan kosong di dalamnya - tag <code>&lt;br&gt;</code> mandiri akan dimasukkan di sana.  Agar tidak menyumbat kontrol dengan nilai kosong, kami akan menganggapnya sebagai string kosong. </p><br><p>  Kedua, Internet Explorer tidak mendukung acara <code>input</code> untuk elemen yang dapat <code>contenteditable</code> .  Kami harus menerapkan fallback menggunakan <code>MutationObserver</code> : </p><br><pre> <code class="javascript hljs">private readonly observer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MutationObserver(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onChange( ContenteditableValueAccessor.processValue( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.elementRef.nativeElement.innerHTML, ), ); }); ngAfterViewInit() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.observer.observe(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.elementRef.nativeElement, { <span class="hljs-attr"><span class="hljs-attr">characterData</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">childList</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">subtree</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }); } ngOnDestroy() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.observer.disconnect(); }</code> </pre> <br><p>  Kami tidak akan menerapkan verifikasi pada browser tertentu.  Sebagai gantinya, kami segera menonaktifkan <code>MutationObserver</code> pada acara <code>input</code> pertama: </p><br><pre> <code class="javascript hljs">@HostListener(<span class="hljs-string"><span class="hljs-string">'input'</span></span>) onInput() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.observer.disconnect(); <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  Sekarang komponen kami berfungsi di IE11 dan kami puas dengan diri kami sendiri! </p><br><h1 id="internet-explorer-">  Internet Explorer!  ·Éö (‡≤† Áõä ‡≤† ·Éö) </h1><br><p>  Sayangnya, IE11 tidak akan ketinggalan.  Rupanya, ada bug dalam karya <code>MutationObserver</code> .  Jika ada tag di dalam elemen <code>contenteditable</code> , misalnya, <code>some &lt;b&gt;text&lt;/b&gt;</code> , maka ketika menghapus teks, yang akan berarti menghapus seluruh tag ( <code>text</code> kata dalam contoh ini), panggilan balik pengamat akan dipanggil <strong>sebelum real perubahan DOM!</strong> </p><br><p><img src="https://habrastorage.org/webt/6v/ny/ol/6vnyolxqyhmql3v12r4cu1kjpla.jpeg"></p><br><p>  Sayangnya, kami tidak punya pilihan selain mengakui kekalahan dan menggunakan <code>setTimeout</code> : </p><br><pre> <code class="javascript hljs">private readonly observer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MutationObserver(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onChange( ContenteditableValueAccessor.processValue( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.elementRef.nativeElement.innerHTML, ), ); }); });</code> </pre> <br><h1 id="vyvod">  Kesimpulan </h1><br><p>  Asalkan Angular harus mendukung Internet Explorer versi 9, 10 dan 11, menjadi jelas mengapa mereka tidak mengimplementasikan pekerjaan dengan <code>contenteditable</code> di rumah. </p><br><p>  Selain itu, Anda harus ingat bahwa HTML dapat berisi kode berbahaya - karena itu, jangan dengan berani mengambil konten yang tidak dikenal dan menempelkannya ke dalam kontrol, dan input pengguna harus dicek dalam acara <code>paste</code> dan <code>drop</code> .  Kode yang dijelaskan dalam artikel ini berfungsi di Angular 4 dan lebih tinggi, termasuk <code>FormHooks</code> .  Jika mau, Anda dapat menambahkan dukungan untuk Angular 2, jika Anda menggunakan <code>Renderer</code> , bukan <code>Renderer2</code> .  Kode sumber dan paket npm tersedia di tautan: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/TinkoffCreditSystems/angular-contenteditable-accessor</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.npmjs.com/package/@tinkoff/angular-contenteditable-accessor</a> </p><br><p>  Dan mainkan dengan contoh di sini: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://stackblitz.com/edit/angular2-contenteditable-value-accessor</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id443714/">https://habr.com/ru/post/id443714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id443700/index.html">Bagaimana kita memperbaiki struktur wawancara, dan apa yang terjadi</a></li>
<li><a href="../id443702/index.html">Bagaimana mendelegasikan laporan sederhana ke robot. Menulis bot dengan Python dan Google BigQuery</a></li>
<li><a href="../id443704/index.html">Menurut hasil IPO 2019, 5 ribu jutawan baru mungkin muncul di Lembah Silikon</a></li>
<li><a href="../id443708/index.html">Misi Chang'e 4 adalah hari ketiga di bulan. Rover "Yutu-2" untuk mencari ... batu</a></li>
<li><a href="../id443710/index.html">Java Challengers # 4: Membandingkan objek dengan equals () dan hashCode ()</a></li>
<li><a href="../id443716/index.html">"Aku punya cadangan di kaset saya." Kisah orang pertama</a></li>
<li><a href="../id443718/index.html">Game fantasi dengan 300 ribu balapan</a></li>
<li><a href="../id443720/index.html">Detail</a></li>
<li><a href="../id443722/index.html">Desain dan penamaan antrian</a></li>
<li><a href="../id443724/index.html">AMD Radeon VII: Chip High-End (Bagian 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>