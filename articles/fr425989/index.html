<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🤝‍👨🏻 👩🏾‍🤝‍👩🏻 🐜 Sous le capot de Graveyard Keeper: comment les effets graphiques sont mis en œuvre 🛀🏼 👲🏾 🤶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour à tous! Depuis 4 ans, je n'ai pas écrit en Habr. Ma dernière série de messages portait sur divers outils et astuces que nous avons utilisés su...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sous le capot de Graveyard Keeper: comment les effets graphiques sont mis en œuvre</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425989/">  Bonjour à tous!  Depuis 4 ans, je n'ai pas écrit en Habr.  Ma dernière <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">série de messages</a> portait sur divers outils et astuces que nous avons utilisés sur notre dernier jeu (en le développant sur Unity).  Depuis lors, nous avons sorti avec succès le jeu et en avons également sorti un nouveau.  Alors maintenant, vous pouvez expirer un peu et écrire de nouveaux articles qui peuvent être utiles à quelqu'un. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wb/qc/nc/wbqcnc2xkeiepxqphi3iphwnoo0.gif"></div><br>  Aujourd'hui, je veux parler des astuces graphiques et des astuces que nous avons utilisées pour créer l'image que vous voyez dans le GIF ci-dessus. <br><br>  Nous sommes très sensibles aux visuels de nos jeux et avons donc investi beaucoup de temps et d'efforts dans divers effets et autres goodies qui rendraient notre pixel art aussi attrayant que possible.  Peut-être que quelqu'un trouvera quelque chose d'utile pour lui-même. <br><br>  Pour commencer, je vais brièvement énumérer ce que l'image va être dans notre jeu: <a name="habracut"></a><br><br><ol><li>  Lumière ambiante variable - un changement banal de l'éclairage en fonction de l'heure de la journée. </li><li>  Correction des couleurs LUT - est responsable de changer le ton de l'image en fonction de l'heure de la journée (ou du type de zone). </li><li>  Sources lumineuses dynamiques - torches, poêles, lampes. </li><li>  Cartes normales - chargées de donner du volume aux objets, en particulier lors du déplacement de sources lumineuses. </li><li>  Mathématiques de la répartition de la lumière 3D - il est chargé de s'assurer que la source de lumière au centre de l'écran éclaire correctement un objet qui est plus haut, mais n'éclaire pas un objet qui est plus bas (c'est-à-dire tourné vers la caméra avec le côté éteint). </li><li>  Ombres - faites par des sprites, tournent et répondent à la position des sources de lumière. </li><li>  Simulation de la hauteur des objets - pour un affichage correct du brouillard. </li><li>  Autres décorateurs: pluie, vent, animations (y compris animation de shaders de feuillage et d'herbe), etc. </li></ol><br>  Maintenant plus en détail. <br><br><h2>  Lumière ambiante variable </h2><br>  Ici, en principe, rien de spécial.  La nuit - plus sombre, pendant la journée - plus clair.  La couleur de la lumière est définie par le gradient temporel.  La nuit, la source de lumière ne devient pas seulement plus sombre, mais acquiert une teinte bleue. <br><br>  Cela ressemble à ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kz/uc/z6/kzucz6juapnzkaxln72k6h6o5pk.png"></div><br><h2>  Correction des couleurs LUT </h2><br>  LUT (Look-up table) - tables d'échange de couleurs.  En gros, il s'agit d'un tableau RVB tridimensionnel où, à chaque nœud, il y a une valeur de couleur, qui doit être remplacée par celle correspondante.  Autrement dit, si un point rouge est situé aux coordonnées (1, 1, 1), cela signifie que toute la couleur blanche de l'image sera remplacée par du rouge.  Si les coordonnées (1, 1, 1) sont blanches (R = 1, G = 1, B = 1), alors il n'y a pas de changement.  Par conséquent, la LUT sans changement a une couleur pour chaque coordonnée correspondant à ces mêmes coordonnées.  C'est-à-dire  au point (0,4, 0,5, 0,8) est la couleur (R = 0,4, G = 0,5, B = 0,8). <br><br>  Eh bien, il convient de noter que pour plus de commodité, ils présentent une texture 3D en deux dimensions.  Par exemple, voici à quoi ressemble la LUT «par défaut» (sans changer le rendu des couleurs): <br><br><img src="https://habrastorage.org/webt/ev/dp/a_/evdpa_vrtx8qpwetg0a1lsbnvv4.png"><br><br>  Il est mis en œuvre de manière élémentaire, il fonctionne rapidement et facilement. <br><br>  Il est également très facile à configurer - vous donnez à l’artiste n’importe quelle image du jeu et vous dites «tonalité des couleurs pour que ce soit comme le soir».  Après cela, appliquez toutes les couches de correction des couleurs à la LUT par défaut et obtenez la LUT du soir. <br><br>  Dans notre cas, l'artiste est resté un peu coincé et a créé jusqu'à 10 LUT différentes pour différentes heures de la journée (nuit, crépuscule, soirée, etc.).  Voici à quoi ressemble leur configuration: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ra/rw/le/rarwlem4o5aoufvhb8vmficb-za.png"></div><br>  Par conséquent, selon l'heure de la journée, le même emplacement est différent: <br><br><img src="https://habrastorage.org/webt/k2/fz/1w/k2fz1wmhn9yw-rcgvticox4_bh4.png"><br><br>  Ici, la transparence des sprites lumineux des fenêtres change également en fonction de l'heure de la journée. <br><br><h3>  Sources lumineuses dynamiques et cartes normales </h3><br>  Les sources lumineuses sont utilisées de manière absolument ordinaire, de Unity.  De plus, des cartes normales sont dessinées pour chaque image-objet, ce qui vous permet d'avoir une idée du volume. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hy/dv/vf/hydvvfxlld52gux9o0mnz2gavbe.gif"></div><br>  De telles normales sont dessinées tout simplement.  L'artiste peint grossièrement une lumière avec un pinceau de 4 côtés: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0o/mv/jv/0omvjvscrffh1o8exichnqylnia.png"></div><br>  Et puis ce script va à la carte normale: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_4/md/oa/_4mdoakkf1puyp5lyvwjn6zmm-g.png"></div><br>  Si vous cherchez un shader (et un logiciel) qui fait cela, vous pouvez regarder dans la direction de Sprite Lamp. <br><br><h3>  Simulation de lumière 3D </h3><br>  C'est un peu plus compliqué.  Vous ne pouvez pas simplement prendre et mettre en évidence les sprites.  Nous devons nous demander si le sprite est "derrière" la source de lumière ou "devant". <br><br>  Faites attention à cette image: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/k1/tr/51/k1tr51sgx_4fmnzjkhtkv176ye0.png"></div><br>  Les deux arbres sont à la même distance de la source lumineuse, cependant, l'arbre distant est illuminé, et l'arbre le plus proche ne l'est pas (car sa partie non éclairée est tournée vers la caméra). <br><br>  J'ai résolu ce problème tout simplement.  Le shader calcule la distance le long de l'axe vertical y entre la source de lumière et le sprite.  Et s'il est positif (la source de lumière avant le sprite), alors nous illuminons le sprite comme d'habitude, mais s'il est négatif (le sprite bloque la source de lumière), mais l'intensité lumineuse décroît beaucoup à distance avec un très grand coefficient.  C'est précisément le coefficient qui a été fait, et pas seulement «pas d'éclairage», de sorte que lorsque la source lumineuse se déplace et apparaît soudainement derrière le sprite, le sprite ne devient pas instantanément noir, mais progressivement.  Mais encore assez rapidement. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vy/d7/cw/vyd7cwsfbrkbe4majwq81fynkck.gif"></div><br><h2>  Ombres </h2><br>  Les ombres sont faites par des sprites tournant autour d'un point.  J'ai essayé de leur ajouter plus de compression (skew), mais cela s'est avéré inutile. <br><br>  Au total, chaque objet peut avoir un maximum de 4 ombres.  L'une vient du Soleil et trois proviennent de sources lumineuses dynamiques.  L'image ci-dessous montre le principe: <br><br><img src="https://habrastorage.org/webt/8r/8_/u2/8r8_u21cgbiicmqpdvpjywl5rb4.png"><br><br>  La tâche «trouver les 3 prochaines sources de lumière et calculer la distance / l'angle des ombres par rapport à elles» est résolue par un script qui tourne dans Update.  Oui, ça ne marche pas très vite, car  il faut faire beaucoup de maths.  Si j'écrivais maintenant, j'utiliserais les nouveaux systèmes de travaux parallèles dans Unity.  Mais ce n'était pas encore le cas, j'ai donc optimisé autant que possible les scripts ordinaires. <br><br>  La seule chose qui compte, c'est que j'ai fait en sorte que la rotation du sprite ne se transforme pas, mais à l'intérieur du vertex shader.  C'est-à-dire  la rotation ne bouge pas.  C'est juste qu'un paramètre est défini dans le sprite (j'ai utilisé la couleur pour cela, car tout de même, toutes les ombres sont noires), et le shader est déjà responsable de la rotation du sprite.  C'est plus rapide car  ne pas avoir à tirer la géométrie dans Unity. <br><br>  Un autre inconvénient de cette approche est que les ombres doivent être configurées (et parfois peintes) individuellement pour chaque objet.  Certes, nous avons réussi, probablement, avec une dizaine de sprites différents plus ou moins universels (fins, épais, ovales, etc.). <br><br>  Le deuxième inconvénient est qu'il est parfois difficile de faire de l'ombre pour un objet dont le point de contact avec la terre est très allongé.  Par exemple, regardez l'ombre de la clôture: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mo/i2/dr/moi2drffv8hi9ynls99ve-gqjnc.gif"></div><br>  Pas parfait.  Voici à quoi cela ressemble si vous rendez le sprite de la clôture lui-même translucide: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7j/0t/fz/7j0tfz3lovxbfy2d2zu1afhtl_e.gif"></div><br>  Ici, cependant, il convient de noter que le sprite est toujours très déformé verticalement (le sprite d'ombre d'origine ressemble presque à un cercle).  C'est pourquoi son virage ressemble moins à un virage qu'à une distorsion. <br><br><h2>  Simulations de brouillard et de hauteur </h2><br>  Il y a du brouillard dans le jeu.  Il ressemble à ceci (ci-dessus est la version normale, ci-dessous est un brouillard extrême à 100% pour démontrer l'effet). <br><br><img src="https://habrastorage.org/webt/4i/2r/c_/4i2rc__pzbgrqecd4oq83piemsu.png"><br><br>  Comme vous pouvez le voir, les sommets des maisons et des arbres dépassent du brouillard.  En fait, obtenir cet effet était assez simple.  Le brouillard se compose de nombreux nuages ​​horizontaux répartis sur toute la profondeur de la scène.  Et en conséquence, il s'avère que la partie supérieure de tous les sprites est bloquée par moins de sprites de brouillard: <br><br><img src="https://habrastorage.org/webt/43/gd/gr/43gdgrxqrdisek50lynbramf4bc.png"><br><br><h2>  Le vent </h2><br>  Le vent du pixel art est une autre histoire.  Il n'y a pas beaucoup d'options.  Soit animer avec vos mains (ce qui est presque impossible avec notre quantité d'art), ou écrire un shader déformant, mais alors vous devez parfois subir de vilaines distorsions.  Bien sûr, vous ne pouvez pas animer du tout, mais l'image semble inanimée. <br><br>  Nous avons choisi l'option de distorsion en utilisant le shader.  Cela ressemble à ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cb/uh/nn/cbuhnnzyx14un9chz96mma0qmyq.gif"></div><br>  Si vous appliquez ce shader à une texture en damier, il devient clair ce qui se passe: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uo/ag/n5/uoagn5vbuxpeee_71sn-frkklyk.gif"></div><br>  Il convient également de noter que nous n'animons pas toute la couronne, mais uniquement des feuilles individuelles: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2s/iu/my/2siumyhll6pl84c_hn6ursn-cpe.png"></div><br>  Nous secouons également le blé dans le vent, mais tout est simple - le vertex shader déforme les coordonnées x, en tenant compte de la composante y.  Plus le point est élevé, plus le décalage est fort.  Ceci est fait de sorte que seul le haut chancelle, mais pas la racine.  De plus - la phase d'oscillation change des coordonnées x / y de sorte que différents sprites sur l'écran oscillent de manière aléatoire. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gy/ks/z6/gyksz6p4hodfgv4e-shli_gelyg.gif"></div><br>  Le même shader est également utilisé pour créer l'effet de balancer le blé et l'herbe lorsqu'un joueur les traverse. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sz/oo/q9/szooq97kmlmd9wmmlqnjohyyqdm.gif"></div><br>  C'est probablement tout pour l'instant.  Je n'ai pas intentionnellement abordé la question de la construction de la scène et de sa géométrie, car  c'est matière pour un article séparé.  Pour le reste, il a évoqué les principales solutions utilisées en développement. <br><br>  <b>PS:</b> Si quelqu'un est intéressé par certains aspects techniques, écrivez dans les commentaires.  Je vais peut-être le dire dans un article séparé.  À moins, bien sûr, que cela soit nécessaire. <br><br>  <b>PPS:</b> J'en profite pour dire que maintenant nous voulons trouver plusieurs personnes compétentes dans l'équipe (programmeur, PM, KM, artiste).  Les détails sont sur le site Web du studio.  J'espère que cette phrase n'a pas violé les règles. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr425989/">https://habr.com/ru/post/fr425989/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr425975/index.html">Convertir des mots et des phrases en anagramme</a></li>
<li><a href="../fr425977/index.html">Flexbox: quelle est la taille de cette boîte flexible?</a></li>
<li><a href="../fr425981/index.html">Carrière de débutant à LK: des bonds en avant pour progresser lentement</a></li>
<li><a href="../fr425983/index.html">Sécurité des vols</a></li>
<li><a href="../fr425985/index.html">Exécution de code personnalisé sur GO</a></li>
<li><a href="../fr425991/index.html">Comment nous avons créé l'hébergement</a></li>
<li><a href="../fr425993/index.html">Comment combler l'écart entre les sexes dans la technologie</a></li>
<li><a href="../fr425995/index.html">Visualisez FHIR - La norme informatique pour la médecine</a></li>
<li><a href="../fr425997/index.html">Cours MIT "Sécurité des systèmes informatiques". Conférence 11: Langage de programmation Ur / Web, partie 1</a></li>
<li><a href="../fr425999/index.html">Cours MIT "Sécurité des systèmes informatiques". Conférence 11: Langage de programmation Ur / Web, partie 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>