<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¼â€ğŸ¤â€ğŸ‘¨ğŸ» ğŸ‘©ğŸ¾â€ğŸ¤â€ğŸ‘©ğŸ» ğŸœ Sous le capot de Graveyard Keeper: comment les effets graphiques sont mis en Å“uvre ğŸ›€ğŸ¼ ğŸ‘²ğŸ¾ ğŸ¤¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour Ã  tous! Depuis 4 ans, je n'ai pas Ã©crit en Habr. Ma derniÃ¨re sÃ©rie de messages portait sur divers outils et astuces que nous avons utilisÃ©s su...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sous le capot de Graveyard Keeper: comment les effets graphiques sont mis en Å“uvre</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425989/">  Bonjour Ã  tous!  Depuis 4 ans, je n'ai pas Ã©crit en Habr.  Ma derniÃ¨re <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sÃ©rie de messages</a> portait sur divers outils et astuces que nous avons utilisÃ©s sur notre dernier jeu (en le dÃ©veloppant sur Unity).  Depuis lors, nous avons sorti avec succÃ¨s le jeu et en avons Ã©galement sorti un nouveau.  Alors maintenant, vous pouvez expirer un peu et Ã©crire de nouveaux articles qui peuvent Ãªtre utiles Ã  quelqu'un. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wb/qc/nc/wbqcnc2xkeiepxqphi3iphwnoo0.gif"></div><br>  Aujourd'hui, je veux parler des astuces graphiques et des astuces que nous avons utilisÃ©es pour crÃ©er l'image que vous voyez dans le GIF ci-dessus. <br><br>  Nous sommes trÃ¨s sensibles aux visuels de nos jeux et avons donc investi beaucoup de temps et d'efforts dans divers effets et autres goodies qui rendraient notre pixel art aussi attrayant que possible.  Peut-Ãªtre que quelqu'un trouvera quelque chose d'utile pour lui-mÃªme. <br><br>  Pour commencer, je vais briÃ¨vement Ã©numÃ©rer ce que l'image va Ãªtre dans notre jeu: <a name="habracut"></a><br><br><ol><li>  LumiÃ¨re ambiante variable - un changement banal de l'Ã©clairage en fonction de l'heure de la journÃ©e. </li><li>  Correction des couleurs LUT - est responsable de changer le ton de l'image en fonction de l'heure de la journÃ©e (ou du type de zone). </li><li>  Sources lumineuses dynamiques - torches, poÃªles, lampes. </li><li>  Cartes normales - chargÃ©es de donner du volume aux objets, en particulier lors du dÃ©placement de sources lumineuses. </li><li>  MathÃ©matiques de la rÃ©partition de la lumiÃ¨re 3D - il est chargÃ© de s'assurer que la source de lumiÃ¨re au centre de l'Ã©cran Ã©claire correctement un objet qui est plus haut, mais n'Ã©claire pas un objet qui est plus bas (c'est-Ã -dire tournÃ© vers la camÃ©ra avec le cÃ´tÃ© Ã©teint). </li><li>  Ombres - faites par des sprites, tournent et rÃ©pondent Ã  la position des sources de lumiÃ¨re. </li><li>  Simulation de la hauteur des objets - pour un affichage correct du brouillard. </li><li>  Autres dÃ©corateurs: pluie, vent, animations (y compris animation de shaders de feuillage et d'herbe), etc. </li></ol><br>  Maintenant plus en dÃ©tail. <br><br><h2>  LumiÃ¨re ambiante variable </h2><br>  Ici, en principe, rien de spÃ©cial.  La nuit - plus sombre, pendant la journÃ©e - plus clair.  La couleur de la lumiÃ¨re est dÃ©finie par le gradient temporel.  La nuit, la source de lumiÃ¨re ne devient pas seulement plus sombre, mais acquiert une teinte bleue. <br><br>  Cela ressemble Ã  ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kz/uc/z6/kzucz6juapnzkaxln72k6h6o5pk.png"></div><br><h2>  Correction des couleurs LUT </h2><br>  LUT (Look-up table) - tables d'Ã©change de couleurs.  En gros, il s'agit d'un tableau RVB tridimensionnel oÃ¹, Ã  chaque nÅ“ud, il y a une valeur de couleur, qui doit Ãªtre remplacÃ©e par celle correspondante.  Autrement dit, si un point rouge est situÃ© aux coordonnÃ©es (1, 1, 1), cela signifie que toute la couleur blanche de l'image sera remplacÃ©e par du rouge.  Si les coordonnÃ©es (1, 1, 1) sont blanches (R = 1, G = 1, B = 1), alors il n'y a pas de changement.  Par consÃ©quent, la LUT sans changement a une couleur pour chaque coordonnÃ©e correspondant Ã  ces mÃªmes coordonnÃ©es.  C'est-Ã -dire  au point (0,4, 0,5, 0,8) est la couleur (R = 0,4, G = 0,5, B = 0,8). <br><br>  Eh bien, il convient de noter que pour plus de commoditÃ©, ils prÃ©sentent une texture 3D en deux dimensions.  Par exemple, voici Ã  quoi ressemble la LUT Â«par dÃ©fautÂ» (sans changer le rendu des couleurs): <br><br><img src="https://habrastorage.org/webt/ev/dp/a_/evdpa_vrtx8qpwetg0a1lsbnvv4.png"><br><br>  Il est mis en Å“uvre de maniÃ¨re Ã©lÃ©mentaire, il fonctionne rapidement et facilement. <br><br>  Il est Ã©galement trÃ¨s facile Ã  configurer - vous donnez Ã  lâ€™artiste nâ€™importe quelle image du jeu et vous dites Â«tonalitÃ© des couleurs pour que ce soit comme le soirÂ».  AprÃ¨s cela, appliquez toutes les couches de correction des couleurs Ã  la LUT par dÃ©faut et obtenez la LUT du soir. <br><br>  Dans notre cas, l'artiste est restÃ© un peu coincÃ© et a crÃ©Ã© jusqu'Ã  10 LUT diffÃ©rentes pour diffÃ©rentes heures de la journÃ©e (nuit, crÃ©puscule, soirÃ©e, etc.).  Voici Ã  quoi ressemble leur configuration: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ra/rw/le/rarwlem4o5aoufvhb8vmficb-za.png"></div><br>  Par consÃ©quent, selon l'heure de la journÃ©e, le mÃªme emplacement est diffÃ©rent: <br><br><img src="https://habrastorage.org/webt/k2/fz/1w/k2fz1wmhn9yw-rcgvticox4_bh4.png"><br><br>  Ici, la transparence des sprites lumineux des fenÃªtres change Ã©galement en fonction de l'heure de la journÃ©e. <br><br><h3>  Sources lumineuses dynamiques et cartes normales </h3><br>  Les sources lumineuses sont utilisÃ©es de maniÃ¨re absolument ordinaire, de Unity.  De plus, des cartes normales sont dessinÃ©es pour chaque image-objet, ce qui vous permet d'avoir une idÃ©e du volume. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hy/dv/vf/hydvvfxlld52gux9o0mnz2gavbe.gif"></div><br>  De telles normales sont dessinÃ©es tout simplement.  L'artiste peint grossiÃ¨rement une lumiÃ¨re avec un pinceau de 4 cÃ´tÃ©s: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0o/mv/jv/0omvjvscrffh1o8exichnqylnia.png"></div><br>  Et puis ce script va Ã  la carte normale: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_4/md/oa/_4mdoakkf1puyp5lyvwjn6zmm-g.png"></div><br>  Si vous cherchez un shader (et un logiciel) qui fait cela, vous pouvez regarder dans la direction de Sprite Lamp. <br><br><h3>  Simulation de lumiÃ¨re 3D </h3><br>  C'est un peu plus compliquÃ©.  Vous ne pouvez pas simplement prendre et mettre en Ã©vidence les sprites.  Nous devons nous demander si le sprite est "derriÃ¨re" la source de lumiÃ¨re ou "devant". <br><br>  Faites attention Ã  cette image: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/k1/tr/51/k1tr51sgx_4fmnzjkhtkv176ye0.png"></div><br>  Les deux arbres sont Ã  la mÃªme distance de la source lumineuse, cependant, l'arbre distant est illuminÃ©, et l'arbre le plus proche ne l'est pas (car sa partie non Ã©clairÃ©e est tournÃ©e vers la camÃ©ra). <br><br>  J'ai rÃ©solu ce problÃ¨me tout simplement.  Le shader calcule la distance le long de l'axe vertical y entre la source de lumiÃ¨re et le sprite.  Et s'il est positif (la source de lumiÃ¨re avant le sprite), alors nous illuminons le sprite comme d'habitude, mais s'il est nÃ©gatif (le sprite bloque la source de lumiÃ¨re), mais l'intensitÃ© lumineuse dÃ©croÃ®t beaucoup Ã  distance avec un trÃ¨s grand coefficient.  C'est prÃ©cisÃ©ment le coefficient qui a Ã©tÃ© fait, et pas seulement Â«pas d'Ã©clairageÂ», de sorte que lorsque la source lumineuse se dÃ©place et apparaÃ®t soudainement derriÃ¨re le sprite, le sprite ne devient pas instantanÃ©ment noir, mais progressivement.  Mais encore assez rapidement. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vy/d7/cw/vyd7cwsfbrkbe4majwq81fynkck.gif"></div><br><h2>  Ombres </h2><br>  Les ombres sont faites par des sprites tournant autour d'un point.  J'ai essayÃ© de leur ajouter plus de compression (skew), mais cela s'est avÃ©rÃ© inutile. <br><br>  Au total, chaque objet peut avoir un maximum de 4 ombres.  L'une vient du Soleil et trois proviennent de sources lumineuses dynamiques.  L'image ci-dessous montre le principe: <br><br><img src="https://habrastorage.org/webt/8r/8_/u2/8r8_u21cgbiicmqpdvpjywl5rb4.png"><br><br>  La tÃ¢che Â«trouver les 3 prochaines sources de lumiÃ¨re et calculer la distance / l'angle des ombres par rapport Ã  ellesÂ» est rÃ©solue par un script qui tourne dans Update.  Oui, Ã§a ne marche pas trÃ¨s vite, car  il faut faire beaucoup de maths.  Si j'Ã©crivais maintenant, j'utiliserais les nouveaux systÃ¨mes de travaux parallÃ¨les dans Unity.  Mais ce n'Ã©tait pas encore le cas, j'ai donc optimisÃ© autant que possible les scripts ordinaires. <br><br>  La seule chose qui compte, c'est que j'ai fait en sorte que la rotation du sprite ne se transforme pas, mais Ã  l'intÃ©rieur du vertex shader.  C'est-Ã -dire  la rotation ne bouge pas.  C'est juste qu'un paramÃ¨tre est dÃ©fini dans le sprite (j'ai utilisÃ© la couleur pour cela, car tout de mÃªme, toutes les ombres sont noires), et le shader est dÃ©jÃ  responsable de la rotation du sprite.  C'est plus rapide car  ne pas avoir Ã  tirer la gÃ©omÃ©trie dans Unity. <br><br>  Un autre inconvÃ©nient de cette approche est que les ombres doivent Ãªtre configurÃ©es (et parfois peintes) individuellement pour chaque objet.  Certes, nous avons rÃ©ussi, probablement, avec une dizaine de sprites diffÃ©rents plus ou moins universels (fins, Ã©pais, ovales, etc.). <br><br>  Le deuxiÃ¨me inconvÃ©nient est qu'il est parfois difficile de faire de l'ombre pour un objet dont le point de contact avec la terre est trÃ¨s allongÃ©.  Par exemple, regardez l'ombre de la clÃ´ture: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mo/i2/dr/moi2drffv8hi9ynls99ve-gqjnc.gif"></div><br>  Pas parfait.  Voici Ã  quoi cela ressemble si vous rendez le sprite de la clÃ´ture lui-mÃªme translucide: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7j/0t/fz/7j0tfz3lovxbfy2d2zu1afhtl_e.gif"></div><br>  Ici, cependant, il convient de noter que le sprite est toujours trÃ¨s dÃ©formÃ© verticalement (le sprite d'ombre d'origine ressemble presque Ã  un cercle).  C'est pourquoi son virage ressemble moins Ã  un virage qu'Ã  une distorsion. <br><br><h2>  Simulations de brouillard et de hauteur </h2><br>  Il y a du brouillard dans le jeu.  Il ressemble Ã  ceci (ci-dessus est la version normale, ci-dessous est un brouillard extrÃªme Ã  100% pour dÃ©montrer l'effet). <br><br><img src="https://habrastorage.org/webt/4i/2r/c_/4i2rc__pzbgrqecd4oq83piemsu.png"><br><br>  Comme vous pouvez le voir, les sommets des maisons et des arbres dÃ©passent du brouillard.  En fait, obtenir cet effet Ã©tait assez simple.  Le brouillard se compose de nombreux nuages â€‹â€‹horizontaux rÃ©partis sur toute la profondeur de la scÃ¨ne.  Et en consÃ©quence, il s'avÃ¨re que la partie supÃ©rieure de tous les sprites est bloquÃ©e par moins de sprites de brouillard: <br><br><img src="https://habrastorage.org/webt/43/gd/gr/43gdgrxqrdisek50lynbramf4bc.png"><br><br><h2>  Le vent </h2><br>  Le vent du pixel art est une autre histoire.  Il n'y a pas beaucoup d'options.  Soit animer avec vos mains (ce qui est presque impossible avec notre quantitÃ© d'art), ou Ã©crire un shader dÃ©formant, mais alors vous devez parfois subir de vilaines distorsions.  Bien sÃ»r, vous ne pouvez pas animer du tout, mais l'image semble inanimÃ©e. <br><br>  Nous avons choisi l'option de distorsion en utilisant le shader.  Cela ressemble Ã  ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cb/uh/nn/cbuhnnzyx14un9chz96mma0qmyq.gif"></div><br>  Si vous appliquez ce shader Ã  une texture en damier, il devient clair ce qui se passe: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uo/ag/n5/uoagn5vbuxpeee_71sn-frkklyk.gif"></div><br>  Il convient Ã©galement de noter que nous n'animons pas toute la couronne, mais uniquement des feuilles individuelles: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2s/iu/my/2siumyhll6pl84c_hn6ursn-cpe.png"></div><br>  Nous secouons Ã©galement le blÃ© dans le vent, mais tout est simple - le vertex shader dÃ©forme les coordonnÃ©es x, en tenant compte de la composante y.  Plus le point est Ã©levÃ©, plus le dÃ©calage est fort.  Ceci est fait de sorte que seul le haut chancelle, mais pas la racine.  De plus - la phase d'oscillation change des coordonnÃ©es x / y de sorte que diffÃ©rents sprites sur l'Ã©cran oscillent de maniÃ¨re alÃ©atoire. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gy/ks/z6/gyksz6p4hodfgv4e-shli_gelyg.gif"></div><br>  Le mÃªme shader est Ã©galement utilisÃ© pour crÃ©er l'effet de balancer le blÃ© et l'herbe lorsqu'un joueur les traverse. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sz/oo/q9/szooq97kmlmd9wmmlqnjohyyqdm.gif"></div><br>  C'est probablement tout pour l'instant.  Je n'ai pas intentionnellement abordÃ© la question de la construction de la scÃ¨ne et de sa gÃ©omÃ©trie, car  c'est matiÃ¨re pour un article sÃ©parÃ©.  Pour le reste, il a Ã©voquÃ© les principales solutions utilisÃ©es en dÃ©veloppement. <br><br>  <b>PS:</b> Si quelqu'un est intÃ©ressÃ© par certains aspects techniques, Ã©crivez dans les commentaires.  Je vais peut-Ãªtre le dire dans un article sÃ©parÃ©.  Ã€ moins, bien sÃ»r, que cela soit nÃ©cessaire. <br><br>  <b>PPS:</b> J'en profite pour dire que maintenant nous voulons trouver plusieurs personnes compÃ©tentes dans l'Ã©quipe (programmeur, PM, KM, artiste).  Les dÃ©tails sont sur le site Web du studio.  J'espÃ¨re que cette phrase n'a pas violÃ© les rÃ¨gles. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr425989/">https://habr.com/ru/post/fr425989/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr425975/index.html">Convertir des mots et des phrases en anagramme</a></li>
<li><a href="../fr425977/index.html">Flexbox: quelle est la taille de cette boÃ®te flexible?</a></li>
<li><a href="../fr425981/index.html">CarriÃ¨re de dÃ©butant Ã  LK: des bonds en avant pour progresser lentement</a></li>
<li><a href="../fr425983/index.html">SÃ©curitÃ© des vols</a></li>
<li><a href="../fr425985/index.html">ExÃ©cution de code personnalisÃ© sur GO</a></li>
<li><a href="../fr425991/index.html">Comment nous avons crÃ©Ã© l'hÃ©bergement</a></li>
<li><a href="../fr425993/index.html">Comment combler l'Ã©cart entre les sexes dans la technologie</a></li>
<li><a href="../fr425995/index.html">Visualisez FHIR - La norme informatique pour la mÃ©decine</a></li>
<li><a href="../fr425997/index.html">Cours MIT "SÃ©curitÃ© des systÃ¨mes informatiques". ConfÃ©rence 11: Langage de programmation Ur / Web, partie 1</a></li>
<li><a href="../fr425999/index.html">Cours MIT "SÃ©curitÃ© des systÃ¨mes informatiques". ConfÃ©rence 11: Langage de programmation Ur / Web, partie 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>