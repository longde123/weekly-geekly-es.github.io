<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÖ üï∫ üßë OpenVPN com autentica√ß√£o e autoriza√ß√£o avan√ßadas üíÄ üë®üèø‚Äçüíª üë®üèæ‚Äçüè´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O artigo discute a configura√ß√£o do OpenVPN com recursos adicionais: 



- Certificados de token para autentica√ß√£o prim√°ria (Rutoken como exemplo) 
- B...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OpenVPN com autentica√ß√£o e autoriza√ß√£o avan√ßadas</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/433250/">  O artigo discute a configura√ß√£o do OpenVPN com recursos adicionais: <br><br><ul><li>  Certificados de token para autentica√ß√£o prim√°ria (Rutoken como exemplo) </li><li>  Back-end LDAP para autentica√ß√£o secund√°ria (usando o ActiveDirectory como exemplo) </li><li>  filtrando recursos internos dispon√≠veis para os usu√°rios (via iptables) </li></ul><br>  Tamb√©m descreve como configurar clientes para Linux, Windows e MacOS. <br><a name="habracut"></a><br><h3>  Configura√ß√£o do servidor </h3><br><h4>  Instale o OpenVPN </h4><br>  Pegue o script <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Nyr / openvpn-install</a> , execute a partir do root. <br><br><pre><code class="plaintext hljs">git clone https://github.com/Nyr/openvpn-install.git cd openvpn-install</code> </pre> <br>  O processo de inicializa√ß√£o far√° algumas perguntas. <br><br><ul><li>  protocolo udp </li><li>  porta 1194 </li><li>  Servidores DNS - Local </li><li>  endere√ßo de gateway IP externo na Internet atrav√©s do qual o servidor VPN estar√° dispon√≠vel </li></ul><br>  H√° tamb√©m uma vers√£o com seguran√ßa aprimorada do script original - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/Angristan/OpenVPN-install</a> .  Possui mais configura√ß√µes de criptografia com explica√ß√µes sobre o porqu√™. <br><br><h4>  Gerenciamento de usu√°rios </h4><br>  <b>Adicionando</b> <br>  Se os tokens n√£o forem usados, o usu√°rio ser√° adicionado atrav√©s do mesmo script.  O script basicamente gera uma configura√ß√£o ovpn personalizada e insere um certificado assinado pelo certificado raiz l√°. <br><br>  Se tokens forem usados ‚Äã‚Äã(consulte a se√ß√£o sobre tokens abaixo), o certificado ser√° gravado manualmente com base na solicita√ß√£o do certificado que √© gerado no token.  A configura√ß√£o do usu√°rio deve ser feita manualmente a partir do modelo existente (do mesmo a partir do qual o script de configura√ß√£o √© gerado).  O modelo est√° aqui <code>/etc/openvpn/client-common.txt</code> .  Ele n√£o est√° inclu√≠do no pacote openvpn e √© gerado pelo script durante o processo de configura√ß√£o. <br><br>  <b>Excluir</b> <br>  A remo√ß√£o de usu√°rios √© feita atrav√©s do mesmo script de instala√ß√£o.  O certificado √© adicionado √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CRL</a> , a nova CRL √© enviada por push ao servidor vpn.  O servidor considera todos os certificados que est√£o na CRL inv√°lidos e se recusa a aceitar. <br><br>  Como revogar um certificado manualmente: <br><br><pre> <code class="plaintext hljs">cd /etc/openvpn/easyrsa #   ./easyrsa revoke $CLIENT #   crl ./easyrsa gen-crl #   crl rm -rf /etc/openvpn/crl.pem #    cp /etc/openvpn/easy-rsa/pki/crl.pem /etc/openvpn/crl.pem # openvpn    crl,       nobody chown nobody:nobody /etc/openvpn/crl.pem</code> </pre><br><h4>  Filtrando hosts dispon√≠veis para clientes </h4><br>  Os clientes precisam ser limitados pelos hosts que eles podem acessar na rede quando se conectam ao openvpn. <br><br>  <b>Manualmente</b> <br><br>  A id√©ia √© pegar pacotes mesmo na interface <code>tun0</code> , na qual eles v√™m de clientes e filtr√°-los antes de entrar no NAT.  Ap√≥s o NAT, n√£o haver√° motivo para filtr√°-los - todos ter√£o um endere√ßo IP do servidor openvpn na rede interna.  Antes de entrar no NAT, os pacotes para cada usu√°rio t√™m seu pr√≥prio endere√ßo IP exclusivo (para a correspond√™ncia de endere√ßos IP e usu√°rios, consulte o arquivo <code>/etc/openvpn/ipp.txt</code> ). <br><br>  Pacotes que passam pelo sistema (n√£o v√™m diretamente dele e n√£o s√£o recebidos, ou seja, s√£o roteados pelo sistema) s√£o processados ‚Äã‚Äãpela tabela FORWARD.  As tabelas no iptables s√£o processadas de cima para baixo, se nenhuma das regras da tabela levar a uma decis√£o sobre o destino do pacote, a regra padr√£o ser√° acionada. <br><br>  Preparando a tabela FORWARD: <br><br><pre> <code class="plaintext hljs">#   iptables -F FORWARD #     FORWARD -    iptables -P FORWARD DROP #     iptables -I FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT</code> </pre><br>  Regras de exemplo para um cliente espec√≠fico.  Como a regra padr√£o da tabela √© DROP, resta apenas permitir os pares host + porta onde voc√™ puder.  Permitir acesso √† porta no host + executar ping no pr√≥prio host: <br><br><pre> <code class="plaintext hljs">iptables -I FORWARD -s 10.8.0.3 -i tun0 -d 10.0.2.3 -p tcp --dport 443 -j ACCEPT iptables -I FORWARD -s 10.8.0.3 -i tun0 -d 10.0.2.3 -p icmp --icmp-type echo-request -j ACCEPT</code> </pre><br>  No exemplo acima, o host 10.8.0.3 tem acesso permitido √† porta 443 do host 10.0.2.3. <br><br>  Como fechar o acesso: <br><br><pre> <code class="plaintext hljs">#         iptables -L FORWARD --line-numbers #     iptables -D FORWARD { }</code> </pre><br>  Ent√£o voc√™ precisa encontrar todas as regras para um cliente espec√≠fico e exclu√≠-las. <br><br>  Durante a depura√ß√£o, √© conveniente verificar quais regras funcionam.  Cada regra possui um contador de pacotes processados. <br><br><pre> <code class="plaintext hljs">#  ,      watch iptables -nvL FORWARD #     iptables -Z FORWARD</code> </pre><br>  <b>Automaticamente</b> <br><br>  Um servidor openvpn tem a capacidade de executar scripts para determinadas a√ß√µes.  Em particular, ao conectar e desconectar clientes.  Os scripts podem ser escritos em qualquer coisa, se forem execut√°veis.  Dentro do script, as vari√°veis ‚Äã‚Äãde ambiente transmitem todos os tipos de par√¢metros para a conex√£o atual.  Estamos interessados ‚Äã‚Äãem vari√°veis: <br><br><ul><li>  <code>common_name</code> (nome do propriet√°rio do certificado; o que leva ao campo de nome comum ao criar o certificado) </li><li>  <code>ifconfig_pool_remote_ip</code> (endere√ßo IP do cliente em tun0) </li><li>  <code>script_type</code> (qual evento aconteceu - conecte ou desconecte). </li></ul><br>  Voc√™ precisa de privil√©gios de root para gerenciar o iptables.  O Openvpn depois de conectar redefine os direitos a ningu√©m e executa scripts a partir dele.  √â ruim permitir que ningu√©m fa√ßa algo com o sudo e √© melhor n√£o usar um asterisco nas regras, mas de alguma forma voc√™ precisa permitir que o usu√°rio controle as tabelas de ip. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/sudoers.d/50_openvpn # #    nobody ALL = NOPASSWD: /sbin/iptables -A FORWARD* #     nobody ALL = NOPASSWD: /sbin/iptables -L FORWARD* #    nobody ALL = NOPASSWD: /sbin/iptables -D FORWARD*</span></span></code> </pre><br>  Na configura√ß√£o do servidor, voc√™ precisa adicionar permiss√£o para executar arquivos de terceiros e ativar dois ganchos respons√°veis ‚Äã‚Äãpor conectar e desconectar o usu√°rio. <br><br><pre> <code class="bash hljs">script-security 2 client-connect /etc/openvpn/bin/hosts.rb client-disconnect /etc/openvpn/bin/hosts.rb</code> </pre><br>  O pr√≥prio script, que l√™ as configura√ß√µes e aplica as regras para o iptables.  O script funciona com os mesmos princ√≠pios descritos na se√ß√£o anterior. <br><br><div class="spoiler">  <b class="spoiler_title">/openvpn/bin/hosts.rb</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/ruby # -*- coding: utf-8 -*- require 'pp' def log(string) puts 'hosts.rb: ' + string end def parse_config_file(name) config_path = "hosts/#{name}" unless File.exist?(config_path) puts "There is no specific configuration for #{name}." p name exit 0 end config_source = IO.read(config_path).split("\n") config = config_source.inject([]) do |result,line| ip, port, protocol = line.split(/\s+/) result &lt;&lt; { ip: ip, port: port, protocol: protocol || 'tcp' } end end def get_config(name) user_config = parse_config_file(name) if user_config everybody_config = parse_config_file('everybody') end everybody_config + user_config end def apply_rule(rule) command = "sudo iptables #{rule}" log(command) system(command) end def remove_rule(number) command = "sudo iptables -D FORWARD #{number}" log(command) system(command) end def allow_target(source_ip, options) #         . apply_rule("-A FORWARD -s #{source_ip} -i tun0 -d #{options[:ip]} -p #{options[:protocol]} --dport #{options[:port]} -j ACCEPT") #       apply_rule("-A FORWARD -s #{source_ip} -i tun0 -d #{options[:ip]} -p icmp --icmp-type echo-request -j ACCEPT") end def clear_targets(source_ip) #      FORWARD,  source_ip. rules_exist = true while rules_exist table = `sudo iptables -L FORWARD --line-number`.split("\n") the_line = table.find do |line| fields = line.split(/\s+/) ip = fields[4] ip == source_ip end if the_line number = the_line.split(/\s+/)[0] remove_rule(number) else rules_exist = false end end end ################################################################################ script_type = ENV['script_type'] log(script_type) name = ENV['common_name'] source_ip = ENV['ifconfig_pool_remote_ip'] case script_type when 'client-connect' config = get_config(name) config.each{|target| allow_target(source_ip, target)} when 'client-disconnect' clear_targets(source_ip) else puts "Unknown script type #{script_type}." end</span></span></code> </pre></div></div><br>  As regras s√£o armazenadas em arquivos correspondentes ao nome comum dos certificados na pasta <code>/etc/openvpn/hosts</code> .  Eles especificam exatamente quais endere√ßos IP est√£o dispon√≠veis para um cliente espec√≠fico.  Separador - um n√∫mero arbitr√°rio de espa√ßos.  O endere√ßo IP, a porta e o protocolo (tcp ou udp) s√£o gravados atrav√©s do separador. <br><br><pre> <code class="bash hljs">10.0.0.24 53 udp 10.0.0.25 53 udp 10.0.2.3 443 tcp</code> </pre><br>  Como resultado, a seguinte estrutura deve <code>/etc/openvpn</code> na pasta <code>/etc/openvpn</code> <br><br>  ‚îú‚îÄ‚îÄ bin <br>  Hosts ‚îî‚îÄ‚îÄ hosts.rb <br>  Hosts‚îÄ‚îÄ anfitri√µes <br>  ‚îÇ ‚îú‚îÄ‚îÄ user1 <br>  2 ‚îú‚îÄ‚îÄ user2 <br>  Everybody ‚îî‚îÄ‚îÄ todo mundo <br>  Server‚îÄ‚îÄ server.conf <br>  ‚îî‚îÄ‚îÄ ... <br><br>  <code>User1</code> e <code>user2</code> s√£o arquivos no formato acima.  Eles descrevem a quais hosts o usu√°rio com o nome comum correspondente tem acesso. <br><br>  H√° outro arquivo <code>everybody</code> adicional, ele cont√©m regras que se aplicam a todos os clientes, desde que exista um arquivo de configura√ß√£o separado para esses clientes.  Ou seja, se o usu√°rio tiver uma lista de hosts para onde ele pode ir, essa lista e os hosts listados em <code>everybody</code> aplicados.  Caso contr√°rio, <code>everybody</code> n√£o <code>everybody</code> aplic√°vel.  Por exemplo, √© conveniente colocar um servidor DNS nesse arquivo. <br><br>  <b>Registo</b> <br><br>  O script de instala√ß√£o inclui apenas o registro de conex√µes atuais (par√¢metro <code>status)</code> .  Para que um log comum apare√ßa, voc√™ precisa adicionar uma linha √† configura√ß√£o do servidor ( <code>/etc/openvpn/server.conf</code> ): <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-append /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/openvpn.log</code> </pre> <br><br>  <b>LDAP</b> <br><br>  Existe um plugin <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">openvpn-auth-ldap</a> que permite autenticar um usu√°rio novamente via LDAP. <br><br>  Entrega do pacote: <br><br><pre> <code class="plaintext hljs">sudo yum install openvpn-auth-ldap</code> </pre> <br>  Adicione ao server.conf: <br><br><pre> <code class="plaintext hljs">plugin /usr/lib64/openvpn/plugin/lib/openvpn-auth-ldap.so "/etc/openvpn/ldap.conf"</code> </pre> <br>  Crie uma configura√ß√£o para o ldap no <code>/etc/openvpn/ldap.conf</code> : <br><pre> <code class="plaintext hljs">&lt;LDAP&gt; URL ldaps://{LDAP_DOMAIN_HERE} Timeout 15 TLSEnable no FollowReferrals yes BindDN "BIND_DN_HERE" Password "BIND_PASSWORD_HERE" &lt;/LDAP&gt; &lt;Authorization&gt; BaseDN "{BASE_DN_HERE}" SearchFilter "(&amp;(sAMAccountName=%u)(objectClass=organizationalPerson)(objectCategory=person)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))" RequireGroup false &lt;/Authorization&gt;</code> </pre><br>  Adicione a linha √† configura√ß√£o ovpn personalizada: <br><br><pre> <code class="plaintext hljs">auth-user-pass</code> </pre> <br>  Assim, primeiro o usu√°rio ser√° solicitado a fornecer o nome de usu√°rio e a senha do dom√≠nio, depois o PIN do token.  Se uma dessas etapas falhar, a conex√£o n√£o ser√° estabelecida. <br><br>  A descri√ß√£o das op√ß√µes para o ldap.conf <a href="">est√° no reposit√≥rio do plug-in</a> .  Ele suporta autentica√ß√£o por associa√ß√£o ao grupo, mas eu n√£o o testei. <br><br><h4>  Velocidade </h4><br>  O maior aumento na velocidade fornece a inclus√£o do modo udp.  Isso √© recomendado em todos os manuais.  O ponto √© que n√£o faz sentido iniciar uma conex√£o de cliente tcp em um canal tcp.  Um tcp no cliente √© suficiente para fazer a entrega correta dos pacotes.  Se os pacotes forem perdidos no canal udp, a conex√£o tcp do cliente controlar√° o ajuste de entrega. <br><br>  A velocidade aumentar√° pelo menos porque n√£o h√° necessidade de aguardar a confirma√ß√£o da entrega de cada pacote no canal.  H√° um segundo problema com o tcp - um pacote tcp do cliente provavelmente n√£o se encaixa em um pacote do canal vpn.  O MTU √© o mesmo, mas os cabe√ßalhos precisam ser adicionados ao pacote do cliente.  Como resultado, voc√™ deve enviar dois pacotes dentro do canal vpn por pacote de usu√°rio. <br><br>  O TCP faz sentido usar quando √© imposs√≠vel de outra maneira.  Por exemplo, quando o vpn funciona atrav√©s do canal ssh. <br><br><h4>  Exemplo de uma configura√ß√£o completa do servidor </h4><br><div class="spoiler">  <b class="spoiler_title">example-server.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">port 1194 proto tcp dev tun sndbuf 0 rcvbuf 0 ca ca.crt cert server.crt key server.key dh dh.pem tls-auth ta.key 0 topology subnet server 10.8.0.0 255.255.255.0 ifconfig-pool-persist ipp.txt push "redirect-gateway def1 bypass-dhcp" push "dhcp-option DNS 10.0.0.25" push "dhcp-option DNS 10.0.0.24" keepalive 10 120 cipher AES-256-CBC comp-lzo user nobody group nobody persist-key persist-tun status openvpn-status.log verb 3 crl-verify crl.pem log-append /var/log/openvpn.log script-security 2 client-connect /etc/openvpn/bin/hosts.rb client-disconnect /etc/openvpn/bin/hosts.rb</code> </pre><br></div></div><br><h3>  Configura√ß√£o de token </h3><br><h4>  Biblioteca PKCS # 11 </h4><br>  Para trabalhar com tokens, voc√™ precisa de uma biblioteca especial.  A biblioteca √© necess√°ria para criar pares de chaves e para a conex√£o real.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Baixe para todas as plataformas pelo link</a> . <br><br>  Onde quer que o librtpkcs11ecp.so seja encontrado posteriormente - esta √© a pr√≥pria biblioteca que precisa ser baixada e colocada em algum lugar em um local conveniente. <br><br><h4>  Criando um certificado em um token </h4><br>  Gere um par de chaves no token.  O par√¢metro id aqui √© o n√∫mero de s√©rie do slot no token onde o par de chaves se encaixa. <br><br><pre> <code class="plaintext hljs">pkcs11-tool --module /usr/lib64/librtpkcs11ecp.so --keypairgen --key-type rsa:2048 -l --id 01</code> </pre><br>  Fa√ßa uma solicita√ß√£o de certificado para a chave p√∫blica.  No processo de cria√ß√£o de uma solicita√ß√£o de certificado, a vida √∫til do certificado e o nome comum s√£o definidos, usados ‚Äã‚Äãpara filtrar os endere√ßos IP dispon√≠veis na rede.  O nome comum deve corresponder ao logon no ActiveDirectory para que n√£o haja confus√£o. <br><br><pre> <code class="plaintext hljs">openssl openssl&gt; engine -t dynamic -pre SO_PATH:/usr/lib64/openssl/engines/pkcs11.so -pre ID:pkcs11 -pre LIST_ADD:1 -pre LOAD -pre MODULE_PATH:/usr/lib64/librtpkcs11ecp.so openssl&gt; req -engine pkcs11 -new -key slot_0-id_01 -keyform engine -out /home/john/good.req</code> </pre><br>  A solicita√ß√£o recebida deve ser movida para a <code>/etc/openvpn/easy-rsa/pki/reqs/</code> .  A extens√£o do arquivo deve ser necess√°ria. <br>  Convertendo uma solicita√ß√£o em um certificado: <br><br><pre> <code class="plaintext hljs">cd /etc/openvpn/easy-rsa/ ./easyrsa sign-req client good</code> </pre><br>  Depois disso, um certificado com o mesmo nome, mas com a extens√£o <code>crt</code> , aparecer√° na pasta <code>/etc/openvpn/easy-rsa/pki/issued/</code> . <br><br>  Antes da grava√ß√£o, o certificado deve ser convertido em DER: <br><br><pre> <code class="plaintext hljs">openssl x509 -in /home/user/user-cert.pem -out /home/user/user-cert.crt -outform DER</code> </pre><br>  Escrevendo um certificado para um token: <br><br><pre> <code class="plaintext hljs">pkcs11-tool --module /usr/lib/librtpkcs11ecp.so -l -y cert -w /home/user/user-cert.crt --id 45 --label TEST</code> </pre> <br>  Est√° escrito com base no artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚ÄúUsando o Rutoken EDS com OpenSSL (RSA)‚Äù</a> . <br><br><h4>  Usando token para autentica√ß√£o </h4><br>  Localize o ID do certificado a ser apresentado ao servidor: <br><br><pre> <code class="plaintext hljs">$ openvpn --show-pkcs11-ids /usr/lib64/librtpkcs11ecp.so The following objects are available for use. Each object shown below may be used as parameter to --pkcs11-id option please remember to use single quote mark. Certificate DN: /CN=User1 Serial: 490B82C4000000000075 Serialized id: aaaa/bbb/41545F5349474E415455524581D2A1A1B23C4AA4CB17FAF7A4600</code> </pre><br>  Estamos interessados ‚Äã‚Äãno ID serializado aqui. <br><br>  Op√ß√µes que devem ser inseridas na configura√ß√£o ovpn para que os tokens sejam selecionados: <br><br><pre> <code class="plaintext hljs">pkcs11-providers /usr/lib64/librtpkcs11ecp.so pkcs11-id 'aaaa/bbb/41545F5349474E415455524581D2A1A1B23C4AA4CB17FAF7A4600'</code> </pre> <br>  A op√ß√£o <code>pkcs11-id</code> <b>deve estar entre aspas simples.</b> <br><br>  Este manual faz sentido em todas as plataformas.  Voc√™ precisa especificar o caminho para a biblioteca e o ID do certificado no token.  A biblioteca pode ser chamada de maneira um pouco diferente, seja <code>.dll</code> , n√£o <code>.so</code> , mas o significado √© o mesmo. <br><br>  Nesse caso, voc√™ precisa remover as se√ß√µes <code>cert</code> e <code>key</code> do arquivo ovpn, porque o certificado e a chave privada ser√£o retirados do token. <br><br>  A configura√ß√£o completa do cliente (para Windows) fica assim: <br><br><div class="spoiler">  <b class="spoiler_title">client.ovpn</b> <div class="spoiler_text"> <code>client <br> dev tun <br> proto tcp <br> sndbuf 0 <br> rcvbuf 0 <br> remote 78.47.37.247 22222 <br> resolv-retry infinite <br> nobind <br> persist-key <br> persist-tun <br> remote-cert-tls server <br> cipher AES-256-CBC <br> comp-lzo <br> setenv opt block-outside-dns <br> key-direction 1 <br> verb 3 <br> <br> pkcs11-providers "c://Windows//System32//rtPKCS11ECP.dll" <br> pkcs11-id 'Aktiv\x20Co\x2E/Rutoken\x20ECP/342b871d/Rutoken/01' <br> <br> -----BEGIN CERTIFICATE----- <br> {CERT_HERE} <br> -----END CERTIFICATE----- <br> <br> <br> &lt;tls-auth&gt; <br> # <br> # 2048 bit OpenVPN static key <br> # <br> -----BEGIN OpenVPN Static key V1----- <br> {KEY_HERE} <br> -----END OpenVPN Static key V1----- <br> &lt;/tls-auth&gt;</code> <br> </div></div><br>  Escrito com base em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Como adicionar autentica√ß√£o de fator duplo a uma configura√ß√£o OpenVPN usando cart√µes inteligentes do lado do cliente"</a> . <br><br><h3>  Configura√ß√£o do cliente </h3><br><h4>  Linux </h4><br>  O Openvpn possui um bug que impede o usu√°rio de inserir o c√≥digo PIN a partir do token, se o pacote for constru√≠do com o suporte ao systemd.  Como o systemd est√° em toda parte ultimamente, todos os pacotes que j√° est√£o dispon√≠veis nos reposit√≥rios s√£o compilados com seu suporte.  Clientes no Linux precisam coletar o pacote por conta pr√≥pria.  Aqui est√° um exemplo de configura√ß√£o que funcionou para mim no Arch Linux: <br><br><pre> <code class="plaintext hljs">./configure \ --prefix=/usr \ --sbindir=/usr/bin \ --enable-iproute2 \ --enable-pkcs11 \ --enable-plugins \ --enable-x509-alt-username</code> </pre><br>  Voc√™ pode verificar se o openvpn foi criado com ou sem systemd usando o seguinte comando: <br><br><pre> <code class="plaintext hljs">openvpn --version | grep --color enable_systemd</code> </pre><br><h4>  Mas os </h4><br>  No Mac OS, existe apenas um cliente gratuito - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tunnelblink</a> . <br><br>  Ele n√£o sabe como inserir um c√≥digo PIN a partir de um token da GUI.  O erro √© descrito, por exemplo, aqui - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://groups.google.com/forum/#!topic/tunnelblick-discuss/f_Rp_2nV-x8</a> Ignorado iniciando o openvpn a partir do console.  Isso n√£o √© surpreendente, j√° que o cliente oficial do Windows tamb√©m n√£o sabe disso. <br><br>  Tamb√©m no Mac OS (ao contr√°rio do Windows), s√£o necess√°rios scripts adicionais para configurar a rede.  Se voc√™ simplesmente executar o openvpn a partir do console, o DNS n√£o funcionar√° (talvez algo mais, apenas o DNS aparecer√°). <br><br>  O TunnelBlick possui esses scripts de configura√ß√£o de rede, eles s√≥ precisam ser chamados ao estabelecer e desconectar a conex√£o.  O que voc√™ precisa adicionar √† configura√ß√£o ovpn: <br><br><pre> <code class="bash hljs">script-security 2 up <span class="hljs-string"><span class="hljs-string">"/Applications/Tunnelblick.app/Contents/Resources/client.up.tunnelblick.sh -9 -d -f -m -w -ptADGNWradsgnw"</span></span> down <span class="hljs-string"><span class="hljs-string">"/Applications/Tunnelblick.app/Contents/Resources/client.down.tunnelblick.sh -9 -d -f -m -w -ptADGNWradsgnw"</span></span></code> </pre> <br>  Um script de exemplo para iniciar uma conex√£o openvpn, que pode ser colocada na √°rea de trabalho e cutucada com o mouse: <br><br><pre> <code class="plaintext hljs">#!/bin/bash tunnelblick=/Applications/Tunnelblick.app/Contents/Resources/openvpn/openvpn-2.4.2-openssl-1.0.2k sudo $tunnelblick/openvpn --config $tunnelblick/user.ovpn</code> </pre><br><h4>  Windows </h4><br>  Sob as janelas, tudo parece funcionar.  O cliente oficial n√£o sabe como inserir o c√≥digo PIN a partir do token, ele consegue abrir o VPN manualmente √† m√£o no console. <br><br>  O mais importante √© fazer tudo sob o administrador.  Execute o instalador do cliente como administrador.  Inicie um terminal no qual o openvpn tamb√©m inicie com direitos de administrador, caso contr√°rio n√£o poder√° controlar a interface de rede. <br><br>  No Windows, o caminho da biblioteca para trabalhar com tokens deve ser registrado por meio de barras duplas.  Isso se aplica √†s op√ß√µes ovpn config e <code>--show-pkcs11-ids</code> na linha de comandos. <br><br><pre> <code class="bash hljs">pkcs11-providers <span class="hljs-string"><span class="hljs-string">"c://Windows//System32//rtPKCS11ECP.dll"</span></span> pkcs11-id <span class="hljs-string"><span class="hljs-string">'Aktiv\x20Co\x2E/Rutoken\x20ECP/342b871d/Rutoken/01'</span></span></code> </pre></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt433250/">https://habr.com/ru/post/pt433250/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt433234/index.html">Uma bab√° perfeita √© necess√°ria; certifique-se de passar por um exame de IA para avaliar o respeito e as boas maneiras</a></li>
<li><a href="../pt433236/index.html">O chefe do Google acredita que o medo da IA ‚Äã‚Äã√© "completamente justificado"</a></li>
<li><a href="../pt433242/index.html">M√°scara t√≥xica</a></li>
<li><a href="../pt433246/index.html">Framework: an√°lise de sistemas DLT</a></li>
<li><a href="../pt433248/index.html">Analisando a an√°lise forense de mem√≥ria com o OtterCTF e apresentando a estrutura de volatilidade</a></li>
<li><a href="../pt433252/index.html">Manequim em um helic√≥ptero h√≠brido el√©trico turbojato</a></li>
<li><a href="../pt433254/index.html">Estamos apenas lutando contra a morte, e voc√™? Ou empresas que desenvolvem rem√©dios fant√°sticos</a></li>
<li><a href="../pt433256/index.html">Desenvolvimento de UI com Flutter</a></li>
<li><a href="../pt433258/index.html">Voc√™ pode comprar componentes eletr√¥nicos na Europa, mesmo em f√©rias. Experi√™ncia de compra na Mouser na Bulg√°ria</a></li>
<li><a href="../pt433260/index.html">Leitura de fim de semana: materiais sobre como trabalhar com DP, revis√µes de ferro no data center e a "cozinha" do provedor de IaaS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>