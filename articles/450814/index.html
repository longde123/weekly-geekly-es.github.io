<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç¶ üë¥üèΩ ‚ò™Ô∏è C√≥mo funciona BGP ‚ú≥Ô∏è üè™ üë∞üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoy nos fijamos en el protocolo BGP. No hablaremos durante mucho tiempo por qu√© es y por qu√© se usa como el √∫nico protocolo. Hay mucha informaci√≥n sob...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo funciona BGP</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450814/">  Hoy nos fijamos en el protocolo BGP.  No hablaremos durante mucho tiempo por qu√© es y por qu√© se usa como el √∫nico protocolo.  Hay mucha informaci√≥n sobre este tema, por ejemplo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br>  Entonces, ¬øqu√© es BGP?  BGP es un protocolo de enrutamiento din√°mico que es el √∫nico protocolo EGP (Protocolo de puerta de enlace externo).  Este protocolo se utiliza para construir enrutamiento en Internet.  Considere c√≥mo se construye el vecindario entre dos enrutadores BGP. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/3fa/da6/dd3/3fada6dd3c41923367af475da9b0ae10.jpg" alt="Mi imagen"></a> <br>  Considere el vecindario entre Router1 y Router3.  Los configuraremos utilizando los siguientes comandos: <a name="habracut"></a><br><pre><code class="plaintext hljs">router bgp 10 network 192.168.12.0 network 192.168.13.0 neighbor 192.168.13.3 remote-as 10 router bgp 10 network 192.168.13.0 network 192.168.24.0 neighbor 192.168.13.1 remote-as 10</code> </pre> <br>  El vecindario dentro de un sistema aut√≥nomo es AS 10. Despu√©s de ingresar datos en un enrutador, por ejemplo en el Enrutador1, este enrutador intenta establecer una relaci√≥n de vecindad con el Enrutador3.  El estado inicial cuando no sucede nada se llama <b>inactivo</b> .  Tan pronto como bgp est√© configurado en el Router1, comenzar√° a escuchar el puerto TCP 179: pasar√° al estado <b>Conectar</b> , y cuando intente abrir una sesi√≥n con el Router3, pasar√° al estado <b>Activo</b> . <br><br>  Despu√©s de que se establece la sesi√≥n entre Router1 y Router3, se lleva a cabo un intercambio de mensajes abiertos.  Cuando el Router1 env√≠a este mensaje, este estado se llamar√° <b>Open Sent</b> .  Y cuando recibe un mensaje Abierto del Router3, pasar√° al estado <b>Confirmar abierto</b> .  Considere la publicaci√≥n abierta con m√°s detalle: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d9d/231/607/d9d2316070de22049a24da6d86cecb2b.jpg" alt="Mi imagen"></a> <br>  Este mensaje transmite informaci√≥n sobre el protocolo BGP que utiliza el enrutador.  Al intercambiar mensajes abiertos, el enrutador 1 y el enrutador 3 comunican informaci√≥n sobre sus configuraciones entre s√≠.  Se pasan los siguientes par√°metros: <br><blockquote><ul><li>  <b>Versi√≥n</b> : esto incluye la versi√≥n BGP que est√° utilizando el enrutador.  La versi√≥n actual de BGP es la versi√≥n 4 que se describe en RFC 4271. Dos enrutadores BGP intentar√°n negociar una versi√≥n compatible, cuando haya una falta de coincidencia, no habr√° sesi√≥n BGP. </li><li>  <b>Mi AS</b> : esto incluye el n√∫mero AS del enrutador BGP, los enrutadores deber√°n acordar los n√∫meros AS y tambi√©n define si ejecutar√°n iBGP o eBGP. </li><li>  <b>Tiempo de espera</b> : si BGP no recibe ning√∫n mensaje de mantenimiento o actualizaci√≥n del otro lado durante el tiempo de espera, entonces declarar√° al otro lado 'muerto' y anular√° la sesi√≥n de BGP.  Por defecto, el tiempo de espera se establece en 180 segundos en los enrutadores Cisco IOS, el mensaje de mantenimiento se env√≠a cada 60 segundos.  Ambos enrutadores deben acordar el tiempo de espera o no habr√° una sesi√≥n BGP. </li><li>  <b>Identificador de BGP</b> : esta es la identificaci√≥n del enrutador BGP local que se elige como OSPF: <br><ul><li>  Utilice la ID de enrutador que se configur√≥ manualmente con el comando bgp router-id. </li><li>  Use la direcci√≥n IP m√°s alta en una interfaz de bucle invertido. </li><li>  Use la direcci√≥n IP m√°s alta en una interfaz f√≠sica. </li></ul></li><li>  <b>Par√°metros opcionales</b> : aqu√≠ encontrar√° algunas capacidades opcionales del enrutador BGP.  Este campo se ha agregado para que se puedan agregar nuevas funciones a BGP sin tener que crear una nueva versi√≥n. Las cosas que puede encontrar aqu√≠ son: <br><br><ul><li>  Soporte para MP-BGP (Multi Protocol BGP). </li><li>  soporte para ruta de actualizaci√≥n. </li><li>  soporte para n√∫meros AS de 4 octetos. </li></ul></li></ul></blockquote>  Para establecer un vecindario, se deben cumplir las siguientes condiciones: <br><br><ul><li>  N√∫mero de versi√≥n  Versi√≥n actual 4. </li><li>  El n√∫mero AS debe coincidir con el que configur√≥ el <b>vecino 192.168.13.3 remoto-como 10</b> . </li><li>  El ID del enrutador debe ser diferente del vecino. </li></ul><br>  Si alguno de los par√°metros no cumple con estas condiciones, el enrutador enviar√° un mensaje de <b>notificaci√≥n</b> donde indica un error.  Despu√©s de enviar y recibir mensajes abiertos, la relaci√≥n de vecindario ingresa al estado <b>ESTABLECIDO</b> .  Despu√©s de eso, los enrutadores pueden intercambiar informaci√≥n sobre rutas y hacerlo mediante mensajes de <b>actualizaci√≥n</b> .  Aqu√≠ hay un mensaje de actualizaci√≥n que env√≠a Router1 a Router3: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/853/f42/1f0/853f421f0a69f407c5ae4eae3423240c.jpg" alt="Mi imagen"></a> <br><br>  Aqu√≠ se indican las redes informadas por los atributos Router1 y Path, que son an√°logas a las m√©tricas.  Hablaremos sobre los atributos de ruta con m√°s detalle.  Adem√°s, los mensajes keepalive se transmiten dentro de la sesi√≥n TCP.  Se transmiten, por defecto, cada 60 segundos.  Este es un temporizador Keepalive.  Si el mensaje Keepalive no se recibe durante el Temporizador de retenci√≥n, esto significar√° la p√©rdida de comunicaci√≥n con el vecino.  Por defecto, es igual a - 180 segundos. <br><br>  Placa √∫til: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/853/f42/1f0/853f421f0a69f407c5ae4eae3423240c.jpg" alt="Mi imagen"></a> <br><br>  Parece haber descubierto c√≥mo los enrutadores transmiten informaci√≥n entre s√≠, ahora intentemos descubrir la l√≥gica del protocolo BGP. <br><br>  Para anunciar una ruta a la tabla BGP, como en los protocolos IGP, se usa el comando de red, pero la l√≥gica de operaci√≥n es diferente.  Si en IGP, despu√©s de especificar una ruta en el comando de red, IGP observa qu√© interfaces pertenecen a esta subred y las incluye en su tabla, luego el comando de red en BGP busca en la tabla de enrutamiento y busca una coincidencia <b>exacta</b> con la ruta en el comando de red.  Si se encuentran estos, estas rutas caer√°n en la tabla BGP. <br><blockquote>  Busque una ruta en la tabla de enrutamiento IP actual del enrutador que coincida exactamente con los par√°metros del comando de red;  si existe la ruta IP, coloque el NLRI equivalente en la tabla BGP local. </blockquote>  Ahora elevaremos BGP a todos los restantes y veremos c√≥mo se selecciona la ruta dentro de un AS.  Despu√©s de que el enrutador BGP recibe rutas del vecino, comienza la selecci√≥n de la ruta √≥ptima.  Aqu√≠ debe comprender qu√© tipo de vecinos pueden ser: internos y externos.  ¬øEl enrutador de configuraci√≥n comprende si el vecino configurado es interno o externo?  Si en un equipo: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.13.3 remote-as 10</code> </pre> <br>  como par√°metro remoto como, se especifica el AS, que se configura en el enrutador con el comando router bgp 10. Las rutas que provienen del AS interno se consideran internas y las rutas del AS externo se consideran externas.  Y con respecto a cada uno, una l√≥gica diferente de recepci√≥n y env√≠o de obras.  Considere la siguiente topolog√≠a: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/cea/5f8/2b0/cea5f82b050662b2632cab01f3de8e24.jpg" alt="Mi imagen"></a> <br><br>  Cada enrutador tiene una interfaz loopback configurada con ip: xxxx 255.255.255.0, donde x es el n√∫mero del enrutador.  En Router9 tenemos una interfaz de bucle invertido con la direcci√≥n 9.9.9.9 255.255.255.0.  Lo anunciaremos en BGP y veremos c√≥mo se distribuye.  Esta ruta se transmitir√° al Router8 y al Router12.  Con Router8, esta ruta ir√° a Router6, pero en Router5 no estar√° en la tabla de enrutamiento.  Adem√°s, en el Router12 esta ruta entrar√° en la tabla, pero en el Router11 tampoco lo ser√°.  Tratemos de resolverlo.  Considere qu√© datos y par√°metros est√°n siendo transmitidos por Router9 a sus vecinos, informando esta ruta.  El paquete a continuaci√≥n se enviar√° desde Router9 a Router8. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/5e7/80b/ca0/5e780bca084e8f42dab14d03f62723b6.jpg" alt="Mi imagen"></a> <br>  La informaci√≥n de ruta consta de atributos de ruta. <br><br>  Los atributos de ruta se dividen en 4 categor√≠as: <br><br><ol><li>  <b>Obligatorio bien conocido</b> : todos los enrutadores BGP deben reconocer estos atributos.  Debe estar presente en todas las actualizaciones. </li><li>  <b>Discrecionalmente conocido</b> : todos los enrutadores BGP deben reconocer estos atributos.  Pueden estar presentes en las actualizaciones, pero su presencia no es necesaria. </li><li>  <b>Transitivo opcional</b> : es posible que no todas las implementaciones de BGP lo reconozcan.  Si el enrutador no reconoce el atributo, marca la actualizaci√≥n como parcial y la env√≠a m√°s a los vecinos, conservando el atributo no reconocido. </li><li>  <b>Opcional no transitivo</b> : puede no ser reconocido por todas las implementaciones de BGP.  Si el enrutador no reconoce el atributo, el atributo se ignora y se descarta durante la transmisi√≥n a los vecinos. </li></ol><br>  Ejemplos de atributos BGP: <br><br><ul><li>  <b>Conocido obligatorio</b> : <br><ul><li>  Ruta del sistema aut√≥nomo </li><li>  Siguiente salto </li><li>  Origen </li></ul><br></li><li>  <b>Discrecional bien conocido</b> : <br><ul><li>  Preferencia local </li><li>  Agregado at√≥mico </li></ul></li><li>  <b>Transitivo opcional</b> : <br><ul><li>  Agregador </li><li>  Comunidades </li></ul></li><li>  <b>Opcional no transitivo</b> : <br><ul><li>  Discriminador de m√∫ltiples salidas (MED) </li><li>  ID del creador </li><li>  Lista de cl√∫ster </li></ul></li></ul><br>  En este caso, estaremos interesados ‚Äã‚Äãen Origin, Next-hop, AS Path.  Dado que la ruta pasa entre Router8 y Router9, es decir, dentro del mismo AS, se considera interna y prestaremos atenci√≥n a Origin. <br><br>  Atributo de origen: indica c√≥mo se recibi√≥ la ruta en la actualizaci√≥n.  Posibles valores de atributo: <br><br><ul><li>  0 - IGP: NLRI obtenido dentro del sistema aut√≥nomo original; </li><li>  1 - EGP: NLRI aprendido por el Protocolo de puerta de enlace exterior (EGP).  BGP predecesor, no utilizado </li><li>  2 - Incompleto: NLRI se aprendi√≥ de otra manera </li></ul><br>  En nuestro caso, como se puede ver en el paquete, es 0. Cuando esta ruta se transmite al Router12, este c√≥digo tendr√° el c√≥digo - 1. <br><br>  Siguiente, siguiente salto.  Atributo del siguiente salto <br><br><ul><li>  Esta es la direcci√≥n IP del enrutador eBGP a trav√©s del cual pasa la ruta a la red de destino. </li><li>  El atributo cambia cuando el prefijo se pasa a otro AS. </li></ul><br>  En el caso de iBGP, es decir, dentro de un AS, el siguiente salto se indicar√° como el que aprendi√≥ o cont√≥ sobre esta ruta.  En nuestro caso, ser√° 192.168.89.9.  Pero cuando transfiera esta ruta de Router8 a Router6, Router8 la cambiar√° y la reemplazar√° por la suya.  El siguiente salto ser√°: 192.168.68.8.  Esto nos lleva a dos reglas: <br><br><ol><li>  Si el enrutador pasa la ruta a su vecino interno, entonces no cambia el par√°metro Next-hop. </li><li>  Si el enrutador env√≠a la ruta a su vecino externo, cambia el siguiente salto a la ip de la interfaz desde la que env√≠a este enrutador. </li></ol><br>  Esto nos lleva a comprender el primer problema: por qu√© no habr√° una ruta en la tabla de enrutamiento en Router5 y Router11.  Consideremos con m√°s detalle.  Entonces, Router6 recibi√≥ la informaci√≥n de ruta 9.9.9.0/24 y la agreg√≥ de forma segura a la tabla de enrutamiento: <br><br><pre> <code class="plaintext hljs">Router6#show ip route bgp Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2 E1 - OSPF external type 1, E2 - OSPF external type 2 i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2 ia - IS-IS inter area, * - candidate default, U - per-user static route o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP a - application route + - replicated route, % - next hop override, p - overrides from PfR Gateway of last resort is not set 9.0.0.0/24 is subnetted, 1 subnets B 9.9.9.0 [20/0] via 192.168.68.8, 00:38:25</code> </pre> <br>  Ahora Router6 pas√≥ la ruta Router5 y no cambi√≥ la primera regla del pr√≥ximo salto.  Es decir, el Router5 deber√≠a agregar <b>9.9.9.0 [20/0] a trav√©s de 192.168.68.8</b> , pero no tiene una ruta a 192.168.68.8 y, por lo tanto, esta ruta no se agregar√°, aunque la informaci√≥n sobre esta ruta se almacenar√° en la tabla BGP: <br><br><pre> <code class="plaintext hljs">&lt;b&gt;Router5#show ip bgp BGP table version is 1, local router ID is 5.5.5.5 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path * i 9.9.9.0/24 192.168.68.8 0 100 0 45 i&lt;/b&gt;</code> </pre> <br>  La misma situaci√≥n ocurrir√° entre Router11-Router12.  Para evitar tal situaci√≥n, es necesario configurar de modo que el Router6 o el Router12, pasando la ruta a sus vecinos internos, sustituyan su direcci√≥n IP como Next-hop.  Se hace usando el comando: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.56.5 next-hop-self</code> </pre> <br>  Despu√©s de este comando, el Router6 enviar√° un mensaje de Actualizaci√≥n, donde para las rutas como Next-hop se indicar√° la ip de la interfaz Gi0 / 0 del Router6 - 192.168.56.6, despu√©s de lo cual esta ruta ya estar√° en la tabla de enrutamiento. <br><br>  Sigamos adelante y veamos si esta ruta aparece en Router7 y Router10.  No aparecer√° en la tabla de enrutamiento y podr√≠amos pensar que el problema es como el primero con el par√°metro Next-hop, pero si miramos la salida del comando show ip bgp, veremos que la ruta no se recibi√≥ incluso con el Next-hop incorrecto, que significa que la ruta ni siquiera se transmiti√≥.  Y esto nos llevar√° a la existencia de otra regla: <br><blockquote>  Las rutas recibidas de vecinos internos no se transfieren a otros vecinos internos. </blockquote>  Como el Router5 recibi√≥ la ruta del Router6, no se transmitir√° a su otro vecino interno.  Para que la transferencia tenga lugar, debe configurar la funci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Reflector de ruta</a> , o configurar las relaciones de vecindad completamente conectadas (Full Mesh), es decir, el Router5-7 ser√° vecino de cada una.  Utilizaremos el Reflector de ruta en este caso.  En el Router5, debe usar este comando: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.57.7 route-reflector-client</code> </pre> <br>  Route-Reflector cambia el comportamiento de BGP al transmitir una ruta a un vecino interno.  Si el vecino interno se especifica como <b>route-reflector-client</b> , se anunciar√°n las rutas internas a estos clientes. <br><br>  ¬øLa ruta no apareci√≥ en Router7?  No te olvides de Next-hop tambi√©n.  Despu√©s de estas manipulaciones, la ruta tambi√©n deber√≠a estar en el Router7, pero esto no sucede.  Esto nos lleva a otra regla: <br><blockquote>  La regla del siguiente salto solo funciona para rutas externas.  Para rutas internas, el atributo del siguiente salto no se reemplaza. </blockquote><br>  Y tenemos una situaci√≥n en la que necesita crear un entorno utilizando enrutamiento est√°tico o IGP para informar a los enrutadores sobre todas las rutas dentro del AS.  Registraremos las rutas est√°ticas en Router6 y Router7 y luego obtendremos la ruta deseada en la tabla del enrutador.  En AS 678, actuaremos un poco diferente: escribiremos las rutas est√°ticas para 192.168.112.0/24 en Router10 y 192.168.110.0/24 en Router12.  A continuaci√≥n, establecemos la relaci√≥n de vecindad entre Router10 y Router12.  Tambi√©n configuramos Router12 para enviar su pr√≥ximo salto para Router10: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.110.10 next-hop-self</code> </pre> <br>  El resultado ser√° que el Router10 recibir√° la ruta 9.9.9.0/24, se recibir√° tanto del Router7 como del Router12.  Veamos qu√© elecci√≥n hace Router10: <br><br><pre> <code class="plaintext hljs">Router10#show ip bgp BGP table version is 3, local router ID is 6.6.6.6 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.112.12 0 100 0 45 i 192.168.107.7 0 123 45 i</code> </pre> <br>  Como podemos ver, dos rutas y una flecha (&gt;) significan que la ruta a trav√©s de 192.168.112.12 est√° seleccionada. <br>  Veamos c√≥mo se lleva a cabo el proceso de selecci√≥n de ruta: <br><br><ol><li>  En primer lugar, al recibir la ruta, se verifica la disponibilidad de su Next-hop.  Es por eso que, cuando recibimos una ruta en el Router5 sin configurar Next-hop-self, esta ruta ya no se envi√≥ para su procesamiento. </li><li>  El siguiente es el par√°metro Peso.  Este par√°metro no es un atributo de ruta (PA) y no se transmite en mensajes BGP.  Se configura localmente en cada enrutador y se usa solo para manipular la selecci√≥n de ruta en el enrutador.  Considera un ejemplo.  Se muestra arriba que Router10 eligi√≥ la ruta para 9.9.9.0/24 a trav√©s de Router12 (192.168.112.12).  Para cambiar el par√°metro Wieght, puede usar el mapa de ruta para establecer rutas espec√≠ficas, o asignar peso a su vecino usando el comando: <br><br><pre> <code class="plaintext hljs"> neighbor 192.168.107.7 weight 200</code> </pre> <br>  Ahora todas las rutas de este vecino tendr√°n tal peso.  Veamos c√≥mo cambia la elecci√≥n de ruta despu√©s de esta manipulaci√≥n: <br><br><pre> <code class="plaintext hljs">Router10#show bgp *Mar 2 11:58:13.956: %SYS-5-CONFIG_I: Configured from console by console BGP table version is 2, local router ID is 6.6.6.6 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt; 9.9.9.0/24 192.168.107.7 200 123 45 i * i 192.168.112.12 0 100 0 45 i</code> </pre> <br>  Como puede ver, la ruta a trav√©s del Router7 ahora est√° seleccionada, pero esto no tendr√° ning√∫n efecto en los otros enrutadores. </li><li>  En tercer lugar tenemos - Preferencia local.  Este par√°metro es un atributo discrecional bien conocido, lo que significa que su presencia es opcional.  Este par√°metro es v√°lido solo dentro de un AS y afecta la elecci√≥n de la ruta solo para los vecinos internos.  Por eso, se transmite solo en los mensajes de actualizaci√≥n destinados al vecino interno.  En los mensajes de actualizaci√≥n para vecinos externos est√° ausente.  Por lo tanto, fue asignado a la discrecionalidad conocida.  Intentemos aplicarlo en Router5.  En Router5, deber√≠amos tener dos rutas para 9.9.9.0/24: una a trav√©s de Router6 y la segunda a trav√©s de Router7. <br><br>  Buscamos: <br><br><pre> <code class="plaintext hljs">Router5#show bgp BGP table version is 2, local router ID is 5.5.5.5 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.56.6 0 100 0 45 i</code> </pre> <br>  Pero como puede ver una ruta a trav√©s de Router6.  ¬øY d√≥nde est√° la ruta a trav√©s de Router7?  ¬øQuiz√°s ni siquiera existe en Router7?  Buscamos: <br><br><pre> <code class="plaintext hljs">Router#show bgp BGP table version is 10, local router ID is 7.7.7.7 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.56.6 0 100 0 45 i 192.168.107.10 0 678 45 i</code> </pre> <br>  Extra√±o, todo parece estar en orden.  ¬øPor qu√© no se transmite al Router5?  El caso es que BGP tiene una regla: <br><blockquote>  El enrutador transmite solo aquellas rutas que utiliza por s√≠ mismo. </blockquote><br>  Router7 utiliza la ruta a trav√©s de Router5, por lo que la ruta a trav√©s de Router10 no se transmitir√°.  De vuelta a la preferencia local.  Establezcamos la Preferencia local en Router7 y veamos c√≥mo Router5 responde a esto: <br><br><pre> <code class="plaintext hljs">route-map BGP permit 10 match ip address 10 set local-preference 250 access-list 10 permit any router bgp 123 neighbor 192.168.107.10 route-map BGP in&lt;/b&gt;</code> </pre> <br>  Entonces, creamos un mapa de ruta en el que caen todas las rutas y le indicamos al Router7 que cambie el par√°metro de Preferencia Local a 250 al recibirlo, por defecto es 100. Observamos lo que sucedi√≥ en el Router5: <br><br><pre> <code class="plaintext hljs">Router5#show bgp BGP table version is 8, local router ID is 5.5.5.5 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.57.7 0 250 0 678 45 i</code> </pre> <br>  Como vemos ahora, Router5 prefiere la ruta a trav√©s de Router7.  La misma imagen estar√° en Router6, aunque es m√°s rentable para √©l elegir una ruta a trav√©s de Router8.  Tambi√©n agregamos que un cambio en este par√°metro requiere un reinicio del vecindario para que el cambio surta efecto.  Lee <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a>  Con preferencia local resuelta.  Ir al siguiente par√°metro. </li><li>  Preferencia de ruta con el par√°metro del siguiente salto 0.0.0.0, es decir, rutas locales o agregadas.  Despu√©s de ingresar el comando de red, a estas rutas se les asigna autom√°ticamente el par√°metro Peso igual al m√°ximo - 32678: <br><br><pre> <code class="plaintext hljs">Router#show bgp BGP table version is 2, local router ID is 9.9.9.9 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt; 9.9.9.0/24 0.0.0.0 0 32768 i</code> </pre> </li><li>  El camino m√°s corto a trav√©s de AS.  Se selecciona el par√°metro m√°s corto AS_Path.  Cuanto menos pase la ruta, mejor ser√°.  Considere la ruta a 9.9.9.0/24 en Router10: <br><br><pre> <code class="plaintext hljs">Router10#show bgp BGP table version is 2, local router ID is 6.6.6.6 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path * 9.9.9.0/24 192.168.107.7 0 123 45 i *&gt;i 192.168.112.12 0 100 0 45 i</code> </pre> <br>  Como puede ver, Router10 eligi√≥ la ruta a trav√©s de 192.168.112.12 porque el par√°metro AS_Path contiene solo 45 para esta ruta, y 123 y 45 en el otro caso. Intuitivamente. </li><li>  El siguiente par√°metro es Origen.  ¬øEs IGP (ruta obtenida usando BGP) mejor que EGP (ruta obtenida usando BGP predecesor, ahora no se usa) y EGP es mejor que Incomplete?  (recibido de alguna otra manera, por ejemplo, por redistribuci√≥n). </li><li>  El siguiente par√°metro es MED.  Ten√≠amos Wieght, que solo funcionaba localmente en el enrutador.  Hab√≠a una preferencia local que funcionaba solo dentro de un sistema aut√≥nomo.  Como puede suponer, MED es un par√°metro que se transmitir√° entre sistemas aut√≥nomos.  Muy buen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> sobre esta opci√≥n. </li></ol><br>  No se utilizar√°n m√°s atributos, pero si las dos rutas tienen los mismos atributos, se utilizar√°n las siguientes reglas: <br><br><ol><li>  Elija una ruta a trav√©s del vecino IGP m√°s cercano. </li><li>  Seleccione la ruta m√°s antigua para la ruta eBGP. </li><li>  Elija una ruta a trav√©s del vecino con la ID de enrutador BGP m√°s baja. </li><li>  Elija una ruta a trav√©s del vecino con la direcci√≥n IP m√°s baja. </li></ol><br>  <b>Ahora considere el tema de la convergencia BGP.</b> <br><br>  Veamos qu√© sucede si, por ejemplo, el Router6 pierde la ruta 9.9.9.0/24 a trav√©s del Router9.  Apagamos la interfaz Gi0 / 1 Router6, que comprende de inmediato que la sesi√≥n BGP con Router8 est√° desconectada y el vecino se ha ido, lo que significa que la ruta recibida no es v√°lida.  El Router6 env√≠a inmediatamente mensajes de Actualizaci√≥n donde indica la red 9.9.9.0/24 en el campo Rutas Retiradas.  Tan pronto como el Router5 reciba un mensaje similar, env√≠elo al Router7.  Pero dado que Router7 tiene una ruta a trav√©s de Router10, enviar√° inmediatamente Update con una nueva ruta en respuesta.  Si el estado de la interfaz no puede detectar la ca√≠da del vecino, entonces debe esperar a que se active el Temporizador de retenci√≥n. <br><br>  <b>Confederaci√≥n</b> <br><br>  Si recuerdas, hablamos sobre el hecho de que a menudo tienes que usar una topolog√≠a completamente conectada.  Con una gran cantidad de enrutadores en un AS, esto puede causar grandes problemas, para evitar esto es necesario usar confederaciones.  Un AS se divide en varios sub-AS, lo que le permite funcionar sin el requisito de una topolog√≠a completamente conectada. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d55/6a8/741/d556a874120b70319381332cdddf739b.jpg" alt="Mi imagen"></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ hay un enlace a este </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">laboratorio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠ est√° la</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> configuraci√≥n para GNS3. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por ejemplo, con esta topolog√≠a, tendr√≠amos que conectar todos los enrutadores en AS 2345 entre s√≠, pero usando Confederaci√≥n, podemos establecer relaciones de vecindad solo entre enrutadores conectados directamente entre s√≠. Hablemos de esto en detalle. Si solo tuvi√©ramos AS 2345, entonces </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">laForge</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> recibir√≠a una marcha de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Picard y</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> le dir√≠a a sus </font><b><font style="vertical-align: inherit;">enrutadores </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Worf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero no le dir√≠an a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crusher al</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> respecto </font><font style="vertical-align: inherit;">. Adem√°s, las rutas que el propio router rasprastranyaet </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laforge</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , no ser√≠an transferidos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trituradora</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Worf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ni </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">datos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tendr√≠a que establecer una Ruta-Reflector o una relaci√≥n de vecindario completamente conectada. </font><font style="vertical-align: inherit;">Al dividir un AS 2345 en 4 sub-AS (2,3,4,5) para cada enrutador, terminamos con una l√≥gica de operaci√≥n diferente. </font><font style="vertical-align: inherit;">Todo est√° perfectamente descrito </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fuentes:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CCIE Routing and Switching v5.0 Official Cert Guide, Volume 2, Fifth Edition, Narbik Kocharians, Terry Vinson. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sitio web </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xgu.ru</font></font></a> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sitio </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GNS3Vault</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/450814/">https://habr.com/ru/post/450814/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450802/index.html">Corte de legado</a></li>
<li><a href="../450804/index.html">Impresi√≥n de metal en 3D en la industria automotriz: comience con poco</a></li>
<li><a href="../450806/index.html">Cuando una variable de entorno acelera el proceso 40 veces</a></li>
<li><a href="../450810/index.html">Las 7 mejores formas de verificar r√°pidamente las competencias de los especialistas de TI antes de la entrevista</a></li>
<li><a href="../450812/index.html">PSR-14: el evento principal en PHP</a></li>
<li><a href="../450816/index.html">Encabezados HTTP para el desarrollador responsable</a></li>
<li><a href="../450818/index.html">Desde alta latencia de ceph hasta parche de kernel con eBPF / BCC</a></li>
<li><a href="../450820/index.html">Comit√© del programa FrontendConf: marcos, horizontes, experiencia mundial y misi√≥n de la conferencia.</a></li>
<li><a href="../450822/index.html">Marcos desaparecidos</a></li>
<li><a href="../450824/index.html">El estado de css</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>