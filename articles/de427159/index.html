<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì∏ üåÑ üè¶ Wir sammeln Protokolle der Mikrotik-Firewall in einer Datenbank üë®üèº‚Äçüíº ü§úüèø üßëüèæ‚Äçü§ù‚Äçüßëüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Guten Tag. 

 Ich m√∂chte Ihnen sagen, wie einfach und nat√ºrlich Sie einen Metadatenerfassungsserver f√ºr den Netzwerkverkehr f√ºr Mikrotik-Router konfig...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir sammeln Protokolle der Mikrotik-Firewall in einer Datenbank</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427159/">  Guten Tag. <br><br>  Ich m√∂chte Ihnen sagen, wie einfach und nat√ºrlich Sie einen Metadatenerfassungsserver f√ºr den Netzwerkverkehr f√ºr Mikrotik-Router konfigurieren k√∂nnen. <br><br>  <b>Zweck:</b> Das Ziel besteht darin, die "gekauten" Firewall-Protokolle zur weiteren Analyse in einer Datenbank zu speichern. <br><br>  <b>Mittel:</b> Jede neue Linux-Distribution mit rsyslogd v8 und h√∂her ist f√ºr die Implementierung geeignet. M√∂glicherweise funktioniert die vorgeschlagene Syntax auch unter v7.  Wir brauchen auch ein DBMS, ich habe Mariadb gew√§hlt.  Das Datenbankwachstum h√§ngt von der Anzahl der protokollierten Regeln ab, da die Gr√∂√üe des Laufwerks in Ihrem Ermessen liegt. In meinem Fall werden 30 bis 40 Regeln protokolliert, was ungef√§hr 1200.000 Zeilen pro Tag entspricht.  W√§hrend des Monats der Nutzung der Datenbank, einschlie√ülich der Indizes, wuchs sie auf 3,8 GB. <br><br>  <b>Mechanik: Der</b> Router sendet ein Protokoll √ºber UDP an den Remote-Server.  Mit regul√§ren Ausdr√ºcken bereinigt der rsyslog-Server Zeichenfolgen von unn√∂tigen Informationen, generiert eine SQL-Einf√ºgung und sendet sie an das DBMS.  Das DBMS f√ºhrt vor dem Einf√ºgen mithilfe eines Triggers eine zus√§tzliche Bereinigung und Trennung von Feldern durch, die in rsyslog nicht analysiert werden konnten. <br><a name="habracut"></a><br><h4>  <b>Konfigurieren Sie RSYSLOG</b> </h4><br>  Bearbeiten der Datei /etc/rsyslog.conf <br>  F√ºgen Sie dort die folgenden Zeilen hinzu: <br><br><pre><code class="plaintext hljs">module(load="ommysql") module(load="imudp") input(type="imudp" port="514")</code> </pre> <br>  Daher laden wir die erforderlichen Module und √∂ffnen den 514 UDP-Port. <br><br>  Die Protokollzeile von Mikrotik sieht folgenderma√üen aus: <br><br><pre> <code class="plaintext hljs">20180927155341 BLOCKSMKNETS forward: in:ether6 - LocalTORF out:VLAN55 - RT_INET, src-mac 00:15:17:31:b8:d7, proto TCP (SYN), 192.168.0.234:2457-&gt;192.168.6.14:65535, len 60</code> </pre> <br>  Wie Sie sehen k√∂nnen, wird es schwierig sein, viel mehr f√ºr die Speicherung in der Datenbank und eine klare Auswahl zu ben√∂tigen. <br>  Theoretisch muss ich solche Daten hinzuf√ºgen: <br><br><pre> <code class="plaintext hljs">20180927155341 ether6 VLAN5 192.168.0.234 2457 192.168.6.14 65535 00:15:17:31:b8:d7 TCP SYN forward BLOCKSMKNETS 60</code> </pre> <br>  Ich konnte eine solche Zeile nicht mit nur einem rsyslog erhalten.  Rsyslog-Stammg√§ste verwenden POSIX ERE / BRE, daher gibt es keine M√∂glichkeit, Funktionen wie Lookahead oder Lookbehind anzuwenden. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Es</a> gibt ein Tool, mit dem Sie Stammg√§ste debuggen und ausprobieren k√∂nnen. Vielleicht k√∂nnen Sie den Port von der Adresse sowie den Namen der Schnittstelle von in: und out: trennen.  Denken Sie daran, dass einige Sport- und Dport-Protokolle fehlen. <br><br>  Im Allgemeinen war meine Ausgabe wie folgt: <br><br><pre> <code class="plaintext hljs">20180927155341 in:ether6 out:VLAN5 192.168.0.234:2457 192.168.6.14:65535 00:15:17:31:b8:d7 TCP (SYN) forward BLOCKSMKNETS 60</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Es</a> gibt eine Dokumentation zum Kochen von rsyslog-Stammg√§sten. <br><br>  Im endg√ºltigen Formular sieht die Konfigurationsdatei f√ºr den Empfang des Protokolls von Mikrotik /etc/rsyslog.d/20-remote.conf folgenderma√üen aus: <br><br><pre> <code class="plaintext hljs">$template tpl_traflog,"insert into traflog.traffic (datetime, inif, outif, src, dst, smac, proto, flags, chain, logpref, len) values ('%timereported:::date-mysql%', '%msg:R,ERE,0,DFLT,0:in:[a-zA-Z]+[0-9]+|in:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%', '%msg:R,ERE,0,BLANK,0:out:[a-zA-Z]+[0-9]+|out:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%', '%msg:R,ERE,0,DFLT,0:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%', '%msg:R,ERE,0,DFLT,1:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%', '%msg:R,ERE,0,BLANK:([0-f]+:){5}[0-f]+--end%', '%msg:R,ERE,0,BLANK:\b[AX]{3,4}\b--end%', '%msg:R,ERE,0,BLANK:\([AZ]+\)|\(([AZ]+\,){1,3}[AZ]+\)--end%', '%msg:R,ERE,0,DFLT:[ax]+--end%', '%msg:F,32:2%', '%msg:R,ERE,0,DFLT:[0-9]+$--end%' )",SQL if ($fromhost-ip == '192.168.0.230') and ($syslogtag contains "firewall") then {action(type="ommysql" server="localhost" serverport="3306" db="traflog" uid="rsyslogger" pwd="rsyslogger" template="tpl_traflog") stop}</code> </pre><br>  In der ersten Zeile ist die Beschreibung der Vorlage (Vorlage) eine Zeile mit SQL-Code zum √úbertragen an das DBMS. <br>  Die zweite Zeile ist die Bedingung, unter der die Aktion ausgef√ºhrt wird, dh der Datensatz im DBMS. <br>  Die Bedingung sieht folgenderma√üen aus: Wenn die Protokollquelle = 192.168.0.230 ( <code>if ($fromhost-ip == '192.168.0.230')</code> ) und wenn die Nachrichtenzeile "Firewall" enth√§lt (und ($ syslogtag "Firewall" enth√§lt), verwenden Sie das Modul ommysql mit Verbindungsparametern ( <code>then {action(type="ommysql" server="localhost" serverport="3306" db="traflog" uid="rsyslogger" pwd="..."</code> ) rufen wir die Vorlage tpl_traflog ( <code>template="tpl_traflog")</code> ), und danach stoppen wir die weitere Verarbeitung der Zeile ( <code>stop}</code> ). <br><br>  Es ist m√∂glich, dass in Ihrem Fall etwas schief geht. Dies kann an den Namen der Schnittstellen oder Protokollpr√§fixen liegen, m√∂glicherweise an etwas anderem.  Zum Debuggen gehen wir wie folgt vor, kommentieren die zweite Zeile, f√ºgen eine neue Vorlage und zwei neue Bedingungen hinzu: <br><br><pre> <code class="plaintext hljs">$template tpl_traflog_test,"%timereported:::date-mysql% %msg:R,ERE,0,DFLT,0:in:[a-zA-Z]+[0-9]+|in:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end% %msg:R,ERE,0,BLANK,0:out:[a-zA-Z]+[0-9]+|out:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end% %msg:R,ERE,0,DFLT,0:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end% %msg:R,ERE,0,DFLT,1:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end% %msg:R,ERE,0,BLANK:([0-f]+:){5}[0-f]+--end% %msg:R,ERE,0,BLANK:\b[AX]{3,4}\b--end% %msg:R,ERE,0,BLANK:\([AZ]+\)|\(([AZ]+\,){1,3}[AZ]+\)--end% %msg:R,ERE,0,DFLT:[ax]+--end% %msg:F,32:2% %msg:R,ERE,0,DFLT:[0-9]+$--end%\n" if ($fromhost-ip == '192.168.0.230') then {action(type="omfile" file="/var/log/remote/192.168.0.230.log" )} if ($fromhost-ip == '192.168.0.230') then {action(type="omfile" file="/var/log/remote/192.168.0.230.log" template="tpl_traflog_test" ) stop}</code> </pre> <br>  Starten Sie den Logger neu. <br><br>  Die Vorlage tpl_traflog_test √§hnelt tpl_traflog, jedoch ohne SQL INSERT. <br><br>  Die erste Bedingung f√ºgt der Datei /var/log/remote/192.168.0.230.log die unverarbeitete Zeile% msg% hinzu, da die Vorlage nicht angegeben ist. <br><br>  Die zweite Bedingung f√ºgt die verarbeitete Zeile derselben Datei hinzu. <br>  So wird es bequemer zu vergleichen. <br>  Bereiten Sie als N√§chstes die Datenbank vor. <br><br><h4>  <b>Wir bereiten eine DB vor</b> </h4><br>  Wir werden die DBMS-Einstellung verringern, hier ist alles Standard. <br><br>  Wir starten die MySQL-Konsole und f√ºhren den folgenden Code aus: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   create database traflog character set utf8 collate utf8_bin; use traflog; --  create table traffic (id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY, datetime DATETIME, inif VARCHAR(20), outif VARCHAR(20), src VARCHAR(21), sport INT(5), dst VARCHAR(21), dport INT(5), smac VARCHAR(17), proto VARCHAR(4), flags VARCHAR(11), chain VARCHAR(8), logpref VARCHAR(24), len INT(5)) ENGINE=MYISAM; --  create user rsyslogger@localhost identified by '...'; grant all privileges on traflog.* to rsyslogger@localhost;</span></span></code> </pre><br>  Die Tabelle ist fertig, der Benutzer ist. <br><br>  F√ºgen Sie nun einen Trigger hinzu, der das tut, was der Logger nicht konnte, um die Adresse vom Port zu trennen, die Namen der Schnittstellen zu bereinigen und die Klammern vom Flag zu entfernen: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   traffic DELIMITER // create TRIGGER delim_ip_port_flags BEFORE insert ON traffic FOR EACH ROW begin set NEW.inif = REGEXP_REPLACE ((NEW.inif), 'in:', '' ); set NEW.outif = REGEXP_REPLACE ((NEW.outif), 'out:', '' ); set NEW.sport = REGEXP_REPLACE ((NEW.src), '([0-9]+\.){3}[0-9]+:|([0-9]+\.){3}[0-9]+', '' ); set NEW.src = REGEXP_REPLACE ((NEW.src), ':[0-9]+', '' ); set NEW.dport = REGEXP_REPLACE ((NEW.dst), '([0-9]+\.){3}[0-9]+:|([0-9]+\.){3}[0-9]+', '' ); set NEW.dst = REGEXP_REPLACE ((NEW.dst), ':[0-9]+', '' ); set NEW.flags = REGEXP_REPLACE ((NEW.flags), '\\(|\\)', '' ); end // delimiter ;</span></span></code> </pre> <br>  REGEXP_REPLACE sucht nach dem zweiten Parameter nach dem Dezimalpunkt (regul√§re Saison) und ersetzt ihn durch den dritten Parameter. In unserem Fall enth√§lt das Anf√ºhrungszeichen nichts. Daher wird einfach entfernt, was gefunden wurde. <br><br>  Lassen Sie uns eine Testeinf√ºgung erstellen, √§hnlich wie der Logger: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   insert into traffic (datetime, inif, outif, src, dst, smac, proto, chain, logpref) values (20180730075437, 'in:ether6', 'out:VLAN55', '192.168.0.234:4997', '192.168.6.18:65535', '00:15:17:31:b8:d7', 'TCP', '(SYN)', 'forward', 'BLOCKSMKNETS');</span></span></code> </pre> <br>  Mal sehen, was passiert ist: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tarffic;</code> </pre> <br>  Wenn alles korrekt ist, fahren Sie fort.  Wenn nicht, suchen Sie nach dem Fehler. <br><br>  F√ºgen Sie mindestens einen Index hinzu.  Ich bin kein Meister im Erstellen von Indizes, aber so wie ich es verstehe, ist es in MySQL korrekter, Indizes mit unterschiedlichen Verkn√ºpfungsfeldern f√ºr unterschiedliche Abfragen zu verwenden, da eine Abfrage nur einen Index verwenden kann (oder irre ich mich?).  Wenn Sie verstehen, tun Sie es nach Ihrem Ermessen. <br>  Ich muss oft Anfragen mit einem bestimmten Pr√§fix stellen, deshalb habe ich diesen Index hinzugef√ºgt: <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--  create index traffic_index on traffic (datetime,logpref,src);</span></span></code> </pre> <br>  Fertig. <br><br>  Jetzt m√ºssen Sie mit dem Senden auf dem Router beginnen, die Einstellungen und Aktionen des Remote-Protokollservers hinzuf√ºgen, die Protokolloption zu einer der Firewall-Regeln hinzuf√ºgen und ein Pr√§fix von nicht mehr als 24 Zeichen hinzuf√ºgen. <br><br>  In der Mikrotik-Konsole sieht es ungef√§hr so ‚Äã‚Äãaus: <br><br><pre> <code class="plaintext hljs">/system logging action set 3 remote=192.168.0.94 src-address=192.168.0.230 add name=remote2 remote=192.168.0.19 syslog-facility=local6 target=remote /system logging add action=remote topics=error,account,critical,event,info add action=remote2 topics=firewall /ip firewall filter ... add action=drop chain=input comment="drop ssh brute forcers" dst-port=22,8291 log=yes log-prefix=DROP_SSH_BRUTE protocol=tcp src-address-list=ssh_blacklist ...</code> </pre><br>  W√§hrend 192.168.0.230 die Adresse des Routers ist, 192.168.0.19 die Adresse des Protokollservers f√ºr die Firewall-Protokolle ist und 192.168.0.94 ein anderer Protokollserver ist, liegen Mikrotik-Systemprotokolle dort, wir brauchen sie jetzt nicht.  Unser Setup ist remote2. <br><br>  Als n√§chstes sehen Sie, was in die Datei f√§llt: <br><br><pre> <code class="plaintext hljs">tail -f /var/log/remote/192.168.0.230.log</code> </pre> <br>  Zeilen vom Router sollten in die Datei gestreut werden, es sei denn, Ihre Regel wird h√§ufig ausgel√∂st. <br><br>  Wenn einige Felder fehlen, dh die Sequenz datetime, inif, outif, src, dst, smac, proto, flags, chain, logpref, len nicht befolgt wird, k√∂nnen Sie versuchen, den Parameter in den Debugging-Vorlagen des Loggers zu √§ndern und BLANK durch DLFT zu ersetzen.  Anstelle der Leere eines Feldes erscheinen dann einige Buchstaben. Ich kann mich nicht erinnern, welche bereits vorhanden sind.  In diesem Fall stimmt etwas mit dem regul√§ren Zeitplan nicht und Sie m√ºssen ihn beheben. <br><br>  Wenn alles so lief, wie es sollte, schalten Sie die Testbedingungen und die Vorlage aus. <br><br>  Sie m√ºssen auch die Standardkonfiguration in /etc/rsyslog.d/ ausf√ºhren. Ich habe sie in 50-default.conf umbenannt, damit Remote-Protokolle nicht in das Systemprotokoll / var / log / message eingef√ºgt werden <br>  Starten Sie den Logger neu. <br><br>  Warten wir etwas, bis unsere Datenbank voll ist.  Dann k√∂nnen wir mit der Auswahl beginnen. <br><br>  <b>Einige Fragen zum Beispiel:</b> <br><br><div class="spoiler">  <b class="spoiler_title">So zeigen Sie die Gr√∂√üe der Datenbank und die Anzahl der Zeilen an:</b> <div class="spoiler_text"><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> table_schema <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"database"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_length + index_length)/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"size Mb"</span></span>, TABLE_ROWS <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"count rows"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> information_schema.tables <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> table_schema; +<span class="hljs-comment"><span class="hljs-comment">--------------------+---------+------------+ | database | size Mb | count rows | +--------------------+---------+------------+ | information_schema | 0.17 | NULL | | traflog | 3793.39 | 21839553 | +--------------------+---------+------------+ 2 rows in set (0.48 sec)</span></span></code> </pre><br>  In einem Monat sind fast 4 GB gewachsen, dies h√§ngt jedoch von der Anzahl und den Eigenschaften der protokollierten Firewall-Regeln ab <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Anzahl der protokollierten Pr√§fixe</b> <div class="spoiler_text">  Die Anzahl der protokollierten Pr√§fixe entspricht nicht der Anzahl der Regeln. Einige Regeln arbeiten mit einem Pr√§fix, aber wie viele Gesamtpr√§fixe gibt es noch?  und wie viele Regeln wurden f√ºr sie ausgearbeitet?: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> logpref,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(logpref) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> logpref <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(logpref) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; +<span class="hljs-comment"><span class="hljs-comment">----------------------+----------------+ | logpref | count(logpref) | +----------------------+----------------+ | ACCEPT_TORF_INET | 14582602 | | ACCEPT_SMK_PPP | 1085791 | | DROP_FORWARD_INVALID | 982374 | | REJECT_BNK01 | 961503 | | ACCEPT_MMAX_TORF | 802455 | | ACCEPT_TORF_PPP | 736803 | | SMTP_DNAT | 689533 | | ACCEPT_SMK_INET | 451411 | | ACCEPT_INET_TORF | 389857 | | BLOCK_SMKNETS | 335424 | | DROP_SMTP_BRUTE | 285850 | | ACCEPT_ROZN_TORF | 154811 | | ACCEPT_TORF_MMAX | 148393 | | DROP_ETHALL_ETHALL | 80679 | | ACCEPT_SMTP | 48921 | | DROP_SMTP_DDOS | 32190 | | RDP_DNAT | 28757 | | ACCEPT_TORF_ROZN | 18456 | | SIP_DNAT | 15494 | | 1CWEB_DNAT | 6406 | | BLOCKSMKNETS | 5789 | | DROP_SSH_BRUTE | 3162 | | POP_DNAT | 1997 | | DROP_RDP_BRUTE | 442 | | DROP_BNK01 | 291 | | DROPALL | 138 | | ACCEPT_RTP_FORWARD | 90 | | REJECT_SMTP_BRUTE | 72 | | L2TP_INPUT_ACCEPT | 33 | +----------------------+----------------+ 29 rows in set (2 min 51.03 sec)</span></span></code> </pre> <br>  ACCEPT_TORF_INET ist f√ºhrend. Mit diesem Pr√§fix k√∂nnen Sie jeden finden, der √ºber unser lokales Netzwerk ins Internet gegangen ist. Protokolle und Ports werden aufgezeichnet. Die Zeit wird kommen und der Zugriff wird f√ºr einige geschlossen.  Es gibt Referenzdaten f√ºr zuk√ºnftige Arbeiten an Fehlern. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Smtp Speerf√ºhrer</b> <div class="spoiler_text">  Mal sehen, wer heute versucht hat, zum SMTP-Server zu gelangen: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'SMTP_DNAT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> datetime &gt; <span class="hljs-string"><span class="hljs-string">'2018101600000000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>; +<span class="hljs-comment"><span class="hljs-comment">----------------+--------------+ | src | count(dport) | +----------------+--------------+ | 191.96.249.92 | 12440 | | 191.96.249.24 | 4556 | | 191.96.249.61 | 4537 | | 185.255.31.122 | 3119 | | 178.57.79.250 | 226 | | 185.36.81.174 | 216 | | 185.234.219.32 | 211 | | 89.248.162.145 | 40 | | 45.125.66.157 | 32 | | 188.165.124.31 | 21 | +----------------+--------------+ 10 rows in set, 1 warning (21.36 sec)</span></span></code> </pre> <br>  Der Knoten 191.96.249.92 ist heute eindeutig der Gewinner.  Mal sehen, in welchen protokollierten Regeln er noch auftauchte: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,dport,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport),logpref <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> src=<span class="hljs-string"><span class="hljs-string">'191.96.249.92'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> logpref <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; +<span class="hljs-comment"><span class="hljs-comment">---------------+-------+--------------+-----------------+ | src | dport | count(dport) | logpref | +---------------+-------+--------------+-----------------+ | 191.96.249.92 | 25 | 226989 | SMTP_DNAT | | 191.96.249.92 | 25 | 170714 | DROP_SMTP_BRUTE | | 191.96.249.92 | 25 | 2907 | DROP_SMTP_DDOS | | 191.96.249.92 | 25 | 2061 | ACCEPT_SMTP | +---------------+-------+--------------+-----------------+ 4 rows in set (10 min 44.21 sec)</span></span></code> </pre><br>  Dieser ist nur auf SMTP spezialisiert, ~ 1% der Treffer f√ºr den Versuch, das Passwort zu erraten oder etwas M√ºll zu schicken, der Rest ging ins Badehaus. <br><br>  Die Anfrage hat 10 Minuten gedauert, das ist viel, die aktuellen Indizes sind nicht daf√ºr geeignet, oder Sie k√∂nnen die Anfrage neu formulieren, aber jetzt werden wir nicht dar√ºber sprechen. <br></div></div><br>  In Zukunft ist geplant, die Weboberfl√§che mit Standardabfragen und -formularen zu verschrauben. <br>  Der Vektor ist gegeben, ich hoffe, dass dieser Artikel n√ºtzlich sein wird. <br><br>  Danke an alle! <br><br>  <b>Referenzliste:</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Rsyslog-Dokumentation</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">MySQL-Dokumentation</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mikrotik-Protokollierungsdokumentation</a> <br><br>  Vielen Dank an die LOR-Community f√ºr die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Tipps.</a> <br><br>  <b>UPD.1</b> <br>  Das Flag-Feld wurde zur Datenbank hinzugef√ºgt. Jetzt k√∂nnen Sie die Verbindungsdauer verfolgen, indem Sie SYN, FIN abrufen. <br>  Einige Fehler in rsyslog-Stammg√§sten sowie MySQL-Trigger wurden behoben. <br><br>  Seltsamerweise l√∂scht die Standardregel defconf: drop invalid alle endg√ºltigen Pakete von TCP-Verbindungen. Infolgedessen schlagen alle Knoten, die versuchen, die Verbindung in der Wissenschaft zu schlie√üen, fehl und senden mehrere FINs.  Ist das richtig <br><br>  Ich habe eine Regel hinzugef√ºgt, die das Durchlaufen von TCP mit ACK- und FIN-Flags erm√∂glicht. <br><br>  Unter dem SQL-Spoiler eine Prozedur, die die Zeit der TCP-Verbindungen in den letzten f√ºnf Minuten anzeigt <br><div class="spoiler">  <b class="spoiler_title">verbindungsliste ()</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> connections_list; DELIMITER // <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> connections_list() <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> logid <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> done <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> datefin DATETIME; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> datesyn DATETIME; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conntime <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> connsport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conndport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> connsrc <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conndst <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> cur <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>,datetime,src,sport,dst,dport <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> conn_syn_fin <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> flags=<span class="hljs-string"><span class="hljs-string">'SYN'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> CONTINUE <span class="hljs-keyword"><span class="hljs-keyword">HANDLER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOUND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> done=<span class="hljs-literal"><span class="hljs-literal">TRUE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> conn_syn_fin; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> connless; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> connless(datestart DATETIME,dateend DATETIME,<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>,src <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>),sport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>,dst <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>),dport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> conn_syn_fin (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> datetime &gt; <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime &gt; <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'TCP_FIN'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%SYN%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); OPEN cur; read_loop: LOOP FETCH cur INTO logid,datesyn,connsrc,connsport,conndst,conndport; IF done THEN LEAVE read_loop; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> datefin=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> conn_syn_fin <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&gt;logid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> src=connsrc <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> sport=connsport <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dst=conndst <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dport=conndport <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> conntime=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timediff</span></span>(datefin,datesyn)); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> connless (datestart,dateend,<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>,src,sport,dst,dport) <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> (datesyn,datefin,conntime,connsrc,connsport,conndst,conndport); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; CLOSE cur; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> connless; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; // DELIMITER ;</code> </pre><br></div></div><br>  Als Ergebnis der Prozedur werden zwei tempor√§re Tabellen erstellt. <br>  Die Tabelle <b>conn_syn_fin</b> enth√§lt Protokolleintr√§ge mit den Flags SYN und FIN. Anschlie√üend wird eine Suche mit dem Cursor in dieser Tabelle durchgef√ºhrt. <br>  Die <b>connless-</b> Tabelle enth√§lt eine Liste von Verbindungen, offen und abgeschlossen, abgeschlossen haben eine Dauer von offen bzw. Nr. <br>  Notieren Sie die Abtastzeit minus f√ºnf Minuten von der aktuellen Zeit.  Meine Anfrage ist langsam.  Langsam durchl√§uft es die Cursorsuche, verarbeitet ungef√§hr 10 Datens√§tze pro Sekunde und versucht, sie in jeder Hinsicht zu beschleunigen, aber die Ausf√ºhrungszeit ist immer ungef√§hr gleich. <br>  Beachten Sie auch, dass dieses Verfahren nur zu Demonstrationszwecken dient.  Wenn Sie eine Auswahl f√ºr einen bestimmten src / sport / dst / dport treffen m√ºssen, ist es besser, ein separates Verfahren √§hnlich diesem zu erstellen.  Wenn Sie ein SQL-Master sind, k√∂nnen Sie Ihre Abfrage besser schreiben. <br><br><div class="spoiler">  <b class="spoiler_title">call connection_list ();</b> <div class="spoiler_text"><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> connections_list(); +<span class="hljs-comment"><span class="hljs-comment">---------------------+---------------------+----------+---------------+-------+-----------------+-------+ | datestart | dateend | duration | src | sport | dst | dport | +---------------------+---------------------+----------+---------------+-------+-----------------+-------+ | 2019-03-20 14:12:19 | 2019-03-20 14:13:14 | 00:00:55 | 192.168.0.81 | 41868 | 87.250.250.207 | 443 | | 2019-03-20 14:12:25 | NULL | NULL | 192.168.0.65 | 49311 | 52.5.23.125 | 443 | | 2019-03-20 14:12:31 | 2019-03-20 14:12:51 | 00:00:20 | 192.168.0.104 | 54433 | 217.69.139.42 | 443 | | 2019-03-20 14:12:31 | 2019-03-20 14:12:51 | 00:00:20 | 192.168.0.104 | 54434 | 217.69.139.42 | 443 | | 2019-03-20 14:12:32 | NULL | NULL | 192.168.0.119 | 37977 | 209.85.233.95 | 443 | ... | 2019-03-20 14:17:12 | NULL | NULL | 192.168.0.119 | 39331 | 91.213.158.131 | 443 | | 2019-03-20 14:17:13 | NULL | NULL | 192.168.0.90 | 63388 | 87.240.185.236 | 443 | +---------------------+---------------------+----------+---------------+-------+-----------------+-------+ 399 rows in set (33.17 sec) Query OK, 0 rows affected (33.18 sec)</span></span></code> </pre><br></div></div><br><br>  Nachdem der Vorgang abgeschlossen ist, bleiben die tempor√§ren Tabellen <b>conn_syn_fin</b> und <b>connless</b> erhalten. Sie k√∂nnen sie genauer betrachten, wenn Sie etwas Verd√§chtiges oder <b>Unzuverl√§ssiges</b> finden.  Nach dem Start des Vorgangs werden die alten Tabellen gel√∂scht und neue angezeigt.  Schreiben Sie, wenn Sie einen Fehler finden. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de427159/">https://habr.com/ru/post/de427159/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de427147/index.html">‚ÄûBIAN-Referenzmodell‚Äú f√ºr die Bankenbranche oder wie man aufh√∂rt, das Rad neu zu erfinden</a></li>
<li><a href="../de427149/index.html">RADIOTEHNIKA S-30 Lautsprecher alt bis neu</a></li>
<li><a href="../de427151/index.html">Der Bildungsprozess in der IT: Olympiaden, Stipendien, Unterst√ºtzungsprogramme und Gemeinschaften der ITMO-Universit√§t</a></li>
<li><a href="../de427153/index.html">DNA Mechanismen zum Speichern und Verarbeiten von Informationen. Teil II</a></li>
<li><a href="../de427155/index.html">Southampton Filter Bus - Der erste Schritt zu saubereren St√§dten</a></li>
<li><a href="../de427163/index.html">Neues Material wird dazu beitragen, thermische Solarkraftwerke effizienter zu machen</a></li>
<li><a href="../de427165/index.html">So entwickeln Sie Integrationstests f√ºr Atlassian Jira Server (jira-func-test-plugin)</a></li>
<li><a href="../de427169/index.html">Tesla entfernte leise die vollst√§ndige Autopilot-Option</a></li>
<li><a href="../de427171/index.html">Sicherheit verl√§sst dich</a></li>
<li><a href="../de427173/index.html">Ist Telefonie billiger als kostenlos?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>