<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õëÔ∏è ‚úîÔ∏è üë®üèø‚Äçüî¨ Otra biblioteca simulada üõ£Ô∏è ‚ò™Ô∏è üßìüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Buenas tardes Estoy comprometido con la automatizaci√≥n de pruebas. Como todos los ingenieros de automatizaci√≥n, tengo un conjunto de bibliotecas y her...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Otra biblioteca simulada</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476904/"><p> Buenas tardes  Estoy comprometido con la automatizaci√≥n de pruebas.  Como todos los ingenieros de automatizaci√≥n, tengo un conjunto de bibliotecas y herramientas que generalmente elijo para escribir pruebas.  Pero peri√≥dicamente hay situaciones en las que ninguna de las bibliotecas familiares puede resolver el problema con el riesgo de hacer que las auto-pruebas sean inestables o fr√°giles.  En este art√≠culo, me gustar√≠a contarles c√≥mo la tarea aparentemente est√°ndar de usar mock'ov me llev√≥ a escribir mi m√≥dulo.  Tambi√©n me gustar√≠a compartir mi decisi√≥n y escuchar comentarios. </p><a name="habracut"></a><br><h1>  App </h1><br><p>  Uno de los sectores necesarios en el sector financiero es la auditor√≠a.  Los datos deben verificarse regularmente (conciliaci√≥n).  En este sentido, apareci√≥ la aplicaci√≥n que prob√©.  Para no hablar de algo abstracto, imaginemos que nuestro equipo est√° desarrollando una aplicaci√≥n para procesar aplicaciones de mensajer√≠a instant√°nea.  Para cada aplicaci√≥n, se debe crear un evento apropiado en elasticsearch.  La aplicaci√≥n de verificaci√≥n ser√° nuestro monitoreo de que las aplicaciones no se omiten. </p><br><p>  Entonces, imagine que tenemos un sistema que tiene los siguientes componentes: </p><br><ol><li>  Servidor de configuraci√≥n.  Para el usuario, este es un punto de entrada √∫nico donde configura no solo la aplicaci√≥n para la verificaci√≥n, sino tambi√©n otros componentes del sistema. </li><li>  Solicitud de verificaci√≥n. </li><li>  Datos de la aplicaci√≥n que procesan aplicaciones que se almacenan en elasticsearch. </li><li>  Datos de referencia  El formato de datos depende del mensajero con el que est√° integrada la aplicaci√≥n. </li></ol><br><h1>  Desaf√≠o </h1><br><p>  Las pruebas de automatizaci√≥n en este caso parecen bastante sencillas: </p><br><ol><li>  Preparaci√≥n del medio ambiente: <br><ul><li>  Elasticsearch se instala con una configuraci√≥n m√≠nima (usando msi y la l√≠nea de comando). </li><li>  Se instala una aplicaci√≥n de verificaci√≥n. </li></ul></li><li>  Prueba de ejecuci√≥n: <br><ul><li>  Se configura una aplicaci√≥n de verificaci√≥n. </li><li>  Elasticsearch se llena con datos de prueba para la prueba correspondiente (cu√°ntas aplicaciones se procesaron). </li><li>  La aplicaci√≥n recibe datos de "referencia" del messenger (cu√°ntas aplicaciones se supon√≠a que realmente eran). </li><li>  Se verifica el veredicto emitido por la aplicaci√≥n: la cantidad de aplicaciones verificadas con √©xito, la cantidad de aplicaciones faltantes, etc. </li></ul></li><li>  Limpieza del medio ambiente. </li></ol><br><p>  El problema es que estamos probando el monitoreo, pero para configurarlo, necesitamos datos del servidor de configuraci√≥n.  En primer lugar, instalar y configurar un servidor para cada ejecuci√≥n es una operaci√≥n que requiere mucho tiempo (tiene su propia base, por ejemplo).  En segundo lugar, quiero aislar las aplicaciones para simplificar la localizaci√≥n de problemas al encontrar un defecto.  Al final, se decidi√≥ usar simulacro. </p><br><p>  Esto puede plantear la pregunta: "Si todav√≠a nos burlamos del servidor, tal vez no podamos pasar tiempo instalando y llenando Elasticsearch, ¬øpero reemplazar el simulacro?  Pero a√∫n as√≠, siempre debe recordar que el uso de simulacro proporciona flexibilidad, pero agrega la obligaci√≥n de controlar la relevancia del comportamiento simulado.  Por lo tanto, me negu√© a reemplazar elasticsearch: es bastante simple instalarlo y llenarlo. </p><br><h1>  Primer simulacro </h1><br><p> El servidor env√≠a la configuraci√≥n a las solicitudes GET de varias maneras en / configuration.  Estamos interesados ‚Äã‚Äãen dos formas.  El primero es <code>/configuration/data_cluster</code> con configuraci√≥n de cl√∫ster </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-attr"><span class="hljs-attr">"credentials"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span> } }</code> </pre> <br><p>  El segundo es <code>/configuration/reconciliation</code> con la configuraci√≥n de la aplicaci√≥n de perforaci√≥n </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"reconciliation_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">3600</span></span>, <span class="hljs-attr"><span class="hljs-attr">"configuration_update_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"file:///c:/path"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"credentials"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span> } } }</code> </pre> <br><p>  La dificultad es que necesita poder cambiar la respuesta del servidor durante la prueba o entre pruebas para probar c√≥mo responde la aplicaci√≥n a los cambios de configuraci√≥n, contrase√±as incorrectas, etc. </p><br><p>  Por lo tanto, los simulacros est√°ticos y las herramientas para simulacros en las pruebas unitarias (simulacro, monkeypatch de pytest, etc.) no funcionar√°n para nosotros.  Encontr√© una gran biblioteca de <code>pretenders</code> que pens√© que era adecuada para m√≠.  <a href="https://pretenders.readthedocs.io/en/latest/" title="Lea la documentaci√≥n de Pretenders">Pretenders</a> proporciona la capacidad de crear un servidor HTTP con reglas que determinan c√≥mo responder√° el servidor a las solicitudes.  Las reglas se almacenan en preajustes, lo que permite aislar simulacros para diferentes conjuntos de pruebas.  Los ajustes preestablecidos se pueden borrar y volver a llenar, lo que le permite actualizar las respuestas seg√∫n sea necesario.  Es suficiente elevar el servidor una vez durante la preparaci√≥n del entorno: </p><br><pre> <code class="bash hljs">python -m pretenders.server.server --host 127.0.0.1 --port 8000</code> </pre> <br><p>  Y en las pruebas necesitamos agregar el uso del cliente.  En el caso m√°s simple, cuando las respuestas est√°n completamente codificadas en las pruebas, puede verse as√≠: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pretenders.client.http <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> HTTPMock <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pretenders.common.constants <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FOREVER @pytest.fixture <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configuration_server_mock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> mock = HTTPMock(host=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, port=<span class="hljs-number"><span class="hljs-number">8000</span></span>, name=<span class="hljs-string"><span class="hljs-string">"server"</span></span>) request.addfinalizer(mock.reset) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_something</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration_server_mock)</span></span></span><span class="hljs-function">:</span></span> configuration_server_mock.when(<span class="hljs-string"><span class="hljs-string">"GET /configuration/data_cluster"</span></span>).reply( headers={<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, body=json.dumps({ <span class="hljs-string"><span class="hljs-string">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, }), status=<span class="hljs-number"><span class="hljs-number">200</span></span>, times=FOREVER, ) configuration_server_mock.when(<span class="hljs-string"><span class="hljs-string">"GET /configuration/reconciliation"</span></span>).reply( headers={<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, body=json.dumps({ <span class="hljs-string"><span class="hljs-string">"reconciliation_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">3600</span></span>, <span class="hljs-string"><span class="hljs-string">"configuration_update_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"source"</span></span>: { <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"file:///c:/path"</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, }, }), status=<span class="hljs-number"><span class="hljs-number">200</span></span>, times=FOREVER, ) <span class="hljs-comment"><span class="hljs-comment"># test application</span></span></code> </pre> <br><p>  Pero eso no es todo.  Con su flexibilidad, <code>pretenders</code> tiene dos limitaciones que deben recordarse y deben abordarse en nuestro caso: </p><br><ol><li>  Las reglas no se pueden eliminar de una en una.  Para cambiar la respuesta, debe eliminar todo el preajuste y volver a crear todas las reglas. </li><li>  Todas las rutas utilizadas en las reglas son relativas.  Los ajustes preestablecidos tienen una ruta √∫nica de la forma / mockhttp / &lt;preset_name&gt;, y esta ruta es un prefijo com√∫n para todas las rutas creadas en las reglas.  La aplicaci√≥n bajo prueba recibe solo el nombre de host y no puede conocer el prefijo. </li></ol><br><p>  La primera limitaci√≥n es muy desagradable, pero se puede resolver escribiendo un m√≥dulo que encapsule el trabajo con la configuraci√≥n.  Por ejemplo, entonces </p><br><pre> <code class="python hljs">configuration.data_cluster.port = <span class="hljs-number"><span class="hljs-number">443</span></span></code> </pre> <br><p>  o (para realizar solicitudes de actualizaci√≥n con menos frecuencia) </p><br><pre> <code class="python hljs">data_cluster_config = get_default_data_cluster_config() data_cluster_config.port = <span class="hljs-number"><span class="hljs-number">443</span></span> configuration.update_data_cluster(data_cluster_config)</code> </pre> <br><p>  Tal encapsulaci√≥n nos permite actualizar todas las rutas casi sin dolor.  Tambi√©n puede crear un preajuste individual para cada punto final individual y un preajuste general (principal), redirigiendo (a trav√©s de 307 o 308) a los individuales.  Entonces solo puede borrar un preset para actualizar la regla. </p><br><p>  Para deshacerse de los prefijos, puede usar la biblioteca <a href="https://mitmproxy.org/" title="Ir al sitio web mitmproxy">mitmproxy</a> .  Esta es una herramienta poderosa que permite, entre otras cosas, redirigir solicitudes.  Eliminaremos los prefijos de la siguiente manera: </p><br><pre> <code class="bash hljs">mitmdump --mode reverse:http://127.0.0.1:8000 --replacements :~http:^/:/mockhttp/server/ --listen-host 127.0.01 --listen-port 80</code> </pre> <br><p>  Los par√°metros de este comando hacen lo siguiente: </p><br><ol><li>  <code>--listen-host 127.0.0.1</code> y <code>--listen-port 80</code> obvios.  Mitmproxy eleva su servidor, y con estos par√°metros determinamos la interfaz y el puerto que escuchar√° este servidor. </li><li>  <code>--mode reverse:http://127.0.0.1:8000</code> significa que las solicitudes al servidor mitproxy ser√°n redirigidas a <code>http://127.0.0.1:8000</code> .  Lee m√°s <a href="https://docs.mitmproxy.org/stable/concepts-modes/" title="Documentaci√≥n de varios modos.">aqu√≠</a> . </li><li>  <code>--replacements :~http:^/:/mockhttp/server/</code> define una plantilla mediante la cual se modificar√°n las solicitudes.  Consta de tres partes: un filtro de solicitud ( <code>~http</code> para solicitudes HTTP), una plantilla para cambiar ( <code>^/</code> para reemplazar el comienzo de la ruta) y reemplazar ( <code>/mockhttp/server</code> ).  Lee m√°s <a href="https://docs.mitmproxy.org/stable/overview-features/" title="Documentaci√≥n de funcionalidad">aqu√≠</a> . </li></ol><br><p>  En nuestro caso, agregamos <code>mockhttp/server</code> a todas las solicitudes HTTP y las redirigimos a <code>http://127.0.0.1:8000</code> , es decir  a nuestros pretendientes de servidor.  Como resultado, hemos logrado que ahora la configuraci√≥n se pueda obtener con una solicitud GET a <code>http://127.0.0.1/configuration/data_cluster</code> . </p><br><p>  En general, qued√© satisfecho con el dise√±o con <code>pretenders</code> y <code>mitmproxy</code> .  Con la aparente complejidad, despu√©s de todo, 2 servidores en lugar de uno real, la preparaci√≥n consiste en instalar 2 paquetes y ejecutar 2 comandos en la l√≠nea de comandos para iniciarlos.  No todo es tan simple en la gesti√≥n de un simulacro, pero toda la complejidad radica en un solo lugar (gesti√≥n de presets) y se resuelve de manera bastante simple y confiable.  Sin embargo, aparecieron nuevas circunstancias en el problema que me hicieron pensar en una nueva soluci√≥n. </p><br><h1>  Segundo simulacro </h1><br><p>  Hasta ese momento, casi no dije de d√≥nde proven√≠an los datos de referencia.  Un lector atento podr√≠a notar que en el ejemplo anterior, la ruta al sistema de archivos se usa como la direcci√≥n de origen de datos.  Y realmente funciona de esta manera, pero solo para uno de los proveedores.  Otro proveedor proporciona una API para recibir aplicaciones, y fue con √©l que surgi√≥ un problema.  Es dif√≠cil aumentar la API del proveedor durante las pruebas, por lo que plane√© reemplazarlo con simulacro de acuerdo con el mismo esquema que antes.  Pero para recibir solicitudes, una solicitud del formulario </p><br><pre> <code class="plaintext hljs">GET /application-history?page=2&amp;size=5&amp;start=1569148012&amp;end=1569148446</code> </pre> <br><p>  Hay 2 puntos aqu√≠.  En primer lugar, algunas opciones.  El hecho es que los par√°metros se pueden especificar en cualquier orden, lo que complica enormemente la expresi√≥n regular de la regla de <code>pretenders</code> .  Tambi√©n es necesario recordar que los par√°metros son opcionales, pero esto no es un problema como el orden aleatorio.  En segundo lugar, los √∫ltimos par√°metros (inicio y fin) especifican el intervalo de tiempo para filtrar el pedido.  Y el problema en este caso es que no podemos predecir de antemano qu√© intervalo (no la magnitud, sino el tiempo de inicio) ser√° utilizado por la aplicaci√≥n para formar la respuesta simulada.  En pocas palabras, necesitamos conocer y usar los valores de los par√°metros para formar una respuesta "razonable".  La "razonabilidad" en este caso es importante, por ejemplo, para que podamos probar que la aplicaci√≥n pasa por todas las p√°ginas de la paginaci√≥n: si respondemos a todas las solicitudes de la misma manera, no podremos encontrar defectos debido al hecho de que solo se solicita una de cada cinco p√°ginas . </p><br><p>  Intent√© buscar soluciones alternativas, pero al final decid√≠ escribir la m√≠a.  Entonces hab√≠a un <a href="https://github.com/KillAChicken/loose-server" title="Ir al repositorio y documentaci√≥n">servidor suelto</a> .  Esta es una aplicaci√≥n <a href="https://palletsprojects.com/p/flask/" title="Ir a la p√°gina del proyecto">Flask</a> en la que se pueden configurar rutas y respuestas despu√©s de que se inicia.  Fuera de la caja, √©l sabe c√≥mo trabajar con reglas para el tipo de solicitud (GET, POST, etc.) y para la ruta.  Esto le permite reemplazar <code>pretenders</code> y <code>mitmproxy</code> en la tarea original.  Tambi√©n mostrar√© c√≥mo se puede usar para crear un simulacro para la API del proveedor. </p><br><p>  Una aplicaci√≥n necesita 2 rutas principales: </p><br><ol><li>  Punto final base.  Este es el mismo prefijo que se usar√° para todas las reglas configuradas. </li><li>  Punto final de configuraci√≥n.  Este es el prefijo de esas solicitudes con las que puede configurar el servidor simulado. </li></ol><br><pre> <code class="bash hljs">python -m looseserver.default.server.run --host 127.0.0.1 --port 80 --base-endpoint / --configuration-endpoint /_mock_configuration/</code> </pre> <br><p>  En general, es mejor no configurar el punto final base y el punto final de configuraci√≥n para que uno sea el padre del otro.  De lo contrario, existe el riesgo de que las rutas de configuraci√≥n y prueba entren en conflicto.  El punto final de la configuraci√≥n tendr√° prioridad, ya que las reglas de Flask se agregan para la configuraci√≥n antes que para las rutas din√°micas.  En nuestro caso, podr√≠amos usar <code>--base-endpoint /configuration/</code> si no √≠bamos a incluir la API del proveedor en este simulacro. </p><br><p>  La versi√≥n m√°s simple de las pruebas no cambia mucho. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.http <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> HTTPClient <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PathRule <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.response <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FixedResponse @pytest.fixture <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configuration_server_mock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MockFactory</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self._client = HTTPClient(configuration_url=<span class="hljs-string"><span class="hljs-string">"http://127.0.0.1/_mock_configuration/"</span></span>) self._rule_ids = [] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_rule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, path, json_response)</span></span></span><span class="hljs-function">:</span></span> rule = self._client.create_rule(PathRule(path=path)) self._rule_ids.append(rule.rule_id) response = FixedResponse( headers={<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, status=<span class="hljs-number"><span class="hljs-number">200</span></span>, body=json.dumps(json_response), ) self._client.set_response(rule_id=rule.rule_id, response=response) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_delete_rules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rule_id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self._rule_ids: self._client.remove_rule(rule_id=rule_id) mock = MockFactory() request.addfinalizer(mock._delete_rules) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_something</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration_server_mock)</span></span></span><span class="hljs-function">:</span></span> configuration_server_mock.create_rule( path=<span class="hljs-string"><span class="hljs-string">"configuration/data_cluster"</span></span>, json_response={ <span class="hljs-string"><span class="hljs-string">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, } ) configuration_server_mock.create_rule( path=<span class="hljs-string"><span class="hljs-string">"configuration/reconciliation"</span></span>, json_response={ <span class="hljs-string"><span class="hljs-string">"reconciliation_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">3600</span></span>, <span class="hljs-string"><span class="hljs-string">"configuration_update_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"source"</span></span>: { <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"file:///applications"</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, }, } )</code> </pre> <br><p>  La fijaci√≥n se ha vuelto m√°s dif√≠cil, pero las reglas ahora se pueden eliminar de una en una, lo que simplifica el trabajo con ellas.  Usar <code>mitmproxy</code> ya no es necesario. </p><br><p>  Volvamos a la API del proveedor.  Crearemos un nuevo tipo de reglas para un servidor suelto, que, seg√∫n el valor del par√°metro, dar√° diferentes respuestas.  A continuaci√≥n, utilizaremos esta regla para el par√°metro de p√°gina. </p><br><p>  Se deben crear nuevas reglas y respuestas tanto para el servidor como para el cliente.  Comencemos con el servidor: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.server.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ServerRule <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerParameterRule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ServerRule)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, parameter_name, parameter_value=None, rule_type=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"PARAMETER"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> super(ServerParameterRule, self).__init__(rule_type=rule_type) self._parameter_name = parameter_name self._parameter_value = parameter_value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_match_found</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self._parameter_value <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._parameter_name <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.args <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.args.get(self._parameter_name) == self._parameter_value</code> </pre> <br><p>  Cada regla debe definir un m√©todo <code>is_match_found</code> , que determina si debe funcionar para una solicitud determinada o no.  El par√°metro de entrada para ello es el objeto de solicitud.  Despu√©s de crear la nueva regla, es necesario "ense√±ar" al servidor a aceptarla del cliente.  Para hacer esto, use <code>RuleFactory</code> : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.server.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_rule_factory <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.server.application <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> configure_application <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_create_application</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(base_endpoint, configuration_endpoint)</span></span></span><span class="hljs-function">:</span></span> server_rule_factory = create_rule_factory(base_endpoint) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_parse_param_rule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rule_type, parameters)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ServerParameterRule( rule_type=rule_type, parameter_name=parameters[<span class="hljs-string"><span class="hljs-string">"parameter_name"</span></span>], parameter_value=parameters[<span class="hljs-string"><span class="hljs-string">"parameter_value"</span></span>], ) server_rule_factory.register_rule( rule_type=<span class="hljs-string"><span class="hljs-string">"PARAMETER"</span></span>, parser=_parse_param_rule, serializer=<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> rule_type, rule: <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> configure_application( rule_factory=server_rule_factory, base_endpoint=base_endpoint, configuration_endpoint=configuration_endpoint, ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">"__main__"</span></span>: application = _create_application(base_endpoint=<span class="hljs-string"><span class="hljs-string">"/"</span></span>, configuration_endpoint=<span class="hljs-string"><span class="hljs-string">"/_mock_configuration"</span></span>) application.run(host=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, port=<span class="hljs-number"><span class="hljs-number">80</span></span>)</code> </pre> <br><p>  Aqu√≠ creamos una f√°brica para las reglas de forma predeterminada, de modo que contenga las reglas que usamos antes y registremos un nuevo tipo.  En este caso, el cliente no necesita la informaci√≥n de la regla, por lo que el <code>serializer</code> realidad no hace nada.  Adem√°s, esta f√°brica se transfiere a la aplicaci√≥n.  Y ya se puede ejecutar como una aplicaci√≥n Flask normal. </p><br><p>  La situaci√≥n con el cliente es similar: creamos una regla y una f√°brica.  Pero para el cliente, en primer lugar, no es necesario definir el m√©todo <code>is_match_found</code> , y en segundo lugar, el serializador en este caso es necesario para enviar la regla al servidor. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.client.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ClientRule <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_rule_factory <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClientParameterRule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ClientRule)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, parameter_name, parameter_value=None, rule_type=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"PARAMETER"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, rule_id=None)</span></span></span><span class="hljs-function">:</span></span> super(ClientParameterRule, self).__init__(rule_type=rule_type, rule_id=rule_id) self.parameter_name = parameter_name self.parameter_value = parameter_value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_create_client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration_url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_serialize_param_rule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rule)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-string"><span class="hljs-string">"parameter_name"</span></span>: rule.parameter_name, <span class="hljs-string"><span class="hljs-string">"parameter_value"</span></span>: rule.parameter_value, } client_rule_factory = create_rule_factory() client_rule_factory.register_rule( rule_type=<span class="hljs-string"><span class="hljs-string">"PARAMETER"</span></span>, parser=<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> rule_type, parameters: ClientParameterRule(rule_type=rule_type, parameter_name=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), serializer=_serialize_param_rule, ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HTTPClient(configuration_url=configuration_url, rule_factory=client_rule_factory)</code> </pre> <br><p>  Queda por usar <code>_create_client</code> para crear el cliente, y las reglas se pueden usar en las pruebas.  En el siguiente ejemplo, agregu√© el uso de otra regla predeterminada: <code>CompositeRule</code> .  Le permite combinar varias reglas en una para que funcionen solo si cada una de ellas devuelve True para llamar a <code>is_match_found</code> . </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.fixture def configuration_server_mock(request): class MockFactory: def __init__(self): self._client = _create_client("http://127.0.0.1/_mock_configuration/") self._rule_ids = [] def create_paged_rule(self, path, page, json_response): rule_prototype = CompositeRule( children=[ PathRule(path=path), ClientParameterRule(parameter_name="page", parameter_value=page), ] ) rule = self._client.create_rule(rule_prototype) self._rule_ids.append(rule.rule_id) response = FixedResponse( headers={"Content-Type": "application/json"}, status=200, body=json.dumps(json_response), ) self._client.set_response(rule_id=rule.rule_id, response=response) ... mock = MockFactory() request.addfinalizer(mock._delete_rules) return mock def test_something(configuration_server_mock): ... configuration_server_mock.create_paged_rule( path="application-history", page=None, json_response=["1", "2", "3"], ) configuration_server_mock.create_paged_rule( path="application-history", page="1", json_response=["1", "2", "3"], ) configuration_server_mock.create_paged_rule( path="application-history", page="2", json_response=["4", "5"], )</span></span></code> </pre> <br><h1>  Conclusi√≥n </h1><br><p>  Una <code>mitmproxy</code> <code>pretenders</code> y <code>mitmproxy</code> proporciona una herramienta lo suficientemente potente y flexible para crear simulacros.  Sus ventajas: </p><br><ol><li>  F√°cil instalaci√≥n </li><li>  Capacidad para aislar conjuntos de consultas mediante ajustes preestablecidos. </li><li>  Elimina todo un conjunto aislado a la vez. </li></ol><br><p>  Por contra incluyen: </p><br><ol><li>  La necesidad de crear expresiones regulares para reglas. </li><li>  La incapacidad de cambiar las reglas individualmente. </li><li>  La presencia de un prefijo para todas las rutas creadas o el uso de redirecci√≥n utilizando <code>mitmproxy</code> . </li></ol><br><p>  Enlaces de documentaci√≥n: <br>  <a href="https://pretenders.readthedocs.io/en/latest/">Pretendientes</a> <br>  <a href="https://docs.mitmproxy.org/stable/">Mitmproxi</a> <br>  <a href="https://github.com/KillAChicken/loose-server/wiki">Servidor suelto</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/476904/">https://habr.com/ru/post/476904/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../476880/index.html">Cunas de seguridad: CSRF</a></li>
<li><a href="../476888/index.html">Qu√© tendencias de dise√±o UX seguir en 2020</a></li>
<li><a href="../476890/index.html">Para quienes trabajan en Houdini. Sobre la naturaleza de los cursos Vex y Bites of Python</a></li>
<li><a href="../476900/index.html">Dispositivo aut√≥nomo en arduino, que indica un aumento (disminuci√≥n) de la temperatura</a></li>
<li><a href="../476902/index.html">Barrymore, ¬øcu√°l es el rumor alrededor de Voximplant? Implementado sockets web, se√±or</a></li>
<li><a href="../476906/index.html">Novedades de SOLIDWORKS 2020</a></li>
<li><a href="../476908/index.html">¬øHadoop est√° muerto? Parte 2</a></li>
<li><a href="../476910/index.html">Antig√ºedades: una dif√≠cil elecci√≥n de tarjeta de sonido para juegos de DOS</a></li>
<li><a href="../476912/index.html">Derechos de c√≥digo de empresa para programadores</a></li>
<li><a href="../476914/index.html">Instalar el m√≥dulo Powershell desde el repositorio de Github</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>