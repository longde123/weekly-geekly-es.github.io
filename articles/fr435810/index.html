<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç± üçô üßëüèΩ‚Äçü§ù‚ÄçüßëüèΩ Rejoignez la collection locale et DbSet dans Entity Framework ‚òÇÔ∏è üåÅ üë©üèø‚Äçüíª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un peu plus d'un an avec ma participation, le "dialogue" suivant a eu lieu: 


 Application .Net : Hey Entity Framework, veuillez me donner beaucoup d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rejoignez la collection locale et DbSet dans Entity Framework</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435810/"><p>  Un peu plus d'un an avec ma participation, le "dialogue" suivant a eu lieu: </p><br><p>  <strong>Application .Net</strong> : Hey Entity Framework, veuillez me donner beaucoup de donn√©es! <br>  <strong>Entity Framework</strong> : D√©sol√©, je ne vous ai pas compris.  Que voulez-vous dire? <br>  <strong>Application .Net</strong> : Oui, je viens de recevoir une collection de 100 000 transactions.  Et maintenant, nous devons v√©rifier rapidement l'exactitude des prix des titres qui y sont indiqu√©s. <br>  <strong>Entity Framework</strong> : Ahh, eh bien, essayons ... <br>  <strong>Application .Net</strong> : voici le code: </p><br><pre><code class="cpp hljs">var query = from p in context.Prices join t in transactions on <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { p.Ticker, p.TradedOn, p.PriceSourceId } equals <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { t.Ticker, t.TradedOn, t.PriceSourceId } select p; query.ToList();</code> </pre> <br><p>  <strong>Cadre d'entit√©</strong> : </p><br><p><img src="https://habrastorage.org/webt/kc/jh/lp/kcjhlpnggo_fhkdgik481svjuea.png"></p><br><p>  Classique  Je pense que beaucoup de gens connaissent cette situation: quand je veux vraiment "magnifiquement" et faire rapidement une recherche dans la base de donn√©es en utilisant le <em>JOIN de la</em> collection locale et <em>DbSet</em> .  Habituellement, cette exp√©rience est d√©cevante. </p><br><p>  Dans cet article (qui est une <em>traduction gratuite de mon autre article</em> ), je vais mener une s√©rie d'exp√©riences et essayer diff√©rentes mani√®res de contourner cette limitation.  Il y aura un code (simple), des pens√©es et quelque chose comme une fin heureuse. </p><a name="habracut"></a><br><h2 id="vvedenie">  Pr√©sentation </h2><br><p>  Tout le monde conna√Æt <em>Entity Framework</em> , beaucoup l'utilisent tous les jours et il existe de nombreux bons articles sur la fa√ßon de le cuisiner correctement (utilisez des requ√™tes plus simples, utilisez les param√®tres de Skip and Take, utilisez VIEW, demandez uniquement les champs n√©cessaires, surveillez la mise en cache des requ√™tes et autre), cependant, le th√®me <em>JOIN</em> de la collection locale et <em>DbSet</em> est toujours un point faible. </p><br><h2 id="zadacha">  D√©fi </h2><br><p>  Supposons qu'il existe une base de donn√©es avec les prix et qu'il existe une collection de transactions pour lesquelles vous devez v√©rifier l'exactitude des prix.  Et supposons que nous ayons le code suivant. </p><br><pre> <code class="cpp hljs">var localData = GetDataFromApiOrUser(); var query = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId join t in localData on <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { s.Ticker, p.TradedOn, p.PriceSourceId } equals <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { t.Ticker, t.TradedOn, t.PriceSourceId } select p; var result = query.ToList();</code> </pre> <br><p>  Ce code ne fonctionne pas du tout dans <em>Entity Framework 6</em> .  Dans <em>Entity Framework Core</em> - cela fonctionne, mais tout sera fait c√¥t√© client et dans le cas o√π il y a des millions d'enregistrements dans la base de donn√©es - ce n'est pas une option. </p><br><p>  Comme je l'ai dit, je vais essayer diff√©rentes fa√ßons de contourner ce probl√®me.  Du simple au complexe.  Pour mes exp√©riences, j'utilise le code du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rentiel</a> suivant.  Le code est √©crit en utilisant: <em>C #</em> , <em>.Net Core</em> , <em>EF Core</em> et <em>PostgreSQL</em> . </p><br><p>  J'ai √©galement r√©alis√© quelques m√©triques: le temps pass√© et la consommation de m√©moire.  Avertissement: si le test a √©t√© effectu√© pendant plus de 10 minutes, je l'ai interrompu (la restriction vient d'en haut).  Test machine Intel Core i5, 8 Go de RAM, SSD. </p><br><div class="spoiler">  <b class="spoiler_title">Sch√©ma DB</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/1d5/f8c/cec/1d5f8ccec6ef1b7361195c18ac139d09.png" alt="image"></p><br><p>  Seulement 3 tableaux: <em>prix</em> , <em>titres</em> et <em>sources de prix</em> .  <em>Prix</em> - contient 10 millions d'entr√©es. </p></div></div><br><h4 id="sposob-1-naive">  M√©thode 1. Naive </h4><br><p>  Commen√ßons simplement et utilisons le code suivant: </p><br><div class="spoiler">  <b class="spoiler_title">Code pour la m√©thode 1</b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { foreach (var testElement in TestData) { result.AddRange(context.Prices.Where( x =&gt; x.Security.Ticker == testElement.Ticker &amp;&amp; x.TradedOn == testElement.TradedOn &amp;&amp; x.PriceSourceId == testElement.PriceSourceId)); } }</code> </pre> </div></div><br><p>  L'id√©e est simple: dans une boucle, nous lisons les enregistrements de la base de donn√©es un par un et les ajoutons √† la collection r√©sultante.  Ce code n'a qu'un seul avantage: la simplicit√©.  Et un inconv√©nient est la faible vitesse: m√™me s'il y a un index dans la base de donn√©es, la plupart du temps il faudra une communication avec le serveur de base de donn√©es.  Les mesures sont les suivantes: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/985/61c/b6a/98561cb6a2566faff490fc2bf7432fb9.png" alt="image"></p><br><p>  La consommation de m√©moire est faible.  Une grande collection prend 1 minute.  Pour commencer, pas mal, mais je le veux plus vite. </p><br><h4 id="sposob-2-naive-parallel">  M√©thode 2: parall√®le na√Øf </h4><br><p>  Essayons d'ajouter du parall√©lisme.  L'id√©e est d'acc√©der √† la base de donn√©es √† partir de plusieurs threads. </p><br><div class="spoiler">  <b class="spoiler_title">Code pour la m√©thode 2</b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;Price&gt;(); var partitioner = Partitioner.Create(<span class="hljs-number"><span class="hljs-number">0</span></span>, TestData.Count); Parallel.ForEach(partitioner, range =&gt; { var subList = TestData.Skip(range.Item1) .Take(range.Item2 - range.Item1) .ToList(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { foreach (var testElement in subList) { var query = context.Prices.Where( x =&gt; x.Security.Ticker == testElement.Ticker &amp;&amp; x.TradedOn == testElement.TradedOn &amp;&amp; x.PriceSourceId == testElement.PriceSourceId); foreach (var el in query) { result.Add(el); } } } });</code> </pre> </div></div><br><p>  R√©sultat: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/916/d22/428/916d224282a3020dc31df6c67a18b070.png" alt="image"></p><br><p>  Pour les petites collections, cette approche est encore plus lente que la premi√®re m√©thode.  Et pour le plus grand - 2 fois plus rapide.  Fait int√©ressant, 4 threads ont √©t√© g√©n√©r√©s sur ma machine, mais cela n'a pas entra√Æn√© d'acc√©l√©ration 4x.  Cela sugg√®re que la surcharge de cette m√©thode est importante: √† la fois c√¥t√© client et c√¥t√© serveur.  La consommation de m√©moire a augment√©, mais pas de mani√®re significative. </p><br><h4 id="sposob-3-multiple-contains">  M√©thode 3: Contient plusieurs </h4><br><p>  Il est temps d'essayer autre chose et de r√©duire la t√¢che √† une seule requ√™te.  Cela peut √™tre fait comme suit: </p><br><ol><li>  Pr√©parez 3 collections uniques de <em>Ticker</em> , <em>PriceSourceId</em> et <em>Date</em> </li><li>  Ex√©cutez la demande et utilisez 3 <em>Contient</em> </li><li>  Rev√©rifiez les r√©sultats localement </li></ol><br><div class="spoiler">  <b class="spoiler_title">Code pour la m√©thode 3</b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { <span class="hljs-comment"><span class="hljs-comment">//   var tickers = TestData.Select(x =&gt; x.Ticker).Distinct().ToList(); var dates = TestData.Select(x =&gt; x.TradedOn).Distinct().ToList(); var ps = TestData.Select(x =&gt; x.PriceSourceId).Distinct().ToList(); //    3 Contains var data = context.Prices .Where(x =&gt; tickers.Contains(x.Security.Ticker) &amp;&amp; dates.Contains(x.TradedOn) &amp;&amp; ps.Contains(x.PriceSourceId)) .Select(x =&gt; new { Price = x, Ticker = x.Security.Ticker, }) .ToList(); var lookup = data.ToLookup(x =&gt; $"{x.Ticker}, {x.Price.TradedOn}, {x.Price.PriceSourceId}"); //  foreach (var el in TestData) { var key = $"{el.Ticker}, {el.TradedOn}, {el.PriceSourceId}"; result.AddRange(lookup[key].Select(x =&gt; x.Price)); } }</span></span></code> </pre> </div></div><br><p>  Le probl√®me ici est que le temps d'ex√©cution et la quantit√© de donn√©es renvoy√©es d√©pendent fortement des donn√©es elles-m√™mes (√† la fois dans la requ√™te et dans la base de donn√©es).  Autrement dit, un ensemble de seules les donn√©es n√©cessaires peut renvoyer et des enregistrements suppl√©mentaires peuvent √™tre retourn√©s (m√™me 100 fois plus). </p><br><p>  Cela peut √™tre expliqu√© √† l'aide de l'exemple suivant.  Supposons qu'il existe le tableau suivant avec des donn√©es: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f3f/2bb/ea5/f3f2bbea5148127963cab9010d2b2f10.png" alt="image"></p><br><p>  Supposons √©galement que j'ai besoin des prix pour <em>Ticker1</em> avec <em>TradedOn</em> = <em>2018-01-01</em> et pour <em>Ticker2</em> avec <em>TradedOn</em> = <em>2018-01-02</em> . </p><br><p>  Puis des valeurs uniques pour <em>Ticker</em> = ( <em>Ticker1</em> , <em>Ticker2</em> ) <br>  Et des valeurs uniques pour <em>TradedOn</em> = ( <em>2018-01-01</em> , <em>2018-01-02</em> ) </p><br><p>  Cependant, 4 enregistrements seront retourn√©s en cons√©quence, car ils correspondent vraiment √† ces combinaisons.  La mauvaise chose est que plus les champs sont utilis√©s, plus les chances d'obtenir des enregistrements suppl√©mentaires en cons√©quence. </p><br><p>  Pour cette raison, les donn√©es obtenues par cette m√©thode doivent en outre √™tre filtr√©es c√¥t√© client.  Et c'est le plus gros inconv√©nient. <br>  Les mesures sont les suivantes: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dd5/078/5ef/dd50785efd38900c4d18467607b87a1e.png" alt="image"></p><br><p>  La consommation de m√©moire est pire que toutes les m√©thodes pr√©c√©dentes.  Le nombre de lignes lues est plusieurs fois sup√©rieur au nombre demand√©.  Les tests pour les grandes collections ont √©t√© interrompus car ils ont fonctionn√© pendant plus de 10 minutes.  Cette m√©thode n'est pas bonne. </p><br><h4 id="sposob-4-predicate-builder">  M√©thode 4. G√©n√©rateur de pr√©dicats </h4><br><p>  Essayons de l'autre c√¥t√©: la bonne vieille <em>expression</em> .  En les utilisant, vous pouvez cr√©er 1 grande requ√™te sous la forme suivante: </p><br><p> <code>‚Ä¶ (.. AND .. AND ..) OR (.. AND .. AND ..) OR (.. AND .. AND ..) ‚Ä¶</code> </p> <br><p>  Cela donne l'espoir qu'il sera possible de g√©n√©rer 1 demande et d'obtenir uniquement les donn√©es n√©cessaires pour 1 appel.  Code: </p><br><div class="spoiler">  <b class="spoiler_title">Code pour la m√©thode 4</b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { var baseQuery = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId select <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestData() { Ticker = s.Ticker, TradedOn = p.TradedOn, PriceSourceId = p.PriceSourceId, PriceObject = p }; var tradedOnProperty = typeof(TestData).GetProperty(<span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>); var priceSourceIdProperty = typeof(TestData).GetProperty(<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span>); var tickerProperty = typeof(TestData).GetProperty(<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>); var paramExpression = Expression.Parameter(typeof(TestData)); Expression wholeClause = null; foreach (var td in TestData) { var elementClause = Expression.AndAlso( Expression.Equal( Expression.MakeMemberAccess( paramExpression, tradedOnProperty), Expression.Constant(td.TradedOn) ), Expression.AndAlso( Expression.Equal( Expression.MakeMemberAccess( paramExpression, priceSourceIdProperty), Expression.Constant(td.PriceSourceId) ), Expression.Equal( Expression.MakeMemberAccess( paramExpression, tickerProperty), Expression.Constant(td.Ticker)) )); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wholeClause == null) wholeClause = elementClause; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> wholeClause = Expression.OrElse(wholeClause, elementClause); } var query = baseQuery.Where( (Expression&lt;Func&lt;TestData, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt;)Expression.Lambda( wholeClause, paramExpression)).Select(x =&gt; x.PriceObject); result.AddRange(query); }</code> </pre> </div></div><br><p>  Le code s'est av√©r√© plus compliqu√© que dans les m√©thodes pr√©c√©dentes.  Construire manuellement <em>Expression n'est</em> pas l'op√©ration la plus simple et la plus rapide. </p><br><p>  Mesures: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/312/373/4fc/3123734fc82c4fc4d783f4f9ce2cf225.png" alt="image"></p><br><p>  Les r√©sultats temporaires √©taient encore pires que dans la m√©thode pr√©c√©dente.  Il semble que les frais g√©n√©raux pendant la construction et lors de la marche dans l'arbre se soient av√©r√©s √™tre bien plus que le gain li√© √† l'utilisation d'une seule demande. </p><br><h4 id="sposob-5-shared-query-data-table">  M√©thode 5: table de donn√©es de requ√™te partag√©e </h4><br><p>  Essayons une autre option: <br>  J'ai cr√©√© une nouvelle table dans la base de donn√©es dans laquelle j'√©crirai les donn√©es n√©cessaires pour compl√©ter la demande (implicitement j'ai besoin d'un nouveau <em>DbSet</em> dans le contexte). </p><br><p>  Maintenant, pour obtenir le r√©sultat dont vous avez besoin: </p><br><ol><li>  Lancer la transaction </li><li>  T√©l√©charger des donn√©es de requ√™te dans une nouvelle table </li><li>  Ex√©cutez la requ√™te elle-m√™me (en utilisant la nouvelle table) </li><li>  Annuler une transaction (pour effacer le tableau de donn√©es des requ√™tes) </li></ol><br><p>  Le code ressemble √† ceci: </p><br><div class="spoiler">  <b class="spoiler_title">Code pour la m√©thode 5</b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { context.Database.BeginTransaction(); var reducedData = TestData.Select(x =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SharedQueryModel() { PriceSourceId = x.PriceSourceId, Ticker = x.Ticker, TradedOn = x.TradedOn }).ToList(); <span class="hljs-comment"><span class="hljs-comment">//      context.QueryDataShared.AddRange(reducedData); context.SaveChanges(); var query = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId join t in context.QueryDataShared on new { s.Ticker, p.TradedOn, p.PriceSourceId } equals new { t.Ticker, t.TradedOn, t.PriceSourceId } select p; result.AddRange(query); context.Database.RollbackTransaction(); }</span></span></code> </pre> </div></div><br><p>  Premi√®res mesures: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/df0/ab7/d7d/df0ab7d7d01b0aeaeebf2b9a41f5e75b.png" alt="image"></p><br><p>  Tous les tests ont fonctionn√© et ont fonctionn√© rapidement!  La consommation de m√©moire est √©galement acceptable. <br>  Ainsi, gr√¢ce √† l'utilisation d'une transaction, cette table peut √™tre utilis√©e simultan√©ment par plusieurs processus.  Et comme il s'agit d'une v√©ritable table existante, toutes les fonctionnalit√©s d' <em>Entity Framework</em> sont √† notre disposition: il vous suffit de charger les donn√©es dans la table, de cr√©er une requ√™te √† l'aide de <em>JOIN</em> et de l'ex√©cuter.  √Ä premi√®re vue, c'est ce dont vous avez besoin, mais il y a des inconv√©nients importants: </p><br><ul><li>  Vous devez cr√©er une table pour un type de requ√™te sp√©cifique </li><li>  Il est n√©cessaire d'utiliser des transactions (et de gaspiller des ressources SGBD sur celles-ci) </li><li>  Et l'id√©e m√™me que vous devez √âCRIRE quelque chose, quand vous avez besoin de LIRE, semble √©trange.  Et sur Read Replica, cela ne fonctionnera tout simplement pas. <br>  Et le reste est une solution plus ou moins fonctionnelle qui peut d√©j√† √™tre utilis√©e. </li></ul><br><h4 id="sposob-6-memoryjoin-extension">  M√©thode 6. Extension MemoryJoin </h4><br><p>  Vous pouvez maintenant essayer d'am√©liorer l'approche pr√©c√©dente.  Les pens√©es sont: </p><br><ul><li>  Au lieu d'utiliser une table sp√©cifique √† un type de requ√™te, vous pouvez utiliser une option g√©n√©ralis√©e.  √Ä savoir, cr√©ez une table avec un nom comme <em>shared_query_data</em> et ajoutez-y plusieurs champs <em>Guid</em> , plusieurs <em>Long</em> , plusieurs <em>String</em> , etc.  Des noms simples peuvent √™tre pris: <em>Guid1</em> , <em>Guid2</em> , <em>String1</em> , <em>Long1</em> , <em>Date2</em> , etc.  Ensuite, ce tableau peut √™tre utilis√© pour 95% des types de requ√™te.  Les noms de propri√©t√© peuvent √™tre ¬´ajust√©s¬ª ult√©rieurement √† l'aide de la perspective <strong>S√©lectionner</strong> . </li><li>  Vous devez ensuite ajouter un <em>DbSet</em> pour <em>shared_query_data</em> . </li><li>  Mais que se passe-t-il si, au lieu d'√©crire des donn√©es dans la base de donn√©es, en passant des valeurs √† l'aide de la construction <strong>VALUES</strong> ?  Autrement dit, il est n√©cessaire que dans la requ√™te SQL finale, au lieu d'acc√©der √† <em>shared_query_data,</em> il y ait un appel √† <strong>VALUES</strong> .  Comment faire <br><ul><li>  Dans Entity Framework Core - en utilisant simplement <em>FromSql</em> . </li><li>  Dans Entity Framework 6 - vous devez utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DbInterception</a> - c'est-√†-dire, changez le SQL g√©n√©r√© en ajoutant la construction <strong>VALUES</strong> juste avant l'ex√©cution.  Cela entra√Ænera une limitation: dans une seule demande, pas plus d'une construction <strong>VALUES</strong> .  Mais √ßa va marcher! </li></ul></li><li>  Puisque nous <em>n'allons</em> pas √©crire dans la base de donn√©es, nous obtenons alors la table <em>shared_query_data</em> cr√©√©e √† la premi√®re √©tape, n'est-elle pas n√©cessaire du tout?  R√©ponse: oui, ce n'est pas n√©cessaire, mais <em>DbSet</em> est toujours n√©cessaire, car Entity Framework doit conna√Ætre le sch√©ma de donn√©es afin de g√©n√©rer des requ√™tes.  Il s'av√®re que nous avons besoin d'un <em>DbSet</em> pour un mod√®le g√©n√©ralis√© qui n'existe pas dans la base de donn√©es et n'est utilis√© que pour inspirer Entity Framework, qu'il sait ce qu'il fait. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Convertir IEnumerable en exemple IQueryable</b> <div class="spoiler_text"><ol><li>  L'entr√©e a re√ßu une collection d'objets du type suivant: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeQueryData</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> Ticker {get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTimeTradedOn {get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PriceSourceId {get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>;} }</code> </pre> </li><li>  Nous avons √† notre disposition <em>DbSet</em> avec les champs <em>String1</em> , <em>String2</em> , <em>Date1</em> , <em>Long1</em> , <em>etc.</em> </li><li>  Laissez <em>Ticker</em> √™tre stock√© dans <em>String1</em> , <em>TradedOn</em> dans <em>Date1</em> et <em>PriceSourceId</em> dans <em>Long1</em> ( <em>int</em> mapps en <em>long</em> , afin de ne pas s√©parer les champs pour <em>int</em> et <em>long</em> ) </li><li>  Alors <em>FromSql</em> + <em>VALUES</em> sera comme ceci: <br><pre> <code class="cpp hljs">var query = context.QuerySharedData.FromSql( <span class="hljs-string"><span class="hljs-string">"SELECT * FROM ( VALUES (1, 'Ticker1', @date1, @id1), (2, 'Ticker2', @date2, @id2) ) AS __gen_query_data__ (id, string1, date1, long1)"</span></span>)</code> </pre> </li><li>  Vous pouvez maintenant faire une projection et renvoyer un <em>IQueryable</em> pratique en utilisant le m√™me type qui √©tait √† l'entr√©e: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> query.Select(x =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SomeQueryData() { Ticker = x.String1, TradedOn = x.Date1, PriceSourceId = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)x.Long1 });</code> </pre> </li></ol></div></div><br><p>  J'ai r√©ussi √† impl√©menter cette approche et m√™me √† la concevoir comme un package <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NuGet EntityFrameworkCore.MemoryJoin</a> (le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">code est</a> √©galement disponible).  Malgr√© le fait que le nom contient le mot <em>Core</em> , <em>Entity Framework</em> 6 est √©galement pris en charge.  Je l'ai appel√© <strong>MemoryJoin</strong> , mais en fait, il envoie des donn√©es locales au SGBD dans la construction <em>VALUES</em> et tout le travail est fait dessus. </p><br><p>  Le code est le suivant: </p><br><div class="spoiler">  <b class="spoiler_title">Code pour la m√©thode 6</b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { <span class="hljs-comment"><span class="hljs-comment">// :    ,      var reducedData = TestData.Select(x =&gt; new { x.Ticker, x.TradedOn, x.PriceSourceId }).ToList(); //  IEnumerable&lt;&gt;   IQueryable&lt;&gt; var queryable = context.FromLocalList(reducedData); var query = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId join t in queryable on new { s.Ticker, p.TradedOn, p.PriceSourceId } equals new { t.Ticker, t.TradedOn, t.PriceSourceId } select p; result.AddRange(query); }</span></span></code> </pre> </div></div><br><p>  Mesures: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/6a7/d72/bb2/6a7d72bb265d9dedbc8e54d94fe16a4f.png" alt="image"></p><br><p>  C'est le meilleur r√©sultat que j'aie jamais essay√©.  Le code √©tait tr√®s simple et direct, et fonctionnait en m√™me temps pour Read Replica. </p><br><div class="spoiler">  <b class="spoiler_title">Un exemple de requ√™te g√©n√©r√©e pour recevoir 3 √©l√©ments</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceId"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"ClosePrice"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"OpenPrice"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"SecurityId"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>, <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>, <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>, <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"Price"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"p"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">"Security"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"s"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"SecurityId"</span></span> = <span class="hljs-string"><span class="hljs-string">"s"</span></span>.<span class="hljs-string"><span class="hljs-string">"SecurityId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"x"</span></span>.<span class="hljs-string"><span class="hljs-string">"string1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>, <span class="hljs-string"><span class="hljs-string">"x"</span></span>.<span class="hljs-string"><span class="hljs-string">"date1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-string"><span class="hljs-string">"x"</span></span>.<span class="hljs-string"><span class="hljs-string">"long1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> int4) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, @__gen_q_p0, @__gen_q_p1, @__gen_q_p2), (<span class="hljs-number"><span class="hljs-number">2</span></span>, @__gen_q_p3, @__gen_q_p4, @__gen_q_p5), (<span class="hljs-number"><span class="hljs-number">3</span></span>, @__gen_q_p6, @__gen_q_p7, @__gen_q_p8) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> __gen_query_data__ (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, string1, date1, long1) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"x"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"t"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ((<span class="hljs-string"><span class="hljs-string">"s"</span></span>.<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span> = <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (<span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span> = <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span>)</code> </pre> <br><p>  Ici, vous pouvez √©galement voir comment le mod√®le g√©n√©ralis√© (avec les champs <em>String1</em> , <em>Date1</em> , <em>Long1</em> ) utilisant Select se transforme en celui qui est utilis√© dans le code (avec les champs <em>Ticker</em> , <em>TradedOn</em> , <em>PriceSourceId</em> ). </p></div></div><br><p>  Tout le travail est effectu√© en 1 requ√™te sur le serveur SQL.  Et c'est une petite fin heureuse, dont j'ai parl√© au d√©but.  N√©anmoins, l'utilisation de cette m√©thode n√©cessite une compr√©hension et les √©tapes suivantes: </p><br><ul><li>  Vous devez ajouter un <em>DbSet</em> suppl√©mentaire √† votre contexte (bien que la table elle-m√™me puisse √™tre <em>omise</em> ) </li><li>  Dans le mod√®le g√©n√©ralis√©, utilis√© par d√©faut, 3 champs de types <em>Guid</em> , <em>String</em> , <em>Double</em> , <em>Long</em> , <em>Date</em> , etc. sont d√©clar√©s.  Cela devrait suffire pour 95% des types de demandes.  Et si vous passez une collection d'objets avec 20 champs √† <em>FromLocalList</em> , une <em>exception</em> sera lev√©e, disant que l'objet est trop complexe.  Il s'agit d'une restriction souple et peut √™tre contourn√©e - vous pouvez d√©clarer votre type et y ajouter au moins 100 champs.  Cependant, plus de champs sont plus lents √† travailler. </li><li>  Plus de d√©tails techniques sont d√©crits dans mon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> . </li></ul><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Dans cet article, j'ai pr√©sent√© mes r√©flexions sur le sujet de la collection locale JOIN et de DbSet.  Il me semblait que mon d√©veloppement √† l'aide de <em>VALUES</em> pouvait int√©resser la communaut√©.  Au moins, je n'ai pas rencontr√© une telle approche lorsque j'ai r√©solu ce probl√®me moi-m√™me.  Personnellement, cette m√©thode m'a aid√© √† surmonter un certain nombre de probl√®mes de performances dans mes projets en cours, peut-√™tre qu'elle vous aidera √©galement. </p><br><p>  Quelqu'un dira que l'utilisation de <em>MemoryJoin est</em> trop "abstraite" et doit √™tre d√©velopp√©e davantage, et jusque-l√†, elle ne devrait pas √™tre utilis√©e.  C'est exactement la raison pour laquelle j'√©tais tr√®s douteux et pendant pr√®s d'un an, je n'ai pas √©crit cet article.  Je suis d'accord pour que cela fonctionne plus facilement (j'esp√®re qu'un jour √ßa le sera), mais je dirai aussi que l'optimisation n'a jamais √©t√© la t√¢che des Juniors.  L'optimisation n√©cessite toujours une compr√©hension du fonctionnement de l'outil.  Et s'il est possible d'obtenir une acc√©l√©ration d'environ 8 fois ( <em>Naive Parallel</em> vs <em>MemoryJoin</em> ), je ma√Ætriserais 2 points et la documentation. </p><br><p>  Et enfin, les diagrammes: </p><br><p>  Le temps pass√©.  Seules 4 m√©thodes ont termin√© la t√¢che en moins de 10 minutes, et <em>MemoryJoin</em> est le seul moyen qui a termin√© la t√¢che en moins de 10 secondes. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/720/256/846/72025684620477d221c0f113a6cb354f.png" alt="image"></p><br><p>  Consommation de m√©moire.  Toutes les m√©thodes ont montr√© approximativement la m√™me consommation de m√©moire, √† l'exception de <em>Contient plusieurs</em> .  Cela est d√ª √† la quantit√© de donn√©es retourn√©es. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e07/a91/b63/e07a91b63375d49a21adb81e8213ffdb.png" alt="image"></p><br><p>  Merci d'avoir lu! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr435810/">https://habr.com/ru/post/fr435810/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr435798/index.html">Sony WH-1000XM3 - le meilleur casque sans fil?</a></li>
<li><a href="../fr435800/index.html">Lettre du d√©cembriste 11</a></li>
<li><a href="../fr435802/index.html">OpenVPN, dont vous saviez si peu</a></li>
<li><a href="../fr435804/index.html">Intel Cyclone n'enregistre pas la configuration apr√®s le red√©marrage</a></li>
<li><a href="../fr435806/index.html">Japon: des essais cliniques de patchwork de bio-ing√©nierie sur le c≈ìur annonc√©s</a></li>
<li><a href="../fr435812/index.html">Th√©orie du bonheur. La statistique comme moyen scientifique de ne rien savoir</a></li>
<li><a href="../fr435814/index.html">[The Old New Thing] Puis-je utiliser ma pile √† ma guise?</a></li>
<li><a href="../fr435816/index.html">Le Massachusetts Hospital et DeepMind ont ouvert de mani√®re ind√©pendante la bo√Æte noire de l'IA en m√©decine</a></li>
<li><a href="../fr435822/index.html">Comment contr√¥ler le mat√©riel dans un centre de donn√©es √† l'aide du son</a></li>
<li><a href="../fr435824/index.html">Ce que vous devez savoir avant de commencer une carri√®re dans l'industrie audio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>