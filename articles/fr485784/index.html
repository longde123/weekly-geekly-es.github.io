<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíáüèª üë¥ üë®üèæ‚Äç‚úàÔ∏è Faire fonctionner n'importe quel processus avec NTFS transactionnel: ma premi√®re √©tape pour cr√©er un sandbox pour Windows üéé üë©üèø‚Äçü§ù‚Äçüë©üèª üôÜüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il existe un module dans le noyau Windows charg√© de prendre en charge le regroupement des op√©rations sur les fichiers dans une entit√© appel√©e transact...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Faire fonctionner n'importe quel processus avec NTFS transactionnel: ma premi√®re √©tape pour cr√©er un sandbox pour Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485784/"><p><img src="https://habrastorage.org/webt/p0/-s/fi/p0-sfitxnzzpywfqxuc4arx1fps.png" align="right" alt="TransactionMaster">  Il existe un module dans le noyau Windows charg√© de prendre en charge le regroupement des op√©rations sur les fichiers dans une entit√© appel√©e <strong>transaction</strong> .  Les actions sur cette entit√© sont isol√©es et atomiques: elle peut √™tre <em>appliqu√©e</em> en la rendant permanente ou <em>annul√©e</em> .  Tr√®s pratique lors de l'installation de programmes, d'accord?  Nous passons toujours d'un √©tat convenu √† un autre, et en cas de probl√®me, toutes les modifications sont annul√©es. </p><br><p> Depuis que j'ai appris le support d'une telle fonctionnalit√©, j'ai toujours voulu regarder le monde de l'int√©rieur de ces transactions.  Et vous savez quoi: j'ai trouv√© une m√©thode simple et vraiment merveilleuse pour faire fonctionner n'importe quel processus dans une transaction de fichier, <del>  mais les marges du livre sont trop √©troites pour lui </del>  .  Dans la plupart des cas, cela ne n√©cessite m√™me pas de privil√®ges administratifs. </p><br><p>  Voyons comment cela fonctionne, exp√©rimentons mon programme et comprenons ce que sont les bacs √† sable. </p><a name="habracut"></a><br><h2 id="repozitoriy">  D√©p√¥t </h2><br><p>  Pour ceux qui sont impatients d'essayer: <a href="https://github.com/diversenok/TransactionMaster">TransactionMaster sur GitHub</a> . </p><br><h2 id="teoriya">  Th√©orie </h2><br><p>  La prise en charge de NTFS transactionnel, ou <strong>TxF</strong> , est apparue dans Windows Vista, et a permis de simplifier consid√©rablement le code responsable de la r√©cup√©ration des erreurs dans le processus de mise √† jour du logiciel et du syst√®me d'exploitation lui-m√™me.  En fait, la t√¢che de restauration a √©t√© transf√©r√©e au noyau du syst√®me d'exploitation, qui a commenc√© √† appliquer la <a href="https://ru.wikipedia.org/wiki/ACID">s√©mantique <abbr title="Atomicit√©, coh√©rence, isolement, durabilit√©">ACID</abbr></a> compl√®te aux op√©rations de fichiers - il suffit de demander. </p><br><p> Pour prendre en charge cette technologie, de nouvelles fonctions API ont √©t√© ajout√©es qui dupliquaient les fonctionnalit√©s existantes, ajoutant un nouveau param√®tre - une transaction.  La transaction elle-m√™me est devenue l'un des nombreux objets du noyau dans le syst√®me d'exploitation, avec les fichiers, les processus et les objets de synchronisation.  Dans le cas le plus simple, la s√©quence d'actions lorsque vous travaillez avec des transactions consiste √† cr√©er un objet de transaction en appelant <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/ktmw32/nf-ktmw32-createtransaction"><code>CreateTransaction</code></a> , √† travailler avec des fichiers (√† l'aide de fonctions telles que <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/winbase/nf-winbase-createfiletransactedw"><code>CreateFileTransacted</code></a> , <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/winbase/nf-winbase-movefiletransactedw"><code>MoveFileTransacted</code></a> , <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/winbase/nf-winbase-deletefiletransactedw"><code>DeleteFileTransacted</code></a> et similaires), et √† appliquer / <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/winbase/nf-winbase-deletefiletransactedw"><code>DeleteFileTransacted</code></a> la transaction √† l'aide de <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/ktmw32/nf-ktmw32-committransaction"><code>CommitTransaction</code></a> / <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/ktmw32/nf-ktmw32-rollbacktransaction"><code>RollbackTransaction</code></a> . </p><br><p>  Voyons maintenant l'architecture de ces fonctionnalit√©s.  Nous savons que la couche d'API document√©e, provenant de biblioth√®ques telles que <code>kernel32.dll</code> , ne transf√®re pas directement le contr√¥le au noyau du syst√®me d'exploitation, mais fait r√©f√©rence √† la couche d'abstraction sous-jacente en mode utilisateur - <code>ntdll.dll</code> , qui effectue d√©j√† un appel syst√®me.  Et l√†, une surprise nous attend: <u>il n'y a tout simplement pas de duplication de fonctions pour travailler avec des fichiers dans le cadre de transactions dans <strong>ntdll</strong> , comme dans le noyau</u> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ke/ql/5q/keql5q2xtkbwehzymrrnivsniq8.png" alt="Couches API"></div><br><p>  N√©anmoins, les prototypes de ces fonctions de l'API native n'ont pas chang√© depuis des temps imm√©moriaux, ce qui signifie qu'ils apprendront ailleurs dans le contexte de quelle transaction effectuer l'op√©ration.  Mais d‚Äôo√π?  La r√©ponse est que chaque thread a un champ sp√©cial dans lequel le handle de la transaction en cours est stock√©.  La zone de m√©moire o√π elle se trouve est appel√©e <abbr title="Bloquer l'environnement filet√©">TEB</abbr> , le bloc d'environnement de flux.  Parmi les choses connues, le <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/errhandlingapi/nf-errhandlingapi-getlasterror">dernier code d'erreur</a> et l' <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentthreadid">identifiant de flux y</a> sont √©galement stock√©s. </p><br><p>  Ainsi, les fonctions avec le suffixe <code>*Transacted</code> d√©finissent le champ de la transaction en cours, appellent une fonction similaire sans suffixe, puis restaurent la valeur pr√©c√©dente.  Ils le font en utilisant une paire de fonctions <a href=""><code>RtlGetCurrentTransaction</code></a> / <a href=""><code>RtlSetCurrentTransaction</code></a> de <code>ntdll</code> .  Le code des fonctions elles-m√™mes est tr√®s simple, √† l'exception du cas avec <abbr title="Windows sur Windows 64 bits">WoW64</abbr> , qui sera <abbr title="Windows sur Windows 64 bits">discut√©</abbr> ci <abbr title="Windows sur Windows 64 bits">-</abbr> dessous. </p><br><p>  Qu'est-ce que tout cela signifie pour nous?  <strong>En modifiant une variable dans la m√©moire de processus, nous pouvons contr√¥ler dans le contexte de quelle transaction elle travaille avec le syst√®me de fichiers.</strong>  Vous n'avez pas besoin de d√©finir d'interruptions ni d'appels de fonction d'interception, remettez simplement le descripteur de transaction au processus cible et corrigez quelques octets dans sa m√©moire pour chacun des threads.  Cela semble √©l√©mentaire, faisons-le! </p><br><h2 id="podvodnye-kamni">  Pi√®ges </h2><br><p>  Les toutes premi√®res exp√©riences ont montr√© que l'id√©e est r√©alisable: <a href="https://farmanager.com/">Far Manager</a> , que j'utilise √† la place de Windows Explorer, survit parfaitement √† la substitution des transactions √† la vol√©e, et permet de regarder le monde dans son contexte.  Mais il y avait aussi des programmes qui cr√©ent constamment de nouveaux threads pour les op√©rations de fichiers.  Et dans le sc√©nario d'origine, c'est une lacune, car il n'est pas tr√®s pratique de suivre la cr√©ation de threads dans un autre processus (sans parler du fait que le ¬´retard¬ª est critique ici).  Un exemple d'application de la deuxi√®me classe est le <a href="https://github.com/microsoft/winfile">WinFile</a> r√©cemment port√©. </p><br><h3 id="otslezhivayuschaya-dll">  DLL de suivi </h3><br><p>  Heureusement, le suivi synchrone de la cr√©ation de threads et de la configuration ult√©rieure des transactions pour eux est compl√®tement √©l√©mentaire depuis le processus cible.  Il suffit d'y incorporer une DLL, et le chargeur de module appellera son point d'entr√©e avec le param√®tre <a href="https://docs.microsoft.com/ru-ru/windows/win32/dlls/dllmain"><code>DLL_THREAD_ATTACH</code></a> chaque <b>*</b> fois lors de la cr√©ation d'un nouveau thread.  En impl√©mentant cette fonctionnalit√©, j'ai corrig√© la compatibilit√© avec une douzaine de programmes suppl√©mentaires. </p><br><p>  <strong>*</strong> Techniquement, un appel ne fonctionne pas toujours, et ce comportement peut parfois √™tre observ√© dans l'interface de mon programme.  Pour la plupart, les exceptions sont les threads du pool de travail du chargeur de module lui-m√™me.  Le fait est que les biblioth√®ques DLL sont notifi√©es sous le verrou du chargeur de d√©marrage, et cela signifie: vous ne pouvez pas charger de nouveaux modules pour le moment.  Et les threads du chargeur, comme vous le savez, font exactement cela, parall√©lisant l'acc√®s au syst√®me de fichiers.  Une exception est pr√©vue pour de tels cas: si vous sp√©cifiez <a href=""><code>THREAD_CREATE_FLAGS_SKIP_THREAD_ATTACH</code></a> comme indicateur lors de l'appel de <a href=""><code>NtCreateThreadEx</code></a> , vous pouvez √©viter d'attacher un nouveau thread aux DLL existantes et, respectivement, des blocages.  C'est ce qui se passe ici. </p><br><h3 id="zapuskaem-provodnik">  Lancer l'explorateur </h3><br><p>  Il reste la troisi√®me, derni√®re cat√©gorie de programmes qui se bloquent toujours en essayant de les faire fonctionner dans une transaction.  L'un de ces programmes est l'Explorateur Windows.  Je ne peux pas diagnostiquer avec pr√©cision le probl√®me, mais l'application est compliqu√©e et la commutation √† chaud √† l'int√©rieur de la transaction ne l'affecte pas beaucoup.  La raison en est peut-√™tre qu'il contient de nombreux descripteurs de fichiers ouverts, dont certains cessent d'√™tre valides dans le nouveau contexte.  Ou peut-√™tre que c'est autre chose.  Dans de telles situations, le red√©marrage du processus est utile pour qu'il fonctionne d√®s le d√©but de la transaction.  Ensuite, aucune incoh√©rence ne devrait survenir. </p><br><p>  Et par cons√©quent, j'ai ajout√© la possibilit√© de d√©marrer de nouveaux processus au programme, pour lesquels la transaction et le suivi des nouveaux flux sont configur√©s avant d'atteindre le point d'entr√©e, tandis que le processus est suspendu.  Et vous savez quoi, √ßa a march√©!  Certes, √©tant donn√© qu'Explorer utilise activement des objets COM en dehors du processus, l'aper√ßu se rompt lors du d√©placement de fichiers.  Mais sinon, tout est stable. </p><br><h3 id="chto-tam-s-wow64">  Quoi de neuf avec WoW64? </h3><br><p>  Ce sous-syst√®me de lancement de programmes 32 bits sur des syst√®mes 64 bits est un outil extr√™mement pratique, mais la n√©cessit√© de prendre en compte ses fonctionnalit√©s complique souvent la programmation du syst√®me.  J'ai mentionn√© ci-dessus que le comportement de <code>Rtl[Get/Set]CurrentTransaction</code> nettement diff√©rent dans le cas de processus similaires.  La raison en est que les threads des processus WoW64 ont jusqu'√† deux blocs d'environnement.  Ils ont diff√©rentes tailles de pointeur, et il est souhaitable de les maintenir dans un √©tat coh√©rent, bien que, dans le cas des transactions, le TEB 64 bits soit prioritaire.  Lorsque nous √©tablissons des transactions √† distance, nous devons reproduire le comportement de ces fonctions.  Ce n'est pas difficile, mais vous ne devez pas l'oublier, et les d√©tails peuvent √™tre trouv√©s <a href="">ici</a> .  Enfin, les processus WoW64 ont besoin d'une copie suppl√©mentaire de 32 bits de notre DLL de suivi. </p><br><h3 id="nereshyonnye-problemy">  Probl√®mes non r√©solus </h3><br><p>  Forc√© de pleurer - le tout premier sc√©nario qui me vient √† l'esprit, √† savoir le lancement des programmes d'installation dans ce mode - n'est pas encore op√©rationnel.  Premi√®rement, il n'est pas configur√© pour capturer les processus enfants dans la m√™me transaction.  Il y a plusieurs solutions ici, j'y travaille.  Mais si l'application cr√©e plusieurs processus, il est encore trop t√¥t pour l'utiliser en combinaison avec des transactions. </p><br><p>  Deuxi√®mement, le cas des fichiers ex√©cutables qui n'existent pas en dehors de la transaction m√©rite une attention particuli√®re.  Je me souviens qu'il y avait une sorte de virus qui trompait les antivirus na√Øfs de cette fa√ßon: il a √©t√© d√©compress√© dans une transaction, s'est lanc√© lui-m√™me, puis a annul√© la transaction.  Il y a un processus, mais il n'y a pas de fichier ex√©cutable.  L'antivirus pourrait d√©cider qu'il n'y a rien √† analyser et ignorer la menace.  Nous devons √©galement travailler sur des solutions cr√©atives, car, pour une raison quelconque, <a href=""><code>NtCreateUserProcess</code></a> (et, par cons√©quent, <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessw"><code>CreateProcess</code></a> ) ignore la transaction en cours.  Bien s√ªr, <a href=""><code>NtCreateProcessEx</code></a> reste toujours, mais on s'attend √† beaucoup de probl√®mes pour r√©soudre les probl√®mes de compatibilit√©.  Je penserai √† quelque chose. </p><br><h2 id="prichyom-tut-pesochnicy">  Et o√π sont les bacs √† sable? </h2><br><p>  Jetez un oeil √† l'image.  Ici, trois programmes diff√©rents affichent le contenu du m√™me dossier √† partir de trois transactions diff√©rentes.  Cool, non? </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9f/ml/ds/9fmldsooc30vlqq7plchzoxystc.png" alt="Un regard de l'int√©rieur de la transaction"></div><br><p>  Et pourtant, mon programme n'est en aucun cas un bac √† sable, il manque un d√©tail important - <strong>la fronti√®re de s√©curit√©</strong> .  Bien s√ªr, cela n'emp√™che pas certaines entreprises de vendre des objets similaires sous le couvert de bacs √† sable √† part enti√®re, dommage pour eux, que puis-je dire.  Et, malgr√© le fait que cela semble compl√®tement impossible, comment pouvons-nous emp√™cher un programme de changer une variable dans notre m√©moire m√™me si nous sommes m√™me un d√©bogueur?  - J'ai une d√©licieuse astuce en magasin qui me permettra de terminer ce que j'ai commenc√© et de cr√©er le premier bac √† sable que je connais, qui ne n√©cessitera pas de pilote, mais virtualisera le syst√®me de fichiers.  D'ici l√†, attendez les mises √† jour, utilisez <a href="https://sandboxie.com/">Sandboxie</a> et <a href="https://docs.microsoft.com/ru-ru/windows/win32/secauthz/appcontainer-isolation">testez la</a> technologie <a href="https://docs.microsoft.com/ru-ru/windows/win32/secauthz/appcontainer-isolation">AppContainer</a> .  Merci de votre attention. </p><br><p>  R√©f√©rentiel de projet sur GitHub: <strong><a href="https://github.com/diversenok/TransactionMaster">TransactionMaster</a></strong> . <br>  <a href="https://habr.com/en/post/485788/">Le m√™me article en anglais</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr485784/">https://habr.com/ru/post/fr485784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr485768/index.html">Tendances Web 2020 √† essayer</a></li>
<li><a href="../fr485770/index.html">Pol√©mique incorrecte</a></li>
<li><a href="../fr485772/index.html">Du bureau au centre de donn√©es virtuel - comment nous sommes pass√©s √† la virtualisation</a></li>
<li><a href="../fr485776/index.html">Tout au long de la g√©ographie: navigation et t√¢ches g√©od√©siques dans diff√©rentes langues</a></li>
<li><a href="../fr485780/index.html">Robots, r√©sonateurs √† quartz, microcontr√¥leurs ... que fait Epson?</a></li>
<li><a href="../fr485786/index.html">Devoirs arithm√©tiques</a></li>
<li><a href="../fr485790/index.html">Entretiens: attentes vs r√©alit√©</a></li>
<li><a href="../fr485792/index.html">Ivan Lilekvist et Kim Dotkom, une grande interview: l'histoire de Megaupload, l'extradition vers les √âtats-Unis, la libert√©, le bitcoin. 2e partie</a></li>
<li><a href="../fr485796/index.html">R√©soudre l'insoluble</a></li>
<li><a href="../fr485800/index.html">Num√©risation vs Automatisation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>