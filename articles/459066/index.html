<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>  锔 Balance de escritura y lectura de bases de datos   锔</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En un art铆culo anterior , describ铆 el concepto y la implementaci贸n de una base de datos construida sobre la base de funciones, no tablas y campos como...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Balance de escritura y lectura de bases de datos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lsfusion/blog/459066/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/0w/wi/gl/0wwiglioocbaxcpjodrzg5x1ocs.jpeg" alt="imagen"></div><br>  En un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art铆culo</a> anterior <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">,</a> describ铆 el concepto y la implementaci贸n de una base de datos construida sobre la base de funciones, no tablas y campos como en las bases de datos relacionales.  Dio muchos ejemplos que muestran las ventajas de este enfoque sobre el cl谩sico.  Muchos los encontraron no lo suficientemente convincentes. <br><br>  En este art铆culo, mostrar茅 c贸mo este concepto le permite equilibrar r谩pida y convenientemente la escritura y la lectura en la base de datos sin ning煤n cambio en la l贸gica del trabajo.  Intentaron implementar una funcionalidad similar en DBMS comerciales modernos (en particular, Oracle y Microsoft SQL Server).  Al final del art铆culo, mostrar茅 lo que les sucedi贸, por decirlo suavemente, no muy. <br><a name="habracut"></a><br><h3>  Descripci贸n </h3><br>  Como antes, para una mejor comprensi贸n, comenzar茅 la descripci贸n con ejemplos.  Supongamos que necesitamos implementar una l贸gica que devuelva una lista de departamentos con el n煤mero de empleados en ellos y su salario total. <br><br>  En una base de datos funcional, se ver谩 as铆: <br><div class="scrollable-table"><table><tbody><tr><td><code><font color="#a626a4">CLASS</font> Department ''; <br> name '' = <font color="#a626a4">DATA</font> <font color="#a626a4">STRING</font> [ <font color="#986801">100</font> ] (Department); <br> <br> <font color="#a626a4">CLASS</font> Employee ''; <br> department '' = <font color="#a626a4">DATA</font> Department (Employee); <br> salary '' = <font color="#a626a4">DATA</font> <font color="#a626a4">NUMERIC</font> [ <font color="#986801">10</font> , <font color="#986801">2</font> ] (Employee); <br> <br> countEmployees '- ' (Department d) = <br> <font color="#a626a4">GROUP</font> <font color="#a626a4">SUM</font> <font color="#986801">1</font> <font color="#a626a4">IF</font> department(Employee e) = d; <br> salarySum ' ' (Department d) = <br> <font color="#a626a4">GROUP</font> <font color="#a626a4">SUM</font> salary(Employee e) <font color="#a626a4">IF</font> department(e) = d; <br> <br> SELECT name(Department d), countEmployees(d), salarySum(d); <br></code> </td></tr></tbody></table></div>  La complejidad de ejecutar esta consulta en cualquier DBMS ser谩 equivalente a <i>O (n煤mero de empleados)</i> , ya que para este c谩lculo debe escanear toda la tabla de empleados y luego agruparlos por departamento.  Tambi茅n habr谩 una peque帽a adici贸n (creemos que hay muchos m谩s empleados que departamentos) dependiendo del plan elegido <i>O (n煤mero de registro de empleados)</i> u <i>O (n煤mero de departamentos)</i> para la agrupaci贸n, etc. <br><br>  Est谩 claro que la sobrecarga para la ejecuci贸n puede ser diferente en diferentes DBMS, pero la complejidad no cambiar谩 de ninguna manera. <br><br>  En la implementaci贸n propuesta, el DBMS funcional formar谩 una subconsulta, que calcular谩 los valores necesarios para el departamento y luego se unir谩 a la tabla del departamento para obtener el nombre.  Sin embargo, para cada funci贸n, al declarar, es posible especificar un marcador MATERIALIZADO especial.  El sistema crear谩 autom谩ticamente un campo apropiado para cada funci贸n.  Cuando cambia el valor de una funci贸n, el valor del campo cambiar谩 en la misma transacci贸n.  Al acceder a esta funci贸n, ya se realizar谩 una apelaci贸n al campo calculado. <br><br>  En particular, si configura MATERIALIZADO para las funciones <i>countEmployees</i> y <i>salarrySum</i> , en la tabla con la lista de departamentos se agregar谩n dos campos en los que se almacenar谩 el n煤mero de empleados y su salario total.  Con cualquier cambio en los empleados, sus salarios o afiliaci贸n con los departamentos, el sistema cambiar谩 autom谩ticamente los valores de estos campos.  La consulta anterior comenzar谩 a acceder a estos campos directamente y se ejecutar谩 para <i>O (n煤mero de departamentos)</i> . <br><br>  驴Cu谩les son las limitaciones?  Solo una cosa: dicha funci贸n debe tener un n煤mero finito de valores de entrada para los que se define su valor.  De lo contrario, ser谩 imposible construir una tabla que almacene todos sus valores, ya que no puede haber una tabla con un n煤mero infinito de filas. <br><br>  Un ejemplo: <br><div class="scrollable-table"><table><tbody><tr><td> <code>employeesCount '    &gt; N' (Department d, <font color="#a626a4">NUMERIC</font> [ <font color="#986801">10</font> , <font color="#986801">2</font> ] N) = <br> <font color="#a626a4">GROUP</font> <font color="#a626a4">SUM</font> salary(Employee e) <font color="#a626a4">IF</font> department(e) = d <font color="#a626a4">AND</font> salary(e) &gt; N; <br></code> </td></tr></tbody></table></div>  Esta funci贸n se define para un n煤mero infinito de valores del n煤mero N (por ejemplo, cualquier valor negativo es adecuado).  Por lo tanto, no se puede poner MATERIALIZADO.  Por lo tanto, esta es una limitaci贸n l贸gica y no t茅cnica (es decir, no porque no hayamos podido implementar esto).  De lo contrario, no hay restricciones.  Puede usar la agrupaci贸n, la clasificaci贸n, AND y OR, PARTITION, recursi贸n, etc. <br><br>  Por ejemplo, en la tarea 2.2 del art铆culo anterior, puede poner MATERIALIZADO en ambas funciones: <br><div class="scrollable-table"><table><tbody><tr><td> <code>bought <font color="#50a14f">''</font> (Customer c, Product p, <font color="#a626a4">INTEGER</font> y) = <br> <font color="#a626a4">GROUP</font> <font color="#a626a4">SUM</font> sum(Detail d) <font color="#a626a4">IF</font> <br> customer(order(d)) = c <font color="#a626a4">AND</font> <br> product(d) = p <font color="#a626a4">AND</font> <br> extractYear(date(order(d))) = y <font color="#a626a4">MATERIALIZED</font> ; <br> rating <font color="#50a14f">''</font> (Customer c, Product p, <font color="#a626a4">INTEGER</font> y) = <br> <font color="#a626a4">PARTITION</font> <font color="#a626a4">SUM</font> <font color="#986801">1</font> <font color="#a626a4">ORDER</font> <font color="#a626a4">DESC</font> bought(c, p, y), p <font color="#a626a4">BY</font> c, y <font color="#a626a4">MATERIALIZED</font> ; <br> SELECT contactName(Customer c), name(Product p) <font color="#a626a4">WHERE</font> rating(c, p, <font color="#986801">1997</font> ) &lt; <font color="#986801">3</font> ; <br></code> </td></tr></tbody></table></div>  El propio sistema crear谩 una tabla con claves de los tipos <i>Cliente</i> , <i>Producto</i> e <i>INTEGER</i> , le agregar谩 dos campos y actualizar谩 los valores de los campos en ellos con cualquier cambio.  Tras nuevas llamadas a estas funciones, no se calcular谩n, pero se leer谩n los valores de los campos correspondientes. <br><br>  Con este mecanismo, puede, por ejemplo, deshacerse de la recursividad (CTE) en las consultas.  En particular, considere los grupos que forman el 谩rbol usando la relaci贸n hijo / padre (cada grupo tiene un enlace a su padre): <br><div class="scrollable-table"><table><tbody><tr><td> <code>parent = <font color="#a626a4">DATA</font> Group (Group); <br></code> </td></tr></tbody></table></div>  En una base de datos funcional, la l贸gica de recursi贸n se puede definir de la siguiente manera: <br><div class="scrollable-table"><table><tbody><tr><td> <code>level (Group child, Group parent) = <font color="#a626a4">RECURSION</font> <font color="#986801">1l</font> <font color="#a626a4">IF</font> child <font color="#a626a4">IS</font> Group <font color="#a626a4">AND</font> parent == child <br> <font color="#a626a4">STEP</font> <font color="#986801">2l</font> <font color="#a626a4">IF</font> parent == parent($parent); <br> isParent (Group child, Group parent) = <font color="#a626a4">TRUE</font> <font color="#a626a4">IF</font> level(child, parent) <font color="#a626a4">MATERIALIZED</font> ; <br></code> </td></tr></tbody></table></div>  Dado que MATERIALIZED est谩 fijado para la funci贸n <i>isParent</i> , se <i>crear谩</i> una tabla con dos claves (grupos), en la que el campo <i>isParent</i> ser谩 verdadero solo si la primera clave es descendiente de la segunda.  El n煤mero de entradas en esta tabla ser谩 igual al n煤mero de grupos multiplicado por la profundidad promedio del 谩rbol.  Si es necesario, por ejemplo, calcular el n煤mero de descendientes de un determinado grupo, puede acceder a esta funci贸n: <br><div class="scrollable-table"><table><tbody><tr><td> <code>childrenCount (Group g) = <font color="#a626a4">GROUP</font> <font color="#a626a4">SUM</font> <font color="#986801">1</font> <font color="#a626a4">IF</font> isParent(Group child, g); <br></code> </td></tr></tbody></table></div>  No habr谩 CTE en la consulta SQL.  En cambio, habr谩 un simple GROUP BY. <br><br>  Con este mecanismo, tambi茅n puede desnormalizar f谩cilmente la base de datos si es necesario: <br><div class="scrollable-table"><table><tbody><tr><td> <code><font color="#a626a4">CLASS</font> Order <font color="#50a14f">''</font> ; <br> date <font color="#50a14f">''</font> = <font color="#a626a4">DATA</font> <font color="#a626a4">DATE</font> (Order); <br> <br> <font color="#a626a4">CLASS</font> OrderDetail <font color="#50a14f">' '</font> ; <br> order <font color="#50a14f">''</font> = <font color="#a626a4">DATA</font> Order (OrderDetail); <br> date <font color="#50a14f">''</font> (OrderDetail d) = date(order(d)) <font color="#a626a4">MATERIALIZED</font> <font color="#a626a4">INDEXED</font> ; <br></code> </td></tr></tbody></table></div>  Cuando llame a la funci贸n de <i>fecha</i> para la l铆nea de orden, la lectura ser谩 de la tabla con l铆neas de orden del campo para el que hay un 铆ndice.  Al cambiar la fecha del pedido, el propio sistema recalcular谩 autom谩ticamente la fecha desnormalizada en la l铆nea. <br><br><h3>  Los beneficios </h3><br>  驴Por qu茅 se necesita todo este mecanismo?  En los DBMS cl谩sicos, sin reescribir consultas, un desarrollador o un DBA solo pueden cambiar 铆ndices, determinar estad铆sticas y decirle al planificador de consultas c贸mo ejecutarlos (adem谩s, las SUGERENCIAS est谩n disponibles solo en DBMS comerciales).  No importa cu谩nto lo intenten, no podr谩n cumplir la primera solicitud del art铆culo para <i>O (n煤mero de departamentos)</i> sin cambiar las solicitudes y agregar desencadenantes.  En el esquema propuesto, en la etapa de desarrollo, no tiene que pensar en la estructura del almacenamiento de datos y qu茅 agregaciones usar.  Todo esto se puede cambiar f谩cilmente sobre la marcha, directamente en funcionamiento. <br><br>  En la pr谩ctica, esto es lo siguiente.  Algunas personas desarrollan l贸gica directamente basada en la tarea.  No est谩n versados en algoritmos y su complejidad, ni en planes de ejecuci贸n, ni en tipos de join'ov, ni en ning煤n otro componente t茅cnico.  Estas personas son m谩s analistas de negocios que desarrolladores.  Luego, todo entra en pruebas u operaci贸n.  El registro de consultas largas est谩 habilitado.  Cuando se detecta una solicitud larga, otras personas (m谩s t茅cnicas, de hecho DBA) deciden incluir MATERIALIZADO en alguna funci贸n intermedia.  De este modo, la grabaci贸n se ralentiza un poco (ya que se requiere actualizar un campo adicional en una transacci贸n).  Sin embargo, no solo esta solicitud se acelera significativamente, sino tambi茅n todas las dem谩s que usan esta funci贸n.  Al mismo tiempo, tomar una decisi贸n sobre qu茅 funci贸n particular materializar es relativamente simple.  Dos par谩metros principales: el n煤mero de posibles valores de entrada (exactamente cu谩ntos registros habr谩 en la tabla correspondiente) y con qu茅 frecuencia se usa en otras funciones. <br><br><h3>  An谩logos </h3><br>  Los DBMS comerciales modernos tienen mecanismos similares: VISTA MATERIALIZADA con FAST REFRESH (Oracle) e INDEXED VIEW (Microsoft SQL Server).  En PostgreSQL MATERIALIZED VIEW no se puede actualizar en una transacci贸n, sino solo a pedido (e incluso con restricciones muy estrictas), por lo que no lo consideramos.  Pero tienen varios problemas, lo que limita en gran medida su uso. <br><br>  Primero, puede habilitar la materializaci贸n solo si ya ha creado una VISTA normal.  De lo contrario, tendr谩 que volver a escribir las solicitudes restantes para acceder a la vista reci茅n creada para poder utilizar esta materializaci贸n.  O d茅jelo como est谩, pero ser谩 al menos ineficaz si hay ciertos datos ya calculados, pero muchas consultas no siempre los usan, sino que los calcula de nuevo. <br><br>  En segundo lugar, tienen una gran cantidad de restricciones: <br><br><div class="spoiler">  <b class="spoiler_title">Or谩culo</b> <div class="spoiler_text"><blockquote><h5>  5.3.8.4 Restricciones generales sobre la actualizaci贸n r谩pida </h5><br>  La consulta de definici贸n de la vista materializada est谩 restringida de la siguiente manera: <br><ul><li>  La vista materializada no debe contener referencias a expresiones no repetitivas como <code>SYSDATE</code> y <code>ROWNUM</code> . </li><li>  La vista materializada no debe contener referencias a tipos de datos <code>RAW</code> o <code>LONG</code> <code>RAW</code> . </li><li>  No puede contener una subconsulta de lista <code>SELECT</code> . </li><li>  No puede contener funciones anal铆ticas (por ejemplo, <code>RANK</code> ) en la cl谩usula <code>SELECT</code> . </li><li>  No puede hacer referencia a una tabla en la que se define un 铆ndice <code>XMLIndex</code> . </li><li>  No puede contener una cl谩usula <code>MODEL</code> . </li><li>  No puede contener una cl谩usula <code>HAVING</code> con una subconsulta. </li><li>  No puede contener consultas anidadas que tengan <code>ANY</code> , <code>ALL</code> o <code>NOT</code> <code>EXISTS</code> . </li><li>  No puede contener una cl谩usula <code>[START WITH ] CONNECT BY</code> . </li><li>  No puede contener varias tablas de detalles en diferentes sitios. </li><li>  <code>ON</code> <code>COMMIT</code> las vistas materializadas no pueden tener tablas de detalles remotas. </li><li>  Las vistas materializadas anidadas deben tener una uni贸n o agregado. </li><li>  Las vistas de uni贸n materializadas y las vistas agregadas materializadas con una cl谩usula <code>GROUP</code> <code>BY</code> no se pueden seleccionar de una tabla organizada por 铆ndice. </li></ul><br><h5>  5.3.8.5 Restricciones a la actualizaci贸n r谩pida en vistas materializadas con combinaciones solamente </h5><br>  La definici贸n de consultas para vistas materializadas solo con combinaciones y sin agregados tiene las siguientes restricciones para la actualizaci贸n r谩pida: <br><ul><li>  Todas las restricciones de " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Restricciones generales sobre la actualizaci贸n r谩pida</a> ". </li><li>  No pueden tener cl谩usulas o agregados <code>GROUP</code> <code>BY</code> . </li><li>  Los Rowids de todas las tablas en la lista <code>FROM</code> deben aparecer en la lista <code>SELECT</code> de la consulta. </li><li>  Los registros de vista materializada deben existir con rowids para todas las tablas base en la lista <code>FROM</code> de la consulta. </li><li>  No puede crear una vista materializada r谩pida y actualizable desde varias tablas con combinaciones simples que incluyen una columna de tipo de objeto en la instrucci贸n <code>SELECT</code> . </li></ul><br>  Adem谩s, el m茅todo de actualizaci贸n que elija no ser谩 贸ptimamente eficiente si: <br><ul><li>  La consulta de definici贸n utiliza una combinaci贸n externa que se comporta como una combinaci贸n interna.  Si la consulta de definici贸n contiene dicha uni贸n, considere reescribir la consulta de definici贸n para que contenga una uni贸n interna. </li><li>  La lista <code>SELECT</code> de la vista materializada contiene expresiones en columnas de varias tablas. </li></ul><br><h5>  5.3.8.6 Restricciones a la actualizaci贸n r谩pida en vistas materializadas con agregados </h5><br>  La definici贸n de consultas para vistas materializadas con agregados o combinaciones tiene las siguientes restricciones en la actualizaci贸n r谩pida: <br><ul><li>  Todas las restricciones de " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Restricciones generales sobre la actualizaci贸n r谩pida</a> ". </li></ul><br>  La actualizaci贸n r谩pida es compatible con las vistas materializadas <code>ON</code> <code>COMMIT</code> y <code>ON</code> <code>DEMAND</code> , sin embargo, se aplican las siguientes restricciones: <br><ul><li>  Todas las tablas en la vista materializada deben tener registros de vista materializados, y los registros de vista materializada deben: <br><ul><li>  Contiene todas las columnas de la tabla referenciada en la vista materializada. </li><li>  Especifique con <code>ROWID</code> e <code>INCLUDING</code> <code>NEW</code> <code>VALUES</code> . </li><li>  Especifique la cl谩usula <code>SEQUENCE</code> si se espera que la tabla tenga una combinaci贸n de inserciones / cargas directas, eliminaciones y actualizaciones. </li></ul><br></li><li>  Solo <code>SUM</code> , <code>COUNT</code> , <code>AVG</code> , <code>VARIANCE</code> , <code>VARIANCE</code> , <code>MIN</code> y <code>MAX</code> son compatibles para una actualizaci贸n r谩pida. </li><li>  <code>COUNT(*)</code> debe especificarse. </li><li>  Las funciones agregadas deben aparecer solo como la parte m谩s externa de la expresi贸n.  Es decir, los agregados como <code>AVG(AVG(x))</code> o <code>AVG(x)</code> + <code>AVG(x)</code> no est谩n permitidos. </li><li>  Para cada agregado como <code>AVG(expr)</code> , el <code>COUNT(expr)</code> correspondiente <code>COUNT(expr)</code> debe estar presente.  Oracle recomienda que se especifique <code>SUM(expr)</code> . </li><li>  Si se especifica <code>STDDEV(expr</code> <code>VARIANCE(expr)</code> o <code>STDDEV(expr</code> ), <code>COUNT(expr)</code> y <code>SUM(expr)</code> deben especificarse.  Oracle recomienda que se especifique <code>SUM(expr *expr)</code> . </li><li>  La columna <code>SELECT</code> en la consulta de definici贸n no puede ser una expresi贸n compleja con columnas de varias tablas base.  Una posible soluci贸n a esto es usar una vista materializada anidada. </li><li>  La lista <code>SELECT</code> debe contener todas las columnas <code>GROUP</code> <code>BY</code> . </li><li>  La vista materializada no se basa en una o m谩s tablas remotas. </li><li>  Si usa un tipo de datos <code>CHAR</code> en las columnas de filtro de un registro de vista materializada, los juegos de caracteres del sitio maestro y la vista materializada deben ser los mismos. </li><li>  Si la vista materializada tiene uno de los siguientes, la actualizaci贸n r谩pida solo es compatible con inserciones DML convencionales y cargas directas. <br><ul><li>  Vistas materializadas con agregados <code>MIN</code> o <code>MAX</code> </li><li>  Vistas materializadas que tienen <code>SUM(expr)</code> pero no <code>COUNT(expr)</code> </li><li>  Vistas materializadas sin <code>COUNT(*)</code> </li></ul><br>  Dicha vista materializada se denomina vista materializada de solo inserci贸n. </li><li>  Una vista materializada con <code>MAX</code> o <code>MIN</code> se puede actualizar r谩pidamente despu茅s de eliminar o mezclar sentencias DML si no tiene una cl谩usula <code>WHERE</code> . <br>  La actualizaci贸n r谩pida m谩xima / m铆nima despu茅s de eliminar o mezclar DML no tiene el mismo comportamiento que el caso de solo inserci贸n.  Elimina y vuelve a calcular los valores m谩ximos / m铆nimos para los grupos afectados.  Debe ser consciente de su impacto en el rendimiento. </li><li>  Las vistas materializadas con vistas con nombre o subconsultas en la cl谩usula <code>FROM</code> se pueden actualizar r谩pidamente siempre que las vistas se puedan combinar por completo.  Para obtener informaci贸n sobre qu茅 vistas se combinar谩n, consulte la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Referencia del lenguaje SQL de la base de datos Oracle</a> . </li><li>  Si no hay combinaciones externas, puede tener selecciones arbitrarias y combinaciones en la cl谩usula <code>WHERE</code> . </li><li>  Las vistas agregadas materializadas con uniones externas se pueden actualizar r谩pidamente despu茅s de DML convencional y cargas directas, siempre que solo se haya modificado la tabla externa.  Adem谩s, deben existir restricciones 煤nicas en las columnas de uni贸n de la tabla de uni贸n interna.  Si hay uniones externas, todas las uniones deben estar conectadas por <code>AND</code> sy deben usar el operador de igualdad ( <code>=</code> ). </li><li>  Para las vistas materializadas con <code>CUBE</code> , <code>ROLLUP</code> , conjuntos de agrupaci贸n o concatenaci贸n de ellas, se aplican las siguientes restricciones: <br><ul><li>  La lista <code>SELECT</code> debe contener un distintivo de agrupaci贸n que puede ser una funci贸n <code>GROUPING_ID</code> en todas las expresiones <code>GROUP</code> <code>BY</code> o funciones <code>GROUPING</code> una para cada expresi贸n <code>GROUP</code> <code>BY</code> .  Por ejemplo, si la cl谩usula <code>GROUP</code> <code>BY</code> de la vista materializada es " <code>GROUP</code> <code>BY</code> <code>CUBE(a, b)</code> ", la lista <code>SELECT</code> debe contener " <code>GROUPING_ID(a, b)</code> " o " <code>GROUPING(a)</code> <code>AND</code> <code>GROUPING(b)</code> "para que la vista materializada se actualice r谩pidamente. </li><li>  <code>GROUP</code> <code>BY</code> no debe dar lugar a agrupaciones duplicadas.  Por ejemplo, " <code>GROUP BY a, ROLLUP(a, b)</code> " no se puede actualizar r谩pidamente porque da como resultado agrupaciones duplicadas " <code>(a), (a, b), AND (a)</code> ". </li></ul></li></ul><br><h5>  5.3.8.7 Restricciones a la actualizaci贸n r谩pida en vistas materializadas con UNION ALL </h5><br>  Las vistas materializadas con el operador conjunto <code>UNION</code> <code>ALL</code> admiten la opci贸n <code>REFRESH</code> <code>FAST</code> si se cumplen las siguientes condiciones: <br><ul><li>  La consulta de definici贸n debe tener el operador <code>UNION</code> <code>ALL</code> en el nivel superior. <br><br>  El operador <code>UNION</code> <code>ALL</code> no se puede incrustar dentro de una subconsulta, con una excepci贸n: <code>UNION</code> <code>ALL</code> puede estar en una subconsulta en la cl谩usula <code>FROM</code> siempre que la consulta de definici贸n tenga la forma <code>SELECT * FROM</code> (vista o subconsulta con <code>UNION</code> <code>ALL</code> ) como en el siguiente ejemplo: <br><pre>  CREAR VISTA view_with_unionall AS
 (SELECCIONE c.rowid crid, c.cust_id, 2 umarker
  DE clientes c DONDE c.cust_last_name = 'Smith'
  UNIN TODO
  SELECCIONE c.rowid crid, c.cust_id, 3 umarker
  DE clientes c DONDE c.cust_last_name = 'Jones');<font></font>
<font></font>
 CREAR VISTA MATERIALIZADA unionall_inside_view_mv
 ACTUALIZACIN RPIDA EN LA DEMANDA
 SELECCIONAR * DESDE view_with_unionall;
</pre>  Tenga en cuenta que la vista <code>view_with_unionall</code> cumple los requisitos para una actualizaci贸n r谩pida. </li><li>  Cada bloque de consulta en la consulta <code>UNION</code> <code>ALL</code> debe cumplir los requisitos de una vista materializada r谩pida y actualizable con agregados o una vista materializada r谩pida y renovable con uniones. <br><br>  Los registros de vista materializada apropiados se deben crear en las tablas seg煤n sea necesario para el tipo correspondiente de vista materializada r谩pida y actualizable. <br>  Tenga en cuenta que la base de datos Oracle tambi茅n permite el caso especial de una vista materializada de una sola tabla con combinaciones solo si la columna <code>ROWID</code> se ha incluido en la lista <code>SELECT</code> y en el registro de vista materializada.  Esto se muestra en la consulta de definici贸n de la vista <code>view_with_unionall</code> . </li><li>  La lista <code>SELECT</code> de cada consulta debe incluir un marcador <code>UNION</code> <code>ALL</code> , y la columna <code>UNION</code> <code>ALL</code> debe tener un valor num茅rico o de cadena constante diferente en cada rama <code>UNION</code> <code>ALL</code> .  Adem谩s, la columna de marcador debe aparecer en la misma posici贸n ordinal en la lista <code>SELECT</code> de cada bloque de consulta.  Consulte " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Marcador de UNION ALL y reescritura de consultas</a> " para obtener m谩s informaci贸n sobre los marcadores <code>UNION</code> <code>ALL</code> . </li><li>  Algunas funciones, como las uniones externas, las consultas de vistas materializadas agregadas de solo inserci贸n y las tablas remotas no son compatibles con las vistas materializadas con <code>UNION</code> <code>ALL</code> .  Sin embargo, tenga en cuenta que las vistas materializadas utilizadas en la replicaci贸n, que no contienen uniones o agregados, pueden actualizarse r谩pidamente cuando se utilizan <code>UNION</code> <code>ALL</code> o tablas remotas. </li><li>  El par谩metro de inicializaci贸n de compatibilidad debe establecerse en 9.2.0 o superior para crear una vista materializada r谩pida y actualizable con <code>UNION</code> <code>ALL</code> . </li></ul></blockquote></div></div><br>  No quiero ofender a los fan谩ticos de Oracle, pero a juzgar por su lista de limitaciones, parece que este mecanismo no se escribi贸 en el caso general utilizando alg煤n tipo de modelo, sino miles de indios, donde a todos se les permiti贸 escribir su propio hilo, y cada uno de ellos pudo y lo hizo  Usar este mecanismo para una l贸gica real es como caminar en un campo minado.  En cualquier momento, puede obtener una mina, golpeando una de las limitaciones no obvias.  C贸mo funciona esto tambi茅n es un tema aparte, pero est谩 fuera del alcance de este art铆culo. <br><br><div class="spoiler">  <b class="spoiler_title">Microsoft SQL Server</b> <div class="spoiler_text"><blockquote><h3>  Requerimientos Adicionales </h3><br>  Adem谩s de las opciones SET y los requisitos de la funci贸n determinista, se deben cumplir los siguientes requisitos: <br><ul><li>  El usuario que ejecuta <code>CREATE INDEX</code> debe ser el propietario de la vista. </li><li>  Cuando crea el 铆ndice, la opci贸n <code>IGNORE_DUP_KEY</code> debe establecerse en OFF (la configuraci贸n predeterminada). </li><li>  Las tablas deben estar referenciadas por nombres de dos partes, <em>esquema</em> <strong>.</strong>  <em>nombre de tabla</em> en la definici贸n de vista. </li><li>  Las funciones definidas por el usuario a las que se hace referencia en la vista deben crearse utilizando la opci贸n <code>WITH SCHEMABINDING</code> . </li><li>  Cualquier funci贸n definida por el usuario a la que se haga referencia en la vista debe estar referenciada por nombres de dos partes, <em>&lt;schema&gt;</em> <strong>.</strong>  <em>&lt;funci贸n&gt;</em> . </li><li>  La propiedad de acceso a datos de una funci贸n definida por el usuario debe ser <code>NO SQL</code> , y la propiedad de acceso externo debe ser <code>NO</code> . </li><li>  Las funciones de Common Language Runtime (CLR) pueden aparecer en la lista de selecci贸n de la vista, pero no pueden ser parte de la definici贸n de la clave de 铆ndice agrupada.  Las funciones CLR no pueden aparecer en la cl谩usula WHERE de la vista o en la cl谩usula ON de una operaci贸n JOIN en la vista. </li><li>  Las funciones y m茅todos CLR de los tipos definidos por el usuario CLR utilizados en la definici贸n de vista deben tener las propiedades establecidas como se muestra en la siguiente tabla. <br><div class="scrollable-table"><table><thead><tr><th>  Propiedad </th><th>  Nota </th></tr></thead><tbody><tr><td>  DETERMINISTICA = VERDADERO </td><td>  Debe declararse expl铆citamente como un atributo del m茅todo Microsoft .NET Framework. </td></tr><tr><td>  PRECISO = VERDADERO </td><td>  Debe declararse expl铆citamente como un atributo del m茅todo .NET Framework. </td></tr><tr><td>  ACCESO A DATOS = NO SQL </td><td>  Determinado estableciendo el atributo DataAccess en DataAccessKind.None y el atributo SystemDataAccess en SystemDataAccessKind.None. </td></tr><tr><td>  ACCESO EXTERNO = NO </td><td>  Esta propiedad por defecto es NO para las rutinas CLR. </td></tr><tr><td></td><td></td></tr></tbody></table></div></li><li>  La vista debe crearse utilizando la opci贸n <code>WITH SCHEMABINDING</code> . </li><li>  La vista debe hacer referencia solo a las tablas base que est谩n en la misma base de datos que la vista.  La vista no puede hacer referencia a otras vistas. </li><li>  La instrucci贸n SELECT en la definici贸n de vista no debe contener los siguientes elementos de Transact-SQL: <br><div class="scrollable-table"><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td> <code>COUNT</code> </td> <td>  Funciones de ROWSET ( <code>OPENDATASOURCE</code> , <code>OPENQUERY</code> , <code>OPENROWSET</code> Y <code>OPENXML</code> ) </td><td>  <code>OUTER</code> une ( <code>LEFT</code> , <code>RIGHT</code> o <code>FULL</code> ) </td></tr><tr><td>  Tabla derivada (definida al especificar una instrucci贸n <code>SELECT</code> en la cl谩usula <code>FROM</code> ) </td><td>  Autouniones </td><td>  Especificar columnas usando <code>SELECT *</code> o <code>SELECT &lt;table_name&gt;.*</code> </td></tr><tr><td> <code>DISTINCT</code> </td> <td>  <code>STDEV</code> , <code>STDEVP</code> , <code>VAR</code> , <code>VARP</code> o <code>AVG</code> </td><td>  Expresi贸n de tabla com煤n (CTE) </td></tr><tr><td>  <strong>flotante</strong> <sup>1</sup> , <strong>texto</strong> , <strong>ntext</strong> , <strong>imagen</strong> , <strong>XML</strong> o columnas de <strong>flujo de archivos</strong> </td><td>  Subconsulta </td><td>  Cl谩usula <code>OVER</code> , que incluye funciones de clasificaci贸n o ventana agregada </td></tr><tr><td>  Predicados de texto completo ( <code>CONTAINS</code> , <code>FREETEXT</code> ) </td><td>  Funci贸n <code>SUM</code> que hace referencia a una expresi贸n anulable </td><td> <code>ORDER BY</code> </td> </tr><tr><td>  Funci贸n agregada definida por el usuario CLR </td><td> <code>TOP</code> </td> <td>  <code>ROLLUP</code> <code>CUBE</code> , <code>ROLLUP</code> o <code>ROLLUP</code> <code>GROUPING SETS</code> </td></tr><tr><td>  <code>MIN</code> , <code>MAX</code> </td><td>  Operadores <code>UNION</code> , <code>EXCEPT</code> o <code>INTERSECT</code> </td><td> <code>TABLESAMPLE</code> </td> </tr><tr><td>  Variables de la tabla </td><td>  <code>OUTER APPLY</code> o <code>CROSS APPLY</code> </td><td>  <code>PIVOT</code> , <code>UNPIVOT</code> </td></tr><tr><td>  Conjuntos de columnas dispersas </td><td>  Funciones en l铆nea (TVF) o con valores de tabla de varias instrucciones (MSTVF) </td><td> <code>OFFSET</code> </td> </tr><tr><td> <code>CHECKSUM_AGG</code> </td> <td></td><td></td></tr><tr><td></td><td></td><td></td></tr></tbody></table></div><br>  <sup>1</sup> La vista indizada puede contener columnas <strong>flotantes</strong> ;  sin embargo, tales columnas no se pueden incluir en la clave de 铆ndice agrupado. </li><li>  Si <code>GROUP BY</code> est谩 presente, la definici贸n VIEW debe contener <code>COUNT_BIG(*)</code> y no debe contener <code>HAVING</code> .  Estas restricciones de <code>GROUP BY</code> son aplicables solo a la definici贸n de vista indizada.  Una consulta puede usar una vista indizada en su plan de ejecuci贸n incluso si no cumple con estas restricciones <code>GROUP BY</code> . </li><li>  Si la definici贸n de vista contiene una cl谩usula <code>GROUP BY</code> , la clave del 铆ndice agrupado 煤nico puede hacer referencia solo a las columnas especificadas en la cl谩usula <code>GROUP BY</code> . </li></ul></blockquote></div></div><br>  Aqu铆 puede ver que los indios no se sintieron atra铆dos, ya que decidieron hacerlo de acuerdo con el esquema "haremos poco, pero bien".  Es decir, tienen m谩s minas en el campo, pero su ubicaci贸n es m谩s transparente.  Lo m谩s angustiante es esta limitaci贸n: <br><blockquote>  La vista debe hacer referencia solo a las tablas base que est谩n en la misma base de datos que la vista.  La vista no puede hacer referencia a otras vistas. </blockquote><br>  En nuestra terminolog铆a, esto significa que una funci贸n no puede acceder a otra funci贸n materializada.  Corta toda la ideolog铆a de ra铆z. <br>  Adem谩s, esta limitaci贸n (y m谩s adelante en el texto) reduce en gran medida los casos de uso: <br><blockquote>  La instrucci贸n SELECT en la definici贸n de vista no debe contener los siguientes elementos de Transact-SQL: <br><div class="scrollable-table"><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td> <code>COUNT</code> </td> <td>  Funciones de ROWSET ( <code>OPENDATASOURCE</code> , <code>OPENQUERY</code> , <code>OPENROWSET</code> Y <code>OPENXML</code> ) </td><td>  <code>OUTER</code> une ( <code>LEFT</code> , <code>RIGHT</code> o <code>FULL</code> ) </td></tr><tr><td>  Tabla derivada (definida al especificar una instrucci贸n <code>SELECT</code> en la cl谩usula <code>FROM</code> ) </td><td>  Autouniones </td><td>  Especificar columnas usando <code>SELECT *</code> o <code>SELECT &lt;table_name&gt;.*</code> </td></tr><tr><td> <code>DISTINCT</code> </td> <td>  <code>STDEV</code> , <code>STDEVP</code> , <code>VAR</code> , <code>VARP</code> o <code>AVG</code> </td><td>  Expresi贸n de tabla com煤n (CTE) </td></tr><tr><td>  <strong>flotante</strong> <sup>1</sup> , <strong>texto</strong> , <strong>ntext</strong> , <strong>imagen</strong> , <strong>XML</strong> o columnas de <strong>flujo de archivos</strong> </td><td>  Subconsulta </td><td>  Cl谩usula <code>OVER</code> , que incluye funciones de clasificaci贸n o ventana agregada </td></tr><tr><td>  Predicados de texto completo ( <code>CONTAINS</code> , <code>FREETEXT</code> ) </td><td>  Funci贸n <code>SUM</code> que hace referencia a una expresi贸n anulable </td><td> <code>ORDER BY</code> </td> </tr><tr><td>  Funci贸n agregada definida por el usuario CLR </td><td> <code>TOP</code> </td> <td>  <code>ROLLUP</code> <code>CUBE</code> , <code>ROLLUP</code> o <code>ROLLUP</code> <code>GROUPING SETS</code> </td></tr><tr><td>  <code>MIN</code> , <code>MAX</code> </td><td>  Operadores <code>UNION</code> , <code>EXCEPT</code> o <code>INTERSECT</code> </td><td> <code>TABLESAMPLE</code> </td> </tr><tr><td>  Variables de la tabla </td><td>  <code>OUTER APPLY</code> o <code>CROSS APPLY</code> </td><td>  <code>PIVOT</code> , <code>UNPIVOT</code> </td></tr><tr><td>  Conjuntos de columnas dispersas </td><td>  Funciones en l铆nea (TVF) o con valores de tabla de varias instrucciones (MSTVF) </td><td> <code>OFFSET</code> </td> </tr><tr><td> <code>CHECKSUM_AGG</code> </td> <td></td><td></td></tr><tr><td></td><td></td><td></td></tr></tbody></table></div></blockquote><br>  OUTER JOINS, UNION, ORDER BY y otros est谩n prohibidos.  Quiz谩s fue m谩s f谩cil indicar qu茅 se puede usar que qu茅 no.  La lista probablemente ser铆a mucho m谩s peque帽a. <br><br>  Para resumir: un gran conjunto de restricciones en cada DBMS (noto comercial) versus ninguno (con la excepci贸n de uno l贸gico en lugar de t茅cnico) en la tecnolog铆a LGPL.  Sin embargo, debe tenerse en cuenta que implementar este mecanismo en la l贸gica relacional es algo m谩s complicado que en el funcional descrito. <br><br><h3>  Implementaci贸n </h3><br>  Como funciona  PostgreSQL se utiliza como una "m谩quina virtual".  En el interior hay un algoritmo complejo que genera consultas.  Aqu铆 est谩 el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">c贸digo fuente</a> .  Y no solo hay un gran conjunto de heur铆sticas con un mont贸n de ifs.  Entonces, si tiene un par de meses para estudiar, puede intentar comprender la arquitectura. <br><br>  驴Funciona de manera eficiente?  Efectivamente suficiente.  Desafortunadamente, probar esto es dif铆cil.  Solo puedo decir que si considera las miles de solicitudes que se encuentran en aplicaciones grandes, en promedio son m谩s efectivas que un buen desarrollador.  Un excelente programador de SQL puede escribir cualquier consulta de manera m谩s eficiente, pero con mil consultas, simplemente no tendr谩 la motivaci贸n ni el tiempo para hacerlo.  Lo 煤nico que puedo dar ahora como evidencia de efectividad es que, sobre la base de la plataforma construida en este DBMS, varios proyectos del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sistema ERP</a> funcionan en los que hay miles de funciones MATERIALIZADAS diferentes, con miles de usuarios y bases de datos de terrabyte con cientos de millones de registros funcionando en un servidor de doble procesador normal.  Sin embargo, cualquiera puede probar / refutar la efectividad descargando la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">plataforma</a> y PostgreSQL, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">permitiendo el</a> registro de consultas SQL e intentando cambiar la l贸gica y los datos all铆. <br><br>  En los siguientes art铆culos, tambi茅n hablar茅 sobre c贸mo puede colgar restricciones en las funciones, trabajar con sesiones de cambio y mucho m谩s. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/459066/">https://habr.com/ru/post/459066/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459046/index.html">C贸mo implementar independientemente (Prueba de existencia) en 2 pasos</a></li>
<li><a href="../459050/index.html">Potente m贸dulo de escritura Vuex</a></li>
<li><a href="../459052/index.html">C贸mo comparar: "coche incre铆ble" y "choza fea", en una encuesta de marketing y en Big Data</a></li>
<li><a href="../459054/index.html">Mapa de calor de clics: c贸mo se comportan los usuarios en el sitio</a></li>
<li><a href="../459062/index.html">El resumen de materiales interesantes para el desarrollador m贸vil # 305 (del 1 al 7 de julio)</a></li>
<li><a href="../459068/index.html">Windows Server 2008 R2 - El rey est谩 muerto, viva el rey</a></li>
<li><a href="../459070/index.html">Creaci贸n de defensa de la torre en la unidad: torres y enemigos que disparan</a></li>
<li><a href="../459074/index.html">Petty little joy # 7: tres por el precio de uno: animaci贸n de consola, algoritmos y depuraci贸n</a></li>
<li><a href="../459078/index.html">CERN cambia a software de c贸digo abierto, 驴por qu茅?</a></li>
<li><a href="../459080/index.html">Caracter铆sticas HttpUrlConnection de java.net</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>