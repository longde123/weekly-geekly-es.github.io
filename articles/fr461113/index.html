<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¿â€ğŸ­ ğŸ¦‰ ğŸ§’ Cinq ans d'utilisation de C ++ pour des projets de microcontrÃ´leurs en production ğŸ‘©ğŸ¼â€ğŸ³ ğŸ¤° ğŸ§šğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je vais vous raconter comment j'ai transfÃ©rÃ© les entreprises sur lesquelles j'ai travaillÃ© pendant plus de cinq ans de la gestion de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cinq ans d'utilisation de C ++ pour des projets de microcontrÃ´leurs en production</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461113/">  Dans cet article, je vais vous raconter comment j'ai transfÃ©rÃ© les entreprises sur lesquelles j'ai travaillÃ© pendant plus de cinq ans de la gestion de projets de microcontrÃ´leurs en C vers C ++ et ce qui en est ressorti (spoiler: tout va mal). <br><a name="habracut"></a><br><h2>  Un peu de toi </h2><br>  J'ai commencÃ© Ã  Ã©crire sous les microcontrÃ´leurs C, n'ayant qu'une expÃ©rience scolaire avec Pascal, puis j'ai Ã©tudiÃ© l'assembleur et j'ai passÃ© environ 3 ans Ã  Ã©tudier diverses architectures de microcontrÃ´leurs et leurs pÃ©riphÃ©riques.  Puis il y a eu l'expÃ©rience du vrai travail en C # et C ++ avec leur Ã©tude parallÃ¨le, qui a durÃ© plusieurs annÃ©es.  AprÃ¨s cette pÃ©riode, je suis retournÃ© encore et longtemps Ã  la programmation de microcontrÃ´leurs, disposant dÃ©jÃ  des bases thÃ©oriques nÃ©cessaires pour travailler sur des projets rÃ©els. <br><br><h2>  PremiÃ¨re annÃ©e </h2><br>  Je n'avais rien contre le style procÃ©dural de C, cependant, l'entreprise qui a commencÃ© ma pratique rÃ©elle sur des projets rÃ©els a utilisÃ© la Â«programmation C dans un style orientÃ© objetÂ».  Cela ressemblait Ã  quelque chose comme Ã§a. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uart_init</span></span></span><span class="hljs-class"> {</span></span> USART_TypeDef *USARTx; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> baudrate; ... } <span class="hljs-keyword"><span class="hljs-keyword">uart_cfg_t</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uart_init</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uart_cfg_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *cfg)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uart_start_tx</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *d, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> l)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uart_tx</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *d, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> l, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout)</span></span></span></span>;</code> </pre> <br>  Cette approche prÃ©sente les avantages suivants: <br><br><ol><li>  le code est restÃ© le code C. Les avantages suivants en dÃ©coulent: <ul><li>  il est plus facile de contrÃ´ler les Â«objetsÂ», car il est facile de retracer qui et oÃ¹ provoque quoi et dans quelle sÃ©quence (Ã  l'exception des interruptions, mais pas dans cet article); </li><li>  pour stocker le "pointeur sur l'objet" il suffit de se souvenir du fd retournÃ©; </li><li>  si Â«l'objetÂ» a Ã©tÃ© supprimÃ©, alors lorsque vous essayez de l'utiliser, vous recevrez une erreur correspondante dans la valeur de retour de la fonction; </li></ul></li><li>  l'abstraction de tels objets sur le HAL qui y est utilisÃ© a permis d'Ã©crire des objets personnalisables pour la tÃ¢che Ã  partir de sa propre structure d'initialisation (et dans le cas d'un manque de fonctionnalitÃ© HAL, on pourrait masquer l'accÃ¨s aux registres Ã  l'intÃ©rieur des "objets"). </li></ol><br>  InconvÃ©nients: <br><br><ol><li>  si quelqu'un a supprimÃ© Â«l'objetÂ», puis en a crÃ©Ã© un nouveau d'un type diffÃ©rent, il peut arriver que le nouveau obtienne le fd de l'ancien et qu'aucun autre comportement ne soit dÃ©terminÃ©.  Ce comportement pourrait Ãªtre facilement modifiÃ© au prix d'une petite consommation de mÃ©moire pour une liste chaÃ®nÃ©e au lieu d'utiliser un tableau avec une Â«valeur-clÃ©Â» (un tableau pour chaque index fd stockait un pointeur sur la structure de l'objet). </li><li>  il Ã©tait impossible de marquer statiquement la mÃ©moire sous "objets globaux".  Ã‰tant donnÃ© que dans la plupart des applications, les Â«objetsÂ» ont Ã©tÃ© crÃ©Ã©s une fois et n'ont pas Ã©tÃ© supprimÃ©s, cela ressemblait Ã  une Â«bÃ©quilleÂ».  Ici, lors de la crÃ©ation d'un objet, il serait possible de passer un pointeur sur sa structure interne, qui Ã©tait allouÃ©e statiquement lors de la mise en page, mais cela perturberait encore plus le code d'initialisation et romprait l'encapsulation. </li></ol><br>  Lorsqu'on leur a demandÃ© pourquoi C ++ n'avait pas Ã©tÃ© sÃ©lectionnÃ© lors de la construction de l'infrastructure entiÃ¨re, ils ont rÃ©pondu quelque chose comme ceci: Â«Eh bien, C ++ entraÃ®ne des coÃ»ts supplÃ©mentaires Ã©levÃ©s, des coÃ»ts de mÃ©moire incontrÃ´lÃ©s, ainsi qu'un fichier de micrologiciel exÃ©cutable volumineux.  Peut-Ãªtre qu'ils avaient raison.  En effet, au moment du dÃ©but de la conception, il n'y avait que GCC 3.0.5, qui ne brillait pas avec une convivialitÃ© particuliÃ¨re au C ++ (nous devons encore travailler avec lui pour Ã©crire des programmes sous QNX6).  Il n'y avait pas de constexpr et C ++ 11/14, vous permettant de crÃ©er des objets globaux, qui Ã©taient essentiellement des donnÃ©es dans la zone .data, calculÃ©es au stade de la compilation et des mÃ©thodes pour eux. <br><br>  Ã€ la question, pourquoi ne pas Ã©crire sur les registres - j'ai obtenu une rÃ©ponse claire que l'utilisation des "objets" vous permet de configurer le mÃªme type d'application "en une journÃ©e". <br><br>  RÃ©alisant tout cela et rÃ©alisant que maintenant C ++ n'est plus le mÃªme qu'avec GCC 3.0.5, j'ai commencÃ© Ã  rÃ©Ã©crire la partie principale de la fonctionnalitÃ© en C ++.  Pour commencer, travaillez avec les pÃ©riphÃ©riques matÃ©riels du microcontrÃ´leur, puis les pÃ©riphÃ©riques des pÃ©riphÃ©riques externes.  En fait, ce n'Ã©tait qu'un shell plus pratique que ce qui Ã©tait disponible Ã  l'Ã©poque. <br><br><h2>  DeuxiÃ¨me et troisiÃ¨me annÃ©es </h2><br>  J'ai rÃ©Ã©crit tout ce dont j'avais besoin pour mes projets en C ++ et j'ai continuÃ© Ã  Ã©crire de nouveaux modules tout de suite en C ++.  Cependant, il ne s'agissait que de shells sur C. Ayant rÃ©alisÃ© que je n'utilisais pas assez C ++, j'ai commencÃ© Ã  utiliser ses points forts: modÃ¨les, classes d'en-tÃªte uniquement, constexpr, etc.  Tout allait bien. <br><br><h2>  QuatriÃ¨me et cinquiÃ¨me annÃ©e </h2><br><ul><li>  tous les objets sont globaux et incluent des liens entre eux au stade de la compilation (selon l'architecture du projet); </li><li>  tous les objets reÃ§oivent de la mÃ©moire au stade de la mise en page; </li><li>  par objet de classe pour chaque broche; </li><li>  un objet qui encapsule toutes les broches pour les initialiser avec une seule mÃ©thode; </li><li>  un objet de contrÃ´le RCC qui encapsule tous les objets qui se trouvent sur les bus matÃ©riels; </li><li>  Le projet de convertisseur CAN &lt;-&gt; RS485 selon le protocole client contient 60 objets; </li><li>  dans le cas oÃ¹ quelque chose se trouve Ã  ce niveau au niveau HAL ou classe d'un objet, vous devez non seulement Â«rÃ©soudre le problÃ¨meÂ», mais aussi penser Ã  le rÃ©soudre pour que ce correctif fonctionne sur toutes les configurations possibles de ce module ; </li><li>  les modÃ¨les et constexpr utilisÃ©s ne peuvent pas Ãªtre calculÃ©s avant de visualiser les fichiers map, asm et bin du firmware final (ou de lancer le dÃ©bogage dans le microcontrÃ´leur); </li><li>  en cas d'erreur dans le modÃ¨le, un message d'une longueur d'un tiers de la configuration du projet de GCC est Ã©mis.  En lire et en comprendre quelque chose est une rÃ©alisation distincte. </li></ul><br><h2>  RÃ©sumÃ© </h2><br>  Maintenant, je comprends ce qui suit: <ol><li>  l'utilisation de Â«constructeurs de modules universelsÂ» complique inutilement le programme.  Il est beaucoup plus facile d'ajuster les registres de configuration pour un nouveau projet que de se plonger dans les relations entre les objets, puis aussi dans la bibliothÃ¨que HAL; </li><li>  n'ayez pas peur d'utiliser C ++ de peur qu'il "engloutisse beaucoup de mÃ©moire" ou "soit moins optimisÃ© que C".  Non, Ã§a ne l'est pas.  Vous devez avoir peur que l'utilisation d'objets et de nombreuses couches d'abstraction rende le code illisible, et le dÃ©bogage sera un exploit hÃ©roÃ¯que; </li><li>  si vous n'utilisez rien de Â«compliquantÂ», comme les modÃ¨les, l'hÃ©ritage et d'autres charmes attrayants de C ++, alors pourquoi utiliser C ++?  Juste pour le bien des objets?  Est-ce que Ã§a vaut le coup?  Et pour des objets globaux statiques sans utiliser new / delete interdits sur certains projets? </li></ol><br>  En rÃ©sumÃ©, nous pouvons dire que l'apparente simplicitÃ© d'utilisation de C ++ s'est avÃ©rÃ©e Ãªtre juste une excuse pour augmenter Ã  plusieurs reprises la complexitÃ© du projet sans aucun gain de vitesse ou de mÃ©moire. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461113/">https://habr.com/ru/post/fr461113/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461095/index.html">Apollo Guidance Computer - logiciel d'architecture et de systÃ¨me. Partie 1</a></li>
<li><a href="../fr461099/index.html">Jeu AirAttack! - notre premiÃ¨re expÃ©rience de dÃ©veloppement VR</a></li>
<li><a href="../fr461101/index.html">Android Jetpack Composer la premiÃ¨re impression</a></li>
<li><a href="../fr461105/index.html">5 plugins webpack utiles</a></li>
<li><a href="../fr461107/index.html">DosimÃ¨tre pour Seryozha. Partie II Tubes du centenaire vs atome pacifique</a></li>
<li><a href="../fr461121/index.html">Petites expÃ©riences multitÃ¢ches dans un microcontrÃ´leur</a></li>
<li><a href="../fr461125/index.html">La tÃ¢che de crÃ©ation de codes numÃ©riques sÃ©quentiels pour la numÃ©rotation des messages dans le code source dans Visual Studio (ex. C #)</a></li>
<li><a href="../fr461127/index.html">Analyse des performances des machines virtuelles dans VMware vSphere. Partie 3: Stockage</a></li>
<li><a href="../fr461129/index.html">Ã€ propos de Kote, de sa femme, de ses deux fils, de l'idÃ©e ... et pas seulement. Histoire avec suite</a></li>
<li><a href="../fr461131/index.html">Chariot Ã  chariots ROS, partie 2. Logiciel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>