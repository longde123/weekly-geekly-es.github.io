<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêò üòú üëåüèº Nossa experi√™ncia de cria√ß√£o de API de gateway üÖæÔ∏è üßê üë©‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Algumas empresas, incluindo nosso cliente, desenvolvem o produto por meio de uma rede afiliada. Por exemplo, grandes lojas online s√£o integradas a um ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nossa experi√™ncia de cria√ß√£o de API de gateway</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/446438/">  Algumas empresas, incluindo nosso cliente, desenvolvem o produto por meio de uma rede afiliada.  Por exemplo, grandes lojas online s√£o integradas a um servi√ßo de entrega - voc√™ solicita mercadorias e logo recebe um n√∫mero de rastreamento para a encomenda.  Outro exemplo - junto com uma passagem a√©rea, voc√™ compra um seguro ou uma passagem Aeroexpress. <br><br>  Para isso, √© usada uma API, que deve ser emitida aos parceiros por meio da API do Gateway.  N√≥s resolvemos esse problema.  Este artigo fornecer√° detalhes. <br><br>  Dado: portal do ecossistema e API com uma interface onde os usu√°rios s√£o registrados, recebem informa√ß√µes, etc.  Precisamos criar uma API de gateway conveniente e confi√°vel.  No processo, precis√°vamos fornecer <br><br><ul><li>  Registo </li><li>  Controle de conex√£o API </li><li>  Monitorando como os usu√°rios usam o sistema final </li><li>  contabilidade de indicadores de neg√≥cios. </li></ul><br><img src="https://habrastorage.org/webt/op/f3/aa/opf3aadequfubwpkiu4gci8j9nm.png"><br><br>  No artigo, falaremos sobre nossa experi√™ncia na cria√ß√£o da API do Gateway, durante a qual resolvemos as seguintes tarefas: <br><br><ul><li>  autentica√ß√£o de usu√°rio </li><li>  autoriza√ß√£o do usu√°rio </li><li>  modifica√ß√£o do pedido original, </li><li>  solicitar proxy </li><li>  p√≥s-processamento da resposta. </li></ul><br><a name="habracut"></a><br>  Existem dois tipos de gerenciamento de API: <br><br>  1. Padr√£o, que funciona da seguinte maneira.  Antes de conectar, o usu√°rio testa as possibilidades, paga e incorpora em seu site.  Na maioria das vezes, √© usado em pequenas e m√©dias empresas. <br><br>  2. Um grande gerenciamento de API B2B, quando a empresa toma uma decis√£o comercial sobre a conex√£o, torna-se uma empresa parceira com uma obriga√ß√£o contratual e, em seguida, se conecta √† API.  E depois de acertar todas as formalidades, a empresa obt√©m acesso aos testes, passa nos testes e entra nas vendas.  Mas isso n√£o √© poss√≠vel sem uma decis√£o de gerenciamento para se conectar. <br><br><img src="https://habrastorage.org/webt/go/qv/oi/goqvoiroiq0yknutwbn9hrt7abe.jpeg"><br><br><h3>  Nossa decis√£o </h3><br>  Nesta parte, falaremos sobre a cria√ß√£o da API do gateway. <br><br>  Os usu√°rios finais do gateway criado para a API s√£o os parceiros de nossos clientes.  Para cada um deles, j√° temos os contratos necess√°rios.  S√≥ precisamos expandir a funcionalidade, observando o acesso concedido ao gateway.  Consequentemente, √© necess√°rio um processo controlado de conex√£o e controle. <br><br>  Obviamente, pode-se usar uma solu√ß√£o pronta para resolver a tarefa de Gerenciamento de API e criar o API Gateway em particular.  Por exemplo, esse poderia ser o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gerenciamento de API do Azure</a> .  N√£o nos convinha, porque no nosso caso j√° t√≠nhamos um portal de API e um enorme ecossistema constru√≠do em torno dele.  Todos os usu√°rios j√° foram registrados, j√° entenderam onde e como podem obter as informa√ß√µes necess√°rias.  As interfaces necess√°rias j√° existiam no portal da API, apenas precis√°vamos do API Gateway.  Na verdade, come√ßamos a desenvolv√™-lo. <br><br>  O que chamamos de API do Gateway √© um tipo de proxy.  Aqui, novamente, tivemos uma escolha - voc√™ pode escrever seu proxy ou escolher algo pronto.  Nesse caso, seguimos o segundo caminho e escolhemos o pacote nginx + Lua.  Porque  Precis√°vamos de um software confi√°vel e testado que suporte o dimensionamento.  Ap√≥s a implementa√ß√£o, n√£o queremos verificar a corre√ß√£o da l√≥gica de neg√≥cios e a corre√ß√£o do proxy. <br><br>  Qualquer servidor da web possui um pipeline de processamento de solicita√ß√µes.  No caso do nginx, fica assim: <br><br><img src="https://habrastorage.org/webt/7p/bu/9y/7pbu9y7z9ier1gtfhmu5pccawlu.png"><br><br>  (diagrama do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub Lua Nginx</a> ) <br><br>  Nosso objetivo era integrar esse pipeline no momento em que podemos modificar a solicita√ß√£o original. <br><br>  Queremos criar um proxy transparente para que a solicita√ß√£o permane√ßa funcional como veio.  Controlamos apenas o acesso √† API final, ajudamos a solicita√ß√£o a acess√°-la.  Caso a solicita√ß√£o esteja incorreta, a API final deve mostrar o erro, mas n√£o n√≥s.  A √∫nica raz√£o pela qual podemos rejeitar a solicita√ß√£o √© devido √† falta de acesso ao cliente. <br><br>  Para nginx, uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">extens√£o</a> j√° existe em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lua</a> .  Lua √© uma linguagem de script, √© muito leve e f√°cil de aprender.  Assim, implementamos a l√≥gica necess√°ria usando Lua. <br><br>  A configura√ß√£o do nginx (analogia √† rota do aplicativo), onde todo o trabalho √© realizado, √© compreens√≠vel.  Digno de nota aqui √© a √∫ltima diretiva - post_action. <br><br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /middleware { <span class="hljs-attribute"><span class="hljs-attribute">more_clear_input_headers</span></span> Accept-Encoding; <span class="hljs-attribute"><span class="hljs-attribute">lua_need_request_body</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">rewrite_by_lua_file</span></span> <span class="hljs-string"><span class="hljs-string">'middleware/rewrite.lua'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">access_by_lua_file</span></span> <span class="hljs-string"><span class="hljs-string">'middleware/access.lua'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> https://someurl.com; <span class="hljs-attribute"><span class="hljs-attribute">body_filter_by_lua_file</span></span> <span class="hljs-string"><span class="hljs-string">'middleware/body_filter.lua'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">post_action</span></span> /process_session; }</code> </pre> <br>  Considere o que acontece nesta configura√ß√£o: <br>  <b>more_clear_input_headers</b> - limpa o valor dos cabe√ßalhos especificados ap√≥s a diretiva. <br>  <b>lua_need_request_body</b> - controla se o corpo da solicita√ß√£o original deve ser lido antes de executar as diretivas reescrever / acesso / acesso_por_lua ou n√£o.  Por padr√£o, o nginx n√£o l√™ o corpo da solicita√ß√£o do cliente e, se voc√™ precisar acess√°-lo, esta diretiva deve estar ativada. <br>  <b>rewrite_by_lua_file</b> - o caminho para os scripts, que descreve a l√≥gica para modificar a solicita√ß√£o <br>  <b>access_by_lua_file</b> - o caminho para o script, que descreve a l√≥gica que verifica o acesso ao recurso. <br>  <b>proxy_pass</b> - URL para o qual a solicita√ß√£o ser√° <b>enviada por</b> proxy. <br>  <b>body_filter_by_lua_file</b> - o caminho para o script, que descreve a l√≥gica para filtrar a solicita√ß√£o antes de retornar ao cliente. <br>  E, finalmente, <b>post_action</b> √© uma diretiva oficialmente n√£o documentada que pode ser usada para executar qualquer outra a√ß√£o ap√≥s a resposta ser dada ao cliente. <br><br>  A seguir, descreveremos em ordem como resolvemos nossos problemas. <br><br><h3>  Autoriza√ß√£o / autentica√ß√£o e modifica√ß√£o de solicita√ß√£o </h3><br>  <b>Entrar</b> <br><br>  Criamos autoriza√ß√£o e autentica√ß√£o usando acessos a certificados.  Existe um certificado raiz.  Cada novo cliente do cliente gera seu certificado pessoal com o qual ele pode acessar a API.  Este certificado est√° configurado na se√ß√£o do servidor de configura√ß√µes do nginx. <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">ssl</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate</span></span> /usr/local/openresty/nginx/ssl/cert.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate_key</span></span> /usr/local/openresty/nginx/ssl/cert.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_client_certificate</span></span> /usr/local/openresty/nginx/ssl/ca.crt; <span class="hljs-attribute"><span class="hljs-attribute">ssl_verify_client</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>;</code> </pre> <br>  <b>Modifica√ß√£o</b> <br><br>  Uma pergunta justa pode surgir: o que fazer com um cliente certificado, se de repente queremos desconect√°-lo do sistema?  N√£o emita novamente certificados para todos os outros clientes. <br><br>  Ent√£o, sem problemas, abordamos a pr√≥xima tarefa - modifica√ß√£o da solicita√ß√£o original.  A solicita√ß√£o original do cliente, de um modo geral, n√£o √© v√°lida para o sistema final.  Uma das tarefas √© adicionar as partes ausentes √† solicita√ß√£o para torn√°-la v√°lida.  O ponto √© que os dados ausentes s√£o diferentes para cada cliente.  Sabemos que o cliente chega at√© n√≥s com um certificado a partir do qual podemos obter uma impress√£o digital e extrair os dados necess√°rios do cliente do banco de dados. <br><br>  Se em algum momento voc√™ precisar desconectar o cliente do nosso servi√ßo, os dados dele desaparecer√£o do banco de dados e ele n√£o poder√° fazer nada. <br><br><h3>  Trabalhar com dados do cliente </h3><br>  Precis√°vamos garantir alta disponibilidade da solu√ß√£o, especialmente como obtemos dados do cliente.  A dificuldade √© que a fonte desses dados √© um servi√ßo de terceiros que n√£o garante velocidade ininterrupta e razoavelmente alta. <br><br>  Portanto, precis√°vamos garantir alta disponibilidade dos dados do cliente.  Como ferramenta, escolhemos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hazelcast</a> , que fornece: <br><br><ul><li>  acesso r√°pido aos dados </li><li>  a capacidade de organizar um cluster de v√°rios n√≥s com dados replicados em n√≥s diferentes. </li></ul><br>  Adotamos a estrat√©gia mais simples de entrega de cache: <br><br><img src="https://habrastorage.org/webt/u6/f6/72/u6f6729km0g71ge4prl5ww1kes8.png"><br><br>  O trabalho com o sistema final ocorre dentro da estrutura das sess√µes e h√° um limite no n√∫mero m√°ximo.  Se o cliente n√£o encerrou a sess√£o, teremos que fazer isso. <br><br>  Os dados da sess√£o aberta s√£o provenientes do sistema de destino e s√£o processados ‚Äã‚Äãinicialmente no lado Lua.  Decidimos usar o Hazelcast para salvar esses dados com um gravador .NET.  Ent√£o, em alguns intervalos, verificamos o direito √† vida de sess√µes abertas e encerramos a falta. <br><br><h3>  Acesso ao Hazelcast de Lua e .NET </h3><br>  N√£o h√° clientes em Lua para trabalhar com o Hazelcast, mas o Hazelcast possui uma API REST, que decidimos usar.  Para o .NET, existe um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cliente</a> atrav√©s do qual planejamos acessar os dados do Hazelcast no lado do .NET.  Mas l√° estava. <br><br><img src="https://habrastorage.org/webt/qr/xn/ip/qrxnipywarywskcoslishyb8xtm.png"><br><br>  Ao salvar dados via REST e recuperar atrav√©s do cliente .NET, diferentes serializadores / desserializadores s√£o usados.  Portanto, √© imposs√≠vel colocar dados no REST, mas passar pelo cliente .NET e vice-versa. <br><br>  Se voc√™ estiver interessado, falaremos mais sobre esse problema em um artigo separado.  Spoiler - no shemka. <br><br><img src="https://habrastorage.org/webt/wh/l8/ra/whl8rayewel52cotktzhfcejmbs.png"><br><br><h3>  Registro e Monitoramento </h3><br>  Nosso padr√£o corporativo para fazer logon no .NET √© Serilog, todos os logs terminam no Elasticsearch e os analisamos no Kibana.  Eu queria fazer algo semelhante neste caso.  O √∫nico <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cliente</a> a trabalhar com o Elastic em Lua encontrado foi quebrado na primeira solicita√ß√£o.  E usamos o Fluentd. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fluentd</a> √© uma solu√ß√£o de c√≥digo aberto para fornecer uma √∫nica camada de registro de aplicativo.  Permite coletar logs de diferentes camadas do aplicativo e depois convert√™-los em uma √∫nica fonte. <br><br>  A API do Gateway funciona no K8S, por isso decidimos adicionar o cont√™iner com fluentd ao mesmo subtipo para gravar logs na porta tcp aberta existente existente fluentd. <br><br>  Tamb√©m examinamos como o fluente se comportaria se ele n√£o tivesse conex√£o com o Elasticsearch.  Por dois dias, as solicita√ß√µes foram enviadas continuamente ao gateway, os logs foram enviados ao fluentd, mas o IP Elastic foi banido do fluentd.  Ap√≥s a reconex√£o, o fluentd superou perfeitamente todos os logs do Elastic. <br><br><h3>  Conclus√£o </h3><br>  A abordagem escolhida para a implementa√ß√£o nos permitiu entregar um produto realmente funcional ao ambiente de combate em apenas 2,5 meses. <br><br>  Se alguma vez voc√™ fizer essas coisas, recomendamos que voc√™ entenda claramente qual problema est√° resolvendo e quais recursos voc√™ j√° possui.  Esteja ciente das complexidades da integra√ß√£o com os sistemas de gerenciamento de API existentes. <br><br>  Entenda por si mesmo o que exatamente voc√™ desenvolver√° - apenas a l√≥gica comercial do processamento de solicita√ß√µes ou, como pode ser o caso no nosso caso, todo o proxy.  Lembre-se de que tudo o que voc√™ faz deve ser cuidadosamente testado posteriormente. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt446438/">https://habr.com/ru/post/pt446438/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt446428/index.html">Como a planta do zang√£o de RH foi constru√≠da</a></li>
<li><a href="../pt446430/index.html">Arrefecimento de uma nanopart√≠cula levitante por meio de um ressonador √≥ptico</a></li>
<li><a href="../pt446432/index.html">Um semin√°rio sobre gerenciamento de documentos t√©cnicos foi realizado na Crimeia</a></li>
<li><a href="../pt446434/index.html">Escala do Zimbra Collaboration Suite</a></li>
<li><a href="../pt446436/index.html">Como gerar hip√≥teses sobre as necessidades de potenciais consumidores do seu futuro produto</a></li>
<li><a href="../pt446440/index.html">O livro Reage R√°pido. Aplica√ß√µes Web em React, JSX, Redux e GraphQL ¬ª</a></li>
<li><a href="../pt446444/index.html">Do Skype ao WebRTC: Como organizamos a comunica√ß√£o por v√≠deo na Web</a></li>
<li><a href="../pt446446/index.html">No√ß√µes b√°sicas do mecanismo JavaScript: formul√°rios gerais e cache embutido. Parte 1</a></li>
<li><a href="../pt446448/index.html">5 regras b√°sicas para a realiza√ß√£o de entrevistas com problemas para identificar as necessidades do consumidor</a></li>
<li><a href="../pt446452/index.html">Miss√£o lunar ‚ÄúBereshit‚Äù - em 4 de abril de 2019, a transi√ß√£o para a √≥rbita lunar est√° conclu√≠da, 7 dias de voo, 6 manobras e 1 pouso</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>