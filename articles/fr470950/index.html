<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçü§ù‚Äçüë©üèº üèΩ üë©‚Äçüíª bear_hug: jeux en art ASCII en Python3.6 + üë©‚Äçüî¨ ü•ù üë≤üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pour mes jeux en art ASCII, j'ai √©crit la biblioth√®que bear_hug avec une file d'attente d'√©v√©nements, une collection de widgets, le support ECS et d'a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>bear_hug: jeux en art ASCII en Python3.6 +</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/470950/"><img src="https://habrastorage.org/webt/b0/zu/vj/b0zuvjk4xdzcznbys9oslxl_veo.png"><br><br>  Pour mes jeux en art ASCII, j'ai √©crit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la biblioth√®que bear_hug</a> avec une file d'attente d'√©v√©nements, une collection de widgets, le support ECS et d'autres petites choses utiles.  Dans cet article, nous verrons comment l'utiliser pour cr√©er un jeu minimal. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Avertissements</b> <div class="spoiler_text"><ul><li>  Je suis le seul d√©veloppeur de la biblioth√®que, donc je peux √™tre partial. </li><li>  bear_hug est essentiellement un wrapper autour de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bearlibterminal</a> , il n'y aura donc pas d'op√©rations de niveau relativement bas avec les glyphes. </li><li>  Il existe une fonctionnalit√© similaire dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">clubsandwich</a> , mais je ne l'ai pas utilis√©e et je ne peux pas la comparer. </li></ul></div></div><br>  Sous le capot de bear_hug se trouve <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bearlibterminal</a> , une biblioth√®que SDL pour cr√©er une fen√™tre pseudo-console.  Autrement dit, en ATS pur, comme certains ncurses, cela ne fonctionnera pas.  Mais alors l'image est la m√™me sous Linux, sous Windows et ne d√©pend pas des param√®tres du terminal utilisateur.  Ceci est important, en particulier pour les jeux, car lorsque vous changez la police ASCII-art, Dieu peut bien se transformer en: <br><br><img src="https://habrastorage.org/webt/ys/rh/6f/ysrh6fhay5u9slnpwvqn53is1ek.png"><br>  <i>Le m√™me dessin dans sa forme originale et apr√®s copier-coller dans diff√©rents programmes</i> <br><br>  Bien s√ªr, la biblioth√®que a √©t√© √©crite pour des projets de relativement grande envergure.  Mais afin de ne pas √™tre distrait par la conception et l'architecture du jeu, dans cet article, nous allons cr√©er quelque chose de simple.  Un projet d'une nuit, dans lequel il y a quelque chose pour montrer les fonctions de base de la biblioth√®que.  A savoir - un clone simplifi√© de ces m√™mes chars avec Dandy (ils sont √©galement Battle City).  Il y aura un char de joueur, des chars ennemis, des murs destructibles, du son et des scores.  Mais le menu principal, les niveaux et les bonus s√©lectionn√©s ne le seront pas.  Non pas parce qu'il serait impossible de les ajouter, mais parce que ce projet n'est rien d'autre qu'un Halloworld. <br><br><img src="https://habrastorage.org/webt/8k/e7/my/8ke7mymnrejpei7isjbxtbwvyjs.png"><br>  <i>Il y aura une partie, mais il n'y aura pas de victoire.</i>  <i>Parce que la vie est douleur.</i> <br><br>  Tout le mat√©riel utilis√© dans l'article est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur le github</a> ;  la biblioth√®que elle-m√™me est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©galement</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur PyPI</a> (sous licence MIT). <br><br>  Tout d'abord, nous avons besoin d'actifs.  Pour dessiner de l'art ASCII, j'utilise <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">REXpaint</a> de Josh Ge (alias Kyzrati), le d√©veloppeur du bagel de science-fiction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cogmind</a> .  L'√©diteur est gratuit, mais pas open source;  la version officielle est uniquement pour Windows, mais tout fonctionne bien sous wine.  L'interface est assez claire et pratique: <br><br><img src="https://habrastorage.org/webt/jf/x-/bi/jfx-bigu3sedblmkuspxh_pd4d4.png"><br><br>  Nous enregistrons au format binaire local .xp et copions de <code>/path/to/rexpaint/images</code> dans le dossier avec le futur jeu.  En principe, le chargement d'images √† partir de fichiers .txt est √©galement pris en charge, mais il est √©videmment impossible d'enregistrer les couleurs des caract√®res individuels dans un fichier texte.  Oui, et l'√©dition d'art ASCII dans un cahier ne me convient pas personnellement.  Afin de ne pas coder en dur les coordonn√©es et la taille de chaque √©l√©ment, ces donn√©es sont stock√©es dans un fichier JSON distinct: <br><br><div class="spoiler">  <b class="spoiler_title">battlecity.json</b> <div class="spoiler_text"><pre> <code class="json hljs">[ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"player_r"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"xsize"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ysize"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"player_l"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-attr"><span class="hljs-attr">"xsize"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ysize"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> }, ... ]</code> </pre> <br></div></div><br>  Sons sous licences gratuites t√©l√©chargeables sur Internet.  Jusqu'√† pr√©sent, seul .wav est pris en charge.  C'est tout avec des actifs, vous pouvez commencer √† coder.  Tout d'abord, vous devez initialiser le terminal et la file d'attente des √©v√©nements. <br><br><div class="spoiler">  <b class="spoiler_title">game.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  terminal = BearTerminal(font_path='cp437_12x12.png', size='91x60', title='AsciiCity', filter=['keyboard', 'mouse']) #   dispatcher = BearEventDispatcher() # ,         loop = BearLoop(terminal, dispatcher)</span></span></code> </pre> <br></div></div><br>  Le terminal est la fen√™tre r√©elle du jeu.  Vous pouvez placer des widgets dessus, et il lance <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des √©v√©nements d'entr√©e</a> si n√©cessaire.  En tant que cl√©s lors de la cr√©ation d'un terminal, vous pouvez utiliser toutes les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">options</a> du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">terminal bearlibterminal</a> ;  dans ce cas, nous d√©finissons la police, la taille de la fen√™tre (en caract√®res), le titre de la fen√™tre et les m√©thodes de saisie qui nous int√©ressent. <br><br>  Quant √† la file d'attente d'√©v√©nements, elle a une interface tr√®s simple: dispatcher.add_event (√©v√©nement) ajoute l'√©v√©nement √† la file d'attente, et dispatcher.register_listener (√©couteur, event_types) vous permet de vous y abonner.  Un signataire (par exemple, un widget ou un composant) doit avoir un rappel on_event, qui prend un √©v√©nement comme argument unique et ne renvoie rien ou renvoie un autre √©v√©nement ou un ensemble d'√©v√©nements.  L'√©v√©nement lui-m√™me se compose de type et de valeur;  le type ici n'est pas dans le sens de str ou int, mais dans le sens de ¬´vari√©t√©¬ª, par exemple, ¬´key_down¬ª ou ¬´tick¬ª.  La file d'attente accepte uniquement les √©v√©nements de types qui lui sont connus (int√©gr√©s ou cr√©√©s par l'utilisateur) et les envoie √† on_event tous ceux qui souscrivent √† ce type.  Il ne v√©rifie en aucune fa√ßon les valeurs, mais il existe des conventions au sein de la biblioth√®que sur ce qui est une valeur valide pour chaque type d'√©v√©nement. <br><br>  Tout d'abord, nous mettons en file d'attente quelques auditeurs.  Il s'agit de la classe de base pour les objets qui peuvent s'abonner √† des √©v√©nements, mais qui ne sont pas des widgets ou des composants.  En principe, il n'est pas n√©cessaire de l'utiliser, tant que le signataire dispose de la m√©thode on_event. <br><br><div class="spoiler">  <b class="spoiler_title">Auditeurs</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#       dispatcher.register_listener(ClosingListener(), ['misc_input', 'tick']) #       dispatcher.register_listener(EntityTracker(), ['ecs_create', 'ecs_destroy']) #   jukebox = SoundListener({'shot': 'shot.wav', 'explosion': 'explosion.wav'}) # https://freesound.org/people/EMSIarma/sounds/108852/ # https://freesound.org/people/FlashTrauma/sounds/398283/ dispatcher.register_listener(jukebox, 'play_sound')</span></span></code> </pre> <br></div></div><br>  Une liste compl√®te des types d'√©v√©nements int√©gr√©s se trouve <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans la documentation</a> .  Il est facile de voir qu'il y a des √©v√©nements pour la cr√©ation et la destruction d'entit√©s, mais pas pour les dommages.  Puisque nous aurons des objets qui ne se s√©parent pas d'un seul coup (les murs et le r√©servoir du joueur), nous allons le cr√©er: <br><br><div class="spoiler">  <b class="spoiler_title">Inscription au type d'√©v√©nement</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#      ,    #   dispatcher.register_event_type('ac_damage') #       logger = LoggingListener(sys.stderr) dispatcher.register_listener(logger, ['ac_damage', 'play_sound'])</span></span></code> </pre> <br></div></div><br>  Nous convenons que, en tant que valeur, cet √©v√©nement aura un tuple √† partir de l'ID de l'entit√© qui a subi le dommage et de la valeur du dommage.  LoggingListener est juste un outil de d√©bogage qui imprime tous les √©v√©nements re√ßus o√π qu'ils disent, dans ce cas dans stderr.  Dans ce cas, je voulais m'assurer que les d√©g√¢ts passent correctement, et que le son est toujours demand√© quand il le devrait. <br><br>  Avec Listeners pour l'instant, vous pouvez ajouter le premier widget.  Nous avons ce terrain de jeu de classe ECSLayout.  Il s'agit d'une telle disposition, qui peut placer des widgets sur des entit√©s et les d√©placer en r√©ponse √† des √©v√©nements ecs_move, tout en tenant compte des collisions.  Comme la plupart des widgets, il a deux arguments requis: une liste imbriqu√©e de caract√®res (√©ventuellement vide - espace ou Aucun) et une liste imbriqu√©e de couleurs pour chaque caract√®re.  Les couleurs nomm√©es sont accept√©es en tant que couleurs, RVB au format `0xAARRGGBB` (ou` 0xARGB`, `0xRGB`,` 0xRRGGBB`) et au format '#fff'.  Les tailles des deux listes doivent correspondre;  sinon, une exception est lev√©e. <br><br><div class="spoiler">  <b class="spoiler_title">Premier widget</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   .  8460,   9160. # 7         chars = [[' ' for x in range(84)] for y in range(60)] colors = copy_shape(chars, 'gray') layout = ECSLayout(chars, colors) # 'all' -  ,      dispatcher.register_listener(layout, 'all')</span></span></code> </pre> <br></div></div><br>  Puisque nous avons maintenant sur quoi placer les objets dans le jeu, nous pouvons commencer √† cr√©er des entit√©s.  Tout le code des entit√©s et des composants est d√©plac√© vers un fichier distinct.  Le plus simple d'entre eux est un mur de briques destructible.  Elle sait se trouver √† un certain endroit, afficher son widget, servir d'objet de collision et subir des d√©g√¢ts.  Apr√®s suffisamment de d√©g√¢ts, le mur dispara√Æt. <br><br><div class="spoiler">  <b class="spoiler_title">entity.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_wall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dispatcher, atlas, entity_id, x, y)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#   wall = Entity(entity_id) #  wall.add_component(PositionComponent(dispatcher, x, y)) wall.add_component(CollisionComponent(dispatcher)) wall.add_component(PassingComponent(dispatcher)) wall.add_component(DestructorComponent(dispatcher)) #     ,      #    -  /   images_dict = {'wall_3': atlas.get_element('wall_3'), 'wall_2': atlas.get_element('wall_2'), 'wall_1': atlas.get_element('wall_1')} wall.add_component(SwitchWidgetComponent(dispatcher, SwitchingWidget(images_dict=images_dict, initial_image='wall_3'))) wall.add_component(VisualDamageHealthComponent(dispatcher, hitpoints=3, widgets_dict={3: 'wall_3', 2: 'wall_2', 1: 'wall_1'})) #     dispatcher.add_event(BearEvent('ecs_create', wall)) dispatcher.add_event(BearEvent('ecs_add', (wall.id, wall.position.x, wall.position.y)))</span></span></code> </pre> <br></div></div><br>  Tout d'abord, l'objet entit√© lui-m√™me est cr√©√©.  Il ne contient qu'un nom (qui doit √™tre unique) et un ensemble de composants.  Ils peuvent √™tre transf√©r√©s en une seule fois lors de la cr√©ation ou, comme ici, ajout√©s un par un.  Ensuite, tous les composants n√©cessaires sont cr√©√©s.  En tant que widget, SwitchWidget est utilis√©, qui contient plusieurs dessins de la m√™me taille et peut les changer par commande.  Soit dit en passant, les dessins sont charg√©s √† partir de l'atlas lors de la cr√©ation d'un widget.  Et, enfin, l'annonce de la cr√©ation de l'entit√© et l'ordre de la dessiner sur les coordonn√©es n√©cessaires vont dans la file d'attente. <br><br>  Parmi les composants non int√©gr√©s ici, uniquement la sant√©.  J'ai cr√©√© la classe de base ¬´Composant de sant√©¬ª et en ai h√©rit√© le ¬´widget de changement de composant de sant√©¬ª (pour montrer le mur intact et √† plusieurs stades de destruction). <br><br><div class="spoiler">  <b class="spoiler_title">class HealthComponent</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HealthComponent</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Component)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, hitpoints=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3</span></span></span></span><span class="hljs-function"><span class="hljs-params">, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super().__init__(*args, name=<span class="hljs-string"><span class="hljs-string">'health'</span></span>, **kwargs) self.dispatcher.register_listener(self, <span class="hljs-string"><span class="hljs-string">'ac_damage'</span></span>) self._hitpoints = hitpoints <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_event</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, event)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> event.event_type == <span class="hljs-string"><span class="hljs-string">'ac_damage'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> event.event_value[<span class="hljs-number"><span class="hljs-number">0</span></span>] == self.owner.id: self.hitpoints -= event.event_value[<span class="hljs-number"><span class="hljs-number">1</span></span>] @property <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hitpoints</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._hitpoints @hitpoints.setter <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hitpoints</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(value, int): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> BearECSException( <span class="hljs-string"><span class="hljs-string">f'Attempting to set hitpoints of </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{self.owner.id}</span></span></span><span class="hljs-string"> to non-integer </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{value}</span></span></span><span class="hljs-string">'</span></span>) self._hitpoints = value <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self._hitpoints &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>: self._hitpoints = <span class="hljs-number"><span class="hljs-number">0</span></span> self.process_hitpoint_update() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_hitpoint_update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Should be overridden by child classes. """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NotImplementedError(<span class="hljs-string"><span class="hljs-string">'HP update processing should be overridden'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__repr__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#           return dumps({'class': self.__class__.__name__, 'hitpoints': self.hitpoints})</span></span></code> </pre> <br></div></div><br>  Lors de la cr√©ation d'un composant, la cl√© 'nom' est pass√©e √† super () .__ init__.  Lorsqu'un composant est ajout√© √† une entit√©, sous le nom de cette cl√©, il sera ajout√© au __dict__ de l'entit√© et il est accessible via entity_object.health.  En plus de la commodit√© de l'interface, cette approche est bonne car elle interdit l'√©mission d'entit√©s de plusieurs composants homog√®nes.  Et le fait qu'il soit cod√© en dur √† l'int√©rieur du composant ne vous permet pas d'ins√©rer par erreur, par exemple, WidgetComponent dans l'emplacement du composant de sant√©.  Imm√©diatement apr√®s sa cr√©ation, le composant souscrit aux classes d'√©v√©nements qui l'int√©ressent, dans ce cas ac_damage.  Apr√®s avoir re√ßu un tel √©v√©nement, la m√©thode on_event v√©rifiera s'il s'agit de son propri√©taire pendant une heure.  Si c'est le cas, il soustraira la valeur souhait√©e des points de vie et tirera le rappel pour changer la sant√©, la classe de base est abstraite.  Il existe √©galement la m√©thode __repr__, qui est utilis√©e pour la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">s√©rialisation en JSON</a> (par exemple, pour l'enregistrement).  Il n'est pas n√©cessaire de l'ajouter, mais tous les composants int√©gr√©s et la plupart des widgets int√©gr√©s l'ont. <br><br>  L'h√©ritage du composant d'int√©grit√© sous-jacent de VisualDamageHealthComponent remplace le rappel sur le changement d'int√©grit√©: <br><br><div class="spoiler">  <b class="spoiler_title">classe VisualDamageHealthComponent</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VisualDamageHealthComponent</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(HealthComponent)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""       .    HP=0 """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, widgets_dict={}, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super().__init__(*args, **kwargs) self.widgets_dict = OrderedDict() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sorted(widgets_dict.keys()): self.widgets_dict[int(x)] = widgets_dict[x] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_hitpoint_update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.hitpoints == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> hasattr(self.owner, <span class="hljs-string"><span class="hljs-string">'destructor'</span></span>): self.owner.destructor.destroy() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.widgets_dict: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.hitpoints &gt;= x: self.owner.widget.switch_to_image(self.widgets_dict[x])</code> </pre> <br></div></div><br>  Alors que la sant√© est sup√©rieure √† 0, il demande au composant responsable du widget de dessiner le mur dans l'√©tat souhait√©.  Ici, l'appel d√©crit ci-dessus est utilis√© via l'attribut de l'objet entit√©.  Une fois les rep√®res termin√©s, le composant responsable de la destruction correcte de l'entit√© et tous les composants seront appel√©s de la m√™me mani√®re. <br><br>  Pour les autres entit√©s, tout est similaire, seul l'ensemble des composants est diff√©rent.  Des chars sont ajout√©s avec des contr√¥leurs (entr√©e pour le joueur, IA pour les adversaires) et des widgets rotatifs, pour les obus - un composant de collision qui endommage ceux qu'ils touchent.  Je n'analyserai pas chacun d'eux, car il est volumineux et plut√¥t trivial;  regardez seulement le collisionneur de projectiles.  Il a une m√©thode collided_into, appel√©e lorsque l'entit√© h√¥te s'est √©cras√©e sur quelque chose: <br><br><div class="spoiler">  <b class="spoiler_title">collisionneur de composants de balle</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">collided_into</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, entity)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> entity: self.owner.destructor.destroy() <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> hasattr(EntityTracker().entities[entity], <span class="hljs-string"><span class="hljs-string">'collision'</span></span>): self.dispatcher.add_event(BearEvent(event_type=<span class="hljs-string"><span class="hljs-string">'ac_damage'</span></span>, event_value=( entity, self.damage))) self.owner.destructor.destroy()</code> </pre> <br></div></div><br>  Pour s'assurer qu'il est vraiment possible d'obtenir une victime (ce qui peut √™tre faux pour, par exemple, des √©l√©ments d'arri√®re-plan), le projectile utilise EntityTracker ().  Il s'agit d'un singleton qui suit toutes les entit√©s cr√©√©es et d√©truites;  √† travers lui, vous pouvez obtenir un objet entit√© par son nom et faire quelque chose avec ses composants.  Dans ce cas, il est v√©rifi√© que entity.collision (le gestionnaire de collision des victimes) existe. <br><br>  Maintenant dans le fichier principal du jeu, nous appelons simplement toutes les fonctions n√©cessaires √† la cr√©ation d'entit√©s: <br><br><div class="spoiler">  <b class="spoiler_title">Retour √† game.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  , -     atlas = Atlas(XpLoader('battlecity.xp'), 'battlecity.json') #   create_player_tank(dispatcher, atlas, 30, 50) #    wall_array = [[0 for _ in range(14)], [0 for _ in range(14)], [1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0], [1, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0], [1, 1, 1, 0, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1], [1, 0, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 1, 0], [1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 0, 1, 0], [0 for _ in range(14)], [0 for _ in range(14)], [0 for _ in range(14)] ] for y in range(10): for x in range(14): if wall_array[y][x] == 1: create_wall(dispatcher, atlas, f'wall{x}{y}', x*6, y*6) #   -  .     . create_spawner_house(dispatcher, atlas, 35, 0)</span></span></code> </pre> <br></div></div><br>  Les marqueurs de points et de points de vie ne sont pas des entit√©s et ne sont pas sur le champ de bataille.  Par cons√©quent, ils ne sont pas ajout√©s √† ECSLayout, mais directement au terminal √† droite de la carte.  Les widgets pertinents h√©ritent de Label (widget de sortie de texte) et disposent d'une m√©thode on_event pour d√©couvrir ce qui les int√©resse.  Contrairement √† Layout, le terminal ne met pas automatiquement √† jour les widgets √† chaque tick, donc apr√®s avoir chang√© le texte, les widgets lui disent de faire ceci: <br><br><div class="spoiler">  <b class="spoiler_title">listeners.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ScoreLabel</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Label)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super().__init__(text=<span class="hljs-string"><span class="hljs-string">'Score:\n0'</span></span>) self.score = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_event</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, event)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> event.event_type == <span class="hljs-string"><span class="hljs-string">'ecs_destroy'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'enemy'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> event.event_value <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'bullet'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> event.event_value: <span class="hljs-comment"><span class="hljs-comment">#    self.score += 10 self.text = f'Score:\n{self.score}' self.terminal.update_widget(self) class HPLabel(Label): """   """ def __init__(self, *args, **kwargs): super().__init__(text='HP:\n5') self.hp = 5 def on_event(self, event): if event.event_type == 'ac_damage' and event.event_value[0] == 'player': self.hp -= event.event_value[1] self.text = f'HP:\n{self.hp}' self.terminal.update_widget(self)</span></span></code> </pre> <br></div></div><br>  Le g√©n√©rateur ennemi et l'objet responsable de la sortie de "GAME OVER" ne sont pas affich√©s du tout, ils h√©ritent donc de Listener.  Le principe est le m√™me: les objets √©coutent la file d'attente, attendent le bon moment, puis cr√©ent une entit√© ou un widget. <br><br><div class="spoiler">  <b class="spoiler_title">gameover</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#    - . . . class GameOverListener(Listener): """       """ def __init__(self, *args, widget=None, **kwargs): print (args) super().__init__(*args, *kwargs) self.widget = widget def on_event(self, event): if event.event_type == 'ecs_destroy' and event.event_value == 'player': self.terminal.add_widget(self.widget, pos=(20, 20), layer=5)</span></span></code> </pre><br></div></div><br>  Maintenant, nous avons cr√©√© tout ce dont nous avons besoin et nous pouvons commencer le jeu. <br><br><div class="spoiler">  <b class="spoiler_title">Nous lan√ßons</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#      ,   Listeners    terminal.start() terminal.add_widget(layout) terminal.add_widget(score, pos=(85, 10)) terminal.add_widget(hp, pos=(85, 15))</span></span></code> </pre> <br></div></div><br>  Les widgets sont ajout√©s √† l'√©cran uniquement apr√®s son d√©marrage.  Les entit√©s pourraient √™tre ajout√©es √† la carte avant - les √©v√©nements de cr√©ation (dans lesquels l'entit√© enti√®re est stock√©e, y compris le widget) sont simplement accumul√©s dans la file d'attente et r√©solus au premier tick.  Mais le terminal ne peut ajouter des widgets qu'une fois qu'une fen√™tre a √©t√© cr√©√©e avec succ√®s pour lui. <br><br>  √Ä ce stade, nous avons un prototype fonctionnel, que vous pouvez <s>publier dans Early Access pour vingt dollars,</s> ajouter des fonctionnalit√©s et peaufiner le gameplay.  Mais cela d√©passe d√©j√† le cadre de halloworld, et donc de l'article.  J'ajouterai seulement que la construction ind√©pendante du syst√®me python peut √™tre construite en utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pyinstaller</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr470950/">https://habr.com/ru/post/fr470950/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr470930/index.html">Gamification du produit. Historique Ratatype</a></li>
<li><a href="../fr470934/index.html">Gu√©rit avant le mariage: prolif√©ration cellulaire et capacit√©s r√©g√©n√©ratrices des m√©duses</a></li>
<li><a href="../fr470938/index.html">Comment ouvrir un lien en Python. Travailler avec WebBrowser et r√©soudre un probl√®me avec Internet Explorer</a></li>
<li><a href="../fr470940/index.html">Meetup MSK VUE.JS # 3 au groupe Mail.ru: mat√©riaux de mitap</a></li>
<li><a href="../fr470942/index.html">Du d√©butant aux ic√¥nes de style: comment nous avons remport√© des prix dans 2GIS</a></li>
<li><a href="../fr470952/index.html">Trucs et astuces de Digital Forensics: Forensics de l'application ¬´Votre t√©l√©phone¬ª</a></li>
<li><a href="../fr470954/index.html">Installez Zimbra OSE 8.8.15 et Zextras Suite Pro sur Ubuntu 18.04 LTS</a></li>
<li><a href="../fr470958/index.html">Les sondes de vitalit√© √† Kubernetes peuvent √™tre dangereuses</a></li>
<li><a href="../fr470962/index.html">JSConf Budapest 2019</a></li>
<li><a href="../fr470964/index.html">Jouets en bois - inscriptions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>