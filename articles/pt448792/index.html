<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📽️ 🤽🏾 🤽🏼 Teste de Python com pytest. Acessórios Internos, Capítulo 4 👌🏽 🕡 🤱🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Voltar Próximo 


 Os acessórios embutidos que acompanham o pytest podem ajudá-lo a fazer algumas coisas bastante úteis em seus testes com facilidade ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Teste de Python com pytest. Acessórios Internos, Capítulo 4</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448792/"><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Voltar</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Próximo</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p><br><p>  <em>Os acessórios embutidos que acompanham o pytest podem ajudá-lo a fazer algumas coisas bastante úteis em seus testes com facilidade e naturalidade.</em>  <em>Por exemplo, além de manipular arquivos temporários, o pytest inclui acessórios internos para acessar parâmetros de linha de comando, comunicação entre sessões de teste, verificação de fluxos de saída, alteração de variáveis ​​de ambiente e alertas de pesquisa.</em> </p><br><p><img src="https://habrastorage.org/webt/hd/--/9w/hd--9w134j0rxhmxftrflbbdopy.png"></p><a name="habracut"></a><br><blockquote> O código-fonte do projeto Tarefas, bem como todos os testes mostrados neste livro, estão disponíveis no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="https://pragprog.com/titles/bopytest/source_code">link</a> na página da Web do livro em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="https://pragprog.com/titles/bopytest">pragprog.com</a> .  Você não precisa fazer o download do código-fonte para entender o código de teste;  o código de teste é apresentado de forma conveniente nos exemplos.  Mas, para acompanhar as tarefas do projeto ou adaptar exemplos de teste para testar seu próprio projeto (suas mãos estão desamarradas!), Você deve acessar a página da web do livro para baixar o trabalho.  Lá, na página do livro, há um link para o post da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="https://pragprog.com/titles/bopytest/errata">errata</a> e o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="https://forums.pragprog.com/forums/438">fórum de discussão</a> . </blockquote><p>  Sob o spoiler, há uma lista de artigos desta série. </p><br><div class="spoiler">  <b class="spoiler_title">Sumário</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>1. Introdução</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Capítulo 1: Introdução ao pytest</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Capítulo 2: Escrevendo funções de teste</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Capítulo 3: Acessórios Pytest</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Capítulo 4: Acessórios embutidos</strong></a> (este artigo) </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Capítulo 5: Plugins</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Capítulo 6: Configuração</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Capítulo 7: Usando pytest com outras ferramentas</strong></a> </li></ul></div></div><br><p>  No capítulo anterior, você examinou o que são acessórios, como escrevê-los e como usá-los para dados de teste, bem como para códigos de configuração e desmontagem. </p><br><p> Você também usou o conftest.py para compartilhar acessórios entre testes em vários arquivos de teste.  No final do capítulo 3, os seguintes acessórios foram instalados nos acessórios pytest na página 49 do projeto Tasks: <code>tasks_db_session</code> , <code>tasks_just_a_few</code> , <code>tasks_mult_per_owner</code> , <code>tasks_db</code> , <code>db_with_3_tasks</code> e <code>db_with_multi_per_owner</code> definidos em conftest.py que podem ser usados ​​por qualquer função de teste precisa deles. </p><br><p>  Reutilizar equipamentos regulares é uma idéia tão boa que os desenvolvedores do pytest incluíram alguns acessórios normalmente necessários no pytest.  Você já viu como tmpdir e tmpdir_factory são usados ​​pelo projeto Tasks na seção de mudança de escopo para acessórios do projeto Tasks na página 59. Você os discutirá com mais detalhes neste capítulo. </p><br><p>  Os acessórios internos que acompanham o pytest podem ajudá-lo a fazer algumas coisas bastante úteis em seus testes com facilidade e naturalidade.  Por exemplo, além de manipular arquivos temporários, o pytest inclui acessórios internos para acessar parâmetros de linha de comando, comunicação entre sessões de teste, verificação de fluxos de saída, alteração de variáveis ​​de ambiente e alertas de pesquisa.  Acessórios embutidos são extensões da funcionalidade principal do pytest.  Vejamos agora alguns dos equipamentos embutidos mais usados ​​em ordem. </p><br><h2 id="ispolzovanie-tmpdir-i-tmpdir_factory">  Usando tmpdir e tmpdir_factory </h2><br><p>  Se você estiver testando algo que lê, grava ou modifica arquivos, é possível usar o tmpdir para criar arquivos ou diretórios usados ​​por um único teste e o <code>tmpdir_factory</code> quando desejar configurar um diretório para vários testes. </p><br><p>  O dispositivo <code>tmpdir</code> tmpdir possui um escopo de função e o dispositivo <code>tmpdir_factory</code> possui um escopo de sessão.  Qualquer teste único que exija um diretório ou arquivo temporário para apenas um teste pode usar <code>tmpdir</code> .  Isso também se aplica aos equipamentos, que personalizam o diretório ou arquivo que deve ser recriado para cada função de teste. </p><br><p>  Aqui está um exemplo simples usando o <code>tmpdir</code> : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>ch4/test_tmpdir.py</code></a> </blockquote> <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_tmpdir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># tmpdir    ,    # join()  ,    , #     a_file = tmpdir.join('something.txt') #    a_sub_dir = tmpdir.mkdir('anything') #      (  ) another_file = a_sub_dir.join('something_else.txt') #    'something.txt' a_file.write('contents may settle during shipping') #    'anything/something_else.txt' another_file.write('something different') #      assert a_file.read() == 'contents may settle during shipping' assert another_file.read() == 'something different'</span></span></code> </pre> <br><p>  O valor retornado de <code>tmpdir</code> é um objeto do tipo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>py.path.local.1</code></a> que parece ser tudo o que precisamos para diretórios e arquivos temporários.  No entanto, há um truque.  Como o <code>tmpdir</code> elétrico <code>tmpdir</code> definido como um <em>escopo de função</em> , o <code>tmpdir</code> não pode ser usado para criar pastas ou arquivos que devem estar disponíveis por mais de uma função de teste.  Para equipamentos com escopo diferente de uma função (classe, módulo, sessão), <code>tmpdir_factory</code> está disponível. </p><br><p>  O dispositivo <code>tmpdir_factory</code> tmpdir_factory <code>tmpdir_factory</code> muito semelhante ao <code>tmpdir</code> , mas possui uma interface diferente.  Conforme descrito na seção “Especificação do acessório de escopo”, na página 56, os acessórios de área de função são executados uma vez para cada função de teste, os acessórios de região do módulo são executados uma vez por módulo, os acessórios de classe uma vez para cada classe e os testes de validação de área trabalhe uma vez por sessão.  Assim, os recursos criados nos registros da área da sessão têm uma vida útil de toda a sessão.  Para mostrar como <code>tmpdir</code> e <code>tmpdir_factory</code> , <code>tmpdir</code> exemplo <code>tmpdir</code> , onde <code>tmpdir_factory</code> : </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4 / test_tmpdir.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_tmpdir_factory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir_factory)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#      . a_dir   # ,    tmpdir a_dir = tmpdir_factory.mktemp('mydir') # base_temp    'mydir'    #  getbasetemp(),  # ,    base_temp = tmpdir_factory.getbasetemp() print('base:', base_temp) #       , #    ' test_tmpdir ()',   , #    a_dir  tmpdir a_file = a_dir.join('something.txt') a_sub_dir = a_dir.mkdir('anything') another_file = a_sub_dir.join('something_else.txt') a_file.write('contents may settle during shipping') another_file.write('something different') assert a_file.read() == 'contents may settle during shipping' assert another_file.read() == 'something different'</span></span></code> </pre> <br><p>  A primeira linha usa <code>mktemp('mydir')</code> para criar o diretório e o armazena em <code>a_dir</code> .  Para o restante da função, você pode usar <code>a_dir</code> da mesma maneira que <code>tmpdir</code> retornado do <code>tmpdir</code> . </p><br><p>  Na segunda linha do exemplo <code>tmpdir_factory</code> , a função <code>getbasetemp()</code> retorna o diretório base usado para esta sessão.  A declaração de <em>impressão</em> no exemplo é necessária para que você possa visualizar o diretório em seu sistema.  Vamos ver onde fica: </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /path/to/code/ch4 $ pytest -q -s test_tmpdir.py::test_tmpdir_factory base: /private/var/folders/53/zv4j_zc506x2xq25l31qxvxm0000gn/T/pytest-of-okken/pytest-732 . 1 passed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.04 seconds</code> </pre> <br><p>  Esse diretório base depende do sistema e do usuário, e <code>pytest - NUM</code> muda para cada sessão com o aumento de <code>NUM</code> .  O diretório base é deixado sozinho após a sessão.  O pytest o limpa e apenas os poucos diretórios base temporários mais recentes permanecem no sistema, o que é bom se você estiver impaciente para verificar os arquivos após a execução do teste. </p><br><p>  Você também pode especificar seu próprio diretório base se precisar com <code>pytest --basetemp=mydir</code> . </p><br><h3 id="ispolzovanie-vremennyh-katalogov-dlya-drugih-oblastey">  Usando diretórios temporários para outras áreas </h3><br><p>  <code>tmpdir_factory</code> diretórios temporários e arquivos de área de <strong>sessão</strong> do <code>tmpdir_factory</code> , e diretórios de <strong>função</strong> e arquivos de região do <code>tmpdir</code> .  Mas e outras áreas?  E se precisarmos de um diretório temporário do escopo de um módulo ou classe?  Para fazer isso, criamos outro dispositivo elétrico da região do tamanho desejado e, para isso, devemos usar <code>tmpdir_factory</code> . </p><br><p>  Por exemplo, suponha que tenhamos um módulo cheio de testes e muitos deles devem poder ler alguns dados de um arquivo <em>json</em> .  Conseguimos colocar o volume do aparelho no próprio módulo ou no arquivo <em>conftest.py</em> , que configura o arquivo de dados da seguinte maneira: </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4 / autores / conftest.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""Demonstrate tmpdir_factory."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest @pytest.fixture(scope=<span class="hljs-string"><span class="hljs-string">'module'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">author_file_json</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir_factory)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""     ."""</span></span> python_author_data = { <span class="hljs-string"><span class="hljs-string">'Ned'</span></span>: {<span class="hljs-string"><span class="hljs-string">'City'</span></span>: <span class="hljs-string"><span class="hljs-string">'Boston'</span></span>}, <span class="hljs-string"><span class="hljs-string">'Brian'</span></span>: {<span class="hljs-string"><span class="hljs-string">'City'</span></span>: <span class="hljs-string"><span class="hljs-string">'Portland'</span></span>}, <span class="hljs-string"><span class="hljs-string">'Luciano'</span></span>: {<span class="hljs-string"><span class="hljs-string">'City'</span></span>: <span class="hljs-string"><span class="hljs-string">'Sau Paulo'</span></span>} } file = tmpdir_factory.mktemp(<span class="hljs-string"><span class="hljs-string">'data'</span></span>).join(<span class="hljs-string"><span class="hljs-string">'author_file.json'</span></span>) print(<span class="hljs-string"><span class="hljs-string">'file:{}'</span></span>.format(str(file))) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> file.open(<span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: json.dump(python_author_data, f) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> file</code> </pre> <br><p>  O <code>author_file_json()</code> cria um diretório temporário chamado <em>data</em> e cria um arquivo chamado <em>author_file.json</em> no diretório de dados.  Em seguida, ele escreve o dicionário <code>python_author_data</code> como <em>json</em> .  Como este é um módulo de área de fixação, um arquivo json será criado apenas uma vez para cada módulo usando o teste: </p><br><blockquote>  <strong>ch4 / autores / test_authors.py</strong> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" ,    ."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_brian_in_portland</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(author_file_json)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""",   ."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> author_file_json.open() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: authors = json.load(f) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> authors[<span class="hljs-string"><span class="hljs-string">'Brian'</span></span>][<span class="hljs-string"><span class="hljs-string">'City'</span></span>] == <span class="hljs-string"><span class="hljs-string">'Portland'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_all_have_cities</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(author_file_json)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""        ."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> author_file_json.open() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: authors = json.load(f) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> authors: <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> len(authors[a][<span class="hljs-string"><span class="hljs-string">'City'</span></span>]) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Ambos os testes usarão o mesmo arquivo JSON.  Se um arquivo de dados de teste funcionar para vários testes, não faz sentido recriá-lo para os dois testes. </p><br><h2 id="ispolzovanie-pytestconfig">  Usando pytestconfig </h2><br><p>  Usando o acessório pytestconfig interno, você pode controlar como o pytest funciona com argumentos e opções de linha de comando, arquivos de configuração, plugins e o diretório a partir do qual você iniciou o pytest.  O acessório pytestconfig é um atalho para request.config e às vezes é referido na documentação do pytest como " <em>o objeto de configuração do pytest</em> " (objeto de configuração do pytest). </p><br><p>  Para descobrir como o <em>pytestconfig</em> funciona, você pode ver como adicionar um parâmetro de linha de comando personalizado e ler o valor do parâmetro no teste.  Você pode ler o valor dos parâmetros da linha de comando diretamente do pytestconfig, mas para adicionar um parâmetro e analisá-lo, é necessário adicionar uma função de gancho.  As funções de <em>gancho</em> , descritas em mais detalhes no Capítulo 5, “Plugins”, na página 95, são outra maneira de controlar o comportamento do pytest e são frequentemente usadas em plugins.  No entanto, a adição de uma opção de linha de comando personalizada e a leitura do <em>pytestconfig é</em> bastante difundida, por isso quero abordar isso aqui. </p><br><p>  Usaremos o <em>gancho</em> <code>pytest_addoption</code> para adicionar vários parâmetros aos parâmetros já disponíveis na linha de comando pytest: </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4 / pytestconfig / conftest.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pytest_addoption</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(parser)</span></span></span><span class="hljs-function">:</span></span> parser.addoption(<span class="hljs-string"><span class="hljs-string">"--myopt"</span></span>, action=<span class="hljs-string"><span class="hljs-string">"store_true"</span></span>, help=<span class="hljs-string"><span class="hljs-string">"some boolean option"</span></span>) parser.addoption(<span class="hljs-string"><span class="hljs-string">"--foo"</span></span>, action=<span class="hljs-string"><span class="hljs-string">"store"</span></span>, default=<span class="hljs-string"><span class="hljs-string">"bar"</span></span>, help=<span class="hljs-string"><span class="hljs-string">"foo: bar or baz"</span></span>)</code> </pre> <br><p>  A adição de parâmetros da linha de comando via <code>pytest_addoption</code> deve ser feita por meio de plugins ou no arquivo <strong>conftest.py,</strong> localizado na parte superior da estrutura de diretórios do projeto.  Você não deve fazer isso no subdiretório de teste. </p><br><p>  As <code>--myopt</code> e <code>--foo &lt;value&gt;</code> foram adicionadas ao código anterior e a linha de ajuda foi alterada conforme mostrado abaixo: </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /path/to/code/ch4/pytestconfig $ pytest --<span class="hljs-built_in"><span class="hljs-built_in">help</span></span> usage: pytest [options] [file_or_dir] [file_or_dir] [...] ... custom options: --myopt some boolean option --foo=FOO foo: bar or baz ...</code> </pre> <br><p>  Agora podemos acessar essas opções do teste: </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4 / pytestconfig / test_config.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_option</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pytestconfig)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'"foo" set to:'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'foo'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'"myopt" set to:'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'myopt'</span></span>))</code> </pre> <br><p>  Vamos ver como funciona: </p><br><pre> <code class="bash hljs">$ pytest -s -q test_config.py::test_option <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: bar <span class="hljs-string"><span class="hljs-string">"myopt"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: False .1 passed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.01 seconds $ pytest -s -q --myopt test_config.py::test_option <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: bar <span class="hljs-string"><span class="hljs-string">"myopt"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: True .1 passed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.01 seconds $ pytest -s -q --myopt --foo baz test_config.py::test_option <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: baz <span class="hljs-string"><span class="hljs-string">"myopt"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: True .1 passed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.01 seconds</code> </pre> <br><p>  Como o pytestconfig é um equipamento, ele também pode ser obtido em outros equipamentos.  Você pode criar acessórios para os nomes das opções, se desejar, por exemplo: </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4 / pytestconfig / test_config.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.fixture() def foo(pytestconfig): return pytestconfig.option.foo @pytest.fixture() def myopt(pytestconfig): return pytestconfig.option.myopt def test_fixtures_for_options(foo, myopt): print('"foo" set to:', foo) print('"myopt" set to:', myopt)</span></span></code> </pre> <br><p>  Você também pode acessar os parâmetros internos, não apenas os adicionados, além de informações sobre como o pytest foi iniciado (diretório, argumentos etc.). </p><br><p>  Aqui está um exemplo de vários valores e opções de configuração: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_pytestconfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pytestconfig)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'args :'</span></span>, pytestconfig.args) print(<span class="hljs-string"><span class="hljs-string">'inifile :'</span></span>, pytestconfig.inifile) print(<span class="hljs-string"><span class="hljs-string">'invocation_dir :'</span></span>, pytestconfig.invocation_dir) print(<span class="hljs-string"><span class="hljs-string">'rootdir :'</span></span>, pytestconfig.rootdir) print(<span class="hljs-string"><span class="hljs-string">'-k EXPRESSION :'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'keyword'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'-v, --verbose :'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'verbose'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'-q, --quiet :'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'quiet'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'-l, --showlocals:'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'showlocals'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'--tb=style :'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'tbstyle'</span></span>))</code> </pre> <br><p>  Voltaremos ao pytestconfig quando eu demonstrar os arquivos ini no capítulo 6, “Configuração” na página 113. </p><br><h2 id="using-cache">  Usando cache </h2><br><p>  Geralmente, nós testadores pensamos que cada teste é o mais independente possível dos outros testes.  Você deve se certificar de que as dependências da contabilidade de pedidos não entraram.  Gostaria de poder executar ou reiniciar qualquer teste em qualquer ordem e obter o mesmo resultado.  Além disso, as sessões de teste devem ser repetíveis e não alterar o comportamento com base nas sessões de teste anteriores. </p><br><p>  No entanto, às vezes transferir informações de uma sessão de teste para outra pode ser muito útil.  Quando queremos passar informações para futuras sessões de teste, podemos fazer isso com o dispositivo de <code>cache</code> interno. </p><br><p>  O <code>cache</code> dispositivo <code>cache</code> projetado para armazenar informações sobre uma sessão de teste e obtê-la na próxima.  Um ótimo exemplo de uso de permissões de <code>cache</code> para o benefício do caso é a funcionalidade incorporada - <code>--last-failed</code> e <code>--failed-first</code> <code>--last-failed</code> .  Vamos ver como os dados para esses sinalizadores são armazenados no cache. </p><br><p>  Aqui está o texto de ajuda para as opções <code>--failed-first</code> <code>--last-failed</code> e <code>--failed-first</code> <code>--last-failed</code> , bem como algumas opções de <code>cache</code> : </p><br><pre> <code class="plaintext hljs">$ pytest --help ... --lf, --last-failed rerun only the tests that failed at the last run (or all if none failed) --ff, --failed-first run all tests but run the last failures first. This may re-order tests and thus lead to repeated fixture setup/teardown --cache-show show cache contents, don t perform collection or tests --cache-clear remove all cache contents at start of test run. ...</code> </pre> <br><p>  Para vê-los em ação, usaremos estes dois testes: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://">ch4 / cache / test_pass_fail.py</a> </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_this_passes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_this_fails</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> == <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br><p>  Vamos executá-los usando <code>--verbose</code> para ver os nomes das funções e <code>--tb=no</code> para ocultar o rastreamento da pilha: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/cache $ pytest --verbose --tb=no test_pass_fail.py ==================== test session starts ==================== collected 2 items test_pass_fail.py::test_this_passes PASSED test_pass_fail.py::test_this_fails FAILED ============ 1 failed, 1 passed in 0.05 seconds =============</code> </pre> <br><p>  Se você executá-los novamente com o <code>--ff</code> ou <code>--failed-first</code> , os testes que falharam anteriormente serão executados primeiro e depois a sessão inteira: </p><br><pre> <code class="plaintext hljs">$ pytest --verbose --tb=no --ff test_pass_fail.py ==================== test session starts ==================== run-last-failure: rerun last 1 failures first collected 2 items test_pass_fail.py::test_this_fails FAILED test_pass_fail.py::test_this_passes PASSED ============ 1 failed, 1 passed in 0.04 seconds =============</code> </pre> <br><p>  Ou você pode usar <code>--lf</code> ou <code>--lf</code> <code>--last-failed</code> para apenas executar testes que falharam na última vez: </p><br><pre> <code class="plaintext hljs">$ pytest --verbose --tb=no --lf test_pass_fail.py ==================== test session starts ==================== run-last-failure: rerun last 1 failures collected 2 items test_pass_fail.py::test_this_fails FAILED ==================== 1 tests deselected ===================== ========== 1 failed, 1 deselected in 0.05 seconds ===========</code> </pre> <br><p>  Antes de <code>--lf</code> como os dados de travamento são armazenados e como você pode usar o mesmo mecanismo, vejamos outro exemplo que torna o valor de <code>--lf</code> e <code>--ff</code> ainda mais óbvio. </p><br><p>  Aqui está um teste parametrizado com uma falha: </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4 / cache / test_few_failures.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""Demonstrate -lf and -ff with failing tests."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> approx testdata = [ <span class="hljs-comment"><span class="hljs-comment"># x, y, expected (1.01, 2.01, 3.02), (1e25, 1e23, 1.1e25), (1.23, 3.21, 4.44), (0.1, 0.2, 0.3), (1e25, 1e24, 1.1e25) ] @pytest.mark.parametrize("x,y,expected", testdata) def test_a(x, y, expected): """Demo approx().""" sum_ = x + y assert sum_ == approx(expected)</span></span></code> </pre> <br><p>  E na saída: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/cache $ pytest -q test_few_failures.py .F... ====================== FAILURES ====================== _________________________ test_a[1e+25-1e+23-1.1e+25] _________________________ x = 1e+25, y = 1e+23, expected = 1.1e+25 @pytest.mark.parametrize("x,y,expected", testdata) def test_a(x, y, expected): """Demo approx().""" sum_ = x + y &gt; assert sum_ == approx(expected) E assert 1.01e+25 == 1.1e+25 ± 1.1e+19 E + where 1.1e+25 ± 1.1e+19 = approx(1.1e+25) test_few_failures.py:17: AssertionError 1 failed, 4 passed in 0.06 seconds</code> </pre> <br><p>  Talvez você possa identificar o problema imediatamente.  Mas vamos imaginar que o teste seja mais longo e complicado, e não é tão óbvio o que está errado aqui.  Vamos executar o teste novamente para ver o erro novamente.  O caso de teste pode ser especificado na linha de comandos: </p><br><pre> <code class="plaintext hljs">$ pytest -q "test_few_failures.py::test_a[1e+25-1e+23-1.1e+25]"</code> </pre> <br><p>  Se você não deseja copiar e colar <em>(copiar / colar</em> ) ou existem vários casos infelizes que você gostaria de reiniciar, então <code>--lf</code> muito mais fácil.  E se você está realmente depurando uma falha de teste, outro sinalizador que pode facilitar a situação é <code>--showlocals</code> ou <code>-l</code> para abreviar: </p><br><pre> <code class="plaintext hljs">$ pytest -q --lf -l test_few_failures.py F ====================== FAILURES ====================== _________________________ test_a[1e+25-1e+23-1.1e+25] _________________________ x = 1e+25, y = 1e+23, expected = 1.1e+25 @pytest.mark.parametrize("x,y,expected", testdata) def test_a(x, y, expected): """Demo approx().""" sum_ = x + y &gt; assert sum_ == approx(expected) E assert 1.01e+25 == 1.1e+25 ± 1.1e+19 E + where 1.1e+25 ± 1.1e+19 = approx(1.1e+25) expected = 1.1e+25 sum_ = 1.01e+25 x = 1e+25 y = 1e+23 test_few_failures.py:17: AssertionError ================= 4 tests deselected ================= 1 failed, 4 deselected in 0.05 seconds</code> </pre><br><p>  O motivo da falha deve ser mais óbvio. </p><br><p>  Para ter em mente que o teste falhou da última vez, há um pequeno truque.  O pytest armazena informações de erro de teste da última sessão de teste e você pode visualizar as informações salvas com <code>--cache-show</code> : </p><br><pre> <code class="plaintext hljs">$ pytest --cache-show ===================== test session starts ====================== ------------------------- cache values ------------------------- cache/lastfailed contains: {'test_few_failures.py::test_a[1e+25-1e+23-1.1e+25]': True} ================= no tests ran in 0.00 seconds =================</code> </pre> <br><p>  Ou você pode procurar no diretório de cache: </p><br><pre> <code class="plaintext hljs">$ cat .cache/v/cache/lastfailed { "test_few_failures.py::test_a[1e+25-1e+23-1.1e+25]": true }</code> </pre> <br><p>  A opção <code>--clear-cache</code> permite limpar o cache antes de uma sessão. </p><br><p>  O cache pode ser usado não apenas para <code>--lf</code> e <code>--ff</code> .  Vamos escrever um suporte que registre quanto tempo os testes demoram, economiza tempo e na próxima vez que relatar um erro em testes que demoram o dobro do tempo, digamos, da última vez. </p><br><p>  A interface para o dispositivo de cache é simples. </p><br><pre> <code class="plaintext hljs">cache.get(key, default) cache.set(key, value)</code> </pre> <br><p>  Por convenção, os nomes das chaves começam com o nome do seu aplicativo ou plugin, seguido por <code>/</code> , e continuam a separar as seções dos nomes das chaves com <code>/</code> .  O valor que você armazena pode ser qualquer um que seja convertido em <em>json</em> , conforme representado no <code>.cache directory</code> . </p><br><p>  Aqui está nosso acessório usado para corrigir o tempo de teste: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4 / cache / test_slower.py</a> </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.fixture(autouse=True) def check_duration(request, cache): key = 'duration/' + request.node.nodeid.replace(':', '_') #   (nodeid)    #      .cache #    -     start_time = datetime.datetime.now() yield stop_time = datetime.datetime.now() this_duration = (stop_time - start_time).total_seconds() last_duration = cache.get(key, None) cache.set(key, this_duration) if last_duration is not None: errorstring = "       2-  " assert this_duration &lt;= last_duration * 2, errorstring</span></span></code> </pre> <br><p>  Como o equipamento é <em>autouse</em> , ele não precisa ser referenciado no teste.  O objeto de <em>solicitação</em> é usado para obter o <em>nodeid</em> para usar na chave.  <em>nodeid</em> é um identificador exclusivo que funciona mesmo com testes parametrizados.  Adicionamos uma chave com 'duration /' para ser residentes respeitáveis ​​do cache.  O código acima do <em>rendimento</em> é executado antes da função de teste;  o código após o <em>rendimento</em> é executado após a função de teste. </p><br><p>  Agora, precisamos de alguns testes com intervalos de tempo diferentes: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4 / cache / test_slower.py</a> </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.mark.parametrize('i', range(5)) def test_slow_stuff(i): time.sleep(random.random())</span></span></code> </pre> <br><p>  Como você provavelmente não deseja escrever vários testes para isso, usei <code>random</code> e parametrização para gerar facilmente alguns testes que dormem por um período aleatório de tempo, todos menores que um segundo.  Vamos ver algumas vezes como isso funciona: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/cache $ pytest -q --cache-clear test_slower.py ..... 5 passed in 2.10 seconds $ pytest -q --tb=line test_slower.py ...E..E =================================== ERRORS ==================================== ___________________ ERROR at teardown of test_slow_stuff[1] ___________________ E AssertionError: test duration over 2x last duration assert 0.35702 &lt;= (0.148009 * 2) ___________________ ERROR at teardown of test_slow_stuff[4] ___________________ E AssertionError: test duration over 2x last duration assert 0.888051 &lt;= (0.324019 * 2) 5 passed, 2 error in 3.17 seconds</code> </pre> <br><p>  Bem, isso foi divertido.  Vamos ver o que está no cache: </p><br><pre> <code class="plaintext hljs">$ pytest -q --cache-show -------------------------------- cache values --------------------------------- cache\lastfailed contains: {'test_slower.py::test_slow_stuff[2]': True, 'test_slower.py::test_slow_stuff[4]': True} cache\nodeids contains: ['test_slower.py::test_slow_stuff[0]', 'test_slower.py::test_slow_stuff[1]', 'test_slower.py::test_slow_stuff[2]', 'test_slower.py::test_slow_stuff[3]', 'test_slower.py::test_slow_stuff[4]'] cache\stepwise contains: [] duration\test_slower.py__test_slow_stuff[0] contains: 0.958055 duration\test_slower.py__test_slow_stuff[1] contains: 0.214012 duration\test_slower.py__test_slow_stuff[2] contains: 0.19001 duration\test_slower.py__test_slow_stuff[3] contains: 0.725041 duration\test_slower.py__test_slow_stuff[4] contains: 0.836048 no tests ran in 0.03 seconds</code> </pre> <br><p>  Você pode ver facilmente os dados de <code>duration</code> separadamente dos dados em cache devido ao prefixo dos nomes dos dados em cache.  No entanto, é interessante que a funcionalidade <code>lastfailed</code> possa funcionar com uma única entrada de cache.  Nossos dados de duração ocupam uma entrada de cache para cada teste.  Vamos seguir o último exemplo falhado e colocar nossos dados em um registro. </p><br><p>  Lemos e armazenamos em cache para cada teste.  Podemos dividir o acessório no acessório do escopo da função para medir a duração e o acessório do escopo da sessão para leitura e gravação no cache.  No entanto, se fizermos isso, não poderemos usar o dispositivo de cache porque ele tem o escopo da função.  Felizmente, uma rápida olhada na implementação no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> mostra que o dispositivo de cache apenas retorna <code>request.config.cache</code> .  Está disponível em qualquer área. </p><br><p>          : </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/cache/test_slower_2.py</a> </p><br><pre> <code class="python hljs">Duration = namedtuple(<span class="hljs-string"><span class="hljs-string">'Duration'</span></span>, [<span class="hljs-string"><span class="hljs-string">'current'</span></span>, <span class="hljs-string"><span class="hljs-string">'last'</span></span>]) @pytest.fixture(scope=<span class="hljs-string"><span class="hljs-string">'session'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">duration_cache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> key = <span class="hljs-string"><span class="hljs-string">'duration/testdurations'</span></span> d = Duration({}, request.config.cache.get(key, {})) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> d request.config.cache.set(key, d.current) @pytest.fixture(autouse=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_duration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, duration_cache)</span></span></span><span class="hljs-function">:</span></span> d = duration_cache nodeid = request.node.nodeid start_time = datetime.datetime.now() <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> duration = (datetime.datetime.now() - start_time).total_seconds() d.current[nodeid] = duration <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> d.last.get(nodeid, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: errorstring = <span class="hljs-string"><span class="hljs-string">"test duration over 2x last duration"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> duration &lt;= (d.last[nodeid] * <span class="hljs-number"><span class="hljs-number">2</span></span>), errorstring</code> </pre> <br><p>  <code>duration_cache</code>   .       ,     ,    - .        ,     <code>namedtuple</code>  <em>Duration</em>    <code>current</code>  <code>last</code> .     <code>namedtuple</code>  <code>test_duration</code> ,         .    ,   <code>namedtuple</code>    ,         <code>d.current</code> .          . </p><br><p>     ,     : </p><br><pre> <code class="plaintext hljs">$ pytest -q --cache-clear test_slower_2.py ..... 5 passed in 2.80 seconds $ pytest -q --tb=no test_slower_2.py ...EE.. 7 passed, 2 error in 3.21 seconds $ pytest -q --cache-show -------------------------------- cache values --------------------------------- cache\lastfailed contains: {'test_slower_2.py::test_slow_stuff[2]': True, 'test_slower_2.py::test_slow_stuff[3]': True} duration\testdurations contains: {'test_slower_2.py::test_slow_stuff[0]': 0.483028, 'test_slower_2.py::test_slow_stuff[1]': 0.198011, 'test_slower_2.py::test_slow_stuff[2]': 0.426024, 'test_slower_2.py::test_slow_stuff[3]': 0.762044, 'test_slower_2.py::test_slow_stuff[4]': 0.056003, 'test_slower_2.py::test_slow_stuff[5]': 0.18401, 'test_slower_2.py::test_slow_stuff[6]': 0.943054} no tests ran in 0.02 seconds</code> </pre> <br><p>  . </p><br><h2 id="ispolzovanie-capsys">  capsys </h2><br><p>  <code>capsys builtin</code>    :   stdout  stderr   ,     .     stdout  stderr. </p><br><p> ,         stdout: </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/cap/test_capsys.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">greeting</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'Hi, {}'</span></span>.format(name))</code> </pre> <br><p>     ,   .   -  stdout.       capsys: </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/cap/test_capsys.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_greeting</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(capsys)</span></span></span><span class="hljs-function">:</span></span> greeting(<span class="hljs-string"><span class="hljs-string">'Earthling'</span></span>) out, err = capsys.readouterr() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> out == <span class="hljs-string"><span class="hljs-string">'Hi, Earthling\n'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> err == <span class="hljs-string"><span class="hljs-string">''</span></span> greeting(<span class="hljs-string"><span class="hljs-string">'Brian'</span></span>) greeting(<span class="hljs-string"><span class="hljs-string">'Nerd'</span></span>) out, err = capsys.readouterr() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> out == <span class="hljs-string"><span class="hljs-string">'Hi, Brian\nHi, Nerd\n'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> err == <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre> <br><p>  <code>stdout</code>  <code>stderr</code>   <code>capsys.redouterr()</code> .   —  ,      ,     . </p><br><p>      <code>stdout</code> .    ,   <code>stderr</code> : </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yikes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(problem)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'YIKES! {}'</span></span>.format(problem), file=sys.stderr) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_yikes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(capsys)</span></span></span><span class="hljs-function">:</span></span> yikes(<span class="hljs-string"><span class="hljs-string">'Out of coffee!'</span></span>) out, err = capsys.readouterr() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> out == <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> <span class="hljs-string"><span class="hljs-string">'Out of coffee!'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> err</code> </pre> <br><p> <em>pytest</em>        .     <em>print</em> .            .  <code>-s</code>   ,      stdout    .    ,        ,      .   ,             pytest  ,    ,   .      <em>capsys</em> .    <code>capsys.disabled()</code> ,       . </p><br><p>  Aqui está um exemplo: </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/cap/test_capsys.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_capsys_disabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(capsys)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> capsys.disabled(): print(<span class="hljs-string"><span class="hljs-string">'\nalways print this'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#    print('normal print, usually captured') #  ,  </span></span></code> </pre> <br><p> , <em>'always print this'</em>   : </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/cap $ pytest -q test_capsys.py::test_capsys_disabled</code> </pre> <br><p>    ,  <code>always print this</code>        ,        <code>capys.disabled()</code> .   print —     print,  <code>normal print, usually captured</code> ( ,  ),    ,     <code>-s</code> ,     <code>--capture=no</code> ,   . </p><br><h2 id="ispolzovanie-monkeypatch">  monkeypatch </h2><br><p> "monkey patch" —         .    "monkey patching" —                ,      ,     .   <code>monkeypatch</code>       .    ,   ,    ,  ,    .    ,       .   API  ,  monkeypatch    . </p><br><p>  <code>monkeypatch</code>   : </p><br><ul><li> <code>setattr(target, name, value=&lt;notset&gt;, raising=True)</code> :  . </li><li> <code>delattr(target, name=&lt;notset&gt;, raising=True)</code> :  . </li><li> <code>setitem(dic, name, value)</code> :    . </li><li> <code>delitem(dic, name, raising=True)</code> :    . </li><li> <code>setenv(name, value, prepend=None)</code> :    . </li><li> <code>delenv(name, raising=True)</code> :   . </li><li> <code>syspath_prepend(path)</code> :    sys.,       Python. </li><li> <code>chdir(path)</code> :    . </li></ul><br><p>  <code>raising</code>  pytest,    ,     .  <code>prepend</code>  <code>setenv()</code>   .   ,        <code>+ prepend + &lt;old value&gt;</code> . </p><br><p>   monkeypatch  ,    ,   dot- .           ,   dot-    .    ,     cheese-  : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/monkey/cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_cheese_preferences</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> full_path = os.path.expanduser(<span class="hljs-string"><span class="hljs-string">'~/.cheese.json'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(full_path, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: prefs = json.load(f) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prefs <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_cheese_preferences</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(prefs)</span></span></span><span class="hljs-function">:</span></span> full_path = os.path.expanduser(<span class="hljs-string"><span class="hljs-string">'~/.cheese.json'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(full_path, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: json.dump(prefs, f, indent=<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_default_cheese_preferences</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> write_cheese_preferences(_default_prefs) _default_prefs = { <span class="hljs-string"><span class="hljs-string">'slicing'</span></span>: [<span class="hljs-string"><span class="hljs-string">'manchego'</span></span>, <span class="hljs-string"><span class="hljs-string">'sharp cheddar'</span></span>], <span class="hljs-string"><span class="hljs-string">'spreadable'</span></span>: [<span class="hljs-string"><span class="hljs-string">'Saint Andre'</span></span>, <span class="hljs-string"><span class="hljs-string">'camembert'</span></span>, <span class="hljs-string"><span class="hljs-string">'bucheron'</span></span>, <span class="hljs-string"><span class="hljs-string">'goat'</span></span>, <span class="hljs-string"><span class="hljs-string">'humbolt fog'</span></span>, <span class="hljs-string"><span class="hljs-string">'cambozola'</span></span>], <span class="hljs-string"><span class="hljs-string">'salads'</span></span>: [<span class="hljs-string"><span class="hljs-string">'crumbled feta'</span></span>] }</code> </pre> <br><p>  ,      <code>write_default_cheese_preferences()</code> .  ,         .    ,    .        . </p><br><p>      ,          . ,       <code>read_cheese_preferences()</code> ,    ,        <code>write_default_cheese_preferences()</code> : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/monkey/test_cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_def_prefs_full</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> cheese.write_default_cheese_preferences() expected = cheese._default_prefs actual = cheese.read_cheese_preferences() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> expected == actual</code> </pre> <br><p>        ,  ,     ,    cheese- .     . </p><br><p>     <code>HOME set</code> , <code>os.path.expanduser()</code>  <code>~</code> ,       <code>HOME</code> .       <code>HOME</code> ,       : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/monkey/test_cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_def_prefs_change_home</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir, monkeypatch)</span></span></span><span class="hljs-function">:</span></span> monkeypatch.setenv(<span class="hljs-string"><span class="hljs-string">'HOME'</span></span>, tmpdir.mkdir(<span class="hljs-string"><span class="hljs-string">'home'</span></span>)) cheese.write_default_cheese_preferences() expected = cheese._default_prefs actual = cheese.read_cheese_preferences() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> expected == actual</code> </pre> <br><p>    ,  <code>HOME</code>      .     -  <code>expanduser()</code> ,     ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">«On Windows, HOME and USERPROFILE will be used if set, otherwise a combination of….»</a>  . !      ,    Windows.  ,     . </p><br><p>  ,     <code>HOME</code> ,   <code>expanduser</code> : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/monkey/test_cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_def_prefs_change_expanduser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir, monkeypatch)</span></span></span><span class="hljs-function">:</span></span> fake_home_dir = tmpdir.mkdir(<span class="hljs-string"><span class="hljs-string">'home'</span></span>) monkeypatch.setattr(cheese.os.path, <span class="hljs-string"><span class="hljs-string">'expanduser'</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: x.replace(<span class="hljs-string"><span class="hljs-string">'~'</span></span>, str(fake_home_dir)))) cheese.write_default_cheese_preferences() expected = cheese._default_prefs actual = cheese.read_cheese_preferences() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> expected == actual</code> </pre> <br><p>    ,    <em>cheese</em>  <code>os.path.expanduser()</code>     -.         <code>re.sub</code>   <code>~</code>    .    <code>setenv()</code>  <code>setattr()</code>      . , <code>setitem()</code> . </p><br><p> ,   ,  ,    .    ,      ,   <code>write_default_cheese_preferences()</code> : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/monkey/test_cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_def_prefs_change_defaults</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir, monkeypatch)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#      fake_home_dir = tmpdir.mkdir('home') monkeypatch.setattr(cheese.os.path, 'expanduser', (lambda x: x.replace('~', str(fake_home_dir)))) cheese.write_default_cheese_preferences() defaults_before = copy.deepcopy(cheese._default_prefs) #     monkeypatch.setitem(cheese._default_prefs, 'slicing', ['provolone']) monkeypatch.setitem(cheese._default_prefs, 'spreadable', ['brie']) monkeypatch.setitem(cheese._default_prefs, 'salads', ['pepper jack']) defaults_modified = cheese._default_prefs #       cheese.write_default_cheese_preferences() #    actual = cheese.read_cheese_preferences() assert defaults_modified == actual assert defaults_modified != defaults_before</span></span></code> </pre> <br><p>  <code>_default_prefs</code> - ,    <code>monkeypatch.setitem()</code> ,        . </p><br><p>   <code>setenv()</code> , <code>setattr()</code>  <code>setitem()</code> .  <code>del</code>  .     ,      ,  - .    <code>monkeypatch</code>   . </p><br><p> <code>syspath_prepend(path)</code>    <code>sys.path</code> ,    ,            .          stub-.      <code>monkeypatch.syspath_prepend()</code> ,     ,      stub-. </p><br><p> <code>chdir(path)</code>       .            ,      .        ,      ,    <code>monkeypatch.chdir(the_tmpdir)</code> . </p><br><p>       monkeypatch    <code>unittest.mock</code> ,      .      7 " pytest   "  . 125. </p><br><h2 id="ispolzovanie-doctest_namespace">  doctest_namespace </h2><br><p>  <em>doctest</em>     Python         <em>docstrings</em>   ,  ,   .    pytest      <em>doctest</em>   Python    <code>--doctest-modules</code> .    <code>doctest_namespace</code> ,      <em>autouse</em> ,       <em>pytest</em>     doctest .   docstrings    . </p><br><p> <code>doctest_namespace</code>         ,    Python       . , <code>numpy</code>    <code>import numpy as np</code> . </p><br><p>    . ,       <code>unnecessary_math.py</code>   <code>multiply()</code>  <code>divide()</code> ,    .  ,        docstring ,    docstrings : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/dt/1/unnecessary_math.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" This module defines multiply(a, b) and divide(a, b). &gt;&gt;&gt; import unnecessary_math as um Here's how you use multiply: &gt;&gt;&gt; um.multiply(4, 3) 12 &gt;&gt;&gt; um.multiply('a', 3) 'aaa' Here's how you use divide: &gt;&gt;&gt; um.divide(10, 5) 2.0 """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">multiply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Returns a multiplied by b. &gt;&gt;&gt; um.multiply(4, 3) 12 &gt;&gt;&gt; um.multiply('a', 3) 'aaa' """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a * b <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Returns a divided by b. &gt;&gt;&gt; um.divide(10, 5) 2.0 """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a / b</code> </pre><br><p>   <code>unnecessary_math</code> ,    <code>um</code>  ,  <code>import noecessary_math as um</code>   -.   docstrings     <code>import</code> ,     <code>um</code> .   ,  pytest   docstring    .    docstring    ,    docstrings    : </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/dt/1 $ pytest -v --doctest-modules --tb=short unnecessary_math.py ============================= test session starts ============================= collected 3 items unnecessary_math.py::unnecessary_math PASSED unnecessary_math.py::unnecessary_math.divide FAILED unnecessary_math.py::unnecessary_math.multiply FAILED ================================== FAILURES =================================== ______________________ [doctest] unnecessary_math.divide ______________________ 034 035 Returns a divided by b. 036 037 &gt;&gt;&gt; um.divide(10, 5) UNEXPECTED EXCEPTION: NameError("name 'um' is not defined",) Traceback (most recent call last): ... File "&lt;doctest unnecessary_math.divide[0]&gt;", line 1, in &lt;module&gt; NameError: name 'um' is not defined ... _____________________ [doctest] unnecessary_math.multiply _____________________ 022 023 Returns a multiplied by b. 024 025 &gt;&gt;&gt; um.multiply(4, 3) UNEXPECTED EXCEPTION: NameError("name 'um' is not defined",) Traceback (most recent call last): ... File "&lt;doctest unnecessary_math.multiply[0]&gt;", line 1, in &lt;module&gt; NameError: name 'um' is not defined /path/to/code/ch4/dt/1/unnecessary_math.py:23: UnexpectedException ================ 2 failed, 1 passed in 0.03 seconds =================</code> </pre><br><p>     -  <code>import</code>   docstring: </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/dt/2/unnecessary_math.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" This module defines multiply(a, b) and divide(a, b). &gt;&gt;&gt; import unnecessary_math as um Here's how you use multiply: &gt;&gt;&gt; um.multiply(4, 3) 12 &gt;&gt;&gt; um.multiply('a', 3) 'aaa' Here's how you use divide: &gt;&gt;&gt; um.divide(10, 5) 2.0 """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">multiply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Returns a multiplied by b. &gt;&gt;&gt; import unnecessary_math as um &gt;&gt;&gt; um.multiply(4, 3) 12 &gt;&gt;&gt; um.multiply('a', 3) 'aaa' """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a * b <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Returns a divided by b. &gt;&gt;&gt; import unnecessary_math as um &gt;&gt;&gt; um.divide(10, 5) 2.0 """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a / b</code> </pre> <br><p>    : </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/dt/2 $ pytest -v --doctest-modules --tb=short unnecessary_math.py ============================= test session starts ============================= collected 3 items unnecessary_math.py::unnecessary_math PASSED [ 33%] unnecessary_math.py::unnecessary_math.divide PASSED [ 66%] unnecessary_math.py::unnecessary_math.multiply PASSED [100%] ===================== 3 passed in 0.03 seconds ======================</code> </pre> <br><p>     docstrings        . </p><br><p>   <code>doctest_namespace</code> ,   <code>autouse</code>   <code>conftest.py</code>  ,      : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/dt/3/conftest.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unnecessary_math @pytest.fixture(autouse=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_um</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(doctest_namespace)</span></span></span><span class="hljs-function">:</span></span> doctest_namespace[<span class="hljs-string"><span class="hljs-string">'um'</span></span>] = unnecessary_math</code> </pre> <br><p>   pytest   <code>um</code>  <code>doctest_namespace</code> ,     <code>unnecessary_math</code> .     conftest.py,  doctests,     conftest.py    <code>um</code> . </p><br><p>     doctest  pytest   7 " pytest   "  . 125. </p><br><h2 id="ispolzovanie-recwarn">  recwarn </h2><br><p>   <code>recwarn</code>    ,   .  Python    ,     ,    ,      . , ,      ,         ,      .             : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/test_warnings.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> warnings <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lame_function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> warnings.warn(<span class="hljs-string"><span class="hljs-string">"Please stop using this"</span></span>, DeprecationWarning) <span class="hljs-comment"><span class="hljs-comment"># rest of function</span></span></code> </pre> <br><p>   ,      : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/test_warnings.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_lame_function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(recwarn)</span></span></span><span class="hljs-function">:</span></span> lame_function() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> len(recwarn) == <span class="hljs-number"><span class="hljs-number">1</span></span> w = recwarn.pop() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> w.category == DeprecationWarning <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> str(w.message) == <span class="hljs-string"><span class="hljs-string">'Please stop using this'</span></span></code> </pre> <br><p>  recwarn    ,        <code>category</code> (), <code>message</code> (), <code>filename</code> ( )  <code>lineno</code> ( ),    . </p><br><p>      .   ,     ,      ,     .      <code>recwarn.clear()</code> ,     ,      . </p><br><p>    <code>recwarn</code> , pytest      <code>pytest.warns()</code> : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ch4/test_warnings.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_lame_function_2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> pytest.warns(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> warning_list: lame_function() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> len(warning_list) == <span class="hljs-number"><span class="hljs-number">1</span></span> w = warning_list.pop() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> w.category == DeprecationWarning <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> str(w.message) == <span class="hljs-string"><span class="hljs-string">'Please stop using this'</span></span></code> </pre> <br><p>   <code>pytest.warns()</code>         .  <code>recwarn</code>    <code>pytest.warns()</code>   ,    ,  ,    . </p><br><h2 id="uprazhneniya">  Exercícios </h2><br><ol><li>  <code>ch4/cache/test_slower.py</code>   <code>autouse</code> ,  <code>check_duration()</code> .    <code>ch3/tasks_proj/tests/conftest.py</code> . </li><li>     3. </li><li>     , 2x      .  2x  ,    0.1   2x   . </li><li>  pytest   .   ? </li></ol><br><h2 id="chto-dalshe">  O que vem a seguir </h2><br><p>         pytest.      .          ;         pytest. </p><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Voltar</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Próximo</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt448792/">https://habr.com/ru/post/pt448792/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt448768/index.html">Controle de iluminação em vários níveis: resiliência de soluções e produtos</a></li>
<li><a href="../pt448774/index.html">SQL para CSV usando DBMS_SQL</a></li>
<li><a href="../pt448776/index.html">RxVMS - Uma Arquitetura Prática para Aplicações de Flutter</a></li>
<li><a href="../pt448782/index.html">Teste de Python com pytest. Introdução ao pytest, Capítulo 1</a></li>
<li><a href="../pt448784/index.html">Novos recursos para autores de extensão no Visual Studio 2019 versão 16.1</a></li>
<li><a href="../pt448796/index.html">Teste de Python com pytest. Configuração, CAPÍTULO 6</a></li>
<li><a href="../pt448798/index.html">Teste de Python com pytest. Usando pytest com outras ferramentas, CAPÍTULO 7</a></li>
<li><a href="../pt448802/index.html">Pensando em portais: criando portais no Unreal Engine 4</a></li>
<li><a href="../pt448804/index.html">Preparando-se para o tempo de execução e o notário reforçados do macOS</a></li>
<li><a href="../pt448808/index.html">Sobre coisas simples, complicadas. "Dormindo aço". Como lubrificar parafusos enferrujados ou não WD-40 com um único ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>