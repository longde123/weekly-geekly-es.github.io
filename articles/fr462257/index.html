<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👐🏼 🤹🏽 🙏🏼 Kafka sur Kubernetes - est-ce bien? 📬 👨🏽‍🎨 ⬇️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bienvenue, Habr! 

 À un moment donné, nous avons été les premiers à introduire le thème Kafka sur le marché russe et à continuer de suivre son dévelo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kafka sur Kubernetes - est-ce bien?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/462257/">  Bienvenue, Habr! <br><br>  À un moment donné, nous avons été les premiers à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">introduire le</a> thème <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kafka</a> sur le marché russe et à continuer de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">suivre</a> son développement.  En particulier, le sujet de l'interaction entre Kafka et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kubernetes nous a</a> semblé intéressant.  Un article de revue (et plutôt prudent) à ce sujet a été publié sur le blog de la société Confluent en octobre dernier, rédigé par Gwen Shapira.  Aujourd'hui, nous voulons attirer votre attention sur un article d'avril plus récent de Johann Gyger, qui, bien que non dénué de point d'interrogation dans le titre, examine le sujet de manière plus substantielle, accompagnant le texte de liens intéressants.  Veuillez nous pardonner la traduction gratuite de "chaos monkey" si vous le pouvez! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m7/ok/p4/m7okp40yxxxkzul5qq3blkj0qak.png" alt="image"></div><br><a name="habracut"></a><br><h4>  Présentation </h4><br>  Kubernetes est conçu pour gérer des charges sans état.  En règle générale, ces charges de travail sont présentées sous la forme d'une architecture de microservices, elles sont légères, bien adaptées à la mise à l'échelle horizontale, obéissent aux principes des applications à 12 facteurs et permettent de travailler avec des disjoncteurs et des singes du chaos. <br><br>  Kafka, d'autre part, agit essentiellement comme une base de données distribuée.  Ainsi, lorsque vous travaillez, vous devez faire face à la condition, et c'est beaucoup plus lourd qu'un microservice.  Kubernetes prend en charge les charges avec état, mais comme Kelsey Hightower le fait remarquer dans deux de ses tweets, elles doivent être manipulées avec soin: <br><blockquote>  Il semble à certains que si vous lancez Kubernetes sur une charge avec état, il se transforme en une base de données entièrement gérée qui peut rivaliser avec RDS.  Ce n'est pas le cas.  Peut-être que si vous travaillez dur, vissez des composants supplémentaires et attirez une équipe d'ingénieurs SRE, vous pouvez installer RDS sur Kubernetes. </blockquote><blockquote>  Je recommande toujours à tout le monde de faire preuve d'une extrême prudence lors du lancement de charges préservant l'état sur Kubernetes.  La plupart de ceux qui sont intéressés par «puis-je exécuter des charges avec état sur Kubernetes» n'ont pas une expérience suffisante de travail avec Kubernetes, et souvent avec la charge qu'ils demandent. </blockquote>  Alors, dois-je exécuter Kafka sur Kubernetes?  Contre-question: Kafka fonctionnera-t-il mieux sans Kubernetes?  C'est pourquoi je tiens à souligner dans cet article comment Kafka et Kubernetes se complètent mutuellement, et quels pièges peuvent rencontrer lorsqu'ils sont combinés. <br><br><h4>  Délai de livraison </h4><br>  Parlons de la chose de base - l'environnement d'exécution lui-même <br><br>  <i><b>Le processus</b></i> <br><br>  Les courtiers Kafka sont pratiques lorsque vous travaillez avec le CPU.  TLS peut entraîner des frais généraux.  Dans le même temps, les clients Kafka peuvent charger davantage le processeur s'ils utilisent le chiffrement, mais cela n'affecte pas les courtiers. <br><br>  <i><b>La mémoire</b></i> <br><br>  Les courtiers de Kafka engloutissent la mémoire.  La taille du tas JVM est généralement à la mode pour limiter 4 à 5 Go, mais vous aurez également besoin de beaucoup de mémoire système, car Kafka utilise très activement le cache de pages.  Dans Kubernetes, définissez correctement les limites de conteneur pour les ressources et les demandes. <br><br>  <i><b>Entrepôt de données</b></i> <br><br>  Le stockage des données dans les conteneurs est éphémère - les données sont perdues au redémarrage.  Vous pouvez utiliser le volume <code>emptyDir</code> pour les données Kafka, et l'effet sera similaire: vos données de courtier seront perdues après la fin.  Vos messages peuvent toujours être enregistrés sur d'autres courtiers en tant que répliques.  Par conséquent, après un redémarrage, un courtier défaillant doit d'abord répliquer toutes les données, et ce processus peut prendre beaucoup de temps. <br><br>  C'est pourquoi le stockage de données à long terme doit être utilisé.  Qu'il s'agisse d'un stockage à long terme non local avec le système de fichiers XFS ou, plus précisément, ext4.  N'utilisez pas NFS.  Ai-je prévenu.  Les versions NFS v3 ou v4 ne fonctionneront pas.  En bref, le courtier Kafka se terminera s'il ne peut pas supprimer le répertoire de données en raison du problème de «renommage stupide» qui est pertinent dans NFS.  Si je ne vous ai toujours pas convaincu, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lisez</a> très attentivement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> .  L'entrepôt de données doit être non local afin que Kubernetes puisse sélectionner de manière plus flexible un nouveau nœud après un redémarrage ou une relocalisation. <br><br>  <i><b>Réseau</b></i> <br><br>  Comme avec la plupart des systèmes distribués, les performances de Kafka dépendent beaucoup de la latence du réseau minimale et de la bande passante maximale.  N'essayez pas de placer tous les courtiers sur le même nœud, car cela réduirait la disponibilité.  Si le nœud Kubernetes échoue, l'ensemble du cluster Kafka échoue également.  En outre, ne dispersez pas le cluster Kafka dans des centres de données entiers.  Il en va de même pour le cluster Kubernetes.  Un bon compromis dans ce cas est de choisir différentes zones d'accès. <br><br><h4>  La configuration </h4><br>  <i><b>Manifestes courants</b></i> <br><br>  Le site Web de Kubernetes a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">très bon guide</a> sur la façon de configurer ZooKeeper à l'aide de manifestes.  Puisque ZooKeeper fait partie de Kafka, c'est à partir de là qu'il est commode de commencer à se familiariser avec les concepts de Kubernetes applicables ici.  Une fois que vous avez compris cela, vous pouvez utiliser les mêmes concepts avec le cluster Kafka. <br><br><ul><li>  <i>Sub</i> : sub est la plus petite unité déployable de Kubernetes.  Le module contient votre charge de travail et le module lui-même correspond au processus de votre cluster.  Un foyer contient un ou plusieurs conteneurs.  Chaque serveur ZooKeeper de l'ensemble et chaque courtier du cluster Kafka fonctionneront selon une approche distincte. </li><li>  <i>StatefulSet</i> : StatefulSet est un objet Kubernetes qui fonctionne avec plusieurs charges de travail avec état, qui nécessitent une coordination.  StatefulSet offre des garanties concernant la commande des foyers et leur caractère unique. </li><li>  <i>Services sans tête</i> : les services vous permettent de détacher les modules des clients à l'aide d'un nom logique.  Dans ce cas, Kubernetes est responsable de l'équilibrage de charge.  Cependant, lors de la maintenance de charges de travail avec état, comme dans le cas de ZooKeeper et Kafka, les clients doivent échanger des informations avec une instance spécifique.  C'est là que les services sans tête sont utiles: dans ce cas, le client aura toujours un nom logique, mais vous n'aurez pas à aller directement au bas. </li><li>  <i>Volume pour le stockage à long terme</i> : ces volumes sont nécessaires pour la configuration du stockage à long terme sur bloc non local, qui a été mentionné ci-dessus. </li></ul><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Yolean</a> fournit un ensemble complet de manifestes qui facilitent le démarrage de Kafka sur Kubernetes. <br><br>  <i><b>Tableaux de barre</b></i> <br><br>  Helm est un gestionnaire de packages pour un Kubernetes, qui peut être comparé aux gestionnaires de packages pour le système d'exploitation, tels que yum, apt, Homebrew ou Chocolatey.  Son utilisation est pratique pour installer des progiciels prédéfinis décrits dans les diagrammes de Helm.  Un diagramme de Helm bien choisi facilite la tâche difficile: comment configurer correctement tous les paramètres pour utiliser Kafka sur Kubernetes.  Il existe plusieurs diagrammes de Kafka: celui officiel est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans un état incubateur</a> , il y en a un de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Confluent</a> , un de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bitnami</a> de plus. <br><br>  <i><b>Les opérateurs</b></i> <br><br>  Helm ayant certains inconvénients, un autre outil gagne en popularité: les opérateurs Kubernetes.  L'opérateur n'emballe pas seulement le logiciel pour Kubernetes, mais vous permet également de déployer ce logiciel et de le gérer. <br><br>  La liste des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">opérateurs impressionnants</a> mentionne deux opérateurs pour Kafka.  L'un d'eux est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Strimzi</a> .  Avec l'aide de Strimzi, il est facile de lever un cluster Kafka en quelques minutes.  Pratiquement aucune configuration n'est requise, de plus, l'opérateur lui-même fournit de belles fonctionnalités, par exemple le cryptage TLS de type "point à point" à l'intérieur du cluster.  Confluent fournit également <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">son propre opérateur</a> . <br><br>  <b>Performances</b> <br><br>  Il est très important de tester les performances en fournissant à l'instance Kafka installée des points de contrôle.  Ces tests vous aideront à identifier les goulots d'étranglement potentiels avant le début des problèmes.  Heureusement, Kafka fournit déjà deux outils de test de performances: <code>kafka-producer-perf-test.sh</code> et <code>kafka-consumer-perf-test.sh</code> .  Utilisez-les activement.  Pour référence, vous pouvez vous référer aux résultats décrits dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article par</a> Jay Kreps, ou utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cette</a> critique de Stéphane Maarek Amazon MSK. <br><br><h4>  Les opérations </h4><br>  <i><b>Suivi</b></i> <br><br>  La transparence du système est très importante - sinon vous ne comprendrez pas ce qui s'y passe.  Aujourd'hui, il existe une solide boîte à outils qui fournit une surveillance basée sur des métriques dans le style natif du cloud.  Deux outils populaires à cet effet sont Prométhée et Grafana.  Prometheus peut collecter des métriques de tous les processus Java (Kafka, Zookeeper, Kafka Connect) à l'aide de l'exportateur JMX - de la manière la plus simple.  Si vous ajoutez des métriques cAdvisor, vous pouvez mieux comprendre comment les ressources sont utilisées dans Kubernetes. <br><br>  Strimzi a un exemple de tableau de bord Grafana très pratique pour Kafka.  Il affiche des mesures clés, par exemple, sur les secteurs sous-répliqués ou ceux qui sont hors ligne.  Tout y est très clair.  Ces mesures sont complétées par des informations sur l'utilisation et les performances des ressources, ainsi que des indicateurs de stabilité.  Ainsi, vous obtenez une surveillance de base du cluster Kafka sans raison! <br><br><img src="https://habrastorage.org/webt/rc/pl/wz/rcplwz2iz4iw7ujogarvaacoffe.png"><br><br>  Source: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">strimzi.io/docs/master/#kafka_dashboard</a> <br><br>  Il serait bon de compléter tout cela avec une surveillance des clients (mesures pour les consommateurs et les producteurs), ainsi qu'une surveillance des retards (pour cela, il y a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Burrow</a> ) et une surveillance de bout en bout - pour cela, utilisez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kafka Monitor</a> . <br><br>  <i><b>Journalisation</b></i> <br><br>  La journalisation est une autre tâche critique.  Assurez-vous que tous les conteneurs de votre installation Kafka sont connectés dans <code>stdout</code> et <code>stderr</code> , et assurez-vous que votre cluster Kubernetes regroupe tous les journaux dans une infrastructure de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">journalisation</a> centrale, comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Elasticsearch</a> . <br><br>  <i><b>Bilan de santé</b></i> <br><br>  Kubernetes utilise des sondes de vivacité et de préparation pour vérifier si vos pods fonctionnent correctement.  Si le test en direct échoue, Kubernetes arrête ce conteneur, puis le redémarre automatiquement si la stratégie de redémarrage est définie en conséquence.  Si le contrôle de disponibilité échoue, Kubernetes l'isole du service de demande.  Ainsi, dans de tels cas, une intervention manuelle n'est plus nécessaire du tout, et c'est un gros plus. <br><br>  <i><b>Déploiement des mises à jour</b></i> <br><br>  StatefulSet prend en charge les mises à jour automatiques: lorsque vous choisissez une stratégie RollingUpdate, chacune sous Kafka sera mise à jour à son tour.  De cette façon, les temps d'arrêt peuvent être réduits à zéro. <br><br>  <i><b>Mise à l'échelle</b></i> <br><br>  Faire évoluer un cluster Kafka n'est pas une tâche facile.  Cependant, dans Kubernetes, il est très facile de faire évoluer les modules vers un certain nombre de répliques, ce qui signifie que vous pouvez identifier de manière déclarative autant de courtiers Kafka que vous le souhaitez.  Le plus difficile dans ce cas est la réaffectation des secteurs après une augmentation ou une réduction.  Encore une fois, Kubernetes vous aidera dans cette tâche. <br><br>  <i><b>Administration</b></i> <br><br>  Les tâches liées à l'administration de votre cluster Kafka, en particulier la création de rubriques et la réaffectation de secteurs, peuvent être effectuées à l'aide de scripts shell existants, ouvrant l'interface de ligne de commande dans vos pods.  Cependant, cette solution n'est pas trop belle.  Strimzi prend en charge la gestion des sujets à l'aide d'un autre opérateur.  Il y a quelque chose à modifier ici. <br><br>  <i><b>Sauvegarde et restauration</b></i> <br><br>  Maintenant, la disponibilité de Kafka dépendra de la disponibilité de Kubernetes.  Si votre cluster Kubernetes tombe, dans le pire des cas, le cluster Kafka tombe également.  Selon la loi de Murphy, cela se produira et vous perdrez des données.  Pour réduire ce type de risque, ayez un bon concept de sauvegarde.  Vous pouvez utiliser MirrorMaker, une autre option consiste à utiliser S3 pour cela, comme décrit dans cet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> de Zalando. <br><br><h4>  Conclusion </h4><br>  Lorsque vous travaillez avec des clusters Kafka de petite ou moyenne taille, il est certainement conseillé d'utiliser Kubernetes, car il offre une flexibilité supplémentaire et simplifie le travail avec les opérateurs.  Si vous avez des exigences non fonctionnelles très graves concernant la latence et / ou le débit, il peut être préférable d'envisager une autre option de déploiement. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr462257/">https://habr.com/ru/post/fr462257/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr462227/index.html">Moscou, 9 août - Backend Stories 4.0</a></li>
<li><a href="../fr462243/index.html">Amélioration des performances frontales de Magento avec ReactJS</a></li>
<li><a href="../fr462245/index.html">auto git bisect comme exemple du noyau Linux</a></li>
<li><a href="../fr462251/index.html">Le mode navigation privée dans le navigateur est-il une fiction?</a></li>
<li><a href="../fr462253/index.html">Les premières expériences utilisant le protocole de streaming sur l'exemple de communication CPU et processeur dans le FPGA Redd</a></li>
<li><a href="../fr462259/index.html">Faire un contrôleur pour une maison intelligente</a></li>
<li><a href="../fr462263/index.html">Pédalez jusqu'au sol: créez un autre manipulateur de pied pour PC</a></li>
<li><a href="../fr462265/index.html">Python et cubes</a></li>
<li><a href="../fr462267/index.html">Apprenez à connaître l'analyseur statique PVS-Studio pour Java</a></li>
<li><a href="../fr462269/index.html">John Romero à Doom: 80s Game Dev</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>