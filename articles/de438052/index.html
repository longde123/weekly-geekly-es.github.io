<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏴 👨🏾‍🍳 👼🏽 Interaktor, Betriebsmuster 🌈 🤶🏻 🙍🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dieser Text ist eine Anpassung eines Teils des Hanami-Framework-Handbuchs für das Laravel-Framework. Was hat das Interesse an diesem speziellen Materi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Interaktor, Betriebsmuster</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438052/"><p>  Dieser Text ist eine Anpassung eines Teils des Hanami-Framework-Handbuchs für das Laravel-Framework.  Was hat das Interesse an diesem speziellen Material geweckt?  Es enthält eine schrittweise Beschreibung mit einer Demonstration der gängigen Funktionen für Programmiersprachen und Frameworks wie: </p><br><ul><li>  Verwenden des Interactors-Musters. </li><li>  Demonstration von TDD \ BDD. </li></ul><br><p>  Es sollte sofort angemerkt werden, dass dies nicht nur unterschiedliche Frameworks mit unterschiedlichen Ideologien (insbesondere in Bezug auf ORM) sind, sondern auch unterschiedliche Programmiersprachen, von denen jede ihre eigene spezifische Kultur hat und aus historischen Gründen "Best Practices" etabliert hat.  Verschiedene Programmiersprachen und Frameworks leihen sich in der Regel die erfolgreichsten Lösungen voneinander aus. Daher unterscheiden sich die grundlegenden Dinge trotz unterschiedlicher Details nicht, es sei denn, wir nehmen PL mit einem anfangs anderen Paradigma.  Es ist interessant genug zu vergleichen, wie ein und dasselbe Problem in verschiedenen Ökosystemen gelöst wird. </p><br><p>  Zunächst haben wir also das Hanami-Framework (Ruby-Framework) - ein ziemlich neues Framework, das sich ideologisch mehr für Symfony interessiert, mit ORM "on Repositories".  Und das Ziel-Laravel \ Lumen (PHP) -Framework mit Active Record. </p><a name="habracut"></a><br><p>  Bei der Anpassung wurden die spitzesten Winkel geschnitten: </p><br><ul><li>  Der erste Teil des Handbuchs wurde mit der Initialisierung des Projekts, einer Beschreibung der Merkmale des Frameworks und ähnlichen spezifischen Dingen weggelassen. </li><li>  ORM Eloquent wird auf den Globus gezogen und dient auch als Repository. </li><li>  Schritte zum Generieren von Code und Vorlagen zum Senden von E-Mails. </li></ul><br><p>  Gespeichert und hervorgehoben auf: </p><br><ul><li>  Interaktoren - Auf der Schnittstelle wurde eine minimal angemessene Implementierung vorgenommen. </li><li>  Tests, schrittweise Entwicklung durch TDD. </li></ul><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Der erste Teil des ursprünglichen Hanami-Tutorials, auf den im folgenden Text verwiesen wird.</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ursprünglicher interaktiver Tutorial-Text</a> <br>  Link zum Repository mit angepasstem PHP-Code am Ende des Textes. </p><br><h3 id="interaktory">  Interaktoren </h3><br><h4 id="novaya-ficha-uvedomleniya-po-elektronnoy-pochte">  Neue Funktion: E-Mail-Benachrichtigungen </h4><br><p>  Funktionsszenario: Wenn ich als Administrator ein Buch hinzufüge, möchte ich E-Mail-Benachrichtigungen erhalten. </p><br><p>  Da die Anwendung nicht authentifiziert ist, kann jeder ein neues Buch hinzufügen.  Wir werden die E-Mail-Adresse des Administrators über Umgebungsvariablen angeben. </p><br><p>  Dies ist nur ein Beispiel, das zeigt, wann Interaktoren verwendet werden müssen und insbesondere wie der Hanami-Interaktor verwendet werden soll. </p><br><p>  <em>Dieses Beispiel kann als Grundlage für andere Funktionen dienen, z. B. die Bestätigung neuer Bücher durch den Administrator, bevor sie veröffentlicht werden.</em>  <em>Oder geben Sie Benutzern die Möglichkeit, eine E-Mail-Adresse anzugeben, um das Buch über einen speziellen Link zu bearbeiten.</em> </p><br><p>  In der Praxis können Sie Interaktoren verwenden, um jede von der Netzwerkschicht abstrahierte Geschäftslogik zu implementieren.  Dies ist besonders nützlich, wenn Sie mehrere Dinge kombinieren möchten, um die Komplexität der Codebasis zu steuern. </p><br><p>  Sie werden verwendet, um nicht triviale Geschäftslogik nach dem Prinzip der Einzelverantwortung zu isolieren. </p><br><p>  In Webanwendungen werden sie normalerweise aus Controller-Aktionen verwendet.  Auf diese Weise trennen Sie Aufgaben, Geschäftslogikobjekte und Interaktoren, die nichts über die Netzwerkschicht der Anwendung wissen. </p><br><h4 id="kolbeki-oni-nam-ne-nuzhny">  Rückrufe?  Wir brauchen sie nicht! </h4><br><p>  Der einfachste Weg, eine E-Mail-Benachrichtigung zu implementieren, besteht darin, einen Rückruf hinzuzufügen. </p><br><p>  Das heißt, nach dem Erstellen eines neuen Bucheintrags in der Datenbank wird eine E-Mail gesendet. </p><br><p>  Architektonisch bietet Hanami keinen solchen Mechanismus.  Dies liegt daran, dass wir Modellrückrufe als Anti-Muster betrachten.  Sie verstoßen gegen den Grundsatz der alleinigen Verantwortung.  In unserem Fall mischen sie die Persistenzschicht falsch mit E-Mail-Benachrichtigungen. </p><br><p>  Während des Tests (und höchstwahrscheinlich in einigen anderen Fällen) möchten Sie den Rückruf überspringen.  Dies ist schnell verwirrend, da mehrere Rückrufe für ein einzelnes Ereignis in einer bestimmten Reihenfolge ausgelöst werden können.  Außerdem können Sie einige Rückrufe überspringen.  Rückrufe machen Code zerbrechlich und schwer verständlich. </p><br><p>  Stattdessen empfehlen wir explizit statt implizit. </p><br><p>  Ein Interaktor ist ein Objekt, das einen bestimmten Anwendungsfall darstellt. </p><br><p>  Sie ermöglichen jeder Klasse eine einzige Verantwortung.  Es liegt in der alleinigen Verantwortung des Interaktors, die Objekte und Methodenaufrufe zu kombinieren, um ein bestimmtes Ergebnis zu erzielen. </p><br><h4 id="ideya">  Idee </h4><br><p>  Die Hauptidee der Interaktoren besteht darin, dass Sie die isolierten Teile der Funktionalität in eine neue Klasse extrahieren. </p><br><p> Sie sollten nur zwei öffentliche Methoden schreiben: <code>__construct</code> und <code>call</code> . <br>  <em>In der PHP-Implementierung des Interaktors hat die <code>__invoke</code> den geschützten Modifikator und wird über <code>__invoke</code> .</em> </p><br><p>  Dies bedeutet, dass solche Objekte leicht zu interpretieren sind, da nur eine Methode zur Verwendung verfügbar ist. </p><br><p>  Das Einkapseln des Verhaltens in ein Objekt erleichtert das Testen.  Dies erleichtert auch das Verständnis Ihrer Codebasis und lässt nicht nur implizit verborgene Komplexität zurück. </p><br><h4 id="podgotovka">  Vorbereitung </h4><br><p>  Angenommen, wir haben unsere Bücherregalanwendung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">"Erste Schritte</a> " und möchten die Funktion "E-Mail-Benachrichtigung für hinzugefügtes Buch" hinzufügen. </p><br><h4 id="pishem-interaktor">  Einen Interaktor schreiben </h4><br><p>  Erstellen wir einen Ordner für unsere Interaktoren und einen Ordner für ihre Tests: </p><br><pre> <code class="plaintext hljs">$ mkdir lib/bookshelf/interactors $ mkdir tests/bookshelf/interactors</code> </pre> <br><p>  Wir legen sie in <code>lib/bookshelf</code> da sie nicht mit der Webanwendung zusammenhängen.  Sie können Bücher später über das Admin-Portal, die API oder sogar ein Befehlszeilenprogramm hinzufügen. </p><br><p>  Fügen Sie den <code>AddBook</code> Interaktor hinzu und schreiben Sie einen neuen Test test <code>tests/bookshelf/interactors/AddBookTest.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment"># tests/bookshelf/interactors/AddBookTest.php &lt;?php use Lib\Bookshelf\Interactors\AddBook; class AddBookTest extends TestCase { private function interactor() { return $this-&gt;app-&gt;make(AddBook::class); } private function bookAttributes() { return [ "author" =&gt; "James Baldwin", 'title' =&gt; "The Fire Next Time", ]; } private function subjectCall() { return $this-&gt;interactor()($this-&gt;bookAttributes()); } public function testSucceeds() { $result = $this-&gt;subjectCall(); $this-&gt;assertTrue($result-&gt;successful()); } }</span></span></code> </pre><br><p>  <code>AddBook</code> eine <code>AddBook</code> wird ein Fehler " <code>Class does not exist</code> <code>AddBook</code> da keine <code>AddBook</code> Klasse vorhanden ist.  Erstellen wir diese Klasse in der Datei <code>lib/bookshelf/interactors/AddBook.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddBook</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Es gibt nur zwei Methoden, die diese Klasse enthalten sollte: <code>__construct</code> zum Festlegen von Daten und <code>call</code> zum Implementieren des Skripts. </p><br><p>  Diese Methoden, insbesondere <code>call</code> , sollten private Methoden <code>call</code> , die Sie schreiben. </p><br><p>  Standardmäßig wird das Ergebnis als erfolgreich angesehen, da wir nicht explizit angegeben haben, dass der Vorgang fehlgeschlagen ist. </p><br><p>  Lassen Sie uns den Test ausführen: </p><br><pre> <code class="plaintext hljs">$ phpunit</code> </pre> <br><p>  Alle Tests müssen bestanden werden! </p><br><p>  Lassen Sie uns <code>AddBook</code> unseren <code>AddBook</code> Interaktor wirklich etwas tun! </p><br><h3 id="sozdanie-knigi">  Bucherstellung </h3><br><p>  Ändern Sie <code>tests/bookshelf/interactors/AddBookTest.php</code> : </p><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCreateBook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;subjectCall(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">"The Fire Next Time"</span></span>, $result-&gt;book-&gt;title); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">"James Baldwin"</span></span>, $result-&gt;book-&gt;author); }</code> </pre> <br><p>  Wenn Sie <code>phpunit</code> Tests <code>phpunit</code> , wird ein Fehler <code>phpunit</code> : </p><br><pre> <code class="plaintext hljs">Exception: Undefined property Lib\Interactor\InteractorResult::$book</code> </pre> <br><p>  Füllen wir unseren Interaktor aus und erklären dann, was wir getan haben: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Book</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddBook</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $expose = [<span class="hljs-string"><span class="hljs-string">"book"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $book = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($bookAttributes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book($bookAttributes); } }</code> </pre> <br><p>  Zwei wichtige Dinge, die hier zu beachten sind: </p><br><p>  String <code>protected static $expose = ["book"];</code>  Fügt die Bucheigenschaft zum Ergebnisobjekt hinzu, das beim Aufruf des Interaktors zurückgegeben wird. </p><br><p>  Die <code>call</code> weist das Buchmodell der <code>Book</code> zu, die als Ergebnis verfügbar sein wird. </p><br><p>  Jetzt sollten die Tests bestehen. </p><br><p>  Wir haben das Buchmodell initialisiert, es ist jedoch nicht in der Datenbank gespeichert. </p><br><h4 id="sohranenie-knigi">  Buch speichern </h4><br><p>  Wir haben ein neues Buch, das aus dem Titel und dem Autor stammt, aber es ist noch nicht in der Datenbank. </p><br><p>  Wir müssen unser <code>BookRepository</code> , um es zu speichern. </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// tests/bookshelf/interactors/AddBookTest.php public function testPersistsBook() { $result = $this-&gt;subjectCall(); $this-&gt;assertNotNull($result-&gt;book-&gt;id); }</span></span></code> </pre> <br><p>  Wenn Sie die Tests ausführen, wird ein neuer Fehler mit der Meldung " <code>Failed asserting that null is not null</code> . </p><br><p>  Dies liegt daran, dass das von uns erstellte Buch keine Kennung hat, da es diese nur erhält, wenn es gespeichert wird. </p><br><p>  Damit der Test bestanden werden kann, müssen wir ein gespeichertes Buch erstellen.  Ein anderer, nicht weniger korrekter Weg besteht darin, das Buch zu speichern, das wir bereits haben. </p><br><p>  Bearbeiten Sie die <code>lib/bookshelf/interactors/AddBook.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($bookAttributes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;book = Book::create($bookAttributes); }</code> </pre> <br><p>  Anstatt ein <code>new Book</code> aufzurufen, führen wir <code>Book::create</code> mit den Attributen des Buches aus. </p><br><p>  Die Methode gibt das Buch weiterhin zurück und speichert diesen Datensatz auch in der Datenbank. </p><br><p>  Wenn Sie die Tests jetzt ausführen, werden Sie feststellen, dass alle Tests bestanden wurden. </p><br><h4 id="vnedrenie-zavisimostey-dependency-injection">  Abhängigkeitsinjektion </h4><br><p>  Lassen Sie uns die Abhängigkeitsinjektion umgestalten. </p><br><p>  Tests funktionieren immer noch, hängen jedoch von den Funktionen zum Speichern in der Datenbank ab (die ID-Eigenschaft wird nach erfolgreichem Speichern festgelegt).  Dies ist ein Implementierungsdetail der Funktionsweise der Erhaltung.  Wenn Sie beispielsweise vor dem Speichern eine UUID erstellen möchten und angeben möchten, dass das Speichern auf andere Weise als durch Ausfüllen der ID-Spalte erfolgreich war, müssen Sie diesen Test ändern. </p><br><p>  Wir können unseren Test und den Interaktor modifizieren, um ihn zuverlässiger zu machen: Er ist weniger anfällig für Brüche aufgrund von Änderungen außerhalb seiner Datei. </p><br><p>  So können wir die Abhängigkeitsinjektion im Interaktor verwenden: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// lib/bookshelf/interactors/AddBook.php public function __construct(Book $repository) { $this-&gt;repository = $repository; } protected function call($bookAttributes) { $this-&gt;book = $this-&gt;repository-&gt;create($bookAttributes); }</span></span></code> </pre> <br><p>  Im Wesentlichen ist dies mit etwas mehr Code dasselbe, um eine <code>repository</code> Eigenschaft zu erstellen. </p><br><p>  Im Moment überprüft der Test das Verhalten der <code>create</code> Methode, um sicherzustellen, dass ihre Kennung mit <code>$this-&gt;assertNotNull($result-&gt;book-&gt;id)</code> gefüllt ist. </p><br><p>  Dies ist ein Implementierungsdetail. </p><br><p>  Stattdessen können wir den Test ändern, um sicherzustellen, dass die Methode <code>create</code> im Repository aufgerufen wurde, und darauf vertrauen, dass das Repository das Objekt speichert (da dies in seiner Verantwortung liegt). </p><br><p>  Lassen Sie uns den <code>testPersistsBook</code> Test ändern: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// tests/bookshelf/interactors/AddBookTest.php public function testPersistsBook() { $repository = Mockery::mock(Book::class); $this-&gt;app-&gt;instance(Book::class, $repository); $attributes = [ "author" =&gt; "James Baldwin", 'title' =&gt; "The Fire Next Time", ]; $repository-&gt;expects()-&gt;create($attributes); $this-&gt;subjectCall($attributes); }</span></span></code> </pre> <br><p>  Jetzt verletzt unser Test nicht die Grenzen seiner Zone. </p><br><p>  Wir haben lediglich die Interaktorabhängigkeit zum Repository hinzugefügt. </p><br><h4 id="uvedomlenie-na-elektronnuyu-pochtu">  E-Mail-Benachrichtigung </h4><br><p>  Fügen wir eine E-Mail-Benachrichtigung hinzu! </p><br><p>  <em>Sie können hier auch alles tun, z. B. eine SMS senden, eine Chat-Nachricht senden oder einen Web-Hook aktivieren.</em> </p><br><p>  Wir werden den Nachrichtentext leer lassen, aber im Betrefffeld geben wir "Buch hinzugefügt!" An. </p><br><p>  Erstellen Sie einen Benachrichtigungstest <code>tests/bookshelf/mail/BookAddedNotificationTest.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>\<span class="hljs-title"><span class="hljs-title">BookAddedNotification</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Support</span></span>\<span class="hljs-title"><span class="hljs-title">Facades</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BookAddedNotificationTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::setUp(); Mail::fake(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BookAddedNotification(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCorrectAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;build(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">'no-reply@example.com'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;from[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'address'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">'admin@example.com'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;to[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'address'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">'Book added!'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;subject); } }</code> </pre> <br><p>  Fügen Sie die Benachrichtigungsklasse <code>lib/Bookshelf/Mail/BookAddedNotification.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>\<span class="hljs-title"><span class="hljs-title">Mailable</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">SerializesModels</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BookAddedNotification</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mailable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">SerializesModels</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;from(<span class="hljs-string"><span class="hljs-string">'no-reply@example.com'</span></span>) -&gt;to(<span class="hljs-string"><span class="hljs-string">'admin@example.com'</span></span>) -&gt;subject(<span class="hljs-string"><span class="hljs-string">'Book added!'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view(<span class="hljs-string"><span class="hljs-string">'emails.book_added_notification'</span></span>); } }</code> </pre> <br><p>  Jetzt bestehen alle unsere Tests! </p><br><p>  Die Benachrichtigung wird jedoch noch nicht gesendet.  Wir müssen das Senden von unserem <code>AddBook</code> Interaktor <code>AddBook</code> . </p><br><p>  <code>AddBook</code> Test <code>AddBook</code> , um sicherzustellen, dass der Mailer aufgerufen wird: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSendMail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Mail::fake(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;subjectCall(); Mail::assertSent(BookAddedNotification::class, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br><p>  Wenn wir die Tests ausführen, wird folgende Fehlermeldung <code>The expected [Lib\Bookshelf\Mail\BookAddedNotification] mailable was sent 0 times instead of 1 times.</code> : <code>The expected [Lib\Bookshelf\Mail\BookAddedNotification] mailable was sent 0 times instead of 1 times.</code>  . </p><br><p>  Jetzt integrieren wir den Benachrichtigungsversand in den Interaktor. </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Book $repository, BookAddedNotification $mail)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;repository = $repository; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail = $mail; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($bookAttributes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;book = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;repository-&gt;create($bookAttributes); Mail::send(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail); }</code> </pre> <br><p>  Infolgedessen sendet der Interaktor eine Benachrichtigung über das Hinzufügen des Buches zur E-Mail. </p><br><h4 id="integraciya-s-kontrollerom">  Controller-Integration </h4><br><p>  Schließlich müssen wir den Interaktor von der Aktion aus aufrufen. </p><br><p>  Bearbeiten Sie die Aktionsdatei <code>app/Http/Controllers/BooksCreateController.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Controllers</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>\<span class="hljs-title"><span class="hljs-title">AddBook</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Response</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BooksCreateController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Create a new controller instance. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AddBook $addBook)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addBook = $addBook; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request $request)</span></span></span><span class="hljs-function"> </span></span>{ $input = $request-&gt;all(); (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addBook)($input); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-number"><span class="hljs-number">201</span></span>)); } }</code> </pre> <br><p>  Unsere Tests bestehen, aber es gibt ein kleines Problem. </p><br><p>  Wir testen den Bucherstellungscode zweimal. </p><br><p>  Dies ist normalerweise eine schlechte Praxis, und wir können sie beheben, indem wir einen weiteren Vorteil der Interaktoren veranschaulichen. </p><br><p>  Wir werden die Erwähnung in <code>BookRepository</code> in den Tests entfernen und das <code>BookRepository</code> für unseren <code>AddBook</code> Interaktor verwenden: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>\<span class="hljs-title"><span class="hljs-title">AddBook</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BooksCreateControllerTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCallsInteractor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $attributes = [<span class="hljs-string"><span class="hljs-string">'title'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1984'</span></span>, <span class="hljs-string"><span class="hljs-string">'author'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'George Orwell'</span></span>]; $addBook = Mockery::mock(AddBook::class); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;app-&gt;instance(AddBook::class, $addBook); $addBook-&gt;expects()-&gt;__invoke($attributes); $response = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;call(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'/books'</span></span>, $attributes); } }</code> </pre> <br><p>  Jetzt bestehen unsere Tests und sie sind viel zuverlässiger! </p><br><p>  Die Aktion nimmt Eingaben (aus den Parametern der http-Anforderung) entgegen und ruft den Interaktor auf, um seine Arbeit zu erledigen.  Die einzige Verantwortung für die Aktion ist die Arbeit mit dem Netzwerk.  Und der Interaktor arbeitet mit unserer realen Geschäftslogik. </p><br><p>  Dies vereinfacht Aktionen und deren Tests erheblich. </p><br><p>  Aktionen sind praktisch von der Geschäftslogik ausgenommen. </p><br><p>  Wenn wir den Interaktor ändern, müssen wir die Aktion oder ihren Test nicht mehr ändern. </p><br><p>  <em>Beachten Sie, dass Sie in einer realen Anwendung wahrscheinlich mehr als die oben beschriebene Logik ausführen möchten, um beispielsweise sicherzustellen, dass das Ergebnis erfolgreich ist.</em>  <em>Und wenn ein Fehler auftritt, möchten Sie Fehler vom Interaktor zurückgeben.</em> </p><br><p>  <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Repository mit Code</a></strong> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de438052/">https://habr.com/ru/post/de438052/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de438036/index.html">3blue1brown und MIT auf Russisch</a></li>
<li><a href="../de438038/index.html">Karriere Steroide. Echte Geschichten</a></li>
<li><a href="../de438042/index.html">Die Entwicklung des x86-Kontextwechsels unter Linux</a></li>
<li><a href="../de438046/index.html">Wie kann man schnell eine Million Punkte auf Spark geocodieren?</a></li>
<li><a href="../de438050/index.html">Kalman-Filter zur Minimierung des Entropiewertes eines zufälligen Fehlers mit einer nicht-Gaußschen Verteilung</a></li>
<li><a href="../de438058/index.html">"Datenanalyse in Python" in zwei Teilen</a></li>
<li><a href="../de438060/index.html">Einschätzung der räumlichen Ausrichtung oder Wie man keine Angst vor Mahoney- und Majwik-Filtern hat</a></li>
<li><a href="../de438062/index.html">Meine Adresse ist kein Haus oder eine Straße, meine Adresse ist die Sowjetunion?</a></li>
<li><a href="../de438064/index.html">Checkliste: Was musste vor dem Start von Microservices in Prod getan werden?</a></li>
<li><a href="../de438066/index.html">10 lehrreiche YouTube-Kanäle auf Englisch, von denen Sie noch nie gehört haben</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>