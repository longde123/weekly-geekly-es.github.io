<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òéÔ∏è üå∫ üö∏ Cr√©ation d'une API REST avec Node.js et une base de donn√©es Oracle. Partie 5 üö∂üèø üëéüèº üò™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Partie 5. Cr√©ation d'une API REST: pagination, tri manuel et filtrage 

 Dans l' article pr√©c√©dent, vous avez termin√© la cr√©ation des fonctionnalit√©s ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cr√©ation d'une API REST avec Node.js et une base de donn√©es Oracle. Partie 5</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473652/">  <b>Partie 5. Cr√©ation d'une API REST: pagination, tri manuel et filtrage</b> <br><br>  Dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article pr√©c√©dent,</a> vous avez termin√© la cr√©ation des fonctionnalit√©s de base de l'API CRUD. <br><br>  Et maintenant, lorsqu'une demande HTTP GET est √©mise sur la route des employ√©s, toutes les lignes de la table sont retourn√©es.  Cela peut ne pas avoir beaucoup d'importance avec seulement 107 lignes dans la table HR.EMPLOYEES, mais imaginez ce qui se passerait si la table contient des milliers ou des millions de lignes.  Les clients tels que les applications mobiles et Web affichent g√©n√©ralement seulement une fraction des lignes disponibles dans la base de donn√©es, puis s√©lectionnent plus de lignes si n√©cessaire - peut-√™tre lorsque l'utilisateur fait d√©filer vers le bas ou clique sur le bouton "Suivant" sur un contr√¥le de pause aux pages de l'interface utilisateur. <br><br>  Pour cela, les API REST doivent prendre en charge les outils de pagination pour les r√©sultats renvoy√©s.  Une fois la pagination prise en charge, les capacit√©s de tri deviennent n√©cessaires, car les donn√©es doivent g√©n√©ralement √™tre tri√©es avant l'application de la pagination.  De plus, l'outil de filtrage des donn√©es est tr√®s important pour les performances.  Pourquoi envoyer des donn√©es de la base de donn√©es, √† travers la couche interm√©diaire et compl√®tement au client, si cela n'est pas n√©cessaire? <br><a name="habracut"></a><br>  J'utiliserai les param√®tres de cha√Æne de requ√™te URL afin que les clients puissent sp√©cifier comment les r√©sultats doivent √™tre pagin√©s, tri√©s et filtr√©s.  Comme toujours en programmation, l'impl√©mentation peut varier selon vos besoins, vos objectifs de performances, etc. Dans cet article, je vais vous parler d'une approche manuelle pour ajouter ces fonctions √† l'API. <br><br>  <b>Pagination</b> <br><br>  Recherchez les param√®tres de cha√Æne que j'utiliserai pour la pagination: sauter et limiter.  Le param√®tre skip sera utilis√© pour ignorer le nombre de lignes sp√©cifi√©, tandis que limit limitera le nombre de lignes retourn√©es.  J'utiliserai la valeur par d√©faut de 30 pour la limite si le client ne fournit pas la valeur. <br><br>  Commencez par mettre √† jour la logique du contr√¥leur pour extraire les valeurs de la cha√Æne de requ√™te et passez-les √† l'API de base de donn√©es.  Ouvrez le fichier <b>controllers / employee.js</b> et ajoutez les lignes de code suivantes √† la fonction get apr√®s la ligne qui analyse le param√®tre req.params.id. <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that parses req.params.id is here *** context.skip = parseInt(req.query.skip, 10); context.limit = parseInt(req.query.limit, 10);</span></span></code> </pre> <br>  Vous devez maintenant mettre √† jour la logique de la base de donn√©es pour prendre en compte ces valeurs et mettre √† jour la requ√™te SQL en cons√©quence.  En SQL, la clause offset est utilis√©e pour ignorer les lignes et la clause fetch est utilis√©e pour limiter le nombre de lignes renvoy√©es par la requ√™te.  Comme d'habitude, les valeurs ne seront pas ajout√©es directement √† la requ√™te - √† la place, elles seront ajout√©es en tant que variables de liaison pour des raisons de performances et de s√©curit√©.  Ouvrez <b>db_apis / employee.js</b> et ajoutez le code suivant apr√®s le bloc if dans la fonction find, qui ajoute la clause where √† la demande. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** if block that appends where clause ends here *** if (context.skip) { binds.row_offset = context.skip; query += '\noffset :row_offset rows'; } const limit = (context.limit &gt; 0) ? context.limit : 30; binds.row_limit = limit; query += '\nfetch next :row_limit rows only';</span></span></code> </pre> <br>  C'est tout ce que vous devez faire pour paginer!  Lancez l'API, puis ex√©cutez quelques commandes URL dans un autre terminal pour la tester.  Voici quelques exemples que vous pouvez utiliser: <br><br><pre> <code class="javascript hljs"># use <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> limit (<span class="hljs-number"><span class="hljs-number">30</span></span>) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees"</span></span> # set limit to <span class="hljs-number"><span class="hljs-number">5</span></span> curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?limit=5"</span></span> # use <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> limit and set skip to <span class="hljs-number"><span class="hljs-number">5</span></span> curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?skip=5"</span></span> # set both skip and limit to <span class="hljs-number"><span class="hljs-number">5</span></span> curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?skip=5&amp;limit=5"</span></span></code> </pre> <br>  <b>Tri</b> <br><br>  Au minimum, les clients doivent pouvoir sp√©cifier une colonne √† trier et √† ordonner (ascendante ou descendante).  La fa√ßon la plus simple de le faire est de d√©finir un param√®tre de requ√™te (j'utiliserai sort), qui vous permet de passer une cha√Æne comme 'last_name: asc' ou 'salaire: desc'.  La seule fa√ßon de garantir l'ordre de l'ensemble de r√©sultats renvoy√© par la requ√™te SQL est d'inclure la clause order by.  Pour cette raison, il serait bien d'avoir une d√©finition de commande par d√©faut d√©finie pour garantir la coh√©rence lorsque le client ne la sp√©cifie pas. <br><br>  Revenez √† <b>controllers / employee.js</b> et ajoutez la ligne de code suivante √† la fonction get apr√®s la ligne qui analyse le param√®tre req.query.limit. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that parses req.query.limit is here *** context.sort = req.query.sort;</span></span></code> </pre> <br>  Ouvrez ensuite <b>db_apis / employee.js</b> et ajoutez la ligne suivante sous les lignes qui d√©clarent et initialisent baseQuery. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** lines that initalize baseQuery end here *** const sortableColumns = ['id', 'last_name', 'email', 'hire_date', 'salary'];</span></span></code> </pre> <br>  sortableColumns est une liste blanche de colonnes que les clients peuvent utiliser pour trier.  Ensuite, √† l'int√©rieur de la fonction find, ajoutez le bloc if suivant, qui ajoute la clause order by.  Cela doit √™tre fait apr√®s l'ajout de la clause where, mais avant les clauses offset et fetch. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** if block that appends where clause ends here *** if (context.sort === undefined) { query += '\norder by last_name asc'; } else { let [column, order] = context.sort.split(':'); if (!sortableColumns.includes(column)) { throw new Error('Invalid "sort" column'); } if (order === undefined) { order = 'asc'; } if (order !== 'asc' &amp;&amp; order !== 'desc') { throw new Error('Invalid "sort" order'); } query += `\norder by "${column}" ${order}`; }</span></span></code> </pre> <br>  La premi√®re partie du bloc if v√©rifie si le client a r√©ussi la valeur de tri.  Si ce n'est pas le cas, la clause order by par d√©faut est ajout√©e √† la requ√™te SQL, qui trie par nom de famille dans l'ordre croissant.  Si une valeur de tri est sp√©cifi√©e, elle est d'abord divis√©e en valeurs de colonne et d'ordre, et chaque valeur est v√©rifi√©e avant d'ajouter l'ordre par √† la requ√™te. <br><br>  Vous pouvez maintenant ex√©cuter plusieurs commandes URL pour le valider.  Voici quelques exemples √† essayer: <br><br><pre> <code class="javascript hljs"># use <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> sort (last_name asc) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees"</span></span> # sort by id and use <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> direction (asc) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?sort=id"</span></span> # sort by hire_date desc curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?sort=hire_date:desc"</span></span> # use sort <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> limit and skip together curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?limit=5&amp;skip=5&amp;sort=salary:desc"</span></span> # should <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> an error because first_name is not whitelisted curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?sort=first_name:desc"</span></span> # should <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> an error because <span class="hljs-string"><span class="hljs-string">'other'</span></span> is not a valid order curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?sort=last_name:other"</span></span></code> </pre> <br>  Les deux derniers exemples devraient lever des exceptions, car ils contiennent des valeurs qui n'ont pas √©t√© ajout√©es √† la liste blanche.  Il utilise le gestionnaire d'erreurs Express standard, donc l'erreur est renvoy√©e sous forme de page Web HTML. <br><br>  <b>Filtrage</b> <br><br>  La possibilit√© de filtrer les donn√©es est une caract√©ristique importante que toutes les API REST doivent fournir.  Comme pour le tri, l'impl√©mentation peut √™tre simple ou complexe selon ce que vous souhaitez prendre en charge.  L'approche la plus simple consiste √† ajouter la prise en charge des filtres de correspondance compl√®te (par exemple, last_name = Doe).  Des impl√©mentations plus complexes peuvent ajouter la prise en charge des op√©rateurs de base (par exemple, &lt;,&gt;, instr, etc.) et des op√©rateurs logiques complexes (par exemple, et / ou) qui peuvent regrouper plusieurs filtres. <br><br>  Dans cet article, je vais essayer de simplifier la situation et d'ajouter un support de filtre pour seulement deux colonnes: department_id et manager_id.  Pour chaque colonne, j'activerai le param√®tre correspondant dans la cha√Æne de requ√™te.  La logique de base de donn√©es qui ajoute la clause where lorsque les demandes GET sont envoy√©es au point de terminaison avec un seul employ√© doit √™tre mise √† jour pour prendre en compte ces nouveaux filtres. <br><br>  Ouvrez <b>controllers / employee.js</b> et ajoutez les lignes suivantes sous la ligne qui analyse la valeur req.query.sort dans la fonction get. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that parses req.query.sort is here *** context.department_id = parseInt(req.query.department_id, 10); context.manager_id = parseInt(req.query.manager_id, 10);</span></span></code> </pre> <br>  <b>Modifiez</b> ensuite <b>db_apis / employee.js</b> pour ajouter la phrase 1 = 1 √† la requ√™te de base, comme indiqu√© ci-dessous. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> baseQuery = <span class="hljs-string"><span class="hljs-string">`select employee_id "id", first_name "first_name", last_name "last_name", email "email", phone_number "phone_number", hire_date "hire_date", job_id "job_id", salary "salary", commission_pct "commission_pct", manager_id "manager_id", department_id "department_id" from employees where 1 = 1`</span></span>;</code> </pre> <br>  Bien s√ªr, 1 = 1 sera toujours vrai, donc l'optimiseur l'ignorera simplement.  Cependant, cette m√©thode simplifiera l'ajout de pr√©dicats suppl√©mentaires √† l'avenir. <br><br>  Dans la fonction find, remplacez le bloc if, qui ajoute la clause where lors du passage context.id, par les lignes suivantes. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that declares 'binds' is here *** if (context.id) { binds.employee_id = context.id; query += '\nand employee_id = :employee_id'; } if (context.department_id) { binds.department_id = context.department_id; query += '\nand department_id = :department_id'; } if (context.manager_id) { binds.manager_id = context.manager_id; query += '\nand manager_id = :manager_id'; }</span></span></code> </pre> <br>  Comme vous pouvez le voir, chaque bloc if ajoute simplement la valeur transmise √† l'objet binds, puis ajoute le pr√©dicat correspondant √† la clause where.  Enregistrez les modifications et red√©marrez l'API.  Utilisez ensuite ces commandes URL pour v√©rifier ceci: <br><br><pre> <code class="javascript hljs"># filter where department_id = <span class="hljs-number"><span class="hljs-number">90</span></span> (returns <span class="hljs-number"><span class="hljs-number">3</span></span> employees) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?department_id=90"</span></span> # filter where manager_id = <span class="hljs-number"><span class="hljs-number">100</span></span> (returns <span class="hljs-number"><span class="hljs-number">14</span></span> employees) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?manager_id=100"</span></span> # filter where department_id = <span class="hljs-number"><span class="hljs-number">90</span></span> and manager_id = <span class="hljs-number"><span class="hljs-number">100</span></span> (returns <span class="hljs-number"><span class="hljs-number">2</span></span> employees) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?department_id=90&amp;manager_id=100"</span></span></code> </pre> <br>  Voil√†, l'API prend d√©sormais en charge la pagination, le tri et le filtrage!  Une approche manuelle offre beaucoup de contr√¥le, mais n√©cessite beaucoup de code.  La fonction de recherche compte d√©sormais 58 lignes et ne prend en charge que des capacit√©s de tri et de filtrage limit√©es.  Vous pourriez envisager d'utiliser un module, tel que le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">g√©n√©rateur de</a> requ√™tes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Knex.js</a> , pour simplifier ces op√©rations. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr473652/">https://habr.com/ru/post/fr473652/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr473638/index.html">Shader n'est pas magique. √âcriture de shaders dans Unity. Pr√©sentation</a></li>
<li><a href="../fr473640/index.html">Coucher de soleil Big Data</a></li>
<li><a href="../fr473642/index.html">Cribble Crabble Gradle: Auto-Build Magic</a></li>
<li><a href="../fr473646/index.html">Hackathon dans une petite entreprise: comment organiser sans vider un train de ressources</a></li>
<li><a href="../fr473648/index.html">Le cheval est mort - Cri: transition du tslint au eslint</a></li>
<li><a href="../fr473654/index.html">Compositeur PHP: corriger les d√©pendances sans douleur</a></li>
<li><a href="../fr473656/index.html">Exp√©rience de g√©n√©rateur de site statique Hugo</a></li>
<li><a href="../fr473658/index.html">G√©rer les bogues dans Go 1.13</a></li>
<li><a href="../fr473660/index.html">Arcade Reverse Engineering: Record Michael Jordan au NBA Jam</a></li>
<li><a href="../fr473664/index.html">Exp√©rience d'apprentissage de premi√®re main. Yandex.Practicum - Analyste de donn√©es</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>