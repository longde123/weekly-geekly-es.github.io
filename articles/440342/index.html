<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò• üëπ üëñ C√≥digo universal C # para NET y JavaScript üöµüèº üö¥ ‚ùì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En 2013, mientras trabajaba en el servicio de fotograf√≠a GFRANQ, particip√© en el desarrollo de un servicio web hom√≥nimo para publicar y procesar fotos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥digo universal C # para NET y JavaScript</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440342/"><p>  En 2013, mientras trabajaba en el servicio de fotograf√≠a GFRANQ, particip√© en el desarrollo de un servicio web hom√≥nimo para publicar y procesar fotos.  Los filtros y las transformaciones se definieron en el archivo con par√°metros, y todo el procesamiento se realiz√≥ en el servidor.  Durante el desarrollo del servicio, era necesario admitir estas transformaciones en el lado del cliente para la vista previa.  Seg√∫n Larry Wall, una de las virtudes de un programador es la pereza.  Por lo tanto, como programadores realmente vagos, pensamos en la posibilidad de usar el mismo c√≥digo tanto en el lado del servidor como en el del cliente.  Todo el desarrollo se realiz√≥ en C #.  Despu√©s de investigar las bibliotecas y un par de intentos, concluimos con orgullo que esto era posible y comenzamos a escribir el c√≥digo universal. </p><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/ir/gs/y0/irgsy0wvrqkk5ybw0elxt5nagfk.png"></div><p></p><br><p> ¬øPor qu√© se necesita este art√≠culo?  De hecho, han pasado 6 a√±os desde 2013, y muchas tecnolog√≠as han perdido su relevancia, por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Script #</a> .  Por otro lado, han aparecido otros nuevos.  Por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Bridge.NET</a> o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Blazor</a> basado en el elegante <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">WebAssembly</a> . </p><br><p>  Sin embargo, algunas ideas todav√≠a se pueden utilizar.  En este art√≠culo intent√© describirlos lo m√°s detallado posible.  Espero que la menci√≥n de Silverlight y Flash provoque una sonrisa con un toque de nostalgia, y no un deseo de criticar las viejas soluciones.  De todos modos, han contribuido al desarrollo de la industria web. </p><a name="habracut"></a><br><h2 id="contents">  Contenido </h2><br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Contenido</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Gol</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Descripci√≥n de filtros</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Descripci√≥n de collages</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Implementaci√≥n</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Elegir una plataforma para el procesamiento de fotos</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Traducci√≥n de C # a Javascript</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ventajas</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Desventajas</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Estructura</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Usando alias</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Enlaces a archivos</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Notas sobre la implementaci√≥n de .NET</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Usando disponer</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Usando cerradura</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Almacenar m√°scaras en la memoria</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Notas sobre la implementaci√≥n de JavaScript</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Minificaci√≥n</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Minificaci√≥n manual</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Minificaci√≥n Automatizada</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Modos de depuraci√≥n y liberaci√≥n</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Propiedad crossOrigin</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Optimizaciones</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Usando los valores precalculados</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Convertir una imagen en una matriz de p√≠xeles</a> </li></ul></li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ejemplos de c√≥digo</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">General</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Detectar si una cadena es un n√∫mero</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Divisi√≥n entera</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Girar y voltear una imagen usando Canvas y Bitmap</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Carga de imagen s√≠ncrona y as√≠ncrona</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Solo script #</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Detectar el tipo y la versi√≥n de un navegador</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Renderizado de una l√≠nea de trazos</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Animaci√≥n de rotaci√≥n</a> </li></ul></li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Conclusi√≥n</a> </li></ul><br><br><h2 id="goal">  Gol </h2><br><p>  El desaf√≠o es implementar el collage de fotos y la funcionalidad de edici√≥n de fotos basada en filtros en el lado del cliente y, si es posible, tambi√©n en el lado del servidor.  Para empezar, cubrir√© c√≥mo se implementan los filtros y collages. </p><br><h3 id="description-of-filters">  Descripci√≥n de filtros </h3><br><p>  En el contexto de nuestro proyecto, <strong>un filtro</strong> es una serie de acciones realizadas en Photoshop y aplicadas a una foto en particular.  A continuaci√≥n se muestran los ejemplos de tales acciones: </p><br><ul><li>  Ajuste de brillo </li><li>  Ajuste de contraste </li><li>  Ajuste de saturaci√≥n </li><li>  Ajuste de curvas de color </li><li>  Enmascaramiento en diferentes modos </li><li>  Enmarcado </li><li>  ... </li></ul><br><p>  Necesitamos un cierto formato para describir estas acciones.  Claro, hay formatos comunes como JSON y XML, pero se decidi√≥ crear nuestro propio formato por las siguientes razones: </p><br><ul><li>  Necesidad de una arquitectura de c√≥digo independiente de la plataforma (.NET, JavaScript, WinPhone, etc.) </li><li>  Se necesita un formato de filtros simple no jer√°rquico, que facilite la escritura de un analizador </li><li>  Los datos XML y JSON consumen m√°s memoria (en este caso particular) </li></ul><br><p>  As√≠ es como se ve la secuencia de acciones para el filtro de <strong>pel√≠cula XPro</strong> : </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/y_/oy/ad/y_oyadt7qubbsa9an37h32ostqs.png"></div><br><p>  Adem√°s de editar una foto con un filtro, necesit√°bamos recortar y rotar la imagen.  S√≠, sab√≠a que hay complementos de jQuery para recortar y rotar im√°genes, pero parec√≠an estar sobrecargados y desviarse de la arquitectura universal del proyecto. </p><br><h3 id="description-of-collages">  Descripci√≥n de collages </h3><br><p>  <strong>Un collage</strong> es una disposici√≥n de varias fotos en miniatura en una sola foto completa (con o sin m√°scara).  Tambi√©n era necesario permitir a los usuarios arrastrar y soltar las im√°genes disponibles en el collage, cambiar su posici√≥n y escala.  Su collage puede verse as√≠: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/084/250/1f8/0842501f87761a3c128b5f117719b10c.jpg"></div><br><p> La funci√≥n de collage implica el uso de un formato simple para almacenar rect√°ngulos con coordenadas relativas de <code>0</code> a <code>1</code> , las direcciones de las fotos y los datos de modificaci√≥n de la imagen.  Las coordenadas relativas se utilizan porque las mismas transformaciones del lado del cliente se aplican a las im√°genes de gran tama√±o en el lado del servidor. </p><br><h2 id="implementation">  Implementaci√≥n </h2><br><p>  Tuvimos que elegir la plataforma que permitiera a los usuarios trabajar con filtros y collages. </p><br><h3 id="choosing-a-platform-for-photo-processing">  Elegir una plataforma para el procesamiento de fotos </h3><br><p>  Existen varias tecnolog√≠as de aplicaciones de Internet enriquecidas ( <strong>RIA</strong> ) como: </p><br><ul><li>  Adobe flash </li><li>  Microsoft Silverlight </li><li>  HTML 5 + JavaScript </li><li>  Cliente nativo </li></ul><br><p>  Por razones obvias, Flash y HTML son las √∫nicas tecnolog√≠as que merecen atenci√≥n, ya que el resto no son compatibles con plataformas cruzadas.  Adem√°s, el cliente Silverlight est√° comenzando a morir.  Aunque realmente me gusta el concepto de <del>  sal </del>  NaCl, desafortunadamente, esta tecnolog√≠a solo es compatible con el navegador Chrome y a√∫n no se sabe cu√°ndo ser√° compatible (y ser√° admitido) por otros navegadores populares.  <em>Nota de 2019: lo har√° y el nombre es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">WebAssembly</a> .</em> </p><br><p>  La elecci√≥n se hizo a favor de la plataforma HTML5 moderna y progresiva, cuya funcionalidad es actualmente compatible con iOS, en oposici√≥n a Flash.  Esta elecci√≥n tambi√©n se basa en el hecho de que hay muchas bibliotecas, que le permiten compilar el c√≥digo C # en Javascript.  Tambi√©n puede usar Visual Studio para este prop√≥sito.  Los detalles se dan a continuaci√≥n. </p><br><h3 id="translating-c-into-javascript">  Traducci√≥n de C # a Javascript </h3><br><p>  HTML 5 + JavaScript ha sido seleccionado como plataforma en la secci√≥n anterior.  Por lo tanto, nos deja una pregunta, si es posible escribir un c√≥digo C # universal que pueda compilarse tanto en .NET como en JavaScript. </p><br><p>  Por lo tanto, se encontraron varias bibliotecas para realizar la tarea: </p><br><ul><li>  Jsil </li><li>  Sharpkit </li><li>  Script # </li><li>  Y algunos otros disponibles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en GitHub</a> . </li></ul><br><p>  Como resultado, se decidi√≥ usar <strong>Script #</strong> debido al hecho de que JSIL trabaja directamente con ensamblajes y genera c√≥digo menos puro (aunque admite una gama m√°s amplia de caracter√≠sticas de lenguaje C #) y SharpKit es un producto comercial.  Para una comparaci√≥n detallada de estas herramientas, vea <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la pregunta sobre stackoverflow</a> . </p><br><p>  En resumen, ScriptSharp en comparaci√≥n con JavaScript escrito manualmente tiene los siguientes pros y contras: </p><br><h4 id="advantages">  Ventajas </h4><br><ul><li>  Posibilidad de escribir un c√≥digo C # universal que pueda compilarse en .NET y otras plataformas (WinPhone, Mono) </li><li>  Desarrollo en un lenguaje C # fuertemente tipado que admite OOP </li><li>  Soporte para funciones IDE (autocompletado y refactorizaci√≥n) </li><li>  Capacidad para detectar la mayor√≠a de los errores en la etapa de compilaci√≥n </li></ul><br><h4 id="disadvantages">  Desventajas </h4><br><ul><li>  Redundancia e irregularidad del c√≥digo JavaScript generado (debido a mscorlib). </li><li>  Compatibilidad solo con ISO-2 (sin sobrecarga de funciones o tipo, extensi√≥n e inferencia gen√©rica) </li></ul><br><h3 id="structure">  Estructura </h3><br><p>  El siguiente esquema puede ilustrar el proceso de compilaci√≥n del mismo c√≥digo C # en .NET y Javascript: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/8ba/bce/32c/8babce32c532d3b3954cdabebabb0e06.png" width="70%" alt="Traducci√≥n de C # a .NET y esquema de JavaScript"></div><br><p>  Aunque .NET y HTML5 son tecnolog√≠as completamente diferentes, tambi√©n tienen caracter√≠sticas similares.  Esto tambi√©n se aplica al trabajo con gr√°ficos.  Por ejemplo, .NET admite <strong>Bitmap</strong> , JavaScript admite su an√°logo: <strong>Canvas</strong> .  Lo mismo ocurre con los <strong>gr√°ficos</strong> , el <strong>contexto</strong> y las matrices de p√≠xeles.  Para combinarlo todo en un c√≥digo, se decidi√≥ desarrollar la siguiente arquitectura: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/89c/427/74c/89c42774cf90bdc873a0c34619cf7207.png" width="50%" alt="Contexto gr√°fico com√∫n de .NET y JavaScript"></div><br><p>  Por supuesto, no se limita a dos plataformas.  Como seguimiento, se planea agregar soporte para WinPhone, y luego, tal vez, Android e iOS. </p><br><p>  Cabe se√±alar que hay dos tipos de operaciones gr√°ficas: </p><br><ul><li>  <strong>Uso de funciones API</strong> ( <code>DrawImage</code> , <code>Arc</code> , <code>MoveTo</code> , <code>LineTo</code> ).  El alto rendimiento y el soporte para la aceleraci√≥n de hardware son importantes ventajas competitivas.  El inconveniente es que se pueden implementar de manera diferente en diferentes plataformas. </li><li>  <strong>Pixel por pixel.</strong>  El soporte para la implementaci√≥n de cualquier efecto y la cobertura multiplataforma se encuentran entre los beneficios.  La desventaja es el bajo rendimiento.  Sin embargo, puede mitigar las desventajas mediante paralelizaci√≥n, sombreadores y tablas precalculadas (lo discutiremos m√°s adelante en la pr√≥xima secci√≥n sobre optimizaci√≥n). </li></ul><br><p>  Como puede ver, la clase abstracta <strong>Graphics</strong> describe todos los m√©todos para trabajar con gr√°ficos;  Estos m√©todos se implementan para varias plataformas en la clase derivada.  Los siguientes alias tambi√©n se escribieron para abstraer de las clases Bitmap y Canvas.  La versi√≥n de WinPhone tambi√©n usa un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">patr√≥n adaptador</a> . </p><br><h4 id="using-alias">  Usando alias </h4><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP using System.Html; using System.Html.Media.Graphics; using System.Runtime.CompilerServices; using Bitmap = System.Html.CanvasElement; using Graphics = System.Html.Media.Graphics.CanvasContext2D; using ImageData = System.Html.Media.Graphics.ImageData; using Image = System.Html.ImageElement; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> DOTNET using System.Drawing; using System.Drawing.Imaging; using System.Drawing.Drawing2D; using Bitmap = System.Drawing.Bitmap; using Graphics = System.Drawing.Graphics; using ImageData = System.Drawing.Imaging.BitmapData; using Image = System.Drawing.Bitmap; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><p>  Desafortunadamente, es imposible crear alias para tipos y matrices inseguros, en otras palabras, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Alias ‚Äã‚Äãpara puntero (byte *) en C #</a> : </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> PixelArray = <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>*, <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> PixelArray = <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]</code> </pre> <br><p>  Para realizar un procesamiento r√°pido de p√≠xeles utilizando el c√≥digo C # no administrado, al mismo tiempo que lo compilamos en Script #, presentamos el siguiente esquema con la ayuda de directivas: </p><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP PixelArray data = context.GetPixelArray(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> DOTNET byte* data = context.GetPixelArray(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><p>  La matriz de <code>data</code> se utiliza posteriormente para implementar varias operaciones de p√≠xel por p√≠xel (como enmascaramiento, ojo de pez, ajuste de saturaci√≥n, etc.), tanto en paralelo como no. </p><br><h4 id="links-to-files">  Enlaces a archivos </h4><br><p>  Se agrega un proyecto separado a la soluci√≥n para cada plataforma, pero, por supuesto, Mono, Script # e incluso Silverlight no pueden hacer referencia a los ensamblados habituales de .NET.  Afortunadamente, Visual Studio tiene un mecanismo para agregar enlaces a archivos, que le permite reutilizar el mismo c√≥digo en diferentes proyectos. </p><br><p>  Las directivas del compilador ( <code>DOTNET</code> , <code>SCRIPTSHARP</code> ) se definen en las propiedades del proyecto en S√≠mbolos de compilaci√≥n condicional. </p><br><h3 id="notes-on-net-implementation">  Notas sobre la implementaci√≥n de .NET </h3><br><p>  Las abstracciones y alias anteriores nos ayudaron a escribir el c√≥digo C # con baja redundancia.  Adem√°s, quiero se√±alar los problemas con las plataformas .NET y JavaScript que enfrentamos al desarrollar el c√≥digo de la soluci√≥n. </p><br><h4 id="using-dispose">  Usando disponer </h4><br><p>  Tenga en cuenta que la inclusi√≥n de cualquier instancia de una clase C #, que implemente la interfaz <code>IDisposable</code> , requiere llamar al m√©todo <strong><code>Dispose</code></strong> o aplicar la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">instrucci√≥n Using</a> .  En este proyecto, estas clases son Bitmap y Contexto.  Lo que he dicho anteriormente no es solo la teor√≠a, en realidad tiene una aplicaci√≥n pr√°ctica: el procesamiento de una gran cantidad de fotos de gran tama√±o (hasta 2400 x 2400 ppp) en ASP.NET Developer Server x86 result√≥ en una excepci√≥n de memoria insuficiente.  El problema se resolvi√≥ despu√©s de agregar <code>Dispose</code> en los lugares correctos.  En el siguiente art√≠culo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">20 se</a> ofrecen otros consejos √∫tiles sobre la manipulaci√≥n de im√°genes en el art√≠culo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">20 Errores de cambio de tama√±o de imagen</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">p√©rdida de memoria .NET: Eliminar o no, esa es la pregunta de 1 GB</a> . </p><br><h4 id="using-lock">  Usando cerradura </h4><br><p>  En JavaScript, hay una diferencia entre la imagen ya cargada con la etiqueta <code>img</code> , para la que puede especificar el origen y el evento de carga, y el lienzo etiquetado con <code>canvas</code> , en el que puede dibujar algo.  En .NET, estos elementos est√°n representados por la misma clase de <code>Bitmap</code> .  Por lo tanto, los alias Bitmap e Image en .NET apuntan a la misma clase <code>System.Drawing.Bitmap</code> . Bitmap como se muestra arriba. </p><br><p>  Sin embargo, esta divisi√≥n en <code>img</code> y <code>canvas</code> en JavaScript tambi√©n fue muy √∫til en la versi√≥n .NET.  El punto es que los filtros usan m√°scaras precargadas de diferentes hilos;  por lo tanto, se requiere el patr√≥n de <strong>bloqueo</strong> para evitar la excepci√≥n durante la sincronizaci√≥n (la imagen se copia con <strong>bloqueo</strong> y el resultado se usa sin bloqueo): </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CloneImage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Image image</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP Bitmap result = (Bitmap)Document.CreateElement("canvas"); result.Width = image.Width; result.Height = image.Height; Graphics context = (Graphics)result.GetContext(Rendering.Render2D); context.DrawImage(image, 0, 0); return result; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> Bitmap result; lock (image) result = new Bitmap(image); return result; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre> <br><p>  Despu√©s de todo, el <strong>bloqueo</strong> tambi√©n debe usarse al acceder a las propiedades de un objeto sincronizado (de hecho, cualquier propiedad es un m√©todo). </p><br><h4 id="storing-masks-in-memory">  Almacenar m√°scaras en la memoria </h4><br><p>  Para acelerar el procesamiento, todas las m√°scaras potencialmente utilizadas para los filtros se cargan en la memoria cuando se inicia el servidor.  <code>‚âà24 MB</code> del formato de la m√°scara, el mapa de bits cargado en el servidor usa <code>4 * 2400 * 2400</code> o <code>‚âà24 MB</code> de memoria (el tama√±o m√°ximo de la imagen es <code>2400 * 2400</code> ; el n√∫mero de bytes por p√≠xel es 4).  Todas las m√°scaras para filtros (‚âà30) y collages (40) consumir√°n 1,5 GB, lo que no es mucho para el servidor;  sin embargo, a medida que crece el n√∫mero de m√°scaras, esta cantidad puede aumentar significativamente.  En el futuro, posiblemente utilizaremos t√©cnicas de compresi√≥n para las m√°scaras almacenadas en la memoria (en formatos .jpg y .png) seguidas de descompresi√≥n cuando sea necesario.  En realidad, el tama√±o se puede reducir hasta 300 veces.  Una ventaja adicional de este enfoque es que la copia de las im√°genes comprimidas es m√°s r√°pida en comparaci√≥n con las grandes;  por lo tanto, la operaci√≥n de <strong>bloqueo</strong> tomar√° menos tiempo y los hilos se bloquear√°n con menos frecuencia. </p><br><h3 id="notes-on-javascript-implementation">  Notas sobre la implementaci√≥n de JavaScript </h3><br><h4 id="minification">  Minificaci√≥n </h4><br><p>  Me negu√© a usar el t√©rmino "ofuscaci√≥n" por la siguiente raz√≥n: este t√©rmino apenas es aplicable a un lenguaje de c√≥digo abierto, que en nuestro caso es JavaScript.  Sin embargo, el anonimato de los identificadores puede alterar la legibilidad y la l√≥gica del c√≥digo.  Y lo m√°s importante, esta t√©cnica reducir√° significativamente el tama√±o del script (la versi√≥n comprimida es is80 KB). </p><br><p>  Hay dos enfoques para la minificaci√≥n de JavaScript: </p><br><ul><li>  <strong>Minificaci√≥n manual,</strong> que se realiza en la etapa de generaci√≥n usando ScriptSharp. </li><li>  <strong>Minificaci√≥n automatizada,</strong> que se realiza despu√©s de la etapa de generaci√≥n utilizando herramientas externas como Google Closure Compiler, Yui y otras herramientas. </li></ul><br><h5 id="manual-minification">  Minificaci√≥n manual </h5><br><p>  Para acortar los nombres de m√©todos, clases y atributos, utilizamos esta sintaxis antes de la declaraci√≥n de las entidades mencionadas anteriormente.  Por supuesto, no hay necesidad de hacerlo si est√° trabajando con m√©todos que se invocan desde scripts externos y clases (p√∫blicas). </p><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP &amp;&amp; !DEBUG [ScriptName("a0")] #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><p>  De todos modos, las variables locales no pudieron ser minimizadas.  Estas construcciones contaminan el c√≥digo y perjudican la legibilidad del c√≥digo, lo que tambi√©n es una desventaja grave.  Sin embargo, esta t√©cnica puede reducir significativamente la cantidad de c√≥digo JavaScript generado y tambi√©n estropearlo. </p><br><p>  Otra desventaja es que debe vigilar esos nombres cortos si cambian el nombre del m√©todo y los nombres de campo (especialmente, los nombres anulados en las clases secundarias) porque en este caso Script # no se preocupar√° por los nombres repetitivos.  Sin embargo, no permitir√° clases duplicadas. </p><br><p>  Por cierto, la funcionalidad de minificaci√≥n para m√©todos y campos privados e internos ya se agreg√≥ a la versi√≥n desarrollada del Script #. </p><br><h5 id="automated-minification">  Minificaci√≥n Automatizada </h5><br><p>  Aunque hay muchas herramientas para la minificaci√≥n de JavaScript, utilic√© el Compilador de cierre de Google por su marca y su buena calidad de compresi√≥n.  La desventaja de la herramienta de minificaci√≥n de Google es que no puede comprimir archivos CSS;  Por el contrario, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">YUI</a> cumple con este desaf√≠o con √©xito.  De hecho, Script # tambi√©n puede minimizar los scripts pero maneja este desaf√≠o mucho peor que Google Closure. </p><br><p>  La herramienta de minificaci√≥n de Google tiene varios niveles de compresi√≥n: espacios en blanco, simples y avanzados.  Elegimos el nivel simple para el proyecto;  aunque, el nivel Avanzado nos permite lograr la m√°xima calidad de compresi√≥n, requiere un c√≥digo escrito de tal manera que los m√©todos sean accesibles desde fuera de la clase.  Esta minificaci√≥n se realiz√≥ parcialmente de forma manual utilizando Script #. </p><br><h4 id="debug-and-release-modes">  Modos de depuraci√≥n y liberaci√≥n </h4><br><p>  Las bibliotecas de depuraci√≥n y lanzamiento se agregaron a las p√°ginas ASP.NET de la siguiente manera: </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Gfranq.JavaScriptFilters.HtmlHelper.IsDebug</span></span></span><span class="hljs-tag">) { %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/mscorlib.debug.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/imgProcLib.debug.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> } </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">else</span></span></span><span class="hljs-tag"> { %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/mscorlib.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/imgProcLib.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> } %&gt;</span></span></code> </pre> <br><p>  En este proyecto, minimizamos los scripts y los archivos de descripci√≥n de filtro. </p><br><h4 id="crossorigin-property">  Propiedad crossOrigin </h4><br><p>  Para acceder a los p√≠xeles de alguna imagen en particular, primero debemos convertirla al lienzo.  Pero esto puede conducir a un error de Seguridad de solicitud de origen cruzado (CORS).  En nuestro caso, el problema se resolvi√≥ de la siguiente manera: </p><br><ul><li>  Establecer el <code>crossOrigin = ''</code> en el lado del servidor. </li><li>  Agregar un encabezado espec√≠fico al paquete HTTP en el lado del servidor. </li></ul><br><p>  Como ScriptSharp no admite esta propiedad para elementos img, se escribi√≥ el siguiente c√≥digo: </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Imported</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AdvImage</span></span> { [IntrinsicProperty] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CrossOrigin { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { } } }</code> </pre> <br><p>  Luego, lo usaremos as√≠: </p><br><pre> <code class="plaintext hljs">((AdvImage)(object)result).CrossOrigin = "";</code> </pre> <br><p>  Esta t√©cnica le permite agregar cualquier caracter√≠stica al objeto sin errores de compilaci√≥n.  En particular, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">propiedad <code>wheelDelta</code> a√∫n no est√° implementada</a> en ScriptSharp (al menos en la versi√≥n 0.7.5).  Esta propiedad indica la cantidad de la rueda de desplazamiento, que se utiliza para crear collages.  Por eso se implement√≥ de esta manera.  Un truco tan sucio con las propiedades no es bueno;  normalmente, necesita hacer cambios al proyecto.  Pero solo para el registro, a√∫n no he descubierto una manera de compilar ScriptSharp desde la fuente. </p><br><p>  Dichas im√°genes requieren que el servidor devuelva los siguientes encabezados en sus encabezados de respuesta (en Global.asax): </p><br><pre> <code class="cs hljs">Response.AppendHeader(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Origin"</span></span>, <span class="hljs-string"><span class="hljs-string">"\*"</span></span>);</code> </pre> <br><p>  Para obtener m√°s informaci√≥n sobre Cross Origin Request Security, visite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://enable-cors.org/</a> . </p><br><h3 id="optimizations">  Optimizaciones </h3><br><h4 id="using-the-precalculated-values">  Usando los valores precalculados </h4><br><p>  Utilizamos la optimizaci√≥n para algunas operaciones, como el brillo, el contraste y el ajuste de las curvas de color mediante el c√°lculo preliminar de los componentes de color resultantes (r, g, b) para todos los valores posibles y el uso posterior de las matrices obtenidas para cambiar los colores de p√≠xeles directamente .  Cabe se√±alar que este tipo de optimizaci√≥n es adecuada solo para operaciones en las que el color del p√≠xel resultante no se ve afectado por el p√≠xel adyacente. </p><br><p>  El c√°lculo de los componentes de color resultantes para todos los valores posibles: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">256</span></span>; i++) { r[i] = ActionFuncR(i); g[i] = ActionFuncG(i); b[i] = ActionFuncB(i); }</code> </pre> <br><p>  El uso de componentes de color precalculados: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; data.Length; i += <span class="hljs-number"><span class="hljs-number">4</span></span>) { data[i] = r[data[i]]; data[i + <span class="hljs-number"><span class="hljs-number">1</span></span>] = g[data[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]]; data[i + <span class="hljs-number"><span class="hljs-number">2</span></span>] = b[data[i + <span class="hljs-number"><span class="hljs-number">2</span></span>]]; }</code> </pre> <br><p>  Si tales operaciones de tabla van una por una, entonces no hay necesidad de calcular im√°genes intermedias: puede pasar solo las matrices de componentes de color.  Como el c√≥digo funcion√≥ bastante r√°pido tanto en el lado del cliente como del servidor, se decidi√≥ dejar a un lado la implementaci√≥n de esta optimizaci√≥n.  Adem√°s, la optimizaci√≥n caus√≥ algunos comportamientos no deseados.  Sin embargo, le dar√© una lista de la optimizaci√≥n: </p><br><table><tbody><tr><td>  C√≥digo original </td><td>  C√≥digo optimizado </td></tr><tr><td>  `` `cs <br>  // C√°lculo de valores para la primera tabla. <br>  para (int i = 0; i &lt;256; i ++) <br>  { <br>  r [i] = ActionFunc1R (i); <br>  g [i] = ActionFunc1G (i); <br>  b [i] = ActionFunc1B (i); <br>  } <br>  // ... <br><br>  // C√°lculo de la imagen intermedia resultante. <br>  para (int i = 0; i &lt;data.Length; i + = 4) <br>  { <br>  datos [i] = r [datos [i]]; <br>  datos [i + 1] = g [datos [i + 1]]; <br>  datos [i + 2] = b [datos [i + 2]]; <br>  } <br>  // ... <br><br>  // C√°lculo de valores para la segunda tabla. <br>  para (int i = 0; i &lt;256; i ++) <br>  { <br>  r [i] = ActionFunc2R (i); <br>  g [i] = ActionFunc2G (i); <br>  b [i] = ActionFunc2B (i); <br>  } <br>  // ... <br><br>  // C√°lculo de la imagen resultante. <br>  para (int i = 0; i &lt;data.Length; i + = 4) <br>  { <br>  datos [i] = r [datos [i]]; <br>  datos [i + 1] = g [datos [i + 1]]; <br>  datos [i + 2] = b [datos [i + 2]]; <br>  } <br>  `` `` <br><br></td><td>  `` `cs <br>  // C√°lculo de valores para la primera tabla. <br>  para (int i = 0; i &lt;256; i ++) <br>  { <br>  r [i] = ActionFunc1R (i); <br>  g [i] = ActionFunc1G (i); <br>  b [i] = ActionFunc1B (i); <br>  } <br>  // ... <br><br>  // C√°lculo de valores para la segunda tabla. <br>  tr = r.Clone (); <br>  tg = g.Clone (); <br>  tb = b.Clone (); <br>  para (int i = 0; i &lt;256; i ++) <br>  { <br>  r [i] = tr [ActionFunc2R (i)]; <br>  g [i] = tg [ActionFunc2G (i)]; <br>  b [i] = tb [ActionFunc2B (i)]; <br>  } <br>  // ... <br><br>  // C√°lculo de la imagen resultante. <br>  para (int i = 0; i &lt;data.Length; i + = 4) <br>  { <br>  datos [i] = r [datos [i]]; <br>  datos [i + 1] = g [datos [i + 1]]; <br>  datos [i + 2] = b [datos [i + 2]]; <br>  } <br>  `` `` <br><br></td></tr></tbody></table><br><p>  Pero incluso esto no es todo.  Si observa la tabla de la derecha, notar√° que se crean nuevas matrices utilizando el m√©todo <code>Clone</code> .  En realidad, puede cambiar los punteros a las matrices antiguas y nuevas en lugar de copiar la matriz en s√≠ (esto recuerda la analog√≠a del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">doble almacenamiento en b√∫fer</a> ). </p><br><h4 id="converting-an-image-to-an-array-of-pixels">  Convertir una imagen en una matriz de p√≠xeles </h4><br><p>  El generador de perfiles de JavaScript en Google Chrome revel√≥ que la funci√≥n <code>GetImageData</code> (que se utiliza para convertir el lienzo en la matriz de p√≠xeles) se ejecuta el tiempo suficiente.  Esta informaci√≥n, por cierto, se puede encontrar en varios art√≠culos sobre la optimizaci√≥n de Canvas en JavaScript. </p><br><p>  Sin embargo, el n√∫mero de llamadas de esta funci√≥n se puede minimizar.  Es decir, podemos usar la misma matriz de p√≠xeles para las operaciones de p√≠xel por p√≠xel, por analog√≠a con la optimizaci√≥n anterior. </p><br><h2 id="code-examples">  Ejemplos de c√≥digo </h2><br><p>  En los ejemplos a continuaci√≥n, proporcionar√© los fragmentos de c√≥digo que encontr√© interesantes y √∫tiles.  Para evitar que el art√≠culo sea demasiado largo, he escondido los ejemplos debajo de un spoiler. </p><br><h3 id="general">  General </h3><br><h4 id="detecting-whether-a-string-is-a-number">  Detectar si una cadena es un n√∫mero </h4><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsNumeric</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> !SCRIPTSHARP return ((Number)int.Parse(n)).ToString() != "NaN"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> double number; return double.TryParse(n, out number); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre> <br><h4 id="integer-division">  Divisi√≥n entera </h4><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Div</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> k</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = n / k; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP result = Math.Floor(n / k); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> return result; }</span></span></code> </pre> <br><h4 id="rotating-and-flipping-an-image-using-canvas-and-bitmap">  Girar y voltear una imagen usando Canvas y Bitmap </h4><br><p>  Tenga en cuenta que en las im√°genes de lienzo html5 se pueden girar 90 y 180 grados solo con matrices, mientras que .NET proporciona una funcionalidad mejorada.  Por lo tanto, se escribi√≥ una funci√≥n precisa apropiada para trabajar con p√≠xeles. </p><br><p>  Tambi√©n vale la pena se√±alar que una rotaci√≥n de 90 grados en cualquier lado en la versi√≥n .NET puede devolver resultados incorrectos.  Por lo tanto, debe crear un nuevo <code>Bitmap</code> despu√©s de usar la funci√≥n <code>RotateFlip</code> . </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo fuente</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RotateFlip</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bitmap bitmap, RotFlipType rotFlipType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP int t, i4, j4, w, h, c; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.RotateNoneFlipNone) return bitmap; GraphicsContext context; PixelArray data; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.RotateNoneFlipX) { context = GraphicsContext.GetContext(bitmap); data = context.GetPixelArray(); w = bitmap.Width; h = bitmap.Height; for (int i = 0; i &lt; h; i++) { c = (i + 1) * w * 4 - 4; for (int j = 0; j &lt; w / 2; j++) { i4 = (i * w + j) * 4; j4 = j * 4; t = (int)data[i4]; data[i4] = data[c - j4]; data[c - j4] = t; t = (int)data[i4 + 1]; data[i4 + 1] = data[c - j4 + 1]; data[c - j4 + 1] = t; t = (int)data[i4 + 2]; data[i4 + 2] = data[c - j4 + 2]; data[c - j4 + 2] = t; t = (int)data[i4 + 3]; data[i4 + 3] = data[c - j4 + 3]; data[c - j4 + 3] = t; } } context.PutImageData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate180FlipNone || rotFlipType == RotFlipType.Rotate180FlipX) { context = GraphicsContext.GetContext(bitmap); data = context.GetPixelArray(); w = bitmap.Width; h = bitmap.Height; c = w * 4 - 4; int dlength4 = data.Length - 4; for (int i = 0; i &lt; data.Length / 4 / 2; i++) { i4 = i * 4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate180FlipNone) j4 = i4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> j4 = (Math.Truncate((double)i / w) * w + (w - i % w)) * 4; t = (int)data[j4]; data[j4] = data[dlength4 - i4]; data[dlength4 - i4] = t; t = (int)data[j4 + 1]; data[j4 + 1] = data[dlength4 - i4 + 1]; data[dlength4 - i4 + 1] = t; t = (int)data[j4 + 2]; data[j4 + 2] = data[dlength4 - i4 + 2]; data[dlength4 - i4 + 2] = t; t = (int)data[j4 + 3]; data[j4 + 3] = data[dlength4 - i4 + 3]; data[dlength4 - i4 + 3] = t; } context.PutImageData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { Bitmap tempBitmap = PrivateUtils.CreateCloneBitmap(bitmap); GraphicsContext tempContext = GraphicsContext.GetContext(tempBitmap); PixelArray temp = tempContext.GetPixelArray(); t = bitmap.Width; bitmap.Width = bitmap.Height; bitmap.Height = t; context = GraphicsContext.GetContext(bitmap); data = context.GetPixelArray(); w = tempBitmap.Width; h = tempBitmap.Height; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate90FlipNone || rotFlipType == RotFlipType.Rotate90FlipX) { c = w * h - w; for (int i = 0; i &lt; temp.Length / 4; i++) { t = Math.Truncate((double)i / h); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate90FlipNone) i4 = i * 4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> i4 = (t * h + (h - i % h)) * 4; j4 = (c - w * (i % h) + t) * 4; //j4 = (w * (h - 1 - i4 % h) + i4 / h) * 4; data[i4] = temp[j4]; data[i4 + 1] = temp[j4 + 1]; data[i4 + 2] = temp[j4 + 2]; data[i4 + 3] = temp[j4 + 3]; } } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate270FlipNone || rotFlipType == RotFlipType.Rotate270FlipX) { c = w - 1; for (int i = 0; i &lt; temp.Length / 4; i++) { t = Math.Truncate((double)i / h); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate270FlipNone) i4 = i * 4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> i4 = (t * h + (h - i % h)) * 4; j4 = (c + w * (i % h) - t) * 4; // j4 = w * (1 + i4 % h) - i4 / h - 1; data[i4] = temp[j4]; data[i4 + 1] = temp[j4 + 1]; data[i4 + 2] = temp[j4 + 2]; data[i4 + 3] = temp[j4 + 3]; } } context.PutImageData(); } return bitmap; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> DOTNET Bitmap result = null; switch (rotFlipType) { case RotFlipType.RotateNoneFlipNone: result = bitmap; break; case RotFlipType.Rotate90FlipNone: bitmap.RotateFlip(RotateFlipType.Rotate90FlipNone); result = new Image(bitmap); bitmap.Dispose(); break; case RotFlipType.Rotate270FlipNone: bitmap.RotateFlip(RotateFlipType.Rotate270FlipNone); result = new Image(bitmap); bitmap.Dispose(); break; case RotFlipType.Rotate180FlipNone: bitmap.RotateFlip(RotateFlipType.Rotate180FlipNone); result = bitmap; break; case RotFlipType.RotateNoneFlipX: bitmap.RotateFlip(RotateFlipType.RotateNoneFlipX); result = bitmap; break; case RotFlipType.Rotate90FlipX: bitmap.RotateFlip(RotateFlipType.Rotate90FlipX); result = new Image(bitmap); bitmap.Dispose(); break; case RotFlipType.Rotate180FlipX: bitmap.RotateFlip(RotateFlipType.Rotate180FlipX); result = bitmap; break; case RotFlipType.Rotate270FlipX: bitmap.RotateFlip(RotateFlipType.Rotate270FlipX); result = new Image(bitmap); bitmap.Dispose(); break; } return result; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre> </div></div><br><h4 id="synchronous-and-asynchronous-image-loading">  Carga de imagen s√≠ncrona y as√≠ncrona </h4><br><p>  Tenga en cuenta que en la versi√≥n Script # especificamos una funci√≥n diferente <code>CollageImageLoad</code> , que se llama despu√©s de cargar una imagen, mientras que en la versi√≥n .NET estos procesos tienen lugar simult√°neamente (desde un sistema de archivos o Internet). </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo fuente</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CollageData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> smallMaskPath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bigMaskPath, List&lt;CollageDataPart&gt; dataParts</span></span></span><span class="hljs-function">)</span></span> { SmallMaskImagePath = smallMaskPath; BigMaskImagePath = bigMaskPath; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP CurrentMask = PrivateUtils.CreateEmptyImage(); CurrentMask.AddEventListener("load", CollageImageLoad, false); CurrentMask.Src = CurrentMaskImagePath; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> CurrentMask = PrivateUtils.LoadBitmap(CurrentMaskImagePath); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!CurrentMaskImagePath.Contains("http://") &amp;&amp; !CurrentMaskImagePath.Contains("https://")) CurrentMask = Bitmap(CurrentMaskImagePath); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { var request = WebRequest.Create(CurrentMaskImagePath); using (var response = request.GetResponse()) using (var stream = response.GetResponseStream()) CurrentMask = (Bitmap)Bitmap.FromStream(stream); } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> DataParts = dataParts; }</span></span></code> </pre> </div></div><br><h3 id="script-only">  Solo script # </h3><br><h4 id="detecting-the-type-and-version-of-a-browser">  Detectar el tipo y la versi√≥n de un navegador </h4><br><p>  Esta funci√≥n se utiliza para determinar las capacidades de arrastrar y soltar en diferentes navegadores.  Intent√© usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">modernizr</a> , pero me devolvi√≥ ese Safari y (en mi caso, era una versi√≥n Win) IE9 lo implement√≥.  En la pr√°ctica, estos navegadores no implementan las capacidades de arrastrar y soltar correctamente. </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo fuente</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> BrowserVersion { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { DetectBrowserTypeAndVersion(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _browserVersion; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DetectBrowserTypeAndVersion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_browserDetected) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> userAgent = Window.Navigator.UserAgent.ToLowerCase(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"opera"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Opera; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"chrome"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Chrome; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"safari"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Safari; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"firefox"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Firefox; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"msie"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> numberIndex = userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"msie"</span></span>) + <span class="hljs-number"><span class="hljs-number">5</span></span>; _browser = BrowserType.IE; _browserVersion = userAgent.Substring(numberIndex, userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">';'</span></span>, numberIndex)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _browser = BrowserType.Unknown; _browserDetected = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre> </div></div><br><h4 id="rendering-a-dash-dot-line">  Renderizado de una l√≠nea de trazos </h4><br><p>  Este c√≥digo se usa para un rect√°ngulo para recortar im√°genes.  Gracias por las ideas a todos los que respondieron a esta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pregunta en stackoverflow</a> . </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo fuente</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DrawDahsedLine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GraphicsContext context, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] dashArray</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dashArray == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) dashArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>] { <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dashCount = dashArray.Length; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> dx = x2 - x1; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> dy = y2 - y1; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> xSlope = Math.Abs(dx) &gt; Math.Abs(dy); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> slope = xSlope ? dy / dx : dx / dy; context.MoveTo(x1, y1); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> distRemaining = Math.Sqrt(dx * dx + dy * dy); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dashIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (distRemaining &gt;= <span class="hljs-number"><span class="hljs-number">0.1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dashLength = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)Math.Min(distRemaining, dashArray[dashIndex % dashCount]); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> step = Math.Sqrt(dashLength * dashLength / (<span class="hljs-number"><span class="hljs-number">1</span></span> + slope * slope)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xSlope) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dx &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) step = -step; x1 += step; y1 += slope * step; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dy &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) step = -step; x1 += slope * step; y1 += step; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dashIndex % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>) context.LineTo(x1, y1); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> context.MoveTo(x1, y1); distRemaining -= dashLength; dashIndex++; } }</code> </pre> </div></div><br><h4 id="rotation-animation">  Animaci√≥n de rotaci√≥n </h4><br><p>  <code>setInterval</code> funci√≥n <code>setInterval</code> se usa para implementar la animaci√≥n de rotaci√≥n de imagen.  Tenga en cuenta que la imagen resultante se calcula durante la animaci√≥n para que no haya retrasos al final de la animaci√≥n. </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo fuente</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rotate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cw</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_rotating &amp;&amp; !_flipping) { _rotating = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; _cw = cw; RotFlipType oldRotFlipType = _curRotFlipType; _curRotFlipType = RotateRotFlipValue(_curRotFlipType, _cw); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> currentStep = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> stepCount = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(RotateFlipTimeSeconds * <span class="hljs-number"><span class="hljs-number">1000</span></span> / StepTimeTicks); Bitmap result = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; _interval = Window.SetInterval(<span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStep &lt; stepCount) { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> absAngle = GetAngle(oldRotFlipType) + currentStep / stepCount * Math.PI / <span class="hljs-number"><span class="hljs-number">2</span></span> * (_cw ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>); DrawRotated(absAngle); currentStep++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Window.ClearInterval(_interval); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) Draw(result); _rotating = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }, StepTimeTicks); result = GetCurrentTransformResult(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_rotating) Draw(result); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DrawRotated</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rotAngle</span></span></span><span class="hljs-function">)</span></span> { _resultContext.FillColor = FillColor; _resultContext.FillRect(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, _result.Width, _result.Height); _resultContext.Save(); _resultContext._graphics.Translate(_result.Width / <span class="hljs-number"><span class="hljs-number">2</span></span>, _result.Height / <span class="hljs-number"><span class="hljs-number">2</span></span>); _resultContext._graphics.Rotate(-rotAngle); _resultContext._graphics.Translate(-_origin.Width / <span class="hljs-number"><span class="hljs-number">2</span></span>, -_origin.Height / <span class="hljs-number"><span class="hljs-number">2</span></span>); _resultContext._graphics.DrawImage(_origin, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); _resultContext.Restore(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Draw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bitmap bitmap</span></span></span><span class="hljs-function">)</span></span> { _resultContext.FillColor = FillColor; _resultContext.FillRect(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, _result.Width, _result.Height); _resultContext.Draw2(bitmap, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((_result.Width - bitmap.Width) / <span class="hljs-number"><span class="hljs-number">2</span></span>), (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((_result.Height - bitmap.Height) / <span class="hljs-number"><span class="hljs-number">2</span></span>)); }</code> </pre> </div></div><br><h2 id="conclusion">  Conclusi√≥n </h2><br><p>  Este art√≠culo describe c√≥mo el lenguaje C # (que combina c√≥digo no administrado y compilaci√≥n para JavaScript) puede usarse para crear una soluci√≥n realmente multiplataforma.  A pesar del enfoque en .NET y JavaScript, la compilaci√≥n para Android, iOS (mediante Mono) y Windows Phone tambi√©n es posible en base a este enfoque, que, por supuesto, tiene sus dificultades.  El c√≥digo es un poco redundante debido a su universalidad, pero no afecta el rendimiento ya que las operaciones gr√°ficas generalmente toman mucho m√°s tiempo. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/440342/">https://habr.com/ru/post/440342/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../440328/index.html">La probabilidad de ganar un partido con la probabilidad conocida de ganar un punto II</a></li>
<li><a href="../440330/index.html">Brevemente sobre abstracciones</a></li>
<li><a href="../440332/index.html">Base de datos en las nubes: a qui√©n y por qu√© - la opini√≥n de los especialistas de Data Egret</a></li>
<li><a href="../440334/index.html">Webinar abierto "Desarrollo de sistemas altamente cargados en PHP"</a></li>
<li><a href="../440338/index.html">C√≥mo garantizar la disponibilidad de un servicio web en la nube en caso de falla del centro de datos</a></li>
<li><a href="../440344/index.html">InterNyet: c√≥mo se invent√≥ Internet en la Uni√≥n Sovi√©tica y por qu√© no funcion√≥</a></li>
<li><a href="../440346/index.html">A finales de febrero, Microsoft presentar√° gafas VR HoloLens 2</a></li>
<li><a href="../440350/index.html">Flying Bear Tornado 2: ha llegado un nuevo oso</a></li>
<li><a href="../440352/index.html">Hack masivo VKontakte [gusano XSS]</a></li>
<li><a href="../440354/index.html">Eventos digitales en Mosc√∫ del 18 al 24 de febrero</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>