<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèáüèæ üë©‚Äçüë©‚Äçüë¶‚Äçüë¶ üë©üèΩ‚Äçüíª Como adicionamos entradas ao mapa e reduzimos o tamanho das bases em 10% üõåüèø üèß üì¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No final do m√™s passado, o 2GIS come√ßou a exibir varandas. Mostramos as entradas para as organiza√ß√µes desde 2013, e as entradas parecem ser as mesmas....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como adicionamos entradas ao mapa e reduzimos o tamanho das bases em 10%</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/415263/"><img src="https://habrastorage.org/webt/en/6k/fp/en6kfpoagwhj42loeubjzo0rzo0.jpeg"><br><br>  No final do m√™s passado, o 2GIS come√ßou a exibir varandas.  Mostramos as entradas para as organiza√ß√µes desde 2013, e as entradas parecem ser as mesmas.  Ent√£o, por que agora?  Todos os produtos e processos internos est√£o prontos, tudo o que voc√™ precisa fazer √© adicionar um pouco mais e corrigir a exibi√ß√£o na interface do usu√°rio. <br><br>  Al√©m da resposta padr√£o "Havia outras prioridades", h√° tamb√©m uma n√£o muito padr√£o: "N√£o √© t√£o simples".  Este artigo √© sobre quais eram as dificuldades e como as resolvemos. <br><a name="habracut"></a><br>  Em primeiro lugar, a entrada n√£o √© a entrada.  Assim, em uma entrada pode levar v√°rias entradas, geralmente de lados diferentes do edif√≠cio.  A defini√ß√£o de "bloco de apartamentos (multin√≠vel) com uma entrada comum" tamb√©m est√° incorreta.  Acontece que uma entrada leva ao primeiro andar da entrada e a outra - ao segundo e subsequentes andares. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zz/w7/pr/zzw7prchtb-1ictjkzvrfd6c_-8.png" alt="Entrada com duas entradas"></div><br>  Em segundo lugar, quero procurar entradas. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yb/ty/ut/ybtyutk7jllplorjkmqiywob1ha.png" alt="Entradas nos resultados da pesquisa"></div><br>  Esta √© uma oportunidade bastante procurada, pois as entradas nem sempre est√£o localizadas de maneira √≥bvia. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/fm/j7/41/fmj741efgjyhdj29y3udi2lsjym.png" alt="Casa com numera√ß√£o de entrada n√£o mais √≥bvia"></div><br>  Al√©m dos n√∫meros de entrada, tamb√©m existem nomes (geralmente de uma √∫nica letra). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ef/wk/2d/efwk2d9a_gsaw5vokxqoyiqzuzm.png" alt="As letras nos nomes das varandas"></div><br>  Ou mesmo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">em Kaliningrado</a> - um endere√ßo separado √© atribu√≠do exatamente √† escada. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rw/iz/4w/rwiz4wywzkk_nnjll6xzrpy5k1o.png" alt="Numera√ß√£o independente de entradas no Kaliningrado"></div><br>  Em terceiro lugar, decidimos que, se fiz√©ssemos uma busca por entradas, por que n√£o apoiar imediatamente a busca pelo n√∫mero do apartamento.  Eles decidiram - e coletaram as s√©ries de apartamentos, no entanto, at√© agora sem um encaderna√ß√£o no ch√£o.  Assim como nas entradas, os apartamentos podem ter n√£o apenas nomes num√©ricos (na maioria das vezes existem variantes com a letra "a"), e os intervalos est√£o longe de ser sempre cont√≠nuos.  Nas casas antigas de S√£o Petersburgo, a numera√ß√£o √© bastante estranha: os apartamentos 1 e 3 podem estar na mesma entrada e o apartamento 2 pode estar na parte oposta do edif√≠cio. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m2/se/uh/m2seuh3ovc_5ob8b1ulcdlru8x8.jpeg" alt="Entrada t√≠pica da antiga Petersburgo"></div><br><div class="spoiler">  <b class="spoiler_title">Digress√£o l√≠rica sobre valida√ß√£o de dados</b> <div class="spoiler_text">  N√£o tente fazer a valida√ß√£o dos dados coletados de maneira muito inteligente - na capital do norte, h√° casos em que voc√™ pode entrar em um apartamento de v√°rias entradas e, em alguns assentamentos europeus, o endere√ßo cont√©m, al√©m da casa, o nome da entrada e o n√∫mero do apartamento nessa entrada.  Peter tamb√©m agrada com um edif√≠cio com duas oitavas entradas. <br></div></div><br>  Quarto, quero mostrar sempre as entradas no mapa, e n√£o apenas quando estudamos as informa√ß√µes de uma casa ou entrada em particular. <br><br>  E, finalmente, existem muitas entradas - de acordo com a estimativa atual, existem cerca de cem mil delas somente em Moscou.  A primeira avalia√ß√£o "nos dedos" deu algumas figuras astron√¥micas - cometemos um erro uma vez a cada seis vezes para o lado maior. <br><br>  <b>Conclus√µes:</b> <br><br><ul><li>  Precisamos de uma entidade adicional, com seu pr√≥prio nome, que contenha uma lista de faixas de apartamentos e √†s quais as entradas do edif√≠cio possam ser anexadas. </li><li>  Procuraremos essa entidade e mostraremos para ela um cart√£o de informa√ß√µes separado. </li><li>  Somos obrigados a aumentar mais uma vez o tamanho dos dados baixados pelo aplicativo m√≥vel, ou mostrar esses dados apenas se houver uma conex√£o de rede, ou apresentar algo com o formato. </li></ul><br><h3>  Chegando √† solu√ß√£o </h3><br>  Os dois primeiros pontos exigem altera√ß√µes nos produtos internos e externos, mas isso √© uma rotina.  O √∫ltimo √© uma quest√£o completamente diferente.  Como n√£o gostamos de incomodar os usu√°rios, definimos uma restri√ß√£o: os dados devem estar dispon√≠veis offline e a adi√ß√£o deles n√£o deve aumentar o tamanho dos bancos de dados. <br><br>  Como  Por um lado, voc√™ precisa reduzir o tamanho atual dos dados; por outro, pode criar um formato para armazenar informa√ß√µes sobre entradas, para que a quantidade de dados adicionais seja m√≠nima. <br><br><h3>  Reduzir o volume de dados </h3><br>  Existem duas maneiras de reduzi-lo: <br><br><ul><li>  Observe atentamente os dados armazenados e tente encontrar algo que n√£o podemos fazer. </li><li>  Pense se √© poss√≠vel, de alguma forma, armazenar dados com mais efici√™ncia do que estamos fazendo agora. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Evolu√ß√£o do formato de armazenamento de dados antes da era das varandas</b> <div class="spoiler_text"><h4>  A primeira e mais f√°cil op√ß√£o </h4><br>  A maneira tradicional de salvar dados complexos √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">normaliz√°-</a> los, coloc√°-los em um banco de dados de tabelas e criar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√≠ndices</a> auxiliares.  Uma vez, o 2GIS fez exatamente isso, exceto para reduzir o tamanho, o conte√∫do de cada tabela foi classificado de modo que, sempre que poss√≠vel, os valores das c√©lulas coincidissem com os valores da linha anterior.  Armazenamos as colunas independentemente e colapsamos sequ√™ncias de valores id√™nticos. <br><br>  Um exemplo altamente simplificado de otimiza√ß√£o do armazenamento de uma tabela com edif√≠cios: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bh/jw/gy/bhjwgyi3kccb_sx2l4zho_pqlsy.png" alt="Um exemplo de armazenamento de tabela otimizada"></div><br>  A normaliza√ß√£o permite reduzir a redund√¢ncia, mas tamb√©m existe um lado negativo - para formar um elemento de interface do usu√°rio para algum objeto, √© necess√°rio fazer v√°rias consultas que acessam um grande n√∫mero de tabelas.  No entanto, na √©poca, essas tabelas eram usadas n√£o apenas para obter dados para exibi√ß√£o, mas para quase todas as tarefas, incluindo pesquisa de texto e v√°rios tipos de pesquisa de viagem.  Para todas essas tarefas, os dados normalizados nos permitiram reduzir a quantidade de informa√ß√µes processadas. <br><br>  Os dados para renderizar o mapa j√° tinham seu pr√≥prio formato bin√°rio e foram armazenados em um bloco separado.  Gradualmente, criamos formatos bin√°rios separados para acelerar a pesquisa de dire√ß√µes e pesquisas de texto.  Somente informa√ß√µes foram deixadas no banco de dados, que foi usado para exibir cart√µes de objetos, bem como para links de alguns objetos com outros. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yd/4k/jh/yd4kjhjwh0pjpbj8bqmvksnqngk.png" alt="Cart√µes e comunica√ß√µes"></div><br><h4>  Simplifique o trabalho </h4><br>  Como voc√™ pode simplificar o trabalho com dados?  Receba todos os dados necess√°rios para desenhar um cart√£o de uma s√≥ vez pelo identificador do objeto.  Como a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vers√£o online</a> j√° recebe todos os dados da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API</a> para uma solicita√ß√£o no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">formato JSON</a> , voc√™ pode ao mesmo tempo combinar os formatos usados ‚Äã‚Äãpor todos os nossos produtos. <br><br>  Os json's para exibi√ß√£o de cart√µes e as comunica√ß√µes precisam ser recebidas para um n√∫mero limitado de objetos, com o poder de v√°rias dezenas de cada vez.  Mas h√° cen√°rios em que atributos individuais precisam ser obtidos de uma s√≥ vez para amostras grandes, at√© centenas de milhares.  √â mais l√≥gico separar esses atributos em uma entidade separada com um formato de armazenamento separado - propriedades.  As propriedades podem ser do tipo e armazenadas com mais efici√™ncia em formato bin√°rio. <br><br>  Uma abordagem ing√™nua para armazenar o json √© usar um banco de dados de valores-chave.  Tome Moscou como exemplo, como o maior de nossos projetos.  Mesmo da forma mais simples poss√≠vel - para cada objeto o json √© armazenado, 8 bytes de identificador e um caractere delimitador - o diret√≥rio ter√° 1,9 GiB.  O tamanho resultante √© quase seis vezes maior que a op√ß√£o descrita anteriormente, e isso ainda est√° sem v√≠nculos e propriedades. <br><br>  N√≥s inflamos objetos deliberadamente, enchendo-os de informa√ß√µes sobre tudo o que √© necess√°rio para exibir seus cart√µes, mas voc√™ ainda precisa armazenar nomes de campos, aspas, v√≠rgulas e colchetes. <br><br><h4>  Compactar dados </h4><br>  A normaliza√ß√£o n√£o √© a √∫nica maneira de eliminar a redund√¢ncia.  A segunda maneira popular √© a compress√£o.  O arquivo lzma do nosso arquivo incrivelmente espesso leva apenas 55 MiB. <br><br>  Obviamente, n√£o podemos usar esse formato diretamente, pois para acessar um objeto arbitr√°rio, precisamos descompactar todos os dados armazenados anteriormente, e os arquivos lzma n√£o s√£o descomprimidos muito rapidamente. <br><br>  Como podemos obter acesso aleat√≥rio r√°pido, por um lado, e por outro lado, compactando os dados, reduzindo o tamanho do espa√ßo necess√°rio?  A resposta √© usar pagina√ß√£o. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ag/lk/jr/aglkjrbolu5w7cclmf-_cuqsjly.png" alt="Formato de armazenamento bin√°rio"></div><br>  Agora que os dados est√£o paginados, podemos compactar cada um individualmente.  Para acessar um local arbitr√°rio, precisamos descompactar e digitalizar a p√°gina, mas isso √© muito mais r√°pido do que descompactar e digitalizar o arquivo inteiro. <br><br>  Nesse formato, todos os dados s√£o armazenados - json'y, relacionamentos e propriedades.  Resta associar esses dados aos identificadores dos objetos.  Para cada identificador, precisamos armazenar um ou mais pares <i>&lt;n√∫mero de armazenamento, n√∫mero de dados no armazenamento&gt;</i> . <br><br><img src="https://habrastorage.org/webt/7b/db/tz/7bdbtzgxk03-5c189bv4sesw7b8.png" alt="Formato simplificado de relacionamento entre identificador de objeto e dados em armazenamentos"><br>  Todos os n√∫meros de s√©rie, compensa√ß√µes e tamanhos s√£o armazenados em um formato compactado semelhante ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">UTF-8</a> , onde valores pequenos ocupam apenas um byte.  Isso nos permite reduzir o tamanho dos links, simplesmente classificando o conte√∫do dos reposit√≥rios bin√°rios para reduzir a frequ√™ncia da ocorr√™ncia. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/od/9w/zv/od9wzvyv9ql8ps8g2gmmyq8njmo.png" alt="Classificar e reduzir o tamanho"></div><br>  Algumas propriedades t√™m muitos valores de frequ√™ncia e, portanto, a classifica√ß√£o fornece um grande ganho de tamanho.  Por outro lado, por causa disso, o n√∫mero de s√©rie dos dados n√£o pode coincidir para todos os armazenamentos. <br><br>  Al√©m disso, longe de todos os objetos, h√° dados em todos os armazenamentos e, portanto, armazenar n√∫meros de armazenamento √© mais eficiente do que fazer refer√™ncia a objetos vazios. <br><br><h4>  Acelere a recupera√ß√£o de dados </h4><br>  O formato descrito tem um problema.  Para encontrar o n√∫mero do objeto que armazena os √≠ndices para o identificador especificado, precisamos executar uma pesquisa bin√°ria dentro dos dados do primeiro objeto.  Para fazer isso, voc√™ precisa carregar 10,9 MiB na mem√≥ria ou fazer 21 leituras adicionais.  Ambas as solu√ß√µes n√£o s√£o adequadas para n√≥s e, portanto, reduzimos o n√∫mero de leituras armazenando dados em uma √°rvore. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8b/cx/to/8bcxto_pgnqn7drgqi5hkiae_su.png" alt="Formato da √°rvore para pesquisa r√°pida de dados por identificador"></div><br>  Agrupamos dados em 32 objetos e, nos n√≠veis intermedi√°rios, armazenamos 128 dos primeiros identificadores de n√≥s aninhados.  Adicionamos tr√™s n√≠veis da √°rvore e reduzimos o n√∫mero de leituras adicionais para quatro (mas, de fato, levando em considera√ß√£o o armazenamento em cache dos n√≥s da √°rvore lidos anteriormente, mesmo para 1-3).  Pre√ßo - um pouco menos de 400 KiB. <br><br>  Nesse est√°gio, somos bastante eficientes em armazenar relacionamentos e propriedades, mas o json ocupa muito espa√ßo.  Isso √© compreens√≠vel.  Quanto maior o tamanho da p√°gina, mais objetos chegam l√° e melhor o algoritmo de compacta√ß√£o √© capaz de determinar quais informa√ß√µes s√£o redundantes.  Mas, por outro lado, mais trabalho precisamos fazer para ler um √∫nico objeto.  Os objetos Json s√£o muito grandes e, portanto, existem muito poucos em uma p√°gina.  Portanto, voc√™ precisa ajudar o algoritmo a fazer seu trabalho melhor. <br><br><h4>  Quebrar json em partes </h4><br>  Em primeiro lugar, muitos objetos t√™m esquemas de dados correspondentes; apenas os valores dos atributos diferem.  Em segundo lugar, muitos valores de atributo s√£o os mesmos, mesmo para objetos com esquemas diferentes.  Vamos separar os esquemas e atribuir valores em armazenamentos separados, e armazenaremos os json's na forma: um link para um esquema + links para atribuir valores. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pq/n8/ef/pqn8ef7v2wv7bkkvbgguql2vggq.png" alt="Json est√° se dividindo em esquemas e dados"></div><br>  Em nosso esquema de dados, o n√∫mero de nomes de atributos √© limitado.  Assim, podemos coloc√°-los em um arquivo separado e armazenar o n√∫mero.  Tamb√©m faremos mais algumas altera√ß√µes, levando em considera√ß√£o que os json s√£o sempre objetos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/i_/ak/gqi_akxdvngmmjmgjrg60y-5luu.png" alt="Formato real para armazenar esquemas de objetos json"></div><br>  Sim, n√≥s basicamente esprememos nossos dados, reduzindo o escopo para o algoritmo funcionar.  Mas, por outro lado, diminu√≠mos bastante o acesso aos dados, e o algoritmo ainda ajuda, comprimindo valores semelhantes armazenados nas proximidades. <br><br>  Definimos o tamanho da p√°gina como 1 KiB e, apesar de otimizarmos o formato para que, por um lado, a leitura n√£o fosse muito lenta e, por outro lado, os dados fossem compactados da melhor maneira poss√≠vel, j√° ... ignoramos as ‚Äútabelas otimizadas‚Äù em tamanho e para facilidade de uso.  Mas n√£o √© √† toa que tudo isso foi!  O ganho m√°ximo deve ser da compress√£o dos valores de atributos, propriedades e esquemas.  Incitamos o zlib e verificamos que, no contexto do restante do trabalho, a leitura dos dados do banco de dados leva pouco tempo.  Satisfeitos com o resultado, mudamos para outras tarefas. <br></div></div><br><h3>  Livre-se do desnecess√°rio </h3><br>  Come√ßamos a reduzir pesquisando dados dos quais voc√™ pode se livrar.  Acontece que, durante a exist√™ncia do formato, aprendemos a ficar sem a maior conex√£o.  Isso representa 10% do tamanho! <br><br>  O c√≥digo para esses dados ainda estava vinculado, mas as altera√ß√µes necess√°rias s√£o bastante triviais.  Mas os aplicativos j√° lan√ßados n√£o podem ser facilmente alterados.  N√≥s nos esfor√ßamos para manter o maior tempo poss√≠vel, n√£o apenas para tr√°s, mas tamb√©m para compatibilidade direta.  E se o primeiro √© familiar a todos, muitos podem n√£o pensar no segundo.  Somos for√ßados a apoi√°-lo devido √† longa cauda de usu√°rios que, por v√°rios motivos, desativaram as atualiza√ß√µes autom√°ticas e n√£o t√™m pressa em mudar para uma nova vers√£o do aplicativo. <br><br><div class="spoiler">  <b class="spoiler_title">Distribui√ß√£o de usu√°rios por vers√£o</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ms/ld/kq/msldkqhkepk1gsouayqmglu36zo.png" alt="Distribui√ß√£o de usu√°rios por vers√£o"></div><br>  No topo est√° a distribui√ß√£o dos usu√°rios pelas vers√µes mais recentes do aplicativo Android.  A parte inferior √© o iOS. <br><br>  √â f√°cil perceber que os usu√°rios de dispositivos iOS s√£o atualizados com muito mais facilidade, mas mesmo entre eles existem muitos usu√°rios de vers√µes mais antigas. <br></div></div><br>  Tamb√©m estamos lan√ßando novos dados para a vers√£o congelada do Windows Phone.  E embora os usu√°rios do WP8 representem apenas uma pequena fra√ß√£o do nosso p√∫blico, em n√∫meros absolutos, isso √© quase 200.000 por m√™s. <br><br>  H√° muito tempo possu√≠mos um mecanismo que nos permite produzir v√°rios formatos de dados e determina automaticamente quais vers√µes devem receber o qu√™.  A oportunidade √© boa, mas voc√™ ainda precisa aprender como descarregar esses formatos.  A primeira grande tarefa foi implementar um servi√ßo que receba todos os dados e filtre os novos para o antigo formato de banco de dados e os antigos para o novo. <br><br>  Um bom b√¥nus do trabalho realizado √© reduzir o tamanho das atualiza√ß√µes mensais, pois a conex√£o remota mudou bastante de m√™s para m√™s, aumentando o tamanho das diferen√ßas. <br><br>  Se voc√™ olhar para os dados restantes, no total, poder√° espremer os mesmos 10%, no entanto, o pre√ßo ser√° incomparavelmente mais alto.  At√© agora, decidimos n√£o tocar. <br><br><h3>  Otimize o formato de armazenamento atual </h3><br>  Como foi escrito acima, criamos 1 p√°gina KiB e n√£o empacotamos todos os reposit√≥rios bin√°rios. <br><br>  A primeira coisa que fazemos √© tentar compactar tamb√©m p√°ginas com links e verificar se a diferen√ßa na velocidade de recebimento de dados est√° na regi√£o do erro. <br><br>  O pr√≥ximo item √© escolher o tamanho ideal da p√°gina.  Quanto maior o tamanho da p√°gina, mais eficientemente os dados s√£o compactados, mas mais lentamente os dados s√£o buscados.  E se, com o aumento do tamanho da p√°gina, os custos de tempo e mem√≥ria aumentam linearmente, o ganho se torna cada vez menos percept√≠vel.  Ap√≥s os testes, decidimos aumentar o tamanho para 8 KiB. <br><br><div class="spoiler">  <b class="spoiler_title">O efeito do tamanho da p√°gina em grandes sele√ß√µes</b> <div class="spoiler_text">  Se o aumento da p√°gina diminuir a velocidade das pequenas sele√ß√µes, as grandes - de centenas de elementos - s√£o aceleradas.  Isso significa que, de uma maneira boa, voc√™ precisa escolher tamanhos diferentes para armazenamento, dependendo dos casos de uso dos dados armazenados neles. <br></div></div><br>  No total, apenas esses dois pontos podem reduzir a base em 18%! <br><br><h3>  Alterar o formato de compacta√ß√£o </h3><br>  O zlib, √© claro, √© um cl√°ssico, mas o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">zstd</a> fornece uma velocidade de descompress√£o mais alta com uma taxa de compress√£o maior.  Al√©m disso, o zstd permite criar primeiro um √∫nico dicion√°rio para todos os dados dispon√≠veis, salv√°-lo uma vez e compact√°-lo com todas as p√°ginas.  Assim, desaceleramos decentemente o processo de cria√ß√£o de um arquivo com um banco de dados, mas reduzimos mais 8%. <br><br><h3>  Adicionar varandas </h3><br><h4>  Maneira f√°cil </h4><br>  A maneira mais f√°cil √© transformar cada entrada em um objeto separado, index√°-los separadamente (de acordo com estimativas aproximadas + 10% do tamanho do √≠ndice) e armazenar separadamente sua geometria nos dados para desenhar o mapa. <br><br>  Este m√©todo inflar√° a base em um total de 3%.  Nas etapas anteriores, ganhamos mais que o suficiente para nos acalmar e trabalhar com as entradas de acordo com o esquema usual, mas ... no in√≠cio do trabalho, n√£o t√≠nhamos certeza disso, e o trabalho em um formato alternativo era paralelo. <br><br><div class="spoiler">  <b class="spoiler_title">Avalia√ß√£o detalhada, para os interessados</b> <div class="spoiler_text">  Vamos tentar avaliar o aumento no tamanho do pacote com o banco de dados para cada objeto: <br><br>  8 bytes - identificador, <br>  6 bytes - n√∫mero de armazenamentos usados ‚Äã‚Äã(dados + cinco propriedades; as propriedades s√£o extra√≠das dos dados principais e armazenadas em formato bin√°rio, pois geralmente s√£o necess√°rias para um grande n√∫mero de objetos de uma s√≥ vez), <br>  3 bytes - √≠ndice no data warehouse, <br>  2 bytes - dados de deslocamento do objeto, <br>  5 bytes - valores dos dados - 2 bytes por circuito, 3 bytes em m√©dia para informa√ß√µes do apartamento (acreditamos que haver√° muitas duplicatas e os pr√≥prios dados ser√£o armazenados uma vez), <br>  6 bytes - coordenadas de dados de deslocamento (outras propriedades t√™m muitos valores duplicados e entram em colapso), <br>  8 bytes - valores de coordenadas. <br><br>  Total de 38 bytes por objeto.  No caso de Moscou, s√£o 4,5 MiB para mais de 124 mil insumos coletados. <br><br>  Em seguida, precisamos armazenar tamb√©m a conex√£o entre a casa e as entradas, s√£o 2,5 bytes para cada pr√©dio e 8 bytes para cada entrada.  Mais 1 MiB. <br><br>  Agora, consideramos quanto tudo isso levar√° no mapa. <br><br>  Primeiro, devemos armazenar a geometria.  Para polilinhas, o primeiro ponto sempre leva 8 bytes, e todos os subsequentes s√£o armazenados como diferen√ßas da precis√£o necess√°ria.  Aqui, estamos satisfeitos com a precis√£o dos dec√≠metros.  A maioria das entradas consiste em dois pontos que n√£o est√£o muito longe um do outro e, portanto, pode-se supor que a pr√≥pria geometria ocupar√° 10 bytes.  Total 1,2 MiB. <br><br>  Tamb√©m precisamos associar o identificador de entrada e o objeto √† sua geometria.  Um √≠ndice √© o mesmo armazenamento bin√°rio que tudo o resto, apenas o destino da comunica√ß√£o (1 byte), o n√∫mero da camada (1 byte) e o n√∫mero do objeto (3 bytes) s√£o armazenados.  Mais 8 bytes por identificador, al√©m de uma √°rvore de pesquisa r√°pida.  Total outro 1,5 MiB. <br><br>  Como foi dito no come√ßo do artigo, queremos exibir constantemente as entradas no mapa, e a maneira mais f√°cil de fazer isso √© descarregar outra camada com pontos, mas ... voc√™ tamb√©m pode reutilizar a camada com geometrias, criando um novo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">s√≠mbolo</a> que exibir√° a imagem de que precisamos no √∫ltimo ponto da polilinha. <br><br>  10% do √≠ndice de pesquisa √© de 5,9 MiB.  Resumindo tudo, temos 14,2 MiB, que √© um pouco mais de 3%. <br></div></div><br><h4>  Op√ß√£o atual </h4><br>  Em vez de indexar as entradas e aumentar o √≠ndice de pesquisa, procuramos casas, mas adicionalmente marcamos as palavras da consulta e selecionamos endere√ßos (relevantes para a pesquisa de entradas em Kaliningrado), entradas e / ou apartamentos.  Assim, na sa√≠da, temos o identificador da casa e os campos de texto digitados, pelos quais devemos encontrar a escada de que precisamos. <br><br><div class="spoiler">  <b class="spoiler_title">Nota</b> <div class="spoiler_text">  Este √© um ponto controverso.  Por um lado, nos permite reduzir o tamanho do banco de dados e, por outro, imp√µe restri√ß√µes ao formato de entrada - as entradas n√£o estar√£o em muitos pedidos que seriam processados ‚Äã‚Äãcorretamente usando uma pesquisa honesta. <br></div></div><br>  Al√©m disso, em vez de descarregar objetos individuais, inclu√≠mos todas as informa√ß√µes sobre as entradas diretamente nos dados da constru√ß√£o. <br>  E, finalmente, transferimos parte das geometrias para o diret√≥rio <br><br>  Vale a pena divulgar este √∫ltimo com mais detalhes. <br><br>  Primeiramente, notamos que a maioria das entradas tem dois pontos e o mesmo comprimento.  Tais entradas podem ser armazenadas na forma de um ponto + dire√ß√£o, ou seja,  economize 1 byte por entrada. <br><br>  Em segundo lugar, assumimos que a maioria das casas nas cidades modernas √© t√≠pica; portanto, os deslocamentos dos pontos de suas entradas em rela√ß√£o ao ponto central da casa coincidir√£o at√© uma volta. <br><br>  J√° temos os pontos centrais dos edif√≠cios.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E se adicionarmos uma nova propriedade ao edif√≠cio - sua "dire√ß√£o" inteira, e para cada entrada mais duas compensa√ß√µes - inteiras em dec√≠metros ao longo e perpendiculares √† linha de dire√ß√£o? </font><font style="vertical-align: inherit;">Considerando como armazenamos json's com informa√ß√µes, a geometria de entrada, em m√©dia, ocupar√° pouco mais de dois bytes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um b√¥nus adicional √© que, como a geometria est√° no diret√≥rio, n√£o precisamos mais armazenar a correspond√™ncia entre o identificador de entrada e o n√∫mero do objeto na camada do mapa.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menos - o c√≥digo se tornou mais complicado. Anteriormente, acabamos de dizer ao mapa ‚Äúmostrar tais e tais objetos‚Äù e agora, ao exibir as entradas, extra√≠mos esses dados do json e adicionamos objetos din√¢micos ao mapa. Tudo n√£o √© muito assustador aqui. Na hora de exibir as teclas de seta das entradas json, j√° temos objetos correspondentes, ou seja, n√£o h√° necessidade de ir adicionalmente ao banco de dados. Com os pontos de entrada exibidos, tudo fica um pouco pior - agora temos que determinar em segundo plano quais casas s√£o vis√≠veis, extrair os dados dessas casas do banco de dados, analisar o json e, se houver entradas, criar objetos din√¢micos para eles.</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Nota</b> <div class="spoiler_text">  .              ,     ,     0,2% (972   ). <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como j√° escrevemos c√≥digo adicional para exibir as entradas, nada nos impede de come√ßar a armazenar entradas de dois pontos na organiza√ß√£o no diret√≥rio. </font><font style="vertical-align: inherit;">O ganho neste caso ser√° pequeno, mas gratuito. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quanto isso nos deu? </font><font style="vertical-align: inherit;">3% se transformaram em 0,5%. </font><font style="vertical-align: inherit;">Poder√≠amos ter feito ainda menos, mas deixamos identificadores nos dados (que s√£o compactados de maneira insuficiente) para simplificar o processamento de mensagens do usu√°rio sobre entradas imprecisas.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Resultado </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adicionamos um grande n√∫mero de entradas, enquanto reduz√≠amos o tamanho do arquivo com dados do mapa em 0,5% e em 26,6% o tamanho do arquivo com os dados do diret√≥rio. </font><font style="vertical-align: inherit;">O √∫ltimo ainda √© o maior de nossos arquivos, mas √© apenas um dos quatro arquivos "pesados"; portanto, a altera√ß√£o geral acabou sendo mais modesta - 10,1%.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/s8/p-/_v/s8p-_vjsi9mgzymzwusfn4vsz6g.png" alt="Redimensionar a base de Moscou ao longo do tempo"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As entradas ainda n√£o foram coletadas. </font><font style="vertical-align: inherit;">O tamanho das bases aumentar√° um pouco com o tempo (de acordo com as estimativas atuais, o mesmo Moscou aumentar√° 0,4%), mas, em qualquer caso, o objetivo √© liberar as entradas sem aumentar o tamanho, mais do que o alcan√ßado.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O que vem a seguir? </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se falarmos sobre melhorias na mercearia, apoiaremos as entradas e os apartamentos nas dicas de pesquisa, bem como na pesquisa dos pontos de partida e de t√©rmino da pesquisa de dire√ß√µes. </font><font style="vertical-align: inherit;">Tamb√©m pensamos em exibir entradas importantes para edif√≠cios (principalmente em shopping centers) da mesma maneira que as varandas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nos planos t√©cnicos, h√° uma verifica√ß√£o de v√°rias id√©ias que podem levar a uma redu√ß√£o adicional no tamanho do arquivo com dados de refer√™ncia, e voc√™ precisa examinar cuidadosamente outros arquivos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E, √© claro, corrigiremos os erros que temos at√© agora.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mais um pensamento: use JSON com sabedoria </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pelo exposto, a conclus√£o sugere que voc√™ n√£o pode pensar muito em formatos bin√°rios e apenas usar JSON. </font></font> Isto n√£o √© inteiramente verdade.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso funciona para n√≥s, porque ao mesmo tempo precisamos receber v√°rias dezenas de objetos da for√ßa. </font><font style="vertical-align: inherit;">Al√©m disso, usamos o rapidjson, que √© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muito inteligente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e consome pouca mem√≥ria. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m vale a pena restringir a transfer√™ncia de dados JSON de C ++ para UI, escritos em outro idioma. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primeiro, voc√™ precisa transform√°-lo em uma string. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em segundo lugar, os analisadores dispon√≠veis na parte da interface do usu√°rio remontam essa linha e o fazem muito mais devagar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â melhor obter todos os dados do JSON por conta pr√≥pria e lan√ßar interfaces simples adaptadas para exibir elementos espec√≠ficos no lado da interface do usu√°rio.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt415263/">https://habr.com/ru/post/pt415263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt415253/index.html">Fotografias do s√©culo XIX foram restauradas usando a tecnologia do s√©culo XXI</a></li>
<li><a href="../pt415255/index.html">Roskosmos anunciou o t√©rmino de voos de m√≠sseis Proton</a></li>
<li><a href="../pt415257/index.html">8 maneiras de melhorar a visualiza√ß√£o de dados</a></li>
<li><a href="../pt415259/index.html">select / poll / epoll: diferen√ßa pr√°tica</a></li>
<li><a href="../pt415261/index.html">Artista VFX em desenvolvimento de jogos: caracter√≠sticas, carreira, desenvolvimento</a></li>
<li><a href="../pt415265/index.html">Procurando um sucessor para o KL-7: RACE e AROFLEX</a></li>
<li><a href="../pt415269/index.html">Como o JS funciona: √Årvores de sintaxe abstratas, an√°lise e sua otimiza√ß√£o</a></li>
<li><a href="../pt415271/index.html">Como os gr√°ficos de Gantt simplificam o gerenciamento de projetos</a></li>
<li><a href="../pt415273/index.html">Aprendendo o b√°sico da programa√ß√£o</a></li>
<li><a href="../pt415275/index.html">O livro "C # 7 e .NET Core. Desenvolvimento multiplataforma para profissionais. 3¬™ edi√ß√£o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>