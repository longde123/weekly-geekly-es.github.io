<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äçüíª üëêüèΩ üë®üèæ‚Äçüè≠ Como avaliar a capacidade do servi√ßo e n√£o cair sob carga üë®üèΩ‚Äçüíº üõ§Ô∏è üßëüèª‚Äçü§ù‚Äçüßëüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mais cedo ou mais tarde, qualquer servi√ßo em crescimento precisa avaliar suas capacidades t√©cnicas. Quantos visitantes podemos servir? Qual √© a capaci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como avaliar a capacidade do servi√ßo e n√£o cair sob carga</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/481134/"><img src="https://habrastorage.org/webt/-s/kl/8y/-skl8ysedkaeho-x6lw7-laelwi.png"><br><br>  Mais cedo ou mais tarde, qualquer servi√ßo em crescimento precisa avaliar suas capacidades t√©cnicas.  Quantos visitantes podemos servir?  Qual √© a capacidade do sistema?  Atingimos o limite e n√£o cairemos se atrairmos v√°rios milhares de usu√°rios?  Quantos recursos de computa√ß√£o adicionais est√£o or√ßados para o pr√≥ximo ano para atender aos planos de crescimento? <br><br>  As respostas podem ser obtidas analiticamente, endere√ßando perguntas a um desenvolvedor experiente / DevOps / SRE / admin.  A confiabilidade da avalia√ß√£o depende de um grande n√∫mero de fatores: come√ßando pelo ritmo de preenchimento do sistema com funcionalidade e pelo gr√°fico das rela√ß√µes entre os componentes e terminando com o tempo que o especialista passou a manh√£ no tr√¢nsito.  Quanto mais complexo o sistema, maior a d√∫vida sobre a adequa√ß√£o da avalia√ß√£o anal√≠tica. <br><br>  Meu nome √© Maxim Kupriyanov, h√° cinco anos que trabalho na Yandex.Market.  Hoje vou contar aos leitores da Habr como aprendemos a avaliar a capacidade de nossos servi√ßos e o que resultou dele. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/dj/-4/ho/dj-4hoqd3ddi5lpwrokluke77ok.png"><br><br><h2>  Vamos para a posi√ß√£o </h2><br>  Como a estrutura dos componentes do mercado √© bastante complicada, decidimos avaliar a capacidade de dimensionar apenas os servi√ßos maiores e mais caros.  Al√©m disso, o n√∫mero di√°rio de solicita√ß√µes para eles deve depender claramente do tamanho do p√∫blico di√°rio do mercado (usu√°rios ativos di√°rios, DAU).  Por que exatamente da DAU?  Como os analistas, fazendo previs√µes para os pr√≥ximos meses e anos, sempre calculam o tamanho futuro da audi√™ncia, e tiraremos proveito dessa circunst√¢ncia agrad√°vel. <br><br>  Agora vamos falar sobre o qual √© imposs√≠vel criar avalia√ß√µes objetivas: sobre as m√©tricas do servi√ßo.  Se o n√∫mero de solicita√ß√µes de servi√ßo depender da DAU, definitivamente precisaremos da m√©trica "solicita√ß√µes por segundo" (solicita√ß√µes por segundo, RPS).  Al√©m disso, para avaliar a qualidade do servi√ßo, voc√™ precisa conhecer a porcentagem de erros e tempos de resposta (tempos de solicita√ß√£o).  O erro ser√° considerado uma resposta com um c√≥digo HTTP de 500 ou superior.  Os erros do intervalo 4xx s√£o do lado do cliente e, em um sistema normalmente funcionando, geralmente n√£o dizem nada sobre problemas de servi√ßo.  Quanto aos hor√°rios, √© habitual calcular e armazenar os percentis 80, 95, 99 e 99,9 de tempos de resposta, mas um conjunto espec√≠fico pode diferir ligeiramente de servi√ßo para servi√ßo. <br><br>  Portanto, temos m√©tricas de frequ√™ncia de solicita√ß√£o, porcentagem de erros e um conjunto de percentis de tempo de resposta.  E tamb√©m sabemos o servi√ßo DAU para todos os dias e per√≠odos futuros (na forma de uma previs√£o).  Dado que os padr√µes m√©dios de comportamento do usu√°rio n√£o mudam muito a cada dia, digamos o seguinte: conhecendo o RPS no per√≠odo mais ativo do dia √∫til (RPS de pico), podemos prever o RPS de pico para per√≠odos futuros, desde que tenhamos uma previs√£o da DAU.  E vice-versa: se sabemos quantas solicita√ß√µes por segundo o sistema pode suportar sem violar o acordo sobre o tempo de resposta e a porcentagem de erros, podemos estimar quanto p√∫blico podemos atender, ou seja, sabemos a capacidade do sistema. <br><br>  Bem, decidimos a tarefa: fixar os tempos de resposta e a porcentagem de erros na forma de acordos e encontrar o RPS m√°ximo que o sistema pode suportar nessas condi√ß√µes.  Como vamos decidir? <br><br><img src="https://habrastorage.org/webt/wf/zk/ea/wfzkeajjy8urgrmv0xib56c9nj8.png"><br><br><h2>  Atiramos no alvo </h2><br>  Aqui est√° uma abordagem cl√°ssica para resolver o problema: coletamos um site de teste, pegamos os logs de acesso ao sistema no ambiente de produ√ß√£o, fabricamos cartuchos e acionamos o sistema, aumentando a frequ√™ncia das solicita√ß√µes, at√© que o site mostre degrada√ß√£o significativa nos tempos de resposta e / ou erros.  Nesse ponto, paramos e corrigimos a frequ√™ncia das solicita√ß√µes (o mesmo RPS).  Vit√≥ria  N√£o importa como.  E aqui est√° o porqu√™: <br><br><ul><li>  o site de teste, como regra, n√£o √© id√™ntico √† plataforma sob o servi√ßo no ambiente de produ√ß√£o; </li><li>  o c√≥digo de servi√ßo muda todos os dias ou com mais frequ√™ncia; </li><li>  experimentos podem influenciar a carga; </li><li>  a gravidade das solicita√ß√µes do usu√°rio depende da hora do dia e de outras condi√ß√µes; </li><li>  servi√ßos modernos raramente funcionam isoladamente, mais frequentemente fazem subconsultas a outros servi√ßos, e isso ter√° que ser levado em considera√ß√£o de alguma forma. </li></ul><br>  Melhoria: lan√ßaremos o servi√ßo automaticamente todos os dias, coletando cartuchos de revistas nos hor√°rios de pico.  E, para n√£o desperdi√ßar recursos em um local de teste, come√ßaremos a descascar componentes de interesse para n√≥s do mesmo lado.  Parece complicado e n√£o resolve todos os problemas.  Mas que outras op√ß√µes existem? <br><br><img src="https://habrastorage.org/webt/sb/ub/zp/sbubzp0dbuxhrpqtdxt6fichhqk.png"><br><br><h2>  Simule a realidade </h2><br>  A ideia geral √© a seguinte: copiamos parte do tr√°fego dos balanceadores para o local, onde coletamos o an√°logo completo do ambiente de produ√ß√£o em miniatura e, ajustando o volume do tr√°fego copiado, procuramos o ponto de degrada√ß√£o.  A id√©ia √© linda e n√≥s, no mercado, fazemos isso para testar novas funcionalidades e comparar o comportamento de novas vers√µes com as antigas.  Meu colega Eugene <a href="https://habr.com/ru/company/yandex/blog/475848/">falou sobre isso</a> em detalhes - veja a se√ß√£o sobre o cluster de sombras.  Mas tamb√©m existem dificuldades √≥bvias: <br><br><ul><li>  o problema de interagir com componentes externos n√£o √© resolvido, pois √© muito caro fazer uma c√≥pia de todo o ambiente de produ√ß√£o; </li><li>  os logs de solicita√ß√£o do sistema de espelhos podem acidentalmente se misturar com os logs do ambiente de produ√ß√£o, o que significa que √© necess√°rio criar um sistema com marca√ß√£o do tr√°fego de espelhos para que ele possa ser encontrado e limpo; </li><li>  as solicita√ß√µes geralmente s√£o espelhadas na totalidade ou em porcentagem do total, e essa precis√£o n√£o nos conv√©m (mas isso pode ser resolvido, estamos trabalhando nessa dire√ß√£o). </li></ul><br>  Em geral, a imita√ß√£o da produ√ß√£o √© uma abordagem muito boa e promissora, mas muito cara e com limita√ß√µes significativas. <br><br><img src="https://habrastorage.org/webt/bh/pd/-8/bhpd-89lwirxbq9ywgv73803qqo.png"><br><br><h2>  Testando diretamente na produ√ß√£o </h2><br>  E ent√£o finalmente chegamos ao delicioso.  Para cada componente testado, criamos uma inst√¢ncia separada na produ√ß√£o, cuja frequ√™ncia de solicita√ß√µes √© regulada a partir do balanceador com alta precis√£o.  Na √∫ltima vez, os <a href="https://habr.com/ru/company/yandex/blog/475848/">leitores nos perguntaram</a> : ‚ÄúO HAProxy √© suficiente para voc√™?  Havia necessidade de escrever algo seu?  Portanto, este √© um caso muito raro, quando n√£o foi suficiente e eu tive que escrever. <br><br>  Ao mesmo tempo, existe um servi√ßo separado que monitora de perto as m√©tricas da inst√¢ncia carregada e, quando os indicadores se aproximam de valores cr√≠ticos, fecha a v√°lvula no balanceador, reduzindo a frequ√™ncia de solicita√ß√µes.  Se o servi√ßo funcionar dentro de limites aceit√°veis, a v√°lvula, pelo contr√°rio, abre.  Obviamente, os limites para tempos e erros ao carregar um servi√ßo ao vivo s√£o notavelmente mais conservadores (geralmente de 5 a 10%) do que no campo de treinamento, porque n√£o queremos piorar a intera√ß√£o com os usu√°rios.  Assim, a inst√¢ncia carregada sempre funciona at√© o limite.  N√≥s corrigimos esses indicadores.  E ent√£o temos aritm√©tica: sabemos o n√∫mero de n√∫cleos de servi√ßo sob carga a cada momento, conhecemos a DAU ontem.  A partir disso, consideramos op√ß√µes de reciclagem, reservas de capacidade e comportamento do sistema ao desativar um ou outro local.  Tudo isso estabelece na base de onde s√£o criados belos gr√°ficos.  Com base nesses dados, quando a capacidade cai abaixo do limite, os alertas s√£o acionados. <br><br><h2>  Vejamos os gr√°ficos </h2><br><img src="https://habrastorage.org/webt/lt/nb/pa/ltnbpanor5tjwa-ljrej4darzcm.png"><br><br>  √â assim que controlamos o fluxo de tr√°fego para a inst√¢ncia testada.  A etapa pode ser qualquer m√∫ltiplo de 1 RPS.  No gr√°fico, para ilustra√ß√£o, modelamos uma subida com um intervalo de tr√™s minutos: primeiro, de 650 a 1K RPS em incrementos de 50 e, em seguida, de 200 a 1K RPS em incrementos de 100. Deixe-me lembr√°-lo de que √© o tr√°fego real do usu√°rio ao qual os clientes receberam respostas. <br><br><img src="https://habrastorage.org/webt/yl/hp/ma/ylhpma60p6keqxgzmsshgvqs1dm.png"><br><br>  Isso mostra o RPS para tr√™s inst√¢ncias: uma sob carga e duas sob controle.  O sujeito foi artificialmente definido um limite superior de 600 RPS.  O servi√ßo pode ser mais, mas se torna inst√°vel demais e depende de influ√™ncias externas.  V√™-se claramente que, na primeira metade do dia, as solicita√ß√µes de servi√ßo s√£o, em m√©dia, mais pesadas e a inst√¢ncia n√£o pode atingir sua capacidade m√°xima em condi√ß√µes aceit√°veis, mas, no final da tarde, tudo volta ao normal.  Bursts e omiss√µes no gr√°fico s√£o inst√¢ncias de reinicializa√ß√£o para distribuir lan√ßamentos e outras atualiza√ß√µes (todos est√£o em equil√≠brio, ningu√©m foi ferido).  E os ajustes passo a passo do RPS no assunto do teste s√£o apenas o trabalho de um algoritmo que busca o limite de possibilidades. <br><br><img src="https://habrastorage.org/webt/3y/du/mw/3ydumwukuqrnergvj0li5mqxary.png"><br><br>  A frequ√™ncia das solicita√ß√µes de servi√ßo e a carga que uma inst√¢ncia pode suportar s√£o claramente vis√≠veis. <br><br><img src="https://habrastorage.org/webt/hy/jj/mt/hyjjmtgnuwgdrkla6_k42za5x_c.png"><br><br>  E aqui recalculamos tudo em porcentagem de utiliza√ß√£o.  O gr√°fico mostra que o servi√ßo estava muito carregado e quando um dos locais foi desativado, havia riscos de sair para o SLA.  Mas agora est√° tudo bem: recursos foram adicionados ao servi√ßo, a reciclagem voltou a limites aceit√°veis. <br><br>  Assim, o teste de carga na produ√ß√£o permite avaliar rapidamente a capacidade do sistema e prever o consumo de recursos para per√≠odos futuros.  Ao mesmo tempo, o sistema n√£o adiciona despesas consider√°veis ‚Äã‚Äãe voc√™ pode trabalhar com seguran√ßa com servi√ßos com estado, uma vez que n√£o geramos novo tr√°fego, mas apenas redistribu√≠mos com precis√£o o que √©.  E finalmente: para funcionar, como regra, n√£o √© necess√°rio alterar o c√≥digo do pr√≥prio sistema experimental, o que permite testar at√© aplicativos legados. <br><br><img src="https://habrastorage.org/webt/bn/fe/bd/bnfebdjggyt-wbi914qf_z9dcnu.png"><br><br><h2>  Refletir </h2><br>  Essa metodologia n√£o atua no mercado h√° mais de um ano, e podemos compartilhar observa√ß√µes e recomenda√ß√µes: <br><br><ul><li>  Ao lado da inst√¢ncia carregada, deve haver um controle comum e, de prefer√™ncia, vapor, pois a degrada√ß√£o geralmente ocorre n√£o porque a inst√¢ncia est√° sobrecarregada, mas devido a problemas gerais com o servi√ßo como um todo. </li><li>  A t√©cnica funciona bem apenas com os componentes cuja carga √© superior a centenas de solicita√ß√µes por segundo para um local.  O motivo √© bem simples: precisamos carregar a inst√¢ncia testada e uma ou duas de controle.  Se n√£o houver tr√°fego suficiente, n√£o alcan√ßaremos a satura√ß√£o ou n√£o poderemos comparar honestamente.  E se o RPS limite por inst√¢ncia for muito pequeno, a etapa m√≠nima para alterar a frequ√™ncia da solicita√ß√£o para 1 RPS pode ser muito dif√≠cil. </li><li>  √â melhor testar frentes e back-ends em locais diferentes, para que artefatos de back-end de teste de carga n√£o afetem a estimativa da capacidade frontal. </li><li>  Quando analisamos os tempos de resposta e procuramos sinais de degrada√ß√£o, geralmente utilizamos agregados de cinco minutos e contamos a mediana para n√£o reagir a explos√µes aleat√≥rias. </li><li>  O principal motivo pelo qual a inst√¢ncia carregada do servi√ßo falha √© o espa√ßo em disco para arquivos de log (logs).  Eles sempre esquecem dele. </li><li>  O registro no disco de servidores da Web carregado com E / S √© um motivo muito comum para agravar os tempos, mesmo em SSDs.  Sempre ative o buffer, a grava√ß√£o ass√≠ncrona e qualquer outra coisa, apenas para n√£o esperar at√© que a grava√ß√£o termine. </li><li>  A carga noturna n√£o √© indicativa, pois os pedidos s√£o, em m√©dia, mais pesados ‚Äã‚Äãdevido √† maior participa√ß√£o de rob√¥s.  Portanto, para estimar a capacidade, √© melhor fixar o intervalo da hora do dia convencionalmente leve e √† noite apenas para reduzir o fluxo de solicita√ß√µes se aparecerem sinais de degrada√ß√£o. </li><li>  O percentil 99,9¬∫ de tempos de resposta √© in√∫til para a estimativa de capacidade, pois as garantias de disponibilidade da rede raramente excedem 99%. </li><li>  Inicie uma linha do tempo e grave lan√ßamentos de servi√ßo e outros eventos significativos.  Ajuda a encontrar o que levou a uma diminui√ß√£o da capacidade. </li><li>  Em uma an√°lise detalhada das causas da degrada√ß√£o, o rastreamento tamb√©m √© √∫til: um cabe√ßalho de marcador √© adicionado a cada solicita√ß√£o de servi√ßo, que vai da frente at√© o √∫ltimo back-end e entra em todos os logs.  Dessa forma, voc√™ pode rastrear todo o caminho da solicita√ß√£o e entender o que causa atrasos. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt481134/">https://habr.com/ru/post/pt481134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt481120/index.html">Onde e como os servidores de borda s√£o aplicados?</a></li>
<li><a href="../pt481122/index.html">Antipatterns PostgreSQL: passando conjuntos e sele√ß√µes para SQL</a></li>
<li><a href="../pt481124/index.html">Dicas para escrever c√≥digo de auto-documenta√ß√£o</a></li>
<li><a href="../pt481126/index.html">Uni√£o de programadores? N√£o conte aos meus chinelos</a></li>
<li><a href="../pt481130/index.html">TOP12 Descobertas Cient√≠ficas Interdisciplinares 2019</a></li>
<li><a href="../pt481138/index.html">Essas pessoas criam intelig√™ncia artificial - 4 hist√≥rias de especialistas em IA e ML</a></li>
<li><a href="../pt481140/index.html">Folha de dicas do formato de arquivo de dados Python</a></li>
<li><a href="../pt481142/index.html">Ol√°, mundo Qt QJSEngine</a></li>
<li><a href="../pt481146/index.html">Outro registrador forneceu o √∫ltimo bloco de endere√ßos IPv4</a></li>
<li><a href="../pt481148/index.html">Problemas f√≠sicos incomuns no desenvolvimento do pensamento cient√≠fico (para crian√ßas em idade escolar)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>