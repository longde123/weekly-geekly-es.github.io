<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõÄüèΩ ü•ú ‚õ±Ô∏è Lo que sabemos sobre microservicios üßñüèæ üéÜ ü•†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Mi nombre es Vadim Madison, lidero el desarrollo de la Plataforma del Sistema Avito. Sobre c√≥mo en la compa√±√≠a estamos cambiando de una arquitect...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Lo que sabemos sobre microservicios</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/454780/"><p>  Hola  Mi nombre es Vadim Madison, lidero el desarrollo de la Plataforma del Sistema Avito.  Sobre c√≥mo en la compa√±√≠a estamos cambiando de una arquitectura monol√≠tica a una arquitectura de microservicio, se ha dicho m√°s de una vez.  Es hora de compartir c√≥mo transformamos nuestra infraestructura para aprovechar al m√°ximo los microservicios y no perdernos en ellos.  C√≥mo PaaS nos ayuda aqu√≠, c√≥mo simplificamos la implementaci√≥n y redujimos la creaci√≥n de un microservicio a un solo clic.  No todo lo que escribo a continuaci√≥n est√° totalmente implementado en Avito, parte es c√≥mo desarrollamos nuestra plataforma. </p><br><p>  (Y al final de este art√≠culo hablar√© sobre la oportunidad de llegar a un seminario de tres d√≠as de un experto en arquitectura de microservicios Chris Richardson). </p><br><p><img src="https://habrastorage.org/webt/9e/m3/xm/9em3xmzspjfadie85f_elruwij4.png"></p><a name="habracut"></a><br><h1 id="kak-my-prishli-k-mikroservisam">  Como llegamos a los microservicios </h1><br><p>  Avito es uno de los mayores clasificados del mundo, publica m√°s de 15 millones de nuevos anuncios por d√≠a.  Nuestro backend acepta m√°s de 20 mil solicitudes por segundo.  Ahora tenemos varios cientos de microservicios. </p><br><p>  Hemos estado construyendo arquitectura de microservicios durante varios a√±os.  C√≥mo exactamente: nuestros colegas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hablaron</a> en detalle en nuestra secci√≥n en RIT ++ 2017. En CodeFest 2017 (ver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">video</a> ), Sergey Orlov y Mikhail Prokopchuk explicaron en detalle por qu√© necesit√°bamos la transici√≥n a microservicios y qu√© papel desempe√±√≥ Kubernetes aqu√≠.  Bueno, ahora estamos haciendo todo lo posible para minimizar los costos de escala inherentes a dicha arquitectura. </p><br><p>  Inicialmente, no creamos un ecosistema que nos ayudara de manera integral en el desarrollo y lanzamiento de microservicios.  Simplemente recopilaron soluciones sensatas de c√≥digo abierto, las lanzaron en casa y sugirieron al desarrollador que las manejara.  Como resultado, fue a una docena de lugares (tableros, servicios internos), despu√©s de lo cual se hizo m√°s fuerte en el deseo de cortar el c√≥digo de la manera antigua, en un monolito.  El color verde en los diagramas a continuaci√≥n indica lo que el desarrollador hace de una forma u otra con sus propias manos, el color amarillo indica automatizaci√≥n. </p><br><p><img src="https://habrastorage.org/webt/2a/h8/br/2ah8breno6ypqrbgo7uwi4g_ymw.png"></p><br><p>  Ahora en la utilidad PaaS CLI, un equipo crea un nuevo servicio, y dos m√°s agregan una nueva base de datos e implementan en Stage. </p><br><p><img src="https://habrastorage.org/webt/ku/wf/ek/kuwfekxz9r75rl_hobbjp-rd82i.png"></p><br><h1 id="kak-preodolet-epohu-mikroservisnoy-razdroblennosti">  C√≥mo superar la era de la "fragmentaci√≥n de microservicios" </h1><br><p> Con una arquitectura monol√≠tica, en aras de la coherencia de los cambios en el producto, los desarrolladores se vieron obligados a descubrir qu√© estaba pasando con sus vecinos.  Cuando se trabaja en la nueva arquitectura, los contextos de servicio ya no dependen unos de otros. </p><br><p>  Adem√°s, para que la arquitectura de microservicios sea efectiva, es necesario establecer muchos procesos, a saber: </p><br><p>  ‚Ä¢ tala de √°rboles; <br>  ‚Ä¢ seguimiento de consultas (Jaeger); <br>  ‚Ä¢ agregaci√≥n de errores (Centinela); <br>  ‚Ä¢ estados, mensajes, eventos de Kubernetes (procesamiento de flujo de eventos); <br>  ‚Ä¢ l√≠mite de carrera / disyuntor (puede usar Hystrix); <br>  ‚Ä¢ control de la conectividad del servicio (usamos Netramesh); <br>  ‚Ä¢ monitoreo (Grafana); <br>  ‚Ä¢ asamblea (TeamCity); <br>  ‚Ä¢ comunicaci√≥n y notificaci√≥n (Slack, correo electr√≥nico); <br>  ‚Ä¢ seguimiento de tareas;  (Jira) <br>  ‚Ä¢ compilaci√≥n de documentaci√≥n. </p><br><p>  Para que, a medida que el sistema escala, no pierda su integridad y siga siendo efectivo, repensamos la organizaci√≥n del trabajo de microservicios en Avito. </p><br><h1 id="kak-my-upravlyaemsya-s-mikroservisami">  C√≥mo manejamos los microservicios </h1><br><p>  Llevar a cabo una "pol√≠tica de partido" unificada entre los muchos microservicios que Avito ayuda a: </p><br><ul><li>  divisi√≥n de infraestructura en capas; </li><li>  Concepto de plataforma como servicio (PaaS); </li><li>  Monitoreo de todo lo que sucede con microservicios. </li></ul><br><p>  Las capas de abstracci√≥n de infraestructura incluyen tres capas.  Vayamos de arriba a abajo. </p><br><p>  <strong>A. Superior - malla de servicio.</strong>  Al principio probamos Istio, pero result√≥ que usa demasiados recursos, lo que es demasiado costoso para nuestros vol√∫menes.  Por lo tanto, el ingeniero senior en el equipo de arquitectura Alexander Lukyanchenko desarroll√≥ su propia soluci√≥n: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Netramesh</a> (disponible en c√≥digo abierto), que ahora usamos en producci√≥n y que consume varias veces menos recursos que Istio (pero no hace todo lo que Istio puede presumir). <br>  <strong>B. Medio - Kubernetes.</strong>  En √©l implementamos y operamos microservicios. <br>  <strong>C. Inferior - metal desnudo.</strong>  No usamos nubes y cosas como OpenStack, sino que nos sentamos completamente en metal desnudo. </p><br><p>  Todas las capas est√°n combinadas por PaaS.  Y esta plataforma, a su vez, consta de tres partes. </p><br><p>  <strong>I. Generadores</strong> controlados a trav√©s de la utilidad CLI.  Es ella quien ayuda al desarrollador a crear un microservicio de la manera correcta y con un m√≠nimo de esfuerzo. </p><br><p>  <strong>II</strong>  <strong>Colector combinado</strong> con control de todas las herramientas a trav√©s de un tablero com√∫n. </p><br><p>  <strong>III.</strong>  <strong>Repositorio</strong> .  Interfiere con los planificadores que establecen autom√°ticamente desencadenantes para acciones significativas.  Gracias a este sistema, no se pierde una sola tarea solo porque alguien olvid√≥ poner una tarea en Jira.  Utilizamos una herramienta interna llamada Atlas para esto. </p><br><p><img src="https://habrastorage.org/webt/xq/if/9g/xqif9gz-91gsn2qzo6up78dgqts.png"></p><br><p>  La implementaci√≥n de microservicios en Avito tambi√©n se lleva a cabo de acuerdo con un √∫nico esquema, que simplifica el control sobre ellos en cada etapa de desarrollo y lanzamiento. </p><br><h1 id="kak-ustroen-standartnyy-konveyer-razrabotki-mikroservisa">  C√≥mo funciona la tuber√≠a de desarrollo de microservicios est√°ndar </h1><br><p>  En t√©rminos generales, la cadena de creaci√≥n de microservicios es la siguiente: </p><br><p>  <em>CLI-push ‚Üí Integraci√≥n continua ‚Üí Horneado ‚Üí Implementaci√≥n ‚Üí Pruebas artificiales ‚Üí Pruebas Canarias ‚Üí Pruebas de compresi√≥n ‚Üí Producci√≥n ‚Üí Servicio.</em> </p><br><p>  Lo atravesamos exactamente en esta secuencia. </p><br><h2 id="cli-push">  CLI-push </h2><br><p>  <strong>‚Ä¢ Crear un microservicio</strong> . <br>  Luchamos durante mucho tiempo para ense√±ar a cada desarrollador c√≥mo hacer microservicios.  Incluyendo escribi√≥ en Confluence instrucciones detalladas.  Pero los esquemas cambiaron y se complementaron.  En pocas palabras: un cuello de botella se form√≥ al comienzo del viaje: tom√≥ mucho m√°s tiempo iniciar los microservicios de lo aceptable, y a√∫n as√≠, al crearlos, a menudo surg√≠an problemas. </p><br><p>  Al final, creamos una sencilla utilidad CLI que automatiza los pasos b√°sicos al crear un microservicio.  De hecho, reemplaza el primer git push.  Esto es lo que ella hace. </p><br><p>  - Crea un servicio de acuerdo con la plantilla, paso a paso, en el modo "asistente".  Tenemos plantillas para los principales lenguajes de programaci√≥n en el backend de Avito: PHP, Golang y Python. </p><br><p>  - En un comando, implementa el entorno para el desarrollo local en una m√°quina espec√≠fica - Minikube se eleva, los gr√°ficos Helm se generan autom√°ticamente y se ejecutan en kubernetes locales. </p><br><p>  - Conecta la base de datos deseada.  El desarrollador no necesita conocer la IP, el inicio de sesi√≥n y la contrase√±a para acceder a la base de datos que necesita, al menos localmente, al menos en Stage, al menos en producci√≥n.  Adem√°s, la base de datos se implementa inmediatamente en una configuraci√≥n tolerante a fallas y con equilibrio. </p><br><p>  - Se realiza un montaje en vivo.  Digamos que un desarrollador arregl√≥ algo en un microservicio a trav√©s de su IDE.  La utilidad ve los cambios en el sistema de archivos y, en funci√≥n de ellos, vuelve a ensamblar la aplicaci√≥n (para Golang) y se reinicia.  Para PHP, simplemente reenviamos el directorio dentro del cubo y all√≠ la recarga en vivo se obtiene "autom√°ticamente". </p><br><p>  - Genera autotests.  En forma de discos, pero bastante adecuados para su uso. </p><br><p>  <strong>‚Ä¢ Implementar microservicios</strong> . </p><br><p>  Era un poco triste implementar un microservicio antes.  Obligatorio requerido: </p><br><p>  I. Dockerfile. </p><br><p>  II  Config. <br>  III.  Un gr√°fico de Helm, que es voluminoso e incluye: </p><br><p>  - los propios gr√°ficos; <br>  - plantillas; <br>  - valores espec√≠ficos teniendo en cuenta diferentes entornos. </p><br><p>  Nos libramos del dolor de rehacer los manifiestos de Kubernetes, y ahora se generan autom√°ticamente.  Pero lo m√°s importante, simplificaron la implementaci√≥n hasta el l√≠mite.  De ahora en adelante, tenemos un Dockerfile, y el desarrollador escribe toda la configuraci√≥n en un solo archivo corto app.toml. </p><br><p><img src="https://habrastorage.org/webt/o6/fd/g-/o6fdg-lpen5l_8evpr1j0rsltbe.png"></p><br><p>  S√≠, y en la aplicaci√≥n .toml en s√≠ es ahora asuntos por un minuto.  Anotamos d√≥nde y cu√°ntas copias del servicio generar (en el servidor de desarrollo, en la preparaci√≥n, en la producci√≥n), indican sus dependencias.  Tenga en cuenta el tama√±o de l√≠nea = "peque√±o" en el bloque [motor].  Este es el l√≠mite que se asignar√° al servicio a trav√©s de Kubernetes. </p><br><p>  Adem√°s, sobre la base de la configuraci√≥n, todos los gr√°ficos Helm necesarios se generan autom√°ticamente y se crean conexiones a las bases de datos. </p><br><p>  <strong>‚Ä¢ Validaci√≥n b√°sica.</strong>  Dichos controles tambi√©n est√°n automatizados. <br>  <strong>Necesito rastrear:</strong> <br>  - ¬øHay un Dockerfile? <br>  - ¬øhay app.toml; <br>  - si hay documentaci√≥n; <br>  - si las dependencias est√°n en orden; <br>  - son las reglas de alertas establecidas. <br>  Hasta el √∫ltimo punto: el propietario del servicio mismo indica qu√© m√©tricas del producto monitorear. </p><br><p>  <strong>‚Ä¢ Preparaci√≥n de documentaci√≥n.</strong> <br>  Sigue siendo un lugar problem√°tico.  Parece ser el m√°s obvio, pero al mismo tiempo un r√©cord "a menudo olvidado" y, por lo tanto, un eslab√≥n vulnerable en la cadena. <br>  Es necesario que la documentaci√≥n est√© bajo cada microservicio.  Los siguientes bloques est√°n incluidos en √©l. </p><br><p>  <strong>I. Breve descripci√≥n del servicio</strong> .  Solo unas pocas oraciones sobre lo que hace y para qu√© se necesita. </p><br><p>  <strong>II</strong>  <strong>Enlace al diagrama de arquitectura</strong> .  Es importante que si lo mira r√°pidamente, sea f√°cil de entender, por ejemplo, si usa Redis para el almacenamiento en cach√© o como el almac√©n de datos principal en modo persistente.  En Avito, hasta ahora, este es un enlace a Confluence. </p><br><p>  <strong>III.</strong>  <strong>Runbook</strong>  Una breve gu√≠a para lanzar el servicio y las complejidades de manejarlo. </p><br><p>  <strong>IV.</strong>  <strong>Preguntas frecuentes</strong> , donde ser√≠a bueno anticipar los problemas que pueden encontrar sus colegas al trabajar con el servicio. </p><br><p>  <strong>V. Descripci√≥n de puntos finales para la API</strong> .  Si de repente no indic√≥ su destino, es casi seguro que le pagar√°n colegas cuyos microservicios est√°n relacionados con los suyos.  Ahora usamos Swagger para esto y nuestra soluci√≥n se llama breve. </p><br><p>  <strong>VI.</strong>  <strong>Etiquetas</strong>  O marcadores que muestran a qu√© producto, funcionalidad, unidad estructural de la compa√±√≠a a la que pertenece el servicio.  Ayudan a comprender r√°pidamente, por ejemplo, si no est√° viendo la funcionalidad que sus colegas implementaron hace una semana para la misma unidad de negocios. </p><br><p>  <strong>VII.</strong>  <strong>El propietario o propietarios del servicio</strong> .  En la mayor√≠a de los casos, ellos, o ellos, pueden determinarse autom√°ticamente usando PaaS, pero para el seguro requerimos que el desarrollador los especifique manualmente. </p><br><p>  Finalmente, es una buena pr√°ctica revisar la documentaci√≥n, similar a la revisi√≥n de c√≥digo. </p><br><h2 id="continuous-integration">  Integraci√≥n continua </h2><br><ul><li>  <strong>Preparaci√≥n de repositorios.</strong> </li><li>  <strong>Crear una tuber√≠a en TeamCity.</strong> </li><li>  <strong>Establecer derechos.</strong> </li><li>  <strong>B√∫squeda de propietarios de servicios.</strong>  Existe un esquema h√≠brido: marcado manual y automatizaci√≥n m√≠nima de PaaS.  Un esquema completamente autom√°tico no puede transferir servicios en apoyo a otro equipo de desarrollo o, por ejemplo, si un desarrollador de servicios se cierra. </li><li>  <strong>Registro de servicio en Atlas</strong> (ver arriba).  Con todos sus propietarios y dependencias. </li><li>  <strong>Verifica las migraciones.</strong>  Verificamos si hay alguno potencialmente peligroso entre ellos.  Por ejemplo, en uno de ellos, aparece una tabla alternativa o algo m√°s que puede alterar la compatibilidad del esquema de datos entre diferentes versiones del servicio.  Luego, la migraci√≥n no se realiza, sino que se suscribe: PaaS debe indicar al propietario del servicio cuando sea seguro usarlo. </li></ul><br><h2 id="bake">  Hornear </h2><br><p>  La siguiente etapa es el paquete de servicios antes de la implementaci√≥n. </p><br><ul><li>  <strong>Compila la aplicaci√≥n.</strong>  Seg√∫n los cl√°sicos, en la imagen de Docker. </li><li>  <strong>Generaci√≥n de gr√°ficos de Helm para el servicio en s√≠ y los recursos relacionados.</strong>  Incluido para bases de datos y cach√©.  Se crean autom√°ticamente de acuerdo con la configuraci√≥n app.toml que se gener√≥ en la etapa CLI-push. </li><li>  <strong>Creaci√≥n de tickets para que los administradores abran puertos</strong> (cuando sea necesario). </li><li>  <strong>Prueba de unidad y c√°lculo de cobertura de c√≥digo</strong> .  Si la cobertura del c√≥digo est√° por debajo de un valor umbral dado, lo m√°s probable es que el servicio falle a√∫n m√°s: se implementar√°.  Si est√° al borde de lo permisible, se asignar√° un coeficiente de "pesimismo" al servicio: luego, en ausencia de una mejora del indicador con el tiempo, el desarrollador recibir√° una notificaci√≥n de que no hay progreso por parte de las pruebas (y algo debe hacerse con esto). </li><li>  <strong>Consideraci√≥n de las limitaciones de memoria y CPU</strong> .  Principalmente escribimos microservicios en Golang y los ejecutamos en Kubernetes.  A partir de aqu√≠, hay una sutileza asociada con la peculiaridad del lenguaje Golang: de manera predeterminada, todos los n√∫cleos de la m√°quina se usan al inicio, si no configura expl√≠citamente la variable GOMAXPROCS y cuando se inician varios de estos servicios en la misma m√°quina, comienzan a competir por los recursos, interfiriendo entre s√≠.  Los gr√°ficos a continuaci√≥n muestran c√≥mo cambia el tiempo de ejecuci√≥n si ejecuta la aplicaci√≥n sin competencia y en la carrera por los recursos.  (La fuente de los gr√°ficos est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> ). </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/dl/1g/df/dl1gdfpfvj_me2wgpj28p0ucg90.png"></a> </p><br><p>  <em>Plazo de ejecuci√≥n, menos es mejor.</em>  <em>M√°ximo: 643 ms; M√≠nimo: 42 ms.</em>  <em>Se puede hacer clic en la foto.</em> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/nb/zj/fv/nbzjfv9lx89orqn9r8ngnn84zr4.png"></a> </p><br><p>  <em>Tiempo para la cirug√≠a, menos es mejor.</em>  <em>M√°ximo: 14091 ns, M√≠nimo: 151 ns.</em>  <em>Se puede hacer clic en la foto.</em> </p><br><p>  En la etapa de preparaci√≥n del ensamblaje, puede establecer esta variable expl√≠citamente o puede usar la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">automaxprocs</a> de los chicos de Uber. </p><br><h2 id="deploy">  Implementar </h2><br><p>  <strong>‚Ä¢ Verificaci√≥n de convenciones.</strong>  Antes de comenzar a entregar ensamblados de servicios a los entornos previstos, debe verificar lo siguiente: <br>  - Puntos finales API. <br>  - Cumplimiento del esquema de puntos finales de respuestas API. <br>  - Formato de registro. <br>  - Configuraci√≥n de encabezados para solicitudes de servicio (netramesh est√° haciendo esto ahora) <br>  - Configuraci√≥n del token del propietario al enviar mensajes al bus (bus de eventos).  Esto es necesario para rastrear la conectividad de los servicios a trav√©s del bus.  Puede enviar datos idempotentes al bus que no aumentan la conectividad de los servicios (lo cual es bueno), as√≠ como datos comerciales que mejoran la conectividad de los servicios (¬°lo cual es muy malo!).  Y en el momento en que esta conectividad se convierte en un problema, comprender qui√©n escribe y lee el bus ayuda a dividir correctamente los servicios. </p><br><p>  Si bien no hay muchas convenciones en Avito, su grupo se est√° expandiendo.  Mientras m√°s acuerdos de este tipo tengan la forma de un comando comprensible y conveniente, m√°s f√°cil ser√° mantener la coherencia entre los microservicios. </p><br><h2 id="sinteticheskie-testy">  Pruebas sint√©ticas </h2><br><p>  <strong>‚Ä¢ Prueba de circuito cerrado.</strong>  Para √©l, ahora estamos utilizando el c√≥digo abierto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hoverfly.io</a> .  Primero, registra la carga real en el servicio, luego, solo en un bucle cerrado, emula. </p><br><p>  <strong>‚Ä¢ Prueba de carga.</strong>  Intentamos llevar todos los servicios a un rendimiento √≥ptimo.  Y todas las versiones de cada servicio deben someterse a pruebas de resistencia, para que podamos entender el rendimiento actual del servicio y la diferencia con versiones anteriores del mismo servicio.  Si despu√©s de una actualizaci√≥n del servicio, su rendimiento se ha reducido una vez y media, esta es una se√±al clara para sus propietarios: debe profundizar en el c√≥digo y solucionar la situaci√≥n. <br>  Nos basamos en los datos recopilados, por ejemplo, para implementar correctamente el escalado autom√°tico y, al final, generalmente entendemos cu√°n escalable es el servicio. </p><br><p>  Durante las pruebas de resistencia, verificamos si el consumo de recursos cumple con los l√≠mites establecidos.  Y nos centramos principalmente en los extremos. </p><br><p>  <strong>a) Nos fijamos en la carga total.</strong> <br>  - Demasiado peque√±o: lo m√°s probable es que algo no funcione si la carga cae repentinamente varias veces. <br>  - Demasiado grande: se requiere optimizaci√≥n. </p><br><p> <strong>b) Nos fijamos en el l√≠mite por RPS.</strong> <br>  Aqu√≠ nos fijamos en la diferencia entre la versi√≥n actual y la anterior y el n√∫mero total.  Por ejemplo, si un servicio produce 100 rps, entonces est√° mal escrito o es su especificidad, pero en cualquier caso, esta es una ocasi√≥n para mirar muy de cerca el servicio. <br>  Si RPS, por el contrario, es demasiado, entonces quiz√°s alg√∫n tipo de error y algunos de los puntos finales dejaron de realizar la carga √∫til, pero <code>return true;</code> activa alg√∫n tipo de <code>return true;</code> </p><br><h2 id="canary-testy">  Pruebas canarias </h2><br><p>  Despu√©s de que se pasan las pruebas sint√©ticas, ejecutamos el microservicio en un peque√±o n√∫mero de usuarios.  Comenzamos con cuidado, con una peque√±a fracci√≥n de la audiencia estimada del servicio, menos del 0.1%.  En esta etapa, es muy importante que se establezcan las m√©tricas t√©cnicas y de producto correctas en el monitoreo para que muestren el problema en el servicio lo m√°s r√°pido posible.  El tiempo m√≠nimo para una prueba canaria es de 5 minutos, el principal es de 2 horas.  Para servicios complejos, configuramos la hora en modo manual. <br>  Analizamos: <br>  - m√©tricas espec√≠ficas del idioma, en particular los trabajadores php-fpm; <br>  - errores en Centinela; <br>  - estados de las respuestas; <br>  - tiempo de respuesta (tiempo de respuesta), preciso y promedio; <br>  - latencia; <br>  - excepciones, procesadas y sin procesar; <br>  - m√©tricas alimentarias. </p><br><h2 id="squeeze-testing">  Prueba de compresi√≥n </h2><br><p>  La prueba de compresi√≥n tambi√©n se llama prueba de extrusi√≥n.  El nombre de la t√©cnica se introdujo en Netflix.  Su esencia es que al principio llenamos una instancia con tr√°fico real al estado de falla y, por lo tanto, establecemos su l√≠mite.  Luego, agregue otra instancia y cargue esta pareja, nuevamente al m√°ximo;  vemos su techo y delta con el primer "apret√≥n".  Y entonces conectamos una instancia por paso y calculamos el patr√≥n de cambios. <br>  Los datos de prueba a trav√©s de "extrusi√≥n" tambi√©n se agrupan en la base de datos de m√©tricas generales, donde enriquecemos los resultados de la carga artificial con ellos o incluso los reemplazamos con "sint√©ticos". </p><br><h2 id="prodakshen">  Producci√≥n </h2><br><p>  <strong>‚Ä¢ Escalado.</strong>  Al extender el servicio a producci√≥n, hacemos un seguimiento de c√≥mo se escala.  En este caso, monitorear solo los indicadores de la CPU, en nuestra experiencia, es ineficiente.  El escalado autom√°tico con la evaluaci√≥n comparativa RPS en su forma pura funciona, pero solo para ciertos servicios, por ejemplo, la transmisi√≥n en l√≠nea.  Por lo tanto, estamos analizando principalmente las m√©tricas de productos espec√≠ficos de la aplicaci√≥n. </p><br><p>  <strong>Como resultado, al escalar, analizamos:</strong> <br>  - Indicadores de CPU y RAM, <br>  - el n√∫mero de solicitudes en la cola, <br>  - tiempo de respuesta <br>  - pron√≥stico basado en datos hist√≥ricos. </p><br><p>  Al escalar un servicio, tambi√©n es importante controlar sus dependencias para que no resulte que somos el primer servicio en la cadena de escalado, y aquellos a los que se refiere est√°n bajo carga.  Para establecer una carga aceptable para todo el conjunto de servicios, observamos los datos hist√≥ricos del servicio dependiente "m√°s cercano" (basado en una combinaci√≥n de CPU y RAM y m√©tricas espec√≠ficas de la aplicaci√≥n) y los comparamos con los datos hist√≥ricos del servicio de inicializaci√≥n, y as√≠ sucesivamente a lo largo de toda la "cadena de dependencia" ", De arriba a abajo. </p><br><h2 id="obsluzhivanie">  Servicio </h2><br><p>  Una vez que se pone en funcionamiento el microservicio, podemos colgar los activadores en √©l. </p><br><p>  <strong>Aqu√≠ hay situaciones t√≠picas en las que se dispara el fuego.</strong> <br>  - Migraciones potencialmente peligrosas detectadas. <br>  - Se han lanzado actualizaciones de seguridad. <br>  - El servicio en s√≠ no se ha actualizado durante mucho tiempo. <br>  - La carga en el servicio ha disminuido significativamente o cualquiera de sus m√©tricas de producto est√° m√°s all√° del rango normal. <br>  - El servicio ha dejado de cumplir con los requisitos de la nueva plataforma. </p><br><p>  Algunos de los desencadenantes son responsables de la estabilidad del trabajo, algunos en funci√≥n del servicio del sistema; por ejemplo, algunos servicios no se han implementado durante mucho tiempo y su imagen b√°sica ha dejado de pasar los controles de seguridad. </p><br><h1 id="dashbord">  Tablero de instrumentos </h1><br><p>  En resumen, el tablero es el panel de control de todo nuestro PaaS. </p><br><ul><li>  Un √∫nico punto de informaci√≥n sobre un servicio, con datos sobre su cobertura con pruebas, el n√∫mero de sus im√°genes, el n√∫mero de copias de producci√≥n, versiones, etc. </li><li>  Una herramienta para filtrar datos por servicios y etiquetas (marcadores de pertenencia a unidades de negocio, funcionalidad del producto, etc.) </li><li>  Medios de integraci√≥n con herramientas de infraestructura para rastreo, registro, monitoreo. </li><li>  Un √∫nico punto de documentaci√≥n de servicio. </li><li>  Un √∫nico punto de vista de todos los eventos de servicio. </li></ul><br><p><img src="https://habrastorage.org/webt/gi/lx/to/gilxtozg66qrpsxbrnjccubhiw0.png"><br><img src="https://habrastorage.org/webt/hq/wl/lc/hqwllckcrjfwl48sv_2qrjfefp4.png"><br><img src="https://habrastorage.org/webt/hu/ey/bj/hueybjd31isqaeav3w8iwx_oruq.png"><br><img src="https://habrastorage.org/webt/8z/ir/xk/8zirxkio-65hh2rqrj-impyozmc.png"></p><br><h1 id="itogo">  Total </h1><br><p>  Antes de la introducci√≥n de PaaS, un nuevo desarrollador podr√≠a pasar varias semanas clasificando todas las herramientas necesarias para lanzar un microservicio en producci√≥n: Kubernetes, Helm, nuestras caracter√≠sticas internas de TeamCity, configurando la conexi√≥n a bases de datos y cach√©s en una forma tolerante a fallas, etc. Ahora toma un par de horas leer el inicio r√°pido y hacer el servicio en s√≠. </p><br><hr><br><p>  Hice un informe sobre este tema para HighLoad ++ 2018, puede ver el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">video</a> y la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">presentaci√≥n</a> . </p><br><h1 id="bonus-trek-dlya-teh-kto-dochital-do-konca">  Bonus track para aquellos que han le√≠do hasta el final </h1><br><p>  Nosotros en Avito organizaremos una capacitaci√≥n interna de tres d√≠as para desarrolladores de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Chris Richardson</a> , un experto en arquitectura de microservicios.  Queremos darle la oportunidad de participar en √©l a uno de los lectores de esta publicaci√≥n.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu√≠</a> hay un programa de entrenamiento. </p><br><p>  La capacitaci√≥n se realizar√° del 5 al 7 de agosto en Mosc√∫.  Estos son d√≠as h√°biles que estar√°n completamente ocupados.  El almuerzo y la capacitaci√≥n ser√°n en nuestra oficina, y el participante elegido pagar√° el viaje y el alojamiento. </p><br><p>  Puede solicitar la participaci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en este formulario de Google</a> .  De usted: la respuesta a la pregunta de por qu√© exactamente necesita asistir a la capacitaci√≥n e informaci√≥n sobre c√≥mo contactarlo.  Responda en ingl√©s, porque Chris elegir√° al participante que llegue a la capacitaci√≥n. <br>  Anunciaremos el nombre del participante del entrenamiento como una actualizaci√≥n de esta publicaci√≥n en las redes sociales de Avito para desarrolladores (AvitoTech en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Facebook</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vkontakte</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Twitter</a> ) a m√°s tardar el 19 de julio. </p><br><p>  <em>UPD, 19/07:</em> Recibimos docenas de solicitudes.  Chris los examin√≥ y eligi√≥ un participante: junto con nuestros colegas, Andrei Igumnov ir√° a estudiar.  Felicidades </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/454780/">https://habr.com/ru/post/454780/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454766/index.html">HBO, gracias por recordarme ... "Kit de primeros auxilios de Chernobyl" de un farmac√©utico bielorruso</a></li>
<li><a href="../454770/index.html">Samsung Startup Membership: un nuevo programa para startups en Rusia</a></li>
<li><a href="../454774/index.html">Escribimos el c√≥digo m√°s √∫til en nuestra vida, pero lo tiramos a la basura. Con nosotros</a></li>
<li><a href="../454776/index.html">¬øIndependiente u oficina? Respuesta independiente</a></li>
<li><a href="../454778/index.html">El libro "Machine Learning: Algorithms for Business"</a></li>
<li><a href="../454788/index.html">Arma de un inversor cauteloso: consideramos el valor razonable de los bonos de inversi√≥n</a></li>
<li><a href="../454790/index.html">Imagen nativa de Java: comprobaci√≥n de usabilidad</a></li>
<li><a href="../454792/index.html">Comparaci√≥n de algoritmos de clasificaci√≥n de intercambio</a></li>
<li><a href="../454804/index.html">Crea tu componente con micro-plantillas</a></li>
<li><a href="../454806/index.html">Entrenamiento Cisco 200-125 CCNA v3.0. D√≠a 9. El mundo f√≠sico de los interruptores. Parte 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>