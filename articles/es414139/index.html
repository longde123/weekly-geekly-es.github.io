<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õ∞Ô∏è üèîÔ∏è üßëüèª‚Äçü§ù‚Äçüßëüèª Lanzamiento del proxy MTProto no oficial en Python, caracter√≠sticas del protocolo üö© üíáüèæ üçâ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recientemente, los desarrolladores de Telegram han publicado el c√≥digo fuente de un servidor proxy que se ejecuta en el protocolo MTProto. Los art√≠cul...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Lanzamiento del proxy MTProto no oficial en Python, caracter√≠sticas del protocolo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414139/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/078/b5e/231/078b5e231cde514698b9db4d21cf40cf.png" alt="imagen" width="300"></div><br>  Recientemente, los desarrolladores de Telegram han publicado el c√≥digo fuente de un servidor proxy que se ejecuta en el protocolo MTProto.  Los art√≠culos sobre las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">caracter√≠sticas de su ensamblaje</a> y el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">reempaque del contenedor acoplable con √©l</a> se publicaron en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hub</a> .  El servidor proxy oficial, escrito en C, sorprende con la cantidad de c√≥digo, aproximadamente 23 mil l√≠neas.  Al mismo tiempo, y a veces un poco antes, surgieron varias implementaciones alternativas, pero ninguna de ellas admit√≠a la posibilidad de anunciar su canal. <br><br>  En este art√≠culo, me gustar√≠a, en primer lugar, hablar sobre las caracter√≠sticas poco conocidas del protocolo para comunicar un servidor proxy con servidores externos y, en segundo lugar, hablar sobre nuestro propio desarrollo: la implementaci√≥n de un servidor proxy en Python, que acaba de lanzarse y est√° disponible para todos Licencia MIT gratuita. <br><a name="habracut"></a><br><h3>  Caracter√≠sticas de la interacci√≥n del servidor proxy con servidores externos. </h3><br><ol><li>  El servidor proxy oficial no interact√∫a directamente con los servidores de telegramas, pero utiliza al menos una capa proxy m√°s para esto.  Los llamaremos <b>middle-proxy</b> , su lista est√° disponible en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">core.telegram.org/getProxyConfig</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">core.telegram.org/getProxyConfigV6</a> .  La conexi√≥n IPv6 a√∫n no es compatible con el servidor proxy oficial. <br></li><li>  Para cifrar datos entre el servidor proxy y el proxy medio, se utiliza una clave que se obtiene de las direcciones IP de ambos nodos.  Por lo tanto, el servidor proxy para conectarse al proxy medio debe conocer su direcci√≥n IP externa, de lo contrario, las claves de cifrado en uno y el otro lado ser√°n diferentes.  Adem√°s, los n√∫meros de puerto de ambos nodos y el secreto compartido, disponibles en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">core.telegram.org/getProxySecret,</a> participan en la formaci√≥n de la clave.  Los desarrolladores de Telegram recomiendan actualizar este secreto una vez al d√≠a. <br></li><li>  Al conectar un servidor proxy a un proxy medio, el primero transfiere su tiempo.  Si el tiempo difiere en m√°s de unos pocos minutos, el segundo lado cierra la conexi√≥n. <br></li><li>  Al enviar un mensaje del cliente al proxy central, el mensaje se envuelve en una llamada RPC al protocolo MTProto.  En cada una de estas llamadas RPC, el proxy agrega varios argumentos: ip y puerto de ambos nodos, un identificador de conexi√≥n aleatorio, as√≠ como la etiqueta del servidor proxy utilizada para mostrar el canal publicitario en la aplicaci√≥n.  Estos argumentos adicionales ocupan aproximadamente 96 bytes.  Debido a esta caracter√≠stica, no ser√° posible mostrar canales publicitarios cuando trabaje directamente, no a trav√©s de un proxy intermedio. <br></li><li>  Los servidores de Telegram "creen" la informaci√≥n sobre el cliente ip recibido del servidor proxy.  Estas direcciones se pueden ver en la informaci√≥n de la sesi√≥n (se dibuja el rect√°ngulo): <br><img src="https://habrastorage.org/getpro/habr/post_images/0d5/540/149/0d5540149b03b6a130541839fe58fb5c.jpg" alt="imagen"><br><br></li><li>  Una conexi√≥n TCP entre el servidor proxy y el proxy medio env√≠a mensajes de diferentes usuarios.  En las solicitudes y respuestas hay un argumento "identificador de conexi√≥n aleatorio", que es necesario para que los datos lleguen al cliente correcto. <br></li><li>  Un servidor proxy no puede descifrar los datos del cliente, pero puede distinguir los mensajes regulares de los archivos transmitidos.  Adem√°s, √©l conoce el tama√±o de cada mensaje. <br></li></ol><br>  Fuf, espero no estar cansado de los detalles t√©cnicos.  Ahora debe quedar claro por qu√© en muchos servidores proxy alternativos no hay soporte publicitario: env√≠an mensajes directamente a los servidores de telegramas, sin pasar por el proxy intermedio.  Resulta mucho m√°s f√°cil.  La segunda parte del art√≠culo describe la primera implementaci√≥n no oficial de un servidor proxy que funciona a trav√©s del proxy medio.  Por el momento, en el dominio p√∫blico puede encontrar tres implementaciones de este tipo: oficial, en Erlang y esta. <br><br><h3>  Implementaci√≥n de proxy Python </h3><br>  Inicialmente, el servidor proxy se escribi√≥ para comprender las caracter√≠sticas del protocolo y fue el desarrollo de otro proyecto: un proxy de calcetines as√≠ncronos, escrito, a su vez, para "tocar" as√≠ncrono / esperar en Python. <br><br>  Poco a poco, el proyecto comenz√≥ a tener usuarios que se vieron inundados de preguntas, informes de errores y solicitudes de funciones.  Despu√©s de las mejoras, el proyecto entr√≥ en la etapa de prueba beta y estabilizaci√≥n, que dur√≥ aproximadamente una semana e involucr√≥ a cinco servidores de diferentes configuraciones. <br><br>  Antes de hablar sobre las caracter√≠sticas que el servidor proxy oficial a√∫n no tiene, pero el proxy alternativo s√≠ tiene (y guardar silencio sobre las funciones que el proxy oficial no tiene como alternativa), hablar√© sobre lo que muchas personas piensan primero cuando mencionan la palabra Python . <br><br><h4>  Rendimiento </h4><br>  Para las pruebas de rendimiento, se utiliz√≥ una m√°quina virtual en una nube de configuraci√≥n m√≠nima: 1 CPU, 1024 MB de RAM. <br><br>  En las pruebas sint√©ticas, el servidor proxy pudo transmitir aproximadamente 240 megabits / seg o 3000 mensajes / seg.  Cuando se usa una implementaci√≥n alternativa del bucle de eventos en C, que se llama uvloop, y tambi√©n cuando se usa el int√©rprete PyPy, los datos de rendimiento son diferentes (todas las mediciones son por segundo): <br><img src="https://habrastorage.org/getpro/habr/post_images/0f9/7e2/8b9/0f97e28b974f46daa21b8c4d76122e02.png" alt="imagen"><br><br>  Al probar en usuarios reales, result√≥ que dicho servidor era suficiente para atender c√≥modamente a 4.000 usuarios u 8.000 cuando usaba PyPy. Una gran sorpresa fue que, sin importar c√≥mo se anunciara el servidor de prueba en los canales de habla rusa, todav√≠a el 89% de los usuarios eran de Ir√°n (quiz√°s para otros pa√≠ses el n√∫mero de usuarios servidos simult√°neamente ser√° diferente).  Se ve as√≠: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/23a/bec/039/23abec039507f1e90d53e133cffd0b00.png" alt="imagen"><br><br>  Pregunt√© a varios administradores de otros servidores: su situaci√≥n es la misma.  Quiz√°s esto se deba al hecho de que en Rusia el telegrama funciona bien sin servidores proxy.  En Ir√°n, los servidores de prueba fueron bloqueados para el p√∫blico varias horas despu√©s de su creaci√≥n. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/045/209/eb2/045209eb2d2fa72ca624ca2c46b3912c.png" alt="imagen"><br><br>  Carga del servidor con 2.000 usuarios.  El momento de bloquear el servidor para los ciudadanos iran√≠es es claramente visible. <br><br>  Por lo tanto, el rendimiento de la CPU no es un cuello de botella en el nodo de prueba.  Con 10.000 clientes, es probable que se agote la memoria. <br><br>  No se implementa el uso simult√°neo de varios n√∫cleos de CPU (hola, GIL). <br><br><h4>  Caracter√≠sticas que el servidor proxy oficial a√∫n no tiene </h4><br>  <b>Trabaja en el protocolo IPv6.</b> <br>  Un servidor proxy sin configuraci√≥n adicional puede usar IPv6 para conexiones salientes.  Las conexiones IPv6 no est√°n bloqueadas en Rusia (por ahora). <br><br>  <b>Modo de funcionamiento sin proxy intermedio</b> <br>  Si no se necesita publicidad en el canal, el proxy se conecta autom√°ticamente directamente a los servidores de telegramas, sin pasar por el proxy intermedio.  Es m√°s r√°pido y m√°s confiable. <br><br>  Adem√°s, se implementa el " <b>modo r√°pido</b> " opcional, cuando los mensajes del servidor Telegram al proxy y del proxy al cliente se cifran con la misma clave.  Por lo tanto, el proxy no necesita volver a cifrar los mensajes: los env√≠a tal cual.  Esto no deber√≠a afectar la seguridad.  En cualquier caso, el administrador proxy no tiene acceso a los mensajes de los usuarios. <br><br>  <b>Actualice autom√°ticamente la lista de proxy intermedio y el secreto una vez al d√≠a.</b> <br>  El servidor proxy oficial para actualizar la lista de proxy intermedio recomienda reiniciar el contenedor docker una vez al d√≠a, lo que restablece todas las conexiones.  Es posible que no se establezcan nuevas conexiones si, por ejemplo, un servidor est√° bloqueado en el pa√≠s.  La versi√≥n de Python visita peri√≥dicamente el sitio y actualiza la lista. <br><br>  <b>Multiplataforma</b> <br>  Cualquier plataforma que ejecute Python es compatible.  Result√≥ funcionar incluso en el iPad, sin embargo, el dispositivo bloque√≥ las conexiones entrantes externas.  Windows es compatible por separado, fue una sorpresa para m√≠ cu√°ntas personas lanzan proxies bajo este sistema operativo.  Aunque en Windows puede ejecutar el cliente oficial si utiliza tecnolog√≠as de virtualizaci√≥n o acoplador. <br><br>  <b>La capacidad de correr f√°cilmente sin docker.</b> <br>  Si (de repente) hay quienes no les gusta Docker, se puede iniciar un proxy sin √©l.  Debe especificar al menos dos par√°metros en el archivo de configuraci√≥n: puerto y secreto, tambi√©n puede establecer la etiqueta publicitaria opcional, luego ejecutar el comando: python3 mtprotoproxy.py.  Sin embargo, en este caso, tendr√° que pensar en la ejecuci√≥n autom√°tica en el sistema operativo, por ejemplo, escribir un archivo unitario para systemd.  Tambi√©n necesitar√° instalar pycrypto o pycryptodome, sin √©l funcionar√°, pero muy lentamente. <br><br>  En el caso de docker, el contenedor se puede reconstruir con el comando docker-compose up --build. <br><br><h4>  Caracter√≠sticas programadas para el pr√≥ximo lanzamiento </h4><br>  <b>Limitar la velocidad de descarga de archivos grandes.</b> <br>  Al descargar archivos grandes, puede, en el nivel TCP, "pedir" al proxy intermedio o al servidor Telegram que env√≠e datos m√°s lentamente.  Ahora esto se hace configurando un peque√±o valor del b√∫fer de recepci√≥n, que adem√°s ahorra memoria del servidor. <br><br>  <b>Streaming de mensajes.</b> <br>  Ahora, todos los servidores proxy conocidos que trabajan con proxy intermedio primero leen el mensaje del cliente y solo luego lo transmiten.  El tama√±o de un mensaje puede alcanzar 1 MB.  Se requiere una memoria para su almacenamiento y el retraso de transmisi√≥n aumenta ligeramente.  Puede transferir la transmisi√≥n de datos.  Esto complicar√° el c√≥digo, pero reducir√° el consumo de memoria en el peor de los casos. <br><br>  <b>Cambie la longitud de los paquetes para omitir el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">filtro a lo largo de la longitud del paquete</a></b> . <br>  No logr√© entrar en el lanzamiento. <br><br><h4>  Instalaci√≥n y lanzamiento </h4><br><ol><li>  git clone -b estable <a href="">github.com/alexbers/mtprotoproxy.git;</a>  cd mtprotoproxy </li><li>  <i>(opcional, recomendado)</i> especifique <b>PORT</b> , <b>USERS</b> y <b>AD_TAG</b> en config.py </li><li>  docker-compose up --build -d (o python3 mtprotoproxy.py, sin docker) </li><li>  <i>(opcional, muestra un enlace de la forma tg: //)</i> registros de docker-compose </li></ol><br><img src="https://habrastorage.org/getpro/habr/post_images/d6b/49b/f6d/d6b49bf6d03896df661dcc8af524ed6a.png" alt="imagen"><br><br>  <b>Otras implementaciones de proxy MTProto con soporte para publicidad en canales:</b> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Oficial</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">En Erlang</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">En pit√≥n</a> </li></ul><br><br>  <b>Agradecimientos</b> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">seriyps</a> : para obtener ayuda con las pruebas en usuarios reales <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">shifttstas</a> - para consejos de docker <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">forst</a> (github): para la idea e implementaci√≥n del trabajo en IPv6 <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">p1ratrulezzz</a> (github) - para consejos y un art√≠culo sobre el proyecto <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">freekzy</a> (github): para un parche de error con fuga de mango <br><br>  <b>UPD:</b> repositorio que compila diferentes implementaciones del proxy MTProto: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/mtProtoProxy</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es414139/">https://habr.com/ru/post/es414139/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es414129/index.html">M√°ster en Inform√°tica Te√≥rica en la Universidad Estatal de San Petersburgo</a></li>
<li><a href="../es414131/index.html">El efecto de la frecuencia de la se√±al en la energ√≠a de los enlaces de radio en el espacio libre</a></li>
<li><a href="../es414133/index.html">Dise√±o de juego de rompecabezas con el ejemplo de In The Shadows</a></li>
<li><a href="../es414135/index.html">C√≥mo portar un juego a PSVita mejor√≥ el rendimiento general</a></li>
<li><a href="../es414137/index.html">Experiencia de desarrollo de SPA en VueJS + Nuxt</a></li>
<li><a href="../es414141/index.html">7 reglas para dise√±ar placas de circuito impreso</a></li>
<li><a href="../es414149/index.html">Las razones del mal sonido de la mayor√≠a de los tel√©fonos inteligentes Android</a></li>
<li><a href="../es414151/index.html">Fintech-digest: los bancos informar√°n da√±os por ataques de hackers, Western Union se niega a trabajar con criptomonedas</a></li>
<li><a href="../es414155/index.html">Sistemas de eventos en Unity3D</a></li>
<li><a href="../es414157/index.html">M√°s f√°cil de lo que parece. Cap√≠tulos 6-7</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>