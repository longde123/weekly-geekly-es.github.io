<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïó üê∂ üë©üèæ‚Äçü§ù‚Äçüë®üèª 5 trucos para optimizar consultas SQL en Greenplum ‚ò£Ô∏è ‚öñÔ∏è üöß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cualquier proceso relacionado con la base de datos, tarde o temprano, encuentra problemas con el rendimiento de las consultas a esta base de datos. 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>5 trucos para optimizar consultas SQL en Greenplum</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/rostelecom/blog/442758/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/-5/0k/gz/-50kgzc35o2xwh_r_xzqqavfglg.jpeg"></a> <br><br>  Cualquier proceso relacionado con la base de datos, tarde o temprano, encuentra problemas con el rendimiento de las consultas a esta base de datos. <br><br>  El almac√©n de datos de Rostelecom se basa en Greenplum, la mayor√≠a de los c√°lculos (transformaci√≥n) se realizan mediante consultas sql, que inician (o generan e inician) el mecanismo ETL.  DBMS tiene sus propios matices que afectan significativamente el rendimiento.  Este art√≠culo es un intento de resaltar los aspectos m√°s cr√≠ticos de trabajar con Greenplum en t√©rminos de rendimiento y compartir experiencias. <br><br><div class="spoiler">  <b class="spoiler_title">En pocas palabras sobre Greenplum</b> <div class="spoiler_text"> Greenplum: servidor de base de datos <abbr title="Procesamiento paralelo masivo">MPP</abbr> , cuyo n√∫cleo se basa en PostgreSql. <br><br>  Representa varias instancias diferentes del proceso PostgreSql (instancias).  Uno de ellos es el punto de entrada para el cliente y se llama instancia maestra (maestra), todas las dem√°s se llaman instancias de segmento (segmento, instancias independientes, cada una de las cuales tiene su propia pieza de datos).  Cada servidor (host de segmento) puede ejecutarse de uno a varios servicios (segmento).  Esto se hace para utilizar mejor los recursos del servidor y principalmente los procesadores.  El asistente almacena metadatos, es responsable de comunicar a los clientes con datos y tambi√©n distribuye el trabajo entre segmentos. <br><br><img src="https://habrastorage.org/webt/pd/9n/sa/pd9nsaodhcjqwwhzsfvvdflqlou.jpeg"><br><br>  Lea m√°s en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n oficial</a> . <br></div></div><br>  Adem√°s en el art√≠culo habr√° muchas referencias al plan de solicitud.  La informaci√≥n para Greenplum est√° disponible <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br><h2>  C√≥mo escribir buenas consultas en Greenplum (bueno, o al menos no del todo triste) </h2><a name="habracut"></a><br>  Como estamos tratando con una base de datos distribuida, es importante no solo c√≥mo se escribe la consulta SQL, sino tambi√©n c√≥mo se almacenan los datos. <br><br><h3>  1. Distribuci√≥n </h3><br>  Los datos se almacenan f√≠sicamente en diferentes segmentos.  Puede separar los datos por segmentos al azar o por el valor de la funci√≥n hash de un campo o un conjunto de campos. <br><br>  Sintaxis (al crear una tabla): <br><br><pre><code class="sql hljs">DISTRIBUTED BY (some_field)</code> </pre> <br>  M√°s o menos: <br><br><pre> <code class="sql hljs">DISTRIBUTED RANDOMLY</code> </pre> <br>  El campo de distribuci√≥n debe tener una buena selectividad y no tener valores nulos (o tener un m√≠nimo de dichos valores), ya que los registros con dichos campos se distribuir√°n en un segmento, lo que puede conducir a distorsiones de datos. <br><br>  El tipo de campo es preferiblemente entero.  El campo se usa para unir tablas.  Hash join es una de las mejores formas de unir tablas (en t√©rminos de ejecuci√≥n de consultas), funciona mejor con este tipo de datos. <br><br>  Para la distribuci√≥n, es aconsejable elegir no m√°s de dos campos y, por supuesto, uno es mejor que dos.  Los campos adicionales en las claves de distribuci√≥n, en primer lugar, requieren tiempo adicional para el hash, y en segundo lugar (en la mayor√≠a de los casos) requerir√°n la transferencia de datos entre segmentos al ejecutar uniones. <br><br>  Puede utilizar la distribuci√≥n aleatoria si no puede seleccionar uno o dos campos adecuados, as√≠ como para etiquetas peque√±as.  Pero debemos tener en cuenta que dicha distribuci√≥n funciona mejor para la inserci√≥n de datos en masa, y no para un registro.  GreenPlum distribuye datos de acuerdo con el algoritmo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">c√≠clico</a> , y comienza un nuevo ciclo para cada operaci√≥n de inserci√≥n, comenzando desde el primer segmento, que, con peque√±as inserciones frecuentes, conduce a sesgos (sesgo de datos). <br><br>  Con un campo de distribuci√≥n bien elegido, todos los c√°lculos se realizar√°n en el segmento, sin enviar datos a otros segmentos.  Adem√°s, para una uni√≥n √≥ptima de tablas (join), los mismos valores deben ubicarse en el mismo segmento. <br><br><div class="spoiler">  <b class="spoiler_title">Distribuci√≥n en im√°genes.</b> <div class="spoiler_text">  <i>Buena clave de distribuci√≥n:</i> <br><img src="https://habrastorage.org/webt/x-/r9/8i/x-r98iuubqw2tkoea-tblqbgj-m.jpeg" height="700"><br><br>  <i>Mala clave de distribuci√≥n:</i> <br><img src="https://habrastorage.org/webt/79/ft/-g/79ft-gs67yhdwwq156dmxlsz74o.png"><br><br>  <i>Distribuci√≥n aleatoria:</i> <br><img src="https://habrastorage.org/webt/r8/eo/xr/r8eoxrz1t0eksmnylw7yco33rkm.png" height="700"><br></div></div><br>  El tipo de campos utilizados en join debe ser el mismo en todas las tablas. <br>  <b>Importante:</b> no use como campos de distribuci√≥n aquellos que se usan para filtrar consultas en donde, ya que en este caso la carga durante la consulta tampoco se distribuir√° de manera uniforme. <br><br><h3>  2. Particionamiento </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La partici√≥n le</a> permite dividir tablas grandes, como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hechos</a> , en piezas separadas l√≥gicamente.  Greenplum divide f√≠sicamente su tabla en tablas separadas, cada una de las cuales se divide en segmentos seg√∫n la configuraci√≥n de la p. 1. <br><br>  Las tablas deben dividirse l√≥gicamente en secciones, para este prop√≥sito, seleccione el campo que se usa con frecuencia en el bloque where.  De hecho tablas este ser√° el per√≠odo.  Por lo tanto, con el acceso adecuado a la tabla en consultas, solo trabajar√° con parte de la tabla grande completa. <br><br>  En general, la partici√≥n es un tema bastante conocido, y quer√≠a enfatizar que no debe elegir el mismo campo para la partici√≥n y distribuci√≥n.  Esto conducir√° al hecho de que la solicitud se ejecutar√° completamente en un segmento. <br><br>  Es hora de ir, de hecho, a las solicitudes.  La solicitud se ejecutar√° en segmentos de acuerdo con un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">plan</a> espec√≠fico: <br><br><h3>  3. El optimizador </h3><br>  Greenplum tiene dos optimizadores, el optimizador heredado incorporado y el optimizador Orca de terceros: GPORCA - Orca - Pivotal Query Optimizer. <br><br>  Habilitar GPORCA a petici√≥n: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> optimizer = <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;</code> </pre> <br>  <b>Como regla general</b> , el optimizador GPORCA es mejor que el incorporado.  Funciona m√°s adecuadamente con subconsultas y <abbr title="Expresiones de tabla comunes">CTE</abbr> (m√°s detalles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> ). <br>  Realiz√≥ una llamada a una tabla grande en CTE con el m√°ximo filtrado de datos (no se olvide de la poda de particiones) y una lista expl√≠citamente especificada de campos: funciona muy bien. <br><br>  Modifica ligeramente el plan de consulta, por ejemplo, de lo contrario muestra las particiones escaneadas: <br><br>  <i>Optimizador est√°ndar:</i> <br><br><img src="https://habrastorage.org/webt/hg/0u/rq/hg0urqdrlaefwysxwszfpww18mc.png"><br><br>  <i>Orca</i> <br><br><img src="https://habrastorage.org/webt/ct/hv/dz/cthvdzt2s5p126cdu1olhb5teci.png"><br><br>  GPORCA tambi√©n permite actualizar los campos de partici√≥n / distribuci√≥n.  Aunque hay situaciones en las que el optimizador incorporado funciona mejor.  Un optimizador de terceros es muy exigente con las estad√≠sticas, es importante no olvidar <abbr title="analizar">analizar</abbr> . <br><br>  No importa cu√°n bueno sea el optimizador, una consulta mal escrita ni siquiera estirar√° a Orca: <br><br><h3>  4. Manipulaciones con campos en las condiciones donde bloquear o unir </h3><br>  Es importante recordar que la funci√≥n aplicada al campo de filtro o las condiciones de la uni√≥n se aplica a <b>cada</b> registro. <br><br>  En el caso del campo de particionamiento (por ejemplo, date_trunc al campo de particionamiento - fecha), incluso GPORCA no puede funcionar correctamente en este caso, el <abbr title="poda de partici√≥n">recorte de particiones</abbr> no funcionar√°. <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--     set optimizer = on; explain select * from edw_ods.t_000045_bills c where date_trunc('month',tech_dt) between to_date('20180101', 'YYYYMMDD') and to_date('20180101', 'YYYYMMDD') + interval '1 month - 1 second' ;</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/sc/qo/qv/scqoqv3h43a7ezkr4ug2zu8i9ta.png"><br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--     set optimizer = on; explain select * from edw_ods.t_000045_bills c where tech_dt between to_date('20180101', 'YYYYMMDD') and to_date('20180101', 'YYYYMMDD') + interval '1 month - 1 second'</span></span></code> </pre><br><img src="https://habrastorage.org/webt/mo/xz/ah/moxzahjrapobpn_4dss02qykihc.png"><br><br>  <i>Tambi√©n llamo la atenci√≥n sobre la visualizaci√≥n de particiones.</i>  <i>El optimizador incorporado mostrar√° particiones en una lista:</i> <br><br><img src="https://habrastorage.org/webt/lf/it/wk/lfitwkzpj9xkbvnteyq6ynzc-rw.png"><br><br>  Aplique cuidadosamente las funciones a las constantes en los mismos filtros de partici√≥n.  Un ejemplo es el mismo date_trunc: <br><br><pre> <code class="sql hljs">date_trunc('month',to_date($p_some_dt, 'YYYYMMDD'))</code> </pre> <br><img src="https://habrastorage.org/webt/t8/ox/u1/t8oxu1zcmjm0ymsmgj0-we_dp7m.png"><br><br>  GPORCA har√° frente por completo a esa finta y funcionar√° correctamente, el optimizador est√°ndar ya no lo har√°.  Sin embargo, al hacer una conversi√≥n de tipo expl√≠cita, puede hacer que funcione: <br><br><pre> <code class="sql hljs">date_trunc('month',to_date($p_some_dt, 'YYYYMMDD'))::timestamp without time zone</code> </pre> <br><img src="https://habrastorage.org/webt/5y/in/3p/5yin3ppep3f9wuzd9ib_kxa2bdm.png"><br><br>  ¬øY si todo se hace mal? <br><br><h3>  5. Mociones </h3><br>  Otro tipo de operaci√≥n que se puede observar en <i>el plan de consulta</i> son los movimientos.  Movimientos de datos tan marcados entre segmentos: <br><br><ul><li>  <b>Recopilar movimiento</b> : se mostrar√° en casi todos los planes, lo que significa combinar los resultados de la ejecuci√≥n de consultas de todos los segmentos en una secuencia (generalmente al maestro). <br><br>  Dos tablas, distribuidas por una clave, que se utilizan para la uni√≥n, realizan todas las operaciones en segmentos, sin mover datos.  De lo contrario, se produce movimiento de difusi√≥n o movimiento de redistribuci√≥n: </li><li>  <b>Movimiento de transmisi√≥n</b> : cada segmento env√≠a su copia de los datos a otros segmentos.  En una situaci√≥n ideal, la transmisi√≥n se produce solo para tablas peque√±as. </li><li>  <b>Movimiento de redistribuci√≥n</b> : para unir tablas grandes distribuidas en diferentes claves, la redistribuci√≥n se realiza para hacer conexiones localmente.  Para mesas grandes, esta puede ser una operaci√≥n bastante costosa. </li></ul><br>  La difusi√≥n y la redistribuci√≥n son operaciones bastante desventajosas.  Se ejecutan cada vez que se ejecuta la solicitud.  Se recomienda evitarlos.  Habiendo visto estos puntos en el plan de consulta, vale la pena prestar atenci√≥n a las claves de distribuci√≥n.  Las operaciones distintivas y sindicales tambi√©n causan mociones. <br><br>  Esta lista no es exhaustiva y se basa principalmente en la experiencia del autor.  No funcion√≥ encontrar todo de inmediato en Internet al mismo tiempo.  Aqu√≠ trat√© de identificar los factores m√°s cr√≠ticos que afectan el rendimiento de la solicitud y entender por qu√© y por qu√© sucede esto. <br><br>  <i>Este art√≠culo fue preparado por el equipo de gesti√≥n de datos de Rostelecom</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/442758/">https://habr.com/ru/post/442758/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442744/index.html">Soluci√≥n RIPE y sus consecuencias para la exclusi√≥n de dos LIR rusos (Netup, gcxc.net)</a></li>
<li><a href="../442746/index.html">Aplicaci√≥n tonta para la tienda de Windows</a></li>
<li><a href="../442748/index.html">Lo que pasa con el sombrero: los 10 mejores informes de Heisenbug 2018 Mosc√∫</a></li>
<li><a href="../442750/index.html">Virtual Djinn el 8 de marzo, o c√≥mo sorprender a tus empleados en un d√≠a de primavera</a></li>
<li><a href="../442754/index.html">Bases de datos operativas frente a anal√≠ticas: almacenamiento de columnas frente a filas</a></li>
<li><a href="../442760/index.html">Un art√≠culo sobre c√≥mo CommVault respalda PostgreSQL</a></li>
<li><a href="../442762/index.html">Aprendiz Vasya y sus historias sobre idempotencia API</a></li>
<li><a href="../442764/index.html">Resumen de gesti√≥n de productos. Lo que emociona a los productos y a los vendedores en 2019</a></li>
<li><a href="../442770/index.html">Descripci√≥n general de los esc√°neres de c√≥digo de barras JavaScript</a></li>
<li><a href="../442772/index.html">Matem√°ticas para el cient√≠fico de datos: secciones necesarias</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>