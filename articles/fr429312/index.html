<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèä üï≥Ô∏è üßë‚Äçü§ù‚Äçüßë Logique de jeu commune sur le client et le serveur ‚úçüèæ üë©üèº üêé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lors des Pixonic DevGAMM Talks, notre DTO Anton Grigoriev a √©galement pris la parole. Nous, dans l'entreprise, avons d√©j√† dit que nous travaillions su...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Logique de jeu commune sur le client et le serveur</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pixonic/blog/429312/">  Lors des Pixonic DevGAMM Talks, notre DTO Anton Grigoriev a √©galement pris la parole.  Nous, dans l'entreprise, avons d√©j√† dit que nous travaillions sur un nouveau jeu de tir PvP et Anton a partag√© certaines des nuances de l'architecture de ce projet.  Il a expliqu√© comment construire le d√©veloppement de mani√®re √† ce que les changements dans la logique de jeu du client apparaissent automatiquement sur le serveur (et vice versa), et s'il est possible de ne pas √©crire de code, mais de minimiser le trafic.  Vous trouverez ci-dessous un enregistrement et une transcription du rapport. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/eFd4WZBHqDw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br>  Je n‚Äôapprendrai pas √† faire quelque chose, je parlerai de la fa√ßon dont nous l‚Äôavons fait.  Pour ne pas marcher sur le m√™me r√¢teau et profiter de notre exp√©rience.  Il y a un an et demi, nous, dans l'entreprise, ne savions pas comment fabriquer des tireurs sur des t√©l√©phones portables.  Vous dites comment c'est, vous avez des robots de guerre, 100 millions de t√©l√©chargements, 1,5 million de DAU.  Mais dans ce jeu, les robots sont tr√®s lents, et nous voulions faire un tireur rapide, et l'architecture de War Robots ne le permettait pas. <br><br>  Nous savions comment et quoi faire, mais nous n'avions aucune exp√©rience.  Ensuite, nous avons embauch√© une personne qui a eu cette exp√©rience et lui avons dit: faites la m√™me chose que vous avez d√©j√† fait cent fois, mais en mieux.  Puis ils se sont assis et ont commenc√© √† penser √† l'architecture. <br><br><img src="https://habrastorage.org/webt/ta/cm/lz/tacmlz5phqxz6vg6kvpdjwjklaq.png"><br><br>  Entr√© dans le syst√®me de composants d'entit√© (ECS).  Je pense que beaucoup de gens savent ce que c'est.  Tous les objets du monde sont repr√©sent√©s par des entit√©s.  Par exemple, un joueur, son arme, un objet sur la carte.  Ils ont des propri√©t√©s d√©crites par les composants.  Par exemple, le composant Transformer est la position du joueur dans l'espace et le composant Sant√© est sa sant√©.  Il y a une logique - elle est s√©par√©e et repr√©sent√©e par des syst√®mes.  En r√®gle g√©n√©rale, les syst√®mes sont la m√©thode Execute (), qui passe √† travers les composants d'un certain type et fait quelque chose avec eux, avec le monde du jeu.  Par exemple, MoveSystem passe en revue tous les composants de Movement, examine la vitesse dans ce composant, le param√®tre et, sur cette base, calcule la nouvelle position de l'objet, c'est-√†-dire  l'√©crit dans Transform. <br><br>  Une telle architecture a ses propres caract√©ristiques.  Lors du d√©veloppement sur ECS, vous devez penser et faire les choses diff√©remment.  L'un des avantages est la composition plut√¥t que l'h√©ritage multiple.  Rappelez-vous ce rhombique avec h√©ritage multiple en C ++?  Tous ses probl√®mes.  Ce n'est pas le cas chez ECS. <br><br><img src="https://habrastorage.org/webt/eh/0e/2-/eh0e2-7mx_yl1ls4gp65yobizew.png"><br><br>  La deuxi√®me caract√©ristique est la s√©paration de la logique et des donn√©es, dont j'ai d√©j√† parl√©.  Qu'est-ce que cela nous donne?  Nous pouvons stocker l'√©tat du monde et son histoire par lots, nous pouvons le s√©rialiser, nous pouvons envoyer ces donn√©es sur le r√©seau et les modifier en temps r√©el.  Ce ne sont que des donn√©es en m√©moire - nous pouvons modifier n'importe quelle valeur √† tout moment.  Ainsi, il est tr√®s pratique de changer la logique du jeu (ou pour le d√©bogage). <br><br>  Il est √©galement tr√®s important de garder une trace de l'ordre des appels syst√®me.  Tous les syst√®mes se succ√®dent, sont appel√©s par la m√©thode Execute () et, id√©alement, doivent √™tre ind√©pendants.  En pratique, cela ne se produit pas.  Un syst√®me change quelque chose dans le monde, un autre syst√®me l'utilise ensuite.  Et si nous cassons cet ordre, le jeu se d√©roulera diff√©remment.  Probablement pas beaucoup, mais certainement pas le m√™me qu'auparavant. <br><br>  Enfin, l'une des fonctionnalit√©s principales et les plus importantes pour nous est que nous pouvons ex√©cuter le m√™me code √† la fois sur le client et sur le serveur. <br><br>  Donnez au d√©veloppeur une opportunit√©, et il trouvera 99 fa√ßons et raisons de prendre sa d√©cision, et n'utilisera pas celles existantes.  Je pense que beaucoup l'ont fait.  Nous recherchions le cadre ECS √† cette √©poque.  Nous avons consid√©r√© Entitas, Artemis C #, Ash.net et notre propre solution, qui pourrait √™tre √©crite √† partir de l'exp√©rience d'un sp√©cialiste qui est venu chez nous. <br><br><img src="https://habrastorage.org/webt/v8/sb/dt/v8sbdteegwxn_milbcee_wc6qde.png"><br><br>  N'essayez pas de lire ce qui est √©crit sur la diapositive, ce n'est pas si important.  L'important est la quantit√© de vert et de rouge dans les colonnes.  Vert signifie que la solution prend en charge les exigences, rouge - ne prend pas en charge, jaune - prend en charge, mais pas tout √† fait. <br><br>  Dans la colonne, ECS est potentiellement notre solution.  Comme vous pouvez le voir, il fait plus frais - nous pourrions prendre en charge beaucoup plus d'exigences.  En cons√©quence, nous n'avons pas soutenu certains d'entre eux (principalement parce qu'ils n'√©taient pas n√©cessaires), et certains, sans lesquels nous ne pourrions pas continuer √† travailler, ont d√ª √™tre faits.  Nous avons choisi l'architecture, travaill√© longtemps, r√©alis√© une version minimalement jouable et ... fakap. <br><br><img src="https://habrastorage.org/webt/5d/hg/7r/5dhg7r6qkdvxzcbj1svjtshafvk.png"><br><br>  Il s'est av√©r√© que la version la plus injouable.  Le joueur recule constamment, freine, le serveur se bloque au milieu du match.  Il √©tait impossible de le jouer.  Quelles √©taient les raisons des √©checs? <br><br>  La raison n ¬∞ 1 et la plus importante est l'inexp√©rience.  Mais comment √ßa?  Nous avons embauch√© une personne exp√©riment√©e qui √©tait cens√©e tout faire magnifiquement.  Oui, mais en r√©alit√© nous ne lui avons donn√© qu'une partie du travail.  Nous avons dit: "Voici un serveur de jeu pour vous, travaillez dessus."  Et dans notre architecture (plus √† ce sujet plus tard), le client joue un r√¥le tr√®s important.  Et c'est cette partie que nous avons donn√©e √† un homme qui n'avait pas l'exp√©rience n√©cessaire.  Non, c'est un bon programmeur, s√©nateur - il n'y avait tout simplement aucune exp√©rience.  C'est-√†-dire  il n'avait aucune id√©e du genre de r√¢teau qu'il pouvait y avoir. <br><br>  Raison n ¬∞ 2 - allocations irr√©alistes.  80 Ko / trame.  Est-ce beaucoup ou pas?  Si nous prenons en compte le fait que nous avons 30 images par seconde, alors en une seconde nous obtenons 2,5 Mo, et pour un match de 5 minutes, il y a d√©j√† plus de 600 Mo.  Bref, beaucoup.  Le garbage collector commence √† essayer intens√©ment de lib√©rer toute cette m√©moire (quand on en demande de plus en plus), ce qui conduit √† des pics.  √âtant donn√© que nous voulions 30 images par seconde, ces pointes nous ont beaucoup g√™n√©s.  De plus, √† la fois sur le client et sur le serveur. <br><br>  La principale raison des allocations est que nous avons constamment allou√© des tableaux de donn√©es.  Presque √† chaque fois √† chaque image.  Utilis√© LINQ, les expressions lambda et Photon.  Photon est une biblioth√®que r√©seau que nous connaissons et utilisons dans War Robots.  Et tout semble aller bien, mais il alloue de la m√©moire √† chaque fois qu'il envoie ou re√ßoit des donn√©es. <br><br>  Si nous avons r√©gl√© les premiers probl√®mes (r√©√©crits dans nos collections personnalis√©es, mis en cache), il n'y avait pratiquement rien √† faire avec Photon, car il s'agit d'une biblioth√®que tierce.  Il √©tait seulement possible de r√©duire la taille des paquets, et nous avions 5 Ko.  Beaucoup?  Oui  Il y a MTU - c'est la taille minimale r√©elle des paquets qui est envoy√©e via UDP, sans casser le paquet en petites parties.  Il fait environ 1,5 kilo-octets et nous en avions 5 (en moyenne, il y en avait plus). <br><br>  En cons√©quence, Photon a coup√© notre colis en petits et a envoy√© chaque pi√®ce comme fiable, c'est-√†-dire  avec livraison garantie.  Chaque fois que la pi√®ce n'atteignait pas, il l'envoyait encore et encore.  Nous avons encore plus de latence et le r√©seau a mal fonctionn√©. <br><br>  Toutes ces allocations ont conduit au fait que nous avons re√ßu une trame d'environ 100 millisecondes quand 33 √©tait n√©cessaire et l√†, rendu, simulation et autres actions - tout cela prend le CPU.  Tous ces probl√®mes sont complexes, c'est-√†-dire  il √©tait impossible d'en d√©cider, et tout irait bien.  Il fallait les r√©soudre tous en m√™me temps. <br><br>  Et un autre petit probl√®me qui √©tait pendant le d√©veloppement - un grand nombre de r√©f√©rentiels.  5 est √©crit sur la diapositive, mais il me semble qu'il y en avait encore plus.  Tous ces r√©f√©rentiels (pour le client, le serveur de jeu, le code commun, les param√®tres et quelque chose d'autre) ont √©t√© connect√©s par des sous-modules aux deux r√©f√©rentiels principaux pour le client et le serveur de jeu.  C'√©tait difficile de travailler avec.  Les programmeurs peuvent travailler avec Git, SVN, mais il y a aussi des artistes, des designers, etc.  Je pense que beaucoup ont essay√© d'enseigner √† un artiste ou un designer comment travailler avec un syst√®me de contr√¥le de version.  C'est vraiment difficile, donc si votre designer sait comment le faire - prenez soin de lui, c'est un employ√© pr√©cieux.  Dans notre cas, m√™me les programmeurs ont paniqu√© et, par cons√©quent, nous avons tout r√©duit √† un seul r√©f√©rentiel. <br><br>  C'√©tait une excellente solution au probl√®me.  Nous avons l√† un dossier avec un serveur et un dossier avec un client.  Le serveur se compose d'un projet de serveur de jeu, d'un g√©n√©rateur de code et d'outils auxiliaires. <br><br><img src="https://habrastorage.org/webt/ws/rg/6e/wsrg6ecn8sdodaa-uh1r_koqtoq.png"><br><br>  Un client est un client Unity et un code commun.  Un code commun est une structure de donn√©es mondiale, c'est-√†-dire  Entit√©s, composants et simulation syst√®me.  Ce code est principalement g√©n√©r√© par le g√©n√©rateur de serveur.  Il est utilis√© par le serveur.  C'est-√†-dire  Il s'agit d'une partie commune pour le client et le serveur. <br><br>  La vie.  Nous prenons TeamCity, le mettons sur notre r√©f√©rentiel, collectons et d√©ployons le serveur.  Chaque fois qu'un client change de logique g√©n√©rale, un serveur de jeu est assembl√© ici - maintenant, un programmeur de serveur n'est plus n√©cessaire pour cela.  Il y a g√©n√©ralement un serveur, un client et certaines fonctionnalit√©s.  Le client le voit √† la maison, le serveur √† la maison, et un jour cela fonctionnera pour eux.  Dans notre cas, ce n'est pas le cas - le client peut √©crire cette fonctionnalit√© et tout fonctionne sur le serveur. <br><br>  Le match se compose d'une partie commune (d√©sign√©e comme ECS) et d'une pr√©sentation (ce sont des classes unitaires de MonoBehavior, des GameObjects, des mod√®les, des effets - tout ce que le monde repr√©sente).  Ils ne sont pas connect√©s. <br><br><img src="https://habrastorage.org/webt/gh/dp/xf/ghdpxftm1m0fo6gqp51bmkifrw0.png"><br><br>  Entre eux, il y a des pr√©sentateurs, qui fonctionnent avec les deux parties.  Comme vous le comprenez, il s'agit de MVP (Model-View-Presenter) et n'importe laquelle de ces pi√®ces peut √™tre remplac√©e si n√©cessaire.  Il y a une autre partie qui fonctionne avec le r√©seau (sur la diapositive - R√©seau).  Il s'agit de la s√©rialisation des informations sur le monde, de la s√©rialisation des entr√©es, de l'envoi au serveur, de la r√©ception par le serveur, de la connexion au serveur, etc. <br><br>  Plus de likes.  Nous prenons et rempla√ßons cette partie par un package qui n'est pas r√©el, sur le r√©seau, mais virtuel.  Nous cr√©ons un objet √† l'int√©rieur du client et lui envoyons des messages.  Il impl√©mente une simulation de serveur - maintenant cet objet fait tout ce qui s'est pass√© sur le serveur de jeu.  Les joueurs restants sont remplac√©s par des bots. <br><br><img src="https://habrastorage.org/webt/tn/gk/l3/tngkl3sijbk-emyfrzvwivkxyw0.png"><br><br>  C'est fait.  Nous avons obtenu le jeu et la possibilit√© de le tester sans serveur de jeux.  Qu'est-ce que cela signifie?  Cela signifie que l'artiste, apr√®s avoir fait un nouvel effet, peut cliquer sur le bouton Lecture dans l'√©diteur, acc√©der imm√©diatement au match sur la carte et voir comment cela fonctionne.  Ou d√©boguez pour les programmeurs clients ce qu'ils ont √©crit. <br><br>  Mais nous sommes all√©s plus loin et attach√© √† cette couche l'√©mulation du jitter ping des retards r√©seau (c'est lorsque les paquets sur le r√©seau n'arrivent pas dans l'ordre dans lequel ils ont √©t√© envoy√©s) et d'autres choses sur le r√©seau.  En cons√©quence, nous avons obtenu un match pratiquement r√©el sans serveur de jeu.  Cela fonctionne, v√©rifi√©. <br><br>  Revenons √† la g√©n√©ration de code. <br><br><img src="https://habrastorage.org/webt/vb/jd/kb/vbjdkbu6g6ot2a1jdyak4o84v8m.png"><br><br>  J'ai d√©j√† dit que nous avons un g√©n√©rateur de code dans un serveur de jeux.  Il existe un langage sp√©cifique au domaine, qui est en fait une simple classe C #.  Dans ce cas, la classe Sant√©.  Nous le marquons avec nos attributs.  Par exemple, il existe un attribut de composant.  Il dit que la sant√© est une composante de notre monde.  Sur la base de cet attribut, le g√©n√©rateur cr√©era une nouvelle classe C # dans laquelle il y aura un tas de choses.  Ils peuvent √™tre √©crits √† la main, mais cela va g√©n√©rer.  Par exemple, la m√©thode d'ajout d'un composant √† Entity, la m√©thode de recherche de composants, la s√©rialisation des donn√©es, etc.  Il existe un attribut du type DontSend, qui indique qu'il n'est pas n√©cessaire d'envoyer un champ sur le r√©seau - le serveur n'en a pas besoin ou le client n'en a pas besoin.  Ou l'attribut Mach, qui indique que le joueur a une valeur de sant√© maximale de mille.  Qu'est-ce que cela nous donne?  Au lieu d'un champ qui occupe 32 bits (int), nous envoyons 10 bits - trois fois moins.  Un tel g√©n√©rateur de code nous a permis de r√©duire la taille des paquets de 5 Ko √† 1. <br><br><img src="https://habrastorage.org/webt/1u/bx/bx/1ubxbxiuebsnmqh7v822vjo-xgs.png"><br><br>  1 Ko &lt;1,5 - c'est-√†-dire  Nous avons rencontr√© le MTU.  Photon a cess√© de couper et le r√©seau s'est beaucoup am√©lior√©.  Presque tous ses probl√®mes ont disparu.  Mais nous sommes all√©s plus loin et avons fait une compression delta. <br><br><img src="https://habrastorage.org/webt/bg/m1/gp/bgm1gpgzxdlktns_-3rentd-ceo.png"><br><br>  C'est lorsque vous envoyez un √©tat complet, puis uniquement ses modifications.  Il n‚Äôarrive pas que le monde entier ait imm√©diatement compl√®tement chang√©.  Seules certaines parties changent constamment et ces changements sont beaucoup plus petits que l'√©tat lui-m√™me.  Nous avons re√ßu en moyenne 300 octets, soit  17 fois moins qu'√† l'origine. <br><br>  Pourquoi est-ce n√©cessaire si vous √™tes d√©j√† entr√© dans MTU?  Le jeu est en constante √©volution, de nouvelles fonctionnalit√©s apparaissent, et avec elles apparaissent des objets, des entit√©s, de nouveaux composants.  La taille des donn√©es augmente.  Si nous nous arr√™tions √† 1 Ko, nous reviendrions tr√®s bient√¥t au m√™me probl√®me.  Maintenant, apr√®s l'avoir r√©√©crit pour la compression delta, nous n'atteindrons pas cela tr√®s bient√¥t. <br><br>  Maintenant, la partie la plus douce.  Sync  Si vous jouez √† des tireurs, vous savez ce qu'est le d√©calage d'entr√©e - lorsque vous cliquez sur le bouton, et le personnage commence √† se d√©placer apr√®s un certain temps, par exemple, une demi-seconde.  Pour certains jeux du genre mob, c'est normal.  Mais dans le jeu de tir, vous voulez que le h√©ros tire et fasse des d√©g√¢ts juste l√†. <br><br><img src="https://habrastorage.org/webt/5q/ts/4t/5qts4t4xpvyygxwgkrjzffuzwam.png"><br><br>  Pourquoi Input Lag se produit-il?  Le client recueille l'entr√©e du joueur (entr√©e) et l'envoie au serveur de jeu (l'envoi prend du temps).  Ensuite, le serveur de jeu le traite (√† nouveau, le temps) et renvoie le r√©sultat (√† nouveau, le temps).  C'est un retard.  Comment l'enlever?  Il y a une chose appel√©e pr√©diction - le client n'attend pas de r√©ponse du serveur et commence imm√©diatement √† essayer de faire la m√™me chose que le serveur de jeu, c'est-√†-dire  feint.  Prend l'entr√©e du joueur et d√©marre la simulation.  Nous simulons uniquement un client local, car nous ne connaissons pas la contribution des autres joueurs - ils ne viennent pas √† nous.  Par cons√©quent, nous ex√©cutons le syst√®me de simulation uniquement sur notre lecteur. <br><br>  Tout d'abord, cela permet de r√©duire le temps de simulation.  Le client d√©marre la simulation d√®s qu'il re√ßoit l'entr√©e et a plusieurs √©tapes d'avance par rapport au serveur de jeu.  Disons que sur cette image, il simule le tick # 20.  √Ä ce stade, le serveur de jeu simule le tick # 15 dans le pass√©.  Le client voit le reste du monde, encore une fois, dans le pass√©, lui-m√™me - dans le futur.  Pendant qu'il envoie le 20√®me tick au serveur, alors que cette entr√©e atteint, le serveur de jeu commencera d√©j√† √† simuler le 18√®me tick ou d√©j√† le 20√®me.  Si le 18, il le met dans le tampon, atteint le 20, traite et renvoie le r√©sultat. <br><br>  Disons maintenant qu'il simule la tique n ¬∞ 15.  Trait√©e, renvoie le r√©sultat au client.  Le client a une sorte de 15e tick, 15e √©tat de jeu simul√© et le monde du jeu qu'il a pr√©dit.  La comparaison avec le serveur commence.  En fait, il ne compare pas le monde entier, mais seulement son client, car nous ne sommes pas responsables du reste du monde.  Nous ne sommes responsables que de nous-m√™mes.  Si le joueur co√Øncide, tout va bien, ce qui signifie que nous avons correctement simul√©, la physique a fonctionn√© correctement et aucune collision n'est survenue.  Ensuite, nous continuons √† simuler le 20√®me tick, le 21√®me et ainsi de suite. <br><br>  Si le client / joueur ne correspond pas, cela signifie que nous nous sommes tromp√©s quelque part.  Exemple: la physique n'√©tant pas d√©terministe, elle n'a pas correctement calcul√© notre position ou quelque chose s'est produit.  Peut-√™tre juste un bug.  Ensuite, le client prend l'√©tat du serveur de jeu, car le serveur de jeu l'a d√©j√† confirm√© (il fait confiance au serveur - s'il ne faisait pas confiance, les joueurs tricheraient), et simulerait le reste du 15 au 20.  Parce que cette branche temporelle est d√©sormais erron√©e. <br><br>  Cr√©ez une nouvelle branche horaire, c.-√†-d.  mondes parall√®les.  Nous resimulons ces cinq ticks en un seul tick.  Une fois que notre simulation a pris 5 millisecondes, mais si nous devons simuler 10 ticks, c'est d√©j√† 50 millisecondes et nous ne tombons pas dans nos 30 millisecondes.  Ils ont optimis√© et obtenu une milliseconde - maintenant 10 ticks sont trait√©s en 10 millisecondes.  Parce qu'il y a encore du rendu. <br><br>  Toutes ces choses fonctionnent sur le client, et nous l'avons donn√© √† la personne sans l'exp√©rience n√©cessaire.  Moins - nous avions un fakap, et plus - que le programmeur sait maintenant comment le faire correctement. <br><br><img src="https://habrastorage.org/webt/zt/ph/j9/ztphj9138fs3coanbgqad_ef15w.png"><br><br>  Ce sch√©ma a ses propres caract√©ristiques.  Le client sur la photo de gauche tente de traquer l'ennemi.  Il est au 20√®me tick, l'adversaire est au 15√®me tick.  Parce que ping et le client ont 5 ticks d'avance sur le serveur.  Le client tire et doit frapper avec pr√©cision et causer des dommages, peut-√™tre m√™me un tir √† la t√™te.  Mais l'image est diff√©rente sur le serveur - lorsque le serveur commence √† simuler le 20e tick, l'ennemi peut d√©j√† se d√©placer.  Par exemple, si l'ennemi se d√©pla√ßait.  En th√©orie, nous ne devrions pas obtenir.  Mais si cela fonctionnait comme √ßa, personne ne jouerait aux tireurs en ligne en raison de rat√©s constants.  Selon le ping, la probabilit√© de frapper a √©galement chang√©: plus le ping est mauvais, pire vous obtenez.  Par cons√©quent, ils le font diff√©remment. <br><br>  Le serveur prend et roule le monde entier dans le teck dans lequel le joueur a vu le monde.  Le serveur sait quand il √©tait, le ram√®ne au 15√®me tick et voit l'image de gauche.  Il voit que le joueur devrait avoir touch√© et inflige des d√©g√¢ts √† son adversaire d√©j√† dans le 20e tick.  Tout va bien.  Presque.  Si l'ennemi s'est enfui et a couru derri√®re un obstacle, alors nous avons d√©j√† tir√© √† la t√™te √† travers le mur.  Mais c'est un probl√®me connu, les joueurs le savent et ne s'inqui√®tent pas.  Donc √ßa marche, il n'y a rien √† faire. <br><br><img src="https://habrastorage.org/webt/fy/f3/4g/fyf34g2zncwjpautyl5n-ea68qe.png"><br><br>  Ainsi, nous avons atteint 30 ticks par seconde, 30 images par seconde.  Maintenant, environ 600 joueurs jouent sur notre serveur en m√™me temps.  Il y a 6 joueurs dans le match, soit  environ 100 matchs.  Nous n'avons pas de programmeur serveur, nous n'en avons pas besoin.  Les clients √©crivent toute la logique dans l'√©diteur Unity, Rider, en C # et cela fonctionne sur un serveur de jeux.  Presque toujours.  Nous avons r√©duit la taille des paquets de 17 fois et r√©duit les allocations de m√©moire de 80 fois - maintenant m√™me moins d'un kilo-octet sur le client et le serveur.  Le ping moyen √©tait de 200 √† 250 ms, maintenant il est de 150. 200 est la norme pour les jeux en r√©seau mobile, contrairement √† un PC, o√π tout se passe beaucoup plus rapidement, en particulier sur un r√©seau local. <br><br><img src="https://habrastorage.org/webt/k8/sb/ko/k8sbkorut9xfqgnvrkiy5ngrljc.png"><br><br>  Nous pr√©voyons d'isoler ce qui est √©crit dans un cadre distinct pour l'utiliser sur d'autres projets.  Mais jusqu'√† pr√©sent, il n'est pas question d'Open Source.  Et ajoutez-y l'interpolation.  Maintenant, nous avons 30 ticks par seconde, nous pouvons dessiner au fur et √† mesure.  Mais il y a des jeux o√π 20 ticks par seconde ou 10 suffisent. Par cons√©quent, si nous tirons 10 fois par seconde, les personnages se d√©placeront par √†-coups.  Par cons√©quent, une interpolation est n√©cessaire.  Nous avons √©crit notre propre biblioth√®que r√©seau au lieu de Photon - il n'y a pas d'allocations de m√©moire l√†-bas. <br><br>  Il y a encore des parties que vous ne pouvez pas √©crire avec vos mains, mais g√©n√©rer du code.  Par exemple, lorsque nous envoyons l'√©tat du monde √† un client, nous supprimons les donn√©es dont il n'a pas besoin.  Pendant que nous le faisons avec nos mains et lorsqu'une nouvelle fonctionnalit√© appara√Æt, et que nous oublions de supprimer ces donn√©es, quelque chose ne va pas.  En fait, cela peut √™tre g√©n√©r√© en marquant un attribut. <br><br><h3>  Questions du public </h3><br>  <b>- Qu'utilisez-vous pour la g√©n√©ration de code?</b>  <b>Votre propre d√©cision?</b> <br><br>  - Tout est simple - les mains.  Nous avons pens√© √† pr√©parer quelque chose, mais il s'est av√©r√© plus rapide d'√©crire de nos propres mains.  Suivez ce chemin, cela a bien fonctionn√© √† l'√©poque et maintenant. <br><br>  <b>- Vous avez refus√© le d√©veloppeur du serveur, mais vous n'avez pas seulement r√©duit le temps de d√©veloppement car le m√™me code est r√©utilis√©.</b>  <b>Unity ne prend pas en charge la derni√®re version de C #, il a son propre moteur sous le capot.</b>  <b>Vous ne pouvez pas utiliser .NET Core, vous ne pouvez pas utiliser les derni√®res fonctionnalit√©s, certaines structures et plus encore.</b>  <b>La performance n'en souffre-t-elle pas environ un tiers?</b> <br><br>  - Lorsque nous avons commenc√© √† faire tout cela, nous pensions que pour utiliser non pas des classes, mais des structures, cela aurait d√ª fonctionner beaucoup plus rapidement.  Nous avons √©crit un prototype de l'apparence du code, de la fa√ßon dont les programmeurs utiliseront ces structures pour √©crire la logique.  Et c'√©tait terriblement inconfortable.  Nous nous sommes install√©s sur les classes et la performance que nous avons maintenant nous suffit. <br><br>  <b>- Comment vivez-vous maintenant sans interpolation?</b>  <b>Et comment pr√©tendez-vous √™tre un joueur si l'instantan√© ne vient pas dans le bon cadre?</b> <br><br>  - Nous avons une interpolation, seulement elle n'est pas visuelle, mais sur les paquets qui arrivent sur le r√©seau.  Disons que nous avons les 18e, 19e et 20e √©tats.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le 18 est arriv√©, le 20 est arriv√©, et le 19 s'est perdu ou n'a pas encore atteint - nous l'interpolons ici. </font><font style="vertical-align: inherit;">Utilisez simplement la g√©n√©ration de code afin de ne pas √©crire le code d'interpolation. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Y a-t-il d'autres astuces de vie pour compresser plus fortement les quaternions? </font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- J'ai parl√© de 2D - il n'y a qu'un angle alpha, et sur les nouveaux projets, les quaternions ont aussi leurs propres probl√®mes. </font><font style="vertical-align: inherit;">Des hacks de vie, je peux √©galement dire ceci: puisque nous utilisons UDP pour que l'entr√©e ne soit pas perdue, nous l'envoyons par lots: de z√©ro √† cinqui√®me entr√©e, puis de premi√®re √† sixi√®me et ainsi de suite. </font><font style="vertical-align: inherit;">C'est moins cher et l'exp√©dition est meilleure. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Mais l'ordre de reproduction des entr√©es sur le serveur joue un r√¥le?"</font></font></b> <br><br>  "Oui, bien s√ªr."  -    (  ,      ,    ),    2 :    ,    . <br><br> <b>‚Äî       .     ?   ?    1000   ,  ?  ,    ?</b> <br><br> ‚Äî   ,   .        ,       -,     ,   .  ,    30 . <br><br> <b>‚Äî      ,       ?</b> <br><br>  - Bien s√ªr. ,       (     ),     .    ‚Äî ,     , .  -   ,      ,        .  , ,  ,        ,   .    . <br><br> <b>‚Äî         ECS,   ,     ?      ?</b> <br><br> ‚Äî 30    ,      . 80     ,    .      . <br><br> <b>‚Äî     prediction.    20-  - ,      ,          -   ‚Äî    ,  ? ,         .   -  ?</b> <br><br> ‚Äî   :          .     (, 15-)  16-,17-,18-   . <br><br> <b>‚Äî      ?</b> <br><br> ‚Äî ,          .    , , .     Entity (   ),    .          ‚Äî       ,      . ID  ,        . <br><br> <b>‚Äî  -    ‚Äî     ,   ,     ,    ?   ,      ?</b> <br><br> ‚Äî , ,  .  3D    ,     ‚Äî    ,             ,  - .      ,   ,     .   top-down,   ‚Äî    .      .     ,   ,       ,    .     . <br><br> <b>‚Äî       ?</b> <br><br> ‚Äî   .  Cela arrive aussi. <br><br> <b>‚Äî    ,        ,    - .  -         .   -  ,      ,   , 500 , ,     -     - .   ?</b> <br><br> ‚Äî  . <br><br><img src="https://habrastorage.org/webt/5q/ts/4t/5qts4t4xpvyygxwgkrjzffuzwam.png"><br><br>     , ..   20-    20- ,      .    ‚Äî    ,      .   :    20-  ,          ?       ,    . ,      ‚Äî -     .      ,   .      ,  ¬´    - ,  21-,  18-¬ª. : ¬´,    - ¬ª.   . <br><br> <b>‚Äî ..    ,           ?</b> <br><br> ‚Äî ,      . <br><br> <b>‚Äî    reliable UDP ‚Äî   -  ?</b> <br><br> ‚Äî  Photon,  Photon  reliable UDP, unreliable, c     . <br><br> <b>‚Äî    ?</b> <br><br> ‚Äî    ,   -.     ,      . ,   .    ,    .      ,         .     100%,     ,   80%,    . <br><br> <b>‚Äî  ?</b> <br><br> ‚Äî ,   , Photon   ,     MTU. <br><br> <b>‚Äî      ?   ?</b> <br><br> ‚Äî  ,   ,  ,      .     .  ,  .    ,   ,       ,    . <br><br> <b>‚Äî  ,    ,    ?</b> <br><br> ‚Äî   ,     .       ,     . , ,  . , -   .     ,   .   ,      . <br><br> <b>‚Äî       /   ‚Äî     -  .      ,     .</b> <br><br> ‚Äî   ,            . ,   (    ),       -,     ,     -.  ,   .    ‚Äî  ,   . <br><br> <b>‚Äî     ,  -  .      ?</b> <br><br> ‚Äî    ,    .             : ECS,    .       , ECS  .   ,   ECS .  ,       .  ,  ,   ,   (  ,   ,    ,  ,    ,   ).    2D ,   ,     3D ‚Äî    .  3D    , ,   .       .   - ,    .   ,       - -,      . <br><br> <b>‚Äî    ,  ECS      ,   .   ,  ,    C#?</b> <br><br> ‚Äî    ‚Äî . <br><br> <b>‚Äî ..     ES  ?   , ECS ‚Äî      ,         ,    ,       . .. ECS ‚Äî     ,     .</b> <br><br> ‚Äî   ,  ,     .     ,  .   ‚Äî   ,    ,    .   ,    O  -  ,    ,    . <br><br> <b>‚Äî ,   ECS-  ?</b> <br><br> ‚Äî  -, ECS    ,   ,   (   )    ‚Äî   ,     .    ,      ‚Äî   .  ‚Äî    ,     ,    .     ,   , ,   .. <br><br><h3>    Pixonic DevGAMM Talks </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> Consul   stateful-</a> ( , DevOps   BIT.GAMES); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CICD:        </a> ( ,   Pixonic); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">     -  Quake Champions</a> ( , backend- Saber Interactive); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> -  - Tacticool</a> ( , Lead Software Engineer  PanzerDog); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> ECS, C# Job System  SRP    </a> ( , Field Engineer  Unity); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> KISS  </a> ( , Lead Game Programmer  1C Game Studios); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cucumber  :  BDD-    </a> ( , Technical Product Manager, ALICE Platform). </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr429312/">https://habr.com/ru/post/fr429312/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr429298/index.html">Mises √† jour sur VPS.today</a></li>
<li><a href="../fr429302/index.html">Utiliser UTF-8 dans les en-t√™tes HTTP</a></li>
<li><a href="../fr429306/index.html">Vendredi. Bullshit 4.3</a></li>
<li><a href="../fr429308/index.html">Comment j'ai quitt√© une startup dans une grande entreprise</a></li>
<li><a href="../fr429310/index.html">Location, chasse, formation et d√©veloppement de rubistes. Coin RH √† la conf√©rence RubyRussia-2018</a></li>
<li><a href="../fr429314/index.html">Aper√ßu des plates-formes de largage crypto populaires</a></li>
<li><a href="../fr429316/index.html">Op√©rations sur les nombres complexes</a></li>
<li><a href="../fr429318/index.html">IPhone SMT Solver</a></li>
<li><a href="../fr429320/index.html">Sberbank Data Science Day diffus√©e en direct le 10 novembre</a></li>
<li><a href="../fr429322/index.html">nanoCAD Mechanics 9.0: les bases du design moderne</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>