<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚾 👩‍👩‍👧 🙇🏼 Bagian 5/2 Bldg. 1: Persimpangan RocketChip Avenue dan jalur instrumentasi yang licin 🤚🏽 🕛 🧞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dalam empat bagian sebelumnya, persiapan dibuat untuk percobaan dengan inti RocketChip RISC-V, yaitu, porting inti ini ke papan "non-standar" untuk it...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagian 5/2 Bldg. 1: Persimpangan RocketChip Avenue dan jalur instrumentasi yang licin</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461577/"><p>  Dalam empat bagian sebelumnya, persiapan dibuat untuk percobaan dengan inti RocketChip RISC-V, yaitu, porting inti ini ke papan "non-standar" untuk itu dengan Altera FPGAs (sekarang Intel).  Akhirnya, pada bagian <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">terakhir</a> , ternyata menjalankan Linux di forum ini.  Apakah Anda tahu apa yang membuat saya terhibur tentang semua ini?  Bahwa pada saat yang sama saya harus bekerja dengan assembler RISC-V, C dan Scala, dan dari semuanya, Scala adalah bahasa tingkat terendah (karena prosesor tertulis di atasnya). </p><br><p>  Mari kita buat C tidak menyinggung dalam artikel ini juga.  Selain itu, jika bundel Scala + Chisel hanya digunakan sebagai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bahasa khusus domain</a> untuk deskripsi perangkat keras yang eksplisit, hari ini kita akan belajar cara "menarik" fungsi C sederhana ke prosesor dalam bentuk instruksi. </p><br><p> Tujuan utamanya adalah implementasi sepele dari instrumentasi mirip AFL sepele dengan analogi dengan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">QInst</a> , dan penerapan instruksi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">mandiri</a> hanyalah produk sampingan. </p><a name="habracut"></a><br><p>  Jelas bahwa ada (dan bukan satu) komersial OpenCL to RTL converter.  Saya juga menemukan informasi tentang proyek COPILOT tertentu untuk RISC-V dengan tujuan yang sama (jauh lebih maju), tetapi ada sesuatu yang sangat buruk di Google, dan selain itu, kemungkinan besar juga merupakan produk komersial.  Saya terutama tertarik pada solusi OpenSource, tetapi meskipun mereka ada, masih menyenangkan untuk mencoba menerapkannya sendiri - setidaknya sebagai contoh pelatihan yang disederhanakan, dan kemudian bagaimana hasilnya ... </p><br><p>  <strong>Penafian</strong> (di samping peringatan biasa tentang "menari dengan alat pemadam kebakaran"): Saya sangat tidak menyarankan menerapkan secara sembarangan inti perangkat lunak yang dihasilkan, terutama dengan data yang tidak terpercaya - sejauh ini saya tidak begitu percaya diri karena bahkan memahami mengapa data yang sedang diproses tidak dapat "Mengalir" dalam beberapa kasus batas antara proses dan / atau inti.  Nah, tentang fakta bahwa data dapat "mengalahkan", saya pikir, dan itu jelas.  Secara umum, masih ada validasi dan validasi ... </p><br><p>  Sebagai permulaan, apa yang saya sebut "fungsi sederhana"?  Untuk keperluan artikel ini, ini berarti fungsi di mana semua transisi (bersyarat dan tanpa syarat) hanya meningkatkan penghitung instruksi dengan nilai konstan.  Yaitu, grafik dari semua transisi yang mungkin adalah asiklik (diarahkan), tanpa tepi "dinamis".  Tujuan akhir dalam kerangka artikel ini adalah untuk dapat mengambil fungsi sederhana dari program dan, menggantinya dengan plug-in assembler, "menjahitnya" ke dalam prosesor pada tahap sintesis, secara opsional menjadikannya efek samping dari instruksi lain.  <em>Secara khusus, percabangan tidak akan ditampilkan dalam artikel ini, tetapi dalam kasus paling sederhana tidak akan sulit untuk membuatnya.</em> </p><br><h2 id="uchimsya-ponimat-c-na-samom-dele-net">  Belajar memahami C (sebenarnya, tidak) </h2><br><p> Pertama, Anda perlu memahami bagaimana kami akan menguraikan C?  Itu benar, tidak mungkin - tidak sia-sia bahwa saya belajar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">mengurai file ELF</a> : Anda hanya perlu mengkompilasi kode kami di C / Rust / sesuatu yang lain menjadi bytecode eBPF, dan sudah menguraikannya.  Beberapa kesulitan disebabkan oleh fakta bahwa di Scala Anda tidak dapat menghubungkan <code>elf.h</code> dan membaca bidang struktur.  Anda tentu saja dapat mencoba menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">JNAerator</a> - jika perlu, mereka dapat melakukan pengikat ke perpustakaan - tidak hanya struktur, tetapi juga menghasilkan kode untuk bekerja melalui JNA (jangan bingung dengan JNI).  Sebagai seorang programmer sejati, saya akan menulis sepeda saya dan dengan hati-hati menulis enumerasi dan mengimbangi konstanta dari file header.  Struktur hasil dan menengah dijelaskan oleh struktur kelas kasus berikut: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegularSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SymtabSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StrtabSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RelSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Elf64Header</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> sectionHeaders: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Seq</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ByteBuffer</span></span></span></span><span class="hljs-class"><span class="hljs-params">], sectionStringTableIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Elf64Section</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> data: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ByteBuffer</span></span></span></span><span class="hljs-class"><span class="hljs-params">, linkIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, infoIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, kind: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">SectionKind</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Symbol</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, value: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, size: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, shndx: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, isInstrumenter: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Relocation</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> relocatedSection: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, offset: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, symbol: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Symbol</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfInsn</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> opcode: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, dst: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, src: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, offset: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, imm: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Either</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-class"><span class="hljs-params">, </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Symbol</span></span></span></span><span class="hljs-class"><span class="hljs-params">] </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfProg</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, insns: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Seq</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">BpfInsn</span></span></span></span><span class="hljs-class"><span class="hljs-params">] </span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><p>  Saya tidak akan secara khusus menjelaskan proses parsing - ini hanya transfer byte yang membosankan dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>java.nio.ByteBuffer</code></a> - semua hal menarik telah dijelaskan dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel tentang parsing file ELF</a> .  Saya hanya akan mengatakan bahwa Anda perlu menangani <code>opcode == 0x18</code> dengan hati-hati (memuat nilai langsung 64-bit ke dalam register), karena ini membutuhkan dua kata 8-byte sekaligus (mungkin ada opcode lain seperti itu, tetapi saya belum menemukan mereka) , dan ini tidak selalu memuat alamat memori yang terkait dengan relokasi, seperti yang saya pikir pada awalnya.  Misalnya, <code>__builtin_popcountl</code> jujur ​​menggunakan <strong>konstanta</strong> 64-bit <code>0x0101010101010101</code> .  Mengapa saya tidak melakukan relokasi "jujur" dengan menambal file yang diunduh - karena saya ingin melihat karakter dalam bentuk simbolis (maaf untuk permainan kata-kata), sehingga nantinya karakter dari bagian <code>COMMON</code> dapat diganti dengan register tanpa menggunakan kruk dengan penanganan khusus alamat dari jenis khusus (dan artinya, bahkan dengan tarian dengan <code>UInt</code> konstan / non-konstan). </p><br><h2 id="stroim-hardware-po-naboru-instrukciy">  Kami membangun perangkat keras sesuai dengan serangkaian instruksi </h2><br><p>  Jadi, dengan asumsi, semua jalur eksekusi yang mungkin masuk secara eksklusif ke bawah daftar instruksi, yang berarti bahwa data mengalir sepanjang grafik asiklik yang berorientasi, dan semua tepinya didefinisikan secara statis.  Pada saat yang sama, kami memiliki logika kombinasional murni (yaitu, tanpa register di jalan), yang diperoleh dari operasi pada register, serta penundaan selama operasi pemuatan / penyimpanan dengan memori.  Jadi, dalam kasus umum, operasi mungkin tidak dapat diselesaikan dalam satu siklus clock.  Kami akan melakukan yang sederhana: kami akan mentransfer nilai ke dalam bentuk <code>UInt</code> , tetapi seperti <code>(UInt, Bool)</code> : elemen pertama dari pasangan adalah nilainya, dan yang kedua adalah tanda kebenarannya.  Artinya, tidak masuk akal untuk membaca dari memori, asalkan alamatnya salah, dan menulis pada umumnya tidak mungkin. </p><br><p>  Model eksekusi bytecode eBPF mengasumsikan beberapa jenis RAM dengan pengalamatan 64-bit, serta satu set 16 (atau bahkan sepuluh) register 64-bit.  Algoritma rekursif primitif diusulkan: </p><br><ul><li>  kita mulai dengan konteks di mana operan instruksi terletak pada <code>r1</code> dan <code>r2</code> , di sisanya - nol, semuanya valid (lebih tepatnya, validitasnya sama dengan "kesiapan" instruksi coprocessor) </li><li>  jika kita melihat instruksi aritmatika-logis, kita mengekstrak register operan dari konteksnya, menyebut diri kita sebagai ekor daftar dan konteks di mana operan output diganti dengan pasangan <code>(data1 op data2, valid1 &amp;&amp; valid2)</code> </li><li>  jika kita menemukan cabang, kita cukup membangun kedua cabang secara rekursif: jika cabang terjadi, dan jika tidak </li><li>  jika kita menemukan pemuatan atau penyimpanan ke memori, entah bagaimana kita keluar: kita menjalankan panggilan balik yang ditransfer, dengan asumsi invarian bahwa setelah pernyataan yang <code>valid</code> tidak dapat ditarik kembali selama pelaksanaan instruksi ini.  Validitas operasi save adalah DAN oleh kami dengan flag <code>globalValid</code> , yang harus ditetapkan sebelum mengembalikan kontrol.  Pada saat yang sama, kita harus membaca dan menulis di bagian depan untuk memproses peningkatan dan modifikasi lainnya dengan benar. </li></ul><br><p>  Dengan demikian, operasi akan dilakukan sejajar mungkin, dan tidak dalam langkah-langkah.  Pada saat yang sama, saya meminta Anda untuk memperhatikan bahwa semua operasi pada byte memori tertentu secara alami harus sepenuhnya dipesan, jika tidak hasilnya tidak dapat diprediksi, UB.  Yaitu  <code>*addr += 1</code> - ini normal, menulis tidak akan dimulai sampai pembacaan selesai (klise karena kita masih tidak tahu harus menulis apa), tetapi <code>*addr += 1; return *addr;</code> <code>*addr += 1; return *addr;</code>  Saya biasanya memberi <strong>nol</strong> atau sesuatu seperti itu dengan aman.  Mungkin ini layak untuk di-debug (mungkin menyembunyikan beberapa masalah yang lebih rumit), tetapi daya tarik itu sendiri adalah ide yang biasa saja, karena Anda harus melacak alamat memori yang sudah dikerjakan, tetapi saya memiliki keinginan Validasi nilai <code>valid</code> memungkinkan secara statis.  Inilah yang akan dilakukan untuk variabel global berukuran tetap. </p><br><p>  Hasilnya adalah kelas abstrak <code>BpfCircuitConstructor</code> , yang tidak memiliki metode yang diimplementasikan <code>doMemLoad</code> , <code>doMemStore</code> , dan <code>resolveSymbol</code> : </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfCircuitConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... sealed abstract class LdStType(val lgsize: Int) { val byteSize = 1 &lt;&lt; lgsize val bitSize = byteSize * 8 val mask: UInt = if (bitSize == 64) mask64 else ((1l &lt;&lt; bitSize) - 1).U } case object u8 extends LdStType(0) case object u16 extends LdStType(1) case object u32 extends LdStType(2) case object u64 extends LdStType(3) def doMemLoad(addr: UInt, tpe: LdStType, valid: Bool): (UInt, Bool) def doMemStore(addr: UInt, tpe: LdStType, data: UInt, valid: Bool): Bool sealed trait Resolved { def asPlainValue: UInt def load(ctx: Context, offset: Int, tpe: LdStType, valid: Bool): LazyData def store(offset: Int, tpe: LdStType, data: UInt, valid: Bool): Bool } def resolveSymbol(sym: BpfLoader.Symbol): Resolved // ... }</span></span></code> </pre> <br><h2 id="integraciya-s-processornym-yadrom">  Integrasi inti CPU </h2><br><p>  Sebagai permulaan, saya memutuskan untuk pergi dengan cara sederhana: terhubung ke inti prosesor menggunakan protokol RoCC (Rocket Custom Coprocessor) standar.  Sejauh yang saya mengerti, ini adalah ekstensi reguler bukan untuk semua kernel yang kompatibel dengan RISC-V, tetapi hanya untuk Rocket dan BOOM (Berkeley Out-of-Order Machine), oleh karena itu, ketika menyeret pekerjaan upstream pada kompiler, mnemonics assembler <code>custom0</code> dikeluarkan dari mereka - <code>custom3</code> bertanggung jawab atas perintah akselerator. </p><br><p>  Secara umum, setiap inti prosesor Rocket / BOOM dapat memiliki hingga empat akselerator RoCC yang ditambahkan melalui konfigurasi, ada juga contoh implementasi: </p><br><p>  <strong>Configs.scala:</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WithRoccExample</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(site, here, up</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">=&gt;</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">BuildRoCC</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>( (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> accumulator = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AccumulatorExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom0, n = <span class="hljs-number"><span class="hljs-number">4</span></span>)(p)) accumulator }, (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> translator = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">TranslatorExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom1)(p)) translator }, (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> counter = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">CharacterCountExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom2)(p)) counter }) })</code> </pre> <br><p>  Implementasi yang sesuai ada di file <code>LazyRoCC.scala</code> . </p><br><p>  Implementasi akselerator mewakili dua kelas yang sudah akrab dari pengontrol memori: salah satunya dalam hal ini diwarisi dari <code>LazyRoCC</code> , yang lain dari <code>LazyRoCCModuleImp</code> .  Kelas kedua memiliki port <code>io</code> tipe <code>RoCCIO</code> , yang berisi port permintaan <code>cmd</code> , port respons <code>resp</code> , port cache L1D akses mem, output <code>busy</code> dan <code>interrupt</code> , dan input <code>exception</code> .  Ada juga port walker tabel halaman dan FPU yang tampaknya belum kita butuhkan (lagi pula, tidak ada aritmatika nyata dalam eBPF).  Sejauh ini saya ingin mencoba melakukan sesuatu dengan pendekatan ini, jadi saya tidak akan menyentuh.  Juga, seperti yang saya mengerti, ada antarmuka TileLink untuk akses memori yang tidak di-cache, tetapi untuk sekarang saya tidak akan menyentuhnya juga. </p><br><h2 id="uporyadochivatel-zaprosov">  Penyelenggara permintaan </h2><br><p>  Jadi, kami memiliki port untuk mengakses cache, tetapi hanya satu.  Pada saat yang sama, suatu fungsi dapat, misalnya, menambah variabel (yang, paling tidak, dapat diubah menjadi operasi atom tunggal) atau bahkan entah bagaimana mengubahnya secara nontrivial dengan memuat, memperbarui, dan menyimpannya.  Pada akhirnya, satu instruksi dapat membuat beberapa permintaan yang tidak terkait.  Mungkin ini bukan ide terbaik dalam hal kinerja, tetapi, di sisi lain, mengapa tidak, katakanlah, memuat tiga kata (yang, sangat mungkin, sudah ada dalam cache), entah bagaimana memprosesnya secara <strong>paralel</strong> dengan logika kombinasional (kemudian satu pukulan) dan simpan hasilnya.  Oleh karena itu, kita memerlukan semacam skema yang secara efektif “menyelesaikan” upaya akses paralel ke satu port cache. </p><br><p>  Logikanya akan menjadi seperti berikut: pada awal generasi penerapan sub-injeksi tertentu (bidang <code>funct</code> 7-bit dalam hal RoCC), sebuah instance dari query serializer dibuat (membuat satu global tampaknya cukup berbahaya bagi saya, karena ia menciptakan banyak dependensi tambahan antara permintaan yang tidak pernah dapat dijalankan secara bersamaan, dan menghamburkan Fmax kemungkinan besar akan).  Selanjutnya, setiap "saver" / "loader" yang dibuat terdaftar di serializer.  Dalam antrian langsung, jadi untuk berbicara.  Pada setiap tindakan, permintaan pertama dalam urutan pendaftaran dipilih - ia diberikan izin <strong>pada tindakan berikutnya</strong> .  Secara alami, logika seperti itu perlu ditutupi dengan tes (saya benar-benar belum memiliki banyak dari mereka, jadi ini bukan hanya verifikasi, tetapi set minimum yang diperlukan untuk mendapatkan setidaknya sesuatu yang dapat dipahami).  Saya menggunakan <code>PeekPokeTester</code> standar dari komponen yang kurang lebih resmi untuk menguji desain Pahat.  Saya sudah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">menggambarkannya sekali</a> . </p><br><p>  Hasilnya adalah alat seperti itu: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializer</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">isComputing: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Bool</span></span></span></span><span class="hljs-class"><span class="hljs-params">, next: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Bool</span></span></span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">monotonic</span></span></span></span>(x: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> res = <span class="hljs-type"><span class="hljs-type">WireInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> prevRes = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) prevRes := res &amp;&amp; isComputing res := (x || prevRes) &amp;&amp; isComputing res } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">noone</span></span></span></span>(bs: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">Bool</span></span>]): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = !bs.foldLeft(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>)(_ || _) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> previousReqs = <span class="hljs-type"><span class="hljs-type">ArrayBuffer</span></span>[<span class="hljs-type"><span class="hljs-type">Bool</span></span>]() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextReq</span></span></span></span>(x: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): (<span class="hljs-type"><span class="hljs-type">Bool</span></span>, <span class="hljs-type"><span class="hljs-type">Int</span></span>) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> enable = monotonic(x) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> retired = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> doRetire = result &amp;&amp; next <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> thisReq = enable &amp;&amp; !retired &amp;&amp; !doRetire <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> reqWon = thisReq &amp;&amp; noone(previousReqs) when (isComputing) { when(reqWon) { result := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } when(doRetire) { result := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> retired := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } } otherwise { result := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> retired := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } previousReqs += thisReq (result, previousReqs.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) } }</code> </pre> <br><p>  Harap dicatat bahwa di sini dalam proses membuat sirkuit digital, kode Scala dijalankan dengan aman.  Jika Anda melihat lebih dekat, Anda bahkan dapat melihat <code>ArrayBuffer</code> mana bagian-bagian sirkuit ditumpuk ( <code>Boolean</code> adalah jenis dari Scala, <code>Bool</code> adalah jenis Pahat yang mewakili peralatan langsung, dan bukan boolean yang dikenal saat runtime). </p><br><h2 id="rabota-s-l1d-keshom">  Bekerja dengan L1D Cache </h2><br><p>  Bekerja dengan cache sebagian besar terjadi melalui <code>io.mem.req</code> permintaan <code>io.mem.req</code> dan <code>io.mem.resp</code> respons <code>io.mem.resp</code> .  Pada saat yang sama, port permintaan dilengkapi dengan sinyal tradisional yang <code>ready</code> dan <code>valid</code> : yang pertama memberitahu Anda bahwa ia siap menerima permintaan, yang kedua kami mengatakan bahwa permintaan sudah siap dan sudah memiliki struktur yang benar, di bagian depan, <code>valid &amp;&amp; resp</code> permintaan dianggap diterima.  Dalam beberapa antarmuka seperti itu, ada persyaratan "non-respons" dari sinyal dari saat pengaturan ke <code>true</code> dan ke tepi positif selanjutnya dari <code>valid &amp;&amp; resp</code> (ungkapan ini dapat dibangun menggunakan metode <code>fire()</code> untuk kenyamanan). </p><br><p>  Port respons <code>resp</code> , pada gilirannya, hanya memiliki tanda yang <code>valid</code> , dan ini adalah masalah prosesor untuk memperoleh jawaban dalam satu siklus clock: itu "selalu siap" dengan asumsi, dan <code>fire()</code> mengembalikan hanya <code>valid</code> . </p><br><p>  Juga, seperti yang sudah saya katakan, Anda tidak dapat membuat permintaan ketika itu mengerikan: Anda tidak dapat menulis sesuatu, saya tidak tahu apa, dan membaca lagi apa yang akan ditimpa nanti berdasarkan nilai yang dikurangi juga entah bagaimana aneh.  Tetapi kelas <code>Serializer</code> sudah memahami ini, tetapi kami hanya memberinya tanda bahwa permintaan saat ini telah masuk ke cache: <code>next = io.mem.req.fire()</code> .  Semua yang bisa dilakukan adalah memastikan bahwa di "pembaca" jawabannya diperbarui hanya ketika benar-benar datang - tidak lebih awal dan tidak lebih lambat.  Ada metode <code>holdUnless</code> nyaman untuk <code>holdUnless</code> .  Hasilnya kira-kira implementasi berikut: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Constructor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfCircuitConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serializer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Serializer</span></span>(isComputing, io.mem.req.fire()) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doMemLoad</span></span></span></span>(addr: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, tpe: <span class="hljs-type"><span class="hljs-type">LdStType</span></span>, valid: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): (<span class="hljs-type"><span class="hljs-type">UInt</span></span>, <span class="hljs-type"><span class="hljs-type">Bool</span></span>) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> (doReq, thisTag) = serializer.nextReq(valid) when (doReq) { io.mem.req.bits.addr := addr require((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; io.mem.req.bits.tag.getWidth) &gt; thisTag) io.mem.req.bits.tag := thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.cmd := <span class="hljs-type"><span class="hljs-type">M_XRD</span></span> io.mem.req.bits.typ := (<span class="hljs-number"><span class="hljs-number">4</span></span> | tpe.lgsize).<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.data := <span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.valid := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> doResp = isComputing &amp;&amp; serializer.monotonic(doReq &amp;&amp; io.mem.req.fire()) &amp;&amp; io.mem.resp.valid &amp;&amp; io.mem.resp.bits.tag === thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> &amp;&amp; io.mem.resp.bits.cmd === <span class="hljs-type"><span class="hljs-type">M_XRD</span></span> (io.mem.resp.bits.data holdUnless doResp, serializer.monotonic(doResp)) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doMemStore</span></span></span></span>(addr: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, tpe: <span class="hljs-type"><span class="hljs-type">LdStType</span></span>, data: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, valid: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> (doReq, thisTag) = serializer.nextReq(valid) when (doReq) { io.mem.req.bits.addr := addr require((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; io.mem.req.bits.tag.getWidth) &gt; thisTag) io.mem.req.bits.tag := thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.cmd := <span class="hljs-type"><span class="hljs-type">M_XWR</span></span> io.mem.req.bits.typ := (<span class="hljs-number"><span class="hljs-number">4</span></span> | tpe.lgsize).<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.data := data io.mem.req.valid := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } serializer.monotonic(doReq &amp;&amp; io.mem.req.fire()) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resolveSymbol</span></span></span></span>(sym: <span class="hljs-type"><span class="hljs-type">BpfLoader</span></span>.<span class="hljs-type"><span class="hljs-type">Symbol</span></span>): <span class="hljs-type"><span class="hljs-type">Resolved</span></span> = sym <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">BpfLoader</span></span>.<span class="hljs-type"><span class="hljs-type">Symbol</span></span>(symName, _, size, <span class="hljs-type"><span class="hljs-type">ElfConstants</span></span>.<span class="hljs-type"><span class="hljs-type">Elf64_Shdr</span></span>.<span class="hljs-type"><span class="hljs-type">SHN_COMMON</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> size &lt;= <span class="hljs-number"><span class="hljs-number">8</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">RegisterReference</span></span>(regs.getOrElseUpdate(symName, <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span>(<span class="hljs-number"><span class="hljs-number">64.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)))) } }</code> </pre> <br><p>  Sebuah instance dari kelas ini dibuat untuk setiap subinstruksi yang dihasilkan. </p><br><h2 id="ne-vsyo-to-v-kuche-chto-globalnaya-peremennaya">  Tidak semua yang ada di heap adalah variabel global </h2><br><p>  Hmm, apa contoh modelnya?  Kinerja apa yang ingin saya pastikan?  Tentu saja, instrumentasi AFL!  Itu terlihat dalam versi klasik seperti ini: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; extern uint8_t *__afl_area_ptr; extern uint64_t prev; void inst_branch(uint64_t tag) { __afl_area_ptr[((prev &gt;&gt; 1) ^ tag) &amp; 0xFFFF] += 1; prev = tag; }</span></span></span></span></code> </pre> <br><p>  Seperti yang Anda lihat, itu memuat lebih atau kurang logis memuat dan menyimpan (dan di antara mereka selisih) satu byte dari <code>__afl_area_ptr</code> , tetapi di sini register meminta peran <code>prev</code> ! </p><br><p>  Inilah sebabnya mengapa antarmuka <code>Resolved</code> diperlukan: itu dapat membungkus alamat memori biasa atau menjadi referensi register.  Pada saat yang sama, sejauh ini saya hanya mempertimbangkan register skalar dengan ukuran 1, 2, 4 atau 8 byte, yang selalu dibaca dengan nol offset, jadi untuk register, Anda dapat dengan relatif tenang menerapkan pemesanan panggilan.  Dalam hal ini, sangat berguna untuk mengetahui bahwa <code>prev</code> pertama-tama harus dikurangi dan digunakan untuk menghitung indeks, dan baru kemudian ditulis ulang. </p><br><h2 id="a-teper-instrumentaciya">  Dan sekarang instrumentasi </h2><br><p>  Pada titik tertentu, kami mendapat akselerator yang bekerja terpisah dan lebih banyak dengan antarmuka RoCC.  Apa sekarang?  Mengimplementasikan kembali semua sama, mendorong melalui pipa prosesor?  Tampak bagi saya bahwa kruk lebih sedikit akan diperlukan jika, sejalan dengan instruksi yang diinstruksikan, coprocessor dengan <code>funct</code> nilai utilitas yang dikeluarkan secara otomatis hanya akan diaktifkan.  Pada prinsipnya, saya juga harus menyiksa diri sendiri untuk ini: Saya bahkan belajar menggunakan SignalTap, karena debugging hampir buta, dan bahkan dengan kompilasi lima menit setelah perubahan sekecil apa pun (kecuali untuk mengubah bootrom - semuanya cepat di sana) - ini sudah terlalu banyak. </p><br><p>  Akibatnya, decoder perintah diperbaiki dan pipeline sedikit "diluruskan" untuk mempertimbangkan fakta bahwa tidak peduli apa yang dikatakan decoder tentang instruksi asli, RoCC yang tiba-tiba diaktifkan itu sendiri tidak berarti bahwa akan ada latensi panjang untuk menulis ke register output, seperti selama operasi pembagian dan ketinggalan cache data. </p><br><p>  Secara umum, deskripsi instruksi adalah pasangan ([pola untuk mengenali instruksi], [set nilai yang mengkonfigurasi blok jalur data dari inti prosesor]).  Misalnya, <code>default</code> (instruksi yang tidak dikenal) terlihat seperti ini (diambil dari <code>IDecode.scala</code> , di desktop Habr tampilannya, terus terang, jelek): </p><br><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">default</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>] = <span class="hljs-comment"><span class="hljs-comment">// jal renf1 fence.i // val | jalr | renf2 | // | fp_val| | renx2 | | renf3 | // | | rocc| | | renx1 s_alu1 mem_val | | | wfd | // | | | br| | | | s_alu2 | imm dw alu | mem_cmd mem_type| | | | mul | // | | | | | | | | | | | | | | | | | | | | | div | fence // | | | | | | | | | | | | | | | | | | | | | | wxd | | amo // | | | | | | | | scie | | | | | | | | | | | | | | | | | dp List(N,X,X,X,X,X,X,X,X,A2_X, A1_X, IMM_X, DW_X, FN_X, N,M_X, MT_X, X,X,X,X,X,X,X,CSR.X,X,X,X,X)</span></span></code> </pre> <br><p>  ... dan deskripsi tipikal dari <em>salah satu ekstensi</em> di inti Rocket diimplementasikan seperti ini: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDecode</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit val p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecodeConstants</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> table: <span class="hljs-type"><span class="hljs-type">Array</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])] = <span class="hljs-type"><span class="hljs-type">Array</span></span>( <span class="hljs-type"><span class="hljs-type">BNE</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SNE</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BEQ</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SEQ</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BLT</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SLT</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BLTU</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SLTU</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BGE</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SGE</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BGEU</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SGEU</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-comment"><span class="hljs-comment">// ...</span></span></code> </pre> <br><p>  Faktanya adalah bahwa dalam RISC-V (tidak hanya di RocketChip, tetapi dalam arsitektur perintah pada prinsipnya) ISA membelah menjadi subset wajib I (operasi integer), serta opsional M (perkalian integer dan pembagian), A (atom) didukung secara teratur dll. </p><br><p>  Akibatnya, metode asli </p><br><pre> <code class="scala hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span></span>(inst: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, table: <span class="hljs-type"><span class="hljs-type">Iterable</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])]) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> decoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, table) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sigs = <span class="hljs-type"><span class="hljs-type">Seq</span></span>(legal, fp, rocc, branch, jal, jalr, rxs2, rxs1, scie, sel_alu2, sel_alu1, sel_imm, alu_dw, alu_fn, mem, mem_cmd, mem_type, rfs1, rfs2, rfs3, wfd, mul, div, wxd, csr, fence_i, fence, amo, dp) sigs zip decoder map {<span class="hljs-keyword"><span class="hljs-keyword">case</span></span>(s,d) =&gt; s := d} <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> }</code> </pre> <br><p>  telah digantikan oleh </p><br><div class="spoiler">  <b class="spoiler_title">sama, tetapi dengan decoder untuk instrumentasi dan klarifikasi alasan untuk aktivasi rocc</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span></span>(inst: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, table: <span class="hljs-type"><span class="hljs-type">Iterable</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])], handlers: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">OpcodeHandler</span></span>]) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> decoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, table) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sigs=<span class="hljs-type"><span class="hljs-type">Seq</span></span>(legal, fp, rocc_explicit, branch, jal, jalr, rxs2, rxs1, scie, sel_alu2, sel_alu1, sel_imm, alu_dw, alu_fn, mem, mem_cmd, mem_type, rfs1, rfs2, rfs3, wfd, mul, div, wxd, csr, fence_i, fence, amo, dp) sigs zip decoder map {<span class="hljs-keyword"><span class="hljs-keyword">case</span></span>(s,d) =&gt; s := d} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handlers.isEmpty) { handler_rocc := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> handler_rocc_funct := <span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> handlerTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])] = handlers.map { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">OpcodeHandler</span></span>(pattern, funct) =&gt; pattern -&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>, <span class="hljs-type"><span class="hljs-type">BitPat</span></span>(funct.<span class="hljs-type"><span class="hljs-type">U</span></span>)) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> handlerDecoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">N</span></span>, <span class="hljs-type"><span class="hljs-type">BitPat</span></span>(<span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span>)), handlerTable) <span class="hljs-type"><span class="hljs-type">Seq</span></span>(handler_rocc, handler_rocc_funct) zip handlerDecoder map { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (s,d) =&gt; s:=d } } rocc := rocc_explicit || handler_rocc <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> }</code> </pre> </div></div><br><p>  Dari perubahan dalam pipeline prosesor, mungkin yang paling tidak terlihat adalah: </p><br><pre> <code class="diff hljs"> io.rocc.exception := wb_xcpt &amp;&amp; csr.io.status.xs.orR io.rocc.cmd.bits.status := csr.io.status io.rocc.cmd.bits.inst := new RoCCInstruction().fromBits(wb_reg_inst) + when (wb_ctrl.handler_rocc) { + io.rocc.cmd.bits.inst.opcode := 0x0b.U // custom0 + io.rocc.cmd.bits.inst.funct := wb_ctrl.handler_rocc_funct + io.rocc.cmd.bits.inst.xd := false.B + io.rocc.cmd.bits.inst.rd := 0.U + } io.rocc.cmd.bits.rs1 := wb_reg_wdata io.rocc.cmd.bits.rs2 := wb_reg_rs2</code> </pre> <br><p>  Jelas bahwa beberapa parameter permintaan ke akselerator perlu dikoreksi: tidak ada respons yang ditulis ke register, dan <code>funct</code> sama dengan apa yang dikembalikan oleh decoder.  Tetapi ada perubahan yang sedikit kurang jelas: faktanya adalah bahwa perintah ini tidak langsung ke akselerator (empat dari mereka - yang mana?), Tetapi ke router, jadi Anda perlu berpura-pura bahwa perintah memiliki <code>opcode == custom0</code> (ya, proses, dan justru akselerator nol!). </p><br><h2 id="proverka">  Periksa </h2><br><p>  Bahkan, artikel ini mengasumsikan kelanjutan di mana upaya akan dilakukan untuk membawa pendekatan ini ke tingkat produksi yang kurang lebih.  Minimal, Anda harus belajar untuk menyimpan dan memulihkan konteks (keadaan register coprocessor) saat berpindah tugas.  Sementara itu, saya akan memeriksa apakah itu berfungsi dalam kondisi rumah kaca: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; uint64_t counter; uint64_t funct1(uint64_t x, uint64_t y) { return __builtin_popcountl(x); } uint64_t funct2(uint64_t x, uint64_t y) { return (x + y) * (x - y); } uint64_t instMUL() { counter += 1; *((uint64_t *)0x81005000) = counter; return 0; }</span></span></span></span></code> </pre> <br><p>  Sekarang tambahkan ke <code>bootrom/sdboot/sd.c</code> di baris <code>main</code> </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/path/to/freedom-u-sdk/riscv-pk/machine/encoding.h"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// ... ////    -   RoCC #define STR1(x) #x #define STR(x) STR1(x) #define EXTRACT(a, size, offset) (((~(~0 &lt;&lt; size) &lt;&lt; offset) &amp; a) &gt;&gt; offset) #define CUSTOMX_OPCODE(x) CUSTOM_##x #define CUSTOM_0 0b0001011 #define CUSTOM_1 0b0101011 #define CUSTOM_2 0b1011011 #define CUSTOM_3 0b1111011 #define CUSTOMX(X, rd, rs1, rs2, funct) \ CUSTOMX_OPCODE(X) | \ (rd &lt;&lt; (7)) | \ (0x7 &lt;&lt; (7+5)) | \ (rs1 &lt;&lt; (7+5+3)) | \ (rs2 &lt;&lt; (7+5+3+5)) | \ (EXTRACT(funct, 7, 0) &lt;&lt; (7+5+3+5+5)) #define CUSTOMX_R_R_R(X, rd, rs1, rs2, funct) \ asm ("mv a4, %[_rs1]\n\t" \ "mv a5, %[_rs2]\n\t" \ ".word "STR(CUSTOMX(X, 15, 14, 15, funct))"\n\t" \ "mv %[_rd], a5" \ : [_rd] "=r" (rd) \ : [_rs1] "r" (rs1), [_rs2] "r" (rs2) \ : "a4", "a5"); int main(void) { // ... //  RoCC extension write_csr(mstatus, MSTATUS_XS &amp; (MSTATUS_XS &gt;&gt; 1)); //   bootrom       uint64_t res; CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 2); // ...     uint64_t x = 1; for (int i = 0; i &lt; 123; ++i) x *= *(volatile uint8_t *)0x80000000; kputc('0' + x % 10); //   !!! // ... }</span></span></span></span></code> </pre> <br><p>  <code>write_csr</code> ,     <code>custom0</code> - <code>custom3</code> .      ,   illegal instruction,  ,  , ,   .   <code>define</code> -     - ,   «» binutils  <code>customX</code>      RocketChip,  ,   ,   . </p><br><p>     sdboot  ,       ,      . </p><br><p>  : </p><br><pre> <code class="plaintext hljs">$ /hdd/trosinenko/rocket-tools/bin/riscv32-unknown-elf-gdb -q -ex "target remote :3333" -ex "set directories bootrom" builds/zeowaa-e115/sdboot.elf Reading symbols from builds/zeowaa-e115/sdboot.elf...done. Remote debugging using :3333 0x0000000000000000 in ?? () (gdb) x/d 0x81005000 0x81005000: 123 (gdb) set variable $pc=0x10000 (gdb) c Continuing. ^C Program received signal SIGINT, Interrupt. 0x0000000000010488 in crc16_round (data=&lt;optimized out&gt;, crc=&lt;optimized out&gt;) at sd.c:151 151 crc ^= data; (gdb) x/d 0x81005000 0x81005000: 246</code> </pre> <br><div class="spoiler"> <b class="spoiler_title"> funct1</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ /hdd/trosinenko/rocket-tools/bin/riscv32-unknown-elf-gdb -q -ex "target remote :3333" -ex "set directories bootrom" builds/zeowaa-e115/sdboot.elf Reading symbols from builds/zeowaa-e115/sdboot.elf...done. Remote debugging using :3333 0x0000000000010194 in main () at sd.c:247 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); (gdb) set variable $a5=0 (gdb) set variable $pc=0x10194 (gdb) set variable $a4=0xaa (gdb) display/10i $pc-10 1: x/10i $pc-10 0x1018a &lt;main+46&gt;: sw a3,124(a3) 0x1018c &lt;main+48&gt;: addiw a0,a0,1110 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 =&gt; 0x10194 &lt;main+56&gt;: 0x2f7778b 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; (gdb) display/x $a5 2: /x $a5 = 0x0 (gdb) si 0x0000000000010198 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); 1: x/10i $pc-10 0x1018e &lt;main+50&gt;: li a0,25 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 0x10194 &lt;main+56&gt;: 0x2f7778b =&gt; 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; 0x101a6 &lt;main+74&gt;: li a5,10 2: /x $a5 = 0x4 (gdb) set variable $a4=0xaabc (gdb) set variable $pc=0x10194 (gdb) si 0x0000000000010198 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); 1: x/10i $pc-10 0x1018e &lt;main+50&gt;: li a0,25 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 0x10194 &lt;main+56&gt;: 0x2f7778b =&gt; 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; 0x101a6 &lt;main+74&gt;: li a5,10 2: /x $a5 = 0x9</code> </pre> </div></div><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kode sumber</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id461577/">https://habr.com/ru/post/id461577/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id461565/index.html">5 Perintah Pengembang TypeScript</a></li>
<li><a href="../id461567/index.html">SQL Teka-teki yang menghibur</a></li>
<li><a href="../id461569/index.html">Catatan untuk front-end: apa yang harus diperiksa sebelum pengujian</a></li>
<li><a href="../id461571/index.html">SVG dalam kehidupan nyata. Laporan Yandex</a></li>
<li><a href="../id461575/index.html">Membuat PBX berbasis cloud 3CX pada sembarang hosting yang kompatibel dengan Openstack</a></li>
<li><a href="../id461579/index.html">WebMoney memperkenalkan dompet WMP baru dan mengubah aturan permainan</a></li>
<li><a href="../id461583/index.html">Python untuk membantu menguji produk struktural</a></li>
<li><a href="../id461587/index.html">Lokalisasi aplikasi dalam 10 langkah</a></li>
<li><a href="../id461589/index.html">Tic Tac Toe: Siklus Konten</a></li>
<li><a href="../id461593/index.html">API di F #. Modul Aplikasi Berbasis Peran Akses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>