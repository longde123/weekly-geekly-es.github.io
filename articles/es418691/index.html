<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>游꼬 游땼 游둟游낗 Ganadero: Kubernetes en 5 minutos sobre metal desnudo. 游뱇 游븿游낖 驕덢잺</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En el cruce, la orquesta no cambia. 

 Despu칠s de estar completamente cansado de Docker Swarm debido a su pseudo-simplicidad y acabado constante, no e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ganadero: Kubernetes en 5 minutos sobre metal desnudo.</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418691/">  En el cruce, la orquesta <s>no</s> cambia. <br><br>  Despu칠s de estar completamente cansado de Docker Swarm debido a su pseudo-simplicidad y acabado constante, no es un trabajo muy conveniente con sistemas de archivos distribuidos, una interfaz web ligeramente h칰meda y una funcionalidad estrecha, as칤 como la falta de soporte de integraci칩n GitLab "lista para usar", se decidi칩 implementar su cl칰ster Kubernetes en su propio hardware, es decir, mediante la implementaci칩n de Rancher Management Server 2.0. <br><br>  Experiencia de instalaci칩n, esquema de tolerancia a fallas, trabajo con haProxy y dos paneles debajo del gato: <br><a name="habracut"></a><br>  <strong>Datos de entrada:</strong> <br><br>  Servidor host HP Proliant DL320e Gen8 - 2 piezas <br>  VM Ubuntu Server 16.04, 2Gb RAM, 2vCPU, 20Gb HDD - 1 PC.  en cada host (VM-haProxy). <br>  VM Ubuntu Server 16.04, 4Gb RAM, 4vCPU, 40Gb HDD, 20 Gb SSD - 3 piezas.  en cada host (VM - * - Cluster). <br>  VM Ubuntu Server 16.04, 4Gb RAM, 4vCPU, 100Gb HDD - 1 PC.  en cualquier host (VM-NFS). <br><br>  Diagrama de red: <br><br><div class="spoiler">  <b class="spoiler_title">Fig. 1</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ua/wg/ec/uawgecpkngtalxstr0i1fam-ok4.jpeg"><br></div></div><br>  <strong>Comenzando:</strong> <br><br>  <em>VM-haProxy</em> tiene reglas haProxy, fail2ban, iptables a bordo.  Act칰a como una puerta de entrada para todas las m치quinas detr치s de 칠l.  Tenemos dos puertas de enlace y todas las m치quinas en caso de p칠rdida de la comunicaci칩n de la puerta de enlace en su host cambiar치n a otra. <br><br>  La tarea principal de estos nodos (VM-haProxy) es distribuir el acceso al backend, equilibrar, reenviar puertos y recopilar estad칤sticas. <br><br>  Mi elecci칩n recay칩 en haProxy, como una herramienta m치s centrada en el equilibrio y la comprobaci칩n de estado.  Por todo esto, me gusta la sintaxis de las directivas de configuraci칩n y trabajar con listas blancas y negras de IP, as칤 como trabajar con conexi칩n SSL multidominio. <br><br>  Configuraci칩n de HaProxy: <br><br><div class="spoiler">  <b class="spoiler_title">haproxy.conf con comentarios</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">########################################################## #Global # ########################################################## global log 127.0.0.1 local0 notice maxconn 2000 user haproxy group haproxy tune.ssl.default-dh-param 2048 defaults log global mode http option httplog option dontlognull retries 3 option redispatch timeout connect 5000 timeout client 10000 timeout server 10000 option forwardfor option http-server-close ########################################################## #TCP # ########################################################## #    API  Kubernetes listen kube-api-tls bind *:6443 mode tcp option tcplog server VM-Master-Cluster Master:6443 ########################################################## #HTTP/HTTPS - Frontend and backend # ########################################################## #      "  ", frontend  backend. frontend http-in bind *:80 acl network_allowed src -f /path/allowed-ip #     IP.     . http-request deny if !network_allowed #       IP  . reqadd X-Forwarded-Proto:\ http mode http option httpclose acl is_haproxy hdr_end(host) -i haproxy.domain.ru acl is_rancher hdr_end(host) -i rancher.domain.ru acl is_kubernetes hdr_end(host) -i kubernetes.domain.ru use_backend kubernetes if is_kubernetes use_backend rancher if is_rancher use_backend haproxy if is_haproxy frontend https-in bind *:443 ssl crt-list /path/crt-list #    .        . acl network_allowed src -f /path/allowed-ip http-request deny if !network_allowed reqadd X-Forwarded-Proto:\ https acl is_rancher hdr_end(host) -i rancher.etraction.ru acl is_kubernetes hdr_end(host) -i kubernetes.etraction.ru use_backend kubernetes if is_kubernetes { ssl_fc_sni kubernetes.domain.ru } use_backend rancher if is_rancher { ssl_fc_sni rancher.domain.ru } # Backend  haProxy.    . backend haproxy stats enable stats uri /haproxy?stats stats realm Strictly\ Private stats auth login:passwd cookie SERVERID insert nocache indirect #  , , backend   dashboard rancher  kubernetes. backend rancher acl network_allowed src -f /path/allowed-ip http-request deny if !network_allowed mode http redirect scheme https if !{ ssl_fc } server master master:443 check ssl verify none backend kubernetes acl network_allowed src -f /path/allowed-ip http-request deny if !network_allowed mode http balance leastconn redirect scheme https if !{ ssl_fc } server master master:9090 check ssl verify none</span></span></code> </pre> <br></div></div><br>  <strong>Importante:</strong> Todas las m치quinas deben "conocerse" entre s칤 por nombre de host. <br><br><div class="spoiler">  <b class="spoiler_title">manifiesto de marioneta add-host-entry.pp para agregar nombres de host en / etc / hosts</b> <div class="spoiler_text"><pre> <code class="bash hljs">class host_entries { host { <span class="hljs-string"><span class="hljs-string">'proxy01'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.11'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'proxy02'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.12'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'master'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.100'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node01'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.101'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node02'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.102'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node03'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.103'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node04'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.104'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node05'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.105'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'nfs'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.200'</span></span>, } }</code> </pre><br></div></div><br>  <em>VM-Master-Cluster</em> es la m치quina de control principal.  Se diferencia de otros nodos a bordo por Puppet Master, GlusterFS Server, Rancher Server (contenedor), etcd (contenedor), control manager (contenedor).  En caso de desconexi칩n de este host, los servicios de producci칩n contin칰an funcionando. <br>  <em>VM-Node-Cluster</em> - Nodos, trabajadores.  M치quinas de trabajo cuyos recursos se combinar치n en un entorno tolerante a fallas.  Nada interesante <br><br>  <em>VM-NFS</em> : servidor NFS (nfs-kernel-server).  La tarea principal es proporcionar espacio de almacenamiento intermedio.  Almacena archivos de configuraci칩n y todo.  No almacena nada importante.  Su ca칤da puede corregirse lentamente, mientras toma caf칠. <br><br>  <strong>Importante:</strong> Todas las m치quinas de entorno deben tener a bordo: docker.io, nfs-common, gluster-server. <br><br><div class="spoiler">  <b class="spoiler_title">Manifiesto de t칤teres must-have-packages.pp para instalar el software adecuado</b> <div class="spoiler_text"><pre> <code class="bash hljs">class musthave { package { <span class="hljs-string"><span class="hljs-string">'docker.io'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">'installed'</span></span>, } package { <span class="hljs-string"><span class="hljs-string">'nfs-common'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">'installed'</span></span>, } package { <span class="hljs-string"><span class="hljs-string">'gluster-server'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">'installed'</span></span>, } }</code> </pre><br></div></div><br>  No describir칠 la instalaci칩n de nfs-volume y la configuraci칩n de GlusterFS, ya que se describe generosamente en grandes cantidades. <br><br>  Si observa que hay discos SSD en la descripci칩n de la especificaci칩n, est치n preparados para el funcionamiento del sistema de archivos distribuido Gluster.  Cree particiones y almacenamiento en discos de alta velocidad. <br><br>  <em>Nota</em>  De hecho, ejecutar un Rancher no requiere un entorno de espejo.  Todo lo anterior es mi visi칩n del cl칰ster y una descripci칩n de las pr치cticas que sigo. <br><br>  Para ejecutar Rancher, <strong>una</strong> m치quina es suficiente, con 4CPU, 4Gb RAM, 10Gb HDD. <br><br>  5 minutos para el ranchero. <br><br>  En VM-Master-Cluster hacemos: <br><br><pre> <code class="bash hljs">sudo docker run -d --restart=unless-stopped -p 80:80 -p 443:443 rancher/rancher</code> </pre> <br>  Consultar disponibilidad: <br><br><pre> <code class="bash hljs">curl -k https://localhost</code> </pre> <br>  Si vio la API, lo felicito exactamente a la mitad del camino. <br><br>  Mirando nuevamente el diagrama de red, recordamos que trabajaremos desde afuera, a trav칠s de haProxy, en la configuraci칩n en la que hemos publicado el enlace <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">rancher.domain.ru</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">adelante</a> , establezca su contrase침a. <br><br>  La siguiente p치gina es la p치gina de creaci칩n de cl칰steres de Kubernetes. <br><br><div class="spoiler">  <b class="spoiler_title">Fig.2</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/1w/ke/xn/1wkexnv2z_lgd_epga3vx3foyv4.png"><br></div></div><br>  En el men칰 Opciones de cl칰ster, seleccione Franela.  No trabaj칠 con otros proveedores de la red.  No puedo aconsejar <br><br>  Vale la pena prestar atenci칩n al hecho de que instalamos las casillas de verificaci칩n, etcd y Control Plane, la casilla de verificaci칩n de trabajador no est치 instalada, en caso de que no planee usar el administrador en modo de trabajador. <br>  Trabajamos dentro de la red local, con la misma direcci칩n en la NIC, por lo que en los campos de Direcci칩n p칰blica e interna se indica la misma IP. <br><br>  Copie el c칩digo resultante anterior, ejec칰telo en la consola. <br><br>  Despu칠s de un tiempo, en la interfaz web ver치 un mensaje sobre c칩mo agregar un nodo.  Y despu칠s de un tiempo, iniciar치 el cl칰ster de Kubernetes. <br><br><div class="spoiler">  <b class="spoiler_title">Fig.3</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/lj/sn/kk/ljsnkkwx3eh2w0eg5vysblt8wpm.png"><br></div></div><br>  Para agregar un trabajador, vaya a editar el cl칰ster en la interfaz web de Rancher, ver치 el mismo men칰 que genera el comando de conexi칩n. <br><br>  Establezca la casilla de verificaci칩n solo en la posici칩n del trabajador, especifique la IP del futuro trabajador, copie el comando y ejec칰telo en la consola del nodo que necesita. <br><br>  Despu칠s de un tiempo, la potencia del cl칰ster aumentar치, al igual que la cantidad de nodos. <br><br>  <strong>Instale el panel de Kubernetes:</strong> <br><br>  Vaya al men칰 Proyectos / Espacios de nombres. <br><br>  Despu칠s de la instalaci칩n, ver치 que los espacios de nombres relacionados con Kubernetes estar치n contenidos fuera de los proyectos.  Para trabajar completamente con estos espacios de nombres, deben colocarse en el proyecto. <br><br>  Agregue un proyecto, as칤gnele el nombre que desee.  Mueva los espacios de nombres (sistema de ganado, ingress-nginx, kube-public, kube-system) al proyecto que cre칩 utilizando el men칰 contextual "Mover".  Deber칤a ser as칤: <br><br><div class="spoiler">  <b class="spoiler_title">Fig. 4</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/dz/qv/el/dzqvelzycrlwyj3bkwllq-pndqm.png"><br></div></div><br>  Haga clic directamente en el nombre del proyecto, ser치 llevado al panel de control de la carga de trabajo.  Es aqu칤 donde discutiremos c칩mo crear un servicio simple. <br><br><div class="spoiler">  <b class="spoiler_title">Fig.5</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/q6/lp/5z/q6lp5znqlnhzkudjafjnr172n-g.png"><br></div></div><br>  Haga clic en "Importar YAML" en la esquina superior derecha.  Copie y pegue el contenido de <a href="">este archivo</a> en el cuadro de texto de la ventana que se abre, seleccione el espacio de nombres "kube-system", haga clic en "Importar". <br><br>  Despu칠s de un tiempo, se iniciar치 el pod kubernetes-dashboard. <br><br>  Vaya a edici칩n de pod, abra el men칰 de publicaci칩n de puertos, establezca los siguientes valores: <br><br><div class="spoiler">  <b class="spoiler_title">Fig.6</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/_p/2b/wk/_p2bwkxifynrhipap0imqddogfi.png"><br></div></div><br>  Verifique el acceso en el nodo en el que se ejecuta el pod. <br><br><pre> <code class="bash hljs">curl -k https://master:9090</code> </pre> <br>  쯌es la respuesta?  La publicaci칩n se completa, queda por llegar a la parte administrativa. <br><br>  En la p치gina principal de administraci칩n de cl칰steres en Rancher, hay herramientas muy convenientes, como kubectl, la consola de administraci칩n de cl칰steres y el archivo Kubeconfig, el archivo de configuraci칩n que contiene la direcci칩n API, ca.crt, etc. <br><br>  Entramos en kubectl y ejecutamos: <br><br><pre> <code class="bash hljs">kubectl create serviceaccount cluster-admin-dashboard-sa kubectl create clusterrolebinding cluster-admin-dashboard-sa --clusterrole=cluster-admin --serviceaccount=default:cluster-admin-dashboard-sa</code> </pre><br>  Creamos una cuenta de servicio con los m치s altos privilegios, ahora necesitamos un token para acceder al Tablero. <br><br>  Encuentra el secreto de la cuenta creada: <br><br><pre> <code class="bash hljs">kubectl get secret | grep cluster-admin-dashboard-sa</code> </pre><br>  Veremos el nombre de la cuenta con un cierto hash al final, c칩pielo y ejecute: <br><br><pre> <code class="bash hljs">kubectl describe secret cluster-admin-dashboard-sa-$( )</code> </pre><br>  Nuevamente, recordamos que todo ha sido publicado con 칠xito a trav칠s de haProxy. <br><br>  Seguimos el enlace <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">kubernetes.domain.ru</a> .  Ingrese el token recibido. <br><br>  Alegrarse <br><br><div class="spoiler">  <b class="spoiler_title">Fig. 7</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ps/1q/iw/ps1qiwgxivruyotas0fcb2slwfy.png"><br></div></div><br>  <em>PS</em> <br>  El resultado general ser칤a agradecer a Rancher por crear una interfaz intuitiva, una instancia f치cil de implementar, documentaci칩n simple, la capacidad de moverse r치pidamente y la escalabilidad a nivel de cl칰ster.  Tal vez habl칠 demasiado bruscamente al comienzo de la publicaci칩n de que Swarm estaba cansado, m치s bien, las tendencias de desarrollo obvias, que me hicieron mirar a un lado y no terminar la aburrida rutina.  Docker cre칩 una era de desarrollo.  Y juzgar este proyecto ciertamente no es para m칤. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es418691/">https://habr.com/ru/post/es418691/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es418681/index.html">D칤a de la amistad: 50% de descuento en todos los IDE de JetBrains para nuestros amigos</a></li>
<li><a href="../es418683/index.html">Creaci칩n de una m치quina arcade emulador. Parte 2</a></li>
<li><a href="../es418685/index.html">Generaci칩n de nivel de procedimiento</a></li>
<li><a href="../es418687/index.html">Revoluci칩n de 3.5 ": detalles de un peque침o boom de disquetes con vapores</a></li>
<li><a href="../es418689/index.html">C칩mo crear bibliotecas de componentes en Figma, ahorrando un presupuesto, usando el ejemplo de una subasta en l칤nea</a></li>
<li><a href="../es418693/index.html">쯇or qu칠 es tan dif칤cil detectar la felicidad en el cerebro?</a></li>
<li><a href="../es418695/index.html">Guerras contra la pirater칤a: el imperio contraataca</a></li>
<li><a href="../es418699/index.html">Creaci칩n de una m치quina arcade emulador. Parte 3</a></li>
<li><a href="../es418701/index.html">Estudiamos analizadores sint치cticos para el idioma ruso</a></li>
<li><a href="../es418705/index.html">Fundamentos de Futex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>