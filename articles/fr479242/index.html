<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📺 🌰 🍞 Nous finalisons Yandex. Station pour regarder YouTube 👩🏾‍🤝‍👨🏻 👆🏻 💒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sur Yandex.Stations, il n'est pas pratique de regarder YouTube. Il n'y a pas de recommandations, d'abonnements et même la recherche ne fonctionne pas ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous finalisons Yandex. Station pour regarder YouTube</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479242/">  Sur Yandex.Stations, il n'est pas pratique de regarder YouTube.  Il n'y a pas de recommandations, d'abonnements et même la recherche ne fonctionne pas normalement.  Par conséquent, j'ai écrit un télégramme au bot pour lui envoyer n'importe quelle vidéo. <br><br><div style="text-align:center;"><img width="400" src="https://habrastorage.org/webt/3p/mb/iu/3pmbiuv8wfkjlr5yjfdndeyhfe4.gif"></div><br><br>  Sous la coupe, l'histoire est de savoir comment je l'ai fait <b>malgré le fait qu'il n'y ait pas d'API ouverte officielle</b> . <br><a name="habracut"></a><br><h2>  Comment tout a commencé? </h2><br>  Je suis ingénieur.  J'étudie constamment comment différentes technologies et choses fonctionnent, et je réalise moi-même beaucoup de projets intéressants.  Lorsque mes amis m'ont donné Yandex.Station, j'ai <a href="https://habr.com/ru/post/469435/">inversé</a> le protocole d'activation et <a href="https://habr.com/ru/post/470293/">développé l'</a> idée d'un transfert de données orienté vers l'effet wow. <br><br>  J'ai un téléviseur stupide (pas intelligent), et en tant que console multimédia principale, j'utilise la Station.  Tout va bien, mais regarder YouTube est complètement inconfortable.  Vous ne pouvez pas vous connecter à votre compte YouTube, ce qui signifie qu'il n'y a pas de recommandations et d'abonnements.  De plus, la recherche de vidéos dans la Station, si je comprends bien, est effectuée via Yandex.Video.  Malheureusement, un tel schéma ne fonctionne pas très bien.  Parfois, il n'y a pas de vidéos, même si vous prononcez littéralement le nom, et vous ne pouvez pas regarder de nouvelles vidéos tant que le moteur de recherche Yandex ne les indexe pas. <br><br>  J'ai presque accepté le fait que vous ne pouvez pas regarder YouTube sur la station, mais tout a changé il y a quelques semaines. <br><br><h2>  Que s'est-il passé? </h2><br>  Samedi matin, j'ai décidé de regarder la dernière saison de la Silicon Valley.  Je suis allé à Kinopoisk et j'ai vu ce qui suit: <br><br><div style="text-align:center;"><img width="300" src="https://habrastorage.org/webt/l9/ot/u7/l9otu7l6_zwt1v_zc2qsvgbdp6g.png"></div><br>  Après avoir cliqué sur le bouton, la vidéo s'est envolée vers Yandex.Station et a été lue plus loin.  Tout comme ChromeCast ou AirPlay.  Du plaisir!  Mais je n'étais pas ravi de la fonctionnalité elle-même, mais de la possibilité potentielle d'envoyer n'importe quelle vidéo à la station. <br><br>  J'ai oublié de penser à la série - pendant tout le week-end, je suis passé à l'ingénierie inverse et au développement. <br><br><h2>  Faisons les choses correctement. </h2><br>  Nous ouvrons Kinopoisk ou Yandex.Video dans Chrome - il existe d'excellents outils pour le développement Web.  Trouvez le bouton souhaité, faites un clic droit, sélectionnez «Explorer l'élément». <br><br><div style="text-align:center;"><img width="300" src="https://habrastorage.org/webt/ny/rq/et/nyrqetlz0e8rti6gmv33pe1bg5a.png"></div><br>  Il y a beaucoup à apprendre ici, mais nous voulons savoir quelle demande est exécutée lorsque ce bouton est cliqué.  Nous allons dans l'onglet "Réseau" des outils de développement et examinons les demandes. <br><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/pg/pc/zc/pgpczch8nxzxytxn7cucxl9gark.png"></div><br>  Oui, beaucoup de statistiques s'envolent, mais 2 demandes intéressantes sont immédiatement visibles.  Ce sont devices_online_stats et station. <br><br><h2>  Obtenez une liste d'appareils </h2><br>  devices_online_stats - demande les machines utilisateur actives.  Demande simple.  Si vous êtes autorisé dans Yandex, vous pouvez vous renseigner sur vos appareils simplement en ouvrant le lien dans un navigateur: <br><br>  <a href="https://quasar.yandex.ru/devices_online_stats" rel="nofollow">quasar.yandex.ru/devices_online_stats</a> <br><br>  Que dans la réponse: <br><br><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"items"</span></span>:[ { <span class="hljs-attr"><span class="hljs-attr">"icon"</span></span>:<span class="hljs-string"><span class="hljs-string">"https://avatars.mds.yandex.net/get-yandex-station/1540981/yandexstationicon/orig"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-string"><span class="hljs-string">"************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"online"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"platform"</span></span>:<span class="hljs-string"><span class="hljs-string">"yandexstation"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"screen_capable"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"screen_present"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"status"</span></span>:<span class="hljs-string"><span class="hljs-string">"ok"</span></span> }</code> </pre> <br>  Intéressant et assez intuitif.  J'ai remplacé l'identifiant de station dans l'exemple par des astérisques au cas où, mais nous en aurons besoin à l'avenir. <br><br><h2>  Lire la vidéo </h2><br>  Une demande à <a href="https://yandex.ru/video/station" rel="nofollow">yandex.ru/video/station est</a> envoyée à l'aide de la méthode POST.  Répétez-le depuis la console, en recevant la commande comme suit: <br><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/90/cz/dx/90czdx3um7nns9uufhik5ufzvlq.png"></div><br>  Courez dans le terminal et obtenez la réponse: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"status"</span></span>: <span class="hljs-string"><span class="hljs-string">"play"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"msg"</span></span>: <span class="hljs-string"><span class="hljs-string">"success"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br>  Après quelques secondes, la vidéo démarre à la station.  Succès! <br><br><h2>  Nous collectons </h2><br>  J'ai supprimé tous les champs "supplémentaires" de la demande pour qu'elle reste opérationnelle.  Pour envoyer la vidéo à la Station dans le corps et les en-têtes de la requête POST, vous devez mettre seulement 4 paramètres: <br><br><ul><li>  SessionID - autorisation dans Yandex </li><li>  jeton x-csrf </li><li>  provider_item_id - lien vers la vidéo (ou identifiant pour certains services) </li><li>  device - L'identifiant de l'appareil que nous avons reçu plus tôt </li></ul><br>  Qu'est-ce que x-csrf-token?  Nous n'irons pas en profondeur maintenant.  Il peut être obtenu simplement par une demande GET à <a href="https://frontend.vh.yandex.ru/csrf_token" rel="nofollow">frontend.vh.yandex.ru/csrf_token</a> si vous êtes autorisé dans Yandex. <br><br>  À ce stade, j'avais déjà commencé à tout emballer dans un script Python.  Par conséquent, la fonction d'envoi de vidéo à la station ressemble à ceci: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendToScreen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(video_url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Auth and getting Session_id auth_data = { 'login': config.login, 'passwd': config.password } s = requests.Session() s.get("https://passport.yandex.ru/") s.post("https://passport.yandex.ru/passport?mode=auth&amp;retpath=https://yandex.ru", data=auth_data) Session_id = s.cookies["Session_id"] # Getting x-csrf-token token = s.get('https://frontend.vh.yandex.ru/csrf_token').text # Getting devices info </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> device selection here devices_online_stats = s.get("https://quasar.yandex.ru/devices_online_stats").text devices = json.loads(devices_online_stats)["items"] # Preparing request headers = { "x-csrf-token": token, } data = { "msg": { "provider_item_id": video_url }, "device": devices[0]["id"] } if "https://www.youtube" in video_url: data["msg"]["player_id"] = "youtube" # Sending command with video to device res = s.post("https://yandex.ru/video/station", data=json.dumps(data), headers=headers) return res.text</span></span></code> </pre> <br>  Vous avez peut-être remarqué que j'ajoute le champ player_id si un lien de YouTube est envoyé.  Le fait est qu'il y a plusieurs joueurs sur la Station avec les codes youtube, vh et ott.  Par défaut, vh est utilisé, mais l'aperçu et le titre de la vidéo sont interrompus.  De plus, son état n'est pas réinitialisé lorsque le film est modifié, ce qui provoque souvent des erreurs (peut-être, tous les champs de la demande n'étaient pas «redondants»).  Le lecteur ott, si je comprends bien, est utilisé pour les services de streaming, ce qui signifie qu'à l'avenir, vous pourrez regarder IPTV via la station. <br><br><h2>  Quel est le résultat? </h2><br>  Maintenant, j'ai un bot à travers lequel nous envoyons des vidéos de YouTube à la Station.  Cliquez simplement sur "Partager" dans l'application YouTube et envoyez le lien vers Bot.  Au fait, je l'ai appelé «Box» et j'ai fait un logo). <br><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/rv/su/bm/rvsubmacu1ugpftjfa5espxdbcq.jpeg"></div><br>  Je ne l'ai pas rendu public, afin de ne pas collecter les identifiants et mots de passe.  Mais vous pouvez déployer le même pour vous-même ou le modifier pour l'autorisation OAuth ou l'envoi de vidéos à partir d'autres sites.  Toutes les sources sont disponibles sur <a href="https://github.com/Krupnikas/yashhik" rel="nofollow">GitHub</a> . <br><br>  Je voulais faire en sorte qu'une extension de navigateur fonctionne comme AirPlay avec n'importe quelle vidéo, mais j'ai réalisé qu'il était plus pratique d'envoyer depuis l'application depuis le téléphone.  Et pour ce scénario, un bot est mieux adapté.  Voici une vidéo de son travail: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Y3uzSJV2lmo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2>  Conclusion </h2><br>  Lorsqu'un ingénieur manque de fonctionnalité, il la complète lui-même.  Maintenant, nous utilisons vraiment régulièrement ce bot - très pratique :) <br><br>  Développeurs Yandex, veuillez ne pas casser cette demande.  Ce n'est pas une vulnérabilité.  Fonctionne uniquement avec l'authentification.  Et si vous le pouvez - rendez l'API de l'appareil publique - bien plus peut être fait! <br><br>  Merci d'avoir lu mes articles!  J'espère que vous étiez intéressé. <br><br>  Bonne chance! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr479242/">https://habr.com/ru/post/fr479242/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr479232/index.html">Développement d'applications MQ JMS sur Spring Boot</a></li>
<li><a href="../fr479234/index.html">Nouvelles du monde d'OpenStreetMap n ° 488 (19/11/2019 - 25/11/2019)</a></li>
<li><a href="../fr479236/index.html">Kivy. Créez des packages pour Android et pas de magie</a></li>
<li><a href="../fr479238/index.html">La programmation fonctionnelle n'est pas ce qu'on nous dit</a></li>
<li><a href="../fr479240/index.html">Le code dans lequel nous vivons</a></li>
<li><a href="../fr479244/index.html">Arbre de préfixe avec index bitmap</a></li>
<li><a href="../fr479246/index.html">11 directions pour la croissance et le développement professionnel d'un programmeur</a></li>
<li><a href="../fr479248/index.html">Mitap «Kubernetes in action!» - une véritable expérience dans la construction de systèmes évolutifs</a></li>
<li><a href="../fr479250/index.html">Comment j'ai appris à travailler avec des microcontrôleurs - une expérience pour débutant</a></li>
<li><a href="../fr479252/index.html">Compréhension de la liste et carte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>