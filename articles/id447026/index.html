<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛹🏾 🧑🏿‍🤝‍🧑🏾 👼🏿 Kami menulis OTA-loader untuk ATmega128RFA1 (sebagai bagian dari perangkat Smart Response XE) 😷 👩‍🎤 👋🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Semuanya dimulai dengan akuisisi oleh penulis di pasar sekunder perangkat yang menarik - Smart Response XE ( deskripsi singkat ). Ini ditujukan untuk ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kami menulis OTA-loader untuk ATmega128RFA1 (sebagai bagian dari perangkat Smart Response XE)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447026/"><img src="https://habrastorage.org/webt/ie/eb/sz/ieebszdo1m1pcoy6jx1gvxww3ao.jpeg"><br><br>  Semuanya dimulai dengan akuisisi oleh penulis di pasar sekunder perangkat yang menarik - Smart Response XE ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">deskripsi singkat</a> ).  Ini ditujukan untuk sekolah: setiap siswa di kelas menerima perangkat yang mirip dengan buku catatan elektronik atau penerjemah tahun sembilan puluhan, guru mengajukan pertanyaan, dan siswa mengetik di keyboard perangkat jawaban yang diterima melalui saluran radio (802.15,4) ke penerima yang terhubung ke PC guru. <br><br>  Dukungan untuk perangkat ini dihentikan beberapa tahun yang lalu, dan fakta bahwa sekolah membeli masing-masing $ 100-200, sekarang muncul di eBay seharga 10 atau kurang.  Besi di sana sangat cocok untuk percobaan geek: <br><br><ul><li>  Keyboard 60 tombol </li><li>  tampilan dengan resolusi 384x136, 2 bit per piksel - mirip dengan BK, CGA, tetapi 4 bukan warna, tetapi gradasi kecerahan </li><li>  Mikrokontroler ATmega128RFA1 (memori flash 128 kB, ROM 4 kB, RAM 16 kB, transceiver standar 802.15.4) </li><li>  eksternal (berkenaan dengan mikrokontroler, dan bukan seluruh perangkat) memori flash 1 megabyte (128 kilobyte) dengan SPI </li><li>  kompartemen untuk 4 elemen AAA. </li></ul><br>  Dengan nama mikrokontroler, jelas bahwa itu milik keluarga AVR, yang berarti membuat perangkat yang kompatibel dengan Arduino adalah lebih dari sekadar tugas sepele ... <a name="habracut"></a><br><br>  Dari berita di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Hackaday,</a> penulis menemukan bahwa mereka <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">telah melakukan ini</a> (tautan yang sama mengatakan apa yang harus terhubung), memiliki kesempatan untuk menjalankan permainan untuk Arduboy: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/6VqPGFtIT8Q" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Tetapi penulis lebih tertarik pada kesempatan untuk tidak bermain di perangkat, tetapi untuk belajar: <br><br><ul><li>  serial flash SPI </li><li>  pengunduh untuk AVR </li><li>  standar 802.15.4 </li></ul><br>  Penulis mulai dengan menulis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">perpustakaan</a> (GPL v3) yang memungkinkan Anda untuk menginisialisasi tampilan, menampilkan teks dan persegi panjang, dan juga mengakses memori flash dengan antarmuka SPI.  Kemudian ia mulai memunculkan ide-ide untuk penggunaan praktis perangkat ini: terminal multi-player yang kompatibel dengan VT-100 yang berukuran saku.  Setelah membuat ulang tiga perangkat, ia memutuskan untuk "mengajar" mereka cara membuat sketsa "melalui udara".  Yang tidak hanya menarik, tetapi juga sangat nyaman: sulit untuk membuka penutup perangkat setiap kali, dan di bawah penutup baterai hanya ada celah yang memungkinkan Anda untuk menghubungkan programmer JTAG ke papan tulis. <br><br><img src="https://habrastorage.org/webt/ds/tb/zn/dstbzns76vsm4pfjogzjsyo9mla.jpeg"><br><br>  Ini cukup untuk mengisi bootloader Arduino, tetapi bukan sketsa - port serial tidak dihasilkan di sana, Anda masih tidak dapat melakukannya tanpa membuka kasing.  Juga, garis TX0 dan RX0 dari port serial pertama diselaraskan dengan garis pemungutan suara dari matriks keyboard, yaitu, yang sepanjang tombol fungsi disurvei ke sisi tampilan.  Tetapi apa yang harus dilakukan - penulis membuat ini: <br><br><img src="https://habrastorage.org/webt/8f/xa/-q/8fxa-qo6dgerkd3ghgh4g-tbjak.jpeg"><br><br>  Di sana ia mengeluarkan jalur JTAG, dan sekarang tidak perlu membuka kompartemen baterai.  Dan untuk dapat mengisi sketsa, saya membawa kedua port serial ke konektor yang sama, menambahkan juga saklar, karena ketika baterai dipasang, perangkat tidak dapat dimatikan secara fisik dengan cara yang berbeda. <br><br>  Butuh waktu cukup lama untuk bekerja dengan besi solder, pisau klerikal, dan pistol lem.  Secara umum, menuangkan sketsa "di udara" jauh lebih nyaman, sangat mendesak untuk menciptakan sesuatu untuk ini. <br><br>  Arduino IDE menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">avrdude</a> untuk mengisi sketsa.  Ini berinteraksi dengan mikrokontroler melalui protokol <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">STK500</a> , yang memungkinkan Anda mentransfer file di kedua arah.  Ini tidak kompatibel dengan saluran di mana penundaan variabel, distorsi dan kehilangan data mungkin terjadi.  Jika ada sesuatu yang berbunyi atau gemerisik di saluran serial, Anda bisa menjadi gila dalam mencari penyebab.  Pernah penulis tersiksa selama setengah hari sampai dia menyadari bahwa masalahnya ada pada kabel yang buruk, serta konverter yang berubah-ubah dari antarmuka CP2102.  Bahkan mikrokontroler dengan konverter antarmuka bawaan, misalnya, ATmega32u4, kadang-kadang bisa sangat nakal.  Setiap pengguna Arduino memperhatikan bahwa kesalahan saat mengunggah sketsa tidak jarang terjadi.  Kadang-kadang rekaman berjalan dengan baik, dan kesalahan terdeteksi selama pembacaan verifikasi.  Ini tidak berarti bahwa ada kesalahan saat menulis - kegagalan itu saat membaca.  Sekarang bayangkan ketika bekerja "di udara" hal yang sama akan terjadi, tetapi jauh lebih sering. <br><br>  Setelah mencoba berbagai cara untuk mengatasi masalah ini, penulis datang dengan yang berikut.  Perangkat ini memiliki memori flash 128 kilobyte dengan antarmuka SPI - kami menerima data melalui kabel (ingat bahwa penulis sudah memiliki satu perangkat dengan konektor di samping), kami menggunakan memori ini sebagai penyangga, dan mengirim data ke perangkat lain melalui saluran radio.  Halo dari Cybiko. <br><br>  Setelah menulis kode untuk bekerja dengan saluran radio, serta font, bootloader menjadi lebih dari 4 kilobyte.  Oleh karena itu, nilai HFUSE harus diubah dari 0xDA ke 0xD8.  Sekarang bootloader dapat mencapai 8 kilobyte, dan alamat awal telah menjadi 0x1E000.  Ini tercermin dalam Makefile, tetapi harus diperhitungkan saat mengisi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bootloader</a> dengan avrdude. <br><br>  Transceiver standar 802.15.4 pada ATmega128RFA1 pada awalnya dirancang untuk beroperasi pada protokol <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ZigBee</a> , yang agak rumit, jadi penulis memutuskan untuk hanya mengirim paket saja.  Ini adalah perangkat keras yang diimplementasikan dalam ATmega128RFA1, jadi diperlukan sedikit kode.  Juga, untuk kesederhanaan, penulis memutuskan untuk menggunakan saluran tetap, mencegahnya memilihnya secara manual.  Standar 802.15.4 mendukung 16 saluran dengan angka dari 11 hingga 26. Mereka cukup tersumbat, beberapa juga tumpang tindih saluran WiFi (merah menunjukkan saluran ZigBee, biru, hijau dan kuning - WiFi). <br><br><img src="https://habrastorage.org/webt/nn/vx/fn/nnvxfnxaptwvpgbllq60zkfh2bq.png"><br><br>  Ternyata saluran 15 dan 26 adalah yang paling rentan terhadap gangguan dari WiFi. Penulis memilih yang kedua.  Penafian: Penerjemah tidak tahu apakah ZigBee sangat disederhanakan.  Mungkin perlu sedikit lebih banyak pemrograman dan implementasi penuhnya? <br><br>  Pada perangkat pertama, perlu untuk menerapkan mesin negara yang mentransmisikan data menggunakan protokol STK500.  Sebagian besar, pesan yang dikirim dan diterima bersifat swasembada, tetapi beberapa terkait dengan pesan yang telah melewati saluran sebelumnya.  Deskripsi dialog diberikan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> . <br><br>  Komponen penting dari dialog ini adalah transfer paket yang ditujukan untuk menulis ke memori flash perangkat tujuan.  Mikrokontroler sederhana dari keluarga AVR memiliki ukuran halaman 128 byte, tetapi ATmega128RFA1 memiliki ukuran 256. Dan memori flash yang menghubungkan melalui protokol SPI memiliki ukuran yang sama.  Program di perangkat pertama saat menuangkan sketsa tidak segera mentransfernya ke yang kedua, tetapi menulisnya ke memori ini.  Ketika Arduino IDE memeriksa kebenaran rekaman, mereka mengirimkannya apa yang tertulis di sana.  Sekarang Anda perlu mentransfer data yang diterima melalui udara ke perangkat kedua.  Pada saat yang sama, beralih dari penerimaan ke transmisi dan sebaliknya terjadi cukup sering.  Protokol STK500 acuh tak acuh terhadap penundaan, tetapi tidak mentolerir kehilangan data (aneh, tetapi dikatakan di atas bahwa keterlambatan dalam transmisi data juga mempengaruhi).  Dan kerugian dalam transmisi nirkabel tidak bisa dihindari.  ATmega128RFA1 memiliki implementasi perangkat keras built-in dari permintaan berulang dengan keraguan tentang transmisi yang benar, tetapi penulis memutuskan untuk mengimplementasikan program yang sama secara mandiri.  Dia mengembangkan protokol di mana lebih banyak data lewat di satu arah daripada di yang lain. <br><br>  Itu tidak sempurna, tetapi semuanya bekerja.  Halaman 256-byte dibagi menjadi empat segmen, yang masing-masing ditransmisikan melalui udara sebagai sebuah paket.  Sebuah paket menampung hingga 125 byte data plus satu byte panjang dan dua CRC.  Jadi fragmen 64 byte panjang bersama dengan nomor halaman dan segmen (dari 0 hingga 3) ditempatkan di sana.  Di perangkat penerima, disediakan variabel yang memungkinkan Anda melacak berapa segmen yang diterima, dan ketika keempat segmen tersebut tiba, konfirmasi dikirim ke perangkat pengirim bahwa seluruh halaman telah diterima.  Tidak ada konfirmasi (CRC tidak cocok) - kirim kembali seluruh halaman.  Kecepatan pada saat yang sama ternyata lebih dari ketika mentransmisikan melalui kabel.  Lihat: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/d-ObUCnRmQU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Tetapi sebenarnya, akan diperlukan untuk menyediakan cara yang nyaman untuk menghubungkan perangkat kabel ke perangkat untuk mengisi sketsa dan di atasnya.  Misalnya, letakkan di dalam konverter antarmuka seperti itu pada CP2102, seperti pada foto, dan tempelkan pada papan sehingga dapat menahan gaya saat menghubungkan dan melepaskan kabel Micro USB. <br><br><img src="https://habrastorage.org/webt/vd/qj/e7/vdqje7zvkvnkzoggl7nvoezzzry.jpeg"><br><br>  Ini juga memiliki stabilisator 3,3 volt (dan cara menggunakannya di perangkat dengan catu daya 6 volt - jika saja ada stabilizer yang sama, dan Anda dapat menambahkan dua dioda untuk secara otomatis memilih dari mana perangkat akan dihidupkan)  Ketiga LED harus dihapus dari papan konverter antarmuka, jika tidak mereka akan memuat baterai tambahan saat bekerja dari mereka, dan juga mengganggu polling keyboard dan bekerja dengan memori flash dengan antarmuka SPI. <br><br>  Pengejaran tujuan ternyata lebih menarik daripada pencapaiannya (dan Anda tidak perlu bercanda tentang bus).  Penulis belajar banyak tentang bootloader untuk AVR, memori flash dengan SPI, protokol STK500 dan standar 802.15.4. <br><br>  Semua kode lain selain perpustakaan yang dijelaskan di atas ada di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> , dan itu juga di bawah GPL v3.  Twitter penulis ada di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id447026/">https://habr.com/ru/post/id447026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id447016/index.html">25 tahun kemudian: sebuah wawancara dengan Linus Torvalds</a></li>
<li><a href="../id447018/index.html">Pengayaan kuantum dalam interpretasi multi-dunia</a></li>
<li><a href="../id447020/index.html">Produktivitas bukan tentang manajemen waktu, tetapi tentang manajemen perhatian</a></li>
<li><a href="../id447022/index.html">Jangan memaksa pendengar untuk berpikir</a></li>
<li><a href="../id447024/index.html">Bagaimana cara menggabungkan keunggulan laptop dan komputer desktop? Analisis masalah dan solusi</a></li>
<li><a href="../id447028/index.html">Steganografi file terakhir: kami menyembunyikan data secara langsung di sektor</a></li>
<li><a href="../id447034/index.html">Bug baru di Telegram Desktop memungkinkan Anda membaca pesan terakhir</a></li>
<li><a href="../id447036/index.html">Koktail untuk diet sehat - dibuat oleh startup dari akselerator Universitas ITMO</a></li>
<li><a href="../id447038/index.html">Dalam daftar ancaman: "Game of Thrones" - salah satu sampul paling populer untuk penjahat cyber</a></li>
<li><a href="../id447040/index.html">Penelitian: biaya rata-rata switch berkurang - kami mengerti mengapa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>