<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèáüèº ü§πüèæ ‚úçüèΩ Ver√∂ffentlichung eines inoffiziellen MTProto-Proxys in Python, Protokollfunktionen üòï üë®üèª‚Äçüî¨ üöã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="K√ºrzlich haben Telegrammentwickler den Quellcode eines Proxyservers ver√∂ffentlicht, der auf dem MTProto-Protokoll ausgef√ºhrt wird. Die Artikel √ºber di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ver√∂ffentlichung eines inoffiziellen MTProto-Proxys in Python, Protokollfunktionen</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414139/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/078/b5e/231/078b5e231cde514698b9db4d21cf40cf.png" alt="Bild" width="300"></div><br>  K√ºrzlich haben Telegrammentwickler den Quellcode eines Proxyservers ver√∂ffentlicht, der auf dem MTProto-Protokoll ausgef√ºhrt wird.  Die Artikel √ºber die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Merkmale seiner Montage</a> und das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Umpacken des Docker-Containers</a> wurden auf dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hub ver√∂ffentlicht</a> .  Der offizielle Proxy-Server, geschrieben in C, √ºberrascht mit der Menge an Code - ungef√§hr 23.000 Zeilen.  Zur gleichen Zeit und manchmal etwas fr√ºher kamen mehrere alternative Implementierungen heraus, aber keine von ihnen unterst√ºtzte die M√∂glichkeit, ihren Kanal zu bewerben. <br><br>  In diesem Artikel m√∂chte ich zum einen √ºber wenig bekannte Funktionen des Protokolls f√ºr die Kommunikation eines Proxyservers mit externen Servern sprechen und zum anderen √ºber unsere eigene Entwicklung - die Implementierung eines Proxyservers in Python, der gerade ver√∂ffentlicht wurde und allen unter verf√ºgbar ist Kostenlose MIT-Lizenz. <br><a name="habracut"></a><br><h3>  Merkmale der Interaktion des Proxyservers mit externen Servern </h3><br><ol><li>  Der offizielle Proxyserver interagiert nicht direkt mit Telegrammservern, sondern verwendet hierf√ºr mindestens eine weitere Proxy-Schicht.  Wir werden sie als <b>Middle-Proxy bezeichnen</b> . Ihre Liste finden Sie unter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">core.telegram.org/getProxyConfig</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">core.telegram.org/getProxyConfigV6</a> .  Die IPv6-Verbindung wird vom offiziellen Proxyserver noch nicht unterst√ºtzt. <br></li><li>  Zum Verschl√ºsseln von Daten zwischen dem Proxyserver und dem mittleren Proxy wird ein Schl√ºssel verwendet, der aus den IP-Adressen beider Knoten abgerufen wird.  Daher muss der Proxyserver f√ºr die Verbindung zum mittleren Proxy seine externe IP-Adresse kennen, da sonst die Verschl√ºsselungsschl√ºssel auf der einen und der anderen Seite unterschiedlich sind.  Dar√ºber hinaus sind die Portnummern beider Knoten und das unter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">core.telegram.org/getProxySecret</a> verf√ºgbare gemeinsame Geheimnis an der Bildung des Schl√ºssels beteiligt.  Telegrammentwickler empfehlen, dieses Geheimnis einmal t√§glich zu aktualisieren. <br></li><li>  Wenn Sie einen Proxyserver mit einem mittleren Proxy verbinden, √ºbertr√§gt der erste seine Zeit.  Wenn sich die Zeit um mehr als einige Minuten unterscheidet, schlie√üt die zweite Seite die Verbindung. <br></li><li>  Beim Senden einer Nachricht vom Client an den mittleren Proxy wird die Nachricht in einen RPC-Aufruf an das MTProto-Protokoll eingeschlossen.  Bei jedem solchen RPC-Aufruf f√ºgt der Proxy mehrere Argumente hinzu: IP und Port beider Knoten, eine zuf√§llige Verbindungskennung sowie das Proxy-Server-Tag, mit dem der Werbekanal in der Anwendung angezeigt wird.  Diese zus√§tzlichen Argumente belegen ungef√§hr 96 Bytes.  Aufgrund dieser Funktion ist es nicht m√∂glich, Werbekan√§le anzuzeigen, wenn Sie direkt arbeiten, nicht √ºber den mittleren Proxy. <br></li><li>  Telegrammserver "glauben" den Informationen √ºber den IP-Client, die vom Proxyserver empfangen wurden.  Diese Adressen sind in den Sitzungsinformationen zu sehen (das Rechteck wird gezeichnet): <br><img src="https://habrastorage.org/getpro/habr/post_images/0d5/540/149/0d5540149b03b6a130541839fe58fb5c.jpg" alt="Bild"><br><br></li><li>  Eine TCP-Verbindung zwischen dem Proxyserver und dem mittleren Proxy sendet Nachrichten von verschiedenen Benutzern.  In Anfragen und Antworten gibt es ein Argument "zuf√§llige Verbindungskennung", das erforderlich ist, damit die Daten den richtigen Client erreichen. <br></li><li>  Ein Proxyserver kann keine Clientdaten entschl√ºsseln, aber er kann regul√§re Nachrichten von √ºbertragenen Dateien unterscheiden.  Au√üerdem kennt er die Gr√∂√üe jeder Nachricht. <br></li></ol><br>  Fuf, ich hoffe nicht m√ºde von den technischen Details.  Jetzt sollte klar sein, warum es in vielen alternativen Proxys keine Werbeunterst√ºtzung gibt - sie senden Nachrichten direkt an die Telegrammserver, wobei der mittlere Proxy umgangen wird.  Es stellt sich viel einfacher heraus.  Der zweite Teil des Artikels beschreibt die erste inoffizielle Implementierung eines Proxyservers, der √ºber Middle-Proxy funktioniert.  Im Moment finden Sie im √∂ffentlichen Bereich drei solcher Implementierungen: offiziell, auf Erlang und diese. <br><br><h3>  Python-Proxy-Implementierung </h3><br>  Urspr√ºnglich wurde der Proxyserver geschrieben, um die Funktionen des Protokolls zu verstehen, und es wurde ein anderes Projekt entwickelt - ein asynchroner Socken-Proxy, der wiederum geschrieben wurde, um asynchrones / Warten in Python zu "ber√ºhren". <br><br>  Allm√§hlich begann das Projekt, Benutzer zu haben, die mit Fragen, Fehlerberichten und Funktionsanfragen √ºberschwemmt waren.  Nach Verbesserungen trat das Projekt in die Beta-Test- und Stabilisierungsphase ein, die etwa eine Woche dauerte und f√ºnf Server mit unterschiedlichen Konfigurationen umfasste. <br><br>  Bevor ich √ºber Funktionen spreche, die der offizielle Proxyserver noch nicht hat, aber der alternative Proxy (und √ºber die Funktionen, die der offizielle Proxy bei der Alternative nicht hat) schweigt, werde ich √ºber die Dinge sprechen, an die viele Leute zuerst denken, wenn sie das Wort Python erw√§hnen . <br><br><h4>  Leistung </h4><br>  F√ºr Leistungstests wurde eine virtuelle Maschine in einer Cloud mit minimaler Konfiguration verwendet: 1 CPU, 1024 MB RAM. <br><br>  Bei synthetischen Tests konnte der Proxyserver etwa 240 Megabit / s oder 3000 Nachrichten / s √ºbertragen.  Bei Verwendung einer alternativen Implementierung der Ereignisschleife in C, die als uvloop bezeichnet wird, und auch bei Verwendung des PyPy-Interpreters sind die Leistungsdaten unterschiedlich (alle Messungen erfolgen pro Sekunde): <br><img src="https://habrastorage.org/getpro/habr/post_images/0f9/7e2/8b9/0f97e28b974f46daa21b8c4d76122e02.png" alt="Bild"><br><br>  Beim Testen an realen Benutzern stellte sich heraus, dass ein solcher Server ausreichte, um 4.000 Benutzer oder 8.000 Benutzer bei Verwendung von PyPy bequem zu bedienen. Eine gro√üe √úberraschung war, dass immer noch 89% der Benutzer aus dem Iran stammten, unabh√§ngig davon, wie der Testserver in russischsprachigen Kan√§len beworben wurde (Vielleicht unterscheidet sich f√ºr andere L√§nder die Anzahl der gleichzeitig bedienten Benutzer).  Es sieht so aus: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/23a/bec/039/23abec039507f1e90d53e133cffd0b00.png" alt="Bild"><br><br>  Ich habe mehrere Administratoren anderer Server gefragt - ihre Situation ist dieselbe.  Vielleicht liegt das daran, dass das Telegramm in Russland ohne Proxyserver gut funktioniert.  Im Iran wurden Testserver einige Stunden nach ihrer Erstellung f√ºr die √ñffentlichkeit gesperrt. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/045/209/eb2/045209eb2d2fa72ca624ca2c46b3912c.png" alt="Bild"><br><br>  Serverlast mit 2.000 Benutzern.  Der Moment der Sperrung des Servers f√ºr iranische B√ºrger ist deutlich sichtbar. <br><br>  Daher ist die CPU-Leistung kein Engpass auf dem Testknoten.  Bei 10.000 Clients ist der Speicher wahrscheinlich knapp. <br><br>  Die gleichzeitige Verwendung mehrerer CPU-Kerne ist nicht implementiert (Hallo, GIL). <br><br><h4>  Funktionen, die der offizielle Proxyserver noch nicht hat </h4><br>  <b>Arbeiten Sie am IPv6-Protokoll.</b> <br>  Ein Proxyserver ohne zus√§tzliche Konfiguration kann IPv6 f√ºr ausgehende Verbindungen verwenden.  IPv6-Verbindungen sind in Russland (vorerst) nicht blockiert. <br><br>  <b>Betriebsart ohne Middle-Proxy</b> <br>  Wenn keine Kanalwerbung ben√∂tigt wird, stellt der Proxy automatisch eine direkte Verbindung zu den Telegrammservern her und umgeht den mittleren Proxy.  Es ist schneller und zuverl√§ssiger. <br><br>  Der optionale " <b>Schnellmodus</b> " wird auch implementiert, wenn Nachrichten vom Telegrammserver an den Proxy und vom Proxy an den Client mit demselben Schl√ºssel verschl√ºsselt werden.  Daher muss der Proxy Nachrichten nicht neu verschl√ºsseln - er sendet sie so wie sie sind.  Dies sollte die Sicherheit nicht beeintr√§chtigen.  In jedem Fall hat der Proxy-Administrator keinen Zugriff auf Benutzernachrichten. <br><br>  <b>Mittlere Proxy-Liste und Geheimnis einmal t√§glich automatisch aktualisieren.</b> <br>  Der offizielle Proxyserver zum Aktualisieren der Middle-Proxy-Liste empfiehlt, den Docker-Container einmal t√§glich neu zu starten, wodurch alle Verbindungen zur√ºckgesetzt werden.  Neue Verbindungen k√∂nnen m√∂glicherweise nicht hergestellt werden, wenn beispielsweise ein Server im Land blockiert ist.  Die Python-Version besucht die Site regelm√§√üig und aktualisiert die Liste. <br><br>  <b>Multi-Plattform</b> <br>  Alle Plattformen, auf denen Python ausgef√ºhrt wird, werden unterst√ºtzt.  Es stellte sich heraus, dass es sogar auf dem iPad ausgef√ºhrt werden konnte. Die externen eingehenden Verbindungen wurden jedoch vom Ger√§t blockiert.  Windows wird separat unterst√ºtzt, es war eine √úberraschung f√ºr mich, wie viele Leute Proxys unter diesem Betriebssystem starten.  Obwohl Sie unter Windows den offiziellen Client ausf√ºhren k√∂nnen, wenn Sie Virtualisierungstechnologien oder Docker verwenden. <br><br>  <b>Die F√§higkeit, einfach ohne Docker zu laufen.</b> <br>  Wenn es (pl√∂tzlich) diejenigen gibt, die Docker nicht m√∂gen, kann ein Proxy ohne Docker gestartet werden.  Sie m√ºssen mindestens zwei Parameter in der Konfigurationsdatei angeben: port und secret. Sie k√∂nnen auch das optionale Werbetag festlegen und dann den folgenden Befehl ausf√ºhren: python3 mtprotoproxy.py.  In diesem Fall m√ºssen Sie jedoch √ºber Autorun im Betriebssystem nachdenken, z. B. Unit-Datei f√ºr systemd schreiben.  Sie m√ºssen auch pycrypto oder pycryptodome installieren, ohne es wird es funktionieren, aber sehr langsam. <br><br>  Im Fall von Docker kann der Container mit dem Befehl docker-compose up --build neu erstellt werden. <br><br><h4>  F√ºr die n√§chste Version geplante Funktionen </h4><br>  <b>Begrenzung der Geschwindigkeit beim Herunterladen gro√üer Dateien.</b> <br>  Wenn Sie gro√üe Dateien herunterladen, k√∂nnen Sie auf TCP-Ebene den mittleren Proxy oder den Telegrammserver bitten, Daten langsamer zu senden.  Dies erfolgt nun durch Festlegen eines kleinen Werts des Empfangspuffers, wodurch zus√§tzlich Serverspeicher gespart wird. <br><br>  <b>Streaming von Nachrichten.</b> <br>  Jetzt lesen alle bekannten Proxy-Server, die mit Middle-Proxy arbeiten, zuerst die Nachricht vom Client und senden sie erst dann.  Die Gr√∂√üe einer Nachricht kann 1 MB erreichen.  Ein Speicher wird f√ºr seine Speicherung ben√∂tigt und die √úbertragungsverz√∂gerung wird geringf√ºgig erh√∂ht.  Sie k√∂nnen Daten-Streaming √ºbertragen.  Dies kompliziert den Code, reduziert jedoch im schlimmsten Fall den Speicherverbrauch. <br><br>  <b>√Ñndern Sie die L√§nge der Pakete, um den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Filter entlang der L√§nge des Pakets</a> zu umgehen</b> . <br>  Ich habe es nicht geschafft, in die Ver√∂ffentlichung zu kommen. <br><br><h4>  Installation und Start </h4><br><ol><li>  Git-Klon -b stabil <a href="">github.com/alexbers/mtprotoproxy.git;</a>  cd mtprotoproxy </li><li>  <i>(optional, empfohlen)</i> <b>Geben</b> <b>Sie</b> <b>PORT</b> , <b>USERS</b> und <b>AD_TAG</b> in config.py an </li><li>  docker-compose up --build -d (oder python3 mtprotoproxy.py, also ohne Docker) </li><li>  <i>(Optional, zeigt einen Link der Form tg: // an)</i> Docker-Compose-Protokolle </li></ol><br><img src="https://habrastorage.org/getpro/habr/post_images/d6b/49b/f6d/d6b49bf6d03896df661dcc8af524ed6a.png" alt="Bild"><br><br>  <b>Andere Implementierungen von MTProto-Proxy mit Unterst√ºtzung f√ºr Kanalwerbung:</b> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Offiziell</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Auf Erlang</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">In Python</a> </li></ul><br><br>  <b>Danksagung</b> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">seriyps</a> - f√ºr Hilfe beim Testen an echten Benutzern <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">shifttstas</a> - f√ºr Docker-Tipps <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">forst</a> (github) - f√ºr die Idee und Umsetzung der Arbeit an IPv6 <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">p1ratrulezzz</a> (github) - f√ºr Tipps und einen Artikel √ºber das Projekt <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">freekzy</a> (github) - f√ºr einen Bug Patch mit Griffleck <br><br>  <b>UPD:</b> Repository, das verschiedene Implementierungen des MTProto-Proxys kompiliert: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/mtProtoProxy</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de414139/">https://habr.com/ru/post/de414139/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de414129/index.html">Master in Theoretischer Informatik an der St. Petersburg State University</a></li>
<li><a href="../de414131/index.html">Die Auswirkung der Signalfrequenz auf die Energie von Funkverbindungen im freien Raum</a></li>
<li><a href="../de414133/index.html">Puzzlespieldesign am Beispiel von In The Shadows</a></li>
<li><a href="../de414135/index.html">Durch die Portierung eines Spiels auf PSVita wurde die Gesamtleistung verbessert</a></li>
<li><a href="../de414137/index.html">SPA-Entwicklungserfahrung auf VueJS + Nuxt</a></li>
<li><a href="../de414141/index.html">7 Regeln f√ºr die Gestaltung von Leiterplatten</a></li>
<li><a href="../de414149/index.html">Die Gr√ºnde f√ºr den schlechten Klang der meisten Android-Smartphones</a></li>
<li><a href="../de414151/index.html">Fintech-Digest: Banken melden Sch√§den durch Hackerangriffe, Western Union weigert sich, mit Kryptow√§hrungen zu arbeiten</a></li>
<li><a href="../de414155/index.html">Ereignissysteme in Unity3D</a></li>
<li><a href="../de414157/index.html">Einfacher als es klingt. Kapitel 6-7</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>