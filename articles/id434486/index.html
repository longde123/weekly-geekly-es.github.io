<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍿 🕗 🧑🏽‍🤝‍🧑🏼 Kartu loyalitas. Google Pay API untuk Passes di ASP.NET 🤱🏻 ♂️ 🤧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aplikasi penyimpanan kartu bank dengan cepat memasuki kehidupan kita berkat Apple Wallet dan Google Pay. Kedua platform, selain perbankan, juga memung...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kartu loyalitas. Google Pay API untuk Passes di ASP.NET</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434486/"><p>  Aplikasi penyimpanan kartu bank dengan cepat memasuki kehidupan kita berkat Apple Wallet dan Google Pay.  Kedua platform, selain perbankan, juga memungkinkan Anda untuk bekerja dengan jenis kartu lainnya - kartu loyalitas, kartu hadiah, tiket acara, boarding pass, dll. <br></p><br><p><img src="https://habrastorage.org/webt/ga/ng/rq/gangrq7tlqwob2cmgxa1dydoasu.png"><br></p><br><p>  Saat bekerja untuk perusahaan yang melayani satu jaringan ritel yang agak besar, saya harus mengintegrasikan kartu loyalitas jaringan ini di Apple Wallet dan Google Pay.  Dan jika Anda harus mengotak-atik Apple Wallet hanya karena lapisan integrasi cukup multifungsi, maka dengan Google Pay sebagian besar upaya dan sel-sel saraf dihabiskan untuk mencoba mencari tahu dokumentasi, menemukan alat yang tepat dan mengembangkan bukti konsep pertama.  Meskipun secara umum sisa pekerjaan berjalan jauh lebih cepat daripada untuk Apple Wallet, saya menghabiskan satu hari mencari tahu cara memulai layanan, jadi saya tidak keberatan jika seseorang menulis artikel serupa sebelum saya. <br><a name="habracut"></a><br></p><h2>  1. Materiel </h2><br>  Kartu loyalitas diwakili menggunakan dua entitas - Kelas Loyalitas dan Objek Loyalitas. <br><br><ul><li>  <i>Kelas Loyalitas</i> adalah semacam templat untuk semua kartu loyalitas.  Ini berisi bidang umum untuk semua peta, seperti warna font, tautan ke aset ikon, latar belakang, bidang teks, dll., Deskripsi lengkap dapat ditemukan di sini: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Loyaltyclass</a> <br></li><li>  <i>Loyalty Object</i> - turunan dari LoyaltyClass.  Ini juga berisi data kartu tertentu dari klien tertentu - nomor kartu, nama, bidang teks tambahan.  Deskripsi di sini: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Loyaltyobject</a> <br></li></ul><br>  Untuk menerima kartu, pengguna harus mengikuti tautan format <br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">www.android.com/payapp/savetoandroidpay</a> <b>/ {JWT}</b></i> , di mana JWT adalah token yang menyimpan JSON dengan data LoyaltyClass.  Tetapi karena panjang URL memiliki batasan, Anda disarankan untuk membuat Kelas Loyalitas terlebih dahulu jika strukturnya mengandung banyak karakter. <br><br><p>  Jika Anda perlu memperbarui peta karena perubahan pada templat, gaya, kebutuhan untuk menambah atau mengubah bidang teks, Anda dapat melakukan ini menggunakan API.  Hanya perlu untuk memenuhi permintaan POST dengan versi peta yang baru, layanan Google sendiri menyinkronkan semua aplikasi pengguna yang memiliki peta ini. <br></p><br><h2>  2. Alat dan dokumentasi </h2><br><p>  Masalahnya adalah bahwa semua contoh dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi untuk Google Pay API for Pass</a> secara eksklusif untuk Java, PHP dan Python, dan dokumentasi itu sendiri sangat merekomendasikan "menggunakan pustaka klien untuk menyederhanakan proses" bekerja dengan API. <br></p><br><p>  Mengikuti saran ini, saya dengan senang hati pergi ke nuget, tetapi perpustakaan untuk Google Pay tidak ada di sana.  Glory to Brin, baris pertama di Google untuk "google pay for pass dotnet" mengembalikan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Google Pay API untuk Passes pustaka utilitas</a> halaman, yang menemukan apa yang saya butuhkan, meskipun dalam format arsip ZIP, di mana ada proyek .net dengan kelas yang dihasilkan yang merupakan pembungkus API <a href="">Google Pay</a> - <a href="">Google Pay API untuk pustaka Klien Passes</a> . <br></p><br><p>  Dilihat oleh keberadaan file <i>Google.Apis.Walletobjects.v1.1.9.2.00.nuspec</i> dalam proyek tersebut, penyebaran paket nuget masih menjadi bagian dari rencana tim Google.  Setelah membuka file ini untuk mencari dokumentasi, saya tidak menemukan sesuatu yang konkret, dan beberapa tautan yang ada di bagian deskripsi dikirim ke halaman yang tidak ada sama sekali. <br><br></p><h2>  3. Mendapatkan token akses </h2><br><p>  Untuk mulai bekerja secara langsung dengan Google Pay API untuk Passes, Anda perlu mendapatkan token akses, untuk ini Anda perlu: <br><br></p><ol><li>  Punya Akun Google Merchant, yang bisa Anda dapatkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">di sini</a> <br></li><li>  Buat Akun Layanan, dapatkan file dengan kredensial untuknya - dokumen json dengan detail akun layanan, termasuk pengidentifikasi, email, kunci pribadi, dll.  Seperti yang direkomendasikan oleh dokumentasi, Anda perlu menyimpan file ini di tempat yang aman. <br></li><li>  Tautkan Akun Pedagang dan Akun Layanan di Google Merchant Center <br></li></ol><br>  Dengan menggunakan file ini, Anda dapat masuk menggunakan perpustakaan <i>Google.Apis.Auth.OAuth2</i> : <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">await</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOAuthToken</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> serviceAccountFile = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty;         serviceAccountFile = ConfigurationManager.AppSettings[<span class="hljs-string"><span class="hljs-string">"GooglePayServiceAccountConfigPath"</span></span>];        <span class="hljs-comment"><span class="hljs-comment">/*              Credential, GoogleCredential              Service Account,   ,      scopes API,             */</span></span>         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> credential = GoogleCredential.FromFile(serviceAccountFile)                            .CreateScoped(WalletobjectsService.Scope.WalletObjectIssuer);        <span class="hljs-comment"><span class="hljs-comment">/*        Access token        ,   GetAccessTokenForRequestAsync         ,               */</span></span>         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> token = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> credential.UnderlyingCredential.GetAccessTokenForRequestAsync();         <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> token; }</code> </pre> <br><h2>  4. Buat peta </h2><br><p>  Untuk membuat kartu loyalitas, Anda harus terlebih dahulu membuat Kelas Loyalitas.  Kelas Loyalitas dapat dibuat menggunakan API, dan menggunakan antarmuka web Google Merchant Center.  Perhatian harus diberikan pada nama kelas, karena nama ini harus unik dalam infrastruktur Google Pay. <br><br>  Setelah membuat Kelas Loyalitas, Anda dapat membuat Objek Loyalitas.  Untuk melakukan ini, Anda sudah perlu perpustakaan yang kami tambahkan ke proyek sebelumnya: buat objek permintaan, tentukan token OAuth, transfer objek LoyaltyObject yang dibuat, dan jalankan permintaan: <br><br></p><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GooglePayApiService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ,    Merchant Account IssuerId = ConfigurationManager.AppSettings["GooglePayIssuerId"]; _wobService = new WalletobjectsService(); } private async Task&lt;LoyaltyObject&gt; ConvertLoyaltyObjectFromTemplate(GooglePayPassTemplate template) { string id = $"{IssuerId}.{template.SerialNumber}"; string loyaltyClassName = ConfigurationManager.AppSettings["GooglePayStoreCardClassName"];     var loyaltyClass = await GetLoyaltyClass(loyaltyClassName); var result =  new LoyaltyObject { Id = id, AccountName = template.AccountName,          Barcode = new Barcode          {          AlternateText = template.BarcodeText,               Value = template.SerialNumber,               Type = "pdf417"          },          Kind = "walletObject#loyaltyObject",          ClassId = loyaltyClass.Id,          ClassReference = loyaltyClass,          State = "active"     };     return result; } private async Task&lt;LoyaltyObject&gt; CreateLoyaltyObject(LoyaltyObject loyaltyObject) { var saveRequest = _wobService.Loyaltyobject.Insert(loyaltyObject); saveRequest.OauthToken = await GetOAuthToken(); var savedObject = await saveRequest.ExecuteAsync(); return savedObject; }</span></span></code> </pre><br>  <i>GooglePayPassTemplate</i> dalam contoh ini adalah DTO yang menyimpan templat peta untuk pengguna, yang dihasilkan oleh layanan yang dikembangkan terpisah. <br><br><h2>  5. Pembaruan peta </h2><br><p>  Di sini prinsipnya sama dengan saat membuat: kami menghasilkan permintaan, mentransfer objek LoyaltyObject yang diperbarui, jalankan: <br><br></p><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;LoyaltyObject&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateLoyaltyObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoyaltyObject loyaltyObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updateRequest = _wobService.Loyaltyobject.Update(loyaltyObject, loyaltyObject.Id);           updateRequest.OauthToken = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> GetOAuthToken(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> savedObject = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> updateRequest.ExecuteAsync(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> savedObject; }</code> </pre> <br><p>  Setelah menyelesaikan permintaan, kartu dalam aplikasi pengguna yang telah diinstal akan diperbarui setelah beberapa detik, jika perangkat berada di jaringan dan memiliki koneksi Internet. </p><br><br><h2>  6. generasi JWT </h2><br><p>  Untuk memasang kartu, Anda harus mengarahkan pengguna ke tautan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">www.android.com/payapp/savetoandroidpay</a> <b>/ {JWT}</b> .  Deskripsi struktur token dapat ditemukan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tautan ini</a> . <br></p><br><p>  Token ditandatangani oleh RSA-SHA256 dengan tanda tangan yang dapat dibuat menggunakan file yang sama dengan kredensial Akun Layanan: <br><br></p><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">JwtHelper</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateJwtForLoyaltyObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoyaltyObject loyaltyObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*       credential   ,         */</span></span> ServiceAccountCredential credential; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> now = DateTime.UtcNow; DateTime unixEpoch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">1970</span></span>, <span class="hljs-number"><span class="hljs-number">01</span></span>, <span class="hljs-number"><span class="hljs-number">01</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 1970-01-01 00:00:00 UTC var secondsSinceEpoch = (int)Math.Round((now - unixEpoch).TotalSeconds); string serviceAccountFile = serviceAccountFile = ConfigurationManager.AppSettings["GooglePayServiceAccountConfigPath"]; using (var fs = new FileStream(serviceAccountFile, FileMode.Open, FileAccess.Read, FileShare.Read)) { credential = ServiceAccountCredential.FromServiceAccountData(fs); } /*    JwtPayload,     payload-a  JWT */ var jwtPayload = new JwtPayload { iat = secondsSinceEpoch, iss = credential.Id, payload = new JwtInternalPayload { loyaltyObjects = new[] { new LoyaltyObjectPayload { id = loyaltyObject.Id } } } }; string header = @"{""alg"":""RS256"",""typ"":""JWT""}"; string payload = JsonConverter.SerializeObject(jwtPayload); string base64Header = EscapedBase64(Convert.ToBase64String(Encoding.UTF8.GetBytes(header))); string base64Payload = EscapedBase64(Convert.ToBase64String(Encoding.UTF8.GetBytes(payload))); //        Signature string signature = EscapedBase64(credential.CreateSignature( Encoding.UTF8.GetBytes($"{base64Header}.{base64Payload}") )); var token = $"{base64Header}.{base64Payload}.{signature}"; return token; } private static string EscapedBase64(string base64) { return base64.Replace('+', '-') .Replace('/', '_') .Replace("=", ""); } }</span></span></code> </pre><br><h2>  Kesimpulan </h2><br><p>  Dalam artikel ini, kami membahas dasar-dasar bekerja dengan Google Pay API untuk Passes: mengatur akun, menghubungkan ke API, membuat Kelas Loyalitas dan Objek Loyalitas. <br><br>  Jika UFO mendukung, saya akan memberi tahu Anda secara terpisah tentang cara bekerja dengan Apple Wallet (semuanya lebih sulit dalam hal penerapan), cara membuat Apple Wallet berteman dengan Google Pay dalam satu layanan web dan tidak merasa sakit. <br></p><br><p></p><h3>  Tautan yang bermanfaat </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Daftarkan Akun Pedagang</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Google Pay API untuk Dokumentasi Passes</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Perpustakaan klien untuk bekerja dengan Google Pay API for Passes</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id434486/">https://habr.com/ru/post/id434486/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id434474/index.html">Kucing hijau tentang konten ruang</a></li>
<li><a href="../id434476/index.html">ChatOps di GitLab akan tersedia untuk semua orang</a></li>
<li><a href="../id434478/index.html">Kode tanpa wajah akan mematikan pemrograman, dan kami tidak akan melakukan apa-apa.</a></li>
<li><a href="../id434480/index.html">Tahun baru, gadget, api</a></li>
<li><a href="../id434482/index.html">Satu tahun lagi dari blog kami: hasil tahun 2018</a></li>
<li><a href="../id434490/index.html">Bagaimana kami melihat speakerphone dengan pemotongan waterjet</a></li>
<li><a href="../id434494/index.html">Apa yang harus dibaca. Daftar fiksi berbahasa Rusia untuk 2017 dan 2018</a></li>
<li><a href="../id434496/index.html">Komitmen dua fase dan masa depan sistem terdistribusi</a></li>
<li><a href="../id434498/index.html">MVP dan Belati 2 - Kerangka Aplikasi Android - Bagian 1</a></li>
<li><a href="../id434500/index.html">Penipu bernama Jeanne atau Watch Your Ears</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>