<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•Ö üî¶ üë∞ Vitrine do modelo de driver simples (SDM) do NodeMCU: interface de usu√°rio din√¢mica üßî üôéüèø üè¥‚Äç‚ò†Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O NodeMCU √© um firmware interativo , que permite executar o interpretador Lua no microcontrolador ESP8266 (o suporte ao ESP32 est√° em desenvolvimento)...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Vitrine do modelo de driver simples (SDM) do NodeMCU: interface de usu√°rio din√¢mica</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449992/"><p><img src="https://habrastorage.org/webt/45/dq/e8/45dqe8yvyxvpg_kcien-88xslei.jpeg" alt="imagem"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O NodeMCU</a> √© um <em>firmware interativo</em> , que permite executar o interpretador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lua</a> no microcontrolador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ESP8266</a> (o suporte ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ESP32</a> est√° em desenvolvimento).  Juntamente com todas as interfaces de hardware regulares, possui m√≥dulo WiFi e sistema de arquivos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SPIFFS</a> . </p><br><p>  Este artigo descreve o novo m√≥dulo para o NodeMCU - sdm.  SDM significa modelo de driver simples e fornece abstra√ß√£o de modelo de driver de dispositivo para o sistema.  Na primeira parte deste artigo, discutiremos o pr√≥prio modelo e, na segunda parte, ser√° mostrada uma interface de usu√°rio da web criada dinamicamente usando sdm com alguns coment√°rios. </p><a name="habracut"></a><br><h1 id="driver-model-basics">  No√ß√µes b√°sicas do modelo de driver </h1><br><p>  Dois componentes principais do modelo s√£o <em>dispositivos</em> e <em>drivers</em> .  Dispositivo √© uma representa√ß√£o abstrata de algum hardware ou dispositivo virtual.  Faz sentido colocar dispositivos na hierarquia da √°rvore, com o microcontrolador no topo, os barramentos no meio e os sensores como folhas. </p><br><pre><code class="plaintext hljs">DEVICES + DRIVERS | +-----+ | +-----+ |1WIRE&lt;----------------------+1WIRE| ++-+-++ | +-----+ | | | | +---------+ | +--------+ | +------+ | | | +------+DS1820| +---v----+ +---v----+ +---v----+ | | +------+ |DS1820|0| |DS1820|1| |DS1822|0| | | +---^----+ +---^----+ +---^----+ | | +------+ | | +--------------+DS1822| | | | | +------+ +-----------+------------------+ +</code> </pre> <br><p>  O driver de dispositivo √© uma parte da l√≥gica associada a um determinado dispositivo.  As fun√ß√µes fornecidas pelo driver s√£o chamadas de <em>m√©todos</em> , os cont√™ineres de dados associados ao driver s√£o chamados de <em>atributos</em> .  Ambos os m√©todos e atributos vivem dentro do driver. </p><br><p>  Os atributos t√™m duas fun√ß√µes associadas a eles: ganchos <em>getter</em> e <em>setter</em> .  Portanto, atribui uma funcionalidade de superconjunto ao m√©todo, mas tamb√©m consome mais mem√≥ria (a mem√≥ria do microcontrolador √© escassa, lembra? </p><br><pre> <code class="lua hljs">sdm.attr_add(drv, <span class="hljs-comment"><span class="hljs-comment">-- device handle "ref", -- attribute name "Reference voltage", -- attribute description 5, function(dev) -- this is a getter function return sdm.attr_data(sdm.attr_handle(dev, "ref")) end, function(dev, value) -- this is a setter function sdm.attr_set(sdm.attr_handle(dev, "ref"), value) end )</span></span></code> </pre> <br><h2 id="device-binding">  Liga√ß√£o de dispositivo </h2><br><p>  Parte complicada do modelo de driver √© a liga√ß√£o de driver de dispositivo.  O processo em si √© bastante simples: combinamos o dispositivo com cada driver dispon√≠vel at√© que ele se encaixe.  Faltam apenas duas partes - l√≥gica correspondente e alguns dados aos quais corresponder. </p><br><p>  Na correspond√™ncia sdm, a l√≥gica reside nos drivers com o nome <code>_poll()</code> .  √â um m√©todo regular chamado de identificador de dispositivo como par√¢metro e retorna <code>true</code> ou <code>false</code> se o dispositivo puder ou n√£o ser conectado ao driver, respectivamente. </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"_poll"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, drv, par)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_data(sdm.local_attr_handle(dev, <span class="hljs-string"><span class="hljs-string">"id"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">-- get device attribute "id" if attr == nil then return false end -- if it does not have one, driver does not match -- parent name must be "ESP8266_1W" and first byte of "id" must be "0x28" return (sdm.device_name(par) == "ESP8266_1W") and (attr:byte(1) == 0x28) end )</span></span></code> </pre> <br><p>  Como visto no exemplo acima, o driver corresponde ao dispositivo usando o atributo  Mas, como observado acima, os atributos se associam apenas ao driver.  Geralmente √© verdade, mas existem alguns atributos que n√£o podem ser recuperados via software.  Estes s√£o IDs de chip, pinos usados ‚Äã‚Äãetc.  Para aqueles, um tipo especial de atributo foi adicionado ao <em>atributo</em> sdm - <em>local</em> .  Este atributo est√° associado a uma inst√¢ncia do dispositivo e geralmente imut√°vel. </p><br><p>  A √∫nica coisa que resta a dizer sobre a liga√ß√£o do driver.  Normalmente, os dispositivos requerem algum tipo de inicializa√ß√£o na inicializa√ß√£o e limpeza ap√≥s o uso.  Para esse prop√≥sito, o sdm usa os m√©todos <code>_init()</code> e <code>_free()</code> . <br>  Se o driver tiver o m√©todo <code>_init()</code> , ele ser√° chamado automaticamente ap√≥s a liga√ß√£o do dispositivo.  O mesmo com <code>_free()</code> . </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"_init"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, drv, par)</span></span></span></span> sdm.device_rename(dev, sdm.request_name(<span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">-- rename device sdm.attr_copy(dev, "temp") -- copy attribute sdm.attr_copy(dev, "precision") -- copy attribute local met = sdm.method_dev_handle(par, "setup") -- get 1Wire bus pin init function .. local func = sdm.method_func(met) -- .. and .. func(par, dev) -- .. call it end ) sdm.method_add(drv, "_free", nil, function(dev, drv, par) local met = sdm.method_dev_handle(par, "free") -- get 1Wire bus pin free function .. local func = sdm.method_func(met) -- .. and .. func(par, dev) -- .. call it end )</span></span></code> </pre> <br><p>  O leitor atento provavelmente perguntaria: o que significa "copiar atributo" no exemplo acima?  E ele estaria certo, porque isso tem a ver com o terceiro tipo de atributo que ainda n√£o discutimos - <em>o atributo privado</em> .  N√£o faz muito sentido ter todos os dados de atributos compartilhados entre todas as inst√¢ncias do dispositivo.  Para esse fim, o sdm fornece um mecanismo de c√≥pia do atributo do driver e o associa ao dispositivo.  Isso faz com que o driver atribua um prot√≥tipo ou modelo. </p><br><p>  Um resumo r√°pido: </p><br><ul><li>  <em>atributos locais</em> s√£o usados ‚Äã‚Äãpara dados que n√£o podem ser recuperados pelo software.  Como IDs de dispositivos, pinos conectados etc. </li><li>  <em>os atributos do driver</em> s√£o usados ‚Äã‚Äãpara dados compartilhados entre todas as inst√¢ncias de dispositivos conectados a esse driver. </li><li>  <em>os atributos privados</em> s√£o copiados dos atributos do driver e mant√™m os dados associados a apenas uma inst√¢ncia do dispositivo.  Esse tipo √© o mais comum. </li></ul><br><div class="scrollable-table"><table><thead><tr><th>  Propriedade </th><th>  Atributo local </th><th>  Atributo privado </th><th>  Atributo Driver (P√∫blico) </th></tr></thead><tbody><tr><td>  Armazenado em </td><td>  dispositivo </td><td>  dispositivo </td><td>  motorista </td></tr><tr><td>  Acess√≠vel usando a al√ßa do driver </td><td>  - </td><td>  - </td><td>  + </td></tr><tr><td>  Acess√≠vel usando a al√ßa do dispositivo </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Compartilhado entre dispositivos </td><td>  - </td><td>  - </td><td>  + </td></tr><tr><td>  Persistir ao desanexar o driver </td><td>  + </td><td>  - </td><td>  + </td></tr></tbody></table></div><br><h1 id="web-user-interface-implementation">  Implementa√ß√£o da Interface com o Usu√°rio da Web </h1><br><h2 id="server-code">  C√≥digo do servidor </h2><br><p>  H√° um ador√°vel projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://github.com/marcoskirsch/nodemcu-">nodemcu-httpserver</a> que implementa o c√≥digo do servidor para o NudeMCU.  Infelizmente, parece estar morto.  Foi usado como base para o servidor.  Primeiro, as fun√ß√µes do servidor foram <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://gitlab.com/matsievskiysv/nodemcu-">movidas para o LFS</a> e, em seguida, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://gitlab.com/matsievskiysv/nodemcu-pseudo">ligeiramente modificadas</a> para atender a uma p√°gina est√°tica para cada chamada.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O Vue.js</a> √© uma escolha perfeita para p√°ginas da Web baseadas em modelos.  Ent√£o foi usado para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">frontend</a> .  Vale ressaltar que o NodeMCU pode n√£o estar conectado √† Internet.  Por esse <code>vue.js</code> , a biblioteca <code>vue.js</code> precisa estar presente localmente e ser atendida pelo servidor NodeMCU. </p><br><p>  Como todos os dispositivos est√£o organizados em estrutura em √°rvore, eles s√£o acessados ‚Äã‚Äãcomo um diret√≥rio: <code>/ESP8266/ESP8266_1W/DS18S20-0</code> .  Aqui <code>/ESP8266</code> √© uma p√°gina do NodeMCU, <code>/ESP8266/ESP8266_1W</code> √© uma p√°gina de barramento <em>1Wire</em> e, finalmente, <code>/ESP8266/ESP8266_1W/DS18S20-0</code> √© um sensor de temperatura. </p><br><p>  Como mencionado anteriormente, todas as p√°ginas do dispositivo s√£o criadas a partir de uma p√°gina de modelo que √© veiculada em todas as chamadas.  <em>O</em> c√≥digo <em>JS</em> dentro desta p√°gina faz a solicita√ß√£o para a mesma URL, anexada com <code>/api</code> .  Para o exemplo acima, o URL da chamada seria <code>/api/ESP8266/ESP8266_1W/DS18S20-0</code> .  Em tais solicita√ß√µes, o servidor responde com dados espec√≠ficos do dispositivo codificado em <em>JSON</em> , que preenchem a p√°gina.  Obviamente, a solicita√ß√£o da p√°gina <em>HTML</em> pode ser ignorada se apenas dados brutos forem necess√°rios. </p><br><h2 id="device-tree">  √Årvore de dispositivos </h2><br><p>  A configura√ß√£o inicial do dispositivo √© feita usando <em>uma</em> estrutura de <em>√°rvore de dispositivos simples</em> .  √â como uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√°rvore de dispositivos</a> , mas mais simples.  Ele descreve a configura√ß√£o do hardware, incluindo atributos locais do dispositivo. </p><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> root={ <span class="hljs-comment"><span class="hljs-comment">-- local_attributes={}, children={ { name="ESP8266_1W", -- local_attributes={}, children = { { name="DS18S20-0", -- static declaration alternative to 1Wire poll method local_attributes={ { name="id", desc=nil, -- empty description to save space data=string.char(16) .. string.char(221) .. string.char(109) .. string.char(104) .. string.char(3) .. string.char(8) .. string.char(0) .. string.char(150) -- ugly way to create byte array }, { datapin=2 } } }, } }, { name="ESP8266_SPI", -- local_attributes={}, children = { { name="MCP3208-0" }, } }, } }</span></span></code> </pre> <br><h2 id="hardware-setup">  Configura√ß√£o de hardware </h2><br><p>  Aqui come√ßa a vitrine.  Para esse prop√≥sito, v√°rios sensores foram conectados ao NodeMCU: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Sensor de</a> temperatura <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DS18B20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Sensor de</a> temperatura <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DS18S20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MCP3208</a> ADC </li></ul><br><p>  <em>Os</em> sensores <em>1Wire</em> est√£o conectados ao mesmo pino. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fb/sw/zi/fbswzi7xav_pj4waz6g19hktrso.jpeg"></a> </p><br><h2 id="web-pages-and-drivers">  P√°ginas da Web e drivers </h2><br><h3 id="root-device">  dispositivo raiz </h3><br><p>  O principal objetivo do dispositivo raiz (tamb√©m conhecido como ESP8266) √© fornecer espa√ßo para seus filhos se conectarem.  No entanto, n√£o √© restrito ter m√©todos ou atributos associados a ele. </p><br><p>  Este trecho de c√≥digo √© <a href="">daqui</a> : </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"_init"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, drv, par)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_handle(dev, <span class="hljs-string"><span class="hljs-string">"id"</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- get device "id" attribute sdm.attr_set(attr, node.chipid()) -- set "id" value attr = sdm.attr_handle(dev, "float") -- get device "float" attribute sdm.attr_set(attr, 3 / 2 ~= 1) -- set to true if firmware supports floating point instructions end ) sdm.attr_add(drv, "float", "Floating point build", false, function(drv) -- attribute value is set inside "_init" function local attr = sdm.attr_drv_handle(drv, "float") return sdm.attr_data(attr) -- just return stored value end, nil )</span></span></code> </pre> <br><p>  Esse c√≥digo adiciona o atributo <code>float</code> que √© usado para armazenar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tipo de constru√ß√£o do</a> firmware.  Seu valor √© inicializado no gancho <code>_init()</code> que √© uma fun√ß√£o especial, executada uma vez quando o driver √© conectado ao dispositivo. </p><br><p>  Esta √© a p√°gina gerada para o dispositivo raiz. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/mg/5q/lo/mg5qlog3-nwjkl6itrfw6ynyvuo.png"></a> </p><br><p>  Aqui podemos ver que o dispositivo raiz tem um <code>heap</code> m√©todo, dois atributos de driver <code>float</code> e <code>id</code> .  Por fim, ele possui dois dispositivos conectados - os barramentos <em>SPI</em> e <em>1Wire</em> . </p><br><h3 id="spi">  SPI </h3><br><p>  <a href=""><em>O</em> driver <em>SPI</em></a> n√£o √© muito interessante.  Apenas mapeia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">as</a> fun√ß√µes do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NodeMCU SPI</a> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/qx/mx/g8/qxmxg8mnkmnl5aglfq7q5zhpnv0.png"></a> </p><br><h3 id="mcp3208">  Mcp3208 </h3><br><p>  <em>MCP3208</em> √© um chip <em>ADC</em> .  Ele mede tens√µes de zero a <em>ref</em> e retorna o c√≥digo de 12 bits.  O interessante dessa implementa√ß√£o de <a href="">driver</a> √© que o atributo <code>ref</code> estaria presente na compila√ß√£o apenas se o firmware oferecer suporte √† aritm√©tica de ponto flutuante.  Se n√£o for suportado, em vez da tens√£o absoluta, o c√≥digo de voltagem ser√° retornado pelos m√©todos <code>single</code> e <code>differential</code> . </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"single"</span></span>, <span class="hljs-string"><span class="hljs-string">"Single ended measure 0|1|2|3|4|5|6|7"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, channel)</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">-- ... if ref ~= nil then -- this part is executed only if floating point arithmetic is enabled rv = ref * rv / 4096 end return rv end ) if 3/2~=1 then -- other alternative is to access ESP8266 "float" method sdm.attr_add(drv, "ref", "Reference voltage", 5, function(dev) return sdm.attr_data(sdm.attr_handle(dev, "ref")) end, function(dev, value) sdm.attr_set(sdm.attr_handle(dev, "ref"), value) end ) end</span></span></code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/m_/_l/cc/m__lccntxwsrorrujvky3opbm0s.png"></a> </p><br><p>  Observe tamb√©m que este dispositivo tem o atributo <code>ref</code> marcado como <em>privado</em> .  √â definido por dispositivo. </p><br><h3 id="1wire">  1 fio </h3><br><p>  <a href=""><em>1 O</em> driver do driver</a> implementa o m√©todo de <code>poll</code> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pesquisa din√¢mica de dispositivos</a> . </p><br><p>  Logo ap√≥s a descoberta do dispositivo, seu tipo n√£o √© conhecido.  Portanto, seu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">endere√ßo exclusivo</a> <em>1Wire</em> √© usado como um novo nome de dispositivo (bytes representados como n√∫meros separados por caracteres <code>_</code> ). </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"poll"</span></span>, <span class="hljs-string"><span class="hljs-string">"Poll for devices"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bus, pin)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> children = sdm.device_children(bus) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> {} <span class="hljs-comment"><span class="hljs-comment">-- already attached local ids = {} -- get IDs of attached devices for name, handle in pairs(children) do local dpin = sdm.attr_data(sdm.local_attr_handle(handle, "pin")) if dpin == pin then ids[sdm.attr_data(sdm.local_attr_handle(handle, "id"))] = true end end ow.reset_search(pin) -- reset previous search while true do -- for all found devices local id = ow.search(pin) if id == nil then break end if ids[id] == nil then -- if not already present local name = "" for i=1,#id do name = name .. tostring(id:byte(i)) .. "_" end name = name:sub(1,-2) -- add to system with their ID used as name local device = sdm.device_add(name, bus) -- add "pin" attribute local rv = sdm.local_attr_add(device, "datapin", nil, pin, nil, nil) -- add "id" attribute local rv = sdm.local_attr_add(device, "id", nil, id, nil, nil) -- poll for driver local rv = sdm.device_poll(device) end end end )</span></span></code> </pre> <br><p>  Esta √© a p√°gina inicial do driver <em>1Wire</em> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/j2/uq/ax/j2uqaxkhqilv0k1fmwaq2hn0iwq.png"></a> </p><br><p>  Ap√≥s emitir a chamada de <code>poll</code> com o argumento <code>2</code> e a p√°gina atualizada, a se√ß√£o filhos √© exibida.  Observe que os nomes dos filhos s√£o leg√≠veis por humanos.  Isso ocorre porque a fun√ß√£o <code>device_rename()</code> foi chamada durante a <code>_init</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/_z/2x/na/_z2xnadqlt_qgyokfxomwivtwkq.png"></a> </p><br><h3 id="ds18s20">  DS18S20 </h3><br><p>  Na inicializa√ß√£o, o <a href="">driver DS18S20</a> verifica se o <em>ID do</em> dispositivo come√ßa com <code>0x10</code> , que √© um c√≥digo de fam√≠lia do dispositivo.  Quando o dispositivo √© conectado ao driver, ele √© renomeado para <code>DS18S20-X</code> , onde <code>DS18S20</code> √© um nome de base e <code>X</code> √© um n√∫mero de inst√¢ncia. </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"_poll"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, drv, par)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_data(sdm.local_attr_handle(dev, <span class="hljs-string"><span class="hljs-string">"id"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> attr == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (sdm.device_name(par) == <span class="hljs-string"><span class="hljs-string">"ESP8266_1W"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (attr:<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-number"><span class="hljs-number">0x10</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- check family ID end ) sdm.method_add(drv, "_init", nil, function(dev, drv, par) sdm.device_rename(dev, sdm.request_name("DS18S20")) -- rename device sdm.attr_copy(dev, "temp") -- copy attribute to device local met = sdm.method_dev_handle(par, "setup") local func = sdm.method_func(met) -- use parent "setup" method on the device func(par, dev) end )</span></span></code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/bm/pk/41/bmpk419dphexm-xlvnxq7hw2jxc.png"></a> </p><br><p>  O atributo local <code>id</code> e <code>datapin</code> n√£o t√™m ganchos <code>getter</code> e <code>setter</code> , portanto, apenas seus nomes s√£o vis√≠veis. </p><br><h3 id="ds18b20">  DS18B20 </h3><br><p>  <a href="">O driver DS18B20</a> √© quase o mesmo que o <a href="">driver DS18S20</a> .  A √∫nica diferen√ßa √© o m√©todo de <code>precision</code> .  Os dois drivers <em>DS18-20</em> assumem a constru√ß√£o de n√∫meros inteiros e n√£o usam divis√£o de ponto flutuante. </p><br><pre> <code class="lua hljs">sdm.attr_add(drv, <span class="hljs-string"><span class="hljs-string">"precision"</span></span>, <span class="hljs-string"><span class="hljs-string">"Precision (9|10|11|12)"</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, precision)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_dev_handle(dev, <span class="hljs-string"><span class="hljs-string">"precision"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sdm.attr_data(attr) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, precision)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> par = sdm.device_parent(dev) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_dev_handle(dev, <span class="hljs-string"><span class="hljs-string">"precision"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ex = sdm.method_func(sdm.method_dev_handle(par, <span class="hljs-string"><span class="hljs-string">"exchange"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> modes = {[<span class="hljs-number"><span class="hljs-number">9</span></span>]=<span class="hljs-number"><span class="hljs-number">0x1f</span></span>, [<span class="hljs-number"><span class="hljs-number">10</span></span>]=<span class="hljs-number"><span class="hljs-number">0x3f</span></span>, [<span class="hljs-number"><span class="hljs-number">11</span></span>]=<span class="hljs-number"><span class="hljs-number">0x5f</span></span>, [<span class="hljs-number"><span class="hljs-number">12</span></span>]=<span class="hljs-number"><span class="hljs-number">0x7f</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> modes[precision] ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ex(par, dev, {<span class="hljs-number"><span class="hljs-number">0x4e</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, modes[precision]}) sdm.attr_set(attr, precision) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> )</code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/er/lj/gb/erljgbs9zby8767izkmsunyhdd8.png"></a> </p><br><h2 id="memory-usage">  Uso de mem√≥ria </h2><br><p>  <em>A</em> mem√≥ria livre do <em>ESP8266</em> √© de cerca de <em>40k</em> .  O c√≥digo do servidor √© movido para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://gitlab.com/matsievskiysv/nodemcu-">LFS</a> , portanto, ele n√£o ocupa espa√ßo de RAM no momento da inicializa√ß√£o ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://github.com/marcoskirsch/nodemcu-">o c√≥digo original</a> levou cerca de <em>10k</em> ). </p><br><p>  <em>O SDM</em> ocupa cerca de <em>10k</em> para 5 drivers de dispositivo e 5 dispositivos.  Um pouco menor para a constru√ß√£o de firmware n√£o flutuante.  Portanto, √© prefer√≠vel selecionar no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">manifesto do driver</a> apenas os drivers necess√°rios para a tarefa em quest√£o.  A tarefa que consome mais mem√≥ria √© servir a biblioteca <code>vue.js</code> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yy/u-/_i/yyu-_idkp2osapmg3-jy5z2r8ly.png"></a> </p><br><p>  No caso de solicitar dados brutos codificados em <em>JSON</em> (usando <code>curl</code> ), o consumo de mem√≥ria de pico pode ser significativamente reduzido. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/w_/hu/xx/w_huxxzt4w2wszdqq04bgbonbt0.png"></a> </p><br><h2 id="instead-of-an-epilogue">  Em vez de um ep√≠logo </h2><br><p>  Um dos primeiros m√©todos que implementei com sdm foi a liga√ß√£o para <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>node.restart()</code></a> . <br>  Experiment√°-lo usando a interface do usu√°rio da web produziu um resultado curioso.  Logo depois que o navegador da web emitiu a solicita√ß√£o, o chip foi reiniciado conforme o esperado.  Mas como o NodeMCU n√£o respondeu adequadamente √† solicita√ß√£o HTTP, o navegador da Web tentou a mesma solicita√ß√£o novamente.  Quando o servidor NodeMCU foi reiniciado e foi reiniciado, o navegador conectado a ele, redefiniu o contador de <em>tentativa</em> interna <em>novamente</em> e chamou o m√©todo <code>node.restart()</code> , iniciando assim um loop infinito de reinicializa√ß√£o do NodeMCU. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt449992/">https://habr.com/ru/post/pt449992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt449976/index.html">Cont√™ineres associativos multithread em C ++. Relat√≥rio Yandex</a></li>
<li><a href="../pt449978/index.html">Igor Antarov do Moscow Tesla Club luta contra 20 mitos sobre Tesla e carros el√©tricos</a></li>
<li><a href="../pt449984/index.html">Google News e Leo Tolstoy: visualizando incorpora√ß√µes de palavras do Word2Vec usando t-SNE</a></li>
<li><a href="../pt449986/index.html">Blockchain: o que devemos construir um caso?</a></li>
<li><a href="../pt449990/index.html">Como fazer amigos de l√°tex, f√≥rmulas e Habr?</a></li>
<li><a href="../pt449994/index.html">As oito regras de ouro de Schneiderman o ajudar√£o a criar uma interface melhor</a></li>
<li><a href="../pt449996/index.html">Compreendendo o algoritmo da FFT</a></li>
<li><a href="../pt449998/index.html">FAQ: o que um viajante nerd precisa saber sobre vacinas antes de viajar</a></li>
<li><a href="../pt450000/index.html">(Da direita para a esquerda (atrav√©s do espelho</a></li>
<li><a href="../pt450002/index.html">Localizando erros no LLVM 8 com PVS-Studio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>