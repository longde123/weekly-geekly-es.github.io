<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöï ‚õ©Ô∏è üîΩ Replica√ß√£o Cont√≠nua do Antigo para o Novo PostgreSQL com Slony üéÖüèΩ üõ£Ô∏è üëî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A replica√ß√£o nativa de streaming no PostgreSQL funciona apenas entre servidores com a mesma vers√£o principal. Falamos sobre replica√ß√£o l√≥gica em uma p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Replica√ß√£o Cont√≠nua do Antigo para o Novo PostgreSQL com Slony</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/458334/"><p><img src="https://habrastorage.org/webt/c-/eo/j8/c-eoj8fosll1jnolz9jlnmi1wrg.jpeg"></p><br><p>  A replica√ß√£o nativa de streaming no PostgreSQL funciona apenas entre servidores com a mesma vers√£o principal.  Falamos sobre replica√ß√£o l√≥gica em uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">postagem anterior</a> .  Vimos como a replica√ß√£o l√≥gica ajuda a mover dados de uma vers√£o do PostgreSQL para outra.  Mas a replica√ß√£o l√≥gica √© adequada apenas para vers√µes suportadas do PostgreSQL, por exemplo, PostgreSQL 9.4 e PostgreSQL 11. O que fazer com vers√µes anteriores √† 9.4?  Use <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Slony-I</a> . </p><br><p>  Use a replica√ß√£o com o Slony-I para transferir dados de bancos de dados antigos para a vers√£o mais recente do PostgreSQL.  O que √© o Slony e como ele funciona? </p><a name="habracut"></a><br><p>  Este √© o quarto post da nossa s√©rie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Atualizando ou migrando vers√µes antigas do PostgreSQL para novas</a> , onde aprendemos m√©todos diferentes para atualizar os bancos de dados do PostgreSQL. </p><br><h3 id="slony">  Slony </h3><br><p>  Slony √© uma implementa√ß√£o de replica√ß√£o l√≥gica em n√≠vel de aplicativo para o PostgreSQL.  Ou melhor, √© uma ferramenta de replica√ß√£o de terceiros que requer instala√ß√£o e configura√ß√£o separadas.  Slony j√° existe h√° muito tempo.  A vers√£o mais recente suporta PostgreSQL 8.4 a 11. </p><br><p>  O principal objetivo da replica√ß√£o √© transferir altera√ß√µes de um servidor de banco de dados para outro.  Para entender melhor a arquitetura, vejamos os termos: Slon, eventos e slonik. </p><br><p>  A prop√≥sito, Slony, se voc√™ ainda n√£o adivinhou, esses s√£o "elefantes".  E eles realmente t√™m uma √≥tima mem√≥ria.  N√£o √© por acaso que um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">elefante</a> rigoroso, por√©m fofo, ostenta o logotipo do PostgreSQL. </p><br><h3 id="slon">  Slon </h3><br><p>  Slon √© um daemon que √© executado em todos os n√≥s do PostgreSQL na replica√ß√£o do Slony-I.  Esses daemons s√£o usados ‚Äã‚Äãpara manipular eventos de configura√ß√£o e replica√ß√£o para cada servidor PostgreSQL.  Cada servidor PostgreSQL √© chamado de host.  Todos os n√≥s juntos formam um cluster Slony. </p><br><p>  O n√≥ do publicador √© a fonte das altera√ß√µes e o n√≥ do assinante recebe e aplica as altera√ß√µes do publicador. </p><br><p>  Para configurar a replica√ß√£o, voc√™ deve especificar todas as tabelas replicadas ou um conjunto de replica√ß√£o.  A assinatura funciona para um conjunto espec√≠fico.  As altera√ß√µes nas tabelas replicadas s√£o combinadas no SYNC, um grupo de transa√ß√µes aplicadas em conjunto nos assinantes. </p><br><h3 id="sobytiya">  Eventos </h3><br><p>  As altera√ß√µes s√£o relatadas pelo editor como eventos.  Quando um evento √© processado pelo daemon Slon no host remoto, uma confirma√ß√£o √© gerada.  E os eventos notificam os n√≥s de altera√ß√µes na configura√ß√£o, como adicionar ou remover novos n√≥s, novas assinaturas ou altera√ß√µes DDL. </p><br><p>  Cada evento possui seu pr√≥prio identificador de origem exclusivo, n√∫mero de s√©rie, identificador de transa√ß√£o para a captura instant√¢nea no n√≥ do evento, v√°rios argumentos e um registro de data e hora com um fuso hor√°rio. <br>  Os gatilhos gravados no PL / pgSQL registram todas as altera√ß√µes nas tabelas replicadas.  Infelizmente, n√£o h√° uma maneira confi√°vel de lidar com altera√ß√µes em blobs, DDLs ou altera√ß√µes em usu√°rios e fun√ß√µes. </p><br><h3 id="slonik">  slonik </h3><br><p>  Este √© um utilit√°rio de linha de comando com um analisador e int√©rprete que aceita scripts slonik - uma linguagem declarativa simples.  Ele foi projetado para superar as limita√ß√µes de uma linguagem processual.  Com a ajuda dos comandos do slonik, voc√™ pode configurar ou modificar a replica√ß√£o no Slony, e eles podem ser incorporados em scripts de shell.  Ele aceita comandos da entrada padr√£o ou de arquivos.  O exemplo abaixo mostra como o script slonik √© passado para o slonik e incorporado nos scripts shell. </p><br><p>  O script que cria a configura√ß√£o inicial para um esquema mestre-escravo simples em nosso banco de dados pgbench √© semelhante a este: </p><br><pre><code class="plaintext hljs">#!/bin/sh slonik &lt;&lt;_EOF_ cluster name = percona_pg; node 1 admin conninfo = 'dbname=pg93 host=pg93_host user=percona_pg93_user'; node 2 admin conninfo = 'dbname=pg11 host=pg11_host user=percona_pg11_user'; #-- # Creates a _$(clustername), this example, _percona_pg schema #-- init cluster ( id=1, comment = 'Legacy PG Node'); #-- # Add a list of tables being replicated to a set. #-- create set (id=1, origin=1, comment='pgbench'); set add table (set id=1, origin=1, id=1, fully qualified name = 'public.pgbench_accounts', comment='accounts'); set add table (set id=1, origin=1, id=2, fully qualified name = 'public.pgbench_branches', comment='branches'); set add table (set id=1, origin=1, id=3, fully qualified name = 'public.pgbench_tellers', comment='tellers'); set add table (set id=1, origin=1, id=4, fully qualified name = 'public.pgbench_history', comment='history'); #-- # Create the second node (the slave) tell the 2 nodes how to connect to # each other and how they should listen for events. #-- store node (id=2, comment = 'Target node', event node=1); store path (server = 1, client = 2, conninfo='dbname=pg93 host=pg93_host user=percona_pg93_user'); store path (server = 2, client = 1, conninfo='dbname=pg11 host=pg11_host user=percona_pg11_user'); _EOF_</code> </pre> <br><h3 id="pochemu-slony-udobno-ispolzovat-dlya-migraciy">  Por que o Slony √© conveniente para migra√ß√µes? </h3><br><p>  Apesar das vantagens da replica√ß√£o l√≥gica interna, para vers√µes anteriores ao PostgreSQL 9.4, voc√™ precisa usar esta solu√ß√£o de terceiros.  A abordagem baseada em acionador depende da API do banco de dados - ambas as vers√µes devem ser compat√≠veis para usar a sintaxe PL / pgSQL e SQL. </p><br><h3 id="kak-adaptirovat-bazu-dannyh-dlya-ispolzovaniya-so-slony">  Como adaptar o banco de dados para uso com o Slony? </h3><br><ul><li>  As tabelas devem ter chaves prim√°rias.  Adicione um campo serial a todas as tabelas sem uma chave prim√°ria. </li><li>  Altera√ß√µes no blob OID n√£o s√£o replicadas.  Se voc√™ tiver colunas com valores curtos, converta-as em BYTEA.  Se os objetos forem muito grandes - por exemplo, imagens - √© melhor armazenar dados em armazenamento externo (por exemplo, S3 na nuvem da Amazon).  Se a altera√ß√£o do aplicativo for muito complicada, aplique as altera√ß√µes do blob na √∫ltima etapa da migra√ß√£o. </li><li>  ALTER TABLE e outras opera√ß√µes DDL.  Slony n√£o detecta altera√ß√µes na estrutura da tabela.  Use o comando slonik EXECUTE SCRIPT para aplicar um arquivo SQL com cadeias SQL ou DDL a todo o cluster de replica√ß√£o. </li></ul><br><h3 id="onlayn-migraciya-iz-predyduschih-versiy-postgresql">  Migra√ß√£o online de vers√µes anteriores do PostgreSQL </h3><br><ol><li>  Crie um usu√°rio de replica√ß√£o com privil√©gios de superusu√°rio.  Voc√™ pode configurar os direitos em detalhes, mas √© muito mais complicado. </li><li>  Crie um banco de dados no destino com acesso TCP / IP. </li><li>  Copie as defini√ß√µes da tabela do mestre para os escravos. </li><li>  Instale o Slony-I.  Em servidores com uma vers√£o antiga do sistema operacional, ser√° mais f√°cil instalar o Slony-I a partir do c√≥digo-fonte. </li><li>  Defina o cluster, o conjunto de tabelas e as informa√ß√µes de conex√£o do n√≥ como uma lista de comandos slonik. </li><li>  Execute o daemon slon em cada servidor PostgreSQL.  Verifique os arquivos de sa√≠da ou log padr√£o quanto a erros de conex√£o. </li><li>  Execute os comandos de assinatura slonik para iniciar a sincroniza√ß√£o. </li><li>  Teste solicita√ß√µes somente leitura na nova vers√£o do Postgres. </li><li>  Quando todos os dados forem replicados e sincronizados, pare os aplicativos e encaminhe-os para o novo servidor Postgres. </li><li>  Use o n√≥ de desinstala√ß√£o na nova vers√£o do PostgreSQL para remover todos os vest√≠gios da replica√ß√£o do Slony. </li></ol><br><h3 id="perehod-na-predyduschie-versii">  Transi√ß√£o para vers√µes anteriores </h3><br><p>  Use o mesmo procedimento para atualizar para vers√µes anteriores.  Com o Slony, voc√™ pode replicar de qualquer vers√£o e para qualquer vers√£o do PosgreSQL suportada pela vers√£o do Slony.  A vers√£o m√≠nima suportada √© 8.4. </p><br><h3 id="itogi">  Sum√°rio </h3><br><p>  Vimos em termos gerais como voc√™ pode atualizar para a nova vers√£o com tempo de inatividade m√≠nimo usando o Slony.  Saiba mais em nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">webinar</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt458334/">https://habr.com/ru/post/pt458334/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt458324/index.html">Tudo o que voc√™ precisa para come√ßar a usar o Vue.js</a></li>
<li><a href="../pt458326/index.html">Yandex abre conjuntos de dados Toloka para pesquisadores</a></li>
<li><a href="../pt458328/index.html">Como duplicar metas do Yandex.Metrica no Google Analytics</a></li>
<li><a href="../pt458330/index.html">N√£o h√° limite para a perfei√ß√£o: como as interfaces neurais ajudam a humanidade</a></li>
<li><a href="../pt458332/index.html">Programa√ß√£o ass√≠ncrona - desempenho ass√≠ncrono: entenda os custos do ass√≠ncrono e aguarde</a></li>
<li><a href="../pt458336/index.html">O ciclo completo do desenvolvimento de produtos de TI usando o exemplo do projeto: fun√ß√µes da equipe, tarefas do cliente, est√°gios</a></li>
<li><a href="../pt458338/index.html">Application Security Manager. Desenvolvedor ou seguran√ßa?</a></li>
<li><a href="../pt458342/index.html">Texturiza√ß√£o ou o que voc√™ precisa saber para se tornar um Artista de Superf√≠cie. Parte 1. Pixel</a></li>
<li><a href="../pt458344/index.html">Usando mensagens ass√≠ncronas para melhorar a disponibilidade</a></li>
<li><a href="../pt458346/index.html">Solu√ß√£o de problemas com pwnable.kr 01 - fd. Descritores e processos de arquivo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>