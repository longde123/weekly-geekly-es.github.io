<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ„ â¬›ï¸ ğŸ“‡ é…ç½®æœåŠ¡å™¨ä»¥ä½¿ç”¨Ansibleéƒ¨ç½²Railsåº”ç”¨ç¨‹åº ğŸ’ ğŸ§•ğŸ» ğŸ§™ğŸ¿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¸ä¹…å‰ï¼Œæˆ‘éœ€è¦ç¼–å†™å‡ æœ¬æœ‰è¶£çš„å‰§æœ¬ï¼Œä»¥å‡†å¤‡ç”¨äºéƒ¨ç½²Railsåº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ã€‚ è€Œä¸”ï¼Œä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œæˆ‘æ²¡æœ‰æ‰¾åˆ°ç®€å•çš„åˆ†æ­¥æŒ‡å—ã€‚ æˆ‘ä¸æƒ³åœ¨ä¸äº†è§£æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…çš„æƒ…å†µä¸‹å¤åˆ¶åˆ«äººçš„å‰§æœ¬ï¼Œå› æ­¤ä¸å¾—ä¸é˜…è¯»æ–‡æ¡£ï¼Œè‡ªå·±æ”¶é›†æ‰€æœ‰å†…å®¹ã€‚ ä¹Ÿè®¸æœ‰äººå¯ä»¥é€šè¿‡æœ¬æ–‡å¸®åŠ©æ‚¨åŠ å¿«è¿™ä¸€è¿‡ç¨‹ã€‚ 


 é¦–å…ˆè¦äº†è§£çš„æ˜¯ï¼Œansibleä¸º...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>é…ç½®æœåŠ¡å™¨ä»¥ä½¿ç”¨Ansibleéƒ¨ç½²Railsåº”ç”¨ç¨‹åº</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460769/"><p> ä¸ä¹…å‰ï¼Œæˆ‘éœ€è¦ç¼–å†™å‡ æœ¬æœ‰è¶£çš„å‰§æœ¬ï¼Œä»¥å‡†å¤‡ç”¨äºéƒ¨ç½²Railsåº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ã€‚ è€Œä¸”ï¼Œä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œæˆ‘æ²¡æœ‰æ‰¾åˆ°ç®€å•çš„åˆ†æ­¥æŒ‡å—ã€‚ æˆ‘ä¸æƒ³åœ¨ä¸äº†è§£æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…çš„æƒ…å†µä¸‹å¤åˆ¶åˆ«äººçš„å‰§æœ¬ï¼Œå› æ­¤ä¸å¾—ä¸é˜…è¯»æ–‡æ¡£ï¼Œè‡ªå·±æ”¶é›†æ‰€æœ‰å†…å®¹ã€‚ ä¹Ÿè®¸æœ‰äººå¯ä»¥é€šè¿‡æœ¬æ–‡å¸®åŠ©æ‚¨åŠ å¿«è¿™ä¸€è¿‡ç¨‹ã€‚ </p><br><p> é¦–å…ˆè¦äº†è§£çš„æ˜¯ï¼Œansibleä¸ºæ‚¨æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„ç•Œé¢ï¼Œç”¨äºé€šè¿‡SSHåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œé¢„å®šä¹‰çš„æ“ä½œåˆ—è¡¨ã€‚ è¿™é‡Œæ²¡æœ‰ä¸‡èƒ½çš„æ³•å®ï¼Œæ‚¨æ— æ³•å®‰è£…æ’ä»¶ï¼Œä¹Ÿæ— æ³•æ‘†è„±é›¶å®•æœºæ—¶é—´ï¼Œä½¿ç”¨dockerï¼Œç›‘æ§å’Œå…¶ä»–å·¥å…·éƒ¨ç½²åº”ç”¨ç¨‹åºã€‚ ä¸ºäº†ç¼–å†™å‰§æœ¬ï¼Œæ‚¨å¿…é¡»ç¡®åˆ‡åœ°çŸ¥é“è‡ªå·±æƒ³åšä»€ä¹ˆä»¥åŠå¦‚ä½•åšã€‚ å› æ­¤ï¼Œæˆ‘ä¸å–œæ¬¢githubä¸Šç°æˆçš„å‰§æœ¬ï¼Œä¹Ÿä¸å–œæ¬¢ç±»ä¼¼çš„æ–‡ç« ï¼šâ€œå¤åˆ¶å¹¶è¿è¡Œï¼Œå®ƒå°†èµ·ä½œç”¨ã€‚â€ </p><a name="habracut"></a><br><h2 id="chto-nam-nuzhno"> æˆ‘ä»¬éœ€è¦ä»€ä¹ˆï¼Ÿ </h2><br><p> æ­£å¦‚æˆ‘æ‰€è¯´ï¼Œè¦ç¼–å†™ä¸€æœ¬å‰§æœ¬ï¼Œæ‚¨éœ€è¦çŸ¥é“æ‚¨æƒ³åšä»€ä¹ˆä»¥åŠå¦‚ä½•åšã€‚ è®©æˆ‘ä»¬æ¥å†³å®šæˆ‘ä»¬éœ€è¦ä»€ä¹ˆã€‚ å¯¹äºRailsåº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å°†éœ€è¦å‡ ä¸ªç³»ç»Ÿè½¯ä»¶åŒ…ï¼šnginxï¼Œpostgresqlï¼ˆredisç­‰ï¼‰ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç‰¹å®šç‰ˆæœ¬çš„çº¢å®çŸ³ã€‚ æœ€å¥½é€šè¿‡rbenvï¼ˆrvmï¼Œasdf ...ï¼‰å®‰è£…å®ƒã€‚ ä»ç”¨æˆ·çš„æ ¹ç›®å½•è¿è¡Œæ‰€æœ‰è¿™äº›æ€»æ˜¯ä¸€ä¸ªåä¸»æ„ï¼Œå› æ­¤æ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ç”¨æˆ·å¹¶ä¸ºå…¶é…ç½®æƒé™ã€‚ ä¹‹åï¼Œæ‚¨éœ€è¦å°†æˆ‘ä»¬çš„ä»£ç ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œå¤åˆ¶nginxï¼Œpostgresç­‰çš„é…ç½®å¹¶è¿è¡Œæ‰€æœ‰è¿™äº›æœåŠ¡ã€‚ </p><br><p>  <strong>ç»“æœï¼ŒåŠ¨ä½œé¡ºåºå¦‚ä¸‹ï¼š</strong> </p><br><ol><li> ä»¥rootèº«ä»½ç™»å½• </li><li> å®‰è£…ç³»ç»Ÿè½¯ä»¶åŒ… </li><li> åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œé…ç½®æƒé™ï¼Œsshå¯†é’¥ </li><li> é…ç½®ç³»ç»Ÿè½¯ä»¶åŒ…ï¼ˆnginxç­‰ï¼‰å¹¶è¿è¡Œå®ƒä»¬ </li><li> åœ¨æ•°æ®åº“ä¸­åˆ›å»ºç”¨æˆ·ï¼ˆæ‚¨å¯ä»¥ç«‹å³åˆ›å»ºæ•°æ®åº“ï¼‰ </li><li> ä»¥æ–°ç”¨æˆ·èº«ä»½ç™»å½• </li><li> å®‰è£…rbenvå’Œruby </li><li> å®‰è£…æ†ç»‘å™¨ </li><li> å¡«å†™ç”³è¯·ä»£ç  </li><li> æˆ‘ä»¬å¯åŠ¨PumaæœåŠ¡å™¨ </li></ol><br><p> æ­¤å¤–ï¼Œæœ€åçš„æ­¥éª¤å¯ä»¥ä½¿ç”¨capistranoå®Œæˆï¼Œè‡³å°‘å¥¹å¯ä»¥å°†ä»£ç ä»æ¡†ä¸­å¤åˆ¶åˆ°å‘è¡Œç›®å½•ä¸­ï¼Œåœ¨æˆåŠŸéƒ¨ç½²åä½¿ç”¨ç¬¦å·é“¾æ¥åˆ‡æ¢å‘è¡Œç‰ˆï¼Œä»å…±äº«ç›®å½•å¤åˆ¶é…ç½®ï¼Œé‡æ–°å¯åŠ¨pumaç­‰ã€‚ æ‰€æœ‰è¿™äº›éƒ½å¯ä»¥é€šè¿‡Ansibleå®Œæˆï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ </p><br><h2 id="faylovaya-struktura"> æ¡£æ¡ˆç»“æ„ </h2><br><p>  Ansibleçš„æ‰€æœ‰<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ä»¶</a>éƒ½æœ‰ä¸¥æ ¼çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ä»¶ç»“æ„</a> ï¼Œå› æ­¤æœ€å¥½å°†æ‰€æœ‰è¿™äº›æ–‡ä»¶ä¿å­˜åœ¨å•ç‹¬çš„ç›®å½•ä¸­ã€‚ è€Œä¸”å®ƒæ˜¯å¦å°†åœ¨railsåº”ç”¨ç¨‹åºæœ¬èº«ä¸­è¿˜æ˜¯å•ç‹¬å‡ºç°å¹¶ä¸é‡è¦ã€‚ æ‚¨å¯ä»¥å°†æ–‡ä»¶å­˜å‚¨åœ¨å•ç‹¬çš„gitå­˜å‚¨åº“ä¸­ã€‚ å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæœ€æ–¹ä¾¿çš„æ˜¯åœ¨åº”ç”¨ç¨‹åºçš„railsç›®å½•çš„/ configä¸­åˆ›å»ºansibleç›®å½•å¹¶å°†æ‰€æœ‰å†…å®¹å­˜å‚¨åœ¨ä¸€ä¸ªå­˜å‚¨åº“ä¸­ã€‚ </p><br><h3 id="simple-playbook"> ç®€å•çš„å‰§æœ¬ </h3><br><p>  Playbookæ˜¯ymlæ–‡ä»¶ï¼Œæè¿°äº†ä½¿ç”¨ç‰¹æ®Šè¯­æ³•ansibleåº”è¯¥åšä»€ä¹ˆä»¥åŠå¦‚ä½•åšã€‚ è®©æˆ‘ä»¬åˆ›å»ºç¬¬ä¸€ä¸ªä»€ä¹ˆéƒ½ä¸åšçš„å‰§æœ¬ï¼š </p><br><pre><code class="plaintext hljs">--- - name: Simple playbook hosts: all</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åªæ˜¯è¯´æˆ‘ä»¬çš„å‰§æœ¬ç§°ä¸º<code>Simple Playbook</code>å‰§æœ¬ï¼Œå…¶å†…å®¹åº”åœ¨æ‰€æœ‰ä¸»æœºä¸Šè¿è¡Œã€‚ æˆ‘ä»¬å¯ä»¥å°†å…¶ä¿å­˜åœ¨åç§°ä¸º<code>playbook.yml</code>çš„/ ansibleç›®å½•ä¸­ï¼Œç„¶åå°è¯•è¿è¡Œï¼š </p><br><pre> <code class="plaintext hljs">ansible-playbook ./playbook.yml PLAY [Simple Playbook] ************************************************************************************************************************************ skipping: no hosts matched</code> </pre> <br><p>  Ansibleè¯´ï¼Œå®ƒä¸çŸ¥é“ä¸æ‰€æœ‰åˆ—è¡¨åŒ¹é…çš„ä¸»æœºã€‚ å®ƒä»¬å¿…é¡»åœ¨ç‰¹æ®Šçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¸…å•æ–‡ä»¶ä¸­</a>åˆ—å‡ºã€‚ </p><br><p> è®©æˆ‘ä»¬åœ¨åŒä¸€ä¸ªansibleç›®å½•ä¸­åˆ›å»ºå®ƒï¼š </p><br><pre> <code class="plaintext hljs">123.123.123.123</code> </pre> <br><p> å› æ­¤ï¼Œåªéœ€æŒ‡å®šä¸»æœºï¼ˆç†æƒ³æƒ…å†µä¸‹ï¼Œæ˜¯ç”¨äºæµ‹è¯•çš„VPSä¸»æœºï¼Œæˆ–è€…æ‚¨å¯ä»¥æ³¨å†Œlocalhostï¼‰ï¼Œç„¶åå°†å…¶ä¿å­˜ä¸º<code>inventory</code> ã€‚ <br> æ‚¨å¯ä»¥å°è¯•ä½¿ç”¨invetoryæ–‡ä»¶è¿è¡Œansibleï¼š </p><br><pre> <code class="plaintext hljs">ansible-playbook ./playbook.yml -i inventory PLAY [Simple Playbook] ************************************************************************************************************************************ TASK [Gathering Facts] ************************************************************************************************************************************ PLAY RECAP ************************************************************************************************************************************</code> </pre> <br><p> å¦‚æœæ‚¨å…·æœ‰å¯¹æŒ‡å®šä¸»æœºçš„sshè®¿é—®æƒé™ï¼Œåˆ™ansibleå°†è¿æ¥å¹¶æ”¶é›†æœ‰å…³è¿œç¨‹ç³»ç»Ÿçš„ä¿¡æ¯ã€‚  ï¼ˆé»˜è®¤ä»»åŠ¡[æ”¶é›†äº‹å®]ï¼‰ï¼Œç„¶åå°†æä¾›ç®€çŸ­çš„è¿›åº¦æŠ¥å‘Šï¼ˆPLAY RECAPï¼‰ã€‚ </p><br><p> é»˜è®¤æƒ…å†µä¸‹ï¼Œå°†ä½¿ç”¨æ‚¨ç”¨æ¥ç™»å½•ç³»ç»Ÿçš„ç”¨æˆ·åè¿›è¡Œè¿æ¥ã€‚ å®ƒå¾ˆå¯èƒ½ä¸åœ¨ä¸»æœºä¸Šã€‚ åœ¨å‰§æœ¬æ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨remote_useræŒ‡ä»¤æŒ‡å®šç”¨äºè¿æ¥çš„ç”¨æˆ·ã€‚ æ­¤å¤–ï¼Œå…³äºè¿œç¨‹ç³»ç»Ÿçš„ä¿¡æ¯é€šå¸¸å¯¹äºæ‚¨æ¥è¯´æ˜¯ä¸å¿…è¦çš„ï¼Œå¹¶ä¸”æ‚¨ä¸åº”æµªè´¹æ—¶é—´æ¥æ”¶é›†å®ƒã€‚ æ‚¨ä¹Ÿå¯ä»¥å…³é—­æ­¤ä»»åŠ¡ï¼š </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root become: true gather_facts: no</code> </pre> <br><p> å°è¯•å†æ¬¡è¿è¡Œè¯¥å‰§æœ¬ï¼Œå¹¶ç¡®ä¿è¿æ¥æ­£å¸¸ã€‚  ï¼ˆå¦‚æœæŒ‡å®šäº†ç”¨æˆ·çš„æ ¹ï¼Œåˆ™è¿˜å¿…é¡»æŒ‡å®šturnï¼štrueæŒ‡ä»¤ä»¥è·å–æå‡çš„æƒé™ã€‚å¦‚æ–‡æ¡£æ‰€è¿°ï¼š <code>become set to 'true'/'yes' to activate privilege escalation.</code>å°½ç®¡ä¸æ¸…æ¥šåŸå› ï¼‰ ã€‚ </p><br><p> å¯èƒ½æ˜¯ç”±äºpythonè§£é‡Šå™¨æ— æ³•ç¡®å®šçš„ansibleå¯¼è‡´é”™è¯¯ï¼Œç„¶åå¯ä»¥æ‰‹åŠ¨æŒ‡å®šå®ƒï¼š </p><br><pre> <code class="plaintext hljs">ansible_python_interpreter: /usr/bin/python3</code> </pre> <br><p> å¯ä»¥åœ¨<code>whereis python</code>å‘½ä»¤ä¸­æ‰¾åˆ°pythonæ‰€åœ¨çš„ä½ç½®ã€‚ </p><br><h3 id="ustanovka-sistemnyh-paketov"> å®‰è£…ç³»ç»Ÿè½¯ä»¶åŒ… </h3><br><p>  Ansibleéšé™„è®¸å¤šç”¨äºå¤„ç†å„ç§ç³»ç»Ÿè½¯ä»¶åŒ…çš„æ¨¡å—ï¼Œå› æ­¤æˆ‘ä»¬æ— éœ€å‡ºäºä»»ä½•åŸå› ç¼–å†™bashè„šæœ¬ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦è¿™äº›æ¨¡å—ä¹‹ä¸€æ¥æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…ç³»ç»Ÿè½¯ä»¶åŒ…ã€‚ æˆ‘åˆ†åˆ«åœ¨VPSä¸Šå®‰è£…äº†Ubuntu Linuxæ¥å®‰è£…è½¯ä»¶åŒ…ï¼Œä¸ºæ­¤æˆ‘ä½¿ç”¨äº†<code>apt-get</code>å’Œä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¨¡å—</a> ã€‚ å¦‚æœæ‚¨ä½¿ç”¨ä¸åŒçš„æ“ä½œç³»ç»Ÿï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½éœ€è¦ä¸€ä¸ªä¸åŒçš„æ¨¡å—ï¼ˆè¯·è®°ä½ï¼Œæˆ‘åœ¨ä¸€å¼€å§‹å°±è¯´è¿‡ï¼Œæˆ‘ä»¬éœ€è¦äº‹å…ˆçŸ¥é“æˆ‘ä»¬å°†åšä»€ä¹ˆä»¥åŠå¦‚ä½•åšï¼‰ã€‚ ä½†æ˜¯ï¼Œè¯­æ³•å¯èƒ½ç›¸ä¼¼ã€‚ </p><br><p> æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹é¦–è¦ä»»åŠ¡æ¥è¡¥å……å‰§æœ¬ï¼š </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root become: true gather_facts: no tasks: - name: Update system apt: update_cache=yes - name: Install system dependencies apt: name: git,nginx,redis,postgresql,postgresql-contrib state: present</code> </pre> <br><p> ä»»åŠ¡åªæ˜¯ansibleå°†åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„ä»»åŠ¡ã€‚ æˆ‘ä»¬ç»™ä»»åŠ¡èµ·ä¸€ä¸ªåç§°ï¼Œä»¥åœ¨æ—¥å¿—ä¸­è·Ÿè¸ªå…¶è¿›åº¦ã€‚ ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ç‰¹å®šæ¨¡å—çš„è¯­æ³•æè¿°å…¶éœ€è¦æ‰§è¡Œçš„æ“ä½œã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ <code>apt: update_cache=yes</code>è¡¨ç¤ºä½¿ç”¨aptæ¨¡å—æ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…ã€‚ ç¬¬äºŒé˜Ÿè¦å¤æ‚ä¸€äº›ã€‚ æˆ‘ä»¬å°†è½¯ä»¶åŒ…åˆ—è¡¨ä¼ é€’ç»™aptæ¨¡å—ï¼Œå¹¶è¯´å®ƒä»¬çš„<code>state</code>åº”è¯¥<code>present</code> ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¦å®‰è£…è¿™äº›è½¯ä»¶åŒ…ã€‚ åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ›´æ”¹<code>state</code>æ¥å‘Šè¯‰å®ƒä»¬åˆ é™¤æˆ–æ›´æ–°ã€‚ è¯·æ³¨æ„ï¼Œè¦ä½¿railsä¸postgresqlä¸€èµ·ä½¿ç”¨ï¼Œæˆ‘ä»¬éœ€è¦å½“å‰æ­£åœ¨å®‰è£…çš„postgresql-contribè½¯ä»¶åŒ…ã€‚ å†æ¬¡éœ€è¦çŸ¥é“å¹¶å®Œæˆï¼Œansibleæœ¬èº«ä¸ä¼šè¿™æ ·åšã€‚ </p><br><p> å°è¯•å†æ¬¡è¿è¡Œè¯¥å‰§æœ¬ï¼Œå¹¶ç¡®è®¤å·²å®‰è£…è½¯ä»¶åŒ…ã€‚ </p><br><h3 id="sozdanie-novyh-polzovateley"> åˆ›å»ºæ–°ç”¨æˆ·ã€‚ </h3><br><p> ä¸ºäº†ä¸ç”¨æˆ·åˆä½œï¼ŒAnsibleä¹Ÿæœ‰ä¸€ä¸ªæ¨¡å—-ç”¨æˆ·ã€‚ æ·»åŠ å¦ä¸€ä¸ªä»»åŠ¡ï¼ˆæˆ‘å°†å‰§æœ¬çš„å·²çŸ¥éƒ¨åˆ†éšè—åœ¨æ³¨é‡Šçš„åé¢ï¼Œä»¥å…æ¯æ¬¡éƒ½å®Œå…¨å¤åˆ¶å®ƒï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Add a new user user: name: my_user shell: /bin/bash password: "{{ 123qweasd | password_hash('sha512') }}"</code> </pre> <br><p> æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œä¸ºä»–è®¾ç½®schellå’Œå¯†ç ã€‚ ç„¶åæˆ‘ä»¬é¢ä¸´å‡ ä¸ªé—®é¢˜ã€‚ å¦‚æœä¸åŒä¸»æœºçš„ç”¨æˆ·åå¿…é¡»ä¸åŒæ€ä¹ˆåŠï¼Ÿ æ˜¯çš„ï¼Œåœ¨å‰§æœ¬ä¸­ä¿æŒå¯†ç å¼€æ”¾æ˜¯ä¸€ä¸ªéå¸¸ç³Ÿç³•çš„ä¸»æ„ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å°†ç”¨æˆ·åå’Œå¯†ç æ”¾å…¥å˜é‡ä¸­ï¼Œåœ¨æœ¬æ–‡ç»“å°¾å¤„ï¼Œæˆ‘å°†å±•ç¤ºå¦‚ä½•åŠ å¯†å¯†ç ã€‚ </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}"</code> </pre> <br><p> åœ¨å‰§æœ¬ä¸­ä½¿ç”¨åŒå¤§æ‹¬å·è®¾ç½®å˜é‡ã€‚ </p><br><p> æˆ‘ä»¬å°†åœ¨æ¸…å•æ–‡ä»¶ä¸­æŒ‡ç¤ºå˜é‡çš„å€¼ï¼š </p><br><pre> <code class="plaintext hljs">123.123.123.123 [all:vars] user=my_user user_password=123qweasd</code> </pre> <br><p> æ³¨æ„æŒ‡ä»¤<code>[all:vars]</code> -å®ƒè¡¨ç¤ºä¸‹ä¸€ä¸ªæ–‡æœ¬å—æ˜¯å˜é‡ï¼ˆvarsï¼‰ï¼Œå®ƒä»¬é€‚ç”¨äºæ‰€æœ‰ä¸»æœºï¼ˆå…¨éƒ¨ï¼‰ã€‚ </p><br><p>  <code>"{{ user_password | password_hash('sha512') }}"</code>ä¹Ÿå¾ˆæœ‰è¶£ã€‚ äº‹å®æ˜¯ï¼Œ <code>user_add</code>åƒæ‚¨æ‰‹åŠ¨è®¾ç½®çš„é‚£æ ·é€šè¿‡<code>user_add</code>è®¾ç½®ç”¨æˆ·ã€‚ å¹¶ä¸”å®ƒç›´æ¥ä¿å­˜æ‰€æœ‰æ•°æ®ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜å¿…é¡»äº‹å…ˆå°†å¯†ç è½¬æ¢ä¸ºå“ˆå¸Œï¼ˆæ­¤å‘½ä»¤ä¼šè¿™æ ·åšï¼‰çš„åŸå› ã€‚ </p><br><p> è®©æˆ‘ä»¬å°†ç”¨æˆ·æ·»åŠ åˆ°sudoç»„ã€‚ ä½†æ˜¯ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæ‚¨éœ€è¦ç¡®ä¿å­˜åœ¨è¿™æ ·çš„ç»„ï¼Œå› ä¸ºæ²¡æœ‰äººä¼šä¸ºæˆ‘ä»¬è¿™æ ·åšï¼š </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo"</code> </pre> <br><p> è¿™å¾ˆç®€å•ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªç”¨äºåˆ›å»ºç»„çš„ç»„æ¨¡å—ï¼Œå…¶è¯­æ³•ä¸aptéå¸¸ç›¸ä¼¼ã€‚ ç„¶åï¼Œå°†è¿™ä¸ªç»„æ³¨å†Œç»™ç”¨æˆ·å°±è¶³å¤Ÿäº†ï¼ˆ <code>groups: "sudo"</code> ï¼‰ã€‚ <br> å‘è¯¥ç”¨æˆ·æ·»åŠ sshå¯†é’¥ä¹Ÿå¾ˆæœ‰ç”¨ï¼Œä»¥ä¾¿æˆ‘ä»¬æ— éœ€å¯†ç å³å¯åœ¨å…¶ä¸‹ç™»å½•ï¼š </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo" - name: Deploy SSH Key authorized_key: user: "{{ user }}" key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}" state: present</code> </pre> <br><p> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ„é€ <code>"{{ lookup('file', '~/.ssh/id_rsa.pub') }}"</code>å¾ˆæœ‰è¶£-å®ƒå¤åˆ¶äº†id_rsa.pubæ–‡ä»¶çš„å†…å®¹ï¼ˆæ‚¨çš„åç§°å¯èƒ½æœ‰æ‰€ä¸åŒï¼‰ï¼Œå³sshå¯†é’¥çš„å…¬å…±éƒ¨åˆ†å¹¶å°†å…¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Šç”¨æˆ·çš„æˆæƒå¯†é’¥åˆ—è¡¨ä¸­ã€‚ </p><br><h3 id="roli"> çš„è§’è‰² </h3><br><p> å¯ä»¥è½»æ¾å°†æ‰€æœ‰ä¸‰ä¸ªåˆ›å»ºä»»åŠ¡ç”¨ä½œä¸€ä¸ªä»»åŠ¡ç»„ï¼Œå¹¶ä¸”æœ€å¥½å°†è¯¥ç»„ä¸ä¸»è¦å·¥ä½œæ‰‹å†Œåˆ†å¼€ï¼Œä»¥å…å…¶å¢é•¿å¤ªå¤šã€‚ è¿™åœ¨ansibleä¸­æœ‰<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½œç”¨</a> ã€‚ <br> æ ¹æ®å¼€å§‹æ—¶æŒ‡ç¤ºçš„æ–‡ä»¶ç»“æ„ï¼Œå¿…é¡»å°†è§’è‰²æ”¾ç½®åœ¨å•ç‹¬çš„è§’è‰²ç›®å½•ä¸­ï¼Œå¯¹äºæ¯ä¸ªè§’è‰²-åœ¨ä»»åŠ¡ï¼Œæ–‡ä»¶ï¼Œæ¨¡æ¿ç­‰ç›®å½•ä¸­ï¼Œå…·æœ‰ç›¸åŒåç§°çš„å•ç‹¬ç›®å½• <br> è®©æˆ‘ä»¬åˆ›å»ºæ–‡ä»¶ç»“æ„ï¼š <code>./ansible/roles/user/tasks/main.yml</code> ï¼ˆmainæ˜¯å°†è§’è‰²è¿æ¥åˆ°å‰§æœ¬æ—¶å°†åŠ è½½å¹¶æ‰§è¡Œçš„ä¸»æ–‡ä»¶ï¼Œå¯ä»¥åœ¨å…¶ä¸­è¿æ¥å…¶ä»–è§’è‰²æ–‡ä»¶ï¼‰ã€‚ ç°åœ¨ï¼Œæ‚¨å¯ä»¥å°†ä¸ç”¨æˆ·ç›¸å…³çš„æ‰€æœ‰ä»»åŠ¡ä¼ è¾“åˆ°è¯¥æ–‡ä»¶ï¼š </p><br><pre> <code class="plaintext hljs"># Create user and add him to groups - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo" - name: Deploy SSH Key authorized_key: user: "{{ user }}" key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}" state: present</code> </pre> <br><p> åœ¨ä¸»æ‰‹å†Œä¸­ï¼Œæ‚¨å¿…é¡»æŒ‡å®šä½¿ç”¨ç”¨æˆ·è§’è‰²ï¼š </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root gather_facts: no tasks: - name: Update system apt: update_cache=yes - name: Install system dependencies apt: name: git,nginx,redis,postgresql,postgresql-contrib state: present roles: - user</code> </pre> <br><p> å¦å¤–ï¼Œåœ¨æ‰€æœ‰å…¶ä»–ä»»åŠ¡ä¹‹å‰æ‰§è¡Œç³»ç»Ÿæ›´æ–°å¯èƒ½å¾ˆæœ‰æ„ä¹‰ï¼Œä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥é‡å‘½ååœ¨<code>pre_tasks</code>ä¸­å®šä¹‰äº†å®ƒä»¬çš„<code>tasks</code>å—ã€‚ </p><br><h3 id="nastroyka-nginx">  Nginxè®¾ç½® </h3><br><p>  Nginxåº”è¯¥å·²ç»ä¸æˆ‘ä»¬ä¸€èµ·å®‰è£…ï¼Œæ‚¨éœ€è¦å¯¹å…¶è¿›è¡Œé…ç½®å’Œè¿è¡Œã€‚ è®©æˆ‘ä»¬é©¬ä¸Šå°±æ‰®æ¼”è§’è‰²å§ã€‚ åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç»“æ„ï¼š </p><br><pre> <code class="plaintext hljs">- ansible - roles - nginx - files - tasks - main.yml - templates</code> </pre> <br><p> ç°åœ¨æˆ‘ä»¬éœ€è¦æ–‡ä»¶å’Œæ¨¡æ¿ã€‚ ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«åœ¨äºï¼Œansibleæ–‡ä»¶æ˜¯æŒ‰åŸæ ·ç›´æ¥å¤åˆ¶çš„ã€‚ å¹¶ä¸”æ¨¡æ¿åº”å…·æœ‰æ‰©å±•åj2ï¼Œå¹¶ä¸”å®ƒä»¬å¯ä»¥ä½¿ç”¨ç›¸åŒçš„åŒå¤§æ‹¬å·æ¥ä½¿ç”¨å˜é‡çš„å€¼ã€‚ </p><br><p> è®©æˆ‘ä»¬åœ¨<code>main.yml</code>æ–‡ä»¶ä¸­åŒ…å«nginxã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªsystemdæ¨¡å—ï¼š </p><br><pre> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes</code> </pre> <br><p> åœ¨è¿™é‡Œæˆ‘ä»¬ä¸ä»…è¯´åº”è¯¥å¯åŠ¨nginxï¼ˆå³è¿è¡Œå®ƒï¼‰ï¼Œè€Œä¸”ç«‹å³è¯´å¿…é¡»å°†å…¶å¯ç”¨ã€‚ <br> ç°åœ¨å¤åˆ¶é…ç½®æ–‡ä»¶ï¼š </p><br><pre> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes - name: Copy the nginx.conf copy: src: nginx.conf dest: /etc/nginx/nginx.conf owner: root group: root mode: '0644' backup: yes - name: Copy template my_app.conf template: src: my_app_conf.j2 dest: /etc/nginx/sites-available/my_app.conf owner: root group: root mode: '0644'</code> </pre> <br><p> æˆ‘ä»¬åˆ›å»ºä¸»è¦çš„nginxé…ç½®æ–‡ä»¶ï¼ˆæ‚¨å¯ä»¥ç›´æ¥ä»æœåŠ¡å™¨è·å–å®ƒï¼Œä¹Ÿå¯ä»¥è‡ªå·±ç¼–å†™ï¼‰ã€‚ ä»¥åŠä½äºsites_availableç›®å½•ä¸­çš„åº”ç”¨ç¨‹åºçš„é…ç½®æ–‡ä»¶ï¼ˆè¿™ä¸æ˜¯å¿…éœ€çš„ï¼Œä½†å¾ˆæœ‰ç”¨ï¼‰ã€‚ åœ¨ç¬¬ä¸€ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨å¤åˆ¶æ¨¡å—æ¥å¤åˆ¶æ–‡ä»¶ï¼ˆè¯¥æ–‡ä»¶å¿…é¡»åœ¨<code>/ansible/roles/nginx/files/nginx.conf</code> ï¼‰ã€‚ åœ¨ç¬¬äºŒä¸ªæ­¥éª¤ä¸­-å¤åˆ¶æ¨¡æ¿ï¼Œæ›¿æ¢å˜é‡çš„å€¼ã€‚ æ¨¡æ¿åº”ä½äº<code>/ansible/roles/nginx/templates/my_app.j2</code> ï¼‰ã€‚ å®ƒå¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><pre> <code class="plaintext hljs">upstream {{ app_name }} { server unix:{{ app_path }}/shared/tmp/sockets/puma.sock; } server { listen 80; server_name {{ server_name }} {{ inventory_hostname }}; root {{ app_path }}/current/public; try_files $uri/index.html $uri.html $uri @{{ app_name }}; .... }</code> </pre> <br><p> æ³¨æ„æ’å…¥<code>{{ app_name }}</code> ï¼Œ <code>{{ app_path }}</code> ï¼Œ <code>{{ server_name }}</code> ï¼Œ <code>{{ inventory_hostname }}</code> -è¿™äº›éƒ½æ˜¯å˜é‡ï¼Œå…¶å€¼ansibleå°†åœ¨å¤åˆ¶å‰æ›¿æ¢ä¸ºæ¨¡æ¿ã€‚ å¦‚æœæ‚¨å°†å‰§æœ¬ç”¨äºä¸åŒçš„ä¸»æœºç»„ï¼Œè¿™å°†å¾ˆæœ‰ç”¨ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥è¡¥å……åº“å­˜æ–‡ä»¶ï¼š </p><br><pre> <code class="plaintext hljs">[production] 123.123.123.123 [staging] 231.231.231.231 [all:vars] user=my_user user_password=123qweasd [production:vars] server_name=production app_path=/home/www/my_app app_name=my_app [staging:vars] server_name=staging app_path=/home/www/my_stage app_name=my_stage_app</code> </pre> <br><p> å¦‚æœæˆ‘ä»¬ç°åœ¨è¿è¡Œæˆ‘ä»¬çš„å‰§æœ¬ï¼Œå®ƒå°†ä¸ºä¸¤ä¸ªä¸»æœºæ‰§è¡ŒæŒ‡å®šçš„ä»»åŠ¡ã€‚ ä½†æ˜¯åŒæ—¶ï¼Œå¯¹äºç™»å°ä¸»æœºï¼Œå˜é‡å°†ä¸ç”Ÿäº§ç‰ˆæœ¬ä¸åŒï¼Œä¸ä»…åœ¨è§’è‰²å’Œå‰§æœ¬ä¸­ï¼Œè€Œä¸”åœ¨nginxé…ç½®ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ã€‚  <code>{{ inventory_hostname }}</code>ä¸éœ€è¦åœ¨æ¸…å•æ–‡ä»¶ä¸­æŒ‡å®š-è¿™æ˜¯ä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç‰¹æ®Šçš„å˜é‡ansible</a> ï¼Œå½“å‰æ­£åœ¨è¿è¡Œå…¶å‰§æœ¬çš„ä¸»æœºå­˜å‚¨åœ¨å…¶ä¸­ã€‚ <br> å¦‚æœè¦ä¸ºå¤šä¸ªä¸»æœºæä¾›æ¸…å•æ–‡ä»¶ï¼Œå¹¶ä¸”ä»…å¯¹ä¸€ä¸ªç»„è¿è¡Œï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®Œæˆæ­¤æ“ä½œï¼š </p><br><pre> <code class="plaintext hljs">ansible-playbook -i inventory ./playbook.yml -l "staging"</code> </pre> <br><p> å¦ä¸€ç§é€‰æ‹©æ˜¯ä¸ºä¸åŒçš„ç»„ä½¿ç”¨å•ç‹¬çš„æ¸…å•æ–‡ä»¶ã€‚ æˆ–è€…ï¼Œå¦‚æœæ‚¨æœ‰è®¸å¤šä¸åŒçš„ä¸»æœºï¼Œåˆ™å¯ä»¥ç»„åˆä½¿ç”¨ä¸¤ç§æ–¹æ³•ã€‚ </p><br><p> è®©æˆ‘ä»¬å›åˆ°é…ç½®nginxã€‚ å¤åˆ¶é…ç½®æ–‡ä»¶åï¼Œæˆ‘ä»¬éœ€è¦ä»sites_availableåœ¨my_app.confä¸Šçš„sitest_enabledä¸­åˆ›å»ºç¬¦å·é“¾æ¥ã€‚ å¹¶é‡æ–°å¯åŠ¨nginxã€‚ </p><br><pre> <code class="plaintext hljs">... # old code in mail.yml - name: Create symlink to sites-enabled file: src: /etc/nginx/sites-available/my_app.conf dest: /etc/nginx/sites-enabled/my_app.conf state: link - name: restart nginx service: name: nginx state: restarted</code> </pre> <br><p> è¿™é‡Œçš„ä¸€åˆ‡éƒ½å¾ˆç®€å•-åŒæ ·ï¼Œå…·æœ‰ç›¸å½“æ ‡å‡†è¯­æ³•çš„ansibleæ¨¡å—ã€‚ ä½†æ˜¯æœ‰ä¸€ç‚¹ã€‚ æ¯æ¬¡é‡æ–°å¯åŠ¨nginxæ²¡æœ‰æ„ä¹‰ã€‚ æ‚¨æ³¨æ„åˆ°æˆ‘ä»¬æ²¡æœ‰ç¼–å†™ä»¥ä¸‹å½¢å¼çš„å‘½ä»¤ï¼šâ€œåƒè¿™æ ·åšâ€ï¼Œè¯­æ³•çœ‹èµ·æ¥æ›´åƒâ€œè¿™åº”è¯¥å…·æœ‰è¿™ç§çŠ¶æ€â€ã€‚ æœ€å¸¸è§çš„æ˜¯è¿™æ˜¯ansibleçš„å·¥ä½œæ–¹å¼ã€‚ å¦‚æœè¯¥ç»„å·²ç»å­˜åœ¨æˆ–ç³»ç»Ÿè½¯ä»¶åŒ…å·²å®‰è£…ï¼Œåˆ™ansibleå°†å¯¹å…¶è¿›è¡Œæ£€æŸ¥å¹¶è·³è¿‡ä»»åŠ¡ã€‚ å¦å¤–ï¼Œå¦‚æœæ–‡ä»¶ä¸æœåŠ¡å™¨ä¸Šå·²æœ‰çš„æ–‡ä»¶å®Œå…¨ä¸€è‡´ï¼Œåˆ™å°†ä¸ä¼šå¤åˆ¶æ–‡ä»¶ã€‚ æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œä»…åœ¨æ›´æ”¹äº†é…ç½®æ–‡ä»¶åé‡æ–°å¯åŠ¨nginxã€‚ ä¸ºæ­¤æœ‰ä¸€ä¸ªå¯„å­˜å™¨æŒ‡ä»¤ï¼š </p><br><pre> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes - name: Copy the nginx.conf copy: src: nginx.conf dest: /etc/nginx/nginx.conf owner: root group: root mode: '0644' backup: yes register: restart_nginx - name: Copy template my_app.conf template: src: my_app_conf.j2 dest: /etc/nginx/sites-available/my_app.conf owner: root group: root mode: '0644' register: restart_nginx - name: Create symlink to sites-enabled file: src: /etc/nginx/sites-available/my_app.conf dest: /etc/nginx/sites-enabled/my_app.conf state: link - name: restart nginx service: name: nginx state: restarted when: restart_nginx.changed</code> </pre> <br><p> å¦‚æœå…¶ä¸­ä¸€ä¸ªé…ç½®æ–‡ä»¶å‘ç”Ÿæ›´æ”¹ï¼Œåˆ™å°†æ‰§è¡Œå¤åˆ¶ï¼Œå¹¶ä¼šæ³¨å†Œå˜é‡<code>restart_nginx</code> ã€‚ å¹¶ä¸”åªæœ‰åœ¨å·²æ³¨å†Œæ­¤å˜é‡çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡æ‰ä¼šé‡æ–°å¯åŠ¨ã€‚ </p><br><p> å¥½å§ï¼Œå½“ç„¶ï¼Œæ‚¨éœ€è¦å°†nginxè§’è‰²æ·»åŠ åˆ°ä¸»è¦å‰§æœ¬ä¸­ã€‚ </p><br><h3 id="nastroyka-postgresql">  PostgreSQLè®¾ç½® </h3><br><p> å°±åƒæˆ‘ä»¬ä½¿ç”¨nginxä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨systemdå¯ç”¨postgresqlï¼Œè¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¯¥ç”¨æˆ·æ¥è®¿é—®æ•°æ®åº“å’Œæ•°æ®åº“æœ¬èº«ã€‚ <br> åˆ›å»ºè§’è‰²<code>/ansible/roles/postgresql/tasks/main.yml</code> ï¼š </p><br><pre> <code class="plaintext hljs"># Create user in postgresql - name: enable postgresql and start systemd: name: postgresql state: started enabled: yes - name: Create database user become_user: postgres postgresql_user: name: "{{ db_user }}" password: "{{ db_password }}" role_attr_flags: SUPERUSER - name: Create database become_user: postgres postgresql_db: name: "{{ db_name }}" encoding: UTF-8 owner: "{{ db_user }}"</code> </pre> <br><p> æˆ‘ä¸ä¼šæè¿°å¦‚ä½•å‘æ¸…å•æ·»åŠ å˜é‡ï¼Œè¿™å·²ç»åšè¿‡å¾ˆå¤šæ¬¡äº†ï¼Œä»¥åŠpostgresql_dbå’Œpostgresql_useræ¨¡å—çš„è¯­æ³•ã€‚ å¯ä»¥åœ¨æ–‡æ¡£ä¸­æ‰¾åˆ°æ›´å¤šæ•°æ®ã€‚ æŒ‡ä»¤<code>become_user: postgres</code>æœ€æœ‰è¶£ã€‚ äº‹å®æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰postgresç”¨æˆ·å¯ä»¥è®¿é—®postgresqlæ•°æ®åº“ï¼Œå¹¶ä¸”åªèƒ½åœ¨æœ¬åœ°è®¿é—®ã€‚ è¯¥æŒ‡ä»¤å…è®¸æˆ‘ä»¬ä»£è¡¨è¯¥ç”¨æˆ·æ‰§è¡Œå‘½ä»¤ï¼ˆå½“ç„¶ï¼Œé™¤éæˆ‘ä»¬æœ‰æƒè®¿é—®ï¼‰ã€‚ <br> å¦å¤–ï¼Œæ‚¨å¯èƒ½å¿…é¡»åœ¨pg_hba.confä¸­æ·»åŠ ä¸€è¡Œä»¥ä¸ºæ–°ç”¨æˆ·æ‰“å¼€å¯¹æ•°æ®åº“çš„è®¿é—®ã€‚ å¯ä»¥é€šè¿‡æ›´æ”¹nginxé…ç½®çš„ç›¸åŒæ–¹æ³•æ¥å®Œæˆã€‚ </p><br><p> å½“ç„¶ï¼Œæ‚¨éœ€è¦åœ¨ä¸»è¦æ‰‹å†Œä¸­æ·»åŠ postgresqlçš„è§’è‰²ã€‚ </p><br><h3 id="ustanovka-ruby-cherez-rbenv"> é€šè¿‡rbenvå®‰è£…ruby </h3><br><p>  Ansibleæ²¡æœ‰ç”¨äºrbenvçš„æ¨¡å—ï¼Œä½†æ˜¯é€šè¿‡å…‹éš†gitå­˜å‚¨åº“è¿›è¡Œå®‰è£…ã€‚ å› æ­¤ï¼Œæ­¤ä»»åŠ¡æˆä¸ºæœ€ä¸æ ‡å‡†çš„ã€‚ è®©æˆ‘ä»¬ä¸ºå¥¹åˆ›å»ºè§’è‰²<code>/ansible/roles/ruby_rbenv/main.yml</code>å¹¶å¼€å§‹å¡«å……å®ƒï¼š </p><br><pre> <code class="plaintext hljs"># Install rbenv and ruby - name: Install rbenv become_user: "{{ user }}" git: repo=https://github.com/rbenv/rbenv.git dest=~/.rbenv</code> </pre> <br><p> æˆ‘ä»¬å†æ¬¡ä½¿ç”¨begin_useræŒ‡ä»¤åœ¨ä¸ºæ­¤ç›®çš„è€Œåˆ›å»ºçš„ç”¨æˆ·ä¸‹å·¥ä½œã€‚ ç”±äºrbenvå®‰è£…åœ¨å…¶ä¸»ç›®å½•ä¸­ï¼Œè€Œä¸æ˜¯å…¨å±€ã€‚ æˆ‘ä»¬è¿˜ä½¿ç”¨gitæ¨¡å—é€šè¿‡æŒ‡å®šrepoå’Œdestæ¥å…‹éš†å­˜å‚¨åº“ã€‚ </p><br><p> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨bashrcä¸­æ³¨å†Œrbenv initå¹¶å°†rbenvæ·»åŠ åˆ°åŒä¸€ä½ç½®çš„PATHä¸­ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬æœ‰lineinfileæ¨¡å—ï¼š </p><br><pre> <code class="plaintext hljs">- name: Add rbenv to PATH become_user: "{{ user }}" lineinfile: path: ~/.bashrc state: present line: 'export PATH="${HOME}/.rbenv/bin:${PATH}"' - name: Add rbenv init to bashrc become_user: "{{ user }}" lineinfile: path: ~/.bashrc state: present line: 'eval "$(rbenv init -)"'</code> </pre> <br><p> ç„¶åå®‰è£…ruby_buildï¼š </p><br><pre> <code class="plaintext hljs">- name: Install ruby-build become_user: "{{ user }}" git: repo=https://github.com/rbenv/ruby-build.git dest=~/.rbenv/plugins/ruby-build</code> </pre> <br><p> æœ€åå®‰è£…rubyã€‚ è¿™æ˜¯é€šè¿‡rbenvå®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªæ˜¯ä¸€ä¸ªbashå‘½ä»¤ï¼š </p><br><pre> <code class="plaintext hljs">- name: Install ruby become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" rbenv install {{ ruby_version }} args: executable: /bin/bash</code> </pre> <br><p> æˆ‘ä»¬è¯´è¦æ‰§è¡Œå“ªä¸ªå›¢é˜Ÿä»¥åŠå¦‚ä½•æ‰§è¡Œã€‚ ä½†æ˜¯ï¼Œè¿™é‡Œæˆ‘ä»¬é‡åˆ°è¿™æ ·ä¸€ä¸ªäº‹å®ï¼šansibleåœ¨è¿è¡Œå‘½ä»¤ä¹‹å‰ä¸ä¼šè¿è¡Œbashrcä¸­åŒ…å«çš„ä»£ç ã€‚ å› æ­¤ï¼Œå¿…é¡»ç›´æ¥åœ¨åŒä¸€è„šæœ¬ä¸­å®šä¹‰rbenvã€‚ </p><br><p> ä¸‹ä¸€ä¸ªé—®é¢˜æ˜¯shellå‘½ä»¤åœ¨ansibleä¸­æ²¡æœ‰çŠ¶æ€ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä¼šè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦å·²å®‰è£…æ­¤ç‰ˆæœ¬çš„Rubyã€‚ æˆ‘ä»¬å¯ä»¥è‡ªå·±åšï¼š </p><br><pre> <code class="plaintext hljs">- name: Install ruby become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" if ! rbenv versions | grep -q {{ ruby_version }} then rbenv install {{ ruby_version }} &amp;&amp; rbenv global {{ ruby_version }} fi args: executable: /bin/bash</code> </pre> <br><p> ä»ç„¶éœ€è¦å®‰è£…æ†ç»‘ç¨‹åºï¼š </p><br><pre> <code class="plaintext hljs">- name: Install bundler become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" gem install bundler</code> </pre> <br><p> å†ä¸€æ¬¡ï¼Œå°†æˆ‘ä»¬çš„ruby_rbenvè§’è‰²æ·»åŠ åˆ°ä¸»è¦å‰§æœ¬ä¸­ã€‚ </p><br><h3 id="shared-files"> å…±äº«æ–‡ä»¶ã€‚ </h3><br><p> é€šå¸¸ï¼Œæ­¤è®¾ç½®å¯ä»¥å®Œæˆã€‚ ç„¶åä»ç„¶å¯ä»¥è¿è¡Œcapistranoï¼Œå®ƒå°†å¤åˆ¶ä»£ç æœ¬èº«ï¼Œåˆ›å»ºå¿…è¦çš„ç›®å½•å¹¶å¯åŠ¨åº”ç”¨ç¨‹åºï¼ˆå¦‚æœæ‰€æœ‰é…ç½®å‡æ­£ç¡®ï¼‰ã€‚ ä½†æ˜¯ï¼Œcapistranoé€šå¸¸éœ€è¦å…¶ä»–é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚<code>database.yml</code>æˆ–<code>.env</code>å¯ä»¥åƒnginxçš„æ–‡ä»¶å’Œæ¨¡æ¿ä¸€æ ·å¤åˆ¶å®ƒä»¬ã€‚ åªæœ‰ä¸€ç§å¾®å¦™ä¹‹å¤„ã€‚ å¤åˆ¶æ–‡ä»¶ä¹‹å‰ï¼Œéœ€è¦ä¸ºå®ƒä»¬åˆ›å»ºç›®å½•ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="plaintext hljs"># Copy shared files for deploy - name: Ensure shared dir become_user: "{{ user }}" file: path: "{{ app_path }}/shared/config" state: directory</code> </pre> <br><p> æˆ‘ä»¬ä»…æŒ‡å®šä¸€ä¸ªç›®å½•ï¼Œå¦‚æœéœ€è¦ï¼Œansibleä¼šè‡ªåŠ¨åˆ›å»ºçˆ¶ç›®å½•ã€‚ </p><br><h2 id="ansible-vault">  Ansibleä¿é™©åº“ </h2><br><p> æˆ‘ä»¬å·²ç»å¶ç„¶å‘ç°è¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œå³è¯¸å¦‚ç”¨æˆ·å¯†ç ä¹‹ç±»çš„ç§˜å¯†æ•°æ®å¯èƒ½ä¼šå‡ºç°åœ¨å˜é‡ä¸­ã€‚ å¦‚æœä¸ºåº”ç”¨ç¨‹åºå’Œ<code>database.yml</code> <code>.env</code>åˆ›å»ºäº†ä¸€ä¸ª<code>.env</code>æ–‡ä»¶ï¼Œåˆ™åº”è¯¥æœ‰æ›´å¤šæ­¤ç±»å…³é”®æ•°æ®ã€‚ é®ä½ä»–ä»¬çš„çœ¼ç›ï¼Œè¿™å°†æ˜¯å¾ˆå¥½çš„é€‰æ‹©ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Ansibleä¿é™©åº“</a>ç”¨äºæ­¤ç›®çš„ã€‚ </p><br><p> è®©æˆ‘ä»¬ä¸ºå˜é‡<code>/ansible/vars/all.yml</code>åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼ˆåœ¨è¿™é‡Œæ‚¨å¯ä»¥ä¸ºä¸åŒçš„ä¸»æœºç»„åˆ›å»ºä¸åŒçš„æ–‡ä»¶ï¼Œå°±åƒåœ¨æ¸…å•æ–‡ä»¶ä¸­ä¸€æ ·ï¼šproduction.ymlï¼Œstaging.ymlç­‰ï¼‰ã€‚ <br> åœ¨æ­¤æ–‡ä»¶ä¸­ï¼Œæ‚¨éœ€è¦ä¼ è¾“æ‰€æœ‰å¿…é¡»ä½¿ç”¨æ ‡å‡†ymlè¯­æ³•åŠ å¯†çš„å˜é‡ï¼š </p><br><pre> <code class="plaintext hljs"># System vars user_password: 123qweasd db_password: 123qweasd # ENV vars aws_access_key_id: xxxxx aws_secret_access_key: xxxxxx aws_bucket: bucket_name rails_secret_key_base: very_secret_key_base</code> </pre> <br><p> ç„¶åå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯¹è¯¥æ–‡ä»¶è¿›è¡ŒåŠ å¯†ï¼š </p><br><pre> <code class="plaintext hljs">ansible-vault encrypt ./vars/all.yml</code> </pre> <br><p> è‡ªç„¶ï¼Œåœ¨åŠ å¯†è¿‡ç¨‹ä¸­ï¼Œæœ‰å¿…è¦è®¾ç½®è§£å¯†å¯†ç ã€‚ è°ƒç”¨æ­¤å‘½ä»¤åï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æ–‡ä»¶ä¸­æ˜¾ç¤ºçš„å†…å®¹ã€‚ </p><br><p> ä½¿ç”¨<code>ansible-vault decrypt</code>å¯ä»¥è§£å¯†ï¼Œä¿®æ”¹æ–‡ä»¶ï¼Œç„¶åå†æ¬¡åŠ å¯†ã€‚ </p><br><p> è¦å·¥ä½œï¼Œæ— éœ€è§£å¯†æ–‡ä»¶ã€‚ æ‚¨ä»¥åŠ å¯†å½¢å¼å­˜å‚¨å®ƒï¼Œå¹¶ä½¿ç”¨å‚æ•°<code>--ask-vault-pass</code>è¿è¡Œè¯¥å‰§æœ¬ã€‚  Ansibleå°†è¦æ±‚è¾“å…¥å¯†ç ï¼Œè·å–å˜é‡å¹¶å®Œæˆä»»åŠ¡ã€‚ æ‰€æœ‰æ•°æ®å°†ä¿æŒåŠ å¯†çŠ¶æ€ã€‚ </p><br><p> å‡ ä¸ªä¸»æœºç»„å’Œansible Vaultçš„å®Œæ•´å‘½ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="plaintext hljs">ansible-playbook -i inventory ./playbook.yml -l "staging" --ask-vault-pass</code> </pre> <br><p> è€Œä¸”æˆ‘ä¸ä¼šç»™æ‚¨å‰§æœ¬å’Œè§’è‰²çš„å…¨æ–‡ï¼Œè€Œæ˜¯ä¸ºæ‚¨è‡ªå·±å†™ã€‚ å› ä¸ºè¿™å¾ˆçƒ¦äºº-å¦‚æœæ‚¨ä¸äº†è§£éœ€è¦åšä»€ä¹ˆï¼Œé‚£ä¹ˆä»–å°±ä¸ä¼šåšã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN460769/">https://habr.com/ru/post/zh-CN460769/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN460743/index.html">Flutterå…¥é—¨æŒ‡å—</a></li>
<li><a href="../zh-CN460745/index.html">æœ‰åœ¨å®¶åº­è‡ªåŠ¨åŒ–ä¸­ä½¿ç”¨GSMæ¨¡å—çš„ç»éªŒ</a></li>
<li><a href="../zh-CN460747/index.html">å¯»æ‰¾åˆ©æ¶¦æˆ–æ‹§ç´§åšæœï¼šSpotifyå·²åœæ­¢ç›´æ¥ä¸ä½œè€…åˆä½œ-è¿™æ˜¯ä»€ä¹ˆæ„æ€</a></li>
<li><a href="../zh-CN460751/index.html">æˆ‘ä»¬å¦‚ä½•åœ¨å°åˆ‡å°”è¯ºè´åˆ©å‘å°„æœºå™¨äººã€‚ ç¬¬ä¸€éƒ¨åˆ†</a></li>
<li><a href="../zh-CN460755/index.html">ROSæ‰‹æ¨è½¦æœºå™¨äºº-ç¬¬1éƒ¨åˆ†ï¼šé“</a></li>
<li><a href="../zh-CN460773/index.html">åœ¨Javaä¸­å®ç°æ¨¡å¼åŒ¹é…</a></li>
<li><a href="../zh-CN460777/index.html">è½®åˆ°äº†ï¼šä¸ºä»€ä¹ˆè‹¹æœæ”¹å˜äº†å¯¹åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜çš„è¦æ±‚</a></li>
<li><a href="../zh-CN460779/index.html">é«˜çº§è°ƒè¯•</a></li>
<li><a href="../zh-CN460783/index.html">èŠ‚ç‚¹ä¿¡èª‰çš„å…±è¯†ã€‚ æœ‰å¿…è¦å—ï¼Ÿ</a></li>
<li><a href="../zh-CN460785/index.html">Androidæ“ä½œç³»ç»Ÿä¸Šçš„ç”µå­ä¹¦åº”ç”¨ç¨‹åºã€‚ ç¬¬1éƒ¨åˆ†ã€‚ç®€ä»‹å’ŒåŠå…¬åº”ç”¨</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>