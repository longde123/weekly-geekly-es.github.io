<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>う   Rompiendo el navegador UC 解  </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduccion 
 A finales de marzo, informamos sobre el potencial oculto para descargar y ejecutar c贸digo no verificado en el navegador UC. Hoy examina...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rompiendo el navegador UC</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/drweb/blog/452076/"><img src="https://habrastorage.org/webt/ke/e0/rd/kee0rdupth-kalljz9gfxpjndnk.jpeg"><br><br><h3>  Introduccion </h3><br>  A finales de marzo, informamos sobre el potencial oculto para descargar y ejecutar c贸digo no verificado en el navegador UC.  Hoy examinaremos en detalle c贸mo sucede y c贸mo los hackers pueden usarlo. <br><br>  Hace alg煤n tiempo, UC Browser fue promovido y distribuido de manera bastante agresiva.  Fue instalado en dispositivos por malware, distribuido a trav茅s de sitios web bajo la apariencia de archivos de video (es decir, los usuarios pensaron que estaban descargando pornograf铆a o algo as铆, pero en su lugar estaban obteniendo archivos APK con este navegador), anunciados usando pancartas preocupantes sobre el navegador de un usuario desactualizado o vulnerable  El grupo oficial UC Browser VK ten铆a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tema</a> en el que los usuarios pod铆an quejarse de publicidad falsa y muchos usuarios proporcionaban ejemplos.  En 2016, incluso hubo un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">comercial</a> en ruso (s铆, un comercial de un navegador que bloquea los comerciales). <br><br>  Mientras escribimos este art铆culo, UC Browser se instal贸 500,000,000 veces desde Google Play.  Esto es impresionante ya que solo Google Chrome logr贸 superar eso.  Entre las revisiones, puede ver muchas quejas de los usuarios sobre publicidad y ser redirigido a otras aplicaciones en Google Play.  Esta fue la raz贸n de nuestro estudio: quer铆amos ver si UC Browser est谩 haciendo algo mal.  Y lo es!  La aplicaci贸n puede descargar y ejecutar c贸digo ejecutable, lo que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">viola la pol铆tica de Google Play para la publicaci贸n de aplicaciones</a> .  Y UC Browser no solo descarga c贸digo ejecutable;  lo hace de forma insegura, que puede usarse para un ataque MitM.  Veamos si podemos usarlo de esta manera. <br><a name="habracut"></a><br>  Todo lo que sigue se aplica a la versi贸n de UC Browser que se distribuy贸 a trav茅s de Google Play en el momento de nuestro estudio: <br><br><pre><code class="plaintext hljs">package: com.UCMobile.intl versionName: 12.10.8.1172 versionCode: 10598 sha1 APK-file: f5edb2243413c777172f6362876041eb0c3a928c</code> </pre> <br><h3>  Vector de ataque </h3><br>  El manifiesto del navegador UC contiene un servicio con un nombre revelador de <i>com.uc.deployment.UpgradeDeployService</i> . <br><br><pre> <code class="plaintext hljs"> &lt;service android:exported="false" android:name="com.uc.deployment.UpgradeDeployService" android:process=":deploy" /&gt;</code> </pre><br>  Cuando se inicia este servicio, el navegador realiza una solicitud POST a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">puds.ucweb.com/upgrade/index.xhtml</a> que se puede ver en el tr谩fico durante alg煤n tiempo despu茅s del lanzamiento.  En respuesta, el navegador puede recibir un comando para descargar cualquier actualizaci贸n o un nuevo m贸dulo.  Durante nuestro an谩lisis, nunca recibimos tales comandos del servidor, pero notamos que al intentar abrir un archivo PDF en el navegador, repite la solicitud a la direcci贸n anterior y luego descarga una biblioteca nativa.  Para simular un ataque, decidimos usar esta funci贸n del navegador UC, la capacidad de abrir archivos PDF usando una biblioteca nativa, no presente en el archivo APK, pero descargable desde Internet.  T茅cnicamente, UC Browser puede descargar algo sin el permiso de un usuario cuando se le da una respuesta adecuada a una solicitud enviada al inicio.  Pero para esto necesitamos estudiar el protocolo de interacci贸n con el servidor con m谩s detalle, por lo que pensamos que era m谩s f谩cil conectar y editar la respuesta y luego reemplazar la biblioteca necesaria para abrir archivos PDF con algo diferente. <br><br>  Entonces, cuando un usuario desea abrir un archivo PDF directamente en el navegador, el tr谩fico puede contener las siguientes solicitudes: <br><br><img src="https://habrastorage.org/webt/j0/i1/c1/j0i1c1n_nwf_gnauzbudnqor5oi.png"><br><br>  Primero, hay una solicitud POST a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">puds.ucweb.com/upgrade/index.xhtml</a> , luego se descarga la biblioteca comprimida para ver archivos PDF y documentos de Office.  L贸gicamente, podemos suponer que la primera solicitud env铆a informaci贸n sobre el sistema (al menos la arquitectura, porque el servidor necesita seleccionar una biblioteca apropiada), y el servidor responde con cierta informaci贸n sobre la biblioteca que necesita ser descargada, como su direcci贸n y tal vez algo m谩s.  El problema es que esta solicitud est谩 encriptada. <br><br><div class="scrollable-table"><table><tbody><tr><td>  Fragmento de solicitud <br><br></td><td>  Fragmento de respuesta <br><br></td></tr><tr><td><img src="https://habrastorage.org/webt/go/tj/tz/gotjtzkpg2owfmk8jrnznox_vdg.jpeg"><br><br></td><td><img src="https://habrastorage.org/webt/g5/7k/iv/g57kivkwrysmcqvptmhclqzzipq.png"><br><br></td></tr></tbody></table></div><br>  La biblioteca est谩 comprimida en un archivo ZIP y no est谩 encriptada. <br><br><img src="https://habrastorage.org/webt/6r/lt/ns/6rltnsrtyd-_5ekwis68qn-vydc.png"><br><br><h3>  Buscando c贸digo de descifrado de tr谩fico </h3><br>  Intentemos descifrar la respuesta del servidor.  Eche un vistazo al c贸digo de la <i>clase com.uc.deployment.UpgradeDeployService</i> : desde el <i>m茅todo onStartCommand</i> , navegamos a <i>com.uc.deployment.bx</i> y luego a <i>com.uc.browser.core.dcfe</i> : <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(l arg9)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v4_5; String v3_1; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v3; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v1 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg9 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v3 = v1; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v3_1 = arg9.iGX.ipR; StringBuilder v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]product:"</span></span>); v4.append(arg9.iGX.ipR); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]version:"</span></span>); v4.append(arg9.iGX.iEn); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]upgrade_type:"</span></span>); v4.append(arg9.iGX.mMode); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]force_flag:"</span></span>); v4.append(arg9.iGX.iEo); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_mode:"</span></span>); v4.append(arg9.iGX.iDQ); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_type:"</span></span>); v4.append(arg9.iGX.iEr); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_state:"</span></span>); v4.append(arg9.iGX.iEp); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_file:"</span></span>); v4.append(arg9.iGX.iEq); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apk_md5:"</span></span>); v4.append(arg9.iGX.iEl); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]download_type:"</span></span>); v4.append(arg9.mDownloadType); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]download_group:"</span></span>); v4.append(arg9.mDownloadGroup); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]download_path:"</span></span>); v4.append(arg9.iGH); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_child_version:"</span></span>); v4.append(arg9.iGX.iEx); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_series:"</span></span>); v4.append(arg9.iGX.iEw); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_cpu_arch:"</span></span>); v4.append(arg9.iGX.iEt); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_cpu_vfp3:"</span></span>); v4.append(arg9.iGX.iEv); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_cpu_vfp:"</span></span>); v4.append(arg9.iGX.iEu); ArrayList v3_2 = arg9.iGX.iEz; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3_2 != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; v3_2.size() != <span class="hljs-number"><span class="hljs-number">0</span></span>) { Iterator v3_3 = v3_2.iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(v3_3.hasNext()) { Object v4_1 = v3_3.next(); StringBuilder v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_name:"</span></span>); v5.append(((au)v4_1).getName()); v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_ver_name:"</span></span>); v5.append(((au)v4_1).aDA()); v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_ver_code:"</span></span>); v5.append(((au)v4_1).gBl); v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_req_type:"</span></span>); v5.append(((au)v4_1).gBq); } } j v3_4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> j(); mb(v3_4); h v4_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> h(); mb(v4_2); ay v5_1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ay(); v3_4.hS(<span class="hljs-string"><span class="hljs-string">""</span></span>); v3_4.setImsi(<span class="hljs-string"><span class="hljs-string">""</span></span>); v3_4.hV(<span class="hljs-string"><span class="hljs-string">""</span></span>); v5_1.bPQ = v3_4; v5_1.bPP = v4_2; v5_1.yr(arg9.iGX.ipR); v5_1.gBF = arg9.iGX.mMode; v5_1.gBI = arg9.iGX.iEz; v3_2 = v5_1.gAr; c.aBh(); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"os_ver"</span></span>, c.getRomInfo())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"processor_arch"</span></span>, com.uc.baacgetCpuArch())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_arch"</span></span>, com.uc.baacPb())); String v4_3 = com.uc.baacPd(); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_vfp"</span></span>, v4_3)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"net_type"</span></span>, String.valueOf(com.uc.base.system.a.Jo()))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"fromhost"</span></span>, arg9.iGX.iEm)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"plugin_ver"</span></span>, arg9.iGX.iEn)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"target_lang"</span></span>, arg9.iGX.iEs)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"vitamio_cpu_arch"</span></span>, arg9.iGX.iEt)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"vitamio_vfp"</span></span>, arg9.iGX.iEu)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"vitamio_vfp3"</span></span>, arg9.iGX.iEv)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"plugin_child_ver"</span></span>, arg9.iGX.iEx)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"ver_series"</span></span>, arg9.iGX.iEw)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"child_ver"</span></span>, r.aVw())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cur_ver_md5"</span></span>, arg9.iGX.iEl)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cur_ver_signature"</span></span>, SystemHelper.getUCMSignature())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"upgrade_log"</span></span>, i.bjt())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_install"</span></span>, String.valueOf(arg9.iGX.iDQ))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_state"</span></span>, String.valueOf(arg9.iGX.iEp))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_file"</span></span>, arg9.iGX.iEq)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_type"</span></span>, String.valueOf(arg9.iGX.iEr))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_archit"</span></span>, com.uc.baacPc())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_set"</span></span>, SystemHelper.getCpuInstruction())); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> v4_4 = v4_3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || !v4_3.contains(<span class="hljs-string"><span class="hljs-string">"neon"</span></span>) ? <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"neon"</span></span>, String.valueOf(v4_4))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_cores"</span></span>, String.valueOf(com.uc.baacJl()))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"ram_1"</span></span>, String.valueOf(com.uc.baahPo()))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"totalram"</span></span>, String.valueOf(com.uc.baahOL()))); c.aBh(); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"rom_1"</span></span>, c.getRomInfo())); v4_5 = e.getScreenWidth(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v6 = e.getScreenHeight(); StringBuilder v7 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); v7.append(v4_5); v7.append(<span class="hljs-string"><span class="hljs-string">"*"</span></span>); v7.append(v6); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"ss"</span></span>, v7.toString())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"api_level"</span></span>, String.valueOf(Build$VERSION.SDK_INT))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"uc_apk_list"</span></span>, SystemHelper.getUCMobileApks())); Iterator v4_6 = arg9.iGX.iEA.entrySet().iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(v4_6.hasNext()) { Object v6_1 = v4_6.next(); v3_2.add(g.fs(((Map$Entry)v6_1).getKey(), ((Map$Entry)v6_1).getValue())); } v3 = v5_1.toByteArray(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_encode"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } v4_5 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGw ? <span class="hljs-number"><span class="hljs-number">0x1F</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v3 = gi(v4_5, v3); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[v3.length + <span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v6_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">16</span></span>]; Arrays.fill(v6_2, <span class="hljs-number"><span class="hljs-number">0</span></span>); v6_2[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0x5F</span></span>; v6_2[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; v6_2[<span class="hljs-number"><span class="hljs-number">2</span></span>] = ((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)v4_5); v6_2[<span class="hljs-number"><span class="hljs-number">3</span></span>] = -<span class="hljs-number"><span class="hljs-number">50</span></span>; System.arraycopy(v6_2, <span class="hljs-number"><span class="hljs-number">0</span></span>, v1, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>); System.arraycopy(v3, <span class="hljs-number"><span class="hljs-number">0</span></span>, v1, <span class="hljs-number"><span class="hljs-number">16</span></span>, v3.length); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v1 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_encrypt"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(TextUtils.isEmpty(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.mUpgradeUrl)) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_url"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } StringBuilder v0 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v0.append(arg9.iGX.ipR); v0.append(<span class="hljs-string"><span class="hljs-string">"]url:"</span></span>); v0.append(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.mUpgradeUrl); com.uc.browser.core.dci v0_1 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI; v3_1 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.mUpgradeUrl; com.uc.base.net.e v0_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> com.uc.base.net.e(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> com.uc.browser.core.dci$a(v0_1, arg9)); v3_1 = v3_1.contains(<span class="hljs-string"><span class="hljs-string">"?"</span></span>) ? v3_1 + <span class="hljs-string"><span class="hljs-string">"&amp;dataver=pb"</span></span> : v3_1 + <span class="hljs-string"><span class="hljs-string">"?dataver=pb"</span></span>; n v3_5 = v0_2.uc(v3_1); mb(v3_5, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); v3_5.setMethod(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>); v3_5.setBodyProvider(v1); v0_2.b(v3_5); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_null"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"success"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.b(arg9); }</code> </pre> <br>  Podemos ver que aqu铆 es donde se realiza la solicitud POST.  Eche un vistazo a la matriz de 16 bytes que contiene: 0x5F, 0, 0x1F, -50 (= 0xCE).  Los valores son los mismos que en la solicitud anterior. <br><br>  La misma clase contiene una clase anidada con otro m茅todo interesante: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(l arg10, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] arg11)</span></span></span><span class="hljs-function"> </span></span>{ f v0 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGQ; StringBuilder v1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v1.append(arg10.iGX.ipR); v1.append(<span class="hljs-string"><span class="hljs-string">"]:UpgradeSuccess"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v1_1 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11.length &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-number"><span class="hljs-number">0x60</span></span> &amp;&amp; arg11[<span class="hljs-number"><span class="hljs-number">3</span></span>] != <span class="hljs-number"><span class="hljs-number">0xFFFFFFD0</span></span>) { goto label_57; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v3 = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v5 = arg11[<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-number"><span class="hljs-number">1</span></span> ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>] != <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>] != <span class="hljs-number"><span class="hljs-number">11</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>] == <span class="hljs-number"><span class="hljs-number">0x1F</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v3 = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v7 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[arg11.length - <span class="hljs-number"><span class="hljs-number">16</span></span>]; System.arraycopy(arg11, <span class="hljs-number"><span class="hljs-number">16</span></span>, v7, <span class="hljs-number"><span class="hljs-number">0</span></span>, v7.length); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 != <span class="hljs-number"><span class="hljs-number">0</span></span>) { v7 = gj(arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>], v7); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v7 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { goto label_57; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v5 != <span class="hljs-number"><span class="hljs-number">0</span></span>) { v1_1 = gP(v7); goto label_57; } v1_1 = v7; } label_57: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v1_1 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v0.iGY.iGI.a(arg10, <span class="hljs-string"><span class="hljs-string">"up_decrypt"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } q v11 = gb(arg10, v1_1); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v11 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v0.iGY.iGI.a(arg10, <span class="hljs-string"><span class="hljs-string">"up_decode"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v0.iGY.iGt) { v0.d(arg10); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v0.iGY.iGo != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v0.iGY.iGo.a(<span class="hljs-number"><span class="hljs-number">0</span></span>, ((o)v11)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v0.iGY.iGs) { v0.iGY.a(((o)v11)); v0.iGY.iGI.a(v11, <span class="hljs-string"><span class="hljs-string">"up_silent"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"success"</span></span>); v0.iGY.iGI.a(v11); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } v0.iGY.iGI.a(v11, <span class="hljs-string"><span class="hljs-string">"up_silent"</span></span>, <span class="hljs-string"><span class="hljs-string">"no"</span></span>, <span class="hljs-string"><span class="hljs-string">"success"</span></span>); } }</code> </pre> <br>  Este m茅todo recibe una entrada de una matriz de bytes y comprueba si el byte cero es 0x60, o si el tercer byte es 0xD0 y si el segundo byte es 1, 11 o 0x1F.  Consulte la respuesta del servidor: el byte cero es 0x60, el segundo byte es 0x1F, el tercer byte es 0x60.  Se parece a lo que necesitamos.  A juzgar por las cadenas ("up_decrypt", por ejemplo), se supone que se llama a un m茅todo aqu铆 para descifrar la respuesta del servidor.  Ahora veamos el m茅todo gj.  Tenga en cuenta que el primer argumento es un byte en el desplazamiento 2 (es decir, 0x1F en nuestro caso), y el segundo es la respuesta del servidor sin los primeros 16 bytes. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] j(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> arg1, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arg2) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg1 == <span class="hljs-number"><span class="hljs-number">1</span></span>) { arg2 = cc(arg2, c.adu); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg1 == <span class="hljs-number"><span class="hljs-number">11</span></span>) { arg2 = m.aF(arg2); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg1 != <span class="hljs-number"><span class="hljs-number">0x1F</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { arg2 = EncryptHelper.decrypt(arg2); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> arg2; }</code> </pre> <br>  Obviamente, est谩 seleccionando el algoritmo de descifrado, y el byte que en nuestro caso es igual a 0x1F indica una de las tres opciones posibles. <br><br>  Volvamos al an谩lisis de c贸digo.  Despu茅s de un par de saltos, llegamos al m茅todo con el nombre revelador, <i>decryptBytesByKey</i> .  Ahora, dos bytes m谩s se separan de nuestra respuesta y forman una cadena.  Est谩 claro que as铆 es como se selecciona la clave para descifrar el mensaje. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] decryptBytesByKey(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v0 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bytes != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bytes.length &lt; EncryptHelper.PREFIX_BYTES_SIZE) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bytes.length == EncryptHelper.PREFIX_BYTES_SIZE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v0; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] prefix = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[EncryptHelper.PREFIX_BYTES_SIZE]; <span class="hljs-comment"><span class="hljs-comment">// 2  System.arraycopy(bytes, 0, prefix, 0, prefix.length); String keyId = c.ayR().d(ByteBuffer.wrap(prefix).getShort()); //   if(keyId == null) { return v0; } else { a v2 = EncryptHelper.ayL(); if(v2 == null) { return v0; } else { byte[] enrypted = new byte[bytes.length - EncryptHelper.PREFIX_BYTES_SIZE]; System.arraycopy(bytes, EncryptHelper.PREFIX_BYTES_SIZE, enrypted, 0, enrypted.length); return v2.l(keyId, enrypted); } } } } catch(SecException v7_1) { EncryptHelper.handleDecryptException(((Throwable)v7_1), v7_1.getErrorCode()); return v0; } catch(Throwable v7) { EncryptHelper.handleDecryptException(v7, 2); return v0; } } return v0; }</span></span></code> </pre> <br>  Avance un poco, tenga en cuenta que en esta etapa, solo es el identificador de la clave, no la clave en s铆.  La selecci贸n de teclas ser谩 un poco m谩s complicada. <br><br>  En el siguiente m茅todo, se agregan dos par谩metros m谩s a los existentes, por lo que obtenemos un total de cuatro.  El n煤mero m谩gico 16, el identificador de clave, los datos cifrados y una cadena se agrega all铆 por alguna raz贸n (vac铆a en nuestro caso). <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] l(String keyId, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] encrypted) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> SecException { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ayJ().staticBinarySafeDecryptNoB64(<span class="hljs-number"><span class="hljs-number">16</span></span>, keyId, encrypted, <span class="hljs-string"><span class="hljs-string">""</span></span>); }</code> </pre> <br>  Despu茅s de una serie de saltos, vemos el m茅todo <i>staticBinarySafeDecryptNoB64</i> de la interfaz <i>com.alibaba.wireless.security.open.staticdataencrypt.IStaticDataEncryptComponent</i> .  El c贸digo de la aplicaci贸n principal no tiene clases que implementen esta interfaz.  Esta clase est谩 contenida en el archivo <b><i>lib / armeabi-v7a / libsgmain.so</i></b> , que no es realmente .SO, sino m谩s bien .JAR.  El m茅todo que nos interesa se implementa de la siguiente manera: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.alibaba.wireless.security.ai; <span class="hljs-comment"><span class="hljs-comment">// ... public class a implements IStaticDataEncryptComponent { private ISecurityGuardPlugin a; // ... private byte[] a(int mode, int magicInt, int xzInt, String keyId, byte[] encrypted, String magicString) { return this.a.getRouter().doCommand(10601, new Object[]{Integer.valueOf(mode), Integer.valueOf(magicInt), Integer.valueOf(xzInt), keyId, encrypted, magicString}); } // ... private byte[] b(int magicInt, String keyId, byte[] encrypted, String magicString) { return this.a(2, magicInt, 0, keyId, encrypted, magicString); } // ... public byte[] staticBinarySafeDecryptNoB64(int magicInt, String keyId, byte[] encrypted, String magicString) throws SecException { if(keyId != null &amp;&amp; keyId.length() &gt; 0 &amp;&amp; magicInt &gt;= 0 &amp;&amp; magicInt &lt; 19 &amp;&amp; encrypted != null &amp;&amp; encrypted.length &gt; 0) { return this.b(magicInt, keyId, encrypted, magicString); } throw new SecException("", 301); } //... }</span></span></code> </pre> <br>  Aqu铆, nuestra lista de par谩metros se complementa con dos enteros m谩s: 2 y 0. Aparentemente, 2 significa descifrado, como en el <i>m茅todo doFinal</i> de la clase de <i>sistema javax.crypto.Cipher</i> .  Luego, esta informaci贸n se transmite a un determinado enrutador junto con el n煤mero 10601, que aparentemente es el n煤mero de comando. <br><br>  Despu茅s de la pr贸xima cadena de saltos, encontramos una clase que implementa la interfaz <i>RouterComponent</i> y el m茅todo <i>doCommand</i> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.alibaba.wireless.security.mainplugin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.alibaba.wireless.security.framework.IRouterComponent; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.taobao.wireless.security.adapter.JNICLibrary; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IRouterComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg2, Object[] arg3)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JNICLibrary.doCommandNative(arg2, arg3); } }</code> </pre> <br>  Tambi茅n est谩 la clase <i>JNIC Library</i> , donde se <i>declara el</i> m茅todo nativo <i>doCommandNative</i> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.taobao.wireless.security.adapter; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JNICLibrary</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doCommandNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg0, Object[] arg1)</span></span></span></span>; }</code> </pre> <br>  Entonces, necesitamos encontrar el m茅todo <i>doCommandNative</i> en el c贸digo nativo.  Ah铆 es donde comienza la diversi贸n. <br><br><h3>  C贸digo de m谩quina de ofuscaci贸n </h3><br>  Hay una biblioteca nativa en el archivo <i>libsgmain.so</i> (que en realidad es un archivo .JAR y, como dijimos anteriormente, implementa algunas interfaces relacionadas con el cifrado): <i><b>libsgmainso-6.4.36.so</b></i> .  Lo cargamos en IDA y obtenemos un mont贸n de di谩logos con mensajes de error.  El problema es que la tabla de encabezado de secci贸n no es v谩lida.  Esto se hace a prop贸sito para complicar el an谩lisis. <br><br><img src="https://habrastorage.org/webt/_k/bz/5c/_kbz5cbedw6g1jnsj047rtqudli.jpeg"><br><br>  Pero realmente no lo necesitamos de todos modos.  La tabla de encabezado del programa es suficiente para cargar correctamente el archivo ELF y analizarlo.  Entonces simplemente eliminamos la tabla de encabezado de secci贸n, anulando los campos correspondientes en el encabezado. <br><br><img src="https://habrastorage.org/webt/2y/xh/vk/2yxhvksp30f016gfyhrlfh0pklc.jpeg"><br><br>  Luego abrimos el archivo en IDA nuevamente. <br><br>  Tenemos dos formas de decirle a la m谩quina virtual Java exactamente d贸nde la biblioteca nativa contiene la implementaci贸n del m茅todo declarado como nativo en el c贸digo Java.  El primero es darle un nombre como este: <i>Java_package_name_ClassName_methodName</i> .  El segundo es registrarlo al cargar la biblioteca (en la funci贸n JNI_OnLoad) llamando a la funci贸n RegisterNatives.  En nuestro caso, si usa el primer m茅todo, el nombre deber铆a ser as铆: <i>Java_com_taobao_wireless_security_adapter_JNICLibrary_doCommandNative</i> .  La lista de funciones exportadas no contiene este nombre, lo que significa que debemos buscar RegisterNatives.  Por lo tanto, vamos a la funci贸n JNI_OnLoad y vemos lo siguiente: <br><br><img src="https://habrastorage.org/webt/m6/dp/iw/m6dpiwaonfuyri-jg8thppcfgqe.jpeg"><br><br>  Que esta pasando aqui  A primera vista, el principio y el final de la funci贸n son t铆picos de la arquitectura ARM.  La primera instrucci贸n empuja el contenido de los registros que la funci贸n usar谩 a la pila (en este caso, R0, R1 y R2), as铆 como el contenido del registro LR con la direcci贸n de retorno de la funci贸n.  La 煤ltima instrucci贸n restaura los registros guardados y coloca la direcci贸n de retorno en el registro de la PC, regresando as铆 de la funci贸n.  Pero si observamos m谩s de cerca, podemos notar que la pen煤ltima instrucci贸n cambia la direcci贸n de retorno, almacenada en la pila.  Calculemos qu茅 ser谩 cuando se ejecute el c贸digo.  La direcci贸n 0xB130 se carga en R1, tiene 5 restados de ella, luego se mueve a R0 y recibe una adici贸n de 0x10.  Al final, es igual a 0xB13B.  Por lo tanto, IDA cree que la instrucci贸n final realiza un retorno de funci贸n normal, mientras que, de hecho, realiza una transferencia a la direcci贸n calculada 0xB13B. <br><br>  Ahora perm铆tanos recordarle que los procesadores ARM tienen dos modos y dos conjuntos de instrucciones: ARM y Thumb.  El bit de orden inferior de la direcci贸n determina qu茅 conjunto de instrucciones usar谩 el procesador. Es decir, la direcci贸n es en realidad 0xB13A, mientras que el valor en el bit de orden inferior indica el modo Thumb. <br>  Se agrega un adaptador similar y algo de basura sem谩ntica al comienzo de cada funci贸n en esta biblioteca.  Pero no nos detendremos en ellos en detalle.  Solo recuerde que el comienzo real de casi todas las funciones est谩 un poco m谩s all谩. <br><br>  Como no existe una transici贸n expl铆cita a 0xB13A en el c贸digo, IDA no puede reconocer que hay c贸digo all铆.  Por la misma raz贸n, no reconoce la mayor parte del c贸digo en la biblioteca como c贸digo, lo que hace que el an谩lisis sea un poco m谩s complicado.  Entonces, le decimos a IDA que hay c贸digo, y esto es lo que sucede: <br><br><img src="https://habrastorage.org/webt/eq/wp/p3/eqwpp3exmqnybi7r_tdvvan4jls.png"><br><br>  A partir de 0xB144, tenemos claramente la tabla.  Pero 驴qu茅 pasa con sub_494C? <br><br><img src="https://habrastorage.org/webt/bo/9b/rn/bo9brnkfvauy3ntm2dnucnsxqhs.png"><br><br>  Al llamar a esta funci贸n en el registro LR, obtenemos la direcci贸n de la tabla mencionada anteriormente (0xB144).  R0 contiene el 铆ndice en esta tabla.  Es decir, tomamos el valor de la tabla, lo agregamos a LR y obtenemos la direcci贸n a la que debemos ir.  Intentemos calcularlo: 0xB144 + [0xB144 + 8 * 4] = 0xB144 + 0x120 = 0xB264.  Navegamos a esta direcci贸n y vemos un par de instrucciones 煤tiles, luego vamos a 0xB140: <br><br><img src="https://habrastorage.org/webt/nz/95/4x/nz954xqtjmky6tnpaqeejhvecus.png"><br><br>  Ahora habr谩 una transici贸n en el desplazamiento con el 铆ndice 0x20 de la tabla. <br>  A juzgar por el tama帽o de la tabla, habr谩 muchas transiciones en el c贸digo.  Por lo tanto, nos gustar铆a lidiar con esto autom谩ticamente y evitar calcular direcciones manualmente.  Por lo tanto, los scripts y la capacidad de parchear c贸digo en IDA vienen a nuestro rescate: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put_unconditional_branch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(source, destination)</span></span></span><span class="hljs-function">:</span></span> offset = (destination - source - <span class="hljs-number"><span class="hljs-number">4</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">2097151</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-2097152</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> RuntimeError(<span class="hljs-string"><span class="hljs-string">"Invalid offset"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">1023</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-1024</span></span>: instruction1 = <span class="hljs-number"><span class="hljs-number">0xf000</span></span> | ((offset &gt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) instruction2 = <span class="hljs-number"><span class="hljs-number">0xb800</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction1) patch_word(source + <span class="hljs-number"><span class="hljs-number">2</span></span>, instruction2) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: instruction = <span class="hljs-number"><span class="hljs-number">0xe000</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction) ea = here() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> get_wide_word(ea) == <span class="hljs-number"><span class="hljs-number">0xb503</span></span>: <span class="hljs-comment"><span class="hljs-comment">#PUSH {R0,R1,LR} ea1 = ea + 2 if get_wide_word(ea1) == 0xbf00: #NOP ea1 += 2 if get_operand_type(ea1, 0) == 1 and get_operand_value(ea1, 0) == 0 and get_operand_type(ea1, 1) == 2: index = get_wide_dword(get_operand_value(ea1, 1)) print "index =", hex(index) ea1 += 2 if get_operand_type(ea1, 0) == 7: table = get_operand_value(ea1, 0) + 4 elif get_operand_type(ea1, 1) == 2: table = get_operand_value(ea1, 1) + 4 else: print "Wrong operand type on", hex(ea1), "-", get_operand_type(ea1, 0), get_operand_type(ea1, 1) table = None if table is None: print "Unable to find table" else: print "table =", hex(table) offset = get_wide_dword(table + (index &lt;&lt; 2)) put_unconditional_branch(ea, table + offset) else: print "Unknown code", get_operand_type(ea1, 0), get_operand_value(ea1, 0), get_operand_type(ea1, 1) == 2 else: print "Unable to detect first instruction"</span></span></code> </pre> <br>  Ponemos el cursor en la cadena 0xB26A, ejecutamos el script y vemos la transici贸n a 0xB4B0: <br><br><img src="https://habrastorage.org/webt/52/rf/fx/52rffxhzmtrfdhfrznsr8dovfim.png"><br><br>  Nuevamente, IDA no reconoce este lugar como c贸digo.  Lo ayudamos y vemos otra estructura all铆: <br><br><img src="https://habrastorage.org/webt/ct/d9/kv/ctd9kvewm9l1blmw3pqipi8mnqm.png"><br><br>  Las instrucciones que van despu茅s de BLX no parecen muy significativas;  son m谩s como una especie de compensaci贸n.  Nos fijamos en sub_4964: <br><br><img src="https://habrastorage.org/webt/o7/wi/4-/o7wi4-imrothkr6qpkbrklj40aw.png"><br><br>  De hecho, toma DWORD en la direcci贸n de LR, lo agrega a esta direcci贸n, luego toma el valor en la direcci贸n resultante y lo almacena en la pila.  Adem谩s, agrega 4 a LR para saltar este mismo desplazamiento despu茅s de regresar de la funci贸n.  Luego, el comando POP {R1} toma el valor resultante de la pila.  Mirando lo que se encuentra en la direcci贸n 0xB4BA + 0xEA = 0xB5A4, podemos ver algo similar a la tabla de direcciones: <br><br><img src="https://habrastorage.org/webt/ev/hb/a8/evhba8ty8dtnv8niuxyfue0nkfk.png"><br><br>  Para parchear esta estructura, necesitamos obtener dos par谩metros del c贸digo: el desplazamiento y el n煤mero de registro donde queremos empujar el resultado.  Tendremos que preparar un c贸digo de antemano para cada posible registro. <br><br><pre> <code class="python hljs">patches = {} patches[<span class="hljs-number"><span class="hljs-number">0</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x48</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">1</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x49</span></span>, <span class="hljs-number"><span class="hljs-number">0x09</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">2</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4a</span></span>, <span class="hljs-number"><span class="hljs-number">0x12</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">3</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4b</span></span>, <span class="hljs-number"><span class="hljs-number">0x1b</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">4</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4c</span></span>, <span class="hljs-number"><span class="hljs-number">0x24</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">5</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4d</span></span>, <span class="hljs-number"><span class="hljs-number">0x2d</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">8</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">0xd8</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">9</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0xd9</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">10</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0xa0</span></span>, <span class="hljs-number"><span class="hljs-number">0xda</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xa0</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">11</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0xb0</span></span>, <span class="hljs-number"><span class="hljs-number">0xdb</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xb0</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) ea = here() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (get_wide_word(ea) == <span class="hljs-number"><span class="hljs-number">0xb082</span></span> <span class="hljs-comment"><span class="hljs-comment">#SUB SP, SP, #8 and get_wide_word(ea + 2) == 0xb503): #PUSH {R0,R1,LR} if get_operand_type(ea + 4, 0) == 7: pop = get_bytes(ea + 12, 4, 0) if pop[1] == '\xbc': register = -1 r = get_wide_byte(ea + 12) for i in range(8): if r == (1 &lt;&lt; i): register = i break if register == -1: print "Unable to detect register" else: address = get_wide_dword(ea + 8) + ea + 8 for b in patches[register]: patch_byte(ea, b) ea += 1 if ea % 4 != 0: ea += 2 patch_dword(ea, address) elif pop[:3] == '\x5d\xf8\x04': register = ord(pop[3]) &gt;&gt; 4 if register in patches: address = get_wide_dword(ea + 8) + ea + 8 for b in patches[register]: patch_byte(ea, b) ea += 1 patch_dword(ea, address) else: print "POP instruction not found" else: print "Wrong operand type on +4:", get_operand_type(ea + 4, 0) else: print "Unable to detect first instructions"</span></span></code> </pre> <br>  Ponemos el cursor al comienzo de la estructura que queremos reemplazar (es decir, 0xB4B2) y ejecutamos el script: <br><br><img src="https://habrastorage.org/webt/lv/mp/oo/lvmpoow5agndjnbbl-t3imyaisq.jpeg"><br><br>  Adem谩s de las estructuras ya mencionadas, el c贸digo incluye lo siguiente: <br><br><img src="https://habrastorage.org/webt/dk/nn/rw/dknnrwaye18zzz0xipny0_gdqfq.png"><br><br>  Como en el caso anterior, hay un desplazamiento despu茅s de la instrucci贸n BLX: <br><br><img src="https://habrastorage.org/webt/fn/bw/uz/fnbwuzpo3qw1hp3vd9rvr2xfq1k.jpeg"><br><br>  Tomamos el desplazamiento en la direcci贸n de LR, lo agregamos a LR y navegamos all铆.  0x72044 + 0xC = 0x72050.  El script para esta estructura es bastante simple: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put_unconditional_branch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(source, destination)</span></span></span><span class="hljs-function">:</span></span> offset = (destination - source - <span class="hljs-number"><span class="hljs-number">4</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">2097151</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-2097152</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> RuntimeError(<span class="hljs-string"><span class="hljs-string">"Invalid offset"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">1023</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-1024</span></span>: instruction1 = <span class="hljs-number"><span class="hljs-number">0xf000</span></span> | ((offset &gt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) instruction2 = <span class="hljs-number"><span class="hljs-number">0xb800</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction1) patch_word(source + <span class="hljs-number"><span class="hljs-number">2</span></span>, instruction2) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: instruction = <span class="hljs-number"><span class="hljs-number">0xe000</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction) ea = here() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> get_wide_word(ea) == <span class="hljs-number"><span class="hljs-number">0xb503</span></span>: <span class="hljs-comment"><span class="hljs-comment">#PUSH {R0,R1,LR} ea1 = ea + 6 if get_wide_word(ea + 2) == 0xbf00: #NOP ea1 += 2 offset = get_wide_dword(ea1) put_unconditional_branch(ea, (ea1 + offset) &amp; 0xffffffff) else: print "Unable to detect first instruction"</span></span></code> </pre> <br>  El resultado de ejecutar el script: <br><br><img src="https://habrastorage.org/webt/tm/fq/yo/tmfqyogtdhbje0atjckosbrgide.jpeg"><br><br>  Despu茅s de parchear todo en esta funci贸n, podemos se帽alar la IDA a su comienzo real.  Recopilar谩 todo el c贸digo de funci贸n pieza por pieza y podremos descompilarlo usando HexRays. <br><br><h3>  Descifrar las cuerdas </h3><br>  Aprendimos a manejar la ofuscaci贸n del c贸digo de m谩quina en la biblioteca <b><i>libsgmainso-6.4.36.so</i></b> del navegador UC y obtuvimos el c贸digo de funci贸n <i>JNI_OnLoad</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">real_JNI_OnLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JavaVM *vm)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result; <span class="hljs-comment"><span class="hljs-comment">// r0 jclass clazz; // r0 MAPDST int v4; // r0 JNIEnv *env; // r4 int v6; // [sp-40h] [bp-5Ch] int v7; // [sp+Ch] [bp-10h] v7 = *(_DWORD *)off_8AC00; if ( !vm ) goto LABEL_39; sub_7C4F4(); env = (JNIEnv *)sub_7C5B0(0); if ( !env ) goto LABEL_39; v4 = sub_72CCC(); sub_73634(v4); sub_73E24(&amp;unk_83EA6, &amp;v6, 49); clazz = (jclass)((int (__fastcall *)(JNIEnv *, int *))(*env)-&gt;FindClass)(env, &amp;v6); if ( clazz &amp;&amp; (sub_9EE4(), sub_71D68(env), sub_E7DC(env) &gt;= 0 &amp;&amp; sub_69D68(env) &gt;= 0 &amp;&amp; sub_197B4(env, clazz) &gt;= 0 &amp;&amp; sub_E240(env, clazz) &gt;= 0 &amp;&amp; sub_B8B0(env, clazz) &gt;= 0 &amp;&amp; sub_5F0F4(env, clazz) &gt;= 0 &amp;&amp; sub_70640(env, clazz) &gt;= 0 &amp;&amp; sub_11F3C(env) &gt;= 0 &amp;&amp; sub_21C3C(env, clazz) &gt;= 0 &amp;&amp; sub_2148C(env, clazz) &gt;= 0 &amp;&amp; sub_210E0(env, clazz) &gt;= 0 &amp;&amp; sub_41B58(env, clazz) &gt;= 0 &amp;&amp; sub_27920(env, clazz) &gt;= 0 &amp;&amp; sub_293E8(env, clazz) &gt;= 0 &amp;&amp; sub_208F4(env, clazz) &gt;= 0) ) { result = (sub_B7B0(env, clazz) &gt;&gt; 31) | 0x10004; } else { LABEL_39: result = -1; } return result; }</span></span></code> </pre> <br>  Veamos las siguientes cadenas: <br><br><pre> <code class="cpp hljs"> sub_73E24(&amp;unk_83EA6, &amp;v6, <span class="hljs-number"><span class="hljs-number">49</span></span>); clazz = (jclass)((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> (__fastcall *)(JNIEnv *, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *))(*env)-&gt;FindClass)(env, &amp;v6);</code> </pre> <br>  Est谩 bastante claro que la funci贸n <i>sub_73E24</i> descifra el nombre de la clase.  Los par谩metros de esta funci贸n contienen un puntero a los datos que se parecen a los cifrados, un tipo de b煤fer y un n煤mero.  Obviamente, una cadena descifrada estar谩 en el b煤fer despu茅s de una llamada a la funci贸n, ya que el b煤fer va a la funci贸n <i>FindClass</i> , que recibe el mismo nombre de clase que el segundo par谩metro.  Entonces el n煤mero es el tama帽o del b煤fer o la longitud de la cadena.  Intentemos descifrar el nombre de la clase.  Debe indicar si vamos en la direcci贸n correcta.  Echemos un vistazo m谩s de cerca a lo que sucede en <i>sub_73E24</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_73E56</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __int8 *in, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __int8 *out, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v4; <span class="hljs-comment"><span class="hljs-comment">// r6 int v7; // r11 int v8; // r9 int v9; // r4 size_t v10; // r5 int v11; // r0 struc_1 v13; // [sp+0h] [bp-30h] int v14; // [sp+1Ch] [bp-14h] int v15; // [sp+20h] [bp-10h] v4 = 0; v15 = *(_DWORD *)off_8AC00; v14 = 0; v7 = sub_7AF78(17); v8 = sub_7AF78(size); if ( !v7 ) { v9 = 0; goto LABEL_12; } (*(void (__fastcall **)(int, const char *, int))(v7 + 12))(v7, "DcO/lcK+h?m3c*q@", 16); if ( !v8 ) { LABEL_9: v4 = 0; goto LABEL_10; } v4 = 0; if ( !in ) { LABEL_10: v9 = 0; goto LABEL_11; } v9 = 0; if ( out ) { memset(out, 0, size); v10 = size - 1; (*(void (__fastcall **)(int, unsigned __int8 *, size_t))(v8 + 12))(v8, in, v10); memset(&amp;v13, 0, 0x14u); v13.field_4 = 3; v13.field_10 = v7; v13.field_14 = v8; v11 = sub_6115C(&amp;v13, &amp;v14); v9 = v11; if ( v11 ) { if ( *(_DWORD *)(v11 + 4) == v10 ) { qmemcpy(out, *(const void **)v11, v10); v4 = *(_DWORD *)(v9 + 4); } else { v4 = 0; } goto LABEL_11; } goto LABEL_9; } LABEL_11: sub_7B148(v7); LABEL_12: if ( v8 ) sub_7B148(v8); if ( v9 ) sub_7B148(v9); return v4; }</span></span></code> </pre> <br>  La funci贸n sub_7AF78 crea una instancia de contenedor para conjuntos de bytes del tama帽o especificado (no nos centraremos en ellos en detalle).  Aqu铆 se crean dos contenedores de este tipo: uno contiene la cadena " <b><i>DcO / lcK + h? M3c * q @</i></b> " (es f谩cil adivinar que esta es la clave), el otro tiene los datos cifrados.  Ambos objetos se colocan en una determinada estructura, que se transfiere a la funci贸n <i>sub_6115C</i> .  Tambi茅n podemos notar que esta estructura contiene un campo con un valor de 3. Veamos qu茅 sucede despu茅s. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_611B4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struc_1 *a1, _DWORD *a2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v3; <span class="hljs-comment"><span class="hljs-comment">// lr unsigned int v4; // r1 int v5; // r0 int v6; // r1 int result; // r0 int v8; // r0 *a2 = 820000; if ( a1 ) { v3 = a1-&gt;field_14; if ( v3 ) { v4 = a1-&gt;field_4; if ( v4 &lt; 0x19 ) { switch ( v4 ) { case 0u: v8 = sub_6419C(a1-&gt;field_0, a1-&gt;field_10, v3); goto LABEL_17; case 3u: v8 = sub_6364C(a1-&gt;field_0, a1-&gt;field_10, v3); goto LABEL_17; case 0x10u: case 0x11u: case 0x12u: v8 = sub_612F4( a1-&gt;field_0, v4, *(_QWORD *)&amp;a1-&gt;field_8, *(_QWORD *)&amp;a1-&gt;field_8 &gt;&gt; 32, a1-&gt;field_10, v3, a2); goto LABEL_17; case 0x14u: v8 = sub_63A28(a1-&gt;field_0, v3); goto LABEL_17; case 0x15u: sub_61A60(a1-&gt;field_0, v3, a2); return result; case 0x16u: v8 = sub_62440(a1-&gt;field_14); goto LABEL_17; case 0x17u: v8 = sub_6226C(a1-&gt;field_10, v3); goto LABEL_17; case 0x18u: v8 = sub_63530(a1-&gt;field_14); LABEL_17: v6 = 0; if ( v8 ) { *a2 = 0; v6 = v8; } return v6; default: LOWORD(v5) = 28032; goto LABEL_5; } } } } LOWORD(v5) = -27504; LABEL_5: HIWORD(v5) = 13; v6 = 0; *a2 = v5; return v6; }</span></span></code> </pre> <br>  El campo con el valor 3 previamente asignado se cambia como par谩metro de cambio.  Echemos un vistazo al caso 3: los par谩metros que la funci贸n anterior agregada a la estructura (es decir, la clave y los datos cifrados) se transfieren a la funci贸n sub_6364C.  Si observamos de cerca sub_6364C, podemos reconocer el algoritmo RC4. <br><br>  Entonces tenemos un algoritmo y una clave.  Intentemos descifrar el nombre de la clase.  Esto es lo que tenemos: com / taobao / wireless / security / adapter / JNICLibrary.  Brillante!  Estamos en el buen camino. <br><br><h3>  rbol de comando </h3><br>  Ahora necesitamos encontrar la llamada a <i>RegisterNatives</i> , que nos <i>indicar谩 la</i> funci贸n <i>doCommandNative</i> .  Entonces miramos a trav茅s de las funciones llamadas desde <i>JNI_OnLoad</i> , y lo encontramos en <i>sub_B7B0</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_B7F6</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *env, jclass clazz)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> signature[<span class="hljs-number"><span class="hljs-number">41</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// [sp+7h] [bp-55h] char name[16]; // [sp+30h] [bp-2Ch] JNINativeMethod method; // [sp+40h] [bp-1Ch] int v8; // [sp+4Ch] [bp-10h] v8 = *(_DWORD *)off_8AC00; decryptString((unsigned __int8 *)&amp;unk_83ED9, (unsigned __int8 *)name, 0x10u);// doCommandNative decryptString((unsigned __int8 *)&amp;unk_83EEA, (unsigned __int8 *)signature, 0x29u);// (I[Ljava/lang/Object;)Ljava/lang/Object; method.name = name; method.signature = signature; method.fnPtr = sub_B69C; return ((int (__fastcall *)(JNIEnv *, jclass, JNINativeMethod *, int))(*env)-&gt;RegisterNatives)(env, clazz, &amp;method, 1) &gt;&gt; 31; }</span></span></code> </pre> <br>  Y, de hecho, un m茅todo nativo con el nombre <i>doCommandNative</i> est谩 registrado aqu铆.  Ahora sabemos su direcci贸n.  Echemos un vistazo a lo que hace. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doCommandNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *env, jobject obj, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> command, jarray args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v5; <span class="hljs-comment"><span class="hljs-comment">// r5 struc_2 *a5; // r6 int v9; // r1 int v11; // [sp+Ch] [bp-14h] int v12; // [sp+10h] [bp-10h] v5 = 0; v12 = *(_DWORD *)off_8AC00; v11 = 0; a5 = (struc_2 *)malloc(0x14u); if ( a5 ) { a5-&gt;field_0 = 0; a5-&gt;field_4 = 0; a5-&gt;field_8 = 0; a5-&gt;field_C = 0; v9 = command % 10000 / 100; a5-&gt;field_0 = command / 10000; a5-&gt;field_4 = v9; a5-&gt;field_8 = command % 100; a5-&gt;field_C = env; a5-&gt;field_10 = args; v5 = sub_9D60(command / 10000, v9, command % 100, 1, (int)a5, &amp;v11); } free(a5); if ( !v5 &amp;&amp; v11 ) sub_7CF34(env, v11, &amp;byte_83ED7); return v5; }</span></span></code> </pre> <br>  El nombre sugiere que es el punto de entrada para todas las funciones que los desarrolladores transfirieron a la biblioteca nativa.  Estamos espec铆ficamente interesados en la funci贸n n煤mero 10601. <br><br>  Del c贸digo, podemos ver que el n煤mero de comando nos da tres n煤meros: comando / 10000, comando% 10000/100 y comando% 10 (en nuestro caso, 1, 6 y 1).  Estos tres n煤meros, as铆 como el puntero a JNIEnv y los argumentos transferidos a la funci贸n, forman una estructura y se transmiten.  Con estos tres n煤meros (los denominaremos N1, N2 y N3), se construye un 谩rbol de comandos.  Algo como esto: <br><br><img src="https://habrastorage.org/webt/xg/jk/l1/xgjkl1uhzmibo-nhmha3kpivf5a.png"><br><br>  El 谩rbol se crea din谩micamente en JNI_OnLoad.  Tres n煤meros codifican la ruta en el 谩rbol.  Cada hoja del 谩rbol contiene la direcci贸n xorred de la funci贸n correspondiente.  La clave est谩 en el nodo principal.  Es bastante f谩cil encontrar un lugar en el c贸digo donde la funci贸n que necesitamos se agrega al 谩rbol si entendemos todas las estructuras all铆 (no pasaremos tiempo describi茅ndolas en este art铆culo). <br><br><h3>  M谩s ofuscaci贸n </h3><br>  Tenemos la direcci贸n de la funci贸n que se supone que descifra el tr谩fico: 0x5F1AC.  Pero todav铆a es demasiado pronto para relajarse: los desarrolladores del navegador UC tienen otra sorpresa para nosotros. <br><br>  Despu茅s de recibir los par谩metros de una matriz en el c贸digo Java, vamos a la funci贸n en 0x4D070.  Otro tipo de ofuscaci贸n de c贸digo ya est谩 esperando. <br><br>  Luego empujamos dos 铆ndices en R7 y R4: <br><br><img src="https://habrastorage.org/webt/7i/fx/86/7ifx86mr4yph41jsxukpjqvxmfa.png"><br><br>  El primer 铆ndice se mueve a R11: <br><br><img src="https://habrastorage.org/webt/fa/62/6j/fa626jaylcaaewtslff_-byaseo.jpeg"><br><br>  Usamos este 铆ndice para obtener la direcci贸n de la tabla: <br><br><img src="https://habrastorage.org/webt/co/rk/s1/corks1o2dp75elfvdsxjimrohuo.png"><br><br>  Despu茅s de transferir a la primera direcci贸n, usamos el segundo 铆ndice de R4.  La tabla contiene 230 elementos. <br><br>  驴Qu茅 hacemos con eso?  Podr铆amos decirle a la AIF que es una especie de cambio: Editar -&gt; Otro -&gt; Especificar modismo de cambio. <br><br><img src="https://habrastorage.org/webt/36/uu/xn/36uuxnabf3xesptr8qisxzzfutk.jpeg"><br><br>  El c贸digo resultante es horrendo.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin embargo, podemos ver la llamada a la </font><font style="vertical-align: inherit;">funci贸n </font><font style="vertical-align: inherit;">familiar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sub_6115C</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en sus enredos: </font></font><br><br><img src="https://habrastorage.org/webt/-d/pt/3a/-dpt3akb_yckinmdheczkktzlem.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estaba el par谩metro de cambio con el descifrado RC4 en el caso 3. En este caso, la estructura que se transfiere a la funci贸n se llena con los par谩metros transferidos a doCommandNative. Recordamos que ten铆amos magicInt con valor 16. Observamos el caso correspondiente y despu茅s de varias transiciones, encontramos el c贸digo que nos ayuda a identificar el algoritmo. </font></font><br><br><img src="https://habrastorage.org/webt/rn/_1/i4/rn_1i4avl8oki83hslk5u19ygoe.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es AES!</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tenemos un algoritmo y solo necesitamos obtener sus par谩metros, como el modo, la clave y (posiblemente) el vector de inicializaci贸n (su presencia depende del modo de operaci贸n del algoritmo AES). </font><font style="vertical-align: inherit;">La estructura que los contiene debe crearse en alg煤n lugar antes de llamar a la funci贸n sub_6115C. </font><font style="vertical-align: inherit;">Pero dado que esta parte del c贸digo est谩 particularmente bien ofuscada, decidimos parchear el c贸digo para que todos los par谩metros de la funci贸n de descifrado se puedan volcar en un archivo.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parche </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si no desea escribir manualmente todo el c贸digo de parche en el lenguaje ensamblador, puede ejecutar Android Studio, codificar una funci贸n que recibe los mismos par谩metros que nuestra funci贸n de descifrado y escribe en el archivo, luego copie el c贸digo resultante generado por el compilador </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuestros buenos amigos del equipo de UC Browser tambi茅n "aseguraron" la conveniencia de agregar c贸digo. Recordamos que tenemos un c贸digo basura al comienzo de cada funci贸n, que puede reemplazarse f谩cilmente con cualquier otro c贸digo. Muy conveniente :) Sin embargo, no hay suficiente espacio al comienzo de la funci贸n de destino para el c贸digo que guarda todos los par谩metros en un archivo. Tuvimos que dividirlo en partes y usar los bloques de basura de las funciones vecinas. Tenemos cuatro partes en total. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primera parte:</font></font><br><br><img src="https://habrastorage.org/webt/hy/lk/qr/hylkqrhqgyei6qjdj6ayvgivpqu.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los primeros cuatro par谩metros de funci贸n en la arquitectura ARM se indican en los registros R0-R3, mientras que el resto, si lo hay, pasa por la pila. El registro LR indica la direcci贸n de retorno. Necesitamos guardar todos estos datos para que la funci贸n pueda funcionar despu茅s de volcar sus par谩metros. Tambi茅n necesitamos guardar todos los registros que usamos en el proceso, por lo que usamos PUSH.W {R0-R10, LR}. En R7, obtenemos la direcci贸n de la lista de par谩metros transferidos a la funci贸n a trav茅s de la pila.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando la funci贸n fopen, abrimos el archivo / data / local / tmp / aes en el modo "ab" (para poder agregar algo). Luego cargamos la direcci贸n del nombre del archivo en R0 y la direcci贸n de la cadena que indica el modo en R1. Aqu铆 es donde termina el c贸digo basura, por lo que navegamos a la siguiente funci贸n. Como queremos que contin煤e funcionando, colocamos la transici贸n al c贸digo de funci贸n real al principio, antes de la basura, y reemplazamos la basura con el resto del parche. </font></font><br><br><img src="https://habrastorage.org/webt/68/ss/kf/68sskfcymjorl_flpf8mg9wwej4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luego llamamos a fopen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los primeros tres par谩metros de la funci贸n aes son del tipo int. Como empujamos los registros a la pila al principio, simplemente podemos transferir sus direcciones en la pila a la funci贸n fwrite.</font></font><br><br><img src="https://habrastorage.org/webt/d1/yt/iz/d1ytiz_jx7byflntqxxec2nece0.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A continuaci贸n, tenemos tres estructuras que indican el tama帽o de los datos y contienen un puntero a los datos para la clave, el vector de inicializaci贸n y los datos cifrados. </font></font><br><br><img src="https://habrastorage.org/webt/me/vy/kz/mevykztpkcwdr6xkpnenauxqccs.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al final, cerramos el archivo, restauramos los registros y devolvemos el control a la funci贸n aes real.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compilamos el archivo APK con la biblioteca parcheada, lo firmamos, lo descargamos en un dispositivo o emulador y lo ejecutamos. Ahora vemos que el volcado se ha creado con muchos datos. El navegador no solo descifra el tr谩fico, sino tambi茅n otros datos, y todo el descifrado se realiza a trav茅s de esta funci贸n. Por alguna raz贸n, no vemos los datos que necesitamos, y la solicitud que esperamos no es visible en el tr谩fico. Saltemos la espera hasta que UC Browser tenga la oportunidad de hacer esta solicitud y tome la respuesta encriptada obtenida anteriormente del servidor para parchear la aplicaci贸n nuevamente. Agregaremos el descifrado a onCreate de la actividad principal.</font></font><br><br><pre> <code class="plaintext hljs"> const/16 v1, 0x62 new-array v1, v1, [B fill-array-data v1, :encrypted_data const/16 v0, 0x1f invoke-static {v0, v1}, Lcom/uc/browser/core/d/c/g;-&gt;j(I[B)[B move-result-object v1 array-length v2, v1 invoke-static {v2}, Ljava/lang/String;-&gt;valueOf(I)Ljava/lang/String; move-result-object v2 const-string v0, "ololo" invoke-static {v0, v2}, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo compilamos, firmamos, instalamos y ejecutamos. </font><font style="vertical-align: inherit;">Por lo tanto, obtenemos una NullPointerException ya que el m茅todo devuelve un valor nulo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu茅s de analizar m谩s el c贸digo, encontramos una funci贸n con cadenas bastante interesantes: "META-INF /" y ".RSA". </font><font style="vertical-align: inherit;">Parece que la aplicaci贸n verifica su certificado, o incluso genera claves a partir de 茅l. </font><font style="vertical-align: inherit;">Realmente no queremos profundizar en lo que est谩 sucediendo con el certificado, as铆 que solo demos el certificado correcto. </font><font style="vertical-align: inherit;">Aplicaremos un parche a la cadena encriptada, por lo que en lugar de "META-INF /" obtenemos "BLABLINF /", creamos una carpeta con este nombre en el archivo APK y guardamos el certificado del navegador. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo compilamos, firmamos, instalamos y ejecutamos. </font><font style="vertical-align: inherit;">Bingo! </font><font style="vertical-align: inherit;">Tenemos la llave!</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mitm </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora tenemos la clave y un vector de inicializaci贸n igual. Intentemos descifrar la respuesta del servidor en el modo CBC. </font></font><br><br><img src="https://habrastorage.org/webt/9k/m7/un/9km7unymy_ybx1lwnflfbqd36ke.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vemos la URL del archivo, algo as铆 como MD5, "extract_unzipsize" y un n煤mero. D茅janos comprobarlo. El MD5 del archivo es el mismo; El tama帽o de la biblioteca descomprimida es el mismo. Ahora intentaremos parchear esta biblioteca y transmitirla al navegador. Para mostrar que nuestra biblioteca parcheada se ha cargado, crearemos una intenci贸n para crear el mensaje de texto "PWNED!" Reemplazaremos dos respuestas del servidor: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puds.ucweb.com/upgrade/index.xhtml</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y la que solicita la descarga del archivo. En el primero, sustituimos MD5 (el tama帽o sigue siendo el mismo despu茅s de descomprimir); En el segundo, enviamos el archivo con la biblioteca parcheada.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El navegador realiza varios intentos de descargar el archivo, lo que genera un error. </font><font style="vertical-align: inherit;">Aparentemente, algo sospechoso est谩 sucediendo all铆. </font><font style="vertical-align: inherit;">Analizando este formato extra帽o, descubrimos que el servidor tambi茅n transmite el tama帽o del archivo: </font></font><br><br><img src="https://habrastorage.org/webt/e2/-v/ua/e2-vuahng86h0bt0vm84f3xhqrg.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est谩 codificado con LEB128. </font><font style="vertical-align: inherit;">El parche cambia ligeramente el tama帽o de la biblioteca comprimida, por lo que el navegador decidi贸 que el archivo se rompi贸 con la descarga y mostr贸 un error despu茅s de varios intentos. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As铆 que arreglamos el tama帽o del archivo y ... 隆voil谩! </font><font style="vertical-align: inherit;">:) Ver el resultado en el video.</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Nfns7uH03J8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Consecuencias y respuesta del desarrollador. </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Del mismo modo, los piratas inform谩ticos pueden utilizar esta caracter铆stica insegura del navegador UC para distribuir y lanzar bibliotecas maliciosas. Estas bibliotecas funcionar谩n en el contexto del navegador, dando como resultado privilegios completos del sistema que tiene el navegador. Esto les otorga un reinado gratuito para mostrar ventanas de phishing, as铆 como acceso a los archivos de trabajo del navegador, incluidos inicios de sesi贸n, contrase帽as y cookies en la base de datos.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contactamos a los desarrolladores de UC Browser y les informamos sobre el problema que hab铆amos encontrado, tratamos de se帽alar la vulnerabilidad y su peligro, pero se negaron a discutir el asunto. Mientras tanto, el navegador con la funci贸n peligrosa permaneci贸 a la vista. Aunque tan pronto como revelamos los detalles de la vulnerabilidad, era imposible ignorarla como antes. El 27 de marzo se lanz贸 una nueva versi贸n del UC Browser 10.10.9.1193, que accedi贸 al servidor a trav茅s de HTTPS </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puds.ucweb.com/upgrade/index.xhtml</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Adem谩s, entre la "correcci贸n de errores" y el momento en que escribimos este art铆culo, un intento de abrir un PDF en el navegador result贸 en un mensaje de error con el texto "Vaya, algo est谩 mal". </font><font style="vertical-align: inherit;">No se solicit贸 al servidor al intentar abrir el archivo PDF. </font><font style="vertical-align: inherit;">Sin embargo, esto se realiz贸 al inicio, lo que es una se帽al de que la capacidad de descargar el c贸digo ejecutable en violaci贸n de las pol铆ticas de Google Play todav铆a est谩 presente.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/452076/">https://habr.com/ru/post/452076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452064/index.html">Configuraci贸n y archivos de estado deseado de PowerShell: Parte 1. Configuraci贸n de DSC Pull Server para trabajar con la base de datos SQL</a></li>
<li><a href="../452066/index.html">Excelsior JET suspende el desarrollo de su compilador AOT despu茅s de 18 a帽os de trabajo</a></li>
<li><a href="../452068/index.html">12. Check Point Getting Started R80.20. Registros e informes</a></li>
<li><a href="../452072/index.html">Implementamos CircularRevealAnimation en Flutter y simult谩neamente publicamos la biblioteca en pub.dev</a></li>
<li><a href="../452074/index.html">El primer juego sobre la unidad o lo que me llev贸 seis meses.</a></li>
<li><a href="../452078/index.html">Reserva de Kubernetes: existe</a></li>
<li><a href="../452082/index.html">Flujo flexible de actualizaciones en la aplicaci贸n: acelerar el proceso de actualizaci贸n de aplicaciones en Android</a></li>
<li><a href="../452086/index.html">Qu茅 hay en mi p铆xel para ti: crear nanop铆xeles usando metasuperficies de plasm贸n</a></li>
<li><a href="../452088/index.html">Reconocimiento de carreteras mediante segmentaci贸n sem谩ntica.</a></li>
<li><a href="../452090/index.html">Crear un generador de rompecabezas procesal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>