<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè≥Ô∏è üìÉ üëºüèª Experi√™ncia na integra√ß√£o de caixa Atol com negocia√ß√£o pr√≥pria de CRM üç∏ üíÄ üíö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recentemente, nas bilheterias on-line, muita emo√ß√£o, em 1¬∫ de julho de 2019, o √∫ltimo adiamento termina, ent√£o tive que lidar com esse problema. Aquel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Experi√™ncia na integra√ß√£o de caixa Atol com negocia√ß√£o pr√≥pria de CRM</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457684/">  Recentemente, nas bilheterias on-line, muita emo√ß√£o, em 1¬∫ de julho de 2019, o √∫ltimo adiamento termina, ent√£o tive que lidar com esse problema.  Aqueles que possuem 1C ou outro sistema, especialmente, n√£o podem se esfor√ßar, mas se voc√™ tiver seu pr√≥prio sistema auto-escrito, a integra√ß√£o com caixas registradoras on-line tamb√©m cair√° sobre seus ombros. <br><br>  Minha experi√™ncia √© √∫til para integra√ß√£o com caixas eletr√¥nicos da Atol no modo de troca de dados de rede, seu programa pode enviar dados para o servidor da web da Atol tanto no host local quanto na rede local; voc√™ pode envi√°-los at√© pelo navegador AJAX, ou pelo servidor via CURL, portanto, n√£o importa em que idioma seu software corporativo esteja escrito, tudo √© multiplataforma. <br><a name="habracut"></a><br>  Eu me deparei com a bilheteria do Atol 30f - √© uma m√°quina de escrever t√£o simples com uma caixa preta (FN), √© perfeita quando toda a l√≥gica do pedido est√° em software externo, e n√£o no software embutido na caixa.  Al√©m disso, dispositivos desse tipo s√£o relativamente baratos, em compara√ß√£o com os equivalentes do Android. <br><br>  Eu tamb√©m gostaria de observar que os ‚Äúespecialistas‚Äù de algumas empresas envolvidas no suporte n√£o sabem que o Atoll da vers√£o 10 possui um servidor da web embutido no driver que aceita trabalhos JSON; al√©m disso, esse driver tamb√©m pode ser instalado no Linux, julgando pelo n√∫mero de solu√ß√µes prontas nas framboesas, posso assumir que tamb√©m pode ser instalado l√°, na distribui√ß√£o da 10¬™ vers√£o do driver, o instalador do bra√ßo est√° presente. <br><br>  O esquema planejado √© mais ou menos assim: existe um CRM que roda no servidor da rede local, √© aberto a partir de navegadores, a partir do servidor, as verifica√ß√µes ser√£o enviadas ao PHP por meio de curl e impressas na caixa registradora.  E o pr√≥prio caixa eletr√¥nico est√° conectado a qualquer computador no Windows na mesma rede. <br><br>  Eles dizem que, se voc√™ n√£o ativar o caixa, ele poder√° funcionar no modo impressora e imprimir que o cheque √© inv√°lido, mas n√£o pude verificar, tive que fazer um centavo de vendas e devolu√ß√µes. <br><br>  O driver da d√©cima vers√£o √© baixado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Antes da instala√ß√£o, √© necess√°rio instalar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Java com</a> a mesma profundidade de bits que o driver, caso contr√°rio, o servidor Web da caixa de sele√ß√£o n√£o estar√° dispon√≠vel, se voc√™ instalar o driver KKT de 64 bits e, em seguida, o Java x64. <br><br>  Parece que, logicamente, voc√™ precisa instalar um driver de 64 bits em um sistema de 64 bits, mas alguns softwares de 32 bits n√£o poder√£o trabalhar com ele (como isso se aplica ao 1C se for de 32 bits). <br><br><img src="https://habrastorage.org/webt/nf/fn/uk/nffnukvhkzk3za8vpcrn567wygi.png"><br><br>  No final da instala√ß√£o, h√° uma marca de sele√ß√£o - para configurar o servidor da Web, se n√£o estiver instalado, √© necess√°rio acessar o navegador em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">127.0.0.1</a> : 16732 / settings, marque a caixa "ativar servidor" e salve. <br><br><img src="https://habrastorage.org/webt/gv/fm/9l/gvfm9lfbrzxyntshlyhn7fmx-pc.png"><br><br><img src="https://habrastorage.org/webt/dy/so/pq/dysopqgomkepetfvn-de5vgdj3q.png"><br><br>  Depois disso, voc√™ precisa reiniciar o servidor atrav√©s de START-&gt; ATOL-&gt; restart ... <br><br>  Tamb√©m quero avisar imediatamente que, se voc√™ iniciar o servidor da Web, os aplicativos locais n√£o poder√£o acessar o CCP, trabalho por muito tempo, instalo o driver, execute o teste do driver do Cct e ele me diz que a porta est√° ocupada e √© isso, liguei para o suporte t√©cnico do vendedor local eles disseram que n√£o sabemos o que fazer, ent√£o sobrecarreguei o computador dez vezes, reinstalei o driver, nada ajuda. <br><br>  Em geral, depois de ativar e reiniciar o servidor, e antes disso, voc√™ desligou o servidor e verificou a impress√£o de texto sem formata√ß√£o pelo utilit√°rio fornecido, ou apenas verificou a conex√£o, pode prosseguir. <br><br>  Esse servi√ßo web n√£o possui nenhuma prote√ß√£o por senha; portanto, voc√™ precisa configurar imediatamente o firewall do Windows ou outro software para que apenas os computadores necess√°rios possam acessar a porta 16732; na minha situa√ß√£o, este √© o servidor no qual o CRM est√° sendo executado. <br><br>  <b>A comunica√ß√£o com o servi√ßo da web geralmente √© um t√≥pico separado, muito interessante ...</b> <br><br><ol><li>  Gere um uuid exclusivo para o trabalho </li><li>  Enviamos a tarefa usando o m√©todo POST </li><li>  Estamos travando no servi√ßo da web, aguardando o resultado da tarefa com nosso UUID, pode ser que por alguns segundos nossa tarefa tenha um status de espera ou um erro poder√° ocorrer se algo estiver errado na solicita√ß√£o ... </li></ol><br>  Depois, darei uma vers√£o de trabalho, adequada para situa√ß√µes em que o pagamento √© apenas um m√©todo, e n√£o tanto em dinheiro e em parte, mas tamb√©m usa o sistema tribut√°rio padr√£o, o IVA ainda n√£o foi calculado, eu queria adicionar o c√≥digo e distribu√≠-lo, mas Acho que ainda existem pessoas que precisam dessas informa√ß√µes antes de 1¬∫ de julho do que depois.  Devo dizer imediatamente que a classe precisa de refinamento, muito processamento bruto e sem erros, tudo foi feito em algumas horas sem levar em conta a leitura da documenta√ß√£o, esse c√≥digo √© mais um exemplo e eu aconselho voc√™ a estudar a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> em detalhes e adapt√°-la aos seus processos espec√≠ficos. <br><br><div class="spoiler">  <b class="spoiler_title">c√≥digo php para um exemplo de trabalho com API (usado apenas para fins educacionais)</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">Class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AtolWebDriver</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $addr=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>,$port=<span class="hljs-string"><span class="hljs-string">"16732"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $timeout = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  public $operator; function __construct($addr=false,$port=false) { if ($addr!==false) $this-&gt;addr=$addr; if ($port!==false) $this-&gt;port=$port; } public function CallAPI($method, $data,$_url="/requests") { $url = "http://".$this-&gt;addr.":".$this-&gt;port.$_url; $curl = curl_init($url); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); curl_setopt($curl,CURLOPT_TIMEOUT, $this-&gt;timeout); $headers = ['Content-Type: application/json']; curl_setopt($curl,CURLOPT_HTTPHEADER, $headers); curl_setopt($curl, CURLOPT_CUSTOMREQUEST, $method); curl_setopt($curl, CURLOPT_POSTFIELDS, json_encode($data)); $resp = curl_exec($curl); $data = json_decode($resp,1); $code = curl_getinfo($curl, CURLINFO_HTTP_CODE); curl_close($curl); $res= [$data,$code,$resp]; print_r($res); return $res; } //   public function get_res($uuid) { $ready = false; $cnt=0; $res_url = '/requests/'.$uuid; while (!$ready &amp;&amp; ++$cnt&lt;60) { usleep(500000); // ,     list($res,$code,$resp) = $this-&gt;CallAPI('GET',[],$res_url); $ready = ($res['results'][0]['status'] == 'ready'); if ($ready) return $res; } return false; //    } //  public function add_req($uuid,$req) { return $this-&gt;CallAPI('POST', ['uuid'=&gt;$uuid,'request'=&gt;$req]); } //  id   public function gen_uuid() { return exec('uuidgen -r'); } //      public function atol_task($type,$req=[]) { $req['type'] = $type; $uuid = $this-&gt;gen_uuid(); $req = $this-&gt;add_req($uuid,$req); if ($req[1]!='201') return false; //  $res = $this-&gt;get_res($uuid); //  if ($res===false || !isset($res['results'][0])) return false; return $res['results'][0]; } /*    */ //  public function get_shift_status() { $res = $this-&gt;atol_task('getShiftStatus'); if ($res===false) return false; //closed / opened / expired return $res['result']['shiftStatus']['state']; } //  public function open_shift() { $status = $this-&gt;get_shift_status(); //e ,    if ($status=="expired") $this-&gt;close_shift(); if ($status=="opened") return "    "; $res = $this-&gt;atol_task('openShift',['operator'=&gt;$this-&gt;operator]); } //  public function close_shift() { $status = $this-&gt;get_shift_status(); if ($status=="closed") return "    "; $res = $this-&gt;atol_task('closeShift',['operator'=&gt;$this-&gt;operator]); } public function items_prepare($items) { $res_items = []; $summ = 0; while ($item = array_shift($items)) { $res_item = $item; if (!isset($item['type'])) $res_item['type']="position"; if (isset($item['price']) &amp;&amp; isset($item['quantity'])) { $res_item['amount'] = $item['price']*$item['quantity']; $res_item['tax'] = ['type'=&gt;'none']; $summ+=$res_item['amount']; } $res_items[] = $res_item; } return [$res_items,$summ]; } // sell,  sellReturn public function fiskal($type_op="sell",$items,$pay_type="cash") { $data = []; $data['operator'] = $this-&gt;operator; $data['payments'] = []; list($data['items'],$summ) = $this-&gt;items_prepare($items); //+++       $data['payments'][] = ['type'=&gt;$pay_type,'sum'=&gt;$summ]; $res = $this-&gt;atol_task($type_op,$data); } } //  ip   web-  ,      $atol = new AtolWebDriver('192.168.100.10'); //    $atol-&gt;operator = ['name'=&gt;'.']; //       $items = []; $items[] = ['name'=&gt;' ','price'=&gt;0.7,'quantity'=&gt;1]; $items[] = ['name'=&gt;' ','price'=&gt;0.4,'quantity'=&gt;1]; //  $atol-&gt;open_shift(); //  $atol-&gt;fiskal("sell",$items); sleep(10); // ,     //     , ..    $atol-&gt;fiskal("sellReturn",$items); //     sleep(20); // ,   $atol-&gt;close_shift();</span></span></code> </pre> <br></div></div><br>  Existem algumas falhas aqui que eu vou corrigir <br><br><ol><li>  Fra√ß√µes de arredondamento ao calcular os valores, voc√™ precisa arredondar para centavos, caso contr√°rio, voc√™ pode obter 1.000000001 ou 0.999999999 </li><li>  Com a grafia correta do restante da l√≥gica do programa, isso geralmente n√£o ocorre, mas durante os testes me deparei com o fato de que a tarefa retornou um resultado de erro e eu estava esperando por pronto </li></ol><br>  Bem, no processo de implementa√ß√£o, tenho medo de detectar muitos outros erros, por exemplo, se uma tarefa travar por muito tempo no status de espera, √© melhor remov√™-la da fila, caso contr√°rio, as tarefas subseq√ºentes ficar√£o suspensas por v√°rios minutos, eu peguei uma falha uma vez, n√£o esperava que ela fosse impressa e aqui estou, mas ele pulou e imprimiu imediatamente dois cheques seguidos enviados anteriormente ... <br><br>  Em geral, √© poss√≠vel coletar aquisi√ß√µes no site no futuro, se elas n√£o tiverem verifica√ß√µes on-line, at√© que voc√™ decida qual aquisi√ß√£o se danificar.  Mas a solu√ß√£o √© que, mais provavelmente como uma id√©ia para uma solu√ß√£o, o tempo dir√° como essa bilheteria se enraizar√°. <br><br>  <b>Aviso</b> , para quem l√™ o artigo de forma desatenta e n√£o √© muito competente na quest√£o da seguran√ßa - <b>este servi√ßo da Web n√£o possui criptografia (https), n√£o possui autoriza√ß√£o</b> , mesmo que seja usado apenas na rede local - configure a prote√ß√£o para acesso √† porta. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt457684/">https://habr.com/ru/post/pt457684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt457652/index.html">Como organizar 120.000 fotos e para que n√£o haja tryndets, com diferentes n√≠veis de acesso, para a equipe</a></li>
<li><a href="../pt457658/index.html">Uni√£o MS-11: Um acidente que n√£o existia?</a></li>
<li><a href="../pt457660/index.html">Como economizar US $ 58 em 5 minutos: vamos usar pre√ßos diferentes em cada pa√≠s em rela√ß√£o aos profissionais de marketing</a></li>
<li><a href="../pt457666/index.html">Alternativas ao Raspberry Pi</a></li>
<li><a href="../pt457680/index.html">Instala√ß√£o m√≠nima do CentOS / Fedora / RedHat</a></li>
<li><a href="../pt457686/index.html">Como o Sberbank obt√©m consentimento para o processamento biom√©trico</a></li>
<li><a href="../pt457690/index.html">V√≠deo paran√≥ico de Yandex.Money metap</a></li>
<li><a href="../pt457692/index.html">Reflex√µes sobre os padr√µes nacionais de NB-Fi e sistemas de cobran√ßa</a></li>
<li><a href="../pt457694/index.html">Os perigos do uso de constantes com v√°rios caracteres</a></li>
<li><a href="../pt457696/index.html">Os perigos do uso de constantes com v√°rios caracteres</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>