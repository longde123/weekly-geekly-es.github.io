<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèº ‚õëÔ∏è ‚ôëÔ∏è Mani√®re s√©curis√©e d'√©changer JWT dans ASP.NET Core + SPA üçç üßü üéÖüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A.  Entr√©e 
 L'authentification JWT (JSON Web Token) est un m√©canisme d'authentification et d'authentification assez uniforme et coh√©rent entre le ser...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mani√®re s√©curis√©e d'√©changer JWT dans ASP.NET Core + SPA</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468401/">  A. <h2>  Entr√©e </h2><br>  L'authentification JWT (JSON Web Token) est un m√©canisme d'authentification et d'authentification assez uniforme et coh√©rent entre le serveur et les clients.  L'avantage de JWT est qu'il nous permet de g√©rer moins l'√©tat et √©volue bien.  Il n'est pas surprenant que l'autorisation et l'authentification avec son aide soient de plus en plus utilis√©es dans les applications Web modernes. <br><a name="habracut"></a><br>  Lors du d√©veloppement d'applications avec JWT, la question se pose souvent: o√π et comment est-il recommand√© de stocker le jeton?  Si nous d√©veloppons une application Web, nous avons deux des options les plus courantes: <br><br><ul><li>  Stockage Web HTML5 (localStorage ou sessionStorage) <br></li><li>  Les cookies <br></li></ul><br>  En comparant ces m√©thodes, nous pouvons dire qu'elles stockent toutes les deux les valeurs dans le navigateur du client, qu'elles sont assez faciles √† utiliser et repr√©sentent un stockage r√©gulier de paires cl√©-valeur.  La diff√©rence r√©side dans l'environnement de stockage. <br><br>  Le stockage Web (localStorage / sessionStorage) est accessible via JavaScript dans le m√™me domaine.  Cela signifie que tout code JavaScript dans votre application a acc√®s √† Web Storage, ce qui cr√©e une vuln√©rabilit√© aux attaques de script intersite (XSS).  En tant que moteur de stockage, Web Storage ne fournit aucun moyen de s√©curiser vos donn√©es pendant le stockage et le partage.  Nous ne pouvons l'utiliser que pour les donn√©es auxiliaires que nous souhaitons conserver lors de la mise √† jour (F5) ou de la fermeture de l'onglet: √©tat et num√©ro de page, filtres, etc. <br><br>  Les jetons peuvent √©galement √™tre transmis via les cookies du navigateur.  Les cookies utilis√©s avec le drapeau <b>httpOnly</b> ne <b>sont</b> pas affect√©s par XSS.  httpOnly est un indicateur d'acc√®s √† la lecture, √† l'√©criture et √† la suppression des cookies uniquement sur le serveur.  Ils ne seront pas accessibles via JavaScript sur le client, donc le client ne sera pas au courant du jeton et l'autorisation sera enti√®rement trait√©e c√¥t√© serveur. <br><br>  Nous pouvons √©galement d√©finir un indicateur <b>s√©curis√©</b> pour garantir que les cookies ne sont transmis que via HTTPS.  Compte tenu de ces avantages, mon choix s'est port√© sur les cookies. <br><br>  Cet article d√©crit une approche pour impl√©menter l'authentification et l'authentification √† l'aide de cookies s√©curis√©s httpOnly + jeton Web JSON dans ASP.NET Core Web Api en conjonction avec SPA.  L'option est consid√©r√©e dans laquelle le serveur et le client sont d'origine diff√©rente. <br><br><h2>  Configuration de votre environnement de d√©veloppement local </h2><br>  Pour configurer et d√©boguer correctement les relations client-serveur via HTTPS, je vous recommande fortement de configurer imm√©diatement l'environnement de d√©veloppement local afin que le client et le serveur disposent d'une connexion HTTPS. <br><br>  Si vous ne le faites pas tout de suite et essayez de nouer des relations sans connexion HTTPS, √† l'avenir, de nombreux d√©tails appara√Ætront sans lesquels les cookies s√©curis√©s et les politiques de s√©curit√© suppl√©mentaires en production avec HTTPS ne fonctionneront pas correctement. <br><br>  Je vais montrer un exemple de configuration de HTTPS sur OS Windows 10, serveur - ASP.NET Core, SPA - React. <br><br>  Vous pouvez configurer HTTPS dans ASP.NET Core √† l'aide de l'indicateur <u>Configurer pour HTTPS</u> lors de la cr√©ation d'un projet ou, si nous ne l'avons pas fait lors de la cr√©ation, activez l'option correspondante dans Propri√©t√©s. <br><br>  Pour configurer SPA, vous devez modifier le script pour <i>"d√©marrer"</i> , en le d√©finissant sur <i>"set HTTPS = true"</i> .  Ma configuration est la suivante: <br><br><pre><code class="bash hljs"><span class="hljs-string"><span class="hljs-string">'start'</span></span>: <span class="hljs-string"><span class="hljs-string">'set HTTPS=true&amp;&amp;rimraf ./build&amp;&amp;react-scripts start'</span></span></code> </pre> <br>  Je vous conseille de regarder la configuration de HTTPS pour l'environnement de d√©veloppement dans d'autres environnements √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://create-react-app.dev/docs/using-">create-react-app.dev/docs/using-https-in-development</a> <br><br><h2>  Configurer le serveur ASP.NET Core </h2><br><h3>  Configuration JWT </h3><br>  Dans ce cas, l'impl√©mentation la plus courante de JWT √† partir de la documentation ou de n'importe quel article, avec des <code>options.RequireHttpsMetadata = true;</code> param√®tres suppl√©mentaires.RequireHttpsMetadata <code>options.RequireHttpsMetadata = true;</code>  comme notre environnement de d√©veloppement utilise HTTPS: <br><br>  <i>ConfigureServices</i> <br><br><pre> <code class="java hljs">services.AddAuthentication(options =&gt; { options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme; options.DefaultSignInScheme = JwtBearerDefaults.AuthenticationScheme; options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme; }) .AddJwtBearer(JwtBearerDefaults.AuthenticationScheme, options =&gt; { options.RequireHttpsMetadata = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; options.SaveToken = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; options.TokenValidationParameters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TokenValidationParameters { <span class="hljs-comment"><span class="hljs-comment">//  .  }; });</span></span></code> </pre> <br><h3>  Configuration d'une strat√©gie CORS </h3><br>  <b>Important</b> : la strat√©gie <code>AllowCredentials()</code> doit contenir <code>AllowCredentials()</code> .  Cela est n√©cessaire pour recevoir une demande de <i>XMLHttpRequest.withCredentials</i> et renvoyer des cookies au client.  Plus d'informations √† ce sujet seront √©crites plus tard.  D'autres options sont configur√©es en fonction des besoins du projet. <br><br>  Si le serveur et le client sont sur la m√™me origine, alors la configuration compl√®te ci-dessous n'est pas n√©cessaire. <br><br>  <i>ConfigureServices</i> <br><br><pre> <code class="java hljs">services.AddCors();</code> </pre> <br>  <i>Configurer</i> <br><br><pre> <code class="java hljs">app.UseCors(x =&gt; x .WithOrigins(<span class="hljs-string"><span class="hljs-string">"https://localhost:3000"</span></span>) <span class="hljs-comment"><span class="hljs-comment">//    SPA  .AllowCredentials() .AllowAnyMethod() .AllowAnyHeader());</span></span></code> </pre> <br><h3>  D√©finition d'une politique de cookies </h3><br>  Forcer la politique des cookies sur httpOnly et s√©curis√©. <br><br>  Si possible, d√©finissez <code>MinimumSameSitePolicy = SameSiteMode.Strict;</code>  - Cela am√©liore la s√©curit√© des cookies pour les types d'applications qui ne d√©pendent pas du traitement des demandes d'origine crois√©e. <br><br>  <i>Configurer</i> <br><br><pre> <code class="java hljs">app.UseCookiePolicy(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CookiePolicyOptions { MinimumSameSitePolicy = SameSiteMode.Strict, HttpOnly = HttpOnlyPolicy.Always, Secure = CookieSecurePolicy.Always });</code> </pre> <br><h3>  L'id√©e d'un √©change de jetons s√©curis√© </h3><br>  Cette partie est un concept.  Nous allons faire deux choses: <br><br><ol><li>  Jetez un jeton dans une demande HTTP en utilisant httpOnly et des indicateurs s√©curis√©s. </li><li>  Recevez et validez les jetons d'application client √† partir d'une requ√™te HTTP. </li></ol><br>  Pour ce faire, nous avons besoin de: <br><br><ul><li>  √âcrivez le jeton dans le cookie httpOnly lors de la connexion et supprimez-le lors de la connexion. </li><li>  S'il y a un jeton dans les cookies, remplacez-le dans l'en-t√™te HTTP de chaque demande suivante. </li><li>  S'il n'y a pas de jeton dans les cookies, l'en-t√™te sera vide et la demande ne sera pas autoris√©e. </li></ul><br><h3>  Middleware </h3><br>  L'id√©e principale est d'impl√©menter un middleware personnalis√© pour ins√©rer un jeton dans une requ√™te HTTP entrante.  Apr√®s autorisation de l'utilisateur, nous enregistrons le cookie sous une certaine cl√©, par exemple: <i>".AspNetCore.Application.Id"</i> .  Je recommande de d√©finir un nom qui n'a rien √† voir avec l'autorisation ou les jetons - dans ce cas, un cookie avec un jeton ressemblera √† une sorte de constante syst√®me banale pour l'application AspNetCore.  Il y a donc plus de chances que l'attaquant voit de nombreuses variables syst√®me et, sans comprendre quel m√©canisme d'autorisation est utilis√©, ira plus loin.  Bien s√ªr, s'il ne lit pas cet article et ne recherche pas sp√©cifiquement une telle constante. <br><br>  Ensuite, nous devons ins√©rer ce jeton dans toutes les requ√™tes HTTP entrantes suivantes.  Pour ce faire, nous allons √©crire quelques lignes de code Middleware.  Ce n'est rien d'autre qu'un pipeline HTTP. <br><br><img src="https://habrastorage.org/webt/7e/u-/7k/7eu-7k-3ekk6f0ite96eyh_ti7m.png"><br><br>  <i>Configurer</i> <br><br><pre> <code class="java hljs">app.Use(async (context, next) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> token = context.Request.Cookies[<span class="hljs-string"><span class="hljs-string">".AspNetCore.Application.Id"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrEmpty(token)) context.Request.Headers.Add(<span class="hljs-string"><span class="hljs-string">"Authorization"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span> + token); <span class="hljs-function"><span class="hljs-function">await </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }); app.UseAuthentication();</code> </pre> <br>  Nous pouvons prendre cette logique dans un service Middleware s√©par√© afin de ne pas obstruer Startup.cs, l'id√©e ne changera pas. <br><br>  Afin d'√©crire la valeur dans les cookies, il suffit d'ajouter la ligne suivante √† la logique d'autorisation: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Succeeded) HttpContext.Response.Cookies.Append(<span class="hljs-string"><span class="hljs-string">".AspNetCore.Application.Id"</span></span>, token, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CookieOptions { MaxAge = TimeSpan.FromMinutes(<span class="hljs-number"><span class="hljs-number">60</span></span>) });</code> </pre><br>  En utilisant nos politiques de cookies, ces cookies seront automatiquement envoy√©s en tant que httpOnly et s√©curis√©s.  Pas besoin de red√©finir leur politique dans les options de cookies. <br><br>  Dans CookieOptions, vous pouvez d√©finir MaxAge pour sp√©cifier une dur√©e de vie.  Il est utile de sp√©cifier avec JWT Lifetime lors de l'√©mission du jeton afin que le cookie disparaisse apr√®s un certain temps.  D'autres propri√©t√©s de CookieOptions sont configur√©es en fonction des exigences du projet. <br><br>  Pour plus de s√©curit√©, je recommande d'ajouter les en-t√™tes suivants au middleware: <br><br><pre> <code class="java hljs">context.Response.Headers.Add(<span class="hljs-string"><span class="hljs-string">"X-Content-Type-Options"</span></span>, <span class="hljs-string"><span class="hljs-string">"nosniff"</span></span>); context.Response.Headers.Add(<span class="hljs-string"><span class="hljs-string">"X-Xss-Protection"</span></span>, <span class="hljs-string"><span class="hljs-string">"1"</span></span>); context.Response.Headers.Add(<span class="hljs-string"><span class="hljs-string">"X-Frame-Options"</span></span>, <span class="hljs-string"><span class="hljs-string">"DENY"</span></span>);</code> </pre><br><ul><li>  L'en <b>-</b> t√™te <b>X-Content-Type-Options</b> est utilis√© pour se prot√©ger contre les vuln√©rabilit√©s de reniflement MIME.  Cette vuln√©rabilit√© peut se produire lorsqu'un site permet aux utilisateurs de t√©l√©charger du contenu, mais l'utilisateur d√©guise un certain type de fichier en quelque chose d'autre.  Cela peut donner aux attaquants la possibilit√© d'ex√©cuter des scripts de script intersite ou de compromettre un site Web. </li><li>  Tous les navigateurs modernes ont des capacit√©s de filtrage XSS int√©gr√©es qui tentent de d√©tecter les vuln√©rabilit√©s XSS avant que la page ne nous soit enti√®rement affich√©e.  Par d√©faut, ils sont activ√©s dans le navigateur, mais l'utilisateur peut √™tre plus d√©licat et les d√©sactiver.  En utilisant l'en <b>-</b> t√™te <b>X-XSS-Protection</b> , nous pouvons en fait dire au navigateur d'ignorer ce que l'utilisateur a fait et d'appliquer le filtre int√©gr√©. </li><li>  <b>X-Frame-Options</b> indique au navigateur que si votre site est plac√© dans un cadre HTML, alors n'affichez rien.  Ceci est tr√®s important lorsque vous essayez de vous prot√©ger contre les tentatives de d√©tournement de clics. </li></ul><br>  J'ai d√©crit loin de tous les titres.  Il existe de nombreuses autres fa√ßons d'am√©liorer la s√©curit√© des applications Web.  Je vous conseille de vous concentrer sur la liste de contr√¥le de s√©curit√© de la ressource securityheaders.com. <br><br><h2>  Configuration du client SPA </h2><br>  Lorsque le client et le serveur sont situ√©s sur une origine diff√©rente, une configuration suppl√©mentaire est √©galement requise sur le client.  Vous devez encapsuler chaque demande √† l'aide de <i>XMLHttpRequest.withCredentials</i> . <br><br>  J'ai encapsul√© mes m√©thodes comme suit: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> axios <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"axios"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> api = axios.create({ <span class="hljs-attr"><span class="hljs-attr">baseURL</span></span>: process.env.REACT_APP_API_URL }); api.interceptors.request.use(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request</span></span></span><span class="hljs-function"> =&gt;</span></span> requestInterceptor(request)) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> requestInterceptor = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request</span></span></span><span class="hljs-function">) =&gt;</span></span> { request.withCredentials = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> api;</code> </pre> <br>  Nous pouvons envelopper notre configuration de requ√™te de n'importe quelle mani√®re, l'essentiel est que <b>withCredentials = true soit l√†</b> . <br><br>  La propri√©t√© <i>XMLHttpRequest.withCredentials</i> d√©termine si les demandes interdomaines doivent √™tre g√©n√©r√©es √† l'aide d'informations d'identification telles que les cookies, les en-t√™tes d'autorisation ou les certificats TLS. <br><br>  Cet indicateur est √©galement utilis√© pour d√©terminer si les cookies envoy√©s dans la r√©ponse seront ignor√©s.  XMLHttpRequest d'un autre domaine ne peut pas d√©finir un cookie sur son propre domaine si l'indicateur withCredentials n'est pas d√©fini sur true avant de cr√©er cette demande. <br><br>  En d'autres termes, si vous ne sp√©cifiez pas cet attribut, notre cookie ne sera pas enregistr√© par le navigateur, c'est-√†-dire  nous ne pourrons pas renvoyer le cookie au serveur, et le serveur ne trouvera pas le cookie souhait√© avec JWT et ne signera pas le Token porteur dans notre pipeline HTTP. <br><br><h2>  √Ä quoi tout cela sert-il? </h2><br>  Ci-dessus, j'ai d√©crit un moyen d'√©change de jetons r√©sistant aux XSS.  Passons en revue le r√©sultat de la fonctionnalit√© impl√©ment√©e. <br><br>  Si vous allez dans Developer Tools, nous voyons les drapeaux <b>convoit√©s httpOnly</b> and <b>secure</b> : <br><br><img src="https://habrastorage.org/webt/kd/qh/ek/kdqheko2bzbn4esbtkjthcuo7a8.png"><br><br>  Faisons un test d'√©crasement, essayons d'obtenir les cookies du client: <br><br><img src="https://habrastorage.org/webt/fh/vp/sq/fhvpsqvupevuf1p5lubho6jt-hy.png"><br><br>  Nous observons '', c'est-√†-dire  les cookies ne sont pas accessibles depuis l'espace documentaire, ce qui rend impossible leur lecture avec des scripts. <br><br>  Nous pouvons essayer d'obtenir ces cookies √† l'aide d'outils ou d'extensions suppl√©mentaires, mais tous les outils que j'ai essay√©s ont appel√© l'impl√©mentation native √† partir de l'espace document. <br><br><h2>  Projet de d√©monstration </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les instructions de d√©marrage se trouvent dans README.MD</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><br></a> <br><br><h2>  UPD: Protection contre CSRF </h2><br><h3>  Configurer le serveur ASP.NET Core </h3><br>  <i>Services middleware</i> <br><br><div class="spoiler">  <b class="spoiler_title">XsrfProtectionMiddleware.cs</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XsrfProtectionMiddleware</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly IAntiforgery _antiforgery; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly RequestDelegate _next; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">XsrfProtectionMiddleware</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RequestDelegate next, IAntiforgery antiforgery)</span></span></span><span class="hljs-function"> </span></span>{ _next = next; _antiforgery = antiforgery; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> async Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InvokeAsync</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpContext context)</span></span></span><span class="hljs-function"> </span></span>{ context.Response.Cookies.Append( <span class="hljs-string"><span class="hljs-string">".AspNetCore.Xsrf"</span></span>, _antiforgery.GetAndStoreTokens(context).RequestToken, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CookieOptions {HttpOnly = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, Secure = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, MaxAge = TimeSpan.FromMinutes(<span class="hljs-number"><span class="hljs-number">60</span></span>)}); <span class="hljs-function"><span class="hljs-function">await </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context)</span></span></span></span>; } }</code> </pre> <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">MiddlewareExtensions.cs</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MiddlewareExtensions</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IApplicationBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UseXsrfProtection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IApplicationBuilder builder, IAntiforgery antiforgery)</span></span></span><span class="hljs-function"> </span></span>=&gt; builder.UseMiddleware&lt;XsrfProtectionMiddleware&gt;(antiforgery); }</code> </pre> <br></div></div><br><br>  <i>ConfigureServices</i> <br><br><pre> <code class="java hljs">services.AddAntiforgery(options =&gt; { options.HeaderName = <span class="hljs-string"><span class="hljs-string">"x-xsrf-token"</span></span>; }); services.AddMvc();</code> </pre> <br><br>  <i>Configurer</i> <br><br><pre> <code class="java hljs">app.UseAuthentication(); app.UseXsrfProtection(antiforgery);</code> </pre> <br><h3>  Configuration du SPA </h3><br><div class="spoiler">  <b class="spoiler_title">api.axios.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> axios <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"axios"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cookie <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-cookies'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> api = axios.create({ <span class="hljs-attr"><span class="hljs-attr">baseURL</span></span>: process.env.REACT_APP_API_URL }); api.interceptors.request.use(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request</span></span></span><span class="hljs-function"> =&gt;</span></span> requestInterceptor(request)) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> requestInterceptor = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request</span></span></span><span class="hljs-function">) =&gt;</span></span> { request.headers[<span class="hljs-string"><span class="hljs-string">'x-xsrf-token'</span></span>] = cookie.load(<span class="hljs-string"><span class="hljs-string">'.AspNetCore.Xsrf'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> api;</code> </pre> <br></div></div><br><h3>  Utiliser </h3><br>  Pour prot√©ger nos m√©thodes API, vous devez ajouter l'attribut <code>[AutoValidateAntiforgeryToken]</code> pour le contr√¥leur ou <code>[ValidateAntiForgeryToken]</code> pour la m√©thode. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr468401/">https://habr.com/ru/post/fr468401/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr468389/index.html">Artyom Galonsky, Bureau de la STO du Bureau: ¬´Je suis contre une chose telle qu'un ing√©nieur DevOps¬ª</a></li>
<li><a href="../fr468393/index.html">Avec un bon microcontr√¥leur et le temps passe vite ou un oscilloscope de week-end</a></li>
<li><a href="../fr468395/index.html">Surveillance de la s√©curit√© du cloud. 2e partie</a></li>
<li><a href="../fr468397/index.html">Nouvelles du monde d'OpenStreetMap n ¬∞ 477 (09/03/2019 - 09.09.2019)</a></li>
<li><a href="../fr468399/index.html">C / C ++. Comment utiliser les ressources d'application int√©gr√©es lorsque vous travaillez dans GCC sous Linux</a></li>
<li><a href="../fr468403/index.html">Contr√¥les d'ex√©cution des applications logicielles int√©gr√©s</a></li>
<li><a href="../fr468405/index.html">Deux navigateurs entrent en quelque sorte dans la barre de d√©filement ...</a></li>
<li><a href="../fr468407/index.html">5G - une technologie susceptible de ralentir le web</a></li>
<li><a href="../fr468409/index.html">Service Workers in Slack Client: Acc√©l√©ration de t√©l√©chargement et mode hors ligne</a></li>
<li><a href="../fr468413/index.html">Acc√©l√©ration instagram.com. 2e partie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>