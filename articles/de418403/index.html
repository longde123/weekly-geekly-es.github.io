<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï∫üèø üêï üï∫üèΩ Beispiel f√ºr die Programmierung eines FPGA-Beschleunigers ü§≤üèæ üèÖ üë©‚ÄçüöÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor nicht allzu langer Zeit haben wir √ºber den neuen Selectel-Dienst gesprochen - Cloud-Hochleistungsrechnen auf FPGA-Beschleunigern . In einem neuen ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Beispiel f√ºr die Programmierung eines FPGA-Beschleunigers</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/selectel/blog/418403/"><img src="https://habrastorage.org/webt/u-/s-/li/u-s-liwcm4mufz__x0fd8yxbznk.png"><br><br>  Vor nicht allzu langer Zeit haben wir √ºber den neuen Selectel-Dienst gesprochen - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">Cloud-Hochleistungsrechnen auf FPGA-Beschleunigern</a> .  In einem neuen Artikel zu diesem Thema betrachten wir ein Beispiel f√ºr die FPGA-Programmierung zur Erstellung eines Mandelbrot-Sets, eines bekannten mathematischen Algorithmus zur Visualisierung fraktaler Bilder.  Der Artikel verwendete Material von der Site <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">Euler Project</a> . <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Anstelle des Vorworts</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mit Blick auf die Zukunft: Probieren Sie FPGA bei der Arbeit aus</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Informationen zum OpenCL-Standard f√ºr die FPGA-Programmierung</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">OpenCL-Umgebung zum Erstellen von ausf√ºhrbarem Code</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kommen Sie zum Punkt: Erstellen eines Fraktals</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fazit</a> </li></ul><br><a name="habracut"></a><br><h2>  Anstelle des Vorworts </h2><br>  Zun√§chst einige Begriffe.  Ein Computersystem mit einem FPGA-Beschleuniger - in der Regel ist dies ein PCIe-Adapter mit einem FPGA-Chip als Teil des x64-Servers.  Der Beschleuniger √ºbernimmt eine separate ressourcenintensive Aufgabe, an der paralleles Rechnen beteiligt sein kann, und f√ºhrt sie viele Gr√∂√üenordnungen schneller als der x64-Prozessor aus, entl√§dt sie und erh√∂ht die Leistung des gesamten Computersystems.  Beispielsweise kann ein Berechnungszyklus mit 100.000 Wiederholungen auf einem FPGA in nur einem Durchgang ausgef√ºhrt werden, anstatt auf einem klassischen x64-Prozessor 100.000 Mal nacheinander ausgef√ºhrt zu werden.  Logische Elemente, Hardwareressourcen, Kommunikationsverbindungen und FPGA-Chips werden vom Benutzer direkt f√ºr die Aufgabe selbst programmiert. Auf diese Weise k√∂nnen Sie die Aufgabe als Implementierung eines Algorithmus in Silizium implementieren - Algorithmus in Silizium - und dadurch eine hohe Leistung und einen sehr geringen Stromverbrauch erzielen. <br><br>  Die Schwelle f√ºr den Einstieg in die FPGA-Technologie ist heute auch f√ºr Startups durchaus zug√§nglich - ein Server mit einem FPGA-Beschleuniger und der gesamten erforderlichen Software (SDK) kann in der Selectel-Cloud zu einem angemessenen Preis gemietet werden (das sogenannte ‚ÄûCloud-FPGA‚Äú), und die Unterst√ºtzung des Open CL-Standards im FPGA f√ºhrt dazu dass ein Programmierer, der wei√ü, wie man mit C arbeitet, ein Programm auf FPGA vorbereiten und ausf√ºhren kann. <br><br><h2>  Mit Blick auf die Zukunft: Probieren Sie FPGA bei der Arbeit aus </h2><br>  Das unten beschriebene Programmierbeispiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">zum Erstellen</a> eines Mandelbrot-Sets wurde bereits auf einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">Testserver im Selectel Lab implementiert</a> , auf dem jeder seine Leistung bewerten kann (eine Registrierung ist erforderlich). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/3AxNR1jXQWg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Das Projekt wird im Code bereitgestellt und f√ºr die Kompilierung vorbereitet.  Selectel bietet Fernzugriff auf einen Server mit Intel Arria 10 FPGA-Beschleuniger.  Auf der Serverseite werden SDK- und BSP-Tools zum Entwickeln, Debuggen und Kompilieren von OpenCL, Visual Studio-Code zum Vorbereiten von Hostanwendungen (Steueranwendungen f√ºr den Zentralprozessor des Servers) bereitgestellt. <br><blockquote> Beachten Sie, dass das Beispiel selbst keinen angewendeten Wert hat und aus Gr√ºnden der Demonstration der Beschleunigungsmethoden unter Verwendung der Prinzipien der Parallelit√§t ausgew√§hlt wurde.  In diesem Beispiel lernt der Leser den Weg zum Entwerfen einer Anwendung in einem heterogenen Computersystem mit FPGA kennen. Sp√§ter kann dieser Weg verwendet werden, um Ihre eigenen Anwendungen mit parallelem Rechnen zu entwickeln. </blockquote>  <strong>UPDATE</strong> : Im Fr√ºhjahr 2018 stellte Intel den Hochleistungs-Hybridprozessor Xeon Gold 6138P mit integriertem Arria 10 FPGA-Chip vor.  Bis Ende 2018 sollen serielle Prozessoren dieses Typs √ºber Intel-Partner f√ºr Kunden verf√ºgbar sein.  Wir bei Selectel freuen uns auf diesen Chip und hoffen, als erster in Russland unseren Kunden die M√∂glichkeit zu geben, dieses einzigartige neue Produkt zu testen. <br><br><h2>  Informationen zum OpenCL-Standard f√ºr die FPGA-Programmierung </h2><br>  Der OpenCL-Standard wurde von der Khronos Group entwickelt, den weltweit f√ºhrenden Chip- und Softwareherstellern, darunter Intel, AMD, Apple, ARM, Nvidia, Sony Computer Entertainment usw. Er wurde zum Schreiben von Anwendungen entwickelt, die Parallel Computing auf verschiedenen Prozessortypen, einschlie√ülich FPGA, verwenden.  Der OpenCL-Standard enth√§lt die Programmiersprache C basierend auf der Sprachversion C99 (die neueste Version von C99 ist ISO / IEC 9899: 1999 / Cor 3: 2007 vom 15.11.2007) und eine Anwendungsprogrammierumgebung. <br><br>  Die Popularit√§t der Verwendung von OpenCL f√ºr Hochleistungsrechner beruht auf der Tatsache, dass es sich um einen offenen Standard handelt und f√ºr dessen Verwendung keine Lizenz erforderlich ist.  Dar√ºber hinaus beschr√§nkt OpenCL die Palette der unterst√ºtzten Ger√§te nicht auf eine bestimmte Marke, sodass Hardware verschiedener Hersteller auf derselben Softwareplattform verwendet werden kann. <br><blockquote><p>  Zus√§tzlich zu OpenCL: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow noopener noreferrer">Einf√ºhrung in OpenCL auf Habr</a> . </p><br></blockquote>  Ein bisschen Geschichte - die FPGA-Entwurfsroute, die vor dem OpenCL-Standard existierte, war √§u√üerst spezifisch und zeitaufw√§ndig, w√§hrend sie hinsichtlich der Komplexit√§t dem kundenspezifischen Chipdesign (ASIC, anwendungsspezifische integrierte Schaltung, "spezielle integrierte Schaltung") sogar √ºberlegen war.  Ein gr√ºndliches Verst√§ndnis der FPGA-Hardwarestruktur war erforderlich, deren Konfiguration in einer Low-Level-Hardwarebeschreibungssprache (HDL) durchgef√ºhrt werden musste.  Der Besitz dieser Entwurfs- und Verifizierungsroute war und ist eine Kunst, die aufgrund der extremen Komplexit√§t einem begrenzten Kreis von Entwicklern zur Verf√ºgung steht. <br><br>  Das Aufkommen des OpenCL-Support-Toolkits von Intel f√ºr FPGAs hat sich teilweise mit dem Problem der Zug√§nglichkeit der FPGA-Programmierung f√ºr Softwareentwickler befasst.  Der Programmierer w√§hlt unabh√§ngig den Teil seines Algorithmus aus, der f√ºr die Parallelverarbeitung geeignet ist, und beschreibt ihn in C. Anschlie√üend erstellt der Intel OpenCL-Compiler f√ºr FPGA eine bin√§re Konfigurationsdatei, um dieses Fragment des Algorithmus auf dem Beschleuniger auszuf√ºhren. <br>  Unter Verwendung der √ºblichen Visual Studio-Umgebung oder des Standard-gcc-Compilers wird eine Hostanwendung vorbereitet (eine Anwendung vom Typ .exe, die auf dem x64-Hauptprozessor ausgef√ºhrt wird), w√§hrend alle erforderlichen Unterst√ºtzungsbibliotheken im SDK enthalten sind.  Wenn die Host-Anwendung gestartet wird, wird die FPGA-Firmware geladen, die Daten werden in den Chipkern geladen und die Verarbeitung beginnt gem√§√ü dem konzipierten Algorithmus. <br><blockquote><p>  FPGA (FPGA) ist eine vom Benutzer umprogrammierbare, massiv parallele Hardwarestruktur mit Millionen von Logikelementen, Tausenden von DSP-Signalbl√∂cken und Dutzenden von Megabyte Cache f√ºr On-Board-Berechnungen, ohne auf die Hauptspeichermodule des Servers zuzugreifen.  Mit schnellen E / A-Schnittstellen (10GE, 40GE, 100GE, PCIe Gen 3 usw.) k√∂nnen Sie Daten effektiv mit dem Hauptprozessor des Servers austauschen. </p><br></blockquote>  Der OpenCL-Standard ist eine Umgebung zum Ausf√ºhren heterogener Software.  Die Umgebung besteht aus zwei separaten Teilen: <br><br><ol><li>  Host-Software - eine Anwendung, die auf dem Haupt-Zentralprozessor des Servers ausgef√ºhrt wird, in C / C ++ geschrieben ist und die OpenCL-API-Funktionen verwendet.  Der Host-Server organisiert den gesamten Rechenprozess, liefert die Quell- und Empfangsdaten und interagiert mit allen Serversystemen mit dem FPGA-Beschleuniger. </li><li>  Accelerator-Software - ein Programm, das in der OpenCL C-Sprache (C-Sprache mit einer Reihe von Einschr√§nkungen) geschrieben und f√ºr die Ausf√ºhrung auf dem FPGA-Chip kompiliert wurde. </li></ol><br>  Ein typischer Server f√ºr paralleles Rechnen ist ein x64-basierter Computer (zum Ausf√ºhren von Hostanwendungen), der einen Hardware-FPGA-Beschleuniger enth√§lt, der meistens √ºber den PCI-Express-Bus verbunden ist.  Ein solches System wird √ºbrigens im Selectel Lab vorgestellt. <br><br>  Die Programmier- und Kompilierungssequenz f√ºr den FPGA-Beschleuniger besteht aus zwei Schritten.  Der Host-Anwendungscode wird von einem Standard-Compiler (Visual C ++, GCC) kompiliert, um eine ausf√ºhrbare Datei im Server-Betriebssystem (z. B. * .exe) abzurufen.  Der Quellcode des FPGA-Beschleunigers (Kernel, Kernel) wird vom AOC-Compiler als Teil des SDK mit dem Empfang einer Bin√§rdatei (* .aocx) vorbereitet.  Diese Datei dient nur zur Beschleunigerprogrammierung. <br><br> <a href=""><img title="Architektur der OpenCL-Software-Kompilierungsma√ünahmen" src="https://habrastorage.org/getpro/habr/post_images/d7d/f21/34b/d7df2134b9135739340bced60509484c.png" alt="Architektur der OpenCL-Software-Kompilierungsumgebung" width="640" height="403"></a> <br>  Abb.  Architektur der OpenCL-Software-Kompilierungsumgebung <br><br>  Betrachten Sie einen Beispielcode zum Berechnen eines gro√üen Vektors auf zwei Arten <br>  ( <b>PS: Schie√üen Sie nicht auf den Pianisten - im Folgenden wird der Code von der Euler-Projektseite verwendet.</b> ) <br><br><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inc</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> N</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;N; i++) a[i] = a[i] + c; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... inc(a,c,N); ... }</code> </pre> <br><pre> <code class="hljs cs">_<span class="hljs-function"><span class="hljs-function">kernel </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inc</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_global </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = get_global_id(<span class="hljs-number"><span class="hljs-number">0</span></span>); a[i] = a[i] + c; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... clEnqueueNDRangeKernel(...,&amp;N,...) ... }</code> </pre> <br>  Der Code am Anfang ist ein Beispiel daf√ºr, wie eine Single-Threaded-Implementierung in C mit der Methode der sequentiellen Berechnung von Skalarelementen aussehen k√∂nnte. <br><br>  Die zweite Version des Codes ist eine m√∂gliche Implementierung des Algorithmus auf OpenCL in Form einer Funktion, die auf einem FPGA-Beschleuniger berechnet wird.  Es gibt keine Schleife und die Berechnung erfolgt in einer Iteration der Schleife.  Die Berechnung eines Vektorarrays erfolgt als Ausf√ºhrung von N Kopien dieser Funktion.  Jede Kopie hat einen eigenen Index, der in einer Schleife in den Iterator eingesetzt wird, und die Anzahl der Wiederholungsversuche wird vom Host festgelegt, wenn der Code ausgef√ºhrt wird.  Die Iteratoraktion wird von der Funktion get_global_id () bereitgestellt, die mit einem Index innerhalb von 0 ‚â§ index &lt;N arbeitet. <br><br><h2>  Kommen Sie zum Punkt: Erstellen eines Fraktals </h2><br>  Die Mandelbrot-Menge ist eine Anordnung von Punkten "c" auf der komplexen Ebene, f√ºr die die Wiederholungsrelation Zn + 1 = Zn¬≤ + c f√ºr Z0 = 0 eine begrenzte Folge definiert. <br><br>  Wir definieren Zn = Zn + IYn und auch c = p + iq. <br>  F√ºr jeden Punkt wird die folgende Reihenfolge berechnet: <br><p>  Xn + 1 = Xn¬≤ + Yn¬≤ + p <br>  Yn + 1 = 2XnYn + q </p><br>  Die Berechnung der Zugeh√∂rigkeit eines Punktes zur Menge bei jeder Iteration wird als Gleichung durchgef√ºhrt <br>  Xn¬≤ + Yn¬≤ &lt;4. <br><br>  Um das Mandelbrot-Set auf dem Bildschirm anzuzeigen, definieren wir eine Regel: <br><br><ol><li>  Wenn die Ungleichung bei einer Iteration gilt, wird der Punkt in die Menge eingegeben und schwarz angezeigt. </li><li>  Wenn die Ungleichung nicht gilt, beginnend mit einem bestimmten Iterationswert n = N, wird die Farbe durch die Anzahl der Iterationen N bestimmt. </li></ol><br>  Der Berechnungsprozess auf dem Host ist wie folgt: <br><br><ul><li>  Die Berechnung der Anzahl der Iterationen f√ºr jeden Punkt innerhalb des Pixelfensters wird der Funktion mandel_pixel () zugewiesen. </li><li>  Die sequentielle Aufz√§hlung von Bildpunkten wird von der Funktion softwareCalculateFrame () bereitgestellt.  Die Parameter geben das tats√§chliche Intervall der berechneten Punkte, den tats√§chlichen Schritt des Algorithmus und einen Zeiger auf den Farbpuffer der Bildgr√∂√üe (theWidth * theHeight) an. </li><li>  Die Farbe des Punktes wird von der SoftColorTable angepasst. </li></ul><br>  Fahren wir mit dem Code fort: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> mandel_pixel( <span class="hljs-type"><span class="hljs-type">double</span></span> x0, <span class="hljs-type"><span class="hljs-type">double</span></span> y0, unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> maxIterations ) { // variables <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the calculation <span class="hljs-type"><span class="hljs-type">double</span></span> x = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; <span class="hljs-type"><span class="hljs-type">double</span></span> y = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; <span class="hljs-type"><span class="hljs-type">double</span></span> xSqr = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; <span class="hljs-type"><span class="hljs-type">double</span></span> ySqr = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> iterations = <span class="hljs-number"><span class="hljs-number">0</span></span>; // <span class="hljs-keyword"><span class="hljs-keyword">perform</span></span> up <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the maximum number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> iterations <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> solve // the <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-type"><span class="hljs-type">point</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the image <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( xSqr + ySqr &lt; <span class="hljs-number"><span class="hljs-number">4.0</span></span> &amp;&amp;iterations &lt; maxIterations ) { // <span class="hljs-keyword"><span class="hljs-keyword">perform</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> iteration xSqr = x*x; ySqr = y*y; y = <span class="hljs-number"><span class="hljs-number">2</span></span>*x*y + y0; x = xSqr - ySqr + x0; // <span class="hljs-keyword"><span class="hljs-keyword">increment</span></span> iteration count iterations++; } // return the iteration count return iterations; }</code> </pre> <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">int</span></span> softwareCalculateFrame( <span class="hljs-type"><span class="hljs-type">double</span></span> aStartX, <span class="hljs-type"><span class="hljs-type">double</span></span> aStartY, <span class="hljs-type"><span class="hljs-type">double</span></span> aScale, unsigned <span class="hljs-type"><span class="hljs-type">int</span></span>* aFrameBuffer ) { // <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> pointer <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> variables unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> * fb_ptr = aFrameBuffer; unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> j, k, pixel; // <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> position variables <span class="hljs-type"><span class="hljs-type">double</span></span> x = aStartX; <span class="hljs-type"><span class="hljs-type">double</span></span> y = aStartY; <span class="hljs-type"><span class="hljs-type">double</span></span> cur_x, cur_y; <span class="hljs-type"><span class="hljs-type">double</span></span> cur_step_size = aScale; // <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> pixel <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the y dimension <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( j = <span class="hljs-number"><span class="hljs-number">0</span></span>, cur_y = y; j &lt; theHeight; j++, cur_y -= cur_step_size ) { // <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> pixel <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the x dimension <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( cur_x = x, k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k&lt; theWidth; k++, cur_x += cur_step_size ) { // <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the pixel <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> pixel = mandel_pixel(cur_x, cur_y, theSoftColorTableSize); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( pixel == theSoftColorTableSize ) *fb_ptr++ = <span class="hljs-number"><span class="hljs-number">0x0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> *fb_ptr++ = theSoftColorTable[pixel]; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Jedes Pixel wird unabh√§ngig vom anderen berechnet, und daher kann dieser Prozess parallelisiert werden.  Bei der Implementierung des Algorithmus f√ºr den FPGA-Beschleuniger wird ein SIMD-Befehl erstellt, um die Anzahl f√ºr jedes Iterationspixel zu berechnen (Bestimmen des Farbcodes aus der Palette).  Die Implementierung von zwei verschachtelten Schleifen im Bildpuffer wird durch Ausf√ºhren der Operation (theWidth * theHeight) durch OpenCL gerahmt. <br><br>  Die Kernelinstanzen in der folgenden Liste werden als Workitem bezeichnet, und die Menge aller Instanzen wird als Indexbereich bezeichnet.  Die Merkmale der Hardwarefunktion umfassen Folgendes: <br><br><ul><li>  Eine Funktionsdeklaration beginnt mit dem Schl√ºsselwort __kernel. </li><li>  Art der Hardwarefunktion - Die Art des R√ºckgabewerts ist immer ung√ºltig. </li><li>  Die R√ºckgabe von Werten erfolgt √ºber Puffer, die als Parameter √ºbergeben werden. <br><ul><li>  Die ersten drei Parameter definieren das Materialgitter, dessen Knoten den Pixeln des Ausgabebildes entsprechen. </li><li>  Der vierte Parameter begrenzt die Anzahl der Iterationen und verhindert so das Schleifen von Punkten, die zum Mandelbrot-Satz geh√∂ren. </li><li>  Der f√ºnfte Parameter ist ein Zeiger auf den Ausgabefarbpuffer. </li><li>  Das Schl√ºsselwort __global gibt den Speichertyp an, √ºber den der Puffer √ºbertragen wird: Dies ist der allgemeine DDR-Speicher (QDR) auf dem Beschleuniger selbst. </li><li>  Das Schl√ºsselwort "Einschr√§nken" gibt dem Optimierer ein Verbot der Verwendung indirekter Pufferreferenzen. </li><li>  Im 6. Parameter wird ein Zeiger auf die Palette √ºbergeben. </li><li>  Das Schl√ºsselwort __constant optimiert die Pufferzugriffe, indem ein Cache mit einem schreibgesch√ºtzten Attribut generiert wird. </li></ul><br>  Die Beschreibung der Funktion in der Liste entspricht in etwa der Implementierung f√ºr den x64-Prozessor.  Hier erfolgt die Definition der aktuellen Kernelinstanz √ºber die Funktion get_global_id, in die die Dimensionsnummer (0, 1) als Parameter √ºbergeben wird. <br><br>  Zur besseren Optimierung wurde eine explizite Angabe des Zyklusbeginns eingef√ºhrt.  In Ermangelung von Informationen √ºber die Anzahl der Iterationen zum Zeitpunkt der Kompilierung wird die Anzahl der Schleifenschritte explizit angegeben, da f√ºr sie eigene Hardwarebl√∂cke erstellt werden.  Bei dieser Art der Codierung sollte man aufgrund des FPGA-Ressourcenverbrauchs f√ºr eine gr√∂√üere Anzahl von Zyklen auf die Kapazit√§t eines bestimmten auf dem Beschleuniger installierten Chips zur√ºckblicken. <br><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ mandelbrot_kernel.cl : Hardware implementation of the mandelbrot algorithm /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Amount of loop unrolling. #ifndef UNROLL #define UNROLL 20 #endif /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Define the color black as 0 #define BLACK 0x00000000 __kernel void hw_mandelbrot_frame ( const double x0, const double y0, const double stepSize, const unsigned int maxIterations, __global unsigned int *restrict framebuffer, __constant const unsigned int *restrict colorLUT, const unsigned int windowWidth) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Work-item position const size_t windowPosX = get_global_id(0); const size_t windowPosY = get_global_id(1); const double stepPosX = x0 + (windowPosX * stepSize); const double stepPosY = y0 - (windowPosY * stepSize); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Variables for the calculation double x = 0.0; double y = 0.0; double xSqr = 0.0; double ySqr = 0.0;&lt;/code</span></span>&gt; &lt;code&gt;unsigned <span class="hljs-comment"><span class="hljs-comment">#pragma while { int iterations = 0; // Perform up to the maximum number of iterations to solve // the current work-item's position in the image // The loop unrolling factor can be adjusted based on the amount of FPGA // resources available. unroll UNROLL xSqr + ySqr &lt; 4.0 &amp;&amp; iterations &lt; maxIterations ) // Perform the current iteration xSqr = x*x; ySqr = y*y; y = 2*x*y + stepPosY; x = xSqr - ySqr + stepPosX; // Increment iteration count iterations++; } // Output black if we never finished, and a color from the look up table otherwise framebuffer[windowWidth * windowPosY + windowPosX] = (iterations == maxIterations) ? BLACK : colorLUT[iterations]; }</span></span></code> </pre> <br>  Das Intel FPGA SDK f√ºr OpenCL-Dienstprogramm muss vor dem Kompilieren der Hardwareimplementierung des Algorithmus auf dem Host installiert werden.  Zu der vorinstallierten Software muss BSP (Board Support Package) des Herstellers der jeweiligen Beschleunigerplatine geh√∂ren.  In diesem Beispiel wird Intel Quartus Prime Pro 16.1 mit Unterst√ºtzung f√ºr OpenCL und BSP des Euler Thread Accelerators (Intel Arria 10) installiert. <br><br>  Das Folgende ist die Konfiguration von Pfaden und Umgebungsvariablen.  Die Variable ALTERAOCLSDKROOT enth√§lt den Pfad zum Intel FPGA SDK, die Variable AOCL_BOARD_PACKAGE_ROOT enth√§lt den Pfad zum Beschleuniger BSP. <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ALTERAOCLSDKROOT=C:\intelFPGA_pro\<span class="hljs-number"><span class="hljs-number">16.1</span></span>\hld <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> AOCL_BOARD_PACKAGE_ROOT=C:\intelFPGA_pro\<span class="hljs-number"><span class="hljs-number">16.1</span></span>\hld\board\euler_thread <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\hld\bin <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\quartus\bin64 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\hld\board\a10_ref\windows64\bin <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\hld\host\windows64\bin <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\qsys\bin <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\Program Files (x86)\GnuWin32\bin\</code> </pre> <br>  F√ºr die Kompilierung wird der aoc-Compiler aus dem SDK verwendet. <br><br><pre> <code class="hljs powershell">aoc mandelbrot_kernel.cl <span class="hljs-literal"><span class="hljs-literal">-o</span></span> mandelbrot_kernel.aocx -<span class="hljs-literal"><span class="hljs-literal">-board</span></span> thread <span class="hljs-literal"><span class="hljs-literal">-v</span></span> <span class="hljs-literal"><span class="hljs-literal">-v</span></span> -<span class="hljs-literal"><span class="hljs-literal">-report</span></span></code> </pre> <br>  Wir entschl√ºsseln: mandelbrot_kernel.cl - die Datei mit dem Quelltext, mandelbrot_kernel.aocx - die Ausgabeobjektdatei zum Programmieren von FPGA, Thread - den Namen des Beschleunigers aus dem BSP-Paket.  Der Schalter --report zeigt einen FPGA-Ressourcennutzungsbericht an.  Der Schalter ‚Äìv zeigt w√§hrend der Kompilierung Diagnoseinformationen an.  Der Ressourcenverbrauchsbericht f√ºr den Kernel lautet wie folgt: <br><br>  + --------------------------------------------- ------------------- + <br>  ;;  Zusammenfassung der gesch√§tzten Ressourcennutzung; <br>  + ------------------------------------ + -------- ------------------- + <br>  ;;  Ressource + Nutzung; <br>  + ------------------------------------ + -------- ------------------- + <br>  ;;  Logiknutzung;  49% <br>  ;;  ALUTs;  26%; <br>  ;;  Spezielle Logikregister;  25%; <br>  ;;  Speicherbl√∂cke;  21% <br>  ;;  DSP-Bl√∂cke;  16%; <br>  + ------------------------------------ + -------- -------------------; <br><br>  Zum Kompilieren der Hostanwendung wurde im Beispiel das Microsoft Visual Studio 2010 Express-Paket mit installiertem Microsoft SDK 7.1 verwendet.  In den Projekteinstellungen ist die Konfiguration f√ºr x64 ausgew√§hlt.  Verbinden Sie anschlie√üend den Ordner f√ºr externe Header-Dateien und geben Sie in den Linker-Einstellungen den Pfad zu zus√§tzlichen Intel FPGA SDK-Bibliotheken an. <br>  Zus√§tzliche Verzeichnisse zum Einschlie√üen von Dateien = $ (ALTERAOCLSDKROOT) \ host \ include; <br>  Zus√§tzliche Bibliotheksverzeichnisse = $ (AOCL_BOARD_PACKAGE_ROOT) \ windows64 \ lib; <br><pre> <code class="hljs tex"><span class="hljs-formula"><span class="hljs-formula">$(ALTERAOCLSDKROOT)</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">host</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">windows</span></span></span></span></span><span class="hljs-formula">64</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">lib</span></span></span></span></span><span class="hljs-formula">;</span></span></code> </pre> <br>  Der allgemeine Aktionsplan zum Starten des Kernels auf dem Beschleuniger lautet wie folgt: <br><br><ol><li>  Holen Sie sich eine Liste der Plattformen </li><li>  Holen Sie sich eine Liste der Ger√§te </li><li>  Kontext erstellen; </li><li>  Laden Sie den Kernel in das Ger√§t. </li><li>  Eingabepuffer an das Ger√§t senden; </li><li>  F√ºhren Sie den Kernel zur Ausf√ºhrung aus. </li><li>  Lesen Sie den Ausgabepuffer vom Ger√§t. </li><li>  freier Kontext. </li></ol><br>  Betrachten Sie einige Punkte, die in direktem Zusammenhang mit dem Start des Kernels stehen.  Ein Kern ist also so konzipiert, dass er ein Pixel des Bildes verarbeitet.  Daher m√ºssen Sie N Kernelinstanzen ausf√ºhren, wobei N die Gesamtzahl der Pixel im Bild ist. <br><br>  Im Folgenden wird der Fall aufgef√ºhrt, dass sich mehrere Aufgaben auf dem Server befinden und die Aufgabe auf diese verteilt werden kann.  In jedem der Beschleuniger m√ºssen Sie den Kernel laden (Datei mandelbrot_kernel.aocx).  Angenommen, die Anzahl der Beschleuniger ist numDevices, und die Bildlinien werden auf alle Beschleuniger aufgeteilt: <br><br><pre> <code class="hljs django"><span class="xml"><span class="xml">#define MAXDEV 10 static cl_context theContext; static cl_program theProgram; static cl_kernel theKernels[MAXDEV]; //.. // Create the program object theProgram = createProgramFromBinary( theContext, "mandelbrot_kernel.aocx", theDevices, numDevices); // Create the kernels for ( unsigned i = 0; i </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; ++</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theKernels</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clCreateKernel(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theProgram</span></span></span></span><span class="xml"><span class="hljs-tag">, "</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hw_mandelbrot_frame</span></span></span></span><span class="xml"><span class="hljs-tag">", &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> ); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Create</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">output</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pixel</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">buffers</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">every</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">kernel</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; ++</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelData</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clCreateBuffer(theContext,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">CL_MEM_WRITE_ONLY</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelDataWidth</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowsPerDevice</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">]*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Preparing</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">writing</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">palette</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">buffer</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">every</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theHardColorTable</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clCreateBuffer(theContext,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">CL_MEM_READ_ONLY</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aColorTableSize</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++ ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clEnqueueWriteBuffer(theQueues[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theHardColorTable</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">CL_TRUE</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aColorTableSize</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aColorTable</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Preparing</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">kernels</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">run</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> ( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">rowsPerDevice[i++]</span></span></span></span><span class="xml"><span class="hljs-tag"> ) { // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Create</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ND</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">range</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">size_t</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">globalSize</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelDataWidth</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowsPerDevice</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">] }; // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Set</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arguments</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theKernels</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_double</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*) &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aStartX</span></span></span></span><span class="xml"><span class="hljs-tag"> ); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">const</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">double</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">offsetedStartY</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">aStartY</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aScale</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_double</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">offsetedStartY</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_double</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aScale</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_uint</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theHardColorTableSize</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_mem</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelData</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">]); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_mem</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theHardColorTable</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_uint</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theWidth</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Launch</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">kernel</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clEnqueueNDRangeKernel(theQueues[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theKernels</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">globalSize</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">); } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">rowsPerDevice[i++]</span></span></span></span><span class="xml"><span class="hljs-tag"> ) { // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Read</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">output</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clEnqueueReadBuffer(theQueues[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelData</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">CL_TRUE</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelDataWidth</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowsPerDevice</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">]*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">), &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aFrameBuffer</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theWidth</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">); } / / </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span></span></span></span></code> </pre><br><ul><li>  Die Funktion createProgramFromBinary erstellt ein OpenCL-Programmobjekt aus einer Objektdatei. </li><li>  Als n√§chstes wird f√ºr jedes Ger√§t ein Kernel basierend auf dem Programmobjekt erstellt. </li><li>  Die PixelData-Puffer werden erstellt, um die Ausgabe von jedem Kern zu empfangen. </li><li>  Ein Puffer wird zum Speichern der Farbpalette erstellt und in jeden der Beschleuniger geladen. </li><li>  Als n√§chstes wird f√ºr jedes Ger√§t die Bindung lokaler Anwendungsparameter und Kernelparameter mithilfe der Funktion clSetKernelArg festgelegt. </li><li>  Parameter werden durch Seriennummern in der Kernelfunktionsdeklaration beginnend bei Null bestimmt. </li></ul><br>  Der n√§chste wichtige Punkt ist die Bestimmung der Gr√∂√üe der Aufgabe basierend auf dem Indexbereich gem√§√ü dem globalSize-Array.  Dieses Array kann ein-, zwei- oder dreidimensional sein.  F√ºr jede Dimension wird eine Dimension als Ganzzahl angegeben.  Die Dimension des Space bestimmt die Indexreihenfolge des Workitems im Kernel. <br><br>  In dem Beispiel wird f√ºr jeden Kern ein zweidimensionaler Raum angegeben, wobei eine der Achsen die Pixelzeilenelemente ist, die zweite der Satz von Bildlinien, die auf diesem Ger√§t verarbeitet werden.  Im Kernelcode wird die Pixelnummer in der Zeile durch Aufrufen von get_global_id (0) erhalten, die Zeilennummer lautet get_global_id (1).  Die Variable globalSize wird an die Funktion clEnqueueNDRangeKernel √ºbergeben, um die erforderliche Anzahl der auszuf√ºhrenden Kernelinstanzen zu starten. <br><br>  Nach Abschluss der Ausf√ºhrung der Kerne werden Pixelpuffer vom Ger√§t in lokale Arrays gelesen.  Lassen Sie uns die Leistung anhand der Anzahl der Bilder pro Sekunde bewerten. Das Ergebnis ist in der Demonstration auf der SelectelTechDay-Konferenz sichtbar ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">siehe Anfang des Artikels</a> ). <br><br><h2>  Fazit </h2><br>  Durch die Programmierung von FPGA-Beschleunigern in einer Hochsprache wurde die Zugriffsschwelle f√ºr Entwickler auf diese Technologie zweifellos um eine Gr√∂√üenordnung gesenkt.  F√ºr diejenigen, die dieses Toolkit gerade beherrschen, gibt es beispielsweise sogar eine FPGA-Implementierung des ber√ºhmten Beispiels <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">‚ÄûHello World‚Äú</a> . <br><br>  Aber nicht so einfach.  Das Schreiben - und insbesondere das Debuggen eines klar funktionierenden Algorithmus eines real angewandten Problems erfordert immer noch eine hohe Professionalit√§t.  Eine weitere Einschr√§nkung besteht darin, dass jeder FPGA-Chip nur eine Rechenaufgabe innerhalb der Anwendung ausf√ºhren kann.  F√ºr eine andere Aufgabe muss sie erneut programmiert werden. <br><blockquote>  Das Modell der Verwendung der Plattform erm√∂glicht es Ihnen √ºbrigens, mehr als einen FPGA-Beschleuniger auf dem Host zu haben, obwohl dies eine ziemlich teure L√∂sung ist. <br>  Der Host (Hostanwendung) verwaltet den Prozess des Erstellens des Kontexts (Datenstruktur f√ºr den Beschleuniger) und der Befehlswarteschlange.  Das hei√üt,  Eine einzelne Hostanwendung, in der es verschiedene Unteraufgaben f√ºr paralleles Rechnen auf FPGA gibt, kann sie auf verschiedene Beschleuniger laden: <br>  KERNEL1 =&gt; BESCHLEUNIGER A. <br>  KERNEL2 =&gt; BESCHLEUNIGER B. </blockquote><br>  Trotzdem lohnt sich der Versuch, FPGA-Beschleuniger zu beherrschen - in vielen Anwendungsbereichen wird diese Technologie unverzichtbar: Telekommunikation, Biotechnologie, Big Data-Verarbeitung, Mustererkennung, Signal- und Bildverarbeitung, Computermathematik und physikalische Feldmodellierung. <br><br>  Zus√§tzliche Informationen zum Artikel: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">www.altera.com</a> ist eine Intel FPGA- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">Kernressource</a> . <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">www.eulerproject.com</a> ist die offizielle Website des Euler-Projekts. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">Altera + OpenCL: Wir programmieren unter FPGA ohne Kenntnis von VHDL / Verilog</a> - ein Artikel √ºber Habr. <br><cut></cut></li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de418403/">https://habr.com/ru/post/de418403/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de418393/index.html">[Freitag] Wie wir 3D Web ges√§gt haben</a></li>
<li><a href="../de418395/index.html">Elon Musk: Lokale Generatoren elektromagnetischer Felder sch√ºtzen Kolonisten auf dem Mars</a></li>
<li><a href="../de418397/index.html">Freitag Management: Kostenlose Skillbox Webinare</a></li>
<li><a href="../de418399/index.html">Auf der Welle von Selectel FM</a></li>
<li><a href="../de418401/index.html">Wie ich nicht zu dir geworden bin: ein Beitrag der Liebe zu Systemadministratoren</a></li>
<li><a href="../de418405/index.html">Das Prinzip der umgekehrten Pyramide in der Analytik. Wir erstellen ein verst√§ndliches Dashboard</a></li>
<li><a href="../de418407/index.html">Hashflare Cloud Mining wurde geschlossen. Geld kehrt nicht zur√ºck</a></li>
<li><a href="../de418411/index.html">Browser-Netzwerk-Shooter auf Node.js.</a></li>
<li><a href="../de418415/index.html">Telegram f√ºhrte einen eigenen Passport-Dienst zur √úberpr√ºfung und Autorisierung von Benutzern ein</a></li>
<li><a href="../de418417/index.html">Apollo: 9 Monate - normaler Flug</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>