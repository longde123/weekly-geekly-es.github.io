<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>游뗹游낕 游꿇 游륋릞 Reducci칩n de los plazos (criptomonedas, divisas, intercambios) 游대 游낻 鮫뉦잺</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace alg칰n tiempo, me encargaron escribir un procedimiento que reduzca las cotizaciones del mercado Forex (m치s precisamente, los datos de plazos). 

 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Reducci칩n de los plazos (criptomonedas, divisas, intercambios)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418757/">  Hace alg칰n tiempo, me encargaron escribir un procedimiento que reduzca las cotizaciones del mercado Forex (m치s precisamente, los datos de plazos). <br><br>  La declaraci칩n del problema: los datos se ingresan en un intervalo de 1 segundo en este formato: <br><br><ul><li>  Nombre del instrumento (c칩digo de par USDEUR, etc.), </li><li>  Fecha y hora en formato de hora unix, </li><li>  Valor abierto (precio de la primera transacci칩n en el intervalo), </li><li>  Alto valor (precio m치ximo), </li><li>  Valor bajo </li><li>  Valor de cierre (precio de la 칰ltima oferta), </li><li>  Volumen (volumen o volumen de transacci칩n). </li></ul><br>  Es necesario asegurar el rec치lculo y la sincronizaci칩n de los datos en las tablas: 5 segundos, 15 segundos, 1 minuto, 5 minutos, 15 minutos, etc. <br><br>  El formato de almacenamiento de datos descrito se llama OHLC u OHLCV (Abrir, Alto, Bajo, Cerrar, Volumen).  A menudo se usa, puede construir inmediatamente una tabla de "velas japonesas" en 칠l. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/by/ws/8u/byws8uaklvxydw8d2wqkqhpb1ni.png" alt="imagen"></div><br>  Debajo del corte, describ칤 todas las opciones que se me ocurrieron, c칩mo diluir (agrandar) los datos recibidos, para el an치lisis, por ejemplo, el salto invernal en el precio de bitcoin, y de acuerdo con los datos recibidos, inmediatamente construir치 un gr치fico de "Velas japonesas" (en MS Excel tambi칠n hay un gr치fico de este tipo). )  En la imagen de arriba, este gr치fico est치 construido para el per칤odo de tiempo de "1 mes", para la herramienta "bitstampUSD".  El cuerpo blanco de la vela indica un aumento en el precio en el intervalo, negro: una disminuci칩n en el precio, las mechas superior e inferior indican los precios m치ximos y m칤nimos que se alcanzaron en el intervalo.  Antecedentes: volumen de transacciones.  Se ve claramente que en diciembre de 2017 el precio se acerc칩 a la marca de 20K. <br><br>  La soluci칩n se dar치 para dos motores de base de datos, para Oracle y MS SQL, que, de alguna manera, permitir치n compararlos para esta tarea espec칤fica (no generalizaremos la comparaci칩n con otras tareas). <br><a name="habracut"></a><br>  Luego resolv칤 el problema de una manera trivial: calculando el adelgazamiento correcto en una tabla temporal y sincroniz치ndolo con la tabla de destino, eliminando filas que existen en la tabla de destino pero que no existen en la tabla temporal y agregando filas que existen en la tabla temporal pero que no existen en el objetivo.  En ese momento, el cliente satisfizo la soluci칩n y cerr칠 la tarea. <br><br>  Pero ahora decid칤 considerar todas las opciones, porque la soluci칩n anterior contiene una caracter칤stica: es dif칤cil de optimizar para dos casos a la vez: <br><br><ul><li>  cuando la tabla de destino est치 vac칤a y necesita agregar muchos datos, </li><li>  y cuando la tabla de destino es grande, y necesita agregar datos en peque침os fragmentos. </li></ul><br>  Esto se debe al hecho de que en el procedimiento debe conectar la tabla de destino y la tabla temporal, y debe adjuntarla a la m치s grande, y no al rev칠s.  En los dos casos anteriores, los m치s grandes / m치s peque침os se intercambian.  El optimizador decidir치 el orden de conexi칩n en funci칩n de las estad칤sticas, y las estad칤sticas pueden estar desactualizadas y la decisi칩n puede tomarse incorrectamente, lo que conducir치 a una degradaci칩n significativa del rendimiento. <br><br>  En este art칤culo, describir칠 m칠todos de adelgazamiento 칰nicos que pueden ser 칰tiles para los lectores para el an치lisis, por ejemplo, el salto invernal en el precio de bitcoin. <br><br>  Los procedimientos de adelgazamiento en l칤nea se pueden descargar desde github en el enlace al final del art칤culo. <br><br>  Hasta el punto ... Mi tarea se estaba reduciendo del per칤odo de tiempo de "1 segundo" al siguiente, pero aqu칤 estoy considerando la reducci칩n del nivel de transacci칩n (en la tabla de origen, los campos STOCK_NAME, UT, ID, APRICE, AVOLUME).  Porque dichos datos son emitidos por bitcoincharts.com. <br>  En realidad, la eliminaci칩n del nivel de transacci칩n al nivel de "1 segundo" se realiza mediante dicho comando (el operador se traduce f치cilmente en la reducci칩n del nivel de "1 segundo" a los niveles superiores): <br><br>  <b>En Oracle:</b> <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  La funci칩n <i>avg () keep (dense_rank primer orden por UT, ID)</i> funciona as칤: como la solicitud es GROUP BY, cada grupo se calcula independientemente de los dem치s.  Dentro de cada grupo, las cadenas se ordenan por UT e ID, numeradas por <i>dense_rank</i> .  Como sigue la primera funci칩n, la l칤nea se selecciona donde <i>dense_rank</i> devolvi칩 1 (en otras palabras, se selecciona el m칤nimo): se selecciona la primera transacci칩n dentro del intervalo.  Para este UT m칤nimo, ID, si hubiera varias l칤neas, se considerar칤a el promedio.  Pero en nuestro caso se garantizar치 una l칤nea (debido a la unicidad de la ID), por lo que el valor resultante se devuelve inmediatamente como AOPEN.  Es f치cil notar que la <i>primera</i> funci칩n reemplaza dos agregadas. <br><br>  <b>En MS SQL</b> <br><br>  No hay <i>primeras / 칰ltimas</i> funciones (hay <i>first_value / last_value</i> , pero no es eso).  Por lo tanto, debe conectar la tabla consigo misma. <br><br>  No dar칠 la solicitud por separado, pero puede verla a continuaci칩n en el procedimiento <i>dbo.THINNING_HABR_CALC</i> .  Por supuesto, sin <i>primero / 칰ltimo</i> no es tan elegante, pero funcionar치. <br><br>  쮺칩mo puede resolver este problema un operador?  (Aqu칤, el t칠rmino "un operador" no significa que el operador ser치 uno, sino que no habr치 ciclos que "arrastren" los datos en una l칤nea). <br><br>  Enumerar칠 todas las opciones que conozco para resolver este problema: <br><br><ol><li>  SIMP (producto simple, simple, cartesiano), </li><li>  CALC (c치lculo, adelgazamiento iterativo de los niveles superiores), </li><li>  CHIN (forma china, solicitud voluminosa para todos los niveles a la vez), </li><li>  UDAF (funci칩n agregada definida por el usuario), </li><li>  PPTF (funci칩n de tabla paralela y canalizada, soluci칩n de procedimiento, pero con solo dos cursores, de hecho, dos sentencias SQL), </li><li>  MODO (modelo, frase MODELO), </li><li>  e IDEA (ideal, una soluci칩n ideal que puede no funcionar ahora). </li></ol><br>  Mirando hacia el futuro, dir칠 que este es el caso raro cuando la soluci칩n PPTF de procedimiento es la m치s efectiva en Oracle. <br><br>  Descargue archivos de transacciones de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://api.bitcoincharts.com/v1/csv</a> <br>  Recomiendo elegir archivos kraken *.  Los archivos localbtc * son muy ruidosos: contienen l칤neas de distracci칩n con precios poco realistas.  Todos los kraken * contienen alrededor de 31 millones de transacciones, recomiendo excluir krakenEUR de all칤, luego la transacci칩n se convierte en 11 millones.  Este es el volumen m치s conveniente para las pruebas. <br><br>  Ejecute un script en Powershell para generar archivos de control para SQLLDR para Oracle y generar una solicitud de importaci칩n para MSSQL. <br><br><pre> <code class="hljs mel"> # MODIFY PARAMETERS THERE $OracleConnectString = <span class="hljs-string"><span class="hljs-string">"THINNING/aaa@P-ORA11/ORCL"</span></span> # For Oracle $PathToCSV = <span class="hljs-string"><span class="hljs-string">"Z:\10"</span></span> # without trailing slash $filenames = Get-ChildItem -name *.csv Remove-Item *.ctl -ErrorAction SilentlyContinue Remove-Item *.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> -ErrorAction SilentlyContinue Remove-Item *.bad -ErrorAction SilentlyContinue Remove-Item *.dsc -ErrorAction SilentlyContinue Remove-Item LoadData-Oracle.bat -ErrorAction SilentlyContinue Remove-Item LoadData-MSSQL.sql -ErrorAction SilentlyContinue ForEach ($FilenameExt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $Filenames) { Write-Host <span class="hljs-string"><span class="hljs-string">"Processing file: "</span></span>$FilenameExt $StockName = $FilenameExt.<span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>, $FilenameExt.Length<span class="hljs-number"><span class="hljs-number">-5</span></span>) $FilenameCtl = <span class="hljs-string"><span class="hljs-string">'.'</span></span>+$Stockname+<span class="hljs-string"><span class="hljs-string">'.ctl'</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"OPTIONS (DIRECT=TRUE, PARALLEL=FALSE, ROWS=1000000, SKIP_INDEX_MAINTENANCE=Y)"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"UNRECOVERABLE"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"LOAD DATA"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"INFILE '.$StockName.csv'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"BADFILE '.$StockName.bad'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"DISCARDFILE '.$StockName.dsc'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"INTO TABLE TRANSACTIONS_RAW"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"APPEND"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"FIELDS TERMINATED BY ','"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"(ID SEQUENCE (0), STOCK_NAME constant '$StockName', UT, APRICE, AVOLUME)"</span></span> Add-Content -Path LoadData-Oracle.bat -Value <span class="hljs-string"><span class="hljs-string">"sqlldr $OracleConnectString control=$FilenameCtl"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"insert into TRANSACTIONS_RAW (STOCK_NAME, UT, APRICE, AVOLUME)"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"select '$StockName' as STOCK_NAME, UT, APRICE, AVOLUME"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"from openrowset (bulk '$PathToCSV\$FilenameExt', formatfile = '$PathToCSV\format_mssql.bcp') as T1;"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">""</span></span> }</code> </pre><br>  Creemos una tabla de transacciones en Oracle. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> TRANSACTIONS_RAW ( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME varchar2 (<span class="hljs-number"><span class="hljs-number">32</span></span>) , UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , APRICE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) pctfree <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parallel</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> nologging;</code> </pre><br>  En Oracle, ejecute el <i>archivo LoadData-Oracle.bat</i> , habiendo <i>arreglado</i> previamente los par치metros de conexi칩n al comienzo del script Powershell. <br><br>  Yo trabajo en una m치quina virtual.  La descarga de todos los archivos de transacciones de 11M en 8 archivos kraken * (omit칤 el archivo EUR) tom칩 aproximadamente 1 minuto. <br><br>  Y cree funciones que truncar치n las fechas a l칤mites de intervalo: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> TRUNC_UT (p_UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, p_StripeTypeId <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">deterministic</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> p_StripeTypeId <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">10</span></span>) * <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">600</span></span>) * <span class="hljs-number"><span class="hljs-number">600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">3600</span></span>) * <span class="hljs-number"><span class="hljs-number">3600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / ( <span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>)) * ( <span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / (<span class="hljs-number"><span class="hljs-number">24</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>)) * (<span class="hljs-number"><span class="hljs-number">24</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc ((trunc (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'Month'</span></span>) - <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span>) * <span class="hljs-number"><span class="hljs-number">86400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc ((trunc (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'year'</span></span>) - <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span>) * <span class="hljs-number"><span class="hljs-number">86400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> UT2DATESTR (p_UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> varchar2 <span class="hljs-keyword"><span class="hljs-keyword">deterministic</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> to_char (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'YYYY.MM.DD HH24:MI:SS'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  Considera las opciones.  Primero, se proporciona el c칩digo de todas las opciones, luego los scripts para iniciar y probar.  Primero, la tarea se describe para Oracle, luego para MS SQL <br><br><h4>  Opci칩n 1 - SIMP (Trivial) </h4><br>  Todo el conjunto de transacciones se multiplica por el producto cartesiano por un conjunto de 10 l칤neas con n칰meros del 1 al 10. Esto es necesario para obtener 10 l칤neas de una sola l칤nea de transacci칩n con fechas truncadas en los l칤mites de 10 intervalos. <br><br>  Despu칠s de eso, las l칤neas se agrupan por el n칰mero de intervalo y la fecha truncada, y se ejecuta la solicitud anterior. <br><br>  Crear VISTA: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_SIMP_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW , (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rownum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID);</code> </pre><br><h4>  Opci칩n 2 - CALC (calculado iterativamente) </h4><br>  En esta opci칩n, reducimos iterativamente las transacciones al nivel 1, del nivel 1 al nivel 2, y as칤 sucesivamente. <br><br>  Crea una tabla: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> QUOTES_CALC ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME varchar2 (<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) <span class="hljs-comment"><span class="hljs-comment">/*partition by list (STRIPE_ID) ( partition P01 values (1) , partition P02 values (2) , partition P03 values (3) , partition P04 values (4) , partition P05 values (5) , partition P06 values (6) , partition P07 values (7) , partition P08 values (8) , partition P09 values (9) , partition P10 values (10) )*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parallel</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> pctfree <span class="hljs-number"><span class="hljs-number">0</span></span> nologging;</code> </pre><br>  Puede crear un 칤ndice utilizando el campo STRIPE_ID, pero se ha establecido experimentalmente que es m치s rentable para 11 millones de transacciones sin un 칤ndice.  Para cantidades mayores, la situaci칩n puede cambiar.  O puede dividir la tabla descomentando el bloque en la consulta. <br><br>  Crea un procedimiento: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> THINNING_HABR_CALC_T <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rollback</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">immediate</span></span> <span class="hljs-string"><span class="hljs-string">'truncate table QUOTES_CALC'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-comment"><span class="hljs-comment">--+ append into QUOTES_CALC select 1 as STRIPE_ID , STOCK_NAME , UT , avg (APRICE) keep (dense_rank first order by ID) , max (APRICE) , min (APRICE) , avg (APRICE) keep (dense_rank last order by ID) , sum (AVOLUME) , sum (APRICE * AVOLUME) , count (*) from TRANSACTIONS_RAW a group by STOCK_NAME, UT; commit; for i in 1..9 loop insert --+ append into QUOTES_CALC select --+ parallel(4) STRIPE_ID + 1 , STOCK_NAME , TRUNC_UT (UT, i + 1) , avg (AOPEN) keep (dense_rank first order by UT) , max (AHIGH) , min (ALOW) , avg (ACLOSE) keep (dense_rank last order by UT) , sum (AVOLUME) , sum (AAMOUNT) , sum (ACOUNT) from QUOTES_CALC a where STRIPE_ID = i group by STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, i + 1); commit; end loop; end; /</span></span></code> </pre><br>  Por simetr칤a, cree una VISTA simple: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_CALC_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> QUOTES_CALC;</code> </pre><br><h4>  Opci칩n 3 - CHIN (C칩digo chino) </h4><br>  El m칠todo difiere la franqueza brutal del enfoque y es el rechazo del principio de "No te repitas".  En este caso, el rechazo de los ciclos. <br><br>  La opci칩n se proporciona aqu칤 solo para completar. <br><br>  Mirando hacia el futuro, dir칠 que, en t칠rminos de rendimiento en esta tarea en particular, ocupa el segundo lugar. <br><br><div class="spoiler">  <b class="spoiler_title">Gran solicitud</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_CHIN_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T01 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT) , T02 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T01 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T03 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T02 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T04 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T03 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T05 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T04 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T06 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T05 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T07 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T06 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T08 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T07 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T09 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T08 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T10 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T09 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T01 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T02 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T03 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T04 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T05 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T06 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T07 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T08 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T09 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T10;</code> </pre><br></div></div><br><h4>  Opci칩n 4 - UDAF </h4><br>  La opci칩n con la funci칩n agregada definida por el usuario no se dar치 aqu칤, pero se puede ver en github. <br><br><h4>  Opci칩n 5 - PPTF (funci칩n de tabla canalizada y paralela) </h4><br>  Cree una funci칩n (en el paquete): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> THINNING_PPTF_P <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> TRANSACTION_RECORD_T <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-built_in"><span class="hljs-built_in">record</span></span> (STOCK_NAME varchar2(<span class="hljs-number"><span class="hljs-number">128</span></span>), UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, SEQ_NUM <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, APRICE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>); type CUR_RECORD_T is ref cursor return TRANSACTION_RECORD_T; type QUOTE_T is record (STRIPE_ID number, STOCK_NAME varchar2(128), UT number , AOPEN number, AHIGH number, ALOW number, ACLOSE number, AVOLUME number , AAMOUNT number, ACOUNT number); type QUOTE_LIST_T is table of QUOTE_T; function F (p_cursor CUR_RECORD_T) return QUOTE_LIST_T pipelined order p_cursor by (STOCK_NAME, UT, SEQ_NUM) parallel_enable (partition p_cursor by hash (STOCK_NAME)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; / <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> THINNING_PPTF_P <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> F (p_cursor CUR_RECORD_T) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QUOTE_LIST_T <span class="hljs-keyword"><span class="hljs-keyword">pipelined</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> p_cursor <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> (STOCK_NAME, UT, SEQ_NUM) <span class="hljs-keyword"><span class="hljs-keyword">parallel_enable</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> p_cursor <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">hash</span></span> (STOCK_NAME)) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> QuoteTail QUOTE_LIST_T := QUOTE_LIST_T() ; rec TRANSACTION_RECORD_T; rec_prev TRANSACTION_RECORD_T; type ut_T is table of number index by pls_integer; ut number; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> QuoteTail.extend(<span class="hljs-number"><span class="hljs-number">10</span></span>); loop fetch p_cursor into rec; exit when p_cursor%notfound; if rec_prev.STOCK_NAME = rec.STOCK_NAME then if (rec.STOCK_NAME = rec_prev.STOCK_NAME and rec.UT &lt; rec_prev.UT) or (rec.STOCK_NAME = rec_prev.STOCK_NAME and rec.UT = rec_prev.UT and rec.SEQ_NUM &lt; rec_prev.SEQ_NUM) then raise_application_error (-20010, 'Rowset must be ordered, ('||rec_prev.STOCK_NAME||','||rec_prev.UT||','||rec_prev.SEQ_NUM||') &gt; ('||rec.STOCK_NAME||','||rec.UT||','||rec.SEQ_NUM||')'); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.STOCK_NAME &lt;&gt; rec_prev.STOCK_NAME or rec_prev.STOCK_NAME is null then for j in 1 .. 10 loop if QuoteTail(j).UT is not null then pipe row (QuoteTail(j)); QuoteTail(j) := null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; for i in reverse 1..10 loop ut := TRUNC_UT (rec.UT, i); if QuoteTail(i).UT &lt;&gt; ut then for j in 1..i loop pipe row (QuoteTail(j)); QuoteTail(j) := null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if QuoteTail(i).UT is null then QuoteTail(i).STRIPE_ID := i; QuoteTail(i).STOCK_NAME := rec.STOCK_NAME; QuoteTail(i).UT := ut; QuoteTail(i).AOPEN := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.APRICE &lt; QuoteTail(i).ALOW or QuoteTail(i).ALOW is null then QuoteTail(i).ALOW := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.APRICE &gt; QuoteTail(i).AHIGH or QuoteTail(i).AHIGH is null then QuoteTail(i).AHIGH := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; QuoteTail(i).AVOLUME := nvl (QuoteTail(i).AVOLUME, 0) + rec.AVOLUME; QuoteTail(i).AAMOUNT := nvl (QuoteTail(i).AAMOUNT, 0) + rec.AVOLUME * rec.APRICE; QuoteTail(i).ACOUNT := nvl (QuoteTail(i).ACOUNT, 0) + 1; QuoteTail(i).ACLOSE := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; rec_prev := rec; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; for j in 1 .. 10 loop if QuoteTail(j).UT is not null then pipe row (QuoteTail(j)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; exception when no_data_needed then null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; /</code> </pre><br>  Crear VISTA: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_PPTF_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> (THINNING_PPTF_P.F (<span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, APRICE, AVOLUME <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW)));</code> </pre><br><h4>  Opci칩n 6 - MODO (cl치usula modelo) </h4><br>  La opci칩n calcula de forma iterativa el diezmado para los 10 niveles utilizando la frase de la cl치usula <i>MODELO</i> con la frase <i>ITERATE</i> . <br><br>  La opci칩n tampoco es pr치ctica porque es lenta.  En mi entorno, se calculan 1000 transacciones para 8 instrumentos en 1 minuto.  La mayor parte del tiempo se gasta calculando la frase <i>MODELO</i> . <br><br>  Aqu칤 doy esta opci칩n solo por razones de integridad y como confirmaci칩n del hecho de que en Oracle casi todos los c치lculos arbitrariamente complejos se pueden realizar con una consulta, sin usar PL / SQL. <br><br>  Una de las razones del bajo rendimiento de la frase <i>MODELO</i> en esta consulta es que la b칰squeda a la derecha se realiza para <i>cada</i> regla que tenemos 6. Las primeras dos reglas se calculan bastante r치pido, porque hay un direccionamiento expl칤cito directo, sin comodines.  En las cuatro reglas restantes existe la palabra <i>any</i> : los c치lculos son m치s lentos. <br><br>  La segunda dificultad es que tienes que calcular el modelo de referencia.  Es necesario porque la lista de dimensiones debe conocerse <b>antes de</b> calcular la frase <i>MODELO</i> , no podemos calcular nuevas dimensiones dentro de esta frase.  Quiz치s esto se pueda evitar con la ayuda de dos frases MODELO, pero no lo hice debido al bajo rendimiento de una gran cantidad de reglas. <br><br>  Agrego que ser칤a posible no calcular <i>UT_OPEN</i> y <i>UT_CLOSE</i> en el modelo de referencia, sino usar las mismas funciones <i>avg () keep (dense_rank first / last order by)</i> directamente en la frase <i>MODEL</i> .  Pero habr칤a sucedido a칰n m치s lentamente. <br>  Debido a limitaciones de rendimiento, no incluir칠 esta opci칩n en el procedimiento de prueba. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-comment"><span class="hljs-comment">--       SOURCETRANS (STRIPE_ID, STOCK_NAME, PARENT_UT, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) as (select 1, STOCK_NAME, TRUNC_UT (UT, 2), UT , avg (APRICE) keep (dense_rank first order by ID) , max (APRICE) , min (APRICE) , avg (APRICE) keep (dense_rank last order by ID) , sum (AVOLUME) , sum (AVOLUME * APRICE) , count (*) from TRANSACTIONS_RAW where ID &lt;= 1000 --       group by STOCK_NAME, UT) --   PARENT_UT, UT  2...10    UT_OPEN, UT_CLOSE --    , REFMOD (STRIPE_ID, STOCK_NAME, PARENT_UT, UT, UT_OPEN, UT_CLOSE) as (select b.STRIPE_ID , a.STOCK_NAME , TRUNC_UT (UT, b.STRIPE_ID + 1) , TRUNC_UT (UT, b.STRIPE_ID) , min (TRUNC_UT (UT, b.STRIPE_ID - 1)) , max (TRUNC_UT (UT, b.STRIPE_ID - 1)) from SOURCETRANS a , (select rownum + 1 as STRIPE_ID from dual connect by level &lt;= 9) b group by b.STRIPE_ID , a.STOCK_NAME , TRUNC_UT (UT, b.STRIPE_ID + 1) , TRUNC_UT (UT, b.STRIPE_ID)) --        , MAINTAB as ( select STRIPE_ID, STOCK_NAME, PARENT_UT, UT, AOPEN , AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT, null, null from SOURCETRANS union all select STRIPE_ID, STOCK_NAME, PARENT_UT, UT, null , null, null, null, null, null, null, UT_OPEN, UT_CLOSE from REFMOD) select STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT from MAINTAB model return all rows --      2...10 reference RM on (select * from REFMOD) dimension by (STRIPE_ID, STOCK_NAME, UT) measures (UT_OPEN, UT_CLOSE) main MM partition by (STOCK_NAME) dimension by (STRIPE_ID, PARENT_UT, UT) measures (AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) rules iterate (9) ( AOPEN [iteration_number + 2, any, any] = AOPEN [cv (STRIPE_ID) - 1, cv (UT) , rm.UT_OPEN [cv (STRIPE_ID), cv (STOCK_NAME), cv (UT)]] , ACLOSE [iteration_number + 2, any, any] = ACLOSE [cv (STRIPE_ID) - 1, cv (UT) , rm.UT_CLOSE[cv (STRIPE_ID), cv (STOCK_NAME), cv (UT)]] , AHIGH [iteration_number + 2, any, any] = max (AHIGH)[cv (STRIPE_ID) - 1, cv (UT), any] , ALOW [iteration_number + 2, any, any] = min (ALOW)[cv (STRIPE_ID) - 1, cv (UT), any] , AVOLUME [iteration_number + 2, any, any] = sum (AVOLUME)[cv (STRIPE_ID) - 1, cv (UT), any] , AAMOUNT [iteration_number + 2, any, any] = sum (AAMOUNT)[cv (STRIPE_ID) - 1, cv (UT), any] , ACOUNT [iteration_number + 2, any, any] = sum (ACOUNT)[cv (STRIPE_ID) - 1, cv (UT), any] ) order by 1, 2, 3, 4;</span></span></code> </pre><br><h4>  Opci칩n 6 - IDEA (ideal, ideal, pero inoperante) </h4><br>  La solicitud que se describe a continuaci칩n ser칤a potencialmente la m치s eficiente y consumir칤a una cantidad de recursos igual al m칤nimo te칩rico. <br><br>  Pero ni Oracle ni MS SQL le permiten escribir una consulta de esta forma.  Creo que esto es dictado por la norma. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> QUOTES_S1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-comment"><span class="hljs-comment">-- where rownum &lt;= 100 group by STOCK_NAME, TRUNC_UT (UT, 1)) , T1 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) as (select 1, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT from QUOTES_S1 union all select STRIPE_ID + 1 , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + 1) , avg (AOPEN) keep (dense_rank first order by UT) , max (AHIGH) , min (ALOW) , avg (ACLOSE) keep (dense_rank last order by UT) , sum (AVOLUME) , sum (AAMOUNT) , sum (ACOUNT) from T1 where STRIPE_ID &lt; 10 group by STRIPE_ID + 1, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + 1) ) select * from T1</span></span></code> </pre><br>  Esta consulta corresponde a la siguiente parte de la documentaci칩n de Oracle: <br><br>  <i>Si una subquery_factoring_clause se refiere a su propio query_name en la subconsulta que lo define, entonces subquery_factoring_clause se dice que es recursiva.</i>  <i>Una subquery_factoring_clause recursiva debe contener dos bloques de consulta: el primero es el miembro de anclaje y el segundo es el miembro recursivo.</i>  <i>El miembro de anclaje debe aparecer antes que el miembro recursivo, y no puede hacer referencia a query_name.</i>  <i>El miembro de ancla puede estar compuesto por uno o m치s bloques de consulta combinados por los operadores establecidos: UNION ALL, UNION, INTERSECT o MINUS.</i>  <i>El miembro recursivo debe seguir al miembro ancla y debe hacer referencia a query_name exactamente una vez.</i>  <i>Debe combinar el miembro recursivo con el miembro ancla utilizando el operador de conjunto UNION ALL.</i> <br><br>  Pero contradice el siguiente p치rrafo de la documentaci칩n: <br><br>  <i>El miembro recursivo no puede contener ninguno de los siguientes elementos:</i> <i><br></i>  <i>La palabra clave DISTINCT o una cl치usula GROUP BY</i> <i><br></i>  <i>Una funci칩n agregada.</i>  <i>Sin embargo, las funciones anal칤ticas est치n permitidas en la lista de selecci칩n.</i> <br><br>  Por lo tanto, en el miembro recursivo, los agregados y la agrupaci칩n no est치n permitidos. <br><br><h3>  Prueba </h3><br><br>  Hag치moslo primero para <b>Oracle</b> . <br><br>  Realice el procedimiento de c치lculo para el m칠todo CALC y registre el tiempo de su ejecuci칩n: <br><br><pre> <code class="sql hljs">exec THINNING_HABR_CALC_T</code> </pre> <br>  Los resultados del c치lculo para los cuatro m칠todos est치n en cuatro vistas: <br><br><ul><li>  THINNING_HABR_SIMP_V (realizar치 el c치lculo, causando una SELECCI칍N compleja, por lo que tomar치 mucho tiempo), </li><li>  THINNING_HABR_CALC_V (mostrar치 los datos de la tabla QUOTES_CALC, por lo que se ejecutar치 r치pidamente) </li><li>  THINNING_HABR_CHIN_V (tambi칠n realizar치 el c치lculo, causando un SELECT complejo, por lo que tomar치 mucho tiempo), </li><li>  THINNING_HABR_PPTF_V (ejecutar치 la funci칩n THINNING_HABR_PPTF). </li></ul><br>  El tiempo de entrega de todos los m칠todos ya lo he medido y se muestra en la tabla al final del art칤culo. <br><br>  Para el resto de VIEW, ejecutamos las solicitudes y escribimos el tiempo de ejecuci칩n: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_XXXX_V</code> </pre><br>  donde XXXX es SIMP, CHIN, PPTF. <br><br>  Estas vistas calculan el resumen del reclutamiento.  Para calcular el resumen, debe buscar todas las l칤neas y, utilizando el resumen, puede comparar los conjuntos entre s칤. <br><br>  Tambi칠n puede comparar conjuntos utilizando el paquete dbms_sqlhash, pero esto es mucho m치s lento porque necesita ordenar el conjunto original y el c치lculo de hash no es r치pido. <br>  Tambi칠n en 12c hay un paquete DBMS_COMPARISON. <br><br>  Puede verificar la correcci칩n de todos los algoritmos al mismo tiempo.  Consideramos los res칰menes como tal solicitud (con 11 millones de entradas en una m치quina virtual, esto ser치 relativamente largo, aproximadamente 15 minutos): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'SIMP'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALG_NAME, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_SIMP_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CALC'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CALC_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CHIN'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CHIN_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'PPTF'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_PPTF_V a) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ALG_NAME , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> ALG_NAME;</code> </pre><br>  Vemos que los res칰menes son los mismos, por lo que todos los algoritmos dieron los mismos resultados. <br><br>  Ahora vamos a reproducir todo lo mismo en <b>MS SQL</b> .  Prob칠 en la versi칩n 2016. <br><br>  Primero cree la base de datos DBTEST, luego cree una tabla de transacciones en ella: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> TRANSACTIONS_RAW ( STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span> (<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">identity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> );</code> </pre><br>  Descargue los datos descargados. <br><br>  En MSSQL, cree el archivo format_mssql.bcp: <br><br><pre> <code class="sql hljs">12.0 3 1 SQLCHAR 0 0 "," 3 UT "" 2 SQLCHAR 0 0 "," 4 APRICE "" 3 SQLCHAR 0 0 "\n" 5 AVOLUME ""</code> </pre><br>  Y ejecute el script LoadData-MSSQL.sql en SSMS (este script fue generado por el 칰nico script de PowerShell proporcionado en la secci칩n de este art칤culo para Oracle). <br><br>  Creemos dos funciones: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> TRUNC_UT (@p_UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>, @p_StripeTypeId <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> @p_StripeTypeId <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">600</span></span> * <span class="hljs-number"><span class="hljs-number">600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">3600</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">14400</span></span> * <span class="hljs-number"><span class="hljs-number">14400</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span> * <span class="hljs-number"><span class="hljs-number">86400</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime), <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(m, <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (m, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime))), <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime), <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(yy, <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (yy, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime))), <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> UT2DATESTR (@p_UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(s, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Procedemos a implementar las opciones: </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Opci칩n 1 - SIMP </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ejecutar: </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.THINNING_HABR_SIMP_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> STRIPE_ID &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) , T2 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID , STOCK_NAME , dbo.TRUNC_UT (UT, STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (<span class="hljs-number"><span class="hljs-number">1000000</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_UT , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (<span class="hljs-number"><span class="hljs-number">1000000</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW, T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, dbo.TRUNC_UT (UT, STRIPE_ID)) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.STRIPE_ID, t.STOCK_NAME, t.UT, t_op.APRICE <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN, t.AHIGH , t.ALOW, t_cl.APRICE <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T2 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT / <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_op.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT % <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_op.ID) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT / <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_cl.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT % <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_cl.ID);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primeras / 칰ltimas</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> funciones que faltan se </font><font style="vertical-align: inherit;">implementan mediante la doble uni칩n de tabla.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Opci칩n 2 - CALC </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Crear una tabla, procedimiento y vista: </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> dbo.QUOTES_CALC ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ); go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> dbo.THINNING_HABR_CALC <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">truncate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> QUOTES_CALC; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @StripeId <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME , UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_ID , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_ID , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT) <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, t.STOCK_NAME, t.UT, t_op.APRICE, t.AHIGH, t.ALOW, t_cl.APRICE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.UT = t_op.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_ID = t_op.ID) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.UT = t_cl.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_ID = t_cl.ID); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @StripeId = <span class="hljs-number"><span class="hljs-number">1</span></span>; while (@StripeId &lt;= 9) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME , dbo.TRUNC_UT (UT, @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_UT , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> QUOTES_CALC <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> STRIPE_ID = @StripeId <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, dbo.TRUNC_UT (UT, @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>, t.STOCK_NAME, t.UT, t_op.AOPEN, t.AHIGH, t.ALOW, t_cl.ACLOSE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> QUOTES_CALC t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT = t_op.UT) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> QUOTES_CALC t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT = t_cl.UT) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> t_op.STRIPE_ID = @StripeId <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t_cl.STRIPE_ID = @StripeId; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @StripeId = @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.THINNING_HABR_CALC_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.QUOTES_CALC; go</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No implement칠 las opciones 3 (CHIN) y 4 (UDAF) en MS SQL. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Opci칩n 5 - PPTF </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear una funci칩n de tabla y ver. </font><font style="vertical-align: inherit;">Esta funci칩n es solo una funci칩n de tabla, no una funci칩n de tabla canalizada paralela, solo la opci칩n ha conservado su nombre hist칩rico de Oracle:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> dbo.THINNING_HABR_PPTF () <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> @rettab <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @i tinyint; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @tut <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @QuoteTail <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> clustered , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> fast_forward <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, APRICE, AVOLUME <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>; <span class="hljs-comment"><span class="hljs-comment">-- THIS ORDERING (STOCK_NAME, UT, ID) IS MANDATORY open c; fetch next from c into @trans_STOCK_NAME, @trans_UT, @trans_ID, @trans_APRICE, @trans_AVOLUME; while @@fetch_status = 0 begin if @trans_STOCK_NAME &lt;&gt; @trans_prev_STOCK_NAME or @trans_prev_STOCK_NAME is null begin insert into @rettab select * from @QuoteTail; delete @QuoteTail; end; set @i = 10; while @i &gt;= 1 begin set @tut = dbo.TRUNC_UT (@trans_UT, @i); if @tut &lt;&gt; (select UT from @QuoteTail where STRIPE_ID = @i) begin insert into @rettab select * from @QuoteTail where STRIPE_ID &lt;= @i; delete @QuoteTail where STRIPE_ID &lt;= @i; end; if (select count (*) from @QuoteTail where STRIPE_ID = @i) = 0 begin insert into @QuoteTail (STRIPE_ID, STOCK_NAME, UT, AOPEN, AVOLUME, AAMOUNT, ACOUNT) values (@i, @trans_STOCK_NAME, @tut, @trans_APRICE, 0, 0, 0); end; update @QuoteTail set AHIGH = case when AHIGH &lt; @trans_APRICE or AHIGH is null then @trans_APRICE else AHIGH end , ALOW = case when ALOW &gt; @trans_APRICE or ALOW is null then @trans_APRICE else ALOW end , ACLOSE = @trans_APRICE, AVOLUME = AVOLUME + @trans_AVOLUME , AAMOUNT = AAMOUNT + @trans_APRICE * @trans_AVOLUME , ACOUNT = ACOUNT + 1 where STRIPE_ID = @i; set @i = @i - 1; end; set @trans_prev_STOCK_NAME = @trans_STOCK_NAME; set @trans_prev_UT = @trans_UT; set @trans_prev_ID = @trans_ID; set @trans_prev_APRICE = @trans_APRICE; set @trans_prev_AVOLUME = @trans_AVOLUME; fetch next from c into @trans_STOCK_NAME, @trans_UT, @trans_ID, @trans_APRICE, @trans_AVOLUME; end; close c; deallocate c; insert into @rettab select * from @QuoteTail; return; end go create or alter view dbo.THINNING_HABR_PPTF_V as select * from dbo.THINNING_HABR_PPTF ();</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Calculemos la tabla QUOTES_CALC para el m칠todo CALC y escriba el tiempo de ejecuci칩n: </font></font><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> exec dbo.THINNING_HABR_CALC</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Los resultados del c치lculo para los tres m칠todos est치n en tres vistas: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> THINNING_HABR_SIMP_V (realizar치 el c치lculo, causando una SELECCI칍N compleja, por lo que tomar치 mucho tiempo), </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> THINNING_HABR_CALC_V (mostrar치 los datos de la tabla QUOTES_CALC, por lo que se ejecutar치 r치pidamente) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> THINNING_HABR_PPTF_V (ejecutar치 la funci칩n THINNING_HABR_PPTF). </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Para dos VIEWs, ejecutamos las solicitudes y escribimos el tiempo de ejecuci칩n: </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_XXXX_V</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">donde XXXX es SIMP, PPTF. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora puede comparar los resultados de c치lculo para los tres m칠todos para MS SQL. </font><font style="vertical-align: inherit;">Esto se puede hacer en una sola solicitud. </font><font style="vertical-align: inherit;">Ejecutar:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'SIMP'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALG_NAME, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_SIMP_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CALC'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CALC_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'PPTF'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_PPTF_V a) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ALG_NAME , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (STRIPE_ID <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> ALG_NAME;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si tres l칤neas coinciden en todos los campos, el resultado del c치lculo utilizando los tres m칠todos es id칠ntico. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le recomiendo encarecidamente que utilice una peque침a selecci칩n en la etapa de prueba, porque el rendimiento de esta tarea en MS SQL es bajo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si solo tiene el motor MS SQL y desea calcular una mayor cantidad de datos, puede probar el siguiente m칠todo de optimizaci칩n: puede crear 칤ndices:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> TRANSACTIONS_RAW_I1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> TRANSACTIONS_RAW (STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> QUOTES_CALC_I1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Los resultados de medir el rendimiento en mi m치quina virtual son los siguientes: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ss/4s/7x/ss4s7xhwteedzj1qgsjmb20hvvw.png" alt="imagen"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las secuencias de comandos se pueden descargar desde </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Oracle, el esquema THINNING (las secuencias de comandos de este art칤culo, el esquema </font><font style="vertical-align: inherit;">THINNING_LIVE), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descargando</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> datos en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l칤nea</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> desde bitcoincharts.com y </font><i><font style="vertical-align: inherit;">adelgazamiento en l칤nea</font></i><font style="vertical-align: inherit;"> (pero este sitio solo </font><font style="vertical-align: inherit;">env칤a </font><font style="vertical-align: inherit;">datos de los 칰ltimos 5 d칤as en modo en l칤nea) y el script para MS SQL tambi칠n en este art칤culo. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi칩n:</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> esta tarea se resuelve m치s r치pido en Oracle que en MS SQL. Con el aumento en el n칰mero de transacciones, la brecha se est치 volviendo m치s significativa. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En Oracle, PPTF era la mejor opci칩n. Aqu칤 el enfoque procesal result칩 ser m치s rentable, esto sucede con poca frecuencia. Otros m칠todos tambi칠n mostraron un resultado aceptable: incluso prob칠 el volumen de transacciones de 367 millones en una m치quina virtual (el m칠todo PPTF calcul칩 el adelgazamiento en una hora y media).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En MS SQL, el m칠todo de c치lculo iterativo (CALC) result칩 ser el m치s productivo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">쯇or qu칠 el m칠todo PPTF en Oracle result칩 ser el l칤der? </font><font style="vertical-align: inherit;">Debido a la concurrencia y la arquitectura, una funci칩n que se crea como una funci칩n de tabla canalizada paralela est치 incrustada en el medio del plan de consulta:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/za/ss/nl/zassnleqabvacrdkxnumjhd5mky.png" alt="imagen"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es418757/">https://habr.com/ru/post/es418757/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es418743/index.html">Historia del primer lugar en ML Boot Camp VI</a></li>
<li><a href="../es418747/index.html">Resoluci칩n de problemas: 쯖칩mo resolver eficazmente los problemas en un equipo?</a></li>
<li><a href="../es418751/index.html">Dex imp칰dico esp칤a chino</a></li>
<li><a href="../es418753/index.html">vSAN en la nube de VMware</a></li>
<li><a href="../es418755/index.html">C칩mo el comercio electr칩nico sobrevive a las promociones a gran escala. Prepar치ndose para las cargas m치ximas en la web [Parte 1]</a></li>
<li><a href="../es418759/index.html">쮺u치nto le cuesta a un estudiante emitir un chip?</a></li>
<li><a href="../es418761/index.html">El libro "Pure Python. Las sutilezas de la programaci칩n para profesionales 췉</a></li>
<li><a href="../es418763/index.html">Middle / senior: 쯖칩mo salir del pantano?</a></li>
<li><a href="../es418765/index.html">Los consejos de datos ayudan a completar cualquier formulario de entrada. Ahora sanar</a></li>
<li><a href="../es418767/index.html">El enorme legado de juegos de Adobe Flash y mis intentos de salvarlo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>