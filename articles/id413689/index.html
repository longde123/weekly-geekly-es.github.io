<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍💻 🖋️ 🙇🏿 Debian + Postfix + Dovecot + Multidomain + SSL + IPv6 + OpenVPN + Multi-interface + SpamAssassin-learn + Bind 👨🏾 🐢 👨‍🚀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Artikel ini adalah tentang cara mengatur server email modern. 
 Postfix + Dovecot. SPF + DKIM + rDNS. Dengan IPv6. 
 Dengan Enkripsi TLS. Dengan dukun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Debian + Postfix + Dovecot + Multidomain + SSL + IPv6 + OpenVPN + Multi-interface + SpamAssassin-learn + Bind</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413689/">  Artikel ini adalah tentang cara mengatur server email modern. <br>  Postfix + Dovecot.  SPF + DKIM + rDNS.  Dengan IPv6. <br>  Dengan Enkripsi TLS.  Dengan dukungan untuk beberapa domain - berpisah dengan sertifikat SSL asli. <br>  Dengan perlindungan anti-spam dan peringkat anti-spam yang tinggi pada server email lainnya. <br>  Dengan dukungan untuk beberapa antarmuka fisik. <br>  Dengan OpenVPN, yang terhubung melalui IPv4, dan yang memberikan IPv6. <br><br>  Jika Anda tidak ingin mempelajari semua teknologi ini, tetapi ingin mengkonfigurasi server seperti itu, maka artikel ini adalah untuk Anda. <br><br>  Tidak ada upaya untuk menjelaskan setiap detail dalam artikel.  Penjelasannya adalah apa yang tidak dikonfigurasi secara standar atau penting dari sudut pandang konsumen. <br><a name="habracut"></a><br>  Motivasi untuk membuat server surat adalah impian lama saya.  Ini mungkin terdengar konyol, tapi IMHO, jauh lebih baik daripada memimpikan mobil baru dari merek favorit Anda. <br><br>  Motivasi untuk mengkonfigurasi IPv6 adalah dua.  Profesional TI perlu mempelajari teknologi baru secara terus-menerus agar dapat bertahan hidup.  Saya ingin memberikan kontribusi sederhana saya untuk memerangi sensor. <br><br>  Motivasi untuk mengatur OpenVPN hanya untuk IPv6 untuk bekerja pada mesin lokal. <br>  Motivasi untuk mengatur beberapa antarmuka fisik adalah pada server saya satu antarmuka "lambat tapi tidak terbatas" dan yang lainnya "cepat, tetapi dengan tarif". <br><br>  Motivasi untuk mengatur pengaturan Bind adalah bahwa penyedia saya menyediakan server DNS yang tidak stabil, dan google juga macet.  Saya ingin server DNS yang stabil untuk penggunaan pribadi. <br><br>  Motivasi untuk menulis artikel - draft ditulis 10 bulan yang lalu, dan saya sudah melihatnya dua kali.  Jika bahkan penulis secara teratur membutuhkan ini, maka ada kemungkinan besar bahwa orang lain akan membutuhkannya. <br><br>  Tidak ada solusi universal untuk server email.  Tetapi saya akan mencoba menulis sesuatu seperti "lakukan seperti ini lalu, ketika semuanya berjalan sebagaimana mestinya - buang kelebihannya". <br><br>  Ada server Colocation dari tech.ru.  Dimungkinkan untuk membandingkan dengan OVH, Hetzner, AWS.  Untuk mengatasi masalah ini, kerjasama dengan tech.ru akan jauh lebih efektif. <br><br>  Debian 9 diinstal di server. <br><br>  Di server 2 adalah antarmuka `eno1` dan` eno2`.  Yang pertama tidak terbatas, dan yang kedua cepat, masing-masing. <br><br>  Ada 3 alamat IP statis, XX.XX.XX.X0 dan XX.XX.XX.X1 dan XX.XX.XX.X2 pada antarmuka `eno1` dan XX.XX.XX.X5 pada antarmuka` eno2`. <br><br>  Ada XXXX: XXXX: XXXX: XXXX :: / 64 kumpulan alamat IPv6 yang ditugaskan ke antarmuka `eno1` dan darinya XXXX: XXXX: XXXX: XXXX: XXXX: 1: 2 :: / 96 atas permintaan saya ditugaskan ke` eno2`. <br><br>  Ada 3 domain `domain1.com`,` domain2.com`, `domain3.com`.  Untuk `domain1.com` dan` domain3.com` ada sertifikat SSL. <br><br>  Ada akun google di mana Anda ingin mengikat kotak surat `vasya.pupkin @ domain1.com` (menerima surat dan mengirim surat langsung dari antarmuka gmail). <br>  Seharusnya ada kotak surat `support @ domain2.com`, salinan surat yang ingin saya lihat di gmail saya.  Dan jarang mungkin untuk mengirim sesuatu atas nama `support @ domain2.com` melalui antarmuka web. <br><br>  Seharusnya ada kotak surat `ivanov @ domain3.com`, yang akan digunakan Ivanov dari iPhone-nya. <br><br>  Surat yang dikirim harus mematuhi semua persyaratan anti-spam saat ini. <br>  Seharusnya ada tingkat enkripsi tertinggi yang disediakan pada jaringan publik. <br>  Harus ada dukungan IPv6 untuk mengirim dan menerima email. <br>  Harus ada SpamAssassin yang tidak akan pernah menghapus email.  Dan itu akan memantul atau melewati atau mengirim folder Spam ke IMAP. <br>  Pembelajaran otomatis SpamAssassin harus dikonfigurasi: jika saya memindahkan surat ke folder Spam, saya akan belajar dari ini;  jika saya memindahkan surat dari folder Spam, saya akan belajar dari ini.  Hasil belajar SpamAssassin - harus memengaruhi jangkauan pesan di folder Spam. <br>  Skrip Php harus dapat mengirim email atas nama domain apa pun di server ini. <br>  Harus ada layanan openvpn dengan kemampuan untuk menggunakan IPv6 pada klien yang tidak memiliki IPv6. <br><br>  Pertama, Anda perlu mengkonfigurasi antarmuka dan perutean, termasuk IPv6. <br>  Maka Anda perlu mengkonfigurasi OpenVPN, yang akan terhubung melalui IPv4 dan menyediakan klien dengan alamat IPv6 statis-nyata.  Klien ini akan memiliki akses ke semua layanan IPv6 di server dan akses ke sumber daya IPv6 di Internet. <br>  Maka akan diperlukan untuk mengkonfigurasi Postfix untuk mengirim surat + SPF + DKIM + rDNS dan hal-hal sepele yang serupa. <br>  Maka Anda perlu mengkonfigurasi Dovecot dan mengkonfigurasi Multidomain. <br>  Maka Anda perlu mengkonfigurasi SpamAssassin dan mengkonfigurasi pelatihan. <br>  Akhirnya, instal Bind. <br><br><h2>  ============== Multi-interface ============== </h2><br>  Untuk mengkonfigurasi antarmuka, Anda harus mendaftarkan ini di "/ etc / network / interfaces". <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># The loopback network interface auto lo iface lo inet loopback # The primary network interface allow-hotplug eno1 iface eno1 inet static address XX.XX.XX.X0/24 gateway XX.XX.XX.1 dns-nameservers 127.0.0.1 213.248.1.6 post-up ip route add XX.XX.XX.0/24 dev eno1 src XX.XX.XX.X0 table eno1t post-up ip route add default via XX.XX.XX.1 table eno1t post-up ip rule add table eno1t from XX.XX.XX.X0 post-up ip rule add table eno1t to XX.XX.XX.X0 auto eno1:1 iface eno1:1 inet static address XX.XX.XX.X1 netmask 255.255.255.0 post-up ip rule add table eno1t from XX.XX.XX.X1 post-up ip rule add table eno1t to XX.XX.XX.X1 post-up ip route add 10.8.0.0/24 dev tun0 src XX.XX.XX.X1 table eno1t post-down ip route del 10.8.0.0/24 dev tun0 src XX.XX.XX.X1 table eno1t auto eno1:2 iface eno1:2 inet static address XX.XX.XX.X2 netmask 255.255.255.0 post-up ip rule add table eno1t from XX.XX.XX.X2 post-up ip rule add table eno1t to XX.XX.XX.X2 iface eno1 inet6 static address X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1::/64 gateway X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">:1 up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:1/64 dev $IFACE up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:2/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:1/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:2/64 dev $IFACE # The secondary network interface allow-hotplug eno2 iface eno2 inet static address XX.XX.XX.X5 netmask 255.255.255.0 post-up ip route add XX.XX.XX.0/24 dev eno2 src XX.XX.XX.X5 table eno2t post-up ip route add default via XX.XX.XX.1 table eno2t post-up ip rule add table eno2t from XX.XX.XX.X5 post-up ip rule add table eno2t to XX.XX.XX.X5 post-up ip route add 10.8.0.0/24 dev tun0 src XX.XX.XX.X5 table eno2t post-down ip route del 10.8.0.0/24 dev tun0 src XX.XX.XX.X5 table eno2t iface eno2 inet6 static address X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2::/96 up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:1/64 dev $IFACE up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:2/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:1/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:2/64 dev $IFACE # OpenVPN network iface tun0 inet6 static address X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:3::/80</span></span></code> </pre> <br>  Pengaturan ini dapat diterapkan pada server mana pun di tech.ru (dengan sedikit koordinasi dengan dukungan) dan itu akan segera berfungsi sebagaimana mestinya. <br><br>  Jika pengalaman mengatur hal serupa untuk Hetzner, OVH - ada pacar.  Lebih keras. <br><br>  eno1 adalah nama kartu jaringan # 1 (lambat tapi tidak terbatas). <br>  eno2 adalah nama kartu jaringan # 2 (cepat, tetapi dengan tarif). <br>  tun0 adalah nama kartu jaringan virtual dari OpenVPN. <br>  XX.XX.XX.X0 - IPv4 # 1 pada eno1. <br>  XX.XX.XX.X1 - IPv4 # 2 pada eno1. <br>  XX.XX.XX.X2 - IPv4 # 3 pada eno1. <br>  XX.XX.XX.X5 - IPv4 # 1 pada eno2. <br>  XX.XX.XX.1 - gateway IPv4. <br>  XXXX: XXXX: XXXX: XXXX :: / 64 - IPv6 ke seluruh server. <br>  XXXX: XXXX: XXXX: XXXX: 1: 2 :: / 96 - IPv6 untuk eno2, yang lainnya masuk ke eno1 dari luar. <br>  XXXX: XXXX: XXXX: XXXX :: 1 - gateway IPv6 (perlu dicatat bahwa Anda dapat / perlu berteman di sini. Tunjukkan sakelar IPv6). <br>  dns-nameservers - 127.0.0.1 ditentukan (karena bind diinstal secara lokal) dan 213.248.1.6 (ini dari tech.ru). <br><br>  “Table eno1t” dan “table eno2t” - arti dari aturan rute ini adalah bahwa lalu lintas yang melewati eno1 -&gt; melewatinya, dan lalu lintas yang melewati eno2 -&gt; melewatinya.  Dan juga koneksi yang diprakarsai server akan melalui eno1. <br><br><pre> <code class="bash hljs">ip route add default via XX.XX.XX.1 table eno1t</code> </pre> <br>  Dengan perintah ini kami menetapkan bahwa setiap lalu lintas yang tidak dapat dipahami yang jatuh di bawah aturan apa pun dengan "table eno1t" ditandai -&gt; kirim ke antarmuka eno1. <br><br><pre> <code class="bash hljs">ip route add XX.XX.XX.0/24 dev eno1 src XX.XX.XX.X0 table eno1t</code> </pre> <br>  Dengan perintah ini kami mengatur bahwa mengarahkan lalu lintas yang diprakarsai server ke antarmuka eno1. <br><br><pre> <code class="bash hljs">ip rule add table eno1t from XX.XX.XX.X0 ip rule add table eno1t to XX.XX.XX.X0</code> </pre> <br>  Dengan perintah ini, kami menetapkan aturan untuk menandai lalu lintas sendiri. <br><br><pre> <code class="bash hljs">auto eno1:2 iface eno1:2 inet static address XX.XX.XX.X2 netmask 255.255.255.0 post-up ip rule add table eno1t from XX.XX.XX.X2 post-up ip rule add table eno1t to XX.XX.XX.X2</code> </pre> <br>  Blok ini mendefinisikan IPv4 kedua untuk antarmuka eno1. <br><br><pre> <code class="bash hljs">ip route add 10.8.0.0/24 dev tun0 src XX.XX.XX.X1 table eno1t</code> </pre> <br>  Dengan perintah ini kami mengatur rute dari klien OpenVPN ke IPv4 lokal kecuali XX.XX.XX.X0. <br>  Mengapa perintah ini cukup untuk semua IPv4 - Saya masih tidak mengerti. <br><br><pre> <code class="bash hljs">iface eno1 inet6 static address XXXX:XXXX:XXXX:XXXX:1:1::/64 gateway XXXX:XXXX:XXXX:XXXX::1</code> </pre> <br>  Ini kami atur alamat untuk antarmuka itu sendiri.  Server akan menggunakannya sebagai alamat "keluar".  Tidak akan lagi digunakan. <br><br>  Mengapa ditunjukkan ": 1: 1 ::" sangat rumit?  OpenVPN itu bekerja dengan benar dan hanya untuk ini.  Lebih lanjut tentang ini nanti. <br><br>  Pada topik gateway - begitulah cara kerjanya.  Tetapi dengan cara yang benar - di sini Anda harus menentukan saklar IPv6 yang terhubung dengan server. <br><br>  Namun, untuk beberapa alasan, IPv6 berhenti berfungsi jika saya melakukan ini.  Mungkin ini beberapa masalah tech.ru. <br><br><pre> <code class="bash hljs">ip -6 addr add XXXX:XXXX:XXXX:XXXX:1:1:1:1/64 dev <span class="hljs-variable"><span class="hljs-variable">$IFACE</span></span></code> </pre> <br>  Ini menambahkan alamat IPv6 ke antarmuka.  Jika Anda memerlukan seratus alamat, artinya seratus baris dalam file ini. <br><br><pre> <code class="bash hljs">iface eno1 inet6 static address XXXX:XXXX:XXXX:XXXX:1:1::/64 ... iface eno2 inet6 static address XXXX:XXXX:XXXX:XXXX:1:2::/96 ... iface tun0 inet6 static address XXXX:XXXX:XXXX:XXXX:1:3::/80</code> </pre> <br><blockquote>  Tandai alamat dan subnet semua antarmuka sehingga jelas. <br>  id1 - harus "/ 64" - karena ini adalah kumpulan alamat kami. <br>  tun0 - subnet harus lebih besar dari eno1.  Jika tidak, Anda tidak dapat mengkonfigurasi gateway IPv6 untuk klien OpenVPN. <br>  eno2 - subnet harus lebih besar dari tun0.  Jika tidak, klien OpenVPN tidak akan bisa mendapatkan alamat IPv6 lokal. <br>  Untuk kejelasan, saya memilih subnet langkah 16, tetapi Anda bahkan dapat mengambil langkah “1” jika Anda mau. <br>  Dengan demikian, 64 + 16 = 80, dan 80 + 16 = 96. <br><br>  Untuk kejelasan yang lebih besar: <br>  XXXX: XXXX: XXXX: XXXX: 1: 1: YYYY: YYYY - ini adalah alamat yang harus ditetapkan ke situs atau layanan tertentu pada antarmuka eno1. <br>  XXXX: XXXX: XXXX: XXXX: 1: 2: YYYY: YYYY - ini adalah alamat yang harus ditetapkan ke situs atau layanan tertentu pada antarmuka eno2. <br>  XXXX: XXXX: XXXX: XXXX: 1: 3: YYYY: YYYY adalah alamat yang harus ditetapkan untuk klien OpenVPN atau digunakan sebagai alamat layanan OpenVPN. </blockquote><br><br>  Untuk mengkonfigurasi jaringan - harus dimungkinkan untuk me-restart server. <br>  Perubahan IPv4 diambil selama eksekusi (pastikan untuk membungkusnya di layar - jika tidak, perintah ini hanya akan menjatuhkan jaringan di server): <br><br><pre> <code class="bash hljs">/etc/init.d/networking restart</code> </pre> <br>  Dalam file "/ etc / iproute2 / rt_tables" tambahkan di akhir: <br><br><pre> <code class="bash hljs">100 eno1t 101 eno2t</code> </pre> <br>  Tanpa ini, Anda tidak dapat menggunakan tabel khusus di file "/ etc / network / interfaces". <br>  Angka-angka harus unik dan kurang dari 65535. <br><br>  Perubahan IPv6 berubah dengan mudah tanpa me-reboot, tetapi untuk ini Anda perlu mempelajari setidaknya tiga perintah: <br><br><pre> <code class="bash hljs">ip -6 addr ... ip -6 route ... ip -6 neigh ...</code> </pre> <br>  Menyiapkan "/etc/sysctl.conf" <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Uncomment the next line to enable packet forwarding for IPv4 net.ipv4.ip_forward = 1 # Do not accept ICMP redirects (prevent MITM attacks) net.ipv4.conf.all.accept_redirects = 0 net.ipv6.conf.all.accept_redirects = 0 # Do not send ICMP redirects (we are not a router) net.ipv4.conf.all.send_redirects = 0 # For receiving ARP replies net.ipv4.conf.all.arp_filter = 0 net.ipv4.conf.default.arp_filter = 0 # For sending ARP net.ipv4.conf.all.arp_announce = 0 net.ipv4.conf.default.arp_announce = 0 # Enable IPv6 net.ipv6.conf.all.disable_ipv6 = 0 net.ipv6.conf.default.disable_ipv6 = 0 net.ipv6.conf.lo.disable_ipv6 = 0 # IPv6 configuration net.ipv6.conf.all.autoconf = 1 net.ipv6.conf.all.accept_ra = 0 # For OpenVPN net.ipv6.conf.all.forwarding = 1 net.ipv6.conf.all.proxy_ndp = 1 # For nginx on boot net.ipv6.ip_nonlocal_bind = 1</span></span></code> </pre> <br>  Ini adalah pengaturan sysctl dari server saya.  Saya perhatikan yang penting. <br><br><pre> <code class="bash hljs">net.ipv4.ip_forward = 1</code> </pre> <br>  Tanpa ini, OpenVPN tidak akan berfungsi dengan cara apa pun. <br><br><pre> <code class="bash hljs">net.ipv6.ip_nonlocal_bind = 1</code> </pre> <br>  Siapa pun yang mencoba mengikat IPv6 (misalnya nginx) segera setelah antarmuka habis akan mendapatkan kesalahan.  Bahwa alamat seperti itu tidak tersedia. <br><br>  Untuk menghindari situasi seperti itu, pengaturan semacam itu dibuat. <br><br><pre> <code class="bash hljs">net.ipv6.conf.all.forwarding = 1 net.ipv6.conf.all.proxy_ndp = 1</code> </pre> <br>  Tanpa pengaturan IPv6 ini, lalu lintas dari klien OpenVPN tidak masuk ke dunia. <br><br>  Pengaturan lain tidak relevan atau saya tidak ingat mengapa itu terjadi. <br>  Tapi untuk berjaga-jaga, saya meninggalkan "apa adanya." <br><br>  Agar perubahan dalam file ini diambil tanpa me-reboot server, Anda perlu menjalankan perintah: <br><br><pre> <code class="bash hljs">sysctl -p</code> </pre> <br>  Lebih detail tentang aturan "table": <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">habr.com/post/108690</a> <br><br><h2>  ============== OpenVPN ============== </h2><br>  OpenVPN IPv4 tidak berfungsi tanpa iptables. <br><br>  Saya punya iptables untuk VPN ini: <br><br><pre> <code class="bash hljs">iptables -A INPUT -p udp -s YY.YY.YY.YY --dport 1194 -j ACCEPT iptables -A FORWARD -i tun0 -o eno1 -j ACCEPT iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j SNAT --to-source XX.XX.XX.X0 <span class="hljs-comment"><span class="hljs-comment">##iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j MASQUERADE iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -p udp --dport 1194 -j DROP iptables -A FORWARD -p udp --dport 1194 -j DROP</span></span></code> </pre> <br>  YY.YY.YY.YY adalah alamat IPv4 statis saya dari mesin lokal. <br>  10.8.0.0/24 - jaringan openvpn IPv4.  Alamat IPv4 untuk klien openvpn. <br>  Urutan aturan itu penting. <br><br><pre> <code class="bash hljs">iptables -A INPUT -p udp -s YY.YY.YY.YY --dport 1194 -j ACCEPT iptables -A FORWARD -i tun0 -o eno1 -j ACCEPT ... iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -p udp --dport 1194 -j DROP iptables -A FORWARD -p udp --dport 1194 -j DROP</code> </pre> <br>  Ini adalah batasan sehingga hanya saya yang bisa menggunakan OpenVPN dari IP statis saya. <br><br><pre> <code class="bash hljs">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j SNAT --to-source XX.XX.XX.X0 --  -- iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j MASQUERADE</code> </pre> <br>  Untuk meneruskan paket IPv4 antara klien OpenVPN dan Internet, Anda harus mendaftarkan salah satu dari perintah ini. <br><br>  Untuk kasus yang berbeda, salah satu opsi tidak cocok. <br>  Kedua tim cocok untuk kasus saya. <br>  Setelah membaca dokumentasi, saya memilih opsi pertama, karena makan lebih sedikit CPU. <br><br>  Sehingga semua pengaturan iptables diambil setelah reboot - Anda perlu menyimpannya di suatu tempat. <br><br><pre> <code class="bash hljs">iptables-save &gt; /etc/iptables/rules.v4 ip6tables-save &gt; /etc/iptables/rules.v6</code> </pre> <br>  Nama-nama seperti itu tidak dipilih secara kebetulan.  Paket iptables-persistent menggunakannya. <br><br><pre> <code class="bash hljs">apt-get install iptables-persistent</code> </pre> <br>  Menginstal paket OpenVPN utama: <br><br><pre> <code class="bash hljs">apt-get install openvpn easy-rsa</code> </pre> <br>  Siapkan templat untuk sertifikat (ganti nilai Anda): <br><br><pre> <code class="bash hljs">make-cadir ~/openvpn-ca <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca ln -s openssl-1.0.0.cnf openssl.cnf</code> </pre> <br>  Mari mengedit pengaturan templat sertifikat: <br><br><pre> <code class="bash hljs">mcedit vars</code> </pre> <br><pre> <code class="bash hljs">... <span class="hljs-comment"><span class="hljs-comment"># These are the default values for fields # which will be placed in the certificate. # Don't leave any of these fields blank. export KEY_COUNTRY="RU" export KEY_PROVINCE="Krasnodar" export KEY_CITY="Dinskaya" export KEY_ORG="Own" export KEY_EMAIL="admin@domain1.com" export KEY_OU="VPN" # X509 Subject Field export KEY_NAME="server" ...</span></span></code> </pre> <br>  Buat sertifikat server: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> vars ./clean-all ./build-ca ./build-key-server server ./build-dh openvpn --genkey --secret keys/ta.key</code> </pre> <br>  Kami akan mempersiapkan peluang untuk membuat file "client-name.opvn" yang dihasilkan: <br><br><pre> <code class="bash hljs">mkdir -p ~/client-configs/files chmod 700 ~/client-configs/files cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf ~/client-configs/base.conf mcedit ~/client-configs/base.conf</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Client mode client # Interface tunnel type dev tun # TCP protocol proto tcp-client # Address/Port of VPN server remote XX.XX.XX.X0 1194 # Don't bind to local port/address nobind # Don't need to re-read keys and re-create tun at restart persist-key persist-tun # Remote peer must have a signed certificate remote-cert-tls server ns-cert-type server # Enable compression comp-lzo # Custom ns-cert-type server tls-auth ta.key 1 cipher DES-EDE3-CBC</span></span></code> </pre> <br>  Kami akan menyiapkan skrip yang akan menjahit semua file menjadi satu file tunggal. <br><br><pre> <code class="bash hljs">mcedit ~/client-configs/make_config.sh chmod 700 ~/client-configs/make_config.sh</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # First argument: Client identifier KEY_DIR=~/openvpn-ca/keys OUTPUT_DIR=~/client-configs/files BASE_CONFIG=~/client-configs/base.conf cat ${BASE_CONFIG} \ &lt;(echo -e '&lt;ca&gt;') \ ${KEY_DIR}/ca.crt \ &lt;(echo -e '&lt;/ca&gt;\n&lt;cert&gt;') \ ${KEY_DIR}/${1}.crt \ &lt;(echo -e '&lt;/cert&gt;\n&lt;key&gt;') \ ${KEY_DIR}/${1}.key \ &lt;(echo -e '&lt;/key&gt;\n&lt;tls-auth&gt;') \ ${KEY_DIR}/ta.key \ &lt;(echo -e '&lt;/tls-auth&gt;') \ &gt; ${OUTPUT_DIR}/${1}.ovpn</span></span></code> </pre> <br>  Kami membuat klien OpenVPN pertama: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> vars ./build-key client-name <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/client-configs ./make_config.sh client-name</code> </pre> <br>  File "~ / client-configs / files / client-name.ovpn" dikirim ke klien. <br><br>  Untuk klien iOS, Anda perlu melakukan trik: <br>  Isi dari tag tls-auth harus tanpa komentar. <br>  Dan juga letakkan "key-direction 1" tepat sebelum tag "tls-auth". <br><br>  Konfigurasikan konfigurasi server OpenVPN: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca/keys cp ca.crt ca.key server.crt server.key ta.key dh2048.pem /etc/openvpn gunzip -c /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz | tee /etc/openvpn/server.conf mcedit /etc/openvpn/server.conf</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Listen port port 1194 # Protocol proto tcp-server # IP tunnel dev tun0 tun-ipv6 push tun-ipv6 # Master certificate ca ca.crt # Server certificate cert server.crt # Server private key key server.key # Diffie-Hellman parameters dh dh2048.pem # Allow clients to communicate with each other client-to-client # Client config dir client-config-dir /etc/openvpn/ccd # Run client-specific script on connection and disconnection script-security 2 client-connect "/usr/bin/sudo -u root /etc/openvpn/server-clientconnect.sh" client-disconnect "/usr/bin/sudo -u root /etc/openvpn/server-clientdisconnect.sh" # Server mode and client subnets server 10.8.0.0 255.255.255.0 server-ipv6 X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:3::/80 topology subnet # IPv6 routes push "route-ipv6 X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">:/64" push "route-ipv6 2000::/3" # DNS (for Windows) # These are OpenDNS push "dhcp-option DNS 208.67.222.222" push "dhcp-option DNS 208.67.220.220" # Configure all clients to redirect their default network gateway through the VPN push "redirect-gateway def1 bypass-dhcp" push "redirect-gateway ipv6" #For iOS # Don't need to re-read keys and re-create tun at restart persist-key persist-tun # Ping every 10s. Timeout of 120s. keepalive 10 120 # Enable compression comp-lzo # User and group user vpn group vpn # Log a short status status openvpn-status.log # Logging verbosity ##verb 4 # Custom config tls-auth ta.key 0 cipher DES-EDE3-CBC</span></span></code> </pre> <br>  Ini diperlukan untuk menetapkan alamat statis untuk setiap klien (tidak perlu, tetapi saya menggunakan): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Client config dir client-config-dir /etc/openvpn/ccd</span></span></code> </pre> <br>  Detail paling sulit dan utama. <br><br>  Sayangnya, OpenVPN belum dapat mengkonfigurasi gateway IPv6 untuk klien secara independen. <br>  Kami harus meneruskan ini secara manual untuk setiap klien. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Run client-specific script on connection and disconnection script-security 2 client-connect "/usr/bin/sudo -u root /etc/openvpn/server-clientconnect.sh" client-disconnect "/usr/bin/sudo -u root /etc/openvpn/server-clientdisconnect.sh"</span></span></code> </pre> <br>  File "/etc/openvpn/server-clientconnect.sh": <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # Check client variables if [ -z "$ifconfig_pool_remote_ip" ] || [ -z "$common_name" ]; then echo "Missing environment variable." exit 1 fi # Load server variables . /etc/openvpn/variables ipv6="" # Find out if there is a specific config with fixed IPv6 for this client if [ -f "/etc/openvpn/ccd/$common_name" ]; then # Get fixed IPv6 from client config file ipv6=$(sed -nr 's/^.*ifconfig-ipv6-push[ \t]+([0-9a-fA-F\\:]+).*$/\1/p' "/etc/openvpn/ccd/$common_name") echo $ipv6 fi # Get IPv6 from IPv4 if [ -z "$ipv6" ]; then ipp=$(echo "$ifconfig_pool_remote_ip" | cut -d. -f4) if ! [ "$ipp" -ge 2 -a "$ipp" -le 254 ] 2&gt;/dev/null; then echo "Invalid IPv4 part." exit 1 fi hexipp=$(printf '%x' $ipp) ipv6="$prefix$hexipp" fi # Create proxy rule /sbin/ip -6 neigh add proxy $ipv6 dev eno1</span></span></code> </pre> <br><br>  File "/etc/openvpn/server-clientdisconnect.sh": <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # Check client variables if [ -z "$ifconfig_pool_remote_ip" ] || [ -z "$common_name" ]; then echo "Missing environment variable." exit 1 fi # Load server variables . /etc/openvpn/variables ipv6="" # Find out if there is a specific config with fixed IPv6 for this client if [ -f "/etc/openvpn/ccd/$common_name" ]; then # Get fixed IPv6 from client config file ipv6=$(sed -nr 's/^.*ifconfig-ipv6-push[ \t]+([0-9a-fA-F\\:]+).*$/\1/p' "/etc/openvpn/ccd/$common_name") fi # Get IPv6 from IPv4 if [ -z "$ipv6" ]; then ipp=$(echo "$ifconfig_pool_remote_ip" | cut -d. -f4) if ! [ "$ipp" -ge 2 -a "$ipp" -le 254 ] 2&gt;/dev/null; then echo "Invalid IPv4 part." exit 1 fi hexipp=$(printf '%x' $ipp) ipv6="$prefix$hexipp" fi # Delete proxy rule /sbin/ip -6 neigh del proxy $ipv6 dev eno1</span></span></code> </pre> <br>  Kedua skrip menggunakan file "/ etc / openvpn / variabel": <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Subnet prefix=X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">2: # netmask prefixlen=112</span></span></code> </pre> <br>  Mengapa itu tertulis di sini - Saya merasa sulit untuk diingat. <br><br>  Sekarang kelihatannya netmask aneh = 112 (di sana seharusnya 96). <br>  Dan awalannya aneh, tidak cocok dengan jaringan tun0. <br>  Tapi oke, saya biarkan "apa adanya." <br><br><pre> <code class="bash hljs">cipher DES-EDE3-CBC</code> </pre> <br>  Ini adalah amatir - saya memilih metode mengenkripsi koneksi. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Lebih lanjut tentang pengaturan OpenVPN IPv4.</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Lebih lanjut tentang pengaturan OpenVPN IPv6.</a> <br><br><h2>  ============== Postfix ============== </h2><br>  Menginstal paket utama: <br><br><pre> <code class="bash hljs">apt-get install postfix</code> </pre> <br>  Saat memasang, pilih "situs internet". <br><br>  "/Etc/postfix/main.cf" saya terlihat seperti ini: <br><br><pre> <code class="bash hljs">smtpd_banner = <span class="hljs-variable"><span class="hljs-variable">$myhostname</span></span> ESMTP <span class="hljs-variable"><span class="hljs-variable">$mail_name</span></span> (Debian/GNU) biff = no <span class="hljs-comment"><span class="hljs-comment"># appending .domain is the MUA's job. append_dot_mydomain = no readme_directory = no # See http://www.postfix.org/COMPATIBILITY_README.html -- default to 2 on # fresh installs. compatibility_level = 2 # TLS parameters smtpd_tls_cert_file=/etc/ssl/domain1.com.2018.chained.crt smtpd_tls_key_file=/etc/ssl/domain1.com.2018.key smtpd_use_tls=yes smtpd_tls_auth_only = yes smtp_bind_address = XX.XX.XX.X0 smtp_bind_address6 = X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:1 smtp_tls_security_level = may smtp_tls_ciphers = export smtp_tls_protocols = !SSLv2, !SSLv3 smtp_tls_loglevel = 1 smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination myhostname = domain1.com alias_maps = hash:/etc/aliases alias_database = hash:/etc/aliases myorigin = domain1.com mydestination = localhost relayhost = mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 mailbox_size_limit = 0 recipient_delimiter = + inet_interfaces = all inet_protocols = ipv4 internal_mail_filter_classes = bounce # Storage type virtual_transport = lmtp:unix:private/dovecot-lmtp virtual_mailbox_domains = mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf virtual_mailbox_maps = mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf virtual_alias_maps = mysql:/etc/postfix/mysql-virtual-alias-maps.cf # SMTP-Auth settings smtpd_sasl_type = dovecot smtpd_sasl_path = private/auth smtpd_sasl_auth_enable = yes smtpd_recipient_restrictions = permit_sasl_authenticated, permit_mynetworks, #reject_invalid_hostname, #reject_unknown_recipient_domain, reject_unauth_destination, reject_rbl_client sbl.spamhaus.org, check_policy_service unix:private/policyd-spf smtpd_helo_restrictions = #reject_invalid_helo_hostname, #reject_non_fqdn_helo_hostname, reject_unknown_helo_hostname smtpd_client_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_non_fqdn_helo_hostname, permit # SPF policyd-spf_time_limit = 3600 # OpenDKIM milter_default_action = accept milter_protocol = 6 smtpd_milters = unix:var/run/opendkim/opendkim.sock non_smtpd_milters = unix:var/run/opendkim/opendkim.sock # IP address per domain sender_dependent_default_transport_maps = pcre:/etc/postfix/sdd_transport.pcre</span></span></code> </pre> <br>  Mari kita pertimbangkan detail konfigurasi ini. <br><br><pre> <code class="bash hljs">smtpd_tls_cert_file=/etc/ssl/domain1.com.2018.chained.crt smtpd_tls_key_file=/etc/ssl/domain1.com.2018.key</code> </pre> <br><br><hr><blockquote><div class="spoiler">  <b class="spoiler_title">Menurut warga Khabrovsk, blok ini berisi `informasi yang salah dan tesis palsu`.</b> <div class="spoiler_text">  Hanya 8 tahun setelah dimulainya karir saya, saya mulai memahami cara kerja SSL. <br><br>  Oleh karena itu, saya akan bebas menjelaskan cara menggunakan SSL (tanpa menjawab pertanyaan "Bagaimana cara kerjanya?" Dan "Mengapa itu berfungsi?"). <br><br>  Dasar dari enkripsi modern adalah penciptaan pasangan kunci (dua baris karakter yang sangat panjang). <br><br>  Satu "kunci" adalah pribadi, yang lain adalah "publik".  Kami menjaga kunci pribadi dengan sangat rahasia.  Kami mendistribusikan kunci publik kepada semua orang. <br><br>  Dengan menggunakan kunci publik, Anda dapat mengenkripsi serangkaian teks sehingga hanya pemilik kunci pribadi yang dapat mendekripsi. <br>  Ya, itulah keseluruhan basis teknologi. <br><br>  Langkah # 1 - https situs. <br>  Saat mengakses situs, browser mengetahui dari server web bahwa situs tersebut adalah https dan karenanya meminta kunci publik. <br>  Server web memberikan kunci publik.  Menggunakan kunci publik, browser mengenkripsi permintaan http dan mengirimkannya. <br>  Konten permintaan http hanya dapat dibaca oleh seseorang yang memiliki kunci pribadi, yaitu, hanya server tempat panggilan dibuat. <br>  Http-request setidaknya mengandung URI.  Karena itu, jika negara berusaha membatasi akses tidak ke seluruh situs, tetapi ke halaman tertentu, maka untuk situs https ini tidak dapat dilakukan. <br><br>  Langkah # 2 adalah jawaban terenkripsi. <br>  Server web memberikan jawaban yang dapat dengan mudah dibaca di sepanjang jalan. <br>  Solusinya sangat sederhana - browser secara lokal menghasilkan pasangan kunci publik-publik yang sama untuk setiap situs https. <br>  Dan bersama dengan permintaan kunci publik dari situs, ia mengirimkan kunci publik lokalnya. <br>  Server web mengingatnya dan, ketika mengirim tanggapan http, mengenkripsi dengan kunci publik ini dari klien tertentu. <br>  Sekarang http-respons hanya dapat didekripsi oleh pemilik kunci pribadi browser klien (yaitu, klien itu sendiri). <br><br>  Langkah nomor 3 - membuat koneksi aman melalui saluran publik. <br>  Dalam contoh No. 2 ada kerentanan - tidak ada yang mencegah simpatisan baik dari mencegat permintaan http dan mengedit informasi kunci publik. <br>  Dengan demikian, perantara akan melihat hampir semua konten pesan yang dikirim dan diterima sampai saluran komunikasi berubah. <br>  Pertarungan ini sangat sederhana - cukup kirim kunci publik browser sebagai pesan yang dienkripsi dengan kunci publik dari server web. <br>  Server web kemudian mengirim respons seperti "kunci publik Anda seperti ini" dan mengenkripsi pesan ini dengan kunci publik yang sama. <br>  Browser melihat jawaban - jika pesan "kunci publik Anda seperti ini" diterima - maka ini adalah jaminan 100% bahwa saluran komunikasi ini aman. <br>  Seberapa amankah itu? <br>  Pembuatan saluran komunikasi yang aman itu sendiri terjadi pada kecepatan ping * 2.  Sebagai contoh, 20 ms. <br>  Seorang penyerang harus memiliki salah satu pihak kunci pribadi terlebih dahulu.  Atau ambil kunci pribadi selama beberapa milidetik. <br>  Meretas satu kunci pribadi modern akan memakan waktu puluhan tahun pada superkomputer. <br><br>  Langkah # 4 - database publik kunci publik. <br>  Jelas, dalam keseluruhan cerita ini ada kemungkinan penyerang duduk di saluran komunikasi antara klien dan server. <br>  Peluang untuk klien disajikan oleh server, dan ke server untuk disajikan oleh klien.  Dan meniru pasangan kunci di kedua arah. <br>  Kemudian penyerang akan melihat semua lalu lintas dan akan dapat "mengedit" lalu lintas. <br>  Misalnya, ubah alamat tempat mengirim uang atau menyalin kata sandi dari bank online atau memblokir konten yang “tidak menyenangkan”. <br>  Untuk memerangi penyerang seperti itu, mereka datang dengan database publik dengan kunci publik untuk setiap situs https. <br>  Setiap browser "tahu" tentang keberadaan sekitar 200 dari database ini.  Ini sudah diinstal sebelumnya di setiap browser. <br>  "Pengetahuan" didukung oleh kunci publik untuk setiap sertifikat.  Artinya, tidak mungkin memalsukan koneksi dengan masing-masing otoritas sertifikasi tertentu. <br><br>  Sekarang ada pemahaman sederhana tentang cara menggunakan SSL untuk https. <br>  Jika Anda memindahkan otak Anda, akan menjadi jelas bagaimana layanan khusus dapat memecahkan sesuatu dalam desain ini.  Tapi itu akan membebani mereka usaha yang sangat besar. <br>  Dan organisasi yang lebih kecil dari NSA atau CIA - hampir tidak mungkin untuk memecahkan tingkat perlindungan yang ada, bahkan untuk vip. <br><br>  Saya juga akan menambahkan tentang koneksi ssh.  Tidak ada kunci publik, apa yang harus dilakukan.  Masalah ini diselesaikan dengan dua cara. <br>  Opsi kata sandi ssh: <br>  Pada koneksi pertama, klien ssh harus memperingatkan bahwa di sini kita memiliki kunci publik baru dari server ssh. <br>  Dan dengan koneksi lebih lanjut, jika peringatan "kunci publik baru dari server ssh" muncul, itu berarti mereka mencoba mendengarkan Anda. <br>  Atau pada koneksi pertama yang Anda dengarkan, dan sekarang Anda berbicara ke server tanpa perantara. <br>  Sebenarnya, karena fakta bahwa penyadapan mudah, cepat dan mudah terungkap, serangan ini hanya digunakan dalam kasus-kasus khusus untuk klien tertentu. <br><br>  Opsi ssh kunci: <br>  Kami mengambil flash drive, menulis kunci pribadi untuk server ssh di atasnya (untuk ini ada istilah dan banyak nuansa yang signifikan, tapi saya sedang menulis program pendidikan, bukan instruksi untuk digunakan). <br>  Kami meninggalkan kunci publik di mesin tempat klien ssh akan berada dan kami juga merahasiakannya. <br>  Kami membawa flash drive ke server, memasukkan, menyalin kunci pribadi, dan membakar flash drive dan menyebarkan debu dalam angin (atau setidaknya memformatnya dengan nol). <br>  Itu saja - setelah operasi seperti itu tidak mungkin untuk memecahkan koneksi ssh seperti itu.  Tentu saja, lebih dari 10 tahun Anda dapat melihat lalu lintas di superkomputer - tetapi ini adalah cerita yang berbeda. <br><br>  Saya minta maaf untuk offtopic. <br></div></div></blockquote>  Jadi sekarang teorinya sudah diketahui.  Saya akan bercerita tentang aliran penciptaan sertifikat ssl. <br><br>  Menggunakan "openssl genrsa" kami membuat kunci pribadi dan "kosong" untuk kunci publik. <br>  Kami mengirim "blank" ke perusahaan pihak ketiga, di mana kami membayar sekitar $ 9 untuk sertifikat paling sederhana. <br><br>  Dalam beberapa jam, kami menerima kunci "publik" dari perusahaan pihak ketiga dan beberapa kunci publik lainnya. <br><br>  Mengapa perusahaan pihak ketiga harus membayar untuk penerbitan kunci publik saya - masalah terpisah, kami tidak akan mempertimbangkan di sini. <br><br>  Sekarang sudah jelas apa arti dari prasasti itu: <br><br><pre> <code class="plaintext hljs">smtpd_tls_key_file=/etc/ssl/domain1.com.2018.key</code> </pre> <br>  Dalam folder "/ etc / ssl" semua file untuk pertanyaan ssl disimpan. <br>  domain1.com - nama domain. <br>  2018 adalah tahun pembuatan kunci. <br>  "Kunci" - penunjukan bahwa file tersebut adalah kunci pribadi. <br><br>  Dan arti dari file ini: <br><br>  smtpd_tls_cert_file = / etc / ssl / domain1.com.2018.chained.crt <br>  domain1.com - nama domain. <br>  2018 adalah tahun pembuatan kunci. <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dirantai - sebutan bahwa ada rantai kunci publik (yang pertama adalah kunci publik kami dan sisanya adalah apa yang berasal dari perusahaan yang mengeluarkan kunci publik). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crt - penunjukan bahwa ada sertifikat siap (kunci publik dengan penjelasan teknis).</font></font><br><br><pre> <code class="bash hljs">smtp_bind_address = XX.XX.XX.X0 smtp_bind_address6 = XXXX:XXXX:XXXX:XXXX:1:1:1:1</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan ini tidak digunakan dalam kasus ini, tetapi ditulis sebagai contoh. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Karena kesalahan dalam parameter ini akan menyebabkan pengiriman spam dari server Anda (tanpa keinginan Anda). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kemudian buktikan kepada semua orang bahwa Anda tidak bisa disalahkan.</font></font><br><br><pre> <code class="bash hljs">recipient_delimiter = +</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mungkin banyak yang tidak tahu, jadi ini adalah simbol standar untuk penggembalaan, dan ini didukung oleh sebagian besar server surat modern. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Misalnya, jika Anda memiliki kotak surat "username@gmail.com" coba kirimkan ke "username+spam@gmail.com" - lihat apa yang terjadi.</font></font><br><br><pre> <code class="bash hljs">inet_protocols = ipv4</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mungkin ini akan membingungkan. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tapi ini bukan adil. </font><font style="vertical-align: inherit;">Setiap domain baru secara default hanya IPv4, maka saya mengaktifkan IPv6 untuk masing-masing secara individual.</font></font><br><br><pre> <code class="bash hljs">virtual_transport = lmtp:unix:private/dovecot-lmtp virtual_mailbox_domains = mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf virtual_mailbox_maps = mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf virtual_alias_maps = mysql:/etc/postfix/mysql-virtual-alias-maps.cf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di sini kita mengatur bahwa semua surat masuk masuk ke dovecot. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan aturan untuk domain, kotak surat, alias - lihat di database. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/postfix/mysql-virtual-mailbox-domains.cf</font></font><br><br><pre> <code class="bash hljs">user = usermail password = mailpassword hosts = 127.0.0.1 dbname = servermail query = SELECT 1 FROM virtual_domains WHERE name=<span class="hljs-string"><span class="hljs-string">'%s'</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> /etc/postfix/mysql-virtual-mailbox-maps.cf </font></font><br><br><pre> <code class="bash hljs">user = usermail password = mailpassword hosts = 127.0.0.1 dbname = servermail query = SELECT 1 FROM virtual_users WHERE email=<span class="hljs-string"><span class="hljs-string">'%s'</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> /etc/postfix/mysql-virtual-alias-maps.cf </font></font><br><br><pre> <code class="bash hljs">user = usermail password = mailpassword hosts = 127.0.0.1 dbname = servermail query = SELECT destination FROM virtual_aliases WHERE <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>=<span class="hljs-string"><span class="hljs-string">'%s'</span></span></code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># SMTP-Auth settings smtpd_sasl_type = dovecot smtpd_sasl_path = private/auth smtpd_sasl_auth_enable = yes</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sekarang postfix tahu bahwa Anda hanya dapat menerima email untuk pengiriman lebih lanjut dengan otorisasi dengan dovecot. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya benar-benar tidak mengerti mengapa ini digandakan di sini. </font><font style="vertical-align: inherit;">Kami telah mengindikasikan di virtual_transport semua yang diperlukan. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tetapi sistem postfix sudah sangat tua - mungkin itu adalah kastil dari masa lalu.</font></font><br><br><pre> <code class="bash hljs">smtpd_recipient_restrictions = ... smtpd_helo_restrictions = ... smtpd_client_restrictions = ...</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini dikonfigurasikan untuk setiap server email dengan caranya sendiri. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya memiliki 3 server surat yang dapat saya gunakan dan pengaturan ini sangat berbeda karena persyaratan penggunaan yang berbeda. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda harus mengonfigurasi dengan hati-hati - jika tidak, spam akan membanjiri Anda atau lebih buruk, spam akan membanjiri Anda.</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># SPF policyd-spf_time_limit = 3600</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mengkonfigurasi beberapa jenis plugin yang terkait dengan pemeriksaan SPF terhadap pesan yang masuk. </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># OpenDKIM milter_default_action = accept milter_protocol = 6 smtpd_milters = unix:var/run/opendkim/opendkim.sock non_smtpd_milters = unix:var/run/opendkim/opendkim.sock</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mengkonfigurasi bahwa semua surat keluar kita harus memberikan tanda tangan DKIM. </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># IP address per domain sender_dependent_default_transport_maps = pcre:/etc/postfix/sdd_transport.pcre</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini adalah detail utama dalam perutean email saat mengirim email dari skrip php. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/etc/postfix/sdd_transport.pcre":</font></font><br><br><pre> <code class="bash hljs">/^www-domain1@domain1\.com$/ domain1: /^www-domain2@domain1\.com$/ domain2: /^www-domain3@domain1\.com$/ domain3: /@domain1\.com$/ domain1: /@domain2\.com$/ domain2: /@domain3\.com$/ domain3:</code> </pre> <br><blockquote>  —  .  — ,   . <br> Postfix     —        . <br><br>     postfix    —    «master.cf». <br><br>  4, 5, 6 —  .       —    . <br>     php       «from».      . <br><br>     —       nginx+fpm. <br><br>  —       linux-user .    fpm-pool. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fpm-pool menggunakan versi php apa saja (ini hebat ketika Anda bisa menggunakan versi php dan bahkan php.ini yang berbeda di server yang sama untuk situs tetangga). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jadi pengguna linux tertentu "www-domain2" memiliki situs domain2.com. </font><font style="vertical-align: inherit;">Situs ini memiliki kode untuk mengirim surat tanpa menentukan bidang dari. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jadi, bahkan dalam kasus ini, surat-surat itu akan hilang dengan benar dan tidak akan pernah masuk ke spam.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "/Etc/postfix/master.cf" saya terlihat seperti ini: </font></font><br><br><pre> <code class="bash hljs">... smtp inet n - y - - smtpd -o content_filter=spamassassin ... submission inet n - y - - smtpd -o syslog_name=postfix/submission -o smtpd_tls_security_level=encrypt -o smtpd_sasl_auth_enable=yes -o smtpd_client_restrictions=permit_sasl_authenticated,reject ... policyd-spf unix - nn - 0 spawn user=policyd-spf argv=/usr/bin/policyd-spf spamassassin unix - nn - - pipe user=spamd argv=/usr/bin/spamc -f -e /usr/sbin/sendmail -oi -f <span class="hljs-variable"><span class="hljs-variable">${sender}</span></span> <span class="hljs-variable"><span class="hljs-variable">${recipient}</span></span> ... domain1 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X1 -o smtp_helo_name=domain1.com -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:1:1:1 -o syslog_name=postfix-domain1 domain2 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X5 -o smtp_helo_name=domain2.com -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:2:1:1 -o syslog_name=postfix-domain2 domain3 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X2 -o smtp_helo_name=domain3 -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:1:5:1 -o syslog_name=postfix-domain3</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File tidak sepenuhnya diberikan - sudah sangat besar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tercatat hanya apa yang telah diubah.</font></font><br><br><pre> <code class="bash hljs">smtp inet n - y - - smtpd -o content_filter=spamassassin ... spamassassin unix - nn - - pipe user=spamd argv=/usr/bin/spamc -f -e /usr/sbin/sendmail -oi -f <span class="hljs-variable"><span class="hljs-variable">${sender}</span></span> <span class="hljs-variable"><span class="hljs-variable">${recipient}</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ini adalah pengaturan yang terkait dengan spamassasin, tentangnya nanti. </font></font><br><br><pre> <code class="bash hljs">submission inet n - y - - smtpd -o syslog_name=postfix/submission -o smtpd_tls_security_level=encrypt -o smtpd_sasl_auth_enable=yes -o smtpd_client_restrictions=permit_sasl_authenticated,reject</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami memungkinkan Anda untuk terhubung ke server email melalui port 587. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk melakukan ini, pastikan untuk masuk.</font></font><br><br><pre> <code class="bash hljs">policyd-spf unix - nn - 0 spawn user=policyd-spf argv=/usr/bin/policyd-spf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aktifkan verifikasi SPF. </font></font><br><br><pre> <code class="bash hljs">apt-get install postfix-policyd-spf-python</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Instal paket untuk pemeriksaan SPF di atas. </font></font><br><br><pre> <code class="bash hljs">domain1 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X1 -o smtp_helo_name=domain1.com -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:1:1:1 -o syslog_name=postfix-domain1</code> </pre> <br><blockquote>    .          IPv4/IPv6 . <br><br>    rDNS. rDNS —   -   IP . <br>         ,  helo   rDNS  ,    email. <br><br>  helo    ,      —   . <br><br> Helo   rDNS —    . <br>        IP . <br>  OVH —      rDNS. <br>  tech.ru —    . <br>  AWS —    . <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Inet_protocols" dan "smtp_bind_address6" - ini adalah bagaimana kami mengaktifkan dukungan IPv6. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk IPv6, Anda juga perlu mendaftarkan rDNS. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Syslog_name" - dan ini untuk kenyamanan membaca log.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">merekomendasikan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> membeli sertifikat di </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">sini</font></a><font style="vertical-align: inherit;"> . </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menyiapkan banyak postfix + dovecot di sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan SPF.</font></font></a> <br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== Dovecot ============== </font></font></h2><br><pre> <code class="bash hljs">apt-get install dovecot-imapd dovecot-pop3d dovecot-lmtpd dovecot-mysql dovecot-antispam</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasikan mysql, instal paketnya sendiri. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/etc/dovecot/conf.d/10-auth.conf"</font></font><br><br><pre> <code class="bash hljs">disable_plaintext_auth = yes auth_mechanisms = plain login</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otorisasi hanya dienkripsi. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/etc/dovecot/conf.d/10-mail.conf"</font></font><br><br><pre> <code class="bash hljs">mail_location = maildir:/var/mail/vhosts/%d/%n</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di sini kami menunjukkan lokasi surat-surat itu. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya ingin mereka disimpan dalam file dan dikelompokkan berdasarkan domain. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/etc/dovecot/conf.d/10-master.conf"</font></font><br><br><pre> <code class="bash hljs">service imap-login { inet_listener imap { port = 0 } inet_listener imaps { address = XX.XX.XX.X1, XX.XX.XX.X2, XX.XX.XX.X5, [XXXX:XXXX:XXXX:XXXX:1:1:1:1], [XXXX:XXXX:XXXX:XXXX:1:2:1:1], [XXXX:XXXX:XXXX:XXXX:1:1:5:1] port = 993 ssl = yes } } service pop3-login { inet_listener pop3 { port = 0 } inet_listener pop3s { address = XX.XX.XX.X1, XX.XX.XX.X2, XX.XX.XX.X5, [XXXX:XXXX:XXXX:XXXX:1:1:1:1], [XXXX:XXXX:XXXX:XXXX:1:2:1:1], [XXXX:XXXX:XXXX:XXXX:1:1:5:1] port = 995 ssl = yes } } service lmtp { unix_listener /var/spool/postfix/private/dovecot-lmtp { mode = 0600 user = postfix group = postfix } } service imap { } service pop3 { } service auth { unix_listener auth-userdb { mode = 0600 user = vmail } unix_listener /var/spool/postfix/private/auth { mode = 0666 user = postfix group = postfix } user = dovecot } service auth-worker { user = vmail } service dict { unix_listener dict { } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini adalah file pengaturan dovecot utama. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di sini kami memutuskan koneksi yang tidak aman. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan mengaktifkan koneksi yang aman. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/etc/dovecot/conf.d/10-ssl.conf"</font></font><br><br><pre> <code class="bash hljs">ssl = required ssl_cert = &lt;/etc/nginx/ssl/domain1.com.2018.chained.crt ssl_key = &lt;/etc/nginx/ssl/domain1.com.2018.key <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> XX.XX.XX.X5 { ssl_cert = &lt;/etc/nginx/ssl/domain2.com.2018.chained.crt ssl_key = &lt;/etc/nginx/ssl/domain2.com.2018.key }</code> </pre> <br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasikan ssl. </font><font style="vertical-align: inherit;">Kami menunjukkan bahwa ssl diperlukan. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan sertifikat itu sendiri. </font><font style="vertical-align: inherit;">Dan detail penting adalah arahan "lokal". </font><font style="vertical-align: inherit;">Menunjukkan saat menyambung ke IPv4 lokal mana - ssl sertifikat yang akan digunakan. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Omong-omong, IPv6 tidak dikonfigurasi di sini, saya akan memperbaiki kelalaian ini sebagai utas nanti. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XX.XX.XX.X5 (domain2) - tidak ada sertifikat. </font><font style="vertical-align: inherit;">Untuk menghubungkan klien, Anda harus menentukan domain1.com. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XX.XX.XX.X2 (domain3) - ada sertifikat, Anda dapat menentukan domain1.com atau domain3.com untuk menghubungkan klien.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> File "/etc/dovecot/conf.d/15-lda.conf" </font></font><br><br><pre> <code class="bash hljs">protocol lda { mail_plugins = <span class="hljs-variable"><span class="hljs-variable">$mail_plugins</span></span> sieve }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini akan dibutuhkan di masa depan untuk spamassassin. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/etc/dovecot/conf.d/20-imap.conf"</font></font><br><br><pre> <code class="bash hljs">protocol imap { mail_plugins = <span class="hljs-variable"><span class="hljs-variable">$mail_plugins</span></span> antispam }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini adalah plugin antispam. </font><font style="vertical-align: inherit;">Diperlukan untuk melatih spamassasin pada saat transfer ke / dari folder Spam. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/etc/dovecot/conf.d/20-pop3.conf"</font></font><br><br><pre> <code class="bash hljs">protocol pop3 { }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hanya file seperti itu. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/etc/dovecot/conf.d/20-lmtp.conf"</font></font><br><br><pre> <code class="bash hljs">protocol lmtp { mail_plugins = <span class="hljs-variable"><span class="hljs-variable">$mail_plugins</span></span> sieve postmaster_address = admin@domain1.com }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasikan lmtp. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/etc/dovecot/conf.d/90-antispam.conf"</font></font><br><br><pre> <code class="bash hljs">plugin { antispam_backend = pipe antispam_trash = Trash;trash antispam_spam = Junk;Spam;SPAM antispam_pipe_program_spam_arg = --spam antispam_pipe_program_notspam_arg = --ham antispam_pipe_program = /usr/bin/sa-learn antispam_pipe_program_args = --username=%Lu }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan pelatihan Spamassasin pada saat transfer ke / dari folder Spam. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/etc/dovecot/conf.d/90-sieve.conf"</font></font><br><br><pre> <code class="bash hljs">plugin { sieve = ~/.dovecot.sieve sieve_dir = ~/sieve sieve_after = /var/lib/dovecot/sieve/default.sieve }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File yang menunjukkan apa yang harus dilakukan dengan email yang masuk. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/var/lib/dovecot/sieve/default.sieve"</font></font><br><br><pre> <code class="bash hljs">require [<span class="hljs-string"><span class="hljs-string">"fileinto"</span></span>, <span class="hljs-string"><span class="hljs-string">"mailbox"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> header :contains <span class="hljs-string"><span class="hljs-string">"X-Spam-Flag"</span></span> <span class="hljs-string"><span class="hljs-string">"YES"</span></span> { fileinto :create <span class="hljs-string"><span class="hljs-string">"Spam"</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diperlukan untuk mengkompilasi file: "sievec default.sieve". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/etc/dovecot/conf.d/auth-sql.conf.ext"</font></font><br><br><pre> <code class="bash hljs">passdb { driver = sql args = /etc/dovecot/dovecot-sql.conf.ext } userdb { driver = static args = uid=vmail gid=vmail home=/var/mail/vhosts/%d/%n }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menentukan file sql untuk otorisasi. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan file itu sendiri adalah cara otorisasi. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/etc/dovecot/dovecot-sql.conf.ext"</font></font><br><br><pre> <code class="bash hljs">driver = mysql connect = host=127.0.0.1 dbname=servermail user=usermail password=password default_pass_scheme = SHA512-CRYPT password_query = SELECT email as user, password FROM virtual_users WHERE email=<span class="hljs-string"><span class="hljs-string">'%u'</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini sesuai dengan pengaturan yang sama untuk postfix. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/etc/dovecot/dovecot.conf"</font></font><br><pre> <code class="bash hljs">protocols = imap lmtp pop3 listen = *, :: dict { } !include conf.d/*.conf !include_try local.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File konfigurasi utama. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yang penting kita tentukan di sini, tambahkan protokol.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== SpamAssassin ============== </font></font></h2><br><pre> <code class="bash hljs">apt-get install spamassassin spamc</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Instal paket. </font></font><br><br><pre> <code class="bash hljs">adduser spamd --disabled-login</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tambahkan pengguna atas nama siapa. </font></font><br><br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> spamassassin.service</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aktifkan layanan unduh spamassassin saat boot. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/ etc / default / spamassassin":</font></font><br><br><pre> <code class="bash hljs">CRON=1</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aktifkan pembaruan aturan secara otomatis secara default. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File "/etc/spamassassin/local.cf":</font></font><br><br><pre> <code class="bash hljs">report_safe 0 use_bayes 1 bayes_auto_learn 1 bayes_auto_expire 1 bayes_store_module Mail::SpamAssassin::BayesStore::MySQL bayes_sql_dsn DBI:mysql:sa:localhost:3306 bayes_sql_username sa bayes_sql_password password</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penting untuk membuat database "sa" di mysql dengan pengguna "sa" dengan kata sandi "kata sandi" (ganti dengan sesuatu yang memadai). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">report_safe - alih-alih surat, laporan tentang pesan spam akan dikirim. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">use_bayes adalah pengaturan pembelajaran mesin spamassassin. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan spamassassin yang tersisa diterapkan sebelumnya dalam artikel. </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan umum adalah spamassassin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tentang memindahkan email Spam baru ke folder Spam IMAP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tentang sekelompok sederhana Dovecot + SpamAssassin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya sarankan membaca teori belajar spamassasin ketika memindahkan surat di folder imap (dan tidak merekomendasikannya untuk digunakan)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== Menghubungi komunitas ============== </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya juga ingin memberikan ide kepada masyarakat tentang cara meningkatkan tingkat keamanan surat yang diteruskan. </font><font style="vertical-align: inherit;">Karena saya sangat tenggelam dalam topik surat. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sehingga pengguna dapat membuat pasangan kunci pada kliennya (pandangan, thunderbird, browser-plugin, ...). </font><font style="vertical-align: inherit;">Publik dan pribadi. </font><font style="vertical-align: inherit;">Umum - kirim ke DNS. </font><font style="vertical-align: inherit;">Pribadi - simpan ke klien. </font><font style="vertical-align: inherit;">Server email akan dapat menggunakan kunci publik untuk mengirim ke penerima tertentu. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan untuk melindungi terhadap spam dengan email semacam itu (ya, server surat tidak akan dapat melihat kontennya) - Anda perlu memperkenalkan 3 aturan:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wajib tanda tangan DKIM, SPF wajib, rDNS wajib. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jaringan saraf pada topik pelatihan antispam + DB untuk itu di sisi klien. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Algoritme enkripsi harus sedemikian rupa sehingga pihak pengirim harus menghabiskan daya CPU 100 kali lebih banyak pada enkripsi daripada sisi penerima. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selain surat publik - untuk mengembangkan surat undangan standar "untuk memulai korespondensi yang aman." </font><font style="vertical-align: inherit;">Salah satu pengguna (kotak surat) mengirim surat ke kotak surat lain dengan lampiran. </font><font style="vertical-align: inherit;">Dalam surat itu, proposal teks untuk memulai saluran komunikasi yang aman untuk korespondensi dan kunci publik dari pemilik kotak surat (dengan kunci pribadi di sisi klien).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda bahkan dapat membuat sepasang tombol khusus untuk setiap korespondensi. Pengguna penerima dapat menerima tawaran ini dan mengirim kunci publiknya (juga dibuat khusus untuk korespondensi ini). Selanjutnya, pengguna pertama mengirim surat kontrol layanan (dienkripsi dengan kunci publik dari pengguna kedua) - setelah menerima yang pengguna kedua dapat menganggap saluran komunikasi yang dibentuk dapat diandalkan. Kemudian pengguna kedua mengirim surat kontrol - dan kemudian pengguna pertama juga dapat menganggap saluran yang dibentuk sebagai terproteksi. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk memerangi intersepsi kunci di jalan - perlu protokol untuk menyediakan kemungkinan mentransmisikan setidaknya satu kunci publik menggunakan flash drive. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan yang paling penting, semuanya bekerja (pertanyaannya adalah "siapa yang akan membayarnya?"):</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memperkenalkan sertifikat surat senilai mulai $ 10 selama 3 tahun. </font><font style="vertical-align: inherit;">Yang akan memungkinkan pengirim untuk menunjukkan dalam dns bahwa "kunci publik saya ada di luar sana." </font><font style="vertical-align: inherit;">Dan mereka akan memberikan kesempatan untuk memulai koneksi yang aman. </font><font style="vertical-align: inherit;">Pada saat yang sama, ambil senyawa tersebut secara gratis. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gmail akhirnya memonetisasi penggunanya. </font><font style="vertical-align: inherit;">Untuk $ 10 dalam 3 tahun - hak untuk membuat saluran korespondensi yang aman.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== Kesimpulan ============== </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk menguji seluruh artikel, saya akan menyewa server khusus selama sebulan dan membeli domain dengan sertifikat ssl. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tapi keadaan kehidupan berkembang sehingga masalah ini berlangsung selama 2 bulan. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan ketika waktu luang muncul lagi - saya memutuskan untuk menerbitkan artikel apa adanya, dan tidak mengambil risiko publikasi akan tertunda selama satu tahun lagi. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika ada banyak pertanyaan seperti "tetapi ini tidak dijelaskan dalam detail yang cukup" - maka mungkin akan ada kekuatan untuk mengambil server khusus dengan domain baru dan sertifikat SSL baru dan menjelaskan lebih terinci dan yang paling penting - mengidentifikasi semua detail penting yang hilang. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya juga ingin menerima umpan balik tentang topik gagasan tentang sertifikat surat. Jika Anda menyukai ide itu, saya akan mencoba menemukan kekuatan untuk menulis konsep untuk rfc.</font></font><br><br> <b>     —     . <br>       —     . <br>           .</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id413689/">https://habr.com/ru/post/id413689/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id413675/index.html">Joker 2018: Klub Pengembang Java Anonim</a></li>
<li><a href="../id413677/index.html">Peluncuran ROS pada robot self-balancing EduMIP</a></li>
<li><a href="../id413679/index.html">Angular6. PWA. Modul pemuatan malas. Penyebaran otomatis di Firebase</a></li>
<li><a href="../id413681/index.html">Teknik mengembangkan server yang sangat andal di Go</a></li>
<li><a href="../id413683/index.html">ILV telah membuka blokir 7 juta alamat IP. Tetap terkunci 4 juta</a></li>
<li><a href="../id413691/index.html">Mulai</a></li>
<li><a href="../id413693/index.html">Handmade: Keyboard yang dapat diprogram untuk perdagangan online do-it-yourself</a></li>
<li><a href="../id413695/index.html">Keamanan Messenger: mengapa menyimpan pesan di blockchain mungkin merupakan ide yang bagus</a></li>
<li><a href="../id413697/index.html">Bagaimana tidak menulis kode</a></li>
<li><a href="../id413699/index.html">"Siapa yang mengaduk air - 2": atau semua yang ingin Anda ketahui tentang reverse osmosis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>