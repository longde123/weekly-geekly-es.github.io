<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯФ░ ЁЯШУ ЁЯСйЁЯП╜тАНтЬИя╕П рдлреИрдВрд╕реА рд▓рд┐рдирдХреНрд╕ рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ ЁЯРР ЁЯОП ЁЯС▓ЁЯП╛</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рд╕реА рднрд╛рд╖рд╛ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░рдиреЗ рдкрд░ рдПрдХ рдкреНрд░реЛрдЧреНрд░рд╛рдорд░ рдХреНрдпрд╛ рджреЗрдЦрддрд╛ рд╣реИ? рд╡рд╣ fopen , printf , scanf рдФрд░ рдХрдИ рдЕрдиреНрдп рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рджреЗрдЦрддрд╛ рд╣реИред рд╡рд╣ рд╕рднреА рдкреНрд░рдХрд╛рд░ рдХреЗ open рдФрд░ m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рдлреИрдВрд╕реА рд▓рд┐рдирдХреНрд╕ рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475184/"><p> <a href=""><img alt="ls / usr / рд╢реЗрдпрд░ / рдЖрджрдореА / рдЖрджрдореА 2 /" src="https://habrastorage.org/webt/ej/cn/w4/ejcnw4zqrqo_wee6kw-evxqziui.png"></a> </p><br><p> рд╕реА рднрд╛рд╖рд╛ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░рдиреЗ рдкрд░ рдПрдХ рдкреНрд░реЛрдЧреНрд░рд╛рдорд░ рдХреНрдпрд╛ рджреЗрдЦрддрд╛ рд╣реИ?  рд╡рд╣ <code>fopen</code> , <code>printf</code> , <code>scanf</code> рдФрд░ рдХрдИ рдЕрдиреНрдп рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рджреЗрдЦрддрд╛ рд╣реИред  рд╡рд╣ рд╕рднреА рдкреНрд░рдХрд╛рд░ рдХреЗ <code>open</code> рдФрд░ <code>mmap</code> рджреЗрдЦрддрд╛ рд╣реИ - рдРрд╕рд╛ рдкреНрд░рддреАрдд рд╣реЛрддрд╛ рд╣реИ, рдЙрдиреНрд╣реЗрдВ рдХреНрдпреЛрдВ рдЙрдЬрд╛рдЧрд░ рдХрд░реЗрдВ?  рд▓реЗрдХрд┐рди, рдкрд╣рд▓реЗ рд╕рдореВрд╣ рдХреЗ рд╡рд┐рдкрд░реАрдд, рд▓рд┐рдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рдкрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдиреЗ рдкрд░ рдпреЗ рджреЛ рдлрд╝рдВрдХреНрд╢рди рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рд╣реЛрддреЗ рд╣реИрдВ ( <em>рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ</em> , рд▓рдЧрднрдЧ рдХрднреА рднреА рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рдХреЛ рдХреЗрд╡рд▓ рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд░реВрдк рдореЗрдВ рдирд╣реАрдВ рдХрд╣рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ рдЗрд╕рд▓рд┐рдП <code>libc</code> рдореЗрдВ рд░реИрдкрд░ рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ рджрд▓реАрд▓реЗрдВ рджреЗрддреЗ рд╣реИрдВ рдФрд░ рдХрднреА-рдХрднреА, рдЬреИрд╕реЗ рдорд╛рдорд▓реЗ рдореЗрдВ рд╣реЛрддреЗ рд╣реИрдВред <code>open</code> , рдкреБрд░рд╛рдиреЗ рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рдХреЛ рдЕрдзрд┐рдХ рд╕рд╛рдорд╛рдиреНрдп рдирдП рдХреЗ рд╕рд╛рде рдмрджрд▓рдирд╛)ред  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ GNU / Linux рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдЙрдкрд▓рдмреНрдз рд╣рдЬрд╛рд░реЛрдВ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд╡рд┐рдкрд░реАрдд, рдХрд░реНрдиреЗрд▓ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдмрд┐рдВрджреБрдУрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рд╕реАрдорд┐рдд рд╣реЛрддреА рд╣реИ - рдХрдИ рд╕реМ рдХреЗ рдХреНрд░рдо рдореЗрдВ, рд▓реЗрдХрд┐рди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реНрдерд╛рди рдХреЗ рд▓рд┐рдП рдпрд╣ рдХреНрд░реИрд╢ рд╣реЛрддрд╛ рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЧреБрдо рдкреГрд╖реНрда рддрдХ рдкрд╣реБрдВрдЪрдирд╛), рдХрд░реНрдиреЗрд▓ рдХреЗ рд▓рд┐рдП - рдСрдкрд░реЗрд╢рди рдХрд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдореЛрдбред </p><br><p>  рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ рдореИрдВ рдЖрдкрдХреЛ рдореЗрд░реА рд░рд╛рдп рдореЗрдВ рдХреБрдЫ рджрд┐рд▓рдЪрд╕реНрдк рддрдереНрдп рдмрддрд╛рдКрдВрдЧрд╛ред  рдЗрд╕рдореЗрдВ <code>futex</code> s рдФрд░ рдЕрдиреНрдп рдЙрдмрд╛рдК (рд╢рд╛рдпрдж) рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╡рд┐рд╡рд░рдг рдирд╣реАрдВ рд╣реЛрдВрдЧреЗред  рдпрд╣ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рд╣реЛрдЧрд╛ рдЬрд┐рд╕рдиреЗ рдореБрдЭреЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рджреА "рдФрд░ рдХреНрдпрд╛, рдХреНрдпрд╛ рдРрд╕рд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ?"ред </p><a name="habracut"></a><br><p>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдХреИрдЯ рд╕реЗ рдкрд╣рд▓реЗ рдкрд╛рда рдкрд░ рдХреБрдЫ рдЯрд┐рдкреНрдкрдгрд┐рдпрд╛рдВ: рдХреБрдЫ рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рдореЗрдВ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">vDSO</a> рдирд╛рдордХ рдПрдХ рд╕рд╛рдЭрд╛ рдСрдмреНрдЬреЗрдХреНрдЯ рд╕реЗ рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХ рд╡реИрдХрд▓реНрдкрд┐рдХ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ рдХрд░реНрдиреЗрд▓ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдбрд╛рд▓рддрд╛ рд╣реИред  рдРрд╕реЗ рдХреБрдЫ рдХрд╛рд░реНрдп рд╣реИрдВ (рдЪрд╛рд░ рдХреЗ рдЖрд╕рдкрд╛рд╕ рдХреБрдЫ, рд▓реЗрдХрд┐рди рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕рдВрдЦреНрдпрд╛, рдЬрд╛рд╣рд┐рд░рд╛ рддреМрд░ рдкрд░, рдХрд░реНрдиреЗрд▓ рд╕рдВрд╕реНрдХрд░рдг рдФрд░ рд╡рд╛рд╕реНрддреБрдХрд▓рд╛ рдкрд░ рдирд┐рд░реНрднрд░ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ) - рдпреЗ рд╕рднреА рдкреНрд░рдХрд╛рд░ рдХреЗ <code>time</code> рдФрд░ <code>gettimeofday</code> , рдЬреЛ, рдПрдХ рддрд░рдл, рдЕрдХреНрд╕рд░ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ, рдФрд░ рджреВрд╕рд░реА рддрд░рдл, рдЙрдиреНрд╣реЗрдВ рд╕реНрд╡рд┐рдЪ рдХрд┐рдП рдмрд┐рдирд╛ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдХрд░реНрдиреЗрд▓ рд╕рдВрджрд░реНрднред </p><br><p>  рджреВрд╕рд░реЗ, SIGSEGV рд╣рдореЗрд╢рд╛ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреНрд░реИрд╢ рдХреЗ рд╕рд╛рде рд╕рдорд╛рдкреНрдд рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд╣рдо рдЗрд╕ рдмрд╛рд░реЗ рдореЗрдВ <code>userfaultfd</code> рдореЗрдВ рдмрд╛рдд рдХрд░реЗрдВрдЧреЗ рдЬрдм рдпрд╣ <code>userfaultfd</code> рдкрд░ <code>userfaultfd</code> ред </p><br><p>  <strong>рдЕрд╕реНрд╡реАрдХрд░рдг:</strong> рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдпрд╣рд╛рдВ рдкреНрд░рд╕реНрддреБрдд рдЕрдзрд┐рдХрд╛рдВрд╢ рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рдЖрдк рдЕрдкрдиреЗ рд▓рд┐рдирдХреНрд╕ рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреЛ рдмрд╛рдВрдз рд░рд╣реЗ рд╣реИрдВред  рдпрд╣ рд╕рд╛рдорд╛рдиреНрдп рд╣реИ рдЕрдЧрд░ рдЗрд╕ рддрд░рд╣ рд╕реЗ рдЖрдк рдПрдХ рд╡рд┐рд╢реЗрд╖ рдкреНрд░рдХрд╛рд░ рдХреА рдкреНрд░рдгрд╛рд▓реА рдпрд╛ рдПрдХ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рд▓рд┐рдП рд╡реИрдХрд▓реНрдкрд┐рдХ рдЕрдиреБрдХреВрд▓рди рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ рдЕрдиреНрдпрдерд╛ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реЛрдВрдЧреЗред  рд▓реЗрдХрд┐рди рдЕрдиреНрдпрдерд╛, рдореИрдВ рдпрд╣ рд╕реЛрдЪрдиреЗ рдХреА рд╕рд▓рд╛рд╣ рджреЗрддрд╛ рд╣реВрдВ рдХрд┐ рдХреНрд░реЙрд╕-рдкреНрд▓реЗрдЯрдлреЙрд░реНрдо рдХреА рд╡рд╛рдкрд╕реА рдХреИрд╕реЗ рдХрд░реЗрдВред </p><br><h2 id="obschie-voprosy">  рд╕рд╛рдорд╛рдиреНрдп рдкреНрд░рд╢реНрди </h2><br><p>  рд╢реБрд░реБрдЖрдд рдХреЗ рд▓рд┐рдП, рдпрд╣ рд╕рдм рдХреИрд╕реЗ рдбреАрдмрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ?  рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ <code>strace</code> рд╣рдорд╛рд░реА рдорджрдж рдХрд░реЗрдЧрд╛!  рдЪреВрдВрдХрд┐ рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рдХрд╛ рд╕реЗрдЯ рд╕реАрдорд┐рдд рд╣реИ, рдФрд░ рдЕрдзрд┐рдХрд╛рдВрд╢ <code>strace</code> "рджреГрд╖реНрдЯрд┐ рд╕реЗ" рдЬрд╛рдирддрд╛ рд╣реИ, рдпрд╣ рди рдХреЗрд╡рд▓ "рд╕реВрдЪрдХ 0x12345678 рдкрд╛рд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ" рджрд┐рдЦрд╛рдПрдЧрд╛, рд▓реЗрдХрд┐рди рдЗрд╕ рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ рдЗрд╕ рдпрд╛ рдЙрд╕ рджрд┐рд╢рд╛ рдореЗрдВ рдХреНрдпрд╛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ, рдЗрд╕рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдЧрд╛ред  рдпрджрд┐ <code>strace</code> рдкрд░реНрдпрд╛рдкреНрдд рддрд╛рдЬрд╝рд╛ рд╣реИ, рддреЛ <code>-k</code> рд╡рд┐рдХрд▓реНрдк рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдк рдХреЙрд▓ рд╕реНрдЯреИрдХ рдЬрд╛рд░реА рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣ рд╕рдХрддреЗ рд╣реИрдВред </p><br><div class="spoiler">  <b class="spoiler_title">рдпрд╣ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ strace -k sleep 1 execve("/bin/sleep", ["sleep", "1"], 0x7ffe9f9cce30 /* 60 vars */) = 0 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(execve+0xb) [0xe601b] &gt; /usr/bin/strace(+0x0) [0xa279c] &gt; /usr/bin/strace(+0x0) [0xa41d2] &gt; /usr/bin/strace(+0x0) [0x7090b] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /usr/bin/strace(+0x0) [0x7112a] brk(NULL) = 0x558936ded000 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x20b) [0x1ccdb] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1cd2) [0x1b872] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] arch_prctl(0x3001 /* ARCH_??? */, 0x7fff593c0070) = -1 EINVAL ( ) &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e25) [0x1b9c5] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] access("/etc/ld.so.preload", R_OK) = -1 ENOENT (    ) &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x10cb) [0x1db9b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c12] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x1238) [0x1dd08] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_debug_state+0x73a) [0x11d4a] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_exception_free+0x908) [0x189c8] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa362] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] fstat(3, {st_mode=S_IFREG|0644, st_size=254851, ...}) = 0 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x1009) [0x1dad9] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_debug_state+0x761) [0x11d71] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_exception_free+0x908) [0x189c8] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa362] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] mmap(NULL, 254851, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fc49621c000 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x1426) [0x1def6] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_debug_state+0x79d) [0x11dad] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_exception_free+0x908) [0x189c8] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa362] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] close(3) = 0 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x10fb) [0x1dbcb] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_debug_state+0x780) [0x11d90] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_exception_free+0x908) [0x189c8] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa362] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] openat(AT_FDCWD, "/lib/x86_64-linux-gnu/libc.so.6", O_RDONLY|O_CLOEXEC) = 3 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x1238) [0x1dd08] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x7d40] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa3a8] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] read(3, "\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360r\2\0\0\0\0\0"..., 832) = 832 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x12f8) [0x1ddc8] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x7d79] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa3a8] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] ...    ... brk(NULL) = 0x558936ded000 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(brk+0xb) [0x11755b] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__sbrk+0x67) [0x117617] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__default_morecore+0xd) [0x9fd3d] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x2725) [0x9a745] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x3943) [0x9b963] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x3b2b) [0x9bb4b] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x4d9e) [0x9cdbe] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(textdomain+0x740) [0x3be70] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1d35) [0x35515] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5] &gt; /bin/sleep() [0x25f0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /bin/sleep() [0x287e] brk(0x558936e0e000) = 0x558936e0e000 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(brk+0xb) [0x11755b] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__sbrk+0x91) [0x117641] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__default_morecore+0xd) [0x9fd3d] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x2725) [0x9a745] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x3943) [0x9b963] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x3b2b) [0x9bb4b] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x4d9e) [0x9cdbe] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(textdomain+0x740) [0x3be70] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1d35) [0x35515] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5] &gt; /bin/sleep() [0x25f0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /bin/sleep() [0x287e] openat(AT_FDCWD, "/usr/lib/locale/locale-archive", O_RDONLY|O_CLOEXEC) = 3 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__open64_nocancel+0x4c) [0x11679c] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1ce9) [0x354c9] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5] &gt; /bin/sleep() [0x25f0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /bin/sleep() [0x287e] fstat(3, {st_mode=S_IFREG|0644, st_size=8994080, ...}) = 0 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__fxstat64+0x19) [0x1107b9] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1e33) [0x35613] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5] &gt; /bin/sleep() [0x25f0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /bin/sleep() [0x287e] mmap(NULL, 8994080, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fc495795000 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(mmap64+0x26) [0x11baf6] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1e5d) [0x3563d] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5] &gt; /bin/sleep() [0x25f0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /bin/sleep() [0x287e] close(3) = 0 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__close_nocancel+0xb) [0x1165bb] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1eab) [0x3568b] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5] &gt; /bin/sleep() [0x25f0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /bin/sleep() [0x287e] nanosleep({tv_sec=1, tv_nsec=0}, NULL) = 0 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(nanosleep+0x17) [0xe5d17] &gt; /bin/sleep() [0x5827] &gt; /bin/sleep() [0x5600] &gt; /bin/sleep() [0x27b0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /bin/sleep() [0x287e] close(1) = 0 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__close_nocancel+0xb) [0x1165bb] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(_IO_file_close_it+0x70) [0x92fc0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(fclose+0x166) [0x85006] &gt; /bin/sleep() [0x5881] &gt; /bin/sleep() [0x2d27] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_secure_getenv+0x127) [0x49ba7] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(exit+0x20) [0x49d60] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xfa) [0x271ea] &gt; /bin/sleep() [0x287e] close(2) = 0 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__close_nocancel+0xb) [0x1165bb] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(_IO_file_close_it+0x70) [0x92fc0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(fclose+0x166) [0x85006] &gt; /bin/sleep() [0x5881] &gt; /bin/sleep() [0x2d4d] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_secure_getenv+0x127) [0x49ba7] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(exit+0x20) [0x49d60] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xfa) [0x271ea] &gt; /bin/sleep() [0x287e] exit_group(0) = ? +++ exited with 0 +++ &gt; /lib/x86_64-linux-gnu/libc-2.30.so(_exit+0x36) [0xe5fe6] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_secure_getenv+0x242) [0x49cc2] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(exit+0x20) [0x49d60] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xfa) [0x271ea] &gt; /bin/sleep(+0x0) [0x287e]</code> </pre> </div></div><br><p>  рд╕рд╣реА, рд╕реНрд░реЛрдд рдлрд╝рд╛рдЗрд▓ рдирд╛рдо рдФрд░ рд▓рд╛рдЗрди рдирдВрдмрд░ рдпрд╣рд╛рдБ рдкреНрд░рджрд░реНрд╢рд┐рдд рдирд╣реАрдВ рд╣реИрдВред  <code>addr2line</code> рдЖрдкрдХреА рдорджрдж рдХрд░реЗрдЧрд╛ (рдпрджрд┐ рдпрд╣ рдЬрд╛рдирдХрд╛рд░реА рд╕рд┐рджреНрдзрд╛рдВрдд рд░реВрдк рдореЗрдВ рдореМрдЬреВрдж рд╣реИ, рддреЛ рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ)ред </p><br><p>  рдПрдХ рджреВрд╕рд░рд╛ рд╕рд╡рд╛рд▓ рд╣реИ: рдХреБрдЫ рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рдореЗрдВ <code>libc</code> рдореЗрдВ рд░реИрдкрд░ рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВред  рдлрд┐рд░ рдЖрдк <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>syscall</code></a> рдирд╛рдордХ рд╕рд╛рд░реНрд╡рднреМрдорд┐рдХ рдЖрд╡рд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="cpp hljs"> syscall(SYS_kcmp, getpid(), getpid(), KCMP_FILE, <span class="hljs-number"><span class="hljs-number">1</span></span>, fd)</code> </pre> <br><h2 id="fayl-----eto-ochen-uzh-strannyy-predmet">  рдПрдХ рдлрд╝рд╛рдЗрд▓ рдПрдХ рдмрд╣реБрдд рд╣реА рдЕрдЬреАрдм рдмрд╛рдд рд╣реИ ... </h2><br><p>  рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рди рдХреЗрд╡рд▓ рдХрд░реНрдиреЗрд▓ рдХреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рдУрд░ рд╕реЗ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рд╣реИред  рдпрд╣ рдПрдХ рд╕рд╛рд░реНрд╡рднреМрдорд┐рдХ рдПрдкреАрдЖрдИ рднреА рд╣реИ рдЬреЛ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд╕рднреА рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рдордЭ рдореЗрдВ рдЖрддрд╛ рд╣реИред  рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдЖрдкрдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдореЗрдВ рд╕рдорд░реНрдерд┐рдд рдирд╣реАрдВ рд╣реИ, рддреЛ рдпрджрд┐ рдЖрдк рдХрд░реНрдиреЗрд▓ рдХреЛ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдкреВрдЫрддреЗ рд╣реИрдВ рддреЛ рдпрд╣ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдХрд╛рдо рдХрд░реЗрдЧрд╛ред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА "рд╕реЗрдЯрд┐рдВрдЧ" рдХрд╛ рдПрдХ рд╣рд┐рд╕реНрд╕рд╛ <code>execve</code> рджреНрд╡рд╛рд░рд╛ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдорд┐рд▓рд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдк рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╢реБрд░реВ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдмрд╕ рд░рд╛рдЬреНрдп рдХреЛ рд╕рд╣реА рдврдВрдЧ рд╕реЗ <code>execve</code> рдХрд░рдХреЗ рдЬрдЯрд┐рд▓ рдмреИрд╕рд╛рдЦреА рдХреЗ рдмрд┐рдирд╛ рдРрд╕рд╛ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдХреБрдЫ рдРрд╕рд╛ "рдХреНрдпреЛрдВ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ <code>stderr</code> рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░реЗрдВ, рдпрджрд┐ рдЖрдк рдмрд╕ рдлрд╝рд╛рдЗрд▓ рдЦреЛрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ" рдмрдЪреНрдЪреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рдЗрд╕рдХреА рдПрдлрдбреА # 2 ")ред </p><br><p>  рдПрдХ рдмрд╛рд░, рдореБрдЭреЗ рдПрдХ рдлрд╝рд╛рдЗрд▓ рд╕реЗ рдиреЗрдЯрд╡рд░реНрдХ рдкреИрдХреЗрдЯ рдХреЗ рдЕрдиреБрдХреНрд░рдо рдХреЛ рдШрдЯрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдереАред  рдХреБрдЫ рдмрд┐рдВрджреБ рдкрд░, рдмреИрд╕рд╛рдЦреА рдХреА рд╕рдВрдЦреНрдпрд╛ рд╕рднреА рдЙрдЪрд┐рдд рд╕реАрдорд╛рдУрдВ рдХреЛ рдкрд╛рд░ рдХрд░ рдЧрдИ, рдФрд░ рдореИрдВрдиреЗ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ рдХрд┐ рдпрд╣ рд╕рдВрднрд╛рд╡рдирд╛ рдирд╣реАрдВ рдереА рдХрд┐ рдореИрдВрдиреЗ рдЬреЛ рд▓рд┐рдЦрд╛ рдерд╛, рдЙрд╕рдХреЗ рдореБрдХрд╛рдмрд▓реЗ <code>libpcap</code> рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рд╣реЛрдЧрд╛, рдпрд╣ рдорд╛рдирдХ рдерд╛, рдФрд░ рдЗрди рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдЦреЛрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдо рддреМрд░ рдкрд░ рд╕реНрд╡реАрдХреГрдд рдЙрдкрдХрд░рдг рдереЗред  рдпрд╣ рдкрддрд╛ рдЪрд▓рд╛ рд╣реИ рдХрд┐ рдбрдВрдк рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП <code>libpcap</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП <code>fopen</code> рдЬрд┐рддрдирд╛ рдХрдард┐рди рд╣реИ: рдЖрдк рдмрд╕ <code>pcap_(f)open_offline</code> рд╕рд╛рде рдбрдВрдк рдХреЛ <code>pcap_(f)open_offline</code> рдФрд░ <code>pcap_next_ex</code> рдорд╛рдзреНрдпрдо рд╕реЗ рдкреИрдХреЗрдЯ рдХреЛ рд╕реНрдХреВрдк рдХрд░рддреЗ рд╣реИрдВред  рд╡рд╣ рд╕рдм рд╣реИ!  рдЦреИрд░, рдпрд╣ рдХрд╛рдо рдкреВрд░рд╛ рд╣реЛрдиреЗ рдкрд░ рдбрдВрдк рдХреЛ рдмрдВрдж рдХрд░рдиреЗ рдХреЗ рд▓рд╛рдпрдХ рд╣реИ ... </p><br><p>  рд▓реЗрдХрд┐рди рдпрд╣рд╛рдБ рд╕рдорд╕реНрдпрд╛ рдпрд╣ рд╣реИ: рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ <code>libpcap</code> рдореЗрдореЛрд░реА рд╕реЗ рдирд╣реАрдВ рдкрдврд╝ рд╕рдХрддрд╛ рд╣реИред  рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдпрджрд┐ рдЖрдк рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ рдЗрд╕рдореЗрдВ рджреЗрд░реА рдХрд░рддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╣рдорд╛рд░реЗ "рдкреНрд░рдпреЛрдЧрд╢рд╛рд▓рд╛" рдХреЗ рд▓рд┐рдП рд╣рдо рдХрд▓реНрдкрдирд╛ рдХрд░реЗрдВрдЧреЗ рдХрд┐ рд╡рд╣ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ред </p><br><p>  рддреЛ, рдПрдХ рдореЙрдбрд▓ рдЙрджрд╛рд╣рд░рдг: рд╣рдо рдмрд╛рдЗрдЯреНрд╕ рдХреЗ рдЕрдиреБрдХреНрд░рдо рдХреЗ <code>stdin</code> рдкрд░ рдЗрдВрддрдЬрд╛рд░ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рдЬрд┐рд╕рдХреЗ рдмрд╛рдж 4 рдмрд╛рдЗрдЯреНрд╕ рджреНрд╡рд╛рд░рд╛ рдПрдХ рдбрдВрдк рдЧрдардмрдВрдзрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  рдореИрдВ рд╕рдордЭрддрд╛ рд╣реВрдВ рдХрд┐ рдЖрдк рдмрдлрд░ рдЗрдирдкреБрдЯ рдФрд░ рдХреБрдЫ <code>ungetc</code> рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдХреНрдпреЛрдВрдХрд┐ <code>libpcap</code> рдЕрднреА рднреА <code>FILE *</code> рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ), рд▓реЗрдХрд┐рди рд╕рд╛рдорд╛рдиреНрдп рд╕реНрдерд┐рддрд┐ рдореЗрдВ, рд╣рдо рдЗрд╕реЗ рдЪрд▓рддреЗ-рдлрд┐рд░рддреЗ рдЕрдирдкреИрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА <code>read</code> / <code>write</code> рд╕рд╛рде рд╕реАрдзреЗ рдХрд╛рдо рдХрд░ рд╕рдХрддреА рд╣реИред </p><br><h3 id="reshenie-1-memfd_create">  рд╕рдорд╛рдзрд╛рди 1: memfd_create </h3><br><p>  <code>memfd_create</code> рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ <code>memfd_create</code> "рдЖрдо рддреМрд░ рдкрд░ рдЧреБрдордирд╛рдо" рдлрд╝рд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред  рдлрд╝рд╛рдЗрд▓ рд╕реНрдореГрддрд┐ рдореЗрдВ рд╣реИ рдФрд░ рдореМрдЬреВрдж рд╣реИ рдЬрдмрдХрд┐ рдХрдо рд╕реЗ рдХрдо рдПрдХ рд╡рд┐рд╡рд░рдгрдХ рдЗрд╕ рдкрд░ рдЦреБрд▓рд╛ рд╣реИред  рд╕рдмрд╕реЗ рд╕рд░рд▓ рдорд╛рдорд▓реЗ рдореЗрдВ, рдЖрдкрдХреЛ рдмрд╕ рдРрд╕рд╛ рдПрдХ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдорд┐рд▓рддрд╛ рд╣реИ, рдЗрд╕реЗ <code>write</code> рдорд╛рдзреНрдпрдо рд╕реЗ рдбреЗрдЯрд╛ <code>write</code> , <code>lseek</code> рд░рд┐рд╡рд╛рдЗрдВрдб <code>lseek</code> , рдФрд░ <code>lseek</code> рд╕рд╛рде <code>libc</code> рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрддрд╛рдПрдВ: </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd = memfd_create(<span class="hljs-string"><span class="hljs-string">"pcap-dump-contents"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); write(fd, buf, length); lseek(fd, <span class="hljs-number"><span class="hljs-number">0</span></span>, SEEK_SET); FILE *file = fdopen(fd, <span class="hljs-string"><span class="hljs-string">"r"</span></span>);</code> </pre> <br><p>  рдкрд╣рд▓реЗ рддрд░реНрдХ рдХреЗ рд╕рд╛рде рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдлрд╝рд╛рдЗрд▓ рдирд╛рдо рдПрдХ рд╕рд┐рдореНрд▓рд┐рдВрдХ рдореЗрдВ <code>/proc/&lt;PID&gt;/fd</code> рдореЗрдВ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛: </p><br><pre> <code class="plaintext hljs">$ ls -l /proc/31747/fd  0 lr-x------ 1 trosinenko trosinenko 64  10 13:12 0 -&gt; /path/to/128test.pcap lrwx------ 1 trosinenko trosinenko 64  10 13:12 1 -&gt; /dev/pts/17 lrwx------ 1 trosinenko trosinenko 64  10 13:12 2 -&gt; /dev/pts/17 lrwx------ 1 trosinenko trosinenko 64  10 13:12 23 -&gt; '/home/trosinenko/.cache/appstream-cache-AH3OA0.mdb (deleted)' lrwx------ 1 trosinenko trosinenko 64  10 13:12 3 -&gt; '/memfd:pcap-dump-contents (deleted)' lrwx------ 1 trosinenko trosinenko 64  10 13:12 57 -&gt; 'socket:[41036]'</code> </pre> <br><h3 id="reshenie-2-open-s-flagom-o_tmpfile">  рд╕рдорд╛рдзрд╛рди 2: O_TMPFILE рдзреНрд╡рдЬ рдХреЗ рд╕рд╛рде рдЦреБрд▓рд╛ </h3><br><p>  рд▓рд┐рдирдХреНрд╕ рдкрд░, рдПрдХ рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд╕рд╛рде рд╢реБрд░реВ, рдПрдХ рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рддреЗ рд╕рдордп, рдЖрдк рдлрд╝рд╛рдЗрд▓ рдирд╛рдо рдХреЗ рдмрдЬрд╛рдп <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>  O_TMPFILE</code></a> рдФрд░ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдирд╛рдо <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>  O_TMPFILE</code></a> рдХрд░ рд╕рдХрддреЗ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>  O_TMPFILE</code></a> ред  рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рдлрд╝рд╛рдЗрд▓, рдЬреИрд╕рд╛ рдХрд┐ рдПрдХ рд╕рд╛рд╣рд┐рддреНрдпрд┐рдХ рдЪрд░рд┐рддреНрд░ рдХрд╣рддрд╛ рдерд╛ (рд▓рдЧрднрдЧ), рдпрд╣ <em>рд╡рд╣рд╛рдВ рд▓рдЧрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИ</em> ... рдореБрдЭреЗ рдирд╣реАрдВ рдкрддрд╛ рдХрд┐ рдбреЗрдЯрд╛ рдбрд┐рд╕реНрдХ рдкрд░ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рд╕рдВрднрд╡рддрдГ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ (рд╡реИрд╕реЗ, рдпрд╣ рдЗрд╕ рдореЛрдб рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП) ред  рдЕрдВрддрд┐рдо рд▓рд┐рдВрдХ рдмрдВрдж рд╣реЛрдиреЗ рдкрд░ рдлрд╝рд╛рдЗрд▓ рдЕрднреА рднреА рдЧрд╛рдпрдм рд╣реЛ рдЬрд╛рддреА рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕реЗ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>linkat</code></a> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбрд╛рдпрд░реЗрдХреНрдЯреНрд░реА рдЯреНрд░реА рд╕реЗ рдЬреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd = open(<span class="hljs-string"><span class="hljs-string">"."</span></span>, O_RDWR | O_TMPFILE, S_IRUSR | S_IWUSR); assert(fd != <span class="hljs-number"><span class="hljs-number">-1</span></span>); assert(write(fd, buffer + offset, len - offset) == len - offset); assert(lseek(fd, <span class="hljs-number"><span class="hljs-number">0</span></span>, SEEK_SET) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *link_to = getenv(<span class="hljs-string"><span class="hljs-string">"LINK_TO"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (link_to != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> path[<span class="hljs-number"><span class="hljs-number">128</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">snprintf</span></span>(path, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(path), <span class="hljs-string"><span class="hljs-string">"/proc/self/fd/%d"</span></span>, fd); linkat(AT_FDCWD, path, AT_FDCWD, link_to, AT_SYMLINK_FOLLOW); }</code> </pre> <br><p>  рдлрд╝рд╛рдЗрд▓ рдирд╛рдордХрд░рдг рдХреЗ рд╕рд╛рде рдкреАрдбрд╝рд┐рдд рдирд╣реАрдВ рд╣реЛрдиреЗ рдХреЗ рдЕрд╡рд╕рд░ рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрд╣ рдлрд╝рд╛рдЗрд▓ рдХреЛ рднрд░рдиреЗ, рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ, рдЖрджрд┐ рдХреЗ рд▓рд┐рдП рд╕рдВрднрд╡ рдмрдирд╛рддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдкреЗрдбрд╝ рд╕реЗ рдкрд░рдорд╛рдгреБ рд▓рд┐рдВрдХ рдХрд░рддрд╛ рд╣реИред </p><br><div class="spoiler">  <b class="spoiler_title">рдЙрджрд╛рд╣рд░рдг (рджреЛрдиреЛрдВ рджреГрд╖реНрдЯрд┐рдХреЛрдгреЛрдВ рдХреЗ рд▓рд┐рдП)</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> NDEBUG </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//    assert  -   # undef NDEBUG #endif #include &lt;sys/mman.h&gt; #include &lt;unistd.h&gt; #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;assert.h&gt; #include &lt;signal.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/stat.h&gt; #include &lt;fcntl.h&gt; #include &lt;pcap.h&gt; //     PCAP (   -- . ) static const uint32_t pcap_mgc = 0xA1B2C3D4; char buffer[1 &lt;&lt; 20]; int main() { int len = read(0, buffer, sizeof(buffer)); //  -      "", //     pcap_mgc,   //   4  .   ... int offset = -1; for (int i = 0; i &lt; len; i += 4) { if (*(uint32_t *)(buffer + i) == pcap_mgc) { offset = i; break; } } if (offset &gt;= 0) { printf("Found PCAP dump at offset %d\n", offset); } else { fprintf(stderr, "No PCAP dump found.\n"); exit(1); } //   ,  libpcap ,   //   . #if 0 int fd = memfd_create("pcap-dump-contents", 0); assert(fd != -1); assert(write(fd, buffer + offset, len - offset) == len - offset); assert(lseek(fd, 0, SEEK_SET) == 0); #else int fd = open(".", O_RDWR | O_TMPFILE, S_IRUSR | S_IWUSR); assert(fd != -1); assert(write(fd, buffer + offset, len - offset) == len - offset); assert(lseek(fd, 0, SEEK_SET) == 0); const char *link_to = getenv("LINK_TO"); if (link_to != NULL) { char path[128]; snprintf(path, sizeof(path), "/proc/self/fd/%d", fd); linkat(AT_FDCWD, path, AT_FDCWD, link_to, AT_SYMLINK_FOLLOW); } #endif raise(SIGSTOP); //    /proc/PID/fd/ //      - ... FILE *file = fdopen(fd, "r"); char errbuf[PCAP_ERRBUF_SIZE]; pcap_t * dump = pcap_fopen_offline(file, errbuf); assert(dump != NULL); struct pcap_pkthdr *hdr; const uint8_t *data; while (pcap_next_ex(dump, &amp;hdr, &amp;data) == 1) { printf("Read packet: full length = %d bytes, available %d bytes.\n", hdr-&gt;len, hdr-&gt;caplen); } return 0; }</span></span></span></span></code> </pre> <br><pre> <code class="plaintext hljs">$ fallocate -l 128 zero128 $ cat zero128 test.pcap &gt; 128test.pcap $ ./memfd &lt; 128test.pcap Found PCAP dump at offset 128 Read packet: full length = 105 bytes, available 105 bytes. Read packet: full length = 105 bytes, available 105 bytes. Read packet: full length = 66 bytes, available 66 bytes. Read packet: full length = 385 bytes, available 385 bytes. Read packet: full length = 66 bytes, available 66 bytes. ...</code> </pre> </div></div><br><h2 id="userfaultfd-obrabotka-oshibok-pamyati-v-userspace">  userfaultfd: рдпреВрдЬрд░рд╕реНрдкреЗрд╕ рдореЗрдВ рдореЗрдореЛрд░реА рдПрд░рд░ рдХреЛ рд╣реИрдВрдбрд▓ рдХрд░рдирд╛ </h2><br><p>  рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдХрд╣рдиреЗ рдореЗрдВ рдмрд╣реБрдд рдХреБрдЫ рдирдпрд╛ рдирд╣реАрдВ рд╣реЛрдЧрд╛ рдХрд┐ UNIX рдЬреИрд╕реА рдкреНрд░рдгрд╛рд▓рд┐рдпреЛрдВ рдкрд░, рдлрд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдмрд╕ рдХреБрдЫ рднреА рд╕рдВрдХреЗрдд рдирд╣реАрдВ рджреЗрддреЗ рд╣реИрдВред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд▓рд┐рдирдХреНрд╕ рдкрд░ рдпрд╣ рдПрдХ рд╕реЙрдХреЗрдЯ, рдкрд╛рдЗрдк, рдИрд╡реЗрдВрдЯрдлрд╝реАрдб рдпрд╛ рдПрдХ рдИрдмреАрдкреАрдПрдл рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХрд╛ рд▓рд┐рдВрдХ рднреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИред  рд▓реЗрдХрд┐рди рд╢рд╛рдпрдж рдпрд╣ рдЙрджрд╛рд╣рд░рдг рдЕрднреА рднреА рдЖрдкрдХреЛ рдЖрд╢реНрдЪрд░реНрдпрдЪрдХрд┐рдд рдХрд░реЗрдЧрд╛ред  рд▓реЗрдЦ рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рдореИрдВрдиреЗ рдЗрд╕ рддрдереНрдп рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХреА рдХрд┐ рдкреГрд╖реНрда рджреЛрд╖ рдХрд░реНрдиреЗрд▓ рдХреЗ рд▓рд┐рдП рдПрдХ рдЖрдо рдмрд╛рдд рд╣реИ: рд╕реНрд╡реИрдк, рдХреЙрдкреА-рдСрди-рд░рд╛рдЗрдЯ, рдпрд╣ рд╕рдм ... рдЬрдм рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ "рдорд┐рд╕" рдХрд░рддреА рд╣реИ, рддреЛ SIGSEGV рдХреЛ рдЗрд╕реЗ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдЬрд╣рд╛рдВ рддрдХ тАЛтАЛрдореБрдЭреЗ рдкрддрд╛ рд╣реИ, рдХрд░реНрдиреЗрд▓ рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди SIGSEGV рд╣реИрдВрдбрд▓рд░ рд╕реЗ рдирд┐рдпрдВрддреНрд░рдг рд╡рд╛рдкрд╕ рд▓реЗрдирд╛ рдЕрдкрд░рд┐рднрд╛рд╖рд┐рдд рд╡реНрдпрд╡рд╣рд╛рд░ рд╣реИ, рдФрд░ рдлрд┐рд░ рднреА, рд╡рд╣рд╛рдБ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">GNU libsigsegv</a> рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╣реИ рдЬреЛ рд╡рд┐рднрд┐рдиреНрди рдкреНрд▓реЗрдЯрдлрд╛рд░реНрдореЛрдВ рдкрд░ рдореЗрдореЛрд░реА рдПрдХреНрд╕реЗрд╕ рддреНрд░реБрдЯрд┐рдпреЛрдВ рд╕реЗ рдирд┐рдкрдЯрдиреЗ рдХреА рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреЛ рд╕рд╛рдорд╛рдиреНрдп рдХрд░рддрд╛ рд╣реИ, рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рд╡рд┐рдВрдбреЛрдЬ <strong>(рдПрдЯреАрдЯреАрд╢рди): рдЬреАрдкреАрдПрд▓ рд▓рд╛рдЗрд╕реЗрдВрд╕, рдпрджрд┐ рдЗрд╕рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рдирд╣реАрдВ рд╣реИред рдЕрдкрдиреЗ рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреЛ рд╡рд┐рддрд░рд┐рдд рдХрд░реЗрдВ, libsigsegv рдХрд╛ рдЙрдкрдпреЛрдЧ рди рдХрд░реЗрдВ)</strong> ред  рдмрд╣реБрдд рд╕рдордп рдкрд╣рд▓реЗ рдирд╣реАрдВ, рд▓рд┐рдирдХреНрд╕ рдореЗрдВ рдПрдХ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдкреНрд░рд▓реЗрдЦрд┐рдд рдкрджреНрдзрддрд┐ рджрд┐рдЦрд╛рдИ рджреА, рдЬрд┐рд╕реЗ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>userfaultfd</code></a> рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ: рдЙрд╕реА рдирд╛рдо рдХреЗ рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рдЖрдк рдПрдХ рдлрд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░, рд░реАрдбрд┐рдВрдЧ рдФрд░ рд░рд╛рдЗрдЯрд┐рдВрдЧ рдЦреЛрд▓рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдореЗрдВ рд╡рд┐рд╢реЗрд╖ рд╕рдВрд░рдЪрдирд╛рдПрдВ рдХрдорд╛рдВрдб рд╣реЛрддреА рд╣реИрдВред </p><br><p>  рдЗрд╕ рддрд░рд╣ рдХреЗ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдХреЗ рд╕рд╛рде, рдЖрдк рдЕрдкрдиреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рдХрдИ рд╡рд░реНрдЪреБрдЕрд▓ рдкрддреЛрдВ рдХреЛ рдЪрд┐рд╣реНрдирд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдЙрд╕рдХреЗ рдмрд╛рдж, рд╕реНрдореГрддрд┐ рдХреЗ рдкреНрд░рддреНрдпреЗрдХ рдЪрд┐рд╣реНрдирд┐рдд рдкреГрд╖реНрда рдкрд░ рдкрд╣рд▓реА рдкрд╣реБрдВрдЪ рдореЗрдВ, рдкреНрд░рд╡рд╛рд╣ рд╕реЛ рдЬрд╛рдПрдЧрд╛, рдФрд░ рдлрд╝рд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рд╕реЗ рдкрдврд╝рдиреЗ рд╕реЗ рдЬреЛ рд╣реБрдЖ рдЙрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рд╡рд╛рдкрд╕ рдЖ рдЬрд╛рдПрдЧреАред  рдЙрд╕рдХреЗ рдмрд╛рдж, рд╣реИрдВрдбрд▓рд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ рдПрдХ рд╕рдВрдХреЗрддрдХ рдХреЗ рд╕рд╛рде рдбреЗрдЯрд╛ рдХреЛ рднрд░реЗрдЧрд╛ рдЬрд┐рд╕реЗ "рд╕рдорд╕реНрдпрд╛" рдкреГрд╖реНрда рдХреЛ рдкреНрд░рд╛рд░рдВрдн рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдХрд░реНрдиреЗрд▓ рдЗрд╕реЗ рдЖрд░рдВрдн рдХрд░реЗрдЧрд╛ рдФрд░ рдЙрд╕ рдереНрд░реЗрдб рдХреЛ рдЬрдЧрд╛рдПрдЧрд╛ рдЬреЛ рдмрджрд▓ рдЧрдпрд╛ред  рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рдпрд╣ рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдПрдХ рдЕрд▓рдЧ рд╕реНрдЯреНрд░реАрдо рд╣реИ рдЬрд┐рд╕рдХреА рдЬрд┐рдореНрдореЗрджрд╛рд░рд┐рдпреЛрдВ рдореЗрдВ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рд╕реЗ рд░реАрдбрд┐рдВрдЧ рдХрдорд╛рдВрдб рдФрд░ рдЙрддреНрддрд░ рдЬрд╛рд░реА рдХрд░рдирд╛ рд╢рд╛рдорд┐рд▓ рд╣реИред  <em>рд╕рд╛рдорд╛рдиреНрдпрддрдпрд╛, рдЕрдиреНрдп рдЬрд╛рдирдХрд╛рд░реА <code>userfaultfd</code> рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╡рд░реНрдЪреБрдЕрд▓ рдХрд╛рд░реНрдб рдкрд░рд┐рд╡рд░реНрддрди рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреБрдЫ рд╕реВрдЪрдирд╛рдПрдВред</em> </p><br><div class="spoiler">  <b class="spoiler_title">рдЙрджрд╛рд╣рд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> NDEBUG </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//    assert  -   # undef NDEBUG #endif #include &lt;linux/userfaultfd.h&gt; #include &lt;syscall.h&gt; #include &lt;sys/mman.h&gt; #include &lt;sys/ioctl.h&gt; #include &lt;unistd.h&gt; #include &lt;pthread.h&gt; #include &lt;assert.h&gt; #include &lt;stdint.h&gt; #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; // -,   sysconf... #define PAGE_SIZE 4096 #define PAGE_MASK (PAGE_SIZE - 1) static void *thread_fn(void * arg) { int uffd = (intptr_t)arg; struct uffd_msg msg; // ,    hugepages... uint8_t *replacement_page = mmap(NULL, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1 ,0); while(1) { assert(read(uffd, &amp;msg, sizeof msg) &gt; 0); //    ,    if (msg.event == UFFD_EVENT_PAGEFAULT) { uintptr_t addr = msg.arg.pagefault.address; fprintf(stderr, "Fault: addr = 0x%zx\n", addr); //       uint8_t *page_addr = (uint8_t *)((uintptr_t)addr &amp; ~PAGE_MASK); //  "" ,  ""! memset(replacement_page, 0xAB, PAGE_SIZE); //     struct uffdio_copy copy; copy.src = (uintptr_t)replacement_page; copy.dst = (uintptr_t)page_addr; copy.mode = 0; // ,  --   copy.copy = 0; //   --      copy.len = PAGE_SIZE; assert(ioctl(uffd, UFFDIO_COPY, &amp;copy) != -1); } } } static int init_userfaultfd(void) { //   int uffd = syscall(__NR_userfaultfd, 0); // ,       struct uffdio_api api; api.api = UFFD_API; api.features = 0; assert(ioctl(uffd, UFFDIO_API, &amp;api) != -1); fprintf(stderr, "UFFD open\n"); //  - pthread_t thread; memset(&amp;thread, 0, sizeof(thread)); // ...    int  void *? pthread_create(&amp;thread, 0, thread_fn, (void *)(intptr_t)uffd); return uffd; } static void register_region(int uffd, void * aligned_addr, size_t size) { struct uffdio_register reg; memset(&amp;reg, 0, sizeof reg); reg.range.start = (uintptr_t)aligned_addr; reg.range.len = size; reg.mode = UFFDIO_REGISTER_MODE_MISSING; assert (ioctl(uffd, UFFDIO_REGISTER, &amp;reg) != -1); } int main() { void *addr = mmap(NULL, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0); int uffd = init_userfaultfd(); register_region(uffd, addr, PAGE_SIZE); fprintf(stderr, "Before reading\n"); fprintf(stderr, "Data at %p: %x\n", addr, *(volatile int *)addr); return 0; }</span></span></span></span></code> </pre> <br><pre> <code class="plaintext hljs">$ ./userfaultfd UFFD open Before reading Fault: addr = 0x7f46f40d5000 Data at 0x7f46f40d5000: abababab</code> </pre> </div></div><br><h2 id="laquoklyuchevoy-vopros-matematiki-ne-vsyo-li-ravnoraquo-c">  "рдЧрдгрд┐рдд рдХрд╛ рдкреНрд░рдореБрдЦ рдкреНрд░рд╢реНрди: рдХреНрдпрд╛ рдпрд╣ рд╕рдм рдПрдХ рд╣реА рд╣реИ?" ┬й </h2><br><p>  рдХреНрдпрд╛ рд╣реЛрдЧрд╛ рдпрджрд┐ рдЖрдкрдХреЛ рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ рдлрд╝рд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ <code>stdin</code> рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИ?  рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ <code>if (fd == 0) ...</code> - рдФрд░ рдпрд╣ рдмрд╛рдд рд╣реИред  рдареАрдХ рд╣реИ, рдареАрдХ рд╣реИ ... </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;unistd.h&gt; #include &lt;stdio.h&gt; int main() { int fd = dup(0); printf("stdin is fd %d, too\n", fd); if (fd == 0) printf("stdin"); else printf("not stdin"); return 0; }</span></span></span></span></code> </pre> <br><pre> <code class="plaintext hljs">$ gcc kcmp.c -o kcmp $ ./kcmp stdin is fd 3, too not stdin</code> </pre> <br><p>  рдУрд╣ ... рд╕рдВрднрд╛рд▓ рдПрдХ рддрд░рд╣ рд╣реИ, рд▓реЗрдХрд┐рди рдЙрдкрдирд╛рдо рдЕрд▓рдЧ рд╣реИрдВред  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">CRIU</a> - рдЪреЗрдХрдкреЙрдЗрдВрдЯ / рд░рд┐рд╕реНрдЯреЛрд░ рдЗрди <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдпреВрдЬрд░реНрд╕рд╕реНрдкреЗрд╕ рд╣рдорд╛рд░реА</a> рдорджрдж рдХрд░реЗрдЧрд╛ред  ,     ,      .     userspace-,    ,   ,      <code>kcmp</code> :    PID,   , ,  ,   ,          : </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;linux/kcmp.h&gt; #include &lt;syscall.h&gt; #include &lt;unistd.h&gt; #include &lt;stdio.h&gt; int main() { int fd = dup(0); printf("stdin is fd %d, too\n", fd); int pid = getpid(); if (syscall(SYS_kcmp, pid, pid, KCMP_FILE /*    _FILES! */, 0 /* stdin fd */, fd) == 0) printf("stdin\n"); else printf("not stdin\n"); if (syscall(SYS_kcmp, pid, pid, KCMP_FILE, 1 /* stdout fd */, fd) == 0) printf("stdout\n"); else printf("not stdout\n"); return 0; }</span></span></span></span></code> </pre> <br><pre> <code class="plaintext hljs">$ ./kcmp stdin is fd 3, too stdin stdout</code> </pre> <br><p>   !  ,   ... </p><br><pre> <code class="plaintext hljs">$ ls -l /proc/self/fd  0 lrwx------ 1 trosinenko trosinenko 64  10 14:45 0 -&gt; /dev/pts/17 lrwx------ 1 trosinenko trosinenko 64  10 14:45 1 -&gt; /dev/pts/17 lrwx------ 1 trosinenko trosinenko 64  10 14:45 2 -&gt; /dev/pts/17 lrwx------ 1 trosinenko trosinenko 64  10 14:45 23 -&gt; '/home/trosinenko/.cache/appstream-cache-AH3OA0.mdb (deleted)' lr-x------ 1 trosinenko trosinenko 64  10 14:45 3 -&gt; /proc/17265/fd lrwx------ 1 trosinenko trosinenko 64  10 14:45 57 -&gt; 'socket:[41036]'</code> </pre> <br><p> ,   ,   ,  ,       .  ,  bash        ,    <code>ls</code> ! </p><br><pre> <code class="plaintext hljs">$ ./kcmp &lt; kcmp.c stdin is fd 3, too stdin not stdout</code> </pre> <br><p>   ,       тАФ         -,   best effort   -    . </p><br><h2 id="obo-vsyom-i-ponemnozhku">     </h2><br><p>   , ... </p><br><ul><li> тАж      JIT-    userspace?  ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="> eBPF-</a> .       ,  ( ,   ,      -)  . .,    JIT-,  . ,      , BPF. </li><li> тАж        ?  ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>sigaltstack</code></a> . </li><li> тАж       ,     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>readahead</code></a> </li></ul><br><p>           <code>oldolduname</code> ... </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi475184/">https://habr.com/ru/post/hi475184/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi475168/index.html">рдХрдо рдЬреЛрдЦрд┐рдо рд╡рд╛рд▓реЗ рд╡рд┐рдирд┐рдордп рдирд┐рд╡реЗрд╢: рдмреИрдВрдХ рдЬрдорд╛ рдХреЗ рд╡рд┐рдХрд▓реНрдк рдХреЗ рд░реВрдк рдореЗрдВ рдЖрдИрдЖрдИрдП рдЦрд╛рддреЛрдВ рдФрд░ рдмреЙрдиреНрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░реЗрдВ</a></li>
<li><a href="../hi475170/index.html">React.JS рдкрд░ рдбреЗрдЯрд╛-рд╕рдВрдЪрд╛рд▓рд┐рдд рдРрдкреНрд╕ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдмреБрдирд┐рдпрд╛рджреА рдкреИрдЯрд░реНрди рдХреА рд╕рдорд╕реНрдпрд╛рдПрдВ</a></li>
<li><a href="../hi475172/index.html">рд░рд╛рд╕реНрдкрдмреЗрд░реА рдкрд╛рдИ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ 5 рддрд░реАрдХреЗ рднрд╛рдЧ рддреАрди</a></li>
<li><a href="../hi475174/index.html">рдмреИрдЯрд░реА рдпрд╛ рдЗрд▓реЗрдХреНрдЯреНрд░рд┐рдХ рдкреИрд░рд╛рдореЛрдЯрд░ рдХреЗ рдПрдХ рдЫреЛрдЯреЗ рд╕реЗ рд╕рд┐рджреНрдзрд╛рдВрдд рдкрд░ рдХреИрд╕реЗ рдЙрддрд╛рд░реЗрдВред рднрд╛рдЧ 1</a></li>
<li><a href="../hi475178/index.html">PostgreSQL рдореЗрдВ JSONB рдХреЗ рд╕рд╛рде EAV рдХреА рдЬрдЧрд╣</a></li>
<li><a href="../hi475188/index.html">рдмрд╛рдзрд╛ рдЖрдзрд╛рд░рд┐рдд рдЯрд╛рдЗрд▓ рдкреНрд▓реЗрд╕рдореЗрдВрдЯ рдПрд▓реНрдЧреЛрд░рд┐рдереНрдо</a></li>
<li><a href="../hi475192/index.html">рдЧреНрд▓реЛрдмрд▓ рд╡рд╛рд░реНрдорд┐рдВрдЧ рд╕реЗ рд▓рдбрд╝рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рдиреЗ рд╡рд╛рд▓реА рдХрдВрдкрдиреА рдореЗрдВ рдиреМрдХрд░реА рдХреИрд╕реЗ рдЦреЛрдЬреЗрдВ?</a></li>
<li><a href="../hi475194/index.html">SOLID рджреНрд╡рд╛рд░рд╛ рд░рд┐рдбрдХреНрд╕ рд▓рд┐рдЦрдирд╛</a></li>
<li><a href="../hi475196/index.html"># 321 рдбреЗрд╡рд▓рдкрд░ рдХреЗ рд▓рд┐рдП рджрд┐рд▓рдЪрд╕реНрдк рд╕рд╛рдордЧреНрд░реА рдХрд╛ рдкрд╛рдЪрди (4 рдирд╡рдВрдмрд░ рдХреЛ - 10)</a></li>
<li><a href="../hi475200/index.html">OpenStreetMap рд╕рдВред 484 (10/22/2019 - 28/10/2019) рдХреА рджреБрдирд┐рдпрд╛ рд╕реЗ рд╕рдорд╛рдЪрд╛рд░</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>