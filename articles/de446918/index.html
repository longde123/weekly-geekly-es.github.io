<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôíÔ∏è üéá üïê Ich habe diese 6 Lektionen der Arbeit mit Cloudformation f√ºrs Leben gelernt. üîá üë©üèæ‚Äçüéì üë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich habe vor 4 Jahren angefangen mit Cloudformation zu arbeiten. Seitdem habe ich viele Infrastrukturen kaputt gemacht, auch solche, die bereits in Pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ich habe diese 6 Lektionen der Arbeit mit Cloudformation f√ºrs Leben gelernt.</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446918/">  Ich <i>habe vor</i> 4 Jahren angefangen mit <i>Cloudformation</i> zu arbeiten.  Seitdem habe ich viele Infrastrukturen kaputt gemacht, auch solche, die bereits in Produktion waren.  Aber jedes Mal, wenn ich etwas verw√∂hnte, lernte ich neue Dinge.  Dank dieser Erfahrung werde ich einige der wichtigsten Lektionen teilen, die ich gelernt habe. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f6e/613/762/f6e6137629025956cdcc0a1e810f5066.jpg" alt="Bild"><br><br><h4>  Lektion 1: √úberpr√ºfen Sie √Ñnderungen vor der Bereitstellung </h4><br>  Ich habe diese Lektion gelernt, als ich anfing, mit <i>Cloudformation zu arbeiten</i> .  Ich kann mich nicht erinnern, was ich damals kaputt gemacht habe, aber ich erinnere mich genau, dass ich den <i>Befehl aws cloudformation update verwendet habe</i> .  Mit diesem Befehl wird die Vorlage einfach bereitgestellt, ohne dass die √Ñnderungen √ºberpr√ºft werden, die bereitgestellt werden.  Ich denke nicht, dass Erkl√§rungen erforderlich sind, f√ºr die alle √Ñnderungen √ºberpr√ºft werden m√ºssen, bevor sie bereitgestellt werden. <br><br>  Nach diesem Fehler habe ich sofort die <i>Bereitstellungspipeline</i> ge√§ndert und den Aktualisierungsbefehl durch den Befehl <i>create-change-set ersetzt</i> <br><br><pre><code class="plaintext hljs"># OPERATION is either "UPDATE" or "CREATE" changeset_id=$(aws cloudformation create-change-set \ --change-set-name "$CHANGE_SET_NAME" \ --stack-name "$STACK_NAME" \ --template-body "$TPL_PATH" \ --change-set-type "$OPERATION" \ --parameters "$PARAMETERS" \ --output text \ --query Id) aws cloudformation wait \ change-set-create-complete --change-set-name "$changeset_id"</code> </pre> <br>  Wenn ein √Ñnderungssatz erstellt wird, wirkt sich dies nicht auf den vorhandenen Stapel aus.  Im Gegensatz zum Befehl update wird der Change-Set-Ansatz nicht tats√§chlich bereitgestellt.  Stattdessen wird eine Liste mit √Ñnderungen erstellt, die Sie vor der Bereitstellung √ºberpr√ºfen k√∂nnen.  Sie k√∂nnen die √Ñnderungen in der aws-Konsolenoberfl√§che anzeigen.  Wenn Sie jedoch lieber alles M√∂gliche automatisieren m√∂chten, √ºberpr√ºfen Sie diese in der CLI: <br><a name="habracut"></a><br><pre> <code class="plaintext hljs"># this command is presented only for demonstrational purposes. # the real command should take pagination into account aws cloudformation describe-change-set \ --change-set-name "$changeset_id" \ --query 'Changes[*].ResourceChange.{Action:Action,Resource:ResourceType,ResourceId:LogicalResourceId,ReplacementNeeded:Replacement}' \ --output table</code> </pre> <br>  Dieser Befehl sollte eine Ausgabe √§hnlich der folgenden erzeugen: <br><br><pre> <code class="plaintext hljs">-------------------------------------------------------------------- | DescribeChangeSet | +---------+--------------------+----------------------+------------+ | Action | ReplacementNeeded | Resource | ResourceId | +---------+--------------------+----------------------+------------+ | Modify | True | AWS::ECS::Cluster | MyCluster | | Replace| True | AWS::RDS::DBInstance| MyDB | | Add | None | AWS::SNS::Topic | MyTopic | +---------+--------------------+----------------------+------------+</code> </pre> <br>  Achten Sie besonders auf √Ñnderungen, bei denen Aktion <i>Ersetzen</i> , <i>L√∂schen</i> oder <i>Ersetzen</i> erforderlich <i>ist</i> .  Dies sind die gef√§hrlichsten √Ñnderungen und f√ºhren normalerweise zum Verlust von Informationen. <br><br>  Wenn √Ñnderungen angezeigt werden, k√∂nnen sie erweitert werden <br><br><pre> <code class="plaintext hljs">aws cloudformation execute-change-set --change-set-name "$changeset_id" operation_lowercase=$(echo "$OPERATION" | tr '[:upper:]' '[:lower:]') aws cloudformation wait "stack-${operation_lowercase}-complete" \ --stack-name "$STACK_NAME"</code> </pre> <br><h4>  Lektion 2: Verwenden Sie die Stapelrichtlinie, um das Ersetzen oder Entfernen von Ressourcen zu verhindern </h4><br>  Manchmal reicht es nicht aus, nur die √Ñnderungen zu betrachten.  Wir sind alle Menschen und machen alle Fehler.  Kurz nachdem wir mit der Verwendung von √Ñnderungss√§tzen begonnen hatten, f√ºhrte mein Teamkollege unwissentlich eine Bereitstellung durch, die zu einem Datenbank-Upgrade f√ºhrte.  Es passierte nichts Schreckliches, weil es sich um eine Testumgebung handelte. <br><br>  Trotz der Tatsache, dass in unseren Skripten eine Liste der √Ñnderungen angezeigt und um Best√§tigung gebeten wurde, wurde die √Ñnderung ersetzen √ºbersprungen, da die Liste der √Ñnderungen so gro√ü war, dass sie nicht auf den Bildschirm passen konnte.  Und da dies ein regelm√§√üiges Update in der Testumgebung war, wurde den √Ñnderungen nicht viel Aufmerksamkeit geschenkt. <br><cut></cut><br>  Es gibt Ressourcen, die Sie niemals ersetzen oder entfernen m√∂chten.  Hierbei handelt es sich um statusbehaftete Dienste, z. B. eine Instanz einer RDS-Datenbank oder eines Elastichsearch-Clusters usw. Es w√§re sch√∂n, wenn aws die Bereitstellung automatisch ablehnen w√ºrde, wenn f√ºr die ausgef√ºhrte Operation das Entfernen einer solchen Ressource erforderlich w√§re.  Gl√ºcklicherweise verf√ºgt Cloudformation √ºber eine integrierte Methode, um dies zu tun.  Dies wird als Stapelrichtlinie bezeichnet. Weitere Informationen hierzu finden Sie in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> : <br><br><pre> <code class="plaintext hljs">STACK_NAME=$1 RESOURCE_ID=$2 POLICY_JSON=$(cat &lt;&lt;EOF { "Statement" : [{ "Effect" : "Deny", "Action" : [ "Update:Replace", "Update:Delete" ], "Principal": "*", "Resource" : "LogicalResourceId/$RESOURCE_ID" }] } EOF ) aws cloudformation set-stack-policy --stack-name "$STACK_NAME" \ --stack-policy-body "$POLICY_JSON"</code> </pre> <br><h4>  Lektion 3: Verwenden Sie UsePreviousValue, wenn Sie einen Stapel mit geheimen Parametern aktualisieren </h4><br>  Wenn Sie eine RDS-Entit√§t erstellen, m√ºssen Sie in mysql AWS MasterUsername und MasterUserPassword angeben.  Da es besser ist, keine Geheimnisse im Quellcode zu behalten, und ich absolut alles automatisieren wollte, habe ich einen ‚Äûintelligenten Mechanismus‚Äú implementiert, bei dem Anmeldeinformationen vor der Bereitstellung von s3 abgerufen werden. Wenn Anmeldeinformationen nicht gefunden werden, werden neue Anmeldeinformationen generiert und in s3 gespeichert . <br><br>  Diese Anmeldeinformationen werden dann als Parameter an den Befehl cloudformation create-change-set √ºbergeben.  W√§hrend der Experimente mit dem Skript kam es vor, dass die Verbindung zu s3 unterbrochen wurde, und mein ‚Äûintelligenter Mechanismus‚Äú betrachtete dies als Signal zum Generieren neuer Anmeldeinformationen. <br><cut></cut><br>  Wenn ich dieses Skript in einer Produktionsumgebung verwenden w√ºrde und das Verbindungsproblem erneut auftreten w√ºrde, w√ºrde der Stapel mit neuen Anmeldeinformationen aktualisiert.  In diesem speziellen Fall wird nichts Schlimmes passieren.  Ich habe diesen Ansatz jedoch aufgegeben und einen anderen Ansatz verwendet, bei dem Anmeldeinformationen nur einmal angegeben wurden - beim Erstellen des Stapels.  Und sp√§ter, wenn der Stapel aktualisiert werden muss, anstatt den geheimen Wert des Parameters anzugeben, w√ºrde ich einfach <i>UsePreviousValue = true verwenden</i> : <br><br><pre> <code class="plaintext hljs">aws cloudformation create-change-set \ --change-set-name "$CHANGE_SET_NAME" \ --stack-name "$STACK_NAME" \ --template-body "$TPL_PATH" \ --change-set-type "UPDATE" \ --parameters "ParameterKey=MasterUserPassword,UsePreviousValue=true"</code> </pre> <br><h4>  Lektion 4: Verwenden Sie die Rollback-Konfiguration </h4><br>  Ein anderes Team, mit dem ich zusammengearbeitet habe, verwendete eine <i>Cloudformationsfunktion</i> namens <i>Rollback-Konfiguration</i> .  Ich habe sie noch nie zuvor getroffen und schnell erkannt, dass dies die Bereitstellung meiner Stapel noch besser machen w√ºrde.  Jetzt verwende ich jedes Mal, wenn ich meinen Code in Lambda oder ECS mithilfe von Cloudformation bereitstelle. <br><br>  So funktioniert es: Sie geben den <i>CloudWatch-</i> <i>Alarm arn</i> im Parameter <i>--rollback-configuration an</i> , wenn Sie den √Ñnderungssatz erstellen.  Sp√§ter, wenn Sie den √Ñnderungssatz abgeschlossen haben, verfolgt aws den Alarm mindestens eine Minute lang.  Die Bereitstellung wird zur√ºckgesetzt, wenn w√§hrend dieser Zeit der Alarmstatus in ALARM ge√§ndert wird. <br><br>  Das folgende Beispiel zeigt einen Auszug aus der <i>Cloudformationsvorlage,</i> in dem ich einen <i>Cloudwatch-Alarm</i> erstelle, der die Cloud-Metrik des Benutzers als Anzahl der Fehler in den Cloud-Protokollen verfolgt (die Metrik wird √ºber <i>MetricFilter erstellt</i> ): <br><br><pre> <code class="plaintext hljs">Resources: # this metric tracks number of errors in the cloudwatch logs. In this # particular case it's assumed logs are in json format and the error logs are # identified by level "error". See FilterPattern ErrorMetricFilter: Type: AWS::Logs::MetricFilter Properties: LogGroupName: !Ref LogGroup FilterPattern: !Sub '{$.level = "error"}' MetricTransformations: - MetricNamespace: !Sub "${AWS::StackName}-log-errors" MetricName: Errors MetricValue: 1 DefaultValue: 0 ErrorAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Sub "${AWS::StackName}-errors" Namespace: !Sub "${AWS::StackName}-log-errors" MetricName: Errors Statistic: Maximum ComparisonOperator: GreaterThanThreshold Period: 1 # 1 minute EvaluationPeriods: 1 Threshold: 0 TreatMissingData: notBreaching ActionsEnabled: yes</code> </pre> <br>  Jetzt kann der <i>Alarm</i> als <i>Rollback-</i> Trigger verwendet werden, wenn eine Reihe von Tools ausgef√ºhrt wird: <br><br><pre> <code class="plaintext hljs">ALARM_ARN=$1 ROLLBACK_TRIGGER=$(cat &lt;&lt;EOF { "RollbackTriggers": [ { "Arn": "$ALARM_ARN", "Type": "AWS::CloudWatch::Alarm" } ], "MonitoringTimeInMinutes": 1 } EOF ) aws cloudformation create-change-set \ --change-set-name "$CHANGE_SET_NAME" \ --stack-name "$STACK_NAME" \ --template-body "$TPL_PATH" \ --change-set-type "UPDATE" \ --rollback-configuration "$ROLLBACK_TRIGGER"</code> </pre> <br><h4>  Lektion 5: Stellen Sie sicher, dass Sie die neueste Version der Vorlage bereitstellen </h4><br>  Es ist nicht einfach, die neueste Version der Cloudformation-Vorlage bereitzustellen, aber es wird viel Schaden anrichten.  Einmal war es bei uns: Der Entwickler hat nicht die neuesten √Ñnderungen von Git gesendet und die vorherige Version des Stacks unwissentlich bereitgestellt.  Dies f√ºhrte zu einer einfachen Anwendung, die diesen Stapel verwendete. <br><cut></cut><br>  Etwas Einfaches, wie das Hinzuf√ºgen einer √úberpr√ºfung, ob ein Zweig vor der Bereitstellung relevant ist, ist in Ordnung (vorausgesetzt, Git ist Ihr Tool zur Versionskontrolle): <br><pre> <code class="plaintext hljs">git fetch HEADHASH=$(git rev-parse HEAD) UPSTREAMHASH=$(git rev-parse master@{upstream}) if [[ "$HEADHASH" != "$UPSTREAMHASH" ]] ; then echo "Branch is not up to date with origin. Aborting" exit 1 fi</code> </pre> <br><h4>  Lektion 6: Das Rad nicht neu erfinden </h4><br>  Die Bereitstellung mit <i>Cloudformation</i> scheint einfach zu sein.  Sie ben√∂tigen nur eine Reihe von Bash-Skripten, die aws cli-Befehle ausf√ºhren. <br><br>  Vor 4 Jahren begann ich mit einfachen Skripten namens aws cloudformation create-stack command.  Bald war das Drehbuch nicht mehr einfach.  Jede Lektion machte das Skript immer komplexer.  Es war nicht nur schwierig, sondern auch mit einer Reihe von Fehlern. <br><br>  Jetzt arbeite ich in einer kleinen IT-Abteilung.  Die Erfahrung hat gezeigt, dass jedes Team seine eigene Art der Bereitstellung von Cloudformation-Stacks hat.  Und das ist schlecht.  Es w√§re besser, wenn jeder einen einzigen Ansatz verfolgen w√ºrde.  Gl√ºcklicherweise gibt es viele Tools, mit denen Sie Cloudformation-Stacks bereitstellen und konfigurieren k√∂nnen. <br><br>  Diese Lektionen helfen Ihnen, Fehler zu vermeiden. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de446918/">https://habr.com/ru/post/de446918/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de446906/index.html">Umgebungsmusik und ihre Auswirkungen auf das Schreiben von Code</a></li>
<li><a href="../de446908/index.html">Empfehlungen zur Informationssicherheit von DLP und FSTEC: √úberschneiden von Parallelen</a></li>
<li><a href="../de446912/index.html">Wie viel kostet die Sicherheit von Webanwendungen (am Beispiel von Barracuda WAF-as-a-Service)?</a></li>
<li><a href="../de446914/index.html">Warum unterrichtest du gehen</a></li>
<li><a href="../de446916/index.html">Hierarchische Adressbuchver√∂ffentlichung Aktualisiert von Zimbra Docs und anderen Neuheiten in Zimbra 8.8.12</a></li>
<li><a href="../de446920/index.html">Reverse Engineering von April Fool von Google</a></li>
<li><a href="../de446922/index.html">Die Katze unter der Haube. Teil 2</a></li>
<li><a href="../de446924/index.html">Darstellung beliebiger Polynome in Form endlicher Differenzen mit beliebigem Schritt</a></li>
<li><a href="../de446926/index.html">"Also wurde mir klar, dass ich jetzt ein Date Engineer bin und auf eine andere Art und Weise sich auf dem Markt positionieren kann."</a></li>
<li><a href="../de446932/index.html">TDMS Fairway und BIM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>