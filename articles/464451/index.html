<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëºüèª üîπ üèõÔ∏è C√≥mo hice un rastreador de estacionamiento para personas üêò üàÅ üë©üèº‚Äçüé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recientemente, volv√≠ a sujetar. Vivo en Europa, y aqu√≠, en lugar de multas por estacionamiento incorrecto y gr√∫as de "amarre", encadenan la rueda de s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo hice un rastreador de estacionamiento para personas</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464451/">  Recientemente, volv√≠ a sujetar.  Vivo en Europa, y aqu√≠, en lugar de multas por estacionamiento incorrecto y gr√∫as de "amarre", encadenan la rueda de su autom√≥vil.  Para salir, debe hacer una llamada telef√≥nica, pagar una suma redonda y esperar a que el tipo con las llaves levante la cadena.  Es largo, humillante y a veces (dependiendo del √°rea) depredador caro. <br><br>  Ese d√≠a llegu√© tarde a todas partes.  Mientras esperaba que el trabajador sonara con las llaves, me preguntaba cu√°n est√∫pidamente me puse.  Entr√© corriendo, dej√© el autom√≥vil durante media hora en lugar de los 20 minutos m√°ximos libres, exactamente en el minuto 21 y me atraparon.  Desafortunadamente, la camioneta rayada del estacionamiento no estaba muy lejos, e instant√°neamente reaccionaron.  Sol√≠an atraparme antes, por varias razones: me olvid√©, el plazo pagado venci√≥, y a veces simplemente no pod√≠a encontrar mi auto en el laberinto de calles. <br><br>  "Debe haber una aplicaci√≥n para todo", pens√©, y comenc√© a profundizar en la tienda de aplicaciones.  Despu√©s de un mont√≥n de resultados dudosos, mi confianza disminuy√≥ y decid√≠ aclarar: "debe haber una aplicaci√≥n de Android para todo".  Luego encontr√≥ su huavei y se meti√≥ en las entra√±as de la tienda de juegos.  A partir de ah√≠, se derramaron m√°s escombros sobre m√≠ y, ahogado en torpes embarcaciones, escup√≠.  O estoy buscando algo mal, o no hay un rastreador de estacionamiento conveniente y comprensible.  La conclusi√≥n es simple: si no tenemos algo, hag√°moslo nosotros mismos. <br><br>  En el contexto, ya estaba cortando una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">construcci√≥n a largo plazo</a> , quit√°ndome casi todo mi tiempo libre.  Decid√≠ tomar un descanso y en el intervalo para recoger otra proyecci√≥n.  Habiendo estimado la funcionalidad deseada, imagin√© un per√≠odo de un mes y medio y, mirando hacia el futuro, dir√© que, en principio, result√≥ a√∫n m√°s r√°pido.  El resultado fue una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aplicaci√≥n</a> compacta y limpia en ambas plataformas, muy conveniente.  Ahora lo uso yo mismo y le sugiero que lo pruebe. <br><br><img src="https://habrastorage.org/webt/2w/wl/zl/2wwlzlz-6vimwsq9dt2xmyv-bqk.png" alt="imagen" width="800"><br><a name="habracut"></a><br><h3>  Idea </h3><br>  Entonces, ¬øqu√© me gustar√≠a de un rastreador de estacionamiento?  ¬øQu√© extra√±o siempre cuando recibo una multa?  Despu√©s de pensar, formul√© la siguiente introducci√≥n: <br><br><ol><li>  Simple  Idealmente, un bot√≥n.  Un m√≠nimo de funciones de distracci√≥n: sin perfiles, historial de estacionamiento, soporte para m√∫ltiples autos al mismo tiempo, etc. </li><li>  Con notificaciones.  No me olvidar√≠a del auto, si la aplicaci√≥n me lo recordara: hermano, por cierto tienes un estacionamiento all√≠, y est√° a punto de caducar. </li><li>  Considere el tiempo de caminata.  Este es el pensamiento m√°s simple que no he visto encarnado en ninguna parte.  No necesito saber que el estacionamiento caducar√° en 5 minutos si estoy a media hora de distancia.  Necesito que me lo recuerden para poder <b>llegar</b> al auto unos minutos antes del final y salir. </li><li>  Ruta y navegaci√≥n al estacionamiento.  Navegaci√≥n, por supuesto, a trav√©s de Google o Apple Maps, pero la ruta se puede mostrar en su aplicaci√≥n.  Esto ayudar√° si dejaste el auto en un √°rea desconocida, el temporizador funciona y corres en c√≠rculos por las mismas calles. </li></ol><br>  Eleg√≠ Flutter como la base tecnol√≥gica, ya que he estado trabajando con √©l durante alg√∫n tiempo y lo considero bueno.  Para las rutas, decid√≠ usar la API AQU√ç, tambi√©n no por primera vez, sino para el mapa: Mapbox.  Esboc√© varias opciones para la interfaz, eleg√≠ la m√°s minimalista y me involucr√© en el trabajo. <br><br><h3>  Desarrollo </h3><br>  En principio, no hay mucho que contar sobre el proceso de desarrollo en s√≠.  Aqu√≠ no hay ninguna parte del servidor, el cliente m√°s simple, que consiste esencialmente en una vista grande en diferentes estados.  En la primera p√°gina, puede seleccionar un preset (1, 2, 4, 6 horas) o usar el control deslizante para ajustar su per√≠odo de estacionamiento.  Despu√©s de haberlo probado en vivo, me di cuenta de que el control deslizante era lo suficientemente grosero y le agregu√© los botones "+" y "-".  Un matiz divertido y bastante obvio aqu√≠ fue que mientras eliges, el tiempo contin√∫a.  Por lo tanto, debe actualizar esta vista en tiempo real.  Despu√©s de elegir el t√©rmino, haga clic en el √∫nico bot√≥n a continuaci√≥n, y se guardan los datos de ubicaci√≥n y hora, y comienza el estacionamiento.  Es importante tener en cuenta que b√°sicamente almaceno todos los datos a bordo, nada se transfiere a ning√∫n servidor.  En el futuro, esto, por cierto, crear√° dificultades para m√≠, pero m√°s sobre eso m√°s adelante. <br><br>  La segunda p√°gina es, de hecho, el temporizador de estacionamiento.  Prob√© un mont√≥n de opciones aqu√≠: comenc√© con prototipos de informaci√≥n muy sobrecargados, luego los elimin√© de manera iterativa y los simplifiqu√© hasta el l√≠mite.  Realmente quer√≠a que el estado del estacionamiento se mostrara visualmente, en lugar de n√∫meros secos, por lo que el elemento principal de esta p√°gina junto con el mapa era un gr√°fico de anillos.  Muestra el tiempo transcurrido, el tiempo de caminata y el tiempo restante.  Si no est√° cerca del autom√≥vil y el tiempo de caminata no es cero, aparece un bot√≥n de inicio de navegaci√≥n y el mapa muestra una ruta aproximada al estacionamiento.  Eso, de hecho, es todo. <br><br>  A pesar de la simplicidad visual, esta pantalla alborot√≥ mis nervios.  Debe entenderse que mientras el estacionamiento est√° activo, varios procesos ocurren simult√°neamente: <br><br><ul><li>  pasa el tiempo y se acaba el tiempo </li><li>  te mueves y el tiempo de viaje cambia </li></ul><br>  Todo esto sucede en tiempo real y debe mostrarse instant√°neamente en la interfaz.  La carta debe reconstruirse sin problemas, el mapa debe moverse y volver a dibujar la ruta, si existe el riesgo de llegar tarde o de que caduque el estacionamiento, tambi√©n debe aparecer la advertencia correspondiente.  Adem√°s: cuando cierra y abre la aplicaci√≥n, debe restaurar todo esto correctamente.  Y finalmente, lo aterrador: toda la funcionalidad deber√≠a poder funcionar en segundo plano, porque la aplicaci√≥n pasar√° la mayor parte de su vida en segundo plano.  Tales cosas <br><br>  No describir√© la implementaci√≥n en detalle, solo puedo decir que el trabajo de aleteo con los estados es muy valioso.  Donde en un androide puro resultar√≠a un dise√±o orientado a objetos sobrecargado, result√≥ simple y elegante.  Estados comprensibles normales, uni√≥n sensata de vistas a modelos, en tareas como esta, el aleteo brilla.  Sin embargo, no fue sin jambas t√≠picas: por ejemplo, la biblioteca local de trabajar con mapas no tiene una transici√≥n animada a nuevas coordenadas.  Ten√≠a que entrar en su c√≥digo, sacar algunos m√©todos privados y agregar mi muleta.  Es posible que esta funcionalidad se agregue pronto, pero este es todo el aleteo: con todo su atractivo, prep√°rese para tales descubrimientos. <br><br>  Todo lo dem√°s parec√≠a funcionar sin problemas.  En realidad, no hab√≠a mucho m√°s: un par de di√°logos y una p√°gina de introducci√≥n para la cual mi novia (ella era una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">artista</a> ) dibuj√≥ buenas animaciones.  Finalmente, traduje toda la aplicaci√≥n al ruso, incluido el mapa.  Pero entonces comenz√≥ el dolor: notificaciones. <br><br><h3>  Notificaciones </h3><br>  Para m√≠, la capacidad de enviar notificaciones inteligentes fue clave para la aplicaci√≥n; sin ella, no hay nada de qu√© preocuparse.  Sin embargo, cuando comenc√© a trabajar en esta funci√≥n, me di cuenta de que hab√≠a pisado mi propio pie.  En realidad hubo dos problemas.  El primero es flutter, que no sabe c√≥mo trabajar con dispositivos api de bajo nivel listos para usar: debe escribir una junta en forma de complemento que contenga dos c√≥digos nativos y una abstracci√≥n en el dardo.  El segundo problema es mi posici√≥n fundamental de que todo debe llevarse a cabo a bordo.  Entonces, resumimos lo que se necesita.  Es necesario que la aplicaci√≥n <b>en segundo plano</b> : <br><br><ol><li>  Controlando constantemente su geolocalizaci√≥n, </li><li>  Comprobado cu√°ntos minutos a pie hasta el estacionamiento </li><li>  Comprobado con temporizador que expira </li><li>  Si existe el riesgo de no tener tiempo para regresar, una inyecci√≥n de notificaci√≥n </li></ol><br>  Siente la magnitud de la tragedia?  Est√° claro que no hay capacidad t√©cnica para hacer esto si la aplicaci√≥n se cierra por completo.  Pero supongamos que simplemente se minimiza y la pantalla est√° apagada.  AQU√ç api me da la ruta y la estimaci√≥n del tiempo de caminata, ¬øsignifica esto que la aplicaci√≥n enviar√° solicitudes de spam en segundo plano?  ¬øCu√°nto c√≥digo se ejecutar√° en absoluto?  ¬øC√≥mo estamos con la memoria y el consumo de energ√≠a? <br><br>  Me sent√© a pensar.  Comenz√≥ con uno peque√±o: t√©cnicamente, flutter recientemente ha tenido la capacidad de ejecutar c√≥digo en segundo plano, se llama aislar.  Si todo est√° escrito correctamente, entonces puede construir la l√≥gica de una manera espec√≠fica para que no todo se ejecute en segundo plano, sino algunas funcionalidades espec√≠ficas.  De hecho, en modo minimizado, no necesitamos dibujar interfaces o actualizar estados: estamos interesados ‚Äã‚Äãen la l√≥gica simple de calcular el tiempo, y esta l√≥gica es bastante compacta y barata.  Al mismo tiempo, no deber√≠a ser provocado por un cambio en la geolocalizaci√≥n, como lo hice en la versi√≥n original, sino por alg√∫n temporizador interno.  Porque la notificaci√≥n deber√≠a volar, incluso si no te mueves, pero si√©ntate quieto. <br><br>  Bueno, escribimos un c√≥digo liviano que puede ejecutarse en segundo plano y es controlado por un temporizador.  ¬øC√≥mo podemos activarlo dentro del marco de aplicaciones nativas y transmitir datos de geolocalizaci√≥n all√≠?  Result√≥ diferente. <br><br>  La l√≥gica de Android y iPhone en materia de ejecuci√≥n de c√≥digo en segundo plano es radicalmente diferente.  Para un iPhone, est√° ausente como tal: el c√≥digo de fondo solo puede desencadenar un evento del sistema de cierto tipo, por ejemplo, reproducir audio en streaming o, afortunadamente para m√≠, actualizar la ubicaci√≥n.  Para hacer esto, solo solicite permisos y en la parte nativa del complemento Flater suscr√≠base al evento.  Desde all√≠, a trav√©s de un canal de comunicaci√≥n espec√≠fico (MethodChannel), llamamos a la devoluci√≥n de llamada en un dardo, le pasamos los geodatos y comenzamos el fondo con la l√≥gica que necesitamos.  Belleza <br><br>  Android funciona de manera diferente.  T√©cnicamente, tiene la capacidad de ejecutar c√≥digo en segundo plano sin estar atado a eventos del sistema; para esto, debe describir el servicio.  Se cuelga por separado de la aplicaci√≥n, ya sea completamente en segundo plano o en el fondo (all√≠ se hace sentir por un mensaje adjunto en la persiana).  Parece que el problema se ha resuelto: en la parte nativa del complemento, describimos un servicio en segundo plano que rastrea la ubicaci√≥n y extrae el c√≥digo Darth.  Sin embargo, hay un matiz.  Desde la versi√≥n 8.0 de Android, la actitud hacia tales servicios ha cambiado: ahora, si la aplicaci√≥n se minimiza en este momento, sus servicios en segundo plano se cortan infernalmente por el eje para ahorrar energ√≠a.  Y, si su c√≥digo realiza, por ejemplo, una copia de seguridad de datos, entonces, en principio, no le importa en qu√© momento exacto el eje lo dejar√° funcionar; lo principal es que funciona.  Pero en mi caso, necesitamos rastrear el cambio de ubicaci√≥n casi en tiempo real, y el momento es cr√≠tico aqu√≠.  Por lo tanto, la √∫nica forma de salir es comenzar el servicio de antemano.  Describimos una peque√±a notificaci√≥n adjunta en la cortina, nos suscribimos a la ubicaci√≥n, la enviamos al dardo a trav√©s del MethodChannel.  Todo parece funcionar. <br><br>  Por cierto, volviendo a los problemas de memoria, consumo de energ√≠a y cantidad de solicitudes: el c√≥digo se ejecuta cuando la ubicaci√≥n se desplaza a 50 metros o por temporizador.  Adem√°s, √©l mismo es muy ligero, y las solicitudes no pasan por m√≠, sino que van directamente a la API AQU√ç.  Yo mismo no recibo ning√∫n dato y no lo guardo en ning√∫n lado.  En general, esta implementaci√≥n se describe muy bien <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> , este es el blog de uno de los ingenieros de flutter: el c√≥digo tambi√©n se adjunta all√≠.  Su ejemplo es algo diferente, pero el enfoque general es claro, por lo que recomiendo leerlo. <br><br><h3>  Resultado </h3><br>  Eso, de hecho, es todo.  Durante un mes de tiempo libre, obtuve una aplicaci√≥n que resuelve perfectamente un problema espec√≠fico.  Espero que este art√≠culo sea interesante para alguien y que la aplicaci√≥n lo salve de multas y estr√©s.  Puedes mirar y rega√±ar aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Android</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">iOS</a> . <br><br>  Gracias a todos por su atenci√≥n. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/464451/">https://habr.com/ru/post/464451/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../464435/index.html">C√≥mo no ahogarse en un mar de tecnolog√≠a y enfoques: la experiencia de 50 expertos</a></li>
<li><a href="../464437/index.html">C√≥mo el equipo de desarrollo puede ganar m√°s creando sitios de tr√°fico [Gu√≠a de implementaci√≥n]</a></li>
<li><a href="../464443/index.html">Natas Web. Paso de la plataforma CTF destinada a explotar vulnerabilidades web. Parte 2</a></li>
<li><a href="../464445/index.html">¬øPor qu√© es realmente imposible ser vegetariano?</a></li>
<li><a href="../464447/index.html">Cuente Scoring de la Fer o un estudio sobre calificaci√≥n crediticia como parte de la ampliaci√≥n de los horizontes. Parte 1</a></li>
<li><a href="../464453/index.html">Huskies: eliminar, dejar, reemplazar? Que?</a></li>
<li><a href="../464457/index.html">22 sitios para que un programador te ayude a hablar ingl√©s</a></li>
<li><a href="../464459/index.html">Cuatro reglas de UX intuitivo</a></li>
<li><a href="../464463/index.html">iOS Responder Chain o lo que preguntan en la entrevista</a></li>
<li><a href="../464465/index.html">¬øC√≥mo y por qu√© migramos Preply a Kubernetes?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>