<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍❤️‍👨 🌙 👩🏼‍🔧 Mobiler Wächter auf Raspberry pi (h.264) 👨🏼‍💻 🥛 🙅🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die Themen der Verwendung von Raspberry pi zur FPV-Steuerung und Überwachung der Bewegung in einem Frame entlang von H.264-Vektoren sind nicht neu. Di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mobiler Wächter auf Raspberry pi (h.264)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424191/">  Die Themen der Verwendung von Raspberry pi zur FPV-Steuerung und Überwachung der Bewegung in einem Frame entlang von H.264-Vektoren sind nicht neu.  Die Entwicklung gibt nicht vor, originell zu sein, und es wurde relativ wenig Zeit dafür aufgewendet (ab Juli manchmal an Wochenenden). <br><br>  Aber vielleicht ist meine Erfahrung (und die Quelle) für jeden nützlich. <br><br>  Die Idee, dass Sie eine Videoüberwachung in der Wohnung durchführen müssen, entstand, nachdem ein Nachbar sagte, dass jemand in das Türschloss eintauchte. <br><br>  Das erste, was ausgepeitscht wurde, war die Installation des berühmten Bewegungsprogramms auf dem Raspberry Pi Zero mit einer Kamera v1.3.  Im Prinzip löst es das Problem.  Wenn Sie mit der Benachrichtigung per Mail und fps = 4-5 zufrieden sind. <br><br>  Das schien aber nicht interessant zu sein.  Zur Hand war eine Plattform mit Rädern und Gurtzeug aus alten Experimenten und 18650 Batterien aus alten Laptops. <br><br>  Das Ergebnis ist eine unterhaltsame Mischung aus mobiler Videoüberwachung und Bewegungserkennung. <br>  Da ich einen gemieteten VPS habe, gab es keine Probleme beim Zugriff von außen (Heimnetzwerk hinter NAT).  Die Akkulaufzeit beträgt ca. 4 Tage, wenn Sie die Fahrt und den Scheinwerfer nicht missbrauchen. <br><br>  Sie können durch die Wohnung fahren, die Kamera und die Plattform fernsteuern und sie an jedem gewünschten Ort im Bewegungserkennungsmodus belassen. <br><br><img src="https://habrastorage.org/webt/fm/bz/hr/fmbzhriyrbtmqotgwhvk28uexlm.jpeg"><br><br><a name="habracut"></a><h1>  Hardware </h1><br>  Die gesamte Hardware kann in zwei Teile unterteilt werden, von denen der erste nicht vom zweiten abhängt und separat verwendet werden kann: <br><br><h4>  Videoüberwachungsmodul </h4><br><ul><li>  Himbeer pi Null </li><li>  USB WiFi Dongle </li><li>  Himbeer-Pi-Kamera v1.3 </li><li>  2x Schrittmotoren 28BYJ-48 + ULN2003 Treiber </li></ul><br><h4>  Mobile Plattform über SPI aus Himbeeren verwaltet </h4><br><ul><li>  4S 16x18650 Li-Ion + 4S 30A Li-Ion 18650 (BMS) Karte + DC-DC-Aufladung mit Strom- und Spannungsstabilisierung </li><li>  DC / DC-Abwärtswandler (15 V -&gt; 5 V). </li><li>  stm32f103c8t6 Karte </li><li>  4x Getriebemotoren + L298N Platine </li><li>  12V LED Lampe (Scheinwerfer) + Steuerung am IRF3205 (+ smd pnp und npn) </li></ul><br>  Das Raspbian-Image wurde im schreibgeschützten Modus konfiguriert.  In einer solchen Konfiguration überleben Himbeeren leicht unerwartete Abschaltungen, da sie überhaupt keine SD-Karten für die Aufnahme verwenden. <br><br><h1>  Software </h1><br>  Die Software besteht aus 3 separaten Komponenten. <br><h4>  Android App (getestet auf LG6 Oreo und altem Samsung S5 Lollipop) </h4><br>  <b>FPV-Modus</b> <br><br><ul><li>  Zeigen Sie den H.264-Videostream von der Kamera in der angegebenen Auflösung und Bitrate an </li><li>  Kamera- und Plattformsteuerung </li><li>  Nehmen Sie Videos und Fotos aus dem Stream auf. </li></ul><br>  <b>Android-Servicemodus</b> <br><br><ul><li>  Host-Umfrage (mit angegebener Häufigkeit) </li><li>  Laden eines Ereignisfotos von „Bewegung“ in den Rahmen nach Ereignis. </li></ul><br><h4>  Himbeer-Pi-Host auf Python (Picamera + Spidev + RPi.GPIO) </h4><br>  <b>FPV-Modus</b> <br><br><ul><li>  Broadcast H.264-Stream (mit den von der Android-Anwendung angegebenen Parametern) </li><li>  Empfang von Steuerbefehlen für Schrittmotoren und deren Verwaltung. </li><li>  Broadcast-Steuerbefehle über SPI (wenn der Modus aktiviert ist) </li></ul><br>  <b>Tracking-Modus Bewegung im Frame.</b> <br><br><ul><li>  Bewegungserkennung im Frame (gemäß den von der Android-Anwendung angegebenen Parametern) </li><li>  Empfang von Anfragen "und ob sich im Rahmen etwas bewegt" und Hochladen von Fotos auf Anfrage </li><li>  Senden von Fotos im Rahmen (unabhängig von der Anwendung) an den Host. </li></ul><br>  <b>Die einfachste Firmware auf stm32f103</b> <br><br><ul><li>  SPI-Befehle empfangen </li><li>  Steuern Sie die Drehrichtung der Räder und PWM-Motoren. </li><li>  Scheinwerfersteuerung. </li></ul><br><h1>  Bewegungsverfolgung </h1><br>  Das Verfolgen der h.264-Vektoren erwies sich als sehr launisch und anfällig für falsch positive Ergebnisse.  Es gibt nur sehr wenige Bewegungserkennungsimplementierungen für H.264 im Netzwerk.  Ich habe sie alle ausprobiert. <br><br>  Die primitivste Option besteht darin, die Anzahl der Vektoren zu zählen, deren Länge einen bestimmten Schwellenwert überschreitet.  Und wenn Vektoren größer als der Schwellenwert sind, ist dies ein Signal dafür, dass sich im Rahmen eine Bewegung befindet. <br><br>  Leider.  Diese Option ist nur zur Demonstration des Prinzips geeignet.  Es gibt zu viele Fehlalarme.  Besonders auf Oberflächen mit einheitlicher Farbe und Textur. <br><br>  Alle anderen Optionen ergeben entweder zu viele Fehlalarme oder erfüllen einfach nicht das Leistungskriterium: „sollten innerhalb der Frame-Zeit verarbeitet werden“. <br><br>  Infolgedessen habe ich meine Option gewählt.  Obwohl es praktisch keine Fehlalarme gibt, erfordert es eine Bewegung in mehreren Frames hintereinander.  Dies ist jedoch besser als mehrmals täglich Fehlalarme aufgrund von Beleuchtungsänderungen oder allgemein aufgrund unverständlicher „Bewegungen“ im Rahmen durch die „Entscheidung“ der Kamera.  Das Thema zuverlässige Erkennungsalgorithmen für MV H.264 ist im Allgemeinen ein separates und komplexes Thema.  Algorithmen benötigen viel Zeit für das praktische Debuggen und ich habe strenge Laufzeitbeschränkungen. <br><br>  Beispiel für Bewegungsvektoren (Snapshot-Dienstprogrammmodi): <br><br><img src="https://habrastorage.org/webt/ga/14/gv/ga14gvgp-rljxqu7-0cdrrhdvvw.jpeg"><br><br><img src="https://habrastorage.org/webt/ya/yz/sv/yayzsvkjptyuqafxeg3aevdyfhq.jpeg"><br><br>  Bei den Ereignissen „Bewegung im Rahmen“ werden Benachrichtigungen generiert. <br><br><img src="https://habrastorage.org/webt/7w/of/kf/7wofkfeel3yhp6k-vt4m7sw51pg.jpeg"><br><br>  Für meine Zwecke stellte sich heraus, dass es im Prinzip garantiert ist, dass es ausgelöst wird, wenn sich eine menschliche Figur (&gt; 15% des Rahmens) mindestens 2 Sekunden lang bewegt.  Bei einer solchen Vergröberung der Empfindlichkeit habe ich einfach überhaupt keine falsch positiven Ergebnisse gesehen. <br><br><h3>  Bewegungssteuerung. </h3><br>  Plattformmanagement "per Traktor".  Das heißt,  PWM-Steuerung und Drehrichtung der linken und rechten Seite.  Bedienelemente (Streifen) unter den Daumen beider Hände.  Es stellte sich als das Natürlichste für mich heraus. <br><br><img src="https://habrastorage.org/webt/bk/qk/fn/bkqkfn7r2qda8cgikzkcw7a8vae.jpeg"><br><br>  Kamerasteuerung - zwei Streifen, die sich berühren, geben den Befehl, einen bestimmten Winkel zu drehen (je weiter von der Mitte des Streifens entfernt - desto größer der Winkel).  Die kontinuierliche Steuerung der Motoren war unangenehm (wieder subjektiv für mich). <br><br><img src="https://habrastorage.org/webt/_g/jw/bs/_gjwbsyivgtnnknnbohpoexfgqs.jpeg"><br><br><h3>  Verzögerungen FPV </h3><br>  Videoverzögerungen waren relativ klein (&lt;1 Sek.). <br><br>  Die Steuerung einer Plattform mit Rädern mit einer Höchstgeschwindigkeit von 3-4 km / h für eine 100% ige PWM-Verzögerung in 0,6 Sekunden ist ganz normal und wird fast nicht bemerkt. <br><br>  Es scheint mir jedoch, dass sogar 0,3 Sekunden Verzögerung zum Beispiel für einen Quadrocopter viel sind. <br><br>  Tests haben gezeigt, dass die Implementierung der Übersetzung in Python die Verzögerung um 50-70 ms verzögert, verglichen mit der Ausgabe desselben H.264-Streams über Rapivid.  Für mich sind diese 70ms nicht wichtig.  Aber wenn jemand das Maximum herausholen will, muss er dies berücksichtigen. <br><br>  Bei der Arbeit über "lokales WLAN" (das Telefon als Zugangspunkt) beträgt die Verzögerung 350..600 ms.  Aber nicht mehr als 0,6 Sekunden und stabil in diesem Bereich.  Obwohl 50-70 Meter in offenen Bereichen - dies ist nur zum Herumspielen.  In größerer Entfernung funktioniert WLAN vom Telefon nicht. <br>  Es ist erwähnenswert, dass dies in einer sehr "RF-lauten" Umgebung von Wohngebäuden mit vielen WiFi-Netzwerken in der Umgebung ist. <br><br><img src="https://habrastorage.org/webt/zw/bx/-y/zwbx-yzkmwqb0r8p2flbur5u__o.jpeg"><br><br>  Ich war überrascht über das Ergebnis in der Konfiguration „WLAN-Router -&gt; Twisted Pair-Anbieter -&gt; VPS -&gt; MTC 4G am Telefon“ über die Weiterleitung des SSH-Ports von Himbeeren an VPS. <br>  Eine typische Verzögerung erwies sich sogar als etwas besser als über lokales WLAN (!) <br>  Selbst unterwegs im Auto oder in der Nähe eines großen Lag-Hypermarktes sind es nur 300ms. <br><br>  Manchmal (ziemlich selten und unvorhersehbar) betrug die Verzögerung jedoch bis zu mehreren Sekunden.  Rekontext hilft.  Wahrscheinlich sind dies einige Merkmale von 4G / MTS / Anbietern in der Kette usw. <br><br><img src="https://habrastorage.org/webt/qm/bb/2v/qmbb2vsylq_qlv66rlpfz2x_d2e.jpeg"><br><br>  Nachdem alles funktioniert hatte, bestand der Wunsch, den Tonkanal in beide Richtungen anzuschließen.  Technisch ist dies möglich und nicht einmal sehr schwierig.  Aber ich habe keine Lust, mit einem Lötkolben herumzuspielen. <br><br>  Ohne das "zusätzliche" Rasberry Pi wäre es einfacher, das alte Telefon als Host für die Videoüberwachung und das Plattformmanagement zu verwenden.  Der einzige Vorteil von Himbeeren gegenüber einem alten Telefon ist das geringere Gewicht.  Und vielleicht weniger Stromverbrauch (nicht vergleichbar). <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><b>Alle Quellen</b></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de424191/">https://habr.com/ru/post/de424191/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de424177/index.html">Anschließen des Grandstream GXW4104 FXO Gateway an 3CX</a></li>
<li><a href="../de424183/index.html">4. Oktober, Moskau - Backend Stories 2.0</a></li>
<li><a href="../de424185/index.html">Die Verdauung von frischen Materialien aus der Welt des Frontends für die letzte Woche Nr. 331 (17. - 23. September 2018)</a></li>
<li><a href="../de424187/index.html">DEFCON-Konferenz 22. Adrian Crenshaw. Was können Benutzer von TOR "brennen"?</a></li>
<li><a href="../de424189/index.html">Smart Home? Oder nicht schlau ???</a></li>
<li><a href="../de424193/index.html">Internationaler Kongress für Astronautik - wie in Australien</a></li>
<li><a href="../de424197/index.html">Im Ofen von MVPs implementieren wir MVPr (Minimum Viable Prototype)</a></li>
<li><a href="../de424199/index.html">Erstellen eines einfachen GraphQL-API-Servers auf Express und NodeJS</a></li>
<li><a href="../de424201/index.html">Wie maschinelles Lernen mir geholfen hat, einige Aspekte der frühkindlichen Entwicklung zu verstehen</a></li>
<li><a href="../de424203/index.html">Prozedurale Gebäudeerstellung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>