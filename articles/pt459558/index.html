<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦗 😙 👩🏼‍🏫 Como começar a usar o Modo de Usuário no Linux 👏🏻 💸 🛬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introdução do tradutor: No contexto da entrada maciça em nossas vidas de vários tipos de contêineres, pode ser bastante interessante e útil descobrir ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como começar a usar o Modo de Usuário no Linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/459558/">  <i>Introdução do tradutor: No contexto da entrada maciça em nossas vidas de vários tipos de contêineres, pode ser bastante interessante e útil descobrir com quais tecnologias tudo começou uma vez.</i>  <i>Alguns deles ainda podem ser usados ​​até hoje, mas nem todos se lembram de tais métodos (ou sabem se eles não foram encontrados durante seu rápido desenvolvimento).</i>  <i>Uma dessas tecnologias é o Linux no modo de usuário.</i>  <i>O autor do original vasculhou, descobrindo o que os desenvolvimentos antigos ainda funcionavam e o que não era muito, e coletou algo como uma instrução passo a passo sobre como iniciar a UML doméstica em 2k19 para mim.</i>  <i>E sim, convidamos o autor do post original do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Cadey</a> para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Habr</a> . Portanto, se você tiver alguma dúvida, pergunte em inglês nos comentários.</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/480/b5e/ecc/480b5eeccd71ac8e098a9e7b3b8bedb6.jpg" alt="imagem"><br><br>  O Modo de Usuário Linux é, de fato, a própria porta do kernel Linux.  Esse modo permite executar um kernel Linux completo como um processo do usuário e geralmente é usado pelos desenvolvedores para testar drivers.  Mas esse modo também é útil como uma ferramenta para isolamento geral, cujo princípio é semelhante à operação de máquinas virtuais.  Esse modo fornece mais isolamento que o Docker, mas menos que uma máquina virtual completa, como KVM ou Virtual Box. <br><a name="habracut"></a><br>  Em geral, o Modo do Usuário pode parecer estranho e difícil de usar, mas ainda possui suas próprias áreas de aplicação.  Afinal, este é um kernel Linux completo, trabalhando com um usuário sem privilégios.  Esse recurso permite que você execute código potencialmente não confiável sem ameaças à máquina host.  E como é um kernel completo, seus processos são isolados da máquina host, ou seja, os <b>processos em execução no Modo Usuário não serão visíveis para o host</b> .  Isso não é como o contêiner Docker usual, nesse caso a máquina host sempre vê os processos dentro do repositório.  Dê uma olhada neste pedaço de pstree de um dos meus servidores: <br><br><pre><code class="xml hljs">containerd─┬─containerd-shim─┬─tini─┬─dnsd───19*[{dnsd}] │ │ └─s6-svscan───s6-supervise │ └─10*[{containerd-shim}] ├─containerd-shim─┬─tini─┬─aerial───21*[{aerial}] │ │ └─s6-svscan───s6-supervise │ └─10*[{containerd-shim}] ├─containerd-shim─┬─tini─┬─s6-svscan───s6-supervise │ │ └─surl │ └─9*[{containerd-shim}] ├─containerd-shim─┬─tini─┬─h───13*[{h}] │ │ └─s6-svscan───s6-supervise │ └─10*[{containerd-shim}] ├─containerd-shim─┬─goproxy───14*[{goproxy}] │ └─9*[{containerd-shim}] └─32*[{containerd}]</code> </pre> <br>  E compare isso com o kernel do pstree Linux no Modo de Usuário: <br><br><pre> <code class="xml hljs">linux─┬─5*[linux] └─slirp</code> </pre> <br>  Ao trabalhar com contêineres do Docker, posso ver os nomes dos processos em execução no sistema convidado a partir do host.  Com o Modo de Usuário Linux, isso não é possível.  O que isso significa?  Isso significa que as ferramentas de monitoramento que funcionam através do subsistema de auditoria do Linux <b>não veem</b> processos em execução no sistema convidado.  Mas em algumas situações, esse recurso pode se tornar uma faca de dois gumes. <br><br>  Em geral, todo o post abaixo é um conjunto de estudos e tentativas grosseiras de alcançar o resultado desejado.  Para fazer isso, tive que usar várias ferramentas antigas, ler as fontes do kernel, depurar intensamente o código escrito enquanto eu ainda estava no ensino fundamental e também escolher as assembléias do Heroku usando um binário especial em busca das ferramentas necessárias.  Todo esse trabalho levou os caras do meu IRC a me chamarem de mágica.  Espero que este post sirva como alguém documentação confiável para pôr tudo em ordem, mas com os kernels e versões mais recentes do sistema operacional. <br><br><h3>  Personalização </h3><br>  A configuração do Modo de Usuário Linux leva várias etapas: <br><br><ul><li>  instalar dependências no host; </li><li>  Fazendo Download do Kernel Linux </li><li>  configuração de montagem do kernel; </li><li>  montagem de kernel; </li><li>  instalação binária; </li><li>  configurando o sistema de arquivos convidado; </li><li>  seleção de parâmetros de inicialização do kernel; </li><li>  configuração de rede de convidados; </li><li>  iniciando o kernel convidado. </li></ul><br>  Presumo que, se você decidir aumentar tudo, provavelmente fará tudo o que está descrito em algum sistema semelhante ao Ubuntu ou Debian.  Tentei implementar todas as opções acima na minha distribuição favorita - Alpine, mas nada aconteceu, aparentemente porque o kernel do Linux tinha uma forte ligação no glibc-isms para drivers no Modo Usuário.  Eu pretendo relatar isso ao montante depois que eu finalmente descobrir o problema. <br><br><h3>  Instale dependências no host </h3><br>  O Ubuntu requer pelo menos os seguintes pacotes para construir o kernel do Linux (desde que seja uma instalação limpa): <br><br> <code>- 'build-essential' <br> - 'flex' <br> - 'bison' <br> - 'xz-utils' <br> - 'wget' <br> - 'ca-certificates' <br> - 'bc' <br> - 'linux-headers'</code> <br> <br>  Você pode instalá-los usando o seguinte comando (com privilégios de root ou usando o sudo): <br><br><pre> <code class="xml hljs">apt-get -y install build-essential flex bison xz-utils wget ca-certificates bc \ linux-headers-$(uname -r)</code> </pre> <br>  Observe que a execução do programa de configuração de menu para o kernel do Linux exigirá a instalação do <code>libncurses-dev</code> .  Verifique se ele está instalado usando o seguinte comando (com privilégios de root ou com sudo): <br><br><pre> <code class="xml hljs">apt-get -y install libncurses-dev</code> </pre> <br><h3>  Download do kernel </h3><br>  Determine onde carregar e, em seguida, construa o kernel.  Para esta operação, você precisará alocar cerca de 1,3 GB de espaço no disco rígido, portanto, verifique se possui um. <br><br>  Então vá para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">kernel.org</a> e obtenha o URL para baixar a última versão estável do kernel.  No momento da redação deste post: <a href="">https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.1.16.tar.xz</a> <br><br>  Faça o download deste arquivo usando <code>'wget'</code> : <br><br><pre> <code class="xml hljs">wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.1.16.tar.xz</code> </pre> <br>  E extraia-o com <code>'tar'</code> : <br><br><pre> <code class="xml hljs">tar xJf linux-5.1.16.tar.xz</code> </pre> <br>  Agora entramos no diretório criado ao descompactar o tarball: <br><br><pre> <code class="xml hljs">cd linux-5.1.16</code> </pre> <br><h3>  Configuração de compilação do kernel </h3><br>  O sistema de compilação do kernel é uma coleção de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Makefiles</a> com <b>muitas</b> ferramentas e scripts personalizados para automatizar o processo.  Para começar, abra o programa de instalação online: <br><br><pre> <code class="xml hljs">make ARCH=um menuconfig</code> </pre> <br>  Ele completará parcialmente a montagem e exibirá uma caixa de diálogo para você.  Quando ' <code>[Select]</code> ' for exibido na parte inferior da janela, você poderá fazer a configuração usando as teclas Espaço ou Enter.  Navegação na janela, como sempre, com as setas para cima e para baixo do teclado e a seleção de elementos - “esquerda” ou “direita”. <br><br>  Um ponteiro de visualização ---&gt; significa que você está em um submenu acessado pela tecla Enter.  A saída é obviamente através de ' <code>[Exit]</code> '. <br><br>  Inclua os seguintes parâmetros em ' <code>[Select]</code> ' e verifique se há um símbolo '[*]' próximo a eles: <br><br><pre> <code class="xml hljs">UML-specific Options: - Host filesystem Networking support (enable this to get the submenu to show up): - Networking options: - TCP/IP Networking UML Network devices: - Virtual network device - SLiRP transport</code> </pre> <br>  Tudo a partir desta janela pode ser encerrado selecionando sequencialmente ' <code>[Exit]</code> '.  Apenas certifique-se de que, no final, você seja solicitado a salvar a configuração e selecione ' <code>[Yes]</code> '. <br><br>  Eu recomendo que você brinque com as opções de compilação do kernel depois de ler este post.  Graças a esses experimentos, você pode aprender muito em termos de compreensão do trabalho da mecânica de núcleo de baixo nível e da influência de vários sinalizadores em sua montagem. <br><br><h3>  Montagem do Kernel </h3><br>  O kernel do Linux é um ótimo programa que faz muitas coisas.  Mesmo com uma configuração mínima em equipamentos antigos, pode demorar um pouco para montá-lo.  Portanto, construa o kernel com o seguinte comando: <br><br><pre> <code class="xml hljs">make ARCH=um -j$(nproc)</code> </pre> <br>  Porque  Este comando instruirá nosso montador a usar todos os núcleos e threads de processador disponíveis durante o processo de compilação.  O <code>$(nproc)</code> no final do Build substitui a saída do <code>nproc</code> , que faz parte dos <code>coreutils</code> na compilação padrão do Ubuntu. <br><br>  Depois de algum tempo, nosso kernel será compilado em um arquivo executável <code>./linux</code> . <br><br><h3>  Instalação binária </h3><br>  Como o Modo de Usuário no Linux cria um binário regular, você pode instalá-lo como qualquer outro utilitário.  Aqui está como eu fiz isso: <br><br><pre> <code class="xml hljs">mkdir -p ~/bin cp linux ~/bin/linux</code> </pre> <br>  Também vale a pena verificar se <code>~/bin</code> está no seu <code>$PATH</code> : <br><br><pre> <code class="xml hljs">export PATH=$PATH:$HOME/bin</code> </pre> <br><h3>  Configurando o Sistema de Arquivos Convidado </h3><br>  Crie um diretório para o sistema de arquivos convidado: <br><br><pre> <code class="xml hljs">mkdir -p $HOME/prefix/uml-demo cd $HOME/prefix</code> </pre><br>  Abra o alpinelinux.org e, na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">seção de downloads,</a> encontre o link atual para baixar o <code>MINI ROOT FILESYSTEM</code> .  No momento da redação deste texto, era: <br><br><pre> <code class="xml hljs">http://dl-cdn.alpinelinux.org/alpine/v3.10/releases/x86_64/alpine-minirootfs-3.10.0-x86_64.tar.gz</code> </pre> <br>  Faça o download deste tarball usando o wget: <br><br><pre> <code class="xml hljs">wget -O alpine-rootfs.tgz http://dl-cdn.alpinelinux.org/alpine/v3.10/releases/x86_64/alpine-minirootfs-3.10.0-x86_64.tar.gz</code> </pre> <br>  Agora digite o diretório do sistema de arquivos convidado e descompacte o arquivo morto: <br><br><pre> <code class="xml hljs">cd uml-demo tar xf ../alpine-rootfs.tgz</code> </pre> <br>  As etapas descritas criarão um pequeno modelo de sistema de arquivos.  Devido à natureza do sistema, a instalação de pacotes através do gerenciador de aplicativos Alpine será extremamente difícil.  Mas esse FS será suficiente para avaliar a ideia geral. <br><br>  Também precisamos da ferramenta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tini</a> para suprimir o consumo de memória pelos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">processos zumbis de</a> nosso núcleo convidado. <br><br><pre> <code class="xml hljs">wget -O tini https://github.com/krallin/tini/releases/download/v0.18.0/tini-static chmod +x tini</code> </pre> <br><h3>  Criando uma linha de comando do kernel </h3><br>  O kernel do Linux, como a maioria dos outros programas, possui argumentos de linha de comando que podem ser acessados ​​especificando a opção <code>--help</code> . <br><br><div class="spoiler">  <b class="spoiler_title">Sam --help</b> <div class="spoiler_text"><pre> <code class="xml hljs">linux --help User Mode Linux v5.1.16 available at http://user-mode-linux.sourceforge.net/ --showconfig Prints the config file that this UML binary was generated from. iomem=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>,<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">file</span></span></span><span class="hljs-tag">&gt;</span></span> Configure <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">file</span></span></span><span class="hljs-tag">&gt;</span></span> as an IO memory region named <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>. mem=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Amount</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">desired</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ram</span></span></span><span class="hljs-tag">&gt;</span></span> This controls how much "physical" memory the kernel allocates for the system. The size is specified as a number followed by one of 'k', 'K', 'm', 'M', which have the obvious meanings. This is not related to the amount of memory in the host. It can be more, and the excess, if it's ever used, will just be swapped out. Example: mem=64M --help Prints this message. debug this flag is not needed to run gdb on UML in skas mode root=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">file</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">containing</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">root</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fs</span></span></span><span class="hljs-tag">&gt;</span></span> This is actually used by the generic kernel in exactly the same way as in any other kernel. If you configure a number of block devices and want to boot off something other than ubd0, you would use something like: root=/dev/ubd5 --version Prints the version number of the kernel. umid=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> This is used to assign a unique identity to this UML machine and is used for naming the pid file and management console socket. con[0-9]*=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">description</span></span></span><span class="hljs-tag">&gt;</span></span> Attach a console or serial line to a host channel. See http://user-mode-linux.sourceforge.net/old/input.html for a complete description of this switch. eth[0-9]+=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transport</span></span></span><span class="hljs-tag">&gt;</span></span>,<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">options</span></span></span><span class="hljs-tag">&gt;</span></span> Configure a network device. aio=2.4 This is used to force UML to use 2.4-style AIO even when 2.6 AIO is available. 2.4 AIO is a single thread that handles one request at a time, synchronously. 2.6 AIO is a thread which uses the 2.6 AIO interface to handle an arbitrary number of pending requests. 2.6 AIO is not available in tt mode, on 2.4 hosts, or when UML is built with /usr/include/linux/aio_abi.h not available. Many distributions don't include aio_abi.h, so you will need to copy it from a kernel tree to your /usr/include/linux in order to build an AIO-capable UML nosysemu Turns off syscall emulation patch for ptrace (SYSEMU). SYSEMU is a performance-patch introduced by Laurent Vivier. It changes behaviour of ptrace() and helps reduce host context switch rates. To make it work, you need a kernel patch for your host, too. See http://perso.wanadoo.fr/laurent.vivier/UML/ for further information. uml_dir=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">directory</span></span></span><span class="hljs-tag">&gt;</span></span> The location to place the pid and umid files. quiet Turns off information messages during boot. hostfs=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dir</span></span></span><span class="hljs-tag">&gt;</span></span>,<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">flags</span></span></span><span class="hljs-tag">&gt;</span></span>,... This is used to set hostfs parameters. The root directory argument is used to confine all hostfs mounts to within the specified directory tree on the host. If this isn't specified, then a user inside UML can mount anything on the host that's accessible to the user that's running it. The only flag currently supported is 'append', which specifies that all files opened by hostfs will be opened in append mode.</code> </pre> <br></div></div><br>  Este banner ilumina as principais opções de inicialização.  Vamos executar o kernel com o conjunto mínimo de opções necessário: <br><br><pre> <code class="xml hljs">linux \ root=/dev/root \ rootfstype=hostfs \ rootflags=$HOME/prefix/uml-demo \ rw \ mem=64M \ init=/bin/sh</code> </pre> <br>  As linhas acima informam ao nosso núcleo o seguinte: <br><br><ul><li>  Suponha que o sistema de arquivos raiz seja o pseudo-dispositivo <code>/dev/root</code> . </li><li>  Escolha <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">hostfs</a> como o driver do sistema de arquivos raiz. </li><li>  Monte o sistema de arquivos convidado que criamos no dispositivo raiz. </li><li>  E sim, no modo de leitura e gravação. </li><li>  Use apenas 64 megabytes de RAM (você pode usar muito menos, dependendo do que planeja fazer, mas 64 MB parece ser o tamanho ideal). </li><li>  O kernel inicia automaticamente <code>/bin/sh</code> como um processo <code>init</code> . </li></ul><br>  Execute este comando e você deverá obter algo como o seguinte: <br><br><div class="spoiler">  <b class="spoiler_title">Outra folha</b> <div class="spoiler_text"><pre> <code class="xml hljs">Core dump limits : soft - 0 hard - NONE Checking that ptrace can change system call numbers...OK Checking syscall emulation patch for ptrace...OK Checking advanced syscall emulation patch for ptrace...OK Checking environment variables for a tempdir...none found Checking if /dev/shm is on tmpfs...OK Checking PROT_EXEC mmap in /dev/shm...OK Adding 32137216 bytes to physical memory to account for exec-shield gap Linux version 5.1.16 (cadey@kahless) (gcc version 7.4.0 (Ubuntu 7.4.0-1ubuntu1~18.04.1)) #30 Sun Jul 7 18:57:19 UTC 2019 Built 1 zonelists, mobility grouping on. Total pages: 23898 Kernel command line: root=/dev/root rootflags=/home/cadey/dl/uml/alpine rootfstype=hostfs rw mem=64M init=/bin/sh Dentry cache hash table entries: 16384 (order: 5, 131072 bytes) Inode-cache hash table entries: 8192 (order: 4, 65536 bytes) Memory: 59584K/96920K available (2692K kernel code, 708K rwdata, 588K rodata, 104K init, 244K bss, 37336K reserved, 0K cma-reserved) SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=1, Nodes=1 NR_IRQS: 15 clocksource: timer: mask: 0xffffffffffffffff max_cycles: 0x1cd42e205, max_idle_ns: 881590404426 ns Calibrating delay loop... 7479.29 BogoMIPS (lpj=37396480) pid_max: default: 32768 minimum: 301 Mount-cache hash table entries: 512 (order: 0, 4096 bytes) Mountpoint-cache hash table entries: 512 (order: 0, 4096 bytes) Checking that host ptys support output SIGIO...Yes Checking that host ptys support SIGIO on close...No, enabling workaround devtmpfs: initialized random: get_random_bytes called from setup_net+0x48/0x1e0 with crng_init=0 Using 2.6 host AIO clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns futex hash table entries: 256 (order: 0, 6144 bytes) NET: Registered protocol family 16 clocksource: Switched to clocksource timer NET: Registered protocol family 2 tcp_listen_portaddr_hash hash table entries: 256 (order: 0, 4096 bytes) TCP established hash table entries: 1024 (order: 1, 8192 bytes) TCP bind hash table entries: 1024 (order: 1, 8192 bytes) TCP: Hash tables configured (established 1024 bind 1024) UDP hash table entries: 256 (order: 1, 8192 bytes) UDP-Lite hash table entries: 256 (order: 1, 8192 bytes) NET: Registered protocol family 1 console [stderr0] disabled mconsole (version 2) initialized on /home/cadey/.uml/tEwIjm/mconsole Checking host MADV_REMOVE support...OK workingset: timestamp_bits=62 max_order=14 bucket_order=0 Block layer SCSI generic (bsg) driver version 0.4 loaded (major 254) io scheduler noop registered (default) io scheduler bfq registered loop: module loaded NET: Registered protocol family 17 Initialized stdio console driver Using a channel type which is configured out of UML setup_one_line failed for device 1 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 2 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 3 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 4 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 5 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 6 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 7 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 8 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 9 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 10 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 11 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 12 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 13 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 14 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 15 : Configuration failed Console initialized on /dev/tty0 console [tty0] enabled console [mc-1] enabled Failed to initialize ubd device 0 :Couldn't determine size of device's file VFS: Mounted root (hostfs filesystem) on device 0:11. devtmpfs: mounted This architecture does not have kernel memory protection. Run /bin/sh as init process /bin/sh: can't access tty; job control turned off random: fast init done / #</code> </pre> <br></div></div><br>  Manipular o que foi dito acima nos dará um <b>sistema de convidados no mínimo</b> , sem coisas como <code>/proc</code> ou um nome de host atribuído.  Por exemplo, tente os seguintes comandos: <br><br> <code>- uname -av <br> - cat /proc/self/pid <br> - hostname</code> <br> <br>  Para sair do sistema convidado, digite <code>exit</code> ou pressione control-d.  Isso disparará no shell seguido pelo pânico do kernel: <br><br><pre> <code class="xml hljs">/ # exit Kernel panic - not syncing: Attempted to kill init! exitcode=0x00000000 fish: “./linux root=/dev/root rootflag…” terminated by signal SIGABRT (Abort)</code> </pre> <br>  Temos esse pânico no kernel porque o kernel Linux acredita que o processo de inicialização está sempre em execução.  Sem ele, o sistema não pode mais funcionar e é desligado.  Mas, como esse é um processo no modo de usuário, o resultado se envia para o <code>SIGABRT</code> , o que leva à saída. <br><br><h3>  Configuração de rede de convidado </h3><br>  E aqui em nós tudo começa a não seguir o plano.  A rede no Modo de Usuário Linux é onde todo o conceito de um "modo de usuário" limitado começa a desmoronar.  Afinal, geralmente no nível do sistema, a rede é limitada a modos de execução <b>privilegiados</b> por todos nós, razões claras. <br><br>  <i>Nota</i>  <i>trans .: mais sobre as diferentes opções para trabalhar com a rede na UML podem ser lidas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .</i> <br><br><h3>  Viajar para slirp </h3><br>  No entanto, existe uma ferramenta antiga e quase sem suporte chamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Slirp</a> , com a qual o Linux no Modo de Usuário pode interagir com a rede.  Funciona mais ou menos como uma pilha TCP / IP no nível do usuário e não requer nenhuma permissão do sistema para ser executada.  Esta ferramenta foi <b>lançada em 1995</b> e a atualização mais recente data de <b>2006</b> .  Slirp é muito antigo.  Por um tempo sem suporte e atualizações, os compiladores foram tão longe que agora essa ferramenta só pode ser descrita como uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"roteirização de código"</a> . <br><br>  Então, vamos rolar o Slirp dos repositórios do Ubuntu e tentar executá-lo: <br><br><pre> <code class="xml hljs">sudo apt-get install slirp /usr/bin/slirp Slirp v1.0.17 (BETA) Copyright (c) 1995,1996 Danny Gasparovski and others. All rights reserved. This program is copyrighted, free software. Please read the file COPYRIGHT that came with the Slirp package for the terms and conditions of the copyright. IP address of Slirp host: 127.0.0.1 IP address of your DNS(s): 1.1.1.1, 10.77.0.7 Your address is 10.0.2.15 (or anything else you want) Type five zeroes (0) to exit. [autodetect SLIP/CSLIP, MTU 1500, MRU 1500, 115200 baud] SLiRP Ready ... fish: “/usr/bin/slirp” terminated by signal SIGSEGV (Address boundary error)</code> </pre> <br>  Oh deuses.  Vamos instalar um depurador para Slirp e ver se conseguimos descobrir o que está acontecendo aqui: <br><br><pre> <code class="xml hljs">sudo apt-get install gdb slirp-dbgsym gdb /usr/bin/slirp GNU gdb (Ubuntu 8.1-0ubuntu3) 8.1.0.20180409-git Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">http:</span></span></span><span class="hljs-tag">//</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">gnu.org</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">licenses</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">gpl.html</span></span></span><span class="hljs-tag">&gt;</span></span> This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Type "show copying" and "show warranty" for details. This GDB was configured as "x86_64-linux-gnu". Type "show configuration" for configuration details. For bug reporting instructions, please see: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">http:</span></span></span><span class="hljs-tag">//</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">www.gnu.org</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">software</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">gdb</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bugs</span></span></span><span class="hljs-tag">/&gt;</span></span>. Find the GDB manual and other documentation resources online at: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">http:</span></span></span><span class="hljs-tag">//</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">www.gnu.org</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">software</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">gdb</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">documentation</span></span></span><span class="hljs-tag">/&gt;</span></span>. For help, type "help". Type "apropos word" to search for commands related to "word"... Reading symbols from /usr/bin/slirp...Reading symbols from /usr/lib/debug/.build-id/c6/2e75b69581a1ad85f72ac32c0d7af913d4861f.debug...done. done. (gdb) run Starting program: /usr/bin/slirp Slirp v1.0.17 (BETA) Copyright (c) 1995,1996 Danny Gasparovski and others. All rights reserved. This program is copyrighted, free software. Please read the file COPYRIGHT that came with the Slirp package for the terms and conditions of the copyright. IP address of Slirp host: 127.0.0.1 IP address of your DNS(s): 1.1.1.1, 10.77.0.7 Your address is 10.0.2.15 (or anything else you want) Type five zeroes (0) to exit. [autodetect SLIP/CSLIP, MTU 1500, MRU 1500, 115200 baud] SLiRP Ready ... Program received signal SIGSEGV, Segmentation fault. ip_slowtimo () at ip_input.c:457 457 ip_input.c: No such file or directory.</code> </pre> <br>  O erro está batendo <a href="">nesta linha</a> .  Vejamos o stacktrace, talvez algo nos ajude lá: <br><br><pre> <code class="xml hljs">(gdb) bt full #0 ip_slowtimo () at ip_input.c:457 fp = 0x55784a40 #1 0x000055555556a57c in main_loop () at ./main.c:980 so = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optimized</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span><span class="hljs-tag">&gt;</span></span> so_next = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optimized</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span><span class="hljs-tag">&gt;</span></span> timeout = {tv_sec = 0, tv_usec = 0} ret = 0 nfds = 0 ttyp = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optimized</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span><span class="hljs-tag">&gt;</span></span> ttyp2 = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optimized</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span><span class="hljs-tag">&gt;</span></span> best_time = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optimized</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span><span class="hljs-tag">&gt;</span></span> tmp_time = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optimized</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span><span class="hljs-tag">&gt;</span></span> #2 0x000055555555b116 in main (argc=1, argv=0x7fffffffdc58) at ./main.c:95 No locals.</code> </pre> <br>  Aqui vemos que uma falha ocorre durante o início do loop principal, quando o slirp tenta verificar o tempo limite.  Nesse ponto, tive que desistir de tentar depurar.  Mas vamos ver se o Slirp compilado a partir das sortes funciona.  Eu recarreguei o arquivo diretamente do site <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Sourceforge</a> , porque arrastar algo de lá através da linha de comando é uma dor: <br><br><pre> <code class="xml hljs">cd ~/dl wget https://xena.greedo.xeserv.us/files/slirp-1.0.16.tar.gz tar xf slirp-1.0.16.tar.gz cd slirp-1.0.16/src ./configure --prefix=$HOME/prefix/slirp make</code> </pre> <br>  Aqui vemos alertas sobre funções internas indefinidas, ou seja, sobre a impossibilidade de vincular o arquivo binário resultante.  Parece que entre 2006 e esse momento, o gcc parou de criar caracteres usados ​​nas funções internas dos arquivos compilados intermediários.  Vamos tentar substituir a <code>inline</code> - <code>inline</code> por um comentário vazio e ver o resultado: <br><br><pre> <code class="xml hljs">vi slirp.h :6 a <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enter</span></span></span><span class="hljs-tag">&gt;</span></span> #define inline /**/ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">escape</span></span></span><span class="hljs-tag">&gt;</span></span> :wq make</code> </pre> <br>  Não.  Isso também não funciona.  Você ainda não consegue encontrar os caracteres para essas funções. <br><br>  Nesse ponto, desisti e comecei a procurar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pacotes de compilação Heroku</a> no Github.  Minha teoria foi baseada no fato de que alguns pacotes de compilação do Heroku conterão os binários de que preciso.  Como resultado, a pesquisa me levou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  Fiz o download e descompactei <code>uml.tar.gz</code> e encontrei o seguinte: <br><br><pre> <code class="xml hljs">total 6136 -rwxr-xr-x 1 cadey cadey 79744 Dec 10 2017 ifconfig* -rwxr-xr-x 1 cadey cadey 373 Dec 13 2017 init* -rwxr-xr-x 1 cadey cadey 149688 Dec 10 2017 insmod* -rwxr-xr-x 1 cadey cadey 66600 Dec 10 2017 route* -rwxr-xr-x 1 cadey cadey 181056 Jun 26 2015 slirp* -rwxr-xr-x 1 cadey cadey 5786592 Dec 15 2017 uml* -rwxr-xr-x 1 cadey cadey 211 Dec 13 2017 uml_run*</code> </pre> <br>  Este é um arquivo slirp binário!  Ele trabalha? <br><br><pre> <code class="xml hljs">./slirp Slirp v1.0.17 (BETA) FULL_BOLT Copyright (c) 1995,1996 Danny Gasparovski and others. All rights reserved. This program is copyrighted, free software. Please read the file COPYRIGHT that came with the Slirp package for the terms and conditions of the copyright. IP address of Slirp host: 127.0.0.1 IP address of your DNS(s): 1.1.1.1, 10.77.0.7 Your address is 10.0.2.15 (or anything else you want) Type five zeroes (0) to exit. [autodetect SLIP/CSLIP, MTU 1500, MRU 1500] SLiRP Ready ...</code> </pre><br>  Não falha - por isso deve funcionar!  Vamos conectar este binário em <code>~/bin/slirp</code> : <br><br><pre> <code class="xml hljs">cp slirp ~/bin/slirp</code> </pre> <br>  Caso o criador do pacote o remova, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fiz um espelho</a> . <br><br><h3>  Configuração de rede </h3><br>  Agora vamos configurar a rede em nosso núcleo de convidados.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Atualize as opções de inicialização</a> : <br><br><pre> <code class="xml hljs">linux \ root=/dev/root \ rootfstype=hostfs \ rootflags=$HOME/prefix/uml-demo \ rw \ mem=64M \ eth0=slirp,,$HOME/bin/slirp \ init=/bin/sh</code> </pre> <br>  Agora vamos ligar a rede: <br><br><pre> <code class="xml hljs">mount -t proc proc proc/ mount -t sysfs sys sys/ ifconfig eth0 10.0.2.14 netmask 255.255.255.240 broadcast 10.0.2.15 route add default gw 10.0.2.2</code> </pre> <br>  Os dois primeiros comandos de configuração <code>/proc</code> e <code>/sys</code> necessários para o funcionamento do <code>ifconfig</code> , que configura uma interface de rede para comunicação com o Slirp.  O comando <code>route</code> configura uma tabela de roteamento do kernel para forçar todo o tráfego através do túnel Slirp.  Vamos verificar isso com uma consulta DNS: <br><br><pre> <code class="xml hljs">nslookup google.com 8.8.8.8 Server: 8.8.8.8 Address 1: 8.8.8.8 dns.google Name: google.com Address 1: 172.217.12.206 lga25s63-in-f14.1e100.net Address 2: 2607:f8b0:4006:81b::200e lga25s63-in-x0e.1e100.net</code> </pre> <br>  Isso funciona! <br><br>  <i>Nota: Aparentemente, a postagem original foi gravada na área de trabalho com uma placa de rede com fio ou outra configuração que não requer drivers adicionais.</i>  <i>Em um laptop com WiFi 8265 da Intel, quando você cria a rede, ocorre um erro</i> <br><br><pre> <code class="bash hljs">/ <span class="hljs-comment"><span class="hljs-comment"># ifconfig eth0 10.0.2.14 netmask 255.255.255.240 broadcast 10.0.2.15 slirp_tramp failed - errno = 2 ifconfig: ioctl 0x8914 failed: No such file or directory / #</span></span></code> </pre> <br>  <i>Aparentemente, o kernel não pode se comunicar com o driver de rede.</i>  <i>Uma tentativa de compilar o firmware no kernel, infelizmente, não corrigiu a situação.</i>  <i>No momento da publicação, não era possível encontrar uma solução nessa configuração específica.</i>  <i>Em configurações mais simples (por exemplo, no Virtualbox), a interface aumenta corretamente.</i> <br><br>  Vamos automatizar o redirecionamento usando o seguinte script de shell: <br><br><pre> <code class="xml hljs">#!/bin/sh # init.sh mount -t proc proc proc/ mount -t sysfs sys sys/ ifconfig eth0 10.0.2.14 netmask 255.255.255.240 broadcast 10.0.2.15 route add default gw 10.0.2.2 echo "networking set up" exec /tini /bin/sh</code> </pre> <br>  E marque-o como executável: <br><br><pre> <code class="xml hljs">chmod +x init.sh</code> </pre> <br>  E, em seguida, faça alterações na linha de comando do kernel: <br><br><pre> <code class="xml hljs">linux \ root=/dev/root \ rootfstype=hostfs \ rootflags=$HOME/prefix/uml-demo \ rw \ mem=64M \ eth0=slirp,,$HOME/bin/slirp \ init=/init.sh</code> </pre><br>  E repita: <br><br><pre> <code class="xml hljs">SLiRP Ready ... networking set up /bin/sh: can't access tty; job control turned off nslookup google.com 8.8.8.8 Server: 8.8.8.8 Address 1: 8.8.8.8 dns.google Name: google.com Address 1: 172.217.12.206 lga25s63-in-f14.1e100.net Address 2: 2607:f8b0:4004:800::200e iad30s09-in-x0e.1e100.net</code> </pre> <br>  A rede está estável! <br><br><h3> - </h3><br>       ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dockerfile</a> ,           .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a> ,    ,    .   ,       . <br><br><hr><br>  ,      ,    .  - ,          ,    User Mode  Linux       .                .     Docker —    tar-,         <code>docker export</code> ,            . ,    shell-. <br><br>   Rkeene  #lobsters  Freenode.      Slirp      .    ,    Slackware    slirp,    Ubuntu  Alpine   slirp    Rkeene .     ,      -. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt459558/">https://habr.com/ru/post/pt459558/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt459542/index.html">Mecânica de Gamificação: Árvore de Habilidades</a></li>
<li><a href="../pt459544/index.html">Por que a série de Chernobyl descreveu tão mal a energia nuclear</a></li>
<li><a href="../pt459550/index.html">Backup, Parte 5: Testando o Bacula e o Veeam Backup para Linux</a></li>
<li><a href="../pt459552/index.html">Como perder o acesso ao sistema ativo, simplesmente atrapalhando o código-fonte</a></li>
<li><a href="../pt459554/index.html">Acompanhe as alterações nos arquivos usando o Alerting OpenDistro for Elasticsearch</a></li>
<li><a href="../pt459560/index.html">Capacidades dos data centers de contêineres: centro de comutação pronto em Mianmar em 50 dias</a></li>
<li><a href="../pt459562/index.html">Programação diferenciável</a></li>
<li><a href="../pt459564/index.html">O que os desenvolvedores precisam saber sobre negócios</a></li>
<li><a href="../pt459568/index.html">Letra vertical na TI moderna</a></li>
<li><a href="../pt459570/index.html">Beeline mostra anúncios para o bot do Google. Bot infeliz</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>