<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∞üèæ üåò ‚ö±Ô∏è Parfois, plus c'est moins. Quand une diminution de la charge entra√Æne une augmentation du retard üéÖüèª üßïüèª üë©üèº‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comme dans la plupart des articles , il y avait un probl√®me avec un service distribu√©, appelons ce service Alvin. Cette fois, je n'ai pas trouv√© le pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Parfois, plus c'est moins. Quand une diminution de la charge entra√Æne une augmentation du retard</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451904/"> Comme dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plupart des articles</a> , il y avait un probl√®me avec un service distribu√©, appelons ce service Alvin.  Cette fois, je n'ai pas trouv√© le probl√®me moi-m√™me, m'ont inform√© les gars de la partie client. <br><br>  Une fois, je me suis r√©veill√© d'une lettre m√©contente en raison des gros retards d'Alvin, que nous avions pr√©vu de lancer dans un avenir proche.  En particulier, le client a rencontr√© un retard du 99e centile d'environ 50 ms, bien sup√©rieur √† notre budget de retard.  C'√©tait surprenant, car j'ai test√© le service √† fond, surtout pour les retards, car cela fait l'objet de plaintes fr√©quentes. <br><br>  Avant de donner Alvin pour les tests, j'ai men√© de nombreuses exp√©riences avec 40 000 requ√™tes par seconde (QPS), toutes montrant un retard de moins de 10 ms.  J'√©tais pr√™t √† d√©clarer que je n'√©tais pas d'accord avec leurs r√©sultats.  Mais une fois de plus en regardant la lettre, j'ai attir√© l'attention sur quelque chose de nouveau: je n'ai certainement pas test√© les conditions qu'ils ont mentionn√©es, leur QPS √©tait beaucoup plus bas que le mien.  J'ai test√© sur 40k QPS, et ils seulement sur 1k.  J'ai ex√©cut√© une autre exp√©rience, cette fois avec un QPS inf√©rieur, juste pour leur faire plaisir. <br><a name="habracut"></a><br>  Depuis que j'√©cris √† ce sujet sur mon blog, vous avez probablement d√©j√† compris: leur nombre s'est av√©r√© correct.  J'ai test√© mon client virtuel encore et encore, tous avec le m√™me r√©sultat: un faible nombre de demandes augmente non seulement le d√©lai, mais augmente √©galement le nombre de demandes avec un d√©lai sup√©rieur √† 10 ms.  En d'autres termes, si √† 40k QPS, environ 50 requ√™tes par seconde d√©passaient 50 ms, alors √† 1k QPS chaque seconde, il y avait 100 requ√™tes au-dessus de 50 ms.  Paradoxe! <br><br><img src="https://habrastorage.org/webt/xd/86/x-/xd86x-er30ek6tg4hkv4qdevvgq.png"><br><br><h1>  Affinez votre recherche </h1><br>  Face au probl√®me du retard dans un syst√®me distribu√© √† nombreux composants, la premi√®re chose que vous devez faire est de dresser une courte liste de suspects.  Nous approfondissons un peu plus l'architecture d'Alvin: <br><br><img src="https://habrastorage.org/webt/lh/is/s5/lhiss5mqv9dq2h9moyhlss_chlk.png"><br><br>  Un bon point de d√©part est une liste des transitions d'E / S termin√©es (appels r√©seau / recherches de disque, etc.).  Essayons de savoir o√π est le retard.  En plus des E / S √©videntes avec le client, Alvin franchit une √©tape suppl√©mentaire: il acc√®de √† l'entrep√¥t de donn√©es.  Cependant, ce stockage fonctionne dans le m√™me cluster avec Alvin, donc il devrait y avoir moins de retard qu'avec le client.  Donc, la liste des suspects: <br><br><ol><li>  Appel r√©seau du client vers Alvin. <br></li><li>  Appel r√©seau d'Alvin √† l'entrep√¥t de donn√©es. <br></li><li>  Recherche sur disque dans l'entrep√¥t de donn√©es. <br></li><li>  Appel r√©seau depuis l'entrep√¥t de donn√©es vers Alvin. <br></li><li>  Appel r√©seau d'Alvin au client. </li></ol><br>  Essayons de rayer certains points. <br><br><h3>  Entrep√¥t de donn√©es </h3><br>  La premi√®re chose que j'ai faite a √©t√© de convertir Alvin en un serveur ping-ping qui ne g√®re pas les requ√™tes.  D√®s r√©ception de la demande, il renvoie une r√©ponse vide.  Si le d√©lai diminue, alors une erreur dans la mise en ≈ìuvre d'Alvin ou de l'entrep√¥t de donn√©es n'est rien de inconnu.  Dans la premi√®re exp√©rience, nous obtenons le graphique suivant: <br><br><img src="https://habrastorage.org/webt/i4/zs/9s/i4zs9saymr5ra4tmry3diqbgdyy.png"><br><br>  Comme vous pouvez le voir, lors de l'utilisation du serveur ping-ping, il n'y a aucune am√©lioration.  Cela signifie que l'entrep√¥t de donn√©es n'augmente pas le d√©lai et la liste des suspects est divis√©e par deux: <br><br><ol><li>  Appel r√©seau du client vers Alvin. <br></li><li>  Appel r√©seau d'Alvin au client. </li></ol><br>  Ouah!  La liste se r√©tr√©cit rapidement.  Je pensais avoir presque compris la raison. <br><br><h3>  gRPC </h3><br>  Il est maintenant temps de vous pr√©senter un nouveau joueur: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gRPC</a> .  Il s'agit d'une biblioth√®que open source de Google pour les communications <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RPC en cours</a> .  Bien que <code>gRPC</code> bien optimis√© et largement utilis√©, je l'ai utilis√© pour la premi√®re fois sur un syst√®me de cette ampleur, et je m'attendais √† ce que ma mise en ≈ìuvre soit sous-optimale - pour le moins. <br><br>  La pr√©sence de <code>gRPC</code> dans la pile a soulev√© une nouvelle question: peut-√™tre est-ce mon impl√©mentation ou <code>gRPC</code> lui-m√™me cause- <code>gRPC</code> -il un probl√®me de retard?  Ajouter √† la liste du nouveau suspect: <br><br><ol><li>  Le client appelle la biblioth√®que <code>gRPC</code> <br></li><li>  La biblioth√®que <code>gRPC</code> sur le client effectue un appel r√©seau √† la biblioth√®que <code>gRPC</code> sur le serveur <br></li><li>  <code>gRPC</code> biblioth√®que <code>gRPC</code> acc√®de √† Alvin (aucune op√©ration en cas de serveur ping-pong) </li></ol><br>  Pour vous faire comprendre √† quoi ressemble le code, mon impl√©mentation client / Alvin n'est pas tr√®s diff√©rente des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exemples</a> client-serveur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">asynchrone</a> . <br><br><blockquote>  <i>Remarque: la liste ci-dessus est un peu simplifi√©e, car <code>gRPC</code> vous permet d'utiliser votre propre (mod√®le?) Mod√®le de flux, dans lequel la <code>gRPC</code> ex√©cution <code>gRPC</code> et l'impl√©mentation utilisateur sont entrelac√©es.</i>  <i>Par souci de simplicit√©, nous nous en tiendrons √† ce mod√®le.</i> </blockquote><br><h3>  Le profilage r√©soudra tout </h3><br>  En traversant les entrep√¥ts de donn√©es, je pensais que j'avais presque fini: ¬´Maintenant, c'est facile!  Nous appliquerons le profil et d√©couvrirons o√π le retard se produit. "  Je suis un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">grand fan du profilage pr√©cis</a> car les CPU sont tr√®s rapides et le plus souvent ils ne sont pas un goulot d'√©tranglement.  La plupart des retards se produisent lorsque le processeur doit arr√™ter le traitement pour faire autre chose.  Un profilage pr√©cis du CPU a √©t√© fait juste pour cela: il enregistre avec pr√©cision tous les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">changements de contexte</a> et indique clairement o√π les retards se produisent. <br><br>  J'ai pris quatre profils: sous QPS √©lev√© (faible latence) et avec un serveur de ping-pong sur QPS faible (latence √©lev√©e), √† ‚Äã‚Äãla fois c√¥t√© client et c√¥t√© serveur.  Et juste au cas o√π, j'ai √©galement pris un exemple de profil de processeur.  Lorsque je compare des profils, je recherche g√©n√©ralement une pile d'appels anormale.  Par exemple, du mauvais c√¥t√© avec un retard √©lev√©, il y a beaucoup plus de changements de contexte (10 fois ou plus).  Mais dans mon cas, le nombre de changements de contexte a presque co√Øncid√©.  √Ä mon horreur, il n'y avait rien de significatif l√†-bas. <br><br><h1>  D√©bogage suppl√©mentaire </h1><br>  J'√©tais d√©sesp√©r√©.  Je ne savais pas quels autres outils pouvaient √™tre utilis√©s, et mon prochain plan √©tait essentiellement de r√©p√©ter les exp√©riences avec diff√©rentes variantes, et non de diagnostiquer clairement le probl√®me. <br><br><h3>  Et si </h3><br>  D√®s le d√©but, je m'inqui√©tais du temps de retard sp√©cifique de 50 ms.  C'est un tr√®s grand moment.  J'ai d√©cid√© de couper les morceaux du code jusqu'√† ce que je puisse d√©terminer exactement quelle partie √©tait √† l'origine de cette erreur.  Puis a suivi une exp√©rience qui a fonctionn√©. <br><br>  Comme d'habitude, l'esprit en arri√®re semble que tout √©tait √©vident.  J'ai mis le client sur la m√™me machine qu'Alvin - et j'ai envoy√© la demande √† <code>localhost</code> .  Et l'augmentation du retard a disparu! <br><br><img src="https://habrastorage.org/webt/kl/bk/fv/klbkfv7ajppr9uqp_tywvxwgjre.png"><br><br>  Quelque chose n'allait pas avec le r√©seau. <br><br><h3>  Acqu√©rir les comp√©tences d'un ing√©nieur r√©seau </h3><br>  Je dois admettre que ma connaissance des technologies r√©seau est terrible, surtout si l'on consid√®re que je travaille quotidiennement avec elles.  Mais le r√©seau √©tait le principal suspect, et j'avais besoin d'apprendre √† le d√©boguer. <br><br>  Heureusement, Internet aime ceux qui veulent apprendre.  La combinaison de ping et de tracert semblait un bon d√©but pour d√©boguer les probl√®mes de transport r√©seau. <br><br>  Tout d'abord, j'ai ex√©cut√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PsPing</a> sur le port TCP d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Alvin</a> .  J'ai utilis√© les options par d√©faut - rien de sp√©cial.  Sur plus d'un millier de pings, aucun n'a d√©pass√© 10 ms, √† l'exception du premier pour l'√©chauffement.  Cela contredit l'augmentation observ√©e du retard de 50 ms dans le 99e centile: l√†, pour 100 requ√™tes, nous devrions voir environ une requ√™te avec un retard de 50 ms. <br><br>  Ensuite, j'ai essay√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tracert</a> : peut-√™tre que le probl√®me est sur l'un des n≈ìuds le long de la route entre Alvin et le client.  Mais le traceur est revenu les mains vides. <br><br>  Ainsi, la raison du retard n'√©tait pas mon code, ni la mise en ≈ìuvre de gRPC, ni le r√©seau.  J'ai d√©j√† commenc√© √† craindre de ne jamais comprendre cela. <br><br><h3>  Maintenant, sur quel syst√®me d'exploitation sommes-nous </h3><br>  <code>gRPC</code> largement utilis√© sous Linux, mais il est exotique pour Windows.  J'ai d√©cid√© de mener une exp√©rience qui a fonctionn√©: j'ai cr√©√© une machine virtuelle Linux, compil√© Alvin pour Linux et l'ai d√©ploy√©. <br><br><img src="https://habrastorage.org/webt/z1/t8/tk/z1t8tkyhrobvurzcdqlmpdtetzc.png"><br><br>  Et voici ce qui s'est pass√©: le serveur Linux de ping-pong n'a pas eu des retards comme un n≈ìud Windows similaire, bien que la source de donn√©es ne diff√®re pas.  Il s'av√®re que le probl√®me est li√© √† l'impl√©mentation de gRPC pour Windows. <br><br><h3>  Algorithme Nagle </h3><br>  <code>gRPC</code> tout ce temps, je pensais que je <code>gRPC</code> drapeau <code>gRPC</code> .  Maintenant, je me suis rendu compte qu'il manquait en <code>gRPC</code> le drapeau Windows dans <code>gRPC</code> .  J'ai trouv√© la biblioth√®que RPC interne, dans laquelle j'√©tais s√ªr qu'elle fonctionne bien pour tous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les</a> drapeaux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Winsock</a> install√©s.  Il a ensuite ajout√© tous ces drapeaux √† gRPC et d√©ploy√© Alvin sur Windows, dans le serveur de ping-pong fixe pour Windows! <br><br><img src="https://habrastorage.org/webt/7o/it/sf/7oitsfp2rzxotix0cf1xhktbrri.png"><br><br>  <i>Presque</i> termin√©: j'ai commenc√© √† supprimer les drapeaux ajout√©s un par un jusqu'√† ce que la r√©gression revienne, afin de pouvoir en identifier la cause.  C'√©tait le tristement c√©l√®bre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TCP_NODELAY</a> , un commutateur de l'algorithme Nagle. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'algorithme Neigl</a> tente de r√©duire le nombre de paquets envoy√©s sur le r√©seau en retardant la transmission des messages jusqu'√† ce que la taille des paquets d√©passe un certain nombre d'octets.  Bien que cela puisse √™tre agr√©able pour l'utilisateur moyen, il est destructeur pour les serveurs en temps r√©el, car le syst√®me d'exploitation retardera certains messages, entra√Ænant des retards sur un faible QPS.  <code>gRPC</code> avait cet indicateur d√©fini dans l'impl√©mentation Linux pour les sockets TCP, mais pas pour Windows.  Je l'ai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©par√©</a> . <br><br><h1>  Conclusion </h1><br>  Un gros retard dans le faible QPS a √©t√© caus√© par l'optimisation du syst√®me d'exploitation.  Avec le recul, le profilage n'a pas d√©tect√© de retard car il a √©t√© effectu√© en mode noyau et non en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mode utilisateur</a> .  Je ne sais pas s‚Äôil est possible d‚Äôobserver l‚Äôalgorithme Nagle via des captures ETW, mais ce serait int√©ressant. <br><br>  Quant √† l'exp√©rience localhost, elle n'a probablement pas touch√© le code r√©seau r√©el et l'algorithme Neigl n'a pas d√©marr√©, de sorte que les probl√®mes de retard ont disparu lorsque le client a contact√© Alvin via localhost. <br><br>  La prochaine fois que vous constaterez une augmentation de la latence tout en diminuant le nombre de requ√™tes par seconde, l'algorithme Neigl devrait figurer sur votre liste de suspects! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr451904/">https://habr.com/ru/post/fr451904/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr451894/index.html">Un aper√ßu bref et dynamique de l'architecture du compilateur</a></li>
<li><a href="../fr451896/index.html">Un eyeDisk ¬´incassable¬ª est prot√©g√© par un balayage d'iris, mais transmet un mot de passe en texte clair</a></li>
<li><a href="../fr451898/index.html">Innovation en russe</a></li>
<li><a href="../fr451900/index.html">Premi√®re contribution √† l'API du navigateur de Facebook</a></li>
<li><a href="../fr451902/index.html">Camp de d√©veloppeurs Microsoft Azure Russie</a></li>
<li><a href="../fr451906/index.html">Vuln√©rabilit√© dans Exchange: comment d√©tecter l'√©l√©vation de privil√®ges √† un administrateur de domaine</a></li>
<li><a href="../fr451908/index.html">L'histoire des ordinateurs: une nuit au Mus√©e Yandex</a></li>
<li><a href="../fr451912/index.html">Le r√©seau de neurones profonds MuseNet √©crit de la musique</a></li>
<li><a href="../fr451916/index.html">PHP asynchrone et l'histoire d'un v√©lo</a></li>
<li><a href="../fr451918/index.html">A la question de TI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>