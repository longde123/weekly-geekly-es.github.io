<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüé§ üí™üèº ü§∂üèª PKI: biblioth√®ques GCrypt et KSBA comme alternative √† OpenSSL avec prise en charge de la cryptographie russe. Continuation üëÉüèª üíä üíÉüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous continuons √† parler de l'alternative √† openssl et nous parlerons de la biblioth√®que libksba , qui fait partie de GnuPG. La biblioth√®que libksba f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PKI: biblioth√®ques GCrypt et KSBA comme alternative √† OpenSSL avec prise en charge de la cryptographie russe. Continuation</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415611/"><img src="https://habrastorage.org/webt/-0/_j/ix/-0_jixnnpwfrlf98pirivc2nvim.png" align="left">  Nous continuons √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parler</a> de l'alternative √† openssl et nous parlerons de la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">libksba</a> , qui fait partie de GnuPG.  La biblioth√®que libksba fournit une interface de haut niveau pour travailler avec des objets d'infrastructure √† cl√© publique tels que des certificats, des demandes de certificats, des signatures √©lectroniques (CMS / PKCS # 7).  Cependant, contrairement √† la biblioth√®que GCrypt, qui prend en charge les algorithmes cryptographiques russes, libksba n'a pas la mise en ≈ìuvre des recommandations <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TK-26</a> sur l'utilisation des algorithmes GOST R 34.10-2001 / 2012, GOST R 34.11-94 / 2012 dans les objets PKI tels que les certificats, demandes de certificats, objets PKCS # 7 / CMS (documents sign√©s et / ou crypt√©s, etc.). <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/a_/a1/ko/a_a1koe5af24nxexxvu2bjfjbt4.png" align="right">  Commen√ßons par les oids qui peuvent (ou devraient) faire partie des attributs distingu√©s DN (Distinguished Name) de l'√©metteur (√©diteur) et du sujet (propri√©taire) du certificat.  Dans la biblioth√®que libksba, les oid sont √©crits dans la structure oid_name_tbl [] (fichier dn.c).  La structure oid_name_tbl [] ne contient pas d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">oid</a> s de TIN, BIN, OGRNIP et SNILS <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">recommand√©s par</a> TK-26 pour un certificat qualifi√©: <br><blockquote>  18. Les autres attributs du nom, dont l'utilisation est √©tablie conform√©ment √† la loi f√©d√©rale, comprennent: <br><br>  1) OGRN. <br>  La valeur de l'attribut OGRN est une cha√Æne de 13 chiffres repr√©sentant l'ORGRN du titulaire d'un certificat qualifi√© - une entit√© juridique.  L'identifiant d'objet de type attribut OGRN a la forme 1.2.643.100.1, le type d'attribut OGRN est d√©crit comme suit: OGRN :: = NUMERIC STRING SIZE 13; <br><br>  2) SNILS (SNILS). <br>  La valeur de l'attribut SNILS est une cha√Æne de 11 chiffres repr√©sentant SNILS du propri√©taire d'un certificat qualifi√© - un individu.  L'identifiant d'objet du type d'attribut SNILS est 1.2.643.100.3, le type d'attribut SNILS est d√©crit comme suit: SNILS :: = NUMERIC STRING SIZE 11; <br><br>  3) INN. <br>  La valeur de l'attribut INN est une cha√Æne de 12 chiffres repr√©sentant le NIF du titulaire du certificat qualifi√©.  L'identifiant d'objet du type d'attribut INN est 1.2.643.3.131.1.1, le type d'attribut INN est d√©crit comme suit: INN :: = NUMERIC STRING SIZE 12. </blockquote><br>  Naturellement, vous devez ajouter ces oid-s: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *name; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> source; <span class="hljs-comment"><span class="hljs-comment">/* 0 = unknown 1 = rfc2253 2 = David Chadwick, July 2003 &lt;draft-ietf-pkix-dnstrings-02.txt&gt; 3 = Peter Gutmann 4 = tk26 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *description; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> oidlen; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *oid; <span class="hljs-comment"><span class="hljs-comment">/* DER encoded OID. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *oidstr; <span class="hljs-comment"><span class="hljs-comment">/* OID as dotted string. */</span></span> } oid_name_tbl[] = { {<span class="hljs-string"><span class="hljs-string">"CN"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"CommonName"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x03"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.3"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"SN"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"Surname"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x04"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.4"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"SERIALNUMBER"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"SerialNumber"</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x05"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.5"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"C"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"CountryName"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x06"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.6"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"L"</span></span> , <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"LocalityName"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x07"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.7"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"ST"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"StateOrProvince"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x08"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.8"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"STREET"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"StreetAddress"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x09"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.9"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"O"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"OrganizationName"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x0a"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.10"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"OU"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"OrganizationalUnit"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x0b"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.11"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"T"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"Title"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x0c"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.12"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"D"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"Description"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x0d"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.13"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"BC"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"BusinessCategory"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x0f"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.15"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"ADDR"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"PostalAddress"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x11"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.16"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"POSTALCODE"</span></span> , <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"PostalCode"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x11"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.17"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"GN"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"GivenName"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x2a"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.42"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"PSEUDO"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"Pseudonym"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"\x55\x04\x41"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.5.4.65"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"DC"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"domainComponent"</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"\x09\x92\x26\x89\x93\xF2\x2C\x64\x01\x19"</span></span>, <span class="hljs-string"><span class="hljs-string">"0.9.2342.19200300.100.1.25"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"UID"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"userid"</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"\x09\x92\x26\x89\x93\xF2\x2C\x64\x01\x01"</span></span>, <span class="hljs-string"><span class="hljs-string">"0.9.2342.19200300.100.1.1 "</span></span> }, {<span class="hljs-string"><span class="hljs-string">"E"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"emailAddress"</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-string"><span class="hljs-string">"\x2A\x86\x48\x86\xF7\x0D\x01\x09\x01"</span></span>, <span class="hljs-string"><span class="hljs-string">"1.2.840.113549.1.9.1"</span></span> }, <span class="hljs-comment"><span class="hljs-comment">/*TK-26*/</span></span> {<span class="hljs-string"><span class="hljs-string">"OGRN"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"OGRN"</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"\x2a\x85\x03\x64\x01"</span></span>, <span class="hljs-string"><span class="hljs-string">"1.2.643.100.1"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"INN"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"INN"</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">"\x2a\x85\x03\x03\x81\x03\x01\x01"</span></span>, <span class="hljs-string"><span class="hljs-string">"1.2.643.3.131.1.1"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"SNILS"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"SNILS"</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"\x2a\x85\x03\x64\x03"</span></span>, <span class="hljs-string"><span class="hljs-string">"1.2.643.100.3"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"OGRNIP"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"OGRNIP"</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"\x2a\x85\x03\x64\x05"</span></span>, <span class="hljs-string"><span class="hljs-string">"1.2.643.100.5"</span></span> }, { <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> } };</code> </pre> <br>  Ce qui est remarquable dans cette structure est la pr√©sence du champ source, qui indique qui a entr√© un champ particulier, par exemple, 1 (unit√©) indique que le champ est d√©fini dans rfc2253, et 4 (quatre) ajout√©s ici seront indiquer que le domaine est recommand√© par le comit√© technique du TK-26.  Conform√©ment aux recommandations du TK-26, les attributs TIN, OGRN, OGRNIP et SNILS sont de type NUMERIC STRING (voir ci-dessus).  Le traitement des oids inclus dans le DN dans libksba est fourni dans la fonction append_atv (fichier dn.c), cependant, il manque un traitement de type TYPE_NUMERIC_STRING, et vous devez l'ajouter: <br><br><pre> <code class="cpp hljs">. . . <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (use_hex? <span class="hljs-number"><span class="hljs-number">0</span></span> : node-&gt;type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> TYPE_UTF8_STRING: append_utf8_value (image+node-&gt;off+node-&gt;nhdr, node-&gt;len, sb); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   NUMERIC STRING*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> TYPE_NUMERIC_STRING: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> TYPE_PRINTABLE_STRING: ‚Ä¶.</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Le patch pour le fichier dn.c est ici:</b> <div class="spoiler_text"><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- dn_ORIG.c 2016-08-22 11:40:58.000000000 +0300 +++ dn.c 2018-06-26 19:23:38.068492230 +0300 @@ -48,6 +48,7 @@ 2 = David Chadwick, July 2003 &lt;draft-ietf-pkix-dnstrings-02.txt&gt; 3 = Peter Gutmann + 4 = tk26 */ const char *description; size_t oidlen; @@ -74,12 +75,17 @@ "\x09\x92\x26\x89\x93\xF2\x2C\x64\x01\x19", "0.9.2342.19200300.100.1.25" }, {"UID", 1, "userid", 10, "\x09\x92\x26\x89\x93\xF2\x2C\x64\x01\x01", "0.9.2342.19200300.100.1.1 " }, -{"EMAIL", 3, "emailAddress", 9, +{"E", 1, "emailAddress", 9, "\x2A\x86\x48\x86\xF7\x0D\x01\x09\x01", "1.2.840.113549.1.9.1" }, +/*oid-    TK-26*/ +{"OGRN", 4, "OGRN", 5, "\x2a\x85\x03\x64\x01", "1.2.643.100.1" }, +{"INN", 4, "INN", 8, "\x2a\x85\x03\x03\x81\x03\x01\x01", "1.2.643.3.131.1.1" }, +{"SNILS", 4, "SNILS", 5, "\x2a\x85\x03\x64\x03", "1.2.643.100.3" }, +{"OGRNIP", 4, "OGRNIP", 5, "\x2a\x85\x03\x64\x05", "1.2.643.100.5" }, + { NULL } }; - #define N 0x00 #define P 0x01 static unsigned char charclasses[128] = { @@ -555,8 +561,8 @@ name = NULL; for (i=0; oid_name_tbl[i].name; i++) { - if (oid_name_tbl[i].source == 1 - &amp;&amp; node-&gt;len == oid_name_tbl[i].oidlen +/* oid-  DN    */ + if (node-&gt;len == oid_name_tbl[i].oidlen &amp;&amp; !memcmp (image+node-&gt;off+node-&gt;nhdr, oid_name_tbl[i].oid, node-&gt;len)) { @@ -604,6 +610,9 @@ case TYPE_UTF8_STRING: append_utf8_value (image+node-&gt;off+node-&gt;nhdr, node-&gt;len, sb); break; +/*  NUMERIC_STRING*/ + case TYPE_NUMERIC_STRING: + case TYPE_PRINTABLE_STRING: case TYPE_IA5_STRING: /* we assume that wrong encodings are latin-1 */</span></span></code> </pre> <br></div></div><br>  Enregistrez-le dans le fichier diff_dn.patch. <br>  La biblioth√®que libksba peut √™tre t√©l√©charg√©e <a href="">ici</a> .  D√©compressez l'archive, entrez dans le r√©pertoire src et appliquez le patch diff_dn.patch au fichier dn.c: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$patch</span></span> dn.c &lt; diff_dn.patch $</code> </pre> <br>  En plus des oid s des attributs DN, il est √©galement n√©cessaire d'ajouter des oid s des cl√©s GOST √† ‚Äã‚Äãla structure struct pk_algo_table [] (fichier keyihfo.c): <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">algo_table_s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pk_algo_table</span></span></span><span class="hljs-class">[] = {</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* iso.member-body.us.rsadsi.pkcs.pkcs-1.1 */</span></span> <span class="hljs-string"><span class="hljs-string">"1.2.840.113549.1.1.1"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* rsaEncryption (RSAES-PKCA1-v1.5) */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2a\x86\x48\x86\xf7\x0d\x01\x01\x01"</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_RSA, <span class="hljs-string"><span class="hljs-string">"rsa"</span></span>, <span class="hljs-string"><span class="hljs-string">"-ne"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x30\x02\x02"</span></span> }, . . . <span class="hljs-comment"><span class="hljs-comment">/* oid- - */</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* GOST3410-2001 */</span></span> <span class="hljs-string"><span class="hljs-string">"1.2.643.2.2.19"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* gostPublicKey-2001 */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2a\x85\x03\x02\x02\x13"</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_ECC, <span class="hljs-string"><span class="hljs-string">"ecc"</span></span>, <span class="hljs-string"><span class="hljs-string">"q"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x80"</span></span> }, { <span class="hljs-comment"><span class="hljs-comment">/* GOST3410-2012-256 */</span></span> <span class="hljs-string"><span class="hljs-string">"1.2.643.7.1.1.1.1"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* gostPublicKey-2012-256 */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2a\x85\x03\x07\x01\x01\x01\x01"</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_ECC, <span class="hljs-string"><span class="hljs-string">"ecc"</span></span>, <span class="hljs-string"><span class="hljs-string">"q"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x80"</span></span> }, { <span class="hljs-comment"><span class="hljs-comment">/* GOST3410-2012-512 */</span></span> <span class="hljs-string"><span class="hljs-string">"1.2.643.7.1.1.1.2"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* gostPublicKey-2012-512 */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2a\x85\x03\x07\x01\x01\x01\x02"</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_ECC, <span class="hljs-string"><span class="hljs-string">"ecc"</span></span>, <span class="hljs-string"><span class="hljs-string">"q"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x80"</span></span> }, {<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>} };</code> </pre> <br>  De m√™me, dans la structure sig_algo_table [] (fichier keyihfo.c) nous ajoutons des oid-s associ√©s √† la signature √©lectronique selon GOST: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">algo_table_s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sig_algo_table</span></span></span><span class="hljs-class">[] = {</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* iso.member-body.us.rsadsi.pkcs.pkcs-1.5 */</span></span> <span class="hljs-string"><span class="hljs-string">"1.2.840.113549.1.1.5"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* sha1WithRSAEncryption */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2A\x86\x48\x86\xF7\x0D\x01\x01\x05"</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_RSA, <span class="hljs-string"><span class="hljs-string">"rsa"</span></span>, <span class="hljs-string"><span class="hljs-string">"s"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x82"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"sha1"</span></span> }, . . . <span class="hljs-comment"><span class="hljs-comment">/*oid-,   - */</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* GOST3410-2001 */</span></span> <span class="hljs-string"><span class="hljs-string">"1.2.643.2.2.19"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* gostPublicKey-2001 */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2a\x85\x03\x02\x02\x13"</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_ECC, <span class="hljs-string"><span class="hljs-string">"gost"</span></span>, <span class="hljs-string"><span class="hljs-string">"s"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x80"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"gostr3411_CP"</span></span> }, { <span class="hljs-comment"><span class="hljs-comment">/* GOST3410-2012-256 */</span></span> <span class="hljs-string"><span class="hljs-string">"1.2.643.7.1.1.1.1"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* gostPublicKey-2012-256 */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2a\x85\x03\x07\x01\x01\x01\x01"</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_ECC, <span class="hljs-string"><span class="hljs-string">"gost"</span></span>, <span class="hljs-string"><span class="hljs-string">"s"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x80"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"stribog256"</span></span>}, { <span class="hljs-comment"><span class="hljs-comment">/* GOST3410-2012-512 */</span></span> <span class="hljs-string"><span class="hljs-string">"1.2.643.7.1.1.1.2"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* gostPublicKey-2012-512 */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2a\x85\x03\x07\x01\x01\x01\x02"</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_ECC, <span class="hljs-string"><span class="hljs-string">"gost"</span></span>, <span class="hljs-string"><span class="hljs-string">"s"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x80"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"stribog512"</span></span>}, { <span class="hljs-comment"><span class="hljs-comment">/* GOST3411-2012-256 */</span></span> <span class="hljs-string"><span class="hljs-string">"1.2.643.7.1.1.3.2"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* STRIBOG256 */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2a\x85\x03\x07\x01\x01\x03\x02"</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_ECC, <span class="hljs-string"><span class="hljs-string">"gost"</span></span>, <span class="hljs-string"><span class="hljs-string">"s"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x80"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"stribog256"</span></span> }, { <span class="hljs-comment"><span class="hljs-comment">/* GOST3411-2012-512 */</span></span> <span class="hljs-string"><span class="hljs-string">"1.2.643.7.1.1.3.3"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* STRIBOG512 */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2a\x85\x03\x07\x01\x01\x03\x03"</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_ECC, <span class="hljs-string"><span class="hljs-string">"gost"</span></span>, <span class="hljs-string"><span class="hljs-string">"s"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x80"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"stribog512"</span></span> }, { <span class="hljs-comment"><span class="hljs-comment">/* GOST3410-2001-Signature */</span></span> <span class="hljs-string"><span class="hljs-string">"1.2.643.2.2.3"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* gosrPublicKey-2001 avec signature */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2a\x85\x03\x02\x02\x03"</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_ECC, <span class="hljs-string"><span class="hljs-string">"gost"</span></span>, <span class="hljs-string"><span class="hljs-string">"s"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x80"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"gostr3411_CP"</span></span> }, {<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>} };</code> </pre> <br>  Et, enfin, nous compl√©tons la structure de enc_algo_table [] avec des oids de cl√©s GOST qui peuvent participer au chiffrement asym√©trique (PKCS # 7): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">algo_table_s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">enc_algo_table</span></span></span><span class="hljs-class">[] = {</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* iso.member-body.us.rsadsi.pkcs.pkcs-1.1 */</span></span> <span class="hljs-string"><span class="hljs-string">"1.2.840.113549.1.1.1"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* rsaEncryption (RSAES-PKCA1-v1.5) */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2A\x86\x48\x86\xF7\x0D\x01\x01\x01"</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_RSA, <span class="hljs-string"><span class="hljs-string">"rsa"</span></span>, <span class="hljs-string"><span class="hljs-string">"a"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x82"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"1.2.643.2.2.19"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*GOST R34.10-2001 */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2A\x85\x03\x02\x02\x13"</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_ECC, <span class="hljs-string"><span class="hljs-string">"ecc"</span></span>, <span class="hljs-string"><span class="hljs-string">"a"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x80"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"1.2.643.7.1.1.1.1"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*GOST R34.10-2012-256 */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2A\x85\x03\x07\x01\x01\x01\x01"</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_ECC, <span class="hljs-string"><span class="hljs-string">"ecc"</span></span>, <span class="hljs-string"><span class="hljs-string">"a"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x80"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"1.2.643.7.1.1.1.2"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*GOST R34.10-2012-512 */</span></span> <span class="hljs-string"><span class="hljs-string">"\x2A\x85\x03\x07\x01\x01\x01\x02"</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, PKALGO_ECC, <span class="hljs-string"><span class="hljs-string">"ecc"</span></span>, <span class="hljs-string"><span class="hljs-string">"a"</span></span>, <span class="hljs-string"><span class="hljs-string">"\x80"</span></span> }, {<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>} };</code> </pre> <br>  Maintenant que nous avons d√©cid√© de l'oid, passons √† la structure de stockage de la cl√© publique dans le certificat.  En g√©n√©ral, la structure SubjectPublicKeyInfo dans un certificat a la forme suivante: <br><blockquote><pre> <code class="plaintext hljs">SubjectPublicKeyInfo ::= SEQUENCE { algorithm OBJECT IDENTIFIER GostR3410-2001/2012-PublicKeyParameters ::= SEQUENCE { publicKeyParamSet OBJECT IDENTIFIER, digestParamSet OBJECT IDENTIFIER, encryptionParamSet OBJECT IDENTIFIER } subjectKey BIT STRING }</code> </pre> </blockquote>  Le param√®tre publicKeyParamSet sp√©cifie l'oid du point de la courbe elliptique.  Les points OID des points autoris√©s sont enregistr√©s dans la structure struct curve_aliases [] du fichier ecc_curves.c de la biblioth√®que libgcrypt.  Dans la biblioth√®que libksba, ces oid-s sont enregistr√©s dans la structure struct curve_names [] du fichier keyinfo.c.  Dans cette structure, les ¬´1.2.643.2.2.36.0¬ª (GOST2001-CryptoPro-XchA) et ¬´1.2.643.2.2.36.1¬ª (GOST2001-CryptoPro-XchB) sont omis.  Nous ajoutons ces oids, mais en tenant compte du fait que l'oid "1.2.643.2.2.36.0" est en fait un point avec l'oid "1.2.643.2.2.35.1", et "1.2.643.2.2.36.1" correspond √† oid "1.2.643.2.2.35.3": <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *oid; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *name; } curve_names[] = { { <span class="hljs-string"><span class="hljs-string">"1.3.6.1.4.1.3029.1.5.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"Curve25519"</span></span> }, . . . { <span class="hljs-string"><span class="hljs-string">"1.2.643.2.2.35.3"</span></span>, <span class="hljs-string"><span class="hljs-string">"GOST2001-CryptoPro-C"</span></span> }, <span class="hljs-comment"><span class="hljs-comment">/* oid-*/</span></span> <span class="hljs-comment"><span class="hljs-comment">// "GOST2001-CryptoPro-XchA" { "1.2.643.2.2.36.0", "GOST2001-CryptoPro-A" }, // "GOST2001-CryptoPro-XchB" { "1.2.643.2.2.36.1", "GOST2001-CryptoPro-C" }, . . . }</span></span></code> </pre> <br>  Le param√®tre encryptionParamSet est g√©n√©ralement omis.  Le param√®tre digestParamSet peut √©galement √™tre omis: le type de la cl√© GOST d√©termine uniquement l'oid digestParamSet. <br><br>  Le code qui extrait la cl√© publique GOST du certificat, l'analyse et l'int√®gre dans une variable S est ajout√© √† la fonction _ksba_keyinfo_to_sexp (fichier keyinfo.c), et le code charg√© de compresser la signature GOST dans une variable S est ajout√© √† la fonction crypt_val_to_sexp.  Le code est fourni avec des commentaires et ne n√©cessite pas d'explications suppl√©mentaires.  Nous avons parl√© des fonctionnalit√©s de stockage de la cl√© publique et de la signature dans le certificat dans un article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©c√©dent</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Le patch pour le fichier keyinfo.c est ici:</b> <div class="spoiler_text"><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- keyinfo_ORIG.c 2015-10-28 13:41:48.000000000 +0300 +++ keyinfo.c 2018-06-29 10:22:38.312284306 +0300 @@ -45,7 +45,6 @@ #include "convert.h" #include "ber-help.h" - /* Constants used for the public key algorithms. */ typedef enum { @@ -98,6 +97,19 @@ "1.2.840.10045.2.1", /* ecPublicKey */ "\x2a\x86\x48\xce\x3d\x02\x01", 7, 1, PKALGO_ECC, "ecc", "q", "\x80" }, +/*oid- - */ + { /* GOST3410-2001 */ + "1.2.643.2.2.19", /* gostPublicKey-2001 */ + "\x2a\x85\x03\x02\x02\x13", 6, + 1, PKALGO_ECC, "ecc", "q", "\x80" }, + { /* GOST3410-2012-256 */ + "1.2.643.7.1.1.1.1", /* gostPublicKey-2012-256 */ + "\x2a\x85\x03\x07\x01\x01\x01\x01", 8, + 1, PKALGO_ECC, "ecc", "q", "\x80" }, + { /* GOST3410-2012-512 */ + "1.2.643.7.1.1.1.2", /* gostPublicKey-2012-512 */ + "\x2a\x85\x03\x07\x01\x01\x01\x02", 8, + 1, PKALGO_ECC, "ecc", "q", "\x80" }, {NULL} }; @@ -209,6 +221,32 @@ "1.3.36.3.4.3.2.2", /* sigS_ISO9796-2rndWithrsa_ripemd160 */ "\x2B\x24\x03\x04\x03\x02\x02", 7, 0, PKALGO_RSA, "rsa", "s", "\x82", NULL, NULL, "rmd160" }, +/*oid-,   - */ + { /* GOST3410-2001 */ + "1.2.643.2.2.19", /* gostPublicKey-2001 */ + "\x2a\x85\x03\x02\x02\x13", 6, + 1, PKALGO_ECC, "gost", "s", "\x80", NULL, NULL, "gostr3411_94" }, + { /* GOST3410-2012-256 */ + "1.2.643.7.1.1.1.1", /* gostPublicKey-2012-256 */ + "\x2a\x85\x03\x07\x01\x01\x01\x01", 8, + 1, PKALGO_ECC, "gost", "s", "\x80", NULL, NULL, "stribog256"}, + { /* GOST3410-2012-512 */ + "1.2.643.7.1.1.1.2", /* gostPublicKey-2012-512 */ + "\x2a\x85\x03\x07\x01\x01\x01\x02", 8, + 1, PKALGO_ECC, "gost", "s", "\x80", NULL, NULL, "stribog512"}, + + { /* GOST3411-2012-256 */ + "1.2.643.7.1.1.3.2", /* STRIBOG256 */ + "\x2a\x85\x03\x07\x01\x01\x03\x02", 8, + 1, PKALGO_ECC, "gost", "s", "\x80", NULL, NULL, "stribog256" }, + { /* GOST3411-2012-512 */ + "1.2.643.7.1.1.3.3", /* STRIBOG512 */ + "\x2a\x85\x03\x07\x01\x01\x03\x03", 8, + 1, PKALGO_ECC, "gost", "s", "\x80", NULL, NULL, "stribog512" }, + { /* GOST3410-2001-Signature */ + "1.2.643.2.2.3", /* gosrPublicKey-2001 avec signature */ + "\x2a\x85\x03\x02\x02\x03", 6, + 1, PKALGO_ECC, "gost", "s", "\x80", NULL, NULL, "gostr3411_94" }, {NULL} }; @@ -218,6 +256,20 @@ "1.2.840.113549.1.1.1", /* rsaEncryption (RSAES-PKCA1-v1.5) */ "\x2A\x86\x48\x86\xF7\x0D\x01\x01\x01", 9, 1, PKALGO_RSA, "rsa", "a", "\x82" }, +/*oid- -    */ + { + "1.2.643.2.2.19", /*GOST R34.10-2001 */ + "\x2A\x85\x03\x02\x02\x13", 6, + 1, PKALGO_ECC, "ecc", "a", "\x80" }, + { + "1.2.643.7.1.1.1.1", /*GOST R34.10-2012-256 */ + "\x2A\x85\x03\x07\x01\x01\x01\x01", 8, + 1, PKALGO_ECC, "ecc", "a", "\x80" }, + { + "1.2.643.7.1.1.1.2", /*GOST R34.10-2012-512 */ + "\x2A\x85\x03\x07\x01\x01\x01\x02", 8, + 1, PKALGO_ECC, "ecc", "a", "\x80" }, + {NULL} }; @@ -267,6 +319,13 @@ { "1.2.643.2.2.35.1", "GOST2001-CryptoPro-A" }, { "1.2.643.2.2.35.2", "GOST2001-CryptoPro-B" }, { "1.2.643.2.2.35.3", "GOST2001-CryptoPro-C" }, +/* oid-       34.10-2001/2012*/ +// "GOST2001-CryptoPro-XchA" + { "1.2.643.2.2.36.0", "GOST2001-CryptoPro-A" }, +// "GOST2001-CryptoPro-XchB" + { "1.2.643.2.2.36.1", "GOST2001-CryptoPro-C" }, + + { "1.2.643.7.1.2.1.2.1", "GOST2012-tc26-A" }, { "1.2.643.7.1.2.1.2.2", "GOST2012-tc26-B" }, @@ -393,7 +452,8 @@ /* get the object identifier */ if (!derlen) return gpg_error (GPG_ERR_INV_KEYINFO); - c = *der++; derlen--; + c = *der++; + derlen--; if ( c != 0x06 ) return gpg_error (GPG_ERR_UNEXPECTED_TAG); /* not an OBJECT IDENTIFIER */ TLV_LENGTH(der); @@ -418,6 +478,7 @@ if (!derlen) return gpg_error (GPG_ERR_INV_KEYINFO); c = *der++; derlen--; + if ( c == 0x05 ) { /*printf ("parameter: NULL \n"); the usual case */ @@ -471,6 +532,7 @@ else { /* printf ("parameter: with tag %02x - ignored\n", c); */ + TLV_LENGTH(der); seqlen -= der - startparm; /* skip the value */ @@ -692,6 +754,9 @@ const unsigned char *ctrl; const char *elem; struct stringbuf sb; +/*XXXXX*/ + int gost_key; + char *parm_oid_hash = NULL; *r_string = NULL; @@ -701,6 +766,7 @@ c = *der++; derlen--; if ( c != 0x30 ) return gpg_error (GPG_ERR_UNEXPECTED_TAG); /* not a SEQUENCE */ + TLV_LENGTH(der); /* and now the inner part */ err = get_algorithm (1, der, derlen, &amp;nread, &amp;off, &amp;len, &amp;is_bitstr, @@ -715,13 +781,36 @@ &amp;&amp; !memcmp (der+off, pk_algo_table[algoidx].oid, len)) break; } + if (!pk_algo_table[algoidx].oid) return gpg_error (GPG_ERR_UNKNOWN_ALGORITHM); if (!pk_algo_table[algoidx].supported) return gpg_error (GPG_ERR_UNSUPPORTED_ALGORITHM); +/*   1 - - */ + gost_key = !memcmp(pk_algo_table[algoidx].oidstring, "1.2.643", 7); if (parm_off &amp;&amp; parm_len &amp;&amp; parm_type == TYPE_OBJECT_ID) parm_oid = ksba_oid_to_str (der+parm_off, parm_len); + else +/*  - */ + if (parm_off &amp;&amp; parm_len &amp;&amp; parm_type == TYPE_SEQUENCE &amp;&amp; gost_key &amp;&amp; (*(der+parm_off + off - 2) == TYPE_OBJECT_ID)){ +/* oid curve  -*/ + int len_hash; + int len_curve; + unsigned char* addr_hash; + unsigned char* addr_curve; + len_curve = (int) *(der+parm_off + off -1); + addr_curve = der+parm_off + off; + parm_oid = ksba_oid_to_str (addr_curve, len_curve); +/* oid   -*/ + if( *(addr_curve + len_curve)== TYPE_OBJECT_ID) { + len_hash = (unsigned int) *(der+parm_off + off + len_curve + 1); + addr_hash = addr_curve + len_curve + 2; + parm_oid_hash = ksba_oid_to_str (addr_hash, len_hash); + } +/* oid    -*/ + } + else if (parm_off &amp;&amp; parm_len) { parmder = der + parm_off; @@ -762,6 +851,13 @@ put_stringbuf_sexp (&amp;sb, "curve"); put_stringbuf_sexp (&amp;sb, parm_oid); put_stringbuf (&amp;sb, ")"); +/* oid-  - */ + if(gost_key &amp;&amp; parm_oid_hash) { + put_stringbuf (&amp;sb, "("); + put_stringbuf_sexp (&amp;sb, "hash"); + put_stringbuf_sexp (&amp;sb, parm_oid_hash); + put_stringbuf (&amp;sb, ")"); + } } /* If parameters are given and we have a description for them, parse @@ -851,6 +947,43 @@ put_stringbuf (&amp;sb, "("); tmp[0] = *elem; tmp[1] = 0; put_stringbuf_sexp (&amp;sb, tmp); +/*        TK-26*/ + if(gost_key){ + unsigned char pk[129]; + unsigned char *x; + unsigned char *y; + int len_pk; + int len_xy; + int i; + unsigned char c_inv; + int offset; + pk[0] = 0x04; + if(len == 131 || len == 66){ + offset = 0; + if(der[0] == 0x04 &amp;&amp; der[1] &amp; 0x80) + offset = 3; + else if(der[0] == 0x04 &amp;&amp; der[1] &amp; 0x40) + offset = 2; + len_pk = len - offset; + memcpy(&amp;pk[1], der + offset, len_pk); + x = &amp;pk[1]; + len_xy = len_pk / 2; + y = x + len_xy; +/*REVERT-INVERTIROVANIE*/ + for (i = 0; i &lt; (len_xy/2); i++) { + c_inv = *(x + i); + *(x + i) = *(x + len_xy - i - 1); + *(x + len_xy - i - 1) = c_inv; + } + for (i = 0; i &lt; (len_xy/2); i++) { + c_inv = y[i]; + y[i] = y[len_xy - i -1]; + y[len_xy - i - 1] = c_inv; + } + put_stringbuf_mem_sexp (&amp;sb, pk , len_pk + 1); + } + } else + put_stringbuf_mem_sexp (&amp;sb, der, len); der += len; derlen -= len; @@ -1606,6 +1739,8 @@ const unsigned char *ctrl; const char *elem; struct stringbuf sb; +/*XXXXX*/ + int gost_sign; /* FIXME: The entire function is very similar to keyinfo_to_sexp */ *r_string = NULL; @@ -1615,7 +1750,6 @@ else algo_table = enc_algo_table; - err = get_algorithm (1, der, derlen, &amp;nread, &amp;off, &amp;len, &amp;is_bitstr, NULL, NULL, NULL); if (err) @@ -1628,11 +1762,16 @@ &amp;&amp; !memcmp (der+off, algo_table[algoidx].oid, len)) break; } + if (!algo_table[algoidx].oid) return gpg_error (GPG_ERR_UNKNOWN_ALGORITHM); + if (!algo_table[algoidx].supported) return gpg_error (GPG_ERR_UNSUPPORTED_ALGORITHM); +/*    oid-*/ + gost_sign = !memcmp(algo_table[algoidx].oidstring, "1.2.643", 7); + der += nread; derlen -= nread; @@ -1682,8 +1821,22 @@ put_stringbuf (&amp;sb, "("); tmp[0] = *elem; tmp[1] = 0; +/*   ,  r  ,  s   */ + if(gost_sign == 1 &amp;&amp; algo_table == sig_algo_table){ + put_stringbuf_sexp (&amp;sb, "r"); + put_stringbuf_mem_sexp (&amp;sb, der+(len/2), len/2); + put_stringbuf (&amp;sb, ")"); + put_stringbuf (&amp;sb, "("); + put_stringbuf_sexp (&amp;sb, "s"); + put_stringbuf_mem_sexp (&amp;sb, der, len/2); + } + else{ + put_stringbuf_sexp (&amp;sb, tmp); put_stringbuf_mem_sexp (&amp;sb, der, len); +/* */ + } + der += len; derlen -= len; put_stringbuf (&amp;sb, ")");</span></span></code> </pre><br></div></div><br>  Enregistrez-le dans le fichier diff_keyinfo.patch et appliquez-le au fichier keyinfo.c: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$patch</span></span> keyinfo.c &lt; diff_keyinfo.patch $</code> </pre> <br>  Apr√®s avoir ajout√© ces correctifs, vous pouvez cr√©er la biblioth√®que.  Si vous n'allez pas installer la biblioth√®que libksba.so.8.11.6 assembl√©e dans le syst√®me, mais que vous ne l'utiliserez qu'√† des fins de test, il est pratique de la copier dans le r√©pertoire dans lequel les cas de test seront collect√©s.  Ces correctifs sont suffisants pour analyser des certificats avec des cl√©s GOST, ainsi que des documents sign√©s avec des cl√©s GOST au format PKCS # 7, et extraire et v√©rifier la validit√© math√©matique de la signature √©lectronique du certificat X509 ou de la signature √©lectronique du document PKCS # 7 / CMS. <br><br>  Pour tester cela, consid√©rez deux modules logiciels.  Le premier module check_cert v√©rifie que le certificat est sign√© correctement et le deuxi√®me module check_cms_signed v√©rifie l'int√©grit√© du document sign√© (CMS / PKCS # 7) et l'exactitude de la signature du document.  Rappelons que la validit√© du certificat est d√©termin√©e non seulement par l'exactitude de sa signature, mais √©galement par sa validit√© (non-rappel) au moment de la v√©rification.  De la m√™me mani√®re, la validit√© d'une signature sous un document est d√©termin√©e non seulement par la fiabilit√© math√©matique de la signature, mais √©galement par la validit√© du certificat signataire. <br><br><img src="https://habrastorage.org/webt/_x/ka/k2/_xkak2cjlx-e6zisd53wa4oqt5w.png" alt="image" align="left">  Pour cr√©er un document sign√© au format PKCS # 7, vous pouvez utiliser l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">guinss.exe</a> √©crit en Python avec Tkinter et utiliser des jetons PKCS # 11 avec prise en charge de la cryptographie russe comme moyen de protection des informations cryptographiques (SKZI): <br><br><img src="https://habrastorage.org/webt/y-/ab/wt/y-abwtfbzl4gn49vmxsz9gyfn0m.png"><br><br>  Nous notons √©galement que le format PKCS # 7 envisag√© pour la signature √©lectronique du document implique l'inclusion d'un signataire dans la signature.  Ceci est fait pour que l'exemple ne devienne pas immense. <br><br><div class="spoiler">  <b class="spoiler_title">Le code source de l'utilitaire de v√©rification de signature de certificat check_cert.c est donn√© ici:</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;assert.h&gt; #include &lt;errno.h&gt; #include &lt;ctype.h&gt; #include &lt;gcrypt.h&gt; #include &lt;ksba.h&gt; /* Hash function used with libksba. */ #define HASH_FNC ((void (*)(void *, const void*,size_t))gcry_md_write) /*  S-*/ static void show_sexp (const char *prefix, gcry_sexp_t a) { char *buf; size_t size; if (prefix) fputs (prefix, stderr); size = gcry_sexp_sprint (a, GCRYSEXP_FMT_ADVANCED, NULL, 0); buf = gcry_xmalloc (size); gcry_sexp_sprint (a, GCRYSEXP_FMT_ADVANCED, buf, size); fprintf (stderr, "%.*s", (int)size, buf); gcry_free (buf); } /*    */ static gpg_error_t check_cert_sig (ksba_cert_t issuer_cert, ksba_cert_t cert) { gpg_error_t err; const char *algoid; gcry_md_hd_t md; int i, algo; ksba_sexp_t p; size_t n; /*     : S_PKEY - S-   . S_SIG - S-   S_HASH - S-     tbs- */ gcry_sexp_t s_sig, s_hash, s_pkey; const char *s; char algo_name[16+1]; /* hash algorithm name converted to lower case. */ int digestlen; unsigned char *digest; int gost_key; /* Hash the target certificate using the algorithm from that certificate. */ algoid = ksba_cert_get_digest_algo (cert); algo = gcry_md_map_name (algoid); if (!algo) { fprintf(stderr, "unknown hash algorithm `%s'\n", algoid? algoid:"?"); return (-1); } /*  */ gost_key = !memcmp(algoid, "1.2.643", 7); s = gcry_md_algo_name (algo); for (i=0; *s &amp;&amp; i &lt; sizeof algo_name - 1; s++, i++) algo_name[i] = tolower (*s); algo_name[i] = 0; err = gcry_md_open (&amp;md, algo, 0); if (err) { fprintf(stderr, "md_open failed: %s\n", algoid); return err; } err = ksba_cert_hash (cert, 1, HASH_FNC, md); if (err) { fprintf(stderr, "ksba_cert_hash failed: %s\n", algoid); gcry_md_close (md); return err; } gcry_md_final (md); /*     */ p = ksba_cert_get_sig_val (cert); /*   */ n = gcry_sexp_canon_len (p, 0, NULL, NULL); if (!n) { gcry_md_close (md); ksba_free (p); return (-1); } /*   S-  libgcrypt*/ err = gcry_sexp_sscan ( &amp;s_sig, NULL, p, n); ksba_free (p); if (err) { fprintf(stderr, "gcry_sexp_scan failed: %s\n", "Beda"); gcry_md_close (md); return err; } /* S- */ show_sexp ("Sig value:\n", s_sig); /*      */ p = ksba_cert_get_public_key (issuer_cert); n = gcry_sexp_canon_len (p, 0, NULL, NULL); if (!n) { fprintf(stderr, "libksba did not return a proper S-Exp\n"); gcry_md_close (md); ksba_free (p); gcry_sexp_release (s_sig); return (-1); } err = gcry_sexp_sscan ( &amp;s_pkey, NULL, p, n); ksba_free (p); if (err) { fprintf(stderr, "gcry_sexp_scan failed: %s\n", "pubkey"); gcry_md_close (md); gcry_sexp_release (s_sig); return err; } /* S-   */ show_sexp ("s_pkey:\n", s_pkey); digestlen = gcry_md_get_algo_dlen (algo); digest = gcry_md_read (md, algo); if (gost_key){ unsigned char *h; unsigned char c; int len_xy; /*   littlt-endian  big-endian*/ unsigned short arch = 1; /* 0x0001 */ h = digest; len_xy = *((unsigned char *) &amp;arch) == 0 ? 0:gcry_md_get_algo_dlen (algo); /* */ for (i = 0; i &lt; (len_xy/2); i++) { c = *(h + i); *(h + i) = *(h + len_xy - i - 1); *(h + len_xy - i - 1) = c; } } switch (gost_key) { case 0: if ( gcry_sexp_build (&amp;s_hash, NULL, "(data(flags pkcs1)(hash %s %b))", algo_name, (int)digestlen, digest) ) { exit (1); } break; case 1: if ( gcry_sexp_build (&amp;s_hash, NULL, "(data(flags gost)(value %b))", (int)digestlen, digest) ) { exit (1); } break; default: exit (1); } /* S-   tbs-*/ show_sexp ("s_hash:\n", s_hash); /* */ err = gcry_pk_verify (s_sig, s_hash, s_pkey); /* */ gcry_md_close (md); gcry_sexp_release (s_sig); gcry_sexp_release (s_hash); gcry_sexp_release (s_pkey); return err; } int main (int argc, unsigned char *argv[]) { FILE *fp; ksba_reader_t r; ksba_cert_t cert; FILE *fp_ca; ksba_reader_t r_ca; ksba_cert_t cert_ca; gpg_error_t err; unsigned char *sub_dn; if(argc != 3) { fprintf(stderr, "Usage: check_cert &lt; &gt; &lt; &gt;\n"); exit(1); } fp = fopen (argv[1], "rb"); if (!fp) { fprintf (stderr, "check_cert: can't open `%s'\n", argv[1]); exit (1); } err = ksba_reader_new (&amp;r); if (err) { fprintf(stderr, "ksba_reader_new error\n"); exit(1); } err = ksba_reader_set_file (r, fp); if (err) { fprintf(stderr, "ksba_reader_set error\n"); exit(1); } err = ksba_cert_new (&amp;cert); if (err){ fprintf(stderr, "ksba_cert_new error\n"); exit(1); } err = ksba_cert_read_der (cert, r); if (err){ fprintf(stderr, "ksba_cert_read_der error\n"); exit(1); } fp_ca = fopen (argv[2], "rb"); if (!fp_ca) { fprintf (stderr, "check_cert: can't open `%s'\n", argv[2]); exit (1); } err = ksba_reader_new (&amp;r_ca); if (err) { fprintf(stderr, "ksba_reader_new error\n"); exit(1); } err = ksba_reader_set_file (r_ca, fp_ca); if (err) { fprintf(stderr, "ksba_reader_set error\n"); exit(1); } err = ksba_cert_new (&amp;cert_ca); if (err){ fprintf(stderr, "ksba_cert_new error\n"); exit(1); } err = ksba_cert_read_der (cert_ca, r_ca); if (err){ fprintf(stderr, "ksba_cert_read_der error\n"); exit(1); } sub_dn = ksba_cert_get_subject (cert, 0); fprintf(stderr, "check_cert: Verify %s\n", sub_dn); err = check_cert_sig (cert_ca, cert); if (err) { fprintf(stderr, "check_cert: verify %s error\n", argv[1]); } else { fprintf(stderr, "check_cert: verify %s Ok\n", argv[1]); } }</span></span></span></span></code> </pre> <br></div></div><br>  Nous enregistrons le code dans le fichier check_cert.c, le traduisons et l'ex√©cutons: <br><br><pre> <code class="bash hljs">bash-4.3<span class="hljs-variable"><span class="hljs-variable">$ln</span></span> ‚Äìs libksba.so.8 lgcrypt libksba.so.8.11.6 bash-4.3$ cc -o check_cert check_cert.c -lgcrypt libksba.so.8.11.6 bash-4.3$ ./check_cert Usage: check_cert &lt; &gt; &lt; &gt; bash-4.3$</code> </pre> <br>  Ainsi, afin de v√©rifier le certificat, il est n√©cessaire d'avoir le certificat lui-m√™me et le certificat CA (par exemple, vous pouvez le prendre de l'article pr√©c√©dent) sur lequel il a √©t√© √©mis.  Les certificats doivent √™tre (pour l'instant) encod√©s en DER: <br><br><pre> <code class="bash hljs">bash-4.3$ ./check_cert CERT_CMS_KSBA.der CAcert_NEWCA.der check_cert: Verify SNILS=22222222222,INN=123456789012,O=CMS,STREET=PKCS7,L= ,ST=50  ,C=RU,GN=KSBA,SN=GCrypt,CN= GCrypt and KSBA,E=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>@test.ru Sig value: (sig-val (gost (r <span class="hljs-comment"><span class="hljs-comment">#FBD2976F7E63D792A695D4EB8D41F4880F43BB98108ABC313C1661380A1E480C54F96BBE611BA3D7ECB029E4C5685792D8D565AEA2E9AFD3AB660453C04EEC20#) (s #ACC68AC42AA2293A945E565C621AFF8F19AA5D5039D83D11D7125469DF068B1E0C4247A325CE031E9A9C31F55191CE4FB6528A11F0D81BE5463C38C30A2AD8AC#) ) (hash stribog512) ) s_pkey: (public-key (ecc (curve "1.2.643.7.1.2.1.2.1") (hash "1.2.643.7.1.1.2.3") (q #04C5BFDFB8481951FB19AE8631B27CD13979FAE1ED61910EF9E8A9EAC5D757503264C327C753D4E38E402434119806088E81E2C1D5FBD36FA43366BFE374367585DC6A79954EC97F796CF63CB2F23392050ECB50E147B80749927979057DD5CFD496A2C8A4367DDD0E0E92045147AB801EF177C3EB441979A2757377E982E93314#) ) ) s_hash: (data (flags gost) (value #B2507D0208DB58DE0FA9EF6E4A2EDD07E86BAD313C2A0546C786FD5CF16A515DF28A1B40149F95570A8943922D1C6CFDD781727070034FEC799C1EEB6611EBA0#) ) check_cert: verify CERT_CMS_KSBA.der Ok bash-4.3$</span></span></code> </pre> <br>  Pour v√©rifier un certificat auto-sign√©, ce dernier est indiqu√© √† la fois comme certificat v√©rifi√© et comme certificat racine: <br><br><pre> <code class="bash hljs">bash-4.3$ ./check_cert CAcert_NEWCA.der CAcert_NEWCA.der check_cert: Verify E=info@ooo.ru,CN= ,OU= 2,O= ,C=RU,ST= ,L=.  . . . check_cert: verify CAcert_NEWCA.der Ok bash-4.3$</code> </pre> <br>  Nous avons donc un utilitaire simple pour v√©rifier la signature des certificats. <br><br>  V√©rifier la signature √©lectronique des documents au format PKCS # 7 d√©velopp√© <br><br><div class="spoiler">  <b class="spoiler_title">utilitaire de test check_cms_signed.c:</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;assert.h&gt; #include &lt;time.h&gt; #include &lt;errno.h&gt; #include &lt;ksba.h&gt; //#include "t-common.h" #include &lt;gcrypt.h&gt; #include &lt;sys/stat.h&gt; #include &lt;sys/types.h&gt; #include &lt;fcntl.h&gt; #include &lt;unistd.h&gt; /* Hash function used with libksba. */ #define HASH_FNC ((void (*)(void *, const void*,size_t))gcry_md_write) void dump_isotime (const ksba_isotime_t t) { if (!t || !*t) fprintf (stderr, "[none]"); else fprintf (stderr,"%.4s-%.2s-%.2s %.2s:%.2s:%s", t, t+4, t+6, t+9, t+11, t+13); } static void show_sexp (const char *prefix, gcry_sexp_t a) { char *buf; size_t size; if (prefix) fputs (prefix, stderr); size = gcry_sexp_sprint (a, GCRYSEXP_FMT_ADVANCED, NULL, 0); buf = gcry_xmalloc (size); gcry_sexp_sprint (a, GCRYSEXP_FMT_ADVANCED, buf, size); fprintf (stderr, "%.*s", (int)size, buf); gcry_free (buf); } void dummy_hash_fnc (void *arg, const void *buffer, size_t length) { (void)arg; (void)buffer; (void)length; } static int dummy_writer_cb (void *cb_value, const void *buffer, size_t count) { (void)cb_value; (void)buffer; (void)count; return 0; } /*   */ unsigned char *dgst_file (char *oid, char* fcont, int *len_h) { gcry_md_hd_t hd; gcry_error_t err; int algo; FILE *fp; unsigned char buf[1024]; size_t size; int i; unsigned char *h; unsigned char *ret_h; algo = gcry_md_map_name (oid); if (algo == GCRY_MD_NONE) return NULL; err = gcry_md_open(&amp;hd, algo, 0); if (err) return NULL; fp = fopen (fcont, "r"); if (fp == NULL) return NULL; while (!feof (fp)) { size = fread (buf, 1, sizeof(buf), fp); gcry_md_write (hd, buf, size); } h = gcry_md_read(hd, 0); *len_h = gcry_md_get_algo_dlen (algo); ret_h = malloc(*len_h); memcpy(ret_h, h, *len_h); gcry_md_reset(hd); gcry_md_close(hd); return ret_h; } gcry_error_t one_file (const char *fname, char *fcontent, char *fcert) { gcry_error_t err; FILE *fp; ksba_reader_t r; ksba_writer_t w; ksba_cms_t cms; int i; const char *algoid; ksba_stop_reason_t stopreason; const char *s = NULL; size_t n; ksba_sexp_t p; char *dn; int idx; ksba_cert_t cert; int ii; unsigned char *cert_der; int cert_der_len; int f_der; int rez; ksba_sexp_t p1; size_t n1; gcry_sexp_t s_sig, s_hash, s_pkey, s_num; int gost_key; gcry_md_hd_t md; int rc; int digestlen; unsigned char *digest; gcry_md_hd_t data_md = NULL; ksba_isotime_t sigtime; unsigned char *sub_dn; //dn -  char *is_dn; //dn -   ksba_sexp_t sub_p; //  fprintf (stderr, "\n*** checking `%s' ***\n", fname); fp = fopen (fname, "r"); if (!fp) { fprintf (stderr, "can't open `%s'\n", fname); exit (1); } err = ksba_reader_new (&amp;r); if (err) { fprintf (stderr, "can't reader `%s'\n", fname); exit (1); } err = ksba_reader_set_file (r, fp); if (err) { fprintf (stderr, "can't reader set `%s'\n", fname); exit (1); } /* Also create a writer so that cms.c won't return an error when writing processed content. */ err = ksba_writer_new (&amp;w); if (err) { exit (1); } err = ksba_writer_set_cb (w, dummy_writer_cb, NULL); if (err) { exit (1); } switch (ksba_cms_identify (r)) { case KSBA_CT_SIGNED_DATA: s = "signed data"; break; case KSBA_CT_DATA: s = "data"; case KSBA_CT_ENVELOPED_DATA: if (s == NULL) s = "enveloped data"; case KSBA_CT_DIGESTED_DATA: if (s == NULL) s = "digested data"; case KSBA_CT_ENCRYPTED_DATA: if (s == NULL) s = "encrypted data"; case KSBA_CT_AUTH_DATA: if (s == NULL) s = "auth data"; default: if (s == NULL) s = "unknown"; printf ("identified as: %s\n", s); exit(1); } err = ksba_cms_new (&amp;cms); if (err) { exit(1); } err = ksba_cms_set_reader_writer (cms, r, w); if (err) { exit(1); } rc = gcry_md_open (&amp;data_md, 0, 0); if (rc) { fprintf (stderr, "md_open failed: \n"); exit(1);; } err = ksba_cms_parse (cms, &amp;stopreason); if (err) { fprintf (stderr, "ksba_cms_parse: cannot parse %s\n", fname); exit(1); } ksba_cms_set_hash_function (cms, dummy_hash_fnc, NULL); do { err = ksba_cms_parse (cms, &amp;stopreason); if (err) { fprintf (stderr, "ksba_cms_parse: cannot parse %s\n", fname); exit(1); } } while (stopreason != KSBA_SR_READY); /*  PKCS7  */ cert_der_len = 0; for (ii=0; (cert=ksba_cms_get_cert (cms, ii)); ii++) { cert_der = (unsigned char*)ksba_cert_get_image(cert, (size_t *)&amp;cert_der_len); f_der = open(fcert, O_RDWR|O_TRUNC|O_CREAT, 0666); if (f_der == -1) { fprintf(stderr, "Bad open file=%s for cert\n", cert_der_len, fcert); exit(1); } /*    */ rez = write(f_der, cert_der, cert_der_len); close(f_der); /*      */ p1 = ksba_cert_get_public_key (cert); n1 = gcry_sexp_canon_len (p1, 0, NULL, NULL); if (!n1) { fprintf(stderr, "libksba did not return a proper S-Exp\n"); exit(1); } err = gcry_sexp_sscan ( &amp;s_pkey, NULL, p1, n1); ksba_free (p1); if (err) { fprintf(stderr, "gcry_sexp_scan failed: %s\n", "pubkey"); exit(1); } /*   DN  */ sub_dn = ksba_cert_get_subject (cert, 0); ksba_cert_release (cert); } for (idx=0; idx &lt; 1; idx++) { int algo; int info_pkalgo; unsigned char *s; int s_len; int len_h; unsigned char *dgst_h; /*  /PKCS#7 DN    is_dn      sub_p*/ /*       */ /*     ,       PKCS#7*/ err = ksba_cms_get_issuer_serial (cms, idx, &amp;is_dn, &amp;sub_p); if (err) { fprintf (stderr, "ksba_cms_get_issuer_serial cannot %s\n", fname); exit(1); } /*  */ algoid = ksba_cms_get_digest_algo (cms, idx); err = ksba_cms_get_sigattr_oids (cms, 0, "1.2.840.113549.1.7.1",&amp;dn); if (err &amp;&amp; err != -1) { fprintf (stderr, "ksba_cms_get_sigattr_oids cannot %s err=%d\n", fname, err); exit(1); } algo = gcry_md_map_name (algoid); /*   - (1)  */ gost_key = !memcmp(algoid, "1.2.643", 7); gcry_md_enable (data_md, algo); rc = gcry_md_open (&amp;md, algo, 0); if (rc) { fprintf(stderr, "md_open failed:\n"); exit(1); } /* -*/ ksba_cms_set_hash_function (cms, HASH_FNC, data_md); /*    */ rc = ksba_cms_hash_signed_attrs (cms, idx); if (rc) { fprintf(stderr, "hashing signed attrs failed: \n"); gcry_md_close (md); continue; } gcry_md_final (md); digestlen = gcry_md_get_algo_dlen (algo); /*  */ digest = gcry_md_read (data_md, algo); gcry_md_close (md); if (gost_key){ /*   */ unsigned char *h; unsigned char c; int len_xy; /*   littlt-endian  big-endian*/ unsigned short arch = 1; /* 0x0001 */ h = digest; len_xy = *((unsigned char *) &amp;arch) == 0 ? 0:gcry_md_get_algo_dlen (algo); /* */ for (i = 0; i &lt; (len_xy/2); i++) { c = *(h + i); *(h + i) = *(h + len_xy - i - 1); *(h + len_xy - i - 1) = c; } } switch (gost_key) { case 0: if ( gcry_sexp_build (&amp;s_hash, NULL, "(data(flags pkcs1)(hash %s %b))", algoid, (int)digestlen, digest) ) { fprintf(stderr, "BUG\n"); exit (1); } break; case 1: /* ,  S-   */ if ( gcry_sexp_build (&amp;s_hash, NULL, "(data(flags gost)(value %b))", (int)digestlen, digest) ) { exit (1); } break; default: exit (1); } /*   */ rc = ksba_cms_get_signing_time (cms, idx, sigtime); if (rc) { fprintf(stderr, "error getting signing time\n"); // *sigtime = 0; /* (we can't encode an error in the time string.) */ exit(1); } /*       PKCS#7 */ err = ksba_cms_get_message_digest (cms, idx, &amp;dn, &amp;n); if (err) { fprintf (stderr, "ksba_cms_get_message_digest cannot %s\n", fname); exit(1); } /*     */ dgst_h = dgst_file ((char *)algoid, (char *)fcontent, &amp;len_h); if (dgst_h == NULL) { fprintf(stderr, "\nBad digest %s\n", fcontent); exit (1); } if (memcmp(dgst_h, dn, n)) { /* :  ,     ,    ..*/ fprintf(stderr, "\nBad content %s\n", fcontent); exit (1); } ksba_free (dn); putchar ('\n'); dn = ksba_cms_get_sig_val (cms, idx); if (!dn) { printf ("signer %d - signature not found\n", idx); exit(1); } n = gcry_sexp_canon_len ((ksba_sexp_t)dn, 0, NULL, NULL); if (!n){ fprintf(stderr, "libksba did not return a proper S-Exp\n"); exit(1); } err = gcry_sexp_sscan ( &amp;s_sig, NULL, dn, n); if (err){ fprintf(stderr, "gcry_sexp_scan failed: %s\n", "Beda"); exit(1); } ksba_free (dn); } fprintf(stderr, "\n===========================================================\n"); if (*sigtime){ fprintf (stderr, "  :\n"); dump_isotime (sigtime); fprintf (stderr, "\n"); } else fprintf (stderr, "[date not given]\n"); fprintf(stderr, "\n : %s\n", sub_dn); fprintf(stderr, "\n : %s\n", is_dn); n = gcry_sexp_canon_len ((ksba_sexp_t)sub_p, 0, NULL, NULL); if (!n){ fprintf(stderr, "libksba did not return a proper S-Exp NUM\n"); exit(1); } err = gcry_sexp_sscan ( &amp;s_num, NULL, sub_p, n); show_sexp ("\n :\n", s_num); fprintf(stderr, "\n===========================================================\n"); /* */ err = gcry_pk_verify (s_sig, s_hash, s_pkey); // if(err) { show_sexp ("s_pkey:\n", s_pkey); show_sexp ("s_sig:\n", s_sig); show_sexp ("s_hash:\n", s_hash); // } ksba_cms_release (cms); ksba_reader_release (r); fclose (fp); return (err); } int main (int argc, char **argv) { gcry_error_t err; unsigned char *h; int *len_h; if(argc != 4) { fprintf(stderr, "Usage: check_cms &lt; &gt; &lt; &gt; &lt;   &gt;\n"); exit(1); } err = one_file (argv[1], argv[2], argv[3]); if (err) { fprintf(stderr, "check_cms: verify %s error\n", argv[1]); } else { fprintf(stderr, "check_cms: verify %s Ok\n", argv[1]); fprintf(stderr, "check_cms:     %s\n", argv[3]); } exit (0); }</span></span></span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afin de simplifier l'exemple, il est √©crit en supposant que le document n'a qu'une seule signature (une signature) et son certificat est stock√© dans la signature. </font><font style="vertical-align: inherit;">Nous enregistrons l'utilitaire check_cms_signed.c, le traduisons et l'ex√©cutons:</font></font><br><br><pre> <code class="bash hljs">bash-4.3$ cc -o check_cms_signed check_cms_signed.c -lgcrypt libksba.so.8.11.6 bash-4.3$ ./check_cms_signed Usage: check_cms &lt; &gt; &lt; &gt; &lt;    &gt; bash-4.3$</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et maintenant, nous v√©rifions le fonctionnement de l'utilitaire: </font></font><br><br><pre> <code class="bash hljs">bash-4.3$ ./check_cms_signed test_cms_ksba.txt.p7s test_cms_ksba.txt save_cert.der *** checking `test_cms_ksba.txt.p7s<span class="hljs-string"><span class="hljs-string">' *** ===========================================================   : 2018-06-25 15:57:12  : SNILS=22222222222,INN=123456789012,O=CMS,STREET=PKCS7,L= ,ST=50  ,C=RU,GN=KSBA,SN=GCrypt,CN= GCrypt and KSBA,E=test@test.ru  : E=info@lissi.ru,CN= ,OU= 2,O= ,C=RU,ST= ,L=. ,STREET=.  .4 .7,OGRN=1234567890123,INN=123456789012  : (#73102E931BF9EA1369BA#) =========================================================== s_pkey: (public-key (ecc (curve "1.2.643.7.1.2.1.2.2") (hash "1.2.643.7.1.1.2.3") (q #044840A283684ECB537989536B9F080F7B914F3E6C153BC23F8A9212E303BF5B13905D29D0689CA5F2D0715D13FDC0FD387650193A7B46BE20C266776FAE36483750FE52A4C4E35EFB37EA64B48CB50ED5151289F59793574BD5FA59A2048A97FD94A1E5BB8DBF616B776D70C25774C1AC11CD6B6791D15850C37F7F176F49DBB6#) ) ) s_sig: (sig-val (gost (r #430C6EE1C0126F217B58EF5FB2E25055B2DF64AF0A1D769F2E7402145322ACD77B7D537B985AD7F3E3EDE94F9521D2F1E039B6F818B88D1CD709BE7BA97FE5E7#) (s #6A75146760E21BF6FA4CEDB41D37D938D5988DE048F9171796E764EC0E90891A7E02CA7F855C2468E11D217DB5C28DFAB1E31FF45793029FCDD666BE589F646A#) ) (hash stribog512) ) s_hash: (data (flags gost) (value #AD66AC68C832442C9520718AF9F67A87518CFE23098886C075F09DD19AC626DA65D7E39F6E0F81F5CF19C7DC5C3C9CC75FAD26A6C450ADD4C02FD31B49BA7CF1#) ) check_cms: verify test_cms_ksba.txt.p7s Ok check_cms:     save_cert.der bash-4.3$</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Si nous rempla√ßons / modifions le document √† signer, nous obtenons: </font></font><br><br><pre> <code class="bash hljs">bash-4.3$ ./check_cms_signed test_cms_ksba.txt.p7s test_cms_ksba_Change.txt save_cert.der *** checking `test_cms_ksba.txt.p7s<span class="hljs-string"><span class="hljs-string">' *** Bad content test_cms_ksba_Change.txt bash-4.3$</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une fois la v√©rification r√©ussie, le certificat du signataire sera enregistr√© dans &lt;O√π enregistrer le certificat du signataire </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; (dans l'exemple, il s'agit du fichier sace_cert.der). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le r√©sultat n'√©tait pas du tout une mauvaise utilit√©, qui peut √™tre utilis√© √† la fois dans la pratique et √† des fins √©ducatives. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais seulement un quart du chemin vers le but final a √©t√© parcouru. </font><font style="vertical-align: inherit;">En dehors de notre conversation, le travail avec des documents crypt√©s (PKCS # 7, VKO, KEK), la signature de documents, la cr√©ation de demandes de certificats est rest√©. </font><font style="vertical-align: inherit;">Le travail continue.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr415611/">https://habr.com/ru/post/fr415611/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr415595/index.html">M√©thodes pour augmenter la r√©tention des joueurs en utilisant les jeux SLOT comme exemple: Partie 1</a></li>
<li><a href="../fr415597/index.html">Postfix - amavisd-new sans localhost ni serveur de messagerie d'une nouvelle fa√ßon</a></li>
<li><a href="../fr415599/index.html">L'Inde veut √©galement obtenir de l'h√©lium-3</a></li>
<li><a href="../fr415601/index.html">Cluster Kubernetes HA avec containerd. Ou y a-t-il une vie sans docker?</a></li>
<li><a href="../fr415605/index.html">Comment nous avons √©conomis√© le traitement des cartes avec Exadata</a></li>
<li><a href="../fr415613/index.html">Pourquoi vous ne devriez pas acheter de lustres √† LED</a></li>
<li><a href="../fr415615/index.html">Interaction avec le serveur via l'API dans iOS sur Swift 3. Partie 2</a></li>
<li><a href="../fr415617/index.html">Utilisation de la biblioth√®que FPC InternetPCools dans Delphi</a></li>
<li><a href="../fr415619/index.html">Apple et Samsung terminent une guerre des brevets de 7 ans</a></li>
<li><a href="../fr415621/index.html">Syst√®me de surveillance mini√®re</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>