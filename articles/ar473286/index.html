<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ธ ๐ฉ๐ผโโ๏ธ ๐จโ๐ฆ ููุชุจ ุงูุญูุงูุฉ ุถุฏ ูุฌูุงุช DDoS ุนูู XDP. ุงูุฌุฒุก ุงููููู ๐ ๐จ ๐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุชุชูุญ ุชูููุฉ EXpress Data Path (XDP) ุงููุนุงูุฌุฉ ุงูุชุนุณููุฉ ูุญุฑูุฉ ุงููุฑูุฑ ุนูู ูุงุฌูุงุช Linux ูุจู ูุตูู ุงูุญุฒู ุฅูู ุญุฒูุฉ ุดุจูุฉ kernel. ุชุทุจูู XDP - ุงูุญูุงูุฉ ุถุฏ ูุฌูุงุช D...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ููุชุจ ุงูุญูุงูุฉ ุถุฏ ูุฌูุงุช DDoS ุนูู XDP. ุงูุฌุฒุก ุงููููู</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473286/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ุชุชูุญ ุชูููุฉ EXpress Data Path (XDP) ุงููุนุงูุฌุฉ ุงูุชุนุณููุฉ ูุญุฑูุฉ ุงููุฑูุฑ ุนูู ูุงุฌูุงุช Linux ูุจู ูุตูู ุงูุญุฒู ุฅูู ุญุฒูุฉ ุดุจูุฉ kernel.  ุชุทุจูู XDP - ุงูุญูุงูุฉ ุถุฏ ูุฌูุงุช DDoS (CloudFlare) ูุงููุฑุดุญุงุช ุงููุนูุฏุฉ ูุฌูุน ุงูุฅุญุตุงุฆูุงุช (Netflix).  ูุชู ุชูููุฐ ุจุฑุงูุฌ XDP ุจูุงุณุทุฉ ุงูุฌูุงุฒ ุงูุธุงูุฑู eBPF ุ ูุจุงูุชุงูู ุ ุชูุฌุฏ ูููุฏ ุนูู ูู ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ูุนูู ูุธุงุฆู kernel ุงููุชููุฑุฉ ุ ุงุนุชูุงุฏูุง ุนูู ููุน ุงูุชุตููุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุงูุบุฑุถ ูู ุงูููุงูุฉ ูู ุณุฏ ุฃูุฌู ุงููุตูุฑ ูู ุงูุนุฏูุฏ ูู ููุงุฏ XDP.  ุฃููุงู ุ ูููุฑูู ููุฏูุง ุฌุงูุฒูุง ูุชุฎุทู ุนูู ุงูููุฑ ููุฒุงุช XDP: ุชู ุฅุนุฏุงุฏู ููุชุญูู ุฃู ุจุณูุท ุฌุฏูุง ูู ุงูุชุณุจุจ ูู ุญุฏูุซ ูุดููุงุช.  ุนูุฏ ูุญุงููุฉ ูุชุงุจุฉ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูุฎุงุตุฉ ุจู ูู ููุทุฉ ุงูุตูุฑ ูู ููุทุฉ ุงูุตูุฑ ุ ูุง ููุฌุฏ ููู ููุง ูุฌุจ ูุนูู ุจุงูุฃุฎุทุงุก ุงููููุฐุฌูุฉ.  ุซุงููุงู ุ ูุง ูุชู ุชุบุทูุฉ ุทุฑู ุงุฎุชุจุงุฑ XDP ูุญูููุง ุจุฏูู VMs ูุงูุฃุฌูุฒุฉ ุ ุนูู ุงูุฑุบู ูู ุฃู ูุฏููู ูุทุจุงุชูู ุงูุฎุงุตุฉ.  ุงููุต ูุฎุตุต ูููุจุฑูุฌูู ุงููุทูุนูู ุนูู ุงูุดุจูุงุช ูููููุณ ุงูููุชููู ุจู XDP ู eBPF. </p><a name="habracut"></a><br><p style=";text-align:right;direction:rtl"> ูู ูุฐุง ุงูุฌุฒุก ุ ุณูุจุญุซ ุจุงูุชูุตูู ููู ูุชู ุชุฌููุน ูุฑุดุญ XDP ูููููุฉ ุงุฎุชุจุงุฑู ุ ุซู ุณููุชุจ ูุณุฎุฉ ุจุณูุทุฉ ูู ุขููุฉ ูููุงุช ุชุนุฑูู ุงูุงุฑุชุจุงุท SYN ุงููุนุฑููุฉ ุนูู ูุณุชูู ูุนุงูุฌุฉ ุงูุญุฒูุฉ.  ูู ุญูู ุฃููุง ูู ูุดูู "ูุงุฆูุฉ ุจูุถุงุก" <br>  ุงูุชุญูู ูู ุงูุนููุงุก ุ ูุงูุญูุงุธ ุนูู ุงูุนุฏุงุฏุงุช ูุฅุฏุงุฑุฉ ุนุงูู ุงูุชุตููุฉ - ุณุฌูุงุช ูุงููุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุณููุชุจ ูู C - ูุฐุง ููุณ ูู ุงููุฃููู ุ ูููู ุนููู.  ูู ุงูุดูุฑุฉ ูุชุงุญุฉ ุนูู GitHub ุนุจุฑ ุงูุฑุงุจุท ูู ุงูููุงูุฉ ุ ูุชููุณู ุฅูู ุฅูุชุฒุงูุงุช ููููุง ูููุฑุงุญู ุงูููุถุญุฉ ูู ุงูููุงูุฉ. </p><br><p style=";text-align:right;direction:rtl">  <strong>ุชูููู.</strong>  ุฃุซูุงุก ุงูููุงู ุ ุณูุชู ุชุทููุฑ ุญู ุตุบูุฑ ูุตุฏ ูุฌูุงุช DDoS ุ ูุฃู ูุฐู ูููุฉ ูุงูุนูุฉ ูู XDP ูููุทูู.  ููุน ุฐูู ุ ูุฅู ุงููุฏู ุงูุฑุฆูุณู ูู ุงูุชุนุงูู ูุน ุงูุชูููููุฌูุง ุ ููุฐุง ููุณ ุฏููููุง ูุฅูุดุงุก ุญูุงูุฉ ุฌุงูุฒุฉ.  ูู ูุชู ุชุญุณูู ุฑูุฒ ุงูุชุฏุฑูุจ ูุญุฐู ุจุนุถ ุงููุฑูู ุงูุฏูููุฉ. </p><br><h2 id="kratkiy-obzor-xdp" style=";text-align:right;direction:rtl">  XDP ูู ููุญุฉ </h2><br><p style=";text-align:right;direction:rtl">  ุณุฃุญุฏุฏ ุงูููุงุท ุงูุฑุฆูุณูุฉ ููุท ุญุชู ูุง ุฃูุฑุฑ ุงููุซุงุฆู ูุงูููุงูุงุช ุงูููุฌูุฏุฉ. </p><br><p style=";text-align:right;direction:rtl"> ูุฐูู ุ ูุชู ุชุญููู ุฑูุฒ ุงูุชุตููุฉ ูู ุงูููุงุฉ.  ูุชู ุฅุฑุณุงู ุงูุญุฒู ุงููุงุฑุฏุฉ ุฅูู ุงููุฑุดุญ.  ูุชูุฌุฉู ูุฐูู ุ ูุฌุจ ุฃู ูุชุฎุฐ ุงููุฑุดุญ ูุฑุงุฑูุง: ุชุฎุทู ุงูุญุฒูุฉ ุฅูู ุงูููุงุฉ ( <code>XDP_PASS</code> ) ุ ูุชุฌุงูู ุงูุญุฒูุฉ ( <code>XDP_DROP</code> ) ุฃู ุฅุนุงุฏุชูุง ( <code>XDP_TX</code> ).  ูููู ูููุฑุดุญ ุชุบููุฑ ุงูุญุฒูุฉ ุ ููุฐุง ููุทุจู ุจุดูู ุฎุงุต ุนูู <code>XDP_TX</code> .  ููููู ุฃูุถูุง ุชุนุทู ุงูุจุฑูุงูุฌ ( <code>XDP_ABORTED</code> ) ูุชุฌุงูู ุงูุญุฒูุฉ ุ ูููู ูุฐุง ุชูุงุธุฑูุฉ <code>assert(0)</code> ููุชุตุญูุญ. </p><br><p style=";text-align:right;direction:rtl">  ุชู ุชุตููู ุงูุฌูุงุฒ ุงูุธุงูุฑู eBPF (ูุฑุดุญ Berkley Packet Filter) ุจุดูู ุจุณูุท ุจุญูุซ ูููู ููููุงุฉ ุงูุชุญูู ูู ุฃู ุงูููุฏ ูุง ูููุตู ููุง ูุถุฑ ุจุฐุงูุฑุฉ ุดุฎุต ุขุฎุฑ.  ุงููููุฏ ูุงูุดููุงุช ุงูุฅุฌูุงููุฉ: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฏูุฑุงุช ูุญุธูุฑุฉ (ุงูููุฒ ูุฑุฉ ุฃุฎุฑู). </li><li style=";text-align:right;direction:rtl">  ููุงู ูููุฉ ููุจูุงูุงุช ุ ูููู ูุง ุชูุฌุฏ ูุธุงุฆู (ูุฌุจ ุฃู ุชููู ุฌููุน ูุธุงุฆู C ูุถููุฉ). </li><li style=";text-align:right;direction:rtl">  ูุญุธุฑ ุงููุตูู ุฅูู ุงูุฐุงูุฑุฉ ุฎุงุฑุฌ ุงููุฎุฒู ุงููุคูุช ูุงูุญุฒู. </li><li style=";text-align:right;direction:rtl">  ุญุฌู ุงูุฑูุฒ ูุญุฏูุฏ ุ ููู ูุฐุง ููุณ ููููุง ูู ุงูููุงุฑุณุฉ ุงูุนูููุฉ. </li><li style=";text-align:right;direction:rtl">  ูุง ููุณูุญ ุจุงูููุงููุงุช ุฅูุง ููุธุงุฆู kernel ุงูุฎุงุตุฉ (ูุณุงุนุฏูู eBPF). </li></ul><br><p style=";text-align:right;direction:rtl">  ูุจุฏู ุชุตููู ุงููุฑุดุญ ูุชุฑููุจู ููุง ููู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุชู ุชุฑุฌูุฉ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงููุตุฏุฑ (ุนูู ุณุจูู ุงููุซุงู ุ <code>kernel.c</code> ) ุฅูู ุงููุงุฆู ( <code>kernel.o</code> ) ุถูู ุจููุฉ ุงูุฌูุงุฒ ุงูุธุงูุฑู eBPF.  ุงุนุชุจุงุฑูุง ูู ุฃูุชูุจุฑ 2019 ุ ุชู ุฏุนู ุงูุชุญููู ุงูุจุฑูุฌู ูู eBPF ูู ููุจู Clang ููุนุฏ ูู GCC 10.1. </li><li style=";text-align:right;direction:rtl">  ุฅุฐุง ูุงู ููุงู ูู ุฑูุฒ ุงููุงุฆู ูุฐุง ููุงููุงุช ูุจููุฉ kernel (ุนูู ุณุจูู ุงููุซุงู ุ ุงูุฌุฏุงูู ูุงูุนุฏุงุฏุงุช) ุ ูุชู ุงุณุชุฎุฏุงู ุงูุฃุตูุงุฑ ุจุฏูุงู ูู ูุนุฑูุงุชูุง ุ ุฃู ุฃูู ูุง ูููู ุชูููุฐ ูุซู ูุฐุง ุงูุฑูุฒ.  ูุจู ุงูุชุญููู ูู kernel ุ ุชุญุชุงุฌ ุฅูู ุงุณุชุจุฏุงู ูุฐู ุงูุฃุตูุงุฑ ุจูุนุฑู ูุงุฆูุงุช ูุญุฏุฏุฉ ุชู ุฅูุดุงุคูุง ูู ุฎูุงู ููุงููุงุช kernel (ุฑูุฒ ุงูุฑุงุจุท).  ููููู ุงูููุงู ุจุฐูู ุจุงุณุชุฎุฏุงู ุฃุฏูุงุช ูุณุงุนุฏุฉ ุฎุงุฑุฌูุฉ ุ ุฃู ููููู ูุชุงุจุฉ ุจุฑูุงูุฌ ูููู ุจุฑุจุท ุนุงูู ุชุตููุฉ ูุญุฏุฏ ูุชุญูููู. </li><li style=";text-align:right;direction:rtl">  ูุชุญูู kernel ูู ุงูุจุฑูุงูุฌ ุงููุญููู.  ูุชู ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุญููุงุช ูุงูุบูุงุจ ูุฑุงุก ุญุฏูุฏ ุงูุญุฒูุฉ ูุงูููุฏุณ.  ุฅุฐุง ุชุนุฐุฑ ุนูู ุงููุฏูู ุฅุซุจุงุช ุตุญุฉ ุงูููุฏ ุ ูุณูุชู ุฑูุถ ุงูุจุฑูุงูุฌ - ูุฌุจ ุฃู ุชููู ูุงุฏุฑูุง ุนูู ุฅุฑุถุงุฆู. </li><li style=";text-align:right;direction:rtl">  ุจุนุฏ ุงูุชุญูู ุจูุฌุงุญ ุ ุชููู kernel ุจุชุฌููุน ููุฏ ูุงุฆู ููุฏุณุฉ eBPF ูู ููุฏ ุขูุฉ ููุฏุณุฉ ุงููุธุงู (ูู ุงูููุช ุงูููุงุณุจ). </li><li style=";text-align:right;direction:rtl">  ุงูุจุฑูุงูุฌ ูุนูู ุนูู ูุงุฌูุฉ ููุจุฏุฃ ูู ูุนุงูุฌุฉ ุงูุญุฒู. </li></ol><br><p style=";text-align:right;direction:rtl">  ูุธุฑูุง ูุฃู XDP ูุนูู ูู kernel ุ ูุชู ุชุตุญูุญ ุงูุฃุฎุทุงุก ุนู ุทุฑูู ุณุฌูุงุช ุงูุชุชุจุน ุ ููู ุงููุงูุน ุ ุจูุงุณุทุฉ ุงูุญุฒู ุงูุชู ูููู ุงูุจุฑูุงูุฌ ุจุชุตููุฉูุง ุฃู ุฅูุดุงุคูุง.  ููุน ุฐูู ุ ูููุฑ eBPF ุงูุญูุงูุฉ ููุฑูุฒ ุงูุฐู ุชู ุชุญูููู ูููุธุงู ุ ุจุญูุซ ููููู ุชุฌุฑุจุฉ XDP ูุจุงุดุฑุฉ ุนูู Linux ุงููุญูู. </p><br><h2 id="podgotovka-okruzheniya" style=";text-align:right;direction:rtl">  ุฅุนุฏุงุฏ ุงูุจูุฆุฉ </h2><br><h3 id="sborka" style=";text-align:right;direction:rtl">  ุฌูุนูุฉ </h3><br><p style=";text-align:right;direction:rtl">  ูุง ูููู ูู Clang ุฅุตุฏุงุฑ ุฑูุฒ ูุงุฆู ูุจููุฉ eBPF ูุจุงุดุฑุฉ ุ ูุฐูู ุชุชููู ุงูุนูููุฉ ูู ุฎุทูุชูู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชุฑุฌูุฉ C ุฑูุฒ ูู LLVM bytecode ( <code>clang -emit-llvm</code> ). </li><li style=";text-align:right;direction:rtl">  ุชุญููู bytecode ุฅูู ุฑูุฒ ูุงุฆู eBPF ( <code>llc -march=bpf -filetype=obj</code> ). </li></ol><br><p style=";text-align:right;direction:rtl">  ุนูุฏ ูุชุงุจุฉ ูุฑุดุญ ุ ูููู ุงููููุงู ุงููุฐุงู ูุญุชููุงู ุนูู ูุธุงุฆู ูุณุงุนุฏุฉ ููุญุฏุงุช ูุงูุฑู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูู ุงุฎุชุจุงุฑุงุช kernel</a> ูููุฏูุง.  ูู ุงูููู ุฃู ุชุชุทุงุจู ูุน ุฅุตุฏุงุฑ kernel ( <code>KVER</code> ).  ูู <code>helpers/</code> ูู <code>helpers/</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> KVER=v5.3.7 <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> BASE=https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/plain/tools/testing/selftests/bpf wget -P helpers --content-disposition <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${BASE}</span></span></span><span class="hljs-string">/bpf_helpers.h?h=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${KVER}</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${BASE}</span></span></span><span class="hljs-string">/bpf_endian.h?h=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${KVER}</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">unset</span></span> KVER BASE</code> </pre> <br><p style=";text-align:right;direction:rtl">  Makefile for Arch Linux (kernel 5.3.7): </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">CLANG ?= clang LLC ?= llc KDIR ?= /lib/modules/$(shell uname -r)/build ARCH ?= $(subst x86_64,x86,$(shell uname -m)) CFLAGS = \ -Ihelpers \ \ -I$(KDIR)/include \ -I$(KDIR)/include/uapi \ -I$(KDIR)/include/generated/uapi \ -I$(KDIR)/arch/$(ARCH)/include \ -I$(KDIR)/arch/$(ARCH)/include/generated \ -I$(KDIR)/arch/$(ARCH)/include/uapi \ -I$(KDIR)/arch/$(ARCH)/include/generated/uapi \ -D__KERNEL__ \ \ -fno-stack-protector -O2 -g xdp_%.o: xdp_%.c Makefile $(CLANG) -c -emit-llvm $(CFLAGS) $&lt; -o - | \ $(LLC) -march=bpf -filetype=obj -o $@ .PHONY: all clean all: xdp_filter.o clean: rm -f ./*.o</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุญุชูู <code>KDIR</code> ุนูู ุงููุณุงุฑ ุฅูู ุฑุคูุณ kernel ุ <code>ARCH</code> - ุจููุฉ ุงููุธุงู.  ูุฏ ุชุฎุชูู ุงููุณุงุฑุงุช ูุงูุฃุฏูุงุช ููููุงู ุจูู ุงูุชูุฒูุนุงุช. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูุซุงู ุนูู ุงููุฑู ูู Debian 10 (kernel 4.19.67)</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">#   CLANG ?= clang LLC ?= llc-7 #   KDIR ?= /usr/src/linux-headers-$(shell uname -r) ARCH ?= $(subst x86_64,x86,$(shell uname -m)) #    -I CFLAGS = \ -Ihelpers \ \ -I/usr/src/linux-headers-4.19.0-6-common/include \ -I/usr/src/linux-headers-4.19.0-6-common/arch/$(ARCH)/include \ #   </code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ุชุชุถูู <code>CFLAGS</code> ุฏููููุง ูุญุชูู ุนูู ุฑุคูุณ ูุณุงุนุฏุฉ ูุงูุนุฏูุฏ ูู ุงูุฃุฏูุฉ ุงูุชู ุชุญุชูู ุนูู ุฑุคูุณ kernel.  ูุนูู ุฑูุฒ <code>__KERNEL__</code> ุฃู ุฑุคูุณ UAPI (ูุงุฌูุงุช ุจุฑูุฌุฉ ุงูุชุทุจููุงุช ููุถุงุก ุงููุณุชุฎุฏููู) ูุญุฏุฏุฉ ูุฑูุฒ kernel ุ ูุฃู ุงููุฑุดุญ ูุนูู ูู kernel. </p><br><p style=";text-align:right;direction:rtl">  ูููู ุชุนุทูู ุญูุงูุฉ ุงูููุฏุณ ( <code>-fno-stack-protector</code> ) ุ ูุฃู ุฃุฏุงุฉ ุงูุชุญูู ูู ููุฏ eBPF ูุง ุฒุงูุช ุชุจุญุซ ุนู ูุฎุฑุฌ ูู ุงูููุฏุณ.  ูุฌุจ ุชุถููู ุงูุชุญุณูู ุนูู ุงูููุฑ ูุฃู ุญุฌู ุฑูุฒ eBPF bytecode ูุญุฏูุฏ. </p><br><p style=";text-align:right;direction:rtl">  ููุจุฏุฃ ุจูุฑุดุญ ูุชุฎุทู ุฌููุน ุงูุญุฒู ููุง ููุนู ุดูุฆูุง: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">#include &lt;uapi/linux/bpf.h&gt; #include &lt;bpf_helpers.h&gt; SEC("prog") int xdp_main(struct xdp_md* ctx) { return XDP_PASS; } char _license[] SEC("license") = "GPL";</code> </pre> <br><p style=";text-align:right;direction:rtl">  <code>xdp_filter.o</code> ุงูุฃูุฑ <code>make</code> <code>xdp_filter.o</code> .  ุฃูู ูุงุฎุชุจุงุฑู ุงูุขูุ </p><br><h3 id="testovyy-stend" style=";text-align:right;direction:rtl">  ูููู ุงุฎุชุจุงุฑ </h3><br><p style=";text-align:right;direction:rtl">  ูุฌุจ ุฃู ูุดุชูู ุงูุญุงูู ุนูู ูุงุฌูุชูู: ุญูุซ ุณูููู ููุงู ูุฑุดุญ ูุฃู ูููุง ุณูุชู ุฅุฑุณุงู ุงูุญุฒู.  ูุฌุจ ุฃู ุชููู ูุฐู ุฃุฌูุฒุฉ Linux ูุงููุฉ ุงููุธุงุฆู ูุน IP ุงูุฎุงุต ุจูุง ูู ุฃุฌู ุงูุชุญูู ูู ููููุฉ ุนูู ุงูุชุทุจููุงุช ุงูุนุงุฏูุฉ ูุน ุงูููุชุฑ ุงูุฎุงุต ุจูุง. </p><br><p style=";text-align:right;direction:rtl">  ุฃุฌูุฒุฉ ูุซู veth (ุดุจูุฉ ุฅูุซุฑูุช ุงูุชุฑุงุถูุฉ) ููุงุณุจุฉ ููุง: ููู ุนุจุงุฑุฉ ุนู ุฒูุฌ ูู ูุงุฌูุงุช ุงูุดุจูุฉ ุงูุงูุชุฑุงุถูุฉ "ูุชุตูุฉ" ูุจุงุดุฑุฉ ูุน ุจุนุถูุง ุงูุจุนุถ.  ููููู ุฅูุดุงุฆูุง ูุซู ูุฐุง (ูู ูุฐุง ุงููุณู ุ ูุชู ุชูููุฐ ุฌููุน ุฃูุงูุฑ <code>ip</code> <code>root</code> ): </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ip link add xdp-remote <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> veth peer name xdp-local</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุง <code>xdp-remote</code> ู <code>xdp-local</code> ูู ุฃุณูุงุก ุงูุฃุฌูุฒุฉ.  ุณูุชู ุฅุฑูุงู ุนุงูู ุชุตููุฉ ุจู <code>xdp-local</code> (192.0.2.1/24) ุ ูุณูุชู ุฅุฑุณุงู ุญุฑูุฉ ุงููุฑูุฑ ุงููุงุฑุฏุฉ ูู <code>xdp-remote</code> (192.0.2.2/24).  ููุน ุฐูู ุ ูููุงู ูุดููุฉ: ูุงููุงุฌูุงุช ููุฌูุฏุฉ ุนูู ููุณ ุงูุฌูุงุฒ ุ ููู ูุฑุณู Linux ุญุฑูุฉ ุงููุฑูุฑ ุฅูู ูุงุญุฏ ูููู ุนุจุฑ ุงูุขุฎุฑ.  ููููู ุญู ูุฐุง ุจุงุณุชุฎุฏุงู ููุงุนุฏ <code>iptables</code> ุงูุตุนุจุฉ ุ ููู ุณูุชุนูู ุนูููุง ุชุบููุฑ ุงูุญุฒู ุ ููู ุฃูุฑ ุบูุฑ ูุฑูุญ ุนูุฏ ุชุตุญูุญ ุงูุฃุฎุทุงุก.  ูู ุงูุฃูุถู ุงุณุชุฎุฏุงู ูุณุงุญุงุช ุฃุณูุงุก ุงูุดุจูุงุช (ูุณุงุญุงุช ุฃุณูุงุก ุงูุดุจูุงุช ุ ุงููุดุงุฑ ุฅูููุง ูููุง ููู ุจุงูุดุจูุงุช). </p><br><p style=";text-align:right;direction:rtl">  ุชุญุชูู ูุณุงุญุฉ ุงุณู ุงูุดุจูุฉ ุนูู ูุฌููุนุฉ ูู ุงููุงุฌูุงุช ูุฌุฏุงูู ุงูุชูุฌูู ูููุงุนุฏ NetFilter ุ ูุนุฒููุฉ ุนู ูุงุฆูุงุช ููุงุซูุฉ ูู ุดุจูุงุช ุฃุฎุฑู.  ูุชู ุชุดุบูู ูู ุนูููุฉ ูู ูุณุงุญุฉ ุงุณู ุ ููุง ูููู ุงููุตูู ุฅูููุง ุฅูุง ูู ูุงุฆูุงุช ูุฐู ุงูุดุจูุงุช.  ุจุดูู ุงูุชุฑุงุถู ุ ูุญุชูู ุงููุธุงู ุนูู ูุณุงุญุฉ ุงุณู ุดุจูุฉ ูุงุญุฏุฉ ูุฌููุน ุงููุงุฆูุงุช ุ ุจุญูุซ ููููู ุงูุนูู ุนูู Linux ูุนุฏู ูุนุฑูุฉ ุงูุดุจูุงุช. </p><br><p style=";text-align:right;direction:rtl">  ุฅูุดุงุก ูุณุงุญุฉ ุงุณู <code>xdp-test</code> ุฌุฏูุฏุฉ ูููู <code>xdp-remote</code> . </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ip netns add xdp-test ip link <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> dev xdp-remote netns xdp-test</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุนูุฏุฆุฐู ูู "ุชุฑู" <code>xdp-local</code> ุงูุนูููุฉ ููุฏ ุงูุชุดุบูู ูู <code>xdp-test</code> <code>xdp-local</code> (ุณุชุจูู ูู ุงูุดุจูุงุช ุงูุงูุชุฑุงุถูุฉ ุจุดูู ุงูุชุฑุงุถู) ูุณูู ุชุฑุณููุง ุนุจุฑ <code>xdp-remote</code> ุนูุฏ ุฅุฑุณุงู ุญุฒูุฉ ุฅูู 192.0.2.1 ุ ูุฃู ูุฐู ูู ุงููุงุฌูุฉ ุงููุญูุฏุฉ ูู 192.0.2.0/ 24 ุงููุชุงุญุฉ ููุฐู ุงูุนูููุฉ.  ูุฐุง ูุนูู ุฃูุถุง ูู ุงูุงุชุฌุงู ุงููุนุงูุณ. </p><br><p style=";text-align:right;direction:rtl">  ุนูุฏ ุงูุชููู ุจูู ุงูุดุจูุงุช ุ ุชุณูุท ุงููุงุฌูุฉ ูุชููุฏ ุงูุนููุงู.  ูุชูููู ุงููุงุฌูุฉ ูู netns ุ ุชุญุชุงุฌ ุฅูู ุชุดุบูู <code>ip ...</code> ูู ูุณุงุญุฉ ุงุณู ุฃูุฑ <code>ip netns exec</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> xdp-test \ ip address add 192.0.2.2/24 dev xdp-remote ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> xdp-test \ ip link <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> xdp-remote up</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุง ุชุฑูู ุ ูุฐุง ูุง ูุฎุชูู ุนู ุฅุนุฏุงุฏ <code>xdp-local</code> ูู ูุณุงุญุฉ ุงูุงุณู ุงูุงูุชุฑุงุถูุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"> ip address add 192.0.2.1/24 dev xdp-local ip link <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> xdp-local up</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ููุช ุจุชุดุบูู <code>tcpdump -tnevi xdp-local</code> ุ ููููู ุฃู ุชุฑู ุฃู ุงูุญุฒู ุงููุฑุณูุฉ ูู <code>xdp-test</code> ูุชู ุชุณููููุง ุฅูู ูุฐู ุงููุงุฌูุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> xdp-test ping 192.0.2.1</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฃููุง ูุฑูุญุฉ ูุชุดุบูู shell ูู <code>xdp-test</code> .  ููุฌุฏ ุจุฑูุงูุฌ ูุตู ูู ุงููุณุชูุฏุน ูุนูู ุชููุงุฆููุง ูุน ุงูุญุงูู ุ ุนูู ุณุจูู ุงููุซุงู ุ ููููู ุชูููู ุงูุญุงูู ุจุงุณุชุฎุฏุงู <code>sudo ./stand up</code> command ูุญุฐูู ุจุงุณุชุฎุฏุงู <code>sudo ./stand down</code> </p><br><h3 id="trassirovka" style=";text-align:right;direction:rtl">  ุชุชุจุน </h3><br><p style=";text-align:right;direction:rtl">  ูุชู ุชูุตูู ุงููุฑุดุญ ุจุงูุฌูุงุฒ ููุง ููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ip -force link <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> dev xdp-local xdp object xdp_filter.o verbose</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุฒู <code>-force</code> ูุฑุถ ุฑุจุท ุจุฑูุงูุฌ ุฌุฏูุฏ ุฅุฐุง ูุงู ุขุฎุฑ ููุถููุง ุจุงููุนู.  "ูุง ุชูุฌุฏ ุฃุฎุจุงุฑ ุฌูุฏุฉ" ูุง ูุชุนูู ุจูุฐุง ุงูุฃูุฑ ุ ูุงููุชูุฌุฉ ูู ูู ุฃู ุญุงู ุถุฎูุฉ.  <code>verbose</code> ุงุฎุชูุงุฑููุง ุ ูููู ุจู ูุธูุฑ ุชูุฑูุฑ ุนู ุนูู ุฃุฏุงุฉ ุงูุชุญูู ูู ุงูููุฏ ูุน ูุงุฆูุฉ ุงูุชุฌููุน: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Verifier analysis: 0: (b7) r0 = 2 1: (95) exit</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ุงูุจุฑูุงูุฌ ูู ุงููุงุฌูุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ip link <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> dev xdp-local xdp off</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ุงูุจุฑูุงูุฌ ุงููุตู ุ ูุฐู ูู <code>sudo ./stand attach</code> ู <code>sudo ./stand detach</code> . </p><br><p style=";text-align:right;direction:rtl">  ูู ุฎูุงู ุฅุฑูุงู ูุฑุดุญ ุ ููููู ุงูุชุญูู ูู ุงุณุชูุฑุงุฑ ุชูููุฐ ุงูุฃูุฑ <code>ping</code> ุ ููู ูู ูุนูู ุงูุจุฑูุงูุฌุ  ุฃุถู ุงูุณุฌูุงุช.  <a href=""><code>bpf_trace_printk()</code></a> ูุธููุฉ <a href=""><code>bpf_trace_printk()</code></a> <code>printf()</code> ุ ููููุง ุชุฏุนู ุญุชู ุซูุงุซ ูุณูุทุงุช ููุท ุ ุจุงุณุชุซูุงุก ุงููุงูุจ ุ ููุงุฆูุฉ ูุญุฏูุฏุฉ ูู ุงููุคููุงุช.  ูุจุณุท ุงููุงูุฑู <code>bpf_printk()</code> ุงูููุงููุฉ. </p><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"> SEC("prog") int xdp_main(struct xdp_md* ctx) { + bpf_printk("got packet: %p\n", ctx); return XDP_PASS; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุฐูุจ ุงูุฅุฎุฑุงุฌ ุฅูู ููุงุฉ ุงูุชุชุจุน kernel ุ ูุงูุชู ุชุญุชุงุฌ ุฅูู ุชูููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n 1 | sudo tee /sys/kernel/debug/tracing/options/trace_printk</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุนุฑุถ ุชุฏูู ุงูุฑุณุงูุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">cat /sys/kernel/debug/tracing/trace_pipe</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูููู ููุง ุงูุฃูุฑูู ุจุฅุฌุฑุงุก ููุงููุฉ <code>sudo ./stand log</code> . </p><br><p style=";text-align:right;direction:rtl">  ูุฌุจ ุนูู Ping ุงูุขู ุชุดุบูู ุงูุฑุณุงุฆู ุงูุชุงููุฉ ููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">&lt;...&gt;-110930 [004] ..s1 78803.244967: 0: got packet: 00000000ac510377</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ูุธุฑุช ุนู ูุซุจ ุฅูู ุฅุฎุฑุงุฌ ุงููุฏูู ุ ุณุชูุงุญุธ ุญุณุงุจุงุช ุบุฑูุจุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">0: (bf) r3 = r1 1: (18) r1 = 0xa7025203a7465 3: (7b) *(u64 *)(r10 -8) = r1 4: (18) r1 = 0x6b63617020746f67 6: (7b) *(u64 *)(r10 -16) = r1 7: (bf) r1 = r10 8: (07) r1 += -16 9: (b7) r2 = 16 10: (85) call bpf_trace_printk#6 &lt;...&gt;</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงูุญูููุฉ ูู ุฃู ุจุฑุงูุฌ eBPF ูุง ุชุญุชูู ุนูู ูุณู ุจูุงูุงุช ุ ูุจุงูุชุงูู ูุฅู ุงูุทุฑููุฉ ุงููุญูุฏุฉ ูุชุฑููุฒ ุณูุณูุฉ ุงูุชูุณูู ูู ุจุงุณุชุฎุฏุงู ุงููุณุงุฆุท ุงููุจุงุดุฑุฉ ูุฃูุงูุฑ VM: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ python -c <span class="hljs-string"><span class="hljs-string">"import binascii; print(bytes(reversed(binascii.unhexlify('0a7025203a74656b63617020746f67'))))"</span></span> b<span class="hljs-string"><span class="hljs-string">'got packet: %p\n'</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุฐุง ุงูุณุจุจ ุ ูุคุฏู ุฅุฎุฑุงุฌ ุงูุชุตุญูุญ ุฅูู ุชุถุฎูู ุงูุชุนูููุฉ ุงูุจุฑูุฌูุฉ ุงููุงุชุฌุฉ ุฅูู ุญุฏ ูุจูุฑ. </p><br><h3 id="otpravka-paketov-xdp" style=";text-align:right;direction:rtl">  ุฅุฑุณุงู ุญุฒู XDP </h3><br><p style=";text-align:right;direction:rtl">  ุฏุนูุง ูุบูุฑ ุงููุฑุดุญ: ุฏุนู ูุฑุณู ุฌููุน ุงูุญุฒู ุงููุงุฑุฏุฉ ูุฑุฉ ุฃุฎุฑู.  ูุฐุง ุบูุฑ ุตุญูุญ ูู ูุฌูุฉ ูุธุฑ ุงูุดุจูุฉ ุ ุญูุซ ุณูููู ูู ุงูุถุฑูุฑู ุชุบููุฑ ุงูุนูุงููู ูู ุงูุฑุคูุณ ุ ูููู ุงูุนูู ุงูุขู ููู ูู ุญูุซ ุงููุจุฏุฃ. </p><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"> bpf_printk("got packet: %p\n", ctx); - return XDP_PASS; + return XDP_TX; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุชุดุบูู <code>tcpdump</code> ุนูู <code>xdp-remote</code> .  ูุฌุจ ุฃู ููุธูุฑ ุทูุจ ุงุฑุชุฏุงุฏ ICMP ุงูุตุงุฏุฑ ูุงููุงุฑุฏ ูุชุทุงุจููุง ููุชููู ุนู ุฅุธูุงุฑ ุฑุฏ ุงุฑุชุฏุงุฏ ICMP.  ูููู ูุง ุชุธูุฑ.  ุงุชุถุญ ุฃูู ููู ูุนูู <code>XDP_TX</code> ูู ุจุฑูุงูุฌ ุนูู <code>xdp-local</code> <a href="">ูู ุงูุถุฑูุฑู</a> <code>xdp-remote</code> ูุงุฌูุฉ <code>xdp-remote</code> ูููุงุฌูุฉ <code>xdp-remote</code> ุ ุญุชู ูู ูุงูุช ูุงุฑุบุฉ ุ <a href="">ููุฌุจ</a> ุฑูุนูุง. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ููู ุงูุชุดูุช ุฐููุ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ุจุงูููุงุณุจุฉ ุ ุชุชูุญ ุขููุฉ ุฃุญุฏุงุซ perf ุ ุจุงุณุชุฎุฏุงู ููุณ ุงูุฌูุงุฒ ุงูุธุงูุฑู ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุชุชุจุน ูุณุงุฑ ุงูุญุฒูุฉ ูู ุงูููุงุฉ</a> ุ ุฃู ูุชู ุงุณุชุฎุฏุงู eBPF ููุชูููู ูุน eBPF. </p><br><blockquote style=";text-align:right;direction:rtl">  ุนููู ุฃู ุชุตูุน ุงูุฎูุฑ ูู ุงูุดุฑ ุ ูุฃูู ูุง ููุฌุฏ ุดูุก ุขุฎุฑ ุชุณุชููุฏ ููู. </blockquote><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ sudo perf trace --call-graph dwarf -e <span class="hljs-string"><span class="hljs-string">'xdp:*'</span></span> 0.000 ping/123455 xdp:xdp_bulk_tx:ifindex=19 action=TX sent=0 drops=1 err=-6 veth_xdp_flush_bq ([veth]) veth_xdp_flush_bq ([veth]) veth_poll ([veth]) &lt;...&gt;</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุง ูู ุงูููุฏ 6ุ </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ errno 6 ENXIO 6 No such device or address</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุชุชููู ูุธููุฉ <code>veth_xdp_flush_bq()</code> ุฑูุฒ ุฎุทุฃ ูู <code>veth_xdp_xmit()</code> ุ ุญูุซ ูุจุญุซ ุนู ุทุฑูู <code>ENXIO</code> ููุฌุฏ ุชุนููููุง. </p></div></div><br><p style=";text-align:right;direction:rtl">  ุงุณุชุนุงุฏุฉ ุงูุญุฏ ุงูุฃุฏูู ููุชุตููุฉ ( <code>XDP_PASS</code> ) ูู ููู <code>xdp_dummy.c</code> ุ ุฃุถูู ุฅูู Makefile ุ <code>xdp-remote</code> ุจู <code>xdp-remote</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> remote \ ip link <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> dev int xdp object dummy.o</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุธูุฑ ุงูุขู <code>tcpdump</code> ูุง ูู ูุชููุน: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">62:57:8e:70:44:64 &gt; 26:0e:25:37:8f:96, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 13762, offset 0, flags [DF], proto ICMP (1), length 84) 192.0.2.2 &gt; 192.0.2.1: ICMP echo request, id 46966, seq 1, length 64 62:57:8e:70:44:64 &gt; 26:0e:25:37:8f:96, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 13762, offset 0, flags [DF], proto ICMP (1), length 84) 192.0.2.2 &gt; 192.0.2.1: ICMP echo request, id 46966, seq 1, length 64</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ุชู ุนุฑุถ ARP ููุท ุ ูุณุชุญุชุงุฌ ุฅูู ุฅุฒุงูุฉ ุงููุฑุดุญุงุช (ูุชู ุฐูู ุนู ุทุฑูู <code>sudo ./stand detach</code> ) ุ ุงุจุฏุฃ ูู <code>ping</code> ุ ุซู ูู ุจุชุนููู ุงููุฑุดุญุงุช ูุญุงูู ูุฑุฉ ุฃุฎุฑู.  ุงููุดููุฉ ูู ุฃู ุนุงูู ุงูุชุตููุฉ <code>XDP_TX</code> ูุคุซุฑ ุนูู ูู ูู ARP ูุฅุฐุง ูุงู ุงูููุฏุณ <br>  ุชูููุช ูุณุงุญุฉ ุงุณู <code>xdp-test</code> ูู "ูุณูุงู" ุนููุงู MAC 192.0.2.1 ุ ููู ุชุชููู ูู ุญู ุนููุงู IP ูุฐุง. </p><br><h2 id="postanovka-zadachi" style=";text-align:right;direction:rtl">  ุจูุงู ุงููุดููุฉ </h2><br><p style=";text-align:right;direction:rtl">  ุฏุนูุง ููุชูู ุฅูู ุงููููุฉ ุงููุฐููุฑุฉ: ูุชุงุจุฉ ุขููุฉ ูููุงุช ุชุนุฑูู ุงูุงุฑุชุจุงุท SYN ุนูู XDP. </p><br><p style=";text-align:right;direction:rtl">  ุญุชู ุงูุขู ุ ูุธู ููุถุงู SYN ูุฌูู DDoS ุดุงุฆุน ุ ุฌููุฑู ุนูู ุงููุญู ุงูุชุงูู.  ุนูุฏ ุฅูุดุงุก ุงุชุตุงู (ูุตุงูุญุฉ TCP) ุ ูุณุชูุจู ุงูุฎุงุฏู SYN ุ ููุฎุตุต ููุงุฑุฏ ูุงุชุตุงู ูุณุชูุจูู ุ ููุณุชุฌูุจ ุจุญุฒูุฉ SYNACK ุ ูููุชุธุฑ ACK.  ูููู ุงูููุงุฌู ุจุจุณุงุทุฉ ุจุฅุฑุณุงู ุญุฒู SYN ูู ุนูุงููู ููููุฉ ุจูุจูุบ ุงูุขูุงู ูู ุงูุซุงููุฉ ูู ูู ูุถูู ูู ุนุฏุฉ ุขูุงู ูู ุงูุฑูุจูุชุงุช.  ูุถุทุฑ ุงูุฎุงุฏู ุฅูู ุชุฎุตูุต ุงูููุงุฑุฏ ููุฑ ูุตูู ุงูุญุฒูุฉ ุ ููุชุญุฑุฑ ููุช ุงูุชูุงุก ูููุฉ ูุจูุฑ ุ ููุชูุฌุฉ ูุฐูู ุ ูุชู ุงุณุชููุงุฏ ุงูุฐุงูุฑุฉ ุฃู ุงูุญุฏูุฏ ุ ุนุฏู ูุจูู ุงุชุตุงูุงุช ุฌุฏูุฏุฉ ุ ุงูุฎุฏูุฉ ุบูุฑ ูุชููุฑุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ูู ุชูู ุจุชุฎุตูุต ููุงุฑุฏ ูุญุฒูุฉ SYN ุ ูููู ุงุณุชุฌุงุจุช ููุท ุจุญุฒูุฉ SYNACK ุ ูููู ูููู ุฃู ูููู ุงูุฎุงุฏู ุฃู ุญุฒูุฉ ACK ุงูุชู ุฌุงุกุช ูุงุญููุง ุชุดูุฑ ุฅูู ุญุฒูุฉ SYN ูู ูุชู ุญูุธูุงุ  ุจุนุฏ ูู ุดูุก ุ ูููู ููููุงุฌู ุฃูุถุง ุฅูุดุงุก ACKs ููููุฉ.  ุฌููุฑ ููู ุชุนุฑูู ุงูุงุฑุชุจุงุท SYN ูู ุชุดููุฑ ูุนููุงุช <code>seqnum</code> ูู <code>seqnum</code> ูู ุงูุนูุงููู ูุงูููุงูุฆ ูุชุบููุฑ ุงูููุญ.  ุฅุฐุง ุชูููุช ACK ูู ุงููุตูู ูุจู ุชุบููุฑ ุงูููุญ ุ ูููููู ูุฑุฉ ุฃุฎุฑู ุญุณุงุจ ุงูุชุฌุฒุฆุฉ ูููุงุฑูุชู ูุน <code>acknum</code> .  ูุง ูููู ููููุงุฌู ูุฒูู <code>acknum</code> ุ ูุฃู ุงูููุญ ูุชุถูู ุณุฑูุง ุ ููู ูููู ูุฏูู ููุช ูููุฑุฒ ุจุณุจุจ ุงูููุงุฉ ุงููุญุฏูุฏุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุชู ุชุทุจูู ููู ุชุนุฑูู ุงูุงุฑุชุจุงุท SYN ููุฐ ูุชุฑุฉ ุทูููุฉ ูู ููุงุฉ Linux ููุฏ ูุชู ุชุดุบููู ุชููุงุฆููุง ุฅุฐุง ูุตู SYN ุจุณุฑุนุฉ ูุจูุฑุฉ ูุจูููุงุช ูุจูุฑุฉ. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงูุจุฑูุงูุฌ ุงูุชุนูููู ุนูู ูุตุงูุญุฉ TCP</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ูููุฑ TCP ููู ุงูุจูุงูุงุช ูุฏูู ูู ุงูุจุงูุชุงุช ุ ุนูู ุณุจูู ุงููุซุงู ุ ูุชู ุฅุฑุณุงู ุทูุจุงุช HTTP ุนุจุฑ TCP.  ููุชูู ุงูุชูุงุฑ ูู ูุทุน ูู ุญุฒู.  ุชุญุชูู ุฌููุน ุญุฒู TCP ุนูู ุนูุงูุงุช ููุทููุฉ ูุฃุฑูุงู ุชุณูุณู 32 ุจุช: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ุชุญุฏุฏ ูุฌููุนุฉ ุงูุนูุงูุงุช ุฏูุฑ ุญุฒูุฉ ูุนููุฉ.  ุชุนูู ุนูุงูุฉ SYN ุฃู ูุฐู ูู ุงูุญุฒูุฉ ุงูุฃููู ูููุฑุณู ูู ุงูุงุชุตุงู.  ุชุนูู ุนูุงูุฉ ACK ุฃู ุงููุฑุณู ูุฏ ุชููู ุฌููุน ุจูุงูุงุช ุงูุงุชุตุงู ูุจู ุจุงูุช <code>acknum</code> .  ูููู ุฃู ุชุญุชูู ุงูุญุฒูุฉ ุนูู ุนุฏุฉ ุนูุงูุงุช ููุชู ุงุณุชุฏุนุงุคูุง ุจูุงุณุทุฉ ุงููุฌููุนุฉ ุงูุฎุงุตุฉ ุจูุง ุ ุนูู ุณุจูู ุงููุซุงู ุ ุญุฒูุฉ SYNACK. </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ูุญุฏุฏ ุฑูู ุงูุชุณูุณู (seqnum) ุงูุฅุฒุงุญุฉ ูู ุฏูู ุงูุจูุงูุงุช ููุจุงูุช ุงูุฃูู ุงูุฐู ูุชู ุฅุฑุณุงูู ูู ูุฐู ุงูุญุฒูุฉ.  ุนูู ุณุจูู ุงููุซุงู ุ ุฅุฐุง ูุงู ูุฐุง ุงูุฑูู ูู ุงูุญุฒูุฉ ุงูุฃููู ุงูุชู ุชุญุชูู ุนูู X ุจุงูุชุงุช ูู ุงูุจูุงูุงุช ูู N ุ ูุณูููู N + X ูู ุงูุญุฒูุฉ ุงูุชุงููุฉ ูุน ุจูุงูุงุช ุฌุฏูุฏุฉ.  ูู ุจุฏุงูุฉ ุงูุงุชุตุงู ุ ูููู ูู ุฌุงูุจ ุจุชุญุฏูุฏ ูุฐุง ุงูุฑูู ุจุดูู ุชุนุณูู. </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ุฑูู ุงูุฅูุฑุงุฑ (acknum) - ูู ููุณ ุงูุฅุฒุงุญุฉ seqnum ุ ููููู ูุง ูุญุฏุฏ ุนุฏุฏ ุงูุจุงูุชุงุช ุงููุฑุงุฏ ุฅุฑุณุงููุง ุ ูููู ุฑูู ุงูุจุงูุช ุงูุฃูู ูู ุงููุณุชูู ุงูุฐู ูู ูุฑู ุงููุฑุณู. </p><br></li></ul><br><p style=";text-align:right;direction:rtl">  ูู ุจุฏุงูุฉ ุงูุงุชุตุงู ุ ูุฌุจ ุฃู ูุชูู ุงูุทุฑูุงู ุนูู <code>seqnum</code> ู <code>acknum</code> .  ูุฑุณู ุงูุนููู ุญุฒูุฉ SYN ูุน <code>seqnum = X</code>  ูุณุชุฌูุจ ุงูุฎุงุฏู ุจุญุฒูุฉ SYNACK ุ ุญูุซ ููุชุจ <code>seqnum = Y</code> <code>acknum = X + 1</code> .  ูุณุชุฌูุจ ุงูุนููู ุฅูู SYNACK ูุน ุญุฒูุฉ ACK ุ ุญูุซ <code>seqnum = X + 1</code> ุ <code>acknum = Y + 1</code> .  ุจุนุฏ ุฐูู ุ ูุจุฏุฃ ููู ุงูุจูุงูุงุช ุงููุนูู. </p><br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ูู ูุคูุฏ ุงููุญุงูุฑ ุงุณุชูุงู ุงูุญุฒูุฉ ุ ูุณูุฑุณููุง TCP ูุฑุฉ ุฃุฎุฑู ุจุญููู ุงููููุฉ. </p></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ููุงุฐุง ูุง ูุชู ุงุณุชุฎุฏุงู ูููุงุช ุชุนุฑูู ุงูุงุฑุชุจุงุท SYN ุฏุงุฆููุงุ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ุฃููุงู ุ ูู ุญุงูุฉ ููุฏ SYNACK ุฃู ACK ุ ูุฌุจ ุนููู ุงูุชุธุงุฑ ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู - ูุชู ุฅุจุทุงุก ุงูุงุชุตุงู.  ุซุงููุง ุ ูู ุญุฒูุฉ SYN - ูููุท ูู ุฐูู!  - ูุชู ุฅุฑุณุงู ุนุฏุฏ ูู ุงูุฎูุงุฑุงุช ุงูุชู ุชุคุซุฑ ุนูู ููุงุตูุฉ ุชุดุบูู ุงูุงุชุตุงู.  ุฏูู ุชุฐูุฑ ุญุฒู SYN ุงููุงุฑุฏุฉ ุ ูุชุฌุงูู ุงูุฎุงุฏู ูุฐู ุงูุฎูุงุฑุงุช ุ ูู ุงูุญุฒู ุงูุชุงููุฉ ูู ูุฑุณููุง ุงูุนููู ุจุนุฏ ุงูุขู.  ูู ูุฐู ุงูุญุงูุฉ ุ ูููู ุฃู ูุนูู TCP ุ ูููู ุนูู ุงูุฃูู ูู ุงููุฑุญูุฉ ุงูุฃูููุฉ ุ ุณุชูุฎูุถ ุฌูุฏุฉ ุงูุงุชุตุงู. </p></div></div><br><p style=";text-align:right;direction:rtl">  ูู ุญูุซ ุงูุญุฒู ุ ูุฌุจ ุฃู ูููู ุจุฑูุงูุฌ XDP ุจูุง ููู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  SYNACK ูุน ููู ุชุนุฑูู ุงูุงุฑุชุจุงุท ููุฑุฏ ุนูู SYN ุ </li><li style=";text-align:right;direction:rtl">  ุงูุฑุฏ ุนูู ACK RST (ูุทุน ุงูุงุชุตุงู) ุ </li><li style=";text-align:right;direction:rtl">  ุชุฌุงูู ุงูุญุฒู ุงูุฃุฎุฑู. </li></ul><br><p style=";text-align:right;direction:rtl">  ุฎูุงุฑุฒููุฉ ุงูููุฏ ุงููุงุฐุจ ูุน ุชุญููู ุงูุญุฒูุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">   Ethernet,  .    IPv4,  .     , (*)    ,  .    TCP,  . (**)   SYN,  SYN-ACK  cookie.   ACK,   acknum   cookie,  .      N  . (*)  RST. (**)     .</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุดูุฑ ูุงุญุฏ <code>(*)</code> ุฅูู ุงูููุงุท ุงูุชู ูููู ูู ุฎูุงููุง ุงูุชุญูู ูู ุญุงูุฉ ุงููุธุงู - ูู ุงููุฑุญูุฉ ุงูุฃููู ุ ููููู ุงูุงุณุชุบูุงุก ุนููุง ุจุจุณุงุทุฉ ุนู ุทุฑูู ุชุทุจูู ูุตุงูุญุฉ TCP ูุน ุฅูุดุงุก ููู ุชุนุฑูู ุงุฑุชุจุงุท SYN ูุซู seqnum. </p><br><p style=";text-align:right;direction:rtl">  ูู ุงูููุงู <code>(**)</code> ุ ุนูู ุงูุฑุบู ูู ุนุฏู ูุฌูุฏ ุฌุฏูู ุ ูุฅููุง ุณูุชุฎุทู ุงูุญุฒูุฉ. </p><br><h2 id="realizaciya-tcp-handshake" style=";text-align:right;direction:rtl">  ุชูููุฐ ูุตุงูุญุฉ TCP </h2><br><h3 id="razbor-paketa-i-verifikaciya-koda" style=";text-align:right;direction:rtl">  ุชุญููู ุงูุญุฒูุฉ ูุงูุชุญูู ูู ุงูููุฏ </h3><br><p style=";text-align:right;direction:rtl">  ูุญู ุจุญุงุฌุฉ ุฅูู ููุงูู ุฑุฃุณ ุงูุดุจูุฉ: Ethernet ( <code>uapi/linux/if_ether.h</code> ) ู IPv4 ( <code>uapi/linux/ip.h</code> ) ู TCP ( <code>uapi/linux/tcp.h</code> ).  ุขุฎุฑ ูุงุญุฏ ูู ุฃุณุชุทุน ุงูุงุชุตุงู ุจุณุจุจ ุงูุฃุฎุทุงุก ุงููุชุนููุฉ <code>atomic64_t</code> ุ ูุงุถุทุฑุฑุช ุฅูู ูุณุฎ ุงูุชุนุงุฑูู ุงููุงุฒูุฉ ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูุฌุจ ุฃู ุชููู ุฌููุน ุงููุธุงุฆู ุงููุฎุตุตุฉ ูู C ููุงุจููุฉ ุงููุฑุงุกุฉ ูุฏูุฌุฉ ูู ููุงู ุงูุงุณุชุฏุนุงุก ุ ูุฃู ูุฏูู eBPF ูู ุงูููุงุฉ ูุญุธุฑ ุงูุงูุชูุงู ูู ุฌุฏูุฏ ุ ุฃู ูู ุงููุงูุน ุญููุงุช ูููุงููุงุช ุงููุธุงุฆู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">#define INTERNAL static __attribute__((always_inline))</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุชุนุทูู ุงููุงูุฑู <code>LOG()</code> ุงูุทุจุงุนุฉ ูู ุฅูุดุงุก ุงูุฅุตุฏุงุฑ. </p><br><p style=";text-align:right;direction:rtl">  ุงูุจุฑูุงูุฌ ุนุจุงุฑุฉ ุนู ูุงูู ูููุธุงุฆู.  ูุชููู ูู ูููุง ุญุฒูุฉ ูุชู ูููุง ุชูููุฒ ุฑุฃุณ ุงููุณุชูู ุงูููุงุจู ุ ุนูู ุณุจูู ุงููุซุงู ุ ูุชููุน <code>process_ether()</code> ุฃู ูููู <code>ether</code> ููุชูุฆูุง.  ุจูุงุกู ุนูู ูุชุงุฆุฌ ุงูุชุญููู ุงูููุฏุงูู ุ ูููู ุฃู ุชููู ุงููุธููุฉ ุงูุฑุฒูุฉ ุฅูู ูุณุชูู ุฃุนูู.  ูุชูุฌุฉ ุงูุฏุงูุฉ ูู ุฅุฌุฑุงุก XDP.  ุญุชู ุงูุขู ุ ุชููู ูุนุงูุฌุงุช SYN ู ACK ุจุชูุฑูุฑ ุฌููุน ุงูุญุฒู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">struct Packet { struct xdp_md* ctx; struct ethhdr* ether; struct iphdr* ip; struct tcphdr* tcp; }; INTERNAL int process_tcp_syn(struct Packet* packet) { return XDP_PASS; } INTERNAL int process_tcp_ack(struct Packet* packet) { return XDP_PASS; } INTERNAL int process_tcp(struct Packet* packet) { ... } INTERNAL int process_ip(struct Packet* packet) { ... } INTERNAL int process_ether(struct Packet* packet) { struct ethhdr* ether = packet-&gt;ether; LOG("Ether(proto=0x%x)", bpf_ntohs(ether-&gt;h_proto)); if (ether-&gt;h_proto != bpf_ntohs(ETH_P_IP)) { return XDP_PASS; } // B struct iphdr* ip = (struct iphdr*)(ether + 1); if ((void*)(ip + 1) &gt; (void*)packet-&gt;ctx-&gt;data_end) { return XDP_DROP; /* malformed packet */ } packet-&gt;ip = ip; return process_ip(packet); } SEC("prog") int xdp_main(struct xdp_md* ctx) { struct Packet packet; packet.ctx = ctx; // A struct ethhdr* ether = (struct ethhdr*)(void*)ctx-&gt;data; if ((void*)(ether + 1) &gt; (void*)ctx-&gt;data_end) { return XDP_PASS; } packet.ether = ether; return process_ether(&amp;packet); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฃููุช ุงูุงูุชุจุงู ุฅูู ุงููุญูุตุชูู A ู B. ุฅุฐุง ุนููุช ุนูู A ุ ูุณูุชู ุชุฌููุน ุงูุจุฑูุงูุฌ ุ ูููู ุณูููู ููุงู ุฎุทุฃ ูู ุงูุชุญูู ุฃุซูุงุก ุงูุชุญููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Verifier analysis: &lt;...&gt; 11: (7b) *(u64 *)(r10 -48) = r1 12: (71) r3 = *(u8 *)(r7 +13) invalid access to packet, off=13 size=1, R7(id=0,off=0,r=0) R7 offset is outside of the packet processed 11 insns (limit 1000000) max_states_per_insn 0 total_states 0 peak_states 0 mark_read 0 Error fetching program/map!</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุณุทุฑ ุงูููุชุงุญ ูู <code>invalid access to packet, off=13 size=1, R7(id=0,off=0,r=0)</code> : ููุงู ูุณุงุฑุงุช ููุชูููุฐ ุนูุฏูุง ุชููู ุงูุจุงูุชุฉ ุงูุซุงูุซุฉ ุนุดุฑุฉ ูู ุจุฏุงูุฉ ุงููุฎุฒู ุงููุคูุช ุฎุงุฑุฌ ุงูุญุฒูุฉ.  ููููุง ููุงุฆูุฉ ุงูุจูุงูุงุช ุ ูู ุงูุตุนุจ ููู ุฃู ุณุทุฑ ูุชุญุฏุซ ุนูู ุ ูููู ููุฌุฏ ุฑูู ุชุนูููู (12) ููููู ููุถุญ ุฃุณุทุฑ ุงูููุฏ ุงููุตุฏุฑู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">llvm-objdump -S xdp_filter.o | less</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ูุฐู ุงูุญุงูุฉ ุ ูุดูุฑ ุฅูู ุณูุณูุฉ </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">LOG("Ether(proto=0x%x)", bpf_ntohs(ether-&gt;h_proto));</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงูุชู ูู ุงููุงุถุญ ุฃู ุงููุดููุฉ ูู <code>ether</code> .  ุณูููู ุฏุงุฆูุง ูุฐูู. </p><br><h3 id="otvet-na-syn" style=";text-align:right;direction:rtl">  ุงูุฑุฏ ุนูู SYN </h3><br><p style=";text-align:right;direction:rtl">  ุงููุฏู ูู ูุฐู ุงููุฑุญูุฉ ูู ุชูููู ุญุฒูุฉ SYNACK ุตุญูุญุฉ ูุน <code>seqnum</code> ุซุงุจุช ุ ูุงูุฐู ุณูุชู ุงุณุชุจุฏุงูู ุจููู ุชุนุฑูู ุงุฑุชุจุงุท SYN ูู ุงููุณุชูุจู.  ุชุญุฏุซ ูู ุงูุชุบููุฑุงุช ูู <code>process_tcp_syn()</code> ูุงูููุทูุฉ ุงููุญูุทุฉ ุจูุง. </p><br><h4 id="proverka-paketa" style=";text-align:right;direction:rtl">  ูุญุต ุงูุญุฒูุฉ </h4><br><p style=";text-align:right;direction:rtl">  ูู ุงูุบุฑูุจ ุฃู ูุฐุง ูู ุงูุฎุท ุงูุฃูุซุฑ ุจุฑูุฒูุง ุ ูุจุดูู ุฃูุซุฑ ุฏูุฉ ุ ุชุนููู ุนููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/* Required to verify checksum calculation */ const void* data_end = (const void*)ctx-&gt;data_end;</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุนูุฏ ูุชุงุจุฉ ุงูุฅุตุฏุงุฑ ุงูุฃูู ูู ุงูููุฏ ุ ุชู ุงุณุชุฎุฏุงู kernel 5.1 ุ ููุงู ููุงู ูุฑู ุจูู <code>data_end</code> ู <code>(const void*)ctx-&gt;data_end</code> .  ุนูุฏ ูุชุงุจุฉ ุงูููุงูุฉ ุ ูู ููู ูุฏู 5.3.1 kernel ูุฐู ุงููุดููุฉ.  ุฑุจูุง ูุงู ุงููุชุฑุฌู ุจุงููุตูู ุฅูู ุงููุชุบูุฑ ุงููุญูู ุจุดูู ูุฎุชูู ุนู ุงูุญูู.  ุงูุดูุฑุฉ ุงูุฃุฎูุงููุฉ ุงููุจุณุทุฉ ูููู ุฃู ุชุณุงุนุฏ ูู ุงููุซูุฑ ูู ุงูุชุนุดูุด. </p><br><p style=";text-align:right;direction:rtl">  ูุฒูุฏ ูู ุงููุญูุตุงุช ุงูุฑูุชูููุฉ ููุฃุทูุงู ุนูู ุดุฑู ุงููุฏูู  ุญูู <code>MAX_CSUM_BYTES</code> ุฃุฏูุงู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">const u32 ip_len = ip-&gt;ihl * 4; if ((void*)ip + ip_len &gt; data_end) { return XDP_DROP; /* malformed packet */ } if (ip_len &gt; MAX_CSUM_BYTES) { return XDP_ABORTED; /* implementation limitation */ } const u32 tcp_len = tcp-&gt;doff * 4; if ((void*)tcp + tcp_len &gt; (void*)ctx-&gt;data_end) { return XDP_DROP; /* malformed packet */ } if (tcp_len &gt; MAX_CSUM_BYTES) { return XDP_ABORTED; /* implementation limitation */ }</code> </pre> <br><h4 id="razvorot-paketa" style=";text-align:right;direction:rtl">  ุญุฒูุฉ ุงูุชุดุงุฑ </h4><br><p style=";text-align:right;direction:rtl">  ุงููุฃ <code>seqnum</code> ู <code>acknum</code> ุ ุงุถุจุท ACK (ุชู ุถุจุท SYN ุจุงููุนู): </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">const u32 cookie = 42; tcp-&gt;ack_seq = bpf_htonl(bpf_ntohl(tcp-&gt;seq) + 1); tcp-&gt;seq = bpf_htonl(cookie); tcp-&gt;ack = 1;</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุชุจุฏูู ููุงูุฐ TCP ูุนููุงู IP ูุนููุงู MAC.  ูุง ูููู ุงููุตูู ุฅูู ุงูููุชุจุฉ ุงูููุงุณูุฉ ูู ุจุฑูุงูุฌ XDP ุ ูุฐูู <code>memcpy()</code> ูู ูุงูุฑู ูุฎูู ููุงูุฌ ูุถูููุง. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">const u16 temp_port = tcp-&gt;source; tcp-&gt;source = tcp-&gt;dest; tcp-&gt;dest = temp_port; const u32 temp_ip = ip-&gt;saddr; ip-&gt;saddr = ip-&gt;daddr; ip-&gt;daddr = temp_ip; struct ethhdr temp_ether = *ether; memcpy(ether-&gt;h_dest, temp_ether.h_source, ETH_ALEN); memcpy(ether-&gt;h_source, temp_ether.h_dest, ETH_ALEN);</code> </pre> <br><h4 id="pereschet-kontrolnyh-summ" style=";text-align:right;direction:rtl">  ุงุฎุชุจุงุฑู ุฅุนุงุฏุฉ ุญุณุงุจ </h4><br><p style=";text-align:right;direction:rtl">  ุชุชุทูุจ ุนูููุงุช ุงุฎุชุจุงุฑ IPv4 ู TCP ุฅุถุงูุฉ ุฌููุน ุงููููุงุช ุฐุงุช 16 ุจุช ูู ุงูุฑุคูุณ ุ ููุง ุฃู ุญุฌู ุงูุฑุคูุณ ููุชูุจ ูููุง ุ ุฃู ุฃูู ูู ููุช ุงูุชุฌููุน ุ ูููู ุงูุฃูุฑ ุบูุฑ ูุนุฑูู.  ูุฐู ูุดููุฉ ูุฃู ุงููุฏูู ูู ูุชุฎุทู ุญููุฉ ููุชุธูุฉ ุฅูู ุญุฏูุฏ ูุชุบูุฑุฉ.  ููู ุญุฌู ุงูุฑุคูุณ ูุญุฏูุฏ: ูุง ูุตู ุฅูู 64 ุจุงูุช ููู ููููุง.  ููููู ุฅูุดุงุก ุญููุฉ ูุน ุนุฏุฏ ุซุงุจุช ูู ุงูุชูุฑุงุฑุงุช ุ ูุงูุชู ูููู ุฃู ุชูุชูู ูุจู ุงูููุนุฏ ุงููุญุฏุฏ. </p><br><p style=";text-align:right;direction:rtl">  ุฃูุงุญุธ ุฃู ููุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">RFC 1624</a> ุญูู ููููุฉ ุฅุนุงุฏุฉ ุญุณุงุจ ุงููุฌููุน ุงูุงุฎุชุจุงุฑู ุฌุฒุฆููุง ุฅุฐุง ุชู ุชุบููุฑ ูููุงุช ุงูุญุฒูุฉ ุงูุซุงุจุชุฉ ููุท.  ููุน ุฐูู ุ ูุฅู ุงูุทุฑููุฉ ููุณุช ุนุงูููุฉ ุ ูุณูููู ุงูุชูููุฐ ุฃูุซุฑ ุตุนูุจุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุงุฎุชุจุงุฑู ุญุณุงุจ ูุธููุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">#define MAX_CSUM_WORDS 32 #define MAX_CSUM_BYTES (MAX_CSUM_WORDS * 2) INTERNAL u32 sum16(const void* data, u32 size, const void* data_end) { u32 s = 0; #pragma unroll for (u32 i = 0; i &lt; MAX_CSUM_WORDS; i++) { if (2*i &gt;= size) { return s; /* normal exit */ } if (data + 2*i + 1 + 1 &gt; data_end) { return 0; /* should be unreachable */ } s += ((const u16*)data)[i]; } return s; }</code> </pre> <br><p style=";text-align:right;direction:rtl">   ,  <code>size</code>   ,    ,      . </p><br><p style=";text-align:right;direction:rtl">  32-     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">INTERNAL u32 sum16_32(u32 v) { return (v &gt;&gt; 16) + (v &amp; 0xffff); }</code> </pre> <br><p style=";text-align:right;direction:rtl">        : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">ip-&gt;check = 0; ip-&gt;check = carry(sum16(ip, ip_len, data_end)); u32 tcp_csum = 0; tcp_csum += sum16_32(ip-&gt;saddr); tcp_csum += sum16_32(ip-&gt;daddr); tcp_csum += 0x0600; tcp_csum += tcp_len &lt;&lt; 8; tcp-&gt;check = 0; tcp_csum += sum16(tcp, tcp_len, data_end); tcp-&gt;check = carry(tcp_csum); return XDP_TX;</code> </pre> <br><p style=";text-align:right;direction:rtl">  <code>carry()</code>   32-  16-   ,  RFC 791. </p><br><h4 id="proverka-rukopozhatiya-tcp" style=";text-align:right;direction:rtl">   TCP </h4><br><p style=";text-align:right;direction:rtl">      <code>netcat</code> ,   ACK,   Linux  RST-,       SYN โ     SYNACK    -       ,     . </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ sudo ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> xdp-test nc -nv 192.0.2.1 6666 192.0.2.1 6666: Connection reset by peer</code> </pre> <br><p style=";text-align:right;direction:rtl">        <code>tcpdump</code>  <code>xdp-remote</code>  , , <code>hping3</code>      . </p><br><h3 id="syn-cookie" style=";text-align:right;direction:rtl"> SYN cookie </h3><br><p style=";text-align:right;direction:rtl">    XDP   .    , ,    .  Linux, ,   SipHash,     XDP     . </p><br><p style=";text-align:right;direction:rtl">    TODO,    : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"> XDP-    <code>cookie_seed</code> (  )   ,    ,         . </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">   SYN cookie  ACK-    ,   IP  ,     . </p><br></li></ul><br><p style=";text-align:right;direction:rtl">   : </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ sudoip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> xdp-test nc -nv 192.0.2.1 6666 192.0.2.1 6666: Connection reset by peer</code> </pre> <br><p style=";text-align:right;direction:rtl">      ( <code>flags=0x2</code> โ  SYN, <code>flags=0x10</code> โ  ACK): </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Ether(proto=0x800) IP(src=0x20e6e11a dst=0x20e6e11e proto=6) TCP(sport=50836 dport=6666 flags=0x2) Ether(proto=0x800) IP(src=0xfe2cb11a dst=0xfe2cb11e proto=6) TCP(sport=50836 dport=6666 flags=0x10) cookie matches for client 20200c0</code> </pre> <br><p style=";text-align:right;direction:rtl">     IP,    SYN flood  ,     ACK flood,   : </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">sudo ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> xdp-test hping3 --flood -A -s 1111 -p 2222 192.0.2.1</code> </pre> <br><p style=";text-align:right;direction:rtl">   : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Ether(proto=0x800) IP(src=0x15bd11a dst=0x15bd11e proto=6) TCP(sport=3236 dport=2222 flags=0x10) cookie mismatch</code> </pre> <br><h2 id="zaklyuchenie" style=";text-align:right;direction:rtl">  ุงุณุชูุชุงุฌ </h2><br><p style=";text-align:right;direction:rtl">  eBPF   XDP        ,     . , XDP โ      ,     ,  DPDK    kernel bypass.   , XDP     , ,   ,       .     ,          userspace-. </p><br><p style=";text-align:right;direction:rtl">   ,   ,       ,     userspace-   . </p><br><p style=";text-align:right;direction:rtl">  ุงููุฑุงุฌุน: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><strong>   GitHub</strong></a> </li><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">bpftrace Cheat Sheet</a> </li><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">BPF and XDP Reference Guide</a> </li><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">XDP Tutorial</a> </li><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">PoC: compiling to eBPF from Rust</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar473286/">https://habr.com/ru/post/ar473286/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar473274/index.html">ุงูุฃุญุฏุงุซ ุงูุฑูููุฉ ูู ููุณูู ูู 28 ุฃูุชูุจุฑ - 3 ููููุจุฑ</a></li>
<li><a href="../ar473276/index.html">ุงูุฃุญุฏุงุซ ุงูุฑูููุฉ ูู ุณุงู ุจุทุฑุณุจุฑุฌ ูู 28 ุฃูุชูุจุฑ - 3 ููููุจุฑ</a></li>
<li><a href="../ar473278/index.html">ุชุญุฏูุซ ูุญุทุฉ ูููุฏูุฒ: ูุนุงููุฉ 1910</a></li>
<li><a href="../ar473282/index.html">ุงูุจุงุฑุซูููู. ุฃุตุญุงุจ ุงููููุงุฑุงุช ุงูุนุดูุงุฆูุฉ: ููู ุฃุตุจุญ ุงูุฃุฎูุงู ุจูุฎูุงู ุฃุตุญุงุจ ุงููููุงุฑุงุช ุ ูุนูู ุงูุฅูุชุฑูุช ููููุบุฏุง - ุงูุนุงูููุฉ</a></li>
<li><a href="../ar473284/index.html">ูุจุงุฑ ุ TechLead ุ ูููุฏุณ ูุนูุงุฑู - ูุงุฐุง ุจุนุฏุ ููููุฉ ุงูุชุนุงูู ูุน ุฑูุชูู ุงูุนูู ูุฃูู ุงููุถู ูุฏูุงุ</a></li>
<li><a href="../ar473288/index.html">ุจูุงุก ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูุฎุงุตุฉ ุจู ูู ููุทุฉ ุงูุตูุฑ ุ ูุณูู ุชุถุฎ ูุณุชูุงู</a></li>
<li><a href="../ar473290/index.html">ุฌูููุง. ูู ุฃูู ุชุจุฏุฃ ุงููุดุฑูุนุ ...</a></li>
<li><a href="../ar473292/index.html">ููุฎุต ุงูููุงุฏ ุงููุซูุฑุฉ ููุงูุชูุงู ููุทููุฑ ุงูุจุฑุงูุฌ ุงููุญููู ุฑูู 319 (ูู ุงููุชุฑุฉ ูู 21 ุฅูู 27 ุฃูุชูุจุฑ)</a></li>
<li><a href="../ar473294/index.html">ุฅุฏุงุฑุฉ ุงูุฐุงูุฑุฉ ุฃู ุฃูู ูู ูุซูุฑ ูู ุงูุฃุญูุงู ุงุทูุงู ุงููุงุฑ ุนูู ููุณู ูู ุงููุฏู</a></li>
<li><a href="../ar473296/index.html">ุจุฏุก ุงูุชุดุบูู ุฏูู ุงููุงู. ุชุฌุฑุจุฉ ุดุฎุตูุฉ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>