<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåè üëµüèΩ üë∂üèº Sistema de entrega de configura√ß√£o de rede de filtragem Qrator ü§∏üèæ üòØ üë®üèΩ‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR : arquitetura cliente-servidor de nossa ferramenta de gerenciamento de configura√ß√£o interna, QControl. 
 No seu por√£o, h√° um protocolo de trans...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sistema de entrega de configura√ß√£o de rede de filtragem Qrator</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qrator/blog/463735/"><img src="https://habrastorage.org/webt/m2/ak/w7/m2akw7igwdnpnlkl-wtyczkznlc.jpeg"><br><br>  <b>TL; DR</b> : arquitetura cliente-servidor de nossa ferramenta de gerenciamento de configura√ß√£o interna, QControl. <br>  No seu por√£o, h√° um protocolo de transporte de duas camadas que trabalha com mensagens compactadas com gzip sem descompress√£o entre os pontos de extremidade.  Roteadores distribu√≠dos e pontos de extremidade recebem as atualiza√ß√µes de configura√ß√£o, e o pr√≥prio protocolo possibilita a instala√ß√£o de rel√©s localizados intermedi√°rios.  Ele √© baseado em um design de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">backup diferencial</a> (‚Äúrecente-est√°vel‚Äù, explicado mais adiante) e emprega a linguagem de consulta JMESpath e o modelo Jinja para renderiza√ß√£o da configura√ß√£o. <br><br>  O Qrator Labs opera e mant√©m uma rede de mitiga√ß√£o distribu√≠da globalmente.  Nossa rede √© anycast, com base no an√∫ncio de nossas sub-redes via BGP.  Ser uma rede anycast BGP localizada fisicamente em v√°rias regi√µes da Terra nos permite processar e filtrar o tr√°fego ileg√≠timo mais pr√≥ximo do backbone da Internet - operadores de n√≠vel 1. <br><br>  Por outro lado, ser uma rede geograficamente distribu√≠da tem suas dificuldades.  A comunica√ß√£o entre os pontos de presen√ßa da rede (PoP) √© essencial para um provedor de seguran√ßa ter uma configura√ß√£o coerente para todos os n√≥s da rede e atualiz√°-la de maneira oportuna e coesa.  Portanto, para oferecer o melhor servi√ßo poss√≠vel aos clientes, tivemos que encontrar uma maneira de sincronizar os dados de configura√ß√£o entre diferentes continentes de maneira confi√°vel. <br><blockquote>  No come√ßo, havia a Palavra ... que rapidamente se tornou o protocolo de comunica√ß√£o que precisava de uma atualiza√ß√£o. </blockquote><a name="habracut"></a><br>  O ponto principal da exist√™ncia do QControl e a principal raz√£o para gastar muito tempo e esfor√ßo na constru√ß√£o de um protocolo nosso √© a necessidade de obter uma fonte autorizada da configura√ß√£o e, eventualmente, sincronizar nossos PoPs com ela.  O armazenamento foi apenas um dos v√°rios recursos necess√°rios do desenvolvimento do QControl.  Al√©m disso, tamb√©m precisamos de integra√ß√£o com a periferia existente e futura, valida√ß√µes de dados inteligentes (e personaliz√°veis) e diferencia√ß√£o de acesso.  Al√©m disso, quer√≠amos que este sistema gerisse coisas atrav√©s de comandos, n√£o atrav√©s de modifica√ß√µes manuais nos arquivos.  Antes do QControl, os dados eram enviados para os pontos de presen√ßa mais ou menos manualmente.  Se algum PoP estava indispon√≠vel no momento e esquecemos de atualiz√°-lo mais tarde, a configura√ß√£o foi dessincronizada e foi necess√°ria uma solu√ß√£o de problemas demorada para traz√™-lo de volta √† sincroniza√ß√£o. <br><br>  Aqui est√° o sistema que criamos: <br><img src="https://habrastorage.org/getpro/habr/post_images/ee1/a25/5c0/ee1a255c01c5119a0f59191782817efb.png" alt="imagem"><br>  O servidor de configura√ß√£o √© respons√°vel pela valida√ß√£o e armazenamento de dados;  o roteador possui pontos de extremidade diferentes para receber e retransmitir atualiza√ß√µes de configura√ß√£o dos clientes e da equipe de suporte ao servidor e do servidor aos PoPs. <br><br>  A qualidade da conex√£o √† Internet ainda √© bastante diversificada em todo o mundo - para ilustrar isso, vamos visualizar um traceroute simples de Praga, Rep√∫blica Tcheca a Cingapura e Hong Kong. <br><br> <a href=""><img src="https://habrastorage.org/webt/ob/pl/vc/obplvcdpqlc8as-nra_jnpv4hbc.png" alt="imagem"></a> <br>  MTR de Praga para Singapura <br><br> <a href=""><img src="https://habrastorage.org/webt/4z/xo/7s/4zxo7sr_qqrg6cdlipwwvujohto.png" alt="imagem"></a> <br>  Mesma segunda captura de tela com traceroute para Hong Kong <br><br>  N√∫meros de alta lat√™ncia significam baixa velocidade.  Al√©m disso, h√° uma alta perda de pacotes.  Os n√∫meros de largura de banda n√£o compensam esse problema, que sempre deve ser levado em considera√ß√£o ao criar redes descentralizadas. <br><br>  A configura√ß√£o completa do PoP √© uma por√ß√£o de dados bastante significativa e precisa ser transferida para muitos receptores diferentes atrav√©s de conex√µes n√£o confi√°veis.  Felizmente, embora a configura√ß√£o mude com frequ√™ncia, ela muda em pequenos incrementos. <br><br><h3>  Projeto est√°vel recente </h3><br>  √â uma decis√£o bastante direta construir uma rede distribu√≠da com base em atualiza√ß√µes incrementais.  Embora existam alguns problemas com os diffs, eles s√£o dif√≠ceis de criar corretamente: precisamos salvar todos os diffs entre os pontos de refer√™ncia em algum lugar, para poder reenvi√°-los se algu√©m perder alguma coisa.  Todo destino deve aplic√°-los de forma coerente.  Caso haja v√°rios destinos, isso pode levar muito tempo em toda a rede.  O destinat√°rio tamb√©m deve poder solicitar pe√ßas ausentes e, √© claro, a parte central deve responder a essa solicita√ß√£o com precis√£o, enviando apenas os dados ausentes. <br><br>  O que constru√≠mos no final √© uma coisa - temos apenas uma camada de refer√™ncia, a fixa "est√°vel" e apenas uma diff, "recente".  Todo recente √© baseado no √∫ltimo est√°bulo e √© suficiente para reconstruir os dados de configura√ß√£o.  Quando um novo recente chega ao destino, o antigo √© descart√°vel. <br><br>  √Äs vezes, nos √© necess√°rio enviar uma nova configura√ß√£o est√°vel, porque as recentes crescem muito.  Al√©m disso, uma observa√ß√£o importante aqui √© que podemos fazer tudo isso transmitindo / transmitindo multicast atualiza√ß√µes, sem nos preocupar com a capacidade de receber destinos para montar as pe√ßas.  Depois de verificarmos que todos t√™m o est√°bulo certo, todos s√£o alimentados apenas com o recente recente.  Devemos dizer que funciona?  Faz.  Os est√°bulos s√£o armazenados em cache no servidor de configura√ß√£o e nos receptores, sendo os recentes recriados quando necess√°rio. <br><br><h3>  Arquitetura de transporte em duas camadas </h3><br>  Por que exatamente constru√≠mos nosso transporte com duas camadas?  A resposta √© bem simples: quer√≠amos dividir o roteamento do aplicativo, inspirando-nos no modelo OSI com suas camadas de transporte e aplicativo.  Portanto, separamos o protocolo de transporte (Thrift) do formato de serializa√ß√£o de comando de alto n√≠vel (msgpack).  √â por isso que um roteador (que faz multicast / broadcast / retransmiss√£o) nem olha dentro do msgpack, nem extrai ou comprime a carga √∫til e faz apenas a transmiss√£o. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Wiki</a> Thrift: <br>  <i>O Apache Thrift permite definir tipos de dados e interfaces de servi√ßo em um arquivo de defini√ß√£o simples.</i>  <i>Tomando esse arquivo como entrada, o compilador gera c√≥digo a ser usado para criar facilmente clientes e servidores RPC que se comunicam sem interrup√ß√µes nas linguagens de programa√ß√£o.</i>  <i>Em vez de escrever uma carga de c√≥digo padr√£o para serializar e transportar seus objetos e chamar m√©todos remotos.</i> <br><br>  Adotamos a estrutura Thrift por causa de seu RPC e suporte a v√°rios idiomas ao mesmo tempo.  Como sempre, as partes f√°ceis s√£o f√°ceis de construir: o cliente e o servidor.  No entanto, o roteador era muito dif√≠cil de quebrar, em parte devido √† aus√™ncia de uma solu√ß√£o pronta para uso no momento. <br><br><img src="https://habrastorage.org/webt/l8/so/6v/l8so6vrzh0u_feb60p6ehjbubs0.png" align="left">  Existem outras op√ß√µes, como o protobuf / gRPC, mas quando come√ßamos o projeto, o gRPC era imaturo e hesitamos em us√°-lo. <br><br>  Obviamente, n√≥s poder√≠amos (e dever√≠amos!) Criar nossa pr√≥pria roda.  Seria mais f√°cil criar um protocolo personalizado para o que precisamos, juntamente com o roteador, porque o cliente-servidor √© mais simples de programar do que criar um roteador funcional com o Thrift.  No entanto, h√° uma negatividade tradicional em rela√ß√£o a protocolos e implementa√ß√µes personalizadas de bibliotecas populares, e sempre h√° o "como podemos port√°-lo posteriormente para outros idiomas".  Por isso, decidimos abandonar as ideias indecorosas. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Descri√ß√£o do</a> Msgpack: <br>  <i>MessagePack √© um formato eficiente de serializa√ß√£o bin√°ria.</i>  <i>Permite trocar dados entre v√°rios idiomas, como JSON.</i>  <i>Mas √© mais r√°pido e menor.</i>  <i>Inteiros pequenos s√£o codificados em um √∫nico byte, e cadeias curtas t√≠picas requerem apenas um byte extra, al√©m das pr√≥prias cadeias.</i> <br><br>  Na primeira camada, temos um Thrift com as informa√ß√µes m√≠nimas necess√°rias para o roteador enviar uma mensagem.  Na segunda camada, n√≥s compactamos as estruturas do msgpack. <br>  Votamos no msgpack porque √© mais r√°pido e mais compacto em compara√ß√£o com o JSON.  No entanto, o que √© ainda mais importante √© que ele suporta tipos de dados personalizados, permitindo alguns recursos interessantes, como "apag√µes" e transfer√™ncia de dados bin√°rios brutos. <br><br>  <b>Jmespath</b> <br>  <i>JMESPath √© uma linguagem de consulta para JSON.</i> <br>  Essa √© a √∫nica descri√ß√£o que obtemos da documenta√ß√£o oficial do JMESPath, mas, na verdade, √© muito mais do que isso.  O JMESPath permite pesquisar e filtrar estruturas arbitr√°rias do tipo √°rvore e at√© aplicar transforma√ß√µes de dados em tempo real.  Usamos essa linguagem de consulta para obter informa√ß√µes relevantes do grande blob de configura√ß√£o. <br>  Embora toda a configura√ß√£o tenha uma estrutura semelhante a uma √°rvore, extra√≠mos as sub√°rvores relevantes para diferentes destinos de configura√ß√£o. <br><br>  Tamb√©m √© flex√≠vel o suficiente para alterar a sub√°rvore, independentemente de um modelo de configura√ß√£o ou de outros plugins de configura√ß√£o.  Para torn√°-lo ainda melhor, o JMES Path √© facilmente extens√≠vel e permite gravar filtros personalizados e rotinas de transforma√ß√£o de dados.  No entanto, ele precisa de algum poder intelectual para compreender. <br><br>  <b>Jinja</b> <br>  Para alguns destinos, precisamos renderizar a configura√ß√£o em arquivos; portanto, precisamos de um mecanismo de modelo, onde o Jinja √© uma escolha √≥bvia.  O Jinja est√° gerando um arquivo de configura√ß√£o a partir do modelo e dos dados recebidos no ponto de destino. <br><br>  Para renderizar o arquivo de configura√ß√£o, precisamos de uma solicita√ß√£o jmespath, modelo para o caminho e arquivo de destino, modelo para a pr√≥pria configura√ß√£o.  Al√©m disso, neste momento, √© bom especificar os direitos de acesso ao arquivo.  Felizmente, tudo isso foi combinado em um arquivo - antes do modelo de configura√ß√£o, colocamos um cabe√ßalho YAML, descrevendo o restante.  Por exemplo: <br> <code>--- <br> selector: "[@][?@.fft._meta.version == `42`] | items([0].fft_config || `{}`)" <br> destination_filename: "fft/{{ match[0] }}.json" <br> file_mode: 0644 <br> reload_daemons: [fft] <br> ... <br> {{ dict(match[1]) | json(indent=2, sort_keys=True) }} <br></code> <br>  Para fazer a configura√ß√£o de uma nova periferia, adicionamos um novo arquivo de modelo, nenhuma altera√ß√£o no c√≥digo fonte e atualiza√ß√µes de software PoP s√£o necess√°rias. <br><br>  O que mudou ap√≥s a implementa√ß√£o da ferramenta de gerenciamento de configura√ß√£o QControl? <br>  Em primeiro lugar, recebemos atualiza√ß√µes de configura√ß√£o coerentes e confi√°veis ‚Äã‚Äãem toda a nossa rede. <br>  Segundo, colocamos uma ferramenta poderosa para valida√ß√£o de configura√ß√£o e altera√ß√µes nas m√£os de nossa equipe de suporte e de nossos clientes. <br><br>  Conseguimos isso empregando um design est√°vel recente para simplificar a comunica√ß√£o entre o servidor de configura√ß√£o e os destinat√°rios da configura√ß√£o, usando o protocolo de comunica√ß√£o de duas camadas para oferecer suporte a roteadores independentes de carga √∫til e implementando o mecanismo de renderiza√ß√£o de configura√ß√£o baseado em Jinja para suportar uma grande variedade de arquivos de configura√ß√£o para nossa periferia diversificada. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt463735/">https://habr.com/ru/post/pt463735/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt463719/index.html">Ferramentas do m√©todo de gerenciamento de projetos (parte 2)</a></li>
<li><a href="../pt463725/index.html">Petty little joy # 9: aplicativos de console com rosto humano</a></li>
<li><a href="../pt463727/index.html">Como entrar no topo do Google na UE / EUA no nicho de desenvolvimento e encontrar clientes com grandes or√ßamentos</a></li>
<li><a href="../pt463729/index.html">Encontro com o fundador do NSTR Viktor Chernikov</a></li>
<li><a href="../pt463733/index.html">Mesh VS WiFi: o que escolher para wireless?</a></li>
<li><a href="../pt463737/index.html">Resolu√ß√£o de problemas com pwnable.kr 21 - horcuxes. Programa√ß√£o orientada a retorno e cadeias ROP</a></li>
<li><a href="../pt463739/index.html">Sistema de Gerenciamento de Configura√ß√£o de Rede Qrator Filter</a></li>
<li><a href="../pt463741/index.html">Firefox (j√° corrigido) e Chrome permitem usar o cabe√ßalho Alt-Svc para verificar portas da intranet</a></li>
<li><a href="../pt463745/index.html">Complicar C ++ √© inevit√°vel. E n√£o apenas C ++</a></li>
<li><a href="../pt463747/index.html">Acessar propriedades dentro do campo Jsonb para Npgsql</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>