<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêò ü§æüèΩ üñ•Ô∏è OpenVPN avec authentification et autorisation avanc√©es üë©üèø‚Äçü§ù‚Äçüë©üèº üë©üèø‚Äçüç≥ üëºüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'article d√©crit la configuration d'OpenVPN avec des fonctionnalit√©s suppl√©mentaires: 



- Certificats de jeton pour l'authentification principale (R...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OpenVPN avec authentification et autorisation avanc√©es</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/433250/">  L'article d√©crit la configuration d'OpenVPN avec des fonctionnalit√©s suppl√©mentaires: <br><br><ul><li>  Certificats de jeton pour l'authentification principale (Rutoken comme exemple) </li><li>  Backend LDAP pour l'authentification secondaire (en utilisant ActiveDirectory comme exemple) </li><li>  filtrage des ressources internes disponibles pour les utilisateurs (via iptables) </li></ul><br>  Il d√©crit √©galement comment configurer les clients pour Linux, Windows et MacOS. <br><a name="habracut"></a><br><h3>  Configuration du serveur </h3><br><h4>  Installer OpenVPN </h4><br>  Prenez le script <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nyr / openvpn-install</a> , ex√©cutez √† partir de la racine. <br><br><pre><code class="plaintext hljs">git clone https://github.com/Nyr/openvpn-install.git cd openvpn-install</code> </pre> <br>  Le processus de d√©marrage posera quelques questions. <br><br><ul><li>  protocole udp </li><li>  port 1194 </li><li>  Serveurs DNS - locaux </li><li>  IP externe - adresse de passerelle sur Internet via laquelle le serveur VPN sera disponible </li></ul><br>  Il existe √©galement une version s√©curis√©e du script d'origine - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/Angristan/OpenVPN-install</a> .  Il a plus de param√®tres de cryptage et explique pourquoi. <br><br><h4>  Gestion des utilisateurs </h4><br>  <b>Ajout</b> <br>  Si les jetons ne sont pas utilis√©s, l'utilisateur est ajout√© via le m√™me script.  Le script g√©n√®re essentiellement une configuration ovpn personnalis√©e et y ins√®re un certificat sign√© par le certificat racine. <br><br>  Si des jetons sont utilis√©s (voir la section sur les jetons ci-dessous), le certificat est √©crit manuellement en fonction de la demande de certificat g√©n√©r√©e sur le jeton.  La configuration utilisateur doit √™tre effectu√©e manuellement √† partir du mod√®le existant (√† partir du m√™me mod√®le √† partir duquel le script de configuration est g√©n√©r√©).  Le mod√®le est ici <code>/etc/openvpn/client-common.txt</code> .  Il n'est pas inclus dans le package openvpn et est g√©n√©r√© par le script pendant le processus de configuration. <br><br>  <b>Effacer</b> <br>  La suppression d'utilisateurs se fait via le m√™me script d'installation.  Le certificat est ajout√© √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CRL</a> , la nouvelle CRL est envoy√©e au serveur VPN.  Le serveur consid√®re tous les certificats qui sont en CRL non valides et refuse d'accepter. <br><br>  Comment r√©voquer un certificat manuellement: <br><br><pre> <code class="plaintext hljs">cd /etc/openvpn/easyrsa #   ./easyrsa revoke $CLIENT #   crl ./easyrsa gen-crl #   crl rm -rf /etc/openvpn/crl.pem #    cp /etc/openvpn/easy-rsa/pki/crl.pem /etc/openvpn/crl.pem # openvpn    crl,       nobody chown nobody:nobody /etc/openvpn/crl.pem</code> </pre><br><h4>  Filtrage des h√¥tes disponibles pour les clients </h4><br>  Les clients doivent √™tre limit√©s par les h√¥tes auxquels ils peuvent acc√©der sur le r√©seau lorsqu'ils se connectent √† openvpn. <br><br>  <b>Manuellement</b> <br><br>  L'id√©e est d'attraper les paquets m√™me sur l'interface <code>tun0</code> , dans laquelle ils proviennent des clients et de les filtrer avant d'entrer dans le NAT.  Apr√®s NAT, il n'y aura aucune raison de les filtrer - ils auront tous une adresse IP de serveur openvpn sur le r√©seau interne.  Avant d'entrer dans le NAT, les paquets pour chaque utilisateur ont leur propre adresse IP unique (pour la correspondance des adresses IP et des utilisateurs, voir le fichier <code>/etc/openvpn/ipp.txt</code> ). <br><br>  Les paquets qui transitent par le syst√®me (ne proviennent pas directement de celui-ci et ne sont pas entrants, c'est-√†-dire en fait achemin√©s par le syst√®me) sont trait√©s par la table FORWARD.  Les tables dans iptables sont trait√©es de haut en bas, si aucune des r√®gles du tableau n'a conduit √† une d√©cision sur le sort du paquet, alors la r√®gle par d√©faut est d√©clench√©e. <br><br>  Pr√©paration de la table FORWARD: <br><br><pre> <code class="plaintext hljs">#   iptables -F FORWARD #     FORWARD -    iptables -P FORWARD DROP #     iptables -I FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT</code> </pre><br>  Exemples de r√®gles pour un client sp√©cifique.  √âtant donn√© que la r√®gle par d√©faut pour la table est DROP, il ne reste qu'√† autoriser ces paires h√¥te + port o√π vous le pouvez.  Autorisez l'acc√®s au port sur l'h√¥te + envoyez un ping √† l'h√¥te lui-m√™me: <br><br><pre> <code class="plaintext hljs">iptables -I FORWARD -s 10.8.0.3 -i tun0 -d 10.0.2.3 -p tcp --dport 443 -j ACCEPT iptables -I FORWARD -s 10.8.0.3 -i tun0 -d 10.0.2.3 -p icmp --icmp-type echo-request -j ACCEPT</code> </pre><br>  Dans l'exemple ci-dessus, l'h√¥te 10.8.0.3 est autoris√© √† acc√©der au port 443 de l'h√¥te 10.0.2.3. <br><br>  Comment fermer l'acc√®s: <br><br><pre> <code class="plaintext hljs">#         iptables -L FORWARD --line-numbers #     iptables -D FORWARD { }</code> </pre><br>  Ensuite, vous devez trouver toutes les r√®gles pour un client particulier et les supprimer. <br><br>  Pendant le d√©bogage, il est pratique de voir quelles r√®gles fonctionnent.  Chaque r√®gle a un compteur de paquets trait√©s. <br><br><pre> <code class="plaintext hljs">#  ,      watch iptables -nvL FORWARD #     iptables -Z FORWARD</code> </pre><br>  <b>Automatiquement</b> <br><br>  Un serveur openvpn a la possibilit√© d'ex√©cuter des scripts pour certaines actions.  En particulier, lors de la connexion et de la d√©connexion de clients.  Les scripts peuvent √™tre √©crits sur n'importe quoi si seulement ils sont ex√©cutables.  √Ä l'int√©rieur du script, les variables d'environnement transmettent toutes sortes de param√®tres √† la connexion actuelle.  Nous nous int√©ressons aux variables: <br><br><ul><li>  <code>common_name</code> (nom du propri√©taire du certificat; ce qui conduit dans le champ du nom commun lors de la cr√©ation du certificat) </li><li>  <code>ifconfig_pool_remote_ip</code> (adresse IP client sur tun0) </li><li>  <code>script_type</code> (quel √©v√©nement s'est produit - se connecter ou se d√©connecter). </li></ul><br>  Vous avez besoin des privil√®ges root pour g√©rer iptables.  Openvpn apr√®s la connexion r√©initialise les droits sur personne et ex√©cute des scripts √† partir de celui-ci.  Il est mauvais de ne permettre √† personne de faire quelque chose sous sudo, et il vaut mieux ne pas utiliser d'ast√©risque dans les r√®gles, mais vous devez en quelque sorte permettre √† l'utilisateur de contr√¥ler iptables. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/sudoers.d/50_openvpn # #    nobody ALL = NOPASSWD: /sbin/iptables -A FORWARD* #     nobody ALL = NOPASSWD: /sbin/iptables -L FORWARD* #    nobody ALL = NOPASSWD: /sbin/iptables -D FORWARD*</span></span></code> </pre><br>  Dans la configuration du serveur, vous devez ajouter l'autorisation d'ex√©cuter des fichiers tiers et activer deux hooks responsables de la connexion et de la d√©connexion de l'utilisateur. <br><br><pre> <code class="bash hljs">script-security 2 client-connect /etc/openvpn/bin/hosts.rb client-disconnect /etc/openvpn/bin/hosts.rb</code> </pre><br>  Le script lui-m√™me, qui lit les configurations et applique les r√®gles pour iptables.  Le script fonctionne selon les m√™mes principes que ceux d√©crits dans la section pr√©c√©dente. <br><br><div class="spoiler">  <b class="spoiler_title">/openvpn/bin/hosts.rb</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/ruby # -*- coding: utf-8 -*- require 'pp' def log(string) puts 'hosts.rb: ' + string end def parse_config_file(name) config_path = "hosts/#{name}" unless File.exist?(config_path) puts "There is no specific configuration for #{name}." p name exit 0 end config_source = IO.read(config_path).split("\n") config = config_source.inject([]) do |result,line| ip, port, protocol = line.split(/\s+/) result &lt;&lt; { ip: ip, port: port, protocol: protocol || 'tcp' } end end def get_config(name) user_config = parse_config_file(name) if user_config everybody_config = parse_config_file('everybody') end everybody_config + user_config end def apply_rule(rule) command = "sudo iptables #{rule}" log(command) system(command) end def remove_rule(number) command = "sudo iptables -D FORWARD #{number}" log(command) system(command) end def allow_target(source_ip, options) #         . apply_rule("-A FORWARD -s #{source_ip} -i tun0 -d #{options[:ip]} -p #{options[:protocol]} --dport #{options[:port]} -j ACCEPT") #       apply_rule("-A FORWARD -s #{source_ip} -i tun0 -d #{options[:ip]} -p icmp --icmp-type echo-request -j ACCEPT") end def clear_targets(source_ip) #      FORWARD,  source_ip. rules_exist = true while rules_exist table = `sudo iptables -L FORWARD --line-number`.split("\n") the_line = table.find do |line| fields = line.split(/\s+/) ip = fields[4] ip == source_ip end if the_line number = the_line.split(/\s+/)[0] remove_rule(number) else rules_exist = false end end end ################################################################################ script_type = ENV['script_type'] log(script_type) name = ENV['common_name'] source_ip = ENV['ifconfig_pool_remote_ip'] case script_type when 'client-connect' config = get_config(name) config.each{|target| allow_target(source_ip, target)} when 'client-disconnect' clear_targets(source_ip) else puts "Unknown script type #{script_type}." end</span></span></code> </pre></div></div><br>  Les r√®gles sont stock√©es dans des fichiers correspondant au nom commun des certificats dans le dossier <code>/etc/openvpn/hosts</code> .  Ils sp√©cifient exactement quelles adresses IP sont disponibles pour un client particulier.  S√©parateur - un nombre arbitraire d'espaces.  L'adresse IP, le port et le protocole (tcp ou udp) sont √©crits via le s√©parateur. <br><br><pre> <code class="bash hljs">10.0.0.24 53 udp 10.0.0.25 53 udp 10.0.2.3 443 tcp</code> </pre><br>  Par cons√©quent, la structure suivante doit <code>/etc/openvpn</code> dans le dossier <code>/etc/openvpn</code> <br><br>  ‚îú‚îÄ‚îÄ bin <br>  ‚îÇ ‚îî‚îÄ‚îÄ hosts.rb <br>  ‚îú‚îÄ‚îÄ h√¥tes <br>  ‚îÇ ‚îú‚îÄ‚îÄ user1 <br>  ‚îÇ ‚îú‚îÄ‚îÄ user2 <br>  ‚îÇ ‚îî‚îÄ‚îÄ tout le monde <br>  ‚îú‚îÄ‚îÄ server.conf <br>  ‚îî‚îÄ‚îÄ ... <br><br>  <code>User1</code> et <code>user2</code> sont des fichiers dans le format ci-dessus.  Ils d√©crivent les h√¥tes auxquels l'utilisateur avec le nom commun correspondant a acc√®s. <br><br>  Il existe un autre fichier suppl√©mentaire pour <code>everybody</code> le <code>everybody</code> , il contient des r√®gles qui s'appliquent √† tous les clients, √† condition qu'il existe un fichier de configuration distinct pour ces clients.  Autrement dit, si l'utilisateur a une liste d'h√¥tes o√π il peut aller, alors cette liste et les h√¥tes r√©pertori√©s dans <code>everybody</code> appliqu√©s.  Sinon, <code>everybody</code> pas applicable.  Par exemple, il est pratique de placer un serveur DNS dans ce fichier. <br><br>  <b>Journalisation</b> <br><br>  Le script d'installation comprend uniquement la journalisation des connexions actuelles (param√®tre d' <code>status)</code> .  Pour qu'un journal r√©gulier apparaisse, vous devez ajouter une ligne √† la configuration du serveur ( <code>/etc/openvpn/server.conf</code> ): <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-append /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/openvpn.log</code> </pre> <br><br>  <b>LDAP</b> <br><br>  Il existe un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plugin openvpn-auth-ldap</a> qui vous permet d'authentifier √† nouveau un utilisateur via LDAP. <br><br>  Livrer le colis: <br><br><pre> <code class="plaintext hljs">sudo yum install openvpn-auth-ldap</code> </pre> <br>  Ajoutez √† server.conf: <br><br><pre> <code class="plaintext hljs">plugin /usr/lib64/openvpn/plugin/lib/openvpn-auth-ldap.so "/etc/openvpn/ldap.conf"</code> </pre> <br>  Cr√©ez une configuration pour ldap dans <code>/etc/openvpn/ldap.conf</code> : <br><pre> <code class="plaintext hljs">&lt;LDAP&gt; URL ldaps://{LDAP_DOMAIN_HERE} Timeout 15 TLSEnable no FollowReferrals yes BindDN "BIND_DN_HERE" Password "BIND_PASSWORD_HERE" &lt;/LDAP&gt; &lt;Authorization&gt; BaseDN "{BASE_DN_HERE}" SearchFilter "(&amp;(sAMAccountName=%u)(objectClass=organizationalPerson)(objectCategory=person)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))" RequireGroup false &lt;/Authorization&gt;</code> </pre><br>  Ajoutez la ligne √† la configuration ovpn personnalis√©e: <br><br><pre> <code class="plaintext hljs">auth-user-pass</code> </pre> <br>  Ainsi, l'utilisateur sera d'abord demand√© le nom d'utilisateur et le mot de passe du domaine, puis le code PIN du jeton.  Si l'une de ces √©tapes √©choue, la connexion ne sera pas √©tablie. <br><br>  La description des options de ldap.conf se <a href="">trouve dans le r√©f√©rentiel de plugins</a> .  Il prend en charge l'authentification par appartenance √† un groupe, mais je ne l'ai pas test√©. <br><br><h4>  La vitesse </h4><br>  La plus grande augmentation de vitesse donne l'inclusion du mode udp.  Ceci est conseill√© dans tous les manuels.  Le fait est que cela n'a aucun sens de d√©marrer une connexion client TCP dans un canal TCP.  Un tcp chez le client suffit pour effectuer la livraison correcte des paquets.  Si des paquets sont perdus dans le canal udp, la connexion TCP client contr√¥lera l'ajustement de la livraison. <br><br>  La vitesse augmentera au moins car il n'est pas n√©cessaire d'attendre la confirmation de la livraison de chaque paquet dans le canal.  Il y a un deuxi√®me probl√®me avec TCP - un paquet TCP client ne correspond probablement pas √† un paquet du canal VPN.  MTU est le m√™me, mais les en-t√™tes doivent √™tre ajout√©s au package client.  En cons√©quence, vous devez envoyer deux paquets dans le canal vpn par paquet utilisateur. <br><br>  TCP est logique √† utiliser lorsqu'il est impossible d'une autre mani√®re.  Par exemple, lorsque vpn fonctionne via le canal ssh. <br><br><h4>  Exemple de configuration compl√®te d'un serveur </h4><br><div class="spoiler">  <b class="spoiler_title">exemple-serveur.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">port 1194 proto tcp dev tun sndbuf 0 rcvbuf 0 ca ca.crt cert server.crt key server.key dh dh.pem tls-auth ta.key 0 topology subnet server 10.8.0.0 255.255.255.0 ifconfig-pool-persist ipp.txt push "redirect-gateway def1 bypass-dhcp" push "dhcp-option DNS 10.0.0.25" push "dhcp-option DNS 10.0.0.24" keepalive 10 120 cipher AES-256-CBC comp-lzo user nobody group nobody persist-key persist-tun status openvpn-status.log verb 3 crl-verify crl.pem log-append /var/log/openvpn.log script-security 2 client-connect /etc/openvpn/bin/hosts.rb client-disconnect /etc/openvpn/bin/hosts.rb</code> </pre><br></div></div><br><h3>  Configuration du jeton </h3><br><h4>  Biblioth√®que PKCS # 11 </h4><br>  Pour travailler avec des jetons, vous avez besoin d'une biblioth√®que sp√©ciale.  La biblioth√®que est n√©cessaire √† la fois pour cr√©er des paires de cl√©s et pour la connexion r√©elle.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">T√©l√©chargez pour toutes les plateformes par le lien</a> . <br><br>  Partout o√π librtpkcs11ecp.so se trouvera plus tard - c'est la biblioth√®que m√™me qui doit √™tre t√©l√©charg√©e et plac√©e quelque part dans un endroit pratique. <br><br><h4>  Cr√©ation d'un certificat sur un jeton </h4><br>  G√©n√©rez une paire de cl√©s sur le jeton.  Le param√®tre id ici est le num√©ro de s√©rie de l'emplacement sur le jeton o√π la paire de cl√©s s'adapte. <br><br><pre> <code class="plaintext hljs">pkcs11-tool --module /usr/lib64/librtpkcs11ecp.so --keypairgen --key-type rsa:2048 -l --id 01</code> </pre><br>  Faites une demande de certificat pour la cl√© publique.  Lors de la cr√©ation d'une demande de certificat, la dur√©e de vie du certificat et le nom commun sont d√©finis, ce qui est utilis√© pour filtrer les adresses IP disponibles au sein du r√©seau.  Le nom commun doit correspondre √† la connexion dans ActiveDirectory pour qu'il n'y ait aucune confusion. <br><br><pre> <code class="plaintext hljs">openssl openssl&gt; engine -t dynamic -pre SO_PATH:/usr/lib64/openssl/engines/pkcs11.so -pre ID:pkcs11 -pre LIST_ADD:1 -pre LOAD -pre MODULE_PATH:/usr/lib64/librtpkcs11ecp.so openssl&gt; req -engine pkcs11 -new -key slot_0-id_01 -keyform engine -out /home/john/good.req</code> </pre><br>  La demande re√ßue doit √™tre d√©plac√©e vers le <code>/etc/openvpn/easy-rsa/pki/reqs/</code> .  L'extension du fichier doit √™tre <code>req</code> . <br>  Conversion d'une demande en certificat: <br><br><pre> <code class="plaintext hljs">cd /etc/openvpn/easy-rsa/ ./easyrsa sign-req client good</code> </pre><br>  Apr√®s cela, un certificat du m√™me nom mais avec l'extension <code>crt</code> appara√Ætra dans le <code>/etc/openvpn/easy-rsa/pki/issued/</code> . <br><br>  Avant l'enregistrement, le certificat doit √™tre converti en DER: <br><br><pre> <code class="plaintext hljs">openssl x509 -in /home/user/user-cert.pem -out /home/user/user-cert.crt -outform DER</code> </pre><br>  √âcrire un certificat pour un jeton: <br><br><pre> <code class="plaintext hljs">pkcs11-tool --module /usr/lib/librtpkcs11ecp.so -l -y cert -w /home/user/user-cert.crt --id 45 --label TEST</code> </pre> <br>  Il est r√©dig√© sur la base de l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Utilisation de Rutoken EDS avec OpenSSL (RSA)¬ª</a> . <br><br><h4>  Utilisation du jeton pour l'authentification </h4><br>  Recherchez l'ID du certificat √† pr√©senter au serveur: <br><br><pre> <code class="plaintext hljs">$ openvpn --show-pkcs11-ids /usr/lib64/librtpkcs11ecp.so The following objects are available for use. Each object shown below may be used as parameter to --pkcs11-id option please remember to use single quote mark. Certificate DN: /CN=User1 Serial: 490B82C4000000000075 Serialized id: aaaa/bbb/41545F5349474E415455524581D2A1A1B23C4AA4CB17FAF7A4600</code> </pre><br>  Nous sommes int√©ress√©s par l'id s√©rialis√© ici. <br><br>  Options √† saisir dans la configuration ovpn pour que les jetons r√©cup√®rent: <br><br><pre> <code class="plaintext hljs">pkcs11-providers /usr/lib64/librtpkcs11ecp.so pkcs11-id 'aaaa/bbb/41545F5349474E415455524581D2A1A1B23C4AA4CB17FAF7A4600'</code> </pre> <br>  L'option <code>pkcs11-id</code> <b>doit √™tre plac√©e entre guillemets simples.</b> <br><br>  Ce manuel a du sens sur toutes les plateformes.  Vous devez sp√©cifier le chemin d'acc√®s √† la biblioth√®que et l'ID de certificat sur le jeton.  La biblioth√®que peut √™tre appel√©e un peu diff√©remment, soit <code>.dll</code> , pas <code>.so</code> , mais le sens est le m√™me. <br><br>  Dans ce cas, vous devez supprimer les sections <code>cert</code> et <code>key</code> du fichier ovpn, car le certificat et la cl√© priv√©e seront extraits du jeton. <br><br>  La configuration enti√®rement client (pour Windows) ressemble √† ceci: <br><br><div class="spoiler">  <b class="spoiler_title">client.ovpn</b> <div class="spoiler_text"> <code>client <br> dev tun <br> proto tcp <br> sndbuf 0 <br> rcvbuf 0 <br> remote 78.47.37.247 22222 <br> resolv-retry infinite <br> nobind <br> persist-key <br> persist-tun <br> remote-cert-tls server <br> cipher AES-256-CBC <br> comp-lzo <br> setenv opt block-outside-dns <br> key-direction 1 <br> verb 3 <br> <br> pkcs11-providers "c://Windows//System32//rtPKCS11ECP.dll" <br> pkcs11-id 'Aktiv\x20Co\x2E/Rutoken\x20ECP/342b871d/Rutoken/01' <br> <br> -----BEGIN CERTIFICATE----- <br> {CERT_HERE} <br> -----END CERTIFICATE----- <br> <br> <br> &lt;tls-auth&gt; <br> # <br> # 2048 bit OpenVPN static key <br> # <br> -----BEGIN OpenVPN Static key V1----- <br> {KEY_HERE} <br> -----END OpenVPN Static key V1----- <br> &lt;/tls-auth&gt;</code> <br> </div></div><br>  √âcrit sur la base de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Comment ajouter une authentification √† double facteur √† une configuration OpenVPN √† l'aide de cartes √† puce c√¥t√© client¬ª</a> . <br><br><h3>  Configuration client </h3><br><h4>  Linux </h4><br>  Openvpn a un bogue qui emp√™che l'utilisateur d'entrer le code PIN √† partir du jeton si le package est construit avec la prise en charge de systemd.  Depuis que systemd a √©t√© partout ces derniers temps, tous les packages qui sont d√©j√† disponibles dans les r√©f√©rentiels sont compil√©s avec son support.  Les clients sous Linux doivent collecter le package par eux-m√™mes.  Voici un exemple de configuration qui a fonctionn√© pour moi sur Arch Linux: <br><br><pre> <code class="plaintext hljs">./configure \ --prefix=/usr \ --sbindir=/usr/bin \ --enable-iproute2 \ --enable-pkcs11 \ --enable-plugins \ --enable-x509-alt-username</code> </pre><br>  Vous pouvez v√©rifier que openvpn est construit avec ou sans systemd en utilisant la commande suivante: <br><br><pre> <code class="plaintext hljs">openvpn --version | grep --color enable_systemd</code> </pre><br><h4>  Mas os </h4><br>  Sous Mac OS, il n'y a qu'un seul client gratuit - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tunnelblink</a> . <br><br>  Il ne sait pas comment saisir un code PIN √† partir d'un jeton de gui.  Le bug est d√©crit par exemple ici - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://groups.google.com/forum/#!topic/tunnelblick-discuss/f_Rp_2nV-x8</a> Contourn√© en lan√ßant openvpn √† partir de la console.  Ce n'est pas surprenant, √©tant donn√© que le client officiel pour Windows ne le sait pas non plus. <br><br>  Sous Mac OS (contrairement √† Windows), des scripts suppl√©mentaires sont √©galement n√©cessaires pour configurer le r√©seau.  Si vous ex√©cutez simplement openvpn √† partir de la console, DNS ne fonctionnera pas (peut-√™tre autre chose, seul DNS appara√Ætra). <br><br>  TunnelBlick poss√®de ces scripts de configuration r√©seau, ils n'ont besoin d'√™tre appel√©s que lors de l'√©tablissement et de la d√©connexion de la connexion.  Ce que vous devez ajouter √† la configuration ovpn: <br><br><pre> <code class="bash hljs">script-security 2 up <span class="hljs-string"><span class="hljs-string">"/Applications/Tunnelblick.app/Contents/Resources/client.up.tunnelblick.sh -9 -d -f -m -w -ptADGNWradsgnw"</span></span> down <span class="hljs-string"><span class="hljs-string">"/Applications/Tunnelblick.app/Contents/Resources/client.down.tunnelblick.sh -9 -d -f -m -w -ptADGNWradsgnw"</span></span></code> </pre> <br>  Un exemple de script pour lancer une connexion openvpn, qui peut √™tre plac√© sur le bureau et piqu√© avec la souris: <br><br><pre> <code class="plaintext hljs">#!/bin/bash tunnelblick=/Applications/Tunnelblick.app/Contents/Resources/openvpn/openvpn-2.4.2-openssl-1.0.2k sudo $tunnelblick/openvpn --config $tunnelblick/user.ovpn</code> </pre><br><h4>  Windows </h4><br>  Sous les fen√™tres, tout semble fonctionner.  Le client officiel ne sait pas saisir le code PIN depuis le token, il parvient √† ouvrir manuellement vpn depuis la console. <br><br>  La chose la plus importante est de tout faire sous l'administrateur.  Ex√©cutez le programme d'installation du client en tant qu'administrateur.  Lancez un terminal dans lequel openvpn d√©marre √©galement avec les droits d'administrateur, sinon il ne pourra pas contr√¥ler l'interface r√©seau. <br><br>  Sous Windows, le chemin d'acc√®s √† la biblioth√®que pour travailler avec des jetons doit √™tre enregistr√© via des doubles barres obliques.  Cela s'applique √† la fois √† la configuration ovpn et √† l' <code>--show-pkcs11-ids</code> sur la ligne de commande. <br><br><pre> <code class="bash hljs">pkcs11-providers <span class="hljs-string"><span class="hljs-string">"c://Windows//System32//rtPKCS11ECP.dll"</span></span> pkcs11-id <span class="hljs-string"><span class="hljs-string">'Aktiv\x20Co\x2E/Rutoken\x20ECP/342b871d/Rutoken/01'</span></span></code> </pre></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433250/">https://habr.com/ru/post/fr433250/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433234/index.html">Une nounou parfaite est requise; assurez-vous de passer par un scan AI pour √©valuer le respect et les bonnes mani√®res</a></li>
<li><a href="../fr433236/index.html">Le chef de Google estime que la crainte de l'IA est "totalement justifi√©e"</a></li>
<li><a href="../fr433242/index.html">Masque toxique</a></li>
<li><a href="../fr433246/index.html">Framework: analyse des syst√®mes DLT</a></li>
<li><a href="../fr433248/index.html">Analyse de la criminalistique de la m√©moire avec OtterCTF et introduction du cadre de volatilit√©</a></li>
<li><a href="../fr433252/index.html">Mannequin sur un h√©licopt√®re hybride turbor√©acteur</a></li>
<li><a href="../fr433254/index.html">Nous combattons seulement la mort, et vous? Ou des entreprises qui d√©veloppent une m√©decine fantastique</a></li>
<li><a href="../fr433256/index.html">D√©veloppement d'interface utilisateur avec Flutter</a></li>
<li><a href="../fr433258/index.html">Vous pouvez acheter des composants √©lectroniques en Europe m√™me en vacances. Exp√©rience de magasinage chez Mouser en Bulgarie</a></li>
<li><a href="../fr433260/index.html">Lecture le week-end: documents sur le travail avec PD, examens du fer dans le centre de donn√©es et la "cuisine" du fournisseur IaaS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>