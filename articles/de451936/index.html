<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöü ‚ôâÔ∏è üö∏ Suchen nach Sicherheitsl√ºcken im UC-Browser üë©üèº‚Äçüç≥ üë©üèª‚Äç‚öïÔ∏è üàπ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Einf√ºhrung 
 Ende M√§rz berichteten wir , dass wir eine versteckte M√∂glichkeit entdeckt haben, nicht verifizierten Code im UC-Browser herunterzuladen u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Suchen nach Sicherheitsl√ºcken im UC-Browser</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/drweb/blog/451936/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/-f/na/kn/-fnaknrx70xmfiflvfa6ijw1pys.jpeg"></div><br><h3>  Einf√ºhrung </h3><br>  Ende M√§rz <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">berichteten</a> wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">,</a> dass wir eine versteckte M√∂glichkeit entdeckt haben, nicht verifizierten Code im UC-Browser herunterzuladen und auszuf√ºhren.  Heute werden wir detailliert analysieren, wie dieser Download erfolgt und wie Hacker ihn f√ºr ihre eigenen Zwecke verwenden k√∂nnen. <br><br>  Vor einiger Zeit wurde UC Browser sehr aggressiv beworben und verbreitet: Er wurde auf den Ger√§ten der Benutzer mithilfe von Malware installiert, die von verschiedenen Websites in Form von Videodateien verbreitet wurde (d. H. Benutzer dachten, sie h√§tten beispielsweise einen Pornoclip heruntergeladen, erhielten jedoch stattdessen eine APK damit Browser), verwendet erschreckende Banner mit Nachrichten, die besagen, dass der Browser veraltet, anf√§llig und √§hnliches ist.  Die offizielle UC Browser-Gruppe in VK hat ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Thema,</a> in dem sich Benutzer √ºber unfaire Werbung beschweren k√∂nnen, es gibt viele Beispiele.  Im Jahr 2016 gab es sogar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Videowerbung</a> in russischer Sprache (ja, Anzeigen von einem Browser, der Anzeigen blockiert). <br><br>  Zum Zeitpunkt des Schreibens verf√ºgt UC Browser √ºber mehr als 500.000.000 Installationen bei Google Play.  Das ist beeindruckend - nur Google Chrome hat mehr.  Unter den Bewertungen finden Sie viele Beschwerden √ºber Werbung und Weiterleitungen zu einigen Anwendungen bei Google Play.  Dies war der Grund f√ºr die Studie: Wir haben uns entschlossen zu pr√ºfen, ob UC Browser etwas Schlechtes tut.  Und es stellte sich heraus, dass er es tat! <br><a name="habracut"></a><br>  Der Anwendungscode enth√ºllte die M√∂glichkeit, ausf√ºhrbaren Code herunterzuladen und auszuf√ºhren, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">was den Regeln f√ºr die Ver√∂ffentlichung von Anwendungen</a> auf Google Play <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">widerspricht</a> .  Zus√§tzlich zur Tatsache, dass UC Browser ausf√ºhrbaren Code herunterl√§dt, wird dieser unsicher, was zur Durchf√ºhrung eines MitM-Angriffs verwendet werden kann.  Mal sehen, ob es uns gelingt, einen solchen Angriff durchzuf√ºhren. <br><br>  Alles, was unten geschrieben steht, ist f√ºr die Version von UC Browser relevant, die zum Zeitpunkt der Studie bei Google Play vorhanden war: <br><br><pre><code class="plaintext hljs">package: com.UCMobile.intl versionName: 12.10.8.1172 versionCode: 10598 sha1 APK-: f5edb2243413c777172f6362876041eb0c3a928c</code> </pre> <br><h3>  Angriffsvektor </h3><br>  Im UC-Browser-Manifest finden Sie einen Dienst namens <i>com.uc.deployment.UpgradeDeployService</i> . <br><br><pre> <code class="plaintext hljs"> &lt;service android:exported="false" android:name="com.uc.deployment.UpgradeDeployService" android:process=":deploy" /&gt;</code> </pre><br>  Wenn dieser Dienst <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gestartet wird</a></i> , f√ºhrt der Browser eine POST-Anforderung an <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">puds.ucweb.com/upgrade/index.xhtml aus</a></i> , die einige Zeit nach dem Start im Datenverkehr festgestellt werden kann.  Als Antwort erh√§lt er m√∂glicherweise einen Befehl zum Herunterladen eines Updates oder eines neuen Moduls.  W√§hrend des Analyseprozesses gab der Server keine derartigen Befehle aus. Wir haben jedoch festgestellt, dass beim Versuch, die PDF-Datei im Browser zu √∂ffnen, eine zweite Anforderung an die oben angegebene Adresse gestellt wird, wonach die native Bibliothek heruntergeladen wird.  Um den Angriff auszuf√ºhren, haben wir uns f√ºr diese Funktion des UC-Browsers entschieden: die M√∂glichkeit, PDF-Dateien mit einer nativen Bibliothek zu √∂ffnen, die nicht in der APK enthalten ist und bei Bedarf aus dem Internet heruntergeladen wird.  Es ist erw√§hnenswert, dass UC Browser theoretisch gezwungen sein kann, etwas ohne Benutzerinteraktion herunterzuladen - wenn Sie eine korrekt formulierte Antwort auf eine Anforderung geben, die nach dem Start des Browsers ausgef√ºhrt wird.  Daf√ºr m√ºssen wir jedoch das Protokoll der Interaktion mit dem Server genauer untersuchen. Daher haben wir beschlossen, dass es einfacher ist, die abgefangene Antwort zu bearbeiten und die Bibliothek f√ºr die Arbeit mit PDF zu ersetzen. <br><br>  Wenn ein Benutzer eine PDF-Datei direkt in einem Browser √∂ffnen m√∂chte, werden im Datenverkehr die folgenden Anforderungen angezeigt: <br><br><img src="https://habrastorage.org/webt/j0/i1/c1/j0i1c1n_nwf_gnauzbudnqor5oi.png"><br><br>  Zuerst kommt eine POST-Anfrage an <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">puds.ucweb.com/upgrade/index.xhtml</a></i> , danach <br>  Laden Sie das Archiv mit Bibliothek herunter, um PDF- und Office-Formate anzuzeigen.  Es ist logisch anzunehmen, dass bei der ersten Anforderung Informationen √ºber das System √ºbertragen werden (zumindest Architektur, um die gew√ºnschte Bibliothek bereitzustellen), und als Antwort darauf erh√§lt der Browser einige Informationen √ºber die Bibliothek, die heruntergeladen werden m√ºssen: Adresse und m√∂glicherweise etwas anderes.  Das Problem ist, dass diese Anfrage verschl√ºsselt ist. <br><br><div class="scrollable-table"><table><tbody><tr><td>  Snippet anfordern <br><br></td><td>  Antwort-Snippet <br><br></td></tr><tr><td><img src="https://habrastorage.org/webt/go/tj/tz/gotjtzkpg2owfmk8jrnznox_vdg.jpeg"><br><br></td><td><img src="https://habrastorage.org/webt/g5/7k/iv/g57kivkwrysmcqvptmhclqzzipq.png"><br><br></td></tr></tbody></table></div><br><br>  Die Bibliothek selbst ist in ZIP gepackt und nicht verschl√ºsselt. <br><br><img src="https://habrastorage.org/webt/6r/lt/ns/6rltnsrtyd-_5ekwis68qn-vydc.png"><br><br><h3>  Suchverkehrsentschl√ºsselungscode </h3><br><br>  Versuchen wir, die Serverantwort zu entschl√ºsseln.  Wir sehen uns den Code der Klasse <i>com.uc.deployment.UpgradeDeployService an</i> : <i>Gehen Sie</i> von der <i>onStartCommand-</i> Methode zu <i>com.uc.deployment.bx</i> und von dort zu <i>com.uc.browser.core.dcfe</i> : <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(l arg9)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v4_5; String v3_1; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v3; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v1 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg9 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v3 = v1; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v3_1 = arg9.iGX.ipR; StringBuilder v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]product:"</span></span>); v4.append(arg9.iGX.ipR); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]version:"</span></span>); v4.append(arg9.iGX.iEn); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]upgrade_type:"</span></span>); v4.append(arg9.iGX.mMode); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]force_flag:"</span></span>); v4.append(arg9.iGX.iEo); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_mode:"</span></span>); v4.append(arg9.iGX.iDQ); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_type:"</span></span>); v4.append(arg9.iGX.iEr); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_state:"</span></span>); v4.append(arg9.iGX.iEp); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_file:"</span></span>); v4.append(arg9.iGX.iEq); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apk_md5:"</span></span>); v4.append(arg9.iGX.iEl); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]download_type:"</span></span>); v4.append(arg9.mDownloadType); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]download_group:"</span></span>); v4.append(arg9.mDownloadGroup); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]download_path:"</span></span>); v4.append(arg9.iGH); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_child_version:"</span></span>); v4.append(arg9.iGX.iEx); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_series:"</span></span>); v4.append(arg9.iGX.iEw); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_cpu_arch:"</span></span>); v4.append(arg9.iGX.iEt); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_cpu_vfp3:"</span></span>); v4.append(arg9.iGX.iEv); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_cpu_vfp:"</span></span>); v4.append(arg9.iGX.iEu); ArrayList v3_2 = arg9.iGX.iEz; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3_2 != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; v3_2.size() != <span class="hljs-number"><span class="hljs-number">0</span></span>) { Iterator v3_3 = v3_2.iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(v3_3.hasNext()) { Object v4_1 = v3_3.next(); StringBuilder v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_name:"</span></span>); v5.append(((au)v4_1).getName()); v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_ver_name:"</span></span>); v5.append(((au)v4_1).aDA()); v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_ver_code:"</span></span>); v5.append(((au)v4_1).gBl); v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_req_type:"</span></span>); v5.append(((au)v4_1).gBq); } } j v3_4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> j(); mb(v3_4); h v4_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> h(); mb(v4_2); ay v5_1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ay(); v3_4.hS(<span class="hljs-string"><span class="hljs-string">""</span></span>); v3_4.setImsi(<span class="hljs-string"><span class="hljs-string">""</span></span>); v3_4.hV(<span class="hljs-string"><span class="hljs-string">""</span></span>); v5_1.bPQ = v3_4; v5_1.bPP = v4_2; v5_1.yr(arg9.iGX.ipR); v5_1.gBF = arg9.iGX.mMode; v5_1.gBI = arg9.iGX.iEz; v3_2 = v5_1.gAr; c.aBh(); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"os_ver"</span></span>, c.getRomInfo())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"processor_arch"</span></span>, com.uc.baacgetCpuArch())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_arch"</span></span>, com.uc.baacPb())); String v4_3 = com.uc.baacPd(); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_vfp"</span></span>, v4_3)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"net_type"</span></span>, String.valueOf(com.uc.base.system.a.Jo()))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"fromhost"</span></span>, arg9.iGX.iEm)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"plugin_ver"</span></span>, arg9.iGX.iEn)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"target_lang"</span></span>, arg9.iGX.iEs)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"vitamio_cpu_arch"</span></span>, arg9.iGX.iEt)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"vitamio_vfp"</span></span>, arg9.iGX.iEu)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"vitamio_vfp3"</span></span>, arg9.iGX.iEv)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"plugin_child_ver"</span></span>, arg9.iGX.iEx)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"ver_series"</span></span>, arg9.iGX.iEw)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"child_ver"</span></span>, r.aVw())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cur_ver_md5"</span></span>, arg9.iGX.iEl)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cur_ver_signature"</span></span>, SystemHelper.getUCMSignature())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"upgrade_log"</span></span>, i.bjt())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_install"</span></span>, String.valueOf(arg9.iGX.iDQ))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_state"</span></span>, String.valueOf(arg9.iGX.iEp))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_file"</span></span>, arg9.iGX.iEq)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_type"</span></span>, String.valueOf(arg9.iGX.iEr))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_archit"</span></span>, com.uc.baacPc())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_set"</span></span>, SystemHelper.getCpuInstruction())); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> v4_4 = v4_3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || !v4_3.contains(<span class="hljs-string"><span class="hljs-string">"neon"</span></span>) ? <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"neon"</span></span>, String.valueOf(v4_4))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_cores"</span></span>, String.valueOf(com.uc.baacJl()))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"ram_1"</span></span>, String.valueOf(com.uc.baahPo()))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"totalram"</span></span>, String.valueOf(com.uc.baahOL()))); c.aBh(); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"rom_1"</span></span>, c.getRomInfo())); v4_5 = e.getScreenWidth(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v6 = e.getScreenHeight(); StringBuilder v7 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); v7.append(v4_5); v7.append(<span class="hljs-string"><span class="hljs-string">"*"</span></span>); v7.append(v6); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"ss"</span></span>, v7.toString())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"api_level"</span></span>, String.valueOf(Build$VERSION.SDK_INT))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"uc_apk_list"</span></span>, SystemHelper.getUCMobileApks())); Iterator v4_6 = arg9.iGX.iEA.entrySet().iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(v4_6.hasNext()) { Object v6_1 = v4_6.next(); v3_2.add(g.fs(((Map$Entry)v6_1).getKey(), ((Map$Entry)v6_1).getValue())); } v3 = v5_1.toByteArray(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_encode"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } v4_5 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGw ? <span class="hljs-number"><span class="hljs-number">0x1F</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v3 = gi(v4_5, v3); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[v3.length + <span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v6_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">16</span></span>]; Arrays.fill(v6_2, <span class="hljs-number"><span class="hljs-number">0</span></span>); v6_2[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0x5F</span></span>; v6_2[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; v6_2[<span class="hljs-number"><span class="hljs-number">2</span></span>] = ((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)v4_5); v6_2[<span class="hljs-number"><span class="hljs-number">3</span></span>] = -<span class="hljs-number"><span class="hljs-number">50</span></span>; System.arraycopy(v6_2, <span class="hljs-number"><span class="hljs-number">0</span></span>, v1, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>); System.arraycopy(v3, <span class="hljs-number"><span class="hljs-number">0</span></span>, v1, <span class="hljs-number"><span class="hljs-number">16</span></span>, v3.length); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v1 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_encrypt"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(TextUtils.isEmpty(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.mUpgradeUrl)) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_url"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } StringBuilder v0 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v0.append(arg9.iGX.ipR); v0.append(<span class="hljs-string"><span class="hljs-string">"]url:"</span></span>); v0.append(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.mUpgradeUrl); com.uc.browser.core.dci v0_1 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI; v3_1 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.mUpgradeUrl; com.uc.base.net.e v0_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> com.uc.base.net.e(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> com.uc.browser.core.dci$a(v0_1, arg9)); v3_1 = v3_1.contains(<span class="hljs-string"><span class="hljs-string">"?"</span></span>) ? v3_1 + <span class="hljs-string"><span class="hljs-string">"&amp;dataver=pb"</span></span> : v3_1 + <span class="hljs-string"><span class="hljs-string">"?dataver=pb"</span></span>; n v3_5 = v0_2.uc(v3_1); mb(v3_5, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); v3_5.setMethod(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>); v3_5.setBodyProvider(v1); v0_2.b(v3_5); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_null"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"success"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.b(arg9); }</code> </pre> <br>  Wir sehen hier die Bildung der POST-Anfrage.  Wir machen auf die Erstellung eines Arrays von 16 Bytes und dessen F√ºllung aufmerksam: 0x5F, 0, 0x1F, -50 (= 0xCE).  Entspricht dem, was wir in der obigen Anfrage gesehen haben. <br><br>  In derselben Klasse k√∂nnen Sie eine verschachtelte Klasse feststellen, in der es eine andere interessante Methode gibt: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(l arg10, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] arg11)</span></span></span><span class="hljs-function"> </span></span>{ f v0 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGQ; StringBuilder v1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v1.append(arg10.iGX.ipR); v1.append(<span class="hljs-string"><span class="hljs-string">"]:UpgradeSuccess"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v1_1 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11.length &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-number"><span class="hljs-number">0x60</span></span> &amp;&amp; arg11[<span class="hljs-number"><span class="hljs-number">3</span></span>] != <span class="hljs-number"><span class="hljs-number">0xFFFFFFD0</span></span>) { goto label_57; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v3 = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v5 = arg11[<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-number"><span class="hljs-number">1</span></span> ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>] != <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>] != <span class="hljs-number"><span class="hljs-number">11</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>] == <span class="hljs-number"><span class="hljs-number">0x1F</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v3 = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v7 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[arg11.length - <span class="hljs-number"><span class="hljs-number">16</span></span>]; System.arraycopy(arg11, <span class="hljs-number"><span class="hljs-number">16</span></span>, v7, <span class="hljs-number"><span class="hljs-number">0</span></span>, v7.length); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 != <span class="hljs-number"><span class="hljs-number">0</span></span>) { v7 = gj(arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>], v7); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v7 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { goto label_57; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v5 != <span class="hljs-number"><span class="hljs-number">0</span></span>) { v1_1 = gP(v7); goto label_57; } v1_1 = v7; } label_57: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v1_1 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v0.iGY.iGI.a(arg10, <span class="hljs-string"><span class="hljs-string">"up_decrypt"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } q v11 = gb(arg10, v1_1); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v11 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v0.iGY.iGI.a(arg10, <span class="hljs-string"><span class="hljs-string">"up_decode"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v0.iGY.iGt) { v0.d(arg10); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v0.iGY.iGo != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v0.iGY.iGo.a(<span class="hljs-number"><span class="hljs-number">0</span></span>, ((o)v11)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v0.iGY.iGs) { v0.iGY.a(((o)v11)); v0.iGY.iGI.a(v11, <span class="hljs-string"><span class="hljs-string">"up_silent"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"success"</span></span>); v0.iGY.iGI.a(v11); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } v0.iGY.iGI.a(v11, <span class="hljs-string"><span class="hljs-string">"up_silent"</span></span>, <span class="hljs-string"><span class="hljs-string">"no"</span></span>, <span class="hljs-string"><span class="hljs-string">"success"</span></span>); } }</code> </pre> <br>  Die Methode empf√§ngt ein Array von Bytes als Eingabe und pr√ºft, ob das Nullbyte 0x60 oder das dritte Byte 0xD0 und das zweite Byte 1, 11 oder 0x1F ist.  Wir sehen uns die Antwort vom Server an: Null Byte - 0x60, Sekunde - 0x1F, Dritte - 0x60.  Sieht aus wie das, was wir brauchen.  Nach den Zeilen zu urteilen (z. B. "up_decrypt"), sollte hier eine Methode aufgerufen werden, die die Antwort des Servers entschl√ºsselt. <br>  Wir gehen zur <i>gj-</i> Methode √ºber.  Beachten Sie, dass das Byte bei Offset 2 (d. H. 0x1F in unserem Fall) als erstes Argument und die Serverantwort ohne dieses Byte √ºbertragen wird <br>  erste 16 Bytes. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] j(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> arg1, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arg2) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg1 == <span class="hljs-number"><span class="hljs-number">1</span></span>) { arg2 = cc(arg2, c.adu); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg1 == <span class="hljs-number"><span class="hljs-number">11</span></span>) { arg2 = m.aF(arg2); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg1 != <span class="hljs-number"><span class="hljs-number">0x1F</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { arg2 = EncryptHelper.decrypt(arg2); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> arg2; }</code> </pre> <br>  Offensichtlich gibt es eine Auswahl an Entschl√ºsselungsalgorithmen und das gleiche Byte, das in unserem <br>  case ist 0x1F, bezeichnet eine von drei m√∂glichen Optionen. <br><br>  Wir analysieren den Code weiter.  Nach ein paar Spr√ºngen gelangen wir zu einer Methode mit dem sprechenden Namen <i>decryptBytesByKey</i> . <br><br>  Hier werden zwei weitere Bytes von unserer Antwort getrennt und eine Zeichenfolge daraus erhalten.  Es ist klar, dass auf diese Weise der Schl√ºssel ausgew√§hlt wird, um die Nachricht zu entschl√ºsseln. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] decryptBytesByKey(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v0 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bytes != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bytes.length &lt; EncryptHelper.PREFIX_BYTES_SIZE) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bytes.length == EncryptHelper.PREFIX_BYTES_SIZE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v0; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] prefix = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[EncryptHelper.PREFIX_BYTES_SIZE]; <span class="hljs-comment"><span class="hljs-comment">// 2  System.arraycopy(bytes, 0, prefix, 0, prefix.length); String keyId = c.ayR().d(ByteBuffer.wrap(prefix).getShort()); //   if(keyId == null) { return v0; } else { a v2 = EncryptHelper.ayL(); if(v2 == null) { return v0; } else { byte[] enrypted = new byte[bytes.length - EncryptHelper.PREFIX_BYTES_SIZE]; System.arraycopy(bytes, EncryptHelper.PREFIX_BYTES_SIZE, enrypted, 0, enrypted.length); return v2.l(keyId, enrypted); } } } } catch(SecException v7_1) { EncryptHelper.handleDecryptException(((Throwable)v7_1), v7_1.getErrorCode()); return v0; } catch(Throwable v7) { EncryptHelper.handleDecryptException(v7, 2); return v0; } } return v0; }</span></span></code> </pre> <br>  Mit Blick auf die Zukunft stellen wir fest, dass zu diesem Zeitpunkt der Schl√ºssel noch nicht erhalten ist, sondern nur seine ‚ÄûKennung‚Äú.  Den Schl√ºssel zu bekommen ist etwas komplizierter. <br><br>  Bei der n√§chsten Methode werden zwei weitere zu den vorhandenen Parametern hinzugef√ºgt, und es gibt vier davon: magische Nummer 16, Schl√ºsselkennung, verschl√ºsselte Daten und eine unverst√§ndliche Zeichenfolge (in unserem Fall leer). <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] l(String keyId, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] encrypted) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> SecException { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ayJ().staticBinarySafeDecryptNoB64(<span class="hljs-number"><span class="hljs-number">16</span></span>, keyId, encrypted, <span class="hljs-string"><span class="hljs-string">""</span></span>); }</code> </pre> <br>  Nach einer Reihe von √úberg√§ngen gelangen wir zur <i>staticBinarySafeDecryptNoB64-</i> Methode der Schnittstelle <i>com.alibaba.wireless.security.open.staticdataencrypt.IStaticDataEncryptComponent</i> <i>.</i>  Der Hauptanwendungscode enth√§lt keine Klassen, die diese Schnittstelle implementieren.  Eine solche Klasse befindet sich in der Datei <i>lib / armeabi-v7a / libsgmain.so</i> , die eigentlich nicht .so, sondern .jar ist.  Die f√ºr uns interessante Methode wird wie folgt implementiert: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.alibaba.wireless.security.ai; <span class="hljs-comment"><span class="hljs-comment">// ... public class a implements IStaticDataEncryptComponent { private ISecurityGuardPlugin a; // ... private byte[] a(int mode, int magicInt, int xzInt, String keyId, byte[] encrypted, String magicString) { return this.a.getRouter().doCommand(10601, new Object[]{Integer.valueOf(mode), Integer.valueOf(magicInt), Integer.valueOf(xzInt), keyId, encrypted, magicString}); } // ... private byte[] b(int magicInt, String keyId, byte[] encrypted, String magicString) { return this.a(2, magicInt, 0, keyId, encrypted, magicString); } // ... public byte[] staticBinarySafeDecryptNoB64(int magicInt, String keyId, byte[] encrypted, String magicString) throws SecException { if(keyId != null &amp;&amp; keyId.length() &gt; 0 &amp;&amp; magicInt &gt;= 0 &amp;&amp; magicInt &lt; 19 &amp;&amp; encrypted != null &amp;&amp; encrypted.length &gt; 0) { return this.b(magicInt, keyId, encrypted, magicString); } throw new SecException("", 301); } //... }</span></span></code> </pre> <br>  Hier wird unsere Liste der Parameter durch zwei weitere Ganzzahlen erg√§nzt: 2 und 0. Gemessen an <br>  F√ºr alle bedeutet 2 Entschl√ºsselung, wie bei der <i>doFinal-</i> Methode der <i>Systemklasse javax.crypto.Cipher</i> .  Und all dies wird an einen bestimmten Router mit der Nummer 10601 √ºbertragen - dies ist anscheinend die Befehlsnummer. <br><br>  Nach der n√§chsten √úbergangskette finden wir eine Klasse, die die <i>IRouterComponent-</i> Schnittstelle und die <i>doCommand-</i> Methode <i>implementiert</i> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.alibaba.wireless.security.mainplugin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.alibaba.wireless.security.framework.IRouterComponent; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.taobao.wireless.security.adapter.JNICLibrary; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IRouterComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg2, Object[] arg3)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JNICLibrary.doCommandNative(arg2, arg3); } }</code> </pre> <br>  Und auch die <i>JNICLibrary-</i> Klasse, in der die native Methode <i>doCommandNative deklariert ist</i> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.taobao.wireless.security.adapter; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JNICLibrary</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doCommandNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg0, Object[] arg1)</span></span></span></span>; }</code> </pre> <br>  Wir m√ºssen also die <i>doCommandNative-</i> Methode im nativen Code finden.  Und dann beginnt der Spa√ü. <br><br><h3>  Verschleierung des Maschinencodes </h3><br>  In der Datei <i>libsgmain.so</i> befindet sich eine native Bibliothek (die eigentlich .jar ist und in der wir eine kleine Implementierung einiger Verschl√ºsselungsschnittstellen etwas h√∂her gefunden haben): <i>libsgmainso-6.4.36.so</i> .  √ñffnen Sie es in der IDA und erhalten Sie eine Reihe von Dialogfeldern mit Fehlern.  Das Problem ist, dass die Abschnitts√ºberschriften-Tabelle ung√ºltig ist.  Dies geschieht speziell, um die Analyse zu erschweren. <br><br><img src="https://habrastorage.org/webt/_k/bz/5c/_kbz5cbedw6g1jnsj047rtqudli.jpeg"><br><br>  Es wird aber auch nicht ben√∂tigt: Um die ELF-Datei korrekt zu laden und zu analysieren, reicht die Programm-Header-Tabelle aus.  Daher l√∂schen wir einfach die Abschnittstabelle und machen die entsprechenden Felder in der Kopfzeile ung√ºltig. <br><br><img src="https://habrastorage.org/webt/2y/xh/vk/2yxhvksp30f016gfyhrlfh0pklc.jpeg"><br><br>  √ñffnen Sie die Datei erneut in der IDA. <br><br>  Es gibt zwei M√∂glichkeiten, der virtuellen Java-Maschine genau mitzuteilen, wo sich in der nativen Bibliothek die Implementierung der im Java-Code als native deklarierten Methode befindet.  Die erste besteht darin, ihm einen Namen in der Form <i>Java_package_name_ClassName_Method_name zu geben</i> . <br><br>  Die zweite <i>M√∂glichkeit</i> besteht darin, sie beim Laden der Bibliothek zu registrieren (in der Funktion <i>JNI_OnLoad</i> ). <br>  durch Aufrufen der Funktion <i>RegisterNatives</i> . <br><br>  In unserem Fall sollte der Name bei Verwendung der ersten Methode folgenderma√üen <i>lauten</i> : <i>Java_com_taobao_wireless_security_adapter_JNICLibrary_doCommandNative</i> . <br><br>  Unter den exportierten Funktionen gibt es keine solche, daher m√ºssen Sie nach dem Aufruf von <i>RegisterNatives</i> suchen. <br>  Wir gehen zur Funktion <i>JNI_OnLoad</i> und sehen das folgende Bild: <br><br><img src="https://habrastorage.org/webt/m6/dp/iw/m6dpiwaonfuyri-jg8thppcfgqe.jpeg"><br><br>  Was ist hier los?  Anfang und Ende der Funktion sind auf den ersten Blick typisch f√ºr die ARM-Architektur.  Der erste Befehl auf dem Stapel speichert den Inhalt der Register, die die Funktion in ihrer Arbeit verwenden wird (in diesem Fall R0, R1 und R2), sowie den Inhalt des Registers LR, in dem sich die R√ºcksprungadresse der Funktion befindet.  Mit dem letzten Befehl werden die gespeicherten Register wiederhergestellt und die R√ºcksprungadresse wird sofort in das PC-Register gestellt - und kehrt somit von der Funktion zur√ºck.  Wenn Sie jedoch genau hinschauen, werden Sie feststellen, dass die vorletzte Anweisung die auf dem Stapel gespeicherte R√ºcksprungadresse √§ndert.  Wir berechnen, was danach sein wird <br>  Codeausf√ºhrung.  Eine bestimmte Adresse 0xB130 wird in R1 geladen, 5 wird davon subtrahiert, dann wird sie an R0 √ºbertragen und 0x10 wird hinzugef√ºgt.  Es stellt sich heraus, 0xB13B.  Somit glaubt die IDA, dass es im letzten Befehl eine normale R√ºckkehr von der Funktion gibt, aber tats√§chlich gibt es einen √úbergang zur berechneten Adresse 0xB13B. <br><br>  Es sei daran erinnert, dass ARM-Prozessoren zwei Modi und zwei Befehlss√§tze haben: ARM und Thumb.  Das niedrigstwertige Bit der Adresse teilt dem Prozessor mit, welcher Befehlssatz verwendet wird.  Das hei√üt, die Adresse ist tats√§chlich 0xB13A, und die Einheit im niedrigen Bit zeigt den Daumenmodus an. <br><br>  Zu Beginn jeder Funktion in dieser Bibliothek wird ein √§hnlicher ‚ÄûAdapter‚Äú und hinzugef√ºgt <br>  M√ºllcode.  Au√üerdem werden wir nicht im Detail darauf eingehen - wir erinnern uns nur <br>  dass der eigentliche Anfang fast aller Funktionen etwas weiter ist. <br><br>  Da der Code keinen expliziten √úbergang zu 0xB13A enth√§lt, hat der IDA selbst nicht erkannt, dass sich der Code an dieser Stelle befindet.  Aus dem gleichen Grund wird der gr√∂√üte Teil des Codes in der Bibliothek nicht als Code erkannt, was die Analyse etwas erschwert.  Wir teilen der IDA mit, dass der Code hier ist und hier das Ergebnis: <br><br><img src="https://habrastorage.org/webt/eq/wp/p3/eqwpp3exmqnybi7r_tdvvan4jls.png"><br><br>  Bei 0xB144 beginnt die Tabelle eindeutig.  Was ist mit sub_494C? <br><br><img src="https://habrastorage.org/webt/bo/9b/rn/bo9brnkfvauy3ntm2dnucnsxqhs.png"><br><br>  Wenn diese Funktion im LR-Register aufgerufen wird, erhalten wir die Adresse der oben genannten Tabelle (0xB144).  In R0 der Index in dieser Tabelle.  Das hei√üt, ein Wert wird aus der Tabelle entnommen, zu LR addiert und erhalten <br>  Adresse zu gehen.  Versuchen wir es zu berechnen: 0xB144 + [0xB144 + 8 * 4] = 0xB144 + 0x120 = 0xB264.  Wir gehen zur empfangenen Adresse und sehen nur ein paar n√ºtzliche Anweisungen und wieder den √úbergang zu 0xB140: <br><br><img src="https://habrastorage.org/webt/nz/95/4x/nz954xqtjmky6tnpaqeejhvecus.png"><br><br>  Jetzt erfolgt eine Verschiebung um Offset mit dem Index 0x20 aus der Tabelle. <br><br>  Gemessen an der Gr√∂√üe der Tabelle gibt es viele solcher √úberg√§nge im Code.  Es stellt sich die Frage, ob es irgendwie m√∂glich ist, automatischer damit umzugehen, ohne die Adressen manuell zu berechnen.  Skripte und die M√∂glichkeit, Code in der IDA zu patchen, helfen uns dabei: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put_unconditional_branch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(source, destination)</span></span></span><span class="hljs-function">:</span></span> offset = (destination - source - <span class="hljs-number"><span class="hljs-number">4</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">2097151</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-2097152</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> RuntimeError(<span class="hljs-string"><span class="hljs-string">"Invalid offset"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">1023</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-1024</span></span>: instruction1 = <span class="hljs-number"><span class="hljs-number">0xf000</span></span> | ((offset &gt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) instruction2 = <span class="hljs-number"><span class="hljs-number">0xb800</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction1) patch_word(source + <span class="hljs-number"><span class="hljs-number">2</span></span>, instruction2) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: instruction = <span class="hljs-number"><span class="hljs-number">0xe000</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction) ea = here() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> get_wide_word(ea) == <span class="hljs-number"><span class="hljs-number">0xb503</span></span>: <span class="hljs-comment"><span class="hljs-comment">#PUSH {R0,R1,LR} ea1 = ea + 2 if get_wide_word(ea1) == 0xbf00: #NOP ea1 += 2 if get_operand_type(ea1, 0) == 1 and get_operand_value(ea1, 0) == 0 and get_operand_type(ea1, 1) == 2: index = get_wide_dword(get_operand_value(ea1, 1)) print "index =", hex(index) ea1 += 2 if get_operand_type(ea1, 0) == 7: table = get_operand_value(ea1, 0) + 4 elif get_operand_type(ea1, 1) == 2: table = get_operand_value(ea1, 1) + 4 else: print "Wrong operand type on", hex(ea1), "-", get_operand_type(ea1, 0), get_operand_type(ea1, 1) table = None if table is None: print "Unable to find table" else: print "table =", hex(table) offset = get_wide_dword(table + (index &lt;&lt; 2)) put_unconditional_branch(ea, table + offset) else: print "Unknown code", get_operand_type(ea1, 0), get_operand_value(ea1, 0), get_operand_type(ea1, 1) == 2 else: print "Unable to detect first instruction"</span></span></code> </pre> <br>  Wir setzen den Cursor auf die Zeile 0xB26A, f√ºhren das Skript aus und sehen den √úbergang zu 0xB4B0: <br><br><img src="https://habrastorage.org/webt/52/rf/fx/52rffxhzmtrfdhfrznsr8dovfim.png"><br><br>  Die IDA hat diese Site erneut nicht als Code erkannt.  Wir helfen ihr und sehen dort eine andere Konstruktion: <br><br><img src="https://habrastorage.org/webt/ct/d9/kv/ctd9kvewm9l1blmw3pqipi8mnqm.png"><br><br>  Die Anweisungen nach BLX sehen nicht sehr aussagekr√§ftig aus, es ist eher eine Art Voreingenommenheit.  Wir schauen in sub_4964: <br><br><img src="https://habrastorage.org/webt/o7/wi/4-/o7wi4-imrothkr6qpkbrklj40aw.png"><br><br>  In der Tat wird hier das dword an der in LR liegenden Adresse genommen, die zu dieser Adresse hinzugef√ºgt wird, wonach der Wert an der empfangenen Adresse genommen und auf den Stapel geschoben wird.  Au√üerdem wird 4 zu LR hinzugef√ºgt, so dass nach der R√ºckkehr von der Funktion derselbe Versatz √ºbersprungen wird.  Dann zieht der Befehl POP {R1} den empfangenen Wert vom Stapel.  Wenn Sie sich die Adresse 0xB4BA + 0xEA = 0xB5A4 ansehen, sehen Sie etwas √Ñhnliches wie die Adresstabelle: <br><br><img src="https://habrastorage.org/webt/ev/hb/a8/evhba8ty8dtnv8niuxyfue0nkfk.png"><br><br>  Um dieses Design zu patchen, m√ºssen Sie zwei Parameter aus dem Code abrufen: den Offset und die Registernummer, in die Sie das Ergebnis einf√ºgen m√∂chten.  F√ºr jedes m√∂gliche Register m√ºssen Sie im Voraus einen Code vorbereiten. <br><br><pre> <code class="python hljs">patches = {} patches[<span class="hljs-number"><span class="hljs-number">0</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x48</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">1</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x49</span></span>, <span class="hljs-number"><span class="hljs-number">0x09</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">2</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4a</span></span>, <span class="hljs-number"><span class="hljs-number">0x12</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">3</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4b</span></span>, <span class="hljs-number"><span class="hljs-number">0x1b</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">4</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4c</span></span>, <span class="hljs-number"><span class="hljs-number">0x24</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">5</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4d</span></span>, <span class="hljs-number"><span class="hljs-number">0x2d</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">8</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">0xd8</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">9</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0xd9</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">10</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0xa0</span></span>, <span class="hljs-number"><span class="hljs-number">0xda</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xa0</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">11</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0xb0</span></span>, <span class="hljs-number"><span class="hljs-number">0xdb</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xb0</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) ea = here() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (get_wide_word(ea) == <span class="hljs-number"><span class="hljs-number">0xb082</span></span> <span class="hljs-comment"><span class="hljs-comment">#SUB SP, SP, #8 and get_wide_word(ea + 2) == 0xb503): #PUSH {R0,R1,LR} if get_operand_type(ea + 4, 0) == 7: pop = get_bytes(ea + 12, 4, 0) if pop[1] == '\xbc': register = -1 r = get_wide_byte(ea + 12) for i in range(8): if r == (1 &lt;&lt; i): register = i break if register == -1: print "Unable to detect register" else: address = get_wide_dword(ea + 8) + ea + 8 for b in patches[register]: patch_byte(ea, b) ea += 1 if ea % 4 != 0: ea += 2 patch_dword(ea, address) elif pop[:3] == '\x5d\xf8\x04': register = ord(pop[3]) &gt;&gt; 4 if register in patches: address = get_wide_dword(ea + 8) + ea + 8 for b in patches[register]: patch_byte(ea, b) ea += 1 patch_dword(ea, address) else: print "POP instruction not found" else: print "Wrong operand type on +4:", get_operand_type(ea + 4, 0) else: print "Unable to detect first instructions"</span></span></code> </pre> <br>  Wir setzen den Cursor an den Anfang der Konstruktion, die wir ersetzen m√∂chten - 0xB4B2 - und f√ºhren das Skript aus: <br><br><img src="https://habrastorage.org/webt/lv/mp/oo/lvmpoow5agndjnbbl-t3imyaisq.jpeg"><br><br>  Zus√§tzlich zu den bereits erw√§hnten Konstruktionen im Code sind hier auch solche: <br><br><img src="https://habrastorage.org/webt/dk/nn/rw/dknnrwaye18zzz0xipny0_gdqfq.png"><br><br>  Wie im vorherigen Fall gibt es nach dem BLX-Befehl einen Offset: <br><br><img src="https://habrastorage.org/webt/fn/bw/uz/fnbwuzpo3qw1hp3vd9rvr2xfq1k.jpeg"><br><br>  Wir nehmen den Offset zur Adresse von LR, f√ºgen ihn LR hinzu und gehen dorthin.  0x72044 + 0xC = 0x72050.  Das Skript f√ºr dieses Design ist sehr einfach: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put_unconditional_branch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(source, destination)</span></span></span><span class="hljs-function">:</span></span> offset = (destination - source - <span class="hljs-number"><span class="hljs-number">4</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">2097151</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-2097152</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> RuntimeError(<span class="hljs-string"><span class="hljs-string">"Invalid offset"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">1023</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-1024</span></span>: instruction1 = <span class="hljs-number"><span class="hljs-number">0xf000</span></span> | ((offset &gt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) instruction2 = <span class="hljs-number"><span class="hljs-number">0xb800</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction1) patch_word(source + <span class="hljs-number"><span class="hljs-number">2</span></span>, instruction2) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: instruction = <span class="hljs-number"><span class="hljs-number">0xe000</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction) ea = here() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> get_wide_word(ea) == <span class="hljs-number"><span class="hljs-number">0xb503</span></span>: <span class="hljs-comment"><span class="hljs-comment">#PUSH {R0,R1,LR} ea1 = ea + 6 if get_wide_word(ea + 2) == 0xbf00: #NOP ea1 += 2 offset = get_wide_dword(ea1) put_unconditional_branch(ea, (ea1 + offset) &amp; 0xffffffff) else: print "Unable to detect first instruction"</span></span></code> </pre> <br>  Das Ergebnis des Skripts: <br><br><img src="https://habrastorage.org/webt/tm/fq/yo/tmfqyogtdhbje0atjckosbrgide.jpeg"><br><br>  Nachdem alles in der Funktion gepatcht wurde, k√∂nnen Sie die IDA auf ihren tats√§chlichen Anfang verweisen.  Es sammelt den gesamten Funktionscode in Teilen und kann mit HexRays dekompiliert werden. <br><br><h3>  Zeichenfolgen dekodieren </h3><br>  Wir haben im UC-Browser gelernt, wie man mit der Verschleierung von Maschinencode in der Bibliothek <i>libsgmainso-6.4.36.so umgeht,</i> und haben den Code f√ºr die Funktion <i>JNI_OnLoad erhalten</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">real_JNI_OnLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JavaVM *vm)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result; <span class="hljs-comment"><span class="hljs-comment">// r0 jclass clazz; // r0 MAPDST int v4; // r0 JNIEnv *env; // r4 int v6; // [sp-40h] [bp-5Ch] int v7; // [sp+Ch] [bp-10h] v7 = *(_DWORD *)off_8AC00; if ( !vm ) goto LABEL_39; sub_7C4F4(); env = (JNIEnv *)sub_7C5B0(0); if ( !env ) goto LABEL_39; v4 = sub_72CCC(); sub_73634(v4); sub_73E24(&amp;unk_83EA6, &amp;v6, 49); clazz = (jclass)((int (__fastcall *)(JNIEnv *, int *))(*env)-&gt;FindClass)(env, &amp;v6); if ( clazz &amp;&amp; (sub_9EE4(), sub_71D68(env), sub_E7DC(env) &gt;= 0 &amp;&amp; sub_69D68(env) &gt;= 0 &amp;&amp; sub_197B4(env, clazz) &gt;= 0 &amp;&amp; sub_E240(env, clazz) &gt;= 0 &amp;&amp; sub_B8B0(env, clazz) &gt;= 0 &amp;&amp; sub_5F0F4(env, clazz) &gt;= 0 &amp;&amp; sub_70640(env, clazz) &gt;= 0 &amp;&amp; sub_11F3C(env) &gt;= 0 &amp;&amp; sub_21C3C(env, clazz) &gt;= 0 &amp;&amp; sub_2148C(env, clazz) &gt;= 0 &amp;&amp; sub_210E0(env, clazz) &gt;= 0 &amp;&amp; sub_41B58(env, clazz) &gt;= 0 &amp;&amp; sub_27920(env, clazz) &gt;= 0 &amp;&amp; sub_293E8(env, clazz) &gt;= 0 &amp;&amp; sub_208F4(env, clazz) &gt;= 0) ) { result = (sub_B7B0(env, clazz) &gt;&gt; 31) | 0x10004; } else { LABEL_39: result = -1; } return result; }</span></span></code> </pre> <br>  Betrachten Sie die folgenden Zeilen sorgf√§ltig: <br><br><pre> <code class="cpp hljs"> sub_73E24(&amp;unk_83EA6, &amp;v6, <span class="hljs-number"><span class="hljs-number">49</span></span>); clazz = (jclass)((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> (__fastcall *)(JNIEnv *, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *))(*env)-&gt;FindClass)(env, &amp;v6);</code> </pre> <br>  Die Funktion <i>sub_73E24</i> entschl√ºsselt den Klassennamen explizit.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Als Parameter dieser Funktion werden ein Zeiger auf √§hnlich verschl√ºsselte Daten, ein Puffer und eine Nummer √ºbergeben. Offensichtlich </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enth√§lt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> der Puffer nach dem </font><i><font style="vertical-align: inherit;">Aufruf der</font></i><font style="vertical-align: inherit;"> Funktion </font><i><font style="vertical-align: inherit;">eine</font></i><font style="vertical-align: inherit;"> entschl√ºsselte Zeile, </font><i><font style="vertical-align: inherit;">da</font></i><font style="vertical-align: inherit;"> diese an die </font><i><font style="vertical-align: inherit;">FindClass-</font></i><font style="vertical-align: inherit;"> Funktion √ºbergeben wird </font><font style="vertical-align: inherit;">, die den Klassennamen als zweiten Parameter verwendet. Daher ist eine Zahl die Gr√∂√üe eines Puffers oder die L√§nge einer Zeichenfolge. Versuchen wir, den Namen der Klasse zu entschl√ºsseln. Er sollte uns sagen, ob wir in die richtige Richtung gehen. </font><i><font style="vertical-align: inherit;">Schauen</font></i><font style="vertical-align: inherit;"> wir uns </font><i><font style="vertical-align: inherit;">genauer</font></i><font style="vertical-align: inherit;"> an, was in </font><i><font style="vertical-align: inherit;">sub_73E24</font></i><font style="vertical-align: inherit;"> passiert </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></i> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_73E56</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __int8 *in, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __int8 *out, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v4; <span class="hljs-comment"><span class="hljs-comment">// r6 int v7; // r11 int v8; // r9 int v9; // r4 size_t v10; // r5 int v11; // r0 struc_1 v13; // [sp+0h] [bp-30h] int v14; // [sp+1Ch] [bp-14h] int v15; // [sp+20h] [bp-10h] v4 = 0; v15 = *(_DWORD *)off_8AC00; v14 = 0; v7 = sub_7AF78(17); v8 = sub_7AF78(size); if ( !v7 ) { v9 = 0; goto LABEL_12; } (*(void (__fastcall **)(int, const char *, int))(v7 + 12))(v7, "DcO/lcK+h?m3c*q@", 16); if ( !v8 ) { LABEL_9: v4 = 0; goto LABEL_10; } v4 = 0; if ( !in ) { LABEL_10: v9 = 0; goto LABEL_11; } v9 = 0; if ( out ) { memset(out, 0, size); v10 = size - 1; (*(void (__fastcall **)(int, unsigned __int8 *, size_t))(v8 + 12))(v8, in, v10); memset(&amp;v13, 0, 0x14u); v13.field_4 = 3; v13.field_10 = v7; v13.field_14 = v8; v11 = sub_6115C(&amp;v13, &amp;v14); v9 = v11; if ( v11 ) { if ( *(_DWORD *)(v11 + 4) == v10 ) { qmemcpy(out, *(const void **)v11, v10); v4 = *(_DWORD *)(v9 + 4); } else { v4 = 0; } goto LABEL_11; } goto LABEL_9; } LABEL_11: sub_7B148(v7); LABEL_12: if ( v8 ) sub_7B148(v8); if ( v9 ) sub_7B148(v9); return v4; }</span></span></code> </pre> <br>  <i>sub_7AF78</i>         (      ).     :     <i>¬´DcO/lcK+h?m3c*q@¬ª</i> ( ,   ),   ‚Äî  .       ,    <i>sub_6115C</i> .         3. ,      . <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_611B4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struc_1 *a1, _DWORD *a2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v3; <span class="hljs-comment"><span class="hljs-comment">// lr unsigned int v4; // r1 int v5; // r0 int v6; // r1 int result; // r0 int v8; // r0 *a2 = 820000; if ( a1 ) { v3 = a1-&gt;field_14; if ( v3 ) { v4 = a1-&gt;field_4; if ( v4 &lt; 0x19 ) { switch ( v4 ) { case 0u: v8 = sub_6419C(a1-&gt;field_0, a1-&gt;field_10, v3); goto LABEL_17; case 3u: v8 = sub_6364C(a1-&gt;field_0, a1-&gt;field_10, v3); goto LABEL_17; case 0x10u: case 0x11u: case 0x12u: v8 = sub_612F4( a1-&gt;field_0, v4, *(_QWORD *)&amp;a1-&gt;field_8, *(_QWORD *)&amp;a1-&gt;field_8 &gt;&gt; 32, a1-&gt;field_10, v3, a2); goto LABEL_17; case 0x14u: v8 = sub_63A28(a1-&gt;field_0, v3); goto LABEL_17; case 0x15u: sub_61A60(a1-&gt;field_0, v3, a2); return result; case 0x16u: v8 = sub_62440(a1-&gt;field_14); goto LABEL_17; case 0x17u: v8 = sub_6226C(a1-&gt;field_10, v3); goto LABEL_17; case 0x18u: v8 = sub_63530(a1-&gt;field_14); LABEL_17: v6 = 0; if ( v8 ) { *a2 = 0; v6 = v8; } return v6; default: LOWORD(v5) = 28032; goto LABEL_5; } } } } LOWORD(v5) = -27504; LABEL_5: HIWORD(v5) = 13; v6 = 0; *a2 = v5; return v6; }</span></span></code> </pre> <br>    switch   ,      3.  case 3:   <i>sub_6364C</i>    ,       , . .    .     <i>sub_6364C</i> ,      RC4. <br><br>      .    .   : <i>com/taobao/wireless/security/adapter/JNICLibrary</i> .  Gro√üartig!    . <br><br><h3>   </h3><br>     <i>RegisterNatives</i> ,      <i>doCommandNative</i> .  ,   <i>JNI_OnLoad,</i>     <i>sub_B7B0</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_B7F6</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *env, jclass clazz)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> signature[<span class="hljs-number"><span class="hljs-number">41</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// [sp+7h] [bp-55h] char name[16]; // [sp+30h] [bp-2Ch] JNINativeMethod method; // [sp+40h] [bp-1Ch] int v8; // [sp+4Ch] [bp-10h] v8 = *(_DWORD *)off_8AC00; decryptString((unsigned __int8 *)&amp;unk_83ED9, (unsigned __int8 *)name, 0x10u);// doCommandNative decryptString((unsigned __int8 *)&amp;unk_83EEA, (unsigned __int8 *)signature, 0x29u);// (I[Ljava/lang/Object;)Ljava/lang/Object; method.name = name; method.signature = signature; method.fnPtr = sub_B69C; return ((int (__fastcall *)(JNIEnv *, jclass, JNINativeMethod *, int))(*env)-&gt;RegisterNatives)(env, clazz, &amp;method, 1) &gt;&gt; 31; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In der Tat ist hier eine native Methode namens </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">doCommandNative</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> registriert </font><font style="vertical-align: inherit;">. Jetzt kennen wir seine Adresse. Mal sehen, was er macht.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doCommandNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *env, jobject obj, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> command, jarray args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v5; <span class="hljs-comment"><span class="hljs-comment">// r5 struc_2 *a5; // r6 int v9; // r1 int v11; // [sp+Ch] [bp-14h] int v12; // [sp+10h] [bp-10h] v5 = 0; v12 = *(_DWORD *)off_8AC00; v11 = 0; a5 = (struc_2 *)malloc(0x14u); if ( a5 ) { a5-&gt;field_0 = 0; a5-&gt;field_4 = 0; a5-&gt;field_8 = 0; a5-&gt;field_C = 0; v9 = command % 10000 / 100; a5-&gt;field_0 = command / 10000; a5-&gt;field_4 = v9; a5-&gt;field_8 = command % 100; a5-&gt;field_C = env; a5-&gt;field_10 = args; v5 = sub_9D60(command / 10000, v9, command % 100, 1, (int)a5, &amp;v11); } free(a5); if ( !v5 &amp;&amp; v11 ) sub_7CF34(env, v11, &amp;byte_83ED7); return v5; }</span></span></code> </pre> <br>    ,       ,       .      10601. <br><br>    ,       : <i>command / 10000</i> , <i>command % 10000 / 100</i>  <i>command % 10</i> , . .,   , 1, 6  1.   ,     <i>JNIEnv</i>  ,  ,      .      (  N1, N2  N3)   . <br><br>  : <br><br><img src="https://habrastorage.org/webt/xg/jk/l1/xgjkl1uhzmibo-nhmha3kpivf5a.png"><br><br>     <i>JNI_OnLoad</i> . <br>      .        .  ‚Äî   .    ,       ,    ,       (   ,        ). <br><br><h3>   </h3><br>    ,    : 0x5F1AC.    :  UC Browser      . <br><br>     ,     Java-,  <br>     0x4D070.         . <br><br>   R7  R4  : <br><br><img src="https://habrastorage.org/webt/7i/fx/86/7ifx86mr4yph41jsxukpjqvxmfa.png"><br><br>     R11: <br><br><img src="https://habrastorage.org/webt/fa/62/6j/fa626jaylcaaewtslff_-byaseo.jpeg"><br><br>     ,  : <br><br><img src="https://habrastorage.org/webt/co/rk/s1/corks1o2dp75elfvdsxjimrohuo.png"><br><br>        ,   R4.   230 . <br><br>  Was tun?   IDA,    switch: Edit -&gt; Other -&gt; Specify switch idiom. <br><br><img src="https://habrastorage.org/webt/36/uu/xn/36uuxnabf3xesptr8qisxzzfutk.jpeg"><br><br>   . ,    ,        <i>sub_6115C</i> : <br><br><img src="https://habrastorage.org/webt/-d/pt/3a/-dpt3akb_yckinmdheczkktzlem.jpeg"><br><br>   switch,    case 3      RC4.           ,   <i>doCommandNative</i> . ,      <i>magicInt</i>   16.   case ‚Äì      ,     . <br><br><img src="https://habrastorage.org/webt/rn/_1/i4/rn_1i4avl8oki83hslk5u19ygoe.jpeg"><br><br>  AES! <br><br>  ,    : ,  , ,   (       AES).      -    <i>sub_6115C</i> ,       ,     ,        . <br><br><h3>  </h3><br>          ,   Android Studio,   ,       ,     ,    ,    ,   . <br><br>         UC Browser  ¬´¬ª. ,         ,       .   :) ,       ,      , .           .    . <br><br>  : <br><br><img src="https://habrastorage.org/webt/hy/lk/qr/hylkqrhqgyei6qjdj6ayvgivpqu.jpeg"><br><br>   ARM        R0-R3, ,    ‚Äî  .   LR   .      ,      ,     .     ,      ,   PUSH.W {R0-R10,LR}.  R7      ,    . <br><br>    <i>fopen</i>   <i>/data/local/tmp/aes</i>   ¬´ab¬ª, <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d.h. hinzuf√ºgen. In R0 laden wir die Adresse des Dateinamens, in R1 die Adresse der Zeile, die den Modus angibt. Und dann endet der M√ºllcode. Fahren Sie mit der n√§chsten Funktion fort. Damit es weiterhin funktioniert, setzen wir am Anfang den √úbergang zum realen Funktionscode unter Umgehung von Garbage und f√ºgen anstelle von Garbage die Fortsetzung des Patches hinzu. </font></font><br><br><img src="https://habrastorage.org/webt/68/ss/kf/68sskfcymjorl_flpf8mg9wwej4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nennen fopen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die ersten drei Parameter der </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aes-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Funktion </font><font style="vertical-align: inherit;">sind vom Typ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Da wir die Register zu Beginn auf dem Stapel gespeichert haben, k√∂nnen wir die </font><font style="vertical-align: inherit;">Adressen auf dem Stapel </font><font style="vertical-align: inherit;">einfach an die Funktion </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fwrite √ºbergeben</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><img src="https://habrastorage.org/webt/d1/yt/iz/d1ytiz_jx7byflntqxxec2nece0.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Als n√§chstes haben wir drei Strukturen, die die Gr√∂√üe der Daten und einen Zeiger auf die Daten f√ºr den Schl√ºssel, den Initialisierungsvektor und die verschl√ºsselten Daten enthalten.</font></font><br><br><img src="https://habrastorage.org/webt/me/vy/kz/mevykztpkcwdr6xkpnenauxqccs.jpeg"><br><br>    ,        <i>aes</i> . <br><br>  APK   , ,   /, . ,    ,     .       ,       .    - ,       .   ,  UC Browser    ,     ,  ,     :    onCreate  . <br><br><pre> <code class="plaintext hljs"> const/16 v1, 0x62 new-array v1, v1, [B fill-array-data v1, :encrypted_data const/16 v0, 0x1f invoke-static {v0, v1}, Lcom/uc/browser/core/d/c/g;-&gt;j(I[B)[B move-result-object v1 array-length v2, v1 invoke-static {v2}, Ljava/lang/String;-&gt;valueOf(I)Ljava/lang/String; move-result-object v2 const-string v0, "ololo" invoke-static {v0, v2}, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</code> </pre> <br> , , , .  NullPointerException, . .   null. <br><br>        ,     : ¬´META-INF/¬ª  ".RSA". ,    .      .   ,    ,   ,      .     ,   ¬´META-INF/¬ª  ¬´BLABLINF/¬ª,       APK     . <br><br> , , , .  Bingo!   ! <br><br><h3> MitM </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben den Schl√ºssel und den Initialisierungsvektor gleich dem Schl√ºssel. Versuchen wir, die Serverantwort im CBC-Modus zu entschl√ºsseln. </font></font><br><br><img src="https://habrastorage.org/webt/9k/m7/un/9km7unymy_ybx1lwnflfbqd36ke.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir sehen die Archiv-URL, √§hnlich wie MD5, "extract_unzipsize" und eine Nummer. √úberpr√ºfen Sie: Das MD5-Archiv ist gleich, die Gr√∂√üe der entpackten Bibliothek ist gleich. Wir versuchen, diese Bibliothek zu patchen und an den Browser weiterzugeben. Um zu zeigen, dass unsere gepatchte Bibliothek geladen wurde, f√ºhren wir Intent aus, um SMS mit dem Text "PWNED!" Zu erstellen. Wir werden zwei Antworten vom Server ersetzen: </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puds.ucweb.com/upgrade/index.xhtml</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und zum Herunterladen des Archivs. Im ersten ersetzen wir MD5 (die Gr√∂√üe √§ndert sich nach dem Entpacken nicht), im zweiten geben wir das Archiv mit der gepatchten Bibliothek. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Browser versucht mehrmals, das Archiv herunterzuladen, woraufhin ein Fehler auftritt. Anscheinend etwas</font></font><br>   .       ,      : <br><br><img src="https://habrastorage.org/webt/e2/-v/ua/e2-vuahng86h0bt0vm84f3xhqrg.png"><br><br>    LEB128.        ,   ,    ,      . <br><br>   ‚Ä¶  ‚Äì ! :)   . <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://www.youtube.com/watch?v=Nfns7uH03J8</a> <br><br><h3>     </h3><br>           UC Browser,      .       ,      .   ‚Äî    ,         ,      ,   . <br><br>     UC Browser      ,       ,   -     .             .       ,  ,  ,   . 27   <br>    UC Browser 12.10.9.1193,      HTTPS: <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">puds.ucweb.com/upgrade/index.xhtml</a></i> . <br><br>  ,  ¬´¬ª          PDF         ¬´, -   !¬ª.       PDF  ,      ,            Google Play. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de451936/">https://habr.com/ru/post/de451936/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de451926/index.html">√úber Live-Code nach 130 Streams</a></li>
<li><a href="../de451928/index.html">So richten Sie Webanalysen auf AMP-Seiten ein</a></li>
<li><a href="../de451930/index.html">Automatisierung der Treppenhausbeleuchtung</a></li>
<li><a href="../de451932/index.html">PHDays 9: Willkommen im Bereich Sichere Entwicklung</a></li>
<li><a href="../de451934/index.html">Alexander Lamden: ‚ÄûJedes St√ºck Eisen hat einen Charakter‚Äú</a></li>
<li><a href="../de451938/index.html">Gehen Sie zu Bitmap-Indizes: Wild Search</a></li>
<li><a href="../de451942/index.html">Wie das Dr√∂hnen in Afrika Tausende von Menschenleben rettet</a></li>
<li><a href="../de451944/index.html">2019: Jahr des DEX (Dezentrale B√∂rsen)</a></li>
<li><a href="../de451948/index.html">Die Geschichte der drei Patronen</a></li>
<li><a href="../de451950/index.html">Virtuelle Kraftwerke. Ist es m√∂glich, die Quellen "gr√ºner" Energie zu verwalten?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>