<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌻 🌛 👩🏻‍🤝‍👨🏾 窃听CAN总线自动进行语音控制 👨🏾‍⚖️ 🤦🏿 🖖🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="现代汽车不仅是交通工具，而且是具有多媒体功能的先进小工具以及用于单元和传感器的电子控制系统。许多汽车制造商通过电话提供运动辅助，停车辅助，汽车监视和控制功能。由于在所有系统都连接到的汽车中使用了CAN总线，因此有可能做到这一点：引擎，制动系统，方向盘，多媒体，气候等。
 
 我的车是2011斯柯达明...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>窃听CAN总线自动进行语音控制</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/399043/"><img src="https://habrastorage.org/files/9c4/914/a47/9c4914a47e5249c9acff9db678ff6f82.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现代汽车不仅是交通工具，而且是具有多媒体功能的先进小工具以及用于单元和传感器的电子控制系统。许多汽车制造商通过电话提供运动辅助，停车辅助，汽车监视和控制功能。由于在所有系统都连接到的汽车中使用了CAN总线，因此有可能做到这一点：引擎，制动系统，方向盘，多媒体，气候等。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我的车是2011斯柯达明锐。</font><font style="vertical-align: inherit;">它不提供电话控制功能，因此我决定修复此缺陷，同时添加语音控制功能。</font><font style="vertical-align: inherit;">作为CAN总线和电话之间的网关，我将Raspberry Pi与CAN BUS防护罩和TP-Link WiFi路由器一起使用。</font><font style="vertical-align: inherit;">自动聚合的通讯协议已关闭，大众汽车回复了我的所有来信以及协议文件。</font><font style="vertical-align: inherit;">因此，找出设备如何在汽车中通信并学习如何管理它们的唯一方法是对大众总线的CAN协议进行反向工程。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我分阶段行动：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为Raspberry Pi开发CAN屏蔽</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装用于CAN总线的软件</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">连接到汽车的CAN总线</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">嗅探器的开发和CAN总线协议的研究</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手机应用开发</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用Homekit和Siri进行语音控制</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在视频语音控制窗口的末尾。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为Raspberry Pi开发CAN屏蔽</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这里，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">屏蔽</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方案是由</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">lnxpps.de/rpie</font></a><font style="vertical-align: inherit;">采取的</font><font style="vertical-align: inherit;">，还对结论进行了描述，使用了2个微电路MCP2515和MCP2551与CAN进行通信。</font><font style="vertical-align: inherit;">2线CAN-High和CAN-Low连接到屏蔽层。</font><font style="vertical-align: inherit;">在SprintLayout 6中，我展开了电路板，任何人都可以方便地使用</font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CANBoardRPi.lay</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（标题照片中为面包板上的屏蔽板原型）。</font></font><br>
<br>
<img src="https://habrastorage.org/files/3b2/37d/a55/3b237da55bf640f09b88e609ba02c54f.jpg"><br>
<br>
<img src="https://habrastorage.org/files/cd7/63f/cb4/cd763fcb4fce4b01afa57b0b34cf7afe.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装用于CAN总线的软件</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在2岁的Raspbian上，我需要修补bcm2708.c以添加CAN支持（也许现在不需要）。</font><font style="vertical-align: inherit;">要使用CAN总线，您需要从</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/linux-can/can-utils</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装can-utils实用程序包</font><font style="vertical-align: inherit;">，然后加载模块并提高can接口：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># initialize</span></span><font></font>
insmod spi-bcm2708<font></font>
insmod can<font></font>
insmod can-dev<font></font>
insmod can-raw<font></font>
insmod can-bcm<font></font>
insmod mcp251x<font></font>
<span class="hljs-comment"><span class="hljs-comment"># Maerklin Gleisbox (60112 and 60113) uses 250000</span></span>
<span class="hljs-comment"><span class="hljs-comment"># loopback mode for testing</span></span>
ip link <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> can0 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> can bitrate 125000 loopback on<font></font>
ifconfig can0 up<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ifconfig</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令</font></font><br>
<br>
<img src="https://habrastorage.org/files/3f5/4f9/065/3f54f9065c764213a2ff3d644b58e8db.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
验证</font><font style="vertical-align: inherit;">CAN接口是否已经上升</font><font style="vertical-align: inherit;">：</font><font style="vertical-align: inherit;">您可以通过发送和接收命令来验证一切正常。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在一个终端中，我们听：</font></font><br>
<br>
<pre><code class="bash hljs">root@raspberrypi ~ <span class="hljs-comment"><span class="hljs-comment"># candump any,0:0,#FFFFFFFF</span></span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在另一个终端，我们发送：</font></font><br>
<br>
<pre><code class="bash hljs">root@raspberrypi ~ <span class="hljs-comment"><span class="hljs-comment"># cansend can0 123#deadbeef</span></span>
</code></pre><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lnxpps.de/rpie中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
描述了更详细的安装过程</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">连接到汽车的CAN总线</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对VW CAN总线上</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">开放文档进行</font></a><font style="vertical-align: inherit;">了一些研究之后</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">，</font></a><font style="vertical-align: inherit;">我发现我使用了2条总线。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功率单元的CAN总线以</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 500 kbit / s的速度传输数据，连接了服务于该单元的所有控制单元。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，以下设备可以连接到电源设备的CAN总线：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发动机控制单元</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ABS控制单元</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">航向稳定控制单元，</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变速箱控制单元</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安全气囊控制单元</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">组合仪表。</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comfort系统和信息</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令</font><b><font style="vertical-align: inherit;">系统的CAN总线</font></b><font style="vertical-align: inherit;">，允许在为这些系统提供服务的控制单元之间以100 kbit / s的速度传输数据。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下设备</font><font style="vertical-align: inherit;">可以</font><font style="vertical-align: inherit;">连接</font><font style="vertical-align: inherit;">到Comfort系统的CAN总线和信息&lt;command system </font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Climatronic控制单元或空调系统，</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">车门中的控制单元</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">舒适系统控制单元</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">带收音机和导航系统显示器的控制单元。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
可以访问第一个</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
总线</font><font style="vertical-align: inherit;">，您可以控制交通（在我的机械手版本中，您至少可以控制巡航控制），可以访问第二个</font><font style="vertical-align: inherit;">总线</font><font style="vertical-align: inherit;">，您可以控制无线电，气候，中央门锁，电动车窗，前大灯等。</font><font style="vertical-align: inherit;">两条总线均通过位于网关的网关连接在方向盘下方的区域中，诊断型OBD2连接器也连接到网关，很遗憾，无法通过OBD2连接器听到两条总线的通讯，您只能发送命令并请求状态。</font><font style="vertical-align: inherit;">我决定只使用Comfort公交车，而驾驶员车门中的连接器竟然是连接公交车最方便的地方。</font></font><br>
<br>
<img src="https://habrastorage.org/files/d74/ec6/63a/d74ec663afd44450bd2240160d3d84ce.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我可以聆听Comfort CAN上发生的一切并发送命令。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">嗅探器的开发和CAN总线协议的研究</font></font></h2><br>
<img src="https://habrastorage.org/files/ec4/f74/c60/ec4f74c609bd43ad8ce6b316047e42e1.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
访问了CAN总线后，我需要解密谁通过谁和什么。</font><font style="vertical-align: inherit;">图中显示了CAN数据包格式。</font></font><br>
<br>
<img src="https://habrastorage.org/files/97f/667/5f6/97f6675f65d64506bbff0e797ef9826e.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
can-utils集合中的所有实用程序本身都能够解析CAN数据包并仅提供有用的信息，即：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编号</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">资料长度</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">资料</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数据以未加密的形式传输，这有助于协议的研究。</font><font style="vertical-align: inherit;">在Raspberry Pi上，我编写了一个小型服务器，该服务器将数据从candump重定向到TCP / IP，以解析计算机上的数据流并显示精美的数据。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于macOS，我编写了一个简单的应用程序，为每个设备地址在平板电脑上添加了一个单元格，在该单元格中我已经可以看到正在更改的数据。</font></font><br>
<br>
<img src="https://habrastorage.org/files/19e/944/bbe/19e944bbe865425db15e9af90e69edd9.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我按下电源窗口按钮，找到一个其中数据发生变化的单元格，然后确定哪些命令对应于按下，按下，按住，按住。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以通过从终端发送该命令来验证该命令是否有效，例如，将左玻璃抬高的命令：</font></font><br>
<br>
<pre><code class="bash hljs">cansend can0 181<span class="hljs-comment"><span class="hljs-comment">#0200</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过VAG汽车中的CAN总线传输设备的团队（Skoda Octavia，2011年），通过反向工程获得了：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Front Left Glass Up</span></span>
<span class="hljs-number"><span class="hljs-number">181</span></span>#<span class="hljs-number"><span class="hljs-number">0200</span></span>
<span class="hljs-comment"><span class="hljs-comment">// Front Left Glass Down</span></span>
<span class="hljs-number"><span class="hljs-number">181</span></span>#<span class="hljs-number"><span class="hljs-number">0800</span></span>
<span class="hljs-comment"><span class="hljs-comment">// Front Right Glass Up</span></span>
<span class="hljs-number"><span class="hljs-number">181</span></span>#<span class="hljs-number"><span class="hljs-number">2000</span></span>
<span class="hljs-comment"><span class="hljs-comment">// Front Right Glass Down</span></span>
<span class="hljs-number"><span class="hljs-number">181</span></span>#<span class="hljs-number"><span class="hljs-number">8000</span></span>
<span class="hljs-comment"><span class="hljs-comment">// Back Left Glass Up</span></span>
<span class="hljs-number"><span class="hljs-number">181</span></span>#<span class="hljs-number"><span class="hljs-number">0002</span></span>
<span class="hljs-comment"><span class="hljs-comment">// Back Left Glass Down</span></span>
<span class="hljs-number"><span class="hljs-number">181</span></span>#<span class="hljs-number"><span class="hljs-number">0008</span></span>
<span class="hljs-comment"><span class="hljs-comment">// Back Right Glass Up</span></span>
<span class="hljs-number"><span class="hljs-number">181</span></span>#<span class="hljs-number"><span class="hljs-number">0020</span></span>
<span class="hljs-comment"><span class="hljs-comment">// Back Right Glass Down</span></span>
<span class="hljs-number"><span class="hljs-number">181</span></span>#<span class="hljs-number"><span class="hljs-number">0080</span></span>
<span class="hljs-comment"><span class="hljs-comment">// Central Lock Open</span></span>
<span class="hljs-number"><span class="hljs-number">291</span></span>#<span class="hljs-number"><span class="hljs-number">09</span></span>AA020000
<span class="hljs-comment"><span class="hljs-comment">// Central Lock Close</span></span>
<span class="hljs-number"><span class="hljs-number">291</span></span>#<span class="hljs-number"><span class="hljs-number">0955040000</span></span>
<span class="hljs-comment"><span class="hljs-comment">// Update Light status of central lock (   /          ,       ,    )</span></span>
<span class="hljs-number"><span class="hljs-number">291</span></span>#<span class="hljs-number"><span class="hljs-number">0900000000</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我懒得学习其他所有设备，因此在此列表中，只有我感兴趣的内容。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手机应用开发</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用收到的命令，我为iPhone编写了一个应用程序，该应用程序可以打开/关闭窗口并控制中央锁。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Raspberry Pi上，我启动了2台小型服务器，第一台将数据从candump发送到TCP / IP，第二台从iPhone接收命令并将其发送到cansend。</font></font><br>
<br>
<img src="https://habrastorage.org/files/8ab/4be/824/8ab4be824e4946bfb0151492c5c5e0d5.png"><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自动控制iOS应用程序源</font></font></b><div class="spoiler_text"><pre><code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//</span></span>
<span class="hljs-comment"><span class="hljs-comment">//  FirstViewController.m</span></span>
<span class="hljs-comment"><span class="hljs-comment">//  Car Control</span></span>
<span class="hljs-comment"><span class="hljs-comment">//</span></span>
<span class="hljs-comment"><span class="hljs-comment">//  Created by Vitaliy Yurkin on 17.05.15.</span></span>
<span class="hljs-comment"><span class="hljs-comment">//  Copyright (c) 2015 Vitaliy Yurkin. All rights reserved.</span></span>
<span class="hljs-comment"><span class="hljs-comment">//</span></span>

<span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"FirstViewController.h"</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"DataConnection.h"</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CommandConnection.h"</span></span></span></span>

<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FirstViewController</span></span></span><span class="hljs-class"> () &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataConnectionDelegate</span></span></span><span class="hljs-class">&gt;</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) DataConnection *dataConnection;
<span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) CommandConnection *commandConnection;
<span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">IBOutlet</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span> *Door_1;
<span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">IBOutlet</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span> *Door_2;
<span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">IBOutlet</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span> *Door_3;
<span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">IBOutlet</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span> *Door_4;
<span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">IBOutlet</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *CentralLock;
- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)lockUnlock:(<span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *)sender;
<span class="hljs-keyword"><span class="hljs-keyword">@end</span></span>

<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FirstViewController</span></span></span></span>

- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)viewDidLoad {
    <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.dataConnection = [DataConnection new];
    <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.dataConnection.delegate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>;
    [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.dataConnection connectToCanBus];
    
    <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.commandConnection = [CommandConnection new];
    [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.commandConnection connectToCanBus];
}

- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)didReceiveMemoryWarning {
    [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> didReceiveMemoryWarning];
    <span class="hljs-comment"><span class="hljs-comment">// Dispose of any resources that can be recreated.</span></span>
}

- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)doorStatusChanged:(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)value {
    <span class="hljs-comment"><span class="hljs-comment">/*
     1 - Front Left Door
     2 - Front Right Door
     4 - Back Left Door
     8 - Back Right Door
     
     3 - Front Left&amp;Right Door = 1 + 3
     5 - Front&amp; Back left Door = 1 + 4
     */</span></span>
    
    <span class="hljs-comment"><span class="hljs-comment">// Front Left Door</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>) {
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_1.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> yellowColor];
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_1.text = <span class="hljs-string"><span class="hljs-string">@""</span></span>;
        <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"1"</span></span>);
    }
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_1.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> lightGrayColor];
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_1.text = <span class="hljs-string"><span class="hljs-string">@""</span></span>;
    }
    
    <span class="hljs-comment"><span class="hljs-comment">// Front Right Door</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value &amp; <span class="hljs-number"><span class="hljs-number">2</span></span>) {
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_2.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> yellowColor];
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_2.text = <span class="hljs-string"><span class="hljs-string">@""</span></span>;
        <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"2"</span></span>);
    }
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_2.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> lightGrayColor];
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_2.text = <span class="hljs-string"><span class="hljs-string">@""</span></span>;
    }
    
    <span class="hljs-comment"><span class="hljs-comment">// Back Left Door</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value &amp; <span class="hljs-number"><span class="hljs-number">4</span></span>) {
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_3.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> yellowColor];
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_3.text = <span class="hljs-string"><span class="hljs-string">@""</span></span>;
        <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"4"</span></span>);
    }
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_3.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> lightGrayColor];
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_3.text = <span class="hljs-string"><span class="hljs-string">@""</span></span>;
    }
    
    <span class="hljs-comment"><span class="hljs-comment">// Back Right Door</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value &amp; <span class="hljs-number"><span class="hljs-number">8</span></span>) {
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_4.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> yellowColor];
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_4.text = <span class="hljs-string"><span class="hljs-string">@""</span></span>;
        <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"8"</span></span>);
    }
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_4.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> lightGrayColor];
        <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.Door_4.text = <span class="hljs-string"><span class="hljs-string">@""</span></span>;
    }
}

<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> firstStatusChange = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>;
<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> lastStatus;

-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) centralLockStatusChanged:(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)status {
    <span class="hljs-comment"><span class="hljs-comment">// At first status changes set lastStatus variable</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstStatusChange) {
        firstStatusChange = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>;
        <span class="hljs-comment"><span class="hljs-comment">// Invert status, to pass the next test</span></span>
        lastStatus = !status;
    }
    
    <span class="hljs-comment"><span class="hljs-comment">// Change Lock image only if status changed</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(lastStatus == status)) {
        <span class="hljs-comment"><span class="hljs-comment">// Check status</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status) {
            [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.CentralLock setBackgroundImage:[<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> imageNamed:<span class="hljs-string"><span class="hljs-string">@"lock_close"</span></span>] forState:<span class="hljs-built_in"><span class="hljs-built_in">UIControlStateNormal</span></span>];
        }
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
            [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.CentralLock setBackgroundImage:[<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> imageNamed:<span class="hljs-string"><span class="hljs-string">@"lock_open"</span></span>] forState:<span class="hljs-built_in"><span class="hljs-built_in">UIControlStateNormal</span></span>];
        }
        lastStatus = status;
    }
}


<span class="hljs-comment"><span class="hljs-comment">// Front Left Glass</span></span>
- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)frontLeftUp:(<span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *)sender {
    [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.commandConnection sendMessage:<span class="hljs-string"><span class="hljs-string">@"cansend can0 181#0200"</span></span>];
}
- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)frontLeftDown:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)sender {
    [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.commandConnection sendMessage:<span class="hljs-string"><span class="hljs-string">@"cansend can0 181#0800"</span></span>];
}

<span class="hljs-comment"><span class="hljs-comment">// Front Right Glass</span></span>
- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)frontRightUp:(<span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *)sender {
    [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.commandConnection sendMessage:<span class="hljs-string"><span class="hljs-string">@"cansend can0 181#2000"</span></span>];
}
- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)frontRightDown:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)sender {
    [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.commandConnection sendMessage:<span class="hljs-string"><span class="hljs-string">@"cansend can0 181#8000"</span></span>];
}

<span class="hljs-comment"><span class="hljs-comment">// Back Left Glass</span></span>
- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)backLeftUp:(<span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *)sender {
    [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.commandConnection sendMessage:<span class="hljs-string"><span class="hljs-string">@"cansend can0 181#0002"</span></span>];
}
- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)backLeftDown:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)sender {
    [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.commandConnection sendMessage:<span class="hljs-string"><span class="hljs-string">@"cansend can0 181#0008"</span></span>];
}

<span class="hljs-comment"><span class="hljs-comment">// Back Right Glass</span></span>
- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)backRightUp:(<span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *)sender {
    [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.commandConnection sendMessage:<span class="hljs-string"><span class="hljs-string">@"cansend can0 181#0020"</span></span>];
}
- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)backtRightDown:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)sender {
    [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.commandConnection sendMessage:<span class="hljs-string"><span class="hljs-string">@"cansend can0 181#0080"</span></span>];
}

- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)lockUnlock:(<span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *)sender {
    <span class="hljs-comment"><span class="hljs-comment">// If central lock closed</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastStatus) {
        <span class="hljs-comment"><span class="hljs-comment">// Open</span></span>
        [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.commandConnection sendMessage:<span class="hljs-string"><span class="hljs-string">@"cansend can0 291#09AA020000"</span></span>];

        int64_t delayInSeconds = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// 1 sec</span></span>
        dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, delayInSeconds * <span class="hljs-built_in"><span class="hljs-built_in">NSEC_PER_SEC</span></span>);
        dispatch_after(popTime, dispatch_get_main_queue(), ^(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>){
            [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.commandConnection sendMessage:<span class="hljs-string"><span class="hljs-string">@"cansend can0 291#0900000000"</span></span>];
        });
        
    }
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
        <span class="hljs-comment"><span class="hljs-comment">// Close</span></span>
        [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.commandConnection sendMessage:<span class="hljs-string"><span class="hljs-string">@"cansend can0 291#0955040000"</span></span>];
        int64_t delayInSeconds = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// 1 sec</span></span>
        dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, delayInSeconds * <span class="hljs-built_in"><span class="hljs-built_in">NSEC_PER_SEC</span></span>);
        dispatch_after(popTime, dispatch_get_main_queue(), ^(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>){
            [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.commandConnection sendMessage:<span class="hljs-string"><span class="hljs-string">@"cansend can0 291#0900000000"</span></span>];
        });
    }
    
}
<span class="hljs-keyword"><span class="hljs-keyword">@end</span></span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有一种方法不为手机编写应用程序，而是要利用现成的智能家居世界的优势，只需在Raspberry Pi </font><font style="vertical-align: inherit;">命令</font><font style="vertical-align: inherit;">上安装</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z-Way</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自动化系统</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">wget -q -O - razberry.z-wave.me/install | sudo bash</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
之后，我们将CAN设备添加到Z-Way自动化系统中，</font></font><br>
<br>
<img src="https://habrastorage.org/files/ae9/f3f/da1/ae9f3fda1c0c4c0d946b3d052ec655de.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后将车窗</font></font><br>
<br>
<img src="https://habrastorage.org/files/33b/87d/a28/33b87da284b2450b92abe7c75d398556.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调节器</font><font style="vertical-align: inherit;">作为普通开关</font><font style="vertical-align: inherit;">进行控制：Z-Way的移动应用：ZWay Home Control和ZWay Control。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用Homekit和Siri进行语音控制</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我的一篇文章中，我描述了</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Raspberry Pi上安装Homebridge以便对Z-Way家庭自动化系统进行语音控制的过程</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">安装Homebridge之后，您将能够使用Siri进行语音控制。</font><font style="vertical-align: inherit;">我确信对于Android，有许多应用程序允许语音发送HTTP请求来控制Z-Way。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
视频包含语音控制窗口</font></font><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/IHX86-q6OGY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN399043/">https://habr.com/ru/post/zh-CN399043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN399031/index.html">Microsoft在Windows Store中向“使命召唤：无限战争”的客户退还款项</a></li>
<li><a href="../zh-CN399033/index.html">英国科学家谈到“英国科学家”的出现方式</a></li>
<li><a href="../zh-CN399037/index.html">当远离此领域的人撰写有关吉他管声音的文章时会发生什么</a></li>
<li><a href="../zh-CN399039/index.html">熊猫在企鹅之中。x86_64 LattePanda微型计算机</a></li>
<li><a href="../zh-CN399041/index.html">唐纳德·特朗普太空</a></li>
<li><a href="../zh-CN399045/index.html">回顾过去：我们在俄罗斯购买的2006年手机</a></li>
<li><a href="../zh-CN399047/index.html">Свобода программиста</a></li>
<li><a href="../zh-CN399051/index.html">11月11日至13日，数字十月将举办区块链项目黑客马拉松</a></li>
<li><a href="../zh-CN399053/index.html">动物世界中的物理学：蜻蜓及其飞行</a></li>
<li><a href="../zh-CN399055/index.html">在企业中使用区块链技术的方式：数字十月教育中心项目将于2月18日开始</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>