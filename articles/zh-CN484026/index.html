<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‡ ğŸš“ ğŸ•£ ç¬¬6éƒ¨åˆ†ï¼šå°†MemTest86 +ç§»æ¤åˆ°RISC-V ğŸ‘©ğŸ¼â€ğŸ¤â€ğŸ‘¨ğŸ¿ ğŸ‡ğŸ¾ ğŸ‘§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¤§æ¦‚å¾ˆå°‘æœ‰ITä¸“å®¶éœ€è¦è§£é‡Šä¸€ä¸‹Memtest86 +æ˜¯ä»€ä¹ˆ-ä¹Ÿè®¸å®ƒå·²ç»æˆä¸ºæˆ–å¤šæˆ–å°‘æˆä¸ºæµ‹è¯•PC RAMçš„æ ‡å‡†ã€‚ åœ¨ä¸Šä¸€éƒ¨åˆ†å†…å®¹ä¸­ï¼Œæˆ‘ç¢°åˆ°äº†ä¸ä¸»æ¿æ†ç»‘åœ¨ä¸€èµ·çš„æŸåçš„å†…å­˜æ¡ï¼Œå®ƒï¼ˆä¸æ”¯æŒDDR2çš„ä¸Šç½‘æœ¬ä¸€èµ·ï¼‰ä¼¼ä¹æ˜¯ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„è§£å†³æ–¹æ¡ˆã€‚ å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œä»åŸåˆ™ä¸Šè®²ï¼Œè‚‰çœ¼å¯ä»¥çœ‹åˆ°ç³»ç»Ÿçš„ä¸ç¨³å®šè¿è¡Œã€‚ åœ¨æ›´æ£˜æ‰‹...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ç¬¬6éƒ¨åˆ†ï¼šå°†MemTest86 +ç§»æ¤åˆ°RISC-V</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484026/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ne/fb/ha/nefbhar5ihkfmvccfwp0jqrm78u.png"></div><br><p>å¤§æ¦‚å¾ˆå°‘æœ‰ITä¸“å®¶éœ€è¦è§£é‡Šä¸€ä¸‹Memtest86 +æ˜¯ä»€ä¹ˆ-ä¹Ÿè®¸å®ƒå·²ç»æˆä¸ºæˆ–å¤šæˆ–å°‘æˆä¸ºæµ‹è¯•PC RAMçš„æ ‡å‡†ã€‚ åœ¨<a href="https://habr.com/ru/post/459470/">ä¸Šä¸€éƒ¨åˆ†å†…å®¹ä¸­ï¼Œ</a>æˆ‘ç¢°åˆ°äº†ä¸ä¸»æ¿æ†ç»‘åœ¨ä¸€èµ·çš„æŸåçš„å†…å­˜æ¡ï¼Œå®ƒï¼ˆä¸æ”¯æŒDDR2çš„ä¸Šç½‘æœ¬ä¸€èµ·ï¼‰ä¼¼ä¹æ˜¯ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„è§£å†³æ–¹æ¡ˆã€‚ å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œä»åŸåˆ™ä¸Šè®²ï¼Œè‚‰çœ¼å¯ä»¥çœ‹åˆ°ç³»ç»Ÿçš„ä¸ç¨³å®šè¿è¡Œã€‚ åœ¨æ›´æ£˜æ‰‹çš„æƒ…å†µä¸‹ï¼Œæˆ‘å¬è¯´é™¤äº†å¯ä»¥æ— é™æ¬¡â€œçªƒå¬â€å­˜å‚¨å•å…ƒè‡³æ— ç©·å¤§ä¹‹å¤–ï¼Œè¯¥å·¥å…·è¿˜ä½¿ç”¨äº†ä¸€äº›ç‰¹æ®Šçš„æ•°æ®æ¨¡å¼ï¼Œåœ¨è¿™äº›æ•°æ®æ¨¡å¼ä¸Šæ›´æœ‰å¯èƒ½æ£€æµ‹åˆ°DDRæ“ä½œä¸­çš„é”™è¯¯ã€‚ æ€»çš„æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä»¶å¥‡å¦™çš„äº‹æƒ…ï¼Œå¯æƒœçš„æ˜¯ï¼Œå³ä½¿å®ƒçš„åå­—è¯´çš„æ˜¯ï¼š86-â€œä»…é€‚ç”¨äºx86å…¼å®¹ç³»ç»Ÿâ€ã€‚ è¿˜æ˜¯ä¸è¡Œ </p><br><p> åœ¨å‰ªåˆ‡ä¸‹ï¼Œæ‚¨å°†çœ‹åˆ°æˆ‘å°è¯•å°†MemTest86 + v5.1ç§»æ¤åˆ°RISC-Vä»¥åŠå°è®¡çš„æƒ…å†µã€‚  <em>å‰§é€ï¼šå®ƒç§»åŠ¨äº†ï¼</em> </p><a name="habracut"></a><br><p>  <strong>å…è´£å£°æ˜ï¼šæˆ‘ä»…åœ¨ç‰¹å®šæ¿ä¸Šçš„ç‰¹å®šRocketChipç»„ä»¶ä¸Šå¯¹æµ‹è¯•ç»“æœè¿›è¡Œäº†æœ€å°‘çš„æµ‹è¯•ã€‚</strong>  <strong>ä¸ä¿è¯å‡†ç¡®æ€§å’Œå®‰å…¨æ€§ï¼ˆå°¤å…¶æ˜¯åœ¨å…¶ä»–ç³»ç»Ÿä¸Šï¼‰ã€‚</strong>  <strong>ä½¿ç”¨é£é™©è‡ªè´Ÿã€‚</strong>  <strong>ç‰¹åˆ«æ˜¯ï¼Œå¦‚æœå½“å‰ä¿ç•™çš„å†…å­˜åŒºåŸŸå±äºRAMèŒƒå›´ï¼Œåˆ™ä¸ä¼šå¯¹å…¶è¿›è¡Œä»»ä½•å¤„ç†ã€‚</strong> </p><br><p> æ­£å¦‚æˆ‘å·²ç»è¯´è¿‡çš„ï¼Œä¸ä¹…å‰æˆ‘åœ¨é€Ÿå–é€šä¸Šè´­ä¹°äº†å¸¦æœ‰Cyclone IVçš„ä¸»æ¿ï¼Œä½†å…¶ä¸­çš„å†…å­˜æœ‰é—®é¢˜ã€‚ å¹¸è¿çš„æ˜¯ï¼Œè¯¥æ¿å¡çš„é‡è¦åŠŸèƒ½ä¹‹ä¸€æ˜¯ä½¿ç”¨äº†å¸¸è§„çš„DDR2 SO-DIMMæ¨¡å—-ä¸æˆ‘çš„æ—§ä¸Šç½‘æœ¬ç›¸åŒã€‚ ç„¶è€Œï¼Œå¯ä»¥è¯´ï¼Œè·å¾—ä¸€ç§ç”¨äºæµ‹è¯•å†…å­˜æ¨¡å—ï¼ˆå®é™…ä¸Šä¹Ÿæ˜¯æ§åˆ¶å™¨ï¼‰çš„è‡ªæ‰˜ç®¡è§£å†³æ–¹æ¡ˆæ˜¯å¾ˆæœ‰è¶£çš„ã€‚ åœ¨å†…å­˜ä¸è¶³çš„æƒ…å†µä¸‹è°ƒè¯•æˆ‘çš„é”™è¯¯çš„å‰æ™¯æ ¹æœ¬ä¸ä»¤äººæ»¡æ„ã€‚ å°¤å…¶æ˜¯ä¸å¸Œæœ›æœ‰ä¸€ä¸ªå¿«é€Ÿçš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶ä¸”ä¸å¸Œæœ›åœ¨æ— é™é•¿çš„æ—¶é—´å†…æ¨è¿Ÿåœ¨å¦ä¸€ä¸ªæ±‡ç¼–å™¨ä¸­è¿›è¡Œå®Œå…¨é‡å†™ï¼Œæˆ‘æ‰“å¼€äº†ä¸€ç¯‡æœ‰å…³Memtest86 +çš„Wikipediaæ–‡ç« ï¼Œçªç„¶å‘ç°å¡ç‰‡ä¸­å†™ç€â€œç”¨Cå’Œæ±‡ç¼–è¯­è¨€ç¼–å†™â€ã€‚ å—¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»–è™½ç„¶æ˜¯â€œ ... 86â€ï¼Œä½†ä¸æ˜¯å®Œå…¨ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™çš„ï¼Ÿ è¿™ä»¤äººé¼“èˆã€‚ ä»ç„¶åªæœ‰äº†è§£å…³ç³»ã€‚ </p><br><p> å› æ­¤ï¼Œè¯·è½¬åˆ°<a href="http://www.memtest.org/" rel="nofollow">memtest.org</a>å¹¶åœ¨GPL2ä¸‹ä¸‹è½½ç‰ˆæœ¬5.01ã€‚ ä¸ºäº†ä¾¿äºå¼€å‘ï¼Œæˆ‘åœ¨GitHubä¸Š<a href="https://github.com/atrosinenko/memtest86-plus-riscv" rel="nofollow">é‡æ–°åŠ è½½äº†</a>å®ƒã€‚ å¹¸è¿çš„æ˜¯ï¼Œåœ¨æºä»£ç æ¡£æ¡ˆä¸­ï¼Œæˆ‘ä»¬å—åˆ°åä¸º<a href="https://github.com/atrosinenko/memtest86-plus-riscv/blob/68b365d13cf22accd52f88af49c33f57c6643ae5/README.background" rel="nofollow">README.backgroundçš„</a>æ–‡ä»¶çš„æ¬¢è¿ã€‚ </p><br><blockquote>  Memtest86-SMPçš„è§£å‰–ä¸ç”Ÿç† </blockquote><p>å®ƒè¯¦ç»†è§£é‡Šäº†ä»£ç çš„é«˜çº§æ“ä½œï¼ˆç”šè‡³ä½¿ç”¨ASCIIå½¢å¼çš„å›¾ç‰‡ï¼‰ã€‚ åœ¨æ–‡æ¡£çš„å¼€å§‹ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ª<em>Binaryå¸ƒå±€</em> ï¼Œå®ƒç”±<code>bootsect.o</code> ï¼Œ <code>setup.o</code> ï¼Œ <code>head.o</code>å’Œä¸€äº›<code>memtest_shared</code> ã€‚ æ˜¾è€Œæ˜“è§ï¼Œè¿™ä¸‰ä¸ªç›®æ ‡æ–‡ä»¶æ˜¯ä»ç›¸åº”çš„æ±‡ç¼–ç¨‹åºæºä¸­è·å¾—çš„ã€‚ ä¹ä¸€çœ‹ï¼Œå…¶ä»–æ‰€æœ‰å†…å®¹éƒ½æ˜¯ç”¨Cç¼–å†™çš„ï¼ è¿˜ä¸é”™ï¼Œè¿˜ä¸é”™... </p><br><p> ç»“æœï¼Œæˆ‘å°†<code>Makefile</code>å¤åˆ¶åˆ°<code>Makefile.arch</code>å¹¶å¼€å§‹é‡å†™æ‰€æœ‰å†…å®¹ï¼Œå¹¶å°è¯•ä¸¢å¼ƒä¸å¯¹åº”çš„å†…å®¹ã€‚ å½“ç„¶ï¼Œé¦–å…ˆï¼Œæˆ‘éœ€è¦RISC-Vçš„å·¥å…·é“¾ï¼Œå¹¸è¿çš„æ˜¯ï¼Œè‡ªä»ä¹‹å‰çš„å®éªŒä»¥æ¥ï¼Œå®ƒä¸€ç›´åœ¨æˆ‘èº«è¾¹ã€‚ èµ·åˆæˆ‘æƒ³ä¸º32ä½ä½“ç³»ç»“æ„åˆ›å»ºä¸€ä¸ªç«¯å£ï¼Œä½†æ˜¯åæ¥æˆ‘æƒ³èµ·ä¸€ä¸ª64ä½å¤„ç†å™¨å·²ä¸Šä¼ åˆ°æ¿ä¸Šï¼Œå¹¶ä¸”æˆ‘çš„<code>riscv64-</code>å¸¦æœ‰<code>riscv64-</code>å‰ç¼€ã€‚ </p><br><p>  <em>æŠ’æƒ…ç¦»é¢˜ï¼š</em>å½“ç„¶ï¼Œé¦–å…ˆæ˜¯ç ”ç©¶32ä½å’Œ64ä½ä»£ç çš„å…¼å®¹æ€§é—®é¢˜ã€‚ ç»“æœï¼Œåœ¨<code>1.3 RISC-V ISA Overview</code>å£°æ˜çš„ç¬¬<code>1.3 RISC-V ISA Overview</code>æ®µä¸­æ‰¾åˆ°äº†ISAï¼ˆæŒ‡ä»¤é›†ä½“ç³»ç»“æ„ï¼‰çš„éç‰¹æƒéƒ¨åˆ†çš„è§„èŒƒï¼š </p><br><blockquote> æ˜¾å¼åˆ†ç¦»åŸºæœ¬ISAçš„ä¸»è¦ä¼˜ç‚¹æ˜¯ï¼Œå¯ä»¥é’ˆå¯¹æ¯ä¸ªåŸºæœ¬ISAè¿›è¡Œä¼˜åŒ–ï¼Œè€Œæ— éœ€æ”¯æŒå…¶ä»–åŸºæœ¬ISAæ‰€éœ€çš„æ‰€æœ‰æ“ä½œã€‚ ä¾‹å¦‚ï¼ŒRV64Iå¯ä»¥çœç•¥ä»…ç”¨äºå¤„ç†RV32Iä¸­è¾ƒçª„å¯„å­˜å™¨çš„æŒ‡ä»¤å’ŒCSRã€‚  RV32Ié€‰é¡¹å¯ä»¥ä½¿ç”¨ç¼–ç ç©ºé—´ï¼Œå¦åˆ™ä»…ä¿ç•™ç»™æ›´å®½çš„åœ°å€ç©ºé—´å˜ä½“æ‰€éœ€çš„æŒ‡ä»¤ä½¿ç”¨ã€‚ </blockquote><p> æˆ‘è¿˜æƒ³æŒ‡å‡ºçš„æ˜¯ï¼Œå¦‚æœæ­£ç¡®é€‰æ‹©äº†ç›®æ ‡ä½“ç³»ç»“æ„ï¼Œåˆ™å¸¦æœ‰<code>riscv64-</code>å‰ç¼€çš„å·¥å…·é“¾å¾ˆå¯èƒ½ä¼šè½»æ¾æ”¶é›†32ä½ä»£ç -ç¨åä¼šå¯¹æ­¤è¿›è¡Œæ›´å¤šä»‹ç»ã€‚ </p><br><p> ç§»æ¤æ—¶ï¼Œå°†è¿™äº›æ–‡ä»¶æ”¾åœ¨æ‰‹è¾¹å¾ˆæœ‰æ„ä¹‰ï¼š </p><br><ul><li>  <a href="https://riscv.org/specifications/" rel="nofollow">RISC-VæŒ‡ä»¤é›†æ‰‹å†Œç¬¬ä¸€å·ï¼šæ— ç‰¹æƒçš„ISA</a> </li><li>  <a href="https://riscv.org/specifications/privileged-isa/" rel="nofollow">RISC-VæŒ‡ä»¤é›†æ‰‹å†Œç¬¬äºŒå·ï¼šç‰¹æƒæ¶æ„</a> </li><li> å¦å¤–ï¼ŒæŸäº›<a href="https://sifive.cdn.prismic.io/sifive%252F834354f0-08e6-423c-bf1f-0cb58ef14061_fu540-c000-v1.0.pdf" rel="nofollow">SiFive FU540-C000æ‰‹å†Œ</a> -è¯¥èŠ¯ç‰‡æ‰‹å†Œï¼Œå…¶è¡Œä¸ºç±»ä¼¼äºè½¯ä»¶å¤„ç†å™¨ï¼Œç”¨äºFPGAè°ƒè¯•ï¼Œå…¶è¡Œä¸ºä¸ä¼šæ”¹å˜ã€‚ </li></ul><br><h2 id="nastroyka-sborki"> æ„å»ºè®¾ç½® </h2><br><p> è®©æˆ‘ä»¬ä»è¾¾æˆä¸€è‡´å¼€å§‹ï¼šæˆ‘æƒ³è·å¾—ä¸€ä¸ªé€‚åˆè¿›ä¸€æ­¥ç§»æ¤åˆ°x86å’ŒRISC-Vä»¥å¤–çš„ä½“ç³»ç»“æ„çš„ç«¯å£ã€‚ æˆ‘è¿˜å»ºè®®å°†å¼•å¯¼è½¯ç›˜å’Œå…¶ä»–x86ç»†èŠ‚æ’é™¤åœ¨è·¨å¹³å°æ„å»ºä¹‹å¤–ã€‚ </p><br><p> æˆ‘ä»¬æœ€ç»ˆæ‹¥æœ‰çš„æ˜¯ï¼šä¸‰ä¸ªæ±‡ç¼–å™¨æ–‡ä»¶ï¼š <code>bootsect.S</code> ï¼Œ <code>setup.S</code>å’Œ<code>head.S</code> ä»…åœ¨å¯åŠ¨æ—¶æ‰éœ€è¦å‰ä¸¤ä¸ªï¼Œè€Œç¨ååœ¨é‡å®šä½åˆ°å¦ä¸€ä¸ªå­˜å‚¨åŒºåŸŸæ—¶åˆ™éœ€è¦ç¬¬ä¸‰ä¸ªã€‚ äº‹å®æ˜¯ï¼Œä¸ºäº†â€œè‡ªå·±â€æµ‹è¯•å†…å­˜ï¼Œæµ‹è¯•ä»£ç å¿…é¡»é¦–å…ˆç§»è‡³æ–°ä½ç½®ã€‚  Sichæ–‡ä»¶åœ¨ELFä¸­æ”¶é›†ï¼Œç„¶åä»ä¸­è·å–ä»£ç ï¼Œæ•°æ®ç­‰éƒ¨åˆ†ã€‚ æ­¤å¤–ï¼Œå®ƒä»¥PICï¼ˆä½ç½®ç‹¬ç«‹ä»£ç ï¼‰çš„å½¢å¼æ”¶é›†-èµ·åˆï¼Œæˆ‘ä»€è‡³æ„Ÿåˆ°æƒŠè®¶ï¼šå°½ç®¡ä»£ç æ˜¯ç‹¬ç«‹çš„ï¼ˆå³ï¼Œæ²¡æœ‰å†…æ ¸ï¼Œlibcç­‰ï¼‰ï¼Œä½†å®ƒä½¿ç”¨äº†æ­¤ç±»é«˜çº§åŠŸèƒ½ã€‚ </p><br><p> æ­¤å¤–ï¼Œåœ¨Makefileä¸­ä¼šå®šæœŸé‡åˆ°å®šä¹‰ä½“ç³»ç»“æ„çš„å‚æ•°ï¼š <code>-march=i486</code>å’Œ<code>-m32</code>ç­‰ã€‚ æˆ‘éœ€è¦å†™è¿™æ ·çš„ä¸œè¥¿ <del> ç„¶ååƒä¸€ä¸ªå¸ç›˜ </del>  ã€‚ ä»ä½“ç³»ç»“æ„çš„è§’åº¦æ¥çœ‹ï¼ŒRISC-Vçš„æƒ…å†µæ˜¯è¿™æ ·çš„ï¼š <code>rv32</code>å’Œ<code>rv64</code>æœ‰å¾ˆå¤šé€‰é¡¹ï¼ˆä¾‹å¦‚ï¼Œå¯¹äºå°†æ¥çš„<code>rv128</code> ï¼Œä»ç„¶æœ‰æˆªæ–­çš„åµŒå…¥å¼å’Œä¿ç•™ï¼Œä½†æˆ‘ä»¬å¯¹å®ƒä»¬ä¸æ˜¯å¾ˆæ„Ÿå…´è¶£ï¼‰ï¼Œè€ŒISAåç§°æ˜¯é€šè¿‡ä¸ºè¯¥å‰ç¼€åˆ†é…å­—æ¯è€Œå½¢æˆçš„æ‰©å±•ï¼š <code>i</code>åŸºæœ¬çš„æ•´æ•°æŒ‡ä»¤é›†ï¼Œ <code>m</code>æ•´æ•°ä¹˜æ³•å’Œé™¤æ³•ï¼Œ...å½“ç„¶ï¼Œæˆ‘æƒ³åš<code>rv64i</code> ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰ä¹˜æ³•ï¼ŒMemtest86å¾ˆéš¾ç§»æ¤åˆ°ä½“ç³»ç»“æ„ä¸Šã€‚ æ²¡é”™ï¼Œä¼¼ä¹ç¼–è¯‘å™¨å°†åªç”Ÿæˆå‡½æ•°è°ƒç”¨è€Œä¸æ˜¯â€œæœ‰é—®é¢˜çš„â€æŒ‡ä»¤ï¼Œä½†æ˜¯å­˜åœ¨æå¤§é™ä½æ€§èƒ½çš„é£é™©ï¼ˆæ›´ä¸ç”¨è¯´è¿™äº›å‡½æ•°å°†éœ€è¦åœ¨æŸä¸ªåœ°æ–¹ç¼–å†™æˆ–ä½¿ç”¨ï¼‰ã€‚ </p><br><p> æ‚¨è¿˜å°†éœ€è¦ABIè¡Œã€‚ åŸåˆ™ä¸Šï¼Œè°ƒç”¨çº¦å®šçš„åŸºç¡€å·²ç»åœ¨â€œ RISC-Væ±‡ç¼–ç¨‹åºå‘˜æ‰‹å†Œâ€ä¸­æŒ‡å®šçš„<code>Volume I</code>è¿›è¡Œäº†ä»‹ç»ï¼Œå› æ­¤æˆ‘å°†åšç±»ä¼¼ </p><br><pre> <code class="plaintext hljs">$ riscv64-linux-gnu-gcc-9 -mabi=help riscv64-linux-gnu-gcc-9: error: unrecognized argument in option '-mabi=help' riscv64-linux-gnu-gcc-9: note: valid arguments to '-mabi=' are: ilp32 ilp32d ilp32e ilp32f lp64 lp64d lp64f riscv64-linux-gnu-gcc-9: fatal error: no input files compilation terminated.</code> </pre> <br><p>  <code>lp64</code>è€ƒè™‘ï¼Œæˆ‘å°±<code>lp64</code> ã€‚  <em>å±•æœ›æœªæ¥ï¼Œæˆ‘è¦è¯´çš„æ˜¯ï¼Œä½¿ç”¨æ­¤ABIï¼Œæ ‡å‡†åº“ä¸­çš„å¤´æ–‡ä»¶ä¸èµ·ä½œç”¨ï¼Œå› æ­¤æˆ‘é€‰æ‹©äº†<code>lp64f</code> ï¼Œå¹¶å°†ARCHâ€œå‡çº§â€ä¸º<code>rv64imf</code> ã€‚</em>  <em>æ²¡æœ‰ææ…Œï¼Œæˆ‘ä¸æ‰“ç®—åœ¨ç«¯å£ä¸­çœŸæ­£ä½¿ç”¨æµ®ç‚¹ã€‚</em> </p><br><p> ç”±äºæˆ‘æŸç§ç¨‹åº¦ä¸Šä¸æƒ³é’»ç ”è·¨å¹³å°çš„é“¾æ¥æè¿°æ–‡ä»¶-å› æ­¤æˆ‘æ— æ³•ç«‹å³<em>æ‰¾åˆ°ldçš„é”®</em> ï¼Œå› æ­¤æˆ‘å†³å®šä½¿ç”¨ä¸€ä¸ªæ±‡ç¼–å™¨<code>head.S</code>æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨<code>memtest_shared.arch.lds</code>å…¶ä½™åŠŸèƒ½ã€‚ æˆ‘ä»ä¸­ç»™å‡ºäº†è¾“å‡ºæ ¼å¼å’Œä½“ç³»ç»“æ„çš„æŒ‡ç¤ºï¼ˆæ¯•ç«Ÿï¼Œä»Makefileä¸­çš„å˜é‡æ›´æ”¹è¾“å‡ºæ›´å®¹æ˜“ï¼‰ï¼Œå¹¶åœ¨æœ€åä¸´æ—¶æ³¨é‡Šæ‰<code>DISCARD</code> ï¼Œæ— æ³•å¼„æ¸…æˆ‘éœ€è¦å“ªäº›ç‰¹å®šçš„è°ƒè¯•ä¿¡æ¯éƒ¨åˆ†ã€‚  <em>ï¼ˆå±•æœ›ï¼šè‰¯å¥½çš„è°ƒè¯•ä¿¡æ¯ï¼Œä½†å¿…é¡»æ·»åŠ <code>.rela</code> ï¼‰</em>ä¸€èˆ¬æ¥è¯´ï¼Œx86ç‰ˆæœ¬å¼ºè°ƒäº†å¿…é¡»é€‚åˆ64kçš„èƒ½åŠ›-æˆ‘å¸Œæœ›è¿™ä¸å®æ¨¡å¼çš„åŠŸèƒ½ç›¸å…³ï¼Œå¹¶ä¸”åœ¨RISC-Vä¸Šä¸æˆ‘ä»¬æ— å…³ã€‚ ç»“æœï¼Œå°†æ”¶é›†ä¸PICå…±äº«çš„å¯¹è±¡ï¼Œå°±åƒåœ¨åŸå§‹å¯¹è±¡ä¸­ä¸€æ ·ï¼Œå°†è¦åŠ è½½åˆ°å†…å­˜ä¸­çš„ä»£ç å’Œæ•°æ®ä¹Ÿè¢«å’¬æ‰ã€‚ </p><br><p> æˆ‘ä»¬æ”¶é›†...ï¼Œå¹¶ä¸”ç¼–è¯‘ä½äºç¬¬ä¸€ä¸ª<code>reloc.c</code>æ–‡ä»¶ä¸Š-æ˜¾ç„¶ï¼Œå®ƒæ˜¯ä»<code>ld-linux.so</code>æå–çš„ï¼Œå¹¶è´Ÿè´£æ”¯æŒGlobal Offset Tableç­‰ã€‚ æ ¹æ®x86çš„è°ƒç”¨çº¦å®šã€‚ äº‹å®è¯æ˜ï¼Œå®ƒéœ€è¦ä½¿ç”¨æ±‡ç¼–ç¨‹åºæ’å…¥ç›´æ¥å¤„ç†å¯„å­˜å™¨ã€‚ ä½†æ˜¯æˆ‘ä»¬åœ¨RISC-Vä¸Š-å®ƒæœ€åˆæ˜¯ä¸ºæœ¬åœ°æ”¯æŒPICåˆ¶ä½œçš„ï¼Œå› æ­¤è¯·éšæ„æŠ›å‡º<code>reloc.c</code> ã€‚ æ­¤å¤–ï¼Œä»ç„¶æœ‰æ’å…¥ç‰©ï¼Œæœ‰æ—¶å¾ˆé•¿ã€‚ å¹¸è¿çš„æ˜¯ï¼Œå®ƒä»¬è¦ä¹ˆåœ¨è¢«æ³¨é‡Šæ‰çš„Cä»£ç ä¹‹åç«‹å³è¿›å…¥æµ‹è¯•ä»£ç ï¼Œç„¶åå¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼ˆæˆ‘ä»ä¸­å†æ¬¡ç¼–å†™äº†ç”±preprocessoræŒ‡ä»¤åˆ‡æ¢çš„å®Œæ•´ä»£ç ï¼‰ï¼Œè¦ä¹ˆä¾èµ–äºå¹³å°ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰è¿™äº›ä»£ç ï¼Œæ‚¨å¯ä»¥ï¼ˆå¯èƒ½ï¼‰åšï¼ˆä¾‹å¦‚æ‰“å¼€/å…³é—­ç¼“å­˜ï¼Œå‡å»CPUIDç­‰ï¼‰ã€‚ æœ€åï¼Œè¿˜æœ‰ä¸€äº›ç±»ä¼¼<code>rdtsc</code>è°ƒç”¨ï¼Œæˆ‘<code>rdtsc</code>æ²¡æœ‰å°†ä»»ä½•å¤§é—®é¢˜æ”¾å…¥ä¸å¹³å°ç›¸å…³çš„æ ‡å¤´ä¸­ï¼Œå¹¶æ ¹æ®RISC-Vçš„æ–‡æ¡£è¿›è¡Œäº†å®ç°ã€‚ </p><br><p> ç»“æœï¼Œæˆ‘ä»¬è·å¾—äº†<code>arch/i386</code>ç›®å½•ï¼Œå…¶ä¸­ç§»åŠ¨äº†å¤§é‡çš„PCIæ”¯æŒä»£ç ï¼Œä»èŠ¯ç‰‡ç»„è¯»å–ä¿¡æ¯ï¼Œç‰¹å®šäºå¹³å°çš„å†…å­˜æ˜ å°„åœ°å€å®šä¹‰ç­‰ã€‚ åŒæ ·ï¼Œ <code>test_start</code>å‡½æ•°çš„å¼€å¤´<code>test_start</code> ï¼Œå®ƒæ˜¯<code>setup.S</code>åˆ°Cä»£ç çš„å…¥å£ã€‚å¤šé•¿æ—¶é—´ï¼ŒçŸ­ï¼Œä½†æ˜¯æ³¨é‡Šæ‰æ‰€æœ‰å¯èƒ½çš„ä¸œè¥¿ï¼Œå¹¶å®ç°åœ¨RISC-Vä¸‹ä¸èƒ½æ³¨é‡Šæ‰çš„æ‰€æœ‰ä¸œè¥¿ï¼ˆä¾‹å¦‚<code>setup.S</code>å’Œç”¨äºå·¥ä½œçš„ä»£ç ï¼‰ SiFiveå®ç°ä¸­çš„ä¸²è¡Œç«¯å£ï¼‰ï¼Œæˆ‘å¾—åˆ°äº†<code>arch/riscv</code> ï¼Œä½¿ç”¨è¯¥<code>arch/riscv</code>æˆ–å¤šæˆ–å°‘åœ°è¿›è¡Œäº†æ‰€æœ‰ç¼–è¯‘ã€‚ </p><br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä¸å¾—ä¸æ¾„æ¸…ä¸€ä¸‹ï¼Œå®éªŒæœ¬èº«æ˜¯åœ¨æ’°å†™æœ¬æ–‡ä¹‹å‰éƒ¨åˆ†è¿›è¡Œçš„ï¼Œå› æ­¤ç‰¹å®š<em>çš„</em>åŠ¨ä½œ<em>åºåˆ—</em>å¯èƒ½åŒ…å«ä¸€å®šé‡çš„â€œè‰ºæœ¯å°è¯´â€ã€‚ ä½†æ˜¯ï¼Œæˆ‘è‡³å°‘å°è¯•ä»¥æŸç§æ–¹å¼è¿›è¡Œæ¼”ç¤ºï¼Œä½¿å…¶åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä»£è¡¨ä¸€ç§å¯èƒ½çš„æ–¹å¼<em>ï¼ˆæˆ‘æ˜¯ç¨‹åºå‘˜ï¼Œæˆ‘è®°å¾—é‚£ï¼‰</em> ã€‚ å› æ­¤ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å¼€å§‹ä¸€åˆ‡ã€‚ </p><br><h2 id="zapusk-na-zheleze"> åœ¨é“ä¸Šè¿è¡Œ </h2><br><p> ä»è¿‡å»çš„å®éªŒå¼€å§‹ï¼Œæˆ‘ä»ç„¶åœ¨Raspberry Piä¸Šæœ‰ä¸€ä¸ªå°˜åœŸé£æ‰¬çš„â€œæ¶å­â€ï¼Œå¹¶è¿æ¥åˆ°è°ƒè¯•æ¿ä¸Šã€‚ ç”µçº¿æä¾›UARTï¼ŒJTAGå’Œå¸¦æœ‰SDå¡çš„é€‚é…å™¨ã€‚ å°†å¸¦æœ‰DDR2æ§åˆ¶å™¨çš„RV64å¤„ç†å™¨ç¼å…¥é…ç½®å­˜å‚¨å™¨ã€‚ å’Œä»¥å‰ä¸€æ ·ï¼Œæˆ‘æ‰“å¼€â€œæ ‘è“â€ï¼Œåœ¨å®ƒä¹‹å‰æ‰“å¼€ä¸¤ä¸ªSSHä¼šè¯ï¼Œå…¶ä¸­ä¸€ä¸ªè½¬å‘3333 TCPç«¯å£ï¼Œç”¨äºå°†gdbè¿æ¥åˆ°OpenOCDã€‚ åœ¨ä¸€ä¸ªä¼šè¯ä¸­ï¼Œæˆ‘å¯åŠ¨minicomæ¥ç›‘è§†UARTï¼Œåœ¨å¦ä¸€ä¸ªä¼šè¯ä¸­ï¼Œæˆ‘å¯åŠ¨opencomdæ¥é€šè¿‡JTAGä»ä¸»æœºè¿›è¡Œè°ƒè¯•ã€‚ æˆ‘æ‰“å¼€äº†æ¿å­çš„ç”µæº-æ§åˆ¶å°ä¸­å‡ºç°äº†æœ‰å…³å¦‚ä½•ä»SDåŠ è½½æ•°æ®çš„æ¶ˆæ¯ã€‚ </p><br><p> ç°åœ¨ï¼Œæ‚¨å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š </p><br><pre> <code class="plaintext hljs">riscv64-unknown-elf-gdb \ -ex 'target remote 127.0.0.1:3333' \ -ex 'restore /path/to/memtest_shared.bin binary 0x80010000' \ -ex 'add-symbol-file /path/to/memtest_shared 0x80010000' -ex 'set $pc=0x80010000'</code> </pre> <br><p>  <code>-ex</code>é€‰é¡¹<code>-ex</code> gdbå‡è£…ç”¨æˆ·å·²ä»æ§åˆ¶å°è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š </p><br><ul><li> ç¬¬ä¸€ä¸ªä¸OpenOCDå»ºç«‹è¿æ¥ </li><li> ç¬¬äºŒä¸ªå°†æŒ‡å®šä¸»æœºæ–‡ä»¶çš„å†…å®¹å¤åˆ¶åˆ°æŒ‡å®šåœ°å€ </li><li> ç¬¬ä¸‰éƒ¨åˆ†å‘gdbè§£é‡Šè¯´ï¼Œå¿…é¡»ä»<em>è¯¥</em>æ–‡ä»¶ä¸­è·å–æœ‰å…³æºä»£ç çš„ä¿¡æ¯ï¼Œå¹¶è€ƒè™‘åˆ°å®ƒæ˜¯ä»<em>è¯¥</em>åœ°å€ä¸‹è½½çš„ï¼ˆè€Œä¸æ˜¯å…¶æœ¬èº«æŒ‡ç¤ºçš„å†…å®¹ï¼‰ <br><ul><li> æ³¨æ„ï¼šæˆ‘ä»¬ä»ELFæ–‡ä»¶ä¸­æå–å­—ç¬¦ï¼Œå¹¶åŠ è½½â€œåŸå§‹â€äºŒè¿›åˆ¶æ–‡ä»¶ </li></ul></li><li> æœ€åï¼Œç¬¬å››ä¸ªå°†å½“å‰å‘½ä»¤æŒ‡é’ˆå¼ºåˆ¶è½¬æ¢ä¸ºæˆ‘ä»¬çš„ä»£ç  </li></ul><br><p> ä¸å¹¸çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„äº‹æƒ…éƒ½èƒ½é¡ºåˆ©è¿›è¡Œï¼Œå°½ç®¡è°ƒè¯•å™¨ä¸­çš„ä»£ç è¡Œæ˜¾ç¤ºæ­£ç¡®ï¼Œä½†æ˜¯åœ¨æ‰€æœ‰å…¨å±€å˜é‡ä¸­å‡æ˜¾ç¤ºä¸ºé›¶ã€‚ å®é™…ä¸Šï¼Œå¦‚æœåœ¨gdbä¸­æ‰§è¡Œå½¢å¼ä¸º<code>p &amp;global_var</code>çš„å‘½ä»¤ï¼Œå¯æƒœæˆ‘ä»¬çœ‹åˆ°çš„åœ°å€ä¸åˆå§‹ä¸‹è½½åœ°å€ï¼ˆæˆ‘æœ‰<code>0x0</code> ï¼‰ä¸€è‡´ï¼Œè€Œè¯¥åœ°å€æœªä½¿ç”¨<code>add-symbol-file</code>æŒ‡å®šã€‚ ä½œä¸ºæ‹æ–ï¼Œä½†éå¸¸ç®€å•çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘åªæ˜¯æ‰‹åŠ¨å°†<code>0x80010000</code>æ·»åŠ åˆ°æŒ‡å®šçš„åœ°å€ï¼Œå¹¶é€šè¿‡<code>x/x 0xADDR</code>å†…å­˜çš„å†…å®¹ã€‚ å®é™…ä¸Šï¼Œæœ‰å¯èƒ½åœ¨é“¾æ¥æè¿°æ–‡ä»¶ä¸­ä¸´æ—¶æŒ‡ç¤ºæ­£ç¡®çš„èµ·å§‹åœ°å€ï¼Œ <em>æ­¤åˆ»</em> <em>æ­¤</em>åœ°å€å°†ä¸<em>æ­¤æµ‹è¯•é…ç½®ä¸­</em>çš„ä¸‹è½½åœ°å€ä¸€è‡´ã€‚ </p><br><h2 id="osobennosti-relokacii-na-sovremennyh-arhitekturah"> ç°ä»£å»ºç­‘æ¬è¿çš„ç‰¹å¾ </h2><br><p> å¥½äº†ï¼Œå¦‚ä½•ä»¥æŸç§æ–¹å¼æ‰¾åˆ°æˆ‘ä»¬ä¸‹è½½çš„ä»£ç -æˆ‘ä»¬å¼€å§‹äº†ã€‚ ä¸èµ·ä½œç”¨ã€‚ é€æ­¥è°ƒè¯•è¡¨æ˜ï¼Œæˆ‘ä»¬é™·å…¥äº†<code>switch_to_main_stack</code>å‡½æ•°çš„è¿è¡Œè¿‡ç¨‹ä¸­-ä¼¼ä¹å®ƒä»åœ¨å°è¯•ä½¿ç”¨ä¸å·¥ä½œå †æ ˆç›¸å¯¹åº”çš„ç¬¦å·åœ°å€çš„ä¸ç›¸å…³å€¼ã€‚ </p><br><p> ä¸€æ ·ï¼Œç¬¬ä¸€å·æ–‡æ¡£å‘Šè¯‰æˆ‘ä»¬ä¸åŒçš„ä¼ªæŒ‡ä»¤ä»¥åŠå®ƒä»¬ä¸PICä¸€èµ·ä½¿ç”¨å’Œå…³é—­çš„å·¥ä½œï¼š </p><br><p><img src="https://habrastorage.org/webt/vj/7-/_u/vj7-_uqmqyqjloo1webrgpqsdc8.png" alt="æŸäº›RISC-Vä¼ªæŒ‡ä»¤"></p><br><p> å¦‚æ‚¨æ‰€è§ï¼Œä¸€èˆ¬çš„åŸç†æ˜¯ä»å½“å‰æŒ‡ä»¤å¼€å§‹è®¡ç®—å­˜å‚¨å™¨ä¸­çš„åœ°å€ï¼Œç¬¬ä¸€ä¸ªåŠ ä¸Šåç§»é‡çš„é¡¶éƒ¨ï¼Œç¬¬äºŒä¸ªåˆ™<code>add</code>ä½ä½ã€‚ å£°æ˜è¿™æ ·çš„å…¨å±€å˜é‡å‡ ä¹æ— æµäºäº‹ </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vars</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">variables</span></span></span><span class="hljs-class">;</span></span></code> </pre> <br><p> å› æ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨RISC-V ELF psABIæ–‡æ¡£<a href="" rel="nofollow">ä»¥åŠé‡å®šä½ç±»å‹çš„æè¿°ï¼Œ</a>å¹¶ä¸º<code>reloc.c</code>ç¼–å†™äº†ç‰¹å®šäºå¹³å°çš„éƒ¨åˆ†ã€‚ è¿™é‡Œåº”è¯¥æ³¨æ„çš„æ˜¯ï¼ŒåŸå§‹æ–‡ä»¶æ˜¾ç„¶æ˜¯æ¥è‡ªè·¨å¹³å°ä»£ç çš„ã€‚ åœ¨é‚£é‡Œï¼Œå³ä½¿æœªæŒ‡å®šç‰¹å®šçš„ä½æ·±åº¦ï¼Œ <code>ElfW(Addr)</code>å®ï¼Œ <code>Elf32_Addr</code>ä¸º<code>Elf32_Addr</code>æˆ–<code>Elf64_Addr</code> ã€‚ ä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯åˆ°å¤„éƒ½å­˜åœ¨ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å°†å®ƒä»¬æ·»åŠ åˆ°é€šç”¨ä»£ç ï¼ˆä»¥åŠ<a href="" rel="nofollow"><code>arch/riscv/reloc.inc.c</code></a>ä¸­ä¸å­˜åœ¨çš„åœ°æ–¹çš„åŸå› -æ¯•ç«Ÿï¼Œå¯¹äºRISC-Vï¼Œæ²¡æœ‰ç‰¹æ®Šæ„ä¹‰è¦ç»‘å®šåˆ°ç‰¹å®šçš„ä½æ·±åº¦ï¼Œè€Œä¸æ˜¯ç‰¹å®šçš„ä½æ·±åº¦å¿…å¡«ï¼‰ã€‚ </p><br><p> ç»“æœï¼Œ <code>switch_to_main_stack</code>å¼€å§‹é€šè¿‡ï¼ˆå½“ç„¶ä¸æ˜¯æ²¡æœ‰å¹³å°ç›¸å…³çš„æ±‡ç¼–å™¨æŒ‡ä»¤ï¼‰ã€‚ è°ƒè¯•å™¨æ˜¾ç¤ºå…¨å±€å˜é‡ä»ç„¶ä¸æ­£ç¡®ã€‚ å¥½å§ï¼Œå¥½çš„:( </p><br><h2 id="opredelenie-oborudovaniya"> ç¡¬ä»¶å®šä¹‰ </h2><br><p> å½“ç„¶ï¼Œå¯¹äºæµ‹è¯•è€Œè¨€ï¼Œå¯ä»¥ä½¿ç”¨ç¡¬ç¼–ç çš„å¸¸é‡æ¥ä»£æ›¿æŠ›å‡ºçš„è®¾å¤‡å®šä¹‰ä»£ç ï¼Œä½†æ˜¯å¯¹äºæ¯ä¸ªç‰¹å®šçš„å¤„ç†å™¨ç»„ä»¶ï¼ŒæŒ‰ç…§æˆ‘çš„åº”ç”¨ç¨‹åºçš„æ ‡å‡†æ¥é‡å»ºmemtestçš„æˆæœ¬ç”šè‡³å¤ªé«˜ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å°†â€œä½œä¸ºä¸¥è‚ƒçš„æˆå¹´äººâ€è¡Œäº‹ã€‚ å¹¸è¿çš„æ˜¯ï¼Œåœ¨RISC-Vä¸Šï¼ˆå¯èƒ½åœ¨å¤§å¤šæ•°ç°ä»£ä½“ç³»ç»“æ„ä¸Šï¼‰ï¼Œå¼•å¯¼åŠ è½½ç¨‹åºä¹ æƒ¯å°†ä»£ç ä¼ é€’ç»™<a href="https://en.wikipedia.org/wiki/Device_tree" rel="nofollow">Device Tree Blob</a> ï¼Œå®ƒæ˜¯DTSæè¿°çš„ç¼–è¯‘ç‰ˆæœ¬ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><div class="spoiler">  <b class="spoiler_title">zeowaa-1gb.dts</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/dts-v1/; / { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt gt^_^; compatible = "freechips,rocketchip-unknown-dev"; model = "freechips,rocketchip-unknown"; chosen { bootargs = "console=ttySIF0,125200 debug loglevel=7"; }; firmware { sifive,uboot = "YYYY-MM-DD"; }; L16: aliases { serial0 = &amp;L8; }; L15: cpus { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt&amp;#0;gt^_^; timebase-frequency = ^_^ltó´‰€gt^_^; L5: cpu@0 { device_type = "cpu"; clock-frequency = ^_^lt&amp;#0;gt^_^; compatible = "sifive,rocket0", "riscv"; d-cache-block-size = ^_^lt gt^_^; d-cache-sets = ^_^lt@gt^_^; d-cache-size = ^_^ltá€€gt^_^; d-tlb-sets = ^_^lt gt^_^; d-tlb-size = ^_^lt gt^_^; i-cache-block-size = ^_^lt gt^_^; i-cache-sets = ^_^lt@gt^_^; i-cache-size = ^_^ltá€€gt^_^; i-tlb-sets = ^_^lt gt^_^; i-tlb-size = ^_^lt gt^_^; mmu-type = "riscv,sv39"; next-level-cache = &lt;&amp;L10&gt;; reg = &lt;0x0&gt;; riscv,isa = "rv64imafdc"; status = "okay"; timebase-frequency = ^_^ltó´‰€gt^_^; tlb-split; L3: interrupt-controller { #interrupt-cells = ^_^lt gt^_^; compatible = "riscv,cpu-intc"; interrupt-controller; }; }; }; L10: ram@80000000 { device_type = "memory"; reg = &lt;0x0 0x80000000 0x0 0x40000000&gt;; reg-names = "mem"; }; L14: soc { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt gt^_^; compatible = "freechips,rocketchip-unknown-soc", "simple-bus"; ranges; L1: clint@2000000 { compatible = "riscv,clint0"; interrupts-extended = &lt;&amp;L3 3 &amp;L3 7&gt;; reg = &lt;0x2000000 0x10000&gt;; reg-names = "control"; }; L2: debug-controller@0 { compatible = "sifive,debug-013", "riscv,debug-013"; interrupts-extended = &lt;&amp;L3 65535&gt;; reg = &lt;0x0 0x1000&gt;; reg-names = "control"; }; L9: gpio@64002000 { #gpio-cells = ^_^lt gt^_^; #interrupt-cells = ^_^lt gt^_^; compatible = "sifive,gpio0"; gpio-controller; interrupt-controller; interrupt-parent = &lt;&amp;L0&gt;; interrupts = &lt;3 4 5 6 7 8&gt;; reg = &lt;0x64002000 0x1000&gt;; reg-names = "control"; }; L0: interrupt-controller@c000000 { #interrupt-cells = ^_^lt gt^_^; compatible = "riscv,plic0"; interrupt-controller; interrupts-extended = &lt;&amp;L3 11 &amp;L3 9&gt;; reg = &lt;0xc000000 0x4000000&gt;; reg-names = "control"; riscv,max-priority = ^_^lt gt^_^; riscv,ndev = ^_^lt gt^_^; }; L6: rom@10000 { compatible = "sifive,maskrom0"; reg = &lt;0x10000 0x2000&gt;; reg-names = "mem"; }; L8: serial@64000000 { compatible = "sifive,uart0"; interrupt-parent = &lt;&amp;L0&gt;; clocks = &lt;&amp;tlclk&gt;; interrupts = ^_^lt gt^_^; reg = &lt;0x64000000 0x1000&gt;; reg-names = "control"; }; L7: spi@64001000 { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt&amp;#0;gt^_^; compatible = "sifive,spi0"; interrupt-parent = &lt;&amp;L0&gt;; interrupts = ^_^lt gt^_^; reg = &lt;0x64001000 0x1000&gt;; clocks = &lt;&amp;tlclk&gt;; reg-names = "control"; L12: mmc@0 { compatible = "mmc-spi-slot"; disable-wp; reg = &lt;0x0&gt;; spi-max-frequency = ^_^lt gt^_^; voltage-ranges = &lt;3300 3300&gt;; }; }; tlclk: tlclk { #clock-cells = ^_^lt&amp;#0;gt^_^; clock-frequency = ^_^lt gt^_^; clock-output-names = "tlclk"; compatible = "fixed-clock"; }; }; };</code> </pre> </div></div><br><p> æˆ‘æ›¾ç»è§£æELFæ–‡ä»¶ï¼Œä½†ç°åœ¨æˆ‘å†æ¬¡å¯¹FDTï¼ˆå¹³é¢è®¾å¤‡æ ‘ï¼‰æ·±ä¿¡ä¸ç–‘ï¼šè¿™äº›<a href="https://github.com/devicetree-org/devicetree-specification/releases/download/v0.2/devicetree-specification-v0.2.pdf" rel="nofollow">è§„èŒƒæ˜¯</a>ç”±<em>æœ‰çˆ±å¿ƒçš„äºº</em>ç¼–å†™çš„ <del>  ï¼ˆä»ç„¶ï¼Œä»–ä»¬è‡ªå·±ç„¶åè§£æå®ƒï¼ï¼‰ </del> è§£ææ­¤ç±»æ–‡ä»¶ï¼ˆè‡³å°‘ç›´åˆ°æ‚¨éœ€è¦å¤„ç†ä¸å—ä¿¡ä»»çš„è¾“å…¥ä¸ºæ­¢ï¼‰ä¸ä¼šé€ æˆä»»ä½•ç‰¹æ®Šé—®é¢˜ã€‚ æ‰€ä»¥åœ¨è¿™é‡Œï¼šåœ¨æ–‡ä»¶çš„å¼€å¤´ï¼Œæœ‰ä¸€ä¸ªç®€å•çš„å¤´ç»“æ„ï¼Œå…¶ä¸­åŒ…å«é­”æœ¯æ•°å­—<code>0xd00dfeed</code>å’Œæ›´å¤šå­—æ®µã€‚ æˆ‘ä»¬å¯¹â€œæ‰å¹³æ ‘â€ <code>off_dt_struct</code>å’Œè¡Œè¡¨<code>off_dt_strings</code>çš„åç§»é‡æ„Ÿå…´è¶£ã€‚ å®é™…ä¸Šï¼Œæ‚¨è¿˜éœ€è¦å¤„ç†<code>off_mem_rsvmap</code> ï¼Œå®ƒæšä¸¾äº†æœ€å¥½é¿å…ä½¿ç”¨çš„å†…å­˜åŒºåŸŸã€‚ æˆ‘ä»ç„¶ä¸ç†ï¼ˆå®ƒä»¬ï¼ˆå®ƒä»¬ä¸åœ¨æˆ‘çš„æœ¨æ¿ä¸Šï¼‰ï¼Œä½†æ˜¯<strong>ä¸è¦åœ¨å®¶ä¸­é‡å¤</strong> ã€‚ </p><br><p> åŸåˆ™ä¸Šï¼Œå¤„ç†å¹¶ä¸æ˜¯ç‰¹åˆ«å›°éš¾ï¼šæ‚¨åªéœ€è¦æ ¹æ®ä»¤ç‰Œåœ¨å¹³æ•´çš„æ ‘ä¸Šè¡Œèµ°å³å¯ã€‚  <em>æœ‰</em>ä¸‰ä¸ª<em>ä¸»è¦</em>æ ‡è®°ï¼š </p><br><ul><li>  <code>FDT_BEGIN_NODE</code>åœ¨ç´§éšå…¶åçš„é¢å¤–æ•°æ®ä¸­ï¼Œä»¥ç©ºç»ˆæ­¢å­—ç¬¦ä¸²çš„å½¢å¼å‡ºç°å­æ ‘å…ƒç´ çš„åç§°ã€‚ åªéœ€å°†åç§°æ·»åŠ åˆ°å †æ ˆä¸­ </li><li>  <code>FDT_END_NODE</code>å­æ ‘ç»“æŸï¼Œä»å †æ ˆä¸­åˆ é™¤å…ƒç´  </li><li>  <code>FDT_PROP</code>è¿™æœ‰ç‚¹æ£˜æ‰‹ï¼šå®ƒåé¢æ˜¯ä¸€ä¸ªç»“æ„ï¼Œç„¶åæ˜¯lenä¸ªå­—èŠ‚çš„é¢å¤–æ•°æ®ã€‚  â€œå˜é‡â€çš„åç§°ä½äºå­—ç¬¦ä¸²è¡¨ä¸­çš„åç§»<code>nameoff</code> <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> len; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> nameoff; }</code> </pre> </li></ul><br><p> å¥½å§ï¼Œæ€»çš„æ¥è¯´ï¼Œå°±æ˜¯è¿™æ ·ï¼šæˆ‘ä»¬ä»”ç»†é˜…è¯»æœ¬èŠ‚ï¼Œä¸è¦å¿˜è®°è§‚å¯Ÿ4ä¸ªå­—èŠ‚çš„å¯¹é½æƒ…å†µã€‚ ç¾ä¸­ä¸è¶³çš„æ˜¯ï¼šFDTä¸­çš„æ•°å­—é‡‡ç”¨å¤§ç«¯æ ¼å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬åšä¸€ä¸ªç®€å•çš„å‡½æ•° </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be32</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">24</span></span>) | (x &gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span>) | ((x &amp; <span class="hljs-number"><span class="hljs-number">0xff0000</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | ((x &amp; <span class="hljs-number"><span class="hljs-number">0xff00</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); }</code> </pre> <br><p> ç»“æœï¼Œåœ¨<code>riscv_entry</code>é¦–å…ˆè¦åšçš„æ˜¯è§£æFDTï¼Œè€Œ<code>head.S</code>è´Ÿè´£å°†æ§åˆ¶æƒè½¬ç§»åˆ°<code>riscv_entry</code>çœ‹èµ·æ¥åƒè¿™æ · </p><br><pre> <code class="plaintext hljs"> .globl startup_32 #  --    ... startup_32: lla sp, boot_stack_top mv s0, a0 # s0, s1 -- callee-saved mv s1, a1 # ...  .bss #   jal _dl_start #      mv a0, s0 mv a1, s1 j riscv_entry</code> </pre> <br><p> åœ¨å¯„å­˜å™¨<code>a0</code>æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªhart idï¼ˆhartç±»ä¼¼äºRISC-Væœ¯è¯­ä¸­çš„ç¡¬ä»¶æµï¼‰-æˆ‘è¿˜æ²¡æœ‰ä½¿ç”¨å®ƒï¼Œæˆ‘å¿…é¡»åœ¨å•çº¿ç¨‹æƒ…å†µä¸‹å¼„æ¸…æ¥šå®ƒã€‚ åœ¨<code>a1</code>å¼•å¯¼åŠ è½½ç¨‹åºä¼šæ”¾ç½®ä¸€ä¸ªæŒ‡å‘FDTçš„æŒ‡é’ˆã€‚ æˆ‘ä»¬å°†å…¶ä¼ é€’ç»™å‡½æ•°<code>void riscv_entry(ulong hartid, uint8_t *fdt_address)</code> ã€‚ </p><br><p> ç°åœ¨ï¼Œéšç€æˆ‘ä»£ç ä¸­FDT parsilkaçš„å‡ºç°ï¼Œç”µè·¯æ¿çš„åŠ è½½é¡ºåºå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><ul><li> æ‰“å¼€ç”µæº </li><li> ç­‰å¾…U-bootæ§åˆ¶å° </li><li> åœ¨å…¶ä¸­è¾“å…¥å‘½ä»¤ä»¥å‡†å¤‡æ­£ç¡®çš„FDTã€‚ å°¤å…¶æ˜¯<code>/chosen/bootargs</code> command <code>/chosen/bootargs</code>å­˜å‚¨å†…æ ¸å‘½ä»¤è¡Œã€‚ æˆ‘ä»FDTå–å¾—çš„æ‰€æœ‰å…¶ä»–ä¿¡æ¯-RAMèŒƒå›´ï¼ŒUARTåœ°å€ï¼Œ...-å¯ä»¥å¹¶ä¸”åº”è¯¥ä¿ç•™åŸæ · <br><pre> <code class="plaintext hljs">run fdtsetup fdt set /chosen bootargs "console=ttyS0 btrace"</code> </pre> </li><li> ä½¿ç”¨<code>fdt addr</code>å‘½ä»¤ï¼ŒæŸ¥æ‰¾FDTä¸‹è½½åœ°å€ï¼ˆå¦‚æœæ‚¨å°šæœªæŸ¥çœ‹ï¼‰ </li></ul><br><p> ä»gdbç«¯æ·»åŠ å‘½ä»¤ </p><br><ul><li> <code>-ex 'set $a1=0xfdtaddr'</code> </li> </ul><br><h2 id="vyvod-informacii-na-ekran"> ä¿¡æ¯è¾“å‡ºåˆ°å±å¹• </h2><br><p> äº‹å®è¯æ˜ï¼Œé™¤äº†æ±‡ç¼–æ’å…¥å¤–ï¼Œè¿˜å­˜åœ¨å·²çŸ¥çš„å†…å­˜åœ°å€ã€‚ ä¾‹å¦‚<code>SCREEN_ADR</code> ï¼ˆ <code>SCREEN_ADR</code>ç±»ä¼¼ï¼Œå¸¦æœ‰ä¸€ä¸ª<code>D</code> ï¼‰ï¼Œå®ƒæŒ‡å‘ä¸å±å¹•ä¸Šæ˜¾ç¤ºçš„å†…å®¹ç›¸å¯¹åº”çš„åŒºåŸŸã€‚ å½“æˆ‘é‡åˆ°æ­¤é—®é¢˜æ—¶ï¼Œæˆ‘åªæ˜¯ç”¨å®½å¤§çš„æ‰‹åŠ¿å°†æ‰€æœ‰å¼•ç”¨å®ƒçš„å†…å®¹æ”¾åœ¨<code>#if HAS_SCREEN</code> ï¼Œç„¶åç›²ç›®è°ƒè¯•äº†å¾ˆé•¿æ—¶é—´ã€‚ æˆ‘ä»¥ä¸ºå·²ç»æœ‰ä¸€æ®µæ—¶é—´æ‰‹åŠ¨å°†å…¶å…¨éƒ¨è½¬å‚¨åˆ°æ§åˆ¶å°äº†ï¼Œä½†æ˜¯åæ¥æˆ‘æ³¨æ„åˆ°ï¼Œç›¸åŒçš„ä»£ç ä»¤äººç—›è‹¦åœ°å°†è®¸å¤šè½¬ä¹‰åºåˆ—è¾“å‡ºåˆ°ä¸²è¡Œç«¯å£ã€‚ äº‹å®è¯æ˜ï¼Œæ‰€æœ‰äº‹æƒ…å·²ç»å†™åœ¨æˆ‘ä»¬é¢å‰ï¼Œæ‚¨åªéœ€è¦æ›´å‡†ç¡®åœ°æ”¾ç½®å®šä¹‰-æ­¤å¤„æ˜¯minicomçª—å£ä¸­ç†Ÿæ‚‰çš„ç•Œé¢ï¼ˆå°½ç®¡æ˜¯é»‘è‰²å’Œç™½è‰²ï¼‰ï¼  ï¼ˆç›®å‰ï¼Œæ ¹æœ¬ä¸ä½¿ç”¨HAS_SCREEN-æˆ‘åªæ˜¯å¯åŠ¨äº†<code>dummy_con</code>æ•°ç»„ä»¥æœ€å°‘æ›´æ”¹åŸå§‹ä»£ç ã€‚ï¼‰ </p><br><h2 id="otladka-na-qemu"> åœ¨QEMUä¸Šè°ƒè¯• </h2><br><p> å› æ­¤ï¼Œæˆ‘èŠ±äº†ä¸€æ®µæ—¶é—´åœ¨ä¸€å—çœŸæ­£çš„æ¿ä¸Šè°ƒè¯•äº†æ‰€æœ‰ä¸œè¥¿-ç”šè‡³ä¸æ˜¯ç›²ç›®çš„ã€‚ ä½†æ˜¯ä¸€åˆ‡éƒ½å‡æ…¢äº†JTAGçš„é€Ÿåº¦-ææ€–ï¼ å¥½å§ï¼Œæœ€åï¼Œæ‰€æœ‰å†…å®¹éƒ½åº”è¯¥åœ¨çœŸå®çš„ç¡¬ä»¶ä¸Šè¿è¡Œï¼Œä½†æ˜¯åœ¨QEMUä¸Šè¿›è¡Œè°ƒè¯•ä¼šå¾ˆå¥½ã€‚ ç»è¿‡ä¸€å®šæ•°é‡çš„å®éªŒï¼Œç»“æœå‘ç°è¿™æ˜¯ä¸€ä¸ªæ‹æ–ï¼Œä½†ä¸ä½¿ç”¨ç”µè·¯æ¿éå¸¸ç›¸ä¼¼ï¼š </p><br><pre> <code class="plaintext hljs">$ qemu-system-riscv64 -M help Supported machines are: none empty machine sifive_e RISC-V Board compatible with SiFive E SDK sifive_u RISC-V Board compatible with SiFive U SDK spike_v1.10 RISC-V Spike Board (Privileged ISA v1.10) (default) spike_v1.9.1 RISC-V Spike Board (Privileged ISA v1.9.1) virt RISC-V VirtIO Board (Privileged ISA v1.10)</code> </pre> <br><p> æˆ‘ä»¬çœ‹ä¸€ä¸‹QEMUå‡†å¤‡æ¨¡æ‹Ÿå“ªäº›æ¿ã€‚ æˆ‘å¯¹<code>sifive_u</code>å…¼å®¹çš„ç¡¬ä»¶æ„Ÿå…´è¶£ã€‚ </p><br><pre> <code class="plaintext hljs">$ qemu-system-riscv64 -M sifive_u,dumpdtb -m 1g # - QEMU      on --  strace   $ ls -l on -rw-rw-r-- 1 trosinenko trosinenko 1923  19 20:14 on $ dtc -I dtb &lt; on &gt; on.dts #   $ vim on.dts #  bootargs $ dtc &lt; on.dts &gt; on.dtb &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 1 is not a phandle reference &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 2 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/interrupt-controller@c000000:interrupts-extended: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/interrupt-controller@c000000:interrupts-extended: cell 2 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/clint@2000000:interrupts-extended: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/clint@2000000:interrupts-extended: cell 2 is not a phandle reference</code> </pre> <br><p> ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªâ€œå›ºå®šâ€çš„è®¾å¤‡æ ‘blobã€‚  <strong>åœ¨ä¸æ›´æ”¹è™šæ‹Ÿæœºé…ç½®çš„æƒ…å†µä¸‹</strong> ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š </p><br><pre> <code class="plaintext hljs">qemu-system-riscv64 \ -M sifive_u -m 1g \ -serial stdio \ -s -S</code> </pre> <br><p>  <code>-serial stdio</code>å°†ä¸²è¡Œç«¯å£é‡å®šå‘åˆ°æ§åˆ¶å°ï¼Œå› ä¸ºå°†ç§¯æä½¿ç”¨è½¬ä¹‰åºåˆ—ã€‚  <code>-s -S</code>é€‰é¡¹åˆ†åˆ«å¼•å‘gdbserverå’Œåˆ›å»ºè¦æš‚åœçš„VMã€‚ æ‚¨å¯ä»¥ä½¿ç”¨<code>loader</code>ä¸‹è½½ä»£ç ï¼Œä½†æ˜¯æ¯æ¬¡éƒ½å¿…é¡»é‡æ–°å¯åŠ¨QEMUã€‚ </p><br><p> æ‚¨å¯ä»¥ä½¿ç”¨è¿æ¥ </p><br><pre> <code class="plaintext hljs">riscv64-unknown-elf-gdb \ -ex 'target remote 127.0.0.1:1234' \ -ex 'restore /path/to/on.dtb binary 0x80100000' \ -ex 'restore /path/to/memtest_shared.bin binary 0x80020000' \ -ex 'add-symbol-file memtest_shared 0x80100000' \ -ex 'set $a1=0x80020000' \ -ex 'set $pc=0x80100000'</code> </pre> <br><p> ç»“æœï¼Œä¸€åˆ‡éƒ½å˜å¾—æ¯”èªæ˜æ›´æœ‰æ•ˆï¼ </p><br><h2 id="obschiy-princip-raboty"> ä¸€èˆ¬å·¥ä½œåŸç† </h2><br><p> , ,  ,   Memtest86+   <code>btrace</code> ,        ,      (  ,     QEMU): </p><br><p><img src="https://habrastorage.org/webt/su/lr/qh/sulrqhzmiona327osxqzaikijf0.png" alt="btraceæ¨¡å¼"></p><br><p>  ,      , memtest          .     ,      (, trap):  ,   ,   QEMU - !  Â«Â»   <code>Illegal instruction</code>  ,    .      <code>mcause</code> (?),   â€” <code>mepc</code> (?),   â€” <code>mtval</code> (    ?),    . </p><br><p><img src="https://habrastorage.org/webt/lc/is/ho/lcishowkkjngpnorx_gkyav-svg.png" alt="éæ³•æŒ‡ç¤º"></p><br><p>   ,      : </p><br><p> <strong>head.S:</strong> </p><br><pre> <code class="plaintext hljs">#       #   = 0 ---   ,   #  ,    ,     ... lla t1, _trap_entry csrw mtvec, t1 # ... _trap_entry: csrr a0, mcause csrr a1, mepc csrr a2, mtval jal riscv_trap_entry</code> </pre> <br><p>  ,        calling convention,  .        memtest,    HiFive_U-Boot,      <code>Volume II</code> : </p><br><p> <strong>arch.c:</strong> </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *errors[] = { <span class="hljs-string"><span class="hljs-string">"Instruction address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Instruction access fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Illegal instruction"</span></span>, <span class="hljs-string"><span class="hljs-string">"Breakpoint"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load access fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Store/AMO address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Store/AMO access fault"</span></span>, ^_^quot quot^_^, ^_^quot quot^_^, ^_^quot quot^_^, ^_^quot quot^_^, <span class="hljs-string"><span class="hljs-string">"Instruction page fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load page fault"</span></span>, ^_^quot quot^_^, <span class="hljs-string"><span class="hljs-string">"Store/AMO page fault"</span></span>, }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">riscv_trap_entry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ulong cause, ulong epc, ulong tval)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">32</span></span>]; cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"EXCP: "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cause &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(errors) / <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(errors[<span class="hljs-number"><span class="hljs-number">0</span></span>])) { cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, errors[cause]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { itoa(buf, cause); cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, buf); } cprint(<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"PC: "</span></span>); hprint3(<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, epc, <span class="hljs-number"><span class="hljs-number">8</span></span>); cprint(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Addr: "</span></span>); hprint3(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, tval, <span class="hljs-number"><span class="hljs-number">8</span></span>); HALT(); }</code> </pre> <br><p>        â€”    Â« Â»   .   ,   Â«Â»    ,  ,      ,  . </p><br><p>         :     .       ,  memtest  :    : Â«       ,   ,    .        Â».    :  <code>do_test</code>   <code>main.c</code>    2,   (    ),       â€”    Â«Â» ,    memtest.       ,    <code>run_at</code> ,    memtest  <code>_start</code>  <code>_end</code>    (   Â«Â»  ),  -     spinlock'        <code>goto *addr;</code>        . ,  ,      Â«Â»    ,    Â«Â». </p><br><p>      ,    <strong> </strong>  <code>bss</code>    â€”    <code>_dl_start</code>  ,   <code>riscv_entry</code>  ,   trap entry. ,   :     L1I-,   .    ,     <code>fence.i</code> . </p><br><p>   ,  Memtest86+ â€” ,         <code>barrier_s</code>    .       ,          . ,   ,       . </p><br><h2 id="podvodnye-kamni">   </h2><br><p>    ,   :   .   :           .    <em></em> : ,  -       (Own Address,     )   .     ,     ,   .       . -    .   ,   x86 , ,    <code>uint64_t</code>   <code>0x80000002</code>       . ,     : <a href="https://stackoverflow.com/questions/12491578/whats-the-actual-effect-of-successful-unaligned-accesses-on-x86" rel="nofollow"> </a> ,   load/store  x86   ,     â€” .    ,    QEMU    ,  Â«  ,      Â». </p><br><p> ,     ,  <em>  </em> â€”   unaligned access  .. </p><br><p> ,   ,     RocketChip,   â€” QEMU,   ,  ,   RocketChip â€” unaligned access trap,  QEMU  Â«  Â». <br>   Â«misalignedÂ»            ,   </p><br><blockquote> Changed description of misaligned load and store behavior. The specification now allows visible misaligned address traps in execution environment interfaces, rather than just mandating invisible handling of misaligned loads and stores in user mode. Also, now allows access exceptions to be reported for misaligned accesses (including atomics) that should not be emulated. </blockquote><p>  , ,  â€”   ,  user-mode code   ,             .     .   , ,   .   ,       â€” -   machine mode    . ,     <code>rdtsc</code> (x86)  <code>rdtime</code> (rv64),   trap,     . , ,                memory-mapped . </p><br><p>    :      ,  <em> </em>   <code>low_test_addr</code> (       ),  ,   fdt   .   ,  ,  <code>low_test_addr</code>   ,  ,      2   <code>high_test_adr</code>    â€¦ ,     â€”   : <code>head.S</code>       <code>initial_load_addr</code> ,    <code>riscv_entry</code>    <code>move_to_correct_addr</code> : </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">move_to_correct_addr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span> cur_start = (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)&amp;_start; <span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span> cur_end = (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)&amp;_end; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur_start == low_test_addr || cur_start == high_test_adr) { <span class="hljs-comment"><span class="hljs-comment">//  ,     return; } if (cur_start == initial_load_addr &amp;&amp; (cur_start - low_test_addr) &lt; (cur_end - cur_start) ) { //   " ":   , //           //     ,    ,   //     ... serial_echo_print("FIRST STARTUP RELOCATION...\n"); void *temp_addr = (((uintptr_t)&amp;_end &gt;&gt; 12) + 1) &lt;&lt; 12; run_at(temp_addr, 0); } else { // ,    --- ,  . serial_echo_print("FINAL STARTUP RELOCATION...\n"); run_at(low_test_addr, 0); } }</span></span></code> </pre> <br><p> ,     â€”   ,  memtest ,  RAM  -   .  RISC-V    ,        <code>v-&gt;plim_lower</code> . </p><br><p>     ,   Â«Â» ,    -,   â€”  <code>test.c</code>    <code>ulong</code> (  <code>unsigneg long</code> ),   32- x86   <code>uint32_t</code> ,    Â« 64 Â»   <code>uint64_t</code> .       Â«!!! Good: ffffffff Real: ffffffff Bad bits: 00000000Â».   ?       - -1,  32    1.   ,         ,        0â€¦  ,     : ,  <code>ulong</code>      ( <code>uint32_t</code> ),          ( <code>uintptr_t</code> ). ,       . ,     <code>uint64_t</code>   4. RISC-V  <em></em>  ,       C, ,    â€”    UB. <del>     memtest  UBSan. </del>  ,  ,  UBSan   trap-on-error        JTAG. </p><br><h2 id="upakovyvaem-dlya-zagruzchika">    </h2><br><p> ,  memtest -  ,    ,          U-Boot. </p><br><p>       :    <code>mkimage</code>   U-Boot   <em>  Linux</em> : </p><br><pre> <code class="plaintext hljs">mkimage -A riscv -O linux -T kernel -C none \ -a 0x80000000 -e 0x80000000 \ -n memtest -d memtest.bin memtest.uboot</code> </pre> <br><p>      SD-      </p><br><pre> <code class="plaintext hljs">run mmcsetup; run fdtsetup; fdt set /chosen bootargs "console=ttyS0"; fatload mmc 0:1 82000000 memtest.uboot; bootm fdt; bootm 82000000 - ${fdtaddr}</code> </pre> <br><p> (   ,   <code>run</code>     â€”        ). </p><br><p>      :       FDT: <code>0xbffb7c80</code> . ,  :    <code>ffffffff</code> ,     .     ,         (     ),    :   HiFive_U-Boot      : </p><br><pre> <code class="cpp hljs"> theKernel(machid, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)images-&gt;ft_addr);</code> </pre> <br><p>    ,     </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*theKernel)(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> arch, uint params);</code> </pre> <br><p>  ,     , ,  ,  32        ,     <code>head.S</code> : </p><br><pre> <code class="plaintext hljs"> li t0, 0xffffffffL and a1, a1, t0</code> </pre> <br><h2 id="promezhutochnyy-itog">   </h2><br><p> ,  , - ,  ,     ,  : </p><br><ul><li>     x86.       â€”       review         <strong>   </strong> </li><li>   SMP   RISC-V </li><li>        <code>arch/</code> -  </li><li>     <code>test.c</code>  RISC-V (      <code>-O0</code> !) </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN484026/">https://habr.com/ru/post/zh-CN484026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN484012/index.html">ç®€åŒ–å¤§å®¹é‡ç¬”è®°æœ¬çš„ä¹¦å†™è¿‡ç¨‹</a></li>
<li><a href="../zh-CN484014/index.html">2020å¹´å°†æŠ›å¼ƒ10ä¸ªSEOç¥è¯</a></li>
<li><a href="../zh-CN484016/index.html">å…³äºè°ƒè¯•è‡ªåŠ¨ç¼–ç å™¨ç¤ºä¾‹çš„æ·±åº¦å­¦ä¹ åŸºç¡€ï¼Œç¬¬1éƒ¨åˆ†</a></li>
<li><a href="../zh-CN484018/index.html">æ¸¸è‰‡çš„ITæŠ€æœ¯é¢</a></li>
<li><a href="../zh-CN484020/index.html">æ‚¨æƒ³ç»™è°ç•™ä¸‹æ·±åˆ»çš„å°è±¡ï¼Ÿ</a></li>
<li><a href="../zh-CN484028/index.html">é©¬è¹„å¼¯-å¯æŠ˜å å¹³æ¿ç”µè„‘ï¼Œå¸¦æŠ˜å æ˜¾ç¤ºå±</a></li>
<li><a href="../zh-CN484036/index.html">æ–°è¡Œä¸šé›†å›¢ä¸ºæ™ºèƒ½å®¶å±…åˆ›å»ºé€šç”¨æ ‡å‡†</a></li>
<li><a href="../zh-CN484046/index.html">ä½¿ç”¨PVS-Studioæ£€æŸ¥Emby</a></li>
<li><a href="../zh-CN484048/index.html">PHPå’Œæ­£åˆ™è¡¨è¾¾å¼ï¼šåˆå­¦è€…çš„åŸºç¡€</a></li>
<li><a href="../zh-CN484050/index.html">ä½¿ç”¨PVS-Studioåˆ†æå™¨åµŒå…¥æºä»£ç åˆ†æ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>