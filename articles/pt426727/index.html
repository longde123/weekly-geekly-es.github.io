<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöÑ üöï ‚õëÔ∏è EME? Cdm? DRM? CENC? IDK! O que voc√™ precisa para criar seu pr√≥prio player de v√≠deo em um navegador üíÜüèø ‚õπÔ∏è üëßüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O que significam todas essas abrevia√ß√µes? O que √© necess√°rio para desenvolver um player de c√≥digo aberto para assistir a v√≠deos da Amazon, Sky e outra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>EME? Cdm? DRM? CENC? IDK! O que voc√™ precisa para criar seu pr√≥prio player de v√≠deo em um navegador</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/426727/"> O que significam todas essas abrevia√ß√µes?  O que √© necess√°rio para desenvolver um player de c√≥digo aberto para assistir a v√≠deos da Amazon, Sky e outras plataformas e assistir a v√≠deos de qualquer provedor?  Sebastian Golasch falou sobre como o processo de streaming de v√≠deo ocorre na confer√™ncia HolyJS 2018 Piter.  Sob o corte - v√≠deo e tradu√ß√£o de seu relat√≥rio. <br><br><img src="https://habrastorage.org/webt/et/to/7c/etto7cv1khykp68gwreip_8rfy4.jpeg"><br><br>  <i>Sebastian Golasch √© atualmente desenvolvedor da Deutsche Telekom.</i>  <i>Ele trabalhou com Java e PHP por um longo tempo e depois mudou para JS, Python e Rust.</i>  <i>Nos √∫ltimos sete anos, ele trabalha na plataforma dom√©stica inteligente Qivicon.</i> <br><br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/3Y3R_snaDDc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h2>  Um pouco sobre a hist√≥ria do streaming de v√≠deo </h2><br>  Primeiro, vamos olhar para a hist√≥ria da web, j√° que passamos do QuickTime para a Netflix em 25 anos.  Tudo come√ßou nos anos 90, quando a Apple inventou o QuickTime.  Seu uso na Internet come√ßou em 1993-1994.  Naquele momento, o player podia reproduzir v√≠deo com uma resolu√ß√£o de 156 √ó 116 pixels e uma frequ√™ncia de 10 FPS, sem acelera√ß√£o de hardware (usando apenas recursos do processador).  Esse formato foi focado em uma conex√£o dial-up de 9600 baud - 9600 bps, incluindo informa√ß√µes gerais. <br><br>  Era a hora do navegador Netscape.  O v√≠deo no navegador n√£o parecia muito bom, porque n√£o era nativo da Web.  Para jogar, usamos um software externo (o mesmo QuickTime) com sua pr√≥pria interface, que foi visualizada no navegador usando a tag embed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/664/455/137/664455137979de92508841f0d3ceaafa.png"><br><br>  A situa√ß√£o ficou um pouco melhor quando a Macromedia lan√ßou o Shockwave Player (ap√≥s a aquisi√ß√£o da Macromedia pela Adobe, ficou conhecida como Adobe Flash Player).  A primeira vers√£o do Shockwave Player foi lan√ßada em 1997, mas a reprodu√ß√£o de v√≠deo apareceu apenas em 2002. <br><br>  Eles usaram o codec Sorenson Spark aka H.263.  Foi otimizado para pequenas resolu√ß√µes e arquivos pequenos.  O que isso significa?  Por exemplo, um v√≠deo de 43 segundos usado para testar o Shockwave Player pesava apenas 560 KB.  Obviamente, n√£o seria muito agrad√°vel assistir a um filme dessa qualidade, mas a tecnologia em si era interessante para a √©poca.  No entanto, como no caso do QuickTime, para o Shockwave Player funcionar no navegador, era necess√°rio um software adicional.  Esse player teve muitos problemas de seguran√ßa, mas o mais importante √© que o v√≠deo ainda era um complemento do navegador. <br><br>  Em 2007, a Microsoft lan√ßou o Silverlight, que lembra o Flash.  N√£o vamos nos aprofundar, mas todas essas solu√ß√µes tinham algo em comum - uma caixa preta.  Todos os jogadores trabalharam como um complemento do navegador, e voc√™ n√£o tinha ideia do que estava acontecendo l√° dentro. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/84b/418/52e/84b41852efd2fb39dbea144b2e898dfe.png"><br><br>
<h2>  Elemento &lt; <code>Video/</code> &gt; </h2><br>  Em 2007, o Opera prop√¥s o uso da tag &lt; <code>Video/</code> &gt;, ou seja, a cria√ß√£o de v√≠deo nativo em um navegador.  N√≥s o usamos hoje.  √â f√°cil e conveniente, e qualquer v√≠deo pode n√£o apenas ser visualizado, mas tamb√©m baixado.  E mesmo que n√£o desejemos permitir o download de v√≠deos, n√£o podemos proibir o download para o navegador.  O m√°ximo √© dificultar o download do v√≠deo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cac/3be/693/cac3be693c7a3328062521d828c12c38.png"><br><br>  A <code>&lt;Video/&gt;</code> √© exatamente o oposto da caixa preta, e visualizar o c√≥digo fonte √© muito simples. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ca1/f23/708/ca1f237081ed5a6a9e648b65e05ea7a1.png"><br><br><h2>  DRM </h2><br>  No entanto, voc√™ n√£o pode simplesmente clicar com o bot√£o direito do mouse em um v√≠deo no Netflix e selecionar "Salvar como".  A raz√£o para isso √© DRM (Gerenciamento de restri√ß√µes digitais).  Esta n√£o √© uma √∫nica tecnologia ou um √∫nico aplicativo que executa qualquer tarefa.  Este √© um termo geral para conceitos como: <br><br><ul><li>  Autentica√ß√£o e criptografia de usu√°rio </li><li>  Criptografia baseada em conte√∫do </li><li>  Defini√ß√£o de direitos e aplica√ß√£o de restri√ß√µes </li><li>  Feedback e atualiza√ß√£o </li><li>  Controle de sa√≠da e prote√ß√£o de link </li><li>  Exame e rastreamento de intrusos </li><li>  Gerenciamento de chaves e licen√ßas </li></ul><br>  Para entender o que √© DRM, precisamos estudar seu ecossistema, ou seja, para descobrir quais empresas est√£o envolvidas.  Isto √©: <br><br><ul><li>  <b>Os propriet√°rios de conte√∫do</b> est√£o no topo do ecossistema.  Por exemplo, Disney, MGM ou FIFA.  Essas empresas produzem conte√∫do e t√™m direitos sobre ele. </li><li>  <b>Os n√∫cleos DRM</b> s√£o empresas que fornecem tecnologia DRM (por exemplo, Google, Apple, Microsoft etc.) Atualmente, existem entre 7 e 8 tecnologias DRM de diferentes empresas. </li><li>  <b>Provedores de servi√ßos</b> - Desenvolva um software de servidor que criptografa o v√≠deo. </li><li>  <b>Navegadores</b> que s√£o realmente jogadores. </li><li>  <b>Os provedores de conte√∫do</b> s√£o empresas como Netflix, Amazon, Sky etc. Como regra geral, eles n√£o possuem os direitos do conte√∫do, licenciam e distribuem o conte√∫do. </li><li>  <b>Os fornecedores de chips / dispositivos</b> tamb√©m est√£o envolvidos no ecossistema, porque o DRM n√£o √© apenas tecnologia de software.  Algumas empresas (principalmente chinesas) est√£o desenvolvendo chips que codificam e decodificam v√≠deos. </li></ul><br>  Voc√™ j√° se perguntou por que, ao assistir um v√≠deo no Netflix em um navegador, ele n√£o possui uma resolu√ß√£o muito alta (SD), mas se voc√™ assistir o mesmo v√≠deo em uma Apple TV ou Android TV Box, o mesmo conte√∫do ser√° reproduzido em Full HD ou em 4K?  O DRM tamb√©m √© respons√°vel por isso.  O fato √© que os fabricantes sempre t√™m medo de piratas roubarem conte√∫do.  Portanto, quanto menos seguro o ambiente em que a decodifica√ß√£o de v√≠deo √© executada, pior a qualidade √© mostrada ao usu√°rio.  Por exemplo, se a decodifica√ß√£o for realizada de forma program√°tica (por exemplo, no Chrome ou Firefox), o v√≠deo ser√° mostrado com a pior qualidade.  Em um ambiente em que os recursos de hardware para decodifica√ß√£o s√£o usados ‚Äã‚Äã(por exemplo, se o Android usa uma GPU), as possibilidades de c√≥pia ilegal de conte√∫do s√£o menores e, aqui, a qualidade da reprodu√ß√£o √© maior.  Por fim, o ambiente mais seguro √© totalmente de hardware (Apple TV ou Android TV Box), onde a decodifica√ß√£o e a reprodu√ß√£o s√£o realizadas sem envolver o software. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9f9/4fb/1bb/9f94fb1bb7c1fa9d31a02d2bf62950f0.png"><br><br>  Mas se falamos de navegadores, a decodifica√ß√£o neles √© quase sempre realizada por software.  Navegadores diferentes usam sistemas diferentes para DRM.  Chrome e Firefox usam Widevine.  Essa empresa √© de propriedade do Google e licencia seus aplicativos DRM.  Assim, para decodifica√ß√£o, o Firefox baixa a biblioteca DRM do Google.  No navegador, voc√™ pode ver de onde vem o download. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ca9/49d/015/ca949d015734b50c36e8594b8f5a4370.png"><br><br>  A Apple usa seu pr√≥prio sistema FairPlay, que foi criado quando a empresa lan√ßou o primeiro iPhone e iPad.  A Microsoft tamb√©m usa seu pr√≥prio desenvolvimento chamado PlayReady, embutido no Windows.  Em outros casos, o Widevine √© usado com mais frequ√™ncia.  Esse sistema existe tanto como aplicativo quanto como solu√ß√£o de hardware - chips que decodificam o v√≠deo. <br><br><h2>  Cdm </h2><br>  A abrevia√ß√£o CDM significa Content Decryption Module.  Este √© um software ou hardware que pode funcionar de v√°rias maneiras: <br><br><ul><li>  Descriptografe o v√≠deo, ap√≥s o qual √© renderizado no navegador usando a tag &lt;Video /&gt;. </li><li>  Descriptografe e decodifique o v√≠deo e transfira os quadros brutos do v√≠deo para reprodu√ß√£o no navegador. </li><li>  Descriptografe e decodifique o v√≠deo e transfira os quadros brutos do v√≠deo para reprodu√ß√£o usando a GPU. </li></ul><br>  Apesar do suporte da GPU, a segunda op√ß√£o √© mais usada (pelo menos no que diz respeito ao Chrome e Firefox). <br><br><h2>  Decodificando e decodificando camadas no navegador </h2><br>  Ent√£o, como tudo isso funciona juntos?  Para entender isso, observe as camadas de decodifica√ß√£o e descriptografia no navegador.  Eles s√£o divididos em: <br><br><ul><li>  Aplicativo JavaScript - informa ao computador qual v√≠deo eu vou assistir. </li><li>  Um navegador √© um player que reproduz conte√∫do de v√≠deo. </li><li>  M√≥dulo de descriptografia de conte√∫do. </li><li>  O gerenciamento de direitos digitais tem tudo a ver com decodifica√ß√£o de v√≠deo (n√£o consegui criar uma nota√ß√£o melhor, ent√£o chamei assim). </li><li>  Tempo de execu√ß√£o confi√°vel. </li><li>  Nesse caso, os dois primeiros componentes s√£o um player DRM, o m√≥dulo de descriptografia de conte√∫do √© um cliente DRM e os dois √∫ltimos componentes s√£o o n√∫cleo DRM. </li></ul><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b2b/7da/87b/b2b7da87bf7b3b92ef4004f4d4b97800.png"><br><br>  O que acontece quando voc√™ reproduz um v√≠deo em um navegador √© mostrado na imagem abaixo.  Ela, √© claro, √© um pouco confusa: h√° muitas setas e cores.  Eu passo a passo passo a passo, usando casos reais para deixar mais claro <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b1e/982/bb7/b1e982bb7fe74fa39f08b00264987409.png"><br><br>  Usaremos o Netflix como exemplo.  Eu escrevi um aplicativo de depura√ß√£o. <br><br>  Comecei com onde, penso, cada um de voc√™s come√ßaria: observei os pedidos que a Netflix faz quando inicio um v√≠deo e vi um grande n√∫mero de grava√ß√µes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b04/913/8d7/b049138d7a4da37f5b9b6c5e4da88bf3.png"><br><br>  No entanto, se voc√™ deixar apenas aqueles que realmente s√£o necess√°rios para reproduzir o v√≠deo, ocorrer√° apenas tr√™s deles: manifesto, licen√ßa e o primeiro fragmento do v√≠deo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/381/e12/a9f/381e12a9f194014ae19501e4e9ada763.png"><br><br>  O aparelho Netflix est√° escrito em JavaScript e cont√©m mais de 76.000 linhas de c√≥digo e, √© claro, n√£o consigo analis√°-lo completamente.  Mas eu gostaria de mostrar as principais partes necess√°rias para a reprodu√ß√£o de v√≠deo protegido. <br><br>  Come√ßaremos com o modelo: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9ba/205/e6f/9ba205e6f022e4a99ffa373372c99047.png"><br><br><h2>  EME </h2><br>  Por√©m, antes de nos aprofundarmos nas fun√ß√µes, precisamos nos familiarizar com outra tecnologia - EME (Extens√µes de m√≠dia criptografada, extens√µes de m√≠dia criptografada).  Essa tecnologia n√£o executa descriptografia e decodifica√ß√£o, √© apenas uma API do navegador.  O EME serve como uma interface para CDM, para KeySystem, para um servidor com uma licen√ßa e para um servidor em que o conte√∫do √© armazenado. <br><br>  Ent√£o, vamos come√ßar com o getKeySystemConfig. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e68/179/765/e68179765d8d942b41efd0a05fb51cd4.png"><br><br>  Deve-se ter em mente que depende do provedor, portanto, a configura√ß√£o que apresento aqui funciona para a Netflix, mas n√£o funciona, por exemplo, para a Amazon. <br><br>  Nesta configura√ß√£o, devemos informar ao sistema de back-end qual n√≠vel de tempo de execu√ß√£o confi√°vel podemos oferecer.  Isso pode ser decodifica√ß√£o segura de hardware ou decodifica√ß√£o segura de software.  Ou seja, estamos dizendo ao sistema que hardware e software ser√£o usados ‚Äã‚Äãpara reprodu√ß√£o.  E isso determinar√° a qualidade do conte√∫do. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c0f/071/1dd/c0f0711ddf9da278d6ab4c23ff31f75c.png"><br><br>  Ap√≥s a configura√ß√£o, configure a cria√ß√£o de um MediaKeySystem inicial. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/99a/62b/ccb/99a62bccbf59fc6c893db5b34b3e3c91.png"><br><br>  √â aqui que a intera√ß√£o com o m√≥dulo de descriptografia de conte√∫do come√ßa.  Voc√™ deve informar √† API qual sistema DRM e KeySystem usamos.  No nosso caso, isso √© Widevine. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e31/ff8/416/e31ff841688a7f78547c02723c31c11c.png"><br><br>  O pr√≥ximo passo √© opcional para todos os sistemas, mas necess√°rio para o Netflix.  Novamente, sua necessidade depende do provedor.  Precisamos aplicar um certificado de servidor em nossas mediaKeys.  Os certificados de servidor s√£o texto sem formata√ß√£o em um arquivo Netflix Cadmium.js que pode ser facilmente copiado.  E quando a aplicamos ao mediaKeys, toda a comunica√ß√£o entre o servidor com a licen√ßa e nosso navegador se torna segura gra√ßas ao uso deste certificado. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d3c/601/dd1/d3c601dd109f2a67e84efe69ca76ba6a.png"><br><br>  Quando isso for feito, devemos voltar ao elemento original do v√≠deo e dizer: ‚ÄúOk, este √© o sistema principal que queremos usar, e essa √© a tag ol√° v√≠deo.  Vamos unir voc√™. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/797/6cf/3ce/7976cf3ce8dacf000547d40084d16d22.png"><br><br>  E aqui est√° a √∫ltima fun√ß√£o que voc√™ precisa para configurar o sistema de v√≠deo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/107/ce0/fa0/107ce0fa0c047fd77218983652e0aa89.png"><br><br>  Esta √© uma sess√£o DRM, ou MediaKeySession.  Esses s√£o apenas os dados que v√£o do provedor ao m√≥dulo de descriptografia que assina os pedidos com eles.  Esses dados tamb√©m s√£o texto simples, oculto por tr√°s de v√°rias fun√ß√µes no arquivo do Netflix, de onde eu as copiei. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ed7/3a4/0a3/ed73a40a370d7744f55590fc9e23efa5.png"><br><br>  Quando chamamos create.Session no objeto mediaKeys, precisamos informar qual v√≠deo suportamos.  Nesse caso, √© mp4.  Isso nos leva de volta ao contexto de mensagens com o nosso sistema CDM.  Tamb√©m precisamos que a Netflix aplique o certificado do servidor base64 em cada formul√°rio, mas toda essa configura√ß√£o na sess√£o de cria√ß√£o √© novamente fornecida, dependendo do sistema DRM. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b24/8ff/e27/b248ffe2709055f4eadc33eab77df455.png"><br><br>  A √∫ltima fun√ß√£o aqui abaixo - keySession.generateRequest cria uma solicita√ß√£o de licen√ßa em segundo plano.  Ou o CDM est√° criando uma solicita√ß√£o de licen√ßa em segundo plano.  Em outras palavras, s√£o dados bin√°rios brutos que devemos enviar ao servidor licenciado para obter uma licen√ßa v√°lida em troca. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/43c/798/16e/43c79816e9006b0668d58555887017b7.png"><br><br>  Aqui cenc √© de interesse.  √â um padr√£o de criptografia ISO que define um esquema de seguran√ßa para v√≠deo mp4.  No WebM, isso √© chamado de maneira diferente, mas a fun√ß√£o executa o mesmo. <br><br>  handleMessage √© a interface EventListener que configuramos.  Quando esse evento √© gerado pelo evento de mensagem em keySession, sabemos que estamos prontos para obter uma licen√ßa do servidor. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4ef/93b/e85/4ef93be85d1d8535408a1abed9ca9ec6.png"><br><br>  E nesse retorno de chamada, apenas recebemos uma solicita√ß√£o para um servidor com uma licen√ßa que fornece alguns dados bin√°rios (eles tamb√©m podem diferir dependendo do provedor).  Usamos esses dados para atualizar a sess√£o atual adicionando uma licen√ßa.  Ou seja, assim que recebemos uma licen√ßa v√°lida do servidor, nosso CDM sabe que podemos decodificar e descriptografar o v√≠deo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/779/ef3/ea9/779ef3ea918671d1c4a2d2df8d9c404d.png"><br><br>  Se aplicarmos isso ao diagrama abaixo, obtemos o seguinte: queremos reproduzir o v√≠deo e o aplicativo JavaScript diz: ‚ÄúOl√°, navegador!  Eu quero reproduzir o v√≠deo! ‚Äù  - usa as extens√µes de m√≠dia criptografada e solicita uma licen√ßa para fun√ß√µes de licen√ßa no Widevine CDM.  Essa solicita√ß√£o √© retornada ao navegador e podemos troc√°-la por uma licen√ßa v√°lida no servidor de licen√ßas e, em seguida, precisamos transferi-la novamente para o CDM.  Este processo foi mostrado no c√≥digo acima. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a98/e80/622/a98e806221a4f2533f0155c8425a36b4.png"><br><br>  Mas observe que ainda n√£o perdemos um segundo do v√≠deo e todos precisamos fazer isso para poder reproduzir alguns v√≠deos no futuro. <br><br><h2>  MSE </h2><br>  E outra tecnologia que precisamos pesquisar √© o MSE (Media Source Extensions).  Ela pode ser chamada de meia-irm√£ do EME (Encrypted Media Extensions).  Essa tamb√©m √© uma API do navegador e n√£o tem nada a ver com DRM.  Eu vejo isso como uma interface de programa√ß√£o para &lt; <code>Video/</code> &gt; Src.  Com ele, voc√™ pode criar fluxos bin√°rios em JavaScript e aplicar fragmentos de v√≠deo ao elemento &lt; <code>Video/</code> &gt;.  Assim, gra√ßas a isso, a fonte da tag &lt; <code>Video/</code> &gt; se torna din√¢mica. <br><br>  Assim, podemos usar as extens√µes para fontes de multim√≠dia, instanciar e acessar o v√≠deo, depois baixar os fragmentos de v√≠deo em partes e aplic√°-los √† tag &lt; <code>Video/</code> &gt;. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0a1/8f5/99f/0a18f599f2422bc047ad16d71f32f9af.png"><br><br>  O ponto √© que, quando voc√™ assiste a um v√≠deo de duas horas, n√£o deseja esperar at√© que ele esteja totalmente carregado.  Em vez disso, corte-o em peda√ßos pequenos, com tamanho variando de 30 segundos a 2 minutos, e aplique-os ao elemento &lt; <code>Video/</code> &gt;, um de cada vez. <br><br>  Quando nosso buffer MediaSource estiver pronto e vinculado ao elemento &lt; <code>Video/</code> &gt;, podemos adicionar um SourceBuffer.  Devemos dizer novamente a ele qual formato de v√≠deo e quais codecs usamos e, em seguida, ele ser√° criado. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/49a/d01/b0f/49ad01b0fcb2745fd0243c9bd4cf0972.png"><br><br>  Finalmente, agora podemos buscar fragmentos individuais e envi√°-los em nosso SourceBuffer usando o m√©todo append ao elemento &lt;Video /&gt;, recebendo um v√≠deo criado dinamicamente.  Tamb√©m pode ser usado para outros casos de uso em que as pessoas podem combinar de forma independente diferentes elementos do v√≠deo, criando seus pr√≥prios v√≠deos, mas eu n√£o gostaria de aprofundar muito nele. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9d5/687/bc3/9d5687bc390e405b84977c99420abb4b.png"><br><br>  Portanto, este √© quase o √∫ltimo passo que devemos dar.  Voc√™ tem uma rede de distribui√ß√£o, possui fragmentos e, em seguida, o navegador envia os fragmentos criptografados e compactados para o CDM, onde a descriptografia e, possivelmente, a decodifica√ß√£o s√£o realizadas.  Em seguida, os fragmentos descriptografados e descompactados s√£o enviados de volta ao navegador, onde s√£o visualizados e exibidos. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/498/2d0/8a6/4982d08a6ee484ab5de56fb3cdb6d247.png"><br><br><h2>  Manifesto </h2><br>  Mas h√° mais um ponto.  Como sabemos de quais fragmentos precisamos baixar, de onde baix√°-los e quando?  E esta √© a √∫ltima parte, a solicita√ß√£o ausente do manifesto.  Quando consultamos um manifesto no Netflix, ele precisa de muitos dados.  Se queremos apenas reproduzir um v√≠deo, √© importante para n√≥s qual sistema DRM usamos, qual v√≠deo queremos assistir (ID da Netflix, que pode ser copiado da URL) e perfis.  Os perfis determinam em que resolu√ß√£o recebemos o v√≠deo e tamb√©m em que idioma recebemos as faixas de √°udio, em que formato (est√©reo, Dolby Digital etc.), se usamos legendas etc. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/daf/b78/506/dafb7850664c7b2baba6894add61a79a.png"><br><br><h2>  MPEG-DASH </h2><br>  O formato de manifesto mais usado √© o MPEG-DASH.  √â verdade que a Apple usa um formato diferente - HSL, que parece uma lista de arquivos no antigo reprodutor Winamp.  Mas Widevine e Microsoft usam exatamente MPEG-DASH.  Ele √© baseado em XML e define tudo: dura√ß√£o, tamanho do buffer, tipos de conte√∫do, quando os fragmentos s√£o carregados, fragmentos para diferentes resolu√ß√µes e altern√¢ncia de taxa de bits adapt√°vel.  O √∫ltimo significa que, se um usu√°rio, por exemplo, assiste a um v√≠deo e ao mesmo tempo a velocidade de download diminui, a reprodu√ß√£o n√£o para, mas a qualidade do v√≠deo simplesmente se deteriora.  Isso ocorre porque o manifesto define as mesmas partes para diferentes resolu√ß√µes, elas t√™m a mesma dura√ß√£o e os mesmos √≠ndices.  Portanto, se a velocidade do download diminuir, o navegador pode simplesmente mudar para um fluxo com uma resolu√ß√£o mais baixa sem interromper o download e sem armazenar em buffer os dados. <br><br>  √â assim que o manifesto de Guardi√µes da Gal√°xia se parece.  Nele podemos ver que, em diferentes velocidades de download, as pessoas receber√£o v√≠deos com qualidade diferente, al√©m do fato de haver faixas de √°udio para pessoas com defici√™ncia auditiva.  Tamb√©m explicita as legendas. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/785/a96/a6f/785a96a6fa6b13ed57bd6f5518f36fa1.png"><br><br>  Temos uma dura√ß√£o e uma indica√ß√£o do tempo a partir do qual iniciar a reprodu√ß√£o.  Esta fun√ß√£o √© usada, por exemplo, quando voc√™ interrompe a exibi√ß√£o e depois retorna ao v√≠deo novamente, come√ßando de onde parou. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dcc/349/b4c/dcc349b4c9b4a4eabfa26da95511185d.png"><br><br>  Tamb√©m h√° robustez novamente, que diz: esse fragmento pode ser perdido apenas se o seu sistema atender aos requisitos.  Nesse caso, √© a decodifica√ß√£o de hardware - Codecs seguros de hardware. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a76/7c2/248/a767c224876945a69441fe4314114319.png"><br><br>  Para a mesma parte do v√≠deo, voc√™ pode determinar qualquer n√∫mero de fragmentos com resolu√ß√µes diferentes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9fa/202/d19/9fa202d1922b5e6d9aabb5a22f359d49.png"><br><br>  E ent√£o voc√™ obt√©m o URL para carregar o fragmento, e o par√¢metro range mostra o intervalo de valores em milissegundos. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/35e/325/93c/35e32593c77c1c7b242ce0141e8b6fd3.png"><br><br>  Esta √© a √∫ltima parte.  √Äs vezes, voc√™ tamb√©m recebe um manifesto da CDN.  Alguns provedores t√™m um servidor separado para entrega de fragmentos, mas na maioria das vezes eles v√™m da mesma m√°quina que a funcionalidade do manifesto.  Quando baixamos o manifesto, sabemos quais fragmentos precisamos baixar, podemos enviar uma solicita√ß√£o de fragmentos e depois descriptografar e decodificar no CDM. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/826/2e5/47d/8262e547d950d80ec737263c795ddab9.png"><br><br>  Em geral, isso √© tudo.  Tudo o que foi dito acima √© suficiente para desenvolver um player de c√≥digo aberto para assistir a v√≠deos da Amazon, Sky e outras plataformas e assistir a praticamente qualquer provedor. <br><br><h2>  Msl </h2><br>  A Netflix considerou que vale a pena adicionar criptografia extra de mensagens entre o navegador e o servidor.  Eles o chamavam de "Camada de seguran√ßa da mensagem", a Camada de seguran√ßa da mensagem ou MSL.  N√£o faz nada diretamente com o v√≠deo, √© apenas uma camada extra de criptografia.  Um dos motivos para a implementa√ß√£o do MSL √© que o HTTPS n√£o √© seguro o suficiente.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O MSL</a> , por outro lado, √© de c√≥digo aberto, para que voc√™ possa sempre ver como ele funciona.  Aqui n√£o vou me aprofundar neste t√≥pico e, se voc√™ estiver interessado, sempre poder√° encontrar informa√ß√µes sobre o motivo pelo qual a Netflix faz MSL em seu blog.  O GitHub possui documenta√ß√£o detalhada sobre sua implementa√ß√£o e implementa√ß√µes de trabalho em Java. <br><br>  H√° tamb√©m uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">implementa√ß√£o Python</a> que escrevemos com os amigos.  At√© onde eu sei, esse √© o √∫nico cliente de c√≥digo aberto que funciona na Netflix.  Ele trabalha com o Kodi Media Center.  Para visualiza√ß√£o, voc√™ pode usar o VLC Player ou qualquer outro software adequado. <br><br><h2>  E novamente a "caixa preta" </h2><br>  Ent√£o, voc√™ viu o que √© necess√°rio para implementar tudo isso e com que frequ√™ncia mencionei o CDM - a "caixa preta" que √© baixada do Google.  Assim, voltamos a exibir o v√≠deo na "caixa preta".  O belo elemento &lt;Video /&gt; est√° novamente escondido de n√≥s.  Adicionamos software de terceiros que nos ajuda, mas que ao mesmo tempo √© fechado e que n√£o podemos gerenciar.  Pode fazer muitas coisas discretas: rastreamento, an√°lise, envio de dados ... <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7ef/e10/72c/7efe1072c1d1d1390451a08ba3897f33.png"><br><br>  Aqui est√° o que Tim Berners Lee disse sobre isso: <i>"Ent√£o, em geral, √© importante manter o EME como um ambiente on-line relativamente seguro, onde voc√™ pode assistir filmes, al√©m do mais conveniente e que o torna parte do discurso interconectado da humanidade".</i> <br><br>  Mas h√° outras opini√µes sobre isso.  Em particular, da Electronic Frontiers Foundation, que antes do advento do DRM era membro do W3C.  Eis o que eles dizem: <i>‚ÄúEm 2013, a EFF ficou desapontada ao saber que o W3C assumiu o projeto de padroniza√ß√£o de extens√µes de m√≠dia criptografadas por EME.</i>  <i>Na verdade, estamos falando de uma API cuja √∫nica fun√ß√£o era fornecer ao DRM um papel de lideran√ßa no ecossistema do navegador.</i>  <i>Continuaremos a lutar para garantir que a Internet seja livre e aberta.</i>  <i>"Continuaremos processando o governo dos EUA para revogar leis que tornam o DRM t√£o t√≥xico e continuaremos a lutar no n√≠vel da lei global".</i> <br><br>  √â dif√≠cil para mim dizer como me relacionar com isso.   ,       ,      ,      .   ,     Netflix,     . ,        ,         . <br><br><blockquote>   , 24-25 ,    <b>HolyJS 2018 Moscow</b> ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">¬´The Universal Serial Web¬ª</a> :     WebUSB,    USB-  .     -,    . <br><br> PS  1-      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> . ,     ‚Äî  50%   . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt426727/">https://habr.com/ru/post/pt426727/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt426717/index.html">A ilus√£o da decep√ß√£o: uma ilus√£o de √≥tica visual baseada na previs√£o retroativa</a></li>
<li><a href="../pt426719/index.html">Hackathon sobre Ci√™ncia de Dados no SIBUR: como foi</a></li>
<li><a href="../pt426721/index.html">Evitar falhas durante o desenvolvimento do produto: 10 dicas do novato</a></li>
<li><a href="../pt426723/index.html">Microsoft e parceiros esperam criar uma c√°psula do tempo na lua</a></li>
<li><a href="../pt426725/index.html">Como fazer as coisas quando voc√™ n√£o deseja faz√™-las</a></li>
<li><a href="../pt426729/index.html">Escola de Magia TypeScript: extens√£o de tipos e gen√©ricos</a></li>
<li><a href="../pt426731/index.html">CSS: recursos interessantes do raio da borda</a></li>
<li><a href="../pt426733/index.html">O ferro n√£o falhar√°. Como eu preparo dezenas de servidores por dia para a batalha</a></li>
<li><a href="../pt426735/index.html">Bem-vindo ao JETHACK Hackathon</a></li>
<li><a href="../pt426737/index.html">Brevemente sobre a arquitetura dos processadores neurom√≥rficos: uma vis√£o interna</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>