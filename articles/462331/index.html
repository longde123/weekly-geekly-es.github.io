<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîé üõÉ üë®‚Äç‚úàÔ∏è Juguete GAZ-66 en el panel de control. Parte 2 üëçüèº üßñ ü§¶üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En esta parte hablaremos sobre el componente de software, c√≥mo la m√°quina cobr√≥ vida. Qu√© sistema operativo se utiliz√≥, qu√© idioma se eligi√≥, qu√© prob...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Juguete GAZ-66 en el panel de control. Parte 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462331/"><p><img src="https://habrastorage.org/webt/ix/tf/mx/ixtfmxmnpt-9rkvbc2kqpdtol2c.jpeg" alt="imagen"></p><br><p>  En esta parte hablaremos sobre el componente de software, c√≥mo la m√°quina cobr√≥ vida.  Qu√© sistema operativo se utiliz√≥, qu√© idioma se eligi√≥, qu√© problemas se enfrentaron. </p><a name="habracut"></a><br><h3 id="1-kak-rabotaet-v-2-h-slovah">  1. C√≥mo funciona en 2 palabras </h3><br><p>  El sistema consta de un servidor que est√° instalado en una m√°quina de escribir y un cliente que est√° instalado en la consola.  El servidor eleva el punto de acceso <strong>wifi</strong> y espera hasta que el cliente se conecta.  El servidor ejecuta comandos del cliente y tambi√©n transmite video desde la c√°mara. </p><br><h3 id="2-os">  2. OS </h3><br><p>  Ahora hablemos sobre los sistemas operativos utilizados. </p><br><p>  Dado que todo el sistema se basa en <strong>Raspberry pi 3</strong> , se utiliz√≥ el sistema operativo oficial.  En el momento de la creaci√≥n, la √∫ltima versi√≥n era <strong>Stretch</strong> , fue y fue seleccionada para su uso en una m√°quina de escribir y un panel de control.  Pero result√≥ que tiene un error (atormentado durante una semana) debido a que es imposible elevar el punto de acceso wifi.  Por lo tanto, para elevar el punto de acceso, se tom√≥ una versi√≥n anterior de <strong>Jessie</strong> que no ten√≠a tales problemas. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Art√≠culo sobre c√≥mo elevar un punto de acceso.</a>  Muy detallado, hizo todo en √©l. </p><br><p>  El control remoto se conecta autom√°ticamente a la m√°quina cuando levanta el punto de acceso. <br>  Conexi√≥n autom√°tica a nuestro punto, en el archivo <strong>/ etc / network / interfaces</strong> agregue: </p><br><pre><code class="plaintext hljs">auto wlan0 iface wlan0 inet dhcp wpa-ssid {ssid} wpa-psk {password}</code> </pre> <br><h3 id="2-yazyk">  2. Idioma </h3><br><p>  Eleg√≠ <strong>python</strong> porque es f√°cil y simple. </p><br><h3 id="3-server">  3. Servidor </h3><br><p>  Por servidor en esta secci√≥n me referir√© al software escrito por m√≠ para controlar la m√°quina y trabajar con video. </p><br><p>  El servidor consta de 2 partes.  Servidor de video y servidor de gesti√≥n. </p><br><h3 id="31-video-server">  3.1 Servidor de video </h3><br><p>  Hab√≠a 2 opciones de c√≥mo trabajar con una c√°mara de video.  Primer uso del m√≥dulo <strong>picamera</strong> y segundo uso <strong>del software mjpg-streamer</strong> .  Sin pensarlo dos veces, decid√≠ usar ambos y cu√°l usar en la configuraci√≥n. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> conf.conf.VideoServerType == <span class="hljs-string"><span class="hljs-string">'m'</span></span> : cmd = <span class="hljs-string"><span class="hljs-string">"cd /home/pi/projects/mjpg-streamer-experimental &amp;&amp; "</span></span> cmd += <span class="hljs-string"><span class="hljs-string">'./mjpg_streamer -o "./output_http.so -p {0} -w ./www" -i "./input_raspicam.so -x {1} -y {2} -fps 25 -ex auto -awb auto -vs -ISO 10"'</span></span>.format(conf.conf.videoServerPort, conf.conf.VideoWidth, conf.conf.VideoHeight) print(cmd) os.system(cmd) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> picamera.PiCamera(resolution = str(conf.conf.VideoWidth) + <span class="hljs-string"><span class="hljs-string">'x'</span></span> + str(conf.conf.VideoHeight) , framerate = conf.conf.VideoRate) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Camera: output = camera.StreamingOutput() camera.output = output Camera.start_recording(output, format = <span class="hljs-string"><span class="hljs-string">'mjpeg'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: address = (conf.conf.ServerIP, conf.conf.videoServerPort) server = camera.StreamingServer(address, camera.StreamingHandler) server.serve_forever() <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: Camera.stop_recording()</code> </pre> <br><p>  Como toman la misma configuraci√≥n, funcionan en la misma direcci√≥n.  No hay problemas para comunicarse con el control remoto al cambiar de uno a otro.  Lo √∫nico que creo que <strong>mjpg-streamer</strong> funciona m√°s r√°pido. </p><br><h3 id="32-server-upravleniya">  3.2 Servidor de gesti√≥n </h3><br><h4 id="321-vzaimodeystvie-mezhdu-klientom-i-serverom">  3.2.1 Interacci√≥n entre cliente y servidor </h4><br><p>  El servidor y el cliente intercambian comandos en forma de cadenas json: </p><br><pre> <code class="python hljs">{<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'val'</span></span>: <span class="hljs-number"><span class="hljs-number">0.0</span></span>} {<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'Y'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'val'</span></span>: <span class="hljs-number"><span class="hljs-number">0.5</span></span>} {<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'turn'</span></span>, <span class="hljs-string"><span class="hljs-string">'x'</span></span>: <span class="hljs-number"><span class="hljs-number">55</span></span>, <span class="hljs-string"><span class="hljs-string">'y'</span></span>: <span class="hljs-number"><span class="hljs-number">32</span></span>}</code> </pre> <br><ul><li>  tipo - 'remoto' o 'auto' dependiendo de qui√©n env√≠a el comando (cliente o servidor) </li><li>  cmd: una cadena con el nombre del bot√≥n correspondiente al nombre del bot√≥n en el <strong>SOMBRERO</strong> del <strong>juego</strong> , por ejemplo: <br><ul><li>  Inicio - Bot√≥n de inicio </li><li>  Seleccionar - Bot√≥n Seleccionar </li><li>  Y - bot√≥n Y </li><li>  etc. </li><li>  girar - el comando para cambiar el estado del joystick, es responsable de girar las ruedas </li></ul></li><li>  estado: verdadero o falso, dependiendo de si el bot√≥n est√° presionado o no.  Se env√≠a un evento de estado de bot√≥n cada vez que cambia su estado. </li><li>  val - velocidad y direcci√≥n de movimiento del motor desde -1 ... 1, valor de tipo <strong>float</strong> .  Par√°metro significativo solo para botones de movimiento. </li><li>  x - desviaci√≥n del joystick a lo largo del eje x de -100 ... 100, valor de tipo <strong>int</strong> </li><li>  y - desviaci√≥n del joystick a lo largo del eje y de -100 ... 100, valor de tipo <strong>int</strong> </li></ul><br><p>  Luego viene mi verg√ºenza, rehacer qu√© manos no alcanzan.  La m√°quina eleva el socket del servidor y espera hasta que el cliente se conecta a √©l.  Adem√°s, para cada nueva conexi√≥n, crea una secuencia separada, y cada nuevo cliente que se conectar√° a la m√°quina podr√° controlarla)).  Esto no puede estar tan lejos porque nadie m√°s tiene ese control remoto, y levanto mi red wifi cerrada. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> TCP_IP = conf.conf.ServerIP TCP_PORT = conf.conf.controlServerPort BUFFER_SIZE = conf.conf.ServerBufferSize self.tcpServer = socket.socket(socket.AF_INET, socket.SOCK_STREAM) self.tcpServer.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number"><span class="hljs-number">1</span></span>) self.tcpServer.bind((TCP_IP, TCP_PORT)) threads = [] <span class="hljs-comment"><span class="hljs-comment">#     . self.tcpServer.listen(1) while True: print("Car server up : Waiting for connections from TCP clients...") (conn, (ip, port)) = self.tcpServer.accept() newthread = ClientThread(conn, ip, port) newthread.start() self.threads.append(newthread)</span></span></code> </pre> <br><h4 id="322-upravlenie-zhelezom">  3.2.2 Gesti√≥n del hierro </h4><br><p>  Al trabajar con Raspberry, se utiliz√≥ el sistema de numeraci√≥n de pin <strong>GPIO.BCM</strong> . </p><br><p>  <strong>La luz se</strong> controla a trav√©s de gpio 17, est√° conectada al segundo pin en <strong>L293</strong> .  A continuaci√≥n, cada vez que el comando viene a incluir: </p><br><pre> <code class="python hljs">GPIO.output(self.gpioLight, GPIO.HIGH)</code> </pre> <br><pre> <code class="python hljs">GPIO.output(self.gpioLight, GPIO.LOW)</code> </pre> <br><p>  Se llaman los comandos correspondientes. </p><br><p>  <strong>El servodrive</strong> se <strong>controla a</strong> trav√©s de la placa <strong>PCA9685 a</strong> trav√©s del bus I2C, por lo que necesitamos la biblioteca adecuada para ello <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Adafruit_PCA9685</a> .  PCA9685 est√° conectado al servo a trav√©s de 7 pines.  La frecuencia PWM requerida para trabajar con servo es de 50 Hz o un per√≠odo de 20 ms. </p><br><p>  El principio de funcionamiento del servo: </p><br><p><img src="https://habrastorage.org/webt/h2/z-/ns/h2z-nsefbtnvntcwbmmt9qoikjc.jpeg" alt="imagen"></p><br><p>  Cuando se aplica una se√±al de 1.5 ms, las ruedas estar√°n centradas.  A 1 ms.  el servo girar√° lo m√°s posible hacia la derecha, 2 ms.  a la izquierda tanto como sea posible.  Los nudillos de direcci√≥n en los puentes para tales giros no est√°n dise√±ados, por lo que el √°ngulo de rotaci√≥n tuvo que seleccionarse experimentalmente. </p><br><p>  Los valores que se pueden pasar a la API Adafruit_PCA9685 van desde 0..4095, 0 sin se√±al, 4095 lleno.  En consecuencia, de este rango fue necesario elegir los valores adecuados para mis ruedas.  La forma m√°s f√°cil de determinar los valores para ruedas establecidas exactamente es transferir 1,5 ms a un valor del rango de ~ 307. </p><br><p>  El valor m√°ximo para la derecha es 245, para la izquierda 369. </p><br><p>  Los valores que provienen del joystick toman valores de -100 ... 100, por lo que tuvieron que traducirse en el rango de 245 a 369. Nuevamente, el centro es el m√°s f√°cil, si 0 es 307. Izquierda y derecha seg√∫n la f√≥rmula: </p><br><pre> <code class="python hljs">val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero))</code> </pre> <br><ul><li>  HardwareSetting._turnCenter - 307 </li><li>  giro - valor del joystick desde -100 ... 100 </li><li>  HardwareSetting._turnDelta - 62, la diferencia entre el centro y la desviaci√≥n m√°xima hacia un lado (307 - 245 = 62) </li><li>  HardwareSetting.yZero - 100, el valor m√°ximo recibido del joystick </li></ul><br><p>  Ruedas rectas: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnCenter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  Girar a la izquierda: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnLeft</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, turn)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero)) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  Girar a la derecha: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnRight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, turn)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero)) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  <strong>El control del motor</strong> tambi√©n se realiza a trav√©s de la placa <strong>PCA9685 a</strong> trav√©s del bus I2C, por lo que utilizamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Adafruit_PCA9685</a> .  Los pines 10 a 15 en el PCA9685 est√°n conectados al L298N (uso 2 canales para absorber energ√≠a).  10 y 11 a ENA y ENB (los relleno con PWM para controlar la velocidad).  12, 13, 14, 15 a IN1, IN2, IN3, IN4: son responsables de la direcci√≥n de rotaci√≥n del motor.  La frecuencia PWM no es muy importante aqu√≠, pero tambi√©n uso 50 Hertz (mi valor predeterminado). </p><br><p>  La m√°quina se detiene: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW)</code> </pre> <br><p>  Avanzando: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">back</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, speed)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . Args: speed:     0  1. """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH)</code> </pre> <br><p>  Movimiento hacia atr√°s: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forward</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, speed)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . Args: speed:     0  1. """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW)</code> </pre> <br><h3 id="4-klient">  4. Cliente </h3><br><h3 id="41-klaviatura">  4.1 Teclado </h3><br><p>  Hubo ciertos problemas con ella, al principio quer√≠a que estuviera llena de acontecimientos (tard√≥ ~ 2 semanas de tormento).  Pero los botones mec√°nicos contribuyeron, el traqueteo de los contactos condujo a fallas constantes e impredecibles (los algoritmos de control que invent√© funcionaron de manera imperfecta).  Entonces mi colega me cont√≥ c√≥mo se hacen los teclados.  Y decid√≠ hacer lo mismo, ahora sondeo el estado cada 0.005 segundos (por qu√© y qui√©n sabe).  Y si ha cambiado, env√≠e el valor al servidor. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">0.005</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.pins : p = self.pins[pin] status = p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> GPIO.input(pin) == GPIO.HIGH : p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] != status : p[<span class="hljs-string"><span class="hljs-string">'callback'</span></span>](pin) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyboardInterrupt: GPIO.cleanup()</code> </pre><br><h3 id="42-dzhoystik">  4.2 Joystick </h3><br><p>  <strong>La lectura de las lecturas</strong> se realiza a trav√©s de la placa <strong>ADS1115 a</strong> trav√©s del bus I2C, por lo tanto, la biblioteca adecuada es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Adafruit_PCA9685</a> .  El joystick tambi√©n es propenso a charlar, por lo que tomo lecturas por analog√≠a con el teclado. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: X = self.adc.read_adc(<span class="hljs-number"><span class="hljs-number">0</span></span>, gain=self.GAIN) / HardwareSetting.valueStep Y = self.adc.read_adc(<span class="hljs-number"><span class="hljs-number">1</span></span>, gain=self.GAIN) / HardwareSetting.valueStep <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> X &gt; HardwareSetting.xZero : X = X - HardwareSetting.xZero <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : X = <span class="hljs-number"><span class="hljs-number">-1</span></span> * (HardwareSetting.xZero - X) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Y &gt; HardwareSetting.yZero : Y = Y - HardwareSetting.yZero <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : Y = <span class="hljs-number"><span class="hljs-number">-1</span></span> * (HardwareSetting.yZero - Y) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(X) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) : X = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(Y) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) : Y = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(self.x - X) &gt;= <span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abs(self.y - Y) &gt;= <span class="hljs-number"><span class="hljs-number">1.0</span></span>) : self.sendCmd(round(X), round(Y)) self.x = X self.y = Y time.sleep(<span class="hljs-number"><span class="hljs-number">0.005</span></span>)</code> </pre> <br><p>  Cuando se alimenta desde 3.3 voltios, el rango de valores que el ADS1115 entrega con un joystick de 0 ... 26500.  Traigo esto al rango de -100 ... 100.  En mi rango alrededor de 0 siempre fluct√∫a, por lo que si los valores no exceden de 5, entonces considero que es 0 (de lo contrario, se inundar√°).  Tan pronto como cambien los valores, env√≠elos a la m√°quina de escribir. </p><br><h3 id="43-podklyuchenie-k-serveru-upravleniya">  4.3 Conexi√≥n al servidor de administraci√≥n </h3><br><p>  Conectarse al servidor es una cosa simple: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> : tcpClient = socket.socket(socket.AF_INET, socket.SOCK_STREAM) tcpClient.settimeout(<span class="hljs-number"><span class="hljs-number">2.0</span></span>) tcpClient.connect((conf.conf.ServerIP, conf.conf.controlServerPort)) self.signalDisplayPrint.emit(<span class="hljs-string"><span class="hljs-string">"+"</span></span>) carStatus.statusRemote[<span class="hljs-string"><span class="hljs-string">'network'</span></span>][<span class="hljs-string"><span class="hljs-string">'control'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.tcpClient = tcpClient <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> socket.error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: self.signalDisplayPrint.emit(<span class="hljs-string"><span class="hljs-string">"-"</span></span>) carStatus.statusRemote[<span class="hljs-string"><span class="hljs-string">'network'</span></span>][<span class="hljs-string"><span class="hljs-string">'control'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> time.sleep(conf.conf.timeRecconect) self.tcpClient = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.tcpClient : self.tcpClient.settimeout(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>)</code> </pre> <br><p>  Pero quiero prestar atenci√≥n a una cosa.  Si no usa el tiempo de espera en la conexi√≥n, se puede congelar y tendr√° que esperar unos minutos (esto sucede cuando el cliente se inici√≥ antes que el servidor).  Resolv√≠ esto de la siguiente manera, configur√© el tiempo de espera para la conexi√≥n.  Tan pronto como se produce la conexi√≥n, elimino el tiempo de espera. </p><br><p>  Tambi√©n almaceno el estado de la conexi√≥n, para saber si se pierde el control y mostrarlo en la pantalla. </p><br><h3 id="44-proverka-podklyucheniya-k-wifi">  4.4 Comprobaci√≥n de la conexi√≥n WiFi </h3><br><p>  Compruebo el estado de wifi para la conexi√≥n al servidor.  Y si, eso tambi√©n me notifico de problemas. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">1.0</span></span>) self.ps = subprocess.Popen([<span class="hljs-string"><span class="hljs-string">'iwgetid'</span></span>], stdout=subprocess.PIPE, stderr=subprocess.STDOUT) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: output = subprocess.check_output((<span class="hljs-string"><span class="hljs-string">'grep'</span></span>, <span class="hljs-string"><span class="hljs-string">'ESSID'</span></span>), stdin=self.ps.stdout) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> re.search(<span class="hljs-string"><span class="hljs-string">r'djvu-car-pi3'</span></span>, str(output)) : self.sendStatus(<span class="hljs-string"><span class="hljs-string">'wifi+'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> subprocess.CalledProcessError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> self.sendStatus(<span class="hljs-string"><span class="hljs-string">'wifi-'</span></span>) self.ps.kill()</code> </pre> <br><h3 id="45-podklyuchenie-k-video-serveru">  4.5 Conexi√≥n a un servidor de video </h3><br><p>  Para esto, <strong>se necesitaba</strong> todo el poder de <strong>Qt5</strong> , por cierto en la distribuci√≥n <strong>Stretch</strong> es m√°s nuevo y en mi opini√≥n se muestra mejor.  en <strong>Jessie</strong> tambi√©n lo intent√©. </p><br><p>  Para la exhibici√≥n us√©: </p><br><pre> <code class="python hljs">self.videoWidget = QVideoWidget()</code> </pre> <br><p>  Y dedujo: </p><br><pre> <code class="python hljs">self.mediaPlayer = QMediaPlayer(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, QMediaPlayer.LowLatency) self.mediaPlayer.setVideoOutput(self.videoWidget)</code> </pre> <br><p>  Conexi√≥n a la transmisi√≥n de video: </p><br><pre> <code class="python hljs">self.mediaPlayer.setMedia(QMediaContent(QUrl(<span class="hljs-string"><span class="hljs-string">"http://{}:{}/?action=stream"</span></span>.format(conf.conf.ServerIP, conf.conf.videoServerPort)))) self.mediaPlayer.play()</code> </pre> <br><p>  Una vez m√°s, me disculpo por la tautolog√≠a).  Superviso el estado de la conexi√≥n de video para la conexi√≥n al servidor de video.  Y si, eso tambi√©n me notifico de problemas. </p><br><p>  As√≠ es como se ve cuando todo no funciona: </p><br><p><img src="https://habrastorage.org/webt/ea/6a/ug/ea6augn3vrdv3ejjom8v6qrnpvu.jpeg" alt="imagen"></p><br><ul><li>  <strong>W</strong> : significa que no hay conexi√≥n con wifi </li><li>  <strong>B</strong> - significa que no hay video </li><li>  <strong>Y</strong> - significa que no hay control </li></ul><br><p>  De lo contrario, no hay letras rojas, hay un video de la c√°mara.  Publicar√© una foto y un video con el trabajo en el futuro) Espero que el soporte para la c√°mara venga en un futuro pr√≥ximo y finalmente lo adjuntar√© normalmente. </p><br><h3 id="5-nastroyka-raspberry-os">  5 Configuraci√≥n del sistema operativo Raspberry </h3><br><p>  Por cierto, el trabajo con la c√°mara y otras cosas necesarias deben estar activadas (tanto en el cliente como en el servidor).  Despu√©s de cargar el sistema operativo: </p><br><p><img src="https://habrastorage.org/webt/ex/ye/gz/exyegz24x9ec0ee0cdp7qpm5kog.jpeg" alt="imagen"></p><br><p>  Y encienda casi todo: c√°mara, ssh, i2c, gpio </p><br><p><img src="https://habrastorage.org/webt/ye/fu/z4/yefuz4_ioqh5g1j_f1n1mgwf_cg.png" alt="imagen"></p><br><h3 id="demonstraciya">  Demostraci√≥n </h3><br><p>  Solo hay un canal de video (la c√°mara permanece en funcionamiento).  Pido disculpas por su ausencia, lo adjuntar√© el lunes. </p><br><img alt="Sombrero de juego" width="400" src="https://habrastorage.org/webt/5q/yt/ox/5qytoxmp0ojxi7bheduksv8qipg.jpeg"><br><p>  Video de trabajo: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/D6ZT90L6q00" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3 id="ishodnye-kody">  C√≥digo fuente </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C√≥digo fuente del servidor y del cliente</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Paquete de inicio del servidor Daemon</a> </p><br><h3 id="ssylki">  Referencias </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 1</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 3</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/462331/">https://habr.com/ru/post/462331/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../462321/index.html">SEO internacional | Factores de posicionamiento SEO internacional</a></li>
<li><a href="../462323/index.html">Obesidad: rel√°jese y participe</a></li>
<li><a href="../462325/index.html">Web Worker m√°s f√°cil de lo que pensabas</a></li>
<li><a href="../462327/index.html">Chirrido de un tumor canceroso: los cient√≠ficos de NUST "MISiS" han desarrollado un ultrasonido l√°ser para el diagn√≥stico de c√°ncer</a></li>
<li><a href="../462329/index.html">Mover la fuente de alimentaci√≥n a la parte frontal del chasis</a></li>
<li><a href="../462333/index.html">Crear un chatbot de conversaci√≥n simple en python</a></li>
<li><a href="../462335/index.html">No leer, releer</a></li>
<li><a href="../462337/index.html">Estad√≠sticas del sitio y tu peque√±o repositorio</a></li>
<li><a href="../462339/index.html">¬øC√≥mo se relaciona la capacitaci√≥n manual con los est√°ndares internos de Amazon y c√≥mo ha impactado la visi√≥n del mundo de la compa√±√≠a?</a></li>
<li><a href="../462347/index.html">Los primeros diez d√≠as en el camino de un b√∫ho a un madrugador: sue√±o, dieta, dieta y ejercicio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>