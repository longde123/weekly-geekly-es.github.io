<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤜🏿 📞 👩🏼‍🏫 Tutoriel DataPower 💖 🐼 😸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Matériel co-écrit par Wedmeed 


 En 2017, lorsque notre projet a commencé au Vietnam, nous avons rencontré la nouvelle bête IBM DataPower pour nous. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tutoriel DataPower</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/neoflex/blog/442686/"><p>  Matériel co-écrit par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Wedmeed</a> </p><br><p> En 2017, lorsque notre projet a commencé au Vietnam, nous avons rencontré la nouvelle bête IBM DataPower pour nous.  IBM DataPower est un produit de passerelle entre les clients et les backends conçu pour le filtrage, le routage, l'enrichissement ou d'autres transformations des messages qui le traversent (ci-après dénommées requêtes).  Il fallait apprendre rapidement, il n'y avait pas de temps pour l'accumulation, donc on nous a demandé de nous familiariser avec, après quoi il y a eu de nombreuses heures de conférence Skype avec notre collègue de Moscou, qui nous a transmis ses connaissances et son expérience avec ce produit. <br></p><br><p>  L'autoformation était basée sur l'étude de la documentation et le visionnage de vidéos de formation sur Internet - et ici j'attendais une prise.  Je n'ai pratiquement pas pu trouver d'informations en russe.  Soit dit en passant, ma connaissance de la langue anglaise à cette époque n'était pas au plus haut niveau, d'ailleurs c'était mon premier projet et, probablement, ces facteurs ont compliqué ma vie.  Cela m'a fait écrire un article de formation en russe et de la manière la plus simple possible pour les développeurs débutants qui sont tombés sur ce produit et essaient de comprendre rapidement ses bases.  L'article ne vous libérera pas de la lecture de la documentation, mais il vous facilitera la vie dans les premiers stades de la compréhension de «comment cela fonctionne». <br></p><br><p>  Il convient également de noter que la structure donnée dans la pratique sera proche du projet réel, ce qui vous permettra de l'utiliser comme base, d'élargir et de compléter vos besoins.  En conclusion, quelques mots sur le projet déjà mis en œuvre, ainsi que certaines fonctionnalités qui méritent une attention particulière, seront donnés aux sections Théorie. </p><br><img src="https://habrastorage.org/webt/rm/at/lk/rmatlkcfuvcjxvgireijushp7yc.jpeg"><br><a name="habracut"></a><br><h2>  Partie 1. Installation de DataPower avec la boîte à outils Docker </h2><br><p>  Installez et exécutez l'application Docker Toolbox.  Immédiatement après le démarrage, vous verrez l'adresse IP de la machine, à travers laquelle DataPower sera disponible plus tard: <br></p><br><img src="https://habrastorage.org/webt/zs/qa/wn/zsqawn2jksqp8j8gfl5gwslnks4.png"><br><br><p>  Pour démarrer l'image, vous devez modifier certains paramètres de la machine virtuelle (pertinents pour la version IDG.2018.4.1.0) et la redémarrer: <br></p><br><ol><li>  Arrêtez la machine docker avec la commande: <br><br><pre><code class="plaintext hljs">docker-machine stop</code> </pre> </li><li>  Système -&gt; Carte mère -&gt; Mémoire principale: minimum 4096 Mo; <br></li><li>  Système -&gt; Processeur: minimum 2; <br></li><li>  Affichage -&gt; Écran -&gt; Mémoire vidéo: au moins 128 Mo; <br></li><li>  Nous lançons la machine docker avec la commande: <br><br><pre> <code class="plaintext hljs">docker-machine start</code> </pre> <br>  <i>Remarque</i>  <i>Si vous êtes invité à redémarrer docker-machine env, exécutez:</i> <br><br><pre> <code class="plaintext hljs">docker-machine env</code> </pre> </li><li>  Ensuite, vous devez dégonfler l'image IBM DataPower: <br><br><pre> <code class="plaintext hljs">docker pull ibmcom/datapower</code> </pre> </li><li>  Lancez ensuite le conteneur Docker avec la commande suivante: <br><br><pre> <code class="plaintext hljs">docker run -it \ -v $PWD/config:/drouter/config \ -v $PWD/local:/drouter/local \ -e DATAPOWER_ACCEPT_LICENSE=true \ -e DATAPOWER_INTERACTIVE=true \ -p 9090:9090 \ -p 3630:3630 \ -p 9022:22 \ -p 7170:7170 \ --name idg \ ibmcom/datapower</code> </pre></li><li>  Après avoir terminé la commande, appuyez sur Entrée et entrez <b>admin / admin</b> comme nom d'utilisateur et mot de passe <br></li><li>  Pour démarrer l'interface de gestion Web, utilisez les commandes: <br><br><pre> <code class="plaintext hljs">co</code> </pre> <br>  et <br><br><pre> <code class="plaintext hljs">web-mgmt 0 9090</code> </pre> </li><li>  Après toutes ces étapes, exécutez dans le navigateur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://192.168.99.100:9090/</a> <br></li></ol><br><h2>  Partie 2. Domaines </h2><br><h3>  2.1.  Théorie </h3><br><p>  Les domaines dans DataPower vous permettent de séparer les outils d'administration et de développement, ainsi que d'assurer la sécurité. <br></p><br><p>  Après l'installation, il n'y a qu'un domaine par défaut à partir duquel les domaines d'application peuvent être créés.  Chaque domaine a sa propre configuration de paramètres. <br></p><br><p>  Certaines ressources et certains paramètres communs ne peuvent être définis que dans le domaine par défaut, notamment les interfaces réseau, les utilisateurs et le contrôle d'accès, les domaines d'application et autres. <br></p><br><p>  Un domaine d'application est une section de développement pour les services de traitement des demandes.  Les services qui y sont définis ne peuvent pas être partagés avec un autre domaine d'application.  Les domaines d'application peuvent être redémarrés séparément et indépendamment, sans avoir besoin d'un redémarrage complet de DataPower. <br></p><br><p>  Vous pouvez créer, redémarrer, réinitialiser, suspendre, renouveler ou supprimer des domaines.  Vous pouvez trouver des informations plus détaillées sur toutes les fonctionnalités d'administration dans la documentation officielle. <br></p><br><p>  Un peu sur le projet terminé.  Nous avons utilisé 3 domaines: <br></p><br><ul><li>  default - le domaine par défaut contenant les ressources et les paramètres partagés; </li><li>  trunk - le domaine principal contenant tout le nécessaire pour le traitement des demandes; </li><li>  paramètres - paramètres et domaine de sécurité, les fichiers locaux contiennent des informations sur les règles de routage des services et les paramètres de sécurité. </li></ul><br><p>  La nécessité de transférer tous les paramètres vers un domaine distinct est apparue dans le cadre de la recherche d'un chemin de déploiement plus simple.  Comme dans de nombreux projets, les environnements de développement, de test et de production ont été séparés, et le transfert vers un domaine de paramètres séparé nous a permis d'installer tous les domaines principaux de l'environnement de développement dans d'autres environnements via l'exportation / importation, sans risque de perdre les paramètres d'environnement. <br></p><br><h3>  2.2.  Pratique </h3><br><ul><li>  Dans le champ de recherche, entrez «domaine», sélectionnez «Domaine d'application» et cliquez sur «Ajouter» <br><img src="https://habrastorage.org/webt/uo/k_/gs/uok_gsaxjifcklt56rs9wmiujhm.png"></li><li>  Ici, vous devez spécifier le nom de domaine, commenter (si vous le souhaitez) et activer l'audit et la journalisation.  Remplissez les champs et appliquez les modifications <br><img src="https://habrastorage.org/webt/3b/6w/ts/3b6wtsfrlvxcxgb7jgpkmm6u1rq.png"></li><li>  De même, ajoutez un autre domaine "tronc" </li><li>  Allez à Examiner les modifications <br><img src="https://habrastorage.org/webt/p-/nh/cp/p-nhcpeur45dhrzahmpffom9pq8.png"></li><li>  et enregistrez la configuration du domaine <br><img src="https://habrastorage.org/webt/1u/8n/si/1u8nsi-zblkkqdsrpa7lnqcgw8g.png"></li><li>  Vous pouvez vérifier l'état des objets créés en accédant au domaine par défaut dans l'arborescence de navigation dans État -&gt; Principal -&gt; État de l'objet <br><img src="https://habrastorage.org/webt/uz/qo/q4/uzqoq4kek4qdgkfkhovrjmiridm.png"></li><li>  Choisissez <b><i>Afficher par: types</i></b> <br><img src="https://habrastorage.org/webt/fj/5_/6z/fj5_6zg-kidxhkt5as0omzfvsiw.png"></li><li>  Recherchez le domaine d'application dans la liste et vérifiez l'état des objets: chacun d'eux doit être enregistré, allumé et à l'état haut.  Si c'est le cas, passez au chapitre suivant. </li></ul><br><img src="https://habrastorage.org/webt/xa/ii/kj/xaiikjxfdhsy19lez-rxo2xmeug.png"><br><br><h2>  Partie 3. Gestionnaires de files d'attente </h2><br><p>  Le gestionnaire de files d'attente n'est pas un composant obligatoire d'IBM DataPower, mais c'est à travers l'exemple de MQ que vous pouvez montrer toute la puissance de ce produit.  Nous utiliserons MQ d'IBM.  Lors des tests décrits au chapitre 6, nous devrons envoyer un message au gestionnaire de files d'attente local.  Dans cet article, je vais le faire en utilisant l'utilitaire rfhutil, mais vous pouvez utiliser n'importe quelle méthode à votre disposition.  Pour les tests, vous devrez créer une connexion de DP à votre gestionnaire de files d'attente local à l'aide du gestionnaire de files d'attente MQ. </p><br><cut></cut><br><h3>  3.1.  Théorie </h3><br><p>  Le gestionnaire de files d'attente permet l'échange de données entre la passerelle et les gestionnaires de files d'attente distantes. </p><br><p>  Vous pouvez également configurer le groupe MQ Queue Manager, ce qui augmentera la tolérance aux pannes du système.  Cela peut être utile, par exemple, si vous souhaitez connecter le client à l'un des ensembles de gestionnaires de files d'attente de travail et, dans certains cas, que vous pouvez trouver dans la documentation officielle. </p><br><p>  D'après l'expérience du projet, une seule caractéristique doit être notée: à un moment donné, nous voulions essayer d'implémenter l'équilibrage de charge en utilisant DataPower, en particulier en utilisant des groupes de gestionnaires de files d'attente, mais en pratique, nous n'avons pas trouvé une telle opportunité.  Une autre solution consiste à créer un cluster de gestionnaires de files d'attente. </p><br><br><h3>  3.2.  Pratique </h3><br><h4>  3.2.1.  La préparation </h4><br><ol><li>  Installez WebSphere MQ; </li><li>  Créez un gestionnaire de files d'attente LOCAL_DP_QM local, accessible sur le port 3630; </li><li>  Configurer le canal DP.SVRCONN; <br><br><p>  Lors de la création d'une chaîne, les commandes suivantes peuvent vous être utiles: </p><br><pre> <code class="plaintext hljs">strmqm LOCAL_DP_QM /*  mq*/ runmqsc LOCAL_DP_QM /*   mq*/ DEFINE CHANNEL (DP.SVRCONN) CHLTYPE(SVRCONN) MCAUSER('evlasenko') /* */ SET CHLAUTH('DP.SVRCONN') TYPE(USERMAP) CLNTUSER('evlasenko') USERSRC(channel) ADDRESS('*') ACTION(ADD) /*      */ SET CHLAUTH(DP.SVRCONN) TYPE(BLOCKUSER) USERLIST('nobody') /*   */ ALTER LISTENER (SYSTEM.DEFAULT.LISTENER.TCP) TRPTYPE(TCP) PORT(3630) control(QMGR) /*    3630*/ ALTER AUTHINFO (SYSTEM.DEFAULT.AUTHINFO.IDPWOS) AUTHTYPE(IDPWOS) CHCKCLNT(OPTIONAL) /* */ REFRESH SECURITY TYPE(CONNAUTH) /*  */ endmqm LOCAL_DP_QM /*  mq*/ strmqm LOCAL_DP_QM /*  mq*/ END</code> </pre><br></li><li>  Créez les files d'attente DP.IIB.REQIN et DP.IIB.RESIN </li><li>  Exécutez rfhutil sous le nom de l'utilisateur pour lequel le canal a été créé.  Dans la ligne Nom du gestionnaire de files d'attente (pour vous connecter), écrivez: <br><br><pre> <code class="plaintext hljs">DP.SVRCONN/TCT/127.0.0.1(3630)</code> </pre> <br></li><li>  Essayez de charger la liste des noms de file d'attente; il ne devrait pas y avoir d'erreurs dans la fenêtre de message.  La connexion au canal a été vérifiée. <br></li></ol><br><h4>  3.2.2.  Créer IBM MQ Queue Manager </h4><br><ol><li>  Accédez au domaine de jonction. </li><li>  Dans la recherche, saisissez MQ, sélectionnez IBM MQ Queue Manager, puis cliquez sur Ajouter. </li><li>  Vous devez spécifier le nom (TEST_QM), le nom d'hôte du gestionnaire de files d'attente, le nom du gestionnaire de files d'attente et le nom du canal, ainsi que le délai d'expiration.  Configurez et enregistrez les modifications. <br><img src="https://habrastorage.org/webt/di/sg/x1/disgx1dt8szkq9uoicnlepcn9lg.png"><br></li></ol><br><p>  Vérifiez l'état de l'objet gestionnaire de files d'attente de la même manière que la vérification de l'état des domaines.  Pour ce faire, sélectionnez État de l'objet et le filtre Afficher par: types dans le domaine de jonction.  Dans la section "IBM MQ Queue Manager", recherchez l'objet approprié et vérifiez son état. </p><br><h2>  Partie 4. Passerelles multiprotocoles </h2><br><h3>  4.1.  Théorie </h3><br><p>  La passerelle multiprotocole (MPG) est une passerelle multiprotocole qui vous permet de recevoir des demandes de clients à l'aide de divers protocoles, puis de les transférer vers différents serveurs à l'aide de divers protocoles.  Le protocole utilisé par le client peut ne pas correspondre au protocole utilisé par le serveur d'accès distant. </p><br>  Dans les principaux paramètres MPG, vous pouvez définir les composants suivants: <br><br><ul><li>  XML Manager - contrôle la compilation et la mise en cache des feuilles de style (xsl, xslt), la mise en cache des documents. </li><li>  Stratégie - se compose de règles, chacune définissant un ensemble d'actions appliquées au message passant par la passerelle. </li><li>  Paramètres avant et arrière (réglage de l'URL, types de messages entrants et sortants, délais d'expiration et plus). </li></ul><br><p>  Quelques mots sur le projet: </p><br><p>  Le projet utilise 4 passerelles multiprotocoles (routage, 2 transformationnelles pour différents systèmes d'extrémité et une autre conçue pour recevoir des fichiers du domaine des paramètres).  Le diagramme ci-dessous montre le schéma d'interaction général: </p><br><img src="https://habrastorage.org/webt/p9/ea/yb/p9eayb25jpeoiazqjd0sitssuf4.png"><br><p>  La quantité de MPG peut varier en fonction de l'architecture de la solution dans son ensemble.  Dans notre cas, DataPower fait face à un bus d'intégration (IIB) et à des microservices, qui présentent des différences d'interfaces importantes (json / http contre xml / mq), il a donc été décidé de créer des MPG transformationnels pour chaque backend spécifique et de le nommer en conséquence.  Pour tous les clients, nous travaillons sur json / http, donc le routage MPG en est un.  Les principaux MPG sont constitués de 3 règles de traitement des messages - demande, réponse et erreurs.  Chaque règle comprend les actions nécessaires, telles que la transformation, la journalisation, le routage et autres. </p><br><p>  À partir des fonctionnalités - si dans la politique, vous utilisez l'action ConvertQueryParamToXML, alors soyez attentif à InputConversion.  Si vous définissez le codage par défaut sur JSON et essayez d'envoyer une demande GET, vous serez surpris de constater que le message n'a subi aucune transformation que vous avez spécifiée et vous n'en trouverez aucune trace.  Cette fonctionnalité aidera à surmonter la création d'une règle distincte pour les demandes GET. </p><br><h3>  4.2.  Pratique </h3><br><h4>  4.2.1.  La préparation </h4><br><p>  Vous pouvez trouver tous les fichiers nécessaires au travail sur le lien <a href="">https://github.com/EvgenyaVlasenko/IBM_DataPower.git</a> <br></p><h4>  4.2.1.1.  Tronc de domaine </h4><br><ol><li>  Accédez au domaine de jonction. </li><li>  Dans le panneau de configuration, sélectionnez Gestion des fichiers. </li><li>  Dans le répertoire local, créez la structure de répertoires suivante et placez-y les fichiers correspondants (chaque fichier contient une brève description des fonctions qu'il exécute, ainsi qu'une discussion plus détaillée à ce sujet plus loin dans l'article). <br><img src="https://habrastorage.org/webt/oj/am/i9/ojami90qdgg81ojuyr88pmeuzd0.png"><br></li></ol><br><h4>  4.2.1.2.  Paramètres de domaine </h4><br><ol><li>  Accédez au domaine des paramètres. </li><li>  Dans le panneau de configuration, sélectionnez Gestion des fichiers. </li><li>  Dans le répertoire local, créez la structure de répertoires suivante et placez-y les fichiers appropriés (les fichiers en contiennent également une brève description). <br><img src="https://habrastorage.org/webt/mf/9r/ne/mf9rnemyu8mcb01ad_wi6__ozj0.png"><br></li></ol><br><h3>  4.2.2.  Créer GetFileMPG </h3><br><p>  Tout d'abord, créez un MPG d'assistance simple qui retournera les fichiers du domaine des paramètres. </p><br><ol><li>  Accédez au domaine des paramètres. </li><li>  Dans le panneau de configuration, sélectionnez Passerelle multiprotocole et cliquez sur Créer. </li><li>  Spécifiez le nom (GetFileMPG), la description (facultatif) et le type de backend (dynamique).  En fait, puisqu'il n'y aura aucun appel au backend, et seul le fichier sera retourné depuis le système local, dans cet exemple, vous pouvez spécifier n'importe quel type de backend. <br><img src="https://habrastorage.org/webt/ds/g7/5g/dsg75gxvgo-7caldbmytubddg6i.png"><br></li><li>  Spécifiez les types de demande et de réponse.  La spécification explicite des types réduira le nombre de vérifications en ligne.  La spécification du type Pass through vous permet de ne pas créer de règle (dans ce cas, pour transformer la réponse).  Si nous spécifions que le type de demande est également transmis, nous ne pourrons en aucun cas traiter le message.  Cette option ne nous convient pas, nous limitons donc le type de demande à l'aide de Non-XML. <br><br><img src="https://habrastorage.org/webt/qx/nx/l_/qxnxl_j3ki9e8hcc215zropuix8.png"><br></li><li>  Cliquez sur + et sélectionnez le gestionnaire HTTP pour créer un nouveau protocole frontal. <br><br><img src="https://habrastorage.org/webt/dc/gq/pq/dcgqpqgpx284pxkoqdqhivwjbku.png"><br></li><li>  Ici, vous devez spécifier un nom, une adresse IP, un port et une liste des méthodes autorisées.  Faites attention à l'adresse IP.  Si vous spécifiez 0.0.0.0, tout le monde peut accéder à cette passerelle.  Si 127.0.0.1 - uniquement d'autres passerelles à l'intérieur du même DataPower.  Puisqu'il y a des paramètres de sécurité parmi les paramètres, nous utilisons la deuxième option.  Remplissez les champs et cliquez sur "Appliquer", le protocole sera automatiquement ajouté à la passerelle. <br><br><img src="https://habrastorage.org/webt/xn/y5/-r/xny5-rfrolidwemexqwg25-tkec.png"><br></li><li>  Cliquez sur + pour ajouter une nouvelle politique. <br><br><img src="https://habrastorage.org/webt/ju/y0/q6/juy0q6_osmjfnwd2v5xev97wvta.png"><br></li><li>  Remplissez le nom de la politique «GetFilePolicy». <br></li><li>  Créez une nouvelle règle, indiquez le nom et la direction de la règle.  Puisqu'il n'y a vraiment pas de backend et que seul le fichier souhaité est retourné, il n'y aura qu'une seule règle (client vers serveur). <br><br><img src="https://habrastorage.org/webt/cv/4c/z_/cv4cz_dfzc5sjxu4i7as6iluzne.png"><br></li><li>  Double-cliquez sur l'action Correspondance pour la configurer, sélectionnez une règle existante et appliquez les modifications.  Il serait idéologiquement correct de définir une restriction sur la capacité de recevoir uniquement des requêtes Get, mais dans le cadre de la tâche de formation, vous pouvez sélectionner celle existante. <br></li><li>  Ajoutez une autre action - GatewayScript en la faisant glisser sur la règle et en la configurant.  En tant que transformation, nous utiliserons le fichier préparé, qui dans le système de fichiers local: /// trouvera le fichier par son nom à partir de l'URI de la demande entrante et le placera dans le corps du message.  Le résultat de l'opération sera transféré directement dans le tampon de sortie de la règle.  Enregistrez les modifications. <br><br><img src="https://habrastorage.org/webt/ai/pr/va/aiprvaljftoye2gr5tf1xjf4s_u.png"><br></li><li>  Le résultat final de la politique devrait ressembler à ceci: <br><br><img src="https://habrastorage.org/webt/rm/q0/on/rmq0onkkkvygnyevy574vsgz3ns.png"><br></li><li>  La création de MPG est terminée, enregistrez les modifications. <br></li><li>  Vous pouvez vérifier le succès de sa création à l'aide de l'état de l'objet, comme pour vérifier l'état des domaines et le gestionnaire de files d'attente.  Pour ce faire, sélectionnez État de l'objet et le filtre Afficher par: services dans le domaine des paramètres.  Dans la section «Passerelle multiprotocole», recherchez l'objet correspondant et vérifiez son état. <br></li><li>  Vous ne pouvez pas appeler ce MPG de l'extérieur, car vous l'avez protégé avec ip.  Modifiez temporairement l'ip de 127.0.0.1 à 0.0.0.0 et le port de 7171 à 7170 et exécutez la requête suivante: <br><br><pre> <code class="plaintext hljs">curl -vv -k "http://192.168.99.100:7170/trunk/route/routeRules.xml"</code> </pre><br></li><li>  Vous devriez obtenir la réponse suivante: <br><br><img src="https://habrastorage.org/webt/e5/m8/3n/e5m83ngxz17e8lahsicaxs6lj5s.png"><br></li><li>  Encore une fois, changez l'ip et le port en 127.0.0.1:7171 d'origine. <br></li></ol><br><h4>  4.2.3.  Création de routageMPG </h4><br><p>  Créez maintenant RoutingMPG.  En fonction de la demande d'entrée et des règles de routage, il déterminera où et avec quels paramètres la demande doit être envoyée. </p><br><ol><li>  Accédez au domaine de jonction. </li><li>  Créez une nouvelle passerelle multiprotocole conformément aux clauses 2-10 de la section 4.2.2 en utilisant les valeurs suivantes: <br><ul><li>  3 - nom: RoutingMPG, type de backend: Dynamique (pour la possibilité d'acheminer les demandes vers différents MPG si nécessaire). </li><li>  4 - Rq: non xml, Rs: non xml. </li><li>  6 - nom: RoutingHTTP_FSH, ip: 0.0.0.0, port: 7170, + méthode Get. </li><li>  8 - nom: RoutingPolicy. </li><li>  9 - nom: RoutingPolicy_rule_req, direction: Client to Server. </li></ul><br></li><li>  Ajoutez une action supplémentaire pour acheminer la demande. Pour ce faire, faites glisser l'action "Acheminer" sur la règle, double-cliquez dessus pour la configurer, remplissez les champs et appliquez les modifications.  Le fichier route.xsl reçoit le fichier de paramètres de routage du domaine de paramètres via GetFileMPG créé précédemment.  Après cela, en fonction de l'URI, les paramètres nécessaires à cette opération sont déjà sélectionnés dans le fichier.  Certains d'entre eux sont utilisés pour le routage, et certains sont ajoutés aux en-têtes pour une utilisation dans d'autres MPG.  Les paramètres d'entrée et de sortie déterminent la façon de travailler uniquement avec le corps du message et n'affectent en aucune façon les en-têtes et les variables.  Par conséquent: entrée de null - puisque les informations du corps du message ne sont pas utilisées pour le routage.  La sortie est nulle - car le résultat de la transformation n'est qu'un changement dans les informations de service. <br><br><img src="https://habrastorage.org/webt/bb/q0/nh/bbq0nh2dtogav5pyfoeneb3t66m.png"><br></li><li>  De même, créez 2 règles supplémentaires et enregistrez toutes les modifications: <br><ul><li>  Direction: Server-Client, nom: RoutingPolicy_rule_resp; <br>  Transformation: entrée INPUT, sortie NULL, fichier de transformation local: ///RoutingMPG/transform/resp.xslt.  Le fichier resp.xslt reçoit le statut http de la réponse MPG de transformation et le définit explicitement sur la réponse RoutingMPG.  Si cela n'est pas fait, le code par défaut sera défini sur 200, même si une erreur s'est produite dans la transformation MPG. <br></li><li>  Direction: Erreur, nom: RoutingPolicy_rule_error; <br>  Transformation: Input INPUT, Output PIPE (selon la documentation, l'utilisation de PIPE entre deux nœuds d'action adjacents comme INPUT et OUTPUT peut éliminer le traitement supplémentaire et réduire la quantité de mémoire utilisée), le fichier de transformation est local: ///RoutingMPG/transform/errors.xsl.  Le fichier errors.xsl reçoit le code d'erreur et le texte de la réponse de la transformation MPG et génère un message d'erreur JSON au format attendu par le client. <br></li></ul><br></li><li>  Le résultat final de la politique devrait ressembler à ceci: <br><br><img src="https://habrastorage.org/webt/um/kx/x-/umkxx-3kwx3hi1dzmc1e80ko-wa.png"><br></li><li>  La création de MPG est terminée, enregistrez les modifications. <br></li><li>  À l'aide, par exemple, de l'utilitaire curl, exécutez la requête suivante: <br><br><pre> <code class="plaintext hljs">curl -vv -k "http://192.168.99.100:7170/dp/test/transformMessage"</code> </pre> <br></li><li>  Si vous obtenez l'erreur suivante, alors tout est fait correctement.  Cette erreur signifie que le message a été reçu et traité avec succès, mais la tentative d'appel du backend (dans ce cas IIBMPG) a échoué.  Passez à l'étape suivante. <br><br><img src="https://habrastorage.org/webt/8g/iq/tl/8giqtlzspsyix66vnl7mkcxnelk.png"><br></li></ol><br><h4>  4.2.4.  Création de IIBMPG </h4><br><p>  L'étape suivante consiste à créer un MPG transformationnel.  Supposons que le système externe soit au format de requête JSON et que le interne soit XML.  Nous devons transformer le message d'entrée afin que le système interne puisse le comprendre.  Il convient de noter qu'il ne s'agit pas toujours d'une simple conversion de l'ensemble du message.  Il est souvent nécessaire de transmettre un message tronqué ou augmenté, parfois avec une structure complètement repensée. </p><br><ol><li>  Accédez au domaine de jonction. </li><li>  Créez une nouvelle passerelle multiprotocole conformément aux clauses 2-10 de la section 4.2.2 en utilisant les valeurs suivantes: <br><ul><li>  3 - nom: IIBMPG, type de backend: dynamique </li><li>  4 - Rq: JSON, Rs: XML </li><li>  6 - nom: IIBHTTP_FSH, ip: 127.0.0.1 (uniquement les requêtes du même DataPower), port: 7172, + méthode Get </li><li>  8 - Nom: IIBPolicy </li><li>  9 - nom: IIBPolicy_rule_req, direction: Client to Server </li></ul><br></li><li>  Ajoutez une description.  En fonction du nom X-DP-Transform-Name dans les en-têtes de demande, le fichier IIBRuleRoute.xsl reçoit du fichier local: ///IIB/route/IIBRouteRules.xml les noms des fichiers de transformation de demande, de réponse et d'erreur pour ce service et définit leurs valeurs dans les variables de contexte correspondantes var: // context / IIB / reqTransform, var: // context / IIB / ansTransform, var: // context / IIB / errTransform.  D'autres valeurs des en-têtes (url, uri, expire, timeout) sont également placées dans des variables de contexte. <br><br><img src="https://habrastorage.org/webt/xo/6b/ek/xo6bekae8dsumpvosfe5xnbhneg.png"><br></li><li>  Ajoutez une autre action en faisant glisser Avancé vers votre règle et en sélectionnant Convertir les paramètres de requête en XML dans la liste, configurez.  Vous devez ajouter une nouvelle mappe de conversion d'entrée, en lui donnant un nom (cmnJSONParseCNVM) et le type requis (JSON). <br><br><img src="https://habrastorage.org/webt/ir/az/gb/irazgbszkybdgjkor1otjvrllqc.png"><br><br><img src="https://habrastorage.org/webt/yd/tk/2x/ydtk2xhbveh4j6z1gsweidcyhak.png"><br></li><li>  Ajoutez la transformation après la conversion standard et configurez-la.  Dans ce cas, la variable définie dans la transformation précédente est utilisée pour indiquer le fichier de transformation.  Cette opération est effectuée de manière à ce que la transformation soit universelle et que le fichier lui-même soit remplacé "à la volée" en fonction du message d'entrée.  Le corps du message est prêt.  L'étape suivante consiste à router le message, et le corps du message ne changera pas, nous créons donc la variable dpvar_1 et y enregistrons le résultat.  C'est cette variable que nous désignons l'entrée de l'action Résultats.  Enregistrez les modifications. <br><br><img src="https://habrastorage.org/webt/yz/cf/do/yzcfdogrjturkuvvmqx7bio_ex4.png"><br></li><li>  Ajoutez une action de routage et définissez les paramètres suivants.  Le fichier IIBURLRoute.xsl reçoit les valeurs des variables de contexte, certaines d'entre elles sont définies comme variables de demande de service, et à partir du reste, il forme un URI pour la demande au système de destination, qui stocke également dans la variable de service. <br><br><img src="https://habrastorage.org/webt/kl/vk/cf/klvkcfgcro60wznqwo0ibxdncys.png"><br></li><li>  De même, créez 2 règles supplémentaires et enregistrez toutes les modifications: <br><ul><li>  Direction: Server-Client, nom: IIBPolicy_rule_resp; <br>  Transformation: Entrée INPUT, Sortie PIPE, fichier de transformation var: // context / IIB / ansTransform (variable de contexte pour substituer la transformation de la réponse "à la volée"). </li><li>  Direction: Erreur, nom: IIBPolicy_rule_error; <br>  Transformation: entrée NULL, sortie PIPE, fichier de transformation var: // context / IIB / errTransform (variable de contexte pour remplacer la transformation d'erreur à la volée). </li></ul><br></li><li>  Le résultat final de la politique devrait ressembler à ceci: <br><img src="https://habrastorage.org/webt/qi/d9/7u/qid97ursvmwifemzxbfdtudjkjc.png"><br></li><li>  La création de MPG est terminée, enregistrez les modifications. <br></li></ol><br><h2>  Partie 5. Test </h2><br><h3>  5.1.  La préparation </h3><br><ol><li>  Téléchargez, par exemple, l'utilitaire rfhutil pour lire et écrire des messages dans la file d'attente; </li><li>  Les fichiers de test se trouvent dans le dossier tests du même répertoire que les fichiers de projet. </li></ol><br><h3>  5.2.  Bilan de santé </h3><br><ol><li>  Envoyez la demande à l'aide de l'utilitaire curl (pour la demande ci-dessous, le répertoire en cours doit être le même que example.json). <br><br><pre> <code class="plaintext hljs">curl -vv -k "http://192.168.99.100:7170/dp/test/transformMessage" -H "Content-Type: application/json" --data-binary @example.json</code> </pre> <br></li><li>  Ouvrez 2 instances de l'utilitaire rfhutil et soustrayez le message de la file d'attente DP.IIB.REQIN avec la première instance; <br></li><li>  Accédez à l'onglet MQMD et copiez le MessageID; <br></li><li>  Dans la deuxième instance, ouvrez le fichier rs.xml, dans l'onglet MQMD, insérez l'identifiant de message dans CorrelID et placez le message dans la file d'attente DP.IIB.RESIN; <br></li><li>  Vous devriez obtenir une réponse similaire: <br><br><img src="https://habrastorage.org/webt/mn/kj/xj/mnkjxj0lyafkvo7hjgpyytuytee.png"><br></li><li>  Répétez les étapes 1 à 3; <br></li><li>      rs_error.xml       correllId; <br></li><li>     <br><br><img src="https://habrastorage.org/webt/_y/i5/hb/_yi5hbw1lnrfwsuryyln9z3rdic.png"><br></li></ol><br><h2>  6.  </h2><br><h3> 6.1.  Théorie </h3><br><p> Log Targets   ,         . <br></p><br><p>     Log Targets    .     ,      4     1000Kb,      .              2-4    .       ,        .  , DataPower,  , ,   ,        ,      ,      -  MPG,     . <br></p><br><h3> 6.2.  </h3><br><ol><li>    trunk; </li><li>    Log Target   ; </li><li>      : <br><ul><li> (IIB_LOG); </li><li> (File); </li><li>  (Text); </li><li>  timestamp(zulu); </li><li>   (logtemp:///IIB.log —  IIBMPG); </li><li>  (1000). <br><img src="https://habrastorage.org/webt/ev/sm/mj/evsmmjxy8m6suwkbaeojvgcudf8.png"><br></li></ul><br></li><li>   .        MPG   IIBMPG. <br><br><img src="https://habrastorage.org/webt/lq/vl/5l/lqvl5lvc_w8powdnufq6emgjgwc.png"><br></li><li>    ,     ,    (  ,        ). <br><br><img src="https://habrastorage.org/webt/ia/tu/98/iatu98v3l0fioelwktk8uwu-6fw.png"><br></li><li>         ; <br></li><li>    ; <br></li><li>          . <br></li><li>      Log Targets    MPG. <br></li><li>   : <br><ul><li>             , ,         . <br><br><img src="https://habrastorage.org/webt/z2/ix/vt/z2ixvtjk8eidxsfbbe6mmfcecnc.png"><br></li><li>        . <br><br><img src="https://habrastorage.org/webt/go/ik/wl/goikwl1pdvlzhiyd_d7gqpffzo8.png"><br></li></ul><br></li></ol><br><h2>  7.  -    </h2><br><ol><li>       –  ,   .    –  ,   ,     -    . <br></li><li>      .       View Logs.      ,  «  », «   »     . <br></li><li>       .           .       MPG       Show Probe -&gt; Enable Probe.         .   ,        . <br><br><img src="https://habrastorage.org/webt/re/6s/mh/re6smhejkm-i8cdmmeky6ch6cmy.png"><br></li><li>   ,      . <br></li></ol><br><p>     –    . <br></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr442686/">https://habr.com/ru/post/fr442686/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr442674/index.html">Instances de sécurité des informations sur la plateforme attackdefense.com</a></li>
<li><a href="../fr442676/index.html">Où les rêves mènent: souterrain</a></li>
<li><a href="../fr442678/index.html">Plus grand projet en stéréolithographie: squelette de mammouth imprimé sur une imprimante 3D</a></li>
<li><a href="../fr442680/index.html">Les technologies de remplacement sensoriel vous permettront de voir le monde à l'aide des sons: comment fonctionne la neuroplasticité du cerveau humain</a></li>
<li><a href="../fr442684/index.html">Performance du site équilibrée. Partie 3: Contenu</a></li>
<li><a href="../fr442688/index.html">L'analyse des données Scala - un besoin urgent ou une opportunité agréable?</a></li>
<li><a href="../fr442690/index.html">Mission lunaire "Bereshit" - selfie sur le fond de la Terre</a></li>
<li><a href="../fr442692/index.html">Blockchain sans intermédiaires: comment nous avons envoyé des titres à un registre distribué</a></li>
<li><a href="../fr442694/index.html">L'un des géants du streaming lancé en Inde et a attiré un million d'utilisateurs en une semaine</a></li>
<li><a href="../fr442696/index.html">S for Security: Internet Security of Things and reports at InoThings ++ 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>