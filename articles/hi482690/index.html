<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯСйЁЯП╛тАНтЪЦя╕П ЁЯСЖ ЁЯСиЁЯП╝тАНЁЯОд Combine рдореЗрдВ рдЕрдкрдирд╛ Publisher рдмрдирд╛рдПрдБ ЁЯЩЖЁЯП╜ ЁЯШЯ ЁЯЪЖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдЖрдЬ рдореИрдВ рдЖрдкрдХреЛ рдПрдкреНрдкрд▓ рдХреЗ рдирдП рдХреЙрдореНрдмрд┐рдиреЗрд╢рди рдврд╛рдВрдЪреЗ рдореЗрдВ рдЕрдкрдирд╛ рдЦреБрдж рдХрд╛ рдкреНрд░рдХрд╛рд╢рдХ рдмрдирд╛рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рдмрддрд╛рдирд╛ рдЪрд╛рд╣реВрдВрдЧрд╛ред 


 рдФрд░ рдЗрд╕рд▓рд┐рдП, рд╢реБрд░реБрдЖрдд рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ рдпрд╛рдж рдХрд░рдиреЗ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Combine рдореЗрдВ рдЕрдкрдирд╛ Publisher рдмрдирд╛рдПрдБ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482690/"><p><img src="https://habrastorage.org/webt/yu/vm/d7/yuvmd7t0eg1ws5pi_ahqklv9bba.png"></p><br><p>  рдЖрдЬ рдореИрдВ рдЖрдкрдХреЛ рдПрдкреНрдкрд▓ рдХреЗ рдирдП рдХреЙрдореНрдмрд┐рдиреЗрд╢рди рдврд╛рдВрдЪреЗ рдореЗрдВ рдЕрдкрдирд╛ рдЦреБрдж рдХрд╛ рдкреНрд░рдХрд╛рд╢рдХ рдмрдирд╛рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рдмрддрд╛рдирд╛ рдЪрд╛рд╣реВрдВрдЧрд╛ред </p><a name="habracut"></a><br><p>  рдФрд░ рдЗрд╕рд▓рд┐рдП, рд╢реБрд░реБрдЖрдд рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ рдпрд╛рдж рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ рдХреИрд╕реЗ рдЧрдардмрдВрдзрди рдХреЗ рдореВрд▓ рднрд╛рдЧ рдПрдХ рджреВрд╕рд░реЗ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░рддреЗ рд╣реИрдВ, рдЕрд░реНрдерд╛рддреН рдкреНрд░рдХрд╛рд╢рдХ, рд╕рджрд╕реНрдпрддрд╛, рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ред </p><br><ul><li>  рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдкреНрд░рдХрд╛рд╢рдХ рд╕реЗ рдЬреБрдбрд╝рддрд╛ рд╣реИ </li><li>  рдкреНрд░рдХрд╛рд╢рдХ рд╕рджрд╕реНрдпрддрд╛ рд╕рджрд╕реНрдп рдХреЛ рднреЗрдЬрддрд╛ рд╣реИ </li><li>  рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рд╕реЗ рдПрди рдорд╛рди рдорд╛рдВрдЧрддрд╛ рд╣реИ </li><li>  рдкреНрд░рдХрд╛рд╢рдХ рдПрди рдорд╛рди рдпрд╛ рдХрдо рднреЗрдЬрддрд╛ рд╣реИ </li><li>  рдкреНрд░рдХрд╛рд╢рдХ рдПрдХ рдкреВрд░реНрдг рд╕рд┐рдЧреНрдирд▓ рднреЗрдЬрддрд╛ рд╣реИ </li></ul><br><h1 id="publisher">  рдкреНрд░рдХрд╛рд╢рдХ </h1><br><p>  рддреЛ рдЪрд▓рд┐рдП рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИ рд╣рдорд╛рд░рд╛ рдкрдмреНрд▓рд┐рд╢рд░ рдмрдирд╛рдирд╛ред  Apple рдкреНрд░рд▓реЗрдЦрди рдХреА рдУрд░ рдореБрдбрд╝рддреЗ рд╣реБрдП, рд╣рдо рджреЗрдЦреЗрдВрдЧреЗ рдХрд┐ <a href="https://developer.apple.com/documentation/combine/publisher">рдкреНрд░рдХрд╛рд╢рдХ</a> рдПрдХ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╣реИред </p><br><pre><code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> : <span class="hljs-type"><span class="hljs-type">Error</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Self</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Self</span></span>.<span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> }</code> </pre> <br><p>  рдЬрд╣рд╛рдВ рдЖрдЙрдЯрдкреБрдЯ рдЗрд╕ рдкреНрд░рдХрд╛рд╢рдХ рджреНрд╡рд╛рд░рд╛ рдкрд╛рд░рд┐рдд рдХрд┐рдП рдЧрдП рдорд╛рдиреЛрдВ рдХрд╛ рдкреНрд░рдХрд╛рд░ рд╣реИ, рд╡рд┐рдлрд▓рддрд╛ рд╡рд┐рдлрд▓рддрд╛ рдХрд╛ рдкреНрд░рдХрд╛рд░ рд╣реИ рдЬрд┐рд╕реЗ рддреНрд░реБрдЯрд┐ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдкрд╛рд▓рди рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред </p><br><p>  рдФрд░ рдкреНрд░рд╛рдкреНрдд рд╕рдорд╛рд░реЛрд╣ (_: рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░), рдЬрд┐рд╕реЗ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХреЛ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ рд╕рджрд╕реНрдпрддрд╛ (_ :) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗред </p><br><p>  рдПрдХ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд░реВрдк рдореЗрдВ, рд╣рдо рдкреНрд░рдХрд╛рд╢рдХ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВ, рдЬреЛ рд╣рдорд╛рд░реЗ рд▓рд┐рдП <a href="https://en.wikipedia.org/wiki/Fibonacci_number">рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐ рд╕рдВрдЦреНрдпрд╛</a> рдЙрддреНрдкрдиреНрди рдХрд░реЗрдЧрд╛ред </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciPublisher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> }</code> </pre> <br><p>  рдЪреВрдВрдХрд┐ рдЕрдиреБрдХреНрд░рдо рдореЗрдВ рд╕рдВрдЦреНрдпрд╛рдПрдБ рд╣реЛрддреА рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдЖрдЙрдЯрдкреБрдЯ рдХрд╛ рдкреНрд░рдХрд╛рд░ Int рд╣реЛрдЧрд╛, рдФрд░ рд╡рд┐рдлрд▓рддрд╛ рд╡рд┐рд╢реЗрд╖ рдкреНрд░рдХрд╛рд░ рдХреА Never рд╣реЛрдЧреА, рдпрд╣ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдкреНрд░рдХрд╛рд╢рдХ рдХрднреА рд╡рд┐рдлрд▓ рдирд╣реАрдВ рд╣реЛрдЧрд╛ред </p><br><p>  рд▓рдЪреАрд▓реЗрдкрди рдХреЗ рд▓рд┐рдП, рд╣рдо рдЙрди рддрддреНрд╡реЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдкрд░ рд╕реАрдорд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рд╣рдо рдЕрдкрдиреЗ рдкреНрд░рдХрд╛рд╢рдХ рдХреЗ рдХреБрдЫ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ рдЗрд╕ рдорд╛рди рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдФрд░ рд▓рдкреЗрдЯрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">UInt</span></span> }</code> </pre> <br><p>  рдЖрдЗрдП рдЗрд╕ рдХреЛрдб рдкрд░ рдПрдХ рдХрд░реАрдм рд╕реЗ рдирдЬрд╝рд░ рдбрд╛рд▓реЗрдВ, var count: UInt рдПрдХ рдЕрдЪреНрдЫреЗ рд╡рд┐рдХрд▓реНрдк рдХреА рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣рдореЗрдВ рдЯрд╛рдЗрдк UInt рдХреЗ рдорд╛рдиреНрдп рдорд╛рдиреЛрдВ рдХреА рд╕реАрдорд╛ рддрдХ рд╕реАрдорд┐рдд рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдпрд╣ рднреА рд╕реНрдкрд╖реНрдЯ рдирд╣реАрдВ рд╣реИ рдХрд┐ рдпрджрд┐ рд╣рдо рдЕрднреА рднреА рдЕрд╕реАрдорд┐рдд рдЕрдиреБрдХреНрд░рдо рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рдХреНрдпрд╛ рдЗрдВрдЧрд┐рдд рдХрд░реЗрдВред </p><br><p>  UInt рдХреЗ рдмрдЬрд╛рдп, рд╣рдо Subscribers.Demand рдкреНрд░рдХрд╛рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ, рдЬреЛ рдХрд┐ Combine рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рдЗрд╕реЗ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рд╕реЗ рдкреНрд░рдХрд╛рд╢рдХ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдХрд╛рд╢рдХ рдХреЛ рднреЗрдЬреЗ рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдкреНрд░рдХрд╛рд░ рдХреЗ рд░реВрдк рдореЗрдВ рднреА рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  рд╕рд░рд▓ рд╢рдмреНрджреЛрдВ рдореЗрдВ, рдпрд╣ рддрддреНрд╡реЛрдВ рдХреА <em>рдЖрд╡рд╢реНрдпрдХрддрд╛</em> рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ, рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рджреНрд╡рд╛рд░рд╛ рдХрд┐рддрдиреЗ рддрддреНрд╡реЛрдВ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  рдЕрд╕реАрдорд┐рдд - рд╕реАрдорд┐рдд рдирд╣реАрдВ, рдХреЛрдИ рдирд╣реАрдВ - рдмрд┐рд▓реНрдХреБрд▓ рдирд╣реАрдВ, рдЕрдзрд┐рдХрддрдо (рдПрди) - рдПрди рдмрд╛рд░ рд╕реЗ рдЕрдзрд┐рдХ рдирд╣реАрдВред </p><br><pre> <code class="swift hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demand</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Equatable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Comparable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hashable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Codable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomStringConvertible</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> unlimited: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-comment"><span class="hljs-comment">///  Demand.max(0) @inlinable public static func max(_ value: Int) -&gt; Subscribers.Demand .... }</span></span></code> </pre> <br><p>  рд╣рдо рдЧрдгрдирд╛ рдХреЗ рд▓рд┐рдП рдПрдХ рдирдП рдкреНрд░рдХрд╛рд░ рдореЗрдВ рдмрджрд▓рддреЗ рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐рдСрдирдлрд┐рдЧрд░реЗрд╢рди рдХреЛ рдлрд┐рд░ рд╕реЗ рд▓рд┐рдЦрддреЗ рд╣реИрдВред </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> }</code> </pre> <br><p>  рдЪрд▓рд┐рдП рд╣рдо рд╡рд╛рдкрд╕ рдкреНрд░рдХрд╛рд╢рдХ рдХреЗ рдкрд╛рд╕ рдЬрд╛рддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░рд╛рдкреНрдд (_: рд╕рдмрд╕реНрдХреНрд░рд╛рдЗрдмрд░) рдкрджреНрдзрддрд┐ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВ, рдЬреИрд╕рд╛ рдХрд┐ рд╣рдо рдпрд╛рдж рдХрд░рддреЗ рд╣реИрдВ, рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХреЛ рдкреНрд░рдХрд╛рд╢рдХ рдореЗрдВ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕ рд╡рд┐рдзрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдФрд░ рд╡рд╣ рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдХреЗ рд╕рд╛рде рдРрд╕рд╛ рдХрд░рддрд╛ рд╣реИ, рдкреНрд░рдХрд╛рд╢рдХ рдХреЛ рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдмрдирд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХреЛ рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдЯреНрд░рд╛рдВрд╕рдлрд░ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред </p><br><pre> <code class="swift hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscription = <span class="hljs-type"><span class="hljs-type">FibonacciSubscription</span></span>(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) }</code> </pre> <br><p>  рдпрд╣ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдлрд╝рдВрдХреНрд╢рди рд╣реИ рдЬреЛ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХреЛ рдПрдХ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЗрддрд╛ рд╣реИ, рдФрд░ рдкреНрд░рдХрд╛рд╢рдХ рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдорд╛рдиреЛрдВ рдХреЛ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХреЗ рдЗрдирдкреБрдЯ рдореВрд▓реНрдпреЛрдВ (рдЖрдЙрдЯрдкреБрдЯ == S.Input) рд╕реЗ рдореЗрд▓ рдЦрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рддреНрд░реБрдЯрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рдорд╛рди рд╣реИред  рдпрд╣ рдкреНрд░рдХрд╛рд╢рдХ рдФрд░ рдЧреНрд░рд╛рд╣рдХ рдХреЛ "рдХрдиреЗрдХреНрдЯ" рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИред </p><br><p>  рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рд╣реА, рдПрдХ рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐рд╕реНрдХреНрд░рд┐рдкреНрд╢рди рд╕рджрд╕реНрдпрддрд╛ рдмрдирд╛рдПрдВ, рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░ рдореЗрдВ рд╣рдо рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдФрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВред  рдЙрд╕рдХреЗ рдмрд╛рдж, рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХреЛ рдЯреНрд░рд╛рдВрд╕рдлрд░ рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </p><br><p>  рд╣рдорд╛рд░рд╛ рдкреНрд░рдХрд╛рд╢рдХ рддреИрдпрд╛рд░ рд╣реИ, рдЕрдВрдд рдореЗрдВ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд╣реИ: </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciPublisher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscription = <span class="hljs-type"><span class="hljs-type">FibonacciSubscription</span></span>(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) } }</code> </pre> <br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдкреНрд░рдХрд╛рд╢рдХ рдХреЗ рдкрд╛рд╕ рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐ рдЕрдиреБрдХреНрд░рдо рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рддрд░реНрдХ рдирд╣реАрдВ рд╣реИ; рд╕рднреА рддрд░реНрдХ рд╕рджрд╕реНрдпрддрд╛ рд╡рд░реНрдЧ - рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐рд╕реНрдХреНрд░рд┐рдкреНрд╢рди рдореЗрдВ рд╣реЛрдВрдЧреЗред </p><br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЕрдиреБрдорд╛рди рд▓рдЧрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐рд╕реНрдХреНрд░рд┐рдкреНрд╢рди рдХреНрд▓рд╛рд╕ рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдЧрд╛, рдЖрдЗрдП рдЗрд╕ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреА рдкрд░рд┐рднрд╛рд╖рд╛ рджреЗрдЦреЗрдВред </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cancellable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomCombineIdentifierConvertible</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> }</code> </pre> <br><p>  рдЕрдиреБрд░реЛрдз (_: Subscribers.Demand) рдлрд╝рдВрдХреНрд╢рди рдкреНрд░рдХрд╛рд╢рдХ рдХреЛ рдмрддрд╛рддрд╛ рд╣реИ рдХрд┐ рд╡рд╣ рдЧреНрд░рд╛рд╣рдХ рдХреЛ рдЕрдзрд┐рдХ рдореВрд▓реНрдп рднреЗрдЬ рд╕рдХрддрд╛ рд╣реИред  рдпрд╣ рдЗрд╕ рдкрджреНрдзрддрд┐ рдореЗрдВ рд╣реИ рдХрд┐ рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐ рд╕рдВрдЦреНрдпрд╛ рднреЗрдЬрдиреЗ рдХрд╛ рддрд░реНрдХ рдХреНрдпрд╛ рд╣реЛрдЧрд╛ред <br>  рд╣рдореЗрдВ рд░рджреНрдж рдХрд░рдиреЗ рдпреЛрдЧреНрдп рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдкрд╛рд▓рди рдХрд░рдиреЗ рдФрд░ рд░рджреНрдж () рдлрд╝рдВрдХреНрд╢рди рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cancellable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> }</code> </pre> <br><p>  рдФрд░ рдмрд╕ CustomCombineIdentifierConvertible рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ рдФрд░ рдХреЗрд╡рд▓ рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░рд┐рд╡рд░реНрддрдиреАрдп CombIdentifier рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░реЗрдВред </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomCombineIdentifierConvertible</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> combineIdentifier: <span class="hljs-type"><span class="hljs-type">CombineIdentifier</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> } }</code> </pre> <br><p>  рдпрд╣рд╛рдБ рдПрдХ рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг рд╣реИ, рдпрджрд┐ рдЖрдк Combine рдореЗрдВ CustomCombineIdentifierConvertible рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреА рдкрд░рд┐рднрд╛рд╖рд╛ рдХреЗ рдареАрдХ рдиреАрдЪреЗ рд╕реНрдХреНрд░реЙрд▓ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ Combine рдЗрд╕ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЗ рд▓рд┐рдП рдПрдХ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рд░реВрдк рд╣реИ - </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomCombineIdentifierConvertible</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Self</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> combineIdentifier: <span class="hljs-type"><span class="hljs-type">CombineIdentifier</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> } }</code> </pre> <br><p>  рдЬреЛ рд╣рдореЗрдВ рдмрддрд╛рддрд╛ рд╣реИ рдХрд┐ рд╡реИрд░рд┐рдПрдмрд▓ CombIIdentifier рдХреА рдкрд░рд┐рднрд╛рд╖рд╛: CombineIdentifier рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛рддреА рд╣реИ рдпрджрд┐ рдЗрд╕ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдкрд╛рд▓рди рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдкреНрд░рдХрд╛рд░ рднреА AnyObject рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░рддрд╛ рд╣реИ, рдЕрд░реНрдерд╛рдд рдпрджрд┐ рдпрд╣ рдкреНрд░рдХрд╛рд░ рдПрдХ рд╡рд░реНрдЧ рд╣реИред  рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐рд╕реНрдХреНрд░рд┐рдкреНрд╢рди рдПрдХ рд╡рд░реНрдЧ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдЪрд░ рдкрд░рд┐рднрд╛рд╖рд╛ рдорд┐рд▓рддреА рд╣реИред </p><br><h1 id="subscription">  рдЕрдВрд╢рджрд╛рди </h1><br><p>  рдФрд░ рдЗрд╕рд▓рд┐рдП рд╣рдо рдЕрдкрдиреЗ рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐рд╕реНрдХреНрд░рд┐рдкреНрд╢рди рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░реЗрдВрдЧреЗред </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscription</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Input</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span>, configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.subscriber = subscriber <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.configuration = configuration <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> = configuration.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> } ... }</code> </pre> <br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐рдСрдирдлрд┐рдЧрд░реЗрд╢рди рдореЗрдВ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХрд╛ рдПрдХ рдордЬрдмреВрдд рд▓рд┐рдВрдХ рд╢рд╛рдорд┐рд▓ рд╣реИ, рджреВрд╕рд░реЗ рд╢рдмреНрджреЛрдВ рдореЗрдВ, рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХрд╛ рдорд╛рд▓рд┐рдХ рд╣реИред  <strong>рдпрд╣ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд┐рдВрджреБ рд╣реИ, рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХреЗ рдкреНрд░рддрд┐рдзрд╛рд░рдг рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реИ, рдФрд░ рдЗрд╕реЗ рддрдм рддрдХ рдкрдХрдбрд╝рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬрдм рддрдХ рдпрд╣ рдХрд╛рдо рдЦрддреНрдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рдПрдХ рддреНрд░реБрдЯрд┐ рдХреЗ рд╕рд╛рде рдпрд╛ рд░рджреНрдж рдХреЗ рд╕рд╛рде рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИред</strong> </p><br><p>  рдЕрдЧрд▓рд╛, рд╣рдо рд░рджреНрджреАрдХрд░рдг рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╕реЗ рд░рджреНрдж () рд╡рд┐рдзрд┐ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВред </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { subscriber = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><p>  рд╢реВрдиреНрдп рдкрд░ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХреЛ рд╕реЗрдЯ рдХрд░рдирд╛ рд╕рджрд╕реНрдпрддрд╛ рдХреЗ рд▓рд┐рдП рджреБрд░реНрдЧрдо рдмрдирд╛рддрд╛ рд╣реИред </p><br><p>  рдЕрдм рд╣рдо рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐ рд╕рдВрдЦреНрдпрд╛ рднреЗрдЬрдиреЗ рдХрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реИрдВред <br>  рд╣рдо рдЕрдиреБрд░реЛрдз рд╡рд┐рдзрд┐ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВ (_: Subscribers.Demand)ред </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1 guard count &gt; .none else { subscriber?.receive(completion: .finished) return } // 2 count -= .max(1) subscriber?.receive(0) if count == .none { subscriber?.receive(completion: .finished) return } // 3 count -= .max(1) subscriber?.receive(1) if count == .none { subscriber?.receive(completion: .finished) return } // 4 var prev = 0 var current = 1 var temp: Int while true { temp = prev prev = current current += temp subscriber?.receive(current) count -= .max(1) if count == .none { subscriber?.receive(completion: .finished) return } } }</span></span></code> </pre> <br><p>  1) рд╢реБрд░реБрдЖрдд рд╕реЗ, рд╣рдо рдпрд╣ рдЬрд╛рдВрдЪрддреЗ рд╣реИрдВ рдХрд┐ рдкреНрд░рдХрд╛рд╢рдХ рдХрд┐рддрдиреЗ рддрддреНрд╡реЛрдВ рдХреЗ рд╕рд╛рде рд╣рдореЗрдВ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдпрджрд┐ рдмрд┐рд▓реНрдХреБрд▓ рдирд╣реАрдВ, рддреЛ рднреЗрдЬрдиреЗ рд╡рд╛рд▓реЗ рдХреЛ рдкреВрд░рд╛ рдХрд░реЗрдВ рдФрд░ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХреЛ рдПрдХ рд╕рдВрдХреЗрдд рднреЗрдЬреЗрдВ рдХрд┐ рдирдВрдмрд░ рднреЗрдЬрдиреЗ рдХрд╛ рдХрд╛рдо рдкреВрд░рд╛ рд╣реЛ рдЧрдпрд╛ рд╣реИред <br>  2) рдпрджрд┐ рдХреЛрдИ рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рддреЛ рдПрдХ рдХреЗ рдмрд╛рдж рдЕрдиреБрд░реЛрдзрд┐рдд рд╕рдВрдЦреНрдпрд╛рдУрдВ рдХреА рдХреБрд▓ рд╕рдВрдЦреНрдпрд╛ рдХреЛ рдХрдо рдХрд░реЗрдВ, рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐ рдЕрдиреБрдХреНрд░рдо рдХреЗ рдкрд╣рд▓реЗ рддрддреНрд╡ рдХреЛ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХреЛ рднреЗрдЬреЗрдВ, рдЕрд░реНрдерд╛рддреН 0 рдФрд░ рдлрд┐рд░ рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХрд┐рддрдиреЗ рдФрд░ рддрддреНрд╡ рдкреНрд░рдХрд╛рд╢рдХ рд╣рдореЗрдВ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ, рдпрджрд┐ рдирд╣реАрдВ, рддреЛ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХреЛ рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рдВрдХреЗрдд рднреЗрдЬреЗрдВред ред <br>  3) 2 рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХ рд╣реА рджреГрд╖реНрдЯрд┐рдХреЛрдг) рдкреИрд░рд╛, рд▓реЗрдХрд┐рди рдХреЗрд╡рд▓ рдлрд┐рдмреЛрдирд╛рдЪреА рдЕрдиреБрдХреНрд░рдо рдореЗрдВ рджреВрд╕рд░реЗ рддрддреНрд╡ рдХреЗ рд▓рд┐рдПред <br>  4) рдпрджрд┐ 2 рд╕реЗ рдЕрдзрд┐рдХ рддрддреНрд╡реЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рддреЛ рд╣рдо рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐ рд╕рдВрдЦреНрдпрд╛рдУрдВ рдХреЛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреБрдирд░рд╛рд╡реГрддреНрдд рдПрд▓реНрдЧреЛрд░рд┐рдереНрдо рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВ, рдЬрд╣рд╛рдВ рдкреНрд░рддреНрдпреЗрдХ рдЪрд░рдг рдкрд░ рд╣рдо рдЕрдЧрд▓реЗ рдирдВрдмрд░ рдХреЛ рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐ рдЕрдиреБрдХреНрд░рдо рд╕реЗ рд╕рдмрд╕реНрдХреНрд░рд╛рдЗрдмрд░ рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░реЗрдВрдЧреЗ рдФрд░ рдпрд╣ рднреА рдЬрд╛рдВрдЪреЗрдВрдЧреЗ рдХрд┐ рдкреНрд░рдХрд╛рд╢рдХ рдЕрднреА рднреА рдХрд┐рддрдиреЗ рддрддреНрд╡ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдпрджрд┐ рдкреНрд░рдХрд╛рд╢рдХ рдЕрдм рдирдП рдирдВрдмрд░ рдкреНрд░рджрд╛рди рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХреЛ рдкреВрд░рд╛ рд╣реЛрдиреЗ рдХрд╛ рд╕рдВрдХреЗрдд рднреЗрдЬреЗрдВред </p><br><div class="spoiler">  <b class="spoiler_title">рдлрд┐рд▓рд╣рд╛рд▓, рд╣рдордиреЗ рдРрд╕рд╛ рдХреЛрдб рд▓рд┐рдЦрд╛ рд╣реИ</b> <div class="spoiler_text"><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciPublisher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscription = <span class="hljs-type"><span class="hljs-type">FibonacciSubscription</span></span>(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscription</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Input</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span>, configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.subscriber = subscriber <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.configuration = configuration <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> = configuration.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { subscriber = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1 guard count &gt; .none else { subscriber?.receive(completion: .finished) return } // 2 count -= .max(1) subscriber?.receive(0) if count == .none { subscriber?.receive(completion: .finished) return } // 3 count -= .max(1) subscriber?.receive(1) if count == .none { subscriber?.receive(completion: .finished) return } // 4 var prev = 0 var current = 1 var temp: Int while true { temp = prev prev = current current += temp subscriber?.receive(current) count -= .max(1) if count == .none { subscriber?.receive(completion: .finished) return } } } }</span></span></code> </pre> </div></div><br><h3 id="pervoe-testirovanie">  рдкрд╣рд▓реЗ рдкрд░реАрдХреНрд╖рдг </h3><br><p>  рдЕрдм рд╣рдо рдкрд░реАрдХреНрд╖рдг рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдХреНрдпрд╛ рд╣реИ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд╣рдорд╛рд░рд╛ рдкреНрд░рдХрд╛рд╢рдХ рдФрд░ рд╕рджрд╕реНрдпрддрд╛ рд╣реИ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд╕рд┐рдмреНрд╕реНрдХреНрд░рд╛рдЗрдмрд░ рдХреА рдХрдореА рд╣реИ, рдХреЙрдореНрдмрд┐рдиреЗрд╢рди рдмреЙрдХреНрд╕ рд╕реЗ 2 рд╕рд┐рдмреНрд╕реНрдХреНрд░рд╛рдЗрдмрд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рдпрд╣ рд╕рд┐рдВрдХ рдФрд░ рдЕрд╕рд╛рдЗрди рд╣реИред </p><br><ul><li>  рд╕рд┐рдВрдХ - рдпрд╣ рд╡рд┐рдзрд┐ рдПрдХ рдЧреНрд░рд╛рд╣рдХ рдмрдирд╛рддрд╛ рд╣реИ рдФрд░ рддреБрд░рдВрдд <strong>рдЕрд╕реАрдорд┐рдд</strong> рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рдореВрд▓реНрдпреЛрдВ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рддрд╛ рд╣реИред </li><li>  рдЕрд╕рд╛рдЗрди - рдкреНрд░рдХрд╛рд╢рдХ рд╕реЗ рд╡рд╕реНрддреБ рддрддреНрд╡ рдХреЗ рд▓рд┐рдП рдкреНрд░рддреНрдпреЗрдХ рддрддреНрд╡ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред </li></ul><br><p>  рд╕рд┐рдВрдХ рд╣рдорд╛рд░реЗ рдЙрджреНрджреЗрд╢реНрдп рдХреЗ рд▓рд┐рдП рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдЕрдиреБрдХреВрд▓ рд╣реИ, рдЗрд╕ рддрдереНрдп рдкрд░ рд╡рд┐рд╢реЗрд╖ рдзреНрдпрд╛рди рджрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ рдпрд╣ рдЕрд╕реАрдорд┐рдд рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рдореВрд▓реНрдпреЛрдВ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рддрд╛ рд╣реИред </p><br><p>  рдФрд░ рдпрд╣рд╛рдВ рд╣рдореЗрдВ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЕрдВрддрд░ рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдЧрд┐рдирддреА рдЪрд░ рдореЗрдВ рд╣рдорд╛рд░рд╛ рдкреНрд░рдХрд╛рд╢рдХ рдЙрди рддрддреНрд╡реЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬреЛ рд╣рдорд╛рд░реЗ рдкреНрд░рдХрд╛рд╢рдХ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдпреЗ рд╕реНрдерд┐рддрд┐рдпрд╛рдВ рд╕реНрд╡рдпрдВ рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХреА рдЬрд╛рддреА рд╣реИрдВред  рд╕рд┐рджреНрдзрд╛рдВрдд рд░реВрдк рдореЗрдВ, рд╣рдо рдЗрд╕ рд╡реИрд░рд┐рдПрдмрд▓ рдХреЗ рдмрд┐рдирд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐ рд╕рдВрдЦреНрдпрд╛рдУрдВ рдХреЛ рдкреНрд░рд╕рд╛рд░рд┐рдд рдХрд░рдиреЗ рдореЗрдВ рд╕реАрдорд┐рдд рдирд╣реАрдВ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдмрд╣реБрдд рдЬрд▓реНрдж рд╣рдо рдкреНрд░рдХрд╛рд░ рдЗрдВрдЯ рдХреЗ рд╕реНрд╡реАрдХрд╛рд░реНрдп рдореВрд▓реНрдпреЛрдВ рдХреА рд╕реАрдорд╛ рд╕реЗ рдЖрдЧреЗ рдирд┐рдХрд▓ рдЬрд╛рдПрдВрдЧреЗред <br>  рд╕рд┐рдВрдХ рдХреЗ рд╕рд╛рде рдорд╛рдорд▓рд╛ рдЕрд▓рдЧ рд╣реИ, рдкреНрд░рддреНрдпреЗрдХ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдпрд╣ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рд╡рд╣ рдХрд┐рддрдиреЗ рдорд╛рди рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реИ, рд╕рд┐рдВрдХ рдЕрд╕реАрдорд┐рдд рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рдорд╛рдиреЛрдВ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рдпрд╣ рддрдм рддрдХ рдореВрд▓реНрдпреЛрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдЧрд╛ рдЬрдм рддрдХ рдХрд┐ рдпрд╣ рдкреВрд░рд╛ рд╣реЛрдиреЗ, рддреНрд░реБрдЯрд┐ рдпрд╛ рд░рджреНрдж рдХрд░рдиреЗ рдХрд╛ рд╕рдВрдХреЗрдд рдкреНрд░рд╛рдкреНрдд рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред </p><br><p>  рд╣рдорд╛рд░реЗ рдкреНрд░рдХрд╛рд╢рдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рд▓рд┐рдП, рд╣рдо рдЗрд╕рдХреЗ рдирд┐рд░реНрдорд╛рдг рдХреЛ рдкреНрд░реЛрдЯреЛрдХреЛрд▓ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдореЗрдВ рдЬреЛрдбрд╝рддреЗ рд╣реИрдВред </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publishers</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration: FibonacciConfiguration)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span> { <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span>(configuration: configuration) } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">count</span></span></span></span><span class="hljs-function"><span class="hljs-params">: Subscribers.Demand = .</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">max</span></span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-number">6</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span></span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span> { <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span>(configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>)) } }</code> </pre> <br><p>  рдФрд░ рдЗрд╕рд▓рд┐рдП рд╣рдорд╛рд░реЗ рдкреНрд░рдХрд╛рд╢рдХ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>)) .sink { value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(value, terminator: <span class="hljs-string"><span class="hljs-string">" "</span></span>) } <span class="hljs-comment"><span class="hljs-comment">// print 0 1 1 2 3 5 8 13 21 34 - OK</span></span></code> </pre> <br><p>  рдФрд░ рдЕрдм рд╕реАрдорд╛ рдорд╛рдорд▓реЗ </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)) .sink { value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(value, terminator: <span class="hljs-string"><span class="hljs-string">" "</span></span>) } <span class="hljs-comment"><span class="hljs-comment">// prinst 0 - OK Publishers.fibonacci(count: .max(2)) .sink { value in print(value, terminator: " ") } // prints 0 1 - OK Publishers.fibonacci(count: .none) .print() //    publisher'a .sink { value in print(value, terminator: " ") } // prints receive finished - OK</span></span></code> </pre> <br><p>  рд▓реЗрдХрд┐рди рдЕрдЧрд░ рдЖрдк рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░реЗрдВ рддреЛ рдХреНрдпрд╛ рд╣реЛрддрд╛ рд╣реИред </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .unlimited) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .sink { value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(value, terminator: <span class="hljs-string"><span class="hljs-string">" "</span></span>) } <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 5 8 13 21 ...   ,     Int.</span></span></code> </pre> <br><p>  рдЖрдк .unlimited рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдХрдИ рдирдВрдмрд░реЛрдВ рдХреЛ рдЖрдЙрдЯрдкреБрдЯ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реИрдВ?  рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ .prefix (_) рдСрдкрд░реЗрдЯрд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рдЬреЛ рд╕рдВрдЧреНрд░рд╣ рд╕реЗ .prefix (_) рдХреЗ рд╕рдорд╛рди рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИ, рдЕрд░реНрдерд╛рдд рдпрд╣ рдХреЗрд╡рд▓ рдкрд╣рд▓реЗ N рддрддреНрд╡реЛрдВ рдХреЛ рдЫреЛрдбрд╝рддрд╛ рд╣реИред </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .unlimited) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .<span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) .sink { <span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> } <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 cancel   ,       Int.</span></span></code> </pre> <br><p>  рдХреНрдпрд╛ рд╕рдорд╕реНрдпрд╛ рд╣реИ?  рд╢рд╛рдпрдж .prefix (_) рдореЗрдВ?  рдЖрдЗрдП рдлрд╛рдЙрдВрдбреЗрд╢рди рд╕реЗ рдорд╛рдирдХ рдЕрдиреБрдХреНрд░рдо рдкрд░ рдереЛрдбрд╝рд╛ рдкреНрд░рдпреЛрдЧ рдХрд░реЗрдВред </p><br><pre> <code class="swift hljs"><span class="hljs-comment"><span class="hljs-comment">//   1 2 3 4 5 6 7 8 ... 1... .publisher .print() .prefix(5) .sink { _ in } // prints 1 2 3 4 5 cancel - </span></span></code> </pre> <br><p>  рдЬреИрд╕рд╛ рдХрд┐ рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрдкрд░реЛрдХреНрдд рдХреЛрдб рдиреЗ рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рдХрд╛рдо рдХрд┐рдпрд╛ рд╣реИ, рддреЛ рд╕рдорд╕реНрдпрд╛ рдкреНрд░рдХрд╛рд╢рдХ рдХреЗ рд╣рдорд╛рд░реЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдореЗрдВ рд╣реИред <br>  рд╣рдо .print () рд╕реЗ рд▓реЙрдЧ рдХреЛ рджреЗрдЦрддреЗ рд╣реИрдВ рдФрд░ рджреЗрдЦрддреЗ рд╣реИрдВ рдХрд┐ N рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдХреЗ рдмрд╛рдж .prefix (_) рд╕реЗ, рд╣рдо рдЕрдкрдиреЗ рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐рд╕реНрдХреНрд░рд┐рдкреНрд╢рди рдкрд░ рдХреИрдВрд╕рд┐рд▓ () рдХрд╣рддреЗ рд╣реИрдВ, рдЬрд╣рд╛рдБ рд╣рдо рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХреЛ рд╢реВрдиреНрдп рдкрд░ рд╕реЗрдЯ рдХрд░рддреЗ рд╣реИрдВред </p><br><pre> <code class="swift hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { subscriber = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><p>  рдпрджрд┐ рдЖрдк рдХреЙрд▓ рд╕реНрдЯреИрдХ рдЦреЛрд▓рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЧреНрд░рд╛рд╣рдХ рд╕реЗ рдХреЙрд▓ рдХреЗ рджреМрд░рд╛рди рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ () рдХреЛ рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ (_ :), .Receive (_)ред  рдЬрд┐рд╕рд╕реЗ рд╣рдо рдпрд╣ рдирд┐рд╖реНрдХрд░реНрд╖ рдирд┐рдХрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЕрдиреБрд░реЛрдз рдХреЗ рд╕рдордп рдХреБрдЫ рдмрд┐рдВрджреБ рдкрд░ (_ :) рдЧреНрд░рд╛рд╣рдХ рд╢реВрдиреНрдп рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ рд╣рдореЗрдВ рдирдП рдирдВрдмрд░ рдмрдирд╛рдиреЗ рдХреЗ рдХрд╛рдо рдХреЛ рд░реЛрдХрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдЗрд╕ рд╢рд░реНрдд рдХреЛ рд╣рдорд╛рд░реЗ рдХреЛрдб рдореЗрдВ рдЬреЛрдбрд╝реЗрдВред </p><br><pre> <code class="swift hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1 guard count &gt; .none else { subscriber?.receive(completion: .finished) return } // 2 count -= .max(1) subscriber?.receive(0) guard let _ = subscriber else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } // 3 count -= .max(1) subscriber?.receive(1) guard let _ = subscriber else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } // 4 var prev = 0 var current = 1 var temp: Int while let subscriber = subscriber { // new temp = prev prev = current current += temp subscriber.receive(current) count -= .max(1) if count == .none { subscriber.receive(completion: .finished) return } } }</span></span></code> </pre> <br><p>  рдЕрдм рд╣рдорд╛рд░реЗ рдкрд░реАрдХреНрд╖рдг рдХреЛрдб рдХреЛ рдЪрд▓рд╛рдПрдВред </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .unlimited) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .<span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) .sink { <span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> } <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 cancel - </span></span></code> </pre> <br><p>  рдЕрдкреЗрдХреНрд╖рд┐рдд рд╡реНрдпрд╡рд╣рд╛рд░ рдорд┐рд▓рд╛ред </p><br><h1 id="subscriber">  рдЧреНрд░рд╛рд╣рдХ </h1><br><p>  рдФрд░ рддреЛ рдФрд░ рдХреНрдпрд╛ рд╣рдорд╛рд░рд╛ рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐рд╢рдмреНрдЬ рддреИрдпрд╛рд░ рд╣реИ?  рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдирд╣реАрдВ, рд╣рдорд╛рд░реЗ рдкрд░реАрдХреНрд╖рдгреЛрдВ рдореЗрдВ рд╣рдордиреЗ рдХреЗрд╡рд▓ рдПрдХ рд╕рд┐рдВрдХ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рд╣реИ рдЬреЛ рд╕рдВрдЦреНрдпрд╛рдУрдВ рдХреА рдПрдХред рд╕реАрдорд╛рдВрдХрд┐рдд рд╕рдВрдЦреНрдпрд╛ рдорд╛рдВрдЧрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдХреНрдпрд╛ рд╣реЛрдЧрд╛ рдпрджрд┐ рд╣рдо рдЗрд╕рдХреЗ рдмрдЬрд╛рдп рдПрдХ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ рдХреБрдЫ рд╕реАрдорд┐рдд рд╕рдВрдЦреНрдпрд╛рдУрдВ рдХреА рдЕрдкреЗрдХреНрд╖рд╛ рдХрд░реЗрдВрдЧреЗред  рдХрдВрдмрд╛рдЗрди рдЗрд╕ рддрд░рд╣ рдХрд╛ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдкреНрд░рджрд╛рди рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд╣рдореЗрдВ рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ рд▓реЗрдЦрди рд╕реЗ рдХреНрдпрд╛ рд░реЛрдХрддрд╛ рд╣реИ?  рдиреАрдЪреЗ рд╣рдорд╛рд░реЗ рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐рд╕реНрдХреНрд░рд╛рдЗрдмрд░ рдХрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╣реИред </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscriber</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Input</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> limit: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(limit: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.limit = limit } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscription: Subscription)</span></span></span></span> { subscription.request(limit) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> input: Input)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> { .<span class="hljs-keyword"><span class="hljs-keyword">none</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(completion: Subscribers.Completion&lt;Failure&gt;)</span></span></span></span> { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Subscriber's completion: \(completion)"</span></span>) } }</code> </pre> <br><p>  рдФрд░ рдЗрд╕рд▓рд┐рдП рд╣рдорд╛рд░реЗ рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐рд╕реНрдХреНрд░рд╛рдЗрдмрд░ рдХреЗ рдкрд╛рд╕ рдПрдХ рд╕реАрдорд╛ рд╕рдВрдкрддреНрддрд┐ рд╣реИ, рдЬреЛ рдпрд╣ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддреА рд╣реИ рдХрд┐ рдпрд╣ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХрд┐рддрдиреЗ рддрддреНрд╡реЛрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реИред  рдФрд░ рдпрд╣ рдкреНрд░рд╛рдкреНрдд (_: рд╕рджрд╕реНрдпрддрд╛) рд╡рд┐рдзрд┐ рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рд╣рдо рд╕рджрд╕реНрдпрддрд╛ рдХреЛ рдмрддрд╛рддреЗ рд╣реИрдВ рдХрд┐ рд╣рдореЗрдВ рдХрд┐рддрдиреЗ рддрддреНрд╡реЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдпрд╣ рднреА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд╛рдпрдХ рд╣реИ (_: рдЗрдирдкреБрдЯ) -&gt; рд╕рдмрд╕реНрдХреНрд░рд╛рдЗрдмрд░реНрд╕ред рдбрд┐рдорд╛рдВрдб рдлрд╝рдВрдХреНрд╢рди, рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдПрдХ рдирдпрд╛ рдорд╛рди рдкреНрд░рд╛рдкреНрдд рд╣реЛрдиреЗ рдкрд░ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рд░рд┐рдЯрд░реНрди рд╡реИрд▓реНрдпреВ рд╣рдо рдЗрдВрдЧрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рд╣рдо рдХрд┐рддрдиреЗ рдЕрддрд┐рд░рд┐рдХреНрдд рддрддреНрд╡реЛрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ: .none - рдмрд┐рд▓реНрдХреБрд▓ рдирд╣реАрдВ редmax (N) N рдореЛрд╣рд░реЗред , рдХреБрд▓ рдореЗрдВ, рдкреНрд░рд╛рдкреНрдд рддрддреНрд╡реЛрдВ рдХреА рдХреБрд▓ рд╕рдВрдЦреНрдпрд╛ рдкреНрд░рд╛рдкреНрдд (_: рд╕рджрд╕реНрдпрддрд╛) рдореЗрдВ рднреЗрдЬреЗ рдЧрдП рд╕рджрд╕реНрдпрддрд╛ рдХреЗ рдореВрд▓реНрдп рдХреЗ рдпреЛрдЧ рдХреЗ рдмрд░рд╛рдмрд░ рд╣реЛрдЧреА рдФрд░ рдкреНрд░рд╛рдкреНрдд рд╕реЗ рд╕рднреА рд░рд┐рдЯрд░реНрди рдорд╛рди (_: рдЗрдирдкреБрдЯ) -&gt; Subscribers.Demandред </p><br><h3 id="vtoroe-testirovanie">  рджреВрд╕рд░рд╛ рдкрд░реАрдХреНрд╖рдг </h3><br><p>  рдЖрдЗрдП, рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐рд╕реНрдХреНрд░рд┐рдкреНтАНрд╕рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рджреЗрдЦреЗрдВред </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscriber = <span class="hljs-type"><span class="hljs-type">FibonacciSubscriber</span></span>(limit: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>)) <span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .subscribe(subscriber) <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 -     0 1 1</span></span></code> </pre> <br><p>  рдЬреИрд╕рд╛ рдХрд┐ рд╣рдо рджреЗрдЦрддреЗ рд╣реИрдВ рдХрд┐ рд╣рдорд╛рд░реЗ рдкреНрд░рдХрд╛рд╢рдХ рдиреЗ 3 рдХреЗ рдмрдЬрд╛рдп 5 рдорд╛рди рднреЗрдЬреЗ рд╣реИрдВред рдРрд╕рд╛ рдХреНрдпреЛрдВ?  рдЪреВрдБрдХрд┐ рдЕрдиреБрд░реЛрдз (_: Subscribers.Demand) рдХрд╛ рддрд░реАрдХрд╛ рдлрд╛рдЗрдмреЛрдиреИрдЪрд┐рд╕реНрдХреНрд░рд┐рдкреНрд╢рди рдХреА рд╡рд┐рдзрд┐ рдЧреНрд░рд╛рд╣рдХ рдХреА рдЬрд░реВрд░рддреЛрдВ рдХреЛ рдзреНрдпрд╛рди рдореЗрдВ рдирд╣реАрдВ рд░рдЦрддреА рд╣реИ, рддреЛ рдЗрд╕реЗ рдареАрдХ рдХрд░реЗрдВ, рдЗрд╕рдХреЗ рд▓рд┐рдП рд╣рдо рдЕрдиреБрд░реЛрдз рдХреА рдЧрдИ рдПрдХ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕рдВрдкрддреНрддрд┐ рдЬреЛрдбрд╝реЗрдВрдЧреЗ, рдЬрд┐рд╕рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣рдо рдЧреНрд░рд╛рд╣рдХ рдХреА рдЬрд░реВрд░рддреЛрдВ рдХреЛ рдЯреНрд░реИрдХ рдХрд░реЗрдВрдЧреЗред </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscription</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Input</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requested: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> = .<span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-comment"><span class="hljs-comment">// new init(subscriber: S?, configuration: FibonacciConfiguration) { self.subscriber = subscriber self.configuration = configuration self.count = configuration.count } func cancel() { subscriber = nil } func request(_ demand: Subscribers.Demand) { guard count &gt; .none else { subscriber?.receive(completion: .finished) return } requested += demand // new count -= .max(1) requested -= .max(1) // new requested += subscriber?.receive(0) ?? .none // new guard let _ = subscriber, requested &gt; .none else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } count -= .max(1) requested -= .max(1) // new requested += subscriber?.receive(1) ?? .none // new guard let _ = subscriber, requested &gt; .none else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } var prev = 0 var current = 1 var temp: Int while let subscriber = subscriber, requested &gt; .none { // new temp = prev prev = current current += temp requested += subscriber.receive(current) // new count -= .max(1) requested -= .max(1) // new if count == .none { subscriber.receive(completion: .finished) return } } } }</span></span></code> </pre> <br><h3 id="trete-testirovanie">  рддреАрд╕рд░рд╛ рдкрд░реАрдХреНрд╖рдг </h3><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscriber = <span class="hljs-type"><span class="hljs-type">FibonacciSubscriber</span></span>(limit: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>)) <span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .subscribe(subscriber) <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 - OK</span></span></code> </pre> <br><p>  рдкреНрд░рдХрд╛рд╢рдХ рдЕрдм рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдХрд╛рдо рдХрд░ рд░рд╣рд╛ рд╣реИред </p><br><div class="spoiler">  <b class="spoiler_title">рдЕрдВрддрд┐рдо рдХреЛрдб</b> <div class="spoiler_text"><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Foundation <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Combine struct FibonacciConfiguration { var count: Subscribers.Demand } struct FibonacciPublisher: Publisher { typealias Output = Int typealias Failure = Never var configuration: FibonacciConfiguration func receive&lt;S&gt;(subscriber: S) where S : Subscriber, Failure == S.Failure, Output == S.Input { let subscription = FibonacciSubscription(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) } } private final class FibonacciSubscription&lt;S: Subscriber&gt;: Subscription where S.Input == Int { var subscriber: S? var configuration: FibonacciConfiguration var count: Subscribers.Demand var requested: Subscribers.Demand = .none init(subscriber: S?, configuration: FibonacciConfiguration) { self.subscriber = subscriber self.configuration = configuration self.count = configuration.count } func cancel() { subscriber = nil } func request(_ demand: Subscribers.Demand) { guard count &gt; .none else { subscriber?.receive(completion: .finished) return } requested += demand count -= .max(1) requested -= .max(1) requested += subscriber?.receive(0) ?? .none guard let _ = subscriber, requested &gt; .none else { return } if count == .none { subscriber?.receive(completion: .finished) return } count -= .max(1) requested -= .max(1) requested += subscriber?.receive(1) ?? .none guard let _ = subscriber, requested &gt; .none else { return } if count == .none { subscriber?.receive(completion: .finished) return } var prev = 0 var current = 1 var temp: Int while let subscriber = subscriber, requested &gt; .none { temp = prev prev = current current += temp requested += subscriber.receive(current) count -= .max(1) requested -= .max(1) if count == .none { subscriber.receive(completion: .finished) return } } } } extension Publishers { private static func fibonacci(configuration: FibonacciConfiguration) -&gt; FibonacciPublisher { FibonacciPublisher(configuration: configuration) } static func fibonacci(count: Subscribers.Demand = .max(6)) -&gt; FibonacciPublisher { FibonacciPublisher(configuration: FibonacciConfiguration(count: count)) } } class FibonacciSubscriber: Subscriber { typealias Input = Int typealias Failure = Never var limit: Subscribers.Demand init(limit: Subscribers.Demand) { self.limit = limit } func receive(subscription: Subscription) { subscription.request(limit) } func receive(_ input: Input) -&gt; Subscribers.Demand { .none } func receive(completion: Subscribers.Completion&lt;Failure&gt;) { print("Subscriber's completion: \(completion)") } } Publishers.fibonacci(count: .max(4)) .print() .sink { _ in } let subscriber = FibonacciSubscriber(limit: .max(3)) Publishers.fibonacci(count: .max(5)) .print() .subscribe(subscriber)</code> </pre></div></div><br><h1 id="rezultat">  рдкрд░рд┐рдгрд╛рдо </h1><br><p>  рдореБрдЭреЗ рдЙрдореНрдореАрдж рд╣реИ рдХрд┐ рдЗрд╕ рд▓реЗрдЦ рдиреЗ рдЖрдкрдХреЛ рдкреНрд░рдХрд╛рд╢рдХ, рд╕рджрд╕реНрдпрддрд╛ рдФрд░ рд╕рдмреНрд╕рдХреНрд░рд╛рдЗрдмрд░ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рд╕рдордЭ рдкреНрд░рджрд╛рди рдХреА рд╣реИ, рд╡реЗ рдПрдХ-рджреВрд╕рд░реЗ рдХреЗ рд╕рд╛рде рдХреИрд╕реЗ рдмрд╛рддрдЪреАрдд рдХрд░рддреЗ рд╣реИрдВ, рдФрд░ рдЬрдм рдЖрдк рдЕрдкрдиреЗ рдкреНрд░рдХрд╛рд╢рдХ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓реЗрддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ рдХрд┐рди рдмрд┐рдВрджреБрдУрдВ рдХреА рддрд▓рд╛рд╢ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдПред  рдХрд┐рд╕реА рднреА рдЯрд┐рдкреНрдкрдгреА, рд▓реЗрдЦ рдХреЗ рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг рдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИред </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi482690/">https://habr.com/ru/post/hi482690/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi482674/index.html">"рдЫреБрдЯреНрдЯрд┐рдпреЛрдВ рдХреЗ рддреБрд░рдВрдд рдмрд╛рдж": рдЖрдИрдЯреАрдПрдордУ рд╡рд┐рд╢реНрд╡рд╡рд┐рджреНрдпрд╛рд▓рдп рдореЗрдВ рд╕реЗрдорд┐рдирд╛рд░, рдорд╛рд╕реНрдЯрд░ рдХрдХреНрд╖рд╛рдПрдВ рдФрд░ рдкреНрд░реМрджреНрдпреЛрдЧрд┐рдХреА рдкреНрд░рддрд┐рдпреЛрдЧрд┐рддрд╛рдПрдВ</a></li>
<li><a href="../hi482678/index.html">рдореИрдВрдиреЗ рдХреИрд╕реЗ iOS рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд╛рда рдЦреЛрдЬ рдХрд░рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ рдФрд░ рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреНрдпрд╛ рдЖрдпрд╛</a></li>
<li><a href="../hi482682/index.html">Qt рдЯреВрд▓ рдСрдЯреЛрдореЗрд╢рди</a></li>
<li><a href="../hi482684/index.html">рдореИрдВрдиреЗ рджреЛ рд╕рдкреНрддрд╛рд╣ рдФрд░ $ 552 рдореЗрдВ рдЕрдкрдирд╛ рд╕реНрд╡рдпрдВ рдХрд╛ рдбрд┐рдкрдлреЗрдХ рдмрдирд╛рдпрд╛</a></li>
<li><a href="../hi482686/index.html">рд╡реИрдЬреНрдЮрд╛рдирд┐рдХ рдорд╕реНрддрд┐рд╖реНрдХ рд╕рдорд╛рд░реЛрд╣ рдХреЛ рдбрд┐рдХреЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╢реБ рд╡реНрдпрд╡рд╣рд╛рд░ рдЕрдиреБрд╕рдВрдзрд╛рди рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рддреЗ рд╣реИрдВ</a></li>
<li><a href="../hi482692/index.html">рдЗрдВрдЯреЗрд▓ рдПрдирдпреВрд╕реА рд╣реЛрдо рдлреЙрд░ рд╡рд░реНрдХ рдПрдВрдб рд╡рд░реНрдЪреБрдЕрд▓рд╛рдЗрдЬреЗрд╢рди</a></li>
<li><a href="../hi482694/index.html">рдХреНрдпрд╛ рд╡рд┐рдВрдбреЛрдЬ рдХреЗ рдмрд╛рдж рдЬреАрд╡рди рд╣реИ рдпрд╛ рдЬрд╣рд╛рдВ 2020 рдореЗрдВ рд╡рд┐рдВрдбреЛрдЬ рд╕рд┐рд╕реНрдЯрдо рдПрдбрдорд┐рдирд┐рд╕реНрдЯреНрд░реЗрдЯрд░ / рдЗрдВрдЬреАрдирд┐рдпрд░ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рдирд╛ рд╣реИ?</a></li>
<li><a href="../hi482696/index.html">рд╡рд┐рдВрдбреЛрдЬ рд▓рд┐рдирдХреНрд╕ рд╕реНрдерд╛рдкрд┐рдд рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рдлреБрд▓ рдбрд┐рд╕реНрдХ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рдиред рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдорд▓реНрдЯреАрдмреВрдЯ</a></li>
<li><a href="../hi482698/index.html">[рдирд┐рдмрдВрдз] рдХрд╛рд░реНрдпрд╛рд▓рдп рдкреНрд▓реИрдВрдХрдЯрди рдХреЛ рд╕рдорд░реНрдкрд┐рддред рдореИрдВ рдЕрдкрдиреЗ рдХрд╛рдо рд╕реЗ рдкреНрд░реЗрд░рд┐рдд рдирд╣реАрдВ рд╣реВрдВ</a></li>
<li><a href="../hi482700/index.html">Google рдФрд░ рдпреИрдВрдбреЗрдХреНрд╕ рдХреЛ "рдмрдХрд╡рд╛рд╕" рдХреИрд╕реЗ рдХрд░реЗрдВ: рд╕рд╛рдЗрдЯреЛрдВ рдХрд╛ рдХрд╛рд▓рд╛ рдФрд░ рд╕рдлреЗрдж рдПрд╕рдИрдУ-рдкреНрд░рдЪрд╛рд░ред Shestakov | рд▓реЛрдЧ рдкреАрдЖрд░рдУ # 74</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>