<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö´ ‚û°Ô∏è üë®üèº‚Äçü§ù‚Äçüë®üèª Uso de Liquibase para administrar la estructura de la base de datos en una aplicaci√≥n Spring Boot. Parte 1 ‚ò¢Ô∏è üíÜüèΩ ‚õπüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo, analizar√© el uso de la utilidad Liquibase en las aplicaciones Spring Boot para versionar la estructura de una base de datos relacion...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Uso de Liquibase para administrar la estructura de la base de datos en una aplicaci√≥n Spring Boot. Parte 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460377/"> En este art√≠culo, analizar√© el uso de la utilidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Liquibase</a> en las aplicaciones Spring Boot para versionar la estructura de una base de datos relacional y migrar esta estructura de una versi√≥n a otra.  En la primera parte, analizaremos el ejemplo b√°sico, y en la segunda hablaremos sobre el uso de <i>liquibase-mave-plugin</i> para revertir los cambios y generar autom√°ticamente scripts comparando las estructuras de la base de datos. <br><br>  Comencemos creando la aplicaci√≥n m√°s simple en Spring Boot + JPA (Hibernate).  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Spring Initializr</a> nos ayudar√° con esto.  De las dependencias, seleccione JPA, MySQL y Web.  Liquibase tambi√©n se puede conectar en este paso, pero para una mejor comprensi√≥n lo haremos m√°s adelante manualmente. <br><a name="habracut"></a><br><h4>  Crea la base de la aplicaci√≥n </h4><br>  Agregamos una clase de entidad a nuestra aplicaci√≥n, as√≠ como un repositorio y un controlador REST para trabajar con ella.  Para concretar, almacenaremos informaci√≥n sobre los usuarios en la entidad creada. <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"users"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span>(strategy = GenerationType.IDENTITY) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"id"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"username"</span></span>, unique = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String userName; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"password"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String password; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"first_name"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String firstName; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"last_name"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String lastName; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"email"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String email; <span class="hljs-comment"><span class="hljs-comment">//    ,    //    Lombok }</span></span></code> </pre> <br>  Spring Data hace que el c√≥digo del repositorio sea extremadamente conciso <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Long</span></span></span><span class="hljs-class">&gt; </span></span>{ }</code> </pre> <br>  Controlador REST que mostrar√° todo el contenido de la tabla de usuario <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UserRepository userRepository; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserRepository userRepository)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userRepository = userRepository; } <span class="hljs-meta"><span class="hljs-meta">@GetMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/user/all"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">allUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> userRepository.findAll(); } }</code> </pre> <br>  Configuraci√≥n en el archivo <i>application.properties</i> <br><br><pre> <code class="plaintext hljs">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver spring.datasource.url=jdbc:mysql://localhost:3306/geek_db?createDatabaseIfNotExist=true&amp;allowPublicKeyRetrieval=true&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC spring.datasource.username=dbuser spring.datasource.password=dbpassword spring.jpa.show-sql=true spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL5Dialect</code> </pre><br>  Se supone que su computadora est√° ejecutando un servidor MySQL en un puerto est√°ndar.  Si es necesario, ajuste la URL del servidor en la cadena de conexi√≥n, as√≠ como el nombre de usuario y la contrase√±a.  Tambi√©n vale la pena prestar atenci√≥n al par√°metro <i>createDatabaseIfNotExist</i> .  Gracias a √©l, al conectarnos, crearemos una base de datos llamada <i>geek_db</i> si no est√° en el servidor. <br><br><h4>  A√±adir liquibase </h4><br>  Seguramente not√≥ que <i>falta</i> una configuraci√≥n para Hibernate, es decir, <i>spring.jpa.hibernate.ddl-auto</i> .  En la mayor√≠a de los manuales para principiantes, el valor de <i>actualizaci√≥n</i> est√° indicado para ello, debido a que Hibernate crear√° y ajustar√° la estructura de la tabla en el propio servidor, en funci√≥n de las clases de entidad presentes en el proyecto.  Este enfoque bien puede usarse si el esquema de datos es muy simple o si el proyecto est√° entrenando, pero con un esquema algo complicado, lo m√°s probable es que comiencen los problemas, aunque solo sea porque no podemos controlar el proceso de generar secuencias de comandos DDL de Hibernate.  Otro problema es que con este enfoque no hay una manera f√°cil de revertir los cambios realizados en Hibernate en la estructura de la base de datos. <br><br>  Es para resolver los problemas anteriores que usaremos la utilidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Liquibase</a> .  Afortunadamente para nosotros, ¬°es perfectamente capaz de integrarse con las aplicaciones Spring Boot!  Para comenzar a usarlo, debe realizar los siguientes pasos <br><br>  Agregue la configuraci√≥n al archivo <i>application.properties</i> <br><br><pre> <code class="plaintext hljs">spring.jpa.hibernate.ddl-auto=none</code> </pre> <br>  Esto es para garantizar que Hibernate no tome ninguna medida para modificar el circuito, ya que  Liquibase los har√° ahora.  Te√≥ricamente, aqu√≠ tambi√©n puede usar el valor de <i>validaci√≥n</i> para un control adicional sobre la correcci√≥n de la estructura de la tabla. <br><br>  Agregar una dependencia a <i>pom.xml</i> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.liquibase<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>liquibase-core<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Despu√©s de agregarlo, Spring boot crear√° autom√°ticamente un bean especial llamado liquibase, que realizar√° todas las acciones para configurar el esquema de la base de datos basado en los scripts de Liquibase cada vez que se inicie la aplicaci√≥n. <br><br>  Ahora debe agregar el script Liquibase, que crear√° la tabla que necesitamos.  En la carpeta / src / main / resources / db / changelog, cree un archivo llamado db.changelog-master.yaml y agregue los siguientes contenidos <br><br><pre> <code class="plaintext hljs">databaseChangeLog: - logicalFilePath: db/changelog/db.changelog-lesson1.yaml - changeSet: id: 1 author: your_liquibase_username changes: - createTable: tableName: users columns: - column: name: id type: BIGINT autoIncrement: true constraints: primaryKey: true nullable: false - column: name: username type: varchar(50) constraints: unique: true nullable: false - column: name: password type: varchar(512) constraints: nullable: false - column: name: first_name type: varchar(50) - column: name: last_name type: varchar(50) - column: name: email type: varchar(50)</code> </pre> <br>  Analicemos el contenido de este script.  En primer lugar, contiene un cambio de conjunto.  ChangeSet es un an√°logo de una confirmaci√≥n en sistemas de control de versiones como Git o SVN.  Por analog√≠a con un commit, los cambios que se realizaron como parte de un changeSet se pueden transferir o volver al servidor de la base de datos.  Cada changeSet debe tener un identificador √∫nico con el que Liquibase determina si un determinado changeSet se ha bombeado a esta base de datos o no. <br><br>  ChangeSet contiene un comando para crear una tabla, y Liquibase describe la estructura de la tabla, y no un script SQL.  Gracias a esto, este archivo se convierte en multiplataforma.  Liquibase generar√° un script SQL dependiendo del servidor de base de datos utilizado.  Adem√°s, si necesitamos revertir el changeSet dado, Liquibase podr√° crear autom√°ticamente un script para eliminar la tabla dada.  Si utilizamos scripts SQL, entonces tendr√≠amos que escribir manualmente un script para revertir los cambios.  En la secci√≥n de <i>cambios</i> , solo tenemos un equipo y esto se considera una buena pr√°ctica, a pesar del hecho de que puede haber cualquier n√∫mero de equipos en un solo <i>cambio</i> . <br><br>  El c√≥digo escrito es suficiente para ejecutar el programa, pero para ver m√°s claramente los resultados de su trabajo, agreguemos otro <i>changeSet</i> , que llenar√° la tabla con datos. <br><br><pre> <code class="plaintext hljs"> - changeSet: id: 2 author: your_liquibase_username comment: "Create admin user" changes: - insert: tableName: users columns: - column: name: username value: "admin" - column: name: password value: "admin" - column: name: email value: "admin@server.com" - insert: tableName: users columns: - column: name: username value: "guest" - column: name: password value: "guest" - column: name: email value: "guest@server.com" rollback: - delete: tableName: users where: username in ('admin', 'guest')</code> </pre> <br>  En este caso, ya ten√≠amos que escribir manualmente un bloque para operaciones de reversi√≥n, como  Liquibase no puede crear autom√°ticamente SQL de reversi√≥n cuando se trabaja con datos.  En general, trabajar con datos en la base de datos no se encuentra entre las caracter√≠sticas clave de Liquibase y se limita solo a las operaciones m√°s simples de inserci√≥n, eliminaci√≥n o cambio.  Por cierto, si necesita m√°s, aqu√≠ puede usar las herramientas de la compa√±√≠a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Red Gate</a> . <br><br>  Entonces, ejecutemos nuestra aplicaci√≥n e intentemos seguir el enlace <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http: // localhost: 8080 / user / all</a> .  Si se inici√≥ la aplicaci√≥n, ver√° una respuesta JSON con informaci√≥n sobre los dos usuarios que se agregaron a la tabla.  Tambi√©n vale la pena echar un vistazo a los registros de inicio de la aplicaci√≥n, en los que puede ver los scripts que Liquibase ejecuta para inicializar la base de datos.  Se debe prestar especial atenci√≥n a la tabla <i>DATABASECHANGELOG</i> .  Es all√≠ donde Liquibase almacena el registro de los cambios realizados en la base de datos. <br><br>  Eso es todo por ahora.  Despu√©s de alg√∫n tiempo, planeo publicar una continuaci√≥n sobre el uso de <i>liquibase-maven-plugin</i> para generar autom√°ticamente scripts al comparar las estructuras de la base de datos y revertir los cambios realizados. <br><br>  Estar√≠a agradecido por cualquier adici√≥n y comentario! <br><br>  PS C√≥digo completo escrito basado en este art√≠culo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/usharik/spring-liquibase-demo/tree/part-1</a> <br><br>  Contin√∫a en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">habr.com/en/post/460907</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/460377/">https://habr.com/ru/post/460377/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460363/index.html">7 factores faltantes en el enfoque 12 Factor App</a></li>
<li><a href="../460365/index.html">Rastreo distribuido: hicimos todo mal</a></li>
<li><a href="../460367/index.html">Ingenier√≠a del Caos: el arte de la destrucci√≥n intencional. Parte 1</a></li>
<li><a href="../460373/index.html">Under the Hood Turbo Pages: Arquitectura de la p√°gina web Tecnolog√≠a de descarga r√°pida</a></li>
<li><a href="../460375/index.html">Libro "Aprendizaje autom√°tico para empresas y marketing"</a></li>
<li><a href="../460381/index.html">¬øQu√© es la asertividad y por qu√© es necesaria?</a></li>
<li><a href="../460383/index.html">Las transiciones de pantalla en Legend of Zelda usan las funciones no documentadas de NES</a></li>
<li><a href="../460387/index.html">Gu√≠a para principiantes de SELinux</a></li>
<li><a href="../460393/index.html">Antecedentes: qu√© esperar de Fedora Silverblue</a></li>
<li><a href="../460395/index.html">La anal√≠tica como caracter√≠stica: el proceso de trabajar con datos en Plesk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>