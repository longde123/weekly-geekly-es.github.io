<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚Ü©Ô∏è üë®‚Äçüíº üôéüèΩ Proxy PHP Xdebug: lorsque les fonctionnalit√©s standard de Xdebug ne suffisent pas üë®üèª‚Äçüî¨ ü¶é ‚òØÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pour d√©boguer les programmes PHP, utilisez souvent Xdebug . Cependant, les fonctionnalit√©s standard de l'IDE et de Xdebug ne sont pas toujours suffisa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Proxy PHP Xdebug: lorsque les fonctionnalit√©s standard de Xdebug ne suffisent pas</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/442504/"><p><img src="https://habrastorage.org/webt/qr/30/pd/qr30pdoglljz7da1c8uooyutxu8.jpeg" alt="Proxy PHP Xdebug: lorsque les fonctionnalit√©s standard de Xdebug ne suffisent pas"></p><br><p>  Pour d√©boguer les programmes PHP, utilisez souvent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Xdebug</a> .  Cependant, les fonctionnalit√©s standard de l'IDE et de Xdebug ne sont pas toujours suffisantes.  Certains des probl√®mes peuvent √™tre r√©solus en utilisant le proxy Xdebug - pydbgpproxy, mais toujours pas tous.  Par cons√©quent, j'ai impl√©ment√© le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">proxy PHP Xdebug</a> bas√© sur le cadre asynchrone amphp. </p><br><p>  Sous la coupe, je vais vous dire ce qui ne va pas avec pydbgpproxy, ce qui manque et pourquoi je ne l'ai pas modifi√©.  Je vais √©galement expliquer comment fonctionne le proxy PHP Xdebug et montrer comment l'√©tendre √† l'aide d'un exemple. <a name="habracut"></a></p><br><h2 id="pydbgpproxy-vs-php-xdebug-proxy">  Pydbgpproxy vs proxy PHP Xdebug </h2><br><p>  Le proxy Xdebug est un service interm√©diaire entre l'IDE et Xdebug (les demandes de proxy de Xdebug √† l'IDE et vice versa).  Le plus souvent, il est utilis√© pour le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©bogage multi-utilisateur</a> .  C'est quand vous avez un serveur Web et plusieurs d√©veloppeurs. </p><br><p>  En tant que proxy, pydbgpproxy est g√©n√©ralement utilis√©.  Mais il a quelques probl√®mes: </p><br><ul><li>  pas de page officielle; </li><li>  difficile de trouver o√π le t√©l√©charger;  il s'av√®re que cela peut √™tre fait <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> - tout d'un coup, Python Remote Debugging Client; </li><li>  Je n'ai pas trouv√© le d√©p√¥t officiel; </li><li>  en raison du paragraphe pr√©c√©dent, il n'est pas clair o√π introduire la demande de retrait; </li><li>  proxy, comme son nom l'indique, est √©crit en Python, ce que tous les d√©veloppeurs PHP ne connaissent pas, ce qui signifie que son expansion est un probl√®me; </li><li>  suite du paragraphe pr√©c√©dent: s'il y a du code en PHP, et qu'il devra √™tre utilis√© en proxy, alors il devra √™tre port√© en Python, et la duplication de code n'est pas toujours tr√®s bonne. </li></ul><br><p>  Une recherche d'un proxy Xdebug √©crit en PHP sur GitHub et sur Internet n'a donn√© aucun r√©sultat.  J'ai donc √©crit le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">proxy PHP Xdebug</a> .  Sous le capot, j'ai utilis√© le cadre asynchrone <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">amphp</a> . </p><br><p>  Les principaux avantages du proxy PHP Xdebug par rapport √† pydbgpproxy: </p><br><ul><li>  Le proxy PHP Xdebug est √©crit dans un langage familier aux d√©veloppeurs PHP, ce qui signifie: <br><ul><li>  il est plus facile d'y r√©soudre des probl√®mes; </li><li>  il est plus facile √† √©tendre; </li></ul></li><li>  Le proxy PHP Xdebug a un r√©f√©rentiel public, ce qui signifie: <br><ul><li>  Vous pouvez le bifurquer et le finir selon vos besoins; </li><li>  Vous pouvez envoyer une demande d'extraction avec une fonctionnalit√© manquante ou une solution √† un probl√®me. </li></ul></li></ul><br><h2 id="kak-rabotat-s-php-xdebug-proxy">  Comment travailler avec le proxy PHP Xdebug </h2><br><h3 id="ustanovka">  L'installation </h3><br><p>  Le proxy PHP Xdebug peut √™tre install√© en tant que d√©pendance de dev via le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">composeur</a> : </p><br><pre><code class="bash hljs">composer.phar require mougrim/php-xdebug-proxy --dev</code> </pre> <br><p>  Mais si vous ne souhaitez pas faire glisser des d√©pendances suppl√©mentaires dans votre projet, le proxy PHP Xdebug peut √™tre install√© en tant que projet via le m√™me compositeur: </p><br><pre> <code class="bash hljs">composer.phar create-project mougrim/php-xdebug-proxy <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-xdebug-proxy</code> </pre> <br><p>  Le proxy PHP Xdebug est extensible, mais <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ext-dom</a> est requis par d√©faut (l'extension est activ√©e par d√©faut en PHP) pour analyser XML et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">amphp / log</a> pour la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">journalisation</a> asynchrone: </p><br><pre> <code class="bash hljs">composer.phar require amphp/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> <span class="hljs-string"><span class="hljs-string">'^1.0.0'</span></span></code> </pre> <br><h3 id="zapusk">  Lancement </h3><br><p><img src="https://habrastorage.org/webt/jb/n4/dc/jbn4dcyqwpirx7koyqjzwxfwozc.jpeg" alt="Proxy PHP Xdebug"></p><br><p>  Le proxy d√©marre comme suit: </p><br><pre> <code class="bash hljs">bin/xdebug-proxy</code> </pre> <br><p>  Le proxy commencera avec les param√®tres par d√©faut: </p><br><pre> <code class="plaintext hljs">Using config path /path/to/php-xdebug-proxy/config [2019-02-14 10:46:24] xdebug-proxy.NOTICE: Use default ide: 127.0.0.1:9000 array ( ) array ( ) [2019-02-14 10:46:24] xdebug-proxy.NOTICE: Use predefined ides array ( 'predefinedIdeList' =&gt; array ( 'idekey' =&gt; '127.0.0.1:9000', ), ) array ( ) [2019-02-14 10:46:24] xdebug-proxy.NOTICE: [Proxy][IdeRegistration] Listening for new connections on '127.0.0.1:9001'... array ( ) array ( ) [2019-02-14 10:46:24] xdebug-proxy.NOTICE: [Proxy][Xdebug] Listening for new connections on '127.0.0.1:9002'... array ( ) array ( )</code> </pre> <br><p>  Dans le journal, vous pouvez voir que le proxy par d√©faut: </p><br><ul><li>  √©coute <code>127.0.0.1:9001</code> pour les connexions de connexion IDE; </li><li>  √©coute <code>127.0.0.1:9002</code> pour les connexions Xdebug; </li><li>  utilise <code>127.0.0.1:9000</code> comme IDE par d√©faut et IDE pr√©d√©fini avec cl√© idekey. </li></ul><br><h3 id="konfiguraciya">  La configuration </h3><br><p>  Si vous souhaitez configurer des ports d'√©coute, etc., vous pouvez sp√©cifier le chemin d'acc√®s au dossier des param√®tres.  Copiez simplement le dossier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">config</a> : </p><br><pre> <code class="bash hljs">cp -r /path/to/php-xdebug-proxy/config /your/custom/path</code> </pre> <br><p>  Il y a trois fichiers dans le dossier des param√®tres: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>config.php</code></a> : <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'xdebugServer'</span></span> =&gt; [ <span class="hljs-comment"><span class="hljs-comment">// host:port    Xdebug 'listen' =&gt; '127.0.0.1:9002', ], 'ideServer' =&gt; [ //  proxy    IDE,     IDE  , //    IDE  ,     . // IDE   ,  proxy    . 'defaultIde' =&gt; '127.0.0.1:9000', //  IDE    'idekey' =&gt; 'host:port', //   IDE  ,     . //  IDE ,   proxy  , //           proxy. 'predefinedIdeList' =&gt; [ 'idekey' =&gt; '127.0.0.1:9000', ], ], 'ideRegistrationServer' =&gt; [ // host:port     IDE, //     IDE,     . 'listen' =&gt; '127.0.0.1:9001', ], ];</span></span></code> </pre> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>logger.php</code></a> : vous pouvez configurer l'enregistreur;  le fichier doit renvoyer un objet qui est une instance de <code>\Psr\Log\LoggerInterface</code> , la valeur par d√©faut est <code>\Monolog\Logger</code> avec <code>\Amp\Log\StreamHandler</code> (pour l'enregistrement non bloquant), affiche les journaux sur stdout; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>factory.php</code></a> : vous pouvez configurer les classes utilis√©es dans le proxy;  le fichier doit renvoyer un objet qui est une instance de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>Factory\Factory</code></a> , la valeur par d√©faut est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>Factory\DefaultFactory</code></a> . </li></ul><br><p>  Apr√®s avoir copi√© les fichiers, vous pouvez modifier et ex√©cuter le proxy: </p><br><pre> <code class="bash hljs">bin/xdebug-proxy --configs=/your/custom/path/config</code> </pre> <br><h3 id="otladka">  D√©bogage </h3><br><p>  De nombreux articles ont √©t√© √©crits sur la fa√ßon de d√©boguer du code √† l'aide de Xdebug.  Je noterai les points principaux. </p><br><p>  Dans php.ini, les param√®tres suivants doivent se trouver dans la section <code>[xdebug]</code> (corrigez-les s'ils diff√®rent des param√®tres standard): </p><br><ul><li>  idekey = idekey </li><li>  remote_host = 127.0.0.1 </li><li>  remote_port = 9002 </li><li>  remote_enable = On </li><li>  remote_autostart = On </li><li>  remote_connect_back = Off </li></ul><br><p>  Ensuite, vous pouvez ex√©cuter du code PHP d√©bogu√©: </p><br><pre> <code class="bash hljs">php /path/to/your/script.php</code> </pre> <br><p>  Si vous avez tout fait correctement, le d√©bogage commencera √† partir du premier point d'arr√™t dans l'EDI.  Le d√©bogage en mode php-fpm par plusieurs d√©veloppeurs d√©passe le cadre de cet article, mais est d√©crit, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><h2 id="rasshirenie-funkciy-proxy">  Fonctionnalit√©s du proxy d'extension </h2><br><p>  Tout ce que nous avons examin√© ci-dessus, pydbgpproxy est √©galement capable √† un degr√© ou √† un autre. </p><br><p>  Parlons maintenant du plus int√©ressant du proxy PHP Xdebug.  Les proxys peuvent √™tre √©tendus √† l'aide de votre propre usine (cr√©√©e dans la configuration <code>factory.php</code> , voir ci-dessus).  L'usine doit impl√©menter l'interface <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>Factory\Factory</code></a> . </p><br><p>  Les plus puissants sont les soi-disant pr√©parateurs de requ√™tes.  Ils peuvent modifier les requ√™tes de Xdebug vers l'IDE et vice versa.  Pour ajouter un <code>Factory\DefaultFactory::createRequestPreparers()</code> requ√™tes, vous devez remplacer la m√©thode <code>Factory\DefaultFactory::createRequestPreparers()</code> .  La m√©thode renvoie un tableau d'objets qui impl√©mentent l'interface <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>RequestPreparer\RequestPreparer</code></a> .  Lors du proxy d'une demande de Xdebug √† l'IDE, ils sont ex√©cut√©s dans l'ordre direct; lors du proxy d'une requ√™te de l'IDE √† Xdebug, il est invers√©. </p><br><p>  Les gestionnaires de requ√™tes peuvent √™tre utilis√©s, par exemple, pour modifier les chemins d'acc√®s aux fichiers (dans les points d'arr√™t et les fichiers ex√©cutables). </p><br><h3 id="debag-perepisannyh-faylov">  D√©boguer les fichiers remplac√©s </h3><br><p>  Afin de donner un exemple de pr√©parateur, je vais faire une petite digression.  Dans les tests unitaires, nous utilisons des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">soft-mocks</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> ).  Soft-mocks vous permet de remplacer des fonctions, des m√©thodes statiques, des constantes, etc. dans les tests, est une alternative pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">runkit</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">uopz</a> .  Cela fonctionne en r√©√©crivant les fichiers PHP √† la vol√©e.  De m√™me, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AspectMock</a> fonctionne toujours. </p><br><p>  Mais les fonctionnalit√©s standard de Xdebug et IDE vous permettent de d√©boguer r√©√©crit (avec un chemin diff√©rent), plut√¥t que les fichiers d'origine. </p><br><p>  Examinons de plus pr√®s le probl√®me de d√©bogage √† l'aide de soft-mocks dans les tests.  Tout d'abord, prenons le cas o√π le code PHP est ex√©cut√© localement. </p><br><p>  Les premi√®res difficult√©s apparaissent au stade de la d√©finition des points d'arr√™t (points d'arr√™t).  Dans l'EDI, ils sont install√©s dans les fichiers d'origine, pas dans les fichiers r√©√©crits.  Pour mettre un point d'arr√™t via l'EDI, vous devez trouver le fichier r√©√©crit r√©el.  Le probl√®me est aggrav√© par le fait que chaque fois que le fichier d'origine est modifi√©, un nouveau fichier r√©√©crit est cr√©√©, c'est-√†-dire que pour chaque contenu de fichier unique, il y aura un fichier r√©√©crit unique. </p><br><p>  Ce probl√®me peut √™tre r√©solu en appelant la fonction <code>xdebug_break()</code> , qui est similaire √† la d√©finition d'un point d'arr√™t.  Dans ce cas, il n'est pas n√©cessaire de rechercher un fichier r√©√©crit. </p><br><p>  Consid√©rez maintenant la situation plus compliqu√©e: l'application s'ex√©cute sur une machine distante. </p><br><p>  Dans ce cas, vous pouvez monter le dossier avec les fichiers r√©√©crits, par exemple, via SSHFS.  Si les chemins d'acc√®s local et distant vers le dossier sont diff√©rents, vous devez toujours enregistrer les mappages dans l'EDI. </p><br><p>  D'une mani√®re ou d'une autre, cette m√©thode est l√©g√®rement diff√©rente de la m√©thode habituelle et vous permet de d√©boguer uniquement les fichiers copi√©s, mais pas ceux d'origine.  Mais je veux toujours √©diter et d√©boguer les m√™mes fichiers originaux. </p><br><p>  AspectMock a r√©solu le probl√®me en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">activant le mode d√©bogage</a> sans la possibilit√© de le d√©sactiver: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $options = [])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($options[<span class="hljs-string"><span class="hljs-string">'excludePaths'</span></span>])) { $options[<span class="hljs-string"><span class="hljs-string">'excludePaths'</span></span>] = []; } $options[<span class="hljs-string"><span class="hljs-string">'debug'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; $options[<span class="hljs-string"><span class="hljs-string">'excludePaths'</span></span>][] = <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::init($options); }</code> </pre> <br><p>  Dans un exemple de test simple, le mode de d√©bogage est par la suite plus lent de 20%. Mais je n'ai pas assez de tests AspectMock pour donner une estimation plus pr√©cise de sa lenteur.  Si vous avez de nombreux tests sur AspectMock, je serai heureux si vous partagez la comparaison dans les commentaires. </p><br><h3 id="ispolzovanie-xdebug-s-soft-mocks">  Utiliser Xdebug avec des soft-mocks </h3><br><p><img src="https://habrastorage.org/webt/eu/3d/ui/eu3duipif0jihrhzwlquhfpywuc.jpeg" alt="Xdebug + soft-mocks"></p><br><p>  Maintenant que le probl√®me est clair, r√©fl√©chissez √† la mani√®re de le r√©soudre √† l'aide du proxy PHP Xdebug.  La partie principale se trouve dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>RequestPreparer\SoftMocksRequestPreparer</code></a> . </p><br><p>  Dans le constructeur de classe, d√©finissez le chemin d'acc√®s au script d'initialisation de soft-mocks et ex√©cutez-le (il est suppos√© que soft-mocks est connect√© en tant que d√©pendance, mais n'importe quel chemin peut √™tre transmis au constructeur): </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LoggerInterface $logger, string $initScript = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger = $logger; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$initScript) { $possibleInitScriptPaths = [ <span class="hljs-comment"><span class="hljs-comment">// proxy   , soft-mocks ‚Äî    __DIR__.'/../../vendor/badoo/soft-mocks/src/init_with_composer.php', // proxy  soft-mocks    __DIR__.'/../../../../badoo/soft-mocks/src/init_with_composer.php', ]; foreach ($possibleInitScriptPaths as $possiblInitScriptPath) { if (file_exists($possiblInitScriptPath)) { $initScript = $possiblInitScriptPath; break; } } } if (!$initScript) { throw new Error("Can't find soft-mocks init script"); } //  soft-mocks (       ..) require $initScript; }</span></span></code> </pre> <br><p><img src="https://habrastorage.org/webt/9p/8t/u7/9p8tu7eatpdhaewvfxvv2ossunu.jpeg" alt="Xdebug + soft-mocks: de Xdebug √† IDE"></p><br><p>  Pour pr√©parer une demande de Xdebug √† l'IDE, vous devez remplacer le chemin d'acc√®s au fichier r√©√©crit par le fichier d'origine: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareRequestToIde</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(XmlDocument $xmlRequest, string $rawRequest)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $context = [ <span class="hljs-string"><span class="hljs-string">'request'</span></span> =&gt; $rawRequest, ]; $root = $xmlRequest-&gt;getRoot(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$root) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($root-&gt;getChildren() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $child) { <span class="hljs-comment"><span class="hljs-comment">//         : // - 'stack': https://xdebug.org/docs-dbgp.php#stack-get // - 'xde</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">bug:</span></span></span><span class="hljs-comment">message': https://xdebug.org/docs-dbgp.php#error-notification if (!in_array($child-&gt;getName(), ['stack', 'xde</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">bug:</span></span></span><span class="hljs-comment">message'], true)) { continue; } $attributes = $child-&gt;getAttributes(); if (isset($attributes['filename'])) { //         ,      $filename = $this-&gt;getOriginalFilePath($attributes['filename'], $context); if ($attributes['filename'] !== $filename) { $this-&gt;logger-&gt;info("Change '{$attributes['filename']}' to '{$filename}'", $context); $child-&gt;addAttribute('filename', $filename); } } } }</span></span></code> </pre> <br><p><img src="https://habrastorage.org/webt/6h/qw/er/6hqwerwharffc9a_ylzobqxut9o.jpeg" alt="Xdebug + soft-mocks: de l'IDE √† Xdebug"></p><br><p>  Pour pr√©parer une demande de l'EDI √† Xdebug, vous devez remplacer le chemin d'acc√®s au fichier d'origine par le chemin d'acc√®s au fichier r√©√©crit: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareRequestToXdebug</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $request, CommandToXdebugParser $commandToXdebugParser)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       [$command, $arguments] = $commandToXdebugParser-&gt;parseCommand($request); $context = [ 'request' =&gt; $request, 'arguments' =&gt; $arguments, ]; if ($command === 'breakpoint_set') { //    -f,          // . https://xdebug.org/docs-dbgp.php#id3 if (isset($arguments['-f'])) { $file = $this-&gt;getRewrittenFilePath($arguments['-f'], $context); if ($file) { $this-&gt;logger-&gt;info("Change '{$arguments['-f']}' to '{$file}'", $context); $arguments['-f'] = $file; //    $request = $commandToXdebugParser-&gt;buildCommand($command, $arguments); } } else { $this-&gt;logger-&gt;error("Command {$command} is without argument '-f'", $context); } } return $request; }</span></span></code> </pre> <br><p>  Pour que le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>Factory\DefaultFactory</code></a> requ√™tes fonctionne, vous devez cr√©er votre classe d'usine et l'h√©riter de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>Factory\DefaultFactory</code></a> ou impl√©menter l'interface <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>Factory\Factory</code></a> .  Pour les soft-mocks, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>Factory\SoftMocksFactory</code></a> ressemble √† ceci: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SoftMocksFactory</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $config)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Config</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       return new SoftMocksConfig($config); } public function createRequestPreparers(LoggerInterface $logger, Config $config): array { $requestPreparers = parent::createRequestPreparers($logger, $config); return array_merge($requestPreparers, [$this-&gt;createSoftMocksRequestPreparer($logger, $config)]); } public function createSoftMocksRequestPreparer(LoggerInterface $logger, SoftMocksConfig $config): SoftMocksRequestPreparer { //     init-   return new SoftMocksRequestPreparer($logger, $config-&gt;getSoftMocks()-&gt;getInitScript()); } }</span></span></code> </pre> <br><p>  Ici, vous avez besoin de votre propre classe de configuration pour pouvoir sp√©cifier le chemin du script d'initialisation des soft-mocks.  Ce que c'est, vous pouvez le voir dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Config \ SoftMocksConfig</a> . </p><br><p>  Il ne restait plus que peu: cr√©er une nouvelle usine et indiquer le chemin vers le script d'initialisation des soft-mocks.  La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>softMocksConfig</code></a> √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>softMocksConfig</code></a> peut √™tre consult√©e dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>softMocksConfig</code></a> . </p><br><h3 id="neblokiruyuschiy-api">  API non bloquante </h3><br><p>  Comme je l'ai √©crit ci-dessus, le proxy PHP Xdebug utilise amphp sous le capot, ce qui signifie qu'une API non bloquante doit √™tre utilis√©e pour fonctionner avec les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">E / S.</a>  Apmphp poss√®de d√©j√† de nombreux composants qui impl√©mentent cette API non bloquante.  Si vous allez √©tendre le proxy PHP Xdebug et l'utiliser en mode multi-utilisateur, assurez-vous d'utiliser des API non bloquantes. </p><br><h2 id="vyvody">  Conclusions </h2><br><p>  Le proxy PHP Xdebug est encore un projet assez r√©cent, mais dans Badoo il est d√©j√† activement utilis√© pour d√©boguer des tests √† l'aide de soft-mocks. </p><br><p>  Proxy PHP Xdebug: </p><br><ul><li>  remplace pydbgpproxy dans le d√©bogage multi-utilisateurs; </li><li>  peut fonctionner avec des soft-mocks; </li><li>  peut √™tre √©tendu: <br><ul><li>  Vous pouvez remplacer les chemins d'acc√®s aux fichiers provenant de l'IDE et de Xdebug; </li><li>  des statistiques peuvent √™tre collect√©es: en mode d√©bogage, au moins le contexte ex√©cutable est disponible lors du d√©bogage (valeurs des variables et ligne de code ex√©cutable). </li></ul></li></ul><br><p>  Si vous utilisez le proxy Xdebug pour autre chose que le d√©bogage multi-utilisateur, partagez votre cas et le proxy Xdebug que vous utilisez dans les commentaires. </p><br><p>  Si vous utilisez pydbgpproxy ou un autre proxy Xdebug, essayez le proxy PHP Xdebug, informez-vous de vos probl√®mes, partagez les demandes de tirage.  D√©veloppons le projet ensemble!  :) </p><br><p>  PS Merci √† mon coll√®gue Yevgeny <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Makhrov</a> alias <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">eZH</a> pour l'id√©e du proxy <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">smdbgpproxy</a> ! </p><br><h2 id="eschyo-raz-ssylki">  Liens √† nouveau </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Proxy PHP Xdebug</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Proxy</a> Xdebug, qui est discut√© dans l'article; </li><li>  pydbgpproxy peut √™tre t√©l√©charg√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> - tout d'un coup, Python Remote Debugging Client; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">amphp</a> - framework PHP non bloquant asynchrone; </li><li>  outils pour maquettes: <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">moqueries</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AspectMock</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">uopz</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">runkit</a> . </li></ul></li></ul><br><p>  Merci de votre attention! </p><br><p>  Je serai heureux de recevoir des commentaires et suggestions. </p><br><p>  Rinat Akhmadeev, Sr.  D√©veloppeur PHP </p><br><p>  <strong>UPD</strong> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">traduction</a> publi√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de l'</a> article en anglais. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr442504/">https://habr.com/ru/post/fr442504/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr442494/index.html">Composant Figma et organisation des instances en utilisant Userpic comme exemple</a></li>
<li><a href="../fr442496/index.html">Cochon d'entreprise</a></li>
<li><a href="../fr442498/index.html">Top 10 des rapports de la conf√©rence C ++ Russia 2018: vid√©os compl√®tes, diapositives, commentaires</a></li>
<li><a href="../fr442500/index.html">Analyseur statique Detekt pour Kotlin</a></li>
<li><a href="../fr442502/index.html">Nous transformons le lieu de travail en v√©lo couch√© pour 200 $</a></li>
<li><a href="../fr442506/index.html">La Russie est-elle punie pour commerce ill√©gal de donn√©es personnelles?</a></li>
<li><a href="../fr442508/index.html">Comment udalenka acc√©l√®re l'innovation sur GitLab</a></li>
<li><a href="../fr442512/index.html">Personnalisation de Django ORM sur l'exemple de ZomboDB</a></li>
<li><a href="../fr442514/index.html">Syst√®mes distribu√©s. Mod√®les de conception. Critique de livre</a></li>
<li><a href="../fr442516/index.html">Pandas Guide to Big Data Analysis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>