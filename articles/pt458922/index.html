<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî∑ ‚òÑÔ∏è ‚è≥ Como passar do ESXi para o KVM / LXD e n√£o enlouquecer üñïüèø üëÇüèΩ üë®‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Por um longo tempo, a empresa Maxnet Systems usou a vers√£o gratuita do VMware - ESXi, come√ßando na vers√£o 5.0, como um hypervisor. A vers√£o paga do vS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como passar do ESXi para o KVM / LXD e n√£o enlouquecer</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/458922/">  Por um longo tempo, a empresa Maxnet Systems usou a vers√£o gratuita do VMware - ESXi, come√ßando na vers√£o 5.0, como um hypervisor.  A vers√£o paga do vSphere assustou o modelo de licenciamento, enquanto a vers√£o gratuita teve v√°rias desvantagens que n√£o estavam dispon√≠veis na vers√£o paga, mas voc√™ pode atend√™-las.  Mas quando nas novas vers√µes do ESXi a nova interface da Web se recusava a trabalhar com a antiga e o monitoramento das matrizes RAID deixou de mostrar sinais de vida, a empresa decidiu procurar uma solu√ß√£o mais universal e aberta.  A empresa j√° teve uma boa experi√™ncia e uma boa impress√£o do LXC - Linux Containers.  Portanto, ficou claro que o hipervisor dos sonhos ser√° h√≠brido e combinar√° KVM e LXD para diferentes cargas - uma continua√ß√£o evolutiva do LXC.  Procurando informa√ß√µes sobre a KVM, a empresa foi confrontada com conceitos err√¥neos, rakes e pr√°ticas prejudiciais, mas testes e tempo colocaram tudo no lugar. <br><br><img src="https://habrastorage.org/webt/s-/vc/6s/s-vc6shq5cfia5bjjcuhixbgukq.jpeg"><br><br>  Sobre como lidar com a mudan√ßa do ESXi para o KVM e n√£o dirigir com um ancinho, dir√° <strong>Lev Nikolaev</strong> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">maniaque</a> ) - administrador e desenvolvedor de sistemas altamente carregados, instrutor de tecnologia da informa√ß√£o.  Vamos falar sobre a rede, reposit√≥rios, cont√™ineres, KVM, LXD, LXC, provisionamento e m√°quinas virtuais convenientes. <br><a name="habracut"></a><br><h2>  Pr√≥logo </h2><br>  Identificaremos imediatamente os pensamentos-chave e analis√°-los-em mais detalhadamente. <br><br>  <strong>Rede.</strong>  Embora as velocidades de suas interfaces n√£o excedam 1 Gb / s, a ponte √© suficiente para voc√™.  Assim que voc√™ quiser espremer mais - isso o limitar√°. <br><br>  <strong>Reposit√≥rio.</strong>  Crie um armazenamento de rede compartilhado.  Mesmo se voc√™ n√£o estiver pronto para usar 10 Gbit / s dentro da rede, at√© 1 Gbit / s fornecer√° 125 MB / s de armazenamento.  Para v√°rias cargas, isso ser√° suficiente com uma margem e a migra√ß√£o de m√°quinas virtuais ser√° uma quest√£o elementar. <br><br>  <strong>Container ou KVM?</strong>  Pr√≥s, contras, armadilhas.  Quais tipos de carga s√£o melhor colocados em um cont√™iner e quais s√£o deixados em uma KVM? <br><br>  <strong>LXD ou LXC</strong> .  O LXD √© LXC?  Ou outra vers√£o?  Ou um complemento?  O que √© isso tudo?  Vamos dissipar mitos e entender as diferen√ßas entre LXD e LXC. <br><br>  <strong>Provisionamento conveniente</strong> .  O que √© mais conveniente: tire a mesma imagem ou instale o sistema sempre do zero?  Como fazer isso com rapidez e precis√£o todas as vezes? <br><br>  <strong>M√°quina virtual conveniente.</strong>  Haver√° hist√≥rias assustadoras sobre gerenciadores de inicializa√ß√£o, parti√ß√µes, LVM. <br><br>  <strong>Diversos</strong> .  Muitas pequenas perguntas: como arrastar rapidamente uma m√°quina virtual do ESXi para o KVM, como migrar bem, como virtualizar discos corretamente? <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/HqsxBkxGxqg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h2>  Motivo da realoca√ß√£o </h2><br>  De onde tiramos a id√©ia maluca de passar do ESXi para o KVM / LXD?  O ESXi √© popular entre pequenas e m√©dias empresas.  Este √© um hipervisor bom e barato.  Mas existem nuances. <br><br>  Come√ßamos com a vers√£o 5.0 - convenientemente, tudo funciona!  A pr√≥xima vers√£o 5.5 √© a mesma. <br><br>  Desde a vers√£o 6.0, j√° √© mais dif√≠cil.  No ESXi, a interface da Web n√£o ficou imediatamente livre, apenas a partir da vers√£o 6.5, antes que um utilit√°rio para Windows fosse necess√°rio.  N√≥s ag√ºentamos isso.  Quem executa o OS X compra o Parallels e instala esse utilit√°rio.  Esta √© uma dor bem conhecida. <br><br>  O monitoramento piscou periodicamente.  Era necess√°rio reiniciar os servi√ßos de gerenciamento no console do servidor - o CIM Heartbeat apareceu novamente.  N√≥s suportamos, porque ele nem sempre caiu. <br><br>  ESXi 6.5 - lixo, desperd√≠cios e atrocidades.  Hypervisor terr√≠vel.  E aqui est√° o porqu√™. <br><br><ul><li>  <strong>Angular cai com uma exce√ß√£o na entrada da interface da Web.</strong>  Assim que voc√™ digitar seu nome de usu√°rio e senha - imediatamente uma exce√ß√£o! </li><li>  <strong>A capacidade de monitorar remotamente o status da matriz RAID n√£o funciona</strong> , pois √© conveniente para n√≥s.  Costumava ser conveniente, mas na vers√£o 6.5, tudo est√° ruim. </li><li>  <strong>Suporte fraco para placas de rede modernas da Intel</strong> .  As placas de rede da Intel e ESXi causam dor.  H√° um encadeamento de agonia no f√≥rum de suporte do ESXi sobre isso.  VMware e Intel n√£o s√£o amigos e as rela√ß√µes n√£o melhorar√£o no futuro pr√≥ximo.  O triste √© que mesmo os clientes de solu√ß√µes pagas enfrentam problemas. </li><li>  <strong>Nenhuma migra√ß√£o no ESXi</strong> .  A menos que a migra√ß√£o seja considerada um procedimento de pausa, copie e inicie.  Colocamos o carro em pausa, o copiamos rapidamente e o iniciamos em outro lugar.  Mas √© imposs√≠vel cham√°-lo de migra√ß√£o - ainda existe uma simples. </li></ul><br>  Tendo analisado tudo isso, tivemos a ideia maluca de mudar com o ESXi 6.5. <br><br><h2>  Lista de desejos </h2><br>  Para come√ßar, escrevemos uma lista de desejos para um futuro ideal para o qual estamos indo. <br><br>  <strong>Gerenciamento sob SSH</strong> , Web e mais opcional.  A interface da web √© √≥tima, mas em uma viagem de neg√≥cios a partir de um iPhone, acessar a interface da web do ESXi e fazer algo √© inconveniente e dif√≠cil.  Portanto, a √∫nica maneira de gerenciar tudo √© SSH, n√£o haver√° outra. <br><br>  <strong>Virtualiza√ß√£o do Windows.</strong>  √Äs vezes, os clientes pedem coisas estranhas e nossa miss√£o √© ajud√°-los. <br><br>  <strong>Drivers sempre novos e a capacidade de configurar uma placa de rede</strong> .  Desejo adequado, mas n√£o realizado sob o ESXi puro. <br><br>  <strong>Migra√ß√£o ao vivo, n√£o em cluster</strong> .  Queremos a capacidade de arrastar m√°quinas de um hipervisor para outro sem sentir atrasos, tempo de inatividade ou inconveni√™ncia. <br><br>  A lista de desejos est√° pronta e uma pesquisa dif√≠cil foi iniciada. <br><br><h2>  Farinha de escolha </h2><br>  O mercado gira em torno de KVM ou LXC com diferentes molhos.  √Äs vezes parece que Kubernetes est√° em algum lugar acima, onde est√° tudo bem, o sol e o para√≠so, e no n√≠vel abaixo h√° Morlocks - KVM, Xen ou algo assim ... <br><br>  Por exemplo, o Proxmox VE √© o Debian, que foi extra√≠do pelo kernel do Ubuntu.  Parece estranho, mas traz para produ√ß√£o? <br><br>  Nossos vizinhos no andar de baixo s√£o o Alt Linux.  Eles criaram uma bela solu√ß√£o: reuniram o Proxmox VE como um pacote.  Eles apenas colocam o pacote em um comando.  Isso √© conveniente, mas n√£o colocamos o Alt Linux em produ√ß√£o, por isso n√£o nos convinha. <br><br><h3>  Take KVM </h3><br>  No final, escolhemos a KVM.  Eles n√£o aceitaram, Xen, por exemplo, por causa da comunidade - a KVM tem muito mais.  Parecia que sempre encontrar√≠amos a resposta para nossa pergunta.  Mais tarde descobrimos que o tamanho de uma comunidade n√£o afeta sua qualidade. <br><br>  Inicialmente, calculamos que usar√≠amos uma m√°quina Bare Metal, adicionar√≠amos o Ubuntu com o qual estamos trabalhando e rodaremos o KVM / LXD de cima.  Contamos com a capacidade de executar cont√™ineres.  O Ubuntu √© um sistema bem conhecido e n√£o h√° surpresas em termos de solu√ß√£o de problemas de inicializa√ß√£o / recupera√ß√£o para n√≥s.  N√≥s sabemos onde chutar se o hypervisor n√£o iniciar.  Tudo √© claro e conveniente para n√≥s. <br><br><h2>  KVM Crash Course </h2><br>  Se voc√™ √© do mundo do ESXi, encontrar√° muitas coisas interessantes.  Aprenda tr√™s palavras: QEMU, KVM e libvirt. <br><br>  <strong>O QEMU</strong> traduz os desejos de um sistema operacional virtualizado nos desafios de um processo regular.  Funciona muito bem em quase todos os lugares, mas lentamente.  O QEMU em si √© um produto independente que virtualiza v√°rios outros dispositivos. <br><br>  Mais adiante, aparece um monte de <strong>QEMU-KVM</strong> .  Este √© o m√≥dulo do kernel do Linux para QEMU.  A virtualiza√ß√£o de todas as instru√ß√µes √© cara, por isso temos um m√≥dulo do kernel do KVM que <strong>traduz apenas algumas instru√ß√µes</strong> .  Como resultado, isso √© significativamente mais r√°pido, porque apenas alguns por cento das instru√ß√µes do conjunto geral s√£o processadas.  Este √© todos os custos da virtualiza√ß√£o. <br><br>  Se voc√™ apenas possui QEMU, iniciar a m√°quina virtual sem liga√ß√£o fica assim: <br><br><pre><code class="plaintext hljs">$ qemu &lt; &gt;</code> </pre> <br>  Nos par√¢metros que voc√™ descreve a rede, bloqueie dispositivos.  Tudo √© maravilhoso, mas inconveniente.  Portanto, h√° libvirt. <br><br>  <strong>O objetivo da libvirt √© ser uma ferramenta √∫nica para todos os hipervisores</strong> .  Pode funcionar com qualquer coisa: com KVM, com LXD.  Parece que resta apenas aprender a sintaxe da libvirt, mas na realidade funciona pior do que na teoria. <br><br>  Essas tr√™s palavras s√£o tudo o que √© necess√°rio para aumentar a primeira m√°quina virtual no KVM.  Mas, novamente, h√° nuances ... <br><br>  O Libvirt possui uma configura√ß√£o na qual m√°quinas virtuais e outras configura√ß√µes s√£o armazenadas.  Ele armazena a configura√ß√£o em arquivos xml - elegante, moderno e direto dos anos 90.  Se desejado, eles podem ser editados manualmente, mas por que, se houver comandos convenientes.  Tamb√©m conveniente √© que as altera√ß√µes nos arquivos xml s√£o maravilhosamente versionadas.  Usamos o <strong>etckeeper</strong> - vers√£o do diret√≥rio etc.  J√° √© poss√≠vel usar o etckeeper e j√° √© tempo. <br><br><h2>  LXC Crash Course </h2><br>  Existem muitos conceitos errados sobre LXC e LXD. <br><br><blockquote>  LXC √© a capacidade do kernel moderno de usar espa√ßos de nome - para fingir que n√£o √© o n√∫cleo que era originalmente. </blockquote><br>  Voc√™ pode criar esses espa√ßos para nome quantos desejar para cada cont√™iner.  Formalmente, o n√∫cleo √© um, mas se comporta como muitos n√∫cleos id√™nticos.  O LXC permite executar cont√™ineres, mas fornece apenas ferramentas b√°sicas. <br><br>  A Canonical, que est√° por tr√°s do Ubuntu e agressivamente avan√ßando cont√™ineres para a frente, lan√ßou o <strong>LXD, um an√°logo da libvirt</strong> .  Essa √© uma liga√ß√£o que facilita a execu√ß√£o de cont√™ineres, mas ainda existe o LXC. <br><br><blockquote>  LXD √© um hypervisor de cont√™iner baseado em LXC. </blockquote><br>  A empresa reina no LXD.  O LXD armazena a configura√ß√£o em seu banco de dados - no diret√≥rio <code>/var/lib/lxd</code> .  L√°, o LXD leva sua configura√ß√£o para a configura√ß√£o no SQlite.  Copi√°-lo n√£o faz sentido, mas voc√™ pode anotar os comandos usados ‚Äã‚Äãpara criar a configura√ß√£o do cont√™iner. <br><br>  N√£o h√° descarga como tal, mas a maioria das altera√ß√µes √© automatizada pelas equipes.  Este √© um an√°logo do arquivo Docker, apenas com controle manual. <br><br><h2>  Produ√ß√£o </h2><br>  Com o que fomos confrontados quando todos navegamos em opera√ß√£o. <br><br><h3>  Rede </h3><br>  Quanto lixo infernal e confus√£o na Internet sobre a rede no KVM!  90% dos materiais dizem usar ponte. <br><br><blockquote>  Pare de usar a ponte! </blockquote><br>  O que h√° de errado com ele?  Ultimamente, tenho a sensa√ß√£o de que a insanidade est√° acontecendo com os cont√™ineres: coloque o Docker em cima do Docker para que voc√™ possa executar o Docker no Docker enquanto assiste ao Docker.  A maioria n√£o entende o que a ponte est√° fazendo. <br><br>  Ele coloca seu controlador de rede no <strong>modo prom√≠scuo</strong> e recebe todo o tr√°fego porque ele n√£o sabe qual e qual n√£o.  Como resultado, todo o tr√°fego da ponte passa por uma pilha Linux maravilhosa e r√°pida em rede, e h√° muitas c√≥pias.  No final, tudo √© lento e ruim.  Portanto, n√£o use bridge na produ√ß√£o. <br><br><h3>  SR-IOV </h3><br>  <strong>SR-IOV √© a capacidade de virtualizar dentro de uma placa de rede</strong> .  A pr√≥pria placa de rede √© capaz de alocar parte de si mesma para m√°quinas virtuais, o que requer algum suporte de hardware.  √â isso que impedir√° a migra√ß√£o.  Migrar uma m√°quina virtual em que o SR-IOV est√° ausente √© doloroso. <br><br>  O SR-IOV deve ser usado onde for suportado por todos os hipervisores como parte da migra√ß√£o.  Caso contr√°rio, o macvtap √© para voc√™. <br><br><h3>  macvtap </h3><br>  Isto √© para aqueles cuja placa de rede n√£o suporta SR-IOV.  Esta √© a vers√£o light da ponte: diferentes endere√ßos MAC est√£o pendurados em uma placa de rede e a <strong>filtragem unicast √© usada</strong> : a placa de rede n√£o aceita tudo, mas estritamente de acordo com a lista de endere√ßos MAC. <br><br>  Detalhes mais sangrentos podem ser encontrados na grande palestra de Toshiaki Makita <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">, Virtual Switching Technologies e Linux Bridge</a> .  Ele est√° cheio de dor e sofrimento. <br><br><blockquote>  90% dos materiais sobre como construir uma rede no KVM s√£o in√∫teis. </blockquote><br>  Se algu√©m diz que a ponte √© incr√≠vel, n√£o fale mais com ela. <br><br>  Com o macvtap, a <strong>CPU economiza cerca de 30%</strong> devido a menos c√≥pias.  Mas o modo prom√≠scuo tem suas pr√≥prias nuances.  Voc√™ n√£o pode se conectar √† interface de rede da m√°quina convidada a partir do pr√≥prio hipervisor - do host.  Um relat√≥rio da Toshiaki detalha isso.  Mas em suma - n√£o vai funcionar. <br><br>  Desde o pr√≥prio hipervisor, raramente o SSH.  √â mais conveniente iniciar um console l√°, por exemplo, um console Win.  √â poss√≠vel ‚Äúobservar‚Äù o tr√°fego na interface - voc√™ n√£o pode se conectar via TCP, mas o tr√°fego no hipervisor √© vis√≠vel. <br><br><blockquote>  Se suas velocidades estiverem acima de 1 Gigabit - escolha macvtap. </blockquote><br>  Em velocidades de interface de at√© ou aproximadamente 1 Gigabit por segundo, tamb√©m √© poss√≠vel usar a ponte.  Mas se voc√™ tem uma placa de rede de 10 Gb e deseja descart√°-la de alguma forma, resta apenas o macvtap.  N√£o h√° outras op√ß√µes.  Exceto SR-IOV. <br><br><h3>  systemd-networkd </h3><br>  <strong>Essa √© uma √≥tima maneira de armazenar a configura√ß√£o de rede no pr√≥prio hypervisor</strong> .  No nosso caso, este √© o Ubuntu, mas para outros sistemas, o systemd funciona. <br><br>  Costum√°vamos ter um arquivo <code>/etc/network/interfaces</code> no qual todos mant√≠amos.  Um arquivo √© inconveniente para editar sempre - systemd-networkd permite dividir a configura√ß√£o em uma dispers√£o de arquivos pequenos.  Isso √© conveniente porque funciona com qualquer sistema de vers√£o: foi enviado ao Git e voc√™ v√™ quando e que mudan√ßa aconteceu. <br><br>  Existe uma falha que nossos membros da rede descobriram.  Quando voc√™ precisa adicionar uma nova VLAN no hypervisor, eu vou configurar.  Ent√£o eu digo: "systemctl restart systemd-networkd".  Neste momento, est√° tudo bem comigo, mas se as sess√µes BGP desta m√°quina forem geradas, elas ser√£o interrompidas.  Nossos membros da rede n√£o aprovam isso. <br><br>  Para o hipervisor, nada de ruim acontece.  Systemd-networkd n√£o √© adequado para fronteiras, servidores com BGP elevado e para hipervisores - excelente. <br><br>  Systemd-networkd est√° longe de ser final e nunca ser√° conclu√≠do.  Mas isso √© mais conveniente do que editar um arquivo enorme.  Uma alternativa ao systemd-networkd no Ubuntu 18.04 √© o Netplan.  Esta √© uma maneira "legal" de configurar a rede e entrar no rake. <br><br><h3>  Dispositivo de rede </h3><br>  Depois de instalar o KVM e o LXD no hypervisor, a primeira coisa que voc√™ ver√° s√£o duas pontes.  Um criou a KVM para si e o segundo - LXD. <br><br><blockquote>  LXD e KVM est√£o tentando implantar sua rede. </blockquote><br>  Se voc√™ ainda precisar de uma ponte - para m√°quinas de teste ou para jogar, mate a ponte, que est√° ativada por padr√£o e crie a sua - a que voc√™ deseja.  KVM ou LXD fazem isso terrivelmente - escorregar dnsmasq, e o horror come√ßa. <br><br><h3>  Armazenamento </h3><br><blockquote>  N√£o importa quais implementa√ß√µes voc√™ gosta - use armazenamento compartilhado. </blockquote><br>  Por exemplo, iSCSI para m√°quinas virtuais.  Voc√™ n√£o se livrar√° do "ponto de falha", mas poder√° <strong>consolidar o armazenamento em um ponto</strong> .  Isso abre novas oportunidades interessantes. <br><br>  Para fazer isso, voc√™ deve ter pelo menos 10 Gb / s de interfaces dentro do datacenter.  Mas mesmo se voc√™ tiver apenas 1 Gbit / s - n√£o se preocupe.  Isso √© aproximadamente 125 MB / s - muito bom para hipervisores que n√£o exigem alta carga de disco. <br><br>  O KVM pode migrar e arrastar o armazenamento.  Mas, por exemplo, no modo de carga de trabalho, transferir uma m√°quina virtual para alguns Terabytes √© uma dor.  Para a migra√ß√£o com um armazenamento comum, apenas RAM √© suficiente, o que √© elementar.  Isso <strong>reduz o tempo de migra√ß√£o</strong> . <br><br><h3>  No final, LXD ou KVM? </h3><br>  Inicialmente, assumimos que, para todas as m√°quinas virtuais em que o kernel corresponde ao sistema host, usaremos o LXD.  E onde precisamos tomar outro n√∫cleo - leve o KVM. <br><br>  Na realidade, os planos n√£o decolaram.  Para entender o porqu√™, d√™ uma olhada no LXD. <br><br><h3>  Lxd </h3><br>  A principal vantagem √© economizar mem√≥ria no n√∫cleo.  O kernel √© o mesmo e quando lan√ßamos novos cont√™ineres, o kernel √© o mesmo.  Com isso, os profissionais terminaram e os contras come√ßaram. <br><br>  <strong>O dispositivo de bloco com rootfs deve ser montado.</strong>  √â mais dif√≠cil do que parece. <br><br>  <strong>Realmente n√£o h√° migra√ß√£o</strong> .  √â, e √© baseado no maravilhoso instrumento sombrio criu, que nossos compatriotas viram.  Tenho orgulho deles, mas em casos simples, o criu n√£o funciona. <br><br>  <strong>O agente zabbix se comporta de maneira estranha em um recipiente</strong> .  Se voc√™ execut√°-lo dentro do cont√™iner, ver√° uma s√©rie de dados do sistema host e n√£o do cont√™iner.  At√© agora nada pode ser feito. <br><br>  <strong>Ao examinar a lista de processos no hypervisor, √© imposs√≠vel entender rapidamente de qual cont√™iner um processo espec√≠fico est√° crescendo</strong> .  Leva tempo para descobrir qual espa√ßo de nome existe, o que e onde.  Se a carga em algum lugar saltou mais do que o normal, ent√£o rapidamente n√£o entendo.  Esse √© o principal problema - a limita√ß√£o nos recursos de resposta.  Uma mini investiga√ß√£o √© realizada para cada caso. <br><br><blockquote>  A √∫nica vantagem do LXD √© economizar a mem√≥ria principal e reduzir a sobrecarga. </blockquote><br>  Mas a Mem√≥ria Compartilhada do Kernel no KVM j√° economiza mem√≥ria. <br><br>  At√© agora, n√£o vejo raz√£o para introduzir uma produ√ß√£o s√©ria e LXD.  Apesar dos melhores esfor√ßos da Canonical nessa √°rea, a produ√ß√£o da LXD traz mais problemas do que solu√ß√µes.  Num futuro pr√≥ximo, a situa√ß√£o n√£o mudar√°. <br><br>  Mas, n√£o se pode dizer que LXD √© mau.  Ele √© bom, mas em casos limitados, que discutirei um pouco mais tarde. <br><br><h3>  Criu </h3><br>  Criu √© um utilit√°rio sombrio. <br><br>  Crie um cont√™iner vazio, ele chegar√° com um cliente DHCP e dir√°: "Suspender!"  Obtenha o erro porque existe um cliente DHCP: ‚ÄúHorror, horror!  Ele abre o soquete com o sinal "cru" - que pesadelo! "  Pior em lugar nenhum. <br><br><blockquote>  Impress√µes de cont√™ineres: sem migra√ß√£o, o Criu funciona sempre. </blockquote><br>  Eu ‚Äúgosto‚Äù da recomenda√ß√£o da equipe do LXD sobre o que fazer com o Criu, para que n√£o haja problemas: <br><br>  - <em>Pegue uma vers√£o mais recente do reposit√≥rio!</em> <br><br>  E de alguma forma posso coloc√°-lo no pacote para n√£o rodar no reposit√≥rio? <br><br><h3>  Conclus√µes </h3><br>  <strong>O LXD √© maravilhoso se voc√™ deseja criar uma infraestrutura de CI / CD.</strong>  Pegamos o LVM - Logical Volume Manager, fazemos uma captura instant√¢nea e iniciamos o cont√™iner.  Tudo funciona muito bem!  Em um segundo, um novo cont√™iner limpo √© criado, configurado para testar e rolar o chef - n√≥s o usamos ativamente. <br><br>  <strong>O LXD √© fraco para produ√ß√£o s√©ria</strong> .  N√£o podemos descobrir o que fazer com o LXD em produ√ß√£o se ele n√£o funcionar bem. <br><br>  <strong>Escolha KVM e apenas KVM!</strong> <br><br><h3>  A migra√ß√£o </h3><br>  Eu vou dizer isso brevemente.  Para n√≥s, a migra√ß√£o acabou sendo um novo mundo maravilhoso que gostamos.  Tudo √© simples l√° - h√° uma equipe para migra√ß√£o e duas op√ß√µes importantes: <br><br><pre> <code class="plaintext hljs">virsh migrate &lt;vm&gt; qemu+ssh://&lt;hypervisor&gt;/system --undefinesource -persistent</code> </pre> <br>  Se voc√™ digitar ‚ÄúMigra√ß√£o KVM‚Äù no Google e abrir o primeiro material, ver√° um comando para migra√ß√£o, mas sem as duas √∫ltimas chaves.  Voc√™ n√£o ver√° uma men√ß√£o de que eles s√£o importantes: "Basta executar este comando!"  Execute o comando - e ele realmente migra, mas apenas como? <br><br>  Op√ß√µes de migra√ß√£o importantes. <br><br>  <strong>undefinesource - remova a m√°quina virtual do hypervisor do qual estamos migrando.</strong>  Se voc√™ reiniciar ap√≥s essa migra√ß√£o, o hipervisor que voc√™ deixou reiniciar√° esta m√°quina.  Voc√™ ficar√° surpreso, mas isso √© normal. <br><br>  <strong>Sem o segundo par√¢metro - persistente - o hipervisor para o qual voc√™ se moveu n√£o considera isso uma migra√ß√£o permanente.</strong>  Ap√≥s a reinicializa√ß√£o, o hypervisor n√£o se lembrar√° de nada. <br><br><pre> <code class="plaintext hljs">- virsh dominfo &lt;vm&gt; | grep persistent</code> </pre> <br>  Sem esse par√¢metro, a m√°quina virtual √© c√≠rculos na √°gua.  Se o primeiro par√¢metro for especificado sem o segundo, adivinhe o que acontecer√°. <br><br>  Existem muitos momentos com a KVM. <br><br><ul><li>  Rede: eles sempre falam sobre bridge - √© um pesadelo!  Voc√™ l√™ e pensa - como assim ?! </li><li>  Migra√ß√£o: eles tamb√©m n√£o dizem nada intelig√≠vel at√© voc√™ bater com a cabe√ßa contra esse muro. </li></ul><br><h2>  Por onde come√ßar? </h2><br>  Para come√ßar tarde - estou falando de outra coisa. <br><br><h3>  Provisionamento: como implant√°-lo </h3><br><blockquote>  Se voc√™ estiver satisfeito com as op√ß√µes de instala√ß√£o padr√£o, o mecanismo preseed √© √≥timo. </blockquote><br>  No ESXi, usamos virt-install.  Essa √© uma maneira regular de implantar uma m√°quina virtual.  √â conveniente que voc√™ crie um arquivo preseed no qual descreve a imagem do seu Debian / Ubuntu.  Inicie uma nova m√°quina alimentando-a com um kit de distribui√ß√£o ISO e um arquivo preseed.  Ent√£o o carro rola sozinho.  Voc√™ se conecta a ele via SSH, conecta-o a um chef, enrola biscoitos - √© isso, corre para o prod! <br><br>  Mas se voc√™ tiver virt-install suficiente, tenho m√°s not√≠cias.  Isso significa que voc√™ n√£o atingiu o est√°gio em que deseja fazer outra coisa.  Superamos e percebemos que o virt-install n√£o √© suficiente.  Chegamos a uma "imagem de ouro", que clonamos e lan√ßamos m√°quinas virtuais. <br><br><h3>  E como organizar uma m√°quina virtual? </h3><br>  Por que chegamos a essa imagem e por que o aprovisionamento √© importante?  Porque ainda existe um entendimento fraco na comunidade de que existem grandes diferen√ßas entre uma m√°quina virtual e uma m√°quina comum. <br><br>  <strong>Uma m√°quina virtual n√£o precisa de um processo de inicializa√ß√£o complicado e de um carregador de inicializa√ß√£o inteligente</strong> .  √â muito mais f√°cil conectar os discos de uma m√°quina virtual a uma m√°quina que possui um conjunto completo de ferramentas do que no modo de recupera√ß√£o tentando sair de algum lugar. <br><br>  <strong>Uma m√°quina virtual precisa da simplicidade de um dispositivo</strong> .  Por que preciso de parti√ß√µes em um disco virtual?  Por que as pessoas pegam um disco virtual e colocam parti√ß√µes l√°, n√£o o LVM? <br><br>  <strong>Uma m√°quina virtual precisa de extensibilidade m√°xima</strong> .  Normalmente, as m√°quinas virtuais crescem.  Este √© um processo "legal" - aumentando a parti√ß√£o no MBR.  Voc√™ o exclui, naquele momento enxugando o suor da testa e pensa: ‚ÄúApenas n√£o escreva agora, apenas n√£o escreva!‚Äù  - e recrie com os novos par√¢metros. <br><br><h3>  LVM @ lilo </h3><br>  Como resultado, chegamos ao LVM @ lilo.  Este √© um carregador de inicializa√ß√£o que permite configurar a partir de um √∫nico arquivo.  Se, para editar a configura√ß√£o do GRUB, voc√™ est√° editando um arquivo especial que controla o mecanismo de modelos e cria o monstruoso boot.cfg, depois com o Lilo - um arquivo e nada mais. <br><br>  O LVM sem parti√ß√£o torna o sistema perfeito e f√°cil.  O problema √© que o GRUB n√£o pode viver sem MBR ou GPT e est√° congelando.  Dizemos a ele: ‚ÄúO GRUB se instala aqui‚Äù, mas ele n√£o pode, porque n√£o h√° parti√ß√µes. <br><br>  O LVM permite expandir e fazer backups rapidamente.  Caixa de di√°logo padr√£o: <br><br>  <em>- Pessoal, como voc√™ faz backup virtual?</em> <br><br>  <em>- ... pegamos um dispositivo de bloco e copiamos.</em> <br><br>  <em>- Voc√™ tentou implantar de volta?</em> <br><br>  <em>- Bem, n√£o, tudo funciona para n√≥s!</em> <br><br>  Voc√™ pode lamber um dispositivo de bloco em uma m√°quina virtual a qualquer momento, mas se houver um sistema de arquivos, qualquer registro requer tr√™s movimentos - esse procedimento n√£o √© at√¥mico. <br><br>  Se voc√™ estiver fazendo um instant√¢neo da m√°quina virtual por dentro, ela poder√° conversar com o sistema de arquivos para que chegue ao estado consistente desejado.  Mas isso n√£o √© adequado para tudo. <br><br><h2>  Como construir um cont√™iner? </h2><br>  Para iniciar e criar um cont√™iner, existem ferramentas regulares dos modelos.  O LXD oferece o modelo Ubuntu 16.04 ou 18.04.  Mas se voc√™ √© um lutador avan√ßado e n√£o deseja um modelo comum, mas seus rootfs personalizados, que voc√™ pode personalizar por si mesmo, surge a pergunta: como criar um cont√™iner do zero no LXD? <br><br><h3>  Recipiente a partir do zero </h3><br>  <strong>Preparando rootfs</strong> .  O Debootstrap ajudar√° com isso: explicamos quais pacotes s√£o necess√°rios, quais n√£o s√£o e instalamos. <br><br>  <strong>Explique ao LXD que queremos criar um cont√™iner a partir de rootfs espec√≠ficos</strong> .  Mas primeiro, crie um cont√™iner vazio com um comando curto: <br><br><pre> <code class="plaintext hljs">curl --unix-socket /var/lib/lxd/unix.socket -X POST -d '{"name": "my-container", "source": {"type": "none"}}' lxd/1.0/containers</code> </pre> <br>  Pode at√© ser automatizado. <br><br>  Um leitor atencioso dir√° - onde est√° o rootfs meu cont√™iner?  Onde √© indicado em que lugar?  Mas eu n√£o disse que isso √© tudo! <br><br>  <strong>Montamos rootfs do cont√™iner</strong> onde ele ir√° morar.  Em seguida, indicamos que o cont√™iner rootfs ficar√° aqui: <br><br><pre> <code class="plaintext hljs">lxc config set my-container raw.lxc "lxc.rootfs=/containers/my-container/rootfs"</code> </pre> <br>  Novamente, isso √© automatizado. <br><br><h3>  Vida do recipiente </h3><br>  <strong>O cont√™iner n√£o possui seu pr√≥prio kernel</strong> ; portanto, √© mais f√°cil carreg√°-lo <strong>:</strong> systemd, init e voou! <br><br>  Se voc√™ n√£o usar ferramentas regulares para trabalhar com o LVM, na maioria dos casos, para iniciar o cont√™iner, ser√° necess√°rio montar os rootfs do cont√™iner no hypervisor. <br><br>  √Äs vezes encontro artigos que recomendam autofs.  N√£o fa√ßa isso.  O Systemd possui unidades de montagem autom√°tica que funcionam, mas o autofs n√£o.  Portanto, as unidades de montagem autom√°tica do sistema podem e devem ser usadas, mas o autofs n√£o vale a pena. <br><br><h2>  Conclus√µes </h2><br>  <strong>Gostamos do KVM com migra√ß√£o</strong> .  Com o LXD, ainda n√£o √© o caminho, embora, para testar e construir a infraestrutura, a utilizemos onde n√£o h√° carga de produ√ß√£o. <br><br>  <strong>Adoramos o desempenho da KVM</strong> .  √â mais familiar olhar para o topo, ver um processo relacionado a essa m√°quina virtual e entender quem e o que estamos fazendo.  √â melhor do que usar um conjunto de utilit√°rios estranhos com cont√™ineres para descobrir que tipo de batidas subaqu√°ticas existem. <br><br>  <strong>Estamos muito satisfeitos com a migra√ß√£o.</strong>  Isso se deve principalmente ao armazenamento compartilhado.  Se migr√°ssemos arrastando discos, n√£o ficar√≠amos t√£o felizes. <br><br><blockquote>  Se voc√™, como Leo, est√° pronto para falar sobre como superar as dificuldades de opera√ß√£o, integra√ß√£o ou suporte, agora √© a hora <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">de enviar um relat√≥rio</a> para a confer√™ncia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DevOpsConf</a> do outono.  E n√≥s, no comit√™ do programa, ajudaremos a preparar a mesma apresenta√ß√£o inspiradora e √∫til que essa. <br><br>  N√£o estamos aguardando o prazo para a chamada de trabalhos e j√° aceitamos v√°rios relat√≥rios para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o programa da</a> confer√™ncia.  Assine a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">newsletter</a> e o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">canal de telegrama</a> e fique por dentro das novidades sobre os preparativos para o DevOpsConf 2019 e n√£o perca novos artigos e v√≠deos. </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt458922/">https://habr.com/ru/post/pt458922/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt458912/index.html">Migrando para o Zimbra com o imapsync</a></li>
<li><a href="../pt458914/index.html">O que (n√£o) voc√™ precisa saber para criar jogos no Unity</a></li>
<li><a href="../pt458916/index.html">Sob o cap√¥ do React. Escrevemos nossa implementa√ß√£o do zero</a></li>
<li><a href="../pt458918/index.html">O que voc√™ pode aprender com o design de jogos hiper-casuais</a></li>
<li><a href="../pt458920/index.html">Confer√™ncia para f√£s do DevOps</a></li>
<li><a href="../pt458924/index.html">Acidentes ajudam voc√™ a aprender</a></li>
<li><a href="../pt458926/index.html">Trag√©dia n√£o vem sozinha</a></li>
<li><a href="../pt458928/index.html">XLNet vs BERT</a></li>
<li><a href="../pt458930/index.html">Como os alunos da Perm chegaram √†s finais do campeonato internacional de an√°lise de dados da Data Mining Cup 2019</a></li>
<li><a href="../pt458932/index.html">Yota - ou como voc√™ pode descobrir tudo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>