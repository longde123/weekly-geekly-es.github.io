<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤩 👩‍👩‍👦 🤱🏻 Arbeiten mit APDU-Befehlen anhand des Beispiel-EToken ♾ 🐶 👩🏿‍💼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=""... Der Weg ist nicht so schwer zu verstehen. Die Kräfte der Natur, natürliche Neigungen, Muster von Ereignissen ... 
 Ein primitives Verständnis der...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Arbeiten mit APDU-Befehlen anhand des Beispiel-EToken</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446552/">  <i>"... Der Weg ist nicht so schwer zu verstehen. Die Kräfte der Natur, natürliche Neigungen, Muster von Ereignissen ...</i> <i><br></i>  <i>Ein primitives Verständnis der Welt bemerkt nur vier Elemente und geht nicht weiter.</i>  <i>Es ist, als ob das Universum auf vier verständliche verständliche Phänomene hinausläuft. "</i> <i><br></i>  <i>Stephen Erickson.</i> <i><br></i>  <i>"Mitternachtsflut."</i> <br><br><img src="https://habrastorage.org/webt/pn/ja/xv/pnjaxvu9xha1saqk36veq8bghhm.jpeg" alt="Bild"><br><br>  Hallo Habr! <br><br>  Das Thema APDU wurde wiederholt angesprochen, betrifft jedoch hauptsächlich Smartcards, für die Sie einen Kartenleser und eine Karte benötigen, die nicht schade ist, sowie Software, da die Arbeit mit der OpenSC-Konsolenschnittstelle, zumindest in Windows $, gelinde gesagt unpraktisch ist. <br>  Zu diesem Zweck habe ich ein kleines Programm mit einer Fensteroberfläche geschrieben, die über Winscard funktioniert. <br>  Quellen und Binärdateien können hier heruntergeladen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">werden</a> . <br>  Um dies unter Visual Studio 2008 zu kompilieren, müssen Sie das WinSCard.Lib-Projekt aus dem Microsoft Windows SDK zum Projekt hinzufügen. <br><a name="habracut"></a><br>  Höchstwahrscheinlich wird es Blue Fish EToken PRO Java 72 K mit EDS-Zertifikaten geben, die vor vielen Jahren abgelaufen sind (bei einem „Kampf“ mit einem vorhandenen EDS wird das Token für Experimente nicht empfohlen!). <br>  Geeignet sind auch JaCarta Pro, die sich nur äußerlich von etokens unterscheiden. <br>  Sie können auch versuchen, mit dem Gemalto SafeNet eToken 5100 zu arbeiten. Sie können den Inhalt von Verzeichnissen anzeigen, können die Datei jedoch aufgrund des sehr kurzen Zeitlimits (wahrscheinlich mehrere Millisekunden) zwischen den Befehlen zum Auswählen und Lesen der Datei nicht lesen, weshalb der Befehl zum Lesen der Datei manuell verweist bereits an einer leeren Stelle (Fehlercode 69 85).  Vielleicht ist dies einer der Gründe, warum auf einigen Plattformen auf diesen Token die Schlüssel nicht mehr angezeigt werden.  In Bezug auf SafeNet eToken 5100 (mit einer ehrlichen Aufschrift auf der Seite „Made in China“) stelle ich Folgendes fest: „JaCarta Single Client“ möchte nicht damit arbeiten und zeigt die Meldung an, dass dieses Produkt nicht unterstützt wird, Aladdins 64-Bit-eToken PKI-Client 5.1 Er sieht es nicht, aber die 32-Version unter Win XP funktioniert damit, obwohl es für dieses Token natürlich ratsam ist, den ursprünglichen SafeNet-Authentifizierungsclient zu installieren. <br><br>  Andere Token, einschließlich der JaCarta-Familie, funktionieren nicht, da die APDU-Befehle für sie alle völlig unterschiedlich sind und ihr im ISO7816-Standard beschriebener digitaler Wert nicht übereinstimmt. <br><br>  Details zum Format von APDU-Befehlen finden Sie beispielsweise <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . <br>  Ein Leser mit einem blauen Fisch kann sich mit der Arbeit von APDU vertraut machen, ohne von der Couch aufzustehen. <br>  Es ist erforderlich, den Treiber für eToken eToken PKI Client 5.1 oder "JaCarta Single Client" zu installieren und das Token zu verbinden. <br><br>  Für eine detaillierte Ansicht des Inhalts des Tokens in einer bequemen Form und eine Abstimmung mit den APDU-Befehlen können Sie die von mir im Autoit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JaCarta Editor geschriebene verwenden</a> . <br><br>  Starten Sie APDUExplorer, wählen Sie "Aladdin Token JC 0" oder "ARDS JaCarta 0" oder "SafeNet Token JC 0" aus der Liste der Leser und Sie können Befehle eingeben. <br>  Sie können sowohl durch Doppelpunkte als auch durch Leerzeichen oder alle zusammen eingeben. <br><br>  Zunächst können Sie die Leistung überprüfen, indem Sie auf "ATR prüfen" klicken und eine Token-Antwort erhalten. <br><br>  Der erste Befehl besteht darin, das Standard-Applet auszuwählen und in das Stammverzeichnis mit der Kennung 3f00 zu wechseln (diese Kennung ist möglicherweise das einzige, was Token von Anbietern gemeinsam haben). <br>  00: A4: 00: 04: 00 <br><br>  Als nächstes erhalten wir eine Liste der Ordner im Stammverzeichnis <br>  80: 01: 01: 00: 04: 09: 02: 00: 00: CD (der Befehl ist die Konstante "Berichtsordnerliste"). <br>  Eine Antwort sollte erhalten werden: <br>  0a 02 66 66 0b 01 00 90 00 <br><br>  Das zweite Byte in der Antwort ist die Größe der empfangenen Daten - zwei Bytes, dh nur ein Ordner (die Datei- oder Ordnerkennung in der APDU benötigt immer zwei Bytes). <br>  Und wir sehen nur einen Ordner mit der Kennung 66 66, der als Aladdin AID-Verzeichnis bezeichnet wird. <br><br>  Berichtsdateiliste (auch konstant) <br>  80: 01: 02: 00: 04: 09: 02: 00: 00: CD <br>  Muss empfangen werden <br>  0a 00 0b 01 00 90 00 <br>  Die Antwort auf Position 01 lautet 00. <br><br>  Gehen Sie in das Verzeichnis 66 66 <br>  00 A4 08 04 02 66 66 00 <br>  Dies ist der Befehl SELECT FILE, dessen Format: vier Bytes, der Befehl 00 A4 08 04 selbst, dann die Größe des Datenfelds des vollständigen Pfads (im Beispiel 02 Bytes), dann der Pfad selbst (im Beispiel 66 66) und 00 müssen vervollständigt werden. <br><br>  Liste der Verzeichnisse melden 66 66 <br>  80: 01: 01: 00: 04: 09: 02: 00: 00: CD <br>  Resv-Bytes: <br>  0a 04 50 01 50 00 0b 01 00 90 00 <br>  Das Antwortfeld 01 (Antwortgröße) zeigt 04 an, d.h.  4 Bytes = zwei Ordner 50 01 und 50 00, wobei 50 01 der Dienstordner und 50 00 der Hauptordner ist, der als PKCS # 11-Verzeichnis bezeichnet wird und in dem alle Daten gespeichert sind <br><br>  Berichtsverzeichnisliste 66 66 <br>  80: 01: 02: 00: 04: 09: 02: 00: 00: CD <br>  Resv-Bytes: <br>  0a 00 0b 01 00 90 00 <br>  Keine Dateien hier. <br><br>  Studien haben gezeigt, dass das Verzeichnis 50 01 keine sichtbaren Ordner und Dateien enthält. Wechseln Sie daher in das Hauptverzeichnis 50 00 <br>  00 A4 08 04 04 66 66 50 00 00 <br>  Berichtsordnerliste <br>  80: 01: 01: 00: 04: 09: 02: 00: 00: CD <br>  Die Antwort hängt davon ab, was auf dem Token gespeichert ist. <br>  Berichtsdateiliste <br>  80: 01: 02: 00: 04: 09: 02: 00: 00: CD <br>  Resv-Bytes: <br>  0a 14 00 0f 00 02 00 03 00 04 00 05 00 06 00 07 00 08 00 09 00 0a 0b 01 00 90 00 <br>  Wir sehen 14 Dateien (Antwortfeld 01), dann alle 2 Bytes sind dies Dateinamen, dann gibt es Dienstinformationen. <br><br>  Jedes Token der untersuchten Modelle enthält immer ein b000-Systemverzeichnis und die 0002-Systemdatei. Versuchen Sie, sie zu lesen, und andere Dateien können nach demselben Prinzip gelesen werden. <br>  Gehen Sie in das Verzeichnis b0 00 <br>  00 A4 08 04 06 66 66 50 00 B0 00 00 <br>  Holen Sie sich eine Liste der Dateien <br>  80: 01: 02: 00: 04: 09: 02: 00: 00: CD <br>  Resv-Bytes: <br>  0a 02 00 02 0b 01 00 90 00 <br>  Wir sehen Datei 00 02 (das Byte im Antwortfeld 01 ist die Namensgröße (jeder Name benötigt immer zwei Bytes, die folgenden Felder sind die Dateinamen, in diesem Fall gibt es nur eine Datei, die durch den Wert von Feld 01 bestimmt wird). <br><br>  Wählen Sie die Datei 0002 aus B000 für den vollständigen Pfad <br>  00 A4 08 04 08 66 66 50 00 B0 00 00 02 00 <br>  Resv-Bytes: <br>  01 01 02 02 02 00 02 03 02 00 10 04 08 00 ff 00 00 ff ff ff 05 00 90 00 <br>  Das Antwortformat ist wie folgt: Präambel - 2 Bytes, Dateityp - 1 Byte (02-Datei, 01-Ordner), Trennzeichen - 2 Bytes, Dateiname - 2 Bytes, Trennzeichen - 2 Bytes, Dateigröße - 2 Bytes, Trennzeichen - 2 Bytes, Zugriffsrechte - 1 Byte (00 - für alle verfügbar, 63 ist durch einen PIN-Code geschützt).  Dann kommen einige Overhead-Informationen, die mit dem Code für die erfolgreiche Ausführung des APDU-Befehls - 90 00 enden. <br><br>  Lesen Sie diese Datei. Die letzten zwei Bytes des Befehls geben die Größe des Puffers an, wie viel Sie lesen müssen (in diesem Fall entspricht dies der Dateigröße). <br>  80 18 00 00 04 0E 02 00 00 10 <br>  Resv-Bytes: (der Wert ist jeweils unterschiedlich): <br>  00 06 63 61 72 64 63 66 00 00 00 00 00 00 00 00 90 00 <br><br>  Ich erwäge hier keine Authentifizierung für das Etoken, da es aus einer Folge von Frage-Antwort-Befehlen besteht und verschlüsselt ist (es gibt ein Antitoken-Projekt, bei dem das Autorisierungsproblem für diese Produkte grundlegend gelöst wurde). <br>  Einige andere Token, wie z. B. JaCarta GOST-2, unterstützen die Authentifizierung durch einfaches Übergeben eines PIN-Codes. <br><br>  Sie können die APDU-Werte von Befehlen beliebiger Smartcards und Token abrufen, indem Sie den Datenverkehr von WinSCard.dll abfangen, indem Sie einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">von hier</a> kompilierten Sniffer ausführen (Experimente haben gezeigt, dass dieser Sniffer installiert ist und nur unter Win XP ausgeführt wird). <br><br>  Als Referenz mögliche Ergebnisse der Ausführung von APDU-Befehlen: <br>  90 00 - OK <br>  69 85 - Nutzungsbedingungen nicht erfüllt <br>  63 00 - Authentifizierung des Host-Kryptogramms fehlgeschlagen (Ext auth) <br>  64 00 - Keine spezifische Diagnose <br>  67 00 - Falsche Länge in Lc <br>  67 XX - Fehler, falscher Parameter P3 (ISO-Code) <br>  68 81 - Logischer Kanal wird nicht unterstützt oder ist nicht aktiv <br>  69 82 - Sicherheitsstatus nicht erfüllt <br>  69 83 - Geheimcode gesperrt <br>  69 85 - Keine aktuell ausgewählte EF, kein Befehl zum Überwachen / keine Transaction Manager-Datei <br>  6A 80 - Die Parameter im Datenfeld sind falsch <br>  6A 81 - Karte ist blockiert oder Befehl wird nicht unterstützt <br>  6A 82 - Datei nicht gefunden <br>  6A 85 - Lc stimmt nicht mit der TLV-Struktur überein <br>  6A 86 - Falsches P1 P2 <br>  6A 88 - Referenzierte Daten nicht gefunden (Init upd) <br>  6D 00 - Ungültige Anweisung <br>  6E 00 - Ungültige Klasse </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de446552/">https://habr.com/ru/post/de446552/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de446538/index.html">PhotoGuru wechselte zur "dunklen Seite" und "weiser"</a></li>
<li><a href="../de446544/index.html">Microsoft erweitert das Azure IP Advantage-Programm um neue IP-Vorteile für Azure IoT-Innovatoren und -Starts</a></li>
<li><a href="../de446546/index.html">Microsoft erweitert Azure IP Advantage um neue IP-Vorteile für Azure IoT-Innovatoren und -Starts</a></li>
<li><a href="../de446548/index.html">Analyse von Statistiken zu Werbekampagnen - Erstellen Sie eine neue Metrik im DataFrame (Python)</a></li>
<li><a href="../de446550/index.html">Probleme mit Koordinatormustern und was hat RouteComposer damit zu tun?</a></li>
<li><a href="../de446554/index.html">Yandex Resident Program oder Wie man aus einem erfahrenen Backend ein ML-Ingenieur wird</a></li>
<li><a href="../de446558/index.html">Exotische Datenstrukturen: Modifizierte Merkle Patricia Trie</a></li>
<li><a href="../de446560/index.html">"Courtesy Exchange": die Essenz des Konflikts zwischen den beiden bekanntesten Streaming-Unternehmen</a></li>
<li><a href="../de446562/index.html">Asynchronität in der Programmierung</a></li>
<li><a href="../de446566/index.html">Projekt Null. Wie Amazon mit Fälschungen umgehen will</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>