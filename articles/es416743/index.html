<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚Ñ¢Ô∏è üßõüèº ü§¥üèº Bot para Starcraft en Rust, C y cualquier otro idioma ü§¥üèø üî¢ üçï</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="StarCraft: Brood War . Cu√°nto significa eso para m√≠. Y para muchos de ustedes. Tantos que dud√© si dar un enlace a la wiki. 


 Una vez, Halt me llam√≥ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bot para Starcraft en Rust, C y cualquier otro idioma</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416743/"><p><img src="https://habrastorage.org/webt/qv/fa/ex/qvfaexsnkzmckmwrt_spqmc7nr4.png" align="left">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">StarCraft: Brood War</a> .  Cu√°nto significa eso para m√≠.  Y para muchos de ustedes.  Tantos que dud√© si dar un enlace a la wiki. </p><br><p>  Una vez, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">Halt</a> me llam√≥ en un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">correo electr√≥nico</a> personal y se ofreci√≥ a aprender <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Rust</a> .  Como cualquier persona normal, decidimos comenzar con <del>  hola mundo </del>  escribir una biblioteca din√°mica para Windows que pueda cargarse en el espacio de direcciones de un juego de StarCraft y administrar unidades. </p><br><p> El art√≠culo describir√° el proceso de encontrar soluciones, utilizando tecnolog√≠as, t√©cnicas que le permitir√°n aprender cosas nuevas en el lenguaje Rust y su ecosistema o inspirarse para implementar un bot en su idioma favorito, ya sea C, C ++, ruby, python, etc. </p><a name="habracut"></a><br><p>  Vale la pena leer este art√≠culo bajo el himno de Corea del Sur: </p><br><div class="spoiler">  <b class="spoiler_title">Starcraft OST</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/pNt0iVG2VOA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><br><h2 id="bwapi">  Bwapi </h2><br><p>  Este juego ya tiene 20 a√±os.  Y todav√≠a es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">popular</a> , los campeonatos re√∫nen salas enteras de personas en los EE. UU. Incluso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en 2017</a> , donde tuvo lugar la batalla de los grandes maestros Jaedong vs Bisu.  ¬°Adem√°s de los jugadores en vivo, los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">coches sin alma</a> tambi√©n participan en batallas!  Y esto es posible gracias a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">BWAPI</a> .  M√°s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlaces</a> √∫tiles. </p><br><p>  Durante m√°s de una d√©cada, ha habido una comunidad de desarrolladores de bots en torno a este juego.  Los entusiastas escriben bots y participan en varios campeonatos.  Muchos de ellos estudian IA y aprendizaje autom√°tico.  BWAPI es utilizado por las universidades para educar a sus estudiantes.  Incluso hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">canal de contracci√≥n</a> que transmite juegos. </p><br><p>  Entonces, un equipo de fan√°ticos hace unos a√±os revirti√≥ las partes internas de Starcraft y escribi√≥ una API C ++ que le permite escribir bots, integrarse en el proceso del juego y dominar a las personas pat√©ticas. </p><br><p>  Como suele suceder antes <del>  para construir una casa, necesitas obtener mineral, forjar herramientas ... </del>  escribe un bot, necesitas implementar la API.  ¬øQu√© puede ofrecer Rust? </p><br><h2 id="ffi">  Ffi </h2><br><p>  Interactuar con otros idiomas de Rust es bastante simple.  Hay <abbr title="Interfaz de funciones for√°neas">FFI</abbr> para esto.  Perm√≠tanme proporcionar un breve extracto de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> . </p><br><p>  Supongamos que tenemos una biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">snappy</a> que tiene un archivo de encabezado <a href="">snappy-ch</a> desde el cual copiaremos las declaraciones de funciones. </p><br><p>  Crea un proyecto usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">carga</a> . </p><br><pre><code class="bash hljs">$ cargo new --bin snappy Created binary (application) `snappy` project $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> snappy snappy$ tree . ‚îú‚îÄ‚îÄ Cargo.toml ‚îî‚îÄ‚îÄ src ‚îî‚îÄ‚îÄ main.rs 1 directory, 2 files</code> </pre> <br><p>  Cargo cre√≥ una estructura de archivos est√°ndar para el proyecto. </p><br><p>  En <code>Cargo.toml</code> especifique la dependencia de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">libc</a> : </p><br><pre> <code class="hljs powershell">[<span class="hljs-type"><span class="hljs-type">dependencies</span></span>] libc = <span class="hljs-string"><span class="hljs-string">"0.2"</span></span></code> </pre> <br><p>  <code>src/main.rs</code> archivo <code>src/main.rs</code> se ver√° as√≠: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">crate</span></span> libc; <span class="hljs-comment"><span class="hljs-comment">//   C ,     size_t use libc::size_t; #[link(name = "snappy")] //       extern { //    ,    //  C  : // size_t snappy_max_compressed_length(size_t source_length); fn snappy_max_compressed_length(source_length: size_t) -&gt; size_t; } fn main() { let x = unsafe { snappy_max_compressed_length(100) }; println!("max compressed length of a 100 byte buffer: {}", x); }</span></span></code> </pre> <br><p>  Recopilamos y ejecutamos: </p><br><pre> <code class="bash hljs">snappy$ cargo build ... snappy$ cargo run Finished dev [unoptimized + debuginfo] target(s) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.02s Running `target/debug/snappy` max compressed length of a 100 byte buffer: 148</code> </pre> <br><p>  Solo puede llamar a <code>cargo run</code> , que antes del lanzamiento llama a <code>cargo build</code> .  O cree un proyecto y llame al binario directamente: </p><br><pre> <code class="bash hljs">snappy$ ./target/debug/snappy max compressed length of a 100 byte buffer: 148</code> </pre> <br><p>  El c√≥digo se compila con la condici√≥n de que la biblioteca r√°pida est√© instalada (para Ubuntu, el paquete libsnappy-dev debe estar instalado). </p><br><pre> <code class="bash hljs">snappy$ ldd target/debug/snappy ... libsnappy.so.1 =&gt; /usr/lib/x86_64-linux-gnu/libsnappy.so.1 (0x00007f8de07cf000)</code> </pre> <br><p>  Como puede ver, nuestro binario est√° vinculado a la biblioteca compartida libsnappy.  Y la llamada <code>snappy_max_compressed_length</code> es una llamada de funci√≥n de esta biblioteca. </p><br><h2 id="rust-bindgen">  Rust-Bindgen </h2><br><p>  Ser√≠a bueno si pudi√©ramos generar autom√°ticamente FFI.  Afortunadamente, hay una utilidad en el arsenal de rastomanov llamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">rust-bindgen</a> .  Es capaz de generar enlaces FFI a bibliotecas C (y algunas C ++). </p><br><p>  Instalaci√≥n: </p><br><pre> <code class="bash hljs">$ cargo install bindgen</code> </pre> <br><p>  ¬øC√≥mo se ve el uso <strong>de Rust-Bindgen</strong> ?  Tomamos los archivos de encabezado C / C ++, establecemos la utilidad <strong>bindgen</strong> en ellos y obtenemos el c√≥digo Rust generado con las definiciones de las estructuras y funciones de la estructura.  As√≠ es como se ve la generaci√≥n FFI para snappy: </p><br><pre> <code class="rust hljs">$ bindgen /usr/include/snappy-ch | grep -C <span class="hljs-number"><span class="hljs-number">1</span></span> snappy_max_compressed_length <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">snappy_max_compressed_length</span></span></span></span>(source_length: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>; }</code> </pre> <br><p>  Result√≥ que bindgen pasa frente a los encabezados de BWAPI, generando toneladas de hojas de c√≥digo no utilizables (debido a las funciones de miembro virtual, std :: string en la API p√∫blica, etc.).  El caso es que BWAPI est√° escrito en C ++.  C ++ es generalmente dif√≠cil de usar incluso en proyectos de C ++.  Una vez que es mejor vincular una biblioteca compilada con el mismo vinculador (versiones id√©nticas), es mejor analizar los archivos de encabezado con el mismo compilador (versiones id√©nticas).  Porque hay muchos factores que pueden afectar el resultado.  Por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">destrozar</a> , que GNU GCC todav√≠a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">no puede implementar sin errores</a> .  Estos factores son tan importantes que no pueden superarse ni siquiera en <abbr title="Marco de prueba de C ++ de Google">gtest</abbr> , y la documentaci√≥n <a href="">indica</a> que ser√≠a mejor para usted construir gtest como parte del proyecto con el mismo compilador y el mismo vinculador. </p><br><h2 id="bwapi-c">  Bwapi-c </h2><br><p>  C es la programaci√≥n de lingua franca.  Si rust-bindgen funciona bien para el lenguaje C, ¬øpor qu√© no implementar BWAPI para C y luego usar su API?  Buena idea! </p><br><p>  S√≠, es una buena idea hasta que analice las entra√±as de BWAPI y vea la cantidad de clases y m√©todos que necesita implementar = (Especialmente todos estos dise√±os de estructuras en memoria, ensambladores, parches de memoria y otros horrores para los que no tenemos tiempo. Es necesario utilizar la soluci√≥n existente al m√°ximo. </p><br><p>  Pero de alguna manera debemos ocuparnos de las funciones de manipulaci√≥n, c√≥digo C ++, herencia y miembros virtuales. </p><br><p>  En C ++, hay dos herramientas poderosas que usaremos para resolver nuestro problema, estos son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">punteros opacos</a> y <code>extern "C"</code> . </p><br><p>  <code>extern "C" {}</code> permite que el c√≥digo C ++ se disfrace como C. Esto le permite generar nombres de funciones puros sin alterarlos. </p><br><p>  Los punteros opacos nos dan la capacidad de borrar un tipo y crear un puntero a "alg√∫n tipo" cuya implementaci√≥n no proporcionamos.  Dado que esto es solo una declaraci√≥n de alg√∫n tipo, y no su implementaci√≥n, es imposible usar este tipo por valor, solo puede usarse por puntero. </p><br><p>  Digamos que tenemos ese c√≥digo C ++: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> cpp { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bar; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;bar; } }; } <span class="hljs-comment"><span class="hljs-comment">// namespace cpp</span></span></code> </pre> <br><p>  Podemos convertirlo en un encabezado C como este: </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo_</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">//    Foo //  cpp::Foo::get_bar int Foo_get_bar(Foo* self); }</span></span></code> </pre> <br><p>  Y la parte de C ++, que ser√° el enlace entre el encabezado de C y la implementaci√≥n de C ++: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Foo_get_bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Foo* self)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      cpp::Foo    ::get_bar return reinterpret_cast&lt;cpp::Foo*&gt;(self)-&gt;get_bar(); }</span></span></code> </pre> <br><p>  No todos los m√©todos de clase tuvieron que ser manejados de esta manera.  Hay clases en BWAPI, operaciones en las que puede implementarse utilizando los valores de campo de estas estructuras, por ejemplo <code>typedef struct Position { int x; int y; } Position;</code> <code>typedef struct Position { int x; int y; } Position;</code>  y m√©todos como <code>Position::get_distance</code> . </p><br><p>  Hubo quienes tuvieron que ser juzgados de una manera especial.  Por ejemplo, un AIModule debe ser un puntero a una clase C ++ con un conjunto espec√≠fico de funciones miembro virtuales.  Sin embargo, aqu√≠ est√° el <a href="">t√≠tulo</a> y la <a href="">implementaci√≥n</a> . </p><br><p>  Entonces, despu√©s de varios meses de arduo trabajo, <strong>554</strong> m√©todos y una docena de clases, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">naci√≥ la</a> biblioteca multiplataforma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">BWAPI-C</a> , que le permite <a href="">escribir bots en C.</a>  El subproducto fue la compilaci√≥n cruzada y la capacidad de implementar la API en cualquier otro idioma que admita FFI y la convenci√≥n de llamadas cdecl. </p><br><p>  Si est√° escribiendo una biblioteca, escriba la API de C. </p><br><p>  La caracter√≠stica m√°s importante de BWAPI-C es la capacidad m√°s amplia para integrarse con otros idiomas.  <code>Python</code> , <code>Ruby</code> , <code>Rust</code> , <code>PHP</code> , <code>Java</code> y muchos otros saben c√≥mo trabajar con C, por lo tanto, tambi√©n puede escribir un bot en ellos, si trabaja un poco con un archivo e implementa sus envoltorios. </p><br><h2 id="pishem-bota-na-c">  Escribir un bot en C </h2><br><p>  Esta parte describe los principios generales del dise√±o de los m√≥dulos de Starcraft. </p><br><p>  Hay 2 tipos de bots: m√≥dulo y cliente.  Veremos un ejemplo de c√≥mo escribir un m√≥dulo. </p><br><p>  Un m√≥dulo es una biblioteca descargable; el principio general de carga se puede ver <a href="">aqu√≠</a> .  El m√≥dulo debe exportar 2 funciones: <code>newAIModule</code> y <code>gameInit</code> . </p><br><p>  Con <code>gameInit</code> todo es simple, esta funci√≥n se llama para pasar un puntero al juego actual.  Este puntero es muy importante, porque en la naturaleza de BWAPI vive una variable est√°tica global que se usa en algunas partes del c√≥digo.  <code>gameInit</code> : </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-function">DLLEXPORT </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gameInit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* game</span></span></span><span class="hljs-function">)</span></span> { BWAPIC_setGame(game); }</code> </pre> <br><p>  <code>newAIModule</code> poco m√°s complicado.  Deber√≠a devolver un puntero a una clase C ++ que tenga una tabla de m√©todo virtual con los nombres en <strong>XXXXX</strong> que se <strong>invocan</strong> en ciertos eventos del juego.  Defina la estructura del m√≥dulo: </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExampleAIModule</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AIModule_vtable* vtable_; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* name; } ExampleAIModule;</code> </pre> <br><p>  El primer campo debe ser un puntero a una tabla de m√©todos (magia, todas las cosas).  Entonces, la <code>newAIModule</code> funci√≥n <code>newAIModule</code> : </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-function">DLLEXPORT </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newAIModule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ExampleAIModule* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> = (ExampleAIModule*) <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(ExampleAIModule) ); <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-&gt;name = <span class="hljs-string"><span class="hljs-string">"ExampleAIModule"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-&gt;vtable_ = &amp;module_vtable; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> createAIModuleWrapper( (AIModule*) <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> ); }</code> </pre> <br><p>  <code>createAIModuleWrapper</code> es otra magia que convierte un puntero C en un puntero a una clase C ++ con virtual <del>  m√©todos </del>  funciones miembro </p><br><p>  <code>module_vtable</code> es una variable est√°tica en la tabla de m√©todos, los valores de los m√©todos se completan con punteros a funciones globales: </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AIModule_vtable module_vtable = { onStart, onEnd, onFrame, onSendText, onReceiveText, onPlayerLeft, onNukeDetect, onUnitDiscover, onUnitEvade, onUnitShow, onUnitHide, onUnitCreate, onUnitDestroy, onUnitMorph, onUnitRenegade, onSaveGame, onUnitComplete }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onEnd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isWinner)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onFrame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSendText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* text)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceiveText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Player* player, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* text)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPlayerLeft</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Player* player)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onNukeDetect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Position target)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitDiscover</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitEvade</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitShow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitHide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitMorph</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitRenegade</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSaveGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* gameName)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitComplete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{}</code> </pre> <br><p>  Por el nombre de las funciones y sus firmas queda claro en qu√© condiciones y con qu√© argumentos se llaman.  Por ejemplo, hice todas las funciones vac√≠as excepto </p><br><pre> <code class="hljs java"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ ExampleAIModule* self = (ExampleAIModule*) <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>; Game* game = BWAPIC_getGame(); Game_sendText(game, <span class="hljs-string"><span class="hljs-string">"Hello from bwapi-c!"</span></span>); Game_sendText(game, <span class="hljs-string"><span class="hljs-string">"My name is %s"</span></span>, self-&gt;name); }</code> </pre> <br><p>  Esta funci√≥n se llama cuando comienza el juego.  Se pasa un puntero al m√≥dulo actual como argumento.  <code>BWAPIC_getGame</code> devuelve un puntero global al juego que configuramos llamando a <code>BWAPIC_setGame</code> .  Entonces, mostraremos un ejemplo de compilaci√≥n cruzada y operaci√≥n del m√≥dulo: </p><br><pre> <code class="bash hljs">bwapi-c/example$ tree . ‚îú‚îÄ‚îÄ BWAPIC.dll ‚îî‚îÄ‚îÄ Dll.c 0 directories, 2 files bwapi-c/example$ i686-w64-mingw32-gcc -mabi=ms -shared -o Dll.dll Dll.c -I../include -L. -lBWAPIC bwapi-c/example$ cp Dll.dll ~/Starcraft/bwapi-data/ bwapi-c/example$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/Starcraft/bwapi-data/ Starcraft$ wine bwheadless.exe -e StarCraft.exe -l bwapi-data/BWAPI.dll --headful ... ... ...</code> </pre> <br><p>  Tocamos botones y comenzamos el juego.  Puede leer m√°s sobre el lanzamiento en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sitio</a> web de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">BWAPI</a> y en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">BWAPI-C</a> . </p><br><p>  El resultado del m√≥dulo: </p><br><p><img src="https://habrastorage.org/webt/cw/a-/41/cwa-41ihsyva-pj2stpef1xjn2g.png" alt="imagen"></p><br><p>  Puede encontrar un ejemplo un poco m√°s complejo de un m√≥dulo que muestra el trabajo con iteradores, control de unidades, b√∫squeda de minerales y estad√≠sticas en <a href="">bwapi-c / example / Dll.c.</a> </p><br><h2 id="bwapi-sys">  bwapi-sys </h2><br><p>  En el ecosistema Rasta, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">es habitual</a> llamar a los paquetes de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">una</a> manera determinada que se vinculan a las bibliotecas nativas.  Cualquier paquete foo-sys tiene dos funciones importantes: </p><br><ul><li>  Enlace a la biblioteca nativa de libfoo </li><li>  Proporciona declaraciones de funciones de la biblioteca libfoo.  Pero solo no se proporcionan declaraciones, abstracciones de alto nivel en cajas * -sys. </li></ul><br><p>  Para que el paquete * -sys pueda vincularse con √©xito, integran una <a href="">b√∫squeda de</a> biblioteca nativa y / o un <a href="">ensamblaje de</a> biblioteca de las fuentes en √©l. </p><br><p>  Para que el paquete * -sys proporcione declaraciones, uno debe escribirlas a mano o generar usando bindgen.  De nuevo bindgen.  Intento n√∫mero dos =) </p><br><p>  Generar carpetas con bwapi-c se vuelve obsceno: </p><br><pre> <code class="bash hljs">bindgen BWAPI.h -o lib.rs \ --opaque-type <span class="hljs-string"><span class="hljs-string">".+_"</span></span> \ --blacklist-type <span class="hljs-string"><span class="hljs-string">"std.*|__.+|.+_$|Game_v(Send|Print|Draw).*|va_list|.+_t$"</span></span> \ --no-layout-tests \ --no-derive-debug \ --raw-line <span class="hljs-string"><span class="hljs-string">"#![allow(improper_ctypes, non_snake_case)]"</span></span> \ -- -I../submodules/bwapi-c/include sed -i -r -- <span class="hljs-string"><span class="hljs-string">'s/.+\s+(.+)_;/pub struct \1;/'</span></span> lib.rs</code> </pre> <br><p>  Donde <code>BWAPI.h</code> es el archivo con las inclusiones de todos los encabezados de encabezado de BWAPI-C. </p><br><p>  Por ejemplo, para funciones ya conocidas, bindgen gener√≥ las siguientes declaraciones: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> { <span class="hljs-comment"><span class="hljs-comment">/// BWAPIC_setGame must be called from gameInit to initialize BWAPI::BroodwarPtr pub fn BWAPIC_setGame(game: *mut Game); } extern "C" { pub fn BWAPIC_getGame() -&gt; *mut Game; }</span></span></code> </pre> <br><p>  Hay 2 estrategias: almacenar el c√≥digo generado en el repositorio y generar c√≥digo sobre la marcha durante el ensamblaje.  Ambos enfoques tienen sus ventajas y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">desventajas</a> . </p><br><p>  Bienvenido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bwapi-sys</a> , otro peque√±o paso hacia nuestro objetivo. </p><br><p>  ¬øRecuerdas que habl√© de multiplataforma?  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">Nlinker se</a> uni√≥ al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">proyecto</a> e implement√≥ una estrategia dif√≠cil.  Si el objetivo es Windows, descargue el BWAPIC ya ensamblado del github.  Y para los objetivos restantes, recopilamos BWAPI-C de las fuentes para OpenBW (te contar√© un poco m√°s adelante). </p><br><h2 id="bwapi-rs">  bwapi-rs </h2><br><p>  Ahora que tenemos las carpetas, podemos describir las abstracciones de alto nivel.  Tenemos 2 tipos con los que trabajar: valores puros y punteros opacos. </p><br><p>  Con valores puros, todo es m√°s simple.  Toma el color como ejemplo.  Necesitamos que sea conveniente usar el c√≥digo Rust para que podamos usar los colores de una manera conveniente y natural: </p><br><pre> <code class="rust hljs">game.draw_line(CoordinateType::Screen, (<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>), (<span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span>), Color::Red); ^^^</code> </pre> <br><p>  Entonces, para un uso conveniente, ser√° necesario definir una idiom√°tica para la enumeraci√≥n del lenguaje Rust con <a href="">constantes</a> de C ++ y definir m√©todos de conversi√≥n en bwapi_sys :: Color usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">std :: convert :: From</a> rasgo: </p><br><pre> <code class="rust hljs"><span class="hljs-comment"><span class="hljs-comment">// FFI version #[repr(C)] #[derive(Copy, Clone)] pub struct Color { pub color: ::std::os::raw::c_int, } // Idiomatic version #[derive(PartialEq, PartialOrd, Copy, Clone)] pub enum Color { Black = 0, Brown = 19, ...</span></span></code> </pre> <br><p>  Aunque por conveniencia, puede usar la caja <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enum-primitive-derivar</a> . </p><br><p>  Con punteros opacos, no es m√°s dif√≠cil.  Para hacer esto, use el patr√≥n <a href="">Newtype</a> : </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span></span>(*<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> sys::Player);</code> </pre> <br><p>  Es decir, Player es una determinada estructura con un campo privado: un puntero opaco sin formato de C. Y as√≠ es como puede describir el m√©todo Player :: color: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Player { <span class="hljs-comment"><span class="hljs-comment">//    Player::getColor  bwapi-sys //extern "C" { // pub fn Player_getColor(self_: *mut Player) -&gt; Color; //} pub fn color(&amp;self) -&gt; Color { // bwapi_sys::Player_getColor -    BWAPI-C // self.0 -   let color = unsafe { bwapi_sys::Player_getColor(self.0) }; color.into() //  bwapi_sys::Color -&gt; Color } }</span></span></code> </pre> <br><p>  ¬°Ahora podemos escribir nuestro primer bot en Rust! </p><br><h2 id="pishem-bota-na-rust">  Escribiendo un bot en Rust </h2><br><p>  Como prueba de concepto, el bot se ver√° como un pa√≠s famoso: toda su funcionalidad ser√° contratar trabajadores y recolectar minerales. </p><br><p><img src="https://habrastorage.org/webt/hx/r_/jm/hxr_jmj2fbsitx-tfw96p2pa2tu.png" alt="Corea del norte"></p><br><p><img src="https://habrastorage.org/webt/ww/gf/lr/wwgflrekcnxtv75thaurrwcm0g8.png" alt="Corea del sur"></p><br><p>  Comencemos con las <code>gameInit</code> requeridas de <code>gameInit</code> y <code>newAIModule</code> : </p><br><pre> <code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#[no_mangle]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gameInit</span></span></span></span>(game: *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> void) { bwapi_sys::BWAPIC_setGame(game <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> bwapi_sys::Game); } <span class="hljs-meta"><span class="hljs-meta">#[no_mangle]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newAIModule</span></span></span></span>() -&gt; *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> void { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> module = ExampleAIModule { name: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>::from(<span class="hljs-string"><span class="hljs-string">"ExampleAIModule"</span></span>) }; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = wrap_handler(<span class="hljs-built_in"><span class="hljs-built_in">Box</span></span>::new(module)); result }</code> </pre> <br><p>  <code>#[no_mangle]</code> realiza la misma funci√≥n que la <code>extern "C"</code> en C ++.  Dentro de <code>wrap_handler</code> , todo tipo de magia ocurre con la sustituci√≥n de la tabla de funciones virtuales y se disfraza como una clase de C ++. </p><br><p>  La descripci√≥n de la estructura del m√≥dulo es a√∫n m√°s simple y hermosa que en C: </p><br><pre> <code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExampleAIModule</span></span></span></span> { name: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, }</code> </pre> <br><p>  Agregue un par de m√©todos para representar estad√≠sticas y dar √≥rdenes: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> ExampleAIModule { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw_stat</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> game = Game::get(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> message = <span class="hljs-built_in"><span class="hljs-built_in">format!</span></span>(<span class="hljs-string"><span class="hljs-string">"Frame {}"</span></span>, game.frame_count()); game.draw_text(CoordinateType::Screen, (<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), &amp;message); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">give_orders</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> player = Game::get().self_player(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> unit <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> player.units() { <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> unit.get_type() { UnitType::Terran_SCV | UnitType::Zerg_Drone | UnitType::Protoss_Probe =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !unit.is_idle() { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> unit.is_carrying_gas() || unit.is_carrying_minerals() { unit.return_cargo(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(mineral) = Game::get() .minerals() .min_by_key(|m| unit.distance_to(m)) { <span class="hljs-comment"><span class="hljs-comment">// WE REQUIRE MORE MINERALS unit.right_click(&amp;mineral, false); } } UnitType::Terran_Command_Center =&gt; { unit.train(UnitType::Terran_SCV); } UnitType::Protoss_Nexus =&gt; { unit.train(UnitType::Protoss_Probe); } UnitType::Zerg_Hatchery | UnitType::Zerg_Lair | UnitType::Zerg_Hive =&gt; { unit.train(UnitType::Zerg_Drone); } _ =&gt; {} }; } } }</span></span></code> </pre> <br><p>  Para que el tipo ExampleAIModule se convierta en un m√≥dulo real, debe ense√±arle a responder a los eventos <strong>onXXXX</strong> , para lo cual debe implementar el tipo EventHandler, que es un an√°logo de la tabla virtual AIModule_vtable de C: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> EventHandler <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ExampleAIModule { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_start</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { Game::get().send_text(&amp;<span class="hljs-built_in"><span class="hljs-built_in">format!</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello from Rust! My name is {}"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.name)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_end</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _is_winner: <span class="hljs-built_in"><span class="hljs-built_in">bool</span></span>) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_frame</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.draw_stat(); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.give_orders(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_send_text</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _text: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_receive_text</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _player: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Player, _text: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_player_left</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _player: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Player) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_nuke_detect</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _target: Position) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_discover</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_evade</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_show</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_hide</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_create</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_destroy</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_morph</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_renegade</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_save_game</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _game_name: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_complete</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} }</code> </pre> <br><p>  Construir e iniciar el m√≥dulo es tan f√°cil como para C: </p><br><pre> <code class="bash hljs">bwapi-rs$ cargo build --example dll --target=i686-pc-windows-gnu bwapi-rs$ cp ./target/i686-pc-windows-gnu/debug/examples/dll.dll ~/Starcraft/bwapi-data/Dll.dll bwapi-rs$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/Starcraft/bwapi-data/ Starcraft$ wine bwheadless.exe -e StarCraft.exe -l bwapi-data/BWAPI.dll --headful ... ... ...</code> </pre> <br><p>  Y el video de trabajo: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/rACbnWpI01M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2 id="nemnogo-o-krosskompilyacii">  Un poco sobre compilaci√≥n cruzada </h2><br><p>  En resumen, Rust es hermoso!  En dos clics, puede poner muchas cadenas de herramientas para diferentes plataformas.  Espec√≠ficamente, la cadena de herramientas i686-pc-windows-gnu se establece mediante el comando: </p><br><pre> <code class="bash hljs">rustup target add i686-pc-windows-gnu</code> </pre> <br><p>  Tambi√©n puede especificar el kofig para carga en la ra√≠z del proyecto <code>.cargo/config</code> : </p><br><pre> <code class="hljs powershell">[<span class="hljs-type"><span class="hljs-type">target.i686</span></span>-<span class="hljs-type"><span class="hljs-type">pc</span></span>-<span class="hljs-type"><span class="hljs-type">windows</span></span>-<span class="hljs-type"><span class="hljs-type">gnu</span></span>] linker = <span class="hljs-string"><span class="hljs-string">"i686-w64-mingw32-gcc"</span></span> ar = <span class="hljs-string"><span class="hljs-string">"i686-w64-mingw32-ar"</span></span> runner = <span class="hljs-string"><span class="hljs-string">"wine"</span></span></code> </pre> <br><p>  Y eso es todo lo que necesita hacer para compilar su proyecto Rust desde Linux en Windows. </p><br><h2 id="openbw">  Openbw </h2><br><p>  Estos muchachos fueron a√∫n m√°s lejos.  Decidieron escribir una versi√≥n de c√≥digo abierto del juego SC: BW!  Y les va bastante bien.  Uno de sus objetivos era implementar im√°genes HD, pero SC: Remastered se adelant√≥ a ellas = (Por el momento, puedes usar su API para escribir bots (s√≠, tambi√©n en C ++). Pero la caracter√≠stica m√°s sorprendente es la capacidad de ver repeticiones <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">directamente en el navegador</a> . </p><br><h2 id="zaklyuchenie">  Conclusi√≥n </h2><br><p>  Un problema no resuelto permaneci√≥ durante la implementaci√≥n: no controlamos la unicidad de los enlaces, y la existencia simult√°nea de <code>&amp;mut</code> y <code>&amp;</code> al cambiar un objeto conducir√° a un comportamiento indefinido.  Problemas  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">Halt</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">intent√≥</a> implementar enlaces idiom√°ticos, pero su fusible se desvaneci√≥ ligeramente.  Adem√°s, para resolver este problema, deber√° nivelar cualitativamente la API de C ++ y establecer correctamente los calificadores <code>const</code> . </p><br><p>  Realmente disfrut√© trabajando en este proyecto, Ï¢ÖÏùº Ï¢ÖÏùº vi repeticiones y me sumerg√≠ profundamente en la atm√≥sfera.  Este juego dej√≥ ÎØøÏñ¥ ÎØøÏñ¥ ÏïäÏùÑ Ï†ïÎèÑ Ïù∏ un legado.  Ning√∫n juego es , ÏóÜÎã§ popular entre SC: BW, y su impacto en ÎåÄÌïúÎØºÍµ≠ Ï†ïÏπò ÏóêÍ≤å fue impensable.  Los jugadores profesionales en Corea ÏïÑÎßàÎèÑ son tan populares como los dramas coreanos ÎìúÎùºÎßà Ï£ºÏó∞ Î∞∞Ïö∞ Îì§ transmitidos en horario estelar.  ÎòêÌïú, ÌïúÍµ≠ ÏóêÏÑú ÌîÑÎ°ú Í≤åÏù¥Î®∏ ÎùºÎ©¥ Íµ∞ÎåÄ Ïùò ÌäπÎ≥ÑÌïú Ïú°Íµ∞ Ïóê ÏûÖÎåÄ Ìï† Ïàò ÏûàÎã§. </p><br><p>  ¬°Viva StarCraft! </p><br><h2 id="ssylki">  Referencias </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gitter</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bwapi-rs</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bwapi-sys</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bwapi-c</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bwapi</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">openbw</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es416743/">https://habr.com/ru/post/es416743/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es416729/index.html">El programa PYCON RUSSIA est√° listo: 25 informes y 3 talleres de oradores de Google, Red Hat, Yelp, Yandex</a></li>
<li><a href="../es416731/index.html">Frost on glass: c√≥mo hacer pl√°stico de vidrio resistente</a></li>
<li><a href="../es416737/index.html">A * Algoritmo de b√∫squeda de ruta en un juego Voxel 3d Unity</a></li>
<li><a href="../es416739/index.html">Nuevo ASUS en Computex 2018</a></li>
<li><a href="../es416741/index.html">Los atacantes usaron certificados D-Link robados en su software de robo de contrase√±as</a></li>
<li><a href="../es416745/index.html">Nuevo ASUS ROG en Computex 2018</a></li>
<li><a href="../es416751/index.html">Recopilaci√≥n de informaci√≥n contextual para el registro.</a></li>
<li><a href="../es416753/index.html">El popular plugin Hola VPN est√° comprometido</a></li>
<li><a href="../es416755/index.html">Me gusta extremo - Comit√© de investigaci√≥n contra</a></li>
<li><a href="../es416757/index.html">Pruebas escamosas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>