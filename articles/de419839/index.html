<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔀 👋🏽 ⛏️ Low Level NCR ATM Hacking 👨🏽‍✈️ 📦 🙍🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bild: Sascha Kohlmann , CC BY-SA 2.0 

 Es gibt Systeme, auf die bloße Sterbliche standardmäßig keinen Zugriff haben. Und die Entwickler solcher Syste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Low Level NCR ATM Hacking</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/419839/"><img src="https://habrastorage.org/webt/tj/nt/2x/tjnt2xaabgktk2grtx0ihas90f0.jpeg"><br><br>  <i>Bild: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sascha Kohlmann</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CC BY-SA 2.0</a></i> <br><br>  Es gibt Systeme, auf die bloße Sterbliche standardmäßig keinen Zugriff haben.  Und die Entwickler solcher Systeme glauben naiv, dass sie vor dem Eindringen und den scharfen Augen von Forschern geschützt sind. <br><br>  Nehmen Sie mindestens Geldautomaten.  Es gibt häufige Fälle, in denen unbekannte Personen an einen Geldautomaten kommen, einen Laptop anschließen, Geld nehmen und gehen, ohne Protokolle im System zu hinterlassen.  Und aktuelle Geschichten mit " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Schnitzel</a> " (Malware namens <i>Cutlet Maker</i> ) bestätigen, dass es keine unverwundbaren Systeme gibt - es gibt unterforschte. <br><a name="habracut"></a><br><h2>  Studienbeginn </h2><br>  Es gibt eine Meinung, dass die einzige Möglichkeit, Geld von einem Geldautomaten zu stehlen, darin besteht, auf einem Muldenkipper zu fahren, einen Haken am Geldautomaten aufzuheben und abzureißen und dann eine Mühle, eine Brechstange und ein Gasschweißgerät zu verwenden.  Es gibt aber noch eine andere Methode. <br><br>  Nach einer kurzen Suche bei <i>Ebay</i> hatte ich einen <b>NCR USB S1 Dispenser</b> mit einer Firmware auf meinem Schreibtisch.  Die Ziele waren wie folgt: <br><br><ul><li>  einen Bypass zum Verschlüsseln der Befehle finden, die der Computer über USB an den Spender selbst sendet, insbesondere zum Ausgeben von Banknoten; </li><li> Erfahren Sie, wie Sie die Notwendigkeit eines physischen Zugriffs auf den Safe zur Authentifizierung (Kassetten-Ruckeln) umgehen können, um Verschlüsselungsschlüssel für Befehle aus dem vorherigen Absatz zu generieren. </li></ul><br><img src="https://habrastorage.org/webt/nk/qw/ri/nkqwri4xymfedse_tdd_mfqkwc8.png"><br><br><h2>  Firmware </h2><br>  Die Firmware ist eine <i>ELF-</i> Datei für den <i>NXP ColdFire-</i> <i>Prozessor</i> ( <i>Motorola 68040</i> , mein Lieblingsprozessor), der unter <i>VxWorks v5.5.1 ausgeführt wird</i> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zy/n2/01/zyn201rwrhyrwet6lawdgkcjmpm.png"></div><br><br>  In der <i>ELF-</i> Datei sind zwei Hauptabschnitte von Interesse - <i>.text</i> und <i>.data</i> : <br><br><ul><li>  Einer von ihnen enthält einen Code, der sich ständig dreht (nennen wir ihn Hauptfirmware), wenn der Spender an die Systemeinheit im oberen Teil des Geldautomaten angeschlossen ist. </li><li>  Der zweite ist der mit <b>zlib</b> gepackte Bootloader-Code (sein lokaler Name ist <b>USB Secure Bootloader</b> ), der für das Hochladen der Firmware und das Starten des Hauptcodes verantwortlich ist. </li></ul><br>  Und das Beste daran ist, dass die Symbole in der Datei ungeschnitten bleiben - nehmen Sie sie und suchen Sie nach etwas Interessantem. <br><br><h2>  Internes Gerät der Hauptfirmware </h2><br>  Wenn Sie den Code in Hauptkomponenten unterteilen, erhalten Sie das folgende Schema (in der Reihenfolge der Übermittlung): <br><br><ol><li>  Ein Stream, der sich mit dem Empfangen und Verteilen von USB-Paketen auf Dienste befasst. </li><li>  <b>Services</b> sind die wichtigsten ausführenden Einheiten, jede von ihnen hat ihre eigene Rolle und jede hat ihre eigenen Aufgaben (Klassen). </li><li>  <b>Klassen</b> - hier sind dies Aufgaben, die ein bestimmter Dienst mithilfe von Controllern ausführen kann. </li><li>  <b>Controller</b> sind tatsächlich „ <i>Arbeiter</i> “ ( <i>Arbeiter</i> ), die an der Validierung der an sie gesendeten Aufgaben, ihrer Implementierung sowie der Bildung von Antwortpaketen beteiligt sind. </li></ol><br><img src="https://habrastorage.org/webt/bb/x9/ds/bbx9dsyvocknltgx3sr8kubghv0.png"><br><br>  Da die Firmware viel Code enthält, wurde beschlossen, zunächst nach allen möglichen Diensten zu suchen und dann zu prüfen, wohin die Aufgaben übertragen werden. <br><br>  Als Ergebnis wurden die folgenden Dienste gefunden, die genau das tun sollten, wonach ich suche: <br><br>  1) <b>DispTranService (Dispenser Transaction Service)</b> : Arbeiten mit verschlüsselten Befehlen, Bildung von Banknotenbündeln, Authentifizierung.  Man kann sagen, das interessanteste ist hier. <br><br><img src="https://habrastorage.org/webt/z4/j9/48/z4j948foksgqipdtpkpd4txwe2m.png"><br><br>  2) <b>securityService</b> : Nach der Authentifizierung wird auf der Seite des Spenders ein Sitzungsschlüssel generiert, der auf Anforderung des Computers verschlüsselt an diesen gesendet wird.  Dieser Schlüssel verschlüsselt alle wichtigen Befehle - Ausgabe und bildet ein Bündel von Banknoten. <br><br><img src="https://habrastorage.org/webt/ak/wi/q2/akwiq2yyefxr1l_3d2iepme-qdo.png"><br><br>  Anschließend fiel mir ein weiterer Dienst auf: <b>UsbDownloadService</b> .  Wenn der Spender an den Computer angeschlossen ist und die Firmware-Version des Spenders nicht mit der auf dem Geldautomaten gespeicherten übereinstimmt, wechseln Sie zum <b>Bootloader</b> , um die Firmware hochzuladen, mit der das Betriebssystem arbeiten soll (sie befindet sich im Ordner mit der Software des Herstellers auf dem Computer).  Dieser Dienst kann auch Informationen zur Firmware-Version bereitstellen. <br><br><img src="https://habrastorage.org/webt/26/kc/yc/26kcycxcpiehexunrdlmpq4gjus.png"><br><br><h2>  Physische Authentifizierung </h2><br>  Die physische Authentifizierung wird auf höchster Ebene implementiert und schützt den Geldautomaten davor, einfach Befehle über USB zu senden, um sie ohne Autorisierung auszugeben.  In diesem Fall besteht es darin, dass Sie nur mit einem offenen Safe mit Geld eine der folgenden Aktionen ausführen müssen: <br><br><ul><li>  Entfernen Sie die untere Kassette und legen Sie sie ein. </li><li>  Schalten Sie den Kippschalter auf der Rückseite des Racks mit dem Spender. </li></ul><br><img src="https://habrastorage.org/webt/wr/vg/jn/wrvgjn2ondfz-ar9eqratwm8fuy.png"><br><br>  All dies ist jedoch nur erforderlich, wenn die Zugriffsebene auf das Maximum eingestellt ist, dh physisch.  Es gibt drei davon: <i>USB</i> (0), <i>logisch</i> (1) und <i>physisch</i> (2).  Die verbleibenden zwei werden von Dienstanbietern und Entwicklern zum Debuggen und Testen der Firmware verwendet.  Nun, die physische wird vom Hersteller dringend für die standardmäßige Verwendung empfohlen. <br><br><h2>  Sicherheitslücke </h2><br>  Im Folgenden wird die kritische Sicherheitsanfälligkeit beschrieben (die vom Anbieter zum Zeitpunkt der Veröffentlichung des Artikels bereits behoben wurde), die es ermöglichte, alle Spenderbefehle, einschließlich Bargeldabhebungen, auszuführen, wenn Zugang zum Servicebereich bestand, jedoch ohne Zugang zum Safe (z. B. durch das Loch in der Frontplatte des Geldautomaten). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yj/yp/n4/yjypn4wot4lpkggp6xunjrgr2va.png"></div><br><br>  Wie sich herausstellte, akzeptiert <b>UsbDownloadService</b> Befehle, die keine Verschlüsselung erfordern.  Klingt verlockend.  Aber plötzlich ist alles weiter geschützt und der Name <b>Secure Bootloader</b> zahlt sich aus? <br><br>  <i>(Spoiler: nicht gerechtfertigt!)</i> <br><br><h2>  Wir müssen tiefer gehen </h2><br>  Wie bereits erwähnt, gibt es im Abschnitt <i>.data</i> einen gepackten Loader-Code, der mich lange Zeit nicht interessiert hat, und meine Kollegen haben ihn bei der Prüfung der Firmware nicht beachtet. <br><br><img src="https://habrastorage.org/webt/rd/bf/zt/rdbfztrajma7yrnq6kmrr7o5jcc.png"><br><br>  Während der Bootloader ein Rätsel war, blieb die Frage offen: Wie überflutet die Software auf dem Computer die Firmware?  In der Hauptfirmware wurde nichts dergleichen gefunden. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tb/b0/uy/tbb0uy2d1bzgxpfbf1ies02kapg.png"></div><br><br>  Der <b>Bootloader wird also</b> entpackt und mit dem Offset <b>0x100000</b> in die <i>IDA</i> <b>geladen</b> - jetzt können Sie nachforschen ... Nur gibt es keine Zeichen! <br><br>  Es spielt keine Rolle: Vergleichen Sie die Hauptfirmware mit dem Bootloader-Code, lesen Sie das Datenblatt des Controllers - und es entsteht ein bestimmtes Bild. <br><br><img src="https://habrastorage.org/webt/e-/xd/vv/e-xdvvhfkqldjbfbjrqybgdwua4.png"><br><br>  Es stellte sich heraus, dass das Hochladen der Firmware, obwohl sie geschützt aussieht, nicht wirklich so ist.  Alles, was Sie wissen müssen, ist, wie man es richtig ausfüllt. <br><br>  Es wurde viel Mühe und Zeit aufgewendet, um diesen Prozess vollständig zu verstehen (weitere Informationen finden Sie im Bericht „ <b>Blackbox ist tot - Es lebe die Blackbox!</b> “ Auf der Black Hat 2018-Konferenz in Las Vegas).  Warum lohnt es sich, den NVRAM-Speicher zu löten und ein Backup hochzuladen, um den gesamten Controller zu "kratzen" ... <i>Vielen Dank an Kollege Alexei für Ihre Geduld!</i> <i><br></i> <br>  Als Ergebnis haben wir den folgenden Algorithmus zum Hochladen der Firmware auf den Spender erhalten: <br><br>  1) Generieren Sie ein Paar RSA-Schlüssel und geben Sie den öffentlichen Schlüssel in die Steuerung ein. <br><br><img src="https://habrastorage.org/webt/6g/y4/1h/6gy41hu5hu_ivzg6lazlc5qbaaw.png"><br><br>  2) Schreiben Sie nacheinander <i>.data-</i> und <i>.text-</i> Abschnitte von <i>ELF</i> aus Abschnittsüberschriften an ihre physischen Adressen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jj/yj/3t/jjyj3t71ptne_l7r4cpouwbi6iq.png"></div><br><br>  3) Berechnen Sie SHA-1 aus den aufgezeichneten Daten, verschlüsseln Sie den Hash mit einem privaten Schlüssel und senden Sie ihn an den Controller. <br><br><img src="https://habrastorage.org/webt/kr/9o/ld/kr9oldlexmlcav4iyl9hnxrs844.png"><br><br>  4) Berechnen und senden Sie die Summe aller aufgezeichneten Wörter der Firmware. <br><br><img src="https://habrastorage.org/webt/54/e8/dl/54e8dl0gwyv3i0pxaqw-udgbmbu.png"><br><br>  Wenn danach alles gezählt und erfolgreich aufgezeichnet wurde, wird die Hauptfirmware geladen. <br><br>  Es stellte sich heraus, dass es beim Schreiben von Firmware nur eine Einschränkung gibt: Die Firmware-Version darf nicht niedriger als die aktuelle sein.  Aber niemand hindert uns daran, die Firmware-Version in ihren Daten selbst zu ändern. <br><br>  Als Ergebnis wurde meine spezielle Firmware mit <i>Anti-Sicherheitskorrekturen</i> hochgeladen und erfolgreich gestartet! <br><br>  Zu diesem Zeitpunkt war der Haupt-Firmware-Code gut untersucht, es wurden Befehle zur Ausgabe von Banknoten gefunden.  Jetzt können sie unverschlüsselt gesendet werden, und der Spender führt sie gerne aus. <br><br><img src="https://habrastorage.org/webt/gu/bk/m1/gubkm1l2g0mdd_dfepxjy2n50sa.png"><br><br><h2>  Problem </h2><br>  Nach allem, was während der Studie erlebt wurde (zum Beispiel ein „ <i>vermauerter</i> “ echter Geldautomat), war das Ergebnis so angenehm und kompensierte die Bemühungen, dass der Algorithmus mit einem anderen großen Anbieter wiederholt werden wollte. <br><br><img src="https://habrastorage.org/webt/yt/k1/wx/ytk1wxlqy9dotiuoqvwlvsc2g0o.png"><br><br>  Der realste Geldautomat begann gespannt und eifrig mit frischen, knusprigen Banknoten zu teilen (in diesem Fall "Bonbonverpackungen" des Anbieters).  Es wurde keine Magie angewendet: nur ein Laptop, ein Gehirn und ein USB-Kabel. <br><br><h2>  Schlussfolgerungen </h2><br>  Wir waren erneut davon überzeugt, dass es nach dem Prinzip der <b>Sicherheit durch Dunkelheit</b> unmöglich ist, einen angemessenen Schutz zu bieten.  Die Richtigkeit des Codes oder der Firmware bedeutet keineswegs, dass ein Angreifer zu einem bestimmten Zeitpunkt keinen Zugriff darauf erhält und die gefundenen Sicherheitslücken nicht ausnutzt.  Alles, was zur Verwirklichung egoistischer Ziele notwendig ist, kann in Gegenwart eines bestimmten Geldbetrags erworben werden. <br><br>  Entwickler müssen mit dem Code umgehen, und Sicherheitspersonal sollte ihn schützen.  Aus diesem Grund scheint der produktivste Ansatz die Zusammenarbeit mit Informationssicherheitsunternehmen zu sein, die über ausreichende Erfahrung bei der Gewährleistung der Sicherheit verschiedener Systeme verfügen, die jeweils zum Aufbau eines angemessenen Schutzes beitragen. <br><br>  PS Vendor bestätigte die Sicherheitsanfälligkeit (eine Lücke wurde auch in einem anderen Modell gefunden - <b>S2</b> ), die im Februar-Fix von 2018 als behoben deklariert wurde. <br><br>  CVE-Liste: <br><br><ul><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CVE-2017-17668</a></b> (NCR <b>S1</b> Dispenser), </li><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CVE-2018-5717</a></b> (NCR <b>S2</b> Dispenser). </li></ul><br><h2>  Danksagung </h2><br>  Vor mir hatten meine Kollegen - <i>Dima Sklyarov</i> und <i>Misha Tsvetkov</i> - bereits an der Firmware gearbeitet (allerdings ohne Spenderplatine).  Ihre Erfolge haben mir in der Studie sehr geholfen, wofür ich ihnen vielmals danke!  In Bezug auf die Hardware hat mir <i>Aleksei Stennikov sehr</i> geholfen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de419839/">https://habr.com/ru/post/de419839/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de419829/index.html">Die Standardschlüsselverschlüsselung von OpenSSH ist schlechter als keine</a></li>
<li><a href="../de419831/index.html">So funktioniert JS: Benutzerdefinierte Elemente</a></li>
<li><a href="../de419833/index.html">Fernarbeit, wie es funktioniert</a></li>
<li><a href="../de419835/index.html">Wie man Autoren motiviert, mit Experten verhandelt und im Allgemeinen gute Artikel schreibt</a></li>
<li><a href="../de419837/index.html">Ich, RoboLoyer, oder wie man in Dokumenten nach Anomalien sucht</a></li>
<li><a href="../de419843/index.html">GeekUniversity eröffnet Einschreibung an der Fakultät für Künstliche Intelligenz</a></li>
<li><a href="../de419845/index.html">Release 0.4.9: Implikationen</a></li>
<li><a href="../de419847/index.html">Von 0,01 TFlops HPL bis ASC'18 Application Innovation</a></li>
<li><a href="../de419849/index.html">Motherboard-Untersuchung: Wie Cyberkriminelle mithilfe von Telekommunikationsunternehmen Mobiltelefonnummern stehlen</a></li>
<li><a href="../de419853/index.html">Unentdeckte IT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>