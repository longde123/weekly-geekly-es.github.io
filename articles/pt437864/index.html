<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍔 👍🏽 👩🏿‍🤝‍👩🏼 Sistema de Monitoramento para servidores Windows em SQL puro, e como eu o havia arrastado secretamente para a Produção 👨🏿‍🌾 👨🏼‍🏫 🐶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Há muito tempo, em uma galáxia muito distante, havia uma empresa que cresceu de uma startup para algo muito maior, mas por um tempo o departamento de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sistema de Monitoramento para servidores Windows em SQL puro, e como eu o havia arrastado secretamente para a Produção</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437864/"> Há muito tempo, em uma galáxia muito distante, havia uma empresa que cresceu de uma startup para algo muito maior, mas por um tempo o departamento de TI ainda era compacto e muito eficiente.  Essa empresa hospedou centenas de servidores Windows virtuais e, é claro, esses servidores foram monitorados.  Mesmo antes de ingressar na empresa, o NetIQ havia sido escolhido como uma solução de monitoramento. <br><br>  Uma das minhas novas tarefas era oferecer suporte ao NetIQ.  A pessoa que trabalhou com o NetIQ antes, falou muito sobre sua experiência com o NetIQ, infelizmente, se eu tentar colocá-lo aqui, seria apenas uma longa fila de caracteres '****'.  Logo eu percebi o porquê.  Steve Jobs provavelmente está girando em seu túmulo olhando para a interface assim: <br><br><img src="https://habrastorage.org/webt/wv/cq/kj/wvcqkjtunh0raiwt14rvhpbn-pw.png" alt="imagem"><br><a name="habracut"></a><br>  Na primeira linha, a lógica da caixa de seleção é positiva ( <i>evento de aumento</i> ); na próxima, negativa ( <i>evento de não elevação</i> ).  Então, como ' <i>Aumentar evento somente i</i> f' funciona?  Eu não tenho ideia. <br><br>  No entanto, havia algo muito pior no NetIQ: seu agente de monitoramento era muito frágil.  Muito mais vulnerável que o próprio Windows.  Pouca memória?  O agente está inoperante.  CPU é 100%?  O agente não responde.  0 bytes livres restantes em uma unidade de disco?  Bem, para enviar uma mensagem de alerta, um agente deve primeiro salvá-lo em um arquivo em um disco ... Então, sim, você não recebe nenhum alerta nesse caso. <br><br>  No entanto, “não conserte o que não está quebrado” e, de alguma forma, vivemos com ele até que nossa empresa foi comprada por uma muito maior.  Quando uma grande empresa compra uma pequena, a pequena se dissipa como uma gota de água no mar.  No entanto, no nosso caso, nós (da perspectiva da TI) não éramos muito menores que a TI de uma empresa maior, e era óbvio desde o início que a fusão seria muito complicada.  Tão complicado que, por um tempo, fomos deixados sozinhos como um departamento independente e todos os processos de negócios e de TI permaneceram os mesmos - apenas sob o guarda-chuva do novo nome.  Isso me lembra o momento em que <b>O ANEL</b> estava deitado na lava, mas ainda não começou a derreter. <br><br><img src="https://habrastorage.org/webt/qf/--/cy/qf--cyd5ehkjz_5zjhmogmwekcw.jpeg" alt="imagem"><br><br>  Enquanto isso, eu atualizei o NetIQ da versão 7 para 8 e posterior para a versão 9. Foi quando todos os nossos problemas começaram.  Estávamos usando o NetIQ para monitorar apenas algumas coisas básicas: disponibilidade de um servidor, memória, CPU, espaço em disco e o mais importante para nós - status dos serviços domésticos.  Quando qualquer tipo de inicialização de serviço desenvolvido em casa foi definido como "Automático", ele deve estar sempre em execução (caso contrário, consideramos travado).  Não deve haver casos como este: <br><br><img src="https://habrastorage.org/webt/45/fz/1h/45fz1ho3t3mxx6ka8yjlhg-_yjs.jpeg" alt="imagem"><br><br>  Portanto, o NetIQ parou de monitorar o status dos serviços.  Após uma semana de experimentação e outra semana de chamadas com o suporte do NetIQ, tínhamos aprendido que “ <i>não era um bug, era um recurso</i> ” e o alerta era acionado apenas quando um processo saía com um código de saída específico.  E nossos serviços falharam com QUALQUER código. <br><br>  Nesse ponto, era tarde demais para reverter.  Como você entende, assim que descobrimos que nossa infraestrutura crítica não foi monitorada, imediatamente ... eh ... não fizemos nada.  Porque naquela época o processo de “fusão” da nossa empresa em uma maior atingiu uma fase ativa, e era assim: <br><br><img src="https://habrastorage.org/webt/cq/y3/zk/cqy3zk1iyhts4aijbhx0umtxab8.jpeg" alt="imagem"><br><br>  Ouvi sons de trovão muito acima, e parecia que os deuses no Olimpo estavam decidindo o destino do mundo, enquanto eu tentava distraí-los com meu minúsculo problema técnico.  Ao mesmo tempo, não conseguia dormir sabendo que nosso sistema de monitoramento estava meio cego. <br><br>  Depois de perceber que não havia mais o que esperar, decidi criar uma solução rápida e suja - um minúsculo scanner de serviço que deveria passar por todos os servidores para verificar os serviços e enviar e-mails para os serviços que estavam inativos, exatamente como na versão antiga do NetIQ fez.  Você pode pensar que o script do PowerShell é a melhor maneira de fazê-lo, mas ... Se tudo o que você tem é um martelo, tudo parece um prego.  Se você é um DBA que trabalhou com SQL desde a versão 6.0, então ... Aqui está um pequeno extrato do código, para que você possa entender do que estou falando: <br><br><img src="https://habrastorage.org/webt/zt/bb/3h/ztbb3hzjroe6t_bzlsj1atrulbi.png" alt="imagem"><br><br>  Levei apenas algumas horas para escrever a primeira solução.  Durante os próximos dias, adicionei uma auditoria, parâmetros e outras coisas sofisticadas.  Depois de examinar o que o comando WMIC poderia fazer, não consegui parar.  Não me lembro exatamente do que aconteceu nas próximas duas semanas - tudo estava meio embaçado, mas quando acordei, todos os recursos do NetIQ foram implementados usando SQL puro. <br><br>  Eu não apenas copiei a funcionalidade NetIQ "como está", eu havia implementado tudo o que sempre sonhei.  No alerta de e-mail do LOWDISK, você também anexa um PDF com um gráfico de crescimento do uso do disco para entender instantaneamente se o crescimento foi genuíno ou se algo deu errado.  Pouca memória - e você obtém não apenas o gráfico, mas também uma distribuição de memória por processo. Além disso, para w3wp.exe, você recebe um nome de pool anexado.  Eu também havia implementado lembretes inteligentes com proteção contra inundações e muitas outras coisas sofisticadas.  BTW, a lista de servidores virtuais foi extraída automaticamente dos repositórios VMware.  Ao olhar para os assuntos de alerta em um cliente móvel, você pode dizer instantaneamente o que estava acontecendo - mesmo sem abrir os emails: <br><br><img src="https://habrastorage.org/webt/ps/cq/fk/pscqfkh5qb23_oujl6zyjmeexzy.png" alt="imagem"><br><br>  Os desenvolvedores modernos se acostumaram a criar níveis de abstração a ponto de prejudicar sua capacidade de escrever um código simples e direto.  Eles não podem criar um sistema de monitoramento sem dizer: “Ok, para qualquer servidor, podemos executar qualquer conjunto de scripts com regras de um repositório ... Quão flexível ...”.  Mas o monitoramento de algumas coisas fundamentais, como status de memória, CPU, disco, serviços, é único.  Ao implementar a verificação dessas condições básicas com um nível de abstração, elas terminam com um código que funciona igualmente ruim para todos os casos.  Este é um exemplo do sistema SCOM.  Tenho certeza de que foi implementado exatamente pelas especificações: <br><br><img src="https://habrastorage.org/webt/wm/3m/ut/wm3mutentcltlmpobwyjutqm0me.png" alt="imagem"><br><br>  Mas a grande vantagem do novo sistema era que não havia nenhum agente.  Sem agentes - nada para instalar, nada para quebrar.  O sistema era simples e confiável como um hummer. <br><br>  Poucos meses depois, cheguei ao trabalho e passei uma ou duas horas trabalhando em minha nova criação - lentamente, sem prazos e ETAs, deixando quase nenhuma dívida técnica.  Depois de um tempo eu me forcei a parar. <br><br>  O NetIQ ainda estava em produção, mas as pessoas definitivamente preferiram alertas do novo sistema, mais confiáveis ​​e informativos.  Gradualmente, mudei todos os "assinantes" de alerta para o novo sistema, mantendo, no entanto, o antigo sistema ativo.  Enquanto isso, o processo de "fusão" de nossa antiga empresa em uma maior chegara à sua fase final: <br><br><img src="https://habrastorage.org/webt/8j/sy/da/8jsydazfbheft25w9ugymimk_hi.jpeg" alt="imagem"><br><br>  Bem, tudo tem um fim.  Fiquei até surpreso por ter tido a chance de brincar com essas coisas em uma grande empresa burocrática.  Após um mês de preparação, disseram-me que “ <i>ok, em uma semana, encerramos o NetIQ e passamos para o SCOM como padrão corporativo</i> ”.  Desliguei o NetIQ (tenho que admitir, odiei tanto que foi um dos momentos mais felizes da minha carreira) e comecei a esperar o SCOM chegar.  Mas não havia.  Nada desde uma semana, mês e até um quarto. <br><br>  Obtivemos o SCOM somente após 6 meses completos - alguém tinha esquecido o custo das licenças para o grande número de servidores que tínhamos.  Nesses 6 meses, muitos departamentos tornaram-se tão dependentes do novo sistema, que mantinha não apenas os alertas, mas também as métricas e inventários de desempenho, que estava fora de questão desativá-lo.  Tornou-se um segundo sistema de backup.  Para os auditores, existe o SCOM, para as coisas realmente úteis - existe a minha criação. <br><br>  De tempos em tempos, os gerentes de diferentes níveis hierárquicos passavam por cima dos alertas desse sistema e perguntavam - o que é?  Recentemente, eu expliquei toda a história por trás deste produto.  Eles riram e deixaram esse sistema funcionar, e para mim foi uma chance de escrever um código como quando eu era estudante - guiado não por especificações, mas baseado no meu próprio entendimento, como um hobby.  Foi muito divertido. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Artigo em russo</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt437864/">https://habr.com/ru/post/pt437864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt437846/index.html">bobaoskit - acessórios, dnssd e WebSocket</a></li>
<li><a href="../pt437848/index.html">Tornamos o processo de desenvolvimento de software pesado para microcontroladores mais conveniente (não)</a></li>
<li><a href="../pt437850/index.html">Quem é mais eficaz no layout de PCB?</a></li>
<li><a href="../pt437852/index.html">História do Shipastik</a></li>
<li><a href="../pt437858/index.html">Palestras adicionais do curso "Designing Highly Loaded Systems" (outono de 2018) em Technopolis</a></li>
<li><a href="../pt437868/index.html">Semana 05 de segurança: Impressoras, câmeras, 7zip e ética</a></li>
<li><a href="../pt437870/index.html">Como Resident Evil 2 desmoronou, mas foi capaz de se tornar o maior sucesso da Capcom</a></li>
<li><a href="../pt437872/index.html">Sapateiro sem botas. Como os alunos escreveram e-mails de phishing</a></li>
<li><a href="../pt437876/index.html">"Nuvens": qual é a vantagem sobre o servidor corporativo</a></li>
<li><a href="../pt437878/index.html">Tendências de segurança cibernética do BI.ZONE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>