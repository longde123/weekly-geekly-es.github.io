<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤šğŸ» ğŸ‡ ğŸ¡ FutexåŸºç¡€ ğŸ£ â­ï¸ ğŸ•¡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Futex ï¼ˆ futex- â€œå¿«é€Ÿç”¨æˆ·ç©ºé—´äº’æ–¥é‡â€çš„ç¼©å†™ï¼‰æ˜¯Linuxå¼€å‘äººå‘˜ä»IBMåœ¨2002å¹´æå‡ºçš„ä¸€ç§æœºåˆ¶ï¼Œå¹¶äº2003å¹´åº•è¿›å…¥å†…æ ¸ã€‚ ä¸»è¦æ€æƒ³æ˜¯æä¾›ä¸€ç§æ›´æœ‰æ•ˆçš„æ–¹æ³•ï¼Œä»¥æœ€å°‘çš„OSå†…æ ¸è°ƒç”¨æ¬¡æ•°æ¥åŒæ­¥ç”¨æˆ·çº¿ç¨‹ã€‚ 

 åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å›é¡¾è¿™äº›åŠŸèƒ½æ¨¡å—ï¼Œå°è¯•äº†è§£å®ƒä»¬çš„å·¥ä½œåŸç†ï¼Œè¿˜å°†å®ƒä»¬ç”¨ä½œæ„å»ºæ›´...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>FutexåŸºç¡€</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/infopulse/blog/418705/">  <b>Futex</b> ï¼ˆ <b>futex-</b> â€œå¿«é€Ÿç”¨æˆ·ç©ºé—´äº’æ–¥é‡â€çš„ç¼©å†™ï¼‰æ˜¯Linuxå¼€å‘äººå‘˜ä»IBMåœ¨2002å¹´æå‡ºçš„ä¸€ç§æœºåˆ¶ï¼Œå¹¶äº2003å¹´åº•è¿›å…¥å†…æ ¸ã€‚ ä¸»è¦æ€æƒ³æ˜¯æä¾›ä¸€ç§æ›´æœ‰æ•ˆçš„æ–¹æ³•ï¼Œä»¥æœ€å°‘çš„OSå†…æ ¸è°ƒç”¨æ¬¡æ•°æ¥åŒæ­¥ç”¨æˆ·çº¿ç¨‹ã€‚ <br><br> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å›é¡¾è¿™äº›åŠŸèƒ½æ¨¡å—ï¼Œå°è¯•äº†è§£å®ƒä»¬çš„å·¥ä½œåŸç†ï¼Œè¿˜å°†å®ƒä»¬ç”¨ä½œæ„å»ºæ›´é«˜çº§åˆ«ï¼ˆæˆ‘ä»¬ç†Ÿæ‚‰çš„ï¼‰åŒæ­¥å¯¹è±¡çš„åŸºç¡€ã€‚ <br><br> é‡è¦ä¸€ç‚¹ï¼šfutexesæ˜¯ä¸€ä¸ªç›¸å½“ä½çº§çš„å·¥å…·ï¼›ä»…åœ¨å¼€å‘åŸºæœ¬åº“ï¼ˆä¾‹å¦‚æ ‡å‡†C / C ++åº“ï¼‰æ—¶æ‰å€¼å¾—ç›´æ¥ä½¿ç”¨å®ƒã€‚ æ‚¨ä¸å¤ªå¯èƒ½éœ€è¦åœ¨å¸¸è§„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨futexã€‚ <br><a name="habracut"></a><br><h3> åŠ¨æœº </h3><br> åœ¨futexå‡ºç°ä¹‹å‰ï¼Œæœ‰å¿…è¦æ¯æ¬¡éƒ½è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼ˆä¾‹å¦‚ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">semop</a> ï¼‰æ¥æ§åˆ¶å¯¹å¤šä¸ªçº¿ç¨‹çš„å…±äº«èµ„æºçš„è®¿é—®ï¼Œè¿™æ˜¯èµ„æºå¯†é›†å‹çš„ï¼Œå› ä¸ºæ¯ä¸ªè°ƒç”¨éƒ½éœ€è¦å°†ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ¨¡å¼åˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼ã€‚ éšç€ç°ä»£å¤„ç†å™¨ä¸­å†…æ ¸æ•°é‡çš„å¢åŠ ä»¥åŠåº”ç”¨è½¯ä»¶ä¸­çº¿ç¨‹æ•°é‡çš„å¢åŠ ï¼Œè¿™å·²ç»æˆä¸ºä¸€ä¸ªé‡è¦çš„é—®é¢˜ã€‚ é‰´äºæ‰€æœ‰è¿™äº›è°ƒç”¨å‡æœªæºå¸¦ä»»ä½•åº”ç”¨åŠŸèƒ½ï¼Œæœªå®ç°ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä»…ä¿è¯å…¶ä½™ä»£ç çš„æ­£ç¡®æ“ä½œï¼Œå› æ­¤è¿™ç”šè‡³æ›´å…·â€œå†’çŠ¯æ€§â€ã€‚ <br><br> æè®®å‘OSæ·»åŠ æ–°æ¦‚å¿µâ€œ futexâ€æ˜¯åŸºäºä¸€ä¸ªç®€å•çš„è§‚å¯Ÿç»“æœï¼šåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ•è·åŒæ­¥å¯¹è±¡çš„å°è¯•é¦–æ¬¡æˆåŠŸã€‚ ç¨‹åºå‘˜ä»¥è¿™æ ·ä¸€ç§æ–¹å¼æ¥ç¼–å†™è½¯ä»¶ï¼šä»é”å®šé”åˆ°è§£é”ï¼Œæ‰€éœ€çš„æ—¶é—´å°½å¯èƒ½çŸ­ï¼Œè¿™æ„å‘³ç€æ•è·å¦ä¸€ä¸ªçº¿ç¨‹çš„å°è¯•ä¸ä¼šé‡åˆ°éšœç¢çš„å¯èƒ½æ€§å¾ˆé«˜ã€‚ å½“æµåˆ°è¾¾è¿™æ ·çš„â€œè‡ªç”±â€åŒæ­¥å¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ•è·å®ƒè€Œæ— éœ€ä½¿ç”¨ç›¸å¯¹ä¾¿å®œçš„åŸå­æ“ä½œè¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚ åŸå­æ“ä½œæˆåŠŸè¿›è¡Œçš„å¯èƒ½æ€§å¾ˆå¤§ã€‚ <br><br> åœ¨é‚£ç§ç½•è§çš„æƒ…å†µä¸‹ï¼Œå½“æˆ‘ä»¬ä»ç„¶å°è¯•è®¿é—®è¢«å¦ä¸€ä¸ªçº¿ç¨‹é˜»å¡çš„èµ„æºæ—¶ï¼ŒåŸå­æ“ä½œå°†è¿”å›é”™è¯¯ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªé€‰æ‹©ã€‚ æˆ‘ä»¬å¯ä»¥æ—‹è½¬ç”¨æˆ·æ¨¡å¼çš„è‡ªæ—‹é”ï¼Œç­‰å¾…èµ„æºçš„é‡Šæ”¾ï¼ˆè¿™å°†æ¶ˆè€—CPUèµ„æºï¼‰ï¼Œæˆ–è€…è®©å†…æ ¸è¿›å…¥ç¡çœ æ¨¡å¼ï¼Œç­‰å¾…èµ„æºçš„é‡Šæ”¾ã€‚ è¿™æ˜¯futexè¿›å…¥åœºæ™¯çš„åœ°æ–¹ã€‚ <br><br><h3> ç®€å•ä½¿ç”¨futexes-æœŸæœ›å’Œå”¤é†’ </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">futexç³»ç»Ÿè°ƒç”¨</a>ç»“åˆäº†å¤šç§åŠŸèƒ½ã€‚ æˆ‘ä»¬åœ¨è¿™é‡Œä¸è€ƒè™‘å¤æ‚çš„é€‰é¡¹ï¼ˆå…¶ä¸­ä¸€äº›é€‰é¡¹å¤ªå¤æ‚ï¼Œç”šè‡³åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿæ²¡æœ‰æè¿°ï¼‰ï¼Œè€Œæ˜¯é›†ä¸­åœ¨FUTEX_WAITå’ŒFUTEX_WAKEæ“ä½œä¸Šã€‚ å®˜æ–¹æ–‡æ¡£ä¸­çš„æè¿°å°†ä¸ºæ‚¨æä¾›è‰¯å¥½çš„åŸºç¡€ï¼š <br><blockquote>  futexï¼ˆï¼‰ç³»ç»Ÿè°ƒç”¨ä¸ºç¨‹åºæä¾›äº†ä¸€ç§ç­‰å¾…ç‰¹å®šæ¡ä»¶å˜ä¸ºçœŸçš„æ–¹æ³•ã€‚ é€šå¸¸ï¼Œæ­¤ç³»ç»Ÿè°ƒç”¨åœ¨å…±äº«å†…å­˜åŒæ­¥çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨é˜»å¡æ„é€ ã€‚ ä½¿ç”¨futexæ—¶ï¼Œä¸»è¦åŒæ­¥æ“ä½œåœ¨ç”¨æˆ·ç©ºé—´ä¸­æ‰§è¡Œã€‚ ç”¨æˆ·ç©ºé—´ç¨‹åºä»…åœ¨ç¨‹åºéœ€è¦é•¿æ—¶é—´è¿›å…¥å¾…æœºæ¨¡å¼ç›´åˆ°æ¡ä»¶å˜ä¸ºçœŸæ—¶æ‰æ‰§è¡Œfutexï¼ˆï¼‰ç³»ç»Ÿè°ƒç”¨ã€‚ å¦å¤–ï¼Œfutexï¼ˆï¼‰å¯ç”¨äºå”¤é†’éœ€è¦ç‰¹å®šæ¡ä»¶çš„è¿›ç¨‹æˆ–çº¿ç¨‹ã€‚ </blockquote> ç®€è€Œè¨€ä¹‹ï¼Œfutexæ˜¯ä¸€ç§å†…æ ¸æ„é€ ï¼Œå¯åœ¨å‘ç”ŸæŸäº›æƒ…å†µæ—¶å¸®åŠ©ç”¨æˆ·ä»£ç åŒæ­¥çº¿ç¨‹ã€‚ ä¸€äº›è¿›ç¨‹ï¼ˆæˆ–çº¿ç¨‹ï¼‰å¯ä»¥ç­‰å¾…FUTEX_WAITè°ƒç”¨ä¸­çš„äº‹ä»¶ï¼Œè€Œå…¶ä»–è¿›ç¨‹ï¼ˆæˆ–çº¿ç¨‹ï¼‰å¯ä»¥ä½¿ç”¨FUTEX_WAKEè°ƒç”¨è¿™äº›äº‹ä»¶ã€‚ ç­‰å¾…æœ‰æ•ˆåœ°è¿›è¡Œ-ç­‰å¾…çº¿ç¨‹è¢«å†…æ ¸æŒ‚èµ·ï¼Œå¹¶ä¸”ä¸ä½¿ç”¨å¤„ç†å™¨èµ„æºï¼Œç›´åˆ°å‘ç”Ÿé¢„æœŸäº‹ä»¶æ—¶å°†å®ƒä»¬å”¤é†’ã€‚ <br><br> èŠ±æ—¶é—´é˜…è¯»æ•´ä¸ªæ–‡æ¡£ã€‚ å¥½å§ï¼Œæˆ–è€…è‡³å°‘é˜…è¯»æœ‰å…³FUTEX_WAITå’ŒFUTEX_WAKEçš„éƒ¨åˆ†ã€‚ <br><br> è®©æˆ‘ä»¬çœ‹ä¸€ä¸ª<a href="">ç®€å•çš„ç¤ºä¾‹</a> ï¼Œè¯¥<a href="">ç¤ºä¾‹</a>æ¼”ç¤ºäº†ä½¿ç”¨futexæ¥åè°ƒä¸¤ä¸ªæµç¨‹çš„å·¥ä½œçš„åŸºæœ¬ç”¨æ³•ã€‚ <br><br> å­è¿›ç¨‹ï¼š <br><br><ol><li> åœ¨é€šç”¨å†…å­˜æ’æ§½ä¸­ç­‰å¾…0xA </li><li> å°†å€¼0xBå†™å…¥æ­¤æ’æ§½ </li></ol><br> çˆ¶è¿›ç¨‹æ­¤æ—¶ï¼š <br><br><ol><li> å°†0xAå€¼å†™å…¥å…±äº«å†…å­˜æ’æ§½ </li><li> ç­‰å¾…0xBå‡ºç°åœ¨å…¶ä¸­ </li></ol><br> ä¸¤ä¸ªè¿‡ç¨‹ä¹‹é—´çš„è¿™ç§â€œæ¡æ‰‹â€ã€‚ è¿™æ˜¯ä»£ç ï¼š <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">** argv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> shm_id = shmget(IPC_PRIVATE, <span class="hljs-number"><span class="hljs-number">4096</span></span>, IPC_CREAT | <span class="hljs-number"><span class="hljs-number">0666</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shm_id &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { perror(<span class="hljs-string"><span class="hljs-string">"shmget"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>* shared_data = shmat(shm_id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); *shared_data = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> forkstatus = fork(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (forkstatus &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { perror(<span class="hljs-string"><span class="hljs-string">"fork"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (forkstatus == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//   printf("child waiting for A\n"); wait_on_futex_value(shared_data, 0xA); printf("child writing B\n"); //  0xB         *shared_data = 0xB; wake_futex_blocking(shared_data); } else { //   printf("parent writing A\n"); //  0xA         *shared_data = 0xA; wake_futex_blocking(shared_data); printf("parent waiting for B\n"); wait_on_futex_value(shared_data, 0xB); // Wait for the child to terminate. wait(NULL); shmdt(shared_data); } return 0; }</span></span></code> </pre> <br> æ³¨æ„POSIXè°ƒç”¨ä»¥åœ¨è¿›ç¨‹ä¹‹é—´åˆ†é…å…±äº«å†…å­˜ã€‚ æˆ‘ä»¬åœ¨è¿™é‡Œä¸èƒ½ä½¿ç”¨é€šå¸¸çš„å†…å­˜åˆ†é…ï¼Œå› ä¸ºå³ä½¿ä¸åŒè¿›ç¨‹ä¸­çš„æŒ‡é’ˆçš„ç›¸åŒåœ°å€å®é™…ä¸Šä¹Ÿä¼šæŒ‡å‘ä¸åŒçš„å†…å­˜å—ï¼ˆæ¯ä¸ªè¿›ç¨‹å”¯ä¸€ï¼‰ã€‚ <br><br> åº”å½“æ³¨æ„çš„æ˜¯ï¼Œè¯¥ç¤ºä¾‹ä¸è§„èŒƒæœ‰æ‰€ä¸åŒï¼Œå› ä¸ºfutexæœ€åˆæ˜¯ä¸ºäº†ç­‰å¾…ç‰¹å®šå«ä¹‰çš„æ›´æ”¹è€Œåˆ›å»ºçš„ï¼Œå³â€œä»æŸç‰©å˜ä¸ºæŸç‰©â€ï¼Œè€Œä¸æ˜¯â€œä»æŸç‰©å˜ä¸ºæŸç‰©â€ã€‚ ä¸ºäº†è¯´æ˜è¿™ç§å¯èƒ½æ€§ï¼Œæˆ‘ç»™å‡ºäº†è¿™ä¸ªç¤ºä¾‹ï¼Œä¸‹é¢æˆ‘ä»¬å°†è€ƒè™‘åŸºæœ¬ç‰ˆæœ¬ï¼ˆåœ¨è¯¥ç‰ˆæœ¬ä¸Šæˆ‘ä»¬å®ç°äº’æ–¥ä½“ï¼‰ã€‚ <br><br> è¿™æ˜¯wait_on_futex_valueå‡½æ•°ä»£ç ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wait_on_futex_value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">* futex_addr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> val)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> futex_rc = futex(futex_addr, FUTEX_WAIT, val, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (futex_rc == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errno != EAGAIN) { perror(<span class="hljs-string"><span class="hljs-string">"futex"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (futex_rc == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*futex_addr == val) { <span class="hljs-comment"><span class="hljs-comment">//    return; } } else { abort(); } } }</span></span></code> </pre> <br> è¯¥å‡½æ•°çš„ä¸»è¦ä»»åŠ¡ï¼ˆå®é™…ä¸Šæ˜¯futexç³»ç»Ÿè°ƒç”¨ä¹‹å¤–ï¼‰æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå½“æˆ‘ä»¬å”¤é†’falseï¼ˆå¯¹æˆ‘ä»¬ä¸æ„Ÿå…´è¶£ï¼‰æ—¶ï¼Œæˆ‘ä»¬å°†åœ¨è¯¥å¾ªç¯ä¸­è¿è¡Œã€‚ å¦‚æœåœ¨å…±äº«å†…å­˜æ’æ§½ä¸­å®‰è£…äº†æ–°å€¼ï¼Œä½†æˆ‘ä»¬æ²¡æœ‰æœŸæœ›ï¼Œåˆ™ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚ å¥½å§ï¼Œæˆ–è€…åœ¨å¦ä¸€ä¸ªè¿›ç¨‹æ¯”æˆ‘ä»¬çš„è¿›ç¨‹æ›´æ—©å”¤é†’çš„æƒ…å†µä¸‹ï¼ˆè¿™åœ¨æˆ‘ä»¬çš„ç‰¹å®šæƒ…å†µä¸‹ä¸ä¼šå‘ç”Ÿï¼Œä½†æ˜¯ä»¥æ›´ä¸€èˆ¬çš„æ–¹å¼æ˜¯å¯èƒ½çš„ï¼‰ã€‚ <br><br>  Futexè¯­ä¹‰éå¸¸æ£˜æ‰‹ï¼ å¦‚æœfutexåœ°å€å¤„çš„å€¼ä¸ç­‰äºä¼ é€’çš„å‚æ•°valï¼Œåˆ™FUTEX_WAITè°ƒç”¨å°†ç«‹å³è¿”å›ã€‚ åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œå¦‚æœå­è¿›ç¨‹å»ç­‰å¾…ï¼Œè€Œçˆ¶è¿›ç¨‹åœ¨æ’æ§½ä¸­å†™å…¥å€¼0xAï¼Œåˆ™å¯èƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œfutexè¿”å›å€¼EAGAINã€‚ <br><br> è¿™æ˜¯wake_futex_blockingå‡½æ•°ä»£ç ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wake_futex_blocking</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">* futex_addr)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> futex_rc = futex(futex_addr, FUTEX_WAKE, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (futex_rc == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { perror(<span class="hljs-string"><span class="hljs-string">"futex wake"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (futex_rc &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } } }</code> </pre> <br> è¿™æ˜¯FUTEX_WAKEçš„é˜»å¡åŒ…è£…å™¨ï¼Œæ— è®ºæœ‰å¤šå°‘ä¾¦å¬å™¨æœŸæœ›å®ƒï¼Œå®ƒéƒ½å°†å¿«é€Ÿè®¡ç®—å¹¶è¿”å›ä¸€ä¸ªå€¼ã€‚ åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œè¿™è¢«ç”¨ä½œâ€œæ¡æ‰‹â€çš„ä¸€éƒ¨åˆ†ï¼Œä½†å…¶ä»–ç”¨é€”ä¹Ÿæ˜¯å¯èƒ½çš„ã€‚ <br><br><h3>  Futexæ˜¯è‡ªå®šä¹‰ä»£ç çš„å†…æ ¸é˜Ÿåˆ—ã€‚ </h3><br> ç®€è€Œè¨€ä¹‹ï¼Œfutexæ˜¯å†…æ ¸é©±åŠ¨çš„é˜Ÿåˆ—ï¼Œç”¨äºè§£å†³è‡ªå®šä¹‰ä»£ç ä»»åŠ¡ã€‚ å®ƒå…è®¸ç”¨æˆ·ä»£ç è¯·æ±‚å†…æ ¸æŒ‚èµ·å…¶çº¿ç¨‹çš„æ‰§è¡Œç›´åˆ°äº‹ä»¶å‘ç”Ÿï¼Œå¹¶åŒæ—¶é€šçŸ¥å¦ä¸€ä¸ªçº¿ç¨‹è¯¥äº‹ä»¶å¹¶å”¤é†’æ‰€æœ‰ç­‰å¾…è¯¥äº‹ä»¶çš„çº¿ç¨‹ã€‚ å‰é¢æˆ‘ä»¬æåˆ°äº†åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹ç»„ç»‡è‡ªæ—‹é”çš„åŠŸèƒ½ï¼Œå¯ä»¥ç­‰å¾…æŸäº›æ¡ä»¶å¾—åˆ°æ»¡è¶³ã€‚ ä½†æ˜¯ï¼Œå†…æ ¸ä¸­çš„é˜Ÿåˆ—æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Œå› ä¸ºå®ƒä½¿æˆ‘ä»¬å…äºåœ¨ç­‰å¾…å¾ªç¯ä¸­æ‰§è¡Œçš„æ•°åäº¿æµªè´¹çš„å¤„ç†å™¨æŒ‡ä»¤ã€‚ <br><br> è¿™æ˜¯æœ‰å…³LWNçš„æ–‡ç« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">â€œ A Futexæ¦‚è¿°å’Œæ›´æ–°â€ä¸­</a>çš„å›¾è¡¨ï¼š <br><br><img src="https://habrastorage.org/getpro/habr/post_images/476/433/d4e/476433d4e5a9ba7dcd840a7fe5eb3d87.png" alt="å›¾ç‰‡"><br><br> åœ¨Linuxå†…æ ¸ä»£ç ä¸­ï¼Œfutexæ˜¯åœ¨kernel / futex.cæ–‡ä»¶ä¸­å®ç°çš„ã€‚ å†…æ ¸å­˜å‚¨ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå…¶ä¸­çš„é”®æ˜¯åœ°å€ï¼Œä»¥ä¾¿å¿«é€Ÿæ‰¾åˆ°æ‰€éœ€çš„é˜Ÿåˆ—å¹¶å°†è°ƒç”¨è¿‡ç¨‹æ·»åŠ åˆ°å…¶ä¸­ã€‚ å½“ç„¶ï¼Œä¸€åˆ‡éƒ½ä¸æ˜¯é‚£ä¹ˆç®€å•-æ¯•ç«Ÿï¼Œå†…æ ¸æœ¬èº«éœ€è¦åŒæ­¥å¯¹å†…éƒ¨æ•°æ®çš„è®¿é—®ï¼Œå¹¶æ”¯æŒfuteksovçš„å„ç§å…¶ä»–é€‰é¡¹ã€‚ <br><br><h3> é™æ—¶ç­‰å¾…FUTEX_WAIT </h3><br>  futexç³»ç»Ÿè°ƒç”¨å…·æœ‰è¶…æ—¶å‚æ•°ï¼Œè¯¥å‚æ•°å…è®¸ç”¨æˆ·æŒ‡å®šå‡†å¤‡ç­‰å¾…å¤šé•¿æ—¶é—´ã€‚ è¿™æ˜¯ä¸€ä¸ªå®ç°çš„å®Œæ•´<a href="">ç¤ºä¾‹</a> ï¼Œä½†è¿™æ˜¯å…³é”®éƒ¨åˆ†ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"child waiting for A\n"</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timespec</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timeout</span></span></span><span class="hljs-class"> = {</span></span>.tv_sec = <span class="hljs-number"><span class="hljs-number">0</span></span>, .tv_nsec = <span class="hljs-number"><span class="hljs-number">500000000</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> t1 = time_ns(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> futex_rc = futex(shared_data, FUTEX_WAIT, <span class="hljs-number"><span class="hljs-number">0xA</span></span>, &amp;timeout, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"child woken up rc=%d errno=%s, elapsed=%llu\n"</span></span>, futex_rc, futex_rc ? strerror(errno) : <span class="hljs-string"><span class="hljs-string">""</span></span>, time_ns() - t1); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (futex_rc == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; *shared_data == <span class="hljs-number"><span class="hljs-number">0xA</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre> <br> å¦‚æœç­‰å¾…è¢«å»¶è¿Ÿäº†500æ¯«ç§’ï¼Œé‚£ä¹ˆfutexå‡½æ•°å°†ç»“æŸï¼Œåœ¨å¾ªç¯çš„ä¸‹ä¸€ä¸ªè¿­ä»£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ­¤åšå‡ºååº”ï¼ˆåœ¨å±å¹•ä¸Šæ˜¾ç¤ºæŸäº›å†…å®¹ï¼Œå†™å…¥æ—¥å¿—ï¼Œç»§ç»­ç­‰å¾…æˆ–åœæ­¢ï¼‰ã€‚ <br><br><h3> ä½¿ç”¨futexå®ç°äº’æ–¥ </h3><br> æˆ‘ä»¬ä»ä»¥ä¸‹äº‹å®å¼€å§‹æœ¬æ–‡ï¼šfutexåœ¨å®ç°æ›´é«˜çº§åˆ«çš„åŒæ­¥å¯¹è±¡ä¸­å…·æœ‰å®é™…ç”¨é€”ã€‚ è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨å®ƒä»¬ï¼ˆä»¥åŠåŸå­ï¼‰æ¥å®ç°ç»å…¸çš„äº’æ–¥ä½“ã€‚ ä¸‹é¢çš„å®ç°åŸºäºUlrich Drepperæ’°å†™çš„æ–‡ç« â€œ Futexes are Trickyâ€ä¸­çš„ä»£ç ã€‚ <br><br> å¯¹äºæ­¤ç¤ºä¾‹ï¼Œæˆ‘ä½¿ç”¨C ++ï¼Œä¸»è¦æ˜¯ä¸ºäº†ä½¿ç”¨C ++ 11æ ‡å‡†ä¸­çš„åŸå­ã€‚ æ‚¨å¯ä»¥åœ¨<a href="">æ­¤å¤„</a>æ‰¾åˆ°å®Œæ•´çš„ä»£ç ï¼Œä½†æœ€é‡è¦çš„éƒ¨åˆ†æ˜¯ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mutex</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Mutex() : atom_(<span class="hljs-number"><span class="hljs-number">0</span></span>) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = cmpxchg(&amp;atom_, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">// If the lock was previously unlocked, there's nothing else for us to do. // Otherwise, we'll probably have to wait. if (c != 0) { do { // If the mutex is locked, we signal that we're waiting by setting the // atom to 2. A shortcut checks is it's 2 already and avoids the atomic // operation in this case. if (c == 2 || cmpxchg(&amp;atom_, 1, 2) != 0) { // Here we have to actually sleep, because the mutex is actually // locked. Note that it's not necessary to loop around this syscall; // a spurious wakeup will do no harm since we only exit the do...while // loop when atom_ is indeed 0. syscall(SYS_futex, (int*)&amp;atom_, FUTEX_WAIT, 2, 0, 0, 0); } // We're here when either: // (a) the mutex was in fact unlocked (by an intervening thread). // (b) we slept waiting for the atom and were awoken. // // So we try to lock the atom again. We set teh state to 2 because we // can't be certain there's no other thread at this exact point. So we // prefer to err on the safe side. } while ((c = cmpxchg(&amp;atom_, 0, 2)) != 0); } } void unlock() { if (atom_.fetch_sub(1) != 1) { atom_.store(0); syscall(SYS_futex, (int*)&amp;atom_, FUTEX_WAKE, 1, 0, 0, 0); } } private: // 0 means unlocked // 1 means locked, no waiters // 2 means locked, there are waiters in lock() std::atomic&lt;int&gt; atom_; };</span></span></code> </pre><br> åœ¨æ­¤ä»£ç ä¸­ï¼Œcmpxhgå‡½æ•°æ˜¯ä¸€ä¸ªç®€å•çš„åŒ…è£…å™¨ï¼Œå¯æ›´æ–¹ä¾¿åœ°ä½¿ç”¨åŸå­ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// An atomic_compare_exchange wrapper with semantics expected by the paper's // mutex - return the old value stored in the atom. int cmpxchg(std::atomic&lt;int&gt;* atom, int expected, int desired) { int* ep = &amp;expected; std::atomic_compare_exchange_strong(atom, ep, desired); return *ep; }</span></span></code> </pre> <br> æ­¤ä»£ç ç¤ºä¾‹åŒ…å«è®¸å¤šè§£é‡Šå…¶æ“ä½œé€»è¾‘çš„æ³¨é‡Šã€‚ è¿™ä¸ä¼šé€ æˆä¼¤å®³ï¼Œå› ä¸ºå­˜åœ¨å¾ˆå¤§çš„é£é™©ï¼Œæ‚¨å¯èƒ½ä¼šæƒ³è¦ç¼–å†™ä¸€ä¸ªç¨å¾®ç®€å•ä½†å®Œå…¨ä¸æ­£ç¡®çš„ç‰ˆæœ¬ã€‚ è‡³äºæ­¤ä»£ç -å¹¶ä¸æ˜¯æ‰€æœ‰ä»£ç éƒ½å®Œç¾ã€‚ ä¾‹å¦‚ï¼Œä»–å°è¯•å¯¹std :: atomicç±»å‹çš„å†…éƒ¨è®¾å¤‡è¿›è¡Œå‡è®¾ï¼Œå°†å…¶å†…å®¹è½¬æ¢ä¸ºint *ï¼Œä»¥ä¼ é€’ç»™futexè°ƒç”¨ã€‚ é€šå¸¸æƒ…å†µå¹¶éå¦‚æ­¤ã€‚ è¯¥ä»£ç å¯ä»¥åœ¨Linux x64ä¸Šç¼–è¯‘å¹¶è¿è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½ä¿è¯ä¸å…¶ä»–å¹³å°çš„å…¼å®¹æ€§ã€‚ ä¸ºäº†è·å¾—å®ƒï¼Œæˆ‘ä»¬éœ€è¦ä¸ºåŸå­æ·»åŠ ä¸€ä¸ªå¹³å°ä¾èµ–å±‚ã€‚ ç”±äºè¿™ä¸æ˜¯æœ¬æ–‡çš„ä¸»é¢˜ï¼ˆå¹¶ä¸”å› ä¸ºæ‚¨ä¸å¤ªå¯èƒ½åœ¨åŒä¸€ä¸ªC ++æ¨¡å—ä¸­æ··åˆä½¿ç”¨futexï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å°†çœç•¥æ­¤å®ç°ã€‚ è¿™åªæ˜¯ä¸€ä¸ªç¤ºèŒƒï¼ <br><br><h3>  Glibcäº’æ–¥é”å’Œä½çº§é” </h3><br> å› æ­¤ï¼Œæˆ‘ä»¬åˆ°äº†glibcå®ç°POSIXçº¿ç¨‹çš„åœ°æ­¥ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†æ˜¯pthread_mutex_tç±»å‹ã€‚ æ­£å¦‚æˆ‘åœ¨æœ¬æ–‡å¼€å¤´æ‰€è¯´çš„é‚£æ ·ï¼Œfutexå¹¶ä¸æ˜¯æ™®é€šå¼€å‘äººå‘˜æ‰€éœ€è¦çš„ã€‚ å®ƒä»¬ç”±è¿è¡Œæ—¶åº“æˆ–éå¸¸ä¸“é—¨ç”¨äºå®ç°æ›´é«˜çº§åˆ«çš„åŒæ­¥åŸè¯­çš„ä¸œè¥¿ä½¿ç”¨ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒæŸ¥çœ‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">NPTL</a>äº’æ–¥é”çš„å®ç°å¾ˆæœ‰è¶£ã€‚ åœ¨glibcä»£ç ä¸­ï¼Œè¿™æ˜¯nptl / pthread_mutex_lock.cæ–‡ä»¶ã€‚ <br><br> ç”±äºéœ€è¦æ”¯æŒå„ç§ç±»å‹çš„äº’æ–¥é”ï¼Œå› æ­¤ä»£ç éå¸¸å¤æ‚ï¼Œä½†æ˜¯å¦‚æœéœ€è¦ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°éå¸¸ç†Ÿæ‚‰çš„å—ã€‚ æ‚¨è¿˜å¯ä»¥æŸ¥çœ‹sysdeps / unix / sysv / linux / x86_64 / lowlevellock.hå’Œnptl / lowlevellock.cæ–‡ä»¶ã€‚ è¯¥ä»£ç æœ‰äº›æ··ä¹±ï¼Œä½†æ˜¯æ¯”è¾ƒäº¤æ¢å’Œfutexè°ƒç”¨çš„ç»„åˆä»ç„¶å¾ˆå®¹æ˜“ã€‚ <br><br> æ‚¨åº”è¯¥å·²ç»å¾ˆå¥½åœ°ç†è§£äº†systeds /nptl/lowlevellock.hæ–‡ä»¶çš„åˆå§‹æ³¨é‡Šï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Low-level locks use a combination of atomic operations (to acquire and release lock ownership) and futex operations (to block until the state of a lock changes). A lock can be in one of three states: 0: not acquired, 1: acquired with no waiters; no other threads are blocked or about to block for changes to the lock state, &gt;1: acquired, possibly with waiters; there may be other threads blocked or about to block for changes to the lock state. We expect that the common case is an uncontended lock, so we just need to transition the lock between states 0 and 1; releasing the lock does not need to wake any other blocked threads. If the lock is contended and a thread decides to block using a futex operation, then this thread needs to first change the state to &gt;1; if this state is observed during lock release, the releasing thread will wake one of the potentially blocked threads. .. */</span></span></code> </pre> <br><h3> å»è¿è¡Œæ—¶futexes </h3><br>  Rantime Goä¸ä½¿ç”¨libcï¼ˆåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼‰ã€‚ å› æ­¤ï¼Œå®ƒä¸èƒ½ä¾èµ–POSIXçº¿ç¨‹çš„å®ç°ã€‚ è€Œæ˜¯ç›´æ¥è°ƒç”¨è¾ƒä½çº§åˆ«çš„ç³»ç»Ÿè°ƒç”¨ã€‚ è¿™ä½¿å…¶æˆä¸ºä½¿ç”¨futexçš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚ ç”±äºæ— æ³•è°ƒç”¨pthread_mutex_tï¼Œå› æ­¤å¿…é¡»ç¼–å†™è‡ªå·±çš„æ›¿ä»£æ–‡ä»¶ã€‚ è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬ä»å¯¹ç”¨æˆ·å¯è§çš„sync.Mutexç±»å‹å¼€å§‹ï¼ˆåœ¨src / sync / mutex.goä¸­ï¼‰ã€‚ <br><br> è¿™ç§ç±»å‹çš„Lockæ–¹æ³•å°è¯•ä½¿ç”¨åŸå­äº¤æ¢æ“ä½œæ¥å¿«é€Ÿæ•è·é”ã€‚ å¦‚æœäº‹å®è¯æ˜æ‚¨éœ€è¦ç­‰å¾…ï¼Œå®ƒå°†è°ƒç”¨runtime_SemacquireMutexï¼Œåè€…å°†è°ƒç”¨runtime.lockã€‚ è¯¥å‡½æ•°åœ¨src / runtime / lock_futex.goä¸­å®šä¹‰ï¼Œå®ƒå£°æ˜äº†æ‚¨å¯èƒ½ç†Ÿæ‚‰çš„å‡ ä¸ªå¸¸é‡ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ( mutex_unlocked = <span class="hljs-number"><span class="hljs-number">0</span></span> mutex_locked = <span class="hljs-number"><span class="hljs-number">1</span></span> mutex_sleeping = <span class="hljs-number"><span class="hljs-number">2</span></span> ... ) <span class="hljs-comment"><span class="hljs-comment">// Possible lock states are mutex_unlocked, mutex_locked and mutex_sleeping. // mutex_sleeping means that there is presumably at least one sleeping thread.</span></span></code> </pre><br>  runtime.lockè¿˜è¯•å›¾ä½¿ç”¨åŸå­å‡½æ•°æ¥æ•è·é”ã€‚ è¿™æ˜¯æœ‰é“ç†çš„ï¼Œå› ä¸ºåœ¨Goè¿è¡Œæ—¶çš„è®¸å¤šåœ°æ–¹éƒ½è°ƒç”¨äº†runtime.lockï¼Œä½†æ˜¯åœ¨æˆ‘çœ‹æ¥ï¼Œé€šè¿‡ä»Mutex.lockè°ƒç”¨runtime.lockæ—¶åˆ é™¤åŸå­å‡½æ•°çš„ä¸¤ä¸ªè¿ç»­è°ƒç”¨ï¼Œå¯ä»¥é€šè¿‡æŸç§æ–¹å¼ä¼˜åŒ–ä»£ç ã€‚ <br><br> å¦‚æœäº‹å®è¯æ˜æ‚¨éœ€è¦ç­‰å¾…ï¼Œåˆ™ä¼šè°ƒç”¨ä¸å¹³å°ç›¸å…³çš„å‡½æ•°futexsleepï¼Œè¯¥å‡½æ•°åœ¨src / runtime / os_linux.goæ–‡ä»¶ä¸­ä¸ºLinuxå®šä¹‰ã€‚ è¯¥å‡½æ•°ä½¿ç”¨ä»£ç FUTEX_WAIT_PRIVATEè¿›è¡Œfutexç³»ç»Ÿè°ƒç”¨ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™æ˜¯åˆé€‚çš„ï¼Œå› ä¸ºGoè¿è¡Œæ—¶ä½äºä¸€ä¸ªè¿›ç¨‹ä¸­ï¼‰ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN418705/">https://habr.com/ru/post/zh-CN418705/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN418691/index.html">ç‰§åœºä¸»ï¼š5åˆ†é’Ÿå†…ä½¿ç”¨è£¸æœºè¿›è¡ŒKubernetes</a></li>
<li><a href="../zh-CN418693/index.html">ä¸ºä»€ä¹ˆå¹¸ç¦å¾ˆéš¾åœ¨å¤§è„‘ä¸­å‘ç°</a></li>
<li><a href="../zh-CN418695/index.html">åç›—ç‰ˆæˆ˜äº‰-å¸å›½åå‡»</a></li>
<li><a href="../zh-CN418699/index.html">åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿå™¨è¡—æœºã€‚ ç¬¬ä¸‰éƒ¨åˆ†</a></li>
<li><a href="../zh-CN418701/index.html">æˆ‘ä»¬ç ”ç©¶ä¿„è¯­çš„è¯­æ³•åˆ†æå™¨</a></li>
<li><a href="../zh-CN418707/index.html">KDispatcher-è½»å·§æ–¹ä¾¿çš„æ—¥å¸¸äº‹ä»¶æ€»çº¿</a></li>
<li><a href="../zh-CN418709/index.html">éœ€è¦å¼ºè¿«è‡ªå·±ï¼šé©±åŠ¨ç¨‹åºå’Œç•Œé¢éšœç¢</a></li>
<li><a href="../zh-CN418711/index.html">ä»¤ç‰Œç®¡ç†å¯„å­˜å™¨1.0</a></li>
<li><a href="../zh-CN418713/index.html">æ”¹å–„ç»´åŸºç™¾ç§‘è´¨é‡çš„æ¸¸æˆ</a></li>
<li><a href="../zh-CN418715/index.html">procfsè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„æ•ˆç‡å¦‚ä½•ï¼Œå¹¶ä¸”æœ‰å¯èƒ½å¯¹å…¶è¿›è¡Œä¼˜åŒ–</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>