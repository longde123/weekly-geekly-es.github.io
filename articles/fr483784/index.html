<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úñÔ∏è ü§ï üò∏ Comment faire une application multi-locataire √† partir d'une application non-locataire üëäüèº üï∫üèø üí¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je ne donnerai pas une d√©finition de la multi-location, ils ont d√©j√† √©crit √† ce sujet plusieurs fois ici et ici . Et il vaut mieux aller directement a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment faire une application multi-locataire √† partir d'une application non-locataire</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/directum/blog/483784/"><p><img src="https://habrastorage.org/webt/-8/wa/hf/-8wahfnvtijn8bqkeopcgo0an1g.png" alt="image"></p><br><p>  Je ne donnerai pas une d√©finition de la multi-location, ils ont d√©j√† √©crit √† ce sujet plusieurs fois <a href="https://habr.com/ru/company/microsoft/blog/145027/">ici</a> et <a href="https://habr.com/ru/company/1c/blog/326654/">ici</a> .  Et il vaut mieux aller directement au sujet de l'article et commencer par les questions suivantes: </p><br><h2 id="pochemu-prilozhenie-ne-delayut-srazu-multitenantnym">  Pourquoi l'application n'est-elle pas imm√©diatement multi-locataire? </h2><br><p>  Il arrive que l'application soit initialement d√©velopp√©e pour une installation uniquement c√¥t√© client.  Vous pouvez appeler une telle application en bo√Æte ou un <i>logiciel en tant que produit</i> .  Un client ach√®te une box et d√©ploie l'application sur ses serveurs (il existe de nombreux exemples de telles applications). </p><br><p>  Mais au fil du temps, la soci√©t√© de d√©veloppement peut penser qu'il serait bien de placer l'application dans le cloud pour qu'elle soit lou√©e (logiciel en tant que service).  Cette m√©thode de d√©ploiement pr√©sente des avantages tant pour les clients que pour l'entreprise de d√©veloppement.  Les clients peuvent obtenir rapidement un syst√®me fonctionnel et ne pas se soucier du d√©ploiement et de l'administration.  Lors de la location d'une application, vous n'avez pas besoin de gros investissements ponctuels. </p><br><p>  Et la soci√©t√© de d√©veloppement recevra de nouveaux clients, ainsi que de nouvelles t√¢ches: d√©ploiement de l'application dans le cloud, administration, mise √† jour vers de nouvelles versions, migration des donn√©es lors de la mise √† jour, sauvegarde des donn√©es, surveillance de la vitesse et des erreurs, correction des probl√®mes s'ils se produisent. </p><a name="habracut"></a><br><h2 id="pochemu-prilozhenie-v-oblake-dolzhno-byt-multitenantnym">  Pourquoi l'application dans le cloud devrait-elle √™tre multi-locataire? </h2><br><p>  Pour placer une application dans le cloud, il n'est pas n√©cessaire de la rendre multi-locataire.  Mais il y aura ensuite le probl√®me suivant: pour chaque client, vous devrez d√©ployer un stand d√©di√© dans le cloud avec l'application lou√©e, et cela est d√©j√† co√ªteux, √† la fois en termes de consommation des ressources du stand cloud et en termes d'administration.  Il est plus rentable d'impl√©menter l'h√©bergement multiclient dans l'application afin qu'une seule instance puisse servir plusieurs clients (organisations). </p><br><p>  Si l'application attire simultan√©ment 1 000 utilisateurs actifs, il est avantageux de regrouper les clients (organisations) afin qu'au total, ils donnent la charge souhait√©e de 1 000 utilisateurs par instance d'application.  Et puis, il y aura la consommation la plus optimale de ressources cloud. </p><br><p>  Supposons que l'application est lou√©e par une organisation pour 20 utilisateurs (employ√©s de l'organisation).  Ensuite, vous devez regrouper 50 de ces organisations afin d'atteindre la bonne charge.  Il est important d'isoler les organisations les unes des autres.  Une organisation loue une application, autorise uniquement ses employ√©s √† y acc√©der, stocke uniquement ses donn√©es et ne voit pas que d'autres organisations sont √©galement desservies par la m√™me application. </p><br><p>  L'impl√©mentation de l'h√©bergement multiclient ne signifie pas que l'application ne peut plus √™tre d√©ploy√©e localement sur le serveur de l'organisation.  Vous pouvez prendre en charge deux m√©thodes de d√©ploiement en m√™me temps: </p><br><ul><li>  application multi-locataire dans le cloud; </li><li>  application √† locataire unique sur le serveur client. </li></ul><br><p>  Notre application est venue d'une mani√®re similaire: de non-locataire √† multi-locataire.  Et dans cet article, je vais partager quelques approches dans le d√©veloppement de la multi-location. </p><br><h2 id="kak-realizovat-multitenantnost-v-prilozhenii-kotoroe-sproektirovano-kak-ne-tenantnoe">  Comment impl√©menter l'h√©bergement multiclient dans une application con√ßue comme non locataire? </h2><br><p>  Nous limiterons imm√©diatement le sujet, nous ne consid√©rerons que le d√©veloppement, nous n'aborderons pas les probl√®mes de test, de version, de d√©ploiement et d'administration.  Dans tous ces domaines, l'√©mergence de la multi-location doit √©galement √™tre prise en compte, mais pour l'instant nous ne parlerons que de d√©veloppement. </p><br><p>  Pour comprendre ce qu'est une application qui n'√©tait pas locataire et est devenue multi-locataire, je d√©crirai son objet, une liste des services et technologies utilis√©s. </p><br><p>  Il s'agit d'un syst√®me ECM (DirectumRX), compos√© de 10 services (5 services monolithiques et 5 microservices).  Tous ces services peuvent √™tre plac√©s soit sur un serveur puissant, soit sur plusieurs serveurs. </p><br><div class="spoiler">  <b class="spoiler_title">Les services sont</b> <div class="spoiler_text"><ul><li>  Service Web - pour l'entretien des clients Web (navigateurs). </li><li>  Service WCF - pour la maintenance des clients de bureau (applications WPF). </li><li>  Service pour applications mobiles. </li><li>  Service pour effectuer des processus d'arri√®re-plan. </li><li>  Service de planification des processus d'arri√®re-plan. </li><li>  Service d'ex√©cution de sch√©ma de workflow </li><li>  Service d'ex√©cution de bloc de workflow </li><li>  Service de stockage de documents (donn√©es binaires). </li><li>  Service de conversion de documents en html (pr√©visualisation dans un navigateur). </li><li>  Service de stockage des r√©sultats de conversion en html </li></ul></div></div><br><p>  Pile de technologies utilis√©es: <br>  .NET + SQLServer / Postgres + NHibernate + IIS + RabbitMQ + Redis </p><br><p> Alors, que faire pour que les services deviennent multi-locataires?  Pour ce faire, vous devez affiner les m√©canismes suivants dans les services, √† savoir ajouter des connaissances sur les locataires √†: </p><br><ul><li>  stockage de donn√©es; </li><li>  ORM; </li><li>  mise en cache des donn√©es; </li><li>  traitement des demandes; </li><li>  traitement des messages de file d'attente; </li><li>  configuration; </li><li>  enregistrement; </li><li>  effectuer des t√¢ches d'arri√®re-plan; </li><li>  interaction avec des microservices; </li><li>  interaction avec le courtier de messages. </li></ul><br><p>  Dans le cas de notre candidature, c'√©taient les principaux endroits qui n√©cessitaient des am√©liorations.  Examinons-les s√©par√©ment. </p><br><h2 id="vybor-sposoba-hraneniya-dannyh">  Choisir une m√©thode de stockage des donn√©es </h2><br><p>  Lorsque vous lisez des articles sur l'h√©bergement multiclient, la toute premi√®re chose qu'ils trient est de savoir comment organiser le stockage des donn√©es.  En effet, ce point est important. </p><br><p>  Pour notre syst√®me ECM, le stockage principal est une base de donn√©es relationnelle, qui contient environ 100 tables.  Comment organiser le stockage des donn√©es de nombreuses organisations pour que l'organisation A ne voie en aucune fa√ßon les donn√©es de l'organisation B? </p><br><p>  Plusieurs sch√©mas sont connus (beaucoup a d√©j√† √©t√© √©crit sur ces sch√©mas): </p><br><ul><li>  cr√©er votre propre base de donn√©es pour chaque organisation (pour chaque locataire); </li><li>  utiliser une base de donn√©es pour toutes les organisations, mais pour chaque organisation cr√©er son propre sch√©ma dans la base de donn√©es; </li><li>  utilisez une base de donn√©es pour toutes les organisations, mais ajoutez une colonne "cl√© de locataire / d'organisation" dans chaque table. </li></ul><br><p>  Le choix du sch√©ma n'est pas accidentel.  Dans notre cas, il suffit de consid√©rer les cas d'administration syst√®me pour comprendre l'option pr√©f√©r√©e.  Les cas sont les suivants: </p><br><ul><li>  ajouter un locataire (une nouvelle organisation loue un syst√®me); </li><li>  retirer le locataire (l'organisation a refus√© de louer); </li><li>  transf√©rer le locataire vers un autre stand cloud (redistribuer la charge entre les stands cloud quand un stand cesse de faire face √† la charge). </li></ul><br><p>  Prenons un cas de transfert de locataire.  La t√¢che principale du transfert est de transf√©rer les donn√©es de l'organisation vers un autre stand.  Le transfert n'est pas difficile √† faire si le locataire a sa propre base de donn√©es, mais ce sera un casse-t√™te si vous m√©langez les donn√©es de diff√©rentes organisations dans 100 tables.  Essayez d'extraire uniquement les donn√©es n√©cessaires des tables, transf√©rez-les dans une autre base de donn√©es, o√π il y a d√©j√† des donn√©es d'autres locataires, et afin que leurs identifiants ne se croisent pas. </p><br><p>  Le cas suivant est l'ajout d'un nouveau locataire.  Le cas n'est pas non plus simple.  L'ajout de locataire est la n√©cessit√© de remplir les r√©pertoires syst√®me, les utilisateurs, les droits, afin que vous puissiez vous connecter au syst√®me.  Cette t√¢che est mieux r√©solue en clonant une base de donn√©es de r√©f√©rence, qui contient d√©j√† tout ce dont vous avez besoin. </p><br><p>  Le cas de suppression du locataire est tr√®s facilement r√©solu en d√©sactivant la base de donn√©es des locataires. </p><br><p>  Pour ces raisons, nous avons choisi un sch√©ma: <strong>un locataire - une base de donn√©es</strong> . </p><br><h2 id="orm">  ORM </h2><br><p>  Nous avons choisi la m√©thode de stockage des donn√©es, la question suivante: comment apprendre √† l'ORM √† travailler avec le sch√©ma s√©lectionn√©? </p><br><p>  Nous utilisons Nhibernate.  Il √©tait n√©cessaire que Nhibernate fonctionne avec plusieurs bases de donn√©es et passe p√©riodiquement √† la bonne, par exemple, en fonction de la requ√™te http.  Si nous traitons la demande de l'organisation A, alors la base de donn√©es A a √©t√© utilis√©e, et si la demande provient de l'organisation B, alors la base de donn√©es B. </p><br><p>  NHibernate a une telle opportunit√©.  Vous devez remplacer l'impl√©mentation de <em>NHibernate.Connection.DriverConnectionProvider</em> .  Chaque fois que NHibernate veut ouvrir une connexion √† une base de donn√©es, il appelle <em>DriverConnectionProvider</em> pour obtenir une cha√Æne de connexion.  Ici, nous allons le remplacer par le n√©cessaire: </p><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyDriverConnectionProvider</span></span> : <span class="hljs-title"><span class="hljs-title">DriverConnectionProvider</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConnectionString =&gt; TenantRegistry.Instance.CurrentTenant.ConnectionString; }</code> </pre> <br><p>  Qu'est-ce que <em>TenantRegistry.Instance.CurrentTenant,</em> je le dirai un peu plus tard. </p><br><h2 id="keshirovanie-dannyh">  Mise en cache des donn√©es </h2><br><p>  Les services mettent souvent en cache les donn√©es afin de minimiser les requ√™tes de base de donn√©es ou de ne pas calculer la m√™me chose plusieurs fois.  Le probl√®me est que les caches doivent √™tre d√©compos√©s par les locataires si les donn√©es des locataires sont mises en cache.  Il n'est pas acceptable que le cache de donn√©es d'une organisation soit utilis√© lors du traitement d'une demande d'une autre organisation.  La solution la plus simple consiste √† ajouter un identifiant de locataire √† la cl√© de chaque cache: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tenantCacheKey = cacheKey + TenantRegistry.Instance.CurrentTenant.Id;</code> </pre> <br><p>  Ce probl√®me doit √™tre rappel√© lors de la cr√©ation de chaque cache.  Il y a beaucoup de caches dans nos services.  Afin de ne pas oublier de prendre en compte l'identifiant du locataire dans chacun, il est pr√©f√©rable d'unifier le travail avec les caches.  Par exemple, cr√©ez un m√©canisme de mise en cache g√©n√©ral qui mettra en cache hors de la bo√Æte dans le contexte des locataires. </p><br><h2 id="logirovanie">  Journalisation </h2><br><p>  T√¥t ou tard, quelque chose ira mal dans le syst√®me, vous devrez ouvrir le fichier journal et commencer √† l'√©tudier.  La premi√®re question est: au nom de quel utilisateur et de quelle organisation ces actions ont-elles √©t√© engag√©es? </p><br><p>  C'est pratique lorsque dans chaque ligne du journal il y a un identifiant de locataire et un nom d'utilisateur de locataire.  Ces informations deviennent aussi n√©cessaires que, par exemple, l'heure du message: </p><br><pre> <code class="plaintext hljs">2019-05-24 17:05:27.985 &lt;message&gt; [User2 :Tenant1] 2019-05-24 17:05:28.126 &lt;message&gt; [User3 :Tenant2] 2019-05-24 17:05:28.173 &lt;message&gt; [User4 :Tenant3]</code> </pre> <br><p>  Le d√©veloppeur ne doit pas penser au locataire √† √©crire dans le journal, il doit √™tre automatis√©, cach√© "sous le capot" du syst√®me de journalisation. </p><br><p>  Nous utilisons NLog, je vais donc vous donner un exemple.  La fa√ßon la plus simple de s√©curiser l'identifiant du locataire est de cr√©er <em>NLog.LayoutRenderers.LayoutRenderer</em> , qui vous permet d'obtenir l'identifiant du locataire pour chaque entr√©e de journal: </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">LayoutRenderer(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"tenant"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TenantLayoutRenderer</span></span> : <span class="hljs-title"><span class="hljs-title">LayoutRenderer</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Append</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StringBuilder builder, LogEventInfo logEvent</span></span></span><span class="hljs-function">)</span></span> { builder.Append(TenantRegistry.Instance.CurrentTenant.Id); } }</code> </pre> <br><p>  Et puis utilisez ce LayoutRenderer dans le mod√®le de journal: </p><br><pre> <code class="plaintext hljs">&lt;target layout="${odate} ${message} [${user} :${tenant}]"/&gt;</code> </pre> <br><h2 id="vypolnenie-koda">  Ex√©cution de code </h2><br><p>  Dans les exemples ci-dessus, j'ai souvent utilis√© le code suivant: </p><br><pre> <code class="cs hljs">TenantRegistry.Instance.CurrentTenant</code> </pre> <br><p>  Il est temps de dire ce que cela signifie.  Mais vous devez d'abord comprendre l'approche que nous suivons dans les services: </p><br><blockquote>  Toute ex√©cution de code (traitement d'une demande http, traitement d'un message de file d'attente, ex√©cution d'une t√¢che en arri√®re-plan dans un thread s√©par√©) doit √™tre associ√©e √† un locataire. </blockquote><p>  Cela signifie qu'√† n'importe quel endroit de l'ex√©cution du code, on peut demander: "Pour quel locataire ce thread fonctionne-t-il?"  ou d'une autre mani√®re, "Quel est le locataire actuel?" </p><br><p>  <em>TenantRegistry.Instance.CurrentTenant</em> est le locataire actuel pour le flux actuel.  Le flux et le locataire peuvent √™tre li√©s dans nos applications.  Ils sont connect√©s temporairement, par exemple, lors du traitement d'une demande http ou lors du traitement d'un message de la file d'attente.  Une fa√ßon de lier le locataire √† un flux se fait comme suit: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//    . using (TenantRegistry.Instance.SwitchTo(tenantId)) { // ,     . var tenant = TenantRegistry.Instance.CurrentTenant; //     . var connectionString = tenant.ConnectionString; //  . var id = tenant.Id; }</span></span></code> </pre> <br><p>  Un locataire li√© √† un thread peut √™tre obtenu n'importe o√π dans le code, en contactant <em>TenantRegistry</em> - il s'agit d'un singleton, un point d'acc√®s pour travailler avec les locataires.  Par cons√©quent, Nhibernate et NLog peuvent acc√©der √† ce singleton (aux points d'extension) pour trouver la cha√Æne de connexion ou l'identifiant du locataire. </p><br><h2 id="fonovye-zadachi">  T√¢ches d'arri√®re-plan </h2><br><p>  Les services ont souvent des t√¢ches d'arri√®re-plan qui doivent √™tre effectu√©es sur une minuterie.  Les t√¢ches en arri√®re-plan peuvent acc√©der √† la base de donn√©es de l'organisation, puis la t√¢che en arri√®re-plan doit √™tre effectu√©e pour chaque locataire.  Pour ce faire, il n'est pas n√©cessaire de d√©marrer un minuteur ou un thread distinct pour chaque locataire.  Il est possible d'effectuer une t√¢che dans diff√©rents locataires au sein d'un m√™me thread / timer.  Pour ce faire, dans le gestionnaire de minuteur, nous trions les locataires, associons chaque locataire √† un flux et effectuons une t√¢che en arri√®re-plan: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//    . foreach (var tenant in TenantRegistry.Instance.Tenants) { //    . using (TenantRegistry.Instance.SwitchTo(tenant.Id)) { //     . } }</span></span></code> </pre> <br><p>  Deux locataires ne peuvent pas √™tre attach√©s au flux en m√™me temps; si on en attache un, l'autre se d√©tache du flux.  Nous utilisons activement cette approche afin de ne pas produire de threads / timers pour les t√¢ches d'arri√®re-plan. </p><br><h2 id="kak-sootnesti-http-zapros-c-tenantom">  Comment corr√©ler une demande http avec un locataire </h2><br><p>  Pour traiter la demande http du client, vous devez savoir de quelle organisation il est issu.  Si l'utilisateur est d√©j√† authentifi√©, l'identifiant du locataire peut √™tre stock√© dans le cookie d'authentification (si le travail avec l'application est effectu√© via le navigateur) ou dans le jeton JWT.  Mais que se passe-t-il si l'utilisateur ne s'est pas encore authentifi√©?  Par exemple, un utilisateur anonyme a ouvert un site Web d'application et souhaite s'authentifier.  Pour ce faire, il envoie une demande avec un identifiant et un mot de passe.  Dans la base de donn√©es de quelle organisation rechercher cet utilisateur? </p><br><p>  En outre, des demandes anonymes seront re√ßues pour obtenir la page de connexion √† l'application, et cela peut diff√©rer pour diff√©rentes organisations, par exemple, la langue de localisation. </p><br><p>  Pour r√©soudre le probl√®me de corr√©lation des requ√™tes http anonymes et de l'organisation (locataire), nous utilisons des sous-domaines pour les organisations.  Le nom du sous-domaine est form√© par le nom de l'organisation.  Les utilisateurs doivent utiliser le sous-domaine pour travailler avec le syst√®me: </p><br><pre> <code class="plaintext hljs">https://company1.service.com https://company2.service.com</code> </pre> <br><p>  Le m√™me service Web multi-locataire est disponible √† ces adresses.  Mais maintenant, le service comprend de quelle organisation proviendra une demande http anonyme, en se concentrant sur le nom de domaine. <br>  La liaison du nom de domaine et du locataire est effectu√©e dans le fichier de configuration du service Web: </p><br><pre> <code class="json hljs">&lt;tenant name=<span class="hljs-string"><span class="hljs-string">"company1"</span></span> db=<span class="hljs-string"><span class="hljs-string">"database1"</span></span> host=<span class="hljs-string"><span class="hljs-string">"company1.service.com"</span></span> /&gt; &lt;tenant name=<span class="hljs-string"><span class="hljs-string">"company2"</span></span> db=<span class="hljs-string"><span class="hljs-string">"database2"</span></span> host=<span class="hljs-string"><span class="hljs-string">"company2.service.com"</span></span> /&gt;</code> </pre> <br><p>  La configuration des services sera d√©crite ci-dessous. </p><br><h2 id="mikroservisy-hranenie-dannyh">  Microservices.  Stockage de donn√©es </h2><br><p>  Quand j'ai dit que le syst√®me ECM avait besoin de 100 tables, j'ai parl√© de services monolithiques.  Mais il arrive qu'un microservice n√©cessite un stockage relationnel, dans lequel 2-3 tables sont n√©cessaires pour stocker ses donn√©es.  Id√©alement, chaque microservice poss√®de son propre stockage, auquel seul il a acc√®s.  Et le microservice d√©cide comment stocker les donn√©es dans le contexte des locataires. </p><br><p>  Mais nous sommes all√©s dans l'autre sens: nous avons d√©cid√© de stocker toutes les donn√©es de l'organisation dans une seule base de donn√©es.  Si un microservice n√©cessite un stockage relationnel, il utilise la base de donn√©es d'organisation existante afin que les donn√©es ne soient pas dispers√©es sur diff√©rents stockages, mais collect√©es dans une seule base de donn√©es.  Les services monolithiques utilisent la m√™me base de donn√©es. </p><br><p>  Les microservices fonctionnent uniquement avec leurs tables dans la base de donn√©es et n'essaient pas de travailler avec les tables d'un monolithe ou d'un autre microservice.  Il y a des avantages et des inconv√©nients √† cette approche. </p><br><p>  Avantages: </p><br><ul><li>  les donn√©es de l'organisation en un seul endroit; </li><li>  sauvegarde et restauration faciles des donn√©es de l'organisation; </li><li>  Dans la sauvegarde, les donn√©es de tous les services sont coh√©rentes. </li></ul><br><p>  Inconv√©nients: </p><br><ul><li>  une base de donn√©es pour tous les services est un goulot √©troit lors de la mise √† l'√©chelle (les besoins en ressources SGBD augmentent); </li><li>  les microservices ont un acc√®s physique aux tables des autres, mais n'utilisent pas cette fonctionnalit√©. </li></ul><br><h2 id="mikroservisy-znanie-o-tenantah-ne-vsegda-trebuetsya">  Microservices.  La connaissance des locataires n'est pas toujours requise. </h2><br><p>  Un microservice peut ne pas savoir qu'il fonctionne dans un environnement multi-locataire.  Consid√©rez l'un de nos services, qui est engag√© dans la conversion de documents en html. </p><br><p>  Ce que fait le service: </p><br><ol><li>  Prend un message d'une file d'attente RabbitMQ pour convertir un document. <br><ul><li>  r√©cup√®re l'identifiant du document et l'identifiant du locataire du message </li></ul></li><li>  T√©l√©chargez un document √† partir d'un service de stockage de documents. <br><ul><li>  pour cela g√©n√®re une requ√™te dans laquelle il transmet l'identifiant du document et l'identifiant du locataire </li></ul></li><li>  Convertit un document en html. </li><li>  Donne du HTML au service pour stocker les r√©sultats de conversion. </li></ol><br><p>  Le service ne stocke pas de documents et ne stocke pas les r√©sultats de conversion.  Il a une connaissance indirecte des locataires: l'identifiant du locataire transite par le service en transit. </p><br><h2 id="mikroservisy-poddomeny-ne-nuzhny">  Microservices.  Les sous-domaines ne sont pas n√©cessaires </h2><br><p>  J'ai √©crit ci-dessus que les sous-domaines aident √† r√©soudre le probl√®me des demandes http anonymes: </p><br><pre> <code class="plaintext hljs">https://company1.service.com https://company2.service.com</code> </pre> <br><p>  Mais tous les services ne fonctionnent pas avec des demandes anonymes, la plupart n√©cessitent une authentification d√©j√† transmise.  Par cons√©quent, les microservices qui fonctionnent via http ne se soucient souvent pas du nom d'h√¥te de la demande, ils re√ßoivent toutes les informations sur le locataire du jeton JWT ou du cookie d'authentification fourni avec chaque demande. </p><br><h2 id="konfigurirovanie">  La configuration </h2><br><p>  Les services doivent √™tre configur√©s pour qu'ils connaissent les locataires.  √Ä savoir: </p><br><ul><li>  sp√©cifier les cha√Ænes de connexion √† la base de donn√©es des locataires; </li><li>  lier les noms de domaine aux locataires; </li><li>  sp√©cifiez la langue et le fuseau horaire par d√©faut du locataire. </li></ul><br><p>  Les locataires peuvent avoir de nombreux param√®tres.  Pour nos services, nous d√©finissons les param√®tres des locataires dans les fichiers de configuration xml.  Ce n'est ni web.config ni app.config.  Il s'agit d'un fichier xml distinct, dont les modifications doivent pouvoir √™tre intercept√©es sans red√©marrer les services afin que l'ajout d'un nouveau locataire ne red√©marre pas l'ensemble du syst√®me. </p><br><p>  La liste des param√®tres ressemble √† ceci: </p><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!--  . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TENANTS"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tenant</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">db</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DirectumRX_Jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">login</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkUriScheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkFileExtension</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkServer</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">helpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero/help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">devHelpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero/dev_help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Ru-ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isAttributesSignatureAbsenceAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">endorsingSignatureLocksSignedProperties</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">administratorEmail</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin@jupiter-company.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">feedbackEmail</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"support@jupiter-company.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isSendFeedbackAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serviceUserPassword</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">utcOffset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingForced</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tenant</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">db</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DirectumRX_Mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">login</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkUriScheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkFileExtension</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkServer</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">helpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero/help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">devHelpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero/dev_help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Ru-ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isAttributesSignatureAbsenceAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">endorsingSignatureLocksSignedProperties</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">administratorEmail</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"root@mars-ooo.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">feedbackEmail</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"support@mars-ooo.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isSendFeedbackAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serviceUserPassword</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">utcOffset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"-1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingForced</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Lorsqu'une nouvelle organisation loue un service, elle doit ajouter un nouveau locataire au fichier de configuration correspondant.  Et il est souhaitable que d'autres organisations ne ressentent pas cela.  Id√©alement, il ne devrait pas y avoir de red√©marrage des services. </p><br><p>  Chez nous, tous les services ne peuvent pas r√©cup√©rer une configuration sans red√©marrer, mais les services les plus critiques (monolithes) sont capables de le faire. </p><br><h2 id="itog">  R√©sum√© </h2><br><p>  Lorsqu'une application devient multi-locataire, il semble que la complexit√© du d√©veloppement ait consid√©rablement augment√©.  Mais ensuite, vous vous habituez au multitenant et vous traitez son soutien comme une exigence normale. </p><br><p>  Il convient √©galement de rappeler que l'h√©bergement multiclient n'est pas seulement le d√©veloppement, mais aussi le test, l'administration, le d√©ploiement, la mise √† jour, les sauvegardes, les migrations de donn√©es.  Mais mieux √† leur sujet une autre fois. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr483784/">https://habr.com/ru/post/fr483784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr483770/index.html">Vers l'automatisation SSL</a></li>
<li><a href="../fr483774/index.html">Le condens√© des √©v√©nements pour les professionnels des RH en informatique pour janvier 2020</a></li>
<li><a href="../fr483776/index.html">Introduction √† la m√©thode diff√©rentielle s√©mantique en 5 minutes</a></li>
<li><a href="../fr483778/index.html">Semaine de la s√©curit√© 03: Principes responsables de rapport de bogue</a></li>
<li><a href="../fr483780/index.html">Qu'est-ce que Slack et comment √ßa marche?</a></li>
<li><a href="../fr483786/index.html">Tri hybride</a></li>
<li><a href="../fr483788/index.html">Une petite nation insulaire gagne gr√¢ce √† Twitch</a></li>
<li><a href="../fr483790/index.html">Notes du fournisseur IoT. Technologie et √©conomie LoRaWAN dans l'√©clairage urbain</a></li>
<li><a href="../fr483794/index.html">Quitter: pourquoi ne pas prendre Kontroffer</a></li>
<li><a href="../fr483796/index.html">Param√®tres facultatifs dans les r√©f√©rentiels de donn√©es Spring</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>