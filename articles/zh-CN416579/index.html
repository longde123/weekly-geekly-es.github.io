<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚌 👨🏿 📠 我们使用Web Bluetooth API和Arduino控制LED 🚵🏾 ◽️ 🏐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="-水壶，体重秤，玩具，灯泡，咖啡机……这些设备和其他设备中内置了蓝牙模块。 
 -为什么？ 
 -让用户通过该应用程序管理其设备。 例如，控制房间的照明。 
 -噢，可以组装自己的一些简单设备并直接通过浏览器进行管理吗？ 
 -是的！ 而这篇文章就是这样。 
 一点理论 


 在这里，我将提供一些...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>我们使用Web Bluetooth API和Arduino控制LED</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/space307/blog/416579/"><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/yn/_u/jb/yn_ujbyh92tyfs0kwjztiq96dl0.jpeg"></div><br><p><br>  -水壶，体重秤，玩具，灯泡，咖啡机……这些设备和其他设备中内置了蓝牙模块。 <br>  -为什么？ <br>  -让用户通过该应用程序管理其设备。 例如，控制房间的照明。 <br>  -噢，可以组装自己的一些简单设备并直接通过浏览器进行管理吗？ <br>  -是的！ 而这篇文章就是这样。 </p><a name="habracut"></a><br><h2 id="nemnogo-teorii"> 一点理论 </h2><br><p> 在这里，我将提供一些基本术语，这些术语是我们生活中实现任务所需要的（稍后再讨论）。 </p><br><h3 id="bluetooth"> 蓝牙功能 </h3><br><p> 一种无线标准，可在短距离内连接各种类型的设备。 要通过Web蓝牙API控制腺体，我们需要蓝牙v4.0。 </p><br><h3 id="gatt"> 加特 </h3><br><p> 通用属性是蓝牙设备功能的不断广播的树。 </p><br><h3 id="servisy"> 服务项目 </h3><br><p> 蓝牙设备内部有服务。 服务本身是功能和与其他服​​务的关系的集合。 每个服务都有其自己的UID和名称。 通常，会出现“未知服务”。 这是由于设备及其使用案例的数量很大。 </p><br><h3 id="harakteristiki"> 特点 </h3><br><p> 每个服务中都有一些特征，您可以在其中编写，读取它们以及订阅它们。 该功能还具有自己的UID。 </p><br><h2 id="zadacha"> 挑战赛 </h2><br><p> 作为一项任务，我选择了一个网站实现，它可以： </p><br><ul><li> 用不同的颜色点亮LED并关闭它们。 </li><li> 使LED闪烁不同的颜色。 </li></ul><br><p> 并且，从问题的陈述中您可以理解，您需要学习如何与蓝牙设备连接和断开连接。 </p><br><h2 id="komponenty"> 组成部分 </h2><br><p> 为了完成任务，我选择了以下必要列表： </p><br><ul><li>  Arduino的 </li><li> 蓝牙模块v4.0（在我的情况下为HM-10）。 </li><li> 两个三色LED。 </li><li> 面包板。 </li><li> 连接电线。 </li><li> 电阻器 </li></ul><br><p> 该列表对于执行并不严格。 我确信您可以用其他东西代替Arduino并选择其他蓝牙模块。 但是本文将考虑与这些组件的交互。 </p><br><h2 id="kak-eto-dolzhno-rabotat"> 它应该如何工作 </h2><br><p> 简而言之，本质是这样的：我们连接到蓝牙模块并传输一定的代码（包括1到4）。 如果代码有效，则三种颜色之一会亮起，或者LED会以所有可能的颜色（红色，绿色，蓝色）闪烁一段时间。 </p><br><h2 id="prigotovleniya"> 做饭 </h2><br><p> 首先，您需要收集工作图并加载Arduino草图。 下面我给出电路（图1）和我得到的草图代码。 </p><br><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/yj/xx/hb/yjxxhb2khesa-j8qfodl7tu5f4s.png"></div><br><p>  <em>图</em>  <em>1（组装图）</em> <br><br></p><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SoftwareSerial.h&gt; int green_pin = 2; int red_pin = 3; int blue_pin = 4; int BLINK_STEPS = 3; int BLINK_DELAY = 100; SoftwareSerial mySerial(7, 8); // RX, TX void setup() { Serial.begin(9600); mySerial.begin(9600); pinMode(green_pin, OUTPUT); pinMode(red_pin, OUTPUT); pinMode(blue_pin, OUTPUT); } int code; void loop() { if (mySerial.available()) { code = mySerial.read(); shutDownAll(); if (code &gt; 0 &amp;&amp; code &lt; 5) { analogWrite(code, 200); } if (code == 1) { blinked(); } } } void shutDownAll() { analogWrite(green_pin, 0); analogWrite(red_pin, 0); analogWrite(blue_pin, 0); } void blinked() { int steps = 0; while(steps &lt;= BLINK_STEPS) { analogWrite(green_pin, 200); delay(BLINK_DELAY); analogWrite(green_pin, 0); delay(BLINK_DELAY); analogWrite(red_pin, 200); delay(BLINK_DELAY); analogWrite(red_pin, 0); delay(BLINK_DELAY); analogWrite(blue_pin, 200); delay(BLINK_DELAY); analogWrite(blue_pin, 0); delay(BLINK_DELAY); steps += 1; } }</span></span></span></span></code> </pre> <br><h2 id="poslednee-prigotovlenie"> 最后做饭 </h2><br><p> 因此，我们下载了草图，将电路连接到电源。 接下来是什么？ 要使用Web Bluetooth API，我们需要知道设备的名称以及我们要访问的服务。 您可以为此使用“ nRF Connect”应用程序。 </p><br><p> 我们打开该应用程序，然后查看附近的蓝牙设备列表（图2）。 </p><br><div style="text-align:center;"><img height="600" src="https://habrastorage.org/webt/rs/of/xg/rsofxgsudyj7lp3zjd7jridz5qc.jpeg"></div><br><p>  <em>图</em>  <em>2（应用程序找到的设备列表）</em> <br><br> 名为“ CC41-A”的设备使我感兴趣，但没有白费。 </p><br><p> 连接到设备后，我们可以使用其服务列表（图3）。 我们不太可能在“设备信息”中找到有趣的内容，因此我们大胆地单击“未知服务”。 </p><br><div style="text-align:center;"><img height="600" src="https://habrastorage.org/webt/xt/qy/5c/xtqy5cgl8wvkvpsmzdklwa32a1g.jpeg"></div><br><p>  <em>图</em>  <em>3（设备服务列表）</em> <br><br> 在下面的屏幕截图（图4）中，您可以注意到对我们来说最重要的事情：写特征并阅读它。 </p><br><p> 解决上述问题后，我尝试将值“ 2”发送到特征。 结果，我的一对LED开始变绿。 几乎成功了。 现在，我们需要做同样的事情，而不是通过移动应用程序，而是通过浏览器。 </p><br><div style="text-align:center;"><img height="600" src="https://habrastorage.org/webt/mo/mr/ho/momrhoy4vm-vehhvpg6h9pomrse.jpeg"></div><br><p>  <em>图</em>  <em>4（未知特征）</em> <br><br> 这是我们从应用程序收到的继续执行任务的数据列表： </p><br><ol><li> 设备的名称。 </li><li> 服务的UID。 </li><li>  UID特征。 </li></ol><br><h2 id="realizaciya-v-web"> 网络实施 </h2><br><p> 在开始编写JavaScript代码之前，需要注意以下几点： </p><br><ol><li> 该API是实验性的。 </li><li> 适用于Chrome和Samsung Internet。 </li><li> 需要通过HTTPS连接。 </li><li> 我不会提供HTML和CSS代码的示例，因为在本文的框架内没有有趣的内容，但是在本文结尾处，我将保留指向存储库和网站的链接。 </li></ol><br><h2 id="javascript">  Java脚本 </h2><br><p> 使用Web蓝牙API是基于Promise的。 下面，我将给出分阶段的代码示例。 完整的源代码可以在链接所在的存储库中找到。 </p><br><p> 首先，我们需要连接到设备。 我们请求设备，并在过滤器中传输将使用的设备名称和服务UID。 如果您未预先指定服务，则将来将无法与其进行交互。 </p><br><pre> <code class="javascript hljs">navigator.bluetooth.requestDevice({ <span class="hljs-attr"><span class="hljs-attr">filters</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: MY_BLUETOOTH_NAME }, { <span class="hljs-attr"><span class="hljs-attr">services</span></span>: [SEND_SERVICE] }, ] })</code> </pre> <br><p> 单击“连接”按钮后，将打开一个窗口（图5），您需要在其中选择设备并单击“连接”按钮。 </p><br><div style="text-align:center;"><img height="400" src="https://habrastorage.org/webt/qu/ws/zc/quwszczbtzekphhkccgqzebbyx0.png"></div><br><p>  <em>图</em>  <em>5（带有可访问设备的窗口）</em> <br><br> 连接后，将返回一个包含“设备”的Promise，您可以连接到该设备。 好的，让我们将其写入变量并创建连接。 </p><br><pre> <code class="javascript hljs">.then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">device</span></span></span><span class="hljs-function"> =&gt;</span></span> { myDevice = device; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> device.gatt.connect(); })</code> </pre> <br><p> 之后，包含“服务器”的Promise将退还给我们。 然后，我们从“服务器”请求“服务”，并向其中传递服务UID（我们通过应用程序对其进行监视）。 然后，我们得到一个包含“服务”的Promise，从中我们请求“特征”，并向其传递UID（我们也通过应用程序进行了窥视）。 </p><br><pre> <code class="javascript hljs">.then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">server</span></span></span><span class="hljs-function"> =&gt;</span></span> server.getPrimaryService(SEND_SERVICE)) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">service</span></span></span><span class="hljs-function"> =&gt;</span></span> service.getCharacteristic(SEND_SERVICE_CHARACTERISTIC))</code> </pre> <br><p> 只有现在，我们才可以开始做某事。 例如，我将特征存储在变量中并挂断按钮单击处理程序。 在其数据属性中，它们包含一个代码，单击该代码将被写入特性。 </p><br><p> 按钮单击处理程序包含以下代码： </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> code = <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>(event.target.dataset.code); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (code === <span class="hljs-number"><span class="hljs-number">1</span></span>) { toggleLigthCharacteristic.writeValue(<span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>.of(code)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } toggleLigthCharacteristic.readValue() .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">currentCode</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> convertedCode = currentCode.getUint8(<span class="hljs-number"><span class="hljs-number">0</span></span>); toggleLigthCharacteristic.writeValue( <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>.of(convertedCode === code ? <span class="hljs-number"><span class="hljs-number">0</span></span> : code) ); });</code> </pre> <br><p> 必须将uint8数组传递给特征，因此，要转换将传递给它的代码，必须使用Uint8Array。 </p><br><p> 按照计划，代码1使LED闪烁三种颜色，然后熄灭。 但是，如果已向其发送代码3并且LED仍然亮着，该如何关闭LED？ 或打开其他颜色？ </p><br><p> 我读取了特征中的值，使用getUint8对其进行了转换，如果代码匹配，则发送任何无效值（例如0）。 如果该值有效，则将其转换为数组unit8并将其写入特性。 </p><br><p> 对于该任务的最终解决方案，您只需要学习如何与设备断开连接。 我们已经在“ Disconnect”按钮上有一个eventListener，其中设备与蓝牙设备断开连接，eventListener被删除，控制按钮被隐藏，并且undefined被写入变量。 </p><br><pre> <code class="javascript hljs">myDevice.gatt.disconnect(); toggleItemsEventListeners(<span class="hljs-string"><span class="hljs-string">'removeEventListener'</span></span>); toggleButtonsVisible(); toggleLigthCharacteristic = <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>; myDevice = <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>;</code> </pre> <br><h2 id="itog"> 总结 </h2><br><p> 我们创建了一个简单的网页，您可以通过该网页连接并控制蓝牙设备。 如您所见，这非常简单。 您可以通过这种方式组装和管理的设备仅受您的想象力限制！ </p><br><h2 id="poleznye-ssylki"> 有用的链接 </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">带有正在运行的应用程序的存储库</a> </li><li>  <a href="">具有有效应用程序的视频</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Google开发人员文章</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Web蓝牙社区组规范</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">有关GATT的更多信息</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Vadim Makeev的报告“ I and IoT”</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">我可以使用Web Bluetooth API支持</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN416579/">https://habr.com/ru/post/zh-CN416579/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN416565/index.html">亚马逊伐木场：灵魂的呐喊</a></li>
<li><a href="../zh-CN416569/index.html">像Prius，但仅在Linux上：考虑混合办公室</a></li>
<li><a href="../zh-CN416573/index.html">从任何地址发送电子邮件</a></li>
<li><a href="../zh-CN416575/index.html">CERN大型强子对撞机磁体的超导破坏分析</a></li>
<li><a href="../zh-CN416577/index.html">摘要MBLT DEV-适用于iOS开发人员的全新内容</a></li>
<li><a href="../zh-CN416581/index.html">三阶模板，或者我如何将Jinja2移植到C ++</a></li>
<li><a href="../zh-CN416583/index.html">购买哪一台3D扫描仪？ 3Dtool评选的2018年5大最佳3D扫描仪</a></li>
<li><a href="../zh-CN416585/index.html">自定义脚本的跨浏览器Web扩展第3部分</a></li>
<li><a href="../zh-CN416587/index.html">关于低音炮的一些话以及为什么它们适合几乎所有人</a></li>
<li><a href="../zh-CN416589/index.html">死细胞：使用3D管线进行2D动画处理</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>