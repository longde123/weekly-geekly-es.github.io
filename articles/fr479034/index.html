<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïô üöî ‚ùé Comment se connecter √† un VPN d'entreprise sous Linux en utilisant openconnect et vpn-slice ü§¶üèø üåó üî≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vous voulez utiliser Linux au travail, mais pas un VPN d'entreprise? Cet article peut alors vous aider, bien que ce ne soit pas exact. Je tiens √† aver...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment se connecter √† un VPN d'entreprise sous Linux en utilisant openconnect et vpn-slice</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479034/"><p>  Vous voulez utiliser Linux au travail, mais pas un VPN d'entreprise?  Cet article peut alors vous aider, bien que ce ne soit pas exact.  Je tiens √† avertir √† l'avance que je comprends mal les probl√®mes d'administration de r√©seau, il est donc possible que j'ai tout mal fait.  D'un autre c√¥t√©, il est possible que je puisse √©crire le manuel de mani√®re √† ce qu'il soit compr√©hensible pour les gens ordinaires, je vous conseille donc de l'essayer. </p><br><p>  L'article contient beaucoup d'informations suppl√©mentaires, mais sans cette connaissance, je ne serais pas en mesure de r√©soudre les probl√®mes que j'ai subitement rencontr√©s avec le param√®tre vpn.  Je pense que quiconque essaie d'appliquer ce manuel aura des probl√®mes que je n'ai pas rencontr√©s, et j'esp√®re que ces informations suppl√©mentaires aideront √† r√©soudre ces probl√®mes par moi-m√™me. </p><br><p>  La plupart des commandes utilis√©es dans le manuel doivent √™tre ex√©cut√©es via sudo, qui est supprim√© par souci de concision.  Gardez √† l'esprit. </p><br><p>  La plupart des adresses IP ont √©t√© gravement obscurcies, donc si vous voyez une adresse comme 435.435.435.435, il devrait y avoir une adresse IP normale sp√©cifique √† votre cas. </p><br><p>  J'ai Ubuntu 18.04, mais je pense que le manuel peut √™tre appliqu√© √† d'autres distributions avec quelques corrections.  Cependant, dans ce texte, Linux == Ubuntu. </p><br><h2>  Cisco connect </h2><br><p>  Ceux qui sont assis sur Windows ou MacOS peuvent se connecter √† notre VPN d'entreprise via Cisco Connect, qui doit sp√©cifier l'adresse de la passerelle et entrer un mot de passe √† chaque connexion, compos√© d'une partie fixe et d'un code g√©n√©r√© par Google Authenticator. </p><a name="habracut"></a><br><p>  Dans le cas de Linux, il n'√©tait pas possible d'obtenir Cisco Connect, mais il s'est av√©r√© google la recommandation d'utiliser openconnect, faite sp√©cifiquement pour remplacer Cisco Connect. </p><br><h2>  Openconnect </h2><br><p>  En th√©orie, dans ubunt, il existe une interface graphique sp√©ciale pour openconnect, mais cela n'a pas fonctionn√© pour moi.  C'est peut-√™tre pour le mieux. </p><br><p>  Dans ubunt, openconnect est install√© √† partir du gestionnaire de paquets. </p><br><pre><code class="plaintext hljs">apt install openconnect</code> </pre> <br><p>  Imm√©diatement apr√®s l'installation, vous pouvez essayer de vous connecter au VPN </p><br><pre> <code class="plaintext hljs">openconnect --user poxvuibr vpn.evilcorp.com</code> </pre> <br><p>  vpn.evilcorp.com est l'adresse VPN fictive \ <br>  poxvuibr - nom d'utilisateur fictif </p><br><p>  openconnect vous demandera d'entrer un mot de passe, qui, je le rappelle, consiste en une partie fixe et un code de Google Authenticator, puis essaie de se connecter √† vpn.  Si cela s'est av√©r√©, f√©licitations, vous pouvez sauter en toute s√©curit√© au milieu, ce qui est tr√®s douloureux et aller au point sur l'openconnect en arri√®re-plan.  Si cela ne fonctionne pas, vous pouvez continuer.  Bien que si cela s'est av√©r√© lors de la connexion, par exemple, √† partir d'un Wi-Fi invit√© au travail, il est possible de se r√©jouir et t√¥t, vous devez essayer de r√©p√©ter la proc√©dure depuis votre domicile. </p><br><h2>  Attestation </h2><br><p>  Avec une forte probabilit√©, rien ne d√©marre et l'√©chappement openconnect ressemble √† ceci: </p><br><pre> <code class="plaintext hljs">POST https://vpn.evilcorp.com/ Connected to 777.777.777.777:443 SSL negotiation with vpn.evilcorp.com Server certificate verify failed: signer not found Certificate from VPN server "vpn.evilcorp.com" failed verification. Reason: signer not found To trust this server in future, perhaps add this to your command line: --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 Enter 'yes' to accept, 'no' to abort; anything else to view: fgets (stdin): Operation now in progress</code> </pre> <br><p>  D'une part, c'est d√©sagr√©able, car il n'y avait pas de connexion au VPN, mais d'autre part, comment r√©soudre ce probl√®me est compr√©hensible en principe. </p><br><p>  Ensuite, le serveur nous a envoy√© un certificat, selon lequel il peut √™tre √©tabli que la connexion est √©tablie avec le serveur de la soci√©t√© native, et non avec le fraudeur malveillant, et ce certificat est inconnu du syst√®me.  Et donc elle ne peut pas v√©rifier si le vrai serveur l'est ou non.  Et donc, juste au cas o√π, cela cesserait de fonctionner. </p><br><p>  Pour qu'encenconnect se connecte toujours au serveur, vous devez lui indiquer explicitement quel certificat doit provenir du serveur VPN √† l'aide de la cl√© --servercert </p><br><p>  Et vous pouvez savoir quel certificat le serveur nous a envoy√© directement √† partir de quel openconnect imprim√©.  Voici de cette pi√®ce: </p><br><pre> <code class="plaintext hljs">To trust this server in future, perhaps add this to your command line: --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 Enter 'yes' to accept, 'no' to abort; anything else to view: fgets (stdin): Operation now in progress</code> </pre> <br><p>  Avec cette commande, vous pouvez essayer de vous reconnecter </p><br><pre> <code class="plaintext hljs">openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr vpn.evilcorp.com</code> </pre> <br><p>  Peut-√™tre que √ßa marche maintenant, alors vous pouvez aller √† la fin.  Mais Ubunta m'a personnellement montr√© une figue sous cette forme </p><br><pre> <code class="plaintext hljs">POST https://vpn.evilcorp.com/ Connected to 777.777.777.777:443 SSL negotiation with vpn.evilcorp.com Server certificate verify failed: signer not found Connected to HTTPS on vpn.evilcorp.com XML POST enabled Please enter your username and password. POST https://vpn.evilcorp.com/ Got CONNECT response: HTTP/1.1 200 OK CSTP connected. DPD 300, Keepalive 30 Set up DTLS failed; using SSL instead Connected as 192.168.333.222, using SSL NOSSSSSHHHHHHHDDDDD 3 NOSSSSSHHHHHHHDDDDD 3 RTNETLINK answers: File exists /etc/resolvconf/update.d/libc: Warning: /etc/resolv.conf is not a symbolic link to /run/resolvconf/resolv.conf</code> </pre> <br><p>  /etc/resolv.conf </p><br><pre> <code class="plaintext hljs"># Generated by NetworkManager search gst.evilcorpguest.com nameserver 127.0.0.53</code> </pre> <br><p>  /run/resolvconf/resolv.conf </p><br><pre> <code class="plaintext hljs"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8) # DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN # 127.0.0.53 is the systemd-resolved stub resolver. # run "systemd-resolve --status" to see details about the actual nameservers. nameserver 192.168.430.534 nameserver 127.0.0.53 search evilcorp.com gst.publicevilcorp.com</code> </pre> <br><p>  habr.com sera r√©solu, mais il ne sera pas possible d'y entrer.  Les adresses comme jira.evilcorp.com ne r√©solvent pas du tout. </p><br><p>  Ce qui s'est pass√© ici n'est pas clair pour moi.  Mais l'exp√©rience montre que si vous ajoutez la ligne √† /etc/resolv.conf </p><br><pre> <code class="plaintext hljs">nameserver 192.168.430.534</code> </pre> <br><p>  alors les adresses √† l'int√©rieur du VPN se r√©soudront comme par magie et il sera possible de les parcourir, c'est-√†-dire ce que le DNS cherche pour r√©soudre les adresses se trouve dans /etc/resolv.conf, et pas ailleurs. </p><br><p>  Qu'il y ait une connexion au VPN et que cela fonctionne, vous pouvez vous assurer sans changements dans /etc/resolv.conf, pour cela il suffit d'entrer dans le navigateur non pas le nom symbolique de la ressource de vpn, mais son adresse ip </p><br><p>  Le r√©sultat est deux probl√®mes </p><br><ul><li>  lors de la connexion au VPN, son DNS n'est pas pris </li><li>  tout le trafic passe par vpn, ce qui ne vous permet pas d'aller sur Internet </li></ul><br><p>  Ce que je vais faire maintenant, je vais vous le dire, mais d'abord un peu d'automatisation. </p><br><h2>  Saisie automatique de la partie fixe du mot de passe </h2><br><p>  √Ä l'heure actuelle, vous avez probablement d√©j√† entr√© le mot de passe au moins cinq fois et cette proc√©dure vous a d√©j√† assez fatigu√©.  Premi√®rement, parce que le mot de passe est long, et deuxi√®mement, parce que lors de la saisie, vous devez le conserver dans un d√©lai fixe </p><br><p>  La solution finale au probl√®me n'√©tait pas incluse dans l'article, mais cela peut √™tre fait pour que la partie fixe du mot de passe ne doive pas √™tre entr√©e plusieurs fois. </p><br><p>  Supposons que la partie fixe du mot de passe soit fixedPassword et une partie de Google Authenticator 567 987. Le mot de passe entier d'openconnect peut √™tre transmis via une entr√©e standard en utilisant l'argument --passwd-on-stdin. </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr vpn.evilcorp.com --passwd-on-stdin</code> </pre> <br><p>  Maintenant, vous pouvez constamment revenir √† la derni√®re commande entr√©e et y modifier uniquement une partie de Google Authenticator. </p><br><h2>  Le VPN d'entreprise ne permet pas l'acc√®s √† Internet. </h2><br><p>  En r√®gle g√©n√©rale, il n'est pas tr√®s g√™nant de se rendre sur un hub pour utiliser un ordinateur s√©par√©.  Le manque de capacit√© de copier-coller avec stackoverfow peut g√©n√©ralement paralyser le travail, donc quelque chose doit √™tre fait. </p><br><p>  Il est n√©cessaire d'organiser d'une mani√®re ou d'une autre, de sorte que lorsque vous devez acc√©der √† la ressource √† partir du r√©seau interne, Linux passe √† vpn, et lorsque vous devez acc√©der au concentrateur, il va √† Internet. </p><br><p>  openconnect apr√®s avoir d√©marr√© et √©tabli une connexion avec vpn, ex√©cute un script sp√©cial, qui se trouve dans / usr / share / vpnc-scripts / vpnc-script.  Certaines variables sont transf√©r√©es vers le script d'entr√©e, et il fait la configuration vpn.  Malheureusement, je n'ai pas pu comprendre comment r√©partir les flux de trafic entre le VPN d'entreprise et le reste d'Internet √† l'aide d'un script natif. </p><br><p>  Apparemment sp√©cialement pour des gens comme moi, l'utilitaire vpn-slice a √©t√© d√©velopp√©, qui vous permet de diriger le trafic via deux canaux sans danser avec un tambourin.  Eh bien, vous devez danser, mais un chaman n'est pas n√©cessaire. </p><br><h2>  Fractionner le trafic avec vpn-slice </h2><br><p>  Tout d'abord, vpn-slice devra √™tre install√©, vous devrez le d√©couvrir par vous-m√™me.  S'il y a des questions dans les commentaires, j'√©crirai un article s√©par√© √† ce sujet.  Mais c'est un programme Python normal, donc il ne devrait pas y avoir de difficult√©s.  Je mets en utilisant virtualenv. </p><br><p>  Et puis vous devez utiliser l'utilitaire, en utilisant la cl√© --script indiquant openconnect qu'au lieu du script standard, vous devez utiliser vpn-slice </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin \ --script "./bin/vpn-slice 192.168.430.0/24 " vpn.evilcorp.com</code> </pre> <br><p>  En --script, une ligne est pass√©e avec la commande qui doit √™tre appel√©e √† la place du script.  ./bin/vpn-slice - chemin vers le fichier ex√©cutable vpn-slice 192.168.430.0/24 - masque des adresses √† visiter dans vpn.  Ici, je veux dire que si l'adresse commence par 192.168.430, alors la ressource avec cette adresse doit √™tre recherch√©e dans vpn </p><br><p>  Maintenant, la situation devrait √™tre presque normale.  Presque.  Vous pouvez maintenant vous connecter au concentrateur et vous pouvez vous connecter √† la ressource d'entreprise interne par ip, mais vous ne pouvez pas vous connecter √† la ressource d'entreprise interne par nom symbolique.  Si vous enregistrez la correspondance du nom et de l'adresse symboliques dans les h√¥tes, tout devrait fonctionner.  Et travaillez jusqu'√† ce que l'IP change.  Linux peut d√©sormais acc√©der √† Internet ou au r√©seau d'entreprise, selon l'ip.  Mais le DNS non d'entreprise est toujours utilis√© pour d√©terminer l'adresse. </p><br><p>  Le probl√®me peut toujours se manifester sous cette forme - tout va bien au travail, et √† la maison, vous ne pouvez acc√©der aux ressources internes de l'entreprise que par IP.  En effet, lorsque vous √™tes connect√© au Wi-Fi d'entreprise, le DNS d'entreprise est √©galement utilis√©, et les adresses symboliques du VPN sont r√©solues, bien qu'il soit toujours impossible d'acc√©der √† une telle adresse sans utiliser de VPN. </p><br><h2>  Modification automatique du fichier hosts </h2><br><p>  Si vous demandez poliment vpn-slice, puis apr√®s avoir augment√© le VPN, il peut acc√©der √† son DNS, y trouver les adresses IP des ressources n√©cessaires par leurs noms symboliques et les entrer dans les h√¥tes.  Une fois le VPN d√©sactiv√©, ces adresses seront supprim√©es des h√¥tes.  Pour ce faire, passez des noms symboliques √† vpn-slice comme arguments.  Comme √ßa. </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Maintenant, tout devrait fonctionner √† la fois au bureau et sur la plage. </p><br><h2>  Recherchez les adresses de tous les sous-domaines du DNS fournis par le VPN </h2><br><p>  S'il y a peu d'adresses dans le r√©seau, alors l'approche avec la modification automatique du fichier hosts fonctionne tout √† fait.  Mais s'il y a beaucoup de ressources sur le r√©seau, vous devrez constamment ajouter des lignes comme zoidberg.test.evilcorp.com au script zoidberg, c'est le nom de l'un des bancs d'essai. </p><br><p>  Mais maintenant que nous comprenons un peu pourquoi ce besoin peut √™tre √©limin√©. </p><br><p>  Si, apr√®s avoir augment√© le VPN, regardez dans / etc / hosts, vous pouvez voir, voici une ligne </p><br><blockquote>  192.168.430.534 dns0.tun0 # vpn-slice-tun0 AUTOCREATED </blockquote><p>  Oui, et une nouvelle ligne a √©t√© ajout√©e √† resolv.conf.  En bref, vpn-slice a en quelque sorte d√©termin√© l'emplacement du serveur DNS pour vpn. </p><br><p>  Maintenant, nous devons nous assurer que pour d√©couvrir l'adresse IP du nom de domaine se terminant sur evilcorp.com, Linux est all√© au DNS d'entreprise, et si quelque chose d'autre est n√©cessaire, alors par d√©faut. </p><br><p>  J'ai googl√© pendant longtemps et j'ai constat√© qu'une telle fonctionnalit√© est inutilis√©e hors de la bo√Æte.  Cela fait r√©f√©rence √† la possibilit√© d'utiliser le serveur dns dnsmasq local pour r√©soudre les noms. </p><br><p>  Autrement dit, vous pouvez faire en sorte que Linux acc√®de toujours au serveur DNS local pour les adresses IP, qui √† son tour, en fonction du nom de domaine, recherchera IP sur le serveur DNS externe correspondant. </p><br><p>  Pour g√©rer tout ce qui concerne les r√©seaux et les connexions r√©seau, Ubunt utilise NetworkManager, et l'interface graphique pour s√©lectionner, par exemple, une connexion Wi-Fi n'est que le devant. </p><br><p>  Il faudra grimper dans sa configuration. </p><br><ol><li>  Cr√©er un fichier dans /etc/NetworkManager/dnsmasq.d/evilcorp </li></ol><br><blockquote>  adresse = /. evilcorp.com/192.168.430.534 </blockquote><p>  Faites attention au point avant evilcorp.  Cela signale √† dnsmasq que tous les sous-domaines evilcorp.com doivent √™tre recherch√©s dans les dns de l'entreprise. </p><br><ol><li>  Dites √† NetworkManager d'utiliser dnsmasq pour r√©soudre les noms </li></ol><br><p>  La configuration du gestionnaire de r√©seau se trouve dans /etc/NetworkManager/NetworkManager.conf Vous devez y ajouter: </p><br><blockquote>  [principal] <br>  dns = dnsmasq </blockquote><br><ol><li>  Red√©marrez NetworkManager </li></ol><br><pre> <code class="plaintext hljs">service network-manager restart</code> </pre> <br><p>  Maintenant, apr√®s la connexion √† un VPN en utilisant un tas d'openconnect et de vpn-slice, ip sera d√©tect√© normalement m√™me si vous n'ajoutez pas d'adresses symboliques aux arguments de vpnslice. </p><br><h2>  Comment passer par VPN pour s√©parer les services </h2><br><p>  Apr√®s qu'il s'est av√©r√© qu'il se connectait √† vpn, j'√©tais tr√®s heureux pendant deux jours, puis il s'est av√©r√© que si vous vous connectez au VPN depuis l'ext√©rieur du r√©seau du bureau, le courrier ne fonctionne pas.  Un sympt√¥me familier, n'est-ce pas? </p><br><p>  Notre courrier est dans mail.publicevilcorp.com, ce qui signifie qu'il ne rel√®ve pas de la r√®gle de dnsmasq et que l'adresse du serveur de messagerie est recherch√©e via le DNS public. </p><br><p>  Eh bien, le bureau utilise toujours le DNS dans lequel se trouve cette adresse.  Autrement dit, je le pensais.  En fait, apr√®s avoir ajout√© une ligne √† dnsmasq </p><br><blockquote>  adresse = / mail.publicevilcorp.com / 192.168.430.534 </blockquote><p>  la situation n'a pas chang√©.  ip est rest√© le m√™me.  Je devais aller travailler. </p><br><p>  Et seulement alors, quand j'ai fouill√© la situation et r√©gl√© un peu le probl√®me, une personne intelligente m'a dit comment le r√©soudre.  Il √©tait n√©cessaire de se connecter au serveur de messagerie non seulement comme √ßa, mais via vpn </p><br><p>  J'utilise vpn-slice pour passer par le VPN aux adresses commen√ßant par 192.168.430.  Et sur le serveur de messagerie, non seulement l'adresse symbolique n'est pas un sous-domaine de evilcorp, elle a √©galement une adresse IP qui ne commence pas par 192.168.430.  Et bien s√ªr, il ne laisse personne sortir du r√©seau g√©n√©ral. </p><br><p>  Pour que Linux passe par le VPN et le serveur de messagerie, vous devez l'ajouter √† vpn-slice.  Supposons que l'adresse de l'exp√©diteur soit 555.555.555.555 </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin --script "./bin/vpn-slice 555.555.555.555 192.168.430.0/24" vpn.evilcorp.com</code> </pre> <br><h2>  Script pour √©lever un VPN avec un argument </h2><br><p>  Tout cela, bien s√ªr, n'est pas tr√®s pratique.  Oui, vous pouvez enregistrer le texte dans un fichier et le copier-coller sur la console, plut√¥t que de taper avec vos mains, mais ce n'est toujours pas assez agr√©able.  Pour faciliter le processus, vous pouvez encapsuler la commande dans un script qui sera situ√© dans PATH.  Et puis il vous suffit de saisir le code obtenu aupr√®s de Google Authenticator </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Si vous mettez le script dans connect ~ evilcorp ~ vous pouvez simplement √©crire dans la console </p><br><pre> <code class="plaintext hljs">connect_evil_corp 567987</code> </pre> <br><p>  Mais maintenant, de toute fa√ßon, pour une raison quelconque, vous devez garder ouverte la console dans laquelle openconnect fonctionne </p><br><h2>  Lancement d'Openconnect en arri√®re-plan </h2><br><p>  Heureusement, les auteurs d'openconnect ont pris soin de nous et ont ajout√© une cl√© sp√©ciale - arri√®re-plan au programme, qui fait fonctionner le programme en arri√®re-plan apr√®s son lancement.  Si vous l'ex√©cutez comme ceci, apr√®s le lancement, vous pouvez fermer la console </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Maintenant, il n'est pas clair o√π vont les journaux.  Les journaux ne sont g√©n√©ralement pas vraiment n√©cessaires pour nous, mais vous ne savez jamais.  openconnect peut les rediriger vers syslog, o√π ils seront conserv√©s intacts.  vous devez ajouter la cl√© --syslog √† la commande </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \</code> </pre> <br><p>  Et donc, il s'av√®re qu'openconnect fonctionne quelque part en arri√®re-plan et ne d√©range personne, mais comment l'arr√™ter n'est pas clair.  Autrement dit, vous pouvez, bien s√ªr, filtrer l'√©chappement ps avec un grep et rechercher un processus au nom de openconnect, mais il est en quelque sorte morne.  Merci aux auteurs qui y ont r√©fl√©chi.  Openconnect a la cl√© --pid-file, avec laquelle vous pouvez demander √† openconnect d'√©crire son ID de processus dans un fichier. </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \ --pid-file ~/vpn-pid</code> </pre> <br><p>  Maintenant, vous pouvez toujours clouer le processus avec la commande </p><br><pre> <code class="plaintext hljs">kill $(cat ~/vpn-pid)</code> </pre> <br><p>  S'il n'y a pas de processus, kill jurera, mais il ne lancera pas d'erreur.  S'il n'y a pas de fichier, il ne se passera rien de mal non plus, vous pouvez donc tuer le processus en toute s√©curit√© dans la premi√®re ligne du script. </p><br><pre> <code class="plaintext hljs">kill $(cat ~/vpn-pid) #!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \ --pid-file ~/vpn-pid</code> </pre> <br><p>  Vous pouvez maintenant allumer l'ordinateur, ouvrir la console et ex√©cuter la commande, en lui passant le code de Google Authenticator.  La console peut alors √™tre clou√©e. </p><br><h1>  Sans tranche vpn.  Au lieu d'une postface </h1><br><p>  Il √©tait tr√®s difficile de comprendre comment vivre sans vpn-slice.  J'ai d√ª lire beaucoup et google.  Heureusement, quand j'ai pass√© tellement de temps avec le probl√®me, les manuels techniques et m√™me man openconnect se lisent comme des romans passionnants. </p><br><p>  En cons√©quence, j'ai d√©couvert que vpn-slice, comme le script natif, modifie la table de routage pour s√©parer les r√©seaux. </p><br><h2>  Table de routage </h2><br><p>  En termes simples, un tel tableau dans la premi√®re colonne contient o√π doit commencer l'adresse o√π Linux veut aller, et dans la seconde via quelle carte r√©seau aller √† cette adresse.  En fait, il y a plus de colonnes, mais cela ne change pas l'essence. </p><br><p>  Pour voir la table de routage, vous devez ex√©cuter la commande ip route </p><br><pre> <code class="plaintext hljs">default via 192.168.1.1 dev wlp3s0 proto dhcp metric 600 192.168.430.0/24 dev tun0 scope link 192.168.1.0/24 dev wlp3s0 proto kernel scope link src 192.168.1.534 metric 600 192.168.430.534 dev tun0 scope link</code> </pre> <br><p>  Ici, chaque ligne est responsable de l'endroit o√π aller afin d'envoyer un message √† une adresse.  Le premier est une description de l'endroit o√π l'adresse doit commencer.  Afin de comprendre comment d√©terminer que 192.168.0.0/16 signifie que l'adresse doit commencer par 192.168, vous devez rechercher sur Google le masque de l'adresse IP.  Apr√®s dev est le nom de l'adaptateur auquel le message doit √™tre envoy√©. </p><br><p>  Pour VPN, Linux a cr√©√© un adaptateur virtuel - tun0.  Pour que le trafic de toutes les adresses commen√ßant par 192.168 le traverse, la ligne r√©pond </p><br><pre> <code class="plaintext hljs">192.168.0.0/16 dev tun0 scope link</code> </pre> <br><p>  Vous pouvez √©galement consulter l'√©tat actuel de la table de routage √† l'aide de la commande <strong>route -n</strong> (les adresses IP sont dou√©es de mani√®re anonyme) .Cette commande produit des r√©sultats sous une forme diff√©rente et est g√©n√©ralement d√©conseill√©e, mais son √©puisement provient souvent de manuels en ligne et vous devez pouvoir la lire. </p><br><p>  L'endroit o√π l'adresse IP pour l'itin√©raire doit commencer peut √™tre compris √† partir de la combinaison des colonnes Destination et Genmask.  Les parties de l'adresse IP auxquelles correspondent les nombres 255 dans Genmask sont prises en compte, et celles o√π 0 ne l'est pas.  C'est-√†-dire que la combinaison de Destination 192.168.0.0 et Genmask 255.255.255.0 signifie que si l'adresse commence par 192.168.0, une demande lui sera envoy√©e le long de cette route.  Et si la destination est 192.168.0.0 mais que Genmask est 255.255.0.0, les demandes adress√©es aux adresses commen√ßant par 192.168 suivront cette route. </p><br><p>  Afin de comprendre ce que fait r√©ellement vpn-slice, j'ai d√©cid√© de regarder l'√©tat des tables avant et apr√®s </p><br><h2>  Avant d'activer le VPN, c'√©tait comme √ßa </h2><br><pre> <code class="plaintext hljs">route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0</code> </pre> <br><h2>  Apr√®s avoir appel√© openconnect sans vpn-slice, il est devenu si </h2><br><pre> <code class="plaintext hljs">route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 0.0.0.0 0.0.0.0 U 0 0 0 tun0 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0 192.168.430.0 0.0.0.0 255.255.255.0 U 0 0 0 tun0 192.168.430.534 0.0.0.0 255.255.255.255 UH 0 0 0 tun0</code> </pre> <br><h2>  Et apr√®s avoir appel√© openconnect en combinaison avec vpn-slice comme celui-ci </h2><br><pre> <code class="plaintext hljs">Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0 192.168.430.0 0.0.0.0 255.255.255.0 U 0 0 0 tun0 192.168.430.534 0.0.0.0 255.255.255.255 UH 0 0 0 tun0</code> </pre> <br><p>  On peut voir que si vous n'utilisez pas vpn-slice, alors openconnect √©crit explicitement que vous devez passer par vpn √† toutes les adresses sauf indication contraire. </p><br><p>  Ici: </p><br><pre> <code class="plaintext hljs">0.0.0.0 0.0.0.0 0.0.0.0 U 0 0 0 tun0</code> </pre> <br><p>  √Ä proximit√©, il a imm√©diatement indiqu√© un autre chemin √† utiliser si l'adresse que Linux essaie de parcourir ne correspond √† aucun masque de la table. </p><br><pre> <code class="plaintext hljs">0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0</code> </pre> <br><p>  Il a d√©j√† √©t√© √©crit ici que dans ce cas, vous devez passer par l'adaptateur Wi-Fi standard. </p><br><p>  Je crois que le chemin du VPN est utilis√© car il est le premier dans la table de routage. </p><br><p>  Et th√©oriquement, si vous supprimez ce chemin par d√©faut de la table de routage, alors en conjonction avec dnsmasq openconnect devrait assurer un fonctionnement normal. </p><br><p>  J'ai essay√© </p><br><pre> <code class="plaintext hljs">route del default</code> </pre> <br><p>  Et √ßa a march√©. </p><br><h2>  Routage des demandes vers un serveur de messagerie sans tranche vpn </h2><br><p>  Mais j'ai √©galement un serveur de messagerie avec l'adresse 555.555.555.555, dont vous devez √©galement passer par vpn.  L'itin√©raire doit √©galement √™tre ajout√© √† la main. </p><br><pre> <code class="plaintext hljs">ip route add 555.555.555.555 via dev tun0</code> </pre> <br><p>  Et maintenant toutes les r√®gles.  Vous pouvez donc vous passer de vpn-slice, mais vous devez d√©j√† bien savoir ce que vous faites.  Je pense maintenant √† ajouter la suppression de l'itin√©raire par d√©faut et √† ajouter l'itin√©raire de l'exp√©diteur apr√®s la connexion √† vpn √† la derni√®re ligne du script natif openconnect, juste pour r√©duire le nombre de pi√®ces mobiles dans mon v√©lo. </p><br><p>  Probablement, quelqu'un pour comprendre comment configurer un VPN aurait assez de cette postface.  Mais pendant que j'essayais de comprendre quoi et comment le faire, j'ai lu beaucoup de ces manuels qui fonctionnent pour l'auteur, mais pour une raison quelconque, ils ne fonctionnent pas pour moi et j'ai d√©cid√© d'ajouter ici toutes les pi√®ces que j'ai trouv√©es.  Je serais tr√®s content de quelque chose comme √ßa. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr479034/">https://habr.com/ru/post/fr479034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr479016/index.html">5 √©tapes pour prot√©ger les secrets commerciaux</a></li>
<li><a href="../fr479018/index.html">Docker pour le front-end. Partie 2. Que faites-vous?</a></li>
<li><a href="../fr479020/index.html">L'histoire de la fa√ßon dont Google Play a ray√© dix ans de mon travail en une heure</a></li>
<li><a href="../fr479022/index.html">Les t√©l√©viseurs intelligents Samsung, LG, Vizio et TCL prennent chaque seconde des "empreintes digitales" de l'√©cran et les envoient au serveur</a></li>
<li><a href="../fr479026/index.html">V√©ritable somme des canaux Internet - OpenMPTCPRouter</a></li>
<li><a href="../fr479036/index.html">Intel ne peut pas faire face √† la demande de processeurs. HP et Dell en souffrent</a></li>
<li><a href="../fr479038/index.html">Transformation num√©rique Leroy Merlin: Conception d'une interface pour travailler avec les appels clients</a></li>
<li><a href="../fr479040/index.html">Tests de r√©gression visuelle. Red√©marrer</a></li>
<li><a href="../fr479042/index.html">La m√©thode Y est un moyen tr√®s simple de cr√©er un Rubik's Cube</a></li>
<li><a href="../fr479044/index.html">Mon impl√©mentation de tampon en anneau dans NOR flash</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>