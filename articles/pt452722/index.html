<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí§ üî≥ ‚úåüèº Fa√ßa amigos CI, testes de unidade e banco de dados üë®üèø‚Äç‚öïÔ∏è üôÖüèΩ üßñüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O artigo √© sobre como testar a intera√ß√£o com o banco de dados no IC. Vi v√°rias solu√ß√µes usando docker e testcontainers, mas tenho o meu e quero compar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fa√ßa amigos CI, testes de unidade e banco de dados</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452722/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/p9/2f/hw/p92fhwlfahzagt8w9wzxpfclgzw.png" alt="imagem"></div><br>  O artigo √© sobre como testar a intera√ß√£o com o banco de dados no IC.  Vi v√°rias solu√ß√µes usando docker e testcontainers, mas tenho o meu e quero compartilh√°-lo. <br><a name="habracut"></a><br>  Meu projeto java passado estava intimamente ligado a um banco de dados.  Processamento longo com tentativas, multithreading e bloqueios de bloqueio.  Para a tarefa, foi necess√°rio corrigir algumas consultas SQL complicadas.  De alguma forma, eu estava acostumado a cobrir meu c√≥digo com testes, mas antes disso todo o SQL era reduzido a consultas primitivas e podia ser executado em uma base H2 na mem√≥ria.  E aqui no hardcore. <br><br>  Eu poderia testar o SQL simples com minhas m√£os e covardemente martelar nos autotestes, justificando-me: "Eu n√£o sou algum tipo de modelo, vou cometer erros no c√≥digo simples".  Na verdade, os erros aparecem com menos frequ√™ncia devido √† disponibilidade de testes.  Era poss√≠vel atribuir responsabilidade aos testadores - se eu cometesse algum erro, eles o encontrariam. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/js/ro/nh/jsronhgbydvhziosboj6velwb5w.png" alt="imagem"></div><br>  De acordo com a ideologia do teste de unidade, os testes s√£o necess√°rios apenas para testar m√≥dulos individuais e, se o m√≥dulo usar algo externo, isso dever√° ser substitu√≠do por um esbo√ßo.  Na pr√°tica, quando se torna muito dif√≠cil implementar um stub, o m√≥dulo √© simplesmente ignorado.  Velocidade e modularidade s√£o importantes, mas √© mais importante n√£o deixar o c√≥digo n√£o testado, mesmo que n√£o apare√ßa nas m√©tricas de cobertura.  Portanto, o m√≥dulo n√£o √© mais considerado uma classe separada, mas um grupo conectado, juntamente com a configura√ß√£o.  O principal com essas declara√ß√µes n√£o √© chegar ao conceito de unidade que se estende ao n√≠vel do cluster. <br><br>  Para testes locais, cada desenvolvedor tem seu pr√≥prio esquema, mas os testes s√£o executados no Jenkins e ainda n√£o h√° conex√£o com o banco de dados.  O CI precisa de um circuito separado, parece √≥bvio.  Mas em um diagrama vazio, n√£o √© muito correto executar testes; a cria√ß√£o de uma estrutura de banco de dados em cada teste consome tempo e est√° repleta de discrep√¢ncias entre a estrutura no teste e na batalha.  Executar em uma base pr√©-preparada - eu tenho um monte de problemas com ramifica√ß√µes.  Voc√™ pode preparar o banco de dados antes de executar todos os testes usando o liquibase, primeiro limpando tudo para zero e depois atualizando para a vers√£o mais recente. <br><br>  A revers√£o costuma ser esquecida para finalizar e voc√™ precisa limpar as bases com as m√£os nos ambientes de teste.  Teste e ele!  O algoritmo √© o seguinte: <br><br><ol><li>  remova tudo sob a raiz (para a pureza do experimento) </li><li>  atualizar para a vers√£o mais recente </li><li>  executar revers√£o 1-2 vers√µes de volta </li><li>  atualizar para a vers√£o mais recente (os testes precisam ser conduzidos na nova estrutura do banco de dados, al√©m de verificar se a revers√£o n√£o esqueceu de excluir nada, o que impedir√° a atualiza√ß√£o de rolar novamente) </li></ol><br>  Outros desenvolvedores n√£o desejam executar testes de revers√£o ao iniciar cada teste.  N√≥s fazemos a troca. <br><br><pre><code class="kotlin hljs">project.ext.doRollbackTest = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) }</code> </pre> <br>  Enquanto houver treinamento em gatos, est√° tudo bem.  Mas um projeto em desenvolvimento din√¢mico faz seus pr√≥prios ajustes - 2 pull-quests, montagem simult√¢nea.  Uma inst√¢ncia est√° testando alguma coisa, e a segunda est√° derrubando a base sob seus p√©s.  √â resolvido com uma simples proibi√ß√£o de montagens paralelas. <br><br><img src="https://habrastorage.org/webt/my/64/hm/my64hmqfabt8qg0jcuz-xwiddvi.png" alt="imagem"><br><br>  E novamente uma queda - eu decidi executar testes usando a conta Jenkins, porque  tudo est√° bem no pessoal, e o conjunto de solicita√ß√µes cai por motivos pouco claros.  Recordamos a conversa fervorosa de que o DevOps √© uma cultura e o uso de contas t√©cnicas para fins pessoais √© inaceit√°vel. <br><br><img src="https://habrastorage.org/webt/fr/lb/xf/frlbxfbj6ck-8pdbhff0v5kpeta.png" alt="imagem"><br><br>  Acumulado 10 pool de solicita√ß√µes.  Todos coletados, redistribu√≠dos, voc√™ pode mesclar.  O primeiro foi, o ramo principal mudou - o resto fica na fila para a reconstru√ß√£o.  Voc√™ pode mesclar √† medida que avan√ßa, mas h√° prioridades.  Pedidos de solicita√ß√£o mais urgentes, menos urgentes, tamb√©m est√£o sendo desligados devido a erros no c√≥digo.  Em geral, paralelize de volta. <br><br>  A montagem deve ser simples, composta por etapas simples e compreens√≠vel at√© para os alunos de ontem.  Em 99%, n√£o h√° problema em que a montagem do conjunto de solicita√ß√µes e libera√ß√µes √© seq√ºencial e n√£o paralela.  Se a revis√£o n√£o acumular mais do que 1-2 PR, a proibi√ß√£o de montagens simult√¢neas √© suficiente. <br><br>  E para o lan√ßamento paralelo, precisamos de bases ou esquemas aos quais cada teste lan√ßado ter√° acesso exclusivo. <br><br>  A primeira op√ß√£o √© alocar dinamicamente.  Criar um esquema no banco de dados √© r√°pido.  Tendo uma nuvem com uma API, voc√™ pode alocar um banco de dados l√°. <br><br>  Se voc√™ n√£o excluir a exclus√£o de bancos de dados antigos, poder√° terminar rapidamente o espa√ßo em disco quando os testes ca√≠rem e "esquecer" para liberar recursos.  √â "quando", n√£o "se". <br><br>  Op√ß√£o dois - um pool de banco de dados / esquema com um servi√ßo de gerenciamento separado.  Fora da API, forne√ßa a Base for the Time, recupere a Base Free Before the Term.  O que retornar√°: um servidor dedicado com um banco de dados ou apenas um pequeno esquema, n√£o importa.  O principal √© que o recurso n√£o ser√° perdido para sempre. <br><br>  Op√ß√£o tr√™s - um conjunto de bases / esquemas de auto-regula√ß√£o.  √â necess√°rio um recurso para a troca de informa√ß√µes sobre bloqueios e o pr√≥prio pool de banco de dados. <br><br>  Optei pela √∫ltima op√ß√£o, pois √© mais f√°cil fix√°-la e n√£o √© particularmente necess√°rio apoi√°-la.  A l√≥gica √© a seguinte - v√°rios circuitos (10 por exemplo) s√£o criados e todas as informa√ß√µes necess√°rias sobre a conex√£o a eles s√£o adicionadas ao recurso compartilhado, cada inst√¢ncia de teste faz uma marca de in√≠cio antes de inici√°-lo e, ap√≥s o final, o exclui.  Se o teste falhar antes de finalizar, o circuito ser√° considerado livre no final do tempo limite. <br><br>  Configura√ß√µes de leitura: <br><br><pre> <code class="kotlin hljs"> project.ext.localConfig = new Properties() localConfig.load(file(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rootDir}</span></span></span><span class="hljs-string">/local.properties"</span></span>).newReader())</code> </pre><br>  Trabalhar com sql a partir de scripts gradle requer o carregamento do driver: <br><pre> <code class="kotlin hljs"> configurations { driver } dependencies { driver group: <span class="hljs-string"><span class="hljs-string">"oracle"</span></span>, name: <span class="hljs-string"><span class="hljs-string">"ojdbc6"</span></span>, version: <span class="hljs-string"><span class="hljs-string">"11.+"</span></span> } task initDriver { doLast { ClassLoader loader = GroovyObject.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.classLoader configurations.driver.each { File file -&gt; loader.addURL(file.toURL()) } } }</code> </pre><br>  Conex√£o: <br><br><pre> <code class="kotlin hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.sql.Sql project.ext.createSqlInstance = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Sql.newInstance( url: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], user: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.username"</span></span>], password: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.password"</span></span>], driver: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>]) }</code> </pre><br>  A troca de informa√ß√µes pode ser realizada atrav√©s da tabela do banco de dados.  Inicializa√ß√£o da tabela de refer√™ncia (ela deve funcionar uma vez, e a tabela permanecer√° at√© o final dos tempos): <br><br><pre> <code class="kotlin hljs"> task initDbPool { dependsOn initDriver doLast { Integer poolSize = <span class="hljs-number"><span class="hljs-number">10</span></span> Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] String baseName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.baseName"</span></span>] String basePass = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.basePass"</span></span>] String token = <span class="hljs-string"><span class="hljs-string">"{id}"</span></span> List tableExists = sql.rows(<span class="hljs-string"><span class="hljs-string">"select table_name from all_tables where table_name=?"</span></span>, [tableName]) assert tableExists.isEmpty() sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE TABLE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> ( ID NUMBER(2) NOT NULL PRIMARY KEY, METADATA VARCHAR2(200) NOT NULL, PROCESSED TIMESTAMP NULL, GUID VARCHAR2(36) NULL) """</span></span>, []) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Integer i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; poolSize ; i++) { String username = baseName.replace(token, i.toString()) String password = basePass.replace(token, i.toString()) sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE USER </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string"> IDENTIFIED BY "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${password}</span></span></span><span class="hljs-string">" DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP PROFILE DEFAULT QUOTA UNLIMITED ON USERS """</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant connect to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create sequence to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create session to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create table to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) String metadata = JsonOutput.toJson([ <span class="hljs-string"><span class="hljs-string">"app.db.driverClass"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.url"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.username"</span></span>: username, <span class="hljs-string"><span class="hljs-string">"app.db.password"</span></span>: password ]) sql.execute(<span class="hljs-string"><span class="hljs-string">""" INSERT INTO </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> (id, metadata) values (?, ?) """</span></span>, [i, metadata]) } } }</code> </pre><br>  Os desenvolvedores t√™m seus pr√≥prios esquemas de depura√ß√£o e montagem, portanto, o uso do pool deve ser desativado: <br><br><pre> <code class="kotlin hljs"> project.ext.isCiBuild = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'pool.db.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) }</code> </pre><br>  Tomar e base livre: <br><br><pre> <code class="kotlin hljs"> task lockDb { dependsOn initDriver onlyIf isCiBuild doLast { project.ext.lockUid = UUID.randomUUID().toString() String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql sql.executeUpdate(<span class="hljs-string"><span class="hljs-string">"""UPDATE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> SET GUID = ?, PROCESSED = SYSDATE WHERE ID IN ( SELECT ID FROM ( SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE')) ) WHERE RN = 1 ) """</span></span>, [lockUid, <span class="hljs-number"><span class="hljs-number">15</span></span>]) def meta = sql.firstRow(<span class="hljs-string"><span class="hljs-string">"SELECT METADATA FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID = ?"</span></span>, [lockUid]) assert meta != <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"No free databases in pool"</span></span> def slurper = new JsonSlurper() Map metadata = slurper.parseText(meta[<span class="hljs-string"><span class="hljs-string">"METADATA"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Map localConfig.putAll(metadata) logger.info(<span class="hljs-string"><span class="hljs-string">"Database locked, {}"</span></span>, metadata) } } task unlockDb { dependsOn lockDb <span class="hljs-comment"><span class="hljs-comment">// init lockUid onlyIf isCiBuild doLast { try { String tableName = localConfig["pool.db.referenceTable"] Sql sql = createSqlInstance() as Sql sql.executeUpdate("UPDATE ${tableName} SET GUID = NULL WHERE GUID = ?", [lockUid]) logger.info("Database unlocked") } catch (ignored) { logger.error(ignored) } } }</span></span></code> </pre><br>  Se voc√™ concluir a montagem duas vezes seguidas, esquemas diferentes poder√£o ser selecionados e valores diferentes permanecer√£o ao montar os arquivos de propriedades.  Para lan√ßamentos locais, as configura√ß√µes s√£o est√°ticas. <br><br><pre> <code class="kotlin hljs"> configure([processResources, processTestResources]) { Task t -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (project.ext.isCiBuild()) { t.outputs.upToDateWhen { <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } t.filesMatching(<span class="hljs-string"><span class="hljs-string">'**/*.properties'</span></span>) { filter(ReplaceTokens, tokens: localConfig, beginToken: <span class="hljs-string"><span class="hljs-string">'${'</span></span>, endToken: <span class="hljs-string"><span class="hljs-string">'}'</span></span>) } }</code> </pre><br>  Tarefas para testar a revers√£o: <br><br><pre> <code class="kotlin hljs"> task restoreAfterRollbackTest(type: LiquibaseTask) { command = <span class="hljs-string"><span class="hljs-string">'update'</span></span> } task rollbackTest(type: LiquibaseTask) { dependsOn lockDb command = <span class="hljs-string"><span class="hljs-string">'rollback'</span></span> requiresValue = <span class="hljs-literal"><span class="hljs-literal">true</span></span> doFirst { project.ext.liquibaseCommandValue = localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.tag'</span></span>] } doLast { project.ext.liquibaseCommandValue = <span class="hljs-literal"><span class="hljs-literal">null</span></span> } }</code> </pre><br>  E configure a ordem de execu√ß√£o: <br><br><pre> <code class="kotlin hljs"> configure([project]) { tasks.withType(LiquibaseTask.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>) { LiquibaseTask t -&gt; logger.info(<span class="hljs-string"><span class="hljs-string">"Liquibase task {} must run after {}"</span></span>, t.getName(), configLiquibase.getName()) (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).dependsOn configLiquibase <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isCiBuild()) { logger.info(<span class="hljs-string"><span class="hljs-string">"Liquibase task {} must run after {}"</span></span>, t.getName(), lockDb.getName()) (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).dependsOn lockDb (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).finalizedBy unlockDb } } <span class="hljs-comment"><span class="hljs-comment">//   CI: // 1.    0 (dropAll) // 2.     rollback (update) // 3. ,       (rollback tag) // 4.      (update) // 5.     if (doRollbackTest()) { def setTaskOrdering = { List&lt;Task&gt; lst -&gt; for (int i = 0; i &lt; lst.size() - 1; i++) { logger.info("Task {} must run after {}", lst[i + 1].getName(), lst[i].getName()) lst[i + 1].dependsOn lst[i] } } setTaskOrdering([ lockDb, configLiquibase, dropAll, update, rollbackTest, restoreAfterRollbackTest, processTestResources, test, ]) lockDb.finalizedBy unlockDb test.finalizedBy unlockDb } }</span></span></code> </pre><br>  A aloca√ß√£o de banco de dados e o teste de revers√£o podem ser colocados em testes.  Maneiras de executar o c√≥digo antes e ap√≥s a conclus√£o de todos os testes: no Junit5, √© BeforeAllCallback, no TestNG BeforeSuite. <br><br>  Para a pergunta "por que o sql deve ser testado pelo programador java", a resposta √© que qualquer c√≥digo deve ser testado.  H√° exce√ß√µes e algum c√≥digo √© irracional para testar em um determinado momento. <br><br>  Eu gostaria de saber como o problema de testar a intera√ß√£o com o banco de dados √© resolvido por outros programadores?  Os cont√™ineres chegaram em todas as resid√™ncias ou os testes de integra√ß√£o foram repassados ‚Äã‚Äãaos ombros dos testadores? <br><br><div class="spoiler">  <b class="spoiler_title">Listagem completa</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.json.JsonOutput <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.json.JsonSlurper <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.sql.Sql <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.tools.ant.filters.ReplaceTokens <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.liquibase.gradle.LiquibaseTask plugins { id <span class="hljs-string"><span class="hljs-string">'java'</span></span> id <span class="hljs-string"><span class="hljs-string">'org.liquibase.gradle'</span></span> version <span class="hljs-string"><span class="hljs-string">'2.0.1'</span></span> } configurations { driver } repositories { jcenter() mavenCentral() maven { url = <span class="hljs-string"><span class="hljs-string">"http://www.datanucleus.org/downloads/maven2/"</span></span> } } dependencies { implementation <span class="hljs-string"><span class="hljs-string">'com.google.guava:guava:27.0.1-jre'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-core:5.1.7.RELEASE'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-context:5.1.7.RELEASE'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-jdbc:5.1.7.RELEASE'</span></span> testImplementation <span class="hljs-string"><span class="hljs-string">'junit:junit:4.12'</span></span> testImplementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-test:5.1.7.RELEASE'</span></span> testRuntime <span class="hljs-string"><span class="hljs-string">'oracle:ojdbc6:11.+'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'org.liquibase:liquibase-core:3.6.1'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'oracle:ojdbc6:11.+'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'org.yaml:snakeyaml:1.24'</span></span> driver group: <span class="hljs-string"><span class="hljs-string">"oracle"</span></span>, name: <span class="hljs-string"><span class="hljs-string">"ojdbc6"</span></span>, version: <span class="hljs-string"><span class="hljs-string">"11.+"</span></span> } project.ext.localConfig = new Properties() localConfig.load(file(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rootDir}</span></span></span><span class="hljs-string">/local.properties"</span></span>).newReader()) project.ext.isCiBuild = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'pool.db.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) } project.ext.doRollbackTest = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) } task configLiquibase { doLast { liquibase { activities { testdb { changeLogFile <span class="hljs-string"><span class="hljs-string">'changelog.yaml'</span></span> url localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.url'</span></span>] driver localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.driverClass'</span></span>] username localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.username'</span></span>] password localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.password'</span></span>] logLevel <span class="hljs-string"><span class="hljs-string">'debug'</span></span> classpath <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${project.projectDir}</span></span></span><span class="hljs-string">/db"</span></span> contexts <span class="hljs-string"><span class="hljs-string">'main'</span></span> } runList = <span class="hljs-string"><span class="hljs-string">'testdb'</span></span> } } } } task initDriver { doLast { ClassLoader loader = GroovyObject.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.classLoader configurations.driver.each { File file -&gt; loader.addURL(file.toURL()) } } } project.ext.createSqlInstance = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Sql.newInstance( url: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], user: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.username"</span></span>], password: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.password"</span></span>], driver: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>]) } task initDbPool { dependsOn initDriver doLast { Integer poolSize = <span class="hljs-number"><span class="hljs-number">10</span></span> Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] String baseName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.baseName"</span></span>] String basePass = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.basePass"</span></span>] String token = <span class="hljs-string"><span class="hljs-string">"{id}"</span></span> List tableExists = sql.rows(<span class="hljs-string"><span class="hljs-string">"select table_name from all_tables where table_name=?"</span></span>, [tableName]) assert tableExists.isEmpty() sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE TABLE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> ( ID NUMBER(2) NOT NULL PRIMARY KEY, METADATA VARCHAR2(200) NOT NULL, PROCESSED TIMESTAMP NULL, GUID VARCHAR2(36) NULL) """</span></span>, []) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Integer i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; poolSize ; i++) { String username = baseName.replace(token, i.toString()) String password = basePass.replace(token, i.toString()) sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE USER </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string"> IDENTIFIED BY "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${password}</span></span></span><span class="hljs-string">" DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP PROFILE DEFAULT QUOTA UNLIMITED ON USERS """</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant connect to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create sequence to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create session to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create table to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) String metadata = JsonOutput.toJson([ <span class="hljs-string"><span class="hljs-string">"app.db.driverClass"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.url"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.username"</span></span>: username, <span class="hljs-string"><span class="hljs-string">"app.db.password"</span></span>: password ]) sql.execute(<span class="hljs-string"><span class="hljs-string">""" INSERT INTO </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> (id, metadata) values (?, ?) """</span></span>, [i, metadata]) } } } task lockDb { dependsOn initDriver onlyIf isCiBuild doLast { project.ext.lockUid = UUID.randomUUID().toString() String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql sql.executeUpdate(<span class="hljs-string"><span class="hljs-string">"""UPDATE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> SET GUID = ?, PROCESSED = SYSDATE WHERE ID IN ( SELECT ID FROM ( SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE')) ) WHERE RN = 1 ) """</span></span>, [lockUid, <span class="hljs-number"><span class="hljs-number">15</span></span>]) def meta = sql.firstRow(<span class="hljs-string"><span class="hljs-string">"SELECT METADATA FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID = ?"</span></span>, [lockUid]) assert meta != <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"No free databases in pool"</span></span> def slurper = new JsonSlurper() Map metadata = slurper.parseText(meta[<span class="hljs-string"><span class="hljs-string">"METADATA"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Map localConfig.putAll(metadata) logger.info(<span class="hljs-string"><span class="hljs-string">"Database locked, {}"</span></span>, metadata) } } task unlockDb { dependsOn lockDb <span class="hljs-comment"><span class="hljs-comment">// init lockUid onlyIf isCiBuild doLast { try { String tableName = localConfig["pool.db.referenceTable"] Sql sql = createSqlInstance() as Sql sql.executeUpdate("UPDATE ${tableName} SET GUID = NULL WHERE GUID = ?", [lockUid]) logger.info("Database unlocked") } catch (ignored) { logger.error(ignored) } } } configure([processResources, processTestResources]) { Task t -&gt; if (project.ext.isCiBuild()) { t.outputs.upToDateWhen { false } } t.filesMatching('**/*.properties') { filter(ReplaceTokens, tokens: localConfig, beginToken: '${', endToken: '}') } } task restoreAfterRollbackTest(type: LiquibaseTask) { command = 'update' } task rollbackTest(type: LiquibaseTask) { dependsOn lockDb command = 'rollback' requiresValue = true doFirst { project.ext.liquibaseCommandValue = localConfig['test.rollback.tag'] } doLast { project.ext.liquibaseCommandValue = null } } configure([project]) { tasks.withType(LiquibaseTask.class) { LiquibaseTask t -&gt; logger.info("Liquibase task {} must run after {}", t.getName(), configLiquibase.getName()) (t as Task).dependsOn configLiquibase if (isCiBuild()) { logger.info("Liquibase task {} must run after {}", t.getName(), lockDb.getName()) (t as Task).dependsOn lockDb (t as Task).finalizedBy unlockDb } } //   CI: // 1.    0 (dropAll) // 2.     rollback (update) // 3. ,       (rollback tag) // 4.      (update) // 5.     if (doRollbackTest()) { def setTaskOrdering = { List&lt;Task&gt; lst -&gt; for (int i = 0; i &lt; lst.size() - 1; i++) { logger.info("Task {} must run after {}", lst[i + 1].getName(), lst[i].getName()) lst[i + 1].dependsOn lst[i] } } setTaskOrdering([ lockDb, configLiquibase, dropAll, update, rollbackTest, restoreAfterRollbackTest, processTestResources, test, ]) lockDb.finalizedBy unlockDb test.finalizedBy unlockDb } }</span></span></code> </pre><br><pre> <code class="bash hljs">pool.db.enabled=<span class="hljs-literal"><span class="hljs-literal">false</span></span> test.rollback.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> pool.db.driverClass=oracle.jdbc.driver.OracleDriver pool.db.url=jdbc:oracle:thin:@localhost:1527:ORCLCDB pool.db.username=SYSTEM pool.db.password=Oradoc_db1 pool.db.referenceTable=c<span class="hljs-comment"><span class="hljs-comment">##test_user1.REF_TABLE pool.db.baseName=C##CI_SCHEMA_{id} pool.db.basePass=CI_SCHEMA_{id}_PASS app.db.driverClass= app.db.url= app.db.username= app.db.password= test.rollback.tag=version_1</span></span></code> </pre><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt452722/">https://habr.com/ru/post/pt452722/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt452706/index.html">Em 1983, este computador da Bella Labs se tornou o primeiro grande mestre.</a></li>
<li><a href="../pt452712/index.html">Como tentamos trabalhar em equipe e o que aconteceu</a></li>
<li><a href="../pt452714/index.html">Preste aten√ß√£o # 5: Resumo de artigos sobre pensamento de produto, psicologia comportamental e produtividade</a></li>
<li><a href="../pt452716/index.html">Em busca de um ponto √≥timo de aplica√ß√£o de recursos humanos</a></li>
<li><a href="../pt452718/index.html">PsyGuide: D√©ficit de aten√ß√£o. # 0001/1001</a></li>
<li><a href="../pt452724/index.html">Phoenix LiveView: quando o c√≥digo javascript √© divertido *</a></li>
<li><a href="../pt452726/index.html">Cute bones 3D: material √≥sseo hiperel√°stico para defeitos pl√°sticos do cr√¢nio</a></li>
<li><a href="../pt452730/index.html">Certifica√ß√£o de sistemas de informa√ß√£o sob o princ√≠pio de segmentos padr√£o. Mitos e Realidade</a></li>
<li><a href="../pt452734/index.html">Migre automaticamente aplicativos iOS (ARM) para o macOS (x86) usando o Bitcode</a></li>
<li><a href="../pt452736/index.html">Criptografia de mensagens em SecureDialogues</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>