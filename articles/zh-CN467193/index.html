<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎃 🐹 😈 带有“天堂之门”的矿工病毒 🗾 👐🏼 🌆</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="大家好！ 预期在逆向工程课程中将有新的流派开始，我们正在与您分享非常有趣的材料的翻译。 享受阅读 



 最近两年可以称为勒索软件黑客的年份。 毫无疑问，勒索软件是最受欢迎的恶意软件类型。 但是，在去年年底，我们开始观察到他们的受欢迎程度下降，并且对矿工的支持增加。 这种趋势有可能在2018年只会...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>带有“天堂之门”的矿工病毒</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/467193/"> 大家好！ 预期在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">逆向工程</a>课程中将有新的流派开始<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">，我们正在</a>与您分享非常有趣的材料的翻译。 享受阅读 <br><br><img src="https://habrastorage.org/webt/ob/ex/ue/obexuezayzkv5cwefrnqwi2j7_8.png"><br><hr><br> 最近两年可以称为勒索软件黑客的年份。 毫无疑问，勒索软件是最受欢迎的恶意软件类型。 但是，在去年年底，我们开始观察到他们的受欢迎程度下降，并且对矿工的支持增加。 这种趋势有可能在2018年只会增长。 <a name="habracut"></a><br><br> 从受害者的角度来看，这是一种解脱，因为矿工没有勒索软件那么危险。 是的，它们会降低系统速度，但是一旦您摆脱它们，便可以像以前一样继续使用计算机。 您的数据不会像勒索软件病毒那样被盗或丢失。 <br><br> 从恶意软件研究人员的角度来看，矿工令人失望。 它们没有提供足够的新材料来进行更深入的分析，主要是因为它们基于众所周知的开放源代码组件，几乎没有混淆或隐蔽。 <br><br> 但是，我们不时发现使用有趣技巧的矿工。 我们最近观看了一种称为“天堂之门”的技术，该技术允许从32位引导加载程序注入到64位进程中。 这个想法并不是什么新鲜事，它的第一个实现可以追溯到2009年，但是有趣的是，它是如何以一种新的形式实现的，可以直接从野外获得。 <br><br> 病毒分析初学者可以阅读有关什么是天堂之门以及如何进行分析的指南。 <br><br><h3> 分析材料 </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">7b3491e0028d443f11989efaeb0fbec2-</a>第一个滴管； </li></ul><br> 这种模式是在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Ngay</a>运动的延续中找到的（在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处有</a>更多<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">信息</a> ）。 查看此类样本的传记后，我看到了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">@_qaz_qaz</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文章</a> ，该<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文章</a>描述了具有类似样本的早期运动。 但是，他的分析不包括“天堂之门”技术。 <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ed575ba72ea8b41ac2c31c8c39ce303b-</a>第二个滴管； </li><li>  ca54fa2cf8a7e3e2cd457811f336de44-32位引导程序。 </li></ul><br><h3> 行为分析 </h3><br> 要查看所提到的注入，我们必须在64位系统上运行该示例。 我们看到它通过特定于加密货币挖掘的参数启动了笔记本的本质： <br><br><img src="https://habrastorage.org/webt/j8/2m/wu/j82mwua73429bcc1dxa1krt7g6g.png"><br><br> 通过查看ProcessExplorer中的内存行，我们看到这不是真正的笔记本，而是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">XMRig</a> Monero <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">矿工</a> 。 <br><br><img src="https://habrastorage.org/webt/xj/st/jn/xjstjnrjz3pq90ujlsn1iulrsmu.png"><br><br> 因此，目前，我们确定内存中笔记本的图像很可能已被RunPE（过程镂空）方法所取代。 <br><br> 主删除器是32位的，但是将有效负载转移到了64位的笔记本电脑上： <br><br><img src="https://habrastorage.org/webt/ks/tq/3f/kstq3f74qii0rguaotcf4ng0hls.png"><br><br> 最有趣的是，官方的Windows API不支持这种类型的注入。 我们可以从64位应用程序（使用WoW64 API）读取/写入32位进程的内存，但反之则不行。 <br><br> 但是，有一些非官方的解决方案，例如称为“天堂之门”的技术。 <br><br><h3> 天堂之门评论 </h3><br> 天堂之门技术最早是由一位绰号为Roy G.Biv的黑客于2009年描述的。 后来，创建了许多实现，例如<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Wow64ext</a>库或基于它的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">W64oWoW64</a> 。  Alex Ionescu在2015年的博客中描述了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">针对这项技术的措施</a> 。 <br> 让我们看看它是如何工作的。 <br><br><h3> 在64位Windows上运行32位进程 </h3><br> 在64位版本的Windows上运行的每个32位进程都在模拟32位环境的特殊<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">WoW64</a>子系统上运行。 您可以使用在64位进程中创建的32位沙箱进行类比。 因此，首先，创建一个64位进程环境。 并且已经在其中创建了32位环境。 该应用程序在此32位环境中运行，但无法访问其64位部分。 <br><br> 如果我们使用64位扫描程序从外部扫描32位进程，则将看到内部具有32和64位DLL。 最重要的是，它具有两个版本的NTDLL：32位（从SysWow64目录加载）和64位（从System32目录加载）： <br><br><img src="https://habrastorage.org/webt/jp/kq/im/jpkqimhiu4fa-y1w1uwwq1up6ga.png"><br><br> 但是，32位进程本身看不到64位部分，并且仅限于使用32位DLL。 要注入64位进程，您需要使用相应功能的64位版本。 <br><br><h3> 代码段 </h3><br> 要访问环境的受限部分，我们需要了解隔离是如何完成的。 事实证明，一切都非常简单。 可通过不同的代码段地址执行32位和64位代码执行：32位-0x23和64位-0x33。 <br><br> 如果我们以通常的方式调用该地址，则默认情况下会设置用于解释该地址的模式。 但是，我们可以使用汇编代码显式请求更改。 <br><br><h3> 矿工内部：天堂之门的实现 </h3><br> 我不会对这个矿工进行全面的分析，因为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a>已经对此进行了描述。 让我们直接去有趣的地方。 该恶意程序检查其环境，并且如果检测到它在64位系统上运行，则使用另一种方式注入64位进程： <br><br><img src="https://habrastorage.org/webt/gz/kw/ll/gzkwlluwayyv5qawjrd6bngp0-o.png"><br><br> 经过一些反分析检查后，它将创建一个新的暂停的64位进程（在本例中为记事本）： <br><br><img src="https://habrastorage.org/webt/ey/ne/fj/eynefjkyabjcaqfkrwqc3hm9qe4.png"><br><br> 这是将要实施恶意负载的目标。 <br> 如前所述，为了将有效负载嵌入到64位进程中，我们需要使用适当的64位函数。 <br><br> 首先，引导程序通过64位NTDLL处理： <br><br><img src="https://habrastorage.org/webt/mo/jj/bw/mojjbw2ddkok1n4weobjayjx4zu.png"><br><br>  <code>get_ntdll</code>函数内部发生的情况需要更详细的说明。 作为说明，我们还可以看一下ReWolf库中的类似<a href="">代码</a> 。 <br><br> 要访问流程环境的64位部分，我们需要使用段选择器。 让我们看看恶意软件如何进入64位模式。 <br><br><img src="https://habrastorage.org/webt/yh/hw/7m/yhhw7mgp_g2ub-y4nqnabhj4vb8.png"><br><br> 似乎这段代码是直接从开放库中复制的： <a href="">https</a> : <a href="">//github.com/rwfpl/rewolf-wow64ext/blob/master/src/internal.h#L26</a> <br><br> 段选择器0x33被压入堆栈。 然后，恶意软件调用以下行：（通过这种方式，下一行的地址也被压入堆栈。） <br><br><img src="https://habrastorage.org/webt/6o/bk/dl/6obkdlrqkdlurnpfrfzlc9axvdw.png"><br><br>  <code>retf</code>堆栈的地址通过添加5个字节来固定，并在<code>retf</code>之后设置： <br><br><img src="https://habrastorage.org/webt/zk/8t/5h/zk8t5hpbn68ngyilrkgldw5gv-g.png"><br><br> 最后，将调用RETF语句。  RETF是“远期回报”，与常规RET不同，它允许您不仅指定要继续执行的地址，还指定一个段。 作为参数，它从堆栈中取出两个DWORD。 因此，当执行RETF时，返回的返回地址变为： <br><br>  <b>0x33：0x402A50</b> <br><br> 由于更改了段，因此将从指定地址开始的代码解释为64位。 因此，调试器看到的代码是32位... <br><br><img src="https://habrastorage.org/webt/kw/h8/7t/kwh87tqwggznnqzoxjf8elqt9ds.png"><br><br>  ...实际上是64位。 <br><br> 为了快速切换视图，我使用了PE-bear功能： <br><br><img src="https://habrastorage.org/webt/t0/7o/_w/t07o_w2ib83ptd1gfnldc0cposg.png"><br><br> 如果这段代码被解释为64位，则如下所示： <br><br><img src="https://habrastorage.org/webt/c8/a2/1d/c8a21dbp7ot9hzx3ipb5-jkwhfo.png"><br><br> 因此，此处执行的代码负责将寄存器R12的内容移至堆栈上的变量，然后切换回32位模式。 这样做是为了获得64位<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">线程信息块（TEB）</a> ，从这里我们从中获得64位<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">进程环境块（PEB）</a> -我们看一看<a href="">类似的代码</a> 。 <br><br>  64位PEB用作查找64位版本的NTDLL的起点。 这部分的实现非常<a href="">简单</a> （使用此方法的“原始”实现可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a>找到），使用指向已加载库的指针，该库是PEB结构中的字段之一。 因此，从PEB中，我们得到一个名为<i>Ldr</i>的字段： <br><br><img src="https://habrastorage.org/webt/y-/fi/v-/y-fiv-utn-eenbgynck30v3rxp4.png"><br><br>  <b><i>Ldr</i></b>是<code>_PEB_LDR_DATA</code>类型的结构。 它包含一个名为<code>InMemoryOrderModuleList</code>的条目： <br><br><img src="https://habrastorage.org/webt/ri/oi/hk/rioihkllxtn7jcj_rs0i39jpegs.png"><br><br> 此列表包含正在研究的进程的内存中存在的所有已加载库。 我们遍历列表，直到找到我们感兴趣的库，在本例中为NTDLL。 这正是上面的<code>get_ntdll</code>函数<code>get_ntdll</code> 。 为了找到合适的名称，它调用以下函数，指定为<code>is_ntdll_lib</code> ，该函数通过字符对照ntdll.dll检查库名称。 相当于<a href="">这段</a>代码。 <br><br><img src="https://habrastorage.org/webt/se/zc/e9/sezce9ivnb5hccvl5gahlmnveqg.png"><br><br> 如果名称匹配，则库地址将返回到几个寄存器： <br><br><img src="https://habrastorage.org/webt/as/_r/mo/as_rmojmqloqtgrbwwoh7cnafpi.png"><br><br> 找到NTDLL后，我们只需要获取相应函数的地址即可。 我们可以通过查看库导出表来做到这一点： <br><br><img src="https://habrastorage.org/webt/jl/oa/mm/jloamm2asyt0a3-xbwqnpawmwic.png"><br><br> 检索以下功能： <br><br><ul><li>  <i>NttUnmapViewOfSection</i> </li><li>  <i>NtGetContextThread</i> </li><li>  <i>NtAllocateVirtualMemory</i> </li><li>  <i>NtReadVirtualMemory</i> </li><li>  <i>NtWriteVirtualMemory</i> </li><li>  <i>NtSetContextThread。</i> </li></ul><br> 众所周知，这些功能是RunPE技术的典型功能。 首先，NtUnmapViewOfSection用于取消映射原始PE文件。 然后，在远程过程中，将分配内存并写入新的PE。 最后，更改过程上下文，以便从嵌入式模块开始执行。 <br><br> 函数地址被存储并在以后调用（类似于<a href="">此</a>代码）以控制远程进程。 <br><br><h3> 结论 </h3><br> 到目前为止，矿工的作者还没有表现出太多的创造力。 他们依靠开源组件来实现自己的目标。 所描述的情况很好地反映了这种趋势，因为使用了现成的实现。 <br><br> 天堂之门已经存在好几年了。 一些恶意程序使用它来增加<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">隐身性</a> 。 但是对于这种矿机，作者可能希望通过使用最适合目标体系结构的有效负载来最大化性能。 <br><br> 仅此而已。 您可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在这里</a>找到有关我们课程的更多信息。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN467193/">https://habr.com/ru/post/zh-CN467193/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN467183/index.html">研究2019年排名前50位的聊天机器人平台和虚拟助手</a></li>
<li><a href="../zh-CN467185/index.html">下坡坡度</a></li>
<li><a href="../zh-CN467187/index.html">创建最新的技术库</a></li>
<li><a href="../zh-CN467189/index.html">温度采样</a></li>
<li><a href="../zh-CN467191/index.html">我们如何制作Vivaldi for Android</a></li>
<li><a href="../zh-CN467197/index.html">JVM内部如何实现多态</a></li>
<li><a href="../zh-CN467199/index.html">汤姆·亨特日记：《巴斯克维尔猎犬》</a></li>
<li><a href="../zh-CN467201/index.html">CacheBrowser实验：使用内容缓存绕过没有代理的中文防火墙</a></li>
<li><a href="../zh-CN467203/index.html">仅仅进行除法运算，或如何创建数学理论并从中获得40万美元。 系列二，倒数第二</a></li>
<li><a href="../zh-CN467205/index.html">我们开发了一个将数据发送到其他应用程序的应用程序（生态系统应用程序）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>