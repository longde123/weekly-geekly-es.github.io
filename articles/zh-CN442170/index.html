<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â²ï¸ ğŸ¡ ğŸ§ æˆ‘ä»¬æ­£åœ¨å‡†å¤‡åœ¨Postgresä¸­è¿›è¡Œå…¨æ–‡æœç´¢ã€‚ ç¬¬ä¸€éƒ¨åˆ† ğŸ‘©ğŸ¾â€ğŸ¤â€ğŸ‘©ğŸ» ğŸ”  ğŸ‘¨ğŸ¿â€ğŸŒ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="UPD ç¬¬äºŒéƒ¨åˆ† 


 æœ¬æ–‡æ˜¯æœ‰å…³å¦‚ä½•åœ¨PostgreSQLä¸­æœ€ä½³é…ç½®å…¨æ–‡æœ¬æœç´¢çš„ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸€éƒ¨åˆ†ã€‚ æˆ‘æœ€è¿‘ä¸å¾—ä¸åœ¨å·¥ä½œä¸­è§£å†³ä¸€ä¸ªç±»ä¼¼çš„é—®é¢˜-å¯¹äºåœ¨æ­¤ä¸»é¢˜ä¸Šè‡³å°‘ç¼ºå°‘ä¸€äº›ç†æ™ºçš„ææ–™ï¼Œæˆ‘æ„Ÿåˆ°éå¸¸æƒŠè®¶ã€‚ æˆ‘çš„æˆ˜æ–—ç»éªŒå¾ˆä¸°å¯Œã€‚ 
 é¢†å¸¦ 


 æˆ‘æ”¯æŒä¸€ä¸ªç›¸å¯¹è¾ƒå¤§çš„é¡¹ç›®ï¼Œè¯¥é¡¹ç›®å¯ä»¥å¯¹æ–‡æ¡£è¿›è¡Œå…¬å¼€æœç´¢ã€‚ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æˆ‘ä»¬æ­£åœ¨å‡†å¤‡åœ¨Postgresä¸­è¿›è¡Œå…¨æ–‡æœç´¢ã€‚ ç¬¬ä¸€éƒ¨åˆ†</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442170/"><p>  <strong>UPD</strong>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¬¬äºŒéƒ¨åˆ†</a> </p><br><p> æœ¬æ–‡æ˜¯æœ‰å…³å¦‚ä½•åœ¨PostgreSQLä¸­<em>æœ€ä½³</em>é…ç½®å…¨æ–‡æœ¬æœç´¢çš„ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸€éƒ¨åˆ†ã€‚ æˆ‘æœ€è¿‘ä¸å¾—ä¸åœ¨å·¥ä½œä¸­è§£å†³ä¸€ä¸ªç±»ä¼¼çš„é—®é¢˜-å¯¹äºåœ¨æ­¤ä¸»é¢˜ä¸Šè‡³å°‘ç¼ºå°‘ä¸€äº›ç†æ™ºçš„ææ–™ï¼Œæˆ‘æ„Ÿåˆ°éå¸¸æƒŠè®¶ã€‚ æˆ‘çš„æˆ˜æ–—ç»éªŒå¾ˆä¸°å¯Œã€‚ </p><a name="habracut"></a><br><h2 id="zavyazka"> é¢†å¸¦ </h2><br><p> æˆ‘æ”¯æŒä¸€ä¸ªç›¸å¯¹è¾ƒå¤§çš„é¡¹ç›®ï¼Œè¯¥é¡¹ç›®å¯ä»¥å¯¹æ–‡æ¡£è¿›è¡Œå…¬å¼€æœç´¢ã€‚ è¯¥æ•°æ®åº“åŒ…å«çº¦500,000ä¸ªæ–‡æ¡£ï¼Œæ€»å®¹é‡çº¦ä¸º3.6 GBã€‚ æœç´¢çš„æœ¬è´¨æ˜¯ï¼šç”¨æˆ·å¡«å†™ä¸€ä¸ªè¡¨æ ¼ï¼Œå…¶ä¸­æ—¢æœ‰å…¨æ–‡æŸ¥è¯¢ï¼Œåˆæœ‰æ•°æ®åº“ä¸­å„ä¸ªå­—æ®µï¼ˆåŒ…æ‹¬join-sï¼‰è¿›è¡Œçš„è¿‡æ»¤ã€‚ </p><br><p> æœç´¢é€šè¿‡Sphinxè¿›è¡Œäº†å·¥ä½œï¼ˆæˆ–æ›´æœ‰æ•ˆï¼‰ï¼Œä½†æ•ˆæœä¸æ˜¯å¾ˆå¥½ã€‚ ä¸»è¦é—®é¢˜å¦‚ä¸‹ï¼š </p><br><ol><li> ç´¢å¼•æ¶ˆè€—äº†å¤§çº¦8 GBçš„RAMã€‚ åœ¨å…·æœ‰8 GB RAMçš„æœåŠ¡å™¨ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚ å†…å­˜äº¤æ¢ï¼Œå¯¼è‡´äº†<em>ç³Ÿç³•çš„</em>æ€§èƒ½ã€‚ </li><li> è¯¥ç´¢å¼•åœ¨å¤§çº¦40åˆ†é’Ÿå†…å»ºç«‹ã€‚ æ¯«æ— ç–‘é—®ï¼Œæœç´¢ç»“æœæ˜¯å¦ä¸€è‡´ï¼›ç´¢å¼•æ¯å¤©å‘å¸ƒä¸€æ¬¡ã€‚ </li><li>æœç´¢å·¥ä½œäº†<em>å¾ˆé•¿æ—¶é—´</em> ã€‚ è¿›è¡Œäº†ç‰¹åˆ«é•¿æ—¶é—´çš„è¯·æ±‚ï¼Œè¿™å¯¹åº”äºå¤§é‡æ–‡æ¡£ï¼šå¿…é¡»å°†å¤§é‡id-shnikä»ç‹®èº«äººé¢åƒä¼ è¾“åˆ°æ•°æ®åº“ï¼Œå¹¶æ ¹æ®åç«¯çš„ç›¸å…³æ€§è¿›è¡Œæ’åºã€‚ </li></ol><br><p> ç”±äºè¿™äº›é—®é¢˜ï¼Œå‡ºç°äº†ä»»åŠ¡-ä¼˜åŒ–å…¨æ–‡æœç´¢ã€‚ æ­¤ä»»åŠ¡æœ‰ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆï¼š </p><br><ol><li> æ”¶ç´§Sphinxï¼šé…ç½®å®æ—¶ç´¢å¼•ï¼Œå°†è¦è¿‡æ»¤çš„å±æ€§å­˜å‚¨åœ¨ç´¢å¼•ä¸­ã€‚ </li><li> ä½¿ç”¨å†…ç½®çš„FTS PostgreSQLã€‚ </li></ol><br><p> å†³å®šå®æ–½ç¬¬äºŒç§è§£å†³æ–¹æ¡ˆï¼šè¿™æ ·ï¼Œæ‚¨å¯ä»¥æœ¬åœ°æä¾›ç´¢å¼•çš„è‡ªåŠ¨æ›´æ–°ï¼Œæ‘†è„±ä¸¤ä¸ªæœåŠ¡ä¹‹é—´çš„<em>é•¿æ—¶é—´</em>é€šä¿¡ï¼Œå¹¶ç›‘è§†ä¸€ä¸ªæœåŠ¡è€Œä¸æ˜¯ä¸¤ä¸ªæœåŠ¡ã€‚ </p><br><p> è¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚ ä½†æ˜¯é—®é¢˜æ‘†åœ¨é¢å‰ã€‚ </p><br><p> è®©æˆ‘ä»¬ä»å¤´å¼€å§‹ã€‚ </p><br><h2 id="naivno-ispolzuem-polnotekstovyy-poisk"> æˆ‘ä»¬å¤©çœŸåœ°ä½¿ç”¨å…¨æ–‡æœç´¢ </h2><br><p>å¦‚æ–‡æ¡£æ‰€è¿°ï¼Œå…¨æ–‡æœ¬æœç´¢éœ€è¦ä½¿ç”¨<code>tsvector</code>å’Œ<code>tsquery</code> ã€‚ ç¬¬ä¸€ä¸ªä»¥æœç´¢ä¼˜åŒ–çš„å½¢å¼å­˜å‚¨æ–‡æ¡£çš„æ–‡æœ¬ï¼Œç¬¬äºŒä¸ªä»¥å…¨æ–‡æŸ¥è¯¢çš„å½¢å¼å­˜å‚¨ã€‚ </p><br><p> è¦æœç´¢PostgreSQLï¼Œæœ‰å‡½æ•°<code>to_tsvector</code> ï¼Œ <code>plainto_tsquery</code> ï¼Œ <code>to_tsquery</code> ã€‚ è¦å¯¹ç»“æœè¿›è¡Œæ’åï¼Œè¯·ä½¿ç”¨<code>ts_rank</code> ã€‚ å®ƒä»¬çš„ç”¨æ³•å¾ˆç›´è§‚ï¼Œå¹¶ä¸”åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡æ¡£ä¸­</a>æœ‰å¾ˆå¥½çš„æè¿°ï¼Œå› æ­¤æˆ‘ä»¬ä¸å†èµ˜è¿°å®ƒä»¬çš„ç”¨æ³•ã€‚ </p><br><p> ä½¿ç”¨å®ƒä»¬çš„ä¼ ç»Ÿæœç´¢æŸ¥è¯¢å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id, ts_rank(to_tsvector("document_text"), plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> documents_document <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> to_tsvector("document_text") @@ plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ts_rank(to_tsvector("document_text"), plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre> <br><p> æˆ‘ä»¬æ¨å¯¼å‡ºæ–‡æœ¬ä¸­å¸¦æœ‰â€œæŸ¥è¯¢â€ä¸€è¯çš„æ–‡æ¡£IDï¼Œå¹¶æŒ‰ç›¸å…³æ€§ä»é«˜åˆ°ä½çš„é¡ºåºå¯¹å…¶è¿›è¡Œæ’åºã€‚ ä¸€åˆ‡ä¼¼ä¹éƒ½è¿˜å¥½å—ï¼Ÿ ä¸è¡Œ </p><br><p> ä¸Šé¢çš„æ–¹æ³•æœ‰å¾ˆå¤šç¼ºç‚¹ï¼š </p><br><ol><li> æˆ‘ä»¬ä¸ä½¿ç”¨ç´¢å¼•è¿›è¡Œæœç´¢ã€‚ </li><li> è¡¨æ ¼çš„æ¯ä¸€è¡Œéƒ½ä¼šè°ƒç”¨ts_vectorå‡½æ•°ã€‚ </li><li> å¯¹è¯¥è¡¨çš„æ¯ä¸€è¡Œè°ƒç”¨ts_rankå‡½æ•°ã€‚ </li></ol><br><p> æ‰€æœ‰è¿™äº›å¯¼è‡´æœç´¢èŠ±è´¹<em>å¾ˆ</em>é•¿æ—¶é—´çš„äº‹å®ã€‚ åœ¨æˆ˜æ–—åŸºç¡€ä¸Šè§£é‡Šç»“æœï¼š </p><br><pre> <code class="plaintext hljs">Gather Merge (actual time=420289.477..420313.969 rows=58742 loops=1) Workers Planned: 2 Workers Launched: 2 -&gt; Sort (actual time=420266.150..420267.935 rows=19581 loops=3) Sort Key: (ts_rank(to_tsvector(document_text), plainto_tsquery(''::text))) DESC Sort Method: quicksort Memory: 2278kB -&gt; Parallel Seq Scan on documents_document (actual time=65.454..420235.446 rows=19581 loops=3) Filter: (to_tsvector(document_text) @@ plainto_tsquery(''::text)) Rows Removed by Filter: 140636 Planning time: 3.706 ms Execution time: 420315.895 ms</code> </pre> <br><p>  420ç§’ï¼ ä¸€ä¸ªè¯·æ±‚ï¼ </p><br><p> è¯¥åŸºåœ°è¿˜äº§ç”Ÿäº†å¾ˆå¤šå½¢å¼çš„<code>[54000] word is too long to be indexed</code> ã€‚ ä¸ç”¨æ‹…å¿ƒã€‚ åŸå› æ˜¯åœ¨æˆ‘çš„æ•°æ®åº“ä¸­æ˜¯åœ¨æ‰€è§å³æ‰€å¾—ç¼–è¾‘å™¨ä¸­åˆ›å»ºçš„æ–‡æ¡£ã€‚ å®ƒæ’å…¥äº†å¾ˆå¤š åœ¨ä»»ä½•å¯èƒ½çš„åœ°æ–¹ï¼Œå¹¶ä¸”è¿ç»­5.4ä¸‡ã€‚  Postgresä¼šå¿½ç•¥æ­¤é•¿åº¦çš„å•è¯ï¼Œå¹¶å†™å‡ºæ— æ³•ç¦ç”¨çš„vorningã€‚ </p><br><p> æˆ‘ä»¬å°†å°è¯•è§£å†³æ‰€æœ‰æåˆ°çš„é—®é¢˜ï¼Œå¹¶åŠ å¿«æœç´¢é€Ÿåº¦ã€‚ </p><br><h2 id="naivno-optimiziruem-poisk"> æˆ‘ä»¬å¤©çœŸåœ°ä¼˜åŒ–äº†æœç´¢ </h2><br><p> å½“ç„¶ï¼Œæˆ‘ä»¬ä¸ä¼šä½¿ç”¨æˆ˜æ–—åŸºåœ°-æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæµ‹è¯•åŸºåœ°ã€‚ å®ƒåŒ…å«çº¦12,000ä¸ªæ–‡æ¡£ã€‚ ç¤ºä¾‹ä¸­çš„è¯·æ±‚åœ¨35ç§’å·¦å³çš„æ—¶é—´å†…æ‰§è¡Œã€‚ æ¼«é•¿çš„æ—¶é—´ï¼ </p><br><div class="spoiler">  <b class="spoiler_title">è¯´æ˜ç»“æœ</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Sort (actual time=35431.874..35432.208 rows=3593 loops=1) Sort Key: (ts_rank(to_tsvector(document_text), plainto_tsquery(''::text))) DESC Sort Method: quicksort Memory: 377kB -&gt; Seq Scan on documents_document (actual time=8.470..35429.261 rows=3593 loops=1) Filter: (to_tsvector(document_text) @@ plainto_tsquery(''::text)) Rows Removed by Filter: 9190 Planning time: 0.200 ms Execution time: 35432.294 ms</code> </pre> </div></div><br><h3 id="indeks"> ç´¢å¼• </h3><br><p> é¦–å…ˆï¼Œå½“ç„¶ï¼Œæ‚¨éœ€è¦æ·»åŠ ä¸€ä¸ªç´¢å¼•ã€‚ æœ€ç®€å•çš„æ–¹æ³•ï¼šåŠŸèƒ½ç´¢å¼•ã€‚ </p><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> idx_gin_document <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> documents_document <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> gin (to_tsvector(<span class="hljs-string"><span class="hljs-string">'russian'</span></span>, "document_text"));</code> </pre> <br><p> è¿™æ ·çš„ç´¢å¼•å°†åˆ›å»ºå¾ˆé•¿æ—¶é—´-åœ¨æµ‹è¯•åŸºç¡€ä¸ŠèŠ±è´¹äº†å¤§çº¦26ç§’ã€‚ ä»–éœ€è¦éå†æ•°æ®åº“ï¼Œå¹¶ä¸ºæ¯ä¸ªè®°å½•è°ƒç”¨to_tsvectorå‡½æ•°ã€‚ å°½ç®¡å®ƒä»ç„¶å¯ä»¥å°†æœç´¢é€Ÿåº¦æé«˜åˆ°12ç§’ï¼Œä½†å®ƒçš„é•¿åº¦ä»ç„¶æ— æ³•åŸè°…ï¼ </p><br><div class="spoiler">  <b class="spoiler_title">è¯´æ˜ç»“æœ</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Sort (actual time=12213.943..12214.327 rows=3593 loops=1) Sort Key: (ts_rank(to_tsvector('russian'::regconfig, document_text), plainto_tsquery(''::text))) DESC Sort Method: quicksort Memory: 377kB -&gt; Bitmap Heap Scan on documents_document (actual time=3.849..12212.248 rows=3593 loops=1) Recheck Cond: (to_tsvector('russian'::regconfig, document_text) @@ plainto_tsquery(''::text)) Heap Blocks: exact=946 -&gt; Bitmap Index Scan on idx_gin_document (actual time=0.427..0.427 rows=3593 loops=1) Index Cond: (to_tsvector('russian'::regconfig, document_text) @@ plainto_tsquery(''::text)) Planning time: 0.109 ms Execution time: 12214.452 ms</code> </pre> </div></div><br><h3 id="mnogokratnyy-vyzov-to_tsvector"> é‡å¤è°ƒç”¨<code>to_tsvector</code> </h3><br><p> è¦è§£å†³æ­¤é—®é¢˜ï¼Œæ‚¨éœ€è¦å°†<code>tsvector</code>å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚ å½“ç„¶ï¼Œåœ¨æ›´æ”¹åŒ…å«æ–‡æ¡£çš„è¡¨ä¸­çš„æ•°æ®æ—¶ï¼Œæ‚¨éœ€è¦é€šè¿‡åç«¯ä½¿ç”¨æ•°æ®åº“ä¸­çš„è§¦å‘å™¨è¿›è¡Œæ›´æ–°ã€‚ </p><br><p> æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼š </p><br><ol><li> å°†<code>tsvector</code>ç±»å‹çš„åˆ—æ·»åŠ åˆ°åŒ…å«æ–‡æ¡£çš„è¡¨ä¸­ã€‚ </li><li> åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„è¡¨ï¼Œå¹¶ä¸æ–‡æ¡£è¡¨è¿›è¡Œä¸€å¯¹ä¸€é€šä¿¡ï¼Œå¹¶å°†å‘é‡å­˜å‚¨åœ¨é‚£é‡Œã€‚ </li></ol><br><p> ç¬¬ä¸€ç§æ–¹æ³•çš„ä¼˜ç‚¹ï¼šæœç´¢ä¸­ç¼ºå°‘join-sã€‚ <br> ç¬¬äºŒç§æ–¹æ³•çš„ä¼˜ç‚¹ï¼šå¸¦æœ‰æ–‡æ¡£çš„è¡¨ä¸­ç¼ºå°‘é¢å¤–çš„æ•°æ®ï¼Œå®ƒçš„å¤§å°ä¸ä»¥å‰ç›¸åŒã€‚ ä½¿ç”¨å¤‡ä»½ï¼Œæ‚¨æ— éœ€æµªè´¹æ—¶é—´å’Œæ—¶é—´åœ¨<code>tsvector</code> ï¼Œæ ¹æœ¬ä¸éœ€è¦å¤‡ä»½ã€‚ </p><br><p> ä¸¤æ¬¡æ—…è¡Œéƒ½å¯¼è‡´ç£ç›˜ä¸Šçš„æ•°æ®å˜æˆåŸæ¥çš„ä¸¤å€ï¼šå­˜å‚¨äº†æ–‡æ¡£æ–‡æœ¬åŠå…¶å‘é‡ã€‚ </p><br><p> æˆ‘ä¸ºè‡ªå·±é€‰æ‹©äº†ç¬¬äºŒç§æ–¹æ³•ï¼Œå®ƒçš„ä¼˜åŠ¿å¯¹æˆ‘æ¥è¯´æ›´ä¸ºé‡è¦ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç´¢å¼•åˆ›å»º</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> idx_gin_document <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> documents_documentvector <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> gin ("document_text");</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">æ–°çš„æœç´¢æŸ¥è¯¢</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> documents_document.id, ts_rank("text", plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> documents_document <span class="hljs-keyword"><span class="hljs-keyword">LEFT JOIN</span></span> documents_documentvector <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> documents_document.id = documents_documentvector.document_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> "text" @@ plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ts_rank("text", plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre> </div></div><br><p> å°†æ•°æ®æ·»åŠ åˆ°é“¾æ¥è¡¨å¹¶åˆ›å»ºç´¢å¼•ã€‚ åœ¨æµ‹è¯•çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ æ•°æ®èŠ±è´¹äº†24ç§’ï¼Œè€Œåˆ›å»ºç´¢å¼•ä»…èŠ±è´¹äº†<em>2.7ç§’</em> ã€‚ å¦‚æˆ‘ä»¬æ‰€è§ï¼Œæ›´æ–°ç´¢å¼•å’Œæ•°æ®å¹¶æ²¡æœ‰æ˜æ˜¾åŠ å¿«ï¼Œä½†æ˜¯ç´¢å¼•æœ¬èº«ç°åœ¨å¯ä»¥<em>éå¸¸</em>å¿«é€Ÿåœ°æ›´æ–°ã€‚ </p><br><p> æœç´¢åŠ é€Ÿäº†å¤šå°‘æ¬¡ï¼Ÿ </p><br><pre> <code class="plaintext hljs">Sort (actual time=48.147..48.432 rows=3593 loops=1) Sort Key: (ts_rank(documents_documentvector.text, plainto_tsquery(''::text))) DESC Sort Method: quicksort Memory: 377kB -&gt; Hash Join (actual time=2.281..47.389 rows=3593 loops=1) Hash Cond: (documents_document.id = documents_documentvector.document_id) -&gt; Seq Scan on documents_document (actual time=0.003..2.190 rows=12783 loops=1) -&gt; Hash (actual time=2.252..2.252 rows=3593 loops=1) Buckets: 4096 Batches: 1 Memory Usage: 543kB -&gt; Bitmap Heap Scan on documents_documentvector (actual time=0.465..1.641 rows=3593 loops=1) Recheck Cond: (text @@ plainto_tsquery(''::text)) Heap Blocks: exact=577 -&gt; Bitmap Index Scan on idx_gin_document (actual time=0.404..0.404 rows=3593 loops=1) Index Cond: (text @@ plainto_tsquery(''::text)) Planning time: 0.410 ms Execution time: 48.573 ms</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">æ²¡æœ‰è¿æ¥çš„æŒ‡æ ‡</b> <div class="spoiler_text"><p> è¦æ±‚ï¼š </p><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id, ts_rank("text", plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> rank <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> documents_documentvector <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> "text" @@ plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> rank;</code> </pre> <br><p> ç»“æœï¼š </p><br><pre> æ’åºï¼ˆå®é™…æ—¶é—´= 44.339..44.487è¡Œ= 3593å¾ªç¯= 1ï¼‰
  æ’åºé”®ï¼šï¼ˆts_rankï¼ˆæ–‡æœ¬ï¼Œplainto_tsqueryï¼ˆ'query'::æ–‡æœ¬ï¼‰ï¼‰ï¼‰
  æ’åºæ–¹å¼ï¼šquicksortå†…å­˜ï¼š265kB
   -&gt;å¯¹documents_documentvectorè¿›è¡Œä½å›¾å †æ‰«æï¼ˆå®é™…æ—¶é—´= 0.692..43.682è¡Œ= 3593å¾ªç¯= 1ï¼‰
        é‡æ–°æ£€æŸ¥æ¡ä»¶ï¼šï¼ˆæ–‡æœ¬@@ plainto_tsqueryï¼ˆ'query'::æ–‡æœ¬ï¼‰ï¼‰
        å †å—ï¼šå‡†ç¡®= 577
         -&gt;å¯¹idx_gin_documentè¿›è¡Œä½å›¾ç´¢å¼•æ‰«æï¼ˆå®é™…æ—¶é—´= 0.577..0.577è¡Œ= 3593å¾ªç¯= 1ï¼‰
              ç´¢å¼•æ¡ä»¶ï¼šï¼ˆæ–‡æœ¬@@ plainto_tsqueryï¼ˆ'query'::æ–‡æœ¬ï¼‰ï¼‰
è®¡åˆ’æ—¶é—´ï¼š0.182æ¯«ç§’
æ‰§è¡Œæ—¶é—´ï¼š44.610æ¯«ç§’
</pre></div></div><br><p> å¤ªä¸å¯æ€è®®äº†ï¼ å°½ç®¡joinå’Œ<code>ts_rank</code>ä»ç„¶<code>ts_rank</code> ã€‚ å·²ç»æ˜¯ä¸€ä¸ªå¯ä»¥æ¥å—çš„ç»“æœï¼Œå¤§å¤šæ•°æ—¶é—´ä¸æ˜¯é€šè¿‡æœç´¢ï¼Œè€Œæ˜¯é€šè¿‡ä¸ºæ¯è¡Œè®¡ç®—<code>ts_rank</code>çš„ã€‚ </p><br><h3 id="mnogokratnyy-vyzov-ts_rank">  <code>ts_rank</code>å¤šé‡é€šè¯ </h3><br><p> ä¼¼ä¹æˆ‘ä»¬å·²ç»æˆåŠŸè§£å†³äº†é™¤æ­¤ä»¥å¤–çš„æ‰€æœ‰é—®é¢˜ã€‚  44æ¯«ç§’æ˜¯ä¸é”™çš„äº¤è´§æ—¶é—´ã€‚ å¹¸ç¦çš„ç»“å±€ä¼¼ä¹å¾ˆæ¥è¿‘ï¼Ÿ åœ¨é‚£é‡Œï¼ </p><br><p> åœ¨ä¸ä½¿ç”¨<code>ts_rank</code>æƒ…å†µä¸‹è¿è¡Œç›¸åŒçš„æŸ¥è¯¢å¹¶æ¯”è¾ƒç»“æœã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">æ²¡æœ‰ts_rank</b> <div class="spoiler_text"><p> è¦æ±‚ï¼š </p><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> document_id, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> rank <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> documents_documentvector <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> "text" @@ plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> rank;</code> </pre> <br><p> ç»“æœï¼š </p><br><pre> <code class="plaintext hljs">Bitmap Heap Scan on documents_documentvector (actual time=0.503..1.609 rows=3593 loops=1) Recheck Cond: (text @@ plainto_tsquery(''::text)) Heap Blocks: exact=577 -&gt; Bitmap Index Scan on idx_gin_document (actual time=0.439..0.439 rows=3593 loops=1) Index Cond: (text @@ plainto_tsquery(''::text)) Planning time: 0.147 ms Execution time: 1.715 ms</code> </pre> </div></div><br><p>  1.7æ¯«ç§’ï¼ å¿«ä¸‰åå€ï¼ å¯¹äºæˆ˜æ–—åŸºåœ°ï¼Œç»“æœçº¦ä¸º150æ¯«ç§’1.5ç§’ã€‚ æ— è®ºå¦‚ä½•ï¼Œä¸¤è€…ä¹‹é—´çš„å·®å¼‚æ˜¯ä¸€ä¸ªæ•°é‡çº§ï¼Œè€Œ1.5ç§’å¹¶ä¸æ˜¯æ‚¨è¦ç­‰å¾…æ¥è‡ªåŸºç¡€çš„ç­”æ¡ˆçš„æ—¶é—´ã€‚ æ€ä¹ˆåŠ </p><br><p> æ‚¨ä¸èƒ½æ ¹æ®ç›¸å…³æ€§å…³é—­æ’åºï¼›ä¸èƒ½å‡å°‘è¦è®¡æ•°çš„è¡Œæ•°ï¼ˆæ•°æ®åº“åº”ä¸ºæ‰€æœ‰<code>ts_rank</code>æ–‡æ¡£è®¡ç®—<code>ts_rank</code> ï¼Œå¦åˆ™æ— æ³•æ’åºï¼‰ã€‚ </p><br><p> åœ¨Internetä¸Šçš„æŸäº›åœ°æ–¹ï¼Œå»ºè®®ç¼“å­˜æœ€é¢‘ç¹çš„è¯·æ±‚ï¼ˆå¹¶å› æ­¤è°ƒç”¨ts_rankï¼‰ã€‚ ä½†æ˜¯æˆ‘ä¸å–œæ¬¢è¿™ç§æ–¹æ³•ï¼šæ­£ç¡®é€‰æ‹©æ­£ç¡®çš„æŸ¥è¯¢éå¸¸å›°éš¾ï¼Œè€Œä¸”é”™è¯¯çš„æŸ¥è¯¢ä»ç„¶ä¼šé™ä½æœç´¢é€Ÿåº¦ã€‚ </p><br><p> æˆ‘éå¸¸å¸Œæœ›åœ¨ç»è¿‡ç´¢å¼•ä¹‹åï¼Œæ•°æ®åƒSphinxä¸€æ ·ä»¥å·²ç»æ’åºçš„å½¢å¼å‡ºç°ã€‚ ä¸å¹¸çš„æ˜¯ï¼Œåœ¨PostgreSQLçš„ç›’å­é‡Œä»€ä¹ˆä¹Ÿåšä¸äº†ã€‚ </p><br><p> ä½†æ˜¯æˆ‘ä»¬å¾ˆå¹¸è¿-RUMç´¢å¼•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ æœ‰å…³å®ƒçš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼Œå¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å…¶ä½œè€…</a>çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¼”è®²ä¸­</a>æ‰¾åˆ°ã€‚ å®ƒå­˜å‚¨æœ‰å…³è¯·æ±‚çš„å…¶ä»–ä¿¡æ¯ï¼Œä½¿æ‚¨å¯ä»¥ç›´æ¥è¯„ä¼°æ‰€è°“çš„ä¿¡æ¯ã€‚  <code>tsvector</code>å’Œ<code>tsquery</code>ä¹‹é—´çš„â€œè·ç¦»â€ï¼Œå¹¶åœ¨æ‰«æç´¢å¼•åç«‹å³äº§ç”Ÿæ’åºç»“æœã€‚ </p><br><p> ä½†æ˜¯ï¼ŒæŠ›å‡ºGINå¹¶å®‰è£…RUMå¹¶ä¸å€¼å¾—ã€‚ å®ƒæœ‰ç¼ºç‚¹ï¼Œæœ‰ä¼˜ç‚¹å’Œæœ‰åº”ç”¨é™åˆ¶-æˆ‘å°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­å¯¹æ­¤è¿›è¡Œä»‹ç»ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN442170/">https://habr.com/ru/post/zh-CN442170/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN442158/index.html">è‹±é›„ä¸‰ä¸–-20å²</a></li>
<li><a href="../zh-CN442162/index.html">STM32å¿«é€Ÿå¯åŠ¨ã€‚ ç¬¬1éƒ¨åˆ†è½¯ä»¶ï¼Œææ–™ï¼ŒCube MX</a></li>
<li><a href="../zh-CN442164/index.html">Roskomnadzorè®¡åˆ’å¯¹Facebookçš„è¿è§„è¡Œä¸ºå¤„ä»¥ç½šæ¬¾</a></li>
<li><a href="../zh-CN442166/index.html">æ˜æ–¯å…‹çš„æ›¿ä»£åœ°é“æ–¹æ¡ˆ</a></li>
<li><a href="../zh-CN442168/index.html">Habra megaratingï¼š12å¹´ä»¥æ¥Habrçš„æœ€ä½³æ–‡ç« å’Œç»Ÿè®¡æ•°æ®ã€‚ ç¬¬2/2éƒ¨åˆ†</a></li>
<li><a href="../zh-CN442176/index.html">ç§‘å­¦å®¶ç»„å»ºä¸€æ”¯ç”±Tæ·‹å·´ç»†èƒç»„æˆçš„å…¨èƒ½å†›ä»¥æ‘§æ¯ç™Œç—‡</a></li>
<li><a href="../zh-CN442178/index.html">Mayhem-å¯ä»¥æ£€æµ‹ç¨‹åºæ¼æ´å¹¶ä¿®å¤å®ƒä»¬çš„æœºå™¨</a></li>
<li><a href="../zh-CN442180/index.html">å…è´¹èµ é€â€œé“â€</a></li>
<li><a href="../zh-CN442182/index.html">æ€¥è¯Šå®¤ï¼šç¾å›½Facebookä¸»æŒäººçš„ç§˜å¯†ç”Ÿæ´»</a></li>
<li><a href="../zh-CN442184/index.html">å…¥ä¾µCANæ€»çº¿æ±½è½¦ã€‚ è™šæ‹Ÿä»ªè¡¨æ¿</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>