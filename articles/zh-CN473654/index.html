<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👃 🐴 🏖️ PHP Composer：轻松解决依赖关系 🕷️ 🔧 🕳️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="你们中许多人可能遇到过这样的情况，即您使用的库或框架中存在错误或没有必要的功能。 假设您不太懒惰并形成了请求请求。 但是他们不会立即接受它，并且该产品的下一次发布通常可能会在一年内完成。 





 如果您迫切需要对产品进行更正，该怎么办？ 显而易见的解决方案是使用库或框架的分支。 但是，并不是所...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP Composer：轻松解决依赖关系</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/473654/"><p> 你们中许多人可能遇到过这样的情况，即您使用的库或框架中存在错误或没有必要的功能。 假设您不太懒惰并形成了请求请求。 但是他们不会立即接受它，并且该产品的下一次发布通常可能会在一年内完成。 </p><br><p><img src="https://habrastorage.org/webt/jv/ys/9h/jvys9h_dh2zmefozo_xhrosiipo.jpeg" alt="PHP Composer：轻松解决依赖关系"></p><br><p> 如果您迫切需要对产品进行更正，该怎么办？ 显而易见的解决方案是使用库或框架的分支。 但是，并不是所有事情都简单。 使用继承来覆盖需要更改的功能并不总是可能的，并且通常需要进行重大更改。 可以修补依赖项的Composer插件可助您一臂之力。 </p><br><p> 在本文中，我将更多地讨论为什么fork会带来不便，并且还将考虑Composer的两个用于依赖项修补的插件：它们之间的差异，如何使用它们以及它们的优点是什么。 如果您遇到类似的问题或只是想知道，欢迎与我们联系。 <a name="habracut"></a></p><br><p>通过示例最方便地考虑该问题。 假设我们要更改<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PHP Code Coverage</a>库中的某些内容，该库在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PHPUnit</a>测试<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">框架中</a>用于测量测试的代码覆盖率。 假设我们要在7.0.8版（ <code>myFix.patch</code>文件）中修复类似的问题： </p><br><pre> <code class="diff hljs">diff --git a/src/CodeCoverage.php b/src/CodeCoverage.php index 2c92ae2..514171e 100644 --- a/src/CodeCoverage.php +++ b/src/CodeCoverage.php @@ -190,6 +190,7 @@ public function filter(): Filter */ public function getData(bool $raw = false): array { + // for example some changes here if (!$raw &amp;&amp; $this-&gt;addUncoveredFilesFromWhitelist) { $this-&gt;addUncoveredFilesFromWhitelist(); }</code> </pre> <br><p> 让我们创建示例库。 让它成为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">php-composer-patches-example</a> 。 这里的细节不是很重要，但是如果您决定看一下库是什么，我会将控制台输出置于扰流器下方。 </p><br><div class="spoiler">  <b class="spoiler_title">隐藏文字</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ git clone git@github.com:mougrim/php-composer-patches-example.git   «php-composer-patches-example»… remote: Enumerating objects: 3, done. remote: Counting objects: 100% (3/3), done. remote: Compressing objects: 100% (2/2), done. remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0  : 100% (3/3), . $ cd php-composer-patches-example/ $ $ composer.phar init --name=mougrim/php-composer-patches-example --description="It's an example for article with using forks and patches for changing dependencies" --author='Mougrim &lt;rinat@mougrim.ru&gt;' --type=library --require='phpunit/phpunit:^8.4.2' --license=MIT --homepage='https://github.com/mougrim/php-composer-patches-example' Welcome to the Composer config generator This command will guide you through creating your composer.json config. Package name (&lt;vendor&gt;/&lt;name&gt;) [mougrim/php-composer-patches-example]: Description [It's an example for article with using forks and patches for changing dependencies]: Author [Mougrim &lt;rinat@mougrim.ru&gt;, n to skip]: Minimum Stability []: Package Type (eg library, project, metapackage, composer-plugin) [library]: License [MIT]: Define your dependencies. Would you like to define your dev dependencies (require-dev) interactively [yes]? no { "name": "mougrim/php-composer-patches-example", "description": "It's an example for article with using forks and patches for changing dependencies", "type": "library", "homepage": "https://github.com/mougrim/php-composer-patches-example", "require": { "phpunit/phpunit": "^8.4.2" }, "license": "MIT", "authors": [ { "name": "Mougrim", "email": "rinat@mougrim.ru" } ] } Do you confirm generation [yes]? yes Would you like to install dependencies now [yes]? yes Loading composer repositories with package information Updating dependencies (including require-dev) Package operations: 29 installs, 0 updates, 0 removals - Installing sebastian/version (2.0.1): Loading from cache - Installing sebastian/type (1.1.3): Loading from cache - Installing sebastian/resource-operations (2.0.1): Loading from cache - Installing sebastian/recursion-context (3.0.0): Loading from cache - Installing sebastian/object-reflector (1.1.1): Loading from cache - Installing sebastian/object-enumerator (3.0.3): Loading from cache - Installing sebastian/global-state (3.0.0): Loading from cache - Installing sebastian/exporter (3.1.2): Loading from cache - Installing sebastian/environment (4.2.2): Loading from cache - Installing sebastian/diff (3.0.2): Loading from cache - Installing sebastian/comparator (3.0.2): Loading from cache - Installing phpunit/php-timer (2.1.2): Loading from cache - Installing phpunit/php-text-template (1.2.1): Loading from cache - Installing phpunit/php-file-iterator (2.0.2): Loading from cache - Installing theseer/tokenizer (1.1.3): Loading from cache - Installing sebastian/code-unit-reverse-lookup (1.0.1): Loading from cache - Installing phpunit/php-token-stream (3.1.1): Loading from cache - Installing phpunit/php-code-coverage (7.0.8): Loading from cache - Installing doctrine/instantiator (1.2.0): Loading from cache - Installing symfony/polyfill-ctype (v1.12.0): Loading from cache - Installing webmozart/assert (1.5.0): Loading from cache - Installing phpdocumentor/reflection-common (2.0.0): Loading from cache - Installing phpdocumentor/type-resolver (1.0.1): Loading from cache - Installing phpdocumentor/reflection-docblock (4.3.2): Loading from cache - Installing phpspec/prophecy (1.9.0): Loading from cache - Installing phar-io/version (2.0.1): Loading from cache - Installing phar-io/manifest (1.0.3): Loading from cache - Installing myclabs/deep-copy (1.9.3): Loading from cache - Installing phpunit/phpunit (8.4.2): Loading from cache sebastian/global-state suggests installing ext-uopz (*) phpunit/phpunit suggests installing phpunit/php-invoker (^2.0.0) phpunit/phpunit suggests installing ext-soap (*) Writing lock file Generating autoload files $ $ echo 'vendor/' &gt; .gitignore $ echo 'composer.lock' &gt;&gt; .gitignore $ git add .gitignore composer.json $ $ git commit --gpg-sign --message='Init composer' [master ce800ae] Init composer 2 files changed, 18 insertions(+) create mode 100644 .gitignore create mode 100644 composer.json $ git push origin master  : 4, . Delta compression using up to 4 threads.  : 100% (3/3), .  : 100% (4/4), 1.21 KiB | 1.21 MiB/s, . Total 4 (delta 0), reused 0 (delta 0) To github.com:mougrim/php-composer-patches-example.git f31c342..ce800ae master -&gt; master</code> </pre> </div></div><br><h2 id="chto-ne-tak-s-forkom-zavisimosti"> 上瘾的叉子怎么了 </h2><br><p> 让我们看看fork依赖是如何发生的。 让我们尝试分叉PHP代码覆盖率。 </p><br><ol><li> 我们转到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub上的PHP代码覆盖率页面</a> 。 </li><li> 按下前叉按钮 <img src="https://habrastorage.org/webt/qj/ff/ta/qjfftaa4kurvcfu91mlrvr2twie.png" alt="叉子按钮">  （注意：您将拥有叉子，将mougrim替换为您的用户名）。 </li><li> 克隆叉子： <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git@github.com:mougrim/php-code-coverage.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-code-coverage</code> </pre> </li><li> 转到我们要修补的版本： <br><pre> <code class="bash hljs">git checkout 7.0.8</code> </pre> </li><li> 创建一个分支进行修复： <br><pre> <code class="bash hljs">git checkout -b 7.0.8-myFix</code> </pre> </li><li> 我们进行必要的更改，提交，推送： <br><pre> <code class="bash hljs">git apply ../myFix.patch git add src/CodeCoverage.php git commit --gpg-sign --message=<span class="hljs-string"><span class="hljs-string">'My fix'</span></span> git push -u origin 7.0.8-myFix</code> </pre> </li><li> 在我们的库的composer.json中添加fork作为存储库（这是必需的，因此在连接<code>phpunit/php-code-coverage</code>软件包时，不是连接原始软件包，而是连接fork）： <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example git checkout -b useFork composer.phar config repositories.phpunit/php-code-coverage vcs https://github.com/mougrim/php-code-coverage.git</code> </pre> </li><li> 将依赖项的版本更改为早午餐： <br><pre> <code class="bash hljs">composer.phar require phpunit/php-code-coverage <span class="hljs-string"><span class="hljs-string">'dev-7.0.8-myFix'</span></span></code> </pre> </li></ol><br><p> 但是实际上它仍然更加复杂：Composer说安装是不可能的，因为<code>phpunit/phpunit</code>需要<code>phpunit/php-code-coverage</code>版本<code>^7.0.7</code> ，而我们的项目则需要<code>dev-7.0.8-myFix</code> ： </p><br><pre> <code class="plaintext hljs">$ composer.phar require phpunit/php-code-coverage 'dev-7.0.8-myFix' ./composer.json has been updated Loading composer repositories with package information Updating dependencies (including require-dev) Your requirements could not be resolved to an installable set of packages. Problem 1 - phpunit/phpunit 8.4.2 requires phpunit/php-code-coverage ^7.0.7 -&gt; satisfiable by phpunit/php-code-coverage[7.0.x-dev]. - phpunit/phpunit 8.4.2 requires phpunit/php-code-coverage ^7.0.7 -&gt; satisfiable by phpunit/php-code-coverage[7.0.x-dev]. - phpunit/phpunit 8.4.2 requires phpunit/php-code-coverage ^7.0.7 -&gt; satisfiable by phpunit/php-code-coverage[7.0.x-dev]. - Can only install one of: phpunit/php-code-coverage[7.0.x-dev, dev-7.0.8-myFix]. - Installation request for phpunit/php-code-coverage dev-7.0.8-myFix -&gt; satisfiable by phpunit/php-code-coverage[dev-7.0.8-myFix]. - Installation request for phpunit/phpunit ^8.4.2 -&gt; satisfiable by phpunit/phpunit[8.4.2]. Installation failed, reverting ./composer.json to its original content.</code> </pre> <br><p> 怎么办呢？ 有四个选项： </p><br><ol><li> 除了<code>phpunit/php-code-coverage</code>分支外，还分支PHPUnit并为依赖项<code>phpunit/php-code-coverage</code>编写版本<code>dev-7.0.8-myFix</code> 。 就支持而言，此路径相当复杂，并且越复杂，则依赖<code>phpunit/php-code-coverage</code>库就越多。 </li><li> 连接<code>phpunit/php-code-coverage</code>时使用<a href="">别名</a> 。 但是别名不会从依赖项中提取，这意味着它们将始终需要手动编写。 </li><li> 在您的fork中<code>phpunit/php-code-coverage</code> ，以便<code>7.0.8</code>标记<code>7.0.8</code>另一个提交。 至少这不是很明显，但是最大程度地-在Git中，使用标记引用不同远程存储库中具有相同名称的不同提交的标记是不方便的。 </li><li> 在您的派生<code>phpunit/php-code-coverage</code>使用alpha发行版标签，例如<code>7.0.8-a+myFix</code> （可能与源库的alpha发行版发生冲突）。 </li></ol><br><p> 所有选项都有其缺点。 我也尝试使用<code>7.0.8.1</code>类的标签，但Composer不接受此类标签。 </p><br><p> 第二种选择和第四种选择似乎邪恶程度较小。 由于它们的动作数量大致相同，因此在本文中，我们将仅考虑其中之一-第四。 创建一个alpha发布标签： </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-code-coverage git tag 7.0.8<span class="hljs-_"><span class="hljs-_">-a</span></span>+myFix git push origin 7.0.8<span class="hljs-_"><span class="hljs-_">-a</span></span>+myFix <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example composer.phar require phpunit/php-code-coverage <span class="hljs-string"><span class="hljs-string">'7.0.8-a+myFix'</span></span> git add composer.json git commit --gpg-sign --message=<span class="hljs-string"><span class="hljs-string">'Use fork'</span></span> git push -u origin useFork</code> </pre> <br><p> 假设我们要在依赖于<code>phpunit/phpunit</code>的项目中使用我们的库<code>mougrim/php-composer-patches-example</code> 。 在这里，不能没有萨满<code>phpunit/php-code-coverage</code> ，您将不得不再次为<code>phpunit/php-code-coverage</code>指定存储库<code>https://github.com/mougrim/php-code-coverage.git</code> ，并明确指出对<code>phpunit/php-code-coverage</code>的依赖性版本<code>7.0.8-a+myFix</code> （否则安装将不会成功）： </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ mkdir php-project <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-project/ composer.phar require phpunit/phpunit <span class="hljs-string"><span class="hljs-string">'^8.4.2'</span></span> composer.phar config repositories.mougrim/php-composer-patches-example vcs https://github.com/mougrim/php-composer-patches-example.git composer.phar config repositories.phpunit/php-code-coverage vcs https://github.com/mougrim/php-code-coverage.git composer.phar require phpunit/php-code-coverage 7.0.8<span class="hljs-_"><span class="hljs-_">-a</span></span>+myFix composer.phar require mougrim/php-composer-patches-example dev-useFork</code> </pre> <br><p> 请注意，php-composer-patches-example作为存储库连接，因为该存储库只是一个示例，因此尚未添加到Packagist中。 您的情况下，很可能会跳过此步骤。 </p><br><p> 总结一下叉子的使用。 </p><br><p> 这种方法的优点： </p><br><ul><li> 无需为Composer安装插件。 </li></ul><br><p> 这种方法的缺点： </p><br><ul><li> 如果使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>roave/security-advisories</code></a> ，则不会看到有关您分叉和修改的依赖项版本包含漏洞的信息； </li><li> 当新版本的依赖关系出现时，将不得不重新重复fork的故事； </li><li> 如果要修复依赖项依赖关系（如所考虑的示例中所示），则<code>dev-*</code>不适用于该依赖关系，并且您必须使用版本进行萨满化或为冲突的依赖项进行分叉； </li><li> 如果有依赖于库的项目，则不必以最明显，最方便的方式在项目中安装库； </li><li> 如果有一些项目依赖于您的库，则对于它们， <code>phpunit/php-code-coverage</code>版本将严格固定，这并不总是可以接受的； </li><li> 此外，如果上述几点的项目由于其他原因已经分叉了PHP代码覆盖率，那么一切将变得更加复杂。 </li></ul><br><p> 我认为您已经意识到分叉上瘾不是一个好主意。 </p><br><h2 id="ispolzovanie-cweaganscomposer-patches"> 使用Cweagans /作曲家补丁 </h2><br><p> 我再次遇到了使用叉子的痛苦和痛苦，我遇到了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PHP Digest No. 101中的</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>cweagans/composer-patches</code></a> （顺便说一句， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">pronskiy有一个</a>有用的博客，我建议订阅）。 这是omposer的插件，它使您可以将补丁应用于依赖项。 阅读说明后，我认为这正是您所需要的。 </p><br><p> 如何使用cweagans / composer-patches： </p><br><ol><li> 克隆PHP代码覆盖率： <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ rm -rf php-code-coverage git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git@github.com:sebastianbergmann/php-code-coverage.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-code-coverage</code> </pre> </li><li> 转到我们要修补的版本： <br><pre> <code class="bash hljs">git checkout 7.0.8</code> </pre> </li><li> 我们进行必要的更改。 </li><li> 创建补丁： <br><pre> <code class="bash hljs">mkdir -p ../php-composer-patches-example/patches/phpunit/php-code-coverage git diff HEAD &gt; ../php-composer-patches-example/patches/phpunit/php-code-coverage/myFix.patch</code> </pre> </li><li> 在我们的项目中，我们连接<code>cweagans/composer-patches</code> ： <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example git checkout master composer.phar update git checkout -b cweagansComposerPatches composer.phar require cweagans/composer-patches <span class="hljs-string"><span class="hljs-string">'^1.6.7'</span></span></code> </pre> </li><li> 要配置<code>cweagans/composer-patches</code>请将以下内容添加到<code>composer.json</code> （您可以为一个软件包指定多个补丁）： <br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"preferred-install"</span></span>: <span class="hljs-string"><span class="hljs-string">"source"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"extra"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"patches"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"phpunit/php-code-coverage"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"My fix description"</span></span>: <span class="hljs-string"><span class="hljs-string">"patches/phpunit/php-code-coverage/myFix.patch"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"enable-patching"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre> </li><li> 更新依赖项： <br><pre> <code class="bash hljs">composer.phar update</code> </pre> </li><li> 如果出了点问题，可以在上一条命令的输出中看到，但以防万一，您可以检查一下我们的更改是否已应用： <br><pre> <code class="plaintext hljs">$ grep example vendor/phpunit/php-code-coverage/src/CodeCoverage.php // for example some changes here</code> </pre> </li><li> 提交并推送结果： <br><pre> <code class="bash hljs">git add composer.json patches/phpunit/php-code-coverage/myFix.patch git commit --gpg-sign --message=<span class="hljs-string"><span class="hljs-string">'Use cweagans/composer-patches'</span></span> git push -u origin cweagansComposerPatches</code> </pre> </li></ol><br><p> 我们确保在项目中安装库时，补丁也将适用。 </p><br><p> 创建一个项目： </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ rm -rf php-project mkdir php-project <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-project composer.phar require phpunit/phpunit <span class="hljs-string"><span class="hljs-string">'^8.4.2'</span></span></code> </pre> <br><p>  <code>composer.json</code>添加到<code>composer.json</code> ： </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"extra"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"enable-patching"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre> <br><p> 安装<code>mougrim/php-composer-patches-example</code> ： </p><br><pre> <code class="bash hljs">composer.phar config repositories.mougrim/php-composer-patches-example vcs https://github.com/mougrim/php-composer-patches-example.git composer.phar require mougrim/php-composer-patches-example dev-cweagansComposerPatches</code> </pre> <br><p> 似乎在连接软件包时应该尝试应用补丁，但没有。 <br> 我们将更新软件包，以便应用补丁，但这不会发生： </p><br><pre> <code class="plaintext hljs">$ composer.phar update Removing package phpunit/php-code-coverage so that it can be re-installed and re-patched. - Removing phpunit/php-code-coverage (7.0.8) Loading composer repositories with package information Updating dependencies (including require-dev) Package operations: 1 install, 0 updates, 0 removals No patches supplied. Gathering patches for dependencies. This might take a minute. - Installing phpunit/php-code-coverage (7.0.8): Loading from cache - Applying patches for phpunit/php-code-coverage patches/phpunit/php-code-coverage/myFix.patch (My fix description) Could not apply patch! Skipping. The error was: The "patches/phpunit/php-code-coverage/myFix.patch" file could not be downloaded: failed to open stream: No such file or directory Writing lock file Generating autoload files</code> </pre> <br><p> 在错误跟踪器中翻阅后，我发现<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">依赖项</a>错误<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">未解决基于文件的补丁</a> 。 事实证明，您必须在修补程序之前指定URL（这意味着从某处下载URL），或者在安装了需要修补程序的依赖项的每个项目中手动指定修补程序的路径。 </p><br><p> 总结<code>cweagans/composer-patches</code> 。 </p><br><p> 这种方法的优点： </p><br><ul><li> 该插件有一个社区； </li><li>  <code>roave/security-advisories</code>将不会停止工作； </li><li> 当发布新版本的依赖项时，如果成功应用了补丁程序，就足以确保一切都可以与新版本一起使用（对于次要版本，很有可能完全可以单独工作，对于主要版本，也很可能不需要执行任何操作）; </li><li> 如果某些项目依赖于您的库，则对于它们， <code>phpunit/php-code-coverage</code>将不会严格固定； </li><li> 而且，在以上段落的情况下，这样的项目将能够在PHP Code Coverage中应用其补丁。 </li></ul><br><p> 缺点： </p><br><ul><li> 这是Composer的插件，这意味着在更新Composer时可能会损坏； </li><li> 必须指定<code>enable-patching=true</code>以便从依赖项应用补丁； </li><li> 主要项目维护者没有太多时间来处理它，因此，通常，他接受请求请求，但并没有特别开发项目（例如，他对<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">任务</a>的第二个版本有想法，但三年后几乎没有什么改变）； </li><li> 有一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">基于文件的补丁不能在依赖项</a>错误中<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">解决</a> ，这<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">很不</a>方便，并且已经积压了三年了。 </li><li> 您不能对不同版本的依赖项使用不同的补丁。 </li></ul><br><p> 最后一点已成为我的障碍。 首先，我提出了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">功能请求</a> 。 维护者写道，他不想将此功能添加到主代码中，但是在第二个版本中，可以编写插件（是的，是Composer插件的插件）。 第二版的前景不明确，所以我决定寻找替代方案。 在小清单中，我没有找到将受支持的插件。 </p><br><p> 我不想进入插件代码，所以我决定分叉-当然，有人已经遇到了问题并已解决。 </p><br><h2 id="ispolzovanie-vaimo-composer-patches"> 使用Vaimo Composer修补程序 </h2><br><p> 在大多数货叉中，与原始货叉完全没有区别（为什么它们甚至会货叉？）。 叉的一部分用于请求请求，这些请求已与主库合并。 但是，有一个有趣的候选人正在解决我的问题<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-Vaimo Composer Patches</a> 。 当时它仍然被构造为fork，但是它的维护者似乎并不会执行拉取请求。 例如，除其他外，他已经将软件包名称更改为<code>vaimo/composer-patches</code> 。 但是有一个问题：问题被禁用，也就是说，根本没有作者的反馈。 另外，该插件也未托管在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Packagist上</a> 。 </p><br><p> 如此好的叉子不应丢在其他无用的叉子中。 因此，我联系了作者，要求启用问题并将程序包添加到Packagist。 经过将近一个月的时间，作者回答并完成了所有这些工作。  :) </p><br><p> 使用<code>vaimo/composer-patches</code>与使用先前的插件没有什么不同，但是您可以为不同的版本指定不同的补丁。 </p><br><ol><li> 我们回滚我们的库​​（删除<code>vendor</code>文件夹是必要的，因为插件<code>cweagans/composer-patches</code>和<code>vaimo/composer-patches</code>不太兼容）： <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example git checkout master rm -rf vendor/ composer.phar update</code> </pre> </li><li> 我们执行上一节中的1-4点。 </li><li> 在我们的项目中，我们连接<code>vaimo/composer-patches</code> ： <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example git checkout -b vaimoComposerPatches composer.phar require vaimo/composer-patches <span class="hljs-string"><span class="hljs-string">'^4.20.2'</span></span></code> </pre> </li><li> 要配置<code>vaimo/composer-patches</code>请将以下内容添加到<code>composer.json</code> （可在<a href="">此处查看</a>文档）： <br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"extra"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"patches"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"phpunit/php-code-coverage"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"My fix description"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"&lt; 7.0.0"</span></span>: <span class="hljs-string"><span class="hljs-string">"patches/phpunit/php-code-coverage/myFix-leagcy.patch"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"&gt;= 7.0.0"</span></span>: <span class="hljs-string"><span class="hljs-string">"patches/phpunit/php-code-coverage/myFix.patch"</span></span> } } } } }</code> </pre> </li><li> 更新依赖项： <br><pre> <code class="bash hljs">composer.phar update</code> </pre> </li><li> 如果出了点问题，可以在上一条命令的输出中看到，但以防万一，您可以确保应用我们的更改： <br><pre> <code class="plaintext hljs">$ grep example vendor/phpunit/php-code-coverage/src/CodeCoverage.php // for example some changes here</code> </pre> </li><li> 提交并推送结果： <br><pre> <code class="bash hljs">git add composer.json patches/phpunit/php-code-coverage/myFix.patch git commit --gpg-sign --message=<span class="hljs-string"><span class="hljs-string">'Use vaimo/composer-patches'</span></span> git push -u origin vaimoComposerPatches</code> </pre> </li></ol><br><p> 我们确保在项目中安装库时，补丁也将适用。 </p><br><p> 创建一个项目并安装<code>mougrim/php-composer-patches-example</code> ： </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ rm -rf php-project mkdir php-project <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-project composer.phar require phpunit/phpunit <span class="hljs-string"><span class="hljs-string">'^8.4.2'</span></span> composer.phar config repositories.mougrim/php-composer-patches-example vcs https://github.com/mougrim/php-composer-patches-example.git composer.phar require mougrim/php-composer-patches-example dev-vaimoComposerPatches</code> </pre> <br><p> 为了以防万一，您可以确保已应用我们的更改： </p><br><pre> <code class="plaintext hljs">$ grep example vendor/phpunit/php-code-coverage/src/CodeCoverage.php // for example some changes here</code> </pre> <br><p> 总结<code>vaimo/composer-patches</code> 。 </p><br><p> 该插件的优点与以前的优点几乎相同，但还包括以下内容： </p><br><ul><li> 维护者正在积极开发该插件，并已经发布了第四个主要版本； </li><li> 无需为要应用依赖项的补丁规定任何附加规定； </li><li> 您可以对不同版本的依赖项使用不同的补丁。 </li><li> 该插件有很多设置，因此，如果本文中描述的功能不足以满足您的要求，请查看文档-可能您所需的功能已经实现。 </li></ul><br><p> 缺点： </p><br><ul><li> 像上一个一样，它是Composer的插件，这意味着在更新Composer时它可能会损坏； </li><li> 与以前的插件不同，此社区的插件较少。 </li></ul><br><h2 id="vyvody"> 结论 </h2><br><p> 总结一般结果： </p><br><ul><li> 使用包叉进行任何较小的修复是不方便的； </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>cweagans/composer-patches</code></a>是一个很好的插件，但是开发很差，所以我不推荐它。 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Vaimo Composer Patches</a>是一个出色的插件，可以很好地解决依赖关系修复的问题，并且还有很多设置。 </li><li>  Vaimo Composer Patches的社区很小，但是我希望本文能有所增加； </li><li> 如果依赖项需要大量更改，则可以使用硬派生（保持派生独立于原始依赖项）更为容易。 </li></ul><br><p> 我还得出了一个间接结论：如果某种依赖关系没有提供必要的功能，那么可能会有实现此功能的分叉甚至更多。 </p><br><p> 在Badoo，我们在两种情况下使用Vaimo Composer Patches： </p><br><ul><li> 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SoftMocks</a>中修补PHPUnit和PHP代码覆盖率； </li><li> 在Webmozart的内部存储库中声明为与SoftMocks兼容的临时修补程序（而SoftMocks不支持<code>array_map(array('static', 'valueToString')</code>构造<code>array_map(array('static', 'valueToString')</code> ）。 </li></ul><br><p> 里纳特·阿赫玛德耶夫（Rinat Akhmadeev），高级  PHP开发人员 </p><br><p>  <strong>UPD1</strong> ：感谢<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">BoShurik</a>提供的<a href="">别名</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">链接</a> 。 在文章中添加了有关别名的要点。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN473654/">https://habr.com/ru/post/zh-CN473654/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN473640/index.html">大数据日落</a></li>
<li><a href="../zh-CN473642/index.html">Cribble Crabble Gradle：自动构建魔术</a></li>
<li><a href="../zh-CN473646/index.html">小公司的Hackathon：如何在不浪费资源的情况下进行安排</a></li>
<li><a href="../zh-CN473648/index.html">马已经死了-哭泣：从tslint到eslint的过渡</a></li>
<li><a href="../zh-CN473652/index.html">使用Node.js和Oracle数据库创建REST API。 第5部分</a></li>
<li><a href="../zh-CN473656/index.html">雨果静态网站生成器体验</a></li>
<li><a href="../zh-CN473658/index.html">处理Go 1.13中的错误</a></li>
<li><a href="../zh-CN473660/index.html">街机逆向工程：在NBA Jam上创下Michael Jordan</a></li>
<li><a href="../zh-CN473664/index.html">亲身学习经验。 Yandex.Practicum-数据分析师</a></li>
<li><a href="../zh-CN473666/index.html">作为科幻小说作家，亚瑟·克拉克（Arthur Clark）几乎关闭了《科技-青年》杂志</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>