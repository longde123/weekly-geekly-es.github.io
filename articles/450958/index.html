<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>游댋 游댨 游눈游낗 AnyStub, biblioteca de stub de conexi칩n Java 游뛋游낕 游 游냦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A diferencia de muchas plataformas, Java adolece de una falta de bibliotecas de stub de conexi칩n. Si has estado en este mundo durante mucho tiempo, en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>AnyStub, biblioteca de stub de conexi칩n Java</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450958/"><p> A diferencia de muchas plataformas, Java adolece de una falta de bibliotecas de stub de conexi칩n.  Si has estado en este mundo durante mucho tiempo, entonces probablemente deber칤as estar familiarizado con WireMock, Betamax o incluso Spock.  Muchos desarrolladores en las pruebas usan Mockito para describir el comportamiento de los objetos, DataJpaTest con una base de datos h2 local, pruebas de Cucumber.  Hoy conocer치 una alternativa liviana que lo ayudar치 a lidiar con varios problemas que puede encontrar al usar estos enfoques.  En particular, anyStub intenta resolver los siguientes problemas: </p><br><ul><li>  simplificar la configuraci칩n del entorno de prueba </li><li>  automatizar la recopilaci칩n de datos para pruebas </li><li>  mant칠ngase en la prueba de su aplicaci칩n y evite probar para otra cosa </li></ul><a name="habracut"></a><br><h2 id="chto-takoe-anystub-i-kak-eto-rabotaet">  쯈u칠 es anyStub y c칩mo funciona? </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">AnyStub</a> ajusta las llamadas de funci칩n, tratando de encontrar las llamadas coincidentes que ya se han grabado.  Pueden suceder dos cosas con esto: </p><br><ul><li>  si hay una llamada coincidente, anyStub restaurar치 el resultado registrado asociado con esa llamada y lo devolver치 </li><li>  si no hay una llamada coincidente y se permite el acceso al sistema externo, anyStub har치 esta llamada, registrar치 este resultado y lo devolver치 </li></ul><br><p>  Fuera de la caja, anyStub proporciona envoltorios para el cliente http de Apache HttpClient para crear ap칠ndices para solicitudes http y varias interfaces de javax.sql. * Para conexiones de base de datos.  Tambi칠n se le proporciona una API para crear ap칠ndices para otras conexiones. </p><br><p>  AnyStub es una biblioteca de clases simple y no requiere una configuraci칩n especial de su entorno.  Esta biblioteca est치 dise침ada para trabajar con aplicaciones de arranque por resorte y obtendr치 el m치ximo beneficio al seguir esta ruta.  Puede usarlo fuera de Spring, en aplicaciones Java simples, pero definitivamente tendr치 que hacer un trabajo adicional.  La siguiente descripci칩n se centra en probar aplicaciones de arranque por resorte. </p><br><p>  Veamos las pruebas de integraci칩n.  Esta es la forma m치s emocionante y completa de probar su sistema.  De hecho, spring-boot y JUnit hacen casi todo por ti cuando escribes anotaciones m치gicas: </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span></code> </pre> <br><p>  En la actualidad, las pruebas de integraci칩n se subestiman y se utilizan de forma limitada, y algunos desarrolladores las evitan.  Esto se debe principalmente a la larga preparaci칩n y mantenimiento de las pruebas o la necesidad de una configuraci칩n especial del entorno en los servidores de compilaci칩n. </p><br><p>  Con anyStub, no tiene que paralizar el contexto de primavera.  En cambio, mantener el contexto cercano a la configuraci칩n de producci칩n es simple y directo. </p><br><p>  En este ejemplo, veremos c칩mo conectar anyStub a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Consuming a RESTful Web Service</a> del manual de Pivotal. </p><br><p>  Conectar una biblioteca a trav칠s de pom.xml </p><br><pre> <code class="java hljs"> &lt;dependency&gt; &lt;groupId&gt;org.anystub&lt;/groupId&gt; &lt;artifactId&gt;anystub&lt;/artifactId&gt; &lt;version&gt;<span class="hljs-number"><span class="hljs-number">0.2</span></span>.27&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt;</code> </pre> <br><p>  El siguiente paso es modificar el contexto de primavera. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.anystub.http.StubHttpClient; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.http.client.HttpClient; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.http.impl.client.HttpClientBuilder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.web.client.RestTemplateBuilder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.web.client.RestTemplateCustomizer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Bean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.http.client.HttpComponentsClientHttpRequestFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.client.RestTemplate; <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RestTemplateBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">builder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RestTemplateCustomizer restTemplateCustomizer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestTemplateCustomizer() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">customize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RestTemplate restTemplate)</span></span></span><span class="hljs-function"> </span></span>{ HttpClient real = HttpClientBuilder.create().build(); StubHttpClient stubHttpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StubHttpClient(real); HttpComponentsClientHttpRequestFactory requestFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpComponentsClientHttpRequestFactory(); requestFactory.setHttpClient(stubHttpClient); restTemplate.setRequestFactory(requestFactory); } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestTemplateBuilder(restTemplateCustomizer); } }</code> </pre> <br><p>  Esta modificaci칩n no cambia las relaciones de componentes en la aplicaci칩n, sino que solo reemplaza la implementaci칩n de una 칰nica interfaz.  Esto nos env칤a al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Principio de sustituci칩n de Barbara Lisk</a> .  Si el dise침o de su aplicaci칩n no lo viola, esta sustituci칩n no violar치 la funcionalidad. </p><br><p>  Todo esta listo.  Este proyecto ya incluye una prueba. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RestTemplate restTemplate; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">contextLoads</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertThat(restTemplate).isNotNull(); } }</code> </pre> <br><p>  Esta prueba est치 vac칤a, pero ya est치 ejecutando el contexto de la aplicaci칩n.  <strong>La diversi칩n comienza aqu칤</strong> .  Como dijimos anteriormente, el contexto de la aplicaci칩n en la prueba coincide con el contexto de trabajo en el que se crea CommandLineRunner en el que se ejecuta la solicitud http al sistema externo. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = LoggerFactory.getLogger(Application.class); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String args[])</span></span></span><span class="hljs-function"> </span></span>{ SpringApplication.run(Application.class); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RestTemplate </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RestTemplateBuilder builder)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> builder.build(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CommandLineRunner </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RestTemplate restTemplate)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> args -&gt; { Quote quote = restTemplate.getForObject( <span class="hljs-string"><span class="hljs-string">"https://gturnquist-quoters.cfapps.io/api/random"</span></span>, Quote.class); log.info(quote.toString()); }; } }</code> </pre> <br><p>  Esto es suficiente para demostrar el funcionamiento de la biblioteca.  Despu칠s de comenzar las pruebas por primera vez, encontrar치 el nuevo <code>complete/src/test/resources/anystub/stub.yml</code> . </p><br><pre> <code class="plaintext hljs">request0: exception: [] keys: [GET, HTTP/1.1, 'https://gturnquist-quoters.cfapps.io/api/random'] values: [HTTP/1.1, '200', OK, 'Content-Type: application/json;charset=UTF-8', 'Date: Thu, 25 Apr 2019 23:04:49 GMT', 'X-Vcap-Request-Id: 5ffce9f3-d972-4e95-6b5c-f88f9b0ae29b', 'Content-Length: 177', 'Connection: keep-alive', '{"type":"success","value":{"id":3,"quote":"Spring has come quite a ways in addressing developer enjoyment and ease of use since the last time I built an application using it."}}']</code> </pre> <br><p>  Que paso  spring-boot ha incorporado RestTemplateBuilder desde la configuraci칩n de prueba a la aplicaci칩n.  Esto llev칩 a la aplicaci칩n a trabajar a trav칠s de la implementaci칩n del c칩digo auxiliar del cliente http.  StubHttpClient intercept칩 la solicitud, no encontr칩 el archivo ap칠ndice, ejecut칩 la solicitud, guard칩 el resultado en un archivo y devolvi칩 el resultado recuperado del archivo. </p><br><p>  A partir de ahora, puede ejecutar esta prueba sin conexi칩n a Internet y esta solicitud ser치 exitosa.  <code>restTemplate.getForObject()</code> devolver치 el mismo resultado.  Puede confiar en este hecho en sus futuras pruebas. </p><br><p>  Puede encontrar todos los cambios descritos en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> . </p><br><p>  De hecho, todav칤a no hemos creado una sola prueba.  Antes de escribir pruebas, veamos c칩mo funciona con las bases de datos. </p><br><p>  En este ejemplo, agregaremos una prueba de integraci칩n para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">acceder a datos relacionales usando JDBC con Spring</a> del tutorial fundamental. </p><br><p>  La configuraci칩n de prueba para este caso se ve as칤: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.anystub.jdbc.StubDataSource; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.h2.jdbcx.JdbcDataSource; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Bean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.sql.DataSource; <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DataSource </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ JdbcDataSource ds = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JdbcDataSource(); ds.setURL(<span class="hljs-string"><span class="hljs-string">"jdbc:h2:./test"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StubDataSource(ds); } }</code> </pre> <br><p>  Aqu칤, se crea un origen de datos regular a una base de datos externa y se envuelve con una implementaci칩n de c칩digo auxiliar: la clase StubDataSource.  Spring-boot lo incorpora en contexto.  Tambi칠n necesitamos crear al menos una prueba para ejecutar el contexto de primavera en la prueba. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.anystub.AnyStubId; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.Test; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.runner.RunWith; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.test.context.SpringBootTest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.test.context.junit4.SpringRunner; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.Assert.*; <span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-meta"><span class="hljs-meta">@AnyStubId</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Esto es nuevamente una prueba vac칤a: su 칰nica tarea es ejecutar el contexto de la aplicaci칩n.  Aqu칤 vemos una anotaci칩n muy importante <code>@AnystubId</code> , pero a칰n no estar치 involucrada. </p><br><p>  Despu칠s de la primera ejecuci칩n, encontrar치 un nuevo <code>src/test/resources/anystub/stub.yml</code> que incluye todas las llamadas a la base de datos.  Te sorprender치 c칩mo funciona la primavera detr치s de escena con bases de datos.  Tenga en cuenta que las nuevas ejecuciones de la prueba no conducir치n a un acceso real a la base de datos.  Si elimina test.mv.db, no aparecer치 despu칠s de repetidas ejecuciones de las pruebas.  El conjunto completo de cambios se puede ver en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> . </p><br><p>  Para resumir.  con anyStub: </p><br><ul><li>  no necesita configurar espec칤ficamente un entorno de prueba </li><li>  las pruebas se realizan con datos reales </li><li>  la primera ejecuci칩n de las pruebas prueba sus suposiciones y guarda los datos de la prueba, las siguientes verifican que el sistema no se haya degradado </li></ul><br><p>  Probablemente tenga preguntas: 쯖칩mo cubre esto los casos en que la base de datos a칰n no existe, qu칠 hacer con las pruebas negativas y el manejo de excepciones?  Volveremos a esto, pero primero, nos ocuparemos de escribir pruebas simples. </p><br><p>  Ahora estamos experimentando con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Consumir un servicio web RESTful</a> .  Este proyecto no contiene componentes que se puedan probar.  A continuaci칩n se crean dos clases, que deben representar dos capas de un dise침o de arquitectura. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.client.RestTemplate; <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RestTemplate restTemplate; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataProvider</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RestTemplate restTemplate)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.restTemplate = restTemplate; } <span class="hljs-function"><span class="hljs-function">Quote </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> restTemplate.getForObject( <span class="hljs-string"><span class="hljs-string">"https://gturnquist-quoters.cfapps.io/api/random"</span></span>, Quote.class); } }</code> </pre> <br><p>  DataProvider proporciona acceso a datos en <del>  vol치til </del>  sistema externo </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component; <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DataProvider dataProvider; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataProcessor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataProvider dataProvider)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dataProvider = dataProvider; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dataProvider.provideData().getValue().getQuote().length(); } }</code> </pre> <br><p>  DataProcessor procesar치 datos de un sistema externo. </p><br><p>  Tenemos la intenci칩n de probar el <code>DataProcessor</code> .  Es necesario probar la correcci칩n del algoritmo de procesamiento y proteger el sistema de la degradaci칩n de futuros cambios. </p><br><p>  Para lograr estos objetivos, puede considerar crear un objeto simulado DataProvider con un conjunto de datos y pasarlo al constructor DataProcessor en las pruebas.  Otra forma podr칤a ser descomponer el DataProcessor para resaltar el procesamiento de la clase Quote.  Entonces, tal clase es f치cil de probar usando pruebas unitarias (seguramente, este es el m칠todo recomendado en libros respetados sobre c칩digo limpio).  Intentemos evitar los cambios de c칩digo y la invenci칩n de los datos de prueba y simplemente escriba una prueba. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataProcessorTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DataProcessor dataProcessor; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-meta"><span class="hljs-meta">@AnyStubId</span></span>(filename = <span class="hljs-string"><span class="hljs-string">"stub"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processDataTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertEquals(<span class="hljs-number"><span class="hljs-number">131</span></span>, dataProcessor.processData()); } }</code> </pre> <br><p>  Es hora de hablar sobre la anotaci칩n @AnystubId.  Esta anotaci칩n ayuda a administrar y controlar archivos de c칩digo auxiliar en las pruebas.  Se puede usar con una clase de prueba o su m칠todo.  Esta anotaci칩n configura un archivo ap칠ndice individual para el 치rea correspondiente.  Si cualquier 치rea est치 cubierta simult치neamente por anotaciones de nivel de clase y m칠todo, la anotaci칩n de m칠todo tiene prioridad.  Esta anotaci칩n tiene el par치metro de nombre de archivo, que define el nombre del archivo ap칠ndice.  la extensi칩n ".yml" se agrega autom치ticamente si se omite.  Al ejecutar esta prueba, <strong>no</strong> encontrar치 un nuevo archivo.  El <code>src/test/resources/anystub/stub.yml</code> ya se cre칩 anteriormente y esta prueba lo reutilizar치.  Obtuvimos el n칰mero 131 de este c칩digo analizando el resultado de la consulta. </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-meta"><span class="hljs-meta">@AnyStubId</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processDataTest2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertEquals(<span class="hljs-number"><span class="hljs-number">131</span></span>, dataProcessor.processData()); Base base = getStub(); assertEquals(<span class="hljs-number"><span class="hljs-number">1</span></span>, base.times(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>)); assertTrue(base.history().findFirst().get().matchEx_to(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-string"><span class="hljs-string">".*gturnquist-quoters.cfapps.io.*"</span></span>)); }</code> </pre> <br><p>  En esta prueba, la anotaci칩n @AnyStubId aparece sin el par치metro de nombre de archivo.  En este caso, <code>src/test/resources/anystubprocessDataTest2.yml</code> .  El nombre del archivo se crea a partir del nombre de la funci칩n (clase) + ".yml".  Una vez que anyStub crea un nuevo archivo para esta prueba, debe realizar una llamada real al sistema.  Y es nuestra suerte que la nueva cita tenga la misma longitud.  Las dos 칰ltimas comprobaciones muestran c칩mo probar el comportamiento de la aplicaci칩n.  Est치 disponible para usted: seleccionando consultas por par치metros o partes de par치metros y contando el n칰mero de consultas.  Hay varias variaciones de los tiempos <em>y las</em> funciones de <em>coincidencia</em> que se pueden encontrar en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci칩n</a> . </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-meta"><span class="hljs-meta">@AnyStubId</span></span>(requestMode = RequestMode.rmTrack) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processDataTest3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertEquals(<span class="hljs-number"><span class="hljs-number">79</span></span>, dataProcessor.processData()); assertEquals(<span class="hljs-number"><span class="hljs-number">79</span></span>, dataProcessor.processData()); assertEquals(<span class="hljs-number"><span class="hljs-number">168</span></span>, dataProcessor.processData()); assertEquals(<span class="hljs-number"><span class="hljs-number">79</span></span>, dataProcessor.processData()); Base base = getStub(); assertEquals(<span class="hljs-number"><span class="hljs-number">4</span></span>, base.times(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>)); }</code> </pre> <br><p>  En esta prueba, @AnyStubId aparece con el nuevo par치metro requestMode.  Le permite administrar permisos para archivos stub.  Hay dos aspectos a controlar: b칰squeda de archivos y permiso para llamar a un sistema externo. </p><br><p>  <code>RequestMode.rmTrack</code> establece las siguientes reglas: si el archivo acaba de crearse, todas las solicitudes se env칤an al sistema externo y se escriben en el archivo con las respuestas, independientemente de si hay una solicitud id칠ntica en el archivo (se permiten duplicados en el archivo).  Si antes de ejecutar las pruebas existe el archivo ap칠ndice, las solicitudes al sistema externo est치n prohibidas.  Las llamadas se esperan exactamente en la misma secuencia.  Si la siguiente solicitud no coincide con la solicitud en el archivo, se genera una excepci칩n. </p><br><p>  <code>RequestMode.rmNew</code> este modo est치 activado por defecto.  Cada solicitud se busca en el archivo ap칠ndice.  Si se encuentra una solicitud coincidente: el resultado correspondiente se restaura desde el archivo, la solicitud al sistema externo se pospone.  Si no se encuentra la solicitud, se solicita el sistema externo, el resultado se guarda en un archivo.  Solicitudes duplicadas en el archivo: no se producen. </p><br><p>  <code>RequestMode.rmNone</code> Cada solicitud se busca en un archivo <code>RequestMode.rmNone</code> .  Si se encuentra una consulta coincidente, su resultado se restaura desde el archivo.  Si la prueba genera una solicitud que no est치 en el archivo, se genera una excepci칩n. </p><br><p>  <code>RequestMode.rmAll</code> antes de la primera solicitud, se borra el archivo <code>RequestMode.rmAll</code> .  Todas las solicitudes se escriben en el archivo (se permiten duplicados en el archivo).  Puede usar este modo si desea ver c칩mo funciona la conexi칩n. </p><br><p>  <code>RequestMode.rmPassThrough</code> todas las solicitudes se env칤an directamente al sistema externo, sin pasar por el c칩digo auxiliar de implementaci칩n. </p><br><p>  Estos cambios est치n disponibles en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub.</a> </p><br><h1 id="chto-eschyo">  Que mas </h1><br><p>  Vimos c칩mo anyStub guarda las respuestas.  Si se produce una excepci칩n al acceder a un sistema externo, anyStub lo guardar치 y lo reproducir치 en solicitudes posteriores. </p><br><p>  A menudo, las clases de nivel superior generan excepciones, mientras que las clases de conexi칩n reciben una respuesta v치lida (probablemente con un c칩digo de error).  En este caso, anyStub es responsable de reproducir la respuesta con el c칩digo de error, y las clases de nivel superior tambi칠n arrojar치n excepciones para sus pruebas. </p><br><p>  Agregue archivos de resguardo al repositorio. </p><br><p>  No tenga miedo de eliminar y sobrescribir archivos de c칩digo auxiliar. </p><br><p>  Administre archivos stub con prudencia.  Puede reutilizar un archivo en varias pruebas o proporcionar un archivo individual para cada prueba.  Aproveche esta oportunidad para sus necesidades.  Pero, por lo general, usar un solo archivo con diferentes modos de acceso es una mala idea. </p><br><p>  Estas son todas las caracter칤sticas principales de anyStub. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/450958/">https://habr.com/ru/post/450958/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450946/index.html">Disco celular en LPC810</a></li>
<li><a href="../450948/index.html">MU-MIMO: uno de los algoritmos de implementaci칩n</a></li>
<li><a href="../450950/index.html">Conceptos b치sicos de Dart Streams</a></li>
<li><a href="../450952/index.html">칈ndice medio y Antibank</a></li>
<li><a href="../450954/index.html">C칩mo aprendimos a explotar Java en Docker</a></li>
<li><a href="../450962/index.html">Bombas de insulina, microchips a prueba de manipulaciones y radio definida por software.</a></li>
<li><a href="../450964/index.html">Nueva biblioteca intr칤nseca x86 SIMD - depuraci칩n de immintrin</a></li>
<li><a href="../450966/index.html">Grabar video de una computadora vieja - m칠todos de LGR</a></li>
<li><a href="../450970/index.html">C칩mo comparar realmente los precios de Apple en los Estados Unidos y Rusia. Experiencia personal</a></li>
<li><a href="../450972/index.html">쮺칩mo organizar un estudio fotogr치fico? Caso de Bolshakova Studio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>