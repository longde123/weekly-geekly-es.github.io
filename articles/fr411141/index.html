<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüîß üç∂ üßëüèª "Smart home" sur Arduino pour un vestiaire üíè üë®üèø‚ÄçüöÄ ‚õèÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Rien d'extraordinaire, juste un autre contr√¥leur Arduino. Avec des capteurs, des bobines et une page Web. Mais avec ses propres caract√©ristiques et un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>"Smart home" sur Arduino pour un vestiaire</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/411141/"><img src="https://habrastorage.org/webt/7o/3k/or/7o3kora9koagtgemf_xxr71mlkk.jpeg"><br><br>  Rien d'extraordinaire, juste un autre contr√¥leur Arduino.  Avec des capteurs, des bobines et une page Web.  Mais avec ses propres caract√©ristiques et une application pratique tr√®s sp√©cifique, bien que tout √† fait banale - l'inclusion √† distance du chauffage √©lectrique dans le pays.  Les citations dans l'en-t√™te ne sont pas al√©atoires, le contr√¥leur n'est pas une maison intelligente dans la version actuelle, mais sert de bonne base pour cela.  <i>(note - cette phrase a √©t√© ajout√©e le 04/12/18 sur la base des commentaires).</i> <br><br>  Caract√©ristiques cl√©s: <br><br><ul><li>  Capteur de param√®tres de r√©seau √©lectrique - compteur √©lectrique ¬´Neva¬ª selon RS-485; </li><li>  Modification √† distance de la page Web de contr√¥le se trouvant sur la carte SD; </li><li>  Inclusion fiable d'un groupe de capteurs de temp√©rature de Dallas sur de longues lignes; </li><li>  Graphiques des changements de param√®tres sans impliquer les services cloud; </li><li>  Solutions de s√©curit√© (chien de garde externe, UPS, red√©marrage automatique du routeur); </li><li>  Protection du bouclier Internet contre le gel pendant les interf√©rences des relais de puissance; </li><li>  Conception compl√®te dans un bo√Ætier sur rail DIN. </li></ul><a name="habracut"></a><br>  J'ai fait ce syst√®me lentement, √† titre de divertissement, de temps en temps en lan√ßant le projet pendant des mois ... Cela a pris environ un an et demi de l'id√©e √† la mise en ≈ìuvre :) <br><br>  Depuis avant que je n'avais pas affaire aux microcontr√¥leurs, j'ai commenc√© avec le kit de d√©marrage avec aliexpress, jou√© avec des LED, des boutons et des capteurs, j'ai compris quelque chose et j'ai commenc√© √† construire un contr√¥leur pour la t√©l√©commande et la surveillance.  Eh bien, la ¬´maison intelligente¬ª n'est pas directe, bien s√ªr, mais quelque chose comme √ßa. <br><br>  L'objectif pratique a d'abord √©t√© fix√© un - allumer √† distance le chauffage dans le pays.  Je n‚Äôai pas encore r√©ussi √† construire une maison (mes mains n‚Äôont pas atteint, hein), mais j‚Äôai un magnifique <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">chalet d‚Äô√©t√©</a> confortable en viande hach√©e chauff√©e par des convecteurs √©lectriques.  R√©chauffez un vestiaire qui s'est refroidi pendant la semaine vendredi soir - une opportunit√© tr√®s tentante pendant la saison froide. <br><br>  Cependant, la t√¢che de contr√¥le √† distance de la charge s'est av√©r√©e assez banale.  Arduino plus le bouclier Internet, un croquis pr√™t √† l'emploi d'Internet et les bobines cliquent d√©j√† √† partir des coches sur la page Web.  L'objectif pratique a en quelque sorte √©t√© atteint tr√®s rapidement et simplement.  Et c'√©tait ennuyeux.  Je voulais quelque chose de plus int√©ressant. <br><br>  Je me suis fix√© un deuxi√®me objectif pratique: surveiller la consommation actuelle du r√©seau de chalets d'√©t√©.  J'ai eu des capteurs de courant sans pr√©tention pour les tests, j'ai jou√©.  Tout fonctionnait bien, mais cette option n'√©tait pas adapt√©e au travail de combat.  Je ne pouvais pas trouver de capteurs plus puissants que sur 5A, mais j'avais besoin d'au moins 25A. <br><br>  Et j'ai eu l'id√©e d'utiliser un compteur d'√©lectricit√© comme capteur de puissance.  Et c'√©tait une grande pens√©e!  Et j'ai cr√©√© un tel appareil, et j'ai vu que c'√©tait bon!  Non sans difficult√©s, mais j'ai parfaitement accompli cette t√¢che, avec pour r√©sultat un sentiment de profonde satisfaction, et je vous le dirai ci-dessous :). <br><br>  <b>Fonctionnel</b> <br><br>  La premi√®re (et jusqu'√† pr√©sent la derni√®re) version de combat du contr√¥leur "maison intelligente" a cette fonctionnalit√©: <br><br><ul><li>  Contr√¥le manuel √† distance de l'activation du relais de puissance via un navigateur et surveillance de leur √©tat actuel; </li><li>  Surveillance √† distance des param√®tres d'un r√©seau d'alimentation triphas√© (tension, courant, fr√©quence et bien d'autres d√©chets inutiles, que j'ai ensuite √©teints); </li><li>  Surveillance √† distance des relev√©s d'un compteur d'√©lectricit√© √† deux tarifs; </li><li>  Surveillance √† distance d'un groupe de capteurs de temp√©rature; </li><li>  Enregistrement des donn√©es et enregistrement des √©v√©nements sur une carte m√©moire; </li><li>  Affichage dans le navigateur des donn√©es de tous les capteurs du jour s√©lectionn√© sous forme de graphiques. </li></ul><br>  <b>Id√©ologie</b> <br><br>  Le principe de la construction de l'ensemble du syst√®me - sans utiliser de services cloud tiers et de serveurs de collecte et d'affichage de donn√©es.  Ce n'est ni bon ni mauvais.  Au stade initial de la ¬´construction intelligente¬ª, un tel sch√©ma est suffisant et simple.  Bien qu'il impose certaines restrictions d'utilisation. <br><br>  Arduino avec un bouclier Internet est le seul serveur Web du syst√®me.  La page Web avec l'interface de gestion est stock√©e sur la carte m√©moire Internet et transmise au navigateur lorsqu'elle est accessible par l'adresse IP sp√©cifi√©e.  L'interaction de l'interface utilisateur avec Arduino se poursuit via des scripts java, dont les corps ne sont pas int√©gr√©s dans la page Web, mais sont stock√©s sur mon stockage de fichiers personnels avec acc√®s √† Internet.  Cette approche r√©duit le poids de la page Web, ce qui acc√©l√®re sa lecture depuis la carte SD et vous permet de modifier plus rapidement et facilement le code du script. <br><br>  La lecture du journal de donn√©es pour l'affichage des graphiques est effectu√©e √† partir de la carte m√©moire sur demande (en appuyant sur un bouton dans un navigateur).  Les donn√©es sont affich√©es uniquement dans la session en cours de la page du navigateur, elles ne sont enregistr√©es nulle part et lorsque vous rechargez la page, vous devez la relire.  C'est un inconv√©nient de l'id√©ologie, car la lecture √† partir d'une carte m√©moire est assez lente, et l'obtention d'une quantit√© quotidienne de donn√©es peut prendre une minute ou deux (il y avait une id√©e de retravailler le format de stockage des donn√©es pour r√©duire sa taille et acc√©l√©rer la lecture). <br><br>  Les valeurs actuelles des capteurs sont affich√©es sur la page et mises √† jour en temps r√©el avec la fr√©quence du cycle de boucle, que j'ai est d'environ 1 Hz. <br><br>  Il n'y a plus de ¬´smartness¬ª dans l'algorithme maintenant.  Si je vais admonester l'algorithme √† l'avenir - je ne sais pas, pour l'instant la version actuelle me satisfait compl√®tement. <br><br>  <b>Topologie du r√©seau</b> <br><br>  Au chalet, Internet mobile Yota (modem usb + routeur wifi).  Il n'y a pas d'adresse IP fixe et il n'y a aucun moyen de l'obtenir non plus, m√™me pour de l'argent.  Et m√™me s'il n'y a pas d'adresse IP blanche dynamique, DynDNS n'est pas applicable.  Seule l'adresse IP grise du r√©seau interne Yota.  IPota Yota ne prend pas en charge (au moins pour 2017, c'est le cas).  Par cons√©quent, je n'ai trouv√© qu'un seul moyen d'acc√©der au routeur du pays de l'ext√©rieur - VPN. <br><br>  √Ä la maison (dans la ville) Internet filaire avec une adresse IP fixe blanche.  Routeur, suivi du stockage r√©seau.  Un serveur VPN a √©t√© cr√©√© sur ce routeur domestique.  Le routeur de pays est configur√© pour √©lever le tunnel VPN PPTP vers le routeur domestique. <br><br>  Le contr√¥leur sur Arduino est connect√© au port LAN du routeur national et se trouve derri√®re NAT, le 80e port lui est transmis.  Ainsi, je ne peux acc√©der √† Arduino qu'√† partir de mon VPN.  En cons√©quence, le LAN domestique et le VPN que j'ai sont deux segments du m√™me sous-r√©seau, l'acc√®s y est direct.  Sur son ordinateur de bureau et sur un smartphone, il a mis en place une connexion VPN et a √©galement acc√©d√© √† Arduino.  Pas tr√®s pratique √† utiliser, mais √ßa marche.  Oui, et une s√©curit√© relative est fournie - sans autorisation dans mon VPN, personne d'autre ne peut acc√©der √† la page de gestion du contr√¥leur. <br><br>  Le goulot d'√©tranglement est le tunnel VPN vers le routeur du pays.  Chute p√©riodiquement.  De plus, c'est la connexion PPTP qui est en train d'√™tre d√©truite, l'acc√®s √† Internet reste.  Et le plus m√©chant, c'est que lorsque la connexion PPTP est rompue, elle ne monte plus d'elle-m√™me.  M√™me le red√©marrage du routeur ne sauvegarde pas.  Seul un red√©marrage complet de son alimentation avec un modem USB, puis pas imm√©diatement.  Vous devez l'√©teindre, attendre 10 minutes, le rallumer.  Heureusement - bien, non - la prochaine it√©ration.  La raison, selon le support technique de Zyxel, est que l'op√©rateur cellulaire bloque les paquets PPTP, car un c√¥t√© envoie correctement, l'autre √©coute correctement, mais les donn√©es n'atteignent pas (j'ai des routeurs Zyxel aux deux extr√©mit√©s du tunnel VPN).  Yota semble √™tre √† bl√¢mer, mais r√©aliser quelque chose d'intelligible d'eux est impossible.  Ou peut-√™tre pas Yota. <br><br>  <b>Chien de garde</b> <br><br>  Pour assurer un fonctionnement relativement fluide du VPN, j'utilise un chien de garde du programme de <strike>b√©quille</strike> - le routeur du pays est aliment√© par un relais de puissance contr√¥l√© par Arduina, et d√®s que le serveur VPN cesse de cingler (√©galement ping Arduina), puis apr√®s 10 minutes, l'alimentation est coup√©e du routeur pendant 10 minutes, puis le routeur √† nouveau Il s'allume et devrait √©tablir une connexion PPTP dans les 5 minutes.  S'il n'y a pas de connexion, l'it√©ration suivante.  Parfois, ce compos√© fonctionne de mani√®re stable pendant des semaines, voire des mois, et parfois il commence √† se briser presque quotidiennement.  Aucun autre moyen de r√©soudre le probl√®me n'a encore √©t√© identifi√©.  Comme je l'ai d√©j√† dit, Yota ne prend pas en charge IPv6, il ne donne pas et ne vend pas d'IP blanche aux physiciens, il n'y a pas d'autre fournisseur avec des tarifs normaux et, bien s√ªr, un trafic illimit√©.  Cependant, cette d√©cision, bien qu'une b√©quille, mais remplit tr√®s bien sa t√¢che.  Maintenant, j'ai toujours une connexion, √† quelques exceptions pr√®s, quand j'arrive au moment du red√©marrage. <br><br>  En plus du logiciel, j'ai √©galement impl√©ment√© un chien de garde mat√©riel.  Juste au cas o√π.  Le contr√¥leur devrait fonctionner pendant des semaines et parfois m√™me des mois en mon absence, et ne pas se bloquer.  Je ne savais pas comment toute cette √©conomie se comporterait en gros inconv√©nients, donc j'√©tais en s√©curit√©.  Le chien de garde int√©gr√© √† Atmega ne fonctionnait pas pour moi parce que je ne travaillais pas du tout chez Arduino Mega ¬´out of the box¬ª, et pour le faire fonctionner, je devais m'amuser beaucoup.  Ce probl√®me est bien d√©crit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  De plus, il dispose d'un intervalle maximum de 8 secondes, ce qui m'a sembl√© insuffisant.  Par cons√©quent, j'ai appliqu√© une puce de surveillance sp√©cialis√©e TPL5000DGST, dont l'intervalle est d√©fini par une combinaison de trois broches et peut atteindre 64 secondes, ce qui me convient parfaitement.  Pour cette puce, j'ai achet√© une petite planche √† pain, je l'ai soud√©e et fix√©e sur le connecteur avec les ports IO d'Arduina (la photo sera plus basse dans la section d'assemblage).  Les tests ont montr√© le fonctionnement fiable de ce chien de garde et je me demandais √† quelle fr√©quence il fonctionnerait en r√©alit√©.  Pour ce faire, j'ai ajout√© une variable au code de programme o√π l'heure et la date de lancement du programme sont stock√©es et ces informations sont affich√©es sur la page Web de contr√¥le.  La pratique a montr√© que, contrairement √† un VPN, le contr√¥leur fonctionne bien pendant longtemps et le chronom√®tre de surveillance n'a jamais √©t√© utile (lors de la r√©daction de l'article, il a fonctionn√© pour la premi√®re fois, ce n'√©tait pas en vain).  Le temps de fonctionnement continu a atteint plus de 3 mois et aurait pu √™tre plus long si je n'avais pas besoin de corriger de temps en temps quelque chose dans le code et de reflasher le contr√¥leur. <br><br>  <b>Le capteur des param√®tres du r√©seau d'alimentation - le compteur √©lectrique Neva</b> <br> <a href=""><img height="200" src="https://habrastorage.org/getpro/habr/post_images/845/f35/bd5/845f35bd5d12bc60384f1aa0bb1506aa.jpg" width="200"></a> <br><br>  Comme je l'ai mentionn√© ci-dessus, √† mon avis, rien de mieux et de plus pr√©cis qu'un compteur √©lectrique num√©rique moderne avec une interface d'acc√®s aux donn√©es externe ne peut √™tre trouv√© comme capteur de param√®tres d'alimentation.  J'ai choisi le comptoir Neva de la soci√©t√© de Saint-P√©tersbourg Taypit avec l'interface RS-485. <br><br>  Je souligne qu'un compteur √©lectrique avec des fils de la 485e interface connect√©s en permanence √† celui-ci n'est pas officiellement autoris√© √† √™tre utilis√© comme compteur ( <b>mise √† jour</b> : dans les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">commentaires, ils ont</a> sugg√©r√© qu'il √©tait autoris√©).  Par cons√©quent, dans le r√©seau √©lectrique du chalet, j'ai mis deux compteurs en s√©rie.  Le premier est un compteur d'√©lectricit√© officiel, scell√© et enregistr√©, situ√© dans le panneau d'entr√©e de la rue.  Le deuxi√®me est mon capteur d'alimentation, non scell√© et non comptabilis√©, dont la soci√©t√© de vente d'√©nergie ne se soucie pas, car elle ne se soucie pas de tout ce qui est install√© apr√®s le dispositif de mesure.  Ce compteur √©lectrique est d√©j√† situ√© dans le panneau √† l'int√©rieur du vestiaire, et dans le m√™me panneau, il y a aussi un contr√¥leur sur Arduino, mais plus √† ce sujet plus tard. <br><br>  Au chalet, j'ai un r√©seau d'alimentation triphas√©.  En ville, je ne peux d√©boguer que sur une seule phase.  J'ai donc acquis deux m√®tres, un Neva MT-324 triphas√© et un Neva MT-124 monophas√©.  Le d√©bogage initial du contr√¥leur a √©t√© effectu√© sur la table sur un compteur triphas√© avec une seule phase connect√©e, puis install√© r√©guli√®rement dans le bouclier de la datcha en mode de fonctionnement de combat.  Le d√©bogage des modifications logicielles ult√©rieures a d√©j√† √©t√© effectu√© sur un compteur monophas√© moins cher sur la table: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/a5a/5cb/6fb/a5a5cb6fb932dea11badc7f06376e22d.jpg" width="640"></a> <br><br>  Pour connecter le compteur √† Arduino, un convertisseur de niveau RS-485 en TTL est requis: <br> <a href=""><img height="200" src="https://habrastorage.org/getpro/habr/post_images/258/07f/e5a/25807fe5acb55ec27d079d024a24b1f0.jpg" width="200"></a> <br><br>  De plus, pour travailler avec le compteur, vous avez besoin d'un port s√©rie gratuit sur Arduino.  Malheureusement, Arduino Uno n'a qu'un seul port s√©rie, si vous le preniez sous le compteur, vous auriez √† perdre la sortie de d√©bogage des informations textuelles (moniteur de port), et sans cela, il serait impossible d'√©crire un croquis.  Par cons√©quent, j'utilise Arduino Mega, qui poss√®de plusieurs ports s√©rie.  Il serait possible d'impl√©menter le deuxi√®me port s√©rie softovo via les ports num√©riques d'Arduino, mais je n'ai pas trouv√© de biblioth√®que appropri√©e avec la possibilit√© de modifier d'autres param√®tres de port, √† l'exception de la vitesse.  Et les param√®tres du port de compteur sont diff√©rents de ceux par d√©faut: d√©bit 9600 bits, 7 bits de donn√©es, 1 bit d'arr√™t, contr√¥le de parit√© - m√™me.  L'objet s√©rie standard dans Arduino, heureusement, vous permet de faire ces r√©glages. <br><br>  Il √©tait relativement facile d'obtenir le protocole d'√©change avec le compteur - le fabricant du compteur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans le domaine public</a> a un programme pour lire les param√®tres sous Windows, qui a √©galement un moniteur de port.  Pour connecter le lecteur √† un ordinateur, j'ai utilis√© le convertisseur d'interface MOXA 232/432 / 485USB.  Un peu de temps pour l'analyse visuelle des packages - et j'ai distingu√© les commandes principales. <br><br>  Cependant, cela ne me semblait pas suffisant et j'ai contact√© le fabricant par e-mail.  Apr√®s un mois de correspondance avec Typit, j'ai finalement r√©ussi √† obtenir une liste compl√®te des commandes avec interpr√©tation: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Codage des param√®tres MT3XX E4S</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Codage des param√®tres NEVA MT124 AS OP (E4P)</a> <br><br>  <b>mise √† jour 10.28.2019</b> : Explications des commandes.  Les commandes du tableau sont repr√©sent√©es sous forme de caract√®res de texte.  Autrement dit, o√π il en co√ªte 0 (z√©ro), vous devez envoyer 0x30.  Les points et les ast√©risques sont des s√©parateurs pour la beaut√©, ils ne veulent rien dire et vous n'avez pas besoin de les envoyer.  √Ä la fin de la commande, un octet de somme de contr√¥le est ajout√©, qui est calcul√© en tenant compte du pr√©fixe et du postfixe de la commande, qui ne sont pas indiqu√©s dans le tableau.  Le pr√©fixe de toutes les commandes de lecture est 0x01 0x52 0x31 0x02.  Ce suffixe est 0x28 0x29 0x03.  Cependant, l'envoi d'un pr√©fixe n'est pas n√©cessaire, et un suffixe semble √™tre obligatoire.  Exemple: commande de lecture de date 09.09.02 * FF.  En fait, vous devez passer les codes de caract√®res de texte 000902FF.  C'est-√†-dire, 0x30 0x30 0x30 0x39 0x30 0x32 0x46 0x46.  Ajoutez le pr√©fixe et le suffixe, nous obtenons l'ensemble 0x01 0x52 0x31 0x02 0x30 0x30 0x30 0x39 0x30 0x32 0x46 0x46 0x28 0x29 0x03.  Nous lisons la somme de contr√¥le comme xor de tous les octets moins 1 et ajoutons l'octet re√ßu √† la fin.  Le pr√©fixe est supprim√© comme facultatif.  En cons√©quence, nous envoyons cela au compteur - 0x30 0x30 0x30 0x39 0x30 0x32 0x46 0x46 0x28 0x29 0x03 0x68.  Le d√©but du cycle d'√©change doit √™tre pr√©c√©d√© des commandes d'initialisation de l'√©change, dans l'esquisse ci-dessous, ces commandes sont marqu√©es comme // D√©but 1, 2, 3. Une fois l'√©change initialis√©, vous pouvez lire les donn√©es du compteur dans le cycle pendant une dur√©e arbitraire, mais apr√®s avoir perdu la communication et peut-√™tre apr√®s un manque prolong√© d'√©change pour d'autres raisons, une r√©initialisation est n√©cessaire. <br><br>  De plus, la question technique est d'√©crire un cycle d'interrogation des param√®tres sous Arduino et de les afficher pour les d√©marreurs dans le moniteur de port.  Le temps d'un cycle s'est av√©r√© √™tre d'environ une seconde.  Cependant, dans la version finale du projet avec l'enregistrement des donn√©es sur un lecteur flash et des capteurs de temp√©rature d'interrogation, ce temps est pass√© √† 4 secondes.  Cela ne me convenait pas du tout et devait plonger dans l'optimisation.  En cons√©quence, j'ai √† nouveau atteint un deuxi√®me intervalle sans perdre de fonctionnalit√©.  Soit dit en passant, j'ai r√©√©crit le croquis √† partir de z√©ro deux ou trois fois jusqu'√† ce que je trouve la bonne architecture et les algorithmes √©conomiques. <br><br>  <b>Impl√©mentation logicielle d'√©change avec un compteur</b> <br><br>  Le code est extrait du contexte de mon grand croquis de travail.  Compil√©, mais sous cette forme, je ne l'ai jamais ex√©cut√©.  Je ne le donne qu'√† titre d'exemple et non √† titre de programme de travail termin√©.  Bien qu'en th√©orie, tout devrait fonctionner sous cette forme. <br><br>  Le code est √©crit pour deux types de compteurs simultan√©ment, le MT-124 monophas√© et le MT-324 triphas√©.  Le type de compteur est s√©lectionn√© automatiquement dans le programme par le mot de r√©ponse de la commande d'initialisation. <br><br>  Je cite le code tel quel, sans joliesse et sans commentaires suppl√©mentaires √† l'exception de ceux que j'ai √©crits moi-m√™me.  Et oui, je ne suis pas programmeur, et je n‚Äô√©tudie m√™me pas pour cela, donc vous ne devriez pas me botter pour la qualit√© du code, mais vous pouvez apprendre √† coder: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">EnergyMeterNeva.ino</a> <br><br>  Un √©norme avantage suppl√©mentaire du compteur d'√©lectricit√© est une horloge en temps r√©el fiable et pr√©cise.  Je n'ai pas eu √† fournir au syst√®me un module suppl√©mentaire, qui doit toujours √™tre trouv√© non seulement de toute fa√ßon, mais de haute qualit√©.  L'heure actuelle pr√©cise √† la seconde pr√®s que j'obtiens du compteur, entre autres donn√©es.  Oui, en ce qui concerne le temps atomique, le temps du compteur est l√©g√®rement d√©cal√© (quelques secondes), je ne sais pas √† quoi il est connect√©, un r√©glage d'usine de mauvaise qualit√© ou autre chose, mais la pr√©cision est excellente, juste avec un l√©ger biais. <br><br>  Dans de rares moments, lorsque l'alimentation au chalet est coup√©e et que le compteur devient indisponible, je re√ßois l'heure actuelle du minuteur interne d'Arduina.  Lorsque le compteur √©lectrique fonctionne et que ses donn√©es sont disponibles, je r√©√©cris la minuterie interne d'Arduina avec la valeur du compteur sur chaque boucle de boucle.  Lorsque le compteur tombe - l'heure actuelle continue de cocher la minuterie Arduina. <br><br>  En plus de la lecture des param√®tres, le compteur peut bien entendu √™tre programm√©.  Autrement dit, l'interface fonctionne √† la fois pour la lecture et l'√©criture.  Cependant, avec de telles difficult√©s, j'essayais d'obtenir un protocole de lecture des commandes que je n'ai m√™me pas fait allusion au fabricant sur la demande d'un protocole d'enregistrement.  Premi√®rement, je n'en avais pas besoin, sauf peut-√™tre juste un peu de temps pour le d√©placer.  Deuxi√®mement, je soup√ßonne que ces donn√©es ne sont plus publiques, car elles peuvent √™tre utilis√©es √† des fins frauduleuses. <br><br>  <b>Capteurs de temp√©rature</b> <br><br>  J'ai d√©j√† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">effectu√© un</a> test de capteurs de temp√©rature avec un exemple de croquis s√©par√©ment plus t√¥t.  Maintenant, il ne restait plus qu'√† int√©grer leur enqu√™te dans le projet principal.  Ce n'√©tait pas difficile.  Les neuf capteurs que j'ai utilis√©s ont fonctionn√© sans probl√®me lorsque j'ai allum√© 1-Wire en parall√®le.  La plage de lectures entre eux √©tait d'environ 0,5 degr√©s, ce qui montre l'inutilit√© de les utiliser avec une pr√©cision maximale de 0,0625 degr√©s.  J'ai rassembl√© les capteurs pour le test dans un pack et l'ai envelopp√© dans plusieurs couches de poly√©thyl√®ne adh√©sif.  Pour une plus grande pr√©cision, j'ai plac√© le pack verticalement et attendu un jour pour √©galiser compl√®tement la temp√©rature.  Les lectures de tous les capteurs ne se sont pas r√©v√©l√©es √™tre les m√™mes. <br><br>           .    ,         ,     ,          delay(750).       ‚Äî       ,     (  750  ),     .    ,        ‚Äî     ,     .        LOOP ,          .             ‚Äî  LOOP   1-1.5 ,     . <br><br>        ¬´85¬ª  ¬´0¬ª.    ,     ,            .        ‚Äî       .      ,    .      ,      (   )    . <br><br>        -, -     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DS18x20_Temperature.ino</a> <br><br>                    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TempSensors_DS18B20.ino</a> <br><br>       1-Wire     4.7      .         SMD-,          5.1 ,    (           ).   . <br><br>            (+5, gnd  data),  9 ,  .            .        .   ‚Äî   .   ‚Äî   ,                .         ,       ,      .           ,          .    : <br><br> <a href=""><img height="300" src="https://habrastorage.org/getpro/habr/post_images/84e/1a3/b3d/84e1a3b3d64983af4236a6dad5458a52.jpg" width="640"></a> <br><br>         ,    ,   . <br><br>      ,  ‚Äî   ,    ,       .         ,             (.  -   ). -       , -       . <br><br>    ,  ..   (      )      ‚Ä¶  ?        ,       .       .               ,    . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La longueur totale de la paire torsad√©e dans les cabines √©tait d'environ 25 m√®tres. Pi√®ces pour capteurs externes - 5 et 10 m√®tres, et une pi√®ce interne de dix m√®tres avec des branches pour sept capteurs. Tout fonctionne presque parfaitement. Seuls des tirets se croisent occasionnellement au lieu des valeurs de temp√©rature. Cela signifie que les donn√©es d'un capteur particulier n'ont pas √©t√© lues correctement. Mais cela arrive si rarement (je le remarque peut-√™tre une fois par mois) que cela ne pose aucun probl√®me. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bouclier Ethernet d' </font><b><font style="vertical-align: inherit;">acc√®s √† distance a</font></b><font style="vertical-align: inherit;"> √©t√© achet√© pour l'acc√®s √† distance √† Arduino. Avec une biblioth√®que int√©gr√©e, travailler avec elle, comme tout le reste dans Arduino, s'est av√©r√© assez simple.</font></font><br><br>      .    -,       ()  -   .       ,    . <br><br>         ,    ‚Äî  ,    ‚Äî   . <br><br>   -   ,              ,    html  : <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/1e0/2fa/c9e/1e02fac9e6e1e8c5a16d0a7c07667f94.png" width="475"></a> <br><br>  html-     ,          .                 JSON. <br><br>                .                . ,          .      html-,  ,   java-     - ,       .    ,     ,   . .  . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je cite les fragments de code de mon impl√©mentation de ce m√©canisme. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans la page html, nous int√©grons le formulaire:</font></font><br><br><pre><code class="plaintext hljs">&lt;script type="text/javascript" src="http://domain/send_HTM.js"&gt;&lt;/script&gt;&lt;/pre&gt; &lt;pre style="font-size: 14px;"&gt;&lt;form&gt; &lt;br&gt;&lt;br&gt; CONTROL.HTM:&lt;br&gt; &lt;textarea cols="100" rows="20" wrap="off" id="htm"&gt;&lt;/textarea&gt;&lt;br&gt; &lt;input type="button" value="" onclick="send_HTM();"&gt;&lt;br&gt; &lt;div id="progress" style="display:none"&gt; &lt;div id="label"&gt;  :&lt;/div&gt; &lt;div style="width:800px;border:1px solid #000"&gt; &lt;div id="bar" style="background:#00f;height:10px;width:0px"&gt;&lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/form&gt;</code> </pre> <br>  Le bouton "Envoyer" lance le script <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Java</a> suivant: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">send_HTM.js</a> <br><br>  Dans l'esquisse de la fonction de traitement des demandes de serveur Web par pr√©fixes dans la demande 'CONTROL.HTM' (d√©but d'envoi du fichier), 'htmlineN' (envoi du num√©ro de ligne) et 'END_CONTROL.HTM' (fin d'envoi du fichier), nous d√©terminons les actions suivantes: <br><br><pre> <code class="plaintext hljs">File acceptHtmFile; ................ if (fl_accept_htm) //  'CONTROL.HTM' { SD.remove(CTRL_HTM); acceptHtmFile = SD.open(CTRL_HTM, FILE_WRITE); //     if (!acceptHtmFile) //      -    { #ifdef DEBUG_SD Serial.println("SD-card not found"); #endif client.print("FAIL"); client.stop(); } else client.print("OK_OPEN_FILE"); acceptHtmMode = true; break; } if (fl_htmline) //  'htmlineN' { int b = acceptHtmFile.println(tag); if (b == 0) { client.print("FAIL"); acceptHtmMode = false; cntHtmModeIteration = 0; } else { client.print("OK"); } cntHtmModeIteration = 0; break; } if (fl_endhtm) //  'END_CONTROL.HTM' { SD.remove(CONTROL_HTM); acceptHtmFile.close(); File htmlFile = SD.open(CONTROL_HTM, FILE_WRITE); //    acceptHtmFile = SD.open(CTRL_HTM); //    for (int i = 0; i &lt; acceptHtmFile.size(); i++) { digitalWrite(PIN_WATCHDOG_DONE, 1); htmlFile.write(acceptHtmFile.read()); digitalWrite(PIN_WATCHDOG_DONE, 0); } acceptHtmFile.close(); htmlFile.close(); client.print("OK_CLOSE_FILE"); acceptHtmMode = false; cntHtmModeIteration = 0; break; }</code> </pre> <br>  Les d√©finitions CONTROL_HTM et CTRL_HTM sont les noms des fichiers html.  Le premier est le fichier principal, le second est le fichier tampon.  Dans le tableau de balises char se trouve le texte de la cha√Æne re√ßue, s√©lectionn√© dans la demande.  La logique est la suivante: lors de la r√©ception des donn√©es, elles sont √©crites dans le fichier spoule, en fin de r√©ception, le fichier spoule est √©cras√© dans le fichier principal.  Je n'arrivais toujours pas √† comprendre comment renommer simplement les fichiers, la biblioth√®que standard SD n'a pas une telle fonction, donc une stupide copie caract√®re par caract√®re, ce qui prend beaucoup de temps. <br><br>  Il serait pratique de stocker le code de la page Web de contr√¥le non pas sur la carte m√©moire du contr√¥leur, mais sur la machine cliente, ou de le t√©l√©charger √† partir d'une ressource externe.  Mais l'interdiction des demandes interdomaines ne le permet pas.  Les javascripts ne peuvent envoyer leurs demandes qu'au nord d'o√π ils ont √©t√© charg√©s.  Dans ce cas, les corps des javascripts peuvent √™tre charg√©s de n'importe o√π, il est seulement important d'o√π la page avec leur appel a √©t√© charg√©e. <br><br>  <b>Enregistrement des donn√©es</b> <br><br>  Le blindage Ethernet a un emplacement pour carte micro-SD √† bord.  C'est √† cause de sa pr√©sence que j'ai d√©cid√© d'√©crire des donn√©es dans des fichiers journaux.  Pour travailler avec une carte m√©moire, il y a aussi une biblioth√®que int√©gr√©e, et pour g√©rer l'√©criture-lecture des fichiers avec elle est g√©n√©ralement √©l√©mentaire. <br><br>  Pour enregistrer la quantit√© de donn√©es, j'ai construit l'algorithme de journalisation afin que l'enregistrement ne se produise que lorsque les donn√©es changent de plus d'un seuil pr√©d√©termin√©.  Pour la temp√©rature, il est de 0,1 ¬∞, pour la tension, il est de 0,2 V.  Les donn√©es d'une journ√©e sont √©crites dans un seul fichier.  √Ä z√©ro heure, un nouveau fichier est cr√©√©.  J'ai choisi le format de texte brut, avec des d√©limiteurs, afin que vous puissiez contr√¥ler rapidement le contenu des fichiers pendant le d√©bogage, et il y aurait une capacit√© simple √† charger dans Excel. <br><br>  Les restrictions de conception ne vous permettent pas d'ins√©rer / retirer facilement une carte m√©moire, j'ai donc utilis√© une grande carte.  Selon mes calculs, il sera rempli pendant plusieurs ann√©es, apr√®s quoi il faudra d√©monter le bo√Ætier, retirer la carte m√©moire et la nettoyer. <br><br>  Je ne vois pas l'int√©r√™t d'enregistrer le code, tout y est compl√®tement trivial - un enregistrement banal de texte dans un fichier.  Et ce code est r√©parti sur toute l'esquisse (non seulement les param√®tres des capteurs sont enregistr√©s, mais aussi une vari√©t√© d'√©v√©nements ponctuels), il est difficile √† isoler. <br><br>  <b>Graphiques</b> <br><br>  En tant que moteur de cartographie, j'utilise la biblioth√®que de visualisation javascript <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">amavart</a> tr√®s flexible.  La biblioth√®que est gratuite et disponible pour t√©l√©chargement et utilisation hors ligne.  J'ai √©galement localis√© cette biblioth√®que sur mon NAS avec un acc√®s Internet permanent.  Le connecter et l'utiliser avec les param√®tres par d√©faut n'est pas difficile, cependant, afin d'obtenir la vue dont j'avais besoin, j'ai d√ª beaucoup bricoler.  Un grand nombre d'exemples sur le site et la disponibilit√© d'une documentation d√©taill√©e ont aid√©. <br><br>  Pour un exemple je donnerai le javascript de dessin des plannings.  En soi, il est inutile, car il ne fonctionne qu'avec un serveur Web et une page html et peut √™tre li√© √† d'autres scripts (c'√©tait il y a longtemps, je ne me souviens pas de tous les d√©tails).  Mais les param√®tres d'apparence de mes graphiques y sont contenus et vous pouvez les obtenir √† partir de l√†: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">get_log.js</a> <br><br>  Le gros avantage de la biblioth√®que amchart est qu'elle peut dessiner les bons graphiques √† partir de donn√©es d√©chir√©es.  Comme je l'ai mentionn√© ci-dessus, dans le journal, je sauvegarde les donn√©es uniquement lorsqu'elles changent.  Autrement dit, cela se produit de mani√®re asynchrone et al√©atoire.  Il peut ne pas y avoir de nouvelles donn√©es pendant plusieurs minutes, puis en quelques secondes, elles changeront plusieurs fois.  Par cons√©quent, les entr√©es du journal s'accompagnent d'intervalles de temps arbitraires.  Amchart prend cela en compte lors du rendu, je n'ai pas √† interpoler les donn√©es avant le rendu.  J'envoie simplement le tableau de donn√©es tel quel et je vois un beau graphique uniforme dans le temps. <br><br>  Je n'ai d√©couvert qu'un seul inconv√©nient de cette biblioth√®que - elle ne sait pas comment (enfin, ou je ne comprends toujours pas comment) mettre √† jour humainement des graphiques en temps r√©el.  Vous pouvez ajouter de nouvelles donn√©es √† celles existantes, mais le redessin est effectu√© √† chaque fois compl√®tement de l'ensemble du tableau de donn√©es, ce qui ralentit consid√©rablement le navigateur.  Cependant, l'id√©ologie m√™me de la lecture des donn√©es d'Arduina pour le rendu √† la demande du navigateur est vici√©e par sa non-optimalit√©, il √©tait donc inutile de se battre pour une mise √† jour rapide en temps r√©el. <br><br>  La bonne solution serait d'organiser un serveur distinct pour le stockage et la visualisation des donn√©es, d'o√π Arduina en temps r√©el les donn√©es tomberaient un peu et seraient stock√©es dans la base de donn√©es, et d'o√π elles pourraient √™tre rapidement envoy√©es √† l'utilisateur dans un navigateur pour visualisation. <br><br>  Maintenant, les graphiques ressemblent √† ceci (sur l'exemple du jour o√π il n'y a personne dans le vestiaire et, par cons√©quent, il n'y a pas de consommation d'√©nergie).  Lorsque les donn√©es actuelles se produisent, l'√©chelle est automatiquement d√©finie pour que tout soit bien ajust√© et les valeurs des niveaux actuels apparaissent sur l'axe vertical: <br><br> <a href=""><img height="246" src="https://habrastorage.org/getpro/habr/post_images/12e/6d5/7e5/12e6d57e563012ba95a5407a1f96a88e.png" width="640"></a> <br><br>  Les graphiques sont affich√©s sur la m√™me page o√π le contr√¥le a lieu, directement sous le bloc de contr√¥le principal. <br><br>  Je ne fournis pas intentionnellement un ensemble complet de sources de projet pour plusieurs raisons: <br><br><ol><li>  Il ne peut pas √™tre d√©marr√© car il se trouve sur un autre r√©seau que le mien, car je n'ai pas essay√© de rendre le projet portable, et il est strictement li√© √† mes adresses et √† la topologie de mon r√©seau. </li><li>  Je suis s√ªr que l'id√©ologie g√©n√©rale du projet souffre de nombreux probl√®mes, car c'est ma premi√®re tentative dans le domaine o√π je ne suis pas bon √† comprendre.  Par cons√©quent, je ne propose √† personne le projet entier √† r√©p√©ter sous cette forme.  Je n'ai partag√© que les moments dans lesquels j'ai moins confiance. </li><li>  Le projet est fait depuis longtemps et depuis longtemps, et je ne me souviendrai jamais de tous les d√©tails et je ne pourrai pas expliquer un certain nombre de solutions.  Le volume du croquis est tr√®s important (selon mes normes, environ 2 000 lignes), il existe plus d'une douzaine de scripts Java diff√©rents, je n'ai pas fait de diagramme sch√©matique du fer.  Autrement dit, je ne peux pas aider les conseils sur la plupart des questions. </li></ol><br>  <b>Assemblage</b> <br><br>  D√®s le d√©but, je me suis fix√© l'objectif - cr√©er un appareil fini, et pas seulement une mise en page avec un tas de publications sur la table: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/721/a45/ba3/721a45ba3d536cfbf0d3b302c32cdd3b.jpg" width="640"></a> <br><br>  Et j'ai imm√©diatement d√©cid√© que je voulais placer l'appareil √† l'int√©rieur du panneau √©lectrique.  Il y a de la nourriture et un comptoir, et en g√©n√©ral, c'est pratique. <br><br>  Pour cela, un √©tui dinrek √©tait n√©cessaire.  Au d√©but, j'ai pens√© √† le d√©velopper et √† l'imprimer sur une imprimante 3D.  Mais je n'ai pas ma propre imprimante 3D, et ce que mes coll√®gues travaillant sur leurs imprimantes auto-assembl√©es impriment ne me convient pas du tout dans la qualit√© de leur apparence.  J'ai trouv√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des √©tuis pr√™ts √† l'emploi</a> sur un rail DIN (de diff√©rentes tailles) √† vendre, ils ont l'air bien, ils sont pratiques √† utiliser (pliables), et il y a aussi une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">carte aveugle</a> pr√™te √† l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">emploi</a> pour eux. <br><br>  J'ai achet√© le plus grand bo√Ætier, afin que non seulement Arduino avec le bouclier Internet puisse y rentrer, mais aussi un relais pour commuter la charge: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/674/493/325/6744933251f7abeed45267d51d2c2e59.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/aed/1dc/c27/aed1dcc279af58de00af5e68f30b8aac.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/fe1/cbb/ab7/fe1cbbab760347fda7df0edf2b0a9c09.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/0f9/13b/250/0f913b2504dcef41d4156e23015f5fef.jpg" width="640"></a> <br><br>  Vint ensuite un long et fascinant processus d'installation de toutes les tripes dans le bo√Ætier.  Dans le cadre de cette activit√©, j'ai m√™me acquis un merveilleux fer √† souder avec fonction sommeil (les fers √† souder que j'avais √©taient encore de l'√©poque sovi√©tique): <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/8f7/cff/613/8f7cff613a071eb2ee93cd09c3286622.jpg" width="640"></a> <br><br>  Pour l'installation, j'ai achet√© un tas de toutes sortes de supports, vis, rondelles et √©crous.  Premier montage: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/c28/ff1/ac7/c28ff1ac7b46d25bf58714949091c7d6.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/fd9/c60/001/fd9c6000193beeb0a82cf14d7ca56cda.jpg" width="640"></a> <br><br>  Pour connecter les fils aux contacts sup√©rieurs, il a fallu utiliser des broches tordues, sinon il ne rentre pas dans le bo√Ætier: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/47a/8eb/107/47a8eb107e5b12253386f61745103774.jpg" width="640"></a> <br><br>  Les rondelles isolantes ont d√ª √™tre coup√©es par endroits: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4da/e6f/55f/4dae6f55f161153a1d544c8aae3c883e.jpg" width="640"></a> <br><br>  Et par endroits, il se pliera plus perversement, soul√®vera la vis du manchon et coupera minutieusement le manchon: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/6ec/226/736/6ec226736d2576706170487958208959.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/f98/c43/fb9/f98c43fb9ddb0da9149193dd92ef465d.jpg" width="640"></a> <br><br>  Pour un seul relocalisation, il n'y avait pas assez de points de pivot, donc il ne tenait qu'√† deux points: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/398/f46/4b6/398f464b6f08b4372bf8792edb0018b9.jpg" width="640"></a> <br><br>  Assemblage assembl√© avec borniers: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/bd8/17d/1cb/bd817d1cbc854ac47c7427c26dc0f0c8.jpg" width="640"></a> <br><br>  Ensuite, l'engin a commenc√© √† se transformer progressivement en fils.  La carte a √©t√© utilis√©e uniquement pour le c√¢blage d'alimentation et pour la connexion aux borniers.  Pour les connexions de signaux, j'ai utilis√© le fil MS-16 (je l'aime plus), pour l'alimentation, il n'a pas travers√© la tension (jusqu'√† 100 V), donc MGTF: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/cc3/5ae/01d/cc35ae01d9728523e1edbe1e3d0ae79d.jpg" width="640"></a> <br><br>  J'ai mont√© des LED sur le panneau avant, soud√© les r√©sistances de limitation de courant directement aux jambes des LED et les ai ferm√©es avec un r√©tr√©cissement thermique: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4a3/299/840/4a3299840a442a416396a30c81a25e2e.jpg" width="640"></a> <br><br>  En cons√©quence, nous avons obtenu un tel remplissage barbu: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/5c7/042/3e7/5c70423e7c3acdbe8f892054ffe010c5.jpg" width="640"></a> <br><br>  Et voici une √©charpe avec un microcircuit de chien de garde, √† l'abri dans les entrailles de ma cr√©ation, juste au-dessus du convertisseur de niveau RS-485-TTL: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/73d/e5b/318/73de5b318ba3e6299168d634cdbaefe2.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/798/c40/61f/798c4061fa2167591312ff1d40adf5a4.jpg" width="640"></a> <br><br>  Toute la structure est pliable, tout peut √™tre retir√©, d√©connect√© et remplac√© sans soudure, √† l'exception d'une √©charpe √† ≈ìil de chien, elle est soud√©e aux broches du connecteur, habill√©e d'un certain nombre de ports IO d'Arduina. <br><br>  Dans la boite: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/c0b/918/cd8/c0b918cd83cbf30b11bc6b47e150b60f.jpg" width="640"></a> <br><br>  J'ai coup√© des ouvertures pour les connecteurs Arduina dans la paroi en plastique du bo√Ætier.  J'ai d'abord fait les trous exactement en fonction de la taille des connecteurs, mais l'assemblage dans le bo√Ætier doit √™tre d√©marr√© en diagonale (sinon cela ne fonctionne tout simplement pas) et les connecteurs ne sont pas pass√©s, j'ai d√ª dilapider un peu: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/7a1/5bd/21c/7a15bd21c6767e24b78a867b95952606.jpg" width="640"></a> <br><br>  En allumant le produit fini sur la table, tout a fonctionn√© imm√©diatement: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/262/a25/4f6/262a254f611519e81f429b00b2440758.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4ff/cb6/10c/4ffcb610c648d20fe7c386f821178ad9.jpg" width="640"></a> <br><br>  Sur le panneau avant apport√©: <br><br><ul><li>  Quatre LED rouges - indication de charge; </li><li>  Deux verts - communication avec le compteur et avec le serveur VPN; </li><li>  Deux jaunes sont de rechange; </li><li>  Un jaune - indication d'un red√©marrage du routeur; </li><li>  Un rouge est la nutrition; </li><li>  Et un bouton de r√©initialisation. </li></ul><br>  Pour obtenir 5 volts sur 220, j'ai utilis√© une alimentation dinerey avec r√©glage du niveau de sortie, l'alimentation a √©t√© fournie directement au microcontr√¥leur, en contournant le convertisseur d'entr√©e de 7-12 √† 5 volts.  C'√©tait pratique pour plusieurs raisons.  Tout d'abord, la puissance du convertisseur int√©gr√© √† un moment donn√© n'√©tait pas suffisante, le courant y est limit√©.  Deuxi√®mement, il fallait encore alimenter le relais en 5 volts.  Troisi√®mement, le tableau de bord est un facteur de forme dinrek pratique en termes d'installation.  Par cons√©quent, ici: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/801/0f7/aad/8010f7aad941e5f4619553fe7433c58e.jpg" width="640"></a> <br><br><br>  <b>Test</b> <b><br></b> <br>  Tout √©tait tourn√© sur la table, tout fonctionnait comme il se doit, il √©tait temps d'installer le contr√¥leur dans le bouclier et de le v√©rifier en mode combat. <br><br>  Mais d'abord, j'ai tout connect√© ¬´sur la morve¬ª, poussant litt√©ralement tous les tripes dans un autre bouclier, √† faible courant pour tester les capteurs de temp√©rature en conditions r√©elles sur de longues lignes pos√©es dans un canal de c√¢ble avec des c√¢bles d'alimentation ~ 220V: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/d3c/3a8/b45/d3c3a8b45a90075449e23e24f4ae37e7.jpg" width="640"></a> <br><br>  Comme vous pouvez le voir sur la photo ci-dessus, jusqu'√† pr√©sent, j'ai essay√© de contr√¥ler le red√©marrage du routeur par l'alimentation √† l'aide de la prise Senseit ¬´intelligente¬ª.  Cependant, cet appareil avec un co√ªt fou de 5 mille (pour 2016) s'est av√©r√© extr√™mement buggy et de mauvaise humeur.  Au cours de l'ann√©e d'utilisation, cela m'a forc√© √† plusieurs reprises √† arriver de fa√ßon impr√©vue au chalet √† des moments inopportuns, afin de supprimer manuellement ce miracle de l'ing√©nierie et de la pens√©e marketing d'un profond inconv√©nient en termes de communications GSM.  Avec la transition vers mon contr√¥leur Arduino, qui s'est av√©r√© plus fiable qu'un exemple, j'ai √©t√© soulag√© de jeter cette jonque ¬´professionnelle¬ª dans une belle bo√Æte dans une bo√Æte et de l'oublier. <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/efa/f91/91b/efaf9191b1dffa362e86e302d4858d34.jpg" width="640"></a> <br><br>  Le test a √©t√© r√©ussi, il n'y a eu aucun √©chec et il a √©t√© possible de proc√©der √† l'installation finale dans un endroit r√©gulier: <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/887/ac8/320/887ac8320dca67597c4f979806e22b93.jpg" width="472"></a> <br><br>  Oui, c'est le bouclier ABB TwinLine 800x300x225 IP55, d'une valeur de 25 mille roubles.  sans remplissage (et remplissage pour un autre 15 mille environ).  Et oui, il est install√© dans un vestiaire 6x2.  Chacun a ses propres cafards.  Oui, j'ai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©cup√©r√© moi-m√™me toutes les pi√®ces √©lectriques</a> .  Et il a aussi construit un vestiaire, oui.  Non, je ne suis pas √©lectricien.  Et pas un constructeur. <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4d4/c1b/3e5/4d4c1b3e5710dfb4a87299bb1f55fbfd.jpg" width="640"></a> <br><br>  Dans les profondeurs du bouclier, j'ai localis√© une petite alimentation sans coupure <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Powercom WOW 300</a> , l√† sa LED verte s'allume, et √† gauche et au dessus - sa prise d'alimentation d'entr√©e: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/b6a/991/299/b6a991299668084c3ae8265d064e1910.jpg" width="640"></a> <br><br>  Il dure environ 40 minutes d'autonomie de la batterie de l'appareil Arduino, d'un routeur avec un modem USB et une connexion Wi-Fi et des cam√©ras de surveillance IP Full HD. <br><br>  Et ici, vous pouvez voir les fiches d'alimentation blanches de deux consommateurs ininterrompus - le bloc d'alimentation Arduino et le blindage √† faible courant, o√π se trouvent le routeur et le bloc d'alimentation pour la cam√©ra de surveillance ext√©rieure.  Cette ligne va avec une coupure dans le contacteur, qui est contr√¥l√© par Arduino, juste pour le m√™me chien de garde logiciel qui red√©marre le routeur sous tension en cas de chute d'un VPN (la cam√©ra red√©marre en m√™me temps, bien qu'elle n'en ait pas besoin).  Les lignes sup√©rieures des paires torsad√©es des capteurs de temp√©rature sont connect√©es au contr√¥leur: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/0b8/fd7/50b/0b8fd750b2a17afd69eb55b6d56bf709.jpg" width="640"></a> <br><br>  Je dois dire que je ne ferais jamais confiance au passage d'une charge puissante √† de petits relais bleus chinois, malgr√© les param√®tres de ces relais, qui semblent permettre de le faire.  Par cons√©quent, l'utilisation de contacteurs modulaires normaux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Legrand n ¬∞ 4 125 01</a> avec possibilit√© de commande manuelle a √©t√© imm√©diatement pr√©vue.  C'est-√†-dire que les relais √† l'int√©rieur du corps du contr√¥leur contr√¥lent les contacteurs, et les contacteurs contr√¥lent d√©j√† la charge.  C'est fiable.  Mais l'alimentation du routeur et de la cam√©ra ne s'effectue qu'√† travers ce petit relais chinois bleu, le courant y est faible, donc c'est possible. <br><br>  Au premier lancement de combat, j'ai √©t√© tr√®s d√©√ßu.  Sur la table, j'ai tout v√©cu sauf la charge.  Pourquoi?  Les contacteurs cliquent et il est donc clair qu'ils vont commuter la charge.  Mais non, il fallait faire l'exp√©rience.  Des √©lectroconvecteurs puissants ont introduit des interf√©rences dans le syst√®me au moment de l'ouverture des contacts, ce qui a conduit √† un gel garanti du bouclier Internet.  Et pour le sortir de la panne n'√©tait possible qu'en coupant le courant, une simple r√©initialisation n'a pas aid√©.  Googl√© - oui, ce chinois a un tel probl√®me.  Et la biblioth√®que ne g√®re pas cette situation.  Autrement dit, le morceau de fer est mauvais, et le logiciel n'est pas tr√®s bon. <br><br>  Je pensais d√©j√† que tout √©tait parti.  J'ai m√™me command√© des relais √† semi-conducteurs, mais ils, √©cume, sont plus grands en hauteur, et ils ne rentreraient pas dans ma conception.  Mais alors j'ai pens√© qu'il pourrait encore √™tre possible de supprimer l'interf√©rence.  Googl√© √† nouveau, a trouv√© des condensateurs anti-bruit sp√©ciaux (les soi-disant condensateurs de type X).  Il suffit de les connecter en parall√®le √† l'enroulement de commande des contacteurs, et voil√†!  Les raccords ont compl√®tement disparu.  Au cours de la derni√®re ann√©e de fonctionnement, aucun cas n'a √©t√© enregistr√©: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/7ae/198/80c/7ae19880c09be755c8421266a4ba29df.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/c25/e89/cb2/c25e89cb2e1f8ed607f736bfdfc0cd20.jpg" width="640"></a> <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/6b8/a25/f65/6b8a25f65c6f9de23a3b1ad57a91f97d.jpg" width="472"></a> <br><br>  Mais de cette fa√ßon, vous pouvez regarder √† l'int√©rieur de la bo√Æte: <br><br> <a href=""><img height="480" src="https://habrastorage.org/getpro/habr/post_images/776/7c3/7c9/7767c37c908537a36b5bd763a39fc7bc.jpg" width="640"></a> <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/827/6fa/818/8276fa8186818314c5b4ce8516ef6f04.jpg" width="480"></a> <br><br>  Eh bien, la vue finale de la visi√®re avec le plastron (aucun bouchon n'√©tait fourni dans le kit): <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/e4c/231/5ac/e4c2315ac67af993ed83151f58896e85.jpg" width="472"></a> <br><br>  Pour le d√©bogage et le clignotement, le c√¢ble USB est connect√© au contr√¥leur et stock√© √† l'int√©rieur du bouclier derri√®re une porte ferm√©e (il ne sera temporairement pas connect√© √† cette photo): <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/e51/1ce/92d/e511ce92de3e8e090aa842ff540034d6.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/8fa/202/f5a/8fa202f5abf1eeb6bbca9192dc82c719.jpg" width="640"></a> <br><br>  Le syst√®me fonctionne depuis pr√®s d'un an, a surv√©cu √† des gel√©es jusqu'√† 20 degr√©s sans aucun probl√®me. <br><br>  En g√©n√©ral, je suis satisfait du r√©sultat.  Cependant, pour les t√¢ches plus ou moins fonctionnelles, Arduino est clairement faible.  Plus d'une fois, je suis tomb√© en panne de m√©moire et j'ai d√ª couper et optimiser.  Et la vitesse de travail, surtout avec une carte m√©moire, ne me convient pas du tout.  Par cons√©quent, les futures impl√©mentations de ces m√©tiers, le cas √©ch√©ant, je voudrais baser sur quelque chose de plus puissant.  Des coll√®gues me donnent un Raspberry Pi, une bonne option, je pense. <br><br>  Quelqu'un pourrait dire: ¬´Combien de difficult√©s il y a pour une t√¢che aussi primitive¬ª, et il aura probablement raison.  Pour moi, toute cette entreprise est un passe-temps, avec peu de justification pour le sens.  Par cons√©quent, je cherchais du divertissement dans tout ce que je pouvais :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr411141/">https://habr.com/ru/post/fr411141/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr411131/index.html">Le premier concours de robotique sous-marine pour les √©l√®ves de la 1re √† la 4e ann√©e</a></li>
<li><a href="../fr411133/index.html">Jouets robots pour enfants: pour l'apprentissage et le divertissement</a></li>
<li><a href="../fr411135/index.html">Param√®tres</a></li>
<li><a href="../fr411137/index.html">VTC - Centre de communication par satellite (Vladivostok)</a></li>
<li><a href="../fr411139/index.html">Le myst√®re de la dur√©e de vie des neutrons devient plus compliqu√© et la mati√®re noire n'est toujours pas visible</a></li>
<li><a href="../fr411143/index.html">Programmation des microcontr√¥leurs modernes: le√ßon 1</a></li>
<li><a href="../fr411145/index.html">Mes petits relais: l'ordinateur Brainfuck est une r√©alit√©</a></li>
<li><a href="../fr411147/index.html">Immenses taches de plan√®tes g√©antes</a></li>
<li><a href="../fr411149/index.html">Pr√©vision TRIZ des syst√®mes d√©centralis√©s et de la soci√©t√© cyber-physique de 2035</a></li>
<li><a href="../fr411151/index.html">iMX6ULL. Transition vers les modules processeurs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>