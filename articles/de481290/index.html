<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë±üèø ‚òùüèæ üè∞ HOW-to / Network- und VLAN-Einstellungen auf einem dedizierten Hetzner- und Mikrotik-Server üöÖ üéä üöÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Angesichts einer Frage und einer Unterbrechung wird in zahlreichen Dokumentationen versucht, das Gelernte zu systematisieren und aufzuschreiben, um si...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HOW-to / Network- und VLAN-Einstellungen auf einem dedizierten Hetzner- und Mikrotik-Server</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481290/"><p>  Angesichts einer Frage und einer Unterbrechung wird in zahlreichen Dokumentationen versucht, das Gelernte zu systematisieren und aufzuschreiben, um sich besser zu erinnern.  Und machen Sie auch Anweisungen in dieser Angelegenheit, um nicht den ganzen Weg wieder zu gehen. </p><br><p>  Die Quelldokumentation finden Sie in gro√üer Anzahl unter <a href="https://forum.proxmox.com/" rel="nofollow">https://forum.proxmox.com</a> <a href="https://wiki.hetzner.de/" rel="nofollow">https://wiki.hetzner.de</a> </p><a name="habracut"></a><br><h2 id="postanovka-zadachi">  Erkl√§rung des Problems </h2><br><p>  Der Client m√∂chte mehrere gemietete Server in einem Netzwerk zusammenfassen, um nicht mehr f√ºr mehrere zus√§tzliche Subnetze bezahlen zu m√ºssen, die gesamte Farm f√ºr einen Router aufzuh√§ngen, ihnen lokale Adressen zuzuweisen und sich mit einer Firewall zu sch√ºtzen.  Damit der gesamte Serviceverkehr im VLAN abl√§uft.  Verschieben Sie au√üerdem virtualochki von einem alten Server auf einen neuen und lehnen Sie dies ab, aktualisieren Sie die verwendete alte Hardware und wechseln Sie gleichzeitig zu einem neuen Proxmox. </p><br><p>  Anf√§nglich verf√ºgt der Client √ºber 5 Server mit jeweils einem zus√§tzlichen Subnetz, wobei die erste Adresse aus dem zugewiesenen Subnetz einer zus√§tzlichen Bridge auf Proxmox zugewiesen wird </p><br><p><img src="https://habrastorage.org/webt/_z/fi/qo/_zfiqosgko8zksksazh9rlhhu-e.png"></p><br><p>  Gleichzeitig arbeiten VMs unter Windows und haben die Adresse 85.xx177 / 29 mit dem Gate 85.xx176 konfiguriert <br>  In √§hnlicher Weise werden alle 5 Server mit ihren virtuellen Maschinen konfiguriert. </p><br><p>  Es ist lustig, dass diese Konfiguration beim Einrichten des Netzwerks im Prinzip falsch ist, um die Netzwerkadresse f√ºr den ersten Knoten und auch f√ºr das Gateway zu verwenden.  Wenn Sie versuchen, eine solche Konfiguration in einer virtuellen Maschine in Ubuntu zu erhalten, funktioniert das Netzwerk nicht. <br></p><br><h2 id="realizaciya">  Implementierung </h2><br><ul><li>  Wir erstellen einen vSwitch in der Benutzeroberfl√§che, weisen ihm eine VlanID zu und f√ºgen diesen vSwitch allen Servern hinzu, die wir ben√∂tigen. </li></ul><br><p><img src="https://habrastorage.org/webt/vf/lm/1e/vflm1eo8gfnba8ds_8_pgpmmcp8.png"></p><br><ul><li>  Wir stellen einen Testserver zur Verf√ºgung, damit Sie problemlos konfigurieren und umziehen k√∂nnen. </li></ul><br><p>  Wir erheben den ersten virtuellen chr gem√§√ü der <strong><a href="https://wiki.mikrotik.com/wiki/Manual:CHR_ProxMox_installation" rel="nofollow">Anleitung f√ºr proxmox</a></strong> . </p><br><p>  Wenn Sie das obige Skript verwenden, beachten Sie, dass das Vorhandensein des Verzeichnisses -d / root / temp zu Beginn √ºberpr√ºft wird. Ist dies nicht der Fall, wird das Verzeichnis / home / root / temp erstellt. Die weitere Arbeit mit dem Verzeichnis / root / temp wird jedoch fortgesetzt.  Das Skript muss repariert werden, um das entsprechende Verzeichnis zu erstellen. </p><br><ul><li>  Richten Sie ein Netzwerk f√ºr Proxmox ein. </li></ul><br><p><img src="https://habrastorage.org/webt/8p/pc/if/8ppcifybz-syafd8zbc0hoqmghg.png"></p><br><p>  F√ºgen Sie das Subinterface mit der VLAN-Nummer hinzu und geben Sie an, dass die Adresseinstellungen auf Bridges mithilfe des inet-Handbuchs vorgenommen werden.  <strong>WICHTIG</strong>  Sie k√∂nnen keine IP-Adressen f√ºr Schnittstellen konfigurieren, die Sie dann in die Bridge aufnehmen, wie dies funktioniert und ob jemand etwas wei√ü oder nicht. </p><br><p>  Nach der Korrespondenz mit dem Hetzner-Support wurde klar, dass weder f√ºr das Subnetz noch f√ºr die dedizierte Adresse eine zus√§tzliche Mohnblume hinzugef√ºgt werden konnte.  <u>Das hei√üt, Sie k√∂nnen die lokale Schnittstelle auf dem Server und die Schnittstelle unserer virtuellen CHR-Maschine nicht in die Bridge aufnehmen.</u>  Hetzner sendet eine Benachrichtigung mit der Aufforderung, die zus√§tzliche Mohnblume zu entfernen.  Wir entfernen die vmbr0-Br√ºcke und weisen die Adresse direkt der eno1-Schnittstelle zu. </p><br><p>  Als n√§chstes erstellen wir die vmbr1-Br√ºcke - und h√§ngen eine beliebige Adresse daran, die der Endpunkt unserer Routen von CHR ist, und geben mit einem zus√§tzlichen Befehl die Route zu unserem zus√§tzlichen Netzwerk an, die in Hetzner f√ºr diesen Server √ºber diese Br√ºcke bestellt wurde.  Das Hinzuf√ºgen einer Route funktioniert, wenn die Benutzeroberfl√§che ansteigt. </p><br><p>  Die zweite Br√ºcke ist unsere Schnittstelle f√ºr den lokalen Datenverkehr. F√ºgen Sie eine Adresse hinzu, um die Konnektivit√§t zwischen verschiedenen Proxmox-Servern in einem lokalen Netzwerk ohne Internetzugang herzustellen, und geben Sie als Port die Sinterschnittstelle eno1.4000 an, die unserer VlanID zugewiesen ist. <br>  W√§hrend der Ersteinrichtung erhalten Sie Tipps, wie Sie das ifupdown2-Paket f√ºr Proxmox zus√§tzlich installieren und den Server beim √Ñndern der Netzwerkschnittstellen nicht vollst√§ndig neu starten k√∂nnen.  Dies ist jedoch nur f√ºr die Erstkonfiguration typisch. Wenn Sie Bridges verwenden und bereits virtuelle Maschinen einrichten, treten bei virtuellen Maschinen Probleme mit Netzwerkfehlern auf.  Obwohl Sie beispielsweise die vmbr2-Schnittstelle korrigiert haben und die Konfiguration angewendet wurde, f√§llt das Netzwerk bereits auf allen internen Schnittstellen aus und steigt erst nach einem vollst√§ndigen Neustart des Servers an.  ifdown &amp;&amp; ifup helfen nicht.  Wenn jemand eine L√∂sung hat, bin ich dankbar. </p><br><p>  Die allererste konfigurierte Schnittstelle auf dem Server bleibt betriebsbereit und zug√§nglich. </p><br><ul><li><p>  Adresszuweisung f√ºr CHR, um Adressen aus dem Pool nicht zu verlieren <br>  Der Adresspool, den Hetzner ausgibt, sieht f√ºr einen Netzwerker sehr seltsam aus: </p><br><p><img src="https://habrastorage.org/webt/bo/1i/2i/bo1i2iqkuifjfw0j8eo8rlklczo.png"></p><br></li></ul><br><p>  Das Seltsame ist, dass das Gate die Verwendung Ihrer eigenen physischen Serveradresse vorschl√§gt. </p><br><p>  Die von Hetzner selbst angebotene klassische Version ist in der Problemstellung angegeben und wurde vom Auftraggeber eigenst√§ndig umgesetzt.  Bei dieser Option verliert der Client die erste Adresse an die Netzwerkadresse, die zweite Adresse an die Proxmox-Bridge und es wird auch das Gateway und die letzte Adresse f√ºr die √úbertragung.  IPv4-Adressen sind nicht redundant.  Wenn Sie direkt versuchen, die IP-Adresse 136.x.x.177 / 29 und das Gateway f√ºr 0.0.0.0/0 148.x.x.165 auf dem CHR zu registrieren, k√∂nnen Sie dies tun. Das Gateway ist jedoch nicht direkt verbunden und daher nicht erreichbar. </p><br><p><img src="https://habrastorage.org/webt/61/6c/tl/616ctlgp2pr4vc7-emkoid3sybc.png"></p><br><p>  Sie k√∂nnen aus der Situation herauskommen, wenn Sie f√ºr jede Adresse 32 Netzwerke verwenden und die von uns ben√∂tigte Adresse, die eine beliebige sein kann, als Netzwerkname angeben.  Es stellt sich das Analogon der Punkt-zu-Punkt-Verbindung heraus. </p><br><p><img src="https://habrastorage.org/webt/kt/lp/bh/ktlpbh2jgzuk4mp1t34ja_6zloq.png"></p><br><p>  In diesem Fall wird das Gateway nat√ºrlich verf√ºgbar sein und alles wird so funktionieren, wie wir es brauchen. <br>  Beachten Sie, dass in einer solchen Konfiguration die Verwendung der SRC-NAT-Maskeraderegel nicht empfohlen wird, da die Ausgabeadresse vage anders ist, es jedoch korrekter ist, die Aktion src-NAT und die spezifische Adresse anzugeben, von der Sie den Client freigeben. </p><br><ul><li>  Und zum Schluss. <br>  Um den Zugriff auf Proxmox selbst aus dem Internet zu blockieren, verwenden Sie die integrierten Tools: Es gibt eine hervorragende Firewall. </li></ul><br><p><img src="https://habrastorage.org/webt/s3/3b/wo/s33bwousnhfvvvsqpqsmvdghuxo.png"></p><br><p>  Sie sollten die von hetzner angebotene Firewall nicht verwenden, um sich nicht am Ort der Einstellungen zu verwechseln.  Hetzner wird auch in allen netzwerken aktiv sein, auch in jenen, die mit dem chr verbunden sind, und um ports zu √∂ffnen und weiterzuleiten, muss es auch in der weboberfl√§che des anbieters ge√∂ffnet werden. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de481290/">https://habr.com/ru/post/de481290/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de481276/index.html">Wie ich mein YP und meinen Compiler f√ºr 12 Jahre erstellt habe</a></li>
<li><a href="../de481280/index.html">Wie wir die Qualifizierungsphase von CTFZone-2020 vorbereitet haben</a></li>
<li><a href="../de481282/index.html">Was die Idee wert ist und wie man daraus ein Konzept macht: Spiele-Designer-Tools</a></li>
<li><a href="../de481286/index.html">Steig auf den Tisch! B√ºrokleinigkeiten, die √ºberhaupt keine Kleinigkeiten sind</a></li>
<li><a href="../de481288/index.html">Redux Toolkit als Werkzeug f√ºr eine effektive Redux-Entwicklung</a></li>
<li><a href="../de481294/index.html">Die 10 besten Tools zur Softwaretestautomatisierung</a></li>
<li><a href="../de481296/index.html">Wie schreibe ich Code, der wiederverwendet wird?</a></li>
<li><a href="../de481302/index.html">"About, yes not a cluster" oder wie wir DBMS importiert haben</a></li>
<li><a href="../de481304/index.html">Amerikanische Flagge sortieren</a></li>
<li><a href="../de481306/index.html">Einf√ºhrung von werf 1.0 stable: Was hat GitOps damit zu tun, Status und Pl√§ne</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>