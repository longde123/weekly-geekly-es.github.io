<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòÉ üë®üèæ‚Äçüöí ü§∑ postfix + dovecot + mysql sur FreeBSD üåí üí† ‚õπÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©sentation 
 Je voulais √©tudier le serveur de messagerie pendant longtemps, mais mes mains n‚Äôont atteint que maintenant, et je n‚Äôai pas r√©ussi √† tro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>postfix + dovecot + mysql sur FreeBSD</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476148/"><h2>  Pr√©sentation </h2><br>  Je voulais √©tudier le serveur de messagerie pendant longtemps, mais mes mains n‚Äôont atteint que maintenant, et je n‚Äôai pas r√©ussi √† trouver les informations correctes, alors j‚Äôai d√©cid√© d‚Äô√©crire une publication aussi d√©taill√©e que possible.  Cette publication traitera non seulement de postfix, dovecot, mysql, postfixadmin, mais aussi de spamassassin, clamav-milter (une version sp√©ciale de clamav pour les serveurs de messagerie), de postgrey, ainsi que de la possibilit√© de transf√©rer du spam vers le dossier Spam (dovecot- pigeonhole). <br><a name="habracut"></a><br><h3>  La pr√©paration </h3><br>  Tout d'abord, nous installerons les packages dont vous avez besoin pour travailler (postfix, dovecot et dovecot-pigeonhole doivent √™tre install√©s √† partir des ports, dovecot-sieve peut √™tre install√© √† partir des packages, en principe, il existe des versions plus r√©centes dans les ports et pour cette raison il peut y avoir incompatibilit√© entre dovecot et dovecot- tamis).  Installez les packages suivants: <br><br><pre><code class="plaintext hljs">pkg install apache24 php73 mod_php73 php73-extensions php73-mysqli php73-mbstring php73-openssl clamav-milter postgrey spamassassin mysql57-server openssl wget</code> </pre> <br>  Apr√®s l'installation, nous mettrons les services n√©cessaires en autorun: <br><br><pre> <code class="plaintext hljs">#postfix  dovecot  ,       sysrc postfix_enable="YES" sysrc dovecot_enable="YES" sysrc mysql_enable="YES" sysrc apache24_enable="YES" sysrc spamd_flags="-u spamd -H /var/spool/spamd" sysrc spamd_enable="YES" sysrc postgrey_enable="YES" sysrc clamav_clamd_enable="YES" sysrc clamav_milter_enable="YES" sysrc clamav_freshclam_enable="YES" #freshclam        12  sysrc clamav_freshclam_flags="--daemon --checks=12"</code> </pre><br>  Ex√©cutez les services: <br><br><pre> <code class="plaintext hljs">service apache24 start service mysql-server start #  spamassassin       sa-update sa-compile service sa-spamd start #   clamav   freshclam service clamav-clamd start service clamav-freshclam start service clamav-milter start #  postgrey    (/usr/local/etc/rc.d/postgrey),       ""   4-   ,    : ${postgrey_flags:=--inet=10023}     : : ${postgrey_flags:=--inet=10023 --auto-whitelist-clients=4} service postgrey start</code> </pre><br>  N'oubliez pas d'ajouter dans httpd.conf les lignes n√©cessaires pour que php fonctionne dans apache et pour que postfixadmin fonctionne correctement: <br><br><pre> <code class="plaintext hljs">&lt;FilesMatch "\.php$"&gt; SetHandler application/x-httpd-php &lt;/FilesMatch&gt; &lt;FilesMatch "\.phps$"&gt; SetHandler application/x-httpd-php-source &lt;/FilesMatch&gt; &lt;IfModule dir_module&gt; DirectoryIndex index.php &lt;/IfModule&gt; #         postfixadmin DocumentRoot "/usr/local/www/apache24/data/postfixadmin-3.2/public"</code> </pre><br>  Ensuite, allez dans le r√©pertoire et t√©l√©chargez postfixadmin <br><br><pre> <code class="plaintext hljs">cd /usr/local/www/apache24/data</code> </pre><br>  T√©l√©charger postfixadmin (au moment de la r√©daction, la version actuelle √©tait 3.2) <br><br><pre> <code class="plaintext hljs">wget --no-check-certificate https://sourceforge.net/projects/postfixadmin/files/postfixadmin/postfixadmin-3.2/postfixadmin-3.2.tar.gz</code> </pre><br>  Apr√®s cela, vous devez d√©compresser l'archive dans ce r√©pertoire et changer le propri√©taire du r√©pertoire: <br><br><pre> <code class="plaintext hljs">gzip -d postfixadmin-3.2.tar.gz tar -xvf postfixadmin-3.2.tar chown -R www:www /usr/local/www/apache24/data service apache24 restart</code> </pre><br>  Ensuite, pr√©parez la base de donn√©es pour postfixadmin, ex√©cutez le script mysql-secure-installation (le mot de passe que vous cr√©ez dans ce script devra √™tre cr√©√© dans mysql avec la commande alter user), pour la configuration initiale de mysql, puis entrez mysql, cr√©ez la base de donn√©es et les droits pour elle: <br><br><pre> <code class="plaintext hljs">mysql -p -r alter user 'root'@'localhost' identified by 'password123'; create database postfix; grant all privileges on postfix.* to 'postfix'@'localhost' identified by 'password123'; exit</code> </pre><br>  Une fois la base de donn√©es configur√©e, vous devez modifier le fichier config.inc.php, dans cet exemple, ce fichier se trouve dans le r√©pertoire /usr/local/www/apache24/data/postfixadmin-3.2/, dans ce fichier, vous devez modifier plusieurs lignes et les apporter √† l'esprit, apr√®s avoir modifi√© les param√®tres, red√©marrez apache, vous devez √©galement cr√©er le r√©pertoire templates_c dans le r√©pertoire /usr/local/www/apache24/data/postfixadmin-3.2 et lui affecter le propri√©taire www: <br><br><pre> <code class="plaintext hljs">mkdir /usr/local/www/apache24/data/postfixadmin-3.2/templates_c chown -R www:www /usr/local/www/apache24/data/postfixadmin-3.2/templates_c $CONF['configured'] = true #       postfixadmin     . $CONF['setup_password'] = 'dd28fb2139a3bca426f02f60e6877fd5:13d2703c477b0ab85858e3ac5e076a0a7a477315'; $CONF['default_language'] = 'ru' $CONF['database_type'] = 'mysqli'; $CONF['database_host'] = 'localhost'; $CONF['database_user'] = 'postfix'; #           $CONF['database_password'] = 'password123'; $CONF['database_name'] = 'postfix'; service apache24 restart</code> </pre><br><h4>  SSL </h4><br>  Pour g√©n√©rer la cl√©, nous utiliserons la m√©thode propos√©e sur le site postfix.org, avec la cr√©ation de notre propre autorit√© de certification, nous devons aller dans le r√©pertoire / etc / ssl et ex√©cuter le script: <br><br><pre> <code class="plaintext hljs">cd /etc/ssl /usr/local/openssl/misc/CA.pl -newca</code> </pre><br>  Pendant l'ex√©cution du script, un nom pour le certificat sera demand√©, n'entrez rien, appuyez sur Entr√©e, puis le script vous demandera de cr√©er un mot de passe pour le certificat, puis il y aura des questions standard pour cr√©er un certificat. <br><br>  Ensuite, vous devez cr√©er une cl√© secr√®te (sans mot de passe) et un certificat de cl√© publique non sign√© (le nom de l'unit√© organisationnelle (par exemple, la section) [] doit √™tre diff√©rent de ce qui est sp√©cifi√© dans le certificat cr√©√© ci-dessus): <br><br><pre> <code class="plaintext hljs">openssl req -new -newkey rsa:4096 -nodes -keyout foo-key.pem -out foo-req.pem</code> </pre><br>  Nous signerons le certificat de cl√© publique (sp√©cifiez le nombre de jours dont vous avez besoin): <br><br><pre> <code class="plaintext hljs">openssl ca -out foo-cert.pem -days 365 -infiles foo-req.pem</code> </pre><br>  Laissez les certificats cr√©√©s dans ce r√©pertoire, ou transf√©rez-les dans le r√©pertoire qui vous convient le mieux, les configurations ¬´postfix¬ª et ¬´pigeonnier¬ª seront configur√©es en tenant compte du fait que les certificats seront dans ce r√©pertoire. <br><br><h4>  Utilisateur Vmail </h4><br>  Avant d'installer postfix, dovecot et dovecot-pigeonhole, nous allons cr√©er un utilisateur et un groupe (un groupe sera cr√©√© automatiquement) vmail, ainsi que le r√©pertoire o√π le mail sera situ√©. <br><br><pre> <code class="plaintext hljs">pw useradd -n vmail -s /usr/sbin/nologin -u 1000 -d /var/vmail</code> </pre><br>  Cr√©ez un r√©pertoire pour le courrier et d√©finissez le propri√©taire de l'utilisateur vmail: <br><br><pre> <code class="plaintext hljs">mkdir /var/vmail chown -R vmail:vmail /var/vmail chmod -R 744 /var/vmail</code> </pre><br><h2>  Postfix, pigeonnier, pigeonnier-pigeonhole </h2><br>  Comme je l'ai √©crit plus t√¥t, nous allons assembler les donn√©es d'application √† partir des ports, ex√©cuter la commande pour t√©l√©charger et d√©compresser les ports: <br><br><pre> <code class="plaintext hljs">portsnap fetch extract</code> </pre><br>  Apr√®s avoir d√©ball√© les ports, allez dans le r√©pertoire dovecot, configurez le port (notez le support pour mysql) et lancez la construction (BATCH = yes dira √† make de ne pas poser de questions lors de l'installation): <br><br><pre> <code class="plaintext hljs">cd /usr/ports/mail/dovecot make config make BATCH=yes install clean</code> </pre><br>  Faites de m√™me avec Postfix et pigeonnier <br><br>  pigeonnier-pigeonnier: <br><br><pre> <code class="plaintext hljs">cd /usr/ports/mail/dovecot-pigeonhole make BATCH=yes install clean</code> </pre><br>  postfix: v√©rifiez √©galement le support mysql dans les param√®tres du port <br><br><pre> <code class="plaintext hljs">cd /usr/ports/mail/postfix-sasl make config make BATCH=yes install clean</code> </pre><br>  Avant de lancer pigeonnier, copiez les ¬´configs¬ª: <br><br><pre> <code class="plaintext hljs"> cp -R /usr/local/etc/dovecot/example-config/* /usr/local/etc/dovecot</code> </pre><br>  Apr√®s avoir install√© postfix et dovecot, d√©marrez les services: <br><br><pre> <code class="plaintext hljs">service postfix start service dovecot start</code> </pre><br>  Il est √©galement n√©cessaire de cr√©er un r√©pertoire dans lequel le module d'envoi de spam vers le dossier spam sera compil√©, dans mon cas ce r√©pertoire est situ√© dans le dossier /usr/local/etc/dovecot/conf.d, le nom du r√©pertoire est def, cr√©ez ce r√©pertoire et un fichier avec le code pour la compilation et d√©finissez le propri√©taire du r√©pertoire utilisateur vmail donn√©: <br><br><pre> <code class="plaintext hljs">mkdir /usr/local/etc/dovecot/conf.d/def touch /usr/local/etc/dovecot/conf.d/def/default.sieve chown -R vmail:vmail /usr/local/etc/dovecot/conf.d/def chmod -R 744 /usr/local/etc/dovecot/conf.d/def</code> </pre><br>  Placez les lignes dans ce fichier: <br><br><pre> <code class="plaintext hljs">require "fileinto"; if header :contains "X-Spam-Flag" "YES" { fileinto "Junk"; }</code> </pre><br><h3>  Configurations </h3><br>  Dans cette section, je donnerai des exemples de ¬´configs¬ª avec des commentaires, je doute seulement de la ¬´config¬ª de spamassassin, car je n'ai pas trouv√© les descriptions correctes sur le r√©seau (j'ai laiss√© la ¬´config¬ª par d√©faut), veuillez ajouter dans les commentaires la meilleure fa√ßon de configurer spamassassin. <br><br><h4>  Postfix </h4><br>  Tout d'abord, vous devez cr√©er des fichiers pour extraire les utilisateurs, les domaines et les quotas de la base de donn√©es.  Cr√©ez un r√©pertoire pour stocker les fichiers de donn√©es et les fichiers n√©cessaires: <br><br><pre> <code class="plaintext hljs">mkdir /usr/local/etc/postfix/mysql touch /usr/local/etc/postfix/mysql/relay_domains.cf touch /usr/local/etc/postfix/mysql/virtual_alias_maps.cf touch /usr/local/etc/postfix/mysql/virtual_alias_domain_maps.cf touch /usr/local/etc/postfix/mysql/virtual_mailbox_maps.cf</code> </pre><br>  Le contenu de ces fichiers sera: <br>  relay_domains.cf <br><br><pre> <code class="plaintext hljs">hosts = 127.0.0.1 user = postfix password = password123 dbname = postfix query = SELECT domain FROM domain WHERE domain='%s' and backupmx = '1'</code> </pre><br>  virtual_alias_maps.cf <br><br><pre> <code class="plaintext hljs">hosts = 127.0.0.1 user = postfix password = password123 dbname = postfix query = SELECT goto FROM alias WHERE address='%s' AND active ='1'</code> </pre><br>  virtual_alias_domain_maps.cf <br><br><pre> <code class="plaintext hljs">hosts = 127.0.0.1 user = postfix password = password123 dbname = postfix query = SELECT goto FROM alias,alias_domain WHERE alias_domain.alias_domain = '%d' and alias.address = CONCAT('%u', '@', alias_domain.target_domain) AND alias.active = '1'</code> </pre><br>  virtual_mailbox_maps.cf <br><br><pre> <code class="plaintext hljs">hosts = 127.0.0.1 user = postfix password = password123 dbname = postfix query = SELECT maildir FROM mailbox WHERE username='%s' AND active = '1'</code> </pre><br>  master.cf <br><br><pre> <code class="plaintext hljs"># postfix  ,    dovecot    dovecot unix - nn - - pipe flags=DRhu user=vmail:vmail argv=/usr/local/libexec/dovecot/deliver -f ${sender} -d ${recipient} #  smtpd     sasl,    ,  spamassassin    smtp inet n - n - - smtpd -o content_filter=spamassassin -o smtpd_sasl_auth_enable=yes #  587     sasl submission inet n - n - - smtpd -o smtpd_sasl_auth_enable=yes #  smtp    SASL smtps inet n - n - - smtpd -o smtpd_sasl_auth_enable=yes -o smtpd_tls_wrappermode=yes # Spamassassin spamassassin unix - nn - - pipe flags=DROhu user=vmail:vmail argv=/usr/local/bin/spamc -f -e /usr/local/libexec/dovecot/deliver -f ${sender} -d ${user}@${nexthop} #628 inet n - n - - qmqpd pickup unix n - n 60 1 pickup cleanup unix n - n - 0 cleanup qmgr unix n - n 300 1 qmgr #qmgr unix n - n 300 1 oqmgr tlsmgr unix - - n 1000? 1 tlsmgr rewrite unix - - n - - trivial-rewrite bounce unix - - n - 0 bounce defer unix - - n - 0 bounce trace unix - - n - 0 bounce verify unix - - n - 1 verify flush unix n - n 1000? 0 flush proxymap unix - - n - - proxymap proxywrite unix - - n - 1 proxymap smtp unix - - n - - smtp relay unix - - n - - smtp -o syslog_name=postfix/$service_name # -o smtp_helo_timeout=5 -o smtp_connect_timeout=5 showq unix n - n - - showq error unix - - n - - error retry unix - - n - - error discard unix - - n - - discard local unix - nn - - local virtual unix - nn - - virtual lmtp unix - - n - - lmtp anvil unix - - n - 1 anvil scache unix - - n - 1 scache postlog unix-dgram n - n - 1 postlogd</code> </pre><br>  main.cf <br><br><pre> <code class="plaintext hljs">#       dovecot,       local_transport = dovecot #      ,  SMTP-      EHLO  SMTP  smtpd_discard_ehlo_keywords = CONNECT GET POST #            smtpd_delay_reject = yes #     smtpd_helo_required = yes #     ,   disable_vrfy_command = yes #       broken_sasl_auth_clients = yes #   smtpd_sasl_security_options = noanonymous noactive nodictionary smtp_sasl_security_options = noanonymous noactive nodictionary # dovecot  (  cyrus) smtpd_sasl_type = dovecot smtp_sasl_type = dovecot #    smtpd_sasl_path = private/auth #   local_recipient_maps = $virtual_mailbox_maps $virtual_alias_maps #   ,    smtpd_reject_unlisted_recipient = yes #   message_size_limit = 10485760 #     spamassassin spamassassin_destination_recipient_limit = 1 # milter_default_action = accept milter_protocol = 2 #   clamav smtpd_milters = unix:/var/run/clamav/clmilter.sock non_smtpd_milters = unix:/var/run/clamav/clmilter.sock #MYSQL relay_domains = mysql:/usr/local/etc/postfix/mysql/relay_domains.cf virtual_alias_maps = mysql:/usr/local/etc/postfix/mysql/virtual_alias_maps.cf, mysql:/usr/local/etc/postfix/mysql/virtual_alias_domain_maps.cf virtual_mailbox_maps = mysql:/usr/local/etc/postfix/mysql/virtual_mailbox_maps.cf # HELO smtpd_helo_restrictions = permit_sasl_authenticated, reject_non_fqdn_helo_hostname, reject_invalid_hostname #    smtpd_data_restrictions = permit_sasl_authenticated reject_unauth_pipelining, reject_multi_recipient_bounce #   smtpd_sender_restrictions = permit_sasl_authenticated reject_sender_login_mismatch,reject_unauthenticated_sender_login_mismatch, reject_non_fqdn_sender, reject_unknown_sender_domain #  (check_policy_service inet:127.0.0.1:10023  postgrey -      ) smtpd_recipient_restrictions = permit_sasl_authenticated reject_non_fqdn_recipient, reject_unknown_recipient_domain, reject_multi_recipient_bounce, reject_unknown_client_hostname, reject_unauth_destination, check_policy_service inet:127.0.0.1:10023 #   virtual_mailbox_base = /var/vmail #uid  gid vmail virtual_minimum_uid = 1000 virtual_uid_maps = static:1000 virtual_gid_maps = static:1000 #   virtual_transport = devecot dovecot_destination_recipient_limit = 1 #  smtp_use_tls=yes smtp_tls_note_starttls_offer=yes # smtp_tls_security_level=encrypt       ssl,        ssl,    smtp_tls_security_level=may(    ssl,     ) smtp_tls_security_level=encrypt smtp_tls_session_cache_database=btree:$data_directory/smtp_tls_session_cache smtp_tls_CAfile=/etc/ssl/demoCA/cacert.pem smtp_tls_key_file=/etc/ssl/foo-key.pem smtp_tls_cert_file=/etc/ssl/foo-cert.pem smtp_tls_session_cache_timeout=3600s smtp_tls_protocols=!TLSv1.2 smtp_tls_loglevel=1 # smtpd_tls_security_level=encrypt       ssl,        ssl,    smtpd_tls_security_level=may(    ssl,     ) smtpd_tls_security_level=encrypt smtpd_use_tls=yes smtpd_tls_auth_only=yes smtpd_tls_loglevel=1 smtpd_tls_received_header=yes smtpd_tls_session_cache_timeout=3600s smtpd_tls_session_cache_database=btree:$data_directory/smtpd_tls_session_cache smtpd_tls_key_file=/etc/ssl/foo-key.pem smtpd_tls_cert_file=/etc/ssl/foo-cert.pem smtpd_tls_CAfile= /etc/ssl/demoCA/cacert.pem smtpd_tls_protocols=!TLSv1.2 #      tls_random_source=dev:/dev/urandom #  compatibility_level = 2 #   ,    ,      ,    soft_bounce = no #   UNIX       postfix mail_owner = postfix #     postfix(        ) myhostname = $mydomain #       mydomain = virusslayer.su myorigin = $myhostname #    inet_interfaces = all #        mydestination = $mydomain, localhost, localhost.$mydomain #   550         unknown_local_recipient_reject_code = 550 #    localhost mynetworks_style = host #       , -         mynetworks = #  ip inet_protocols = ipv4 #  (   ) alias_maps = hash:/etc/mail/aliases alias_database = dbm:/etc/mail/aliases.db #          smtpd_banner = $myhostname ESMTP $mail_name #       debug_peer_level = 2 #      (   ,    yandex.ru gmail.ru mail.ru  ..) debug_peer_list = 127.0.0.1 #   debugger_command = PATH=/bin:/usr/bin:/usr/local/bin:/usr/X11R6/bin ddd $daemon_directory/$process_name $process_id &amp; sleep 5 #  sendmail sendmail_path = /usr/local/sbin/sendmail mailq_path = /usr/local/bin/mailq setgid_group = maildrop #    html_directory = /usr/local/share/doc/postfix manpage_directory = /usr/local/man sample_directory = /usr/local/etc/postfix readme_directory = /usr/local/share/doc/postfix meta_directory = /usr/local/libexec/postfix shlib_directory = /usr/local/lib/postfix queue_directory = /var/spool/postfix command_directory = /usr/local/sbin daemon_directory = /usr/local/libexec/postfix data_directory = /var/db/postfix</code> </pre><br><h4>  Docot </h4><br>  dovecot.conf <br><br><pre> <code class="plaintext hljs">#     dovecot protocols = imap pop3 #    listen = *, :: #        mysql dict { quota = mysql:/usr/local/etc/dovecot/dovecot-dict-sql.conf.ext } #   !include conf.d/*.conf !include_try local.conf</code> </pre><br>  dovecot-dict-sql.conf.ext <br><br><pre> <code class="plaintext hljs">connect = host=127.0.0.1 dbname=postfix user=postfix password=password123 map { pattern = priv/quota/storage table = quota2 username_field = username value_field = bytes } map { pattern = priv/quota/messages table = quota2 username_field = username value_field = messages }</code> </pre><br>  dovecot-sql.conf.ext <br><br><pre> <code class="plaintext hljs">#    MYSQL driver = mysql connect = host=127.0.0.1 dbname=postfix user=postfix password=password123 #     default_pass_scheme = MD5 #  ,    user_query = SELECT '/var/mail/%d/%n/' AS home, 'maildir:/var/vmail/%d/%n' AS mail, 1000 AS uid, 1000 AS gid, concat('*:bytes=',quota) as quota_rule FROM mailbox \ WHERE username ='%u' AND active = '1' password_query = SELECT username as user, password, '/var/vmail/%d/%n' as userdb_home, 'maildir:/var/vmail/%d/%n' as userdb_mail, 1000 as userdb_uid, \ 1000 as userdb_gid, concat('*:bytes=',quota) AS userdb_quota_rule FROM mailbox WHERE username ='%u' AND active ='1'</code> </pre><br>  10-auth.conf <br><br><pre> <code class="plaintext hljs">#   SSL disable_plaintext_auth = yes #   auth_realms = virusslayer.su auth_default_realm = virusslayer.su #    ( ,         ssl) auth_mechanisms = plain login #   ,  !include auth-sql.conf.ext,        mysql #!include auth-deny.conf.ext #!include auth-master.conf.ext #!include auth-system.conf.ext !include auth-sql.conf.ext #!include auth-ldap.conf.ext #!include auth-passwdfile.conf.ext #!include auth-checkpassword.conf.ext #!include auth-vpopmail.conf.ext #!include auth-static.conf.ext</code> </pre><br>  10-mail.conf <br><br><pre> <code class="plaintext hljs">#    mail_location = maildir:/var/vmail/%d/%n #       namespace inbox { inbox = yes } #uid  gid vmail mail_uid = 1000 mail_gid = 1000 # ,    quota mail_plugins = quota</code> </pre><br>  10-master.conf <br><br><pre> <code class="plaintext hljs">#     ssl service imap-login { inet_listener imap { port = 143 } inet_listener imaps { port = 993 ssl = yes } } service pop3-login { inet_listener pop3 { port = 110 } inet_listener pop3s { port = 995 ssl = yes } } service submission-login { inet_listener submission { port = 587 } } #           (   ,       ) service auth { unix_listener auth-userdb { mode = 0600 user = vmail group = vmail } # Postfix smtp-auth unix_listener /var/spool/postfix/private/auth { mode = 0666 user = postfix group = postfix } } #  vmail   service dict { unix_listener dict { mode = 0660 user = vmail group = vmail } }</code> </pre><br>  10-ssl.conf <br><br><pre> <code class="plaintext hljs"># ssl  (    sll  ) ssl = required #   ssl_cert = &lt;/etc/ssl/foo-cert.pem ssl_key = &lt;/etc/ssl/foo-key.pem ssl_ca = &lt;/etc/ssl/demoCA/cacert.pem #    ssl_min_protocol = TLSv1.2</code> </pre><br>  15-lda.conf <br><br><pre> <code class="plaintext hljs">quota_full_tempfail = no lda_mailbox_autosubscribe = yes protocol lda { #      sieve,        mail_plugins = $mail_plugins sieve quota }</code> </pre><br>  90-plugin.conf <br><br><pre> <code class="plaintext hljs">#             "",       chown -R vmail:vmail #          "" plugin { #setting_name = value sieve = /usr/local/etc/dovecot/conf.d/def/default.sieve }</code> </pre><br>  auth-sql.conf.ext <br><br><pre> <code class="plaintext hljs">#      MYSQL passdb { driver = sql # Path for SQL configuration file, see example-config/dovecot-sql.conf.ext args = /usr/local/etc/dovecot/dovecot-sql.conf.ext } userdb { driver = sql args = /usr/local/etc/dovecot/dovecot-sql.conf.ext }</code> </pre><br><h3>  Spamassassin </h3><br>  Le spamassassin "config" ressemble √† ceci, mais quelque chose me dit que les donn√©es ne sont pas suffisantes, veuillez aider avec les donn√©es dans la "config": <br><br>  local.cf <br><br><pre> <code class="plaintext hljs">rewrite_header Subject *****SPAM***** report_safe 0 required_score 5.0 use_bayes 1 bayes_auto_learn 1 ifplugin Mail::SpamAssassin::Plugin::Shortcircuit endif # Mail::SpamAssassin::Plugin::Shortcircuit</code> </pre><br>  Il est √©galement n√©cessaire de suivre une formation sur les lettres avec et sans spam: <br><br><pre> <code class="plaintext hljs">sa-learn --spam /path/spam/folder sa-learn --ham /path/ham/folder</code> </pre><br><h2>  En option </h2><br>  Dans cette section, je vais sp√©cifier les param√®tres du pare-feu bas√©s sur pf, ajouter pf √† l'ex√©cution automatique et sp√©cifier le fichier avec les r√®gles: <br><br><pre> <code class="plaintext hljs">sysrc pf_enable="YES" sysrc pf_rules="/etc/0.pf"</code> </pre><br>  Cr√©ez un fichier avec les r√®gles: <br><br><pre> <code class="plaintext hljs">ee /etc/0.pf</code> </pre><br>  Et ajoutez-y les r√®gles: <br><br><pre> <code class="plaintext hljs"># (   lo0)    ,     set skip on lo0 #      deovecot, postfix, root pass in quick proto { tcp, udp } from any to any port {53,25,465,587,110,143,993,995} user {dovecot,postfix,root} flags S/SA modulate state pass out quick proto { tcp, udp } from any to any port {53,25,465,587,110,143,993,995} user {dovecot,postfix,root} #      root pass out quick proto {tcp,udp} from any to any user root #     pass in quick proto tcp from any to any port 80 flags S/SA modulate state #SSH pass in quick proto tcp from any to any port 22 flags S/SA modulate state #     clamav  spamd pass out quick proto {tcp,udp} from any to any user {clamav,spamd} #DNS  ICMP pass out quick proto {tcp,udp} from any to any port=53 keep state pass out quick proto icmp from any to any block from any to any fragment block from any to any block all</code> </pre><br>  Vous pouvez ex√©cuter pf avec la commande: <br><br><pre> <code class="plaintext hljs">service pf start</code> </pre><br><h2>  Test </h2><br>  Pour tester toutes les connexions possibles (STARTTLS, SLL), vous pouvez utiliser le client MyOffice Mail pour les appareils mobiles (dans mon cas pour ios), dans cette application, il existe de nombreux param√®tres pour configurer les connexions au serveur de messagerie. <br><br>  Pour tester le spaassasin, nous utilisons la signature GTUBE, ajoutez la ligne dans le message: <br><br><pre> <code class="plaintext hljs">XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X</code> </pre><br>  Si tout est correct, le message sera marqu√© avec du spam et d√©plac√© en cons√©quence dans le dossier spam. <br><br>  Pour tester l'antivirus, vous devez envoyer un email avec un fichier texte, dans ce fichier il y aura une s√©quence EICAR: <br><br><pre> <code class="plaintext hljs">X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*</code> </pre><br>  Les lettres doivent naturellement √™tre envoy√©es √† partir de bo√Ætes aux lettres externes. <br>  Pour afficher les journaux en temps r√©el, ex√©cutez: <br><br><pre> <code class="plaintext hljs">tail -f /var/log/maillog</code> </pre><br>  De plus, pour tester correctement l'envoi de courrier vers des bo√Ætes aux lettres externes (par exemple, yandex.ru, mail.ru, gmail.com, etc.), vous devez enregistrer la zone DNS invers√©e (enregistrement PTR), vous pouvez le faire en contactant votre fournisseur (si vous n'avez certainement pas votre propre serveur DNS). <br><br><h2>  Conclusion </h2><br>  Il peut certainement sembler que le serveur de messagerie est quelque chose de plut√¥t compliqu√©, mais si vous le comprenez, ce n'est pas du tout comme cela, apr√®s avoir pass√© un peu de temps sur la configuration, vous pouvez obtenir un serveur de messagerie plut√¥t fonctionnel, avec une protection contre le spam et les virus. <br><br>  PS Si vous pr√©voyez de ¬´copier-coller¬ª avec des commentaires, vous devez ajouter l'utilisateur root (et ceux qui en ont besoin) aux journaux de classe russes: <br><br><pre> <code class="plaintext hljs">pw usermod root -L russian</code> </pre><br>  Apr√®s ces actions, les caract√®res russes seront affich√©s correctement. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr476148/">https://habr.com/ru/post/fr476148/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr476138/index.html">Les astronomes pensent que les satellites de communication SpaceX, OneWeb et d'autres soci√©t√©s menacent l'avenir de l'astronomie</a></li>
<li><a href="../fr476140/index.html">Comment am√©liorer l'√©coute si vous connaissez 7 000 mots mais ne le comprenez pas √† l'oreille?</a></li>
<li><a href="../fr476142/index.html">Pourquoi √©viter d'utiliser des exceptions pour contr√¥ler votre flux en Java</a></li>
<li><a href="../fr476144/index.html">Comment vous avez besoin et n'avez pas besoin d'√©crire un chat pour les bots en utilisant l'exemple de mon bot pour jouer √† Secret Santa</a></li>
<li><a href="../fr476146/index.html">Comment faire √©voluer les centres de donn√©es. Rapport Yandex</a></li>
<li><a href="../fr476156/index.html">Synchronous Request-Response √† l'aide d'Apache Kafka</a></li>
<li><a href="../fr476160/index.html">La naissance du logiciel √©ducatif et son histoire: des machines m√©caniques aux premiers ordinateurs</a></li>
<li><a href="../fr476162/index.html">Nous cr√©ons une application web moderne. Connaissance du projet et pr√©paration au travail. Partie 1</a></li>
<li><a href="../fr476164/index.html">¬´C'est aussi une analyse de donn√©es.¬ª Parlez de bioinformatique avec Mikhail Gelfand</a></li>
<li><a href="../fr476166/index.html">"Real Iron Man" bat un record de vitesse de vol</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>