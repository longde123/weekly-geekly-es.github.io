<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚èØÔ∏è üê¨ üëçüèº Erstellen Sie ein Multiplayer-.io-Webspiel üì∏ üë©üèø‚Äçüöí üë©üèø‚Äçü§ù‚Äçüë©üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Agar.io wurde 2015 ver√∂ffentlicht und wurde zum Vorl√§ufer des neuen Genres der Spiele .io , dessen Popularit√§t seitdem erheblich zugenommen hat. Das W...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Erstellen Sie ein Multiplayer-.io-Webspiel</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450574/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c7c/405/7a7/c7c4057a7ab7333ee3cb9aba5ecc8c37.jpg" alt="Bild"></div><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">Agar.io</a> wurde 2015 ver√∂ffentlicht und wurde zum Vorl√§ufer des neuen Genres der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer"><strong>Spiele .io</strong></a> , dessen Popularit√§t seitdem erheblich zugenommen hat.  Das Wachstum der Popularit√§t von .io-Spielen, das ich erlebt habe: In den letzten drei Jahren habe ich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zwei Spiele dieses Genres entwickelt und verkauft.</a>  . <br><br>  Falls Sie noch nie von solchen Spielen geh√∂rt haben: Dies sind kostenlose Multiplayer-Web-Spiele, an denen Sie einfach teilnehmen k√∂nnen (kein Konto erforderlich).  Normalerweise schieben sie viele gegnerische Spieler in die gleiche Arena.  Andere ber√ºhmte Spiele des .io-Genres sind: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">Slither.io</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">Diep.io.</a> <br><br>  In diesem Beitrag <strong>erfahren Sie</strong> , wie Sie <strong>ein .io-Spiel von Grund auf neu erstellen</strong> .  Hierzu sind nur Kenntnisse in Javascript ausreichend: Sie m√ºssen beispielsweise die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">ES6-</a> Syntax, das <code>this</code> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">Promises</a> verstehen.  Auch wenn Sie Javascript nicht perfekt kennen, k√∂nnen Sie den gr√∂√üten Teil des Beitrags herausfinden. <br><a name="habracut"></a><br><h2>  Spielbeispiel .io </h2><br>  Um Ihnen das Lernen zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">erleichtern</a> , beziehen wir uns auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ein Beispiel</a> f√ºr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ein .io-Spiel</a> .  Versuche es zu spielen! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/um/yq/qj/umyqqjon22wmshrz8o8wtyeaxl0.png"></div><br>  Das Spiel ist ganz einfach: Sie steuern ein Schiff in einer Arena, in der sich andere Spieler befinden.  Ihr Schiff feuert automatisch Granaten ab und Sie versuchen, andere Spieler zu treffen, w√§hrend Sie deren Granaten ausweichen. <br><br><h2>  1. √úbersicht / Projektstruktur </h2><br><blockquote>  Ich empfehle, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer"><strong>den Quellcode f√ºr ein</strong></a> Beispielspiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer"><strong>herunterzuladen</strong></a> , damit Sie mir folgen k√∂nnen. </blockquote><br>  Das Beispiel verwendet Folgendes: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">Express</a> ist das beliebteste Webframework f√ºr Node.js, das den Webserver des Spiels verwaltet. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">socket.io</a> - eine Websocket-Bibliothek zum Datenaustausch zwischen einem Browser und einem Server. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Webpack</a> ist ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Modulmanager</a> .  Lesen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier,</a> warum Sie Webpack verwenden. </li></ul><br>  So sieht die Projektverzeichnisstruktur aus: <br><br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span>/ assets/ ... src/ <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>/ css/ ... html/ <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.js ... <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>/ <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.js ... shared/ constants.js</code> </pre> <br><h3>  √∂ffentlich / </h3><br>  Alles in der <code>public/</code> Ordner wird statisch vom Server √ºbertragen.  <code>public/assets/</code> enth√§lt die von unserem Projekt verwendeten Bilder. <br><br><h3>  src / </h3><br>  Der gesamte Quellcode befindet sich im Ordner <code>src/</code> .  Die Namen <code>client/</code> und <code>server/</code> sprechen f√ºr sich selbst und <code>shared/</code> enth√§lt eine konstante Datei, die sowohl vom Client als auch vom Server importiert wird. <br><br><h2>  2. Baugruppen / Projektparameter </h2><br>  Wie oben erw√§hnt, verwenden wir den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Webpack-Modulmanager</a> , um das Projekt zu erstellen.  Werfen wir einen Blick auf unsere Webpack-Konfiguration: <br><br><h5>  webpack.common.js: </h5><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = require(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MiniCssExtractPlugin = require(<span class="hljs-string"><span class="hljs-string">'mini-css-extract-plugin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>.exports = { entry: { game: <span class="hljs-string"><span class="hljs-string">'./src/client/index.js'</span></span>, }, output: { filename: <span class="hljs-string"><span class="hljs-string">'[name].[contenthash].js'</span></span>, path: path.resolve(__dirname, <span class="hljs-string"><span class="hljs-string">'dist'</span></span>), }, <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>: { rules: [ { test: /\.js$/, exclude: /node_modules/, use: { loader: <span class="hljs-string"><span class="hljs-string">"babel-loader"</span></span>, options: { presets: [<span class="hljs-string"><span class="hljs-string">'@babel/preset-env'</span></span>], }, }, }, { test: /\.css$/, use: [ { loader: MiniCssExtractPlugin.loader, }, <span class="hljs-string"><span class="hljs-string">'css-loader'</span></span>, ], }, ], }, plugins: [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MiniCssExtractPlugin({ filename: <span class="hljs-string"><span class="hljs-string">'[name].[contenthash].css'</span></span>, }), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HtmlWebpackPlugin({ filename: <span class="hljs-string"><span class="hljs-string">'index.html'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: <span class="hljs-string"><span class="hljs-string">'src/client/html/index.html'</span></span>, }), ], };</code> </pre> <br>  Die wichtigsten hier sind die folgenden Zeilen: <br><br><ul><li>  <code>src/client/index.js</code> ist der Eingabepunkt f√ºr den Javascript-Client (JS).  Webpack startet von hier aus und sucht rekursiv nach anderen importierten Dateien. </li><li>  Die Ausgabe-JS unserer Webpack-Assembly befindet sich im Verzeichnis <code>dist/</code> .  Ich werde diese Datei unser <strong>JS-Paket nennen</strong> . </li><li>  Wir verwenden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">Babel</a> und insbesondere die Konfiguration <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">@ babel / preset-env</a> , um unseren JS-Code f√ºr √§ltere Browser zu transpilieren. </li><li>  Wir verwenden das Plugin, um alle CSS zu extrahieren, auf die in den JS-Dateien verwiesen wird, und um sie an einem Ort zu kombinieren.  Ich werde es unser <strong>CSS-Paket nennen</strong> . </li></ul><br>  M√∂glicherweise haben Sie seltsame Paketdateinamen <code>'[name].[contenthash].ext'</code> .  Sie enthalten die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">Ersetzung der Namen der</a> Webpack- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">Dateien</a> : <code>[name]</code> wird durch den Namen des Eingabepunkts ersetzt (in unserem Fall handelt es sich um ein <code>game</code> ), und <code>[contenthash]</code> wird durch einen Hash des Inhalts der Datei ersetzt.  Wir tun dies, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">um das Projekt f√ºr das Hashing</a> zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">optimieren.</a> Sie k√∂nnen den Browsern anweisen, unsere JS-Pakete auf unbestimmte Zeit zwischenzuspeichern. <strong>Wenn sich das Paket √§ndert, √§ndert sich auch der Dateiname</strong> ( <code>contenthash</code> √§ndert sich).  Das fertige Ergebnis ist ein Dateiname der Form <code>game.dbeee76e91a97d0c7207.js</code> . <br><br>  Die Datei <code>webpack.common.js</code> ist die Basiskonfigurationsdatei, die wir in die Entwicklungs- und abgeschlossenen Projektkonfigurationen importieren.  Zum Beispiel eine Entwicklungskonfiguration: <br><br><h5>  webpack.dev.js </h5><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> merge = require(<span class="hljs-string"><span class="hljs-string">'webpack-merge'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> common = require(<span class="hljs-string"><span class="hljs-string">'./webpack.common.js'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>.exports = merge(common, { mode: <span class="hljs-string"><span class="hljs-string">'development'</span></span>, });</code> </pre> <br>  Aus Effizienzgr√ºnden verwenden wir <code>webpack.dev.js</code> im Entwicklungsprozess und wechseln zu <code>webpack.prod.js</code> , um die <code>webpack.prod.js</code> bei der Bereitstellung in der Produktion zu optimieren. <br><br><h3>  Lokale Einstellung </h3><br>  Ich empfehle, das Projekt auf einem lokalen Computer zu installieren, damit Sie die in diesem Beitrag aufgef√ºhrten Schritte ausf√ºhren k√∂nnen.  Das Setup ist einfach: Zuerst m√ºssen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Node</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">NPM</a> auf dem System installiert sein.  Als n√§chstes m√ºssen Sie durchf√ºhren <br><br><pre> <code class="cpp hljs">$ git clone https:<span class="hljs-comment"><span class="hljs-comment">//github.com/vzhou842/example-.io-game.git $ cd example-.io-game $ npm install</span></span></code> </pre> <br>  und du bist bereit zu gehen!  F√ºhren Sie einfach den Entwicklungsserver aus <br><br><pre> <code class="cpp hljs">$ npm run develop</code> </pre> <br>  und greifen Sie in einem Webbrowser auf den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">localhost: 3000 zu</a> .  Der Entwicklungsserver erstellt die JS- und CSS-Pakete automatisch neu, wenn sich der Code √§ndert. Aktualisieren Sie einfach die Seite, um alle √Ñnderungen anzuzeigen! <br><br><h2>  3. Kundeneinstiegspunkte </h2><br>  Kommen wir zum Spielcode selbst.  Zuerst ben√∂tigen wir die Seite <code>index.html</code> . Wenn Sie die Site besuchen, l√§dt der Browser sie zuerst.  Unsere Seite wird ganz einfach sein: <br><br><h5>  index.html </h5><br><pre>  &lt;! DOCTYPE html&gt;
 &lt;html&gt;
 &lt;head&gt;
   &lt;title&gt; Ein Beispiel f√ºr ein .io-Spiel &lt;/ title&gt;
   &lt;link type = "text / css" rel = "stylesheet" href = "/ game.bundle.css"&gt;
 &lt;/ head&gt;
 &lt;body&gt;
   &lt;canvas id = "game-canvas"&gt; &lt;/ canvas&gt;
   &lt;script async src = "/ game.bundle.js"&gt; &lt;/ script&gt;
   &lt;div id = "play-menu" class = "hidden"&gt;
     &lt;input type = "text" id = "Benutzername-Eingabe" placeholder = "Benutzername" /&gt;
     &lt;button id = "play-button"&gt; SPIELEN &lt;/ button&gt;
   &lt;/ div&gt;
 &lt;/ body&gt;
 &lt;/ html&gt; </pre><br>  <i>Dieses Codebeispiel ist aus Gr√ºnden der √úbersichtlichkeit leicht vereinfacht. Ich werde dasselbe mit vielen anderen Beispielen des Beitrags tun.</i>  <i>Der vollst√§ndige Code kann immer auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github</a> angezeigt werden.</i> <br><br>  Wir haben: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">HTML5 Canvas</a> ( <code>&lt;canvas&gt;</code> ) <code>&lt;canvas&gt;</code> , das wir zum Rendern des Spiels verwenden werden. </li><li>  <code>&lt;link&gt;</code> , um unser CSS-Paket hinzuzuf√ºgen. </li><li>  <code>&lt;script&gt;</code> , um unser Javascript-Paket hinzuzuf√ºgen. </li><li>  Das Hauptmen√º mit dem Benutzernamen <code>&lt;input&gt;</code> und der <code>&lt;button&gt;</code> ‚ÄûPLAY‚Äú ( <code>&lt;button&gt;</code> ). </li></ul><br>  Nach dem Laden der Homepage wird der Javascript-Code im Browser ausgef√ºhrt, beginnend mit der JS-Datei des Einstiegspunkts: <code>src/client/index.js</code> . <br><br><h5>  index.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { connect, play } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./networking'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { startRendering, stopRendering } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./render'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { startCapturingInput, stopCapturingInput } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./input'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { downloadAssets } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./assets'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { initState } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { setLeaderboardHidden } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./leaderboard'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./css/main.css'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> playMenu = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'play-menu'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> playButton = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'play-button'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> usernameInput = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'username-input'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all([ connect(), downloadAssets(), ]).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { playMenu.classList.remove(<span class="hljs-string"><span class="hljs-string">'hidden'</span></span>); usernameInput.focus(); playButton.onclick = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Play! play(usernameInput.value); playMenu.classList.add('hidden'); initState(); startCapturingInput(); startRendering(); setLeaderboardHidden(false); }; });</span></span></code> </pre> <br>  Dies mag kompliziert erscheinen, aber in Wirklichkeit finden hier nicht viele Aktionen statt: <br><br><ol><li>  Importieren Sie mehrere andere JS-Dateien. </li><li>  Importieren Sie CSS (damit Webpack sie in unser CSS-Paket aufnehmen kann). </li><li>  F√ºhren Sie <code>connect()</code> , um eine Verbindung zum Server herzustellen, und f√ºhren Sie <code>downloadAssets()</code> , um die zum Rendern des Spiels erforderlichen Bilder herunterzuladen. </li><li>  <em>Nach Abschluss von Schritt 3</em> wird das Hauptmen√º ( <code>playMenu</code> ) <code>playMenu</code> . </li><li>  Konfigurieren des Handlers zum Dr√ºcken der PLAY-Taste.  Wenn die Taste gedr√ºckt wird, initialisiert der Code das Spiel und teilt dem Server mit, dass wir spielbereit sind. </li></ol><br>  Das Hauptmerkmal unserer Client-Server-Logik sind die Dateien, die von der Datei <code>index.js</code> importiert wurden.  Jetzt werden wir sie alle in der richtigen Reihenfolge betrachten. <br><br><h2>  4. Austausch von Kundendaten </h2><br>  In diesem Spiel verwenden wir die bekannte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">socket.io-</a> Bibliothek, um mit dem Server zu kommunizieren.  Socket.io verf√ºgt √ºber eine integrierte Unterst√ºtzung f√ºr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">WebSockets</a> , die sich gut f√ºr die bidirektionale Kommunikation eignen: Wir k√∂nnen Nachrichten an den Server senden <em>und der</em> Server kann Nachrichten √ºber dieselbe Verbindung an uns senden. <br><br>  Wir werden eine <code>src/client/networking.js</code> Datei haben, die die <strong>gesamte</strong> Kommunikation mit dem Server √ºbernimmt: <br><br><h5>  network.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'socket.io-client'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { processGameUpdate } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> socket = io(<span class="hljs-string"><span class="hljs-string">`ws://</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">window</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.location.host}</span></span></span><span class="hljs-string">`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> connectedPromise = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> { socket.on(<span class="hljs-string"><span class="hljs-string">'connect'</span></span>, () =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Connected to server!'</span></span>); resolve(); }); }); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> connect = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onGameOver</span></span></span><span class="hljs-function"> =&gt;</span></span> ( connectedPromise.then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Register callbacks socket.on(Constants.MSG_TYPES.GAME_UPDATE, processGameUpdate); socket.on(Constants.MSG_TYPES.GAME_OVER, onGameOver); }) ); export const play = username =&gt; { socket.emit(Constants.MSG_TYPES.JOIN_GAME, username); }; export const updateDirection = dir =&gt; { socket.emit(Constants.MSG_TYPES.INPUT, dir); };</span></span></code> </pre> <br>  <i>Dieser Code ist aus Gr√ºnden der √úbersichtlichkeit ebenfalls leicht reduziert.</i> <br><br>  Diese Datei enth√§lt drei Hauptaktionen: <br><br><ul><li>  Wir versuchen, eine Verbindung zum Server herzustellen.  <code>connectedPromise</code> ist nur zul√§ssig, wenn wir eine Verbindung hergestellt haben. </li><li>  Wenn die Verbindung erfolgreich hergestellt wurde, registrieren wir R√ºckruffunktionen ( <code>processGameUpdate()</code> und <code>onGameOver()</code> ) f√ºr Nachrichten, die wir vom Server empfangen k√∂nnen. </li><li>  Wir exportieren <code>play()</code> und <code>updateDirection()</code> damit andere Dateien sie verwenden k√∂nnen. </li></ul><br><h2>  5. Client-Rendering </h2><br>  Es ist Zeit, ein Bild auf dem Bildschirm anzuzeigen! <br><br>  ... aber bevor wir dies tun k√∂nnen, m√ºssen wir alle Bilder (Ressourcen) herunterladen, die daf√ºr ben√∂tigt werden.  Schreiben wir einen Ressourcenmanager: <br><br><h5>  Assets.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ASSET_NAMES = [<span class="hljs-string"><span class="hljs-string">'ship.svg'</span></span>, <span class="hljs-string"><span class="hljs-string">'bullet.svg'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> assets = {}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> downloadPromise = <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all(ASSET_NAMES.map(downloadAsset)); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downloadAsset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">assetName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> asset = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image(); asset.onload = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Downloaded </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${assetName}</span></span></span><span class="hljs-string">`</span></span>); assets[assetName] = asset; resolve(); }; asset.src = <span class="hljs-string"><span class="hljs-string">`/assets/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${assetName}</span></span></span><span class="hljs-string">`</span></span>; }); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> downloadAssets = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> downloadPromise; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getAsset = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">assetName</span></span></span><span class="hljs-function"> =&gt;</span></span> assets[assetName];</code> </pre> <br>  Ressourcenmanagement ist nicht so schwer zu implementieren!  Der Hauptpunkt besteht darin, das <code>assets</code> Objekt zu speichern, das den Dateinamenschl√ºssel an den Wert des <code>Image</code> Objekts bindet.  Wenn die Ressource geladen ist, speichern wir sie im <code>assets</code> Objekt, damit sie in Zukunft schnell abgerufen werden kann.  Wenn das Herunterladen f√ºr jede einzelne Ressource zul√§ssig ist (dh <strong>alle</strong> Ressourcen werden heruntergeladen), aktivieren wir <code>downloadPromise</code> . <br><br>  Nach dem Herunterladen der Ressourcen k√∂nnen Sie mit dem Rendern beginnen.  Wie bereits erw√§hnt, verwenden wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">HTML5-Canvas</a> ( <code>&lt;canvas&gt;</code> ), um auf der Webseite zu zeichnen.  Unser Spiel ist recht einfach, daher m√ºssen wir nur Folgendes zeichnen: <br><br><ol><li>  Hintergrund </li><li>  Spielerschiff </li><li>  Andere Spieler im Spiel </li><li>  Muscheln </li></ol><br>  Hier sind die wichtigen Ausschnitte aus <code>src/client/render.js</code> , die genau die vier oben aufgef√ºhrten Punkte rendern: <br><br><h5>  render.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { getAsset } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./assets'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { getCurrentState } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { PLAYER_RADIUS, PLAYER_MAX_HP, BULLET_RADIUS, MAP_SIZE } = Constants; <span class="hljs-comment"><span class="hljs-comment">// Get the canvas graphics context const canvas = document.getElementById('game-canvas'); const context = canvas.getContext('2d'); // Make the canvas fullscreen canvas.width = window.innerWidth; canvas.height = window.innerHeight; function render() { const { me, others, bullets } = getCurrentState(); if (!me) { return; } // Draw background renderBackground(me.x, me.y); // Draw all bullets bullets.forEach(renderBullet.bind(null, me)); // Draw all players renderPlayer(me, me); others.forEach(renderPlayer.bind(null, me)); } // ... Helper functions here excluded let renderInterval = null; export function startRendering() { renderInterval = setInterval(render, 1000 / 60); } export function stopRendering() { clearInterval(renderInterval); }</span></span></code> </pre> <br>  <i>Dieser Code wird aus Gr√ºnden der √úbersichtlichkeit ebenfalls gek√ºrzt.</i> <br><br>  <code>render()</code> ist die Hauptfunktion dieser Datei.  <code>startRendering()</code> und <code>stopRendering()</code> steuern die Aktivierung des <code>stopRendering()</code> mit 60 FPS. <br><br>  Die spezifischen Implementierungen der einzelnen <code>renderBullet()</code> (z. B. <code>renderBullet()</code> ) sind nicht so wichtig, aber hier ist ein einfaches Beispiel: <br><br><h5>  render.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderBullet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">me, bullet</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { x, y } = bullet; context.drawImage( getAsset(<span class="hljs-string"><span class="hljs-string">'bullet.svg'</span></span>), canvas.width / <span class="hljs-number"><span class="hljs-number">2</span></span> + x - me.x - BULLET_RADIUS, canvas.height / <span class="hljs-number"><span class="hljs-number">2</span></span> + y - me.y - BULLET_RADIUS, BULLET_RADIUS * <span class="hljs-number"><span class="hljs-number">2</span></span>, BULLET_RADIUS * <span class="hljs-number"><span class="hljs-number">2</span></span>, ); }</code> </pre> <br>  Beachten Sie, dass wir die Methode <code>getAsset()</code> verwenden, die zuvor in <code>asset.js</code> ! <br><br><blockquote>  Wenn Sie andere zus√§tzliche Rendering-Funktionen erkunden <a href="">m√∂chten</a> , lesen Sie den Rest von <a href="">src / client / render.js</a> . </blockquote><br><h2>  6. Client-Eingabe </h2><br>  Es ist Zeit, das Spiel <em>spielbar</em> zu machen!  Das Steuerungsschema ist sehr einfach: Sie k√∂nnen die Bewegungsrichtung mit der Maus (auf dem Computer) oder durch Ber√ºhren des Bildschirms (auf dem mobilen Ger√§t) √§ndern.  Um dies zu implementieren, registrieren wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ereignis-Listener</a> f√ºr Maus- und Touch-Ereignisse. <br>  <code>src/client/input.js</code> dies alles: <br><br><h5>  input.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { updateDirection } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./networking'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMouseInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ handleInput(e.clientX, e.clientY); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTouchInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> touch = e.touches[<span class="hljs-number"><span class="hljs-number">0</span></span>]; handleInput(touch.clientX, touch.clientY); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, y</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dir = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.atan2(x - <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.innerWidth / <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.innerHeight / <span class="hljs-number"><span class="hljs-number">2</span></span> - y); updateDirection(dir); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startCapturingInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'mousemove'</span></span>, onMouseInput); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'touchmove'</span></span>, onTouchInput); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stopCapturingInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.removeEventListener(<span class="hljs-string"><span class="hljs-string">'mousemove'</span></span>, onMouseInput); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.removeEventListener(<span class="hljs-string"><span class="hljs-string">'touchmove'</span></span>, onTouchInput); }</code> </pre> <br>  <code>onMouseInput()</code> und <code>onTouchInput()</code> sind Ereignis-Listener, die <code>updateDirection()</code> (von <code>updateDirection()</code> aufrufen, wenn ein Eingabeereignis auftritt (z. B. beim Bewegen der Maus).  <code>updateDirection()</code> Nachrichten an einen Server, der das Eingabeereignis verarbeitet und den Spielstatus entsprechend aktualisiert. <br><br><h2>  7. Kundenzustand </h2><br><blockquote>  Dieser Abschnitt ist der schwierigste im ersten Teil des Beitrags.  Lassen Sie sich nicht entmutigen, wenn Sie es von der ersten Lesung an nicht verstehen!  Sie k√∂nnen es sogar √ºberspringen und sp√§ter darauf zur√ºckkommen. </blockquote><br>  Das letzte Puzzleteil, das zum Vervollst√§ndigen des Client-Server-Codes ben√∂tigt wird, ist der <strong>Status</strong> .  Erinnern Sie sich an das Code-Snippet aus dem Abschnitt Client-Rendering? <br><br><h5>  render.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { getCurrentState } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { me, others, bullets } = getCurrentState(); <span class="hljs-comment"><span class="hljs-comment">// Do the rendering // ... }</span></span></code> </pre> <br>  <code>getCurrentState()</code> sollte in der Lage sein, uns <strong>jederzeit</strong> den aktuellen Status des Spiels auf dem Client basierend auf den vom Server empfangenen Updates bereitzustellen.  Hier ist ein Beispiel f√ºr ein Spiel-Update, das ein Server senden kann: <br><br><pre> <code class="cpp hljs">{ <span class="hljs-string"><span class="hljs-string">"t"</span></span>: <span class="hljs-number"><span class="hljs-number">1555960373725</span></span>, <span class="hljs-string"><span class="hljs-string">"me"</span></span>: { <span class="hljs-string"><span class="hljs-string">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">2213.8050880413657</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">1469.370893425012</span></span>, <span class="hljs-string"><span class="hljs-string">"direction"</span></span>: <span class="hljs-number"><span class="hljs-number">1.3082443894581433</span></span>, <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"AhzgAtklgo2FJvwWAADO"</span></span>, <span class="hljs-string"><span class="hljs-string">"hp"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> }, <span class="hljs-string"><span class="hljs-string">"others"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"bullets"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"RUJfJ8Y18n"</span></span>, <span class="hljs-string"><span class="hljs-string">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">2354.029197099604</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">1431.6848318262666</span></span> }, { <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"ctg5rht5s"</span></span>, <span class="hljs-string"><span class="hljs-string">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">2260.546457727445</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">1456.8088728920968</span></span> } ], <span class="hljs-string"><span class="hljs-string">"leaderboard"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"Player"</span></span>, <span class="hljs-string"><span class="hljs-string">"score"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> } ] }</code> </pre> <br>  Jedes Spiel-Update enth√§lt f√ºnf identische Felder: <br><br><ul><li>  <strong>t</strong> : Server-Zeitstempel f√ºr die Zeit, zu der dieses Update erstellt wurde. </li><li>  <strong>Ich</strong> : Informationen √ºber den Spieler, der dieses Update erh√§lt. </li><li>  <strong>andere</strong> : eine Reihe von Informationen √ºber andere Spieler, die am selben Spiel teilnehmen. </li><li>  <strong>Aufz√§hlungszeichen</strong> : Eine Reihe von Informationen zu den Muscheln im Spiel. </li><li>  <strong>Rangliste</strong> : Aktuelle Ranglistendaten.  In diesem Beitrag werden wir sie nicht ber√ºcksichtigen. </li></ul><br><h3>  7.1 Der naive Zustand des Kunden </h3><br>  Die naive Implementierung von <code>getCurrentState()</code> kann nur Daten aus dem letzten erhaltenen <code>getCurrentState()</code> direkt zur√ºckgeben. <br><br><h5>  naive-state.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> lastGameUpdate = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Handle a newly received game update. export function processGameUpdate(update) { lastGameUpdate = update; } export function getCurrentState() { return lastGameUpdate; }</span></span></code> </pre> <br>  Sch√∂n und klar!  Aber wenn alles so einfach w√§re.  Einer der Gr√ºnde, warum diese Implementierung problematisch ist: <strong>Sie begrenzt die Framerate des Renderings auf die Frequenz der Serveruhr</strong> . <br><br><blockquote>  <strong>Bildrate</strong> : Die Anzahl der Bilder (d. H. <code>render()</code> -Aufrufe) pro Sekunde oder FPS.  Spiele erreichen normalerweise mindestens 60 FPS. </blockquote><br><blockquote>  <strong>Tick ‚Äã‚ÄãRate</strong> : Die H√§ufigkeit, mit der der Server Spielaktualisierungen an Clients sendet.  <strong>Oft ist es niedriger als die Bildrate</strong> .  In unserem Spiel l√§uft der Server mit einer Frequenz von 30 Zyklen pro Sekunde. </blockquote><br>  Wenn wir nur das neueste Update des Spiels rendern, kann FPS 30 <em>niemals</em> √ºberschreiten, da <em>wir nie mehr als 30 Updates pro Sekunde vom Server erhalten</em> .  Selbst wenn wir <code>render()</code> 60 Mal pro Sekunde aufrufen, wird die H√§lfte dieser Aufrufe einfach dasselbe neu zeichnen und im Wesentlichen nichts tun.  Ein weiteres Problem der naiven Implementierung besteht darin, dass es <strong>zu Verz√∂gerungen kommt</strong> .  Bei einer idealen Internetgeschwindigkeit erh√§lt der Client genau alle 33 ms (30 pro Sekunde) ein Spielupdate: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bc3/815/7c9/bc38157c91d436b5fedf948b60c8a213.svg"></div><br>  Leider ist nichts perfekt.  Ein realistischeres Bild w√§re: <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/836/45f/75e/83645f75e556bc5c1c38111a69510734.svg"></div><br>  Eine naive Implementierung ist praktisch der schlimmste Fall, wenn es um Verz√∂gerungen geht.  Wenn das Spiel-Update mit einer Verz√∂gerung von 50 ms empfangen wird, <strong>verlangsamt sich</strong> der <strong>Client</strong> um weitere 50 ms, da der Status des Spiels aus dem vorherigen Update weiterhin angezeigt wird.  Sie k√∂nnen sich vorstellen, wie unpraktisch es f√ºr einen Spieler ist: Durch willk√ºrliches Bremsen erscheint das Spiel nerv√∂s und instabil. <br><br><h3>  7.2 Verbesserter Kundenstatus </h3><br>  Wir werden einige Verbesserungen an der naiven Implementierung vornehmen.  Zun√§chst verwenden wir <strong>eine Renderverz√∂gerung von</strong> 100 ms.  Dies bedeutet, dass der "aktuelle" Status des Clients immer um 100 ms hinter dem Status des Spiels auf dem Server zur√ºckbleibt.  Wenn die Zeit auf dem Server beispielsweise <strong>150</strong> betr√§gt, wird der Status gerendert, in dem sich der Server zum Zeitpunkt <strong>50 befand</strong> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/788/1b5/c78/7881b5c789321648ff1ff70d15b881d4.svg"></div><br>  Dies gibt uns einen Puffer von 100 ms, so dass wir die unvorhersehbare Zeit √ºberleben k√∂nnen, um Spielaktualisierungen zu erhalten: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c1e/494/615/c1e4946159c599c7a2a9196968755e4b.svg"></div><br>  Hierf√ºr wird eine konstante <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">Eingangsverz√∂gerung (Eingangsverz√∂gerung) von</a> 100 ms gezahlt.  Dies ist ein kleines Opfer f√ºr ein reibungsloses Gameplay - die meisten Spieler (besonders Gelegenheitsspieler) werden diese Verz√∂gerung nicht einmal bemerken.  Es ist f√ºr Menschen viel einfacher, sich an eine konstante Verz√∂gerung von 100 ms anzupassen, als mit einer unvorhersehbaren Verz√∂gerung zu spielen. <br><br><blockquote>  Wir k√∂nnen eine andere Technik verwenden, die als <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">"clientseitige Prognose" bezeichnet wird und</a> die wahrgenommene Verz√∂gerungen gut reduziert, in diesem Beitrag jedoch nicht ber√ºcksichtigt wird. </blockquote><br>  Eine weitere Verbesserung, die wir verwenden, ist die <strong>lineare Interpolation</strong> .  Aufgrund von Rendering-Verz√∂gerungen √ºberholen wir normalerweise die aktuelle Zeit im Client um mindestens ein Update.  Wenn <code>getCurrentState()</code> aufgerufen wird, k√∂nnen wir unmittelbar vor und nach der aktuellen Zeit im Client eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="noopener noreferrer">lineare Interpolation</a> zwischen <code>getCurrentState()</code> durchf√ºhren: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ca/1c8/91c/2ca1c891ce7db0341dc78c2f88e16ce4.svg"></div><br>  Dies l√∂st das Problem mit der Bildrate: Jetzt k√∂nnen wir eindeutige Bilder mit jeder Frequenz rendern, die wir ben√∂tigen! <br><br><h3>  7.3 Implementieren des erweiterten Clientstatus </h3><br>  Eine Beispielimplementierung in <code>src/client/state.js</code> verwendet sowohl die Renderverz√∂gerung als auch die lineare Interpolation, dies ist jedoch nicht lange.  Teilen wir den Code in zwei Teile.  Hier ist der erste: <br><br><h5>  state.js Teil 1 </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> RENDER_DELAY = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> gameUpdates = []; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameStart = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> firstServerTimestamp = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ gameStart = <span class="hljs-number"><span class="hljs-number">0</span></span>; firstServerTimestamp = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processGameUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">update</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!firstServerTimestamp) { firstServerTimestamp = update.t; gameStart = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); } gameUpdates.push(update); <span class="hljs-comment"><span class="hljs-comment">// Keep only one game update before the current server time const base = getBaseUpdate(); if (base &gt; 0) { gameUpdates.splice(0, base); } } function currentServerTime() { return firstServerTimestamp + (Date.now() - gameStart) - RENDER_DELAY; } // Returns the index of the base update, the first game update before // current server time, or -1 if N/A. function getBaseUpdate() { const serverTime = currentServerTime(); for (let i = gameUpdates.length - 1; i &gt;= 0; i--) { if (gameUpdates[i].t &lt;= serverTime) { return i; } } return -1; }</span></span></code> </pre> <br>  Der erste Schritt besteht darin, herauszufinden, was <code>currentServerTime()</code> tut.  Wie wir bereits gesehen haben, ist in jedem Spielupdate ein Server-Zeitstempel enthalten.  Wir m√∂chten die Rendering-Verz√∂gerung verwenden, um das Image 100 ms hinter dem Server zu rendern, aber <strong>wir werden nie die aktuelle Zeit auf dem Server</strong> erfahren, da wir nicht wissen k√∂nnen, wie lange eines der Updates bei uns angekommen ist.  Das Internet ist unvorhersehbar und seine Geschwindigkeit kann sehr unterschiedlich sein! <br><br>  Um dieses Problem zu umgehen, k√∂nnen Sie eine vern√ºnftige Ann√§herung verwenden: Wir werden so <strong>tun, als ob das erste Update sofort eingetroffen w√§re</strong> .  Wenn dies wahr w√§re, w√ºrden wir die Serverzeit in diesem bestimmten Moment kennen!  Wir speichern den Server-Zeitstempel in <code>firstServerTimestamp</code> und gleichzeitig unseren <strong>lokalen</strong> (Client-) Zeitstempel in <code>gameStart</code> . <br><br>  Oh warte.  <b>Sollte nicht Zeit auf dem Server sein = Zeit im Client?</b>  Warum unterscheiden wir zwischen "Server-Zeitstempel" und "Client-Zeitstempel"?  Das ist eine gute Frage!  Es stellt sich heraus, dass dies nicht dasselbe ist.  <code>Date.now()</code> gibt unterschiedliche Zeitstempel auf dem Client und dem Server zur√ºck. Dies h√§ngt von den lokalen Faktoren f√ºr diese Computer ab.  <strong>Gehen Sie niemals davon aus, dass die Zeitstempel auf allen Maschinen gleich sind.</strong> <br><br>  Jetzt verstehen wir, was <code>currentServerTime()</code> tut: Es gibt <strong>den Server-Zeitstempel der aktuellen Renderzeit zur√ºck</strong> .<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit anderen Worten, dies ist die aktuelle Serverzeit ( </font></font><code>firstServerTimestamp &lt;+ (Date.now() - gameStart)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) abz√ºglich der Renderverz√∂gerung ( </font></font><code>RENDER_DELAY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nun wollen wir sehen, wie wir mit Spielaktualisierungen umgehen. Wenn ein Update vom Server empfangen wird, wird es aufgerufen </font></font><code>processGameUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und wir speichern das neue Update in einem Array </font></font><code>gameUpdates</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Um die Speichernutzung zu √ºberpr√ºfen, l√∂schen wir alle alten Updates f√ºr das </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basisupdate</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , da wir sie nicht mehr ben√∂tigen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was ist ein "Basisupdate"? Dies ist das </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erste Update, das von der aktuellen Serverzeit r√ºckw√§rts verschoben wird</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Erinnerst du dich an diese Schaltung?</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ca/1c8/91c/2ca1c891ce7db0341dc78c2f88e16ce4.svg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Spiel-Update direkt links von Client Render Time ist ein Basis-Update. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wof√ºr wird das Basisupdate verwendet? </font><font style="vertical-align: inherit;">Warum k√∂nnen wir Updates f√ºr die Basis verwerfen? </font><font style="vertical-align: inherit;">Um dies zu verstehen, </font><font style="vertical-align: inherit;">schauen </font><font style="vertical-align: inherit;">wir uns zum </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schluss</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> die Implementierung an </font></font><code>getCurrentState()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> state.js Teil 2 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!firstServerTimestamp) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {}; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> base = getBaseUpdate(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> serverTime = currentServerTime(); <span class="hljs-comment"><span class="hljs-comment">// If base is the most recent update we have, use its state. // Else, interpolate between its state and the state of (base + 1). if (base &lt; 0) { return gameUpdates[gameUpdates.length - 1]; } else if (base === gameUpdates.length - 1) { return gameUpdates[base]; } else { const baseUpdate = gameUpdates[base]; const next = gameUpdates[base + 1]; const r = (serverTime - baseUpdate.t) / (next.t - baseUpdate.t); return { me: interpolateObject(baseUpdate.me, next.me, r), others: interpolateObjectArray(baseUpdate.others, next.others, r), bullets: interpolateObjectArray(baseUpdate.bullets, next.bullets, r), }; } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wir behandeln drei F√§lle: </font></font><br><br><ol><li> <code>base &lt; 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bedeutet, dass die aktuelle Renderzeit nicht aktualisiert wird (siehe Implementierung oben </font></font><code>getBaseUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Dies kann zu Beginn des Spiels aufgrund von Verz√∂gerungen beim Rendern passieren. </font><font style="vertical-align: inherit;">In diesem Fall verwenden wir das neueste Update.</font></font></li><li> <code>base</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dies ist das neueste Update, das wir haben. </font><font style="vertical-align: inherit;">Dies kann auf eine Netzwerklatenz oder eine schlechte Internetverbindung zur√ºckzuf√ºhren sein. </font><font style="vertical-align: inherit;">In diesem Fall verwenden wir auch das neueste Update, das wir haben.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben ein Update vor und nach der aktuellen Renderzeit, damit Sie </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interpolieren k√∂nnen</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alles, was bleibt, </font></font><code>state.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ist die Implementierung der linearen Interpolation, die eine einfache (aber langweilige) Mathematik ist. </font><font style="vertical-align: inherit;">Wenn Sie es selbst lernen m√∂chten, √∂ffnen Sie es </font></font><code>state.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auf </font></font><a href="" rel="noopener noreferrer"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Teil 2. Backend Server </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In diesem Teil sehen wir uns das Node.js-Backend an, in dem unser </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.io-Spielbeispiel ausgef√ºhrt wird</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1. Servereinstiegspunkt </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zur Steuerung des Webservers verwenden wir das beliebte Webframework f√ºr Node.js namens </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Express</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es wird von unserer Server-Einstiegspunktdatei konfiguriert </font></font><code>src/server/server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server.js, Teil 1 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpack = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpackDevMiddleware = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack-dev-middleware'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpackConfig = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../webpack.dev.js'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Setup an Express server const app = express(); app.use(express.static('public')); if (process.env.NODE_ENV === 'development') { // Setup Webpack for development const compiler = webpack(webpackConfig); app.use(webpackDevMiddleware(compiler)); } else { // Static serve the dist/ folder in production app.use(express.static('dist')); } // Listen on port const port = process.env.PORT || 3000; const server = app.listen(port); console.log(`Server listening on port ${port}`);</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Denken Sie daran, dass wir im ersten Teil √ºber Webpack gesprochen haben? </font><font style="vertical-align: inherit;">Hier werden wir unsere Webpack-Konfigurationen verwenden. </font><font style="vertical-align: inherit;">Wir werden sie auf zwei Arten anwenden:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden Sie die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Webpack-Dev-Middleware</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um unsere Entwicklungspakete automatisch neu zu </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">erstellen</font></a><font style="vertical-align: inherit;"> , oder</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√úbertragen Sie statisch den Ordner, </font></font><code>dist/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in den Webpack unsere Dateien nach dem Zusammenbau der Produktion schreibt.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine weitere wichtige Aufgabe </font></font><code>server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">besteht darin, den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">socket.io-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Server zu konfigurieren </font><font style="vertical-align: inherit;">, der einfach eine Verbindung zum Express-Server herstellt:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server.js, Teil 2 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> socketio = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'socket.io'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Setup Express // ... const server = app.listen(port); console.log(`Server listening on port ${port}`); // Setup socket.io const io = socketio(server); // Listen for socket.io connections io.on('connection', socket =&gt; { console.log('Player connected!', socket.id); socket.on(Constants.MSG_TYPES.JOIN_GAME, joinGame); socket.on(Constants.MSG_TYPES.INPUT, handleInput); socket.on('disconnect', onDisconnect); });</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nach dem erfolgreichen Aufbau einer socket.io-Verbindung mit dem Server konfigurieren wir Ereignishandler f√ºr den neuen Socket. </font><font style="vertical-align: inherit;">Ereignishandler verarbeiten Nachrichten, die von Clients durch Delegierung an das Singleton-Objekt empfangen wurden </font></font><code>game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server.js, Teil 3 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Game = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./game'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ... // Setup the Game const game = new Game(); function joinGame(username) { game.addPlayer(this, username); } function handleInput(dir) { game.handleInput(this, dir); } function onDisconnect() { game.removePlayer(this); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir erstellen ein Spiel des .io-Genres, daher ben√∂tigen wir nur eine Instanz </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(‚ÄûSpiel‚Äú) - alle Spieler spielen in derselben Arena! </font><font style="vertical-align: inherit;">Im n√§chsten Abschnitt werden wir sehen, wie diese Klasse funktioniert </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2. Spieleserver </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Klasse </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enth√§lt die wichtigste serverseitige Logik. </font><font style="vertical-align: inherit;">Es hat zwei Hauptaufgaben: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spielerverwaltung</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spielsimulation</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beginnen wir mit der ersten Aufgabe - mit der Spielerverwaltung.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js, Teil 1 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Player = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./player'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sockets = {}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.players = {}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bullets = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastUpdateTime = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.shouldSendUpdate = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; setInterval(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.update.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>), <span class="hljs-number"><span class="hljs-number">1000</span></span> / <span class="hljs-number"><span class="hljs-number">60</span></span>); } addPlayer(socket, username) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sockets[socket.id] = socket; <span class="hljs-comment"><span class="hljs-comment">// Generate a position to start this player at. const x = Constants.MAP_SIZE * (0.25 + Math.random() * 0.5); const y = Constants.MAP_SIZE * (0.25 + Math.random() * 0.5); this.players[socket.id] = new Player(socket.id, username, x, y); } removePlayer(socket) { delete this.sockets[socket.id]; delete this.players[socket.id]; } handleInput(socket, dir) { if (this.players[socket.id]) { this.players[socket.id].setDirection(dir); } } // ... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In diesem Spiel identifizieren wir die Spieler anhand des Feldes </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ihres Sockets socket.io (wenn Sie verwirrt sind, kehren Sie zu zur√ºck </font></font><code>server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Socket.io selbst weist jedem Socket einen eindeutigen zu </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sodass wir uns dar√ºber keine Gedanken machen m√ºssen. </font><font style="vertical-align: inherit;">Ich werde seine </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spieler-ID</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> anrufen </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lassen Sie uns vor diesem Hintergrund die Instanzvariablen in der Klasse untersuchen </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><ul><li> <code>sockets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ist ein Objekt, das die Spieler-ID an den Socket bindet, der dem Spieler zugeordnet ist. </font><font style="vertical-align: inherit;">Es erm√∂glicht uns, f√ºr eine konstante Zeit √ºber ihre Spieler-IDs auf Sockets zuzugreifen.</font></font></li><li> <code>players</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ist ein Objekt, das eine Spieler-ID an einen Code bindet&gt; Spielerobjekt </font></font></li></ul><br> <code>bullets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ist ein Array von Objekten </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, die keine bestimmte Reihenfolge haben. </font></font><br> <code>lastUpdateTime</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Dies ist der Zeitstempel der Zeit, zu der das Spiel zuletzt aktualisiert wurde. </font><font style="vertical-align: inherit;">Bald werden wir sehen, wie es verwendet wird. </font></font><br> <code>shouldSendUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ist eine Hilfsvariable. </font><font style="vertical-align: inherit;">Wir werden seine Verwendung auch bald sehen. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Methoden </font></font><code>addPlayer()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>removePlayer()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>handleInput()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keine Notwendigkeit zu erkl√§ren, werden sie in verwendet </font></font><code>server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wenn Sie Ihr Ged√§chtnis auffrischen m√ºssen, gehen Sie etwas h√∂her zur√ºck. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die letzte Zeile </font></font><code>constructor()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">startet </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">den Spielaktualisierungszyklus</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (mit einer H√§ufigkeit von 60 Updates / s):</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js, Teil 2 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> applyCollisions = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collisions'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... update() { // Calculate time elapsed const now = Date.now(); const dt = (now - this.lastUpdateTime) / 1000; this.lastUpdateTime = now; // Update each bullet const bulletsToRemove = []; this.bullets.forEach(bullet =&gt; { if (bullet.update(dt)) { // Destroy this bullet bulletsToRemove.push(bullet); } }); this.bullets = this.bullets.filter( bullet =&gt; !bulletsToRemove.includes(bullet), ); // Update each player Object.keys(this.sockets).forEach(playerID =&gt; { const player = this.players[playerID]; const newBullet = player.update(dt); if (newBullet) { this.bullets.push(newBullet); } }); // Apply collisions, give players score for hitting bullets const destroyedBullets = applyCollisions( Object.values(this.players), this.bullets, ); destroyedBullets.forEach(b =&gt; { if (this.players[b.parentID]) { this.players[b.parentID].onDealtDamage(); } }); this.bullets = this.bullets.filter( bullet =&gt; !destroyedBullets.includes(bullet), ); // Check if any players are dead Object.keys(this.sockets).forEach(playerID =&gt; { const socket = this.sockets[playerID]; const player = this.players[playerID]; if (player.hp &lt;= 0) { socket.emit(Constants.MSG_TYPES.GAME_OVER); this.removePlayer(socket); } }); // Send a game update to each player every other time if (this.shouldSendUpdate) { const leaderboard = this.getLeaderboard(); Object.keys(this.sockets).forEach(playerID =&gt; { const socket = this.sockets[playerID]; const player = this.players[playerID]; socket.emit( Constants.MSG_TYPES.GAME_UPDATE, this.createUpdate(player, leaderboard), ); }); this.shouldSendUpdate = false; } else { this.shouldSendUpdate = true; } } // ... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Methode </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enth√§lt wahrscheinlich den wichtigsten Teil der serverseitigen Logik. </font><font style="vertical-align: inherit;">Um alles aufzulisten, was er tut:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berechnet, wie viel Zeit </font></font><code>dt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seit dem letzten vergangen ist </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li><li>        .      .    ,  <code>bullet.update()</code> <strong> <code>true</code> ,     </strong> (    ). </li><li>        .       ‚Äî <code>player.update()</code> <strong>   <code>Bullet</code></strong> . </li><li>         <code>applyCollisions()</code> ,    ,    .        ,    (  <code>player.onDealtDamage()</code> ),       <code>bullets</code> . </li><li>      . </li><li>      <strong> </strong>    <code>update()</code> .         <code>shouldSendUpdate</code> .   <code>update()</code>  60 /,     30 /.  , <strong> </strong>   30 / (       ). </li></ol><br><blockquote> <strong>     <em> </em> ?</strong>   . 30     ‚Äì   ! </blockquote><br><blockquote> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum dann einfach nicht </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30 mal pro Sekunde </font><font style="vertical-align: inherit;">anrufen </font><font style="vertical-align: inherit;">? </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um die Simulation des Spiels zu verbessern. </font><font style="vertical-align: inherit;">Je √∂fter aufgerufen </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, desto genauer ist die Simulation des Spiels. </font><font style="vertical-align: inherit;">Aber lassen Sie sich nicht zu sehr von der Anzahl der Anrufe mitrei√üen </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, denn dies ist eine rechenintensive Aufgabe - 60 pro Sekunde sind v√∂llig ausreichend.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Rest der Klasse </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">besteht aus Hilfsmethoden, die verwendet werden in </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js, Teil 3 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... getLeaderboard() { return Object.values(this.players) .sort((p1, p2) =&gt; p2.score - p1.score) .slice(0, 5) .map(p =&gt; ({ username: p.username, score: Math.round(p.score) })); } createUpdate(player, leaderboard) { const nearbyPlayers = Object.values(this.players).filter( p =&gt; p !== player &amp;&amp; p.distanceTo(player) &lt;= Constants.MAP_SIZE / 2, ); const nearbyBullets = this.bullets.filter( b =&gt; b.distanceTo(player) &lt;= Constants.MAP_SIZE / 2, ); return { t: Date.now(), me: player.serializeForUpdate(), others: nearbyPlayers.map(p =&gt; p.serializeForUpdate()), bullets: nearbyBullets.map(b =&gt; b.serializeForUpdate()), leaderboard, }; } }</span></span></code> </pre> <br> <code>getLeaderboard()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ganz einfach - es sortiert die Spieler nach der Anzahl der Punkte, nimmt die f√ºnf besten und gibt f√ºr jeden Benutzernamen und jede Punktzahl zur√ºck. </font></font><br><br> <code>createUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wird verwendet </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, um Spielaktualisierungen zu erstellen, die an die Spieler weitergegeben werden. </font><font style="vertical-align: inherit;">Seine Hauptaufgabe besteht darin, Methoden aufzurufen, </font></font><code>serializeForUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die f√ºr </font></font><code>Player</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font><font style="vertical-align: inherit;">Klassen implementiert sind </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Beachten Sie, dass er jedem Spieler nur die Daten der </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√§chstgelegenen</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Spieler und Granaten √ºbertr√§gt - es ist nicht erforderlich, Informationen √ºber Spielobjekte zu √ºbertragen, die sich weit vom Spieler entfernt befinden!</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3. Spielobjekte auf dem Server </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In unserem Spiel sind sich die Muscheln und Spieler tats√§chlich sehr √§hnlich: Sie sind abstrakte, sich bewegende Spielobjekte. </font><font style="vertical-align: inherit;">Um diese √Ñhnlichkeit von Spielern und Shells zu nutzen, beginnen wir mit der Implementierung der Basisklasse </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> object.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Object</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(id, x, y, dir, speed) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id = id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x = x; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y = y; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction = dir; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed = speed; } update(dt) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x += dt * <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y -= dt * <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction); } distanceTo(object) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dx = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x - object.x; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dy = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y - object.y; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(dx * dx + dy * dy); } setDirection(dir) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction = dir; } serializeForUpdate() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id, <span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y, }; } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hier passiert nichts Kompliziertes. </font><font style="vertical-align: inherit;">Diese Klasse wird ein guter Bezugspunkt f√ºr die Erweiterung sein. </font><font style="vertical-align: inherit;">Mal sehen, wie die Klasse </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verwendet </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bullet.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> shortid = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'shortid'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ObjectClass = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./object'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bullet</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(parentID, x, y, dir) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(shortid(), x, y, dir, Constants.BULLET_SPEED); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parentID = parentID; } <span class="hljs-comment"><span class="hljs-comment">// Returns true if the bullet should be destroyed update(dt) { super.update(dt); return this.x &lt; 0 || this.x &gt; Constants.MAP_SIZE || this.y &lt; 0 || this.y &gt; Constants.MAP_SIZE; } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Implementierung ist </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sehr kurz! </font><font style="vertical-align: inherit;">Wir haben </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nur die folgenden Erweiterungen </font><font style="vertical-align: inherit;">hinzugef√ºgt </font><font style="vertical-align: inherit;">:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden eines </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shortid-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pakets </font><font style="vertical-align: inherit;">zum zuf√§lligen Generieren eines </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projektils.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hinzuf√ºgen eines Feldes, </font></font><code>parentID</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">damit Sie den Spieler verfolgen k√∂nnen, der dieses Projektil erstellt hat.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hinzuf√ºgen eines R√ºckgabewerts zu </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, der gleich ist, </font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wenn sich das Projektil au√üerhalb der Arena befindet (denken Sie daran, wir haben im letzten Abschnitt dar√ºber gesprochen?).</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fahren wir fort mit </font></font><code>Player</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> player.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ObjectClass = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./object'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Bullet = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./bullet'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(id, username, x, y) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(id, x, y, <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * <span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI, Constants.PLAYER_SPEED); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.username = username; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.hp = Constants.PLAYER_MAX_HP; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fireCooldown = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.score = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// Returns a newly created bullet, or null. update(dt) { super.update(dt); // Update score this.score += dt * Constants.SCORE_PER_SECOND; // Make sure the player stays in bounds this.x = Math.max(0, Math.min(Constants.MAP_SIZE, this.x)); this.y = Math.max(0, Math.min(Constants.MAP_SIZE, this.y)); // Fire a bullet, if needed this.fireCooldown -= dt; if (this.fireCooldown &lt;= 0) { this.fireCooldown += Constants.PLAYER_FIRE_COOLDOWN; return new Bullet(this.id, this.x, this.y, this.direction); } return null; } takeBulletDamage() { this.hp -= Constants.BULLET_DAMAGE; } onDealtDamage() { this.score += Constants.SCORE_BULLET_HIT; } serializeForUpdate() { return { ...(super.serializeForUpdate()), direction: this.direction, hp: this.hp, }; } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spieler sind komplexer als Muscheln, daher sollten in dieser Klasse ein paar Felder mehr gespeichert werden. Seine Methode </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leistet viel Arbeit, insbesondere gibt sie die neu erstellte Shell zur√ºck, wenn sie nicht √ºbrig bleibt </font></font><code>fireCooldown</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(denken Sie daran, wir haben im vorherigen Abschnitt dar√ºber gesprochen?). Er erweitert auch die Methode </font></font><code>serializeForUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, da wir zus√§tzliche Felder f√ºr den Spieler in das Spielupdate aufnehmen m√ºssen. </font></font><br><br> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine Basisklasse </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ist ein wichtiger Schritt, um die Wiederholbarkeit von Code zu vermeiden</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ohne eine Klasse sollte beispielsweise </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jedes Spielobjekt dieselbe Implementierung haben </font></font><code>distanceTo()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, und die Synchronisierung durch Kopieren und Einf√ºgen all dieser Implementierungen in mehreren Dateien w√§re ein Albtraum. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dies ist besonders wichtig f√ºr gro√üe Projekte,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wenn die Anzahl der Erweiterungsklassen </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zunimmt.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4. Konflikterkennung </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir m√ºssen nur noch erkennen, wann die Granaten die Spieler treffen! </font><font style="vertical-align: inherit;">Erinnern Sie sich an diesen Code aus einer Methode </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in einer Klasse </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> applyCollisions = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collisions'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... update() { // ... // Apply collisions, give players score for hitting bullets const destroyedBullets = applyCollisions( Object.values(this.players), this.bullets, ); destroyedBullets.forEach(b =&gt; { if (this.players[b.parentID]) { this.players[b.parentID].onDealtDamage(); } }); this.bullets = this.bullets.filter( bullet =&gt; !destroyedBullets.includes(bullet), ); // ... } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir m√ºssen eine Methode implementieren </font></font><code>applyCollisions()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, die alle Muscheln zur√ºckgibt, die die Spieler getroffen haben. </font><font style="vertical-align: inherit;">Zum Gl√ºck ist das nicht so schwer zu machen, weil</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Alle kollidierenden Objekte sind Kreise, und dies ist die einfachste Abbildung zur Implementierung der Kollisionserkennung. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben bereits eine Methode </font></font><code>distanceTo()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, die wir im vorherigen Abschnitt der Klasse implementiert haben </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> So sieht unsere Implementierung der Kollisionserkennung aus: </font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> collisions.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Returns an array of bullets to be destroyed. function applyCollisions(players, bullets) { const destroyedBullets = []; for (let i = 0; i &lt; bullets.length; i++) { // Look for a player (who didn't create the bullet) to collide each bullet with. // As soon as we find one, break out of the loop to prevent double counting a bullet. for (let j = 0; j &lt; players.length; j++) { const bullet = bullets[i]; const player = players[j]; if ( bullet.parentID !== player.id &amp;&amp; player.distanceTo(bullet) &lt;= Constants.PLAYER_RADIUS + Constants.BULLET_RADIUS ) { destroyedBullets.push(bullet); player.takeBulletDamage(); break; } } } return destroyedBullets; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diese einfache Kollisionserkennung basiert auf der Tatsache, dass </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zwei Kreise kollidieren, wenn der Abstand zwischen ihren Zentren kleiner als die Summe ihrer Radien ist</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Hier ist der Fall, wenn der Abstand zwischen den Mittelpunkten zweier Kreise genau der Summe ihrer Radien entspricht:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/63f/e73/2c8/63fe732c87ed1872522787e3cc4d5ab2.svg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hier m√ºssen Sie einige Aspekte sorgf√§ltig ber√ºcksichtigen: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Projektil sollte nicht in den Spieler fallen, der es erstellt hat. </font><font style="vertical-align: inherit;">Dies kann durch Vergleich </font></font><code>bullet.parentID</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit erreicht werden </font></font><code>player.id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Projektil sollte im Extremfall einer gleichzeitigen Kollision mit mehreren Spielern nur einmal treffen. </font><font style="vertical-align: inherit;">Wir werden dieses Problem mit Hilfe des Bedieners l√∂sen </font></font><code>break</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Sobald ein Spieler gefunden wird, der auf ein Projektil gesto√üen ist, stoppen wir die Suche und fahren mit dem n√§chsten Projektil fort.</font></font></li></ul><br><h2>  Das Ende </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das ist alles! </font><font style="vertical-align: inherit;">Wir haben alles behandelt, was Sie wissen m√ºssen, um ein .io-Webspiel zu erstellen. </font><font style="vertical-align: inherit;">Was weiter? </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstelle dein eigenes .io-Spiel! </font></font></strong> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der gesamte Beispielcode ist Open Source und wird auf </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github ver√∂ffentlicht</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de450574/">https://habr.com/ru/post/de450574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de450556/index.html">Ventilindex - √úberpr√ºfung des neuen VR-Sets</a></li>
<li><a href="../de450564/index.html">Glitzer und Armut: Wie die digitale Revolution Musiker √§rmer machte</a></li>
<li><a href="../de450566/index.html">OutOfMemory und die Verwendung von Vektorbildern in Android Studio</a></li>
<li><a href="../de450568/index.html">Jedes Gift hat sein eigenes Gegenmittel. Wie man spart oder zumindest versucht (upd: √ºber Gegenmittel gegen h√§usliche Vergiftungen)</a></li>
<li><a href="../de450572/index.html">Samba DC als zweiter Controller in der AD-Dom√§ne von Windows 2012R2 und Roaming-Ordnern f√ºr Clients unter Windows und Linux</a></li>
<li><a href="../de450576/index.html">Neue Regeln f√ºr die Anonymit√§t von Messenger</a></li>
<li><a href="../de450578/index.html">Was ist in der Luft zu h√∂ren? Wir empfangen und decodieren die interessantesten Signale. Teil 2, UKW</a></li>
<li><a href="../de450582/index.html">PIM-Prinzipien</a></li>
<li><a href="../de450586/index.html">Fish Redux - Neue Redux-Bibliothek f√ºr Flattern</a></li>
<li><a href="../de450592/index.html">In Deutschland k√∂nnen die Kosten f√ºr die Fahrt mit einem Elektroauto h√∂her sein als mit einem Dieselauto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>