<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÜüèª üå± üî• D√©lais d'√©claircissement (crypto-monnaies, forex, √©changes) ü¶ó üçì üç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a quelque temps, j'ai √©t√© charg√© d'√©crire une proc√©dure qui effectue un √©claircissement des cotations du march√© Forex (plus pr√©cis√©ment, des donn...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©lais d'√©claircissement (crypto-monnaies, forex, √©changes)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418757/">  Il y a quelque temps, j'ai √©t√© charg√© d'√©crire une proc√©dure qui effectue un √©claircissement des cotations du march√© Forex (plus pr√©cis√©ment, des donn√©es de calendrier). <br><br>  L'√©nonc√© du probl√®me: les donn√©es sont entr√©es √† un intervalle de 1 seconde dans ce format: <br><br><ul><li>  Nom de l'instrument (code paire USDEUR, etc.), </li><li>  Date et heure au format Unix, </li><li>  Valeur ouverte (prix de la premi√®re transaction dans l'intervalle), </li><li>  Valeur √©lev√©e (prix maximum), </li><li>  Valeur faible </li><li>  Valeur de cl√¥ture (prix de la derni√®re offre), </li><li> Volume (volume ou volume de transaction). </li></ul><br>  Il est n√©cessaire d'assurer le recalcul et la synchronisation des donn√©es dans les tableaux: 5 sec, 15 sec, 1 min, 5 min, 15 min, etc. <br><br>  Le format de stockage de donn√©es d√©crit est appel√© OHLC ou OHLCV (Open, High, Low, Close, Volume).  Il est souvent utilis√©, vous pouvez imm√©diatement y construire un tableau de "bougies japonaises". <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/by/ws/8u/byws8uaklvxydw8d2wqkqhpb1ni.png" alt="image"></div><br>  Sous la coupe, j'ai d√©crit toutes les options que je pouvais trouver, comment √©claircir (agrandir) les donn√©es re√ßues, pour l'analyse, par exemple, le saut hivernal du prix du bitcoin, et selon les donn√©es re√ßues, vous construirez imm√©diatement un graphique "Bougies japonaises" (dans MS Excel, il y a aussi un tel graphique )  Dans l'image ci-dessus, ce graphique est construit pour la p√©riode de "1 mois", pour l'outil "bitstampUSD".  Le corps blanc de la bougie indique une augmentation de prix dans l'intervalle, noir - une diminution de prix, les m√®ches sup√©rieures et inf√©rieures indiquent les prix maximum et minimum qui ont √©t√© atteints dans l'intervalle.  Contexte - volume de transactions.  On voit clairement qu'en d√©cembre 2017, le prix √©tait proche de la barre des 20K. <br><br>  La solution sera donn√©e pour deux moteurs de base de donn√©es, pour Oracle et MS SQL, qui, d'une certaine mani√®re, permettront de les comparer pour cette t√¢che sp√©cifique (nous ne g√©n√©raliserons pas la comparaison √† d'autres t√¢ches). <br><a name="habracut"></a><br>  J'ai ensuite r√©solu le probl√®me de mani√®re triviale: calcul de l'amincissement correct dans une table temporaire et synchronisation avec la table cible - suppression des lignes qui existent dans la table cible mais n'existent pas dans la table temporaire et ajout de lignes qui existent dans la table temporaire mais n'existent pas dans la cible.  √Ä ce moment-l√†, le client a satisfait la solution et j'ai cl√¥tur√© la t√¢che. <br><br>  Mais maintenant, j'ai d√©cid√© de consid√©rer toutes les options, car la solution ci-dessus contient une fonctionnalit√© - il est difficile d'optimiser pour deux cas √† la fois: <br><br><ul><li>  lorsque la table cible est vide et que vous devez ajouter un grand nombre de donn√©es, </li><li>  et lorsque la table cible est grande et que vous devez ajouter des donn√©es en petits morceaux. </li></ul><br>  Cela est d√ª au fait que dans la proc√©dure, vous devez connecter la table cible et la table temporaire, et vous devez vous attacher √† la plus grande, et non l'inverse.  Dans les deux cas ci-dessus, le plus grand / le plus petit sont √©chang√©s.  L'optimiseur d√©cidera de l'ordre de connexion en fonction des statistiques, et les statistiques peuvent √™tre obsol√®tes et la d√©cision peut √™tre prise de mani√®re incorrecte, ce qui entra√Ænera une d√©gradation significative des performances. <br><br>  Dans cet article, je d√©crirai des m√©thodes d'√©claircissement ponctuelles qui peuvent √™tre utiles aux lecteurs pour l'analyse, par exemple, la hausse hivernale du prix du bitcoin. <br><br>  Les proc√©dures d'amincissement en ligne peuvent √™tre t√©l√©charg√©es depuis github sur le lien en bas de l'article. <br><br>  Au point ... Ma t√¢che consistait √† √©claircir le d√©lai de "1 seconde" au suivant, mais ici, j'envisage de r√©duire le niveau de transaction (dans la table source, les champs STOCK_NAME, UT, ID, APRICE, AVOLUME).  Parce que ces donn√©es sont √©mises par bitcoincharts.com. <br>  En fait, la d√©cimation du niveau de transaction au niveau de "1 sec" est effectu√©e par une telle commande (l'op√©rateur est facilement traduit en d√©cimation du niveau de "1 sec" aux niveaux sup√©rieurs): <br><br>  <b>Sur Oracle:</b> <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  La fonction <i>avg () keep (dense_rank de premier ordre par UT, ID)</i> fonctionne comme ceci: puisque la requ√™te est GROUP BY, chaque groupe est calcul√© ind√©pendamment des autres.  Dans chaque groupe, les cha√Ænes sont tri√©es par UT et ID, num√©rot√©es par <i>dense_rank</i> .  Puisque la premi√®re fonction suit, la ligne est s√©lectionn√©e o√π <i>dense_rank a</i> renvoy√© 1 (en d'autres termes, le minimum est s√©lectionn√©) - la premi√®re transaction dans l'intervalle est s√©lectionn√©e.  Pour cet UT, ID minimum, s'il y avait plusieurs lignes, la moyenne serait consid√©r√©e.  Mais dans notre cas, une ligne sera garantie (en raison de l'unicit√© de l'ID), de sorte que la valeur r√©sultante est imm√©diatement retourn√©e sous la forme AOPEN.  Il est facile de remarquer que la <i>premi√®re</i> fonction remplace deux fonctions agr√©g√©es. <br><br>  <b>Sur MS SQL</b> <br><br>  Il n'y a pas de <i>premi√®re / derni√®re</i> fonctions (il y a <i>first_value / last_value</i> , mais ce n'est pas √ßa).  Par cons√©quent, vous devez connecter la table √† elle-m√™me. <br><br>  Je ne donnerai pas la demande s√©par√©ment, mais vous pouvez la voir ci-dessous dans la proc√©dure <i>dbo.THINNING_HABR_CALC</i> .  Bien s√ªr, sans <i>premier / dernier,</i> ce n'est pas si √©l√©gant, mais cela fonctionnera. <br><br>  Comment ce probl√®me peut-il √™tre r√©solu par un seul op√©rateur?  (Ici, le terme "un op√©rateur" signifie non pas que l'op√©rateur sera un, mais qu'il n'y aura pas de cycles qui "tireront" les donn√©es sur une seule ligne.) <br><br>  Je vais √©num√©rer toutes les options que je connais pour r√©soudre ce probl√®me: <br><br><ol><li>  SIMP (produit simple, simple, cart√©sien), </li><li>  CALC (calcul, √©claircissement it√©ratif des niveaux sup√©rieurs), </li><li>  CHIN (fa√ßon porcelaine, demande volumineuse pour tous les niveaux √† la fois), </li><li>  UDAF (fonction d'agr√©gation d√©finie par l'utilisateur), </li><li>  PPTF (fonction de table en pipeline et parall√®le, solution proc√©durale, mais avec seulement deux curseurs, en fait, deux instructions SQL), </li><li>  MODE (mod√®le, phrase MOD√àLE), </li><li>  et IDEA (id√©al, une solution id√©ale qui peut ne pas fonctionner maintenant). </li></ol><br>  Pour l'avenir, je dirai que c'est le cas rare o√π la solution PPTF proc√©durale est la plus efficace sur Oracle. <br><br>  T√©l√©chargez les fichiers de transaction depuis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://api.bitcoincharts.com/v1/csv</a> <br>  Je recommande de choisir des fichiers kraken *.  Les fichiers localbtc * sont tr√®s bruyants - ils contiennent des lignes distrayantes avec des prix irr√©alistes.  Tous les kraken * contiennent environ 31 millions de transactions, je recommande d'exclure krakenEUR de l√†, puis la transaction devient 11 millions.  Il s'agit du volume le plus pratique pour les tests. <br><br>  Ex√©cutez un script dans Powershell pour g√©n√©rer des fichiers de contr√¥le pour SQLLDR pour Oracle et pour g√©n√©rer une demande d'importation pour MSSQL. <br><br><pre> <code class="hljs mel"> # MODIFY PARAMETERS THERE $OracleConnectString = <span class="hljs-string"><span class="hljs-string">"THINNING/aaa@P-ORA11/ORCL"</span></span> # For Oracle $PathToCSV = <span class="hljs-string"><span class="hljs-string">"Z:\10"</span></span> # without trailing slash $filenames = Get-ChildItem -name *.csv Remove-Item *.ctl -ErrorAction SilentlyContinue Remove-Item *.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> -ErrorAction SilentlyContinue Remove-Item *.bad -ErrorAction SilentlyContinue Remove-Item *.dsc -ErrorAction SilentlyContinue Remove-Item LoadData-Oracle.bat -ErrorAction SilentlyContinue Remove-Item LoadData-MSSQL.sql -ErrorAction SilentlyContinue ForEach ($FilenameExt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $Filenames) { Write-Host <span class="hljs-string"><span class="hljs-string">"Processing file: "</span></span>$FilenameExt $StockName = $FilenameExt.<span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>, $FilenameExt.Length<span class="hljs-number"><span class="hljs-number">-5</span></span>) $FilenameCtl = <span class="hljs-string"><span class="hljs-string">'.'</span></span>+$Stockname+<span class="hljs-string"><span class="hljs-string">'.ctl'</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"OPTIONS (DIRECT=TRUE, PARALLEL=FALSE, ROWS=1000000, SKIP_INDEX_MAINTENANCE=Y)"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"UNRECOVERABLE"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"LOAD DATA"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"INFILE '.$StockName.csv'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"BADFILE '.$StockName.bad'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"DISCARDFILE '.$StockName.dsc'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"INTO TABLE TRANSACTIONS_RAW"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"APPEND"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"FIELDS TERMINATED BY ','"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"(ID SEQUENCE (0), STOCK_NAME constant '$StockName', UT, APRICE, AVOLUME)"</span></span> Add-Content -Path LoadData-Oracle.bat -Value <span class="hljs-string"><span class="hljs-string">"sqlldr $OracleConnectString control=$FilenameCtl"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"insert into TRANSACTIONS_RAW (STOCK_NAME, UT, APRICE, AVOLUME)"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"select '$StockName' as STOCK_NAME, UT, APRICE, AVOLUME"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"from openrowset (bulk '$PathToCSV\$FilenameExt', formatfile = '$PathToCSV\format_mssql.bcp') as T1;"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">""</span></span> }</code> </pre><br>  Cr√©ons une table de transactions sur Oracle. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> TRANSACTIONS_RAW ( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME varchar2 (<span class="hljs-number"><span class="hljs-number">32</span></span>) , UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , APRICE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) pctfree <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parallel</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> nologging;</code> </pre><br>  Sur Oracle, ex√©cutez le <i>fichier LoadData-Oracle.bat</i> , apr√®s avoir pr√©alablement <i>fix√©</i> les param√®tres de connexion au d√©but du script Powershell. <br><br>  Je travaille dans une machine virtuelle.  Le t√©l√©chargement de tous les fichiers de transaction 11M dans 8 fichiers kraken * (j'ai ignor√© le fichier EUR) a pris environ 1 minute. <br><br>  Et cr√©ez des fonctions qui tronqueront les dates aux limites des intervalles: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> TRUNC_UT (p_UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, p_StripeTypeId <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">deterministic</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> p_StripeTypeId <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">10</span></span>) * <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">600</span></span>) * <span class="hljs-number"><span class="hljs-number">600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">3600</span></span>) * <span class="hljs-number"><span class="hljs-number">3600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / ( <span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>)) * ( <span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / (<span class="hljs-number"><span class="hljs-number">24</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>)) * (<span class="hljs-number"><span class="hljs-number">24</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc ((trunc (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'Month'</span></span>) - <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span>) * <span class="hljs-number"><span class="hljs-number">86400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc ((trunc (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'year'</span></span>) - <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span>) * <span class="hljs-number"><span class="hljs-number">86400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> UT2DATESTR (p_UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> varchar2 <span class="hljs-keyword"><span class="hljs-keyword">deterministic</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> to_char (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'YYYY.MM.DD HH24:MI:SS'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  Consid√©rez les options.  Tout d'abord, le code de toutes les options est donn√©, puis les scripts de lancement et de test.  Tout d'abord, la t√¢che est d√©crite pour Oracle, puis pour MS SQL <br><br><h4>  Option 1 - SIMP (Trivial) </h4><br>  L'ensemble des transactions est multipli√© par le produit cart√©sien par un ensemble de 10 lignes avec des nombres de 1 √† 10. Ceci est n√©cessaire pour obtenir 10 lignes √† partir d'une seule ligne de transaction avec des dates tronqu√©es aux fronti√®res de 10 intervalles. <br><br>  Apr√®s cela, les lignes sont regroup√©es par num√©ro d'intervalle et date tronqu√©e, et la demande ci-dessus est ex√©cut√©e. <br><br>  Cr√©er une vue: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_SIMP_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW , (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rownum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID);</code> </pre><br><h4>  Option 2 - CALC (calcul√© it√©rativement) </h4><br>  Dans cette option, nous r√©duisons de mani√®re it√©rative les transactions au niveau 1, du niveau 1 au niveau 2, etc. <br><br>  Cr√©ez une table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> QUOTES_CALC ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME varchar2 (<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) <span class="hljs-comment"><span class="hljs-comment">/*partition by list (STRIPE_ID) ( partition P01 values (1) , partition P02 values (2) , partition P03 values (3) , partition P04 values (4) , partition P05 values (5) , partition P06 values (6) , partition P07 values (7) , partition P08 values (8) , partition P09 values (9) , partition P10 values (10) )*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parallel</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> pctfree <span class="hljs-number"><span class="hljs-number">0</span></span> nologging;</code> </pre><br>  Vous pouvez cr√©er un index √† l'aide du champ STRIPE_ID, mais il a √©t√© exp√©rimentalement √©tabli qu'il est plus rentable pour 11 millions de transactions sans index.  Pour des quantit√©s plus importantes, la situation peut changer.  Ou vous pouvez partitionner la table en supprimant la mise en commentaire du bloc dans la requ√™te. <br><br>  Cr√©ez une proc√©dure: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> THINNING_HABR_CALC_T <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rollback</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">immediate</span></span> <span class="hljs-string"><span class="hljs-string">'truncate table QUOTES_CALC'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-comment"><span class="hljs-comment">--+ append into QUOTES_CALC select 1 as STRIPE_ID , STOCK_NAME , UT , avg (APRICE) keep (dense_rank first order by ID) , max (APRICE) , min (APRICE) , avg (APRICE) keep (dense_rank last order by ID) , sum (AVOLUME) , sum (APRICE * AVOLUME) , count (*) from TRANSACTIONS_RAW a group by STOCK_NAME, UT; commit; for i in 1..9 loop insert --+ append into QUOTES_CALC select --+ parallel(4) STRIPE_ID + 1 , STOCK_NAME , TRUNC_UT (UT, i + 1) , avg (AOPEN) keep (dense_rank first order by UT) , max (AHIGH) , min (ALOW) , avg (ACLOSE) keep (dense_rank last order by UT) , sum (AVOLUME) , sum (AAMOUNT) , sum (ACOUNT) from QUOTES_CALC a where STRIPE_ID = i group by STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, i + 1); commit; end loop; end; /</span></span></code> </pre><br>  Pour la sym√©trie, cr√©ez une VUE simple: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_CALC_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> QUOTES_CALC;</code> </pre><br><h4>  Option 3 - RCIP (code chinois) </h4><br>  La m√©thode diff√®re brutalit√© simple de l'approche, et est le rejet du principe de "Ne vous r√©p√©tez pas."  Dans ce cas, le rejet des cycles. <br><br>  L'option n'est fournie ici que pour √™tre compl√®te. <br><br>  Pour l'avenir, je dirai qu'en termes de performances sur cette t√¢che particuli√®re, il prend la deuxi√®me place. <br><br><div class="spoiler">  <b class="spoiler_title">Grande demande</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_CHIN_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T01 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT) , T02 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T01 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T03 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T02 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T04 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T03 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T05 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T04 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T06 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T05 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T07 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T06 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T08 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T07 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T09 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T08 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T10 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T09 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T01 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T02 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T03 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T04 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T05 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T06 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T07 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T08 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T09 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T10;</code> </pre><br></div></div><br><h4>  Option 4 - UDAF </h4><br>  L'option avec la fonction agr√©g√©e d√©finie par l'utilisateur ne sera pas donn√©e ici, mais elle peut √™tre consult√©e sur github. <br><br><h4>  Option 5 - PPTF (fonction de table en pipeline et parall√®le) </h4><br>  Cr√©ez une fonction (dans le package): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> THINNING_PPTF_P <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> TRANSACTION_RECORD_T <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-built_in"><span class="hljs-built_in">record</span></span> (STOCK_NAME varchar2(<span class="hljs-number"><span class="hljs-number">128</span></span>), UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, SEQ_NUM <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, APRICE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>); type CUR_RECORD_T is ref cursor return TRANSACTION_RECORD_T; type QUOTE_T is record (STRIPE_ID number, STOCK_NAME varchar2(128), UT number , AOPEN number, AHIGH number, ALOW number, ACLOSE number, AVOLUME number , AAMOUNT number, ACOUNT number); type QUOTE_LIST_T is table of QUOTE_T; function F (p_cursor CUR_RECORD_T) return QUOTE_LIST_T pipelined order p_cursor by (STOCK_NAME, UT, SEQ_NUM) parallel_enable (partition p_cursor by hash (STOCK_NAME)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; / <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> THINNING_PPTF_P <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> F (p_cursor CUR_RECORD_T) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QUOTE_LIST_T <span class="hljs-keyword"><span class="hljs-keyword">pipelined</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> p_cursor <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> (STOCK_NAME, UT, SEQ_NUM) <span class="hljs-keyword"><span class="hljs-keyword">parallel_enable</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> p_cursor <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">hash</span></span> (STOCK_NAME)) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> QuoteTail QUOTE_LIST_T := QUOTE_LIST_T() ; rec TRANSACTION_RECORD_T; rec_prev TRANSACTION_RECORD_T; type ut_T is table of number index by pls_integer; ut number; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> QuoteTail.extend(<span class="hljs-number"><span class="hljs-number">10</span></span>); loop fetch p_cursor into rec; exit when p_cursor%notfound; if rec_prev.STOCK_NAME = rec.STOCK_NAME then if (rec.STOCK_NAME = rec_prev.STOCK_NAME and rec.UT &lt; rec_prev.UT) or (rec.STOCK_NAME = rec_prev.STOCK_NAME and rec.UT = rec_prev.UT and rec.SEQ_NUM &lt; rec_prev.SEQ_NUM) then raise_application_error (-20010, 'Rowset must be ordered, ('||rec_prev.STOCK_NAME||','||rec_prev.UT||','||rec_prev.SEQ_NUM||') &gt; ('||rec.STOCK_NAME||','||rec.UT||','||rec.SEQ_NUM||')'); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.STOCK_NAME &lt;&gt; rec_prev.STOCK_NAME or rec_prev.STOCK_NAME is null then for j in 1 .. 10 loop if QuoteTail(j).UT is not null then pipe row (QuoteTail(j)); QuoteTail(j) := null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; for i in reverse 1..10 loop ut := TRUNC_UT (rec.UT, i); if QuoteTail(i).UT &lt;&gt; ut then for j in 1..i loop pipe row (QuoteTail(j)); QuoteTail(j) := null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if QuoteTail(i).UT is null then QuoteTail(i).STRIPE_ID := i; QuoteTail(i).STOCK_NAME := rec.STOCK_NAME; QuoteTail(i).UT := ut; QuoteTail(i).AOPEN := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.APRICE &lt; QuoteTail(i).ALOW or QuoteTail(i).ALOW is null then QuoteTail(i).ALOW := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.APRICE &gt; QuoteTail(i).AHIGH or QuoteTail(i).AHIGH is null then QuoteTail(i).AHIGH := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; QuoteTail(i).AVOLUME := nvl (QuoteTail(i).AVOLUME, 0) + rec.AVOLUME; QuoteTail(i).AAMOUNT := nvl (QuoteTail(i).AAMOUNT, 0) + rec.AVOLUME * rec.APRICE; QuoteTail(i).ACOUNT := nvl (QuoteTail(i).ACOUNT, 0) + 1; QuoteTail(i).ACLOSE := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; rec_prev := rec; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; for j in 1 .. 10 loop if QuoteTail(j).UT is not null then pipe row (QuoteTail(j)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; exception when no_data_needed then null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; /</code> </pre><br>  Cr√©er une vue: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_PPTF_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> (THINNING_PPTF_P.F (<span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, APRICE, AVOLUME <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW)));</code> </pre><br><h4>  Option 6 - MODE (clause mod√®le) </h4><br>  L'option calcule de mani√®re it√©rative la d√©cimation pour les 10 niveaux √† l'aide de la phrase de la clause <i>MODEL</i> avec la phrase <i>ITERATE</i> . <br><br>  L'option est √©galement peu pratique car elle est lente.  Dans mon environnement, 1000 transactions pour 8 instruments sont calcul√©es en 1 minute.  La plupart du temps est consacr√© au calcul de la phrase <i>MOD√àLE</i> . <br><br>  Ici, je donne cette option uniquement par souci d'exhaustivit√© et comme confirmation du fait que sur Oracle, presque tous les calculs arbitrairement complexes peuvent √™tre effectu√©s avec une seule requ√™te, sans utiliser PL / SQL. <br><br>  L'une des raisons de la faible performance de la phrase <i>MODEL</i> dans cette requ√™te est que la recherche √† droite est effectu√©e pour <i>chaque</i> r√®gle, que nous avons 6. Les deux premi√®res r√®gles sont calcul√©es assez rapidement, car il existe un adressage explicite direct, sans jokers.  Dans les quatre autres r√®gles, il y a le mot <i>any</i> - les calculs sont plus lents. <br><br>  La deuxi√®me difficult√© est que vous devez calculer le mod√®le de r√©f√©rence.  Il est n√©cessaire car la liste des dimensions doit √™tre connue <b>avant de</b> calculer la phrase <i>MODEL</i> , nous ne pouvons pas calculer de nouvelles dimensions √† l'int√©rieur de cette phrase.  Peut-√™tre que cela peut √™tre contourn√© √† l'aide de deux phrases MOD√àLE, mais je ne l'ai pas fait en raison des faibles performances d'un grand nombre de r√®gles. <br><br>  J'ajoute qu'il serait possible de ne pas calculer <i>UT_OPEN</i> et <i>UT_CLOSE</i> dans le mod√®le de r√©f√©rence, mais d'utiliser les m√™mes fonctions <i>avg () keep (dense_rank first / last order by)</i> directement dans la phrase <i>MODEL</i> .  Mais cela se serait produit encore plus lentement. <br>  En raison de limitations de performances, je n'inclurai pas cette option dans la proc√©dure de test. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-comment"><span class="hljs-comment">--       SOURCETRANS (STRIPE_ID, STOCK_NAME, PARENT_UT, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) as (select 1, STOCK_NAME, TRUNC_UT (UT, 2), UT , avg (APRICE) keep (dense_rank first order by ID) , max (APRICE) , min (APRICE) , avg (APRICE) keep (dense_rank last order by ID) , sum (AVOLUME) , sum (AVOLUME * APRICE) , count (*) from TRANSACTIONS_RAW where ID &lt;= 1000 --       group by STOCK_NAME, UT) --   PARENT_UT, UT  2...10    UT_OPEN, UT_CLOSE --    , REFMOD (STRIPE_ID, STOCK_NAME, PARENT_UT, UT, UT_OPEN, UT_CLOSE) as (select b.STRIPE_ID , a.STOCK_NAME , TRUNC_UT (UT, b.STRIPE_ID + 1) , TRUNC_UT (UT, b.STRIPE_ID) , min (TRUNC_UT (UT, b.STRIPE_ID - 1)) , max (TRUNC_UT (UT, b.STRIPE_ID - 1)) from SOURCETRANS a , (select rownum + 1 as STRIPE_ID from dual connect by level &lt;= 9) b group by b.STRIPE_ID , a.STOCK_NAME , TRUNC_UT (UT, b.STRIPE_ID + 1) , TRUNC_UT (UT, b.STRIPE_ID)) --        , MAINTAB as ( select STRIPE_ID, STOCK_NAME, PARENT_UT, UT, AOPEN , AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT, null, null from SOURCETRANS union all select STRIPE_ID, STOCK_NAME, PARENT_UT, UT, null , null, null, null, null, null, null, UT_OPEN, UT_CLOSE from REFMOD) select STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT from MAINTAB model return all rows --      2...10 reference RM on (select * from REFMOD) dimension by (STRIPE_ID, STOCK_NAME, UT) measures (UT_OPEN, UT_CLOSE) main MM partition by (STOCK_NAME) dimension by (STRIPE_ID, PARENT_UT, UT) measures (AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) rules iterate (9) ( AOPEN [iteration_number + 2, any, any] = AOPEN [cv (STRIPE_ID) - 1, cv (UT) , rm.UT_OPEN [cv (STRIPE_ID), cv (STOCK_NAME), cv (UT)]] , ACLOSE [iteration_number + 2, any, any] = ACLOSE [cv (STRIPE_ID) - 1, cv (UT) , rm.UT_CLOSE[cv (STRIPE_ID), cv (STOCK_NAME), cv (UT)]] , AHIGH [iteration_number + 2, any, any] = max (AHIGH)[cv (STRIPE_ID) - 1, cv (UT), any] , ALOW [iteration_number + 2, any, any] = min (ALOW)[cv (STRIPE_ID) - 1, cv (UT), any] , AVOLUME [iteration_number + 2, any, any] = sum (AVOLUME)[cv (STRIPE_ID) - 1, cv (UT), any] , AAMOUNT [iteration_number + 2, any, any] = sum (AAMOUNT)[cv (STRIPE_ID) - 1, cv (UT), any] , ACOUNT [iteration_number + 2, any, any] = sum (ACOUNT)[cv (STRIPE_ID) - 1, cv (UT), any] ) order by 1, 2, 3, 4;</span></span></code> </pre><br><h4>  Option 6 - IDEA (id√©al, id√©al, mais inop√©rant) </h4><br>  La demande d√©crite ci-dessous serait potentiellement la plus efficace et consommerait un montant de ressources √©gal au minimum th√©orique. <br><br>  Mais ni Oracle ni MS SQL ne vous permettent d'√©crire une requ√™te sous cette forme.  Je crois que cela est dict√© par la norme. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> QUOTES_S1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-comment"><span class="hljs-comment">-- where rownum &lt;= 100 group by STOCK_NAME, TRUNC_UT (UT, 1)) , T1 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) as (select 1, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT from QUOTES_S1 union all select STRIPE_ID + 1 , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + 1) , avg (AOPEN) keep (dense_rank first order by UT) , max (AHIGH) , min (ALOW) , avg (ACLOSE) keep (dense_rank last order by UT) , sum (AVOLUME) , sum (AAMOUNT) , sum (ACOUNT) from T1 where STRIPE_ID &lt; 10 group by STRIPE_ID + 1, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + 1) ) select * from T1</span></span></code> </pre><br>  Cette requ√™te correspond √† la partie suivante de la documentation Oracle: <br><br>  <i>Si une subquery_factoring_clause fait r√©f√©rence √† son propre query_name dans la sous-requ√™te qui la d√©finit, alors la subquery_factoring_clause est dite r√©cursive.</i>  <i>Une subquery_factoring_clause r√©cursive doit contenir deux blocs de requ√™te: le premier est le membre d'ancrage et le second est le membre r√©cursif.</i>  <i>Le membre d'ancrage doit appara√Ætre avant le membre r√©cursif et il ne peut pas faire r√©f√©rence √† query_name.</i>  <i>Le membre d'ancrage peut √™tre compos√© d'un ou plusieurs blocs de requ√™te combin√©s par les op√©rateurs d'ensemble: UNION ALL, UNION, INTERSECT ou MINUS.</i>  <i>Le membre r√©cursif doit suivre le membre d'ancrage et doit faire r√©f√©rence une seule fois √† query_name.</i>  <i>Vous devez combiner le membre r√©cursif avec le membre d'ancrage √† l'aide de l'op√©rateur d'ensemble UNION ALL.</i> <br><br>  Mais cela contredit le paragraphe suivant de la documentation: <br><br>  <i>Le membre r√©cursif ne peut contenir aucun des √©l√©ments suivants:</i> <i><br></i>  <i>Le mot cl√© DISTINCT ou une clause GROUP BY</i> <i><br></i>  <i>Une fonction d'agr√©gation.</i>  <i>Cependant, les fonctions analytiques sont autoris√©es dans la liste de s√©lection.</i> <br><br>  Ainsi, dans le membre r√©cursif, les agr√©gats et le regroupement ne sont pas autoris√©s. <br><br><h3>  Test </h3><br><br>  Faisons-le d'abord pour <b>Oracle</b> . <br><br>  Effectuez la proc√©dure de calcul de la m√©thode CALC et enregistrez l'heure de son ex√©cution: <br><br><pre> <code class="sql hljs">exec THINNING_HABR_CALC_T</code> </pre> <br>  Les r√©sultats du calcul pour les quatre m√©thodes sont dans quatre vues: <br><br><ul><li>  THINNING_HABR_SIMP_V (effectuera le calcul, provoquant un SELECT complexe, donc cela prendra beaucoup de temps), </li><li>  THINNING_HABR_CALC_V (affichera les donn√©es de la table QUOTES_CALC, donc il s'ex√©cutera rapidement) </li><li>  THINNING_HABR_CHIN_V (effectuera √©galement le calcul, provoquant un SELECT complexe, cela prendra donc beaucoup de temps), </li><li>  THINNING_HABR_PPTF_V (ex√©cutera la fonction THINNING_HABR_PPTF). </li></ul><br>  Le d√©lai de livraison pour toutes les m√©thodes a d√©j√† √©t√© mesur√© par moi et est donn√© dans le tableau en fin d'article. <br><br>  Pour le reste de VIEW, nous ex√©cutons les requ√™tes et √©crivons le temps d'ex√©cution: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_XXXX_V</code> </pre><br>  o√π XXXX est SIMP, CHIN, PPTF. <br><br>  Ces VUES calculent le r√©sum√© du recrutement.  Pour calculer le r√©sum√©, vous devez r√©cup√©rer toutes les lignes, et en utilisant le r√©sum√©, vous pouvez comparer les ensembles les uns avec les autres. <br><br>  Vous pouvez √©galement comparer des ensembles √† l'aide du package dbms_sqlhash, mais cela est beaucoup plus lent car vous devez trier l'ensemble d'origine et le calcul du hachage n'est pas rapide. <br>  Toujours en 12c, il y a un package DBMS_COMPARISON. <br><br>  Vous pouvez v√©rifier l'exactitude de tous les algorithmes en m√™me temps.  Nous consid√©rons les r√©sum√©s comme une telle demande (avec 11M d'entr√©es dans une machine virtuelle, cela sera relativement long, environ 15 minutes): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'SIMP'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALG_NAME, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_SIMP_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CALC'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CALC_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CHIN'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CHIN_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'PPTF'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_PPTF_V a) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ALG_NAME , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> ALG_NAME;</code> </pre><br>  Nous voyons que les r√©sum√©s sont les m√™mes, donc tous les algorithmes ont donn√© les m√™mes r√©sultats. <br><br>  Nous allons maintenant reproduire tout de m√™me en <b>MS SQL</b> .  J'ai test√© sur la version 2016. <br><br>  Cr√©ez d'abord la base de donn√©es DBTEST, puis cr√©ez-y une table de transactions: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> TRANSACTIONS_RAW ( STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span> (<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">identity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> );</code> </pre><br>  T√©l√©chargez les donn√©es t√©l√©charg√©es. <br><br>  Dans MSSQL, cr√©ez le fichier format_mssql.bcp: <br><br><pre> <code class="sql hljs">12.0 3 1 SQLCHAR 0 0 "," 3 UT "" 2 SQLCHAR 0 0 "," 4 APRICE "" 3 SQLCHAR 0 0 "\n" 5 AVOLUME ""</code> </pre><br>  Et ex√©cutez le script LoadData-MSSQL.sql dans SSMS (ce script a √©t√© g√©n√©r√© par le seul script powershell fourni dans la section de cet article pour Oracle). <br><br>  Cr√©ons deux fonctions: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> TRUNC_UT (@p_UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>, @p_StripeTypeId <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> @p_StripeTypeId <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">600</span></span> * <span class="hljs-number"><span class="hljs-number">600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">3600</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">14400</span></span> * <span class="hljs-number"><span class="hljs-number">14400</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span> * <span class="hljs-number"><span class="hljs-number">86400</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime), <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(m, <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (m, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime))), <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime), <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(yy, <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (yy, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime))), <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> UT2DATESTR (@p_UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(s, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nous proc√©dons √† la mise en ≈ìuvre des options: </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Option 1 - SIMP </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ex√©cuter: </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.THINNING_HABR_SIMP_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> STRIPE_ID &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) , T2 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID , STOCK_NAME , dbo.TRUNC_UT (UT, STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (<span class="hljs-number"><span class="hljs-number">1000000</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_UT , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (<span class="hljs-number"><span class="hljs-number">1000000</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW, T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, dbo.TRUNC_UT (UT, STRIPE_ID)) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.STRIPE_ID, t.STOCK_NAME, t.UT, t_op.APRICE <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN, t.AHIGH , t.ALOW, t_cl.APRICE <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T2 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT / <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_op.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT % <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_op.ID) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT / <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_cl.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT % <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_cl.ID);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">premi√®res / derni√®res</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fonctions manquantes sont </font><font style="vertical-align: inherit;">impl√©ment√©es par l'auto-jointure de table double.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Option 2 - CALC </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cr√©ez une table, une proc√©dure et une vue: </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> dbo.QUOTES_CALC ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ); go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> dbo.THINNING_HABR_CALC <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">truncate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> QUOTES_CALC; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @StripeId <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME , UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_ID , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_ID , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT) <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, t.STOCK_NAME, t.UT, t_op.APRICE, t.AHIGH, t.ALOW, t_cl.APRICE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.UT = t_op.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_ID = t_op.ID) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.UT = t_cl.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_ID = t_cl.ID); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @StripeId = <span class="hljs-number"><span class="hljs-number">1</span></span>; while (@StripeId &lt;= 9) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME , dbo.TRUNC_UT (UT, @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_UT , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> QUOTES_CALC <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> STRIPE_ID = @StripeId <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, dbo.TRUNC_UT (UT, @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>, t.STOCK_NAME, t.UT, t_op.AOPEN, t.AHIGH, t.ALOW, t_cl.ACLOSE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> QUOTES_CALC t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT = t_op.UT) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> QUOTES_CALC t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT = t_cl.UT) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> t_op.STRIPE_ID = @StripeId <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t_cl.STRIPE_ID = @StripeId; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @StripeId = @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.THINNING_HABR_CALC_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.QUOTES_CALC; go</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Je n'ai pas impl√©ment√© les options 3 (CHIN) et 4 (UDAF) sur MS SQL. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Option 5 - PPTF </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ez une fonction de table et une vue. </font><font style="vertical-align: inherit;">Cette fonction est juste une fonction de table, pas une fonction de table en pipeline parall√®le, juste l'option a conserv√© son nom historique d'Oracle:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> dbo.THINNING_HABR_PPTF () <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> @rettab <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @i tinyint; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @tut <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @QuoteTail <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> clustered , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> fast_forward <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, APRICE, AVOLUME <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>; <span class="hljs-comment"><span class="hljs-comment">-- THIS ORDERING (STOCK_NAME, UT, ID) IS MANDATORY open c; fetch next from c into @trans_STOCK_NAME, @trans_UT, @trans_ID, @trans_APRICE, @trans_AVOLUME; while @@fetch_status = 0 begin if @trans_STOCK_NAME &lt;&gt; @trans_prev_STOCK_NAME or @trans_prev_STOCK_NAME is null begin insert into @rettab select * from @QuoteTail; delete @QuoteTail; end; set @i = 10; while @i &gt;= 1 begin set @tut = dbo.TRUNC_UT (@trans_UT, @i); if @tut &lt;&gt; (select UT from @QuoteTail where STRIPE_ID = @i) begin insert into @rettab select * from @QuoteTail where STRIPE_ID &lt;= @i; delete @QuoteTail where STRIPE_ID &lt;= @i; end; if (select count (*) from @QuoteTail where STRIPE_ID = @i) = 0 begin insert into @QuoteTail (STRIPE_ID, STOCK_NAME, UT, AOPEN, AVOLUME, AAMOUNT, ACOUNT) values (@i, @trans_STOCK_NAME, @tut, @trans_APRICE, 0, 0, 0); end; update @QuoteTail set AHIGH = case when AHIGH &lt; @trans_APRICE or AHIGH is null then @trans_APRICE else AHIGH end , ALOW = case when ALOW &gt; @trans_APRICE or ALOW is null then @trans_APRICE else ALOW end , ACLOSE = @trans_APRICE, AVOLUME = AVOLUME + @trans_AVOLUME , AAMOUNT = AAMOUNT + @trans_APRICE * @trans_AVOLUME , ACOUNT = ACOUNT + 1 where STRIPE_ID = @i; set @i = @i - 1; end; set @trans_prev_STOCK_NAME = @trans_STOCK_NAME; set @trans_prev_UT = @trans_UT; set @trans_prev_ID = @trans_ID; set @trans_prev_APRICE = @trans_APRICE; set @trans_prev_AVOLUME = @trans_AVOLUME; fetch next from c into @trans_STOCK_NAME, @trans_UT, @trans_ID, @trans_APRICE, @trans_AVOLUME; end; close c; deallocate c; insert into @rettab select * from @QuoteTail; return; end go create or alter view dbo.THINNING_HABR_PPTF_V as select * from dbo.THINNING_HABR_PPTF ();</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Calculons la table QUOTES_CALC pour la m√©thode CALC et √©crivons le temps d'ex√©cution: </font></font><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> exec dbo.THINNING_HABR_CALC</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Les r√©sultats du calcul pour les trois m√©thodes sont dans trois vues: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> THINNING_HABR_SIMP_V (effectuera le calcul, provoquant un SELECT complexe, donc cela prendra beaucoup de temps), </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> THINNING_HABR_CALC_V (affichera les donn√©es de la table QUOTES_CALC, donc il s'ex√©cutera rapidement) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> THINNING_HABR_PPTF_V (ex√©cutera la fonction THINNING_HABR_PPTF). </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pour deux VUES, nous ex√©cutons les requ√™tes et √©crivons le temps d'ex√©cution: </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_XXXX_V</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o√π XXXX est SIMP, PPTF. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez maintenant comparer les r√©sultats des calculs pour les trois m√©thodes pour MS SQL. </font><font style="vertical-align: inherit;">Cela peut √™tre fait en une seule demande. </font><font style="vertical-align: inherit;">Ex√©cuter:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'SIMP'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALG_NAME, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_SIMP_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CALC'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CALC_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'PPTF'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_PPTF_V a) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ALG_NAME , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (STRIPE_ID <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> ALG_NAME;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si trois lignes co√Øncident dans tous les champs, le r√©sultat du calcul utilisant les trois m√©thodes est identique. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je vous conseille fortement d'utiliser une petite s√©lection au stade des tests, car les performances de cette t√¢che dans MS SQL sont faibles. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous ne disposez que du moteur MS SQL et souhaitez calculer une plus grande quantit√© de donn√©es, vous pouvez essayer la m√©thode d'optimisation suivante: vous pouvez cr√©er des index:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> TRANSACTIONS_RAW_I1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> TRANSACTIONS_RAW (STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> QUOTES_CALC_I1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Les r√©sultats de la mesure des performances sur ma machine virtuelle sont les suivants: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ss/4s/7x/ss4s7xhwteedzj1qgsjmb20hvvw.png" alt="image"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les scripts peuvent √™tre t√©l√©charg√©s √† partir de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Oracle, le sch√©ma THINNING - les scripts de cet article, le sch√©ma THINNING_LIVE - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le t√©l√©chargement en ligne de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> donn√©es √† partir de bitcoincharts.com et l' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©claircissement en ligne</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (mais ce site </font><font style="vertical-align: inherit;">envoie </font><font style="vertical-align: inherit;">uniquement </font><font style="vertical-align: inherit;">des </font><font style="vertical-align: inherit;">donn√©es pour les 5 derniers jours en mode en ligne), et le script pour MS SQL √©galement sur cet article. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion:</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cette t√¢che est r√©solue plus rapidement sur Oracle que sur MS SQL. Avec l'augmentation du nombre de transactions, l'√©cart devient plus important. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sur Oracle, PPTF √©tait la meilleure option. Ici, l'approche proc√©durale s'est av√©r√©e plus rentable, cela se produit rarement. D'autres m√©thodes ont √©galement montr√© un r√©sultat acceptable - j'ai m√™me test√© le volume de 367 millions de transactions dans une machine virtuelle (m√©thode PPTF calcul√©e en √©claircissant en une heure et demie).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sur MS SQL, la m√©thode de calcul it√©rative (CALC) s'est av√©r√©e √™tre la plus productive. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi la m√©thode PPTF sur Oracle s'est-elle r√©v√©l√©e √™tre le leader? </font><font style="vertical-align: inherit;">En raison de la concurrence et de l'architecture, une fonction cr√©√©e en tant que fonction de table en pipeline parall√®le est int√©gr√©e au milieu du plan de requ√™te:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/za/ss/nl/zassnleqabvacrdkxnumjhd5mky.png" alt="image"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418757/">https://habr.com/ru/post/fr418757/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418743/index.html">Premi√®re place au ML Boot Camp VI</a></li>
<li><a href="../fr418747/index.html">R√©solution de probl√®mes: comment r√©soudre efficacement les probl√®mes en √©quipe?</a></li>
<li><a href="../fr418751/index.html">Dex impudent espion chinois</a></li>
<li><a href="../fr418753/index.html">vSAN dans le cloud VMware</a></li>
<li><a href="../fr418755/index.html">Comment le commerce √©lectronique survit aux promotions √† grande √©chelle. Se pr√©parer aux pics de charge sur le Web [Partie 1]</a></li>
<li><a href="../fr418759/index.html">Combien co√ªte un √©tudiant pour √©mettre une puce?</a></li>
<li><a href="../fr418761/index.html">Le livre ¬´Pure Python. Les subtilit√©s de la programmation pour les pros ¬ª</a></li>
<li><a href="../fr418763/index.html">Moyen / senior: comment sortir du marais?</a></li>
<li><a href="../fr418765/index.html">Les conseils Dadata aident √† remplir tout formulaire de saisie. Maintenant gu√©ris</a></li>
<li><a href="../fr418767/index.html">L'√©norme h√©ritage de jeu d'Adobe Flash et mes tentatives pour le sauver</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>