<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ˜‡ ğŸ˜² ğŸ¤¾ğŸ¾ æ€§èƒ½ä¸ä½³çš„åœ°é›·æ­£åœ¨ç­‰å¾… ğŸ» â£ï¸ ğŸš…</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è®¨è®ºåŸ‹è®¾åœ¨åœ°é›·ä¸‹çš„åœ°é›·ï¼Œä»¥åŠåœ°é›·çš„æ¢æµ‹ï¼ˆæœ€å¥½æ˜¯åœ¨çˆ†ç‚¸å‰ï¼‰å’Œå¤„ç½®ã€‚ 
 å›¾ç‰‡å¼•èµ·å…³æ³¨ 


 ä»€ä¹ˆæ˜¯åœ°é›·ï¼Ÿ 


 è®©æˆ‘ä»¬ä»ä»»ä½•çŸ¥è¯†çš„æºå¤´å¼€å§‹-å…·æœ‰å®šä¹‰ã€‚ å¤äººè¯´ï¼Œæ­£ç¡®å‘½åæ„å‘³ç€æ­£ç¡®ç†è§£ã€‚ æˆ‘è®¤ä¸ºæœ€å¥½é€šè¿‡å¯¹æ¯”ä¸€ä¸ªæ˜æ˜¾çš„é”™è¯¯æ¥è¡¨è¿°è¡¨ç°è‰¯å¥½çš„åœ°é›·ï¼Œä¾‹å¦‚ï¼š 


String concat(S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æ€§èƒ½ä¸ä½³çš„åœ°é›·æ­£åœ¨ç­‰å¾…</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443206/"><p> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è®¨è®ºåŸ‹è®¾åœ¨åœ°é›·ä¸‹çš„åœ°é›·ï¼Œä»¥åŠåœ°é›·çš„æ¢æµ‹ï¼ˆæœ€å¥½æ˜¯åœ¨çˆ†ç‚¸å‰ï¼‰å’Œå¤„ç½®ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">å›¾ç‰‡å¼•èµ·å…³æ³¨</b> <div class="spoiler_text"><p><img src="https://ic.pics.livejournal.com/ivagkin/26880913/58954/58954_original.jpg" alt="å›¾ç‰‡"></p></div></div><a name="habracut"></a><br><h4 id="chto-takoe-mina"> ä»€ä¹ˆæ˜¯åœ°é›·ï¼Ÿ </h4><br><p> è®©æˆ‘ä»¬ä»ä»»ä½•çŸ¥è¯†çš„æºå¤´å¼€å§‹-å…·æœ‰å®šä¹‰ã€‚ å¤äººè¯´ï¼Œæ­£ç¡®å‘½åæ„å‘³ç€æ­£ç¡®ç†è§£ã€‚ æˆ‘è®¤ä¸ºæœ€å¥½é€šè¿‡å¯¹æ¯”ä¸€ä¸ªæ˜æ˜¾çš„é”™è¯¯æ¥è¡¨è¿°è¡¨ç°è‰¯å¥½çš„åœ°é›·ï¼Œä¾‹å¦‚ï¼š </p><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">concat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String... strings)</span></span></span><span class="hljs-function"> </span></span>{ String result = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String str : strings) { result += str; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p> å³ä½¿æ˜¯æ–°æ‰‹å¼€å‘äººå‘˜ä¹ŸçŸ¥é“è¿™äº›è¡Œæ˜¯ä¸å¯å˜çš„ï¼Œå¹¶ä¸”å°†å®ƒä»¬ç²˜åˆæˆä¸€ä¸ªå¾ªç¯å¹¶ä¸æ„å‘³ç€å°†æ•°æ®æ·»åŠ åˆ°ç°æœ‰è¡Œçš„å°¾éƒ¨ï¼Œè€Œæ˜¯æ¯æ¬¡é€šè¿‡éƒ½ä¼šåˆ›å»ºä¸€æ¡<strong>æ–°</strong>è¡Œã€‚ å¦‚æœæ‚¨å¼„é”™äº†ï¼Œè¯·ä¸è¦æ°”--â€œæƒ³æ³•â€ä¼šç«‹å³è­¦å‘Šæ‚¨å±é™©ï¼Œè€Œâ€œå£°çº³â€è‚¯å®šä¼šæ·¹æ²¡æ‚¨çš„ç»„ä»¶ã€‚ </p><br><p> ä½†æ˜¯æ­¤<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»£ç </a>å°†å¸å¼•è¾ƒå°‘çš„å…³æ³¨ï¼Œå¹¶ä¸”Ideaï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">2018.2ä¹‹å‰çš„ç‰ˆæœ¬</a> ï¼‰å°†ä¿æŒæ²‰é»˜ï¼š </p><br><pre> <code class="java hljs">Long total = <span class="hljs-number"><span class="hljs-number">0L</span></span>; List&lt;Long&gt; totals = query.getResultList(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Long element : totals) { total += element == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-number"><span class="hljs-number">0</span></span> : element; }</code> </pre> <br><p> è¿™é‡Œçš„é—®é¢˜æ˜¯ç›¸åŒçš„ï¼šç®€å•ç±»å‹çš„åŒ…è£…å™¨æ˜¯ä¸å¯å˜çš„ï¼Œè¿™æ„å‘³ç€åœ¨å¯¹è±¡ç¼–å·ä¸­æ·»åŠ 5ä¸ªå•ä½æ„å‘³ç€åˆ›å»ºä¸€ä¸ªæ–°åŒ…è£…å™¨å¹¶å°†6å†™å…¥å…¶ä¸­ã€‚ </p><br><p> è¿™é‡Œçš„ç¬‘è¯æ˜¯åœ¨Javaä¸­å­˜åœ¨ä¸¤ç§è¡¨ç¤ºæŸäº›ç±»å‹çš„æ•°æ®çš„è¡¨ç¤ºå½¢å¼-ç®€å•å’Œå¯¹è±¡ï¼Œä»¥åŠå®ƒä»¬é€šè¿‡è¯­è¨€æœ¬èº«çš„è‡ªåŠ¨è½¬æ¢ã€‚ å› æ­¤ï¼Œè®¸å¤šæ–°æ‰‹å¼€å‘äººå‘˜éƒ½ä¼šè¿™æ ·æ€è€ƒï¼šâ€œå¥½å§ï¼Œæ‰§è¡Œä»¥æŸç§æ–¹å¼å°†å®ƒä»¬æœ¬èº«è½¬åŒ–ä¸ºä¸€ä¸ªæ•°å­—ã€‚â€ </p><br><p> å®é™…ä¸Šï¼Œå¹¶éä¸€åˆ‡éƒ½é‚£ä¹ˆç®€å•ã€‚ è¿›è¡Œ<a href="">åŸºå‡†æµ‹è¯•</a>å¹¶å°è¯•ä»¥æŒ‡å®šçš„æ–¹å¼æ·»åŠ æ•°å­—ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">çªç„¶ï¼Œå®ƒå˜å¾—éå¸¸éå¸¸ä¾¿å®œï¼ˆä»¥ä¸‹æ˜¯JDK 11ï¼Œé™¤éå¦æœ‰æ˜ç¡®è¯´æ˜ï¼‰</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"> (size) Mode Cnt Score Error Units wrapper 10 avgt 100 23,5 Â± 0,1 ns/op wrapper 100 avgt 100 352,3 Â± 2,1 ns/op wrapper 1000 avgt 100 4424,5 Â± 25,2 ns/op wrapper 10 avgt 100 0 Â± 0 B/op wrapper 100 avgt 100 1872 Â± 0 B/op wrapper 1000 avgt 100 23472 Â± 0 B/op</code> </pre> <br><p> ä¸ç®€å•ç±»å‹è¿›è¡Œæ¯”è¾ƒï¼š </p><br><pre> <code class="plaintext hljs">primitive 10 avgt 100 6,4 Â± 0,0 ns/op primitive 100 avgt 100 39,8 Â± 0,1 ns/op primitive 1000 avgt 100 252,5 Â± 1,3 ns/op primitive 10 avgt 100 0 Â± 0 B/op primitive 100 avgt 100 0 Â± 0 B/op primitive 1000 avgt 100 0 Â± 0 B/op</code> </pre> </div></div><br><p> ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºæ€§èƒ½æ¬ ä½³çš„åœ°é›·çš„å®šä¹‰ä¹‹ä¸€-è¯¥ä»£ç æ— æ³•å¸å¼•çœ¼çƒï¼Œä¹Ÿæ— æ³•è¢«é™æ€åˆ†æå™¨æ£€æµ‹åˆ°ï¼ˆè‡³å°‘åœ¨æ‚¨é‡åˆ°å®ƒæ—¶ï¼‰ï¼Œä½†æ˜¯åœ¨æŸäº›ç”¨é€”ä¸­å®ƒä¼šå‡æ…¢é€Ÿåº¦ã€‚ åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œä»ç¼“å­˜ä¸­è·å–çš„å¯¹è±¡æ€»æ•°ä¸è¶…è¿‡127ï¼Œè€Œ<code>Long</code>ä»…æ¯”<code>long</code>æ…¢4å€ã€‚ ä½†æ˜¯ï¼Œå¯¹äºå¤§å°ä¸º100çš„æ•°ç»„ï¼Œé€Ÿåº¦å‡ ä¹è¦ä½10å€ã€‚ </p><br><h4 id="bolshie-melochi"> å¤§ä»¶å°äº‹ </h4><br><p> æœ‰æ—¶ï¼Œåœ¨<em>å‡ ä¹</em>æ²¡æœ‰æ”¹å˜æ‰§è¡Œå«ä¹‰çš„æƒ…å†µä¸‹è¿›è¡Œå°çš„æ›´æ”¹ï¼Œåœ¨<em>æŸäº›</em>æƒ…å†µä¸‹ä¼šæˆä¸ºä¸€ä¸ªé‡å¤§éšœç¢ã€‚ </p><br><p> å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªä»£ç ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// org.springframework.data.convert.CustomConversions$ConversionTargetsCache Map&lt;Object, TypeInformation&lt;?&gt;&gt; cache = new ConcurrentHashMap&lt;&gt;(); private TypeInformation&lt;?&gt; getFromCacheOrCreate(Alias alias) { TypeInformation&lt;?&gt; info = cache.get(alias); if (info == null) { info = getAlias.apply(alias); cache.put(alias, info); } return info; }</span></span></code> </pre> <br><p> æ–¹æ³•é€»è¾‘æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ </p><br><div class="spoiler">  <b class="spoiler_title">ä¸è¦æ€¥ç€é—´è°ï¼Œæƒ³æƒ³</b> <div class="spoiler_text"><p> è¿™æ˜¯<code>ConcurrentHashMap::computeIfAbsent</code> ï¼ </p></div></div><br><p> æˆ‘ä»¬æ‹¥æœ‰â€œå…«â€å­—ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°æ”¹è¿›ä»£ç ï¼šç”¨1æ›¿æ¢6è¡Œï¼Œä½¿ä»£ç æ›´çŸ­ï¼Œæ›´æ˜“äºç†è§£ã€‚ é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œå¤šçº¿ç¨‹ä¸“å®¶ä»¬å¯èƒ½ä¼šæŒ‡å‡º<code>ConcurrentHashMap::computeIfAbsent</code>å¸¦æ¥çš„å¦ä¸€é¡¹æ”¹è¿›ï¼Œä½†<code>ConcurrentHashMap::computeIfAbsent</code>ä¼šæœ‰æ‰€æ”¹è¿›ï¼›ï¼‰ </p><br><p> è®©æˆ‘ä»¬å®ç°ä¸€ä¸ªä¼Ÿå¤§çš„æƒ³æ³•ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// org.springframework.data.convert.CustomConversions$ConversionTargetsCache Map&lt;Object, TypeInformation&lt;?&gt;&gt; cache = new ConcurrentHashMap&lt;&gt;(); private TypeInformation&lt;?&gt; getFromCacheOrCreate(Alias alias) { return cache.computeIfAbsent(alias, getAlias); }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">èšé›†ï¼Œå¼€å§‹ï¼Œå“­æ³£</b> <div class="spoiler_text"><p> è¦æŸ¥çœ‹å®Œæ•´å°ºå¯¸ï¼Œè¯·å³é”®å•å‡»å›¾ç‰‡ï¼Œç„¶åé€‰æ‹©â€œåœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å›¾åƒâ€ <br><img src="https://habrastorage.org/getpro/habr/post_images/9f0/2aa/0e0/9f02aa0e028903e85a63d08207d93509.png" alt="å›¾ç‰‡"></p></div></div><br><p> å½“åº”ç”¨ç¨‹åºä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œä¸€åˆ‡éƒ½å·®ä¸å¤šã€‚ æµå˜å¾—è¶Šæ¥è¶Šå¤šï¼Œå˜å¾—è¶Šæ¥è¶Šå·®ã€‚  <code>ConcurrentHashMap::computeIfAbsent</code>è¯æ˜ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å³ä½¿<strong>å·²å°†</strong>å¯†é’¥æ·»åŠ åˆ°å­—å…¸ä¸­</a> ï¼Œ <code>ConcurrentHashMap::computeIfAbsent</code>è¢«é˜»æ­¢ã€‚ è¿™å°±æ˜¯Spring Date Mongoä¸­å‡ºç°å¤§é‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é”™è¯¯</a>çš„åŸå› ã€‚ </p><br><p> æ‚¨å¯ä»¥é€šè¿‡ç®€å•çš„<a href="">æµ‹é‡</a> ï¼ˆâ€œå…«â€ï¼‰è¿›è¡ŒéªŒè¯ã€‚ è¿™æ˜¯ä»–çš„ç»“è®ºï¼š </p><br><pre> <code class="plaintext hljs">Benchmark Mode Cnt Score Error Units 1 thread computeIfAbsent avgt 20 19,405 Â± 0,411 ns/op getAndPut avgt 20 4,578 Â± 0,045 ns/op 2 threads computeIfAbsent avgt 20 66,492 Â± 2,036 ns/op getAndPut avgt 20 4,454 Â± 0,110 ns/op 4 threads computeIfAbsent avgt 20 155,975 Â± 8,850 ns/op getAndPut avgt 20 5,616 Â± 2,073 ns/op 6 threads computeIfAbsent avgt 20 203,188 Â± 10,547 ns/op getAndPut avgt 20 7,024 Â± 0,456 ns/op 8 threads computeIfAbsent avgt 20 302,036 Â± 31,702 ns/op getAndPut avgt 20 7,990 Â± 0,144 ns/op</code> </pre> <br><p> å¼€å‘äººå‘˜å¯ä»¥æ˜ç¡®åœ°è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªé”™è¯¯å—ï¼Ÿ ä»¥æˆ‘çš„æ‹™è§ï¼Œä¸ï¼Œä¸ã€‚ è¯¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ä»¶</a>è¯´ï¼š </p><br><blockquote> åœ¨è®¡ç®—è¿›è¡ŒæœŸé—´ï¼Œå¯èƒ½ä¼šé˜»æ­¢å…¶ä»–çº¿ç¨‹åœ¨æ­¤æ˜ å°„ä¸Šè¿›è¡Œçš„æŸäº›å°è¯•çš„æ›´æ–°æ“ä½œï¼Œå› æ­¤è®¡ç®—åº”ç®€çŸ­è€Œç®€å•ï¼Œå¹¶ä¸”ä¸å¾—å°è¯•æ›´æ–°æ­¤æ˜ å°„çš„ä»»ä½•å…¶ä»–æ˜ å°„ </blockquote><p> æ¢å¥è¯è¯´ï¼Œ <code>ConcurrentHashMap::computeIfAbsent</code>å…³é—­åŒ…å«æ¥è‡ªå¤–ç•Œçš„é”®çš„å•å…ƒæ ¼ï¼ˆä¸<code>ConcurrentHashMap::get</code>ä¸åŒï¼‰ï¼Œè¿™é€šå¸¸æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºå½“å°šæœªæ·»åŠ é”®æ—¶ï¼Œå®ƒå…è®¸æ‚¨ä»ä¸åŒçš„çº¿ç¨‹è°ƒç”¨æ–¹æ³•æ—¶èº²é¿ç«äº‰ã€‚ </p><br><p> å¦ä¸€æ–¹é¢ï¼Œåœ¨æœ€å¸¸è§çš„æ“ä½œæ¨¡å¼ä¸­ï¼Œå€¼çš„è®¡ç®—åŠå…¶ä¸é”®çš„ç»‘å®šä»…åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶å‘ç”Ÿï¼Œè€Œæ‰€æœ‰åç»­è°ƒç”¨ä»…è¿”å›å…ˆå‰è®¡ç®—çš„å€¼ã€‚ å› æ­¤ï¼Œæœ‰æ„ä¹‰çš„æ˜¯æ›´æ”¹é€»è¾‘ï¼Œä»¥ä¾¿ä»…åœ¨æ›´æ”¹æ—¶è®¾ç½®é”å®šã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®ƒæ˜¯åœ¨è¿™é‡Œåšçš„</a> ã€‚ </p><br><p> åœ¨è¾ƒæ–°çš„ç‰ˆæœ¬ï¼ˆ&gt; 8ï¼‰ä¸­ï¼Œ <code>ConcurrentHashMap::computeIfAbsent</code>å˜å¾—<code>ConcurrentHashMap::computeIfAbsent</code> ï¼š </p><br><pre> <code class="plaintext hljs">JDK 11 Benchmark Mode Cnt Score Error Units 1 thread computeIfAbsent avgt 20 6,983 Â± 0,066 ns/op getAndPut avgt 20 5,291 Â± 1,220 ns/op 2 threads computeIfAbsent avgt 20 7,173 Â± 0,249 ns/op getAndPut avgt 20 5,118 Â± 0,395 ns/op 4 threads computeIfAbsent avgt 20 7,991 Â± 0,447 ns/op getAndPut avgt 20 5,270 Â± 0,366 ns/op 6 threads computeIfAbsent avgt 20 11,919 Â± 0,865 ns/op getAndPut avgt 20 7,249 Â± 0,199 ns/op 8 threads computeIfAbsent avgt 20 14,360 Â± 0,892 ns/op getAndPut avgt 20 8,511 Â± 0,229 ns/op</code> </pre> <br><p> è¯·æ³¨æ„æ­¤ç¤ºä¾‹çš„é˜´é™©ä¹‹å¤„ï¼šè¯­ä¹‰å†…å®¹<em>å¹¶</em>æ²¡æœ‰å¤ªå¤§å˜åŒ–ï¼Œå› ä¸ºä¹ä¸€çœ‹æˆ‘ä»¬åªæ˜¯ä½¿ç”¨äº†æ›´é«˜çº§çš„è¯­æ³•ã€‚ åŒæ—¶ï¼Œå½“åº”ç”¨ç¨‹åºåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œæ—¶ï¼Œç”¨æˆ·å‡ ä¹æ„Ÿè§‰ä¸åˆ°å·®å¼‚ï¼ è¿™çœ‹ä¼¼æ— å®³çš„å˜åŒ– <del> çŒª </del> æˆ‘çš„è¡¨ç°ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ä¸ºä»€ä¹ˆæˆ‘å†™â€œå‡ ä¹ä¸å˜â€</b> <div class="spoiler_text"><p>  <code>ConcurrentHashMap::computeIfAbsent</code>å¹¶ä¸æ€»æ˜¯å¯ä»¥ä¸<code>getAndPut</code>è¡¨è¾¾å¼äº’æ¢ï¼Œå› ä¸º<code>ConcurrentHashMap::computeIfAbsent</code>æ˜¯åŸå­æ“ä½œã€‚ ç”¨ç›¸åŒçš„ä»£ç  </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TypeInformation&lt;?&gt; getFromCacheOrCreate(Alias alias) { TypeInformation&lt;?&gt; info = cache.get(alias); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { info = getAlias.apply(alias); cache.put(alias, info); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info; }</code> </pre> <br><p> ç”±äºç¼ºä¹å¤–éƒ¨åŒæ­¥<strong>ï¼Œç§æ—å‡ºç°äº†</strong> ã€‚ å¦‚æœä¼ é€’ç»™ç»™å®šé”®çš„<code>ConcurrentHashMap::computeIfAbsent</code>å‡½æ•°å§‹ç»ˆè¿”å›ç›¸åŒçš„å€¼ï¼Œåˆ™è¿™æ˜¯ä¸€ä¸ªâ€œå®‰å…¨â€çš„ç«äº‰ï¼Œæˆ‘ä»¬é¢ä¸´çš„æœ€å¤§<code>ConcurrentHashMap::computeIfAbsent</code>æ˜¯ä¸¤æ¬¡æˆ–æ›´å¤šæ¬¡è®¡ç®—ç›¸åŒçš„å€¼ã€‚ å¦‚æœæ²¡æœ‰è¿™æ ·çš„ä¿è¯ï¼Œé‚£ä¹ˆæœºæ¢°æ›´æ¢å°†å›°æ‰°ç€åº”ç”¨çš„å´©æºƒã€‚ å°å¿ƒç‚¹ï¼ </p></div></div><br><h4 id="eti-ruki-nichego-ne-menyali"> è¿™äº›æ‰‹ä»€ä¹ˆéƒ½æ²¡å˜ </h4><br><p> ä¹Ÿæœ‰å¯èƒ½ä»£ç æ ¹æœ¬æ²¡æœ‰æ”¹å˜ï¼Œä½†æ˜¯çªç„¶å®ƒå¼€å§‹å˜æ…¢äº†ã€‚ </p><br><p> æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬é¢ä¸´ç€å°†æ•°ç»„å…ƒç´ è½¬ç§»åˆ°é›†åˆä¸­çš„ä»»åŠ¡ã€‚ æœ€åˆä¹é€»è¾‘çš„æ–¹æ³•æ˜¯ä½¿ç”¨ç°æˆçš„<code>Collection::addAll</code> ï¼Œä½†è¿™å¾ˆä¸å¹¸-å®ƒæ¥å—è¯¥é›†åˆï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Collection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;? extends E&gt; c)</span></span></span></span>; }</code> </pre> <br><p> æœ€ç®€å•çš„æ–¹æ³•æ˜¯å°†æ•°ç»„åŒ…è£…åœ¨<code>Arrays::asList</code> ã€‚ ç»“æœä¼šæ˜¯ </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addItems</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;T&gt; collection)</span></span></span><span class="hljs-function"> </span></span>{ T[] items = getArray(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> collection.addAll(Arrays.asList(items)); }</code> </pre> <br><p> åœ¨æ ¡å¯¹æœŸé—´ï¼Œæ³¨é‡æ€§èƒ½çš„åŒäº‹å¯èƒ½ä¼šå‘Šè¯‰æˆ‘ä»¬ï¼Œæ­¤ä»£ç åŒæ—¶å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š </p><br><ul><li> å°†æ•°ç»„åŒ…è£…åœ¨åˆ—è¡¨ä¸­ï¼ˆé¢å¤–å¯¹è±¡ï¼‰ </li><li> åˆ›å»ºä¸€ä¸ªè¿­ä»£å™¨ï¼ˆå¦ä¸€ä¸ªé¢å¤–çš„å¯¹è±¡ï¼‰å¹¶ä¼ é€’ç»™å®ƒ </li></ul><br><p> å®é™…ä¸Šï¼Œåœ¨<code>Collection::addAll</code>çš„å‚è€ƒå®ç°ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Collection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;? extends E&gt; c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> modified = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (E e : c) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (add(e)) modified = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> modified; } }</code> </pre> <br><p> å› æ­¤ï¼Œè¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªè¿­ä»£å™¨ï¼Œå¹¶ä½¿ç”¨å®ƒå¯¹å…ƒç´ è¿›è¡Œäº†æ’åºã€‚ å› æ­¤ï¼Œæœ‰ç»éªŒçš„åŒå¿—æä¾›ä»–ä»¬çš„è§£å†³æ–¹æ¡ˆï¼š </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addItems</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;T&gt; collection)</span></span></span><span class="hljs-function"> </span></span>{ T[] items = getArray(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Collections.addAll(collection, items); }</code> </pre> <br><p> åœ¨ä»£ç å†…éƒ¨ï¼Œ <em>çœ‹èµ·æ¥ä¼¼ä¹</em>æ›´æœ‰ç”Ÿäº§åŠ›ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;? </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">super</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&gt; c, T... elements)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (T element : elements) result |= c.add(element); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p> é¦–å…ˆï¼Œä¸åˆ›å»ºè¿­ä»£å™¨ã€‚ å…¶æ¬¡ï¼Œè¯¥è¿‡ç¨‹æŒ‰é€šå¸¸çš„è®¡æ•°å‘¨æœŸè¿›è¡Œï¼Œæ­¤å¤–ï¼Œæ•°ç»„éå¸¸é€‚åˆé«˜é€Ÿç¼“å­˜ï¼Œå…¶å…ƒç´ é¡ºåºä½äºå†…å­˜ä¸­ï¼ˆè¿™æ„å‘³ç€å‡ ä¹æ²¡æœ‰é«˜é€Ÿç¼“å­˜æœªå‘½ä¸­ï¼‰ï¼Œå¹¶ä¸”é€šè¿‡ç´¢å¼•è®¿é—®å®ƒä»¬éå¸¸å¿«ã€‚ å¥½äº†ï¼Œä¹Ÿä¸åˆ›å»ºåŒ…è£…åˆ—è¡¨ã€‚ å¬èµ·æ¥ä¸é”™ã€‚ </p><br><p> æœ€åï¼ŒåŒäº‹ä»¬å¼•ç”¨äº†æœ€åé€šè¡Œæ¯”ä¾‹è§„å®šï¼šæ–‡ä»¶ã€‚ é‚£é‡Œï¼Œç™½è‰²çš„ç°è‰²ï¼ˆæˆ–é»‘è‰²çš„ç»¿è‰²ï¼‰è¡¨ç¤ºï¼š </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * ... * The behavior of this convenience method is identical to that of * c.addAll(Arrays.asList(elements)), but this method is likely * to run significantly faster under most implementations. &lt;---- * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@since</span></span></span><span class="hljs-comment"> 1.5 */</span></span> <span class="hljs-meta"><span class="hljs-meta">@SafeVarargs</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;? </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">super</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&gt; c, T... elements)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre> <br><p> ä¹Ÿå°±æ˜¯è¯´ï¼Œå¼€å‘äººå‘˜è‡ªå·±ï¼ˆå¦‚æœä¸æ˜¯ï¼Œä»–ä»¬åº”è¯¥ç›¸ä¿¡è°ï¼Ÿï¼‰å†™é“ï¼Œå¯¹äºå¤§å¤šæ•°å®ç°è€Œè¨€ï¼Œå®ç”¨ç¨‹åºæ–¹æ³•çš„è¿è¡Œé€Ÿåº¦<em>è¦</em>å¿«å¾—å¤šã€‚ è€Œä¸”ä»–çœŸçš„æ›´å¿«ã€‚ æœ‰æ—¶å€™ </p><br><p> æˆ‘ä»¬å°†åœ¨G8ä¸Šé’ˆå¯¹<code>HashSet</code>æ¨å‡ºçš„<a href="">åŸºå‡†æµ‹è¯•</a>å°†æœ‰åŠ©äº<code>HashSet</code> ï¼š </p><br><pre> <code class="plaintext hljs">Benchmark (collection) (size) Mode Cnt Score Error Units addAll HashSet 10 avgt 100 155,2 Â± 2,8 ns/op addAll HashSet 100 avgt 100 1884,4 Â± 37,4 ns/op addAll HashSet 1000 avgt 100 17917,3 Â± 298,8 ns/op collectionsAddAll HashSet 10 avgt 100 136,1 Â± 0,8 ns/op collectionsAddAll HashSet 100 avgt 100 1538,3 Â± 31,4 ns/op collectionsAddAll HashSet 1000 avgt 100 15168,6 Â± 289,4 ns/op</code> </pre> <br><p> çœ‹æ¥æ›´æœ‰ç»éªŒçš„åŒå¿—æ˜¯å¯¹çš„ã€‚ å·®ä¸å¤šäº† </p><br><p> åœ¨æ›´é«˜ç‰ˆæœ¬ä¸­ï¼ˆä¾‹å¦‚ï¼Œåœ¨11ä¸­ï¼‰ï¼Œå®ç”¨ç¨‹åºæ–¹æ³•çš„è¾‰ç…Œå°†é€æ¸æ¶ˆå¤±ï¼š </p><br><pre> <code class="plaintext hljs">Benchmark (collection) (size) Mode Cnt Score Error Units addAll HashSet 10 avgt 100 143,1 Â± 0,6 ns/op addAll HashSet 100 avgt 100 1738,4 Â± 7,3 ns/op addAll HashSet 1000 avgt 100 16853,9 Â± 101,0 ns/op collectionsAddAll HashSet 10 avgt 100 132,1 Â± 1,1 ns/op collectionsAddAll HashSet 100 avgt 100 1661,1 Â± 7,1 ns/op collectionsAddAll HashSet 1000 avgt 100 15450,9 Â± 93,9 ns/op</code> </pre> <br><p> å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬æ²¡æœ‰åœ¨è°ˆè®ºä»»ä½•â€œå¿«å¾—å¤šâ€çš„é—®é¢˜ã€‚ è€Œä¸”ï¼Œå¦‚æœæˆ‘ä»¬å¯¹<code>ArrayList</code> -aé‡å¤è¯¥å®éªŒï¼Œé‚£ä¹ˆç»“æœå‘ç°å®ç”¨ç¨‹åºæ–¹æ³•å¼€å§‹æŸå¤±å¾ˆå¤šï¼ˆè¶Šå¼ºå¤§ï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">Benchmark (collection) (size) Mode Cnt Score Error Units JDK 8 addAll ArrayList 10 avgt 100 38,5 Â± 0,5 ns/op addAll ArrayList 100 avgt 100 188,4 Â± 7,0 ns/op addAll ArrayList 1000 avgt 100 1278,8 Â± 42,9 ns/op collectionsAddAll ArrayList 10 avgt 100 62,7 Â± 0,7 ns/op collectionsAddAll ArrayList 100 avgt 100 495,1 Â± 2,0 ns/op collectionsAddAll ArrayList 1000 avgt 100 4892,5 Â± 48,0 ns/op JDK 11 addAll ArrayList 10 avgt 100 26,1 Â± 0,0 ns/op addAll ArrayList 100 avgt 100 161,1 Â± 0,4 ns/op addAll ArrayList 1000 avgt 100 1276,7 Â± 3,7 ns/op collectionsAddAll ArrayList 10 avgt 100 41,6 Â± 0,0 ns/op collectionsAddAll ArrayList 100 avgt 100 492,6 Â± 1,5 ns/op collectionsAddAll ArrayList 1000 avgt 100 6792,7 Â± 165,5 ns/op</code> </pre> <br><p> è¿™é‡Œæ²¡æœ‰ä»€ä¹ˆæ„å¤–çš„ï¼Œ <code>ArrayList</code>å›´ç»•æ•°ç»„æ„å»ºçš„ï¼Œå› æ­¤å¼€å‘äººå‘˜å…·æœ‰è¿œè§åœ°é‡æ–°å®šä¹‰äº†<code>Collection::addAll</code> ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;? extends E&gt; c)</span></span></span><span class="hljs-function"> </span></span>{ Object[] a = c.toArray(); modCount++; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> numNew = a.length; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (numNew == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Object[] elementData; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> s; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (numNew &gt; (elementData = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.elementData).length - (s = size)) elementData = grow(s + numNew); System.arraycopy(a, <span class="hljs-number"><span class="hljs-number">0</span></span>, elementData, s, numNew); &lt;---    size = s + numNew; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br><p> ç°åœ¨å›åˆ°æˆ‘ä»¬çš„åœ°é›·ã€‚ å‡è®¾æˆ‘ä»¬ä»ç„¶æ¥å—äº†æ ¡å¯¹ä¸­æå‡ºçš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶ä¿ç•™äº†ä»¥ä¸‹ä»£ç ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addItems</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;T&gt; collection)</span></span></span><span class="hljs-function"> </span></span>{ T[] items = getArray(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Collections.addAll(collection, items); }</code> </pre> <br><p> æš‚æ—¶ä¸€åˆ‡éƒ½å¾ˆå¥½ï¼Œä½†æ˜¯åœ¨æ·»åŠ äº†æ–°åŠŸèƒ½ä¹‹åï¼Œè¯¥æ–¹æ³•æœ‰æ—¶ä¼šå˜å¾—å¾ˆçƒ­å¹¶ä¸”å¼€å§‹å˜æ…¢ã€‚ æˆ‘ä»¬å¼€æ”¾æºä»£ç -ä»£ç æœªæ›´æ”¹ã€‚ æ•°æ®é‡æ˜¯ç›¸åŒçš„ã€‚ è€Œä¸”æ€§èƒ½ä¸‹é™äº†å¾ˆå¤šã€‚ è¿™æ˜¯æˆ‘çš„å¦ä¸€ç§ç±»å‹ã€‚ </p><br><p> å‘ç°è°ƒè¯•å™¨å¹¶æ‰¾åˆ°æ¼‚äº®çš„ï¼š </p><br><p><img src="https://habrastorage.org/webt/nw/og/mu/nwogmu0_mvl-ix_hdyoxdaoydik.png"></p><br><p> è¯·æ³¨æ„ï¼šæˆ‘ä»¬æ²¡æœ‰æ”¹å˜ç®—æ³•ï¼Œå¤„ç†çš„æ•°æ®é‡æ²¡æœ‰æ”¹å˜ï¼Œä½†æ˜¯å®ƒä»¬çš„æ€§è´¨æ”¹å˜äº†ï¼Œå¹¶ä¸”åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­å‡ºç°äº†æ€§èƒ½é—®é¢˜ï¼š </p><br><pre> <code class="plaintext hljs"> Java 8 Java 11  addAll 10 56,9 25,2 ns/op collectionsAddAll 10 352,2 142,9 ns/op addAll 100 159,9 84,3 ns/op collectionsAddAll 100 4607,1 3964,3 ns/op addAll 1000 1244,2 760,2 ns/op collectionsAddAll 1000 355796,9 364677,0 ns/op</code> </pre> <br><p> åœ¨å¤§å‹æ•°ç»„ä¸Šï¼Œ <code>Collections::addAll</code>å’Œ<code>Collection::addAll</code>ä¹‹é—´çš„<code>Collection::addAll</code>åªæœ‰500å€ã€‚ äº‹å®æ˜¯ï¼Œ <code>COWList</code>ä¸ä»…ä¼šæ‰©å±•ç°æœ‰æ•°ç»„ï¼Œè¿˜ä¼šåœ¨æ¯æ¬¡æ·»åŠ å…ƒç´ æ—¶åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(E e)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (lock) { Object[] es = getArray(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len = es.length; es = Arrays.copyOf(es, len + <span class="hljs-number"><span class="hljs-number">1</span></span>); &lt;----    es[len] = e; setArray(es); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }</code> </pre> <br><p><del> è°è¯¥æ€ªï¼Ÿ </del></p><br><div class="spoiler">  <b class="spoiler_title">æ€ä¹ˆåŠ</b> <div class="spoiler_text"><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://bugs.openjdk.java.net/browse/JDK-8193031</a> </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http://cr.openjdk.java.net/~martin/webrevs/jdk/Collections-addAll/</a> </p></div></div><br><p> è¿™é‡Œçš„ä¸»è¦é—®é¢˜æ˜¯<code>Collections::addAll</code>æ¥å—ä¸€ä¸ªæ¥å£ï¼Œè€Œ<code>addAll</code>æ–¹æ³•æ²¡æœ‰ä¸»ä½“ã€‚ æ²¡æœ‰å†…å®¹-æ²¡æœ‰ä¸šåŠ¡ï¼Œå› æ­¤ï¼Œæ–‡æ¡£åŸºäº<code>AbstractCollection::addAll</code>å­˜åœ¨çš„å®ç°<code>AbstractCollection::addAll</code> ï¼Œè¿™æ˜¯é€‚ç”¨äºæ‰€æœ‰é›†åˆçš„é€šç”¨ç®—æ³•ã€‚ è¿™æ„å‘³ç€å¤„äºè¾ƒä½æŠ½è±¡çº§åˆ«çš„æ•°æ®ç»“æ„çš„æ›´å…·ä½“çš„å®ç°å¯ä»¥æ›´æ”¹æ­¤è¡Œä¸ºã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç°åœ¨äººç±»</b> <div class="spoiler_text"><pre> <code class="java hljs"> Collection::addAll â€“   AbstractCollection::addAll â€“   &lt;---    ArrayList::addAll HashSet::addAll â€“   &lt;---      COWList::addAll</code> </pre> </div></div><br><h4 id="eschyo-ob-abstrakciyah"> æœ‰å…³æŠ½è±¡çš„æ›´å¤šä¿¡æ¯ </h4><br><p> ç”±äºæˆ‘ä»¬åœ¨è°ˆè®ºæŠ½è±¡çš„å±‚æ¬¡ï¼Œå› æ­¤æˆ‘å°†å‘æ‚¨ä»‹ç»ç”Ÿæ´»ä¸­çš„ä¸€ä¸ªä¾‹å­ã€‚ </p><br><p> è®©æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹è¿™ä¸¤ç§åœ¨æ•°æ®åº“ä¸­ä¿å­˜ç¬¬nä¸ªå®ä½“çš„æ–¹å¼ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Transactional</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; n; i++) { SimpleEntity e = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleEntity(); repository.save(e); } } <span class="hljs-meta"><span class="hljs-meta">@Transactional</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; n; i++) { SimpleEntity e = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleEntity(); repository.saveAndFlush(e); } }</code> </pre> <br><p> ä¹ä¸€çœ‹ï¼Œè¿™ä¸¤ç§æ–¹æ³•çš„æ€§èƒ½ä¸åº”æœ‰å¾ˆå¤§å·®å¼‚ï¼Œå› ä¸º </p><br><ul><li> åœ¨ä¸¤ç§æƒ…å†µä¸‹ï¼Œç›¸åŒæ•°é‡çš„å®ä½“å°†å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ </li><li> å¦‚æœå¯†é’¥æ˜¯ä»åºåˆ—ä¸­è·å–çš„ï¼Œåˆ™é€šè¯æ¬¡æ•°å°†ç›¸åŒ </li><li> ä¼ è¾“çš„æ•°æ®é‡ç›¸åŒ </li></ul><br><p>  <code>SimpleJpaRepository::saveAndFlush</code> ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Transactional</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;S extends T&gt; <span class="hljs-function"><span class="hljs-function">S </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(S entity)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entityInformation.isNew(entity)) { em.persist(entity); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> entity; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> em.merge(entity); } } <span class="hljs-meta"><span class="hljs-meta">@Transactional</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;S extends T&gt; <span class="hljs-function"><span class="hljs-function">S </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveAndFlush</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(S entity)</span></span></span><span class="hljs-function"> </span></span>{ S result = save(entity); flush(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-meta"><span class="hljs-meta">@Transactional</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flush</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ em.flush(); }</code> </pre> <br><p> è¿™é‡Œçš„é»‘ç‚¹æ˜¯<code>flush()</code>æ–¹æ³•ã€‚ ä¸ºä»€ä¹ˆå‚»å‘¢ï¼Ÿ åœ¨æˆ‘çœ‹æ¥ï¼Œå®ƒåœ¨<code>JpaRepository</code>æ¥å£ä¸­çš„å…¬å¼€æ˜¯å¼€å‘äººå‘˜çš„é”™è¯¯ã€‚ æˆ‘ä¼šå°½åŠ›è¯æ˜æˆ‘çš„æƒ³æ³•ã€‚ é€šå¸¸ï¼Œå¼€å‘äººå‘˜æ ¹æœ¬ä¸ä¼šä½¿ç”¨æ­¤æ–¹æ³•ï¼Œå› ä¸ºå¯¹<code>EntityManager::flush</code>çš„è°ƒç”¨ä¸Springæ§åˆ¶çš„äº‹åŠ¡çš„å®Œæˆç›¸å…³ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//     @Transactional public void method() { &lt;--  Session::open /*.*/ } &lt;--  Session::flush</span></span></code> </pre> <br><p> è¯·æ³¨æ„ï¼š <code>EntityManager</code>æ˜¯åœ¨Hibernateä¸­ä½œä¸ºä¼šè¯å®ç°çš„<code>JPA</code>è§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼ˆåˆ†åˆ«ä¸ºSessionæ¥å£å’ŒSessionImplç±»ï¼‰ã€‚  Spring Dateæ˜¯ä¸€ä¸ªåœ¨ORMï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸ºHibernateï¼‰ä¹‹ä¸Šè¿è¡Œçš„æ¡†æ¶ã€‚ äº‹å®è¯æ˜ï¼Œå°½ç®¡æ¡†æ¶çš„ä»»åŠ¡æ˜¯éšè—ä½çº§ç»†èŠ‚ï¼ˆè¯¥æƒ…å†µä¸JDKä¸­çš„ä¸å®‰å…¨æ•…äº‹ç±»ä¼¼ï¼‰ï¼Œä½†<code>JpaRepository::saveAndFlush</code>ä½¿æˆ‘ä»¬å¯ä»¥è®¿é—®APIçš„ä½çº§ã€‚ <br> åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå½“ä½¿ç”¨<code>JpaRepository::saveAndFlush</code>æˆ‘ä»¬è¿›å…¥äº†åº”ç”¨ç¨‹åºçš„è¾ƒä½å±‚ï¼Œä»è€Œç ´åäº†æŸäº›å†…å®¹ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">èŠ±äº›æ—¶é—´å·çœ‹ï¼Œè‡ªå·±è€ƒè™‘ä¸€ä¸‹</b> <div class="spoiler_text"><p>  Hibernateæ‰¹é‡å‘é€æ•°æ®çš„åŠŸèƒ½å·²è¢«ç ´åï¼Œå®ƒæ˜¯<code>application.yml</code>æŒ‡å®šçš„<code>jdbc.batch_size</code>è®¾ç½®çš„å€æ•°ï¼š </p><br><pre> <code class="plaintext hljs">spring: jpa: properties: hibernate: jdbc.batch_size: 500</code> </pre> <br><p>  Hibernateçš„å·¥ä½œåŸºäºäº‹ä»¶ï¼Œå› æ­¤å½“æ‚¨ä¿å­˜1000ä¸ªè¿™æ ·çš„å®ä½“æ—¶ </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Transactional</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; n; i++) { SimpleEntity e = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleEntity(); repository.save(e); } }</code> </pre> <br><p> è°ƒç”¨<code>repository.save(e)</code>ä¸ä¼šç«‹å³ä¿å­˜ã€‚ è€Œæ˜¯åˆ›å»ºä¸€ä¸ªæ’é˜Ÿçš„äº‹ä»¶ã€‚ äº‹åŠ¡å®Œæˆåï¼Œå°†ä½¿ç”¨<code>EntityManager::flush</code>åˆå¹¶æ•°æ®ï¼Œè¯¥æ•°æ®å°†æ’å…¥/æ›´æ–°åˆ†æˆ<code>jdbc.batch_size</code>å€æ•°æŸï¼Œå¹¶<code>jdbc.batch_size</code>åˆ›å»ºè¯·æ±‚ã€‚ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œ <code>jdbc.batch_size: 500</code> ï¼Œå› æ­¤å®é™…ä¸Šä¿å­˜1000ä¸ªå®ä½“ä»…æ„å‘³ç€2ä¸ªè¯·æ±‚ã€‚ </p><br><p> ä½†æ˜¯ï¼Œåœ¨å‘¨æœŸçš„æ¯ä¸ªé˜¶æ®µéƒ½è¦æ‰‹åŠ¨æ‰§è¡Œä¼šè¯ </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Transactional</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; n; i++) { SimpleEntity e = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleEntity(); repository.saveAndFlush(e); } }</code> </pre> <br><p> é˜Ÿåˆ—å·²æ¸…é™¤ï¼Œä¿å­˜1000ä¸ªå®ä½“æ„å‘³ç€1000ä¸ªæŸ¥è¯¢ã€‚ </p></div></div><br><p> å› æ­¤ï¼Œå¹²æ‰°åº”ç”¨ç¨‹åºçš„è¾ƒä½å±‚å¾ˆå®¹æ˜“æˆä¸ºåœ°é›·ï¼Œè€Œä¸ä»…ä»…æ˜¯ç”Ÿäº§åŠ›åœ°é›·ï¼ˆè¯·å‚é˜…ä¸å®‰å…¨åŠå…¶ä¸å—æ§åˆ¶çš„ä½¿ç”¨ï¼‰ã€‚ </p><br><p> å®ƒå‡æ…¢äº†å¤šå°‘ï¼Ÿ ä»¥æœ€å¥½çš„æƒ…å†µï¼ˆå¯¹æˆ‘ä»¬è€Œè¨€ï¼‰-æ•°æ®åº“ä¸åº”ç”¨ç¨‹åºä½äºåŒä¸€ä¸»æœºä¸Šã€‚ æˆ‘çš„<a href="">æµ‹é‡</a>ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š </p><br><pre> <code class="plaintext hljs"> (entityCount) Mode Cnt Score Error Units bulkSave 10 ss 500 16,613 Â± 1,714 ms/op bulkSave 100 ss 500 31,371 Â± 1,453 ms/op bulkSave 1000 ss 500 35,687 Â± 1,973 ms/op bulkSaveUsingFlush 10 ss 500 32,653 Â± 2,166 ms/op bulkSaveUsingFlush 100 ss 500 61,983 Â± 6,304 ms/op bulkSaveUsingFlush 1000 ss 500 184,814 Â± 6,976 ms/op</code> </pre> <br><p> æ˜¾ç„¶ï¼Œå¦‚æœæ•°æ®åº“ä½äºè¿œç¨‹ä¸»æœºä¸Šï¼Œåˆ™æ•°æ®ä¼ è¾“çš„æˆæœ¬å°†éšç€æ•°æ®é‡çš„å¢é•¿è€Œé€æ¸é™ä½æ€§èƒ½ã€‚ </p><br><p> å› æ­¤ï¼Œä»¥é”™è¯¯çš„æŠ½è±¡çº§åˆ«è¿›è¡Œå·¥ä½œå¾ˆå®¹æ˜“åˆ¶é€ å®šæ—¶ç‚¸å¼¹ã€‚ é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œåœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æˆ‘ä»¥å‰çš„ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œ</a>æˆ‘è°ˆåˆ°äº†ä¸€ç§æ”¹è¿›<code>StringBuilder</code> -açš„å¥‡æ€ªå°è¯•ï¼šåœ¨å°è¯•è¿›å…¥æ›´æŠ½è±¡çš„ä»£ç çº§åˆ«æ—¶ï¼Œæˆ‘æ²¡æœ‰æˆåŠŸã€‚ </p><br><h4 id="granicy-minnyh-poley"> é›·åŒºè¾¹ç•Œ </h4><br><p> è®©æˆ‘ä»¬æ‰®æ¼”ä¸€ä¸ªå·¥å…µå—ï¼Ÿ æŸ¥æ‰¾æˆ‘çš„ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// org.springframework.cache.interceptor.CacheAspectSupport Object generateKey(CacheOperationContext ctx, Object result) { Object key = ctx.generateKey(result); Assert.notNull(key, "Null key ..." + context.metadata.operation); // ... return key; }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">æ‰¾åˆ°äº†å—ï¼Ÿ</b>  <b class="spoiler_title">æ£€æŸ¥æ­£ç¡®ç­”æ¡ˆã€‚</b> <div class="spoiler_text"><pre> <code class="java hljs"> | \ / <span class="hljs-comment"><span class="hljs-comment">// org.springframework.cache.interceptor.CacheAspectSupport | \ / Object generateKey(CacheOperationContext ctx, Object result) { Object key = ctx.generateKey(result); | \ / Assert.notNull(key, "Null key ..." + context.metadata.operation); return key; }</span></span></code> </pre> </div></div><br><p> è¯„è®ºå®¶å¤§å£°è¯´é“ï¼šâ€œä½ åœ¨å¼€ç©ç¬‘å—ï¼Ÿä½†æ˜¯åªæœ‰ä¸¤è¡Œèƒ¶åˆå—ï¼Ÿåœ¨è¡€è…¥çš„E.ä¸­æ„å‘³ç€ä»€ä¹ˆï¼Ÿâ€ è®©æˆ‘å¼•èµ·æ‚¨çš„æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä¸ä»…å¼ºè°ƒäº†å­—ç¬¦ä¸²çš„ç²˜åˆï¼Œè€Œä¸”è¿˜å¼ºè°ƒäº†ç±»çš„åç§°å’Œæ–¹æ³•çš„åç§°ã€‚ ç¡®å®ï¼Œèƒ¶åˆå­—ç¬¦ä¸²çš„å±é™©ä¸æ˜¯èƒ¶åˆè‡ªèº«ï¼Œè€Œæ˜¯åœ¨åˆ›å»ºç”¨äºç¼“å­˜çš„é”®çš„æ–¹æ³•ä¸­å‘ç”Ÿçš„äº‹æƒ…ï¼Œå³åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†å¯¹è¯¥æ–¹æ³•æœ‰å¾ˆå¤šè®¿é—®æƒé™ï¼Œè¿™æ„å‘³ç€å¾ˆå¤šåƒåœ¾å›æ”¶è¡Œã€‚ <br> å› æ­¤ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»…</a>å½“å®é™…æŠ›å‡ºæ­¤é”™è¯¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ—¶æ‰åº”åˆ›å»º</a>é”™è¯¯æ¶ˆæ¯ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// org.springframework.cache.interceptor.CacheAspectSupport Object generateKey(CacheOperationContext ctx, Object result) { Object key = ctx.generateKey(result); if (key == null) { throw new IAE("Null key ..." + context.metadata.operation); } // ... return key; }</span></span></code> </pre> <br><p> å› æ­¤ï¼Œé›·åŒºå…·æœ‰è¾¹ç•Œ-è¿™æ˜¯æ•°æ®é‡ï¼Œä½¿ç”¨è¯¥æ–¹æ³•çš„é¢‘ç‡ç­‰å®šé‡æŒ‡æ ‡ï¼Œä¸€æ—¦è¾¾åˆ°æˆ–è¶…è¿‡æ­¤èŒƒå›´ï¼Œè½»å¾®çš„ç¼ºé™·å°±ä¼šåœ¨ç»Ÿè®¡ä¸Šå˜å¾—æ˜¾ç€ã€‚ </p><br><p> å¦ä¸€æ–¹é¢ï¼Œè¿™æ˜¯ä¸€ä¸ªç‰¹æ€§ï¼Œç›¸å¯¹è€Œè¨€ï¼Œä»£ç çš„å¤æ‚æ€§å¹¶ä¸èƒ½å¸¦æ¥æ˜æ˜¾çš„ï¼ˆå¯è¡¡é‡çš„ï¼‰æ”¹è¿›ã€‚ </p><br><p> è¿™æ˜¯å¯¹å¼€å‘äººå‘˜çš„å¦ä¸€ä¸ªç»“è®ºï¼šåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ¬ºéª—æ˜¯é‚ªæ¶çš„ï¼Œä»è€Œå¯¼è‡´ä»£ç æ¯«æ— æ„ä¹‰çš„å¤æ‚åŒ–ã€‚ åœ¨100ä¸ªæ¡ˆä¾‹ä¸­æœ‰99ä¸ªæ¡ˆä¾‹ï¼Œæˆ‘ä»¬ä¸€æ— æ‰€è·ã€‚ </p><br><p> åº”è¯¥è®°ä½ï¼Œæ€»æœ‰ </p><br><h4 id="tot-samyy-sotyy-sluchay"> ä¸€ç™¾ä¾‹ </h4><br><p> è¿™æ˜¯Nitzan Wakartåœ¨ä»–çš„æ–‡ç« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">volatileè¯»å–ä¸­</a>ç»™å‡ºçš„ä»£ç ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@BenchmarkMode</span></span>(Mode.AverageTime) <span class="hljs-meta"><span class="hljs-meta">@OutputTimeUnit</span></span>(TimeUnit.NANOSECONDS) <span class="hljs-meta"><span class="hljs-meta">@State</span></span>(Scope.Thread) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoopyBenchmarks</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Param</span></span>({ <span class="hljs-string"><span class="hljs-string">"32"</span></span>, <span class="hljs-string"><span class="hljs-string">"1024"</span></span>, <span class="hljs-string"><span class="hljs-string">"32768"</span></span> }) <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bunn; <span class="hljs-meta"><span class="hljs-meta">@Setup</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ bunn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[size]; } <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">goodOldLoop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Blackhole fox)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = <span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; bunn.length; y++) { <span class="hljs-comment"><span class="hljs-comment">// good old C style for (the win?) fox.consume(bunn[y]); } } @Benchmark public void sweetLoop(Blackhole fox) { for (byte bunny : bunn) { // syntactic sugar loop goodness fox.consume(bunny); } } }</span></span></code> </pre> <br><p> å»ºç«‹ç»éªŒåï¼Œæˆ‘ä»¬å°†å‘ç°ä¸¤ç§éå†æ•°ç»„çš„æ–¹å¼ä¹‹é—´çš„æƒŠäººå·®å¼‚ï¼š </p><br><pre> <code class="plaintext hljs">Benchmark (size) Score Score error Units goodOldLoop 32 46.630 0.097 ns/op goodOldLoop 1024 1199.338 0.705 ns/op goodOldLoop 32768 37813.600 56.081 ns/op sweetLoop 32 19.304 0.010 ns/op sweetLoop 1024 475.141 1.227 ns/op sweetLoop 32768 14295.800 36.071 ns/op</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæ²¡æœ‰ç»éªŒçš„å¼€å‘äººå‘˜å¯ä»¥å¾—å‡ºè¿™æ ·ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„åŸºå‡†ç»“è®ºï¼šä½¿ç”¨æ–°è¯­æ³•ä¼ é€’æ•°ç»„æ¯”è®¡æ•°å‘¨æœŸæ›´å¿«ã€‚ è¿™æ˜¯é”™è¯¯çš„ç»“è®ºï¼Œå› ä¸ºå€¼å¾—<code>goodOldLoop</code>æ›´æ”¹ä¸€ä¸‹<code>goodOldLoop</code>æ–¹æ³•ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">goodOldLoopReturns</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Blackhole fox)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] sunn = bunn; <span class="hljs-comment"><span class="hljs-comment">// make a local copy of the field for (int y = 0; y &lt; sunn.length; y++) { fox.consume(sunn[y]); } }</span></span></code> </pre> <br><p> å…¶æ€§èƒ½å¯ä¸â€œæ›´å¿«â€çš„<code>sweetLoop</code>æ–¹æ³•ç›¸åª²ç¾ï¼š </p><br><pre> <code class="plaintext hljs">Benchmark (size) Score Score error Units goodOldLoopReturns 32 19.306 0.045 ns/op goodOldLoopReturns 1024 476.493 1.190 ns/op goodOldLoopReturns 32768 14292.286 16.046 ns/op sweetLoop 32 19.304 0.010 ns/op sweetLoop 1024 475.141 1.227 ns/op sweetLoop 32768 14295.800 36.071 ns/op</code> </pre> <br><p>     <code>Blackhole::consume</code> : </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//... public volatile byte b1, b2; public volatile BlackholeL2 nullBait = null; /** * Consume object. This call provides a side effect preventing JIT to eliminate dependent computations. * * @param b object to consume. */ public final void consume(byte b) { if (b == b1 &amp; b == b2) { // SHOULD NEVER HAPPEN nullBait.b1 = b; // implicit null pointer exception } }</span></span></code> </pre> <br><p>         ,    ,      .     <code>goodOldLoop</code>       <code>this.bunn</code>    ,  <code>for-each</code>     ,        (,  Java Concurrency In Practice   "  ").      . </p><br><p>    : "      ?   , <code>Blackhole::consume</code> â€”   JMH       .  ,  ,       ?" </p><br><p>          : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bunn; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">goodOldLoop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Blackhole fox)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = <span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; bunn.length; y++) { fox.consume(bunn[y]); } }</code> </pre> <br><p>   ? ?  ,    : </p><br><pre> <code class="java hljs">E[] bunn; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forEach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Consumer&lt;E&gt; fox)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = <span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; bunn.length; y++) { fox.consume(bunn[y]); } }</code> </pre> <br><p>  <code>Iterable::forEach</code> !        ,   ,        ,       (   JDK 13): </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//ArrayList public void forEach(Consumer&lt;? super E&gt; action) { Objects.requireNonNull(action); final int expectedModCount = modCount; final Object[] es = elementData; final int size = this.size; for (int i = 0; modCount == expectedModCount &amp;&amp; i &lt; size; i++) action.accept(elementAt(es, i)); if (modCount != expectedModCount) throw new ConcurrentModificationException(); } //Arrays$ArrayList public void forEach(Consumer&lt;? super E&gt; action) { Objects.requireNonNull(action); for (E e : a) { action.accept(e); } } //CopyOnWriteArrayList public void forEach(Consumer&lt;? super E&gt; action) { Objects.requireNonNull(action); for (Object x : getArray()) { @SuppressWarnings("unchecked") E e = (E) x; action.accept(e); } } //ArrayDeque public void forEach(Consumer&lt;? super E&gt; action) { Objects.requireNonNull(action); final Object[] es = elements; for (int i = head, end = tail, to = (i &lt;= end) ? end : es.length; ; i = 0, to = end) { for (; i &lt; to; i++) action.accept(elementAt(es, i)); if (to == end) { if (end != tail) throw new ConcurrentModificationException(); break; } } }</span></span></code> </pre> <br><p>     ,          . ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  </a> <code>Collections.nCopies()::forEach</code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forEach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Consumer&lt;? </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">super</span></span></span></span><span class="hljs-function"><span class="hljs-params"> E&gt; action)</span></span></span><span class="hljs-function"> </span></span>{ Objects.requireNonNull(action); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.n; i++) { action.accept(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.element); } }</code> </pre> <br><p>            , . .   <code>this.n</code>  <code>this.element</code>       : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CopiesList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RandomAccess</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> E element; CopiesList(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n, E e) { <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> n &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.n = n; element = e; }</code> </pre> <br><p>  , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">   </a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">   </a> <code>@Stable</code> . </p><br><p>  :  99   100  ,     ,    1   100,             .     ,     . </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">   </a>          "  volatile". </p><br><h4 id="eho-voyny">   </h4><br><p>      ,   : </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//java.lang.Integer @HotSpotIntrinsicCandidate public static Integer valueOf(int i) { if (i &gt;= IntegerCache.low &amp;&amp; i &lt;= IntegerCache.high) return IntegerCache.cache[i + (-IntegerCache.low)]; return new Integer(i); }</span></span></code> </pre> <br><p> -   ,         ( <code>java.lang.Integer</code> , <code>java.lang.Long</code> , <code>java.lang.Short</code> , <code>java.lang.Byte</code> , <code>java.lang.Character</code> ).  ,     ,     </p><br><pre> <code class="java hljs">Integer intgr = Integer.valueOf(<span class="hljs-number"><span class="hljs-number">42</span></span>);</code> </pre> <br><p>    . </p><br><p>      : </p><br><pre> <code class="java hljs">Integer intgr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Integer(<span class="hljs-number"><span class="hljs-number">42</span></span>);</code> </pre> <br><p>        ,         ,       <code>Integer::valueOf</code>   . </p><br><p>         :      .                ,   ,      ""  (         ).   ,        ,         <code>Integer::valueOf</code> .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">"  "</a> . </p><br><p>   . ,              . ,       .      ,    ,      . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN443206/">https://habr.com/ru/post/zh-CN443206/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN443196/index.html">ç¦»çº¿ä¸€åˆ†é’Ÿ-é€‰æ‹©å·¥ä¸šLTEè·¯ç”±å™¨</a></li>
<li><a href="../zh-CN443198/index.html">é©¬å…‹Â·æ‰å…‹ä¼¯æ ¼ï¼ˆMark Zuckerbergï¼‰è¯´ï¼ŒFacebookæ­£åœ¨ç ”ç©¶ä¸€ç§ç”¨äºé˜…è¯»æ€æƒ³çš„ç¥ç»æ¥å£</a></li>
<li><a href="../zh-CN443200/index.html">ä¼Šæœ—é»‘å®¢ä»Citrixçªƒå–äº†TBçš„æ•°æ®</a></li>
<li><a href="../zh-CN443202/index.html">é›†ä¼šåå¯¹å­¤ç«‹çš„Runet</a></li>
<li><a href="../zh-CN443204/index.html">å‰ç«¯æ¯å‘¨æ‘˜è¦ï¼ˆ2019å¹´3æœˆ4æ—¥è‡³10æ—¥ï¼‰</a></li>
<li><a href="../zh-CN443208/index.html">ä¼ä¸šé¼ æ ‡</a></li>
<li><a href="../zh-CN443210/index.html">Reactæ•™ç¨‹ç¬¬21éƒ¨åˆ†ï¼šç¬¬äºŒè¯¾å’Œæ¡ä»¶æ¸²æŸ“ç ”è®¨ä¼š</a></li>
<li><a href="../zh-CN443212/index.html">Reactæ•™ç¨‹ï¼Œç¬¬22éƒ¨åˆ†ï¼šåœ¨TODOåº”ç”¨ç¨‹åºä¸Šå·¥ä½œçš„ç¬¬ä¸ƒé˜¶æ®µï¼Œä»å¤–éƒ¨æºä¸‹è½½æ•°æ®</a></li>
<li><a href="../zh-CN443214/index.html">Reactæ•™ç¨‹ç¬¬23éƒ¨åˆ†ï¼šç¬¬ä¸€ä¸ªè¡¨å•è¯¾ç¨‹</a></li>
<li><a href="../zh-CN443216/index.html">ä¸Šå‘¨ç¬¬355æœŸæ¥è‡ªå‰ç«¯ä¸–ç•Œçš„æ–°é²œææ–™æ‘˜è¦ï¼ˆ2019å¹´3æœˆ4æ—¥è‡³10æ—¥ï¼‰</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>