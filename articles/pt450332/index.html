<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéì ‚ö±Ô∏è üß¢ Como a renderiza√ß√£o de The Witcher 3 √© implementada: raios, estilo do bruxo e outros efeitos ‚ôæ üë∑üèª ü§≥üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Parte 1. Z√≠peres 
 Nesta parte, veremos o processo de renderiza√ß√£o de raios em Witcher 3: Wild Hunt. 

 A renderiza√ß√£o de raio √© realizada um pouco de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como a renderiza√ß√£o de The Witcher 3 √© implementada: raios, estilo do bruxo e outros efeitos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450332/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/abf/ce7/1c4/abfce71c4469b6dcd077723d498c1685.jpg" alt="imagem"></div><br><h2>  Parte 1. Z√≠peres </h2><br>  Nesta parte, veremos o processo de renderiza√ß√£o de raios em Witcher 3: Wild Hunt. <br><br>  A renderiza√ß√£o de raio √© realizada um pouco depois do efeito da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cortina de chuva</a> , mas ainda ocorre no passe de renderiza√ß√£o direta.  Rel√¢mpagos podem ser vistos neste v√≠deo: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/VXt4PEEqV2k" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Eles desaparecem muito rapidamente, por isso √© melhor assistir ao v√≠deo a uma velocidade de 0,25. <br><br>  Voc√™ pode ver que essas n√£o s√£o imagens est√°ticas;  com o tempo, o brilho muda um pouco. <br><br>  Em termos de renderiza√ß√£o de nuances, h√° muitas semelhan√ßas com o desenho de uma cortina de chuva √† dist√¢ncia, por exemplo, os mesmos estados de mesclagem (mesclagem aditiva) e profundidade (a verifica√ß√£o √© ativada, a grava√ß√£o de profundidade n√£o √© executada). <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4ba/7e1/f20/4ba7e1f2075dc128baf8b717eeb3ce92.jpg"></div><br>  <i>Cena sem raio</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3dd/37a/e59/3dd37ae5986de4621766f4fc64525906.jpg"></div><br>  <i>Cena rel√¢mpago</i> <br><br>  Em termos de geometria do raio, The Witcher 3 √© uma malha semelhante a uma √°rvore.  Este exemplo de raio √© representado pela seguinte malha: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5b7/23c/3dc/5b723c3dc1f934c0f6c14903e2a260cf.jpg"></div><br>  Possui coordenadas UV e vetores normais.  Tudo isso √© √∫til no est√°gio de vertex shader. <br><br><h3>  Sombreador de v√©rtice </h3><br>  Vamos dar uma olhada no c√≥digo do shader de v√©rtices montado: <br><br><pre><code class="cpp hljs">vs_5_0 dcl_globalFlags refactoringAllowed dcl_constantbuffer cb1[<span class="hljs-number"><span class="hljs-number">9</span></span>], immediateIndexed dcl_constantbuffer cb2[<span class="hljs-number"><span class="hljs-number">6</span></span>], immediateIndexed dcl_input v0.xyz dcl_input v1.xy dcl_input v2.xyz dcl_input v4.xyzw dcl_input v5.xyzw dcl_input v6.xyzw dcl_input v7.xyzw dcl_output o0.xy dcl_output o1.xyzw dcl_output_siv o2.xyzw, position dcl_temps <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: mov o0.xy, v1.xyxx <span class="hljs-number"><span class="hljs-number">1</span></span>: mov o1.xyzw, v7.xyzw <span class="hljs-number"><span class="hljs-number">2</span></span>: mul r0.xyzw, v5.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].yyyy <span class="hljs-number"><span class="hljs-number">3</span></span>: mad r0.xyzw, v4.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].xxxx, r0.xyzw <span class="hljs-number"><span class="hljs-number">4</span></span>: mad r0.xyzw, v6.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].zzzz, r0.xyzw <span class="hljs-number"><span class="hljs-number">5</span></span>: mad r0.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r0.xyzw <span class="hljs-number"><span class="hljs-number">6</span></span>: mov r1.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>: mad r1.xyz, v0.xyzx, cb2[<span class="hljs-number"><span class="hljs-number">4</span></span>].xyzx, cb2[<span class="hljs-number"><span class="hljs-number">5</span></span>].xyzx <span class="hljs-number"><span class="hljs-number">8</span></span>: dp4 r2.x, r1.xyzw, v4.xyzw <span class="hljs-number"><span class="hljs-number">9</span></span>: dp4 r2.y, r1.xyzw, v5.xyzw <span class="hljs-number"><span class="hljs-number">10</span></span>: dp4 r2.z, r1.xyzw, v6.xyzw <span class="hljs-number"><span class="hljs-number">11</span></span>: add r2.xyz, r2.xyzx, -cb1[<span class="hljs-number"><span class="hljs-number">8</span></span>].xyzx <span class="hljs-number"><span class="hljs-number">12</span></span>: dp3 r1.w, r2.xyzx, r2.xyzx <span class="hljs-number"><span class="hljs-number">13</span></span>: rsq r1.w, r1.w <span class="hljs-number"><span class="hljs-number">14</span></span>: div r1.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r1.w <span class="hljs-number"><span class="hljs-number">15</span></span>: mul r1.w, r1.w, l(<span class="hljs-number"><span class="hljs-number">0.000001</span></span>) <span class="hljs-number"><span class="hljs-number">16</span></span>: mad r2.xyz, v2.xyzx, l(<span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), l(<span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">17</span></span>: mad r1.xyz, r2.xyzx, r1.wwww, r1.xyzx <span class="hljs-number"><span class="hljs-number">18</span></span>: mov r1.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">19</span></span>: dp4 o2.x, r1.xyzw, r0.xyzw <span class="hljs-number"><span class="hljs-number">20</span></span>: mul r0.xyzw, v5.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].yyyy <span class="hljs-number"><span class="hljs-number">21</span></span>: mad r0.xyzw, v4.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].xxxx, r0.xyzw <span class="hljs-number"><span class="hljs-number">22</span></span>: mad r0.xyzw, v6.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].zzzz, r0.xyzw <span class="hljs-number"><span class="hljs-number">23</span></span>: mad r0.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r0.xyzw <span class="hljs-number"><span class="hljs-number">24</span></span>: dp4 o2.y, r1.xyzw, r0.xyzw <span class="hljs-number"><span class="hljs-number">25</span></span>: mul r0.xyzw, v5.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].yyyy <span class="hljs-number"><span class="hljs-number">26</span></span>: mad r0.xyzw, v4.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].xxxx, r0.xyzw <span class="hljs-number"><span class="hljs-number">27</span></span>: mad r0.xyzw, v6.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].zzzz, r0.xyzw <span class="hljs-number"><span class="hljs-number">28</span></span>: mad r0.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r0.xyzw <span class="hljs-number"><span class="hljs-number">29</span></span>: dp4 o2.z, r1.xyzw, r0.xyzw <span class="hljs-number"><span class="hljs-number">30</span></span>: mul r0.xyzw, v5.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].yyyy <span class="hljs-number"><span class="hljs-number">31</span></span>: mad r0.xyzw, v4.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].xxxx, r0.xyzw <span class="hljs-number"><span class="hljs-number">32</span></span>: mad r0.xyzw, v6.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].zzzz, r0.xyzw <span class="hljs-number"><span class="hljs-number">33</span></span>: mad r0.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r0.xyzw <span class="hljs-number"><span class="hljs-number">34</span></span>: dp4 o2.w, r1.xyzw, r0.xyzw <span class="hljs-number"><span class="hljs-number">35</span></span>: ret</code> </pre> <br>  Existem muitas semelhan√ßas com a cortina de chuva do vertex shader, ent√£o n√£o vou repetir.  Quero mostrar a diferen√ßa importante que est√° nas linhas 11 a 18: <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">11</span></span>: add r2.xyz, r2.xyzx, -cb1[<span class="hljs-number"><span class="hljs-number">8</span></span>].xyzx <span class="hljs-number"><span class="hljs-number">12</span></span>: dp3 r1.w, r2.xyzx, r2.xyzx <span class="hljs-number"><span class="hljs-number">13</span></span>: rsq r1.w, r1.w <span class="hljs-number"><span class="hljs-number">14</span></span>: div r1.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r1.w <span class="hljs-number"><span class="hljs-number">15</span></span>: mul r1.w, r1.w, l(<span class="hljs-number"><span class="hljs-number">0.000001</span></span>) <span class="hljs-number"><span class="hljs-number">16</span></span>: mad r2.xyz, v2.xyzx, l(<span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), l(<span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">17</span></span>: mad r1.xyz, r2.xyzx, r1.wwww, r1.xyzx <span class="hljs-number"><span class="hljs-number">18</span></span>: mov r1.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">19</span></span>: dp4 o2.x, r1.xyzw, r0.xyzw</code> </pre> <br>  Em primeiro lugar, cb1 [8] .xyz √© a posi√ß√£o da c√¢mera e r2.xyz √© a posi√ß√£o no espa√ßo do mundo, ou seja, a linha 11 calcula o vetor da c√¢mera para a posi√ß√£o no mundo.  As linhas 12-15 calculam o <i>comprimento (worldPos - cameraPos) * 0.000001.</i> <br><br>  v2.xyz √© o vetor normal da geometria de entrada.  A linha 16 a estende do intervalo [0-1] para o intervalo [-1; 1]. <br><br>  Ent√£o a posi√ß√£o final no mundo √© calculada: <br><br>  <i>finalWorldPos = worldPos + comprimento (worldPos - cameraPos) * 0.000001 * normalVector</i> <br>  O trecho de c√≥digo HLSL para esta opera√ß√£o ser√° algo como isto: <br><br><pre> <code class="cpp hljs"> ... <span class="hljs-comment"><span class="hljs-comment">// final world-space position float3 vNormal = Input.NormalW * 2.0 - 1.0; float lencameratoworld = length( PositionL - g_cameraPos.xyz) * 0.000001; PositionL += vNormal*lencameratoworld; // SV_Posiiton float4x4 matModelViewProjection = mul(g_viewProjMatrix, matInstanceWorld ); Output.PositionH = mul( float4(PositionL, 1.0), transpose(matModelViewProjection) ); return Output;</span></span></code> </pre> <br>  Esta opera√ß√£o resulta em uma pequena ‚Äúexplos√£o‚Äù da malha (na dire√ß√£o do vetor normal).  Eu experimentei substituindo 0,000001 por v√°rios outros valores.  Aqui est√£o os resultados: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6f1/dca/ddb/6f1dcaddbdcd0f6e3c957cd8d2a1121b.jpg"></div><br>  <i>0,000002</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/609/289/c37/609289c37cea41590ffcb94beebae7e5.jpg"></div><br>  <i>0,000005</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/56a/d36/09c/56ad3609c6bbe28990bc8894b163c50d.jpg"></div><br>  <i>0,00001</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/71b/e90/b04/71be90b04a538e953b4a0ee0d4ce2912.jpg"></div><br>  <i>0,000025</i> <br><br><h3>  Pixel shader </h3><br>  Bem, n√≥s descobrimos o shader de v√©rtice, agora √© hora de descer ao c√≥digo do assembler para o shader de pixel! <br><br><pre> <code class="cpp hljs"> ps_5_0 dcl_globalFlags refactoringAllowed dcl_constantbuffer cb0[<span class="hljs-number"><span class="hljs-number">1</span></span>], immediateIndexed dcl_constantbuffer cb2[<span class="hljs-number"><span class="hljs-number">3</span></span>], immediateIndexed dcl_constantbuffer cb4[<span class="hljs-number"><span class="hljs-number">5</span></span>], immediateIndexed dcl_input_ps linear v0.x dcl_input_ps linear v1.w dcl_output o0.xyzw dcl_temps <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: mad r0.x, cb0[<span class="hljs-number"><span class="hljs-number">0</span></span>].x, cb4[<span class="hljs-number"><span class="hljs-number">4</span></span>].x, v0.x <span class="hljs-number"><span class="hljs-number">1</span></span>: add r0.y, r0.x, l(<span class="hljs-number"><span class="hljs-number">-1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">2</span></span>: round_ni r0.y, r0.y <span class="hljs-number"><span class="hljs-number">3</span></span>: ishr r0.z, r0.y, l(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">4</span></span>: xor r0.y, r0.y, r0.z <span class="hljs-number"><span class="hljs-number">5</span></span>: imul null, r0.z, r0.y, r0.y <span class="hljs-number"><span class="hljs-number">6</span></span>: imad r0.z, r0.z, l(<span class="hljs-number"><span class="hljs-number">0x0000ec4d</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>: imad r0.y, r0.y, r0.z, l(<span class="hljs-number"><span class="hljs-number">146956042240.000000</span></span>) <span class="hljs-number"><span class="hljs-number">8</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r0.y, r0.y, l(<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>) <span class="hljs-number"><span class="hljs-number">9</span></span>: round_ni r0.z, r0.x <span class="hljs-number"><span class="hljs-number">10</span></span>: frc r0.x, r0.x <span class="hljs-number"><span class="hljs-number">11</span></span>: add r0.x, -r0.x, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">12</span></span>: ishr r0.w, r0.z, l(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">13</span></span>: xor r0.z, r0.z, r0.w <span class="hljs-number"><span class="hljs-number">14</span></span>: imul null, r0.w, r0.z, r0.z <span class="hljs-number"><span class="hljs-number">15</span></span>: imad r0.w, r0.w, l(<span class="hljs-number"><span class="hljs-number">0x0000ec4d</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span>) <span class="hljs-number"><span class="hljs-number">16</span></span>: imad r0.z, r0.z, r0.w, l(<span class="hljs-number"><span class="hljs-number">146956042240.000000</span></span>) <span class="hljs-number"><span class="hljs-number">17</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r0.z, r0.z, l(<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>) <span class="hljs-number"><span class="hljs-number">18</span></span>: itof r0.yz, r0.yyzy <span class="hljs-number"><span class="hljs-number">19</span></span>: mul r0.z, r0.z, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>) <span class="hljs-number"><span class="hljs-number">20</span></span>: mad r0.y, r0.y, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>), -r0.z <span class="hljs-number"><span class="hljs-number">21</span></span>: mul r0.w, r0.x, r0.x <span class="hljs-number"><span class="hljs-number">22</span></span>: mul r0.x, r0.x, r0.w <span class="hljs-number"><span class="hljs-number">23</span></span>: mul r0.w, r0.w, l(<span class="hljs-number"><span class="hljs-number">3.000000</span></span>) <span class="hljs-number"><span class="hljs-number">24</span></span>: mad r0.x, r0.x, l(<span class="hljs-number"><span class="hljs-number">-2.000000</span></span>), r0.w <span class="hljs-number"><span class="hljs-number">25</span></span>: mad r0.x, r0.x, r0.y, r0.z <span class="hljs-number"><span class="hljs-number">26</span></span>: add r0.y, -cb4[<span class="hljs-number"><span class="hljs-number">2</span></span>].x, cb4[<span class="hljs-number"><span class="hljs-number">3</span></span>].x <span class="hljs-number"><span class="hljs-number">27</span></span>: mad_sat r0.x, r0.x, r0.y, cb4[<span class="hljs-number"><span class="hljs-number">2</span></span>].x <span class="hljs-number"><span class="hljs-number">28</span></span>: mul r0.x, r0.x, v1.w <span class="hljs-number"><span class="hljs-number">29</span></span>: mul r0.yzw, cb4[<span class="hljs-number"><span class="hljs-number">0</span></span>].xxxx, cb4[<span class="hljs-number"><span class="hljs-number">1</span></span>].xxyz <span class="hljs-number"><span class="hljs-number">30</span></span>: mul r0.xyzw, r0.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">2</span></span>].wxyz <span class="hljs-number"><span class="hljs-number">31</span></span>: mul o0.xyz, r0.xxxx, r0.yzwy <span class="hljs-number"><span class="hljs-number">32</span></span>: mov o0.w, r0.x <span class="hljs-number"><span class="hljs-number">33</span></span>: ret</code> </pre> <br>  Boas not√≠cias: o c√≥digo n√£o √© t√£o longo. <br><br>  M√°s not√≠cias: <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">3</span></span>: ishr r0.z, r0.y, l(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">4</span></span>: xor r0.y, r0.y, r0.z <span class="hljs-number"><span class="hljs-number">5</span></span>: imul null, r0.z, r0.y, r0.y <span class="hljs-number"><span class="hljs-number">6</span></span>: imad r0.z, r0.z, l(<span class="hljs-number"><span class="hljs-number">0x0000ec4d</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>: imad r0.y, r0.y, r0.z, l(<span class="hljs-number"><span class="hljs-number">146956042240.000000</span></span>) <span class="hljs-number"><span class="hljs-number">8</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r0.y, r0.y, l(<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>)</code> </pre> <br>  ... do que se trata? <br><br>  Honestamente, essa n√£o √© a primeira vez que eu vejo uma pe√ßa desse tipo ... de c√≥digo assembler nos shaders do Witcher 3.  Mas quando o conheci pela primeira vez, pensei: "Que diabos √© isso?" <br><br>  Algo semelhante pode ser encontrado em alguns outros shaders TW3.  N√£o descreverei minhas aventuras com esse fragmento e apenas digo que a resposta est√° no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ru√≠do inteiro</a> : <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// For more details see: http://libnoise.sourceforge.net/noisegen/ float integerNoise( int n ) { n = (n &gt;&gt; 13) ^ n; int nn = (n * (n * n * 60493 + 19990303) + 1376312589) &amp; 0x7fffffff; return ((float)nn / 1073741824.0); }</span></span></code> </pre> <br>  Como voc√™ pode ver, no pixel shader √© chamado duas vezes.  Usando os guias deste site, podemos entender como o ru√≠do suave √© implementado corretamente.  Voltarei a isso em um minuto. <br><br>  Veja a linha 0 - aqui estamos animando com base na seguinte f√≥rmula: <br><br>  <i>animation = elapsedTime * animationSpeed ‚Äã‚Äã+ TextureUV.x</i> <br>  Esses valores, ap√≥s o arredondamento para o lado inferior ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">piso</a> ) (instru√ß√£o <i>round_ni</i> ) no futuro, se tornam pontos de entrada para ru√≠do inteiro.  Geralmente calculamos o valor do ru√≠do para dois n√∫meros inteiros e, em seguida, calculamos o valor final interpolado entre eles (consulte o site da libnoise para obter detalhes). <br><br>  Bem, esse √© <b>um</b> ru√≠do <b>inteiro</b> , mas, afinal, todos os valores mencionados anteriormente (tamb√©m arredondados para baixo) s√£o flutuantes! <br><br>  Observe que n√£o h√° instru√ß√µes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ftoi aqui</a> .  Suponho que os programadores da CD Projekt Red usaram a fun√ß√£o interna HLSL <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">como aqui</a> , que executa a convers√£o de valores de ponto flutuante "reinterpret_cast" e os trata como um padr√£o inteiro. <br><br>  O peso de interpola√ß√£o para os dois valores √© calculado nas linhas 10-11. <br><br>  <i>interpolationWeight = 1.0 - frac (anima√ß√£o);</i> <br>  Essa abordagem nos permite interpolar entre valores ao longo do tempo. <br><br>  Para criar um ru√≠do suave, esse interpolador √© passado para a fun√ß√£o <b>SCurve</b> : <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s_curve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x2 = x * x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x3 = x2 * x; <span class="hljs-comment"><span class="hljs-comment">// -2x^3 + 3x^2 return -2.0*x3 + 3.0*x2; }</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/15a/5d0/48e/15a5d048e4fcf9b12c51cad50d7bfc3e.png"></div><br>  <i>Fun√ß√£o Smoothstep [libnoise.sourceforge.net]</i> <br><br>  Esse recurso √© conhecido como "passo suave".  Por√©m, como voc√™ pode ver no c√≥digo do assembler, essa <b>n√£o</b> √© <b>uma</b> fun√ß√£o de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">passo suave</a> do HLSL.  Uma fun√ß√£o interna aplica restri√ß√µes para que os valores sejam verdadeiros.  Mas como sabemos que o <i>interpolationWeight</i> sempre estar√° no intervalo [0-1], essas verifica√ß√µes podem ser ignoradas com seguran√ßa. <br><br>  Ao calcular o valor final, v√°rias opera√ß√µes de multiplica√ß√£o s√£o usadas.  Veja como a sa√≠da alfa final pode mudar dependendo do valor do ru√≠do.  Isso √© conveniente porque afetar√° a opacidade do raio renderizado, assim como na vida real. <br><br>  Shader de pixel pronto: <br><br><pre> <code class="cpp hljs"> cbuffer cbPerFrame : <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> (b0) { float4 cb0_v0; float4 cb0_v1; float4 cb0_v2; float4 cb0_v3; } cbuffer cbPerFrame : <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> (b2) { float4 cb2_v0; float4 cb2_v1; float4 cb2_v2; float4 cb2_v3; } cbuffer cbPerFrame : <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> (b4) { float4 cb4_v0; float4 cb4_v1; float4 cb4_v2; float4 cb4_v3; float4 cb4_v4; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VS_OUTPUT</span></span></span><span class="hljs-class"> {</span></span> float2 Texcoords : Texcoord0; float4 InstanceLODParams : INSTANCE_LOD_PARAMS; float4 PositionH : SV_Position; }; <span class="hljs-comment"><span class="hljs-comment">// Shaders in TW3 use integer noise. // For more details see: http://libnoise.sourceforge.net/noisegen/ float integerNoise( int n ) { n = (n &gt;&gt; 13) ^ n; int nn = (n * (n * n * 60493 + 19990303) + 1376312589) &amp; 0x7fffffff; return ((float)nn / 1073741824.0); } float s_curve( float x ) { float x2 = x * x; float x3 = x2 * x; // -2x^3 + 3x^2 return -2.0*x3 + 3.0*x2; } float4 Lightning_TW3_PS( in VS_OUTPUT Input ) : SV_Target { // * Inputs float elapsedTime = cb0_v0.x; float animationSpeed = cb4_v4.x; float minAmount = cb4_v2.x; float maxAmount = cb4_v3.x; float colorMultiplier = cb4_v0.x; float3 colorFilter = cb4_v1.xyz; float3 lightningColorRGB = cb2_v2.rgb; // Animation using time and X texcoord float animation = elapsedTime * animationSpeed + Input.Texcoords.x; // Input parameters for Integer Noise. // They are floored and please note there are using asint. // That might be an optimization to avoid "ftoi" instructions. int intX0 = asint( floor(animation) ); int intX1 = asint( floor(animation-1.0) ); float n0 = integerNoise( intX0 ); float n1 = integerNoise( intX1 ); // We interpolate "backwards" here. float weight = 1.0 - frac(animation); // Following the instructions from libnoise, we perform // smooth interpolation here with cubic s-curve function. float noise = lerp( n0, n1, s_curve(weight) ); // Make sure we are in [0.0 - 1.0] range. float lightningAmount = saturate( lerp(minAmount, maxAmount, noise) ); lightningAmount *= Input.InstanceLODParams.w; // 1.0 lightningAmount *= cb2_v2.w; // 1.0 // Calculate final lightning color float3 lightningColor = colorMultiplier * colorFilter; lightningColor *= lighntingColorRGB; float3 finalLightningColor = lightningColor * lightningAmount; return float4( finalLightningColor, lightningAmount ); }</span></span></code> </pre> <br><h3>  Resumir </h3><br>  Nesta parte, descrevi uma maneira de renderizar raios em The Witcher 3. <br><br>  Estou muito satisfeito por o c√≥digo do assembler que saiu do meu shader corresponder completamente ao original! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/25c/708/e50/25c708e503f4528c313c557abb080222.jpg"></div><br><h2>  Parte 2. Truques do c√©u bobo </h2><br>  Esta parte ser√° um pouco diferente das anteriores.  Nele, quero mostrar alguns aspectos do sombreador do c√©u Witcher 3. <br><br>  Por que "truques bobos" e n√£o todo o shader?  Bem, h√° v√°rias raz√µes.  Em primeiro lugar, o sombreador de c√©u Witcher 3 √© um animal bastante complexo.  O sombreador de pixel da vers√£o 2015 cont√©m 267 linhas de c√≥digo assembler e o sombreador do DLC Blood and Wine cont√©m 385 linhas. <br><br>  Al√©m disso, eles recebem muita entrada, o que n√£o √© muito prop√≠cio para a engenharia reversa do c√≥digo HLSL completo (e leg√≠vel!). <br><br>  Portanto, decidi mostrar apenas parte dos truques desses shaders.  Se eu encontrar algo novo, complementarei a postagem. <br><br>  As diferen√ßas entre a vers√£o de 2015 e o DLC (2016) s√£o muito vis√≠veis.  Em particular, eles incluem diferen√ßas no c√°lculo das estrelas e sua cintila√ß√£o, uma abordagem diferente para renderizar o Sol ... <i>O</i> shader <i>Blood and Wine</i> calcula at√© a Via L√°ctea √† noite. <br><br>  Vou come√ßar com o b√°sico e depois falar sobre truques est√∫pidos. <br><br><h3>  O b√°sico </h3><br>  Como a maioria dos jogos modernos, o Witcher 3 usa o skydome para modelar o c√©u.  Veja o hemisf√©rio usado para isso em Witcher 3 (2015).  Nota: neste caso, a caixa delimitadora dessa malha est√° na faixa de [0,0,0] a [1,1,1] (Z √© o eixo apontando para cima) e possui UVs distribu√≠dos suavemente.  Depois n√≥s os usamos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3cf/49a/34d/3cf49a34dead2ff2e6f2542487edbf65.jpg"></div><br>  A id√©ia por tr√°s do skydome √© semelhante √† id√©ia do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">skybox</a> (a √∫nica diferen√ßa √© a malha usada).  No est√°gio de v√©rtice, transformamos o skydome em rela√ß√£o ao observador (geralmente de acordo com a posi√ß√£o da c√¢mera), o que cria a ilus√£o de que o c√©u est√° realmente muito distante - nunca chegaremos a ele. <br><br>  Se voc√™ leu as partes anteriores desta s√©rie de artigos, sabe que o "The Witcher 3" usa a profundidade inversa, ou seja, o plano distante √© 0,0f e o plano mais pr√≥ximo √© 1,0f.  Para que a sa√≠da do skydome seja totalmente executada no plano remoto, nos par√¢metros da janela de navega√ß√£o, definimos <i>MinDepth com</i> o mesmo valor que <i>MaxDepth</i> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2d7/34f/931/2d734f931c687dde42e3bb549a695764.jpg"></div><br>  Para saber como os <i>campos MinDepth</i> e <i>MaxDepth</i> s√£o usados ‚Äã‚Äãdurante a convers√£o da janela de navega√ß√£o, clique <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> (docs.microsoft.com). <br><br><h3>  Sombreador de v√©rtice </h3><br>  Vamos come√ßar com o vertex shader.  Em Witcher 3 (2015), o c√≥digo do shader do assembler √© o seguinte: <br><br><pre> <code class="cpp hljs"> vs_5_0 dcl_globalFlags refactoringAllowed dcl_constantbuffer cb1[<span class="hljs-number"><span class="hljs-number">4</span></span>], immediateIndexed dcl_constantbuffer cb2[<span class="hljs-number"><span class="hljs-number">6</span></span>], immediateIndexed dcl_input v0.xyz dcl_input v1.xy dcl_output o0.xy dcl_output o1.xyz dcl_output_siv o2.xyzw, position dcl_temps <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: mov o0.xy, v1.xyxx <span class="hljs-number"><span class="hljs-number">1</span></span>: mad r0.xyz, v0.xyzx, cb2[<span class="hljs-number"><span class="hljs-number">4</span></span>].xyzx, cb2[<span class="hljs-number"><span class="hljs-number">5</span></span>].xyzx <span class="hljs-number"><span class="hljs-number">2</span></span>: mov r0.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">3</span></span>: dp4 o1.x, r0.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">4</span></span>: dp4 o1.y, r0.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">1</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">5</span></span>: dp4 o1.z, r0.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">6</span></span>: mul r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].yyyy, cb2[<span class="hljs-number"><span class="hljs-number">1</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">7</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].xxxx, r1.xyzw <span class="hljs-number"><span class="hljs-number">8</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].zzzz, r1.xyzw <span class="hljs-number"><span class="hljs-number">9</span></span>: mad r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r1.xyzw <span class="hljs-number"><span class="hljs-number">10</span></span>: dp4 o2.x, r0.xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">11</span></span>: mul r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].yyyy, cb2[<span class="hljs-number"><span class="hljs-number">1</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">12</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].xxxx, r1.xyzw <span class="hljs-number"><span class="hljs-number">13</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].zzzz, r1.xyzw <span class="hljs-number"><span class="hljs-number">14</span></span>: mad r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r1.xyzw <span class="hljs-number"><span class="hljs-number">15</span></span>: dp4 o2.y, r0.xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">16</span></span>: mul r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].yyyy, cb2[<span class="hljs-number"><span class="hljs-number">1</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">17</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].xxxx, r1.xyzw <span class="hljs-number"><span class="hljs-number">18</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].zzzz, r1.xyzw <span class="hljs-number"><span class="hljs-number">19</span></span>: mad r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r1.xyzw <span class="hljs-number"><span class="hljs-number">20</span></span>: dp4 o2.z, r0.xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">21</span></span>: mul r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].yyyy, cb2[<span class="hljs-number"><span class="hljs-number">1</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">22</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].xxxx, r1.xyzw <span class="hljs-number"><span class="hljs-number">23</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].zzzz, r1.xyzw <span class="hljs-number"><span class="hljs-number">24</span></span>: mad r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r1.xyzw <span class="hljs-number"><span class="hljs-number">25</span></span>: dp4 o2.w, r0.xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">26</span></span>: ret</code> </pre> <br>  Nesse caso, o sombreador de v√©rtice transfere apenas cabos de texto e uma posi√ß√£o no espa√ßo mundial para a sa√≠da.  Em <i>Blood and Wine,</i> ele tamb√©m exibe um vetor normal normalizado.  Vou considerar a vers√£o de 2015 porque √© mais simples. <br><br>  Veja o buffer constante designado como <b>cb2</b> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/360/38d/fc6/36038dfc67c29ef2934d96314ed46aff.jpg"></div><br>  Aqui temos uma matriz do mundo (escala uniforme de 100 e transfer√™ncia em rela√ß√£o √† posi√ß√£o da c√¢mera).  Nada complicado.  cb2_v4 e cb2_v5 s√£o os fatores de escala / desvio usados ‚Äã‚Äãpara converter as posi√ß√µes dos v√©rtices do intervalo [0-1] para o intervalo [-1; 1].  Mas aqui, esses coeficientes "comprimem" o eixo Z (para cima). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7e9/774/4c2/7e97744c28b0997b0b11049bee26fa7b.jpg"></div><br>  Nas partes anteriores da s√©rie, tivemos shaders de v√©rtice semelhantes.  O algoritmo geral √© transferir mais cabos de texto, ent√£o <i>Posi√ß√£o √©</i> calculada levando em considera√ß√£o os coeficientes de escala / desvio, Posi√ß√£oW <i>√©</i> calculada no espa√ßo mundial, ent√£o a posi√ß√£o final do espa√ßo de recorte √© calculada multiplicando <i>matWorld</i> e <i>matViewProj</i> -&gt; seu produto √© usado para multiplicar por <i>Posi√ß√£o</i> para obter a SV_Position final . <br><br>  Portanto, o HLSL desse vertex shader deve ser algo como isto: <br><br><pre> <code class="cpp hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InputStruct</span></span></span><span class="hljs-class"> {</span></span> float3 param0 : POSITION; float2 param1 : TEXCOORD; float3 param2 : NORMAL; float4 param3 : TANGENT; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OutputStruct</span></span></span><span class="hljs-class"> {</span></span> float2 param0 : TEXCOORD0; float3 param1 : TEXCOORD1; float4 param2 : SV_Position; }; <span class="hljs-function"><span class="hljs-function">OutputStruct </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EditedShaderVS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(in InputStruct IN)</span></span></span><span class="hljs-function"> </span></span>{ OutputStruct OUT = (OutputStruct)<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Simple texcoords passing OUT.param0 = IN.param1; // * Manually construct world and viewProj martices from float4s: row_major matrix matWorld = matrix(cb2_v0, cb2_v1, cb2_v2, float4(0,0,0,1) ); matrix matViewProj = matrix(cb1_v0, cb1_v1, cb1_v2, cb1_v3); // * Some optional fun with worldMatrix // a) Scale //matWorld._11 = matWorld._22 = matWorld._33 = 0.225f; // b) Translate // XYZ //matWorld._14 = 520.0997; //matWorld._24 = 74.4226; //matWorld._34 = 113.9; // Local space - note the scale+bias here! //float3 meshScale = float3(2.0, 2.0, 2.0); //float3 meshBias = float3(-1.0, -1.0, -0.4); float3 meshScale = cb2_v4.xyz; float3 meshBias = cb2_v5.xyz; float3 Position = IN.param0 * meshScale + meshBias; // World space float4 PositionW = mul(float4(Position, 1.0), transpose(matWorld) ); OUT.param1 = PositionW.xyz; // Clip space - original approach from The Witcher 3 matrix matWorldViewProj = mul(matViewProj, matWorld); OUT.param2 = mul( float4(Position, 1.0), transpose(matWorldViewProj) ); return OUT; }</span></span></code> </pre> <br>  Compara√ß√£o do meu sombreador (esquerda) e do original (direita): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fd9/ed7/de2/fd9ed7de275ba36551e7751e1d351b8c.jpg"></div><br>  Uma excelente propriedade do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RenderDoc</a> √© que ele permite injetar nosso pr√≥prio shader em vez do original, e essas altera√ß√µes afetar√£o o pipeline at√© o final do quadro.  Como voc√™ pode ver no c√≥digo HLSL, forneci v√°rias op√ß√µes para aplicar zoom e transformar a geometria final.  Voc√™ pode experimentar com eles e obter resultados muito engra√ßados: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0a5/350/e14/0a5350e14231505c0ff1bd5cbf384e15.jpg"></div><br><h4>  Otimiza√ß√£o de vertex shader </h4><br>  Voc√™ percebeu o problema do vertex shader original?  A multiplica√ß√£o de v√©rtices de uma matriz por uma matriz √© completamente redundante!  Encontrei isso em pelo menos alguns shaders de v√©rtice (por exemplo, no shader, uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cortina de chuva √† dist√¢ncia</a> ).  Podemos otimiz√°-lo multiplicando imediatamente o <i>PositionW</i> pelo <i>matViewProj</i> ! <br><br>  Portanto, podemos substituir esse c√≥digo pelo HLSL: <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// Clip space - original approach from The Witcher 3 matrix matWorldViewProj = mul(matViewProj, matWorld); OUT.param2 = mul( float4(Position, 1.0), transpose(matWorldViewProj) );</span></span></code> </pre> <br>  da seguinte maneira: <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// Clip space - optimized version OUT.param2 = mul( matViewProj, PositionW );</span></span></code> </pre> <br>  A vers√£o otimizada nos fornece o seguinte c√≥digo de montagem: <br><br><pre> <code class="cpp hljs"> vs_5_0 dcl_globalFlags refactoringAllowed dcl_constantbuffer CB1[<span class="hljs-number"><span class="hljs-number">4</span></span>], immediateIndexed dcl_constantbuffer CB2[<span class="hljs-number"><span class="hljs-number">6</span></span>], immediateIndexed dcl_input v0.xyz dcl_input v1.xy dcl_output o0.xy dcl_output o1.xyz dcl_output_siv o2.xyzw, position dcl_temps <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: mov o0.xy, v1.xyxx <span class="hljs-number"><span class="hljs-number">1</span></span>: mad r0.xyz, v0.xyzx, cb2[<span class="hljs-number"><span class="hljs-number">4</span></span>].xyzx, cb2[<span class="hljs-number"><span class="hljs-number">5</span></span>].xyzx <span class="hljs-number"><span class="hljs-number">2</span></span>: mov r0.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">3</span></span>: dp4 r1.x, r0.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">4</span></span>: dp4 r1.y, r0.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">1</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">5</span></span>: dp4 r1.z, r0.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">6</span></span>: mov o1.xyz, r1.xyzx <span class="hljs-number"><span class="hljs-number">7</span></span>: mov r1.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">8</span></span>: dp4 o2.x, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">9</span></span>: dp4 o2.y, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">10</span></span>: dp4 o2.z, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">11</span></span>: dp4 o2.w, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">12</span></span>: ret</code> </pre> <br>  Como voc√™ pode ver, reduzimos o n√∫mero de instru√ß√µes de 26 para 12 - uma mudan√ßa bastante significativa.  Eu n√£o sei o qu√£o difundido esse problema est√° no jogo, mas, pelo amor de Deus, o CD Projekt Red, talvez lan√ßar um patch?  :) <br><br>  E eu n√£o estou brincando.  Voc√™ pode inserir meu shader otimizado em vez do RenderDoc original e ver√° que essa otimiza√ß√£o n√£o afeta visualmente nada.  Honestamente, eu n√£o entendo por que o CD Projekt Red decidiu realizar a multiplica√ß√£o de v√©rtices de uma matriz por uma matriz ... <br><br><h3>  O sol </h3><br>  Em The Witcher 3 (2015), o c√°lculo da dispers√£o atmosf√©rica e do Sol consiste em duas chamadas de desenho separadas: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/649/9df/02c/6499df02c248c9bab14a597b6b111d6d.jpg"></div><br>  <i>Witcher 3 (2015) - at√©</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fe6/4ee/77c/fe64ee77c1923920bc01de149ddb60e7.jpg"></div><br>  <i>Witcher 3 (2015) - com o c√©u</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/64d/9e5/416/64d9e541622b33d646b887db01c7c1a2.jpg"></div><br>  <i>Witcher 3 (2015) - com c√©u + sol</i> <br><br>  A renderiza√ß√£o do Sol na vers√£o 2015 √© muito semelhante √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">renderiza√ß√£o da Lua</a> em termos de geometria e estados de mistura / profundidade. <br><br>  Por outro lado, em <i>"Sangue e Vinho", o</i> c√©u com o Sol √© representado em uma passagem: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/184/7dd/daa/1847dddaa38e0876bc829a2d5747c9ce.jpg"></div><br>  <i>The Witcher 3: Blood and Wine (2016) - Para o C√©u</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7fa/aff/002/7faaff002cc6d328d663c582c74a3628.jpg"></div><br>  <i>The Witcher 3: Blood and Wine (2016) - com o c√©u e o sol</i> <br><br>  N√£o importa como voc√™ renderize o Sol, em algum momento voc√™ ainda precisar√° da dire√ß√£o (normalizada) da luz solar.  A maneira mais l√≥gica de obter esse vetor √© usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">coordenadas esf√©ricas</a> .  De fato, precisamos apenas de dois valores que indicam dois √¢ngulos (em radianos!): <i>Phi</i> e <i>teta</i> .  Ap√≥s receb√™-los, podemos assumir que <i>r = 1</i> , reduzindo-o.  Em seguida, para as coordenadas cartesianas com o eixo Y apontando para cima, voc√™ pode escrever o seguinte c√≥digo em HLSL: <br><br><pre> <code class="cpp hljs"> float3 vSunDir; vSunDir.x = <span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(fTheta)*<span class="hljs-built_in"><span class="hljs-built_in">cos</span></span>(fPhi); vSunDir.y = <span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(fTheta)*<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(fPhi); vSunDir.z = <span class="hljs-built_in"><span class="hljs-built_in">cos</span></span>(fTheta); vSunDir = normalize(vSunDir);</code> </pre> <br>  Normalmente, a dire√ß√£o da luz solar √© calculada no aplicativo e depois passada para o buffer constante para uso futuro. <br><br>  Tendo recebido a dire√ß√£o da luz solar, podemos nos aprofundar no c√≥digo de montagem do shader de pixel <i>"Blood and Wine"</i> ... <br><br><pre> <code class="cpp hljs"> ... <span class="hljs-number"><span class="hljs-number">100</span></span>: add r1.xyw, -r0.xyxz, cb12[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyxz <span class="hljs-number"><span class="hljs-number">101</span></span>: dp3 r2.x, r1.xywx, r1.xywx <span class="hljs-number"><span class="hljs-number">102</span></span>: rsq r2.x, r2.x <span class="hljs-number"><span class="hljs-number">103</span></span>: mul r1.xyw, r1.xyxw, r2.xxxx <span class="hljs-number"><span class="hljs-number">104</span></span>: mov_sat r2.xy, cb12[<span class="hljs-number"><span class="hljs-number">205</span></span>].yxyy <span class="hljs-number"><span class="hljs-number">105</span></span>: dp3 r2.z, -r1.xywx, -r1.xywx <span class="hljs-number"><span class="hljs-number">106</span></span>: rsq r2.z, r2.z <span class="hljs-number"><span class="hljs-number">107</span></span>: mul r1.xyw, -r1.xyxw, r2.zzzz ...</code> </pre> <br>  Ent√£o, primeiro, <i>cb12 [0] .xyz</i> √© a posi√ß√£o da c√¢mera e em <i>r0.xyz</i> armazenamos a posi√ß√£o do v√©rtice (essa √© a sa√≠da do shader de v√©rtice).  Portanto, a linha 100 calcula o vetor <i>worldToCamera</i> .  Mas d√™ uma olhada nas linhas 105-107.  Podemos escrev√™-los como <i>normalizar (-worldToCamera)</i> , ou seja, calculamos o vetor <i>cameraToWorld</i> normalizado. <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">120</span></span>: dp3_sat r1.x, cb12[<span class="hljs-number"><span class="hljs-number">203</span></span>].yzwy, r1.xywx</code> </pre> <br>  Em seguida, calculamos o produto escalar dos <i>vetores cameraToWorld</i> e <i>sunDirection</i> !  Lembre-se de que eles devem ser normalizados.  Tamb√©m saturamos essa express√£o completa para limit√°-la ao intervalo [0-1]. <br><br>  √ìtimo!  Este produto escalar √© armazenado em r1.x.  Vamos ver onde se aplica a seguir ... <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">152</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> r1.x, r1.x <span class="hljs-number"><span class="hljs-number">153</span></span>: mul r1.x, r1.x, cb12[<span class="hljs-number"><span class="hljs-number">203</span></span>].x <span class="hljs-number"><span class="hljs-number">154</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">exp</span></span> r1.x, r1.x <span class="hljs-number"><span class="hljs-number">155</span></span>: mul r1.x, r2.y, r1.x</code> </pre> <br>  A trindade ‚Äúlog, mul, exp‚Äù √© exponencia√ß√£o.  Como voc√™ pode ver, aumentamos nosso cosseno (o produto escalar de vetores normalizados) at√© certo ponto.  Voc√™ pode perguntar o porqu√™.  Dessa forma, podemos criar um gradiente que imita o sol.  (E a linha 155 afeta a opacidade desse gradiente, de modo que, por exemplo, o redefinimos para ocultar completamente o sol).  Aqui est√£o alguns exemplos: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/674/662/658/6746626580dbe0d943c27bcda10f8a9d.jpg"></div><br>  <i>expoente = 54</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b0a/a4e/fca/b0aa4efcae350fe8423e3bc8a1463d78.jpg"></div><br>  <i>expoente = 2400</i> <br><br>  Tendo esse gradiente, usamos para interpolar entre <i>skyColor</i> e <i>sunColor</i> !  Para evitar artefatos, √© necess√°rio saturar o valor na linha 120. <br><br>  Vale ressaltar que esse truque pode ser usado para simular as <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">coroas da</a> lua (com valores baixos de expoente).  Para fazer isso, precisamos do vetor <i>moonDirection</i> , que pode ser facilmente calculado usando coordenadas esf√©ricas. <br><br>  O c√≥digo HLSL pronto pode ser semelhante ao seguinte trecho: <br><br><pre> <code class="cpp hljs"> float3 vCamToWorld = normalize( PosW ‚Äì CameraPos ); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> cosTheta = saturate( dot(vSunDir, vCamToWorld) ); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> sunGradient = <span class="hljs-built_in"><span class="hljs-built_in">pow</span></span>( cosTheta, sunExponent ); float3 color = lerp( skyColor, sunColor, sunGradient );</code> </pre> <br><h3>  Movimento das estrelas </h3><br>  Se voc√™ fizer um lapso de tempo no c√©u noturno claro de Witcher 3, poder√° ver que as estrelas n√£o s√£o est√°ticas - elas se movem um pouco pelo c√©u!  Percebi isso quase por acidente e queria saber como foi implementado. <br><br>  Vamos come√ßar com o fato de que as estrelas em Witcher 3 s√£o apresentadas como um mapa c√∫bico de tamanho 1024x1024x6.  Se voc√™ pensar bem, pode entender que esta √© uma solu√ß√£o muito conveniente que permite que voc√™ tire facilmente as dire√ß√µes para amostrar um mapa c√∫bico. <br><br>  Vejamos o seguinte c√≥digo do assembler: <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">159</span></span>: add r1.xyz, -v1.xyzx, cb1[<span class="hljs-number"><span class="hljs-number">8</span></span>].xyzx <span class="hljs-number"><span class="hljs-number">160</span></span>: dp3 r0.w, r1.xyzx, r1.xyzx <span class="hljs-number"><span class="hljs-number">161</span></span>: rsq r0.w, r0.w <span class="hljs-number"><span class="hljs-number">162</span></span>: mul r1.xyz, r0.wwww, r1.xyzx <span class="hljs-number"><span class="hljs-number">163</span></span>: mul r2.xyz, cb12[<span class="hljs-number"><span class="hljs-number">204</span></span>].zwyz, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">164</span></span>: mad r2.xyz, cb12[<span class="hljs-number"><span class="hljs-number">204</span></span>].yzwy, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), -r2.xyzx <span class="hljs-number"><span class="hljs-number">165</span></span>: mul r4.xyz, r2.xyzx, cb12[<span class="hljs-number"><span class="hljs-number">204</span></span>].zwyz <span class="hljs-number"><span class="hljs-number">166</span></span>: mad r4.xyz, r2.zxyz, cb12[<span class="hljs-number"><span class="hljs-number">204</span></span>].wyzw, -r4.xyzx <span class="hljs-number"><span class="hljs-number">167</span></span>: dp3 r4.x, r1.xyzx, r4.xyzx <span class="hljs-number"><span class="hljs-number">168</span></span>: dp2 r4.y, r1.xyxx, r2.yzyy <span class="hljs-number"><span class="hljs-number">169</span></span>: dp3 r4.z, r1.xyzx, cb12[<span class="hljs-number"><span class="hljs-number">204</span></span>].yzwy <span class="hljs-number"><span class="hljs-number">170</span></span>: dp3 r0.w, r4.xyzx, r4.xyzx <span class="hljs-number"><span class="hljs-number">171</span></span>: rsq r0.w, r0.w <span class="hljs-number"><span class="hljs-number">172</span></span>: mul r2.xyz, r0.wwww, r4.xyzx <span class="hljs-number"><span class="hljs-number">173</span></span>: sample_indexable(texturecube)(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) r4.xyz, r2.xyzx, t0.xyzw, s0</code> </pre> <br>  Para calcular o vetor de amostragem final (linha 173), come√ßamos computando o vetor <i>worldToCamera</i> normalizado (linhas 159-162). <br><br>  Em seguida, calculamos dois produtos vetoriais (163-164, 165-166) com <i>moonDirection</i> e, posteriormente, calculamos tr√™s produtos escalares para obter o vetor de amostragem final.  C√≥digo HLSL: <br><br><pre> <code class="cpp hljs"> float3 vWorldToCamera = normalize( g_CameraPos.xyz - Input.PositionW.xyz ); float3 vMoonDirection = cb12_v204.yzw; float3 vStarsSamplingDir = cross( vMoonDirection, float3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) ); float3 vStarsSamplingDir2 = cross( vStarsSamplingDir, vMoonDirection ); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dirX = dot( vWorldToCamera, vStarsSamplingDir2 ); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dirY = dot( vWorldToCamera, vStarsSamplingDir ); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dirZ = dot( vWorldToCamera, vMoonDirection); float3 dirXYZ = normalize( float3(dirX, dirY, dirZ) ); float3 starsColor = texNightStars.Sample( samplerAnisoWrap, dirXYZ ).rgb;</code> </pre> <br>  Nota para mim mesmo: este √© um c√≥digo muito bem projetado, e devo investig√°-lo com mais detalhes. <br><br>  Nota aos leitores: se voc√™ souber mais sobre esta opera√ß√£o, me diga! <br><br><h3>  Estrelas cintilantes </h3><br>  Outro truque interessante que eu gostaria de explorar com mais detalhes √© o tremor das estrelas.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por exemplo, se voc√™ passear por Novigrad em clima claro, notar√° que as estrelas brilham. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fiquei curioso sobre como isso foi implementado. </font><font style="vertical-align: inherit;">Verificou-se que a diferen√ßa entre a vers√£o de 2015 e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Blood and Wine" √©</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bastante grande. </font><font style="vertical-align: inherit;">Para simplificar, considerarei a vers√£o de 2015. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ent√£o, come√ßamos logo ap√≥s a amostragem de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starsColor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> da se√ß√£o anterior:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">174</span></span>: mul r0.w, v0.x, l(<span class="hljs-number"><span class="hljs-number">100.000000</span></span>) <span class="hljs-number"><span class="hljs-number">175</span></span>: round_ni r1.w, r0.w <span class="hljs-number"><span class="hljs-number">176</span></span>: mad r2.w, v0.y, l(<span class="hljs-number"><span class="hljs-number">50.000000</span></span>), cb0[<span class="hljs-number"><span class="hljs-number">0</span></span>].x <span class="hljs-number"><span class="hljs-number">177</span></span>: round_ni r4.w, r2.w <span class="hljs-number"><span class="hljs-number">178</span></span>: bfrev r4.w, r4.w <span class="hljs-number"><span class="hljs-number">179</span></span>: iadd r5.x, r1.w, r4.w <span class="hljs-number"><span class="hljs-number">180</span></span>: ishr r5.y, r5.x, l(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">181</span></span>: xor r5.x, r5.x, r5.y <span class="hljs-number"><span class="hljs-number">182</span></span>: imul null, r5.y, r5.x, r5.x <span class="hljs-number"><span class="hljs-number">183</span></span>: imad r5.y, r5.y, l(<span class="hljs-number"><span class="hljs-number">0x0000ec4d</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span>) <span class="hljs-number"><span class="hljs-number">184</span></span>: imad r5.x, r5.x, r5.y, l(<span class="hljs-number"><span class="hljs-number">146956042240.000000</span></span>) <span class="hljs-number"><span class="hljs-number">185</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r5.x, r5.x, l(<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>) <span class="hljs-number"><span class="hljs-number">186</span></span>: itof r5.x, r5.x <span class="hljs-number"><span class="hljs-number">187</span></span>: mad r5.y, v0.x, l(<span class="hljs-number"><span class="hljs-number">100.000000</span></span>), l(<span class="hljs-number"><span class="hljs-number">-1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">188</span></span>: round_ni r5.y, r5.y <span class="hljs-number"><span class="hljs-number">189</span></span>: iadd r4.w, r4.w, r5.y <span class="hljs-number"><span class="hljs-number">190</span></span>: ishr r5.z, r4.w, l(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">191</span></span>: xor r4.w, r4.w, r5.z <span class="hljs-number"><span class="hljs-number">192</span></span>: imul null, r5.z, r4.w, r4.w <span class="hljs-number"><span class="hljs-number">193</span></span>: imad r5.z, r5.z, l(<span class="hljs-number"><span class="hljs-number">0x0000ec4d</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span>) <span class="hljs-number"><span class="hljs-number">194</span></span>: imad r4.w, r4.w, r5.z, l(<span class="hljs-number"><span class="hljs-number">146956042240.000000</span></span>) <span class="hljs-number"><span class="hljs-number">195</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r4.w, r4.w, l(<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>) <span class="hljs-number"><span class="hljs-number">196</span></span>: itof r4.w, r4.w <span class="hljs-number"><span class="hljs-number">197</span></span>: add r5.z, r2.w, l(<span class="hljs-number"><span class="hljs-number">-1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">198</span></span>: round_ni r5.z, r5.z <span class="hljs-number"><span class="hljs-number">199</span></span>: bfrev r5.z, r5.z <span class="hljs-number"><span class="hljs-number">200</span></span>: iadd r1.w, r1.w, r5.z <span class="hljs-number"><span class="hljs-number">201</span></span>: ishr r5.w, r1.w, l(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">202</span></span>: xor r1.w, r1.w, r5.w <span class="hljs-number"><span class="hljs-number">203</span></span>: imul null, r5.w, r1.w, r1.w <span class="hljs-number"><span class="hljs-number">204</span></span>: imad r5.w, r5.w, l(<span class="hljs-number"><span class="hljs-number">0x0000ec4d</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span>) <span class="hljs-number"><span class="hljs-number">205</span></span>: imad r1.w, r1.w, r5.w, l(<span class="hljs-number"><span class="hljs-number">146956042240.000000</span></span>) <span class="hljs-number"><span class="hljs-number">206</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r1.w, r1.w, l(<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>) <span class="hljs-number"><span class="hljs-number">207</span></span>: itof r1.w, r1.w <span class="hljs-number"><span class="hljs-number">208</span></span>: mul r1.w, r1.w, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>) <span class="hljs-number"><span class="hljs-number">209</span></span>: iadd r5.y, r5.z, r5.y <span class="hljs-number"><span class="hljs-number">210</span></span>: ishr r5.z, r5.y, l(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">211</span></span>: xor r5.y, r5.y, r5.z <span class="hljs-number"><span class="hljs-number">212</span></span>: imul null, r5.z, r5.y, r5.y <span class="hljs-number"><span class="hljs-number">213</span></span>: imad r5.z, r5.z, l(<span class="hljs-number"><span class="hljs-number">0x0000ec4d</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span>) <span class="hljs-number"><span class="hljs-number">214</span></span>: imad r5.y, r5.y, r5.z, l(<span class="hljs-number"><span class="hljs-number">146956042240.000000</span></span>) <span class="hljs-number"><span class="hljs-number">215</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r5.y, r5.y, l(<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>) <span class="hljs-number"><span class="hljs-number">216</span></span>: itof r5.y, r5.y <span class="hljs-number"><span class="hljs-number">217</span></span>: frc r0.w, r0.w <span class="hljs-number"><span class="hljs-number">218</span></span>: add r0.w, -r0.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">219</span></span>: mul r5.z, r0.w, r0.w <span class="hljs-number"><span class="hljs-number">220</span></span>: mul r0.w, r0.w, r5.z <span class="hljs-number"><span class="hljs-number">221</span></span>: mul r5.xz, r5.xxzx, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">3.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">222</span></span>: mad r0.w, r0.w, l(<span class="hljs-number"><span class="hljs-number">-2.000000</span></span>), r5.z <span class="hljs-number"><span class="hljs-number">223</span></span>: frc r2.w, r2.w <span class="hljs-number"><span class="hljs-number">224</span></span>: add r2.w, -r2.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">225</span></span>: mul r5.z, r2.w, r2.w <span class="hljs-number"><span class="hljs-number">226</span></span>: mul r2.w, r2.w, r5.z <span class="hljs-number"><span class="hljs-number">227</span></span>: mul r5.z, r5.z, l(<span class="hljs-number"><span class="hljs-number">3.000000</span></span>) <span class="hljs-number"><span class="hljs-number">228</span></span>: mad r2.w, r2.w, l(<span class="hljs-number"><span class="hljs-number">-2.000000</span></span>), r5.z <span class="hljs-number"><span class="hljs-number">229</span></span>: mad r4.w, r4.w, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>), -r5.x <span class="hljs-number"><span class="hljs-number">230</span></span>: mad r4.w, r0.w, r4.w, r5.x <span class="hljs-number"><span class="hljs-number">231</span></span>: mad r5.x, r5.y, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>), -r1.w <span class="hljs-number"><span class="hljs-number">232</span></span>: mad r0.w, r0.w, r5.x, r1.w <span class="hljs-number"><span class="hljs-number">233</span></span>: add r0.w, -r4.w, r0.w <span class="hljs-number"><span class="hljs-number">234</span></span>: mad r0.w, r2.w, r0.w, r4.w <span class="hljs-number"><span class="hljs-number">235</span></span>: mad r2.xyz, r0.wwww, l(<span class="hljs-number"><span class="hljs-number">0.000500</span></span>, <span class="hljs-number"><span class="hljs-number">0.000500</span></span>, <span class="hljs-number"><span class="hljs-number">0.000500</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), r2.xyzx <span class="hljs-number"><span class="hljs-number">236</span></span>: sample_indexable(texturecube)(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) r2.xyz, r2.xyzx, t0.xyzw, s0 <span class="hljs-number"><span class="hljs-number">237</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> r4.xyz, r4.xyzx <span class="hljs-number"><span class="hljs-number">238</span></span>: mul r4.xyz, r4.xyzx, l(<span class="hljs-number"><span class="hljs-number">2.200000</span></span>, <span class="hljs-number"><span class="hljs-number">2.200000</span></span>, <span class="hljs-number"><span class="hljs-number">2.200000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">239</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">exp</span></span> r4.xyz, r4.xyzx <span class="hljs-number"><span class="hljs-number">240</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> r2.xyz, r2.xyzx <span class="hljs-number"><span class="hljs-number">241</span></span>: mul r2.xyz, r2.xyzx, l(<span class="hljs-number"><span class="hljs-number">2.200000</span></span>, <span class="hljs-number"><span class="hljs-number">2.200000</span></span>, <span class="hljs-number"><span class="hljs-number">2.200000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">242</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">exp</span></span> r2.xyz, r2.xyzx <span class="hljs-number"><span class="hljs-number">243</span></span>: mul r2.xyz, r2.xyzx, r4.xyzx</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hum. Vamos dar uma olhada no final deste c√≥digo de montagem bastante longo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ap√≥s a amostragem de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starsColor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na linha 173, calculamos algum tipo de valor de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deslocamento</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Esse </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deslocamento √©</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usado para distorcer a primeira dire√ß√£o da amostragem (r2.xyz, linha 235) e, novamente, amostramos o mapa c√∫bico de estrelas, executamos a corre√ß√£o gama desses dois valores (237-242) e os multiplicamos (243). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simples, certo? Bem, na verdade n√£o. Vamos pensar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pouco sobre esse </font><i><font style="vertical-align: inherit;">deslocamento</font></i><font style="vertical-align: inherit;"> . Esse valor deve ser diferente em todo o skydome - estrelas igualmente cintilantes pareceriam muito irrealistas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compensar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for o mais diversificado poss√≠vel, tiraremos proveito do fato de que os UVs s√£o estendidos para skydome (v0.xy) e aplicaremos o tempo decorrido armazenado no buffer constante (cb [0] .x). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ n√£o estiver familiarizado com esses assustadores ishr / xor / e, na parte sobre o efeito do raio, leia sobre o ru√≠do inteiro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como voc√™ pode ver, o ru√≠do inteiro √© causado quatro vezes aqui, mas difere do usado para raios. Para tornar os resultados ainda mais aleat√≥rios, o n√∫mero inteiro de entrada para ru√≠do √© a soma ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iadd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) e os bits s√£o invertidos com ele (fun√ß√£o interna </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reversebits</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; instru√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bfrev</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ent√£o, agora diminua a velocidade. Vamos come√ßar do come√ßo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temos 4 "itera√ß√µes" de ru√≠do inteiro. </font><font style="vertical-align: inherit;">Analisei o c√≥digo do assembler, os c√°lculos de todas as 4 itera√ß√µes s√£o assim:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> asint( <span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(x) ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getReverseInt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> reversebits( getInt(x) ); } <span class="hljs-comment"><span class="hljs-comment">// * Inputs - UV and elapsed time in seconds float2 starsUV; starsUV.x = 100.0 * Input.TextureUV.x; starsUV.y = 50.0 * Input.TextureUV.y + g_fTime; // * Iteration 1 int iStars1_A = getReverseInt( starsUV.y ); int iStars1_B = getInt( starsUV.x ); float fStarsNoise1 = integerNoise( iStars1_A + iStars1_B ); // * Iteration 2 int iStars2_A = getReverseInt( starsUV.y ); int iStars2_B = getInt( starsUV.x - 1.0 ); float fStarsNoise2 = integerNoise( iStars2_A + iStars2_B ); // * Iteration 3 int iStars3_A = getReverseInt( starsUV.y - 1.0 ); int iStars3_B = getInt( starsUV.x ); float fStarsNoise3 = integerNoise( iStars3_A + iStars3_B ); // * Iteration 4 int iStars4_A = getReverseInt( starsUV.y - 1.0 ); int iStars4_B = getInt( starsUV.x - 1.0 ); float fStarsNoise4 = integerNoise( iStars4_A + iStars4_B );</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A sa√≠da final de todas as 4 itera√ß√µes (para localiz√°-las, siga as instru√ß√µes de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">itof</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Itera√ß√£o 1 - r5.x, </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Itera√ß√£o 2 - r4.w, </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Itera√ß√£o 3 - r1.w, </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Itera√ß√£o 4 - r5.y </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ap√≥s o √∫ltimo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">itof</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (linha 216 ) temos:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">217</span></span>: frc r0.w, r0.w <span class="hljs-number"><span class="hljs-number">218</span></span>: add r0.w, -r0.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">219</span></span>: mul r5.z, r0.w, r0.w <span class="hljs-number"><span class="hljs-number">220</span></span>: mul r0.w, r0.w, r5.z <span class="hljs-number"><span class="hljs-number">221</span></span>: mul r5.xz, r5.xxzx, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">3.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">222</span></span>: mad r0.w, r0.w, l(<span class="hljs-number"><span class="hljs-number">-2.000000</span></span>), r5.z <span class="hljs-number"><span class="hljs-number">223</span></span>: frc r2.w, r2.w <span class="hljs-number"><span class="hljs-number">224</span></span>: add r2.w, -r2.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">225</span></span>: mul r5.z, r2.w, r2.w <span class="hljs-number"><span class="hljs-number">226</span></span>: mul r2.w, r2.w, r5.z <span class="hljs-number"><span class="hljs-number">227</span></span>: mul r5.z, r5.z, l(<span class="hljs-number"><span class="hljs-number">3.000000</span></span>) <span class="hljs-number"><span class="hljs-number">228</span></span>: mad r2.w, r2.w, l(<span class="hljs-number"><span class="hljs-number">-2.000000</span></span>), r5.z</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Essas linhas calculam os valores da curva S para a balan√ßa com base na parte fracion√°ria do UV, como no caso de raios. </font></font> Ent√£o: <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s_curve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x2 = x * x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x3 = x2 * x; <span class="hljs-comment"><span class="hljs-comment">// -2x^3 + 3x^2 return -2.0*x3 + 3.0*x2; } ... // lines 217-222 float weightX = 1.0 - frac( starsUV.x ); weightX = s_curve( weightX ); // lines 223-228 float weightY = 1.0 - frac( starsUV.y ); weightY = s_curve( weightY );</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como voc√™ pode esperar, esses coeficientes s√£o usados ‚Äã‚Äãpara interpolar suavemente o ru√≠do e gerar o deslocamento final para as coordenadas de amostragem: </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">229</span></span>: mad r4.w, r4.w, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>), -r5.x <span class="hljs-number"><span class="hljs-number">230</span></span>: mad r4.w, r0.w, r4.w, r5.x <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> noise0 = lerp( fStarsNoise1, fStarsNoise2, weightX ); <span class="hljs-number"><span class="hljs-number">231</span></span>: mad r5.x, r5.y, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>), -r1.w <span class="hljs-number"><span class="hljs-number">232</span></span>: mad r0.w, r0.w, r5.x, r1.w <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> noise1 = lerp( fStarsNoise3, fStarsNoise4, weightX ); <span class="hljs-number"><span class="hljs-number">233</span></span>: add r0.w, -r4.w, r0.w <span class="hljs-number"><span class="hljs-number">234</span></span>: mad r0.w, r2.w, r0.w, r4.w <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> offset = lerp( noise0, noise1, weightY ); <span class="hljs-number"><span class="hljs-number">235</span></span>: mad r2.xyz, r0.wwww, l(<span class="hljs-number"><span class="hljs-number">0.000500</span></span>, <span class="hljs-number"><span class="hljs-number">0.000500</span></span>, <span class="hljs-number"><span class="hljs-number">0.000500</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), r2.xyzx <span class="hljs-number"><span class="hljs-number">236</span></span>: sample_indexable(texturecube)(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) r2.xyz, r2.xyzx, t0.xyzw, s0 float3 starsPerturbedDir = dirXYZ + offset * <span class="hljs-number"><span class="hljs-number">0.0005</span></span>; float3 starsColorDisturbed = texNightStars.Sample( samplerAnisoWrap, starsPerturbedDir ).rgb;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui est√° uma pequena visualiza√ß√£o do </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deslocamento</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> calculado </font><font style="vertical-align: inherit;">:</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/SAI-cLJFpfg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ap√≥s o c√°lculo de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starsColorDisturbed,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a parte mais dif√≠cil est√° conclu√≠da.</font></font> Viva! <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A pr√≥xima etapa √© executar a corre√ß√£o gama para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starsColor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starsColorDisturbed</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ap√≥s o que s√£o multiplicados:</font></font><br><br><pre> <code class="cpp hljs"> starsColor = <span class="hljs-built_in"><span class="hljs-built_in">pow</span></span>( starsColor, <span class="hljs-number"><span class="hljs-number">2.2</span></span> ); starsColorDisturbed = <span class="hljs-built_in"><span class="hljs-built_in">pow</span></span>( starsColorDisturbed, <span class="hljs-number"><span class="hljs-number">2.2</span></span> ); float3 starsFinal = starsColor * starsColorDisturbed;</code> </pre> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Estrelas - os retoques finais </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starsFinal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em r1.xyz. </font><font style="vertical-align: inherit;">No final do processamento em estrela, ocorre o seguinte:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">256</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> r1.xyz, r1.xyzx <span class="hljs-number"><span class="hljs-number">257</span></span>: mul r1.xyz, r1.xyzx, l(<span class="hljs-number"><span class="hljs-number">2.500000</span></span>, <span class="hljs-number"><span class="hljs-number">2.500000</span></span>, <span class="hljs-number"><span class="hljs-number">2.500000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">258</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">exp</span></span> r1.xyz, r1.xyzx <span class="hljs-number"><span class="hljs-number">259</span></span>: min r1.xyz, r1.xyzx, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">260</span></span>: add r0.w, -cb0[<span class="hljs-number"><span class="hljs-number">9</span></span>].w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">261</span></span>: mul r1.xyz, r0.wwww, r1.xyzx <span class="hljs-number"><span class="hljs-number">262</span></span>: mul r1.xyz, r1.xyzx, l(<span class="hljs-number"><span class="hljs-number">10.000000</span></span>, <span class="hljs-number"><span class="hljs-number">10.000000</span></span>, <span class="hljs-number"><span class="hljs-number">10.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso √© muito mais f√°cil comparado √†s estrelas cintilantes e em movimento. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ent√£o, come√ßamos elevando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starsFinal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a uma pot√™ncia de 2,5 - isso nos permite controlar a densidade das estrelas. </font><font style="vertical-align: inherit;">Muito esperto. </font><font style="vertical-align: inherit;">Ent√£o tornamos a cor m√°xima das estrelas igual a float3 (1, 1, 1). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb0 [9] .w √© usado para controlar a visibilidade geral das estrelas. </font><font style="vertical-align: inherit;">Portanto, podemos esperar que durante o dia esse valor seja 1,0 (o que d√° uma multiplica√ß√£o por zero) e √† noite - 0,0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No final, aumentamos a visibilidade das estrelas em 10. E √© isso!</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parte 3. O Dom Witcher (objetos e mapa de brilho) </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quase todos os efeitos e t√©cnicas descritos anteriormente n√£o estavam realmente associados ao Witcher 3. Coisas como corre√ß√£o de tom, vinhetas ou c√°lculo do brilho m√©dio est√£o presentes em quase todos os jogos modernos. </font><font style="vertical-align: inherit;">At√© o efeito da intoxica√ß√£o √© bastante difundido. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por isso, decidi examinar mais de perto a mec√¢nica de renderiza√ß√£o do "instinto bruxo". </font><font style="vertical-align: inherit;">Geralt √© um bruxo e, portanto, seus sentimentos s√£o muito mais agu√ßados do que os de uma pessoa comum. </font><font style="vertical-align: inherit;">Conseq√ºentemente, ele pode ver e ouvir mais do que outras pessoas, o que o ajuda muito em suas investiga√ß√µes. </font><font style="vertical-align: inherit;">A mec√¢nica do talento do bruxo permite ao jogador visualizar esses tra√ßos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui est√° uma demonstra√ß√£o do efeito:</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/794z0wbcI6U" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> E mais um, com melhor ilumina√ß√£o: </font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/ReB6IrOb3ic" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como voc√™ pode ver, existem dois tipos de objetos: aqueles com os quais Geralt pode interagir (contorno amarelo) e tra√ßos associados √† investiga√ß√£o (contorno vermelho). </font><font style="vertical-align: inherit;">Depois de Geralt examinar a trilha vermelha, ela pode se transformar em amarelo (primeiro v√≠deo). </font><font style="vertical-align: inherit;">Observe que a tela inteira fica cinza e um efeito de olho de peixe (segundo v√≠deo) √© adicionado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esse efeito √© bastante complicado, ent√£o decidi dividir sua pesquisa em tr√™s partes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No primeiro, falarei sobre a sele√ß√£o de objetos, no segundo - sobre a gera√ß√£o do contorno e no terceiro - sobre a unifica√ß√£o final de tudo isso em um todo.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Selecionar objetos </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como eu disse, existem dois tipos de objetos e precisamos distinguir entre eles. </font><font style="vertical-align: inherit;">No Witcher 3, isso √© implementado usando um buffer de est√™ncil. </font><font style="vertical-align: inherit;">Ao gerar malhas GBuffer que devem ser marcadas como ‚Äútra√ßos‚Äù (vermelho), elas s√£o renderizadas com est√™ncil = 8. Malhas marcadas em amarelo como objetos ‚Äúinteressantes‚Äù s√£o renderizadas com est√™ncil = 4. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por exemplo, as duas texturas a seguir mostram um exemplo de quadro com instinto witcher vis√≠vel e o buffer de est√™ncil correspondente:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a6/7ed/667/2a67ed667870cd52dcf0da4f366975b6.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac7/a84/a9c/ac7a84a9c8aa25c1685a2a5f83f7447f.jpg"></div><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Resumo do buffer do est√™ncil </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O buffer de est√™ncil √© frequentemente usado em jogos para marcar malhas. </font><font style="vertical-align: inherit;">Certas categorias de malhas recebem o mesmo ID. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A id√©ia √© usar a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sempre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com o operador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Substituir</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se o teste de est√™ncil for bem-sucedido e com o operador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manter</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em todos os outros casos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Veja como √© implementado usando o D3D11:</font></font><br><br><pre> <code class="cpp hljs"> D3D11_DEPTH_STENCIL_DESC depthstencilState; <span class="hljs-comment"><span class="hljs-comment">// Set depth parameters.... // Enable stencil depthstencilState.StencilEnable = TRUE; // Read &amp; write all bits depthstencilState.StencilReadMask = 0xFF; depthstencilState.StencilWriteMask = 0xFF; // Stencil operator for front face depthstencilState.FrontFace.StencilFunc = D3D11_COMPARISON_ALWAYS; depthstencilState.FrontFace.StencilDepthFailOp = D3D11_STENCIL_OP_KEEP; depthstencilState.FrontFace.StencilFailOp = D3D11_STENCIL_OP_KEEP; depthstencilState.FrontFace.StencilPassOp = D3D11_STENCIL_OP_REPLACE; // Stencil operator for back face. depthstencilState.BackFace.StencilFunc = D3D11_COMPARISON_ALWAYS; depthstencilState.BackFace.StencilDepthFailOp = D3D11_STENCIL_OP_KEEP; depthstencilState.BackFace.StencilFailOp = D3D11_STENCIL_OP_KEEP; depthstencilState.BackFace.StencilPassOp = D3D11_STENCIL_OP_REPLACE; pDevice-&gt;CreateDepthStencilState( &amp;depthstencilState, &amp;m_pDS_AssignValue );</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O valor stensil a ser gravado no buffer √© passado como um </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StencilRef</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na chamada da API:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// from now on set stencil buffer values to 8 pDevCon-&gt;OMSetDepthStencilState( m_pDS_AssignValue, 8 ); ... pDevCon-&gt;DrawIndexed( ... );</span></span></code> </pre> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Brilho de renderiza√ß√£o </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nesta passagem, do ponto de vista da implementa√ß√£o, existe uma textura de tela cheia no formato R11G11B10_FLOAT, na qual objetos e tra√ßos interessantes s√£o armazenados nos canais R e G. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que precisamos disso em termos de brilho? </font><font style="vertical-align: inherit;">Acontece que o instinto de Geralt tem um raio limitado, ent√£o os objetos s√≥ ficam contornos quando o jogador est√° perto o suficiente deles. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Veja este aspecto em a√ß√£o:</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Xbs-ZRJ7v1w" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6f1/073/f03/6f1073f03172250a5b4c052ebfdfd832.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Come√ßamos limpando a textura do brilho, preenchendo-a com preto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em seguida, s√£o feitas duas chamadas de desenho em tela cheia: a primeira para o rastreamento, a segunda para objetos interessantes:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/077/c17/138/077c1713805b1f95625c05fb11643c53.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A primeira chamada de empate √© feita para tra√ßos - o canal verde: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/14f/7df/63e/14f7df63e4e1760304e4a2c6279953d1.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A segunda chamada √© feita para objetos interessantes - o canal vermelho: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6db/379/add/6db379add4ffc7f54a047f79b608d67f.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bem, mas como determinamos quais pixels considerar? </font><font style="vertical-align: inherit;">Teremos que usar o buffer de est√™ncil! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para cada uma dessas chamadas, √© realizado um teste de est√™ncil e somente os pixels que foram marcados anteriormente como ‚Äú8‚Äù (primeira chamada de desenho) ou ‚Äú4‚Äù s√£o aceitos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Visualiza√ß√£o do teste de est√™ncil para tra√ßos:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a60/227/b57/a60227b575f307ad5a251aa817a49963.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ... e para objetos interessantes: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/014/6eb/5f4/0146eb5f4da50018f5d28b4453e2424c.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como o teste √© realizado neste caso? </font><font style="vertical-align: inherit;">Voc√™ pode aprender sobre o b√°sico do teste de est√™ncil em uma boa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">publica√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Em geral, a f√≥rmula de teste do est√™ncil tem a seguinte forma:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (StencilRef &amp; StencilReadMask OP StencilValue &amp; StencilReadMask) accept pixel <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> discard pixel</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em que: </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StencilRef</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© o valor passado pela chamada da API, </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StencilReadMask</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© a m√°scara usada para ler o valor stensil (observe que ele est√° presente nos lados esquerdo e direito), </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OP</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© o operador de compara√ß√£o, definido via API, </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StencilValue</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© o valor do buffer de est√™ncil no pixel atual sendo processado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â importante entender que usamos ANDs bin√°rios para calcular os operandos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depois de se familiarizar com o b√°sico, vamos ver como esses par√¢metros s√£o usados ‚Äã‚Äãnessas chamadas de empate:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/164/373/d2c/164373d2c3421c708e40dc9cb26eb7c9.jpg"></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Condi√ß√£o de est√™ncil para tra√ßos</font></font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1e5/3c0/ae3/1e53c0ae3680bebe785e64739c4ece43.jpg"></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estado de est√™ncil para objetos interessantes</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ha! </font><font style="vertical-align: inherit;">Como podemos ver, a √∫nica diferen√ßa √© o ReadMask. </font><font style="vertical-align: inherit;">Vamos conferir! </font><font style="vertical-align: inherit;">Substitua estes valores na equa√ß√£o de teste do est√™ncil:</font></font><br><br><pre> <code class="cpp hljs"> Let StencilReadMask = <span class="hljs-number"><span class="hljs-number">0x08</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> StencilRef = <span class="hljs-number"><span class="hljs-number">0</span></span>: For a pixel with stencil = <span class="hljs-number"><span class="hljs-number">8</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x08</span></span> &lt; <span class="hljs-number"><span class="hljs-number">8</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x08</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> &lt; <span class="hljs-number"><span class="hljs-number">8</span></span> TRUE For a pixel with stencil = <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x08</span></span> &lt; <span class="hljs-number"><span class="hljs-number">4</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x08</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> FALSE</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inteligentemente. </font><font style="vertical-align: inherit;">Como voc√™ pode ver, neste caso, n√£o comparamos o valor stensil, mas verificamos se um determinado bit do buffer de est√™ncil est√° definido. </font><font style="vertical-align: inherit;">Cada pixel do buffer de est√™ncil possui o formato uint8, portanto, o intervalo de valores √© [0-255]. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota: todas as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chamadas DrawIndexed (36)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√£o relacionadas √† renderiza√ß√£o de pegadas como rastreios; portanto, nesse quadro espec√≠fico, o mapa de brilho tem a seguinte forma final:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/917/f0d/d04/917f0dd0490ef8faa829ede007838906.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas antes do teste de est√™ncil, existe um sombreador de pixels. </font><font style="vertical-align: inherit;">28738 e 28748 usam o mesmo sombreador de pixels:</font></font><br><br><pre> <code class="cpp hljs"> ps_5_0 dcl_globalFlags refactoringAllowed dcl_constantbuffer cb0[<span class="hljs-number"><span class="hljs-number">2</span></span>], immediateIndexed dcl_constantbuffer cb3[<span class="hljs-number"><span class="hljs-number">8</span></span>], immediateIndexed dcl_constantbuffer cb12[<span class="hljs-number"><span class="hljs-number">214</span></span>], immediateIndexed dcl_sampler s15, <span class="hljs-function"><span class="hljs-function">mode_default </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dcl_resource_texture2d</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> t15 dcl_input_ps_siv v0.xy, position dcl_output o0.xyzw dcl_output o1.xyzw dcl_output o2.xyzw dcl_output o3.xyzw dcl_temps 2 0: mul r0.xy, v0.xyxx, cb0[1].zwzz 1: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r0.x, r0.xyxx, t15.xyzw, s15 2: mul r1.xyzw, v0.yyyy, cb12[211].xyzw 3: mad r1.xyzw, cb12[210].xyzw, v0.xxxx, r1.xyzw 4: mad r0.xyzw, cb12[212].xyzw, r0.xxxx, r1.xyzw 5: add r0.xyzw, r0.xyzw, cb12[213].xyzw 6: div r0.xyz, r0.xyzx, r0.wwww 7: add r0.xyz, r0.xyzx, -cb3[7].xyzx 8: dp3 r0.x, r0.xyzx, r0.xyzx 9: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">sqrt</span></span></span><span class="hljs-function"> r0.x, r0.x 10: mul r0.y, r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.120000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 11: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">log</span></span></span><span class="hljs-function"> r1.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cb3[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">6</span></span></span></span><span class="hljs-function"><span class="hljs-params">].y)</span></span></span><span class="hljs-function"> 12: mul r1.xy, r1.xxxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2.800000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.800000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 13: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">exp</span></span></span><span class="hljs-function"> r1.xy, r1.xyxx 14: mad r0.zw, r1.xxxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">120.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">120.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 15: lt r1.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.030000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, cb3[6].y 16: movc r0.xy, r1.xxxx, r0.yzyy, r0.xwxx 17: div r0.x, r0.x, r0.y 18: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">log</span></span></span><span class="hljs-function"> r0.x, r0.x 19: mul r0.x, r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.600000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 20: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">exp</span></span></span><span class="hljs-function"> r0.x, r0.x 21: add r0.x, -r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 22: max r0.x, r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 23: mul o0.xyz, r0.xxxx, cb3[0].xyzx 24: mov o0.w, cb3[0].w 25: mov o1.xyzw, cb3[1].xyzw 26: mov o2.xyzw, cb3[2].xyzw 27: mov o3.xyzw, cb3[3].xyzw 28: ret</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esse sombreador de pixels grava em apenas um destino de renderiza√ß√£o, portanto as linhas 24 a 27 s√£o redundantes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A primeira coisa que acontece aqui √© a amostragem de profundidade (com um amostrador de pontos com um limite de valor), linha 1. Esse valor √© usado para recriar uma posi√ß√£o no mundo multiplicando por uma matriz especial, seguida pela divis√£o de perspectiva (linhas 2-6). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tomando a posi√ß√£o de Geralt (cb3 [7] .xyz - observe que essa </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font><i><font style="vertical-align: inherit;">a</font></i><font style="vertical-align: inherit;"> posi√ß√£o da c√¢mera!), Calculamos a dist√¢ncia de Geralt a esse ponto espec√≠fico (linhas 7-9). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A seguinte entrada √© importante neste shader: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- cb3 [0] .rgb - cor de sa√≠da. Pode ter o formato float3 (0, 1, 0) (tra√ßos) ou float3 (1, 0, 0) (objetos interessantes),</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- cb3 [6] .y - fator de escala de dist√¢ncia. </font><font style="vertical-align: inherit;">Afeta diretamente o raio e o brilho da sa√≠da final. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais tarde, temos f√≥rmulas bastante complicadas para calcular o brilho, dependendo da dist√¢ncia entre Geralt e o objeto. </font><font style="vertical-align: inherit;">Eu posso assumir que todos os coeficientes s√£o selecionados experimentalmente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A sa√≠da final √© de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> * </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">intensidade</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo HLSL ser√° mais ou menos assim:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FSInput</span></span></span><span class="hljs-class"> {</span></span> float4 param0 : SV_Position; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FSOutput</span></span></span><span class="hljs-class"> {</span></span> float4 param0 : SV_Target0; float4 param1 : SV_Target1; float4 param2 : SV_Target2; float4 param3 : SV_Target3; }; <span class="hljs-function"><span class="hljs-function">float3 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getWorldPos</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( float2 screenPos, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> depth )</span></span></span><span class="hljs-function"> </span></span>{ float4 worldPos = float4(screenPos, depth, <span class="hljs-number"><span class="hljs-number">1.0</span></span>); worldPos = mul( worldPos, screenToWorld ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> worldPos.xyz / worldPos.w; } <span class="hljs-function"><span class="hljs-function">FSOutput </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EditedShaderPS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(in FSInput IN)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// * Inputs // Directly affects radius of the effect float distanceScaling = cb3_v6.y; // Color of output at the end float3 color = cb3_v0.rgb; // Sample depth float2 uv = IN.param0.xy * cb0_v1.zw; float depth = texture15.Sample( sampler15, uv ).x; // Reconstruct world position float3 worldPos = getWorldPos( IN.param0.xy, depth ); // Calculate distance from Geralt to world position of particular object float dist_geraltToWorld = length( worldPos - cb3_v7.xyz ); // Calculate two squeezing params float t0 = 1.0 + 120*pow( abs(distanceScaling), 2.8 ); float t1 = 1.0 + 120*pow( abs(distanceScaling), 0.8 ); // Determine nominator and denominator float2 params; params = (distanceScaling &gt; 0.03) ? float2(dist_geraltToWorld * 0.12, t0) : float2(dist_geraltToWorld, t1); // Distance Geralt &lt;-&gt; Object float nominator = params.x; // Hiding factor float denominator = params.y; // Raise to power of 1.6 float param = pow( params.x / params.y, 1.6 ); // Calculate final intensity float intensity = max(0.0, 1.0 - param ); // * Final outputs. // * // * This PS outputs only one color, the rest // * is redundant. I just added this to keep 1-1 ratio with // * original assembly. FSOutput OUT = (FSOutput)0; OUT.param0.xyz = color * intensity; // == redundant == OUT.param0.w = cb3_v0.w; OUT.param1 = cb3_v1; OUT.param2 = cb3_v2; OUT.param3 = cb3_v3; // =============== return OUT; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Uma pequena compara√ß√£o do c√≥digo de sombreador do assembler original (esquerda) e (direita). </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68c/07d/1d6/68c07d1d6fd99f81cb0b3b63c9927a53.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este foi o primeiro est√°gio do efeito de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">talento da bruxa</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">De fato, √© o mais simples.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parte 4. O Dom Witcher (mapa de descri√ß√£o) </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mais uma vez, d√™ uma olhada na cena que estamos explorando: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a6/7ed/667/2a67ed667870cd52dcf0da4f366975b6.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na primeira parte da an√°lise do efeito do instinto da bruxa, mostrei como o "mapa de brilho" √© gerado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temos uma textura de tela cheia do formato R11G11B10_FLOAT, que pode ser assim:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/917/f0d/d04/917f0dd0490ef8faa829ede007838906.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O canal verde significa "pegadas", o vermelho - objetos interessantes com os quais Geralt pode interagir. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tendo recebido essa textura, podemos avan√ßar para a pr√≥xima etapa - chamei de ‚Äúmapa de contorno‚Äù.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1bf/428/855/1bf4288554d1cef31c2607a4ca73c2bb.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essa √© uma textura um pouco estranha do formato 512x512 R16G16_FLOAT. </font><font style="vertical-align: inherit;">√â importante que seja implementado no estilo de "pingue-pongue". </font><font style="vertical-align: inherit;">O mapa de contorno do quadro anterior s√£o os dados de entrada (junto com o mapa de brilho) para gerar um novo mapa de contorno no quadro atual. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os buffers de ping-pong podem ser implementados de v√°rias maneiras, mas eu pessoalmente gosto do seguinte (pseudo-c√≥digo) acima de tudo:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// Declarations Texture2D m_texOutlineMap[2]; uint m_outlineIndex = 0; // Rendering void Render() { pDevCon-&gt;SetInputTexture( m_texOutlineMap[m_outlineIndex] ); pDevCon-&gt;SetOutputTexture( m_texOutlineMap[!m_outlineIndex] ); ... pDevCon-&gt;Draw(...); // after draw m_outlineIndex = !m_outlineIndex; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essa abordagem, onde a entrada √© sempre </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[m_outlineIndex]</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e a sa√≠da √© sempre </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[! M_outlineIndex]</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , fornece flexibilidade para o uso de p√≥s-efeitos adicionais. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos dar uma olhada no pixel shader:</font></font><br><br><pre> <code class="cpp hljs"> ps_5_0 dcl_globalFlags refactoringAllowed dcl_constantbuffer cb3[<span class="hljs-number"><span class="hljs-number">1</span></span>], immediateIndexed dcl_sampler s0, mode_default dcl_sampler s1, <span class="hljs-function"><span class="hljs-function">mode_default </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dcl_resource_texture2d</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> t0 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dcl_resource_texture2d</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> t1 dcl_input_ps linear v2.xy dcl_output o0.xyzw dcl_temps 4 0: add r0.xyzw, v2.xyxy, v2.xyxy 1: round_ni r1.xy, r0.zwzz 2: frc r0.xyzw, r0.xyzw 3: add r1.zw, r1.xxxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 4: dp2 r1.z, r1.zwzz, r1.zwzz 5: add r1.z, -r1.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 6: max r2.w, r1.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 7: dp2 r1.z, r1.xyxx, r1.xyxx 8: add r3.xyzw, r1.xyxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 9: add r1.x, -r1.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 10: max r2.x, r1.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 11: dp2 r1.x, r3.xyxx, r3.xyxx 12: dp2 r1.y, r3.zwzz, r3.zwzz 13: add r1.xy, -r1.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 14: max r2.yz, r1.xxyx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 15: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r1.xyzw, r0.zwzz, t1.xyzw, s1 16: dp4 r1.x, r1.xyzw, r2.xyzw 17: add r2.xyzw, r0.zwzw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.003906</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.003906</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 18: add r0.xyzw, r0.xyzw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.003906</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.003906</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 19: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r1.yz, r2.xyxx, t1.zxyw, s1 20: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r2.xy, r2.zwzz, t1.xyzw, s1 21: add r1.yz, r1.yyzy, -r2.xxyx 22: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r0.xy, r0.xyxx, t1.xyzw, s1 23: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r0.zw, r0.zwzz, t1.zwxy, s1 24: add r0.xy, -r0.zwzz, r0.xyxx 25: max r0.xy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r0.xyxx)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r1.yzyy)</span></span></span><span class="hljs-function"> 26: min r0.xy, r0.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 27: mul r0.xy, r0.xyxx, r1.xxxx 28: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r0.zw, v2.xyxx, t0.zwxy, s0 29: mad r0.w, r1.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.150000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r0.w 30: mad r0.x, r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.350000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r0.w 31: mad r0.x, r0.y, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.350000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r0.x 32: mul r0.yw, cb3[0].zzzw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">300.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">300.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 33: mad r0.yw, v2.xxxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">150.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">150.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r0.yyyw 34: ftoi r0.yw, r0.yyyw 35: bfrev r0.w, r0.w 36: iadd r0.y, r0.w, r0.y 37: ishr r0.w, r0.y, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">13</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 38: xor r0.y, r0.y, r0.w 39: imul null, r0.w, r0.y, r0.y 40: imad r0.w, r0.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0x0000ec4d</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 41: imad r0.y, r0.y, r0.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">146956042240.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 42: </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">and</span></span></span><span class="hljs-function"> r0.y, r0.y, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0x7fffffff</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 43: itof r0.y, r0.y 44: mad r0.y, r0.y, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000001</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.650000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 45: add_sat r1.xyzw, v2.xyxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.001953</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.001953</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 46: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r0.w, r1.xyxx, t0.yzwx, s0 47: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r1.x, r1.zwzz, t0.xyzw, s0 48: add r0.w, r0.w, r1.x 49: add_sat r1.xyzw, v2.xyxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.001953</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.001953</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 50: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r1.x, r1.xyxx, t0.xyzw, s0 51: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r1.y, r1.zwzz, t0.yxzw, s0 52: add r0.w, r0.w, r1.x 53: add r0.w, r1.y, r0.w 54: mad r0.w, r0.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.250000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, -r0.z 55: mul r0.w, r0.y, r0.w 56: mul r0.y, r0.y, r0.z 57: mad r0.x, r0.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.900000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r0.x 58: mad r0.y, r0.y, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.240000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r0.x 59: add r0.x, r0.y, r0.z 60: mov_sat r0.z, cb3[0].x 61: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">log</span></span></span><span class="hljs-function"> r0.z, r0.z 62: mul r0.z, r0.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">100.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 63: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">exp</span></span></span><span class="hljs-function"> r0.z, r0.z 64: mad r0.z, r0.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.160000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.700000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 65: mul o0.xy, r0.zzzz, r0.xyxx 66: mov o0.zw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 67: ret</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como voc√™ pode ver, o mapa de contorno de sa√≠da √© dividido em quatro quadrados iguais, e esta √© a primeira coisa que precisamos estudar: </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">0</span></span>: add r0.xyzw, v2.xyxy, v2.xyxy <span class="hljs-number"><span class="hljs-number">1</span></span>: round_ni r1.xy, r0.zwzz <span class="hljs-number"><span class="hljs-number">2</span></span>: frc r0.xyzw, r0.xyzw <span class="hljs-number"><span class="hljs-number">3</span></span>: add r1.zw, r1.xxxy, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">4</span></span>: dp2 r1.z, r1.zwzz, r1.zwzz <span class="hljs-number"><span class="hljs-number">5</span></span>: add r1.z, -r1.z, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">6</span></span>: max r2.w, r1.z, l(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>: dp2 r1.z, r1.xyxx, r1.xyxx <span class="hljs-number"><span class="hljs-number">8</span></span>: add r3.xyzw, r1.xyxy, l(<span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">9</span></span>: add r1.x, -r1.z, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">10</span></span>: max r2.x, r1.x, l(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">11</span></span>: dp2 r1.x, r3.xyxx, r3.xyxx <span class="hljs-number"><span class="hljs-number">12</span></span>: dp2 r1.y, r3.zwzz, r3.zwzz <span class="hljs-number"><span class="hljs-number">13</span></span>: add r1.xy, -r1.xyxx, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">14</span></span>: max r2.yz, r1.xxyx, l(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Come√ßamos calculando o piso (TextureUV * 2.0), o que nos fornece o seguinte: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e25/7b3/e14/e257b3e14ac5b8a1f2b65525333924c5.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Para determinar os quadrados individuais, uma pequena fun√ß√£o √© usada: </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getParams</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(float2 uv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> d = dot(uv, uv); d = <span class="hljs-number"><span class="hljs-number">1.0</span></span> - d; d = max( d, <span class="hljs-number"><span class="hljs-number">0.0</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observe que a fun√ß√£o retorna 1,0 com a entrada float2 (0,0, 0,0). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este caso ocorre no canto superior esquerdo. </font><font style="vertical-align: inherit;">Para obter a mesma situa√ß√£o no canto superior direito, subtraia float2 (1, 0) dos cabos de texto arredondados, subtraia float2 (0, 1) para o quadrado verde e float2 (1,0, 1,0) para o quadrado amarelo.</font></font><br><br>  Ent√£o: <br><br><pre> <code class="cpp hljs"> float2 flooredTextureUV = <span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>( <span class="hljs-number"><span class="hljs-number">2.0</span></span> * TextureUV ); ... float2 uv1 = flooredTextureUV; float2 uv2 = flooredTextureUV + float2(<span class="hljs-number"><span class="hljs-number">-1.0</span></span>, <span class="hljs-number"><span class="hljs-number">-0.0</span></span>); float2 uv3 = flooredTextureUV + float2( <span class="hljs-number"><span class="hljs-number">-0.0</span></span>, <span class="hljs-number"><span class="hljs-number">-1.0</span></span>); float2 uv4 = flooredTextureUV + float2(<span class="hljs-number"><span class="hljs-number">-1.0</span></span>, <span class="hljs-number"><span class="hljs-number">-1.0</span></span>); float4 mask; mask.x = getParams( uv1 ); mask.y = getParams( uv2 ); mask.z = getParams( uv3 ); mask.w = getParams( uv4 );</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cada um dos componentes da </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√°scara</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© zero ou um e √© respons√°vel por um quadrado da textura. </font><font style="vertical-align: inherit;">Por exemplo, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mask.r</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mask.w</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/559/e1c/242/559e1c242221886f5c0100fa66837c31.jpg"></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mask.r</font></font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bb5/108/a24/bb5108a241181f23a66c7f3803d33cea.jpg"></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mask.w</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Temos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√°scara</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , vamos seguir em frente. </font><font style="vertical-align: inherit;">A linha 15 mostra o mapa de lumin√¢ncia. </font><font style="vertical-align: inherit;">Observe que a textura do brilho est√° no formato R11G11B10_FLOAT, embora amostremos todos os componentes rgba. </font><font style="vertical-align: inherit;">Nessa situa√ß√£o, sup√µe-se que .a seja 1.0f. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os Texcoords usados ‚Äã‚Äãpara esta opera√ß√£o podem ser calculados como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">frac (TextureUV * 2.0)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Portanto, o resultado dessa opera√ß√£o pode, por exemplo, ter a seguinte apar√™ncia:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/955/071/c05/955071c057420f3c4b083ed174046189.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Veja a semelhan√ßa? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A pr√≥xima etapa √© muito inteligente - o produto escalar de quatro componentes (dp4) √© executado:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">16</span></span>: dp4 r1.x, r1.xyzw, r2.xyzw</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, apenas o canal vermelho (ou seja, apenas objetos interessantes) permanece no canto superior esquerdo, apenas o canal verde no canto superior direito (apenas tra√ßos) e tudo no canto inferior direito (porque o componente de lumin√¢ncia .w est√° indiretamente definido como 1,0). </font><font style="vertical-align: inherit;">√ìtima ideia. </font><font style="vertical-align: inherit;">O resultado do produto escalar se parece com o seguinte:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/37c/488/3ab/37c4883ab098cd1bc4ef2d22187f7d16.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ap√≥s receber este </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">masterFilter</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , estamos prontos para determinar os contornos dos objetos. </font><font style="vertical-align: inherit;">N√£o √© t√£o dif√≠cil quanto pode parecer. </font><font style="vertical-align: inherit;">O algoritmo √© muito semelhante ao usado para obter nitidez - precisamos obter a diferen√ßa absoluta m√°xima de valores. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eis o que acontece: amostramos quatro texels ao lado do texel atual que est√° sendo processado (importante: nesse caso, o tamanho do texel √© 1,0 / 256,0!) E calculamos as diferen√ßas absolutas m√°ximas para os canais vermelho e verde:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> fTexel = <span class="hljs-number"><span class="hljs-number">1.0</span></span> / <span class="hljs-number"><span class="hljs-number">256</span></span>; float2 sampling1 = TextureUV + float2( fTexel, <span class="hljs-number"><span class="hljs-number">0</span></span> ); float2 sampling2 = TextureUV + float2( -fTexel, <span class="hljs-number"><span class="hljs-number">0</span></span> ); float2 sampling3 = TextureUV + float2( <span class="hljs-number"><span class="hljs-number">0</span></span>, fTexel ); float2 sampling4 = TextureUV + float2( <span class="hljs-number"><span class="hljs-number">0</span></span>, -fTexel ); float2 intensity_x0 = texIntensityMap.Sample( sampler1, sampling1 ).xy; float2 intensity_x1 = texIntensityMap.Sample( sampler1, sampling2 ).xy; float2 intensity_diff_x = intensity_x0 - intensity_x1; float2 intensity_y0 = texIntensityMap.Sample( sampler1, sampling3 ).xy; float2 intensity_y1 = texIntensityMap.Sample( sampler1, sampling4 ).xy; float2 intensity_diff_y = intensity_y0 - intensity_y1; float2 maxAbsDifference = max( <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(intensity_diff_x), <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(intensity_diff_y) ); maxAbsDifference = saturate(maxAbsDifference);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora, se multiplicarmos o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">filtro</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maxAbsDifference</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ...</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dcb/332/626/dcb332626d34f07ecf1bd85928b7d1dc.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Muito simples e eficiente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ap√≥s receber os contornos, fazemos uma amostra do mapa de contornos do quadro anterior. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ent√£o, para obter um efeito "fantasmag√≥rico", tomamos parte dos par√¢metros calculados na passagem atual e dos valores do mapa de contorno. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diga ol√° para o nosso velho amigo - ru√≠do inteiro. </font><font style="vertical-align: inherit;">Ele est√° presente aqui. </font><font style="vertical-align: inherit;">Os par√¢metros de anima√ß√£o (cb3 [0] .zw) s√£o obtidos do buffer constante e mudam com o tempo.</font></font><br><br><pre> <code class="cpp hljs"> float2 outlines = masterFilter * maxAbsDifference; <span class="hljs-comment"><span class="hljs-comment">// Sample outline map float2 outlineMap = texOutlineMap.Sample( samplerLinearWrap, uv ).xy; // I guess it's related with ghosting float paramOutline = masterFilter*0.15 + outlineMap.y; paramOutline += 0.35 * outlines.r; paramOutline += 0.35 * outlines.g; // input for integer noise float2 noiseWeights = cb3_v0.zw; float2 noiseInputs = 150.0*uv + 300.0*noiseWeights; int2 iNoiseInputs = (int2) noiseInputs; float noise0 = clamp( integerNoise( iNoiseInputs.x + reversebits(iNoiseInputs.y) ), -1, 1 ) + 0.65; // r0.y</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota: se voc√™ quiser implementar o instinto da bruxa, recomendo limitar o ru√≠do inteiro ao intervalo [-1; 1] (como dito em seu site). </font><font style="vertical-align: inherit;">N√£o havia nenhuma restri√ß√£o no shader TW3 original, mas sem ele obtive artefatos terr√≠veis e todo o mapa do esbo√ßo era inst√°vel. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depois, amostramos o mapa de contorno da mesma maneira que o mapa de brilho anteriormente (desta vez, o texel tem um tamanho de 1.0 / 512.0) e calculamos o valor m√©dio do componente .x:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// sampling of outline map fTexel = 1.0 / 512.0; sampling1 = saturate( uv + float2( fTexel, 0 ) ); sampling2 = saturate( uv + float2( -fTexel, 0 ) ); sampling3 = saturate( uv + float2( 0, fTexel ) ); sampling4 = saturate( uv + float2( 0, -fTexel ) ); float outline_x0 = texOutlineMap.Sample( sampler0, sampling1 ).x; float outline_x1 = texOutlineMap.Sample( sampler0, sampling2 ).x; float outline_y0 = texOutlineMap.Sample( sampler0, sampling3 ).x; float outline_y1 = texOutlineMap.Sample( sampler0, sampling4 ).x; float averageOutline = (outline_x0+outline_x1+outline_y0+outline_y1) / 4.0;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ent√£o, a julgar pelo c√≥digo do montador, √© calculada a diferen√ßa entre a m√©dia e o valor desse pixel espec√≠fico, ap√≥s o qual a distor√ß√£o por ru√≠do inteiro √© realizada: </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// perturb with noise float frameOutlineDifference = averageOutline - outlineMap.x; frameOutlineDifference *= noise0;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O pr√≥ximo passo √© distorcer o valor do mapa de contorno ‚Äúantigo‚Äù usando ru√≠do - esta √© a linha principal que confere √† textura de sa√≠da uma sensa√ß√£o de bloco. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depois, h√° outros c√°lculos, ap√≥s os quais, no final, a ‚Äúatenua√ß√£o‚Äù √© calculada.</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// the main place with gives blocky look of texture float newNoise = outlineMap.x * noise0; float newOutline = frameOutlineDifference * 0.9 + paramOutline; newOutline -= 0.24*newNoise; // 59: add r0.x, r0.y, r0.z float2 finalOutline = float2( outlineMap.x + newOutline, newOutline); // * calculate damping float dampingParam = saturate( cb3_v0.x ); dampingParam = pow( dampingParam, 100 ); float damping = 0.7 + 0.16*dampingParam; // * final multiplication float2 finalColor = finalOutline * damping; return float4(finalColor, 0, 0);</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aqui est√° um pequeno v√≠deo demonstrando um mapa de estrutura de t√≥picos em a√ß√£o: </font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/vSscLz2RYsQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ est√° interessado no sombreador de pixels completo, ele est√° dispon√≠vel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Shader √© compat√≠vel com o RenderDoc. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â interessante (e, para ser honesto, um pouco chato) que, apesar da identidade do c√≥digo do montador com o shader original de Witcher 3, a apar√™ncia final do mapa de contorno no RenderDoc esteja mudando! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota: na √∫ltima passagem (veja a pr√≥xima parte), voc√™ ver√° que apenas o canal .r do mapa de contorno √© usado. </font><font style="vertical-align: inherit;">Por que ent√£o precisamos do canal .g? </font><font style="vertical-align: inherit;">Eu acho que isso √© algum tipo de buffer de ping-pong em uma textura - observe que .r cont√©m o canal .g + algum novo valor.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parte 5: O Dom Witcher (Olho de Peixe e o resultado final) </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listaremos brevemente o que j√° temos: na primeira parte, dedicada ao instinto do bruxo, √© gerado um mapa de brilho em tela cheia que mostra o qu√£o percept√≠vel o efeito deve ser dependendo da dist√¢ncia. </font><font style="vertical-align: inherit;">Na segunda parte, explorei o mapa de contorno com mais detalhes, respons√°vel pelos contornos e pela anima√ß√£o do efeito final. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chegamos ao √∫ltimo est√°gio. </font><font style="vertical-align: inherit;">Tudo isso precisa ser combinado! </font><font style="vertical-align: inherit;">O √∫ltimo passe √© um quad em tela cheia. </font><font style="vertical-align: inherit;">Entradas: buffer de cores, mapa de contorno e mapa de lumin√¢ncia. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a6/7ed/667/2a67ed667870cd52dcf0da4f366975b6.jpg"></div><br><br>  Depois: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/abf/ce7/1c4/abfce71c4469b6dcd077723d498c1685.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mais uma vez vou mostrar o v√≠deo com o efeito aplicado: </font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/ReB6IrOb3ic" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como voc√™ pode ver, al√©m de aplicar contornos a objetos que Geralt pode ver ou ouvir, o efeito olho de peixe √© aplicado a toda a tela, e toda a tela (especialmente os cantos) fica acinzentada para transmitir a sensa√ß√£o de um verdadeiro ca√ßador de monstros. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo completo do shader de pixel montado:</font></font><br><br><pre> <code class="cpp hljs"> ps_5_0 dcl_globalFlags refactoringAllowed dcl_constantbuffer cb0[<span class="hljs-number"><span class="hljs-number">3</span></span>], immediateIndexed dcl_constantbuffer cb3[<span class="hljs-number"><span class="hljs-number">7</span></span>], immediateIndexed dcl_sampler s0, mode_default dcl_sampler s2, <span class="hljs-function"><span class="hljs-function">mode_default </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dcl_resource_texture2d</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> t0 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dcl_resource_texture2d</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> t2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dcl_resource_texture2d</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> t3 dcl_input_ps_siv v0.xy, position dcl_output o0.xyzw dcl_temps 7 0: div r0.xy, v0.xyxx, cb0[2].xyxx 1: mad r0.zw, r0.xxxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 2: mov r1.yz, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r0.zzwz)</span></span></span><span class="hljs-function"> 3: div r0.z, cb0[2].x, cb0[2].y 4: mul r1.x, r0.z, r1.y 5: add r0.zw, r1.xxxz, -cb3[2].xxxy 6: mul_sat r0.zw, r0.zzzw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.555556</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.555556</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 7: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">log</span></span></span><span class="hljs-function"> r0.zw, r0.zzzw 8: mul r0.zw, r0.zzzw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 9: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">exp</span></span></span><span class="hljs-function"> r0.zw, r0.zzzw 10: dp2 r0.z, r0.zwzz, r0.zwzz 11: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">sqrt</span></span></span><span class="hljs-function"> r0.z, r0.z 12: min r0.z, r0.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 13: add r0.z, -r0.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 14: mov_sat r0.w, cb3[6].x 15: add_sat r1.xy, -r0.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.030000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.030000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 16: add r1.x, r1.y, r1.x 17: add_sat r0.xy, r0.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.970000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.970000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 18: add r0.x, r0.x, r1.x 19: add r0.x, r0.y, r0.x 20: mul r0.x, r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">20.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 21: min r0.x, r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 22: add r1.xy, v0.xyxx, v0.xyxx 23: div r1.xy, r1.xyxx, cb0[2].xyxx 24: add r1.xy, r1.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 25: dp2 r0.y, r1.xyxx, r1.xyxx 26: mul r1.xy, r0.yyyy, r1.xyxx 27: mul r0.y, r0.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.100000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 28: mul r1.xy, r0.yyyy, r1.xyxx 29: max r1.xy, r1.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.400000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.400000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 30: min r1.xy, r1.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.400000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.400000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 31: mul r1.xy, r1.xyxx, cb3[1].xxxx 32: mul r1.zw, r1.xxxy, cb0[2].zzzw 33: mad r1.zw, v0.xxxy, cb0[1].zzzw, -r1.zzzw 34: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r2.xyz, r1.zwzz, t0.xyzw, s0 35: mul r3.xy, r1.zwzz, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 36: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r0.y, r3.xyxx, t2.yxzw, s2 37: mad r3.xy, r1.zwzz, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 38: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r2.w, r3.xyxx, t2.yzwx, s2 39: mul r2.w, r2.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 40: mul r3.x, cb0[0].x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.100000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 41: add r0.x, -r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 42: mul r0.xy, r0.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.030000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 43: mov r3.yzw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 44: mov r4.x, r0.y 45: mov r4.y, r2.w 46: mov r4.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 47: loop 48: ige r4.w, r4.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">8</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 49: breakc_nz r4.w 50: itof r4.w, r4.z 51: mad r4.w, r4.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.785375</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, -r3.x 52: sincos r5.x, r6.x, r4.w 53: mov r6.y, r5.x 54: mul r5.xy, r0.xxxx, r6.xyxx 55: mad r5.zw, r5.xxxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r1.zzzw 56: mul r6.xy, r5.zwzz, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 57: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r4.w, r6.xyxx, t2.yzwx, s2 58: mad r4.x, r4.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r4.x 59: mad r5.zw, r5.zzzw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 60: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r4.w, r5.zwzz, t2.yzwx, s2 61: mad r4.y, r4.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r4.y 62: mad r5.xy, r5.xyxx, r1.xyxx, r1.zwzz 63: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r5.xyz, r5.xyxx, t0.xyzw, s0 64: mad r3.yzw, r5.xxyz, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r3.yyzw 65: iadd r4.z, r4.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 66: endloop 67: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r0.xy, r1.zwzz, t3.xyzw, s0 68: mad_sat r0.xy, -r0.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.800000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.750000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r4.xyxx 69: dp3 r1.x, r3.yzwy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.300000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.300000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.300000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 70: add r1.yzw, -r1.xxxx, r3.yyzw 71: mad r1.xyz, r0.zzzz, r1.yzwy, r1.xxxx 72: mad r1.xyz, r1.xyzx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.600000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.600000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.600000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, -r2.xyzx 73: mad r1.xyz, r0.wwww, r1.xyzx, r2.xyzx 74: mul r0.yzw, r0.yyyy, cb3[4].xxyz 75: mul r2.xyz, r0.xxxx, cb3[5].xyzx 76: mad r0.xyz, r0.yzwy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.200000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.200000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.200000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r2.xyzx 77: mov_sat r2.xyz, r0.xyzx 78: dp3_sat r0.x, r0.xyzx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 79: add r0.yzw, -r1.xxyz, r2.xxyz 80: mad o0.xyz, r0.xxxx, r0.yzwy, r1.xyzx 81: mov o0.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 82: ret</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">82 linhas - por isso temos muito trabalho a fazer! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primeiro, d√™ uma olhada nos dados de entrada:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// *** Inputs // * Zoom amount, always 1 float zoomAmount = cb3_v1.x; // Another value which affect fisheye effect // but always set to float2(1.0, 1.0). float2 amount = cb0_v2.zw; // Elapsed time in seconds float time = cb0_v0.x; // Colors of witcher senses float3 colorInteresting = cb3_v5.rgb; float3 colorTraces = cb3_v4.rgb; // Was always set to float2(0.0, 0.0). // Setting this to higher values // makes "grey corners" effect weaker. float2 offset = cb3_v2.xy; // Dimensions of fullscreen float2 texSize = cb0_v2.xy; float2 invTexSize = cb0_v1.zw; // Main value which causes fisheye effect [0-1] const float fisheyeAmount = saturate( cb3_v6.x );</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O principal valor respons√°vel pela magnitude do efeito √© </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fisheyeAmount</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Eu acho que gradualmente aumenta de 0,0 para 1,0 quando Geralt come√ßa a usar seu instinto. </font><font style="vertical-align: inherit;">O restante dos valores dificilmente muda, mas suspeito que alguns deles seriam diferentes se o usu√°rio tivesse desativado o efeito olho de peixe nas op√ß√µes (n√£o verifiquei isso). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A primeira coisa que acontece aqui √© que o shader calcula a m√°scara respons√°vel pelos √¢ngulos cinzas:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">0</span></span>: div r0.xy, v0.xyxx, cb0[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxx <span class="hljs-number"><span class="hljs-number">1</span></span>: mad r0.zw, r0.xxxy, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">2</span></span>: mov r1.yz, <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(r0.zzwz) <span class="hljs-number"><span class="hljs-number">3</span></span>: div r0.z, cb0[<span class="hljs-number"><span class="hljs-number">2</span></span>].x, cb0[<span class="hljs-number"><span class="hljs-number">2</span></span>].y <span class="hljs-number"><span class="hljs-number">4</span></span>: mul r1.x, r0.z, r1.y <span class="hljs-number"><span class="hljs-number">5</span></span>: add r0.zw, r1.xxxz, -cb3[<span class="hljs-number"><span class="hljs-number">2</span></span>].xxxy <span class="hljs-number"><span class="hljs-number">6</span></span>: mul_sat r0.zw, r0.zzzw, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.555556</span></span>, <span class="hljs-number"><span class="hljs-number">0.555556</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> r0.zw, r0.zzzw <span class="hljs-number"><span class="hljs-number">8</span></span>: mul r0.zw, r0.zzzw, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.500000</span></span>, <span class="hljs-number"><span class="hljs-number">2.500000</span></span>) <span class="hljs-number"><span class="hljs-number">9</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">exp</span></span> r0.zw, r0.zzzw <span class="hljs-number"><span class="hljs-number">10</span></span>: dp2 r0.z, r0.zwzz, r0.zwzz <span class="hljs-number"><span class="hljs-number">11</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">sqrt</span></span> r0.z, r0.z <span class="hljs-number"><span class="hljs-number">12</span></span>: min r0.z, r0.z, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">13</span></span>: add r0.z, -r0.z, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No HLSL, podemos escrever isso da seguinte maneira: </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// Main uv float2 uv = PosH.xy / texSize; // Scale at first from [0-1] to [-1;1], then calculate abs float2 uv3 = abs( uv * 2.0 - 1.0); // Aspect ratio float aspectRatio = texSize.x / texSize.y; // * Mask used to make corners grey float mask_gray_corners; { float2 newUv = float2( uv3.x * aspectRatio, uv3.y ) - offset; newUv = saturate( newUv / 1.8 ); newUv = pow(newUv, 2.5); mask_gray_corners = 1-min(1.0, length(newUv) ); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primeiro, o intervalo [-1; </font><font style="vertical-align: inherit;">1] UV e seus valores absolutos. </font><font style="vertical-align: inherit;">Depois, h√° um "aperto" complicado. </font><font style="vertical-align: inherit;">A m√°scara finalizada √© a seguinte:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ba9/320/0d4/ba93200d4f20e0a5bc361e96994b525b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voltarei a esta m√°scara mais tarde. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora vou pular intencionalmente algumas linhas de c√≥digo e estudar cuidadosamente o c√≥digo respons√°vel pelo efeito de zoom.</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">22</span></span>: add r1.xy, v0.xyxx, v0.xyxx <span class="hljs-number"><span class="hljs-number">23</span></span>: div r1.xy, r1.xyxx, cb0[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxx <span class="hljs-number"><span class="hljs-number">24</span></span>: add r1.xy, r1.xyxx, l(<span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">25</span></span>: dp2 r0.y, r1.xyxx, r1.xyxx <span class="hljs-number"><span class="hljs-number">26</span></span>: mul r1.xy, r0.yyyy, r1.xyxx <span class="hljs-number"><span class="hljs-number">27</span></span>: mul r0.y, r0.w, l(<span class="hljs-number"><span class="hljs-number">0.100000</span></span>) <span class="hljs-number"><span class="hljs-number">28</span></span>: mul r1.xy, r0.yyyy, r1.xyxx <span class="hljs-number"><span class="hljs-number">29</span></span>: max r1.xy, r1.xyxx, l(<span class="hljs-number"><span class="hljs-number">-0.400000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.400000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">30</span></span>: min r1.xy, r1.xyxx, l(<span class="hljs-number"><span class="hljs-number">0.400000</span></span>, <span class="hljs-number"><span class="hljs-number">0.400000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">31</span></span>: mul r1.xy, r1.xyxx, cb3[<span class="hljs-number"><span class="hljs-number">1</span></span>].xxxx <span class="hljs-number"><span class="hljs-number">32</span></span>: mul r1.zw, r1.xxxy, cb0[<span class="hljs-number"><span class="hljs-number">2</span></span>].zzzw <span class="hljs-number"><span class="hljs-number">33</span></span>: mad r1.zw, v0.xxxy, cb0[<span class="hljs-number"><span class="hljs-number">1</span></span>].zzzw, -r1.zzzw</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Primeiro, as coordenadas de textura "dobradas" s√£o calculadas e a subtra√ß√£o flutuante2 (1, 1) √© realizada: </font></font><br><br><pre> <code class="cpp hljs"> float2 uv4 = <span class="hljs-number"><span class="hljs-number">2</span></span> * PosH.xy; uv4 /= cb0_v2.xy; uv4 -= float2(<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Esse texcoord pode ser visualizado da seguinte maneira: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/70a/0b0/dfe/70a0b0dfeb9ca86eb86f137ac96c9811.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em seguida </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, √© calculado o ponto do</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> produto escalar </font><i><font style="vertical-align: inherit;">(uv4, uv4)</font></i><font style="vertical-align: inherit;"> , o que nos fornece a m√°scara:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1f0/b6c/0a9/1f0b6c0a97ed9ad17a6bc17f3ebcf6c6.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que √© usado para multiplicar pelos cabos de texto acima: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e34/27e/5f2/e3427e5f2a925c8a78f77d81c5840da4.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Importante: no canto superior esquerdo (pixels pretos) os valores s√£o negativos. </font><font style="vertical-align: inherit;">Eles s√£o exibidos em preto (0,0) devido √† precis√£o limitada do formato R11G11B10_FLOAT. </font><font style="vertical-align: inherit;">Ele n√£o possui um bit de sinal, portanto, valores negativos n√£o podem ser armazenados nele. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em seguida, o coeficiente de atenua√ß√£o √© calculado (como eu disse acima, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fisheyeAmount</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> varia de 0,0 a 1,0).</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> attenuation = fisheyeAmount * <span class="hljs-number"><span class="hljs-number">0.1</span></span>; uv4 *= attenuation;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em seguida, a restri√ß√£o (max / min) e uma multiplica√ß√£o s√£o realizadas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assim, o deslocamento √© calculado. </font><font style="vertical-align: inherit;">Para calcular o uv final, que ser√° usado para provar a textura da cor, basta executar a subtra√ß√£o: </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">float2 colorUV = mainUv - offset; </font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao amostrar a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">textura de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cor </font><i><font style="vertical-align: inherit;">colorUV de</font></i><font style="vertical-align: inherit;"> entrada </font><font style="vertical-align: inherit;">, obtemos uma imagem distorcida nos cantos:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bbc/4f4/967/bbc4f4967c3bf008bf3692af3eb54d69.jpg"></div><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Esbo√ßos </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O pr√≥ximo passo √© fazer uma amostra do mapa de contornos para encontrar os contornos. </font><font style="vertical-align: inherit;">√â bem simples, primeiro encontramos os cabos de texto para amostrar os contornos de objetos interessantes e depois fazer o mesmo para as faixas:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// * Sample outline map // interesting objects (upper left square) float2 outlineUV = colorUV * 0.5; float outlineInteresting = texture2.Sample( sampler2, outlineUV ).x; // r0.y // traces (upper right square) outlineUV = colorUV * 0.5 + float2(0.5, 0.0); float outlineTraces = texture2.Sample( sampler2, outlineUV ).x; // r2.w outlineInteresting /= 8.0; // r4.x outlineTraces /= 8.0; // r4.y</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a08/746/0a3/a087460a37b1b88733e1fef632a566db.jpg"></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Objetos interessantes do mapa de contorno</font></font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0c6/edc/995/0c6edc995e2f6cb4c6aeec6701c30ba3.jpg"></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tra√ßos do mapa de contorno</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vale a pena notar que n√≥s coletamos apenas o canal .x do mapa de contorno e consideramos apenas os quadrados superiores.</font></font><br><br><h4>  Movimento </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para implementar o movimento das faixas, quase o mesmo truque √© usado como efeito de intoxica√ß√£o. </font><font style="vertical-align: inherit;">Um c√≠rculo do tamanho de uma unidade √© adicionado e amostramos 8 vezes o mapa de contorno para objetos e tra√ßos interessantes, bem como a textura da cor. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observe que apenas dividimos os caminhos encontrados por 8.0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como estamos no espa√ßo das coordenadas de textura [0-1] </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a presen√ßa de um c√≠rculo de raio 1 para circundar um √∫nico pixel criar√° artefatos inaceit√°veis:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3e3/8f1/de3/3e38f1de3016256205a5aa9199bb3a0d.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, antes de prosseguir, vamos descobrir como esse raio √© calculado. </font><font style="vertical-align: inherit;">Para fazer isso, precisamos retornar √†s linhas ausentes 15-21. </font><font style="vertical-align: inherit;">Um pequeno problema no c√°lculo desse raio √© que seu c√°lculo est√° espalhado pelo sombreador (possivelmente devido √†s otimiza√ß√µes do sombreador pelo compilador). </font><font style="vertical-align: inherit;">Portanto, aqui est√° a primeira parte (15-21) e a segunda (41-42):</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">15</span></span>: add_sat r1.xy, -r0.xyxx, l(<span class="hljs-number"><span class="hljs-number">0.030000</span></span>, <span class="hljs-number"><span class="hljs-number">0.030000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">16</span></span>: add r1.x, r1.y, r1.x <span class="hljs-number"><span class="hljs-number">17</span></span>: add_sat r0.xy, r0.xyxx, l(<span class="hljs-number"><span class="hljs-number">-0.970000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.970000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">18</span></span>: add r0.x, r0.x, r1.x <span class="hljs-number"><span class="hljs-number">19</span></span>: add r0.x, r0.y, r0.x <span class="hljs-number"><span class="hljs-number">20</span></span>: mul r0.x, r0.x, l(<span class="hljs-number"><span class="hljs-number">20.000000</span></span>) <span class="hljs-number"><span class="hljs-number">21</span></span>: min r0.x, r0.x, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) ... <span class="hljs-number"><span class="hljs-number">41</span></span>: add r0.x, -r0.x, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">42</span></span>: mul r0.xy, r0.xyxx, l(<span class="hljs-number"><span class="hljs-number">0.030000</span></span>, <span class="hljs-number"><span class="hljs-number">0.125000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como voc√™ pode ver, consideramos apenas texels de [0,00 - 0,03] ao lado de cada superf√≠cie, resumimos seus valores, multiplicamos 20 e saturamos. </font><font style="vertical-align: inherit;">Aqui est√° a apar√™ncia deles depois das linhas 15 a 21:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5b2/080/809/5b20808099b641be7510714ffd45a737.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> E aqui est√° como ap√≥s a linha 41: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fa8/51d/853/fa851d8539027d54d2874472d5952448.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na linha 42, multiplicamos isso por 0,03, esse valor √© o raio do c√≠rculo para a tela inteira. </font><font style="vertical-align: inherit;">Como voc√™ pode ver, mais perto das bordas da tela, o raio fica menor. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora podemos ver o c√≥digo do assembler respons√°vel pelo movimento:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">40</span></span>: mul r3.x, cb0[<span class="hljs-number"><span class="hljs-number">0</span></span>].x, l(<span class="hljs-number"><span class="hljs-number">0.100000</span></span>) <span class="hljs-number"><span class="hljs-number">41</span></span>: add r0.x, -r0.x, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">42</span></span>: mul r0.xy, r0.xyxx, l(<span class="hljs-number"><span class="hljs-number">0.030000</span></span>, <span class="hljs-number"><span class="hljs-number">0.125000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">43</span></span>: mov r3.yzw, l(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">44</span></span>: mov r4.x, r0.y <span class="hljs-number"><span class="hljs-number">45</span></span>: mov r4.y, r2.w <span class="hljs-number"><span class="hljs-number">46</span></span>: mov r4.z, l(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">47</span></span>: loop <span class="hljs-number"><span class="hljs-number">48</span></span>: ige r4.w, r4.z, l(<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-number"><span class="hljs-number">49</span></span>: breakc_nz r4.w <span class="hljs-number"><span class="hljs-number">50</span></span>: itof r4.w, r4.z <span class="hljs-number"><span class="hljs-number">51</span></span>: mad r4.w, r4.w, l(<span class="hljs-number"><span class="hljs-number">0.785375</span></span>), -r3.x <span class="hljs-number"><span class="hljs-number">52</span></span>: sincos r5.x, r6.x, r4.w <span class="hljs-number"><span class="hljs-number">53</span></span>: mov r6.y, r5.x <span class="hljs-number"><span class="hljs-number">54</span></span>: mul r5.xy, r0.xxxx, r6.xyxx <span class="hljs-number"><span class="hljs-number">55</span></span>: mad r5.zw, r5.xxxy, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.125000</span></span>, <span class="hljs-number"><span class="hljs-number">0.125000</span></span>), r1.zzzw <span class="hljs-number"><span class="hljs-number">56</span></span>: mul r6.xy, r5.zwzz, l(<span class="hljs-number"><span class="hljs-number">0.500000</span></span>, <span class="hljs-number"><span class="hljs-number">0.500000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">57</span></span>: sample_indexable(texture2d)(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) r4.w, r6.xyxx, t2.yzwx, s2 <span class="hljs-number"><span class="hljs-number">58</span></span>: mad r4.x, r4.w, l(<span class="hljs-number"><span class="hljs-number">0.125000</span></span>), r4.x <span class="hljs-number"><span class="hljs-number">59</span></span>: mad r5.zw, r5.zzzw, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.500000</span></span>, <span class="hljs-number"><span class="hljs-number">0.500000</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.500000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">60</span></span>: sample_indexable(texture2d)(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) r4.w, r5.zwzz, t2.yzwx, s2 <span class="hljs-number"><span class="hljs-number">61</span></span>: mad r4.y, r4.w, l(<span class="hljs-number"><span class="hljs-number">0.125000</span></span>), r4.y <span class="hljs-number"><span class="hljs-number">62</span></span>: mad r5.xy, r5.xyxx, r1.xyxx, r1.zwzz <span class="hljs-number"><span class="hljs-number">63</span></span>: sample_indexable(texture2d)(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) r5.xyz, r5.xyxx, t0.xyzw, s0 <span class="hljs-number"><span class="hljs-number">64</span></span>: mad r3.yzw, r5.xxyz, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.125000</span></span>, <span class="hljs-number"><span class="hljs-number">0.125000</span></span>, <span class="hljs-number"><span class="hljs-number">0.125000</span></span>), r3.yyzw <span class="hljs-number"><span class="hljs-number">65</span></span>: iadd r4.z, r4.z, l(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">66</span></span>: endloop</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos ficar aqui por um minuto. Na linha 40, obtemos o coeficiente de tempo - apenas </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">decorridoTime * 0,1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Na linha 43, temos um buffer para a textura da cor obtida dentro do loop. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r0.x</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (linhas 41-42) √©, como sabemos agora, o raio do c√≠rculo. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r4.x</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (linha 44) √© o contorno de objetos interessantes, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r4.y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (linha 45) √© o contorno de faixas (anteriormente dividido por 8!) e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r4.z</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (linha 46) √© o contador de loop. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como voc√™ pode esperar, o loop possui 8 itera√ß√µes. Come√ßamos calculando o √¢ngulo em radianos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i * PI_4</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o que nos d√° 2 * PI - um c√≠rculo completo. O √¢ngulo √© distorcido ao longo do tempo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando sincos, determinamos o ponto de amostragem (c√≠rculo unit√°rio) e alteramos o raio usando a multiplica√ß√£o (linha 54). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depois disso, contornamos o pixel em um c√≠rculo e mostramos os contornos e cores. </font><font style="vertical-align: inherit;">Ap√≥s o ciclo, obtemos os valores m√©dios (devido √† divis√£o por 8) dos contornos e cores.</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> timeParam = time * <span class="hljs-number"><span class="hljs-number">0.1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// adjust circle radius circle_radius = 1.0 - circle_radius; circle_radius *= 0.03; float3 color_circle_main = float3(0.0, 0.0, 0.0); [loop] for (int i=0; 8 &gt; i; i++) { // full 2*PI = 360 angles cycle const float angleRadians = (float) i * PI_4 - timeParam; // unit circle float2 unitCircle; sincos(angleRadians, unitCircle.y, unitCircle.x); // unitCircle.x = cos, unitCircle.y = sin // adjust radius unitCircle *= circle_radius; // * base texcoords (circle) - note we also scale radius here by 8 // * probably because of dimensions of outline map. // line 55 float2 uv_outline_base = colorUV + unitCircle / 8.0; // * interesting objects (circle) float2 uv_outline_interesting_circle = uv_outline_base * 0.5; float outline_interesting_circle = texture2.Sample( sampler2, uv_outline_interesting_circle ).x; outlineInteresting += outline_interesting_circle / 8.0; // * traces (circle) float2 uv_outline_traces_circle = uv_outline_base * 0.5 + float2(0.5, 0.0); float outline_traces_circle = texture2.Sample( sampler2, uv_outline_traces_circle ).x; outlineTraces += outline_traces_circle / 8.0; // * sample color texture (zooming effect) with perturbation float2 uv_color_circle = colorUV + unitCircle * offsetUV; float3 color_circle = texture0.Sample( sampler0, uv_color_circle ).rgb; color_circle_main += color_circle / 8.0; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A amostragem de cores ser√° realizada da mesma maneira, mas </font><font style="vertical-align: inherit;">adicionaremos um deslocamento multiplicado por um c√≠rculo "√∫nico" </font><font style="vertical-align: inherit;">ao </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">colorVV</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> base </font><font style="vertical-align: inherit;">.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Brilho </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ap√≥s o ciclo, amostramos o mapa de brilho e alteramos os valores finais de brilho (porque o mapa de brilho n√£o sabe nada sobre os contornos): </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">67</span></span>: sample_indexable(texture2d)(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) r0.xy, r1.zwzz, t3.xyzw, s0 <span class="hljs-number"><span class="hljs-number">68</span></span>: mad_sat r0.xy, -r0.xyxx, l(<span class="hljs-number"><span class="hljs-number">0.800000</span></span>, <span class="hljs-number"><span class="hljs-number">0.750000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), r4.xyxx</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> C√≥digo HLSL: </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// * Sample intensity map float2 intensityMap = texture3.Sample( sampler0, colorUV ).xy; float intensityInteresting = intensityMap.r; float intensityTraces = intensityMap.g; // * Adjust outlines float mainOutlineInteresting = saturate( outlineInteresting - 0.8*intensityInteresting ); float mainOutlineTraces = saturate( outlineTraces - 0.75*intensityTraces );</span></span></code> </pre> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cantos cinzentos e a unifica√ß√£o final de tudo </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A cor cinza mais pr√≥xima dos cantos √© calculada usando o produto escalar (linha de montagem 69): </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// * Greyish color float3 color_greyish = dot( color_circle_main, float3(0.3, 0.3, 0.3) ).xxx;</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b55/9a1/e0f/b559a1e0f3ae66041cdf3f9f48ba4b06.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em seguida, duas interpola√ß√µes seguem. </font><font style="vertical-align: inherit;">A primeira combina cinza com a "cor no c√≠rculo" usando a primeira m√°scara que descrevi, para que os cantos fiquem cinza. </font><font style="vertical-align: inherit;">Al√©m disso, existe um coeficiente de 0,6, que reduz a satura√ß√£o da imagem final:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c6a/389/202/c6a38920286de2fe269224a6b26ebd77.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A segunda combina a primeira cor com a acima, usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fisheyeAmount</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Isso significa que a tela fica gradualmente mais escura (devido √† multiplica√ß√£o de 0,6) e cinza nos cantos! </font><font style="vertical-align: inherit;">Engenhoso. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HLSL:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// * Determine main color. // (1) At first, combine "circled" color with gray one. // Now we have have greyish corners here. float3 mainColor = lerp( color_greyish, color_circle_main, mask_gray_corners ) * 0.6; // (2) Then mix "regular" color with the above. // Please note this operation makes corners gradually gray (because fisheyeAmount rises from 0 to 1) // and gradually darker (because of 0.6 multiplier). mainColor = lerp( color, mainColor, fisheyeAmount );</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora podemos adicionar os contornos dos objetos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As cores (vermelho e amarelo) s√£o retiradas do buffer constante.</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// * Determine color of witcher senses float3 senses_traces = mainOutlineTraces * colorTraces; float3 senses_interesting = mainOutlineInteresting * colorInteresting; float3 senses_total = 1.2 * senses_traces + senses_interesting;</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9ca/4ea/52d/9ca4ea52df8a22889828414ee2bfde05.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fuh! </font><font style="vertical-align: inherit;">Estamos quase na linha de chegada! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temos a cor final, existe a cor do instinto da bruxa ... resta combin√°-los de alguma forma! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E para isso, a adi√ß√£o simples n√£o √© adequada. </font><font style="vertical-align: inherit;">Primeiro, calculamos o produto escalar:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">78</span></span>: dp3_sat r0.x, r0.xyzx, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dot_senses_total = saturate( dot(senses_total, float3(<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>) ) );</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que se parece com isso: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ae/357/099/2ae357099e5bfe5185d16103f87a6b69.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> E esses valores no final s√£o usados ‚Äã‚Äãpara interpolar entre a cor e o talento (saturado) da bruxa: </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">76</span></span>: mad r0.xyz, r0.yzwy, l(<span class="hljs-number"><span class="hljs-number">1.200000</span></span>, <span class="hljs-number"><span class="hljs-number">1.200000</span></span>, <span class="hljs-number"><span class="hljs-number">1.200000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), r2.xyzx <span class="hljs-number"><span class="hljs-number">77</span></span>: mov_sat r2.xyz, r0.xyzx <span class="hljs-number"><span class="hljs-number">78</span></span>: dp3_sat r0.x, r0.xyzx, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">79</span></span>: add r0.yzw, -r1.xxyz, r2.xxyz <span class="hljs-number"><span class="hljs-number">80</span></span>: mad o0.xyz, r0.xxxx, r0.yzwy, r1.xyzx <span class="hljs-number"><span class="hljs-number">81</span></span>: mov o0.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">82</span></span>: ret float3 senses_total = <span class="hljs-number"><span class="hljs-number">1.2</span></span> * senses_traces + senses_interesting; <span class="hljs-comment"><span class="hljs-comment">// * Final combining float3 senses_total_sat = saturate(senses_total); float dot_senses_total = saturate( dot(senses_total, float3(1.0, 1.0, 1.0) ) ); float3 finalColor = lerp( mainColor, senses_total_sat, dot_senses_total ); return float4( finalColor, 1.0 );</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/abf/ce7/1c4/abfce71c4469b6dcd077723d498c1685.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E isso √© tudo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O shader completo est√° dispon√≠vel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compara√ß√£o dos meus shaders (esquerdo) e originais (direito):</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/433/5be/2e4/4335be2e49bd901916567734cc0485a5.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espero que voc√™ tenha gostado deste artigo! </font><font style="vertical-align: inherit;">Existem muitas id√©ias brilhantes na mec√¢nica do "instinto bruxo", e o resultado final √© muito plaus√≠vel. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[Partes anteriores da an√°lise: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primeiro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">segundo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .]</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt450332/">https://habr.com/ru/post/pt450332/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt450318/index.html">Padr√µes de design no desenvolvimento moderno de JavaScript</a></li>
<li><a href="../pt450320/index.html">Jogos qu√¢nticos simples revelam a complexidade final do universo</a></li>
<li><a href="../pt450322/index.html">Por que precisamos de tantos mensageiros?</a></li>
<li><a href="../pt450324/index.html">Como o sistema de rastreamento de produtividade dispensa automaticamente funcion√°rios da Amazon</a></li>
<li><a href="../pt450330/index.html">Escolhendo uma escola ao se mudar para os EUA</a></li>
<li><a href="../pt450334/index.html">IaaS e TI gerenciada: resumo da tecnologia</a></li>
<li><a href="../pt450340/index.html">Como analisar o site de um concorrente gratuitamente. Instru√ß√µes passo a passo</a></li>
<li><a href="../pt450342/index.html">Sobre coisas simples, complicadas. Devolvemos as aves dom√©sticas ou RTFM para a defini√ß√£o de pl√°sticos em casa</a></li>
<li><a href="../pt450344/index.html">Uma postagem com bandeira branca ou Como eu salvei seu curso em v√≠deo de aparecer no rastreador</a></li>
<li><a href="../pt450346/index.html">Ber√ßo Cottage de Newton</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>