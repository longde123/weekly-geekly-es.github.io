<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🔧 ⌨️ 🔍 6 praktische Geschichten von unseren SRE-Wochentagen 🏍️ 🧜🏼 🍻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die moderne Webinfrastruktur besteht aus vielen Komponenten für verschiedene Zwecke, die offensichtlich und nicht sehr miteinander verbunden sind. Die...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>6 praktische Geschichten von unseren SRE-Wochentagen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/471892/"><img src="https://habrastorage.org/webt/7_/c-/_w/7_c-_wura080ohc4zdfyq6ummtw.png"><br><br>  Die moderne Webinfrastruktur besteht aus vielen Komponenten für verschiedene Zwecke, die offensichtlich und nicht sehr miteinander verbunden sind.  Dies wird besonders deutlich, wenn Anwendungen betrieben werden, die unterschiedliche Software-Stacks verwenden, die mit dem Aufkommen von Microservices buchstäblich bei jedem Schritt auftraten.  Externe Faktoren (APIs, Dienste usw. von Drittanbietern) werden zum allgemeinen „Spaß“ hinzugefügt, was ein bereits schwieriges Bild kompliziert. <br><br>  Selbst wenn diese Anwendungen durch gemeinsame architektonische Ideen und Lösungen vereint werden, müssen sie im Allgemeinen häufig durch die nächste unbekannte Wildnis waten, um ungewöhnliche Probleme zu beseitigen.  Ob solche Probleme auftreten, ist nur eine Frage der Zeit.  Dies sind die Beispiele aus unserer neuesten Praxis, der dieser Artikel gewidmet ist.  Darsteller: Golang, Sentry, RabbitMQ, Nginx, PostgreSQL und andere. <a name="habracut"></a><br><br><h2>  Geschichte Nr. 1.  Golang und HTTP / 2 </h2><br>  Das Ausführen eines Benchmarks, der viele HTTP-Anforderungen an eine Webanwendung ausführt, hat zu unerwarteten Ergebnissen geführt.  Eine einfache Go-Anwendung im Benchmark-Prozess wird an eine andere Go-Anwendung gesendet, die sich hinter ingress / openresty befindet.  Wenn HTTP / 2 aktiviert ist, erhalten wir für einige Anforderungen Fehler mit Code 400. Um den Grund für dieses Verhalten zu verstehen, haben wir die Go-Anwendung am anderen Ende der Kette entfernt und einen einfachen Speicherort in Ingress erstellt, der immer 200 zurückgibt. Das Verhalten hat sich nicht geändert! <cut></cut><br><br>  Dann wurde beschlossen, das Skript außerhalb der Kubernetes-Umgebung zu reproduzieren - auf einer anderen Hardware.  Das Ergebnis war ein Makefile, mit dessen Hilfe zwei Container gestartet werden: in einem - Benchmarks, die an Nginx gehen, im anderen - in Apache.  Beide hören HTTP / 2 mit einem selbstsignierten Zertifikat ab.  Die endgültige Betriebszeit finden Sie in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/flant/examples/tree/master/2019/09-">diesem Repository</a> . <br><br>  Führen Sie die Benchmarks mit <code>concurrency=200</code> : <br><br>  1.1.  Nginx: <br><br><pre> <code class="plaintext hljs">Completed 0 requests Completed 1000 requests Completed 2000 requests Completed 3000 requests Completed 4000 requests Completed 5000 requests Completed 6000 requests Completed 7000 requests Completed 8000 requests Completed 9000 requests ----- Bench results begin ----- Requests per second: 10336.09 Failed requests: 1623 ----- Bench results end -----</code> </pre> <br>  1.2.  Apache: <br><br><pre> <code class="plaintext hljs">… ----- Bench results begin ----- Requests per second: 11427.60 Failed requests: 0 ----- Bench results end -----</code> </pre> <br>  Wir gehen davon aus, dass es hier um eine weniger strenge Implementierung von HTTP / 2 in Apache geht. <br><br>  Versuchen wir es mit <code>concurrency=1000</code> : <br><br>  2.1.  Nginx: <br><br><pre> <code class="plaintext hljs">… ----- Bench results begin ----- Requests per second: 11274.92 Failed requests: 4205 ----- Bench results end -----</code> </pre> <br>  2.2.  Apache: <br><br><pre> <code class="plaintext hljs">… ----- Bench results begin ----- Requests per second: 11211.48 Failed requests: 5 ----- Bench results end -----</code> </pre> <br>  Gleichzeitig stellen wir fest, dass die Ergebnisse <i>nicht jedes Mal reproduziert werden</i> : Einige der Starts verlaufen ohne Probleme. <br><br>  Eine Suche nach Problemen im Github des Golang-Projekts führte zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="># 25009</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="># 32441</a> .  Durch sie gingen wir zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PR 903</a> : Deaktivieren von HTTP / 2 in Go standardmäßig! <br><br>  Das Interpretieren von Benchmark-Ergebnissen, ohne tief in die Architektur der oben genannten Webserver einzutauchen, ist ziemlich schwierig.  In einem bestimmten Fall war es ausreichend, HTTP / 2 für den angegebenen Dienst zu deaktivieren. <br><br><h2>  Geschichte Nr. 2.  Alte Symfonie und Wachposten </h2><br>  In einem der Projekte funktioniert noch eine sehr alte Version des symfony PHP Framework (v2.3).  Ein alter Raven-Client und eine selbstgeschriebene Klasse in PHP sind "im Kit" angehängt, was das Debuggen etwas erschwert. <br><br>  Nach der Übertragung eines der Dienste in Kubernetes an Sentry, mit dem Fehler bei der Anwendung dieses Projekts verfolgt wurden, kamen plötzlich keine Ereignisse mehr.  Um dieses Verhalten zu reproduzieren, haben wir Beispiele von der Sentry-Website verwendet, zwei Optionen ausgewählt und den DSN aus den Sentry-Einstellungen kopiert.  Optisch hat alles geklappt: Fehlermeldungen (angeblich) wurden nacheinander gesendet. <br><br>  JavaScript-Überprüfungsoption: <br><br><pre> <code class="javascript hljs">&lt;!DOCTYPE html&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"https://browser.sentry-cdn.com/5.6.3/bundle.min.js"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">integrity</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"sha384-/Cqa/8kaWn7emdqIBLk3AkFMAHBk0LObErtMhO+hr52CntkaurEnihPmqYj3uJho"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">crossorigin</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"anonymous"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="undefined"><span class="xml"><span class="undefined"> </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">JavaScript in Body</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"demo"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">A Paragraph.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"myFunction()"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Try it</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="javascript"><span class="xml"><span class="javascript"> Sentry.init({ </span></span><span class="hljs-attr"><span class="xml"><span class="javascript"><span class="hljs-attr">dsn</span></span></span></span><span class="xml"><span class="javascript">: </span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'http://33dddd76e9f0c4ddcdb51@sentry.kube-dev.test//12'</span></span></span></span><span class="xml"><span class="javascript"> }); </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">try</span></span></span></span><span class="xml"><span class="javascript"> { </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">throw</span></span></span></span><span class="xml"><span class="javascript"> </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">new</span></span></span></span><span class="xml"><span class="javascript"> </span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">Error</span></span></span></span><span class="xml"><span class="javascript">(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'Caught'</span></span></span></span><span class="xml"><span class="javascript">); } </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">catch</span></span></span></span><span class="xml"><span class="javascript"> (err) { Sentry.captureException(err); } </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br>  Ähnlich in Python: <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sentry_sdk <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> init, capture_message init(<span class="hljs-string"><span class="hljs-string">"http://33dddd76e9f0c4ddcdb51@sentry.kube-dev.test//12"</span></span>) capture_message(<span class="hljs-string"><span class="hljs-string">"Hello World"</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Will create an event. raise ValueError()</span></span></code> </pre> <br>  Sie kamen jedoch nicht in Sentry.  Beim Senden einer Nachricht wird die Illusion erzeugt, dass die Nachricht gesendet wurde, da Clients sofort einen Hash für das Problem generieren. <br><br>  Infolgedessen wurde das Problem sehr einfach gelöst: Das Senden von Ereignissen ging an HTTP, und der Sentry-Dienst hörte nur HTTPS ab.  Es wurde eine Umleitung von HTTP zu HTTPS bereitgestellt, aber der alte Client (der Code auf der Symfony-Seite) konnte den Weiterleitungen nicht folgen, die Sie heutzutage standardmäßig nicht erwarten. <br><br><h2>  Geschichte Nr. 3.  RabbitMQ und Proxy von Drittanbietern </h2><br>  In einem Projekt wird die Evotor-Cloud zum Verbinden von Registrierkassen verwendet.  Tatsächlich funktioniert es als Proxy: POST-Anforderungen von Evotor gehen direkt an RabbitMQ - über das über WebSocket-Verbindungen implementierte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">STOMP-Plugin</a> . <br><br>  Einer der Entwickler stellte Testanfragen mit Postman und erhielt die erwarteten Antworten von <code>200 OK</code> . Anfragen über die Cloud führten jedoch zu unerwarteten <code>405 Method Not Allowed</code> . <br><br><div class="spoiler">  <b class="spoiler_title">200 OK</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">source: kubernetes namespace: kube-nginx-ingress host: kube-node-2 pod_name: nginx-2bpt7 container_name: nginx stream: stdout app: nginx controller-revision-hash: 5bdbfd564 pod-template-generation: 25 time: 2019-09-10T09:42:50+00:00 request_id: 1271dba228f0943ab2df0196ff0d7f67 user: client address: 100.200.300.400 protocol: HTTP/1.1 scheme: http method: POST host: rmq-review.kube-dev.client.domain path: /api/queues/vhost/queue.gen.eeeeffff111:1.onlinecassa:55556666/get request_query: referrer: user_agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36 content_kind: cacheable namespace: review ingress: stomp-ws service: rabbitmq service_port: stats vhost: rmq-review.kube-dev.client.domain location: / nginx_upstream_addr: 10.127.1.1:15672 nginx_upstream_bytes_received: 2538 nginx_upstream_response_time: 0.008 nginx_upstream_status: 200 bytes_received: 757 bytes_sent: 1254 request_time: 0 status: 200 upstream_response_time: 0 upstream_retries: 0</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">405 Methode nicht zulässig</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">source: kubernetes namespace: kube-nginx-ingress host: kube-node-1 pod_name: nginx-4xx6h container_name: nginx stream: stdout app: nginx controller-revision-hash: 5bdbfd564 pod-template-generation: 25 time: 2019-09-10T09:46:26+00:00 request_id: b8dd789604864c95b4af499ed6805630 user: client address: 200.100.300.400 protocol: HTTP/1.1 scheme: http method: POST host: rmq-review.kube-dev.client.domain path: /api/queues/vhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get request_query: referrer: user_agent: ru.evotor.proxy/37 content_kind: cache-headers-not-present namespace: review ingress: stomp-ws service: rabbitmq service_port: stats vhost: rmq-review.kube-dev.client.domain location: / nginx_upstream_addr: 10.127.1.1:15672 nginx_upstream_bytes_received: 134 nginx_upstream_response_time: 0.004 nginx_upstream_status: 405 bytes_received: 878 bytes_sent: 137 request_time: 0 status: 405 upstream_response_time: 0 upstream_retries: 0</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Tcpdump-Anfrage von Evotor</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">200.100.300.400.21519 &gt; 100.200.400.300: Flags [P.], cksum 0x8e29 (correct), seq 1:879, ack 1, win 221, options [nop,nop,TS val 2313007107 ecr 79097074], length 878: HTTP, length: 878 POST /api/queues//vhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get HTTP/1.1 device-model: ST-5 device-os: android Accept-Encoding: gzip content-type: application/json; charset=utf-8 connection: close accept: application/json x-original-forwarded-for: 10.11.12.13 originhost: rmq-review.kube-dev.client.domain x-original-uri: /api/v2/apps/e114-aaef-bbbb-beee-abadada44ae/requests x-scheme: https accept-encoding: gzip user-agent: ru.evotor.proxy/37 Authorization: Basic X-Evotor-Store-Uuid: 20180417-73DC-40C9-80B7-00E990B77D2D X-Evotor-Device-Uuid: 20190909-A47B-40EA-806A-F7BC33833270 X-Evotor-User-Id: 01-000000000147888 Content-Length: 58 Host: rmq-review.kube-dev.client.domain {"count":1,"encoding":"auto","ackmode":"ack_requeue_true"}[!http] 12:53:30.095385 IP (tos 0x0, ttl 64, id 5512, offset 0, flags [DF], proto TCP (6), length 52) 100.200.400.300:80 &gt; 200.100.300.400.21519: Flags [.], cksum 0xfa81 (incorrect -&gt; 0x3c87), seq 1, ack 879, win 60, options [nop,nop,TS val 79097122 ecr 2313007107], length 0 12:53:30.096876 IP (tos 0x0, ttl 64, id 5513, offset 0, flags [DF], proto TCP (6), length 189) 100.200.400.300:80 &gt; 200.100.300.400.21519: Flags [P.], cksum 0xfb0a (incorrect -&gt; 0x03b9), seq 1:138, ack 879, win 60, options [nop,nop,TS val 79097123 ecr 2313007107], length 137: HTTP, length: 137 HTTP/1.1 405 Method Not Allowed Date: Tue, 10 Sep 2019 10:53:30 GMT Content-Length: 0 Connection: close allow: HEAD, GET, OPTIONS</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Tcpdump-Anfrage von curl</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">777.10.74.11.61211 &gt; 100.200.400.300:80: Flags [P.], cksum 0x32a8 (correct), seq 1:397, ack 1, win 2052, options [nop,nop,TS val 734012594 ecr 4012360530], length 396: HTTP, length: 396 POST /api/queues/%2Fvhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get HTTP/1.1 Host: rmq-review.kube-dev.client.domain User-Agent: curl/7.54.0 Authorization: Basic = Content-Type: application/json Accept: application/json Content-Length: 58 {"count":1,"ackmode":"ack_requeue_true","encoding":"auto"}[!http] 12:40:11.001442 IP (tos 0x0, ttl 64, id 50844, offset 0, flags [DF], proto TCP (6), length 52) 100.200.400.300:80 &gt; 777.10.74.11.61211: Flags [.], cksum 0x2d01 (incorrect -&gt; 0xfa25), seq 1, ack 397, win 59, options [nop,nop,TS val 4012360590 ecr 734012594], length 0 12:40:11.017065 IP (tos 0x0, ttl 64, id 50845, offset 0, flags [DF], proto TCP (6), length 2621) 100.200.400.300:80 &gt; 777.10.74.11.61211: Flags [P.], cksum 0x370a (incorrect -&gt; 0x6872), seq 1:2570, ack 397, win 59, options [nop,nop,TS val 4012360605 ecr 734012594], length 2569: HTTP, length: 2569 HTTP/1.1 200 OK Date: Tue, 10 Sep 2019 10:40:11 GMT Content-Type: application/json Content-Length: 2348 Connection: keep-alive Vary: Accept-Encoding cache-control: no-cache vary: accept, accept-encoding, origin</code> </pre> </div></div><br>  Das geschulte Auge eines Ingenieurs sieht sofort den Unterschied: <br><br><ul><li>  curl: <code>POST /api/queues/%2Fclient…</code> </li><li>  Evotor: <code>POST /api/queues//client…</code> </li></ul><br>  Die Sache war, dass in einem Fall ein unverständlicher (für RabbitMQ) <code>//vhost</code> und in dem anderen - <code>%2Fvhost</code> , was das erwartete Verhalten ist, wenn: <br><br><pre> <code class="plaintext hljs"># rabbitmqctl list_vhosts Listing vhosts ... /vhost</code> </pre> <br>  In der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ausgabe</a> des RabbitMQ-Projekts zu diesem Thema erklärt der Entwickler: <br><br><blockquote>  Wir werden% -encoding nicht ersetzen.  Es ist eine Standardmethode für die URL-Pfadcodierung und das schon seit Ewigkeiten.  Die Annahme, dass die% -Kodierung in HTTP-basierten Tools aufgrund des gängigsten Frameworks, das davon ausgeht, dass solche URL-Pfade "böswillig" sind, nicht mehr funktioniert, ist kurzsichtig und naiv.  Der Standardname des virtuellen Hosts kann <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">in einen beliebigen Wert geändert werden</a> (z. B. einen, der keine Schrägstriche oder andere Zeichen verwendet, für die% -Codierung erforderlich ist). Zumindest mit der Pivotal BOSH-Version von RabbitMQ wird der virtuelle Standardhost zum Zeitpunkt der Bereitstellung ohnehin gelöscht . </blockquote><br>  Das Problem wurde ohne weitere Beteiligung unserer Ingenieure gelöst (auf der Evotor-Seite nach Kontaktaufnahme). <br><br><h2>  Geschichte Nr. 4.  Gen in PostgreSQL </h2><br>  PostgreSQL hat einen sehr nützlichen Index, der oft vergessen wird.  Diese Geschichte begann mit Beschwerden über die Bremsen in der Anwendung.  In einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">kürzlich erschienenen Artikel haben</a> wir bereits ein Beispiel für einen ungefähren Workflow bei der Analyse solcher Situationen angegeben.  Und hier zeigte unser APM - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Atatus</a> - folgendes Bild: <br><br><img src="https://habrastorage.org/webt/t9/yy/gz/t9yygzwma4valcmjnpt-lbfxpdi.png"><br><br>  Um 10 Uhr morgens erhöht sich die Zeit, die die Anwendung für die Arbeit mit der Datenbank benötigt.  Der Grund liegt erwartungsgemäß in den langsamen Reaktionen des DBMS.  Für uns ist es eine verständliche Routine, Abfragen zu analysieren, Problembereiche zu identifizieren und Indizes zu „hängen“.  Das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">von</a> uns verwendete <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Okmeter</a> hilft dabei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">sehr</a> : Es gibt sowohl Standard-Panels zur Überwachung des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Serverstatus</a> als auch die Möglichkeit, <i>schnell</i> eigene zu erstellen - mit der Ausgabe problematischer Metriken: <br><br><img src="https://habrastorage.org/webt/5r/8h/2p/5r8h2pfgbo_rxewvzgf_3jyjcii.png"><br><br>  Diagramme zur CPU-Auslastung zeigen an, dass eine der Datenbanken zu 100% ausgelastet ist.  Warum?  Die neuen PostgreSQL-Panels werden Folgendes auffordern: <br><br><img src="https://habrastorage.org/webt/i0/pq/de/i0pqdejoizrp518mnsnguoljkdg.png"><br><br>  Die Ursache der Probleme ist sofort ersichtlich - der Hauptverbraucher der CPU: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> u.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> u.id = ? &amp; u.field_1 = ? <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> u.field_2 <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%somestring%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> u.id <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> ?</code> </pre> <br>  In Anbetracht des Arbeitsplans der Problemabfrage haben wir festgestellt, dass das Filtern nach indizierten Feldern der Tabelle eine zu große Auswahl ergibt: Die Datenbank empfängt mehr als <code>field_1</code> Zeilen nach <code>id</code> und <code>field_1</code> und sucht dann nach einem Teilstring unter ihnen.  Es stellt sich heraus, dass <code>LIKE</code> auf einem Teilstring eine große Menge von Textdaten durchläuft, was zu einer ernsthaften Verlangsamung der Abfrageausführung und einer Erhöhung der CPU-Auslastung führt. <br><br>  <i>Hier können Sie zu Recht feststellen, dass ein Architekturproblem nicht ausgeschlossen ist (eine Korrektur der Anwendungslogik oder sogar eine Volltext-Engine ist erforderlich ...), aber es gibt keine Zeit für Nacharbeiten, aber es hätte vor 15 Minuten schnell funktionieren müssen.</i>  <i>Gleichzeitig ist das Suchwort tatsächlich eine Kennung (und warum nicht in einem separaten Feld? ..), die Zeileneinheiten erzeugt.</i>  <i>Wenn wir einen Index für dieses Textfeld erstellen könnten, wären alle anderen unnötig.</i> <br><br>  Die letzte aktuelle Lösung besteht darin, einen GIN-Index für <code>field_2</code> .  Das ist der Held des Tages - der gleiche "Geist".  Kurz gesagt, GIN ist eine Art Index, der bei der Volltextsuche eine sehr gute Leistung erbringt und ihn qualitativ beschleunigt.  Mehr darüber können Sie zum Beispiel in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesem wunderbaren Material</a> lesen. <br><br><img src="https://habrastorage.org/webt/sm/lw/qd/smlwqdjwdystzwexf0rfz-hk6qq.png"><br><br>  Wie Sie sehen können, konnte mit dieser einfachen Operation die zusätzliche Last entfernt und damit Geld für den Kunden gespart werden. <br><br><h2>  Geschichte Nr. 5.  Zwischenspeichern von s3 in Nginx </h2><br>  S3-kompatibler Cloud-Speicher steht seit langem fest auf der Liste der Technologien, die von vielen Projekten verwendet werden.  Wenn Sie einen zuverlässigen Bildspeicher für Ihre Site oder für neuronale Netzwerkdaten benötigen, ist Amazon S3 eine gute Wahl.  Die Zuverlässigkeit der Speicherung und die hohe Datenverfügbarkeit (und das Fehlen der Notwendigkeit, den Garten zu "umzäunen") sind faszinierend. <br><br>  Manchmal ist es jedoch eine gute Lösung, einen Caching-Proxyserver vor dem Speicher zu installieren, um Geld zu sparen, da die Zahlung für S3 normalerweise für Anforderungen und für den Datenverkehr erfolgt.  Diese Methode reduziert die Kosten, wenn es beispielsweise um Benutzeravatare geht, von denen es auf jeder Seite viele gibt. <br><br>  Es scheint, dass es einfacher ist, als Nginx zu nehmen und Proxys mit Caching, Revalidierung, Hintergrundaktualisierung und anderem Blackjack einzurichten?  Wie auch anderswo gibt es jedoch einige Nuancen ... <br><br>  Die ungefähre Konfiguration eines solchen Proxys mit Caching sah folgendermaßen aus: <br><br><pre> <code class="plaintext hljs">proxy_cache_key $uri; proxy_cache_methods GET HEAD; proxy_cache_lock on; proxy_cache_revalidate on; proxy_cache_background_update on; proxy_cache_use_stale updating error timeout invalid_header http_500 http_502 http_503 http_504; proxy_cache_valid 200 1h; location ~ ^/(?&lt;bucket&gt;avatars|images)/(?&lt;filename&gt;.+)$ { set $upstream $bucket.s3.amazonaws.com; proxy_pass http://$upstream/$filename; proxy_set_header Host $upstream; proxy_cache aws; proxy_cache_valid 200 1h; proxy_cache_valid 404 60s; }</code> </pre> <br>  Und im Allgemeinen hat es funktioniert: Bilder wurden angezeigt, alles war in Ordnung mit dem Cache ... es traten jedoch Probleme mit AWS S3-Clients auf.  Insbesondere der Client von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">aws-sdk-php</a> funktioniert nicht mehr.  Die Analyse der Nginx-Protokolle ergab, dass der Upstream 403-Code für HEAD-Anforderungen zurückgab und die Antwort einen bestimmten Fehler enthielt: <code>SignatureDoesNotMatch</code> .  Als wir sahen, dass Nginx eine GET-Anfrage an Upstream sendet, passte alles zusammen. <br><br>  Tatsache ist, dass der S3-Client jede Anforderung signiert und der Server diese Signatur überprüft.  Beim einfachen Proxy funktioniert alles einwandfrei: Die Anfrage erreicht den Server unverändert.  Wenn jedoch das Caching aktiviert ist, beginnt nginx mit der Optimierung der Arbeit mit dem Backend und ersetzt HEAD-Anforderungen durch GET.  Die Logik ist einfach: Es ist besser, das gesamte Objekt und dann alle HEAD-Anforderungen aus dem Cache abzurufen und zu speichern.  In unserem Fall kann die Anforderung jedoch nicht geändert werden, da sie signiert ist. <br><br>  Es gibt im Wesentlichen zwei Lösungen: <br><br><ol><li>  Fahren Sie S3-Clients nicht über Proxys. </li><li>  Wenn dies erforderlich ist, <code>proxy_cache_convert_head</code> Option <code>proxy_cache_convert_head</code> und fügen <code>$request_method</code> dem Caching-Schlüssel <code>$request_method</code> .  In diesem Fall sendet nginx HEAD-Anforderungen "wie sie sind" und speichert die Antworten separat zwischen. </li></ol><br><h2>  Geschichte Nr. 6.  DDoS und Google User Content </h2><br>  Der Sonntagabend war erst plötzlich ein Problem!  - Die Warteschlange für die Ungültigmachung des Caches auf Edgeservern ist nicht gewachsen, wodurch echte Benutzer Datenverkehr erhalten.  Dies ist ein sehr seltsames Symptom: Schließlich ist der Cache im Speicher implementiert und nicht an Festplatten gebunden.  Das Leeren des Caches in der verwendeten Architektur ist eine billige Operation, sodass dieser Fehler nur bei einer wirklich hohen Last auftreten kann.  Dies wurde durch die Tatsache bestätigt, dass dieselben Server über das Auftreten von 500 Fehlern zu informieren begannen <i>(rote Linienspitzen in der folgenden Grafik)</i> . <br><br><img src="https://habrastorage.org/webt/3-/cr/ec/3-crecmpt9kbmt7o_6gujxwiru0.png"><br><br>  Ein derart starker Anstieg führte zu CPU-Überläufen: <br><br><img src="https://habrastorage.org/webt/2t/vn/cw/2tvncw9vkrti9ysqmil7bmcztk0.png"><br><br>  Eine schnelle Analyse ergab, dass die Anforderungen nicht an die Hauptdomänen gingen, aber aus den Protokollen ging hervor, dass sie sich im Standard-vhost befanden.  Auf dem Weg stellte sich heraus, dass viele amerikanische Benutzer auf die russische Ressource kamen.  Solche Umstände werfen immer sofort Fragen auf. <br><br>  Nachdem wir Daten aus den Nginx-Protokollen gesammelt hatten, stellten wir fest, dass es sich um ein bestimmtes Botnetz handelt: <br><br><pre> <code class="plaintext hljs">35.222.30.127 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?ITPDH=XHJI" HTTP/1.1 301 178 "http://example.ru/ORQHYGJES" "Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 (.NET CLR 3.5.30729)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?ITPDH=XHJI" "redirect=http://www.example.ru/?ITPDH=XHJI" ancient=1 cipher=- "LM=-;EXP=-;CC=-" 107.178.215.0 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?REVQSD=VQPYFLAJZ" HTTP/1.1 301 178 "http://www.usatoday.com/search/results?q=MLAJSBZAK" "Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 6.0; en-US)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?REVQSD=VQPYFLAJZ" "redirect=http://www.example.ru/?REVQSD=VQPYFLAJZ" ancient=1 cipher=- "LM=-;EXP=-;CC=-" 107.178.215.0 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?MPYGEXB=OMJ" HTTP/1.1 301 178 "http://engadget.search.aol.com/search?q=MIWTYEDX" "Mozilla/5.0 (Windows; U; Windows NT 6.1; en; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 (.NET CLR 3.5.30729)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?MPYGEXB=OMJ" "redirect=http://www.example.ru/?MPYGEXB=OMJ" ancient=1 cipher=- "LM=-;EXP=-;CC=-"</code> </pre> <br>  Ein verständliches Muster wird in den Protokollen verfolgt: <br><br><ul><li>  wahrer User-Agent; </li><li>  eine Anfrage an die Root-URL mit einem zufälligen GET-Argument, um zu vermeiden, dass sie in den Cache gelangt; </li><li>  Referer gibt an, dass die Anfrage von einer Suchmaschine kam. </li></ul><br>  Wir sammeln die Adressen und überprüfen ihre Zugehörigkeit - sie gehören alle zu <code>googleusercontent.com</code> mit zwei Subnetzen (107.178.192.0/18 und 34.64.0.0/10).  Diese Subnetze enthalten virtuelle GCE-Maschinen und verschiedene Dienste, z. B. die Seitenübersetzung. <br><br>  Glücklicherweise dauerte der Angriff nicht so lange (ungefähr eine Stunde) und nahm allmählich ab.  Es scheint, dass die Schutzalgorithmen in Google funktioniert haben, sodass das Problem "von selbst" gelöst wurde. <br><br>  Dieser Angriff war nicht destruktiv, warf aber nützliche Fragen für die Zukunft auf: <br><br><ul><li>  Warum haben Anti-DDOs nicht funktioniert?  Es wird ein externer Dienst verwendet, an den wir eine entsprechende Anfrage gesendet haben.  Es gab jedoch viele Adressen ... </li><li>  Wie können Sie sich in Zukunft davor schützen?  In unserem Fall sind sogar Optionen zum Schließen des Zugriffs auf geografischer Basis möglich. </li></ul><br><h2>  PS </h2><br>  Lesen Sie auch in unserem Blog: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aus dem Leben mit Kubernetes: Wie sich die Spanier nicht über den HTTP-Server beschwerten</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">6 unterhaltsame Systemfehler beim Betrieb von Kubernetes [und deren Lösung]</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">3 ungewöhnliche Fälle über das Linux-Netzwerksubsystem</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de471892/">https://habr.com/ru/post/de471892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de471876/index.html">PDU und All-All-All: Rack-Stromverteilung</a></li>
<li><a href="../de471878/index.html">Wie schreibe ich einen intelligenten Vertrag für WebAssembly in einem Ontology-Netzwerk? Teil 1: Rost</a></li>
<li><a href="../de471884/index.html">10 kostenlose ApexSQL-Dienstprogramme zum Verwalten von Microsoft SQL Server-Datenbanken</a></li>
<li><a href="../de471886/index.html">VMmanager 6: Einführung in die Box und Vergleich mit der vorherigen Generation</a></li>
<li><a href="../de471890/index.html">Variationsinferenz - was ist das und was isst es?</a></li>
<li><a href="../de471896/index.html">Das Inside Playbook. Netzwerkfunktionen in der neuen Ansible Engine 2.9</a></li>
<li><a href="../de471904/index.html">Ressourcenplaner bei HPE InfoSight</a></li>
<li><a href="../de471906/index.html">Die Gefahren unsachgemäßer Optimierungen</a></li>
<li><a href="../de471908/index.html">Die unerwartete Schönheit von Primzahlen</a></li>
<li><a href="../de471912/index.html">Englisch lernen: 7 praktische Möglichkeiten, Ihren Wortschatz zu erweitern</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>