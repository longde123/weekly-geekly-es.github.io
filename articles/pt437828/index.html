<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∂üèª üë®‚Äçüë®‚Äçüëß üöç Abra o webinar "SELECT ordem de execu√ß√£o da consulta e plano de consulta no MS SQL Server" üòè üà∑Ô∏è üñêÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° novamente! 

 Colegas, no √∫ltimo dia de janeiro, estamos lan√ßando o curso "MS SQL Server Developer" , em conex√£o com o qual tivemos uma li√ß√£o tem√°...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Abra o webinar "SELECT ordem de execu√ß√£o da consulta e plano de consulta no MS SQL Server"</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/437828/">  Ol√° novamente! <br><br>  Colegas, no √∫ltimo dia de janeiro, estamos lan√ßando o curso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"MS SQL Server Developer"</a> , em conex√£o com o qual tivemos uma li√ß√£o tem√°tica em aberto.  Nele, falamos sobre como o MS SQL Server executa uma consulta SELECT, discutimos em que ordem e o que √© analisado, e tamb√©m mergulhamos um pouco na leitura do plano de consulta. <br><br>  Palestrante - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kristina Kucherova</a> , arquiteta de modelo de dados no Sberbank da R√∫ssia. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/H9oS-eLSX_8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br>  <b>Objetivos e rota do semin√°rio on-line</b> <br><br>  Os seguintes objetivos foram definidos no in√≠cio do webinar: <br><br><ol><li>  Veja como o servidor executa a solicita√ß√£o e por que isso acontece dessa maneira </li><li>  Aprendendo a ler um plano de consulta. </li></ol><br>  Para alcan√ß√°-los, o professor preparou uma rota simples, mas eficaz: <br><br><img src="https://habrastorage.org/webt/fq/kj/nr/fqkjnrypzokv5wpzw1phclft3xa.jpeg"><br><br>  <b>Por que preciso de um plano de consulta?</b> <br><br>  O plano de consulta √© uma ferramenta muito √∫til que, infelizmente, muitos desenvolvedores n√£o usam.  √Ä primeira vista, pode parecer que n√£o √© necess√°rio conhecer a mec√¢nica da solicita√ß√£o.  No entanto, se voc√™ entender o que est√° acontecendo no SQL Server, poder√° escrever uma consulta mais eficiente.  E isso ajudar√° muito, por exemplo, durante a otimiza√ß√£o. <br><br>  <b>Como vemos uma consulta SELECT?</b> <br><br>  Vamos ver como √© a consulta SELECT: <br><br><table><tbody><tr><td>  SELECT [campo1], [campo2] ... <br></td><td>  Quais campos n√≥s escolhemos? <br></td></tr><tr><td>  FROM [tabela] <br></td><td>  De onde <br></td></tr><tr><td>  ONDE [condi√ß√µes] <br></td><td>  Onde est√£o as condi√ß√µes <br></td></tr><tr><td>  GRUPO POR [campo1] <br></td><td>  Agrupar por campos <br></td></tr><tr><td>  TENDO [condi√ß√µes] <br></td><td>  Tendo tais e tais condi√ß√µes <br></td></tr><tr><td>  PEDIDO POR [campo1] <br></td><td>  Ordena√ß√£o (classifica√ß√£o) <br></td></tr></tbody></table><br>  <b>Como entender para onde ir para dados?</b> <br><br>  A primeira coisa que o servidor tenta entender quando chega uma solicita√ß√£o √© para onde ir para os dados.  O comando FROM responde a essa pergunta, porque √© aqui que teremos uma lista de tabelas (ou o nome de uma tabela). <br><br>  Para maior clareza, vamos imaginar que nosso servidor √© uma esp√©cie de mordomo, a quem pedimos para nos coletar nas f√©rias.  Assim, o mordomo come√ßa a pensar, mas em que arm√°rio est√£o as coisas necess√°rias (em qual tabela voc√™ precisa levar os dados)?  E para que nosso mordomo possa concluir facilmente sua tarefa, usamos FROM. <br><br><img src="https://habrastorage.org/webt/ig/wo/uy/igwouy4la8vroshisd8pk5sqcx8.jpeg"><br><br>  <b>Como entender quais dados levar?</b> <br><br>  Digamos que o mordomo encontrou o arm√°rio certo e o abriu.  Mas que coisas levar?  Talvez n√≥s estamos indo para uma esta√ß√£o de esqui?  Ou talvez em uma praia ensolarada e quente?  Para fazer com que nossas coisas correspondam ao clima, o comando WHERE √© √∫til para n√≥s, que define as condi√ß√µes, ou seja, permite filtrar os dados.  Se estiver quente, pegamos ard√≥sias, camisas e roupas de banho, se estiver frio - luvas, meias de malha, blusas)). <br><br>  O pr√≥ximo passo √© anexar esses dados a grupos, o que acontece com GROUP BY (camisetas separadamente, meias separadamente).  De acordo com os resultados do agrupamento, mais uma condi√ß√£o pode ser imposta usando HAVING (por exemplo, eliminando coisas n√£o pareadas).  No final, adicionamos tudo usando ORDER BY, obtendo a mala finalizada das coisas na sa√≠da, ou melhor, um bloco de dados ordenados. <br><br><img src="https://habrastorage.org/webt/vd/lt/4b/vdlt4bg1o5ebpaxz1di_vhl__tm.jpeg"><br><br>  A prop√≥sito, h√° uma nuance, mas consiste no fato de que h√° uma diferen√ßa de quais condi√ß√µes devem ser escritas em WHERE e quais em HAVING.  Mas isso √© melhor ver no v√≠deo. <br><br>  N√≥s continuamos.  O caminho de execu√ß√£o da solicita√ß√£o √© salvo <b>como um plano de solicita√ß√£o</b> no cache, ou seja, nosso mordomo anota tudo, porque ele √© um bom mordomo - e se voc√™ quiser repetir seu pedido no pr√≥ximo ano?  E tais planos, em princ√≠pio, podem ser muitos. <br><br>  <b>Tipos de conex√µes no plano de consulta</b> <br><br>  Existem tr√™s conex√µes que voc√™ pode encontrar em termos de consulta: <br><br><ol><li>  Loop aninhado. </li><li>  Mesclar jun√ß√£o. </li><li>  Hash join. </li></ol><br>  Antes de abordar cada um deles com mais detalhes, vamos resumir por que dever√≠amos ler o plano de consulta.  Isso √© realmente muito √∫til, pois voc√™ aprender√°: <br><br><ul><li>  qual √≠ndice √© usado; </li><li>  em que ordem se juntam; </li><li>  o que √© selecionado no buffer; </li><li>  quanto o servidor gasta recursos na opera√ß√£o; </li><li>  qual √© a diferen√ßa entre um plano hipot√©tico e um real? </li></ul><br>  <b>Loop aninhado</b> <br><br>  Digamos que precisamos unir dados de tabelas diferentes.  Vamos apresentar essas tabelas como ... uma pequena quantidade de chocolates Skittles e a embalagem completa da M&amp;M. <br><br><img src="https://habrastorage.org/webt/4k/-s/uh/4k-suhjbpvptu8kjhe77rx8posm.jpeg"><br><br>  Ao conectar um tipo Nested Loop, pegamos o doce Skittles e depois pegamos o doce cego do pacote da M&amp;M.  Se n√£o encontrarmos um doce da mesma cor (essa √© a nossa condi√ß√£o), obtemos o pr√≥ximo, ou seja, h√° um busto comum.  Como resultado, podemos dizer que a conex√£o Nested Loop √© mais adequada para pequenas quantidades de dados.  Obviamente, se houver muitos dados, interromper n√£o √© a melhor op√ß√£o. <br><br><img src="https://habrastorage.org/webt/fu/0d/mv/fu0dmvprjve1i1mgbn5v3nou3ow.jpeg"><br><br>  Vamos ver como fica no painel SQL: <br><br><pre><code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--drop table skittles --drop table mms --    create table mms (id int identity(1,1), color varchar(25), taste varchar(15)) insert into mms (color, taste) values ('yellow', 'chocolate') insert into mms (color, taste) values ('red', 'nuts') create clustered index IX_mms_color ON mms(color); create table skittles (id int identity(1,1), color varchar(25), taste varchar(15)) create index IX_skittles_id ON skittles(id); create clustered index IX_skittles_color ON skittles(color); insert into skittles (color, taste) values ('red', 'cherry') insert into skittles (color, taste) values ('blue', 'strange') insert into skittles (color, taste) values ('yellow', 'lemon') insert into skittles (color, taste) values ('green', 'apple') insert into skittles (color, taste) values ('orange', 'orange') --    select mms.* from mms join skittles on mms.color = skittles.color select * from mms join skittles on mms.color = skittles.color</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/gx/vj/ed/gxvjedgxwzjcdv2kbzreqmmofwi.jpeg"><br><br>  <b>Mesclar jun√ß√£o</b> <br><br>  Uma conex√£o √© usada para grandes quantidades de dados.  Quando voc√™ tem uma jun√ß√£o de mesclagem, as duas tabelas t√™m um √≠ndice pelo qual elas podem ser unidas.  No caso dos doces, √© como se os tiv√©ssemos organizado previamente por cor. <br><br>  √â assim: <br><br><img src="https://habrastorage.org/webt/j2/cy/ld/j2cyldmem4_ytym2ssj3wpyco1q.jpeg"><br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--2 tables 50000 rows, only clustered index by color, color is not unique select COUNT(*) from mms_big join skittles_big on mms_big.color = skittles_big.color</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/xv/vm/mf/xvvmmf1ozq_lt7f2rrcnqsvz1cs.jpeg"><br><br>  A jun√ß√£o de mesclagem √© boa nos seguintes casos: <br><br><ul><li>  grandes conjuntos de dados; </li><li>  os mesmos campos de conex√£o do mesmo tipo; </li><li>  os campos de conex√£o possuem √≠ndices. </li></ul><br>  <b>Hash join</b> <br><br>  A jun√ß√£o de hash √© usada para grandes quantidades de dados n√£o classificadas.  Para ingressar nas tabelas nesse caso, voc√™ precisa criar algo que imite o √≠ndice. <br><br>  Exemplo de jun√ß√£o de hash: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--drop table skittles --drop table mms --    create table mms (id int identity(1,1), color varchar(25), taste varchar(15)) insert into mms (color, taste) values ('yellow', 'chocolate') insert into mms (color, taste) values ('red', 'nuts') insert into mms (color, taste) values ('blue', 'strange') insert into mms (color, taste) values ('green', 'chocolate') insert into mms (color, taste) values ('orange', 'chocolate') create table skittles (id int identity(1,1), color varchar(25), taste varchar(15)) insert into skittles (color, taste) values ('red', 'cherry') insert into skittles (color, taste) values ('blue', 'strange') insert into skittles (color, taste) values ('yellow', 'lemon') insert into skittles (color, taste) values ('green', 'apple') insert into skittles (color, taste) values ('orange', 'orange') --    select * from mms join skittles on mms.color = skittles.color</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/0g/vr/xd/0gvrxdfdoc55bwpdkv5ghkwnq-w.jpeg"><br><br>  Para maior clareza, lembramos nossos doces: <br><br><img src="https://habrastorage.org/webt/xg/2l/cn/xg2lcndw5mzxm5msx6l_0kq_4wc.jpeg"><br><br>  O uso da jun√ß√£o Hash envolve 2 fases de a√ß√£o: <br><br><ol><li>  Compilar - uma tabela de hash √© criada na menor tabela.  Para cada valor na tabela n¬∫ 1, um hash √© considerado.  O valor √© armazenado em uma tabela de hash e o hash calculado √© usado como uma chave. </li><li>  Sonda.  Para cada linha da tabela n¬∫ 2, o valor do hash √© calculado para os campos especificados em jun√ß√£o (operador =).  Um hash √© pesquisado na tabela de hash, os valores do campo s√£o verificados. </li></ol><br><img src="https://habrastorage.org/webt/nr/nn/q2/nrnnq2ahbh57a28x3szylahyjue.jpeg"><br><br><img src="https://habrastorage.org/webt/fu/e3/bg/fue3bgxwsesvzgwjgzzva6isnpu.jpeg"><br><br><img src="https://habrastorage.org/webt/dd/fx/mn/ddfxmnjwgneqpqmzxeseavjpkhy.jpeg"><br><br>  Quando a jun√ß√£o de hash √© boa: <br><br><ul><li>  grande conjunto de dados; </li><li>  sem √≠ndices marginais. </li></ul><br>  Um ponto importante: se n√£o houver mem√≥ria suficiente, a grava√ß√£o ir√° para tempdb - para disco. <br><br>  Amigos, al√©m do exposto, a li√ß√£o aberta tamb√©m incluiu outros pontos interessantes, que s√£o melhor visualizados ao assistir ao v√≠deo.  Sugerimos visitar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dia aberto do curso</a> "MS SQL Server Developer", onde voc√™ pode fazer ao professor todas as suas perguntas. <br><br>  A professora do PS <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kristina Kucherova</a> agradece a Jes Schultz Borland por sua <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">apresenta√ß√£o</a> com os Planos de Execu√ß√£o do PASS Summitt: O Segredo para o Sucesso do Ajuste de Consultas, que foi usado na prepara√ß√£o da li√ß√£o aberta. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt437828/">https://habr.com/ru/post/pt437828/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt437816/index.html">MPLS est√° em todo lugar. Como √© a infraestrutura de rede Yandex.Cloud</a></li>
<li><a href="../pt437818/index.html">Ensinamos um computador a distinguir sons: conhecendo o concurso DCASE e montando seu classificador de √°udio em 30 minutos</a></li>
<li><a href="../pt437820/index.html">50 tons de seguran√ßa Drupal</a></li>
<li><a href="../pt437824/index.html">Extens√£o Universal 1C para o Planilhas Google e o Google Docs - use e use</a></li>
<li><a href="../pt437826/index.html">Como migramos o banco de dados do Redis e do Riak KV para o PostgreSQL. Parte 1: o processo</a></li>
<li><a href="../pt437830/index.html">Programa√ß√£o confi√°vel por idioma - revis√£o noob. Parte 1</a></li>
<li><a href="../pt437832/index.html">C√≥digo aberto: humor de c√≥digo, truques de c√≥digo, c√≥digo N√ÉO</a></li>
<li><a href="../pt437834/index.html">Duas hist√≥rias sobre como os eventos de programa√ß√£o ocorreram em Ecaterimburgo</a></li>
<li><a href="../pt437836/index.html">Sob o cap√¥ Screeps - virtualiza√ß√£o na caixa de areia MMO para programadores</a></li>
<li><a href="../pt437838/index.html">As tecnologias de aprendizado de m√°quina aceleram o processo de adapta√ß√£o dos pacientes √†s pr√≥teses bi√¥nicas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>