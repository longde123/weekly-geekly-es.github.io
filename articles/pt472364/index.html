<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üâë üêß ‚ùÑÔ∏è PostgreSQL e configura√ß√µes de consist√™ncia de registros para cada conex√£o espec√≠fica üé∂ üë®üèæ‚Äçü§ù‚Äçüë®üèΩ üëäüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A tradu√ß√£o do artigo foi preparada especialmente para os alunos do curso "Banco de Dados" . √â interessante desenvolver nessa dire√ß√£o? Convidamos voc√™ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL e configura√ß√µes de consist√™ncia de registros para cada conex√£o espec√≠fica</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/472364/"><p>  <em>A tradu√ß√£o do artigo foi preparada especialmente para os alunos do curso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Banco de Dados"</a> .</em>  <em>√â interessante desenvolver nessa dire√ß√£o?</em>  <em>Convidamos voc√™ para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Open Doors Day</a> , onde falamos em detalhes sobre o programa, recursos do formato on-line, compet√™ncias e perspectivas de carreira que aguardam os formados ap√≥s o treinamento.</em> </p><br><p><img src="https://habrastorage.org/webt/gf/iy/te/gfiyteycddmeefan9z5h1nxdgu0.png"></p><br><p>  PostgreSQL e configura√ß√µes de consist√™ncia de registros para cada conex√£o espec√≠fica <br>  No Compose, precisamos lidar com muitos bancos de dados, o que nos d√° a oportunidade de conhecer melhor nossas funcionalidades e fraquezas.  √Ä medida que aprendemos a amar os recursos funcionais dos novos bancos de dados, √†s vezes come√ßamos a pensar em como seria bom se fun√ß√µes semelhantes estivessem presentes em ferramentas mais maduras com as quais trabalhamos h√° muito tempo.  Um dos novos recursos que o PostgreSQL queria ver era a consist√™ncia de grava√ß√£o personalizada em todo o cluster.  E, como se viu, j√° o temos e hoje queremos compartilhar com voc√™ informa√ß√µes sobre como us√°-lo. <a name="habracut"></a></p><br><h1 id="zachem-mne-eto">  Por que eu preciso disso? </h1><br><p>  Como um cluster deve se comportar depende do seu aplicativo.  Tome, por exemplo, um aplicativo para pagamento de contas.  Voc√™ precisar√° de 100% de consist√™ncia no cluster, portanto precisar√° ativar confirma√ß√µes s√≠ncronas para que seu banco de dados aguarde todas as altera√ß√µes.  No entanto, se o seu aplicativo for uma rede social em r√°pido crescimento, provavelmente voc√™ preferir√° 100% de consist√™ncia com uma resposta r√°pida.  Para conseguir isso, voc√™ pode usar confirma√ß√µes ass√≠ncronas no seu cluster. </p><br><h2 id="znakomtes-kompromiss">  Conhe√ßa o compromisso </h2><br><p>  Voc√™ precisa comprometer a consist√™ncia e o desempenho dos dados.  O PostgreSQL parte da consist√™ncia, porque a configura√ß√£o padr√£o neste caso √© previs√≠vel e sem surpresas inesperadas.  E agora vamos nos familiarizar com compromissos. </p><br><h3 id="kompromiss-1-proizvoditelnost">  Compromisso 1: Desempenho </h3><br><p>  Se o cluster do PostgreSQL n√£o exigir consist√™ncia, ele poder√° funcionar de forma ass√≠ncrona.  A grava√ß√£o √© feita no l√≠der do cluster e as atualiza√ß√µes ser√£o enviadas para suas r√©plicas ap√≥s alguns milissegundos.  Quando a consist√™ncia √© necess√°ria para um cluster do PostgreSQL, ele deve funcionar de forma s√≠ncrona.  O registro ser√° feito no l√≠der do cluster, que enviar√° atualiza√ß√µes para as r√©plicas e aguardar√° a confirma√ß√£o de que todos fizeram um registro antes de enviar a confirma√ß√£o ao cliente que iniciou o registro de que foi bem-sucedido.  A diferen√ßa pr√°tica entre essas abordagens √© que o m√©todo ass√≠ncrono requer dois saltos de rede, enquanto o m√©todo s√≠ncrono requer quatro. </p><br><h3 id="kompromiss-2-soglasovannost">  Compromisso 2: Consist√™ncia </h3><br><p>  O resultado no caso de mau funcionamento de um l√≠der nessas duas abordagens tamb√©m ser√° diferente.  Se o trabalho for executado de forma ass√≠ncrona, quando ocorrer esse erro, nem todos os registros ser√£o confirmados por r√©plicas.  Quanto ser√° perdido?  Depende do pr√≥prio aplicativo e da efici√™ncia da replica√ß√£o.  A replica√ß√£o de composi√ß√£o impedir√° que a r√©plica se torne l√≠der se a quantidade de informa√ß√µes contida nela for 1 MB menor que no l√≠der, ou seja, at√© 1 MB de registros podem potencialmente ser perdidos durante a opera√ß√£o ass√≠ncrona. </p><br><p> No modo s√≠ncrono, isso n√£o acontece.  Se o l√≠der falhar, todas as r√©plicas ser√£o atualizadas, pois qualquer registro confirmado no l√≠der deve ser confirmado nas r√©plicas.  Aqui est√° - coer√™ncia. </p><br><p>  Faz sentido usar o comportamento s√≠ncrono em um aplicativo para pagar contas, onde a consist√™ncia tem uma clara vantagem em encontrar um compromisso entre consist√™ncia e desempenho.  O mais importante para esse aplicativo s√£o dados v√°lidos.  Agora lembre-se da rede social, na qual a principal tarefa √© manter a aten√ß√£o do usu√°rio, respondendo √†s solicita√ß√µes o mais r√°pido poss√≠vel.  Nesse caso, o desempenho com menos saltos de rede e menos confirma√ß√µes de espera ser√° uma prioridade.  No entanto, a troca entre desempenho e consist√™ncia n√£o √© a √∫nica a se pensar. </p><br><h3 id="kompromiss-3-sboi">  Compromisso 3: Falhas </h3><br><p>  √â muito importante entender como o cluster se comporta durante uma falha.  Considere uma situa√ß√£o em que uma ou mais r√©plicas falham.  Quando as confirma√ß√µes s√£o processadas de forma ass√≠ncrona, o l√≠der continuar√° funcionando, ou seja, receber√° e processar√° registros sem aguardar a falta de r√©plicas.  Quando as r√©plicas retornam ao cluster, elas alcan√ßam o l√≠der.  Com a replica√ß√£o s√≠ncrona, se as r√©plicas n√£o responderem, o l√≠der n√£o ter√° escolha e continuar√° aguardando a confirma√ß√£o da confirma√ß√£o at√© que a r√©plica retorne ao cluster e possa aceitar e confirmar o registro. </p><br><h2 id="po-odnomu-soedineniyu-na-tranzakciyu">  Uma conex√£o por transa√ß√£o? </h2><br><p>  Cada aplicativo precisa de um tipo especial de combina√ß√£o de consist√™ncia e desempenho.  A menos, √© claro, que seja nosso aplicativo de cobran√ßa, que achamos completamente consistente, ou nosso aplicativo de rede social quase ef√™mero.  Em todos os outros casos, haver√° momentos em que algumas opera√ß√µes devem ser s√≠ncronas e outras ass√≠ncronas.  Voc√™ pode n√£o querer que o sistema aguarde o fechamento da mensagem enviada ao bate-papo, mas se o pagamento for feito no mesmo aplicativo, voc√™ ter√° que aguardar. </p><br><p>  Todas essas decis√µes, √© claro, s√£o tomadas pelo desenvolvedor do aplicativo.  As decis√µes corretas sobre quando aplicar essa ou aquela abordagem ajudar√£o a tirar o m√°ximo proveito do cluster.  √â importante que o desenvolvedor possa alternar entre eles no n√≠vel SQL para conex√µes e transa√ß√µes. </p><br><h2 id="obespechenie-kontrolya-na-praktike">  Fornecendo controle na pr√°tica </h2><br><p> Por padr√£o, o PostgreSQL fornece consist√™ncia.  Isso √© controlado pelo par√¢metro do servidor <code>synchronous_commit</code> .  Por padr√£o, est√° <code>remote_write</code> , mas tem tr√™s outras op√ß√µes: <code>local</code> , <code>remote_write</code> ou <code>off</code> . </p><br><p>  Quando o par√¢metro est√° <code>off</code> , todas as confirma√ß√µes s√≠ncronas s√£o interrompidas, mesmo no sistema local.  O par√¢metro em local determina o modo s√≠ncrono para o sistema local, mas as grava√ß√µes nas r√©plicas s√£o ass√≠ncronas.  <code>Remote_write</code> vai ainda mais longe: as grava√ß√µes nas r√©plicas s√£o feitas de forma ass√≠ncrona, mas s√£o retornadas quando a r√©plica recebeu o registro, mas n√£o o gravou no disco. </p><br><p>  Considerando o intervalo de op√ß√µes dispon√≠veis, escolhemos o comportamento e, lembrando que existem registros s√≠ncronos, selecionamos <code>local</code> para confirma√ß√µes ass√≠ncronas na rede, enquanto deixamos as confirma√ß√µes locais s√≠ncronas. </p><br><p>  Agora, mostraremos como configurar isso em um instante, mas imagine que definimos <code>synchronous_commit</code> como <code>local</code> para o servidor.  N√≥s nos perguntamos se o par√¢metro <code>synchronous_commit</code> pode ser alterado em tempo real, e acabou n√£o sendo poss√≠vel, existem duas maneiras de fazer isso.  O primeiro √© configurar sua sess√£o de conex√£o da seguinte maneira: </p><br><pre> <code class="plaintext hljs">SET SESSION synchronous_commit TO ON; // Your writes go here</code> </pre> <br><p>  Todos os registros subsequentes na sess√£o confirmar√£o as opera√ß√µes de grava√ß√£o para as r√©plicas antes de retornar um resultado positivo ao cliente conectado.  A menos, √© claro, que voc√™ altere a configura√ß√£o <code>synchronous_commit</code> novamente.  Voc√™ pode omitir a parte <code>SESSION</code> do comando, pois ela estar√° no valor padr√£o. </p><br><p>  A segunda maneira √© boa quando voc√™ s√≥ deseja garantir a replica√ß√£o s√≠ncrona para uma √∫nica transa√ß√£o.  Em muitos bancos de dados NoSQL, o conceito de transa√ß√µes n√£o existe, mas existe no PostgreSQL.  Nesse caso, voc√™ inicia a transa√ß√£o e, em seguida, defina o <code>synchronous_commit</code> antes de gravar na transa√ß√£o.  <code>COMMIT</code> a transa√ß√£o usando qualquer valor do par√¢metro <code>synchronous_commit</code> que foi definido naquele momento, embora seja melhor definir a vari√°vel antecipadamente para garantir que outros desenvolvedores entendam que os registros n√£o s√£o ass√≠ncronos. </p><br><pre> <code class="plaintext hljs">BEGIN; SET LOCAL synchronous_commit TO ON; // Your writes go here COMMIT;</code> </pre> <br><p>  Todas as confirma√ß√µes de transa√ß√£o agora ser√£o confirmadas como gravadas nas r√©plicas antes que o banco de dados retorne uma resposta positiva ao cliente conectado. </p><br><h2 id="nastroyka-postgresql">  Configura√ß√£o do PostgreSQL </h2><br><p>  Antes disso, imagin√°vamos um sistema PostgreSQL com o <code>synchronous_commit</code> definido como <code>local</code> .  Para que isso seja real no lado do servidor, voc√™ precisar√° definir dois par√¢metros de configura√ß√£o do servidor.  Outro par√¢metro <code>synchronous_standby_names</code> assumir√° o controle quando o <code>synchronous_commit</code> estiver <code>synchronous_commit</code> .  Ele determina quais r√©plicas s√£o eleg√≠veis para confirma√ß√µes s√≠ncronas e a definiremos como <code>*</code> , o que significa que todas as r√©plicas est√£o ativadas.  Esses valores geralmente s√£o configurados no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">arquivo de configura√ß√£o</a> adicionando: </p><br><pre> <code class="plaintext hljs">synchronous_commit = local synchronous_standby_names='*'</code> </pre> <br><p>  Ao definir o par√¢metro <code>synchronous_commit</code> como <code>local</code> , criamos um sistema no qual as unidades locais permanecem s√≠ncronas, mas as confirma√ß√µes de r√©plica de rede s√£o ass√≠ncronas por padr√£o.  A menos, √© claro, que decidamos fazer esses commits s√≠ncronos, como mostrado acima. </p><br><p>  Se voc√™ acompanhou o desenvolvimento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">do projeto Governor</a> , pode ter notado algumas altera√ß√µes recentes ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2</a> ), que permitiram aos usu√°rios do Governor testar esses par√¢metros e controlar sua consist√™ncia. </p><br><h2 id="esche-para-slov">  Mais algumas palavras ... </h2><br><p>  H√° apenas uma semana, eu diria a voc√™ que n√£o √© poss√≠vel ajustar o PostgreSQL com tanta precis√£o.  Foi ent√£o que Kurt, um membro da equipe da plataforma Compose, insistiu que havia essa oportunidade.  Ele pacificou minhas obje√ß√µes e encontrou o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">seguinte</a> na documenta√ß√£o do PostgreSQL: </p><br><p><img src="https://habrastorage.org/webt/yu/-p/qn/yu-pqnp2g5_ipnofxejmnmkc_uq.png"></p><br><p>  <em>Este par√¢metro pode ser alterado a qualquer momento.</em>  <em>O comportamento de qualquer transa√ß√£o √© determinado pela configura√ß√£o em vigor ao confirmar.</em>  <em>Portanto, √© poss√≠vel e √∫til que as confirma√ß√µes sejam confirmadas de forma s√≠ncrona para algumas transa√ß√µes e ass√≠ncrona para outras.</em>  <em>Por exemplo, para for√ßar uma √∫nica transa√ß√£o de <code>multistatement</code> a confirmar de forma ass√≠ncrona quando o valor padr√£o √© o oposto, defina</em> <code>SET LOCAL synchronous_commit TO OFF</code> <em>na transa√ß√£o.</em> </p><br><p>  Com essa pequena modifica√ß√£o no arquivo de configura√ß√£o, demos aos usu√°rios a capacidade de controlar sua consist√™ncia e desempenho. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt472364/">https://habr.com/ru/post/pt472364/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt472354/index.html">Entre a cadeira e o monitor, est√° a principal vulnerabilidade no sistema: VAP-person</a></li>
<li><a href="../pt472356/index.html">Microsoft vs IBM: grandes mudan√ßas no suporte a Java</a></li>
<li><a href="../pt472358/index.html">30 de outubro √†s 17:00, webinar "Implante o cluster Kubernetes em uma hora na nuvem CROC"</a></li>
<li><a href="../pt472360/index.html">Digitalizando o c√≥digo do Orchard CMS for Bugs</a></li>
<li><a href="../pt472362/index.html">Pesquisamos e analisamos erros no c√≥digo Orchard CMS</a></li>
<li><a href="../pt472366/index.html">Novo algoritmo do Path Finder no Factorio</a></li>
<li><a href="../pt472368/index.html">Pesca com fala: analisamos m√©todos de ataque e m√©todos de prote√ß√£o contra eles</a></li>
<li><a href="../pt472372/index.html">Automa√ß√£o Android Guia super f√°cil para criar seu primeiro teste de caf√© expresso</a></li>
<li><a href="../pt472374/index.html">Por que transferimos servidores para a Isl√¢ndia</a></li>
<li><a href="../pt472378/index.html">Confiabilidade do flash: esperado e inesperado. Parte 2. XIV confer√™ncia da associa√ß√£o USENIX. Tecnologias de armazenamento de arquivos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>