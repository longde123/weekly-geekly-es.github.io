<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè† üç£ üí™üèº Sistemas RPC de referencia (y Json invertido) üéÄ üéå üçØ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comparaci√≥n de varias herramientas (RabbitMQ, Crossbar.io, Nats.io, Nginx, etc.) para organizar RPC entre microservicios. 

 Uso de la memoria 

 Uso ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sistemas RPC de referencia (y Json invertido)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466263/"><img src="https://habrastorage.org/webt/ek/32/ry/ek32ryce-qyz-_veggjdlpckrhu.png"><br>  Comparaci√≥n de varias herramientas (RabbitMQ, Crossbar.io, Nats.io, Nginx, etc.) para organizar RPC entre microservicios. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Uso de la memoria</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/nf/e6/2j/nfe62jq7jepzlt7hvdrmxdftndu.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Uso de la CPU</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/r7/0m/pv/r70mpvfluxfgh8gkuj778vcua3i.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Prueba de procesador m√∫ltiple</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/a3/ic/yh/a3icyhyhqxigksng211u_08ahbu.png"><br></div></div><br><br>  <i>Art√≠culo actualizado 2019-12-15</i> <br><br>  <b>Resumen</b>  La implementaci√≥n de llamadas RPC s√≠ncronas a trav√©s del sistema MQ cl√°sico no es efectiva: brinda un rendimiento reducido y efectos secundarios que deben ser enrollados manualmente (o con herramientas adicionales). <br>  Inverted Json es un servidor de tareas liviano que le permite realizar llamadas RPC s√≠ncronas "honestas" (el cliente y el servidor se conectan a trav√©s de Inverted Json para enviar informaci√≥n), lo que garantiza un alto rendimiento (7 veces m√°s r√°pido que RabbitMQ), y la comunicaci√≥n se realiza a trav√©s de http , que le permite usar cualquier herramienta http, incluso curl desde la consola. <br><br><h3>  1. Pruebas </h3><br>  Todas las herramientas se dividen en 3 grupos: <br><ul><li>  <b>"Conexi√≥n directa"</b> : cuando el cliente se dirige directamente al trabajador, en proyectos con una gran cantidad de trabajadores / servicios es el m√°s dif√≠cil de configurar, requiere un "cliente inteligente", es decir  al llamar, el cliente debe tener informaci√≥n sobre c√≥mo y d√≥nde enviar la solicitud (o se necesita un proxy local adicional), como regla, produce la menor carga en la red. </li><li>  <b>"Conexi√≥n de proxy"</b> : una variante con un √∫nico punto de entrada, un cliente simple, pero al mismo tiempo las dificultades siguen siendo del lado de los trabajadores / seriales: reenv√≠o y asignaci√≥n de puertos, registro de direcciones para servidores proxy, configuraciones de firewall m√°s complicadas, herramientas adicionales a menudo se utilizan para administrar toda esta granja . </li><li>  <b>‚ÄúConexi√≥n invertida‚Äù</b> : un √∫nico punto de entrada tanto para clientes como para trabajadores (puede considerarse como un ESB), la configuraci√≥n de red m√°s simple. </li><li>  Uso de memoria y procesador tomado de `estad√≠sticas del acoplador` </li><li>  En la prueba de "2 n√∫cleos", el servidor y los clientes con interruptores se dividen en diferentes n√∫cleos para reducir la influencia mutua, por lo tanto, el servidor est√° limitado a 2 n√∫cleos a trav√©s del conjunto de tareas (prueba de m√∫ltiples n√∫cleos sin restricciones) </li></ul>  Algunas reflexiones sobre el punto de referencia a continuaci√≥n. <br><br><h3>  2. MQ o RPC </h3><br>  Aunque estos 2 m√©todos de comunicaci√≥n son diferentes, a veces se usa el primero en lugar del segundo y viceversa. <br>  Si intenta delinear los l√≠mites, cu√°ndo usar qu√©, puede obtener algo como esto: <br><ul><li>  <b>RPC</b> (llamada a procedimiento sincr√≥nico): cuando el cliente requiere una respuesta inmediata (en un corto per√≠odo de tiempo), cuando el trabajador necesita responder mientras el cliente espera una respuesta, y si el cliente se ha ido (por tiempo de espera), esta respuesta ya no es necesaria (es por eso que no necesita guardar " solicitud ", como suele hacerse en los sistemas MQ). <br>  Por ejemplo, cuando realiza una consulta en la base de datos, hace RPC, no querr√° usar MQ para esto. </li><li>  <b>MQ</b> (llamada a procedimiento asincr√≥nico): cuando no se necesita la respuesta (inmediatamente), cuando solo necesita completar alg√∫n tipo de tarea al final o simplemente transferir datos. <br>  Por ejemplo, para enviar cartas puede enviar una tarea a trav√©s de MQ <br></li></ul><br><h3>  3. RPC sobre RabbitMQ </h3><br>  <b>RabbitMQ a</b> menudo se usa para organizar RPC, pero al igual que los sistemas MQ similares, crea una sobrecarga adicional, por lo que su uso no es muy productivo. <br><br>  Si usa la "cola" para RPC, entonces necesita limpiar los canales, porque  Si el trabajador se ha ca√≠do por un tiempo, luego de reiniciarlo puede obtener un mont√≥n de tareas irrelevantes, porque los clientes enviaron solicitudes todo este tiempo y, adem√°s, esperaron en vano una respuesta.  El trabajador no estaba activo.  En total, el trabajador recibir√° la tarea incluso si el cliente se fue antes, lo mismo con el cliente, si el canal del cliente no se cuenta, entonces puede estar obstruido con las respuestas no recibidas del trabajador, aunque en RabbitMQ es posible cerrar el canal del cliente, pero al mismo tiempo el rendimiento se reducir√° dr√°sticamente. <br><br>  Tambi√©n debe hacer un trabajador porcino para saber si est√° vivo. <br>  Adem√°s, los recursos se gastan en trabajar con canales, cuando en los sistemas RPC los datos simplemente se env√≠an al trabajador y viceversa. <br><br><h3>  4. Json invertido </h3><br>  Hay muchos sistemas MQ diferentes, pero no muchos servidores Job (RPC) como Gearman / Crossbar.io son opciones muy peque√±as, por lo que los desarrolladores a menudo toman sistemas MQ para RPC. <br>  Por lo tanto, se cre√≥ <b>Inverted JSON</b> (iJson): un servidor proxy con una interfaz http donde los clientes y los trabajadores se conectan como un cliente de red: [cliente] -&gt; [Inverted Json] &lt;- [trabajador], escrito en C / C ++, utiliza epoll, m√°quinas de estado para enrutamiento, json streaming parser, cortes en lugar de cadenas *, etc. formas para un mejor rendimiento. <br><br>  <b>Ventajas de JSON invertido sobre RabbitMQ:</b> <br><ul><li>  No es necesario limpiar los canales de clientes y trabajadores de los mensajes no recibidos </li><li>  No es necesario hacer ping al trabajador, el cliente recibir√° un error inmediatamente si el trabajador se desconecta (con una conexi√≥n de mantenimiento) </li><li>  API m√°s f√°cil: solo una solicitud http (como regla, ya es compatible con todos los idiomas y marcos) </li><li>  Funciona m√°s r√°pido y consume menos memoria. </li><li>  Una forma m√°s f√°cil de enviar comandos a un trabajador espec√≠fico (por ejemplo, si hay varios trabajadores en la cola, pero necesita trabajar con uno espec√≠fico) </li></ul><br>  <b>Otra informaci√≥n de Json invertida</b> <br><ul><li>  La capacidad de transferir datos binarios (no solo json, como su nombre podr√≠a sugerir) </li><li>  No es necesario especificar la identificaci√≥n si el trabajador est√° conectado como keep-alive, Json invertido simplemente conecta al cliente y al trabajador directamente. </li><li>  La capacidad de "suscribirse" a varios comandos (canales), suscribirse a un patr√≥n (por ejemplo, comando / *) sin perder rendimiento. </li><li>  La imagen de Docker es de solo <b>2.6 MB</b> (versi√≥n delgada) </li><li>  Kernel Inverted Json solo ~ 1400 l√≠neas de c√≥digo (v0.3), menos c√≥digo - menos errores;) </li><li>  El JSON invertido no modifica el cuerpo (cuerpo) de la solicitud, sino que lo env√≠a tal cual. </li></ul><br><br><h3>  5. Prueba Inverted Json en 3 minutos </h3><br>  Puedes probar Inverted Json ahora mismo si tienes <b>Docker</b> y <b>curl</b> : <br><img src="https://habrastorage.org/webt/lw/ky/d3/lwkyd3pm8zfnhlyxgpjnsrk6vbu.gif"><br><br>  Descripci√≥n de la imagen: <br>  1) Al iniciar la imagen acoplable de <b>Json invertido</b> en el puerto 8001, --log 47 registra las solicitudes entrantes, etc. <br><pre><code class="bash hljs">$ docker run -it -p 8001:8001 lega911/ijson --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> 47</code> </pre> <br>  2) Registre al trabajador para la tarea "calc / sum" y espere la tarea, solicite el tipo "get", es decir  - obtener la tarea: <br><pre> <code class="bash hljs">$ curl localhost/calc/sum -H <span class="hljs-string"><span class="hljs-string">'type: get'</span></span></code> </pre><br>  3) El cliente realiza una solicitud de c√°lculo / suma RPC: <br><pre> <code class="bash hljs">$ curl localhost/calc/sum -d <span class="hljs-string"><span class="hljs-string">'{"id": 15, "data": "2+3"}'</span></span></code> </pre><br>  4) El trabajador recibe la tarea `{" id ": 15," data ":" 2 + 3 "}` - los datos no han cambiado, ahora debe enviar el resultado al mismo id, tipo de solicitud "result": <br><pre> <code class="bash hljs">$ curl localhost -H <span class="hljs-string"><span class="hljs-string">'type: result'</span></span> -d <span class="hljs-string"><span class="hljs-string">'{"id": 15, "result": 5}'</span></span></code> </pre><br>  ... y el cliente obtiene el resultado como es <code>`{"id": 15, "result": 5}`</code> <br><br><h4>  5.1.  Jsonrpc </h4><br>  JsonRPC 2 no es compatible, pero existen algunos rudimentos, por ejemplo, el cliente puede enviar solicitudes como (url / rpc / call): <br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"jsonrpc"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"method"</span></span>: <span class="hljs-string"><span class="hljs-string">"calc/sum"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: [<span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">23</span></span>], <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}</code> </pre>  aceptar errores como: <br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"jsonrpc"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"error"</span></span>: {<span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">-32601</span></span>, <span class="hljs-attr"><span class="hljs-attr">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">"Method not found"</span></span>}, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>}</code> </pre>  Sin embargo, si hay demanda, entonces se puede mejorar el soporte de JsonRPC. <br><br><h4>  5.2.  Ejemplo de cliente y trabajador de Python </h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># client.py import requests print(requests.post('http://127.0.0.1:8001/test/command', json={'id': 1, 'params': 'Hello'}).json()) # worker.py import requests while True: req = requests.post('http://127.0.0.1:8001/test/command', headers={'type': 'get'}).json() response = { 'id': req['id'], 'result': req['params'] + ' world!' } requests.post('http://127.0.0.1:8001/', json=response, headers={'type': 'result'})</span></span></code> </pre><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">Y aqu√≠</a> puede encontrar un ejemplo en el "modo trabajador", que es m√°s productivo y compacto. <br><br><h3>  6. Algunas reflexiones sobre el resultado de referencia </h3><br><ul><li>  <b>Crossbar.io</b> : se basa en python, por lo que no es tan r√°pido y no puede usar m√∫ltiples n√∫cleos debido a GIL. </li><li>  <b>RabbitMQ</b> : RPC sobre MQ, que impone una sobrecarga adicional.  Una ca√≠da r√°pida en el rendimiento con una carga creciente (no reflejada en la prueba). </li><li>  <b>Nats</b> : no es malo, aunque inferior a Json invertido, como  RPC sobre MQ tambi√©n tendr√° los mismos problemas. </li><li>  <b>Json invertido</b> : alcanz√≥ el l√≠mite de la red (es decir, el lanzamiento de varias copias de pruebas en diferentes n√∫cleos no da un mejor resultado en total), mostr√≥ el uso m√°s eficiente de la memoria y el procesador en relaci√≥n con el rendimiento. </li><li>  <b>Nginx</b> : cuando se pasa el proxy, el rendimiento disminuye r√°pidamente si el modo mantener vivo no est√° activado (desactivado de manera predeterminada), debido a que Linux no permite abrir / cerrar muchos enchufes en un corto per√≠odo de tiempo (esto no se refleja en la prueba). </li><li>  <b>Traefik</b> : muy voraz, utiliza el 600% de la CPU en el pico, inferior a nginx en velocidad </li><li>  <b>uvloop</b> (bajo asyncio): ofrece muy buen rendimiento, porque  m√°s escrito en C / C ++, para RPC es m√°s preferible que ZeroMQ </li><li>  <b>ZeroMQ</b> : el trabajador en s√≠ est√° escrito en Python, por lo que se ejecut√≥ en el kernel, aunque la prueba multiprocesador consume m√°s del 100% de CPU, esto se debe al hecho de que zeromq est√° escrito en C / C ++ sin captura de GIL.  Ofrece un gran rendimiento, pero, por otro lado, si el trabajador no solo a + b, cualquier complicaci√≥n conducir√° a una reducci√≥n significativa en RPC, porque  llegar√° al n√∫cleo incluso antes. </li><li>  <b>ZeroRPC</b> : declarado como un contenedor ligero sobre ZeroMQ, en realidad, el 95% del rendimiento de ZeroMQ se pierde, parece que no es tan ligero. </li><li>  <b>GRPC</b> : la opci√≥n para python produce una gran cantidad de c√≥digo python repetitivo, es decir  el procesador resulta pesado y descansa r√°pidamente en la CPU, para los idiomas compilados probablemente no haya tal problema. </li><li>  Pruebas de 2 n√∫cleos y m√∫ltiples n√∫cleos, en varios n√∫cleos algunos indicadores disminuyeron, ya que tiene que competir por los recursos de la CPU con el c√≥digo de prueba del cliente, por otro lado, algunas pruebas dieron un gran rendimiento, por ejemplo Traefik, que se comi√≥ el 600% de la CPU </li></ul><br><br><h3>  7. Conclusi√≥n </h3><br>  Si tiene una gran empresa y muchos empleados, puede permitirse soportar varias herramientas complejas para organizar conexiones directas entre microservicios, que pueden proporcionar una comunicaci√≥n efectiva. <br>  Y para peque√±as empresas y nuevas empresas, donde un peque√±o equipo necesita resolver problemas de varios campos, Json invertido puede ahorrar tiempo y recursos. <br><br>  Para el desarrollo de Inverted Json, los planes incluyen soporte para pubsub, kubernetes y otras ideas interesantes. <br>  Si est√° interesado en el proyecto o simplemente quiere ayudar al autor, puede poner un asterisco en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">proyecto github</a> , gracias. <br><br><h3>  PD: </h3><br><ul><li>  Tom√≥ m√°s tiempo crear este art√≠culo, incluidas las pruebas, que crear el propio Json invertido </li><li>  Los prototipos de Json invertidos tambi√©n se escribieron en 1. python + asyncio + uvloop, 2. en GoLang </li><li>  Las pruebas fueron revisadas por diferentes expertos. </li><li>  "Rebanadas en lugar de cadenas": en la mayor√≠a de los casos, al analizar http / json, los datos no se copian en cadenas, pero se utiliza el enlace a los datos de origen, por lo tanto, no hay asignaci√≥n y copia innecesarias de la memoria. </li><li>  Si va a probar, no use solicitudes en python, es muy lento, mejor que pycurl, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">este contenedor se</a> usa en las pruebas. </li><li>  El punto de referencia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">est√° aqu√≠</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">Fuentes aqu√≠</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/466263/">https://habr.com/ru/post/466263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../466247/index.html">Entrevista introvertida</a></li>
<li><a href="../466249/index.html">Escribir una serpiente para Android en Kivy, Python</a></li>
<li><a href="../466251/index.html">Impulsando el proyecto de Soft Launch a $ 1 mill√≥n en ingresos por mes</a></li>
<li><a href="../466253/index.html">C√≥mo reconstru√≠ los sitios de aterrizaje de ALS Luna-9 y Luna-13</a></li>
<li><a href="../466257/index.html">Conquistando los mares: almacenes de datos flotantes</a></li>
<li><a href="../466267/index.html">¬øPor qu√© muchos subestiman sus juegos?</a></li>
<li><a href="../466271/index.html">Cursos conjuntos Grupo-IB y Belkasoft: qu√© ense√±amos y a qui√©n acudir</a></li>
<li><a href="../466279/index.html">La mayor√≠a de los dispositivos Android son vulnerables a los ataques de phishing a trav√©s de SMS</a></li>
<li><a href="../466281/index.html">Realidad virtual, juegos de c√≥digo abierto y autos el√©ctricos: lo que dijo John Carmack en el podcast Joe Rogan</a></li>
<li><a href="../466283/index.html">Opencartforum y amigos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>