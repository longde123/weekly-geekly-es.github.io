<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüë®‚Äçüëß ‚öìÔ∏è üñêÔ∏è Escalonamento de privil√©gios do Windows ‚ùé üßëüèø‚Äçü§ù‚ÄçüßëüèΩ üë¥üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√°tica de gerenciamento de seguran√ßa da informa√ß√£o: pentest 
 Aumentando os privil√©gios do usu√°rio para o n√≠vel de administrador de dom√≠nio do Window...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escalonamento de privil√©gios do Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423937/"><h2>  Pr√°tica de gerenciamento de seguran√ßa da informa√ß√£o: pentest </h2><br>  <b>Aumentando os privil√©gios do usu√°rio para o n√≠vel de administrador de dom√≠nio do Windows</b> <br><br><h4>  1. Introdu√ß√£o </h4><br>  Um bom sistema de gerenciamento de seguran√ßa da informa√ß√£o (SGSI) exige avalia√ß√£o regular de sua efic√°cia.  Existem diferentes m√©todos para essas avalia√ß√µes, uma das variedades denominada.  "Teste de penetra√ß√£o" ou teste - uma simula√ß√£o autorizada de um ataque de hackers a um sistema de informa√ß√µes para identificar vulnerabilidades em sua prote√ß√£o antes que elas sejam detectadas por um invasor real.  Nesse caso, quaisquer ferramentas, explora√ß√µes, m√©todos etc. dispon√≠veis na vida real podem ser usadas. <br><br>  Este artigo descreve uma dessas pr√°ticas anti-hackers, cujo objetivo era aumentar os privil√©gios de um usu√°rio de dom√≠nio comum do Microsoft Windows para o n√≠vel de administrador de dom√≠nio.  O artigo foi baseado em um relat√≥rio sobre os resultados de um teste que foi colocado em pr√°tica.  Por raz√µes de confidencialidade, todas as informa√ß√µes que permitem identificar o local (nomes de dom√≠nio e host, contas etc.) s√£o exclu√≠das ou alteradas.  O artigo mostra as t√©cnicas b√°sicas, para uma melhor compreens√£o, forneci os fundamentos e vulnerabilidades te√≥ricos usados ‚Äã‚Äãpara vers√µes espec√≠ficas de sistemas operacionais, bem como recomenda√ß√µes gerais de prote√ß√£o.  E embora a maioria dessas vers√µes do Windows seja considerada obsoleta no momento da publica√ß√£o, este artigo pode ser √∫til para administradores de sistema iniciantes entenderem melhor como proteger as credenciais do usu√°rio no Windows. <br><a name="habracut"></a><br><h4>  Descri√ß√£o do objeto de teste </h4><br>  O objeto de teste √© bastante padr√£o - o sistema de informa√ß√µes de uma pequena empresa (com menos de 200 funcion√°rios) especializada em desenvolvimento de software.  A rede interna da empresa tamb√©m √© t√≠pica: Gigabit Ethernet de discagem, dom√≠nio do Microsoft Windows (vamos cham√°-lo de CORP.LOCAL).  Os hosts internos s√£o divididos em sub-redes IP com base em sua afilia√ß√£o funcional (como: um grupo de desenvolvedores, engenheiros de qualidade, departamento de recursos humanos, contabilidade, marketing, alta ger√™ncia, instala√ß√µes etc.), toda a segmenta√ß√£o √© feita no switch L3 .  H√° tamb√©m um parque de servidores internos dedicados a uma sub-rede IP separada e cont√©m: dois controladores de dom√≠nio do Windows Server 2008 com DNS integrado, um servidor de email interno executando o Exchange, um servidor de arquivos, um servidor de terminal e alguns outros servidores auxiliares executando o Windows e Linux.  Separadamente, vale a pena observar um laborat√≥rio de teste com uma frota de m√°quinas executando vers√µes diferentes do Microsoft Windows (desktop e servidor) e projetadas para testar o software desenvolvido.  O acesso aos hosts do laborat√≥rio de teste est√° dispon√≠vel para todos os funcion√°rios.  A vers√£o principal do sistema operacional da √°rea de trabalho √© o Windows 7. Software antiv√≠rus mal configurado de diferentes fabricantes √© instalado em computadores e servidores de mesa (da Symantec, Kaspersky e Trend Micro, por que um mal configurado ser√° discutido mais adiante). <br><br><h4>  Intruder Model </h4><br>  Intruso - um funcion√°rio interno que possui uma conta de usu√°rio sem privil√©gios no dom√≠nio, um computador de mesa, acesso f√≠sico a computadores de teste (possivelmente possui um laptop corporativo), mas n√£o possui privil√©gios de administrador local em nenhum deles.  Al√©m disso, a conta do invasor n√£o tem a capacidade de alterar as configura√ß√µes do software antiv√≠rus.  A inten√ß√£o do invasor √© obter acesso equivalente ao acesso do administrador ao controlador de dom√≠nio e / ou servidor de arquivos. <br><br>  Como vemos, tanto o modelo do intruso quanto a descri√ß√£o da empresa s√£o bastante t√≠picos. <br><br><h3>  Implementa√ß√£o de ataque </h3><br><h4>  Etapa 0. Coleta de informa√ß√µes sobre a rede interna </h4><br>  Ent√£o, agimos em nome do ofensor.  Nesta etapa, precisamos coletar informa√ß√µes sobre: <br><br><ul><li>  endere√ßamento interno e sub-rede </li><li>  nomes de host e endere√ßos IP, antes de tudo, estamos interessados ‚Äã‚Äãem uma lista de servidores </li><li>  usando o protocolo NetBIOS. </li></ul><br>  Primeiro, usando o utilit√°rio ipconfig, obtemos os endere√ßos IP dos servidores DNS: 192.168.12.1 e 192.168.12.2.  Porque  O DNS est√° integrado ao Active Directory, o que nos d√° motivos para acreditar que conhecemos os endere√ßos IP dos controladores de dom√≠nio.  Em seguida, usando o utilit√°rio nslookup no modo interativo, tentamos obter uma lista de todos os hosts na zona corp.local: <br><br>  <i>&gt; ls ‚Äìd corp.local&gt; arquivo</i> <br><br>  De fato, este comando inicia uma transfer√™ncia completa da zona DNS, salvando-a em arquivo.  Muitos administradores esquecem-se de definir restri√ß√µes na transfer√™ncia de zona para a rede interna, o que facilita a um invasor em potencial coletar informa√ß√µes sobre a infraestrutura da empresa, para obter mais detalhes, consulte [12]. <br><br>  <b>Resultado.</b>  Sucesso.  Uma transfer√™ncia de zona desprotegida nos deu uma lista completa de nomes de host internos, incluindo servidores e seus endere√ßos IP.  Usando os utilit√°rios nbtstat, telnet, bem como qualquer um dos scanners de vulnerabilidade comuns, um invasor pode coletar informa√ß√µes sobre a plataforma, servi√ßos em execu√ß√£o e vers√µes do SO nos hosts de seu interesse. <br><br><h4>  Etapa 1. Obtendo privil√©gios de administrador local </h4><br>  <b>Teoria</b>  Para obter a senha do administrador local, um ataque √© aplicado ao valor do hash dessa senha armazenada no registro do sistema.  Apesar do fato de a fun√ß√£o hash ser matematicamente irrevers√≠vel, o c√°lculo da senha √© poss√≠vel pela enumera√ß√£o direta de seus valores, juntamente com um ataque de dicion√°rio.  O Windows historicamente usou dois algoritmos para calcular uma fun√ß√£o de hash de senha: o algoritmo LM herdado e o algoritmo NT mais recente (√†s vezes tamb√©m chamado de NTLM).  A fun√ß√£o hash LM √© vulner√°vel devido √† sua baixa complexidade computacional, o que torna poss√≠vel enumerar seus valores mesmo em um computador fraco.  A presen√ßa de hashes de senha LM e NT no registro do sistema garante que o invasor possa decifr√°-lo em um per√≠odo de tempo aceit√°vel.  O valor do hash LM nas configura√ß√µes padr√£o √© armazenado no registro do Windows XP / 2003, o que torna esses sistemas especialmente atraentes para o hacker.  A fun√ß√£o hash NT √© computacionalmente mais complexa, no entanto, enumerar seus valores √© bastante simplificada pelo fato de existirem tabelas de valores pr√©-calculados dispon√≠veis (as chamadas tabelas Rainbow) para elas - elas reduzem o c√°lculo do valor hash √† pesquisa do hash desejado entre valores pr√©-calculados. <br><br>  <b>Objeto de ataque.</b>  Hash de senha no banco de dados SAM (registro).  No nosso caso, s√£o todas as m√°quinas √†s quais temos acesso f√≠sico.  Primeiro, este √© o nosso desktop de trabalho e, em segundo lugar, os hosts para a realiza√ß√£o de testes. <br><br>  <b>Implementa√ß√£o.</b>  Com m√°quinas com acesso f√≠sico, realizamos a seguinte opera√ß√£o: inicialize a partir de uma m√≠dia externa (usando um CD do ambiente de pr√©-instala√ß√£o do Windows ou Linux Live CD), monte a parti√ß√£o do sistema NTFS e copie os ramos do registro HKLM \ SYSTEM e HKLM \ SAM (arquivos% WINDIR % \ System32 \ Config \ System e% WINDIR% \ System32 \ Config \ Sam, respectivamente).  Prestamos aten√ß√£o especial √†s m√°quinas que executam o Windows XP \ Windows 2003, nas quais √© prov√°vel que o hash LM seja encontrado.  Para despejar senhas dos arquivos de registro copiados, usamos as ferramentas [1], [2] (todos os links no final do artigo).  Resultado: <br><br><img src="https://habrastorage.org/webt/kn/jq/wm/knjqwm1nlf7ljjd99ndwh60bngg.png" alt="imagem"><br><br>  A √∫ltima linha cont√©m o hash NT necess√°rio do administrador local.  Nos hosts do laborat√≥rio de teste (vamos chamar esses hosts de LAB1 e LAB2), encontramos um hash LM diferente de zero: <br><br><img src="https://habrastorage.org/webt/sz/wi/30/szwi30d1cje8gsfkiok70xtnuyy.png" alt="imagem"><br><br><img src="https://habrastorage.org/webt/1j/g5/l-/1jg5l-dgphti0eayxdcozs-onts.png" alt="imagem"><br><br>  Ent√£o, temos hashes NT e LM.  Mas como recuperar a senha deles?  Para fazer isso, usaremos as mesmas ferramentas [1], [2], bem como os servi√ßos de revers√£o de hash online [8] - [11]: <br><br><img src="https://habrastorage.org/webt/qx/dk/70/qxdk70sdc94zqcuzmxkavjeu4tg.png" alt="imagem"><br><br>  Nota: a senha real consistia no nome da empresa com um pequeno modificador e quebrou rapidamente sob um ataque de dicion√°rio). <br><br>  <b>Resultado.</b>  Sucesso.  As senhas (sejam "Pa $$ word1" e "Pa $$ word2") da conta do administrador local de nossa √°rea de trabalho e dois computadores de teste foram recebidos.  Mas eles ajudar√£o a obter direitos de administrador de dom√≠nio?  Sobre isso mais. <br><br><h4>  Etapa 2. Obtendo credenciais de administrador de dom√≠nio </h4><br>  <b>Teoria</b>  Na maioria dos casos, √© suficiente obter o valor do hash NT da senha para o administrador do dom√≠nio.  Isso ocorre porque, quando um usu√°rio √© verificado usando o protocolo NTLM, o sistema autenticado apresenta apenas o hash NT para o autenticador e a verifica√ß√£o de senha n√£o ocorre.  O hash NT pode ser obtido no chamado  Armazenamento LSA, consultando os chamados  Sess√µes de logon do administrador (a sess√£o de logon √© uma √°rea de dados especial criada pelo processo Winlogon em que o nome de usu√°rio, o dom√≠nio de login e o valor do hash da senha do NT s√£o armazenados, coletivamente, isso √© chamado de segredo LSA).  Esse hash NT √© usado pelo processo NTLMSSP para autentica√ß√£o NTLM.  A sess√£o de logon √© salva o tempo todo enquanto a conta est√° conectada ao sistema.  Voc√™ tamb√©m pode interceptar um hash do NT de uma sess√£o de autentica√ß√£o de administrador do NTLM.  Al√©m disso, √© poss√≠vel obter uma senha de administrador no cache DCC (Credenciais em cache do dom√≠nio).  DCC √© um cache local que preenche quando um usu√°rio faz logon com √™xito em um dom√≠nio.  O objetivo do cache do DCC √© poder autenticar o usu√°rio quando o controlador de dom√≠nio n√£o estiver dispon√≠vel. <br><br>  <b>Objetos de ataque:</b> <br><br><ul><li>  Hashes DCC (filial do registro HKLM \ Security). </li><li>  Sess√£o de logon do administrador de dom√≠nio (segredo LSA). </li><li>  Intercepta√ß√£o de sess√µes NTLM (n√£o consideradas devido √† maior complexidade pr√°tica). </li></ul><br>  <b>Pr√°tica.</b>  Muitos administradores do Windows usam uma conta de administrador de dom√≠nio para executar v√°rios tipos de opera√ß√µes nos computadores dos usu√°rios.  Ao mesmo tempo, seus dados caem no cache do DCC.  Portanto, primeiro tente obter a senha do cache do DCC.  N√≥s vamos para nossa esta√ß√£o de trabalho, salvamos o ramo de registro HKLM \ Security e importamos para [1].  Porque  temos uma senha de administrador local, n√£o precisamos mais inicializar a m√°quina a partir de m√≠dia externa para salvar o registro: <br><br><img src="https://habrastorage.org/webt/up/6p/v3/up6pv3qirtuto8wcxfk6lkofkqq.png" alt="imagem"><br><br>  O cache cont√©m os dados da senha de tr√™s contas.  A √∫ltima conta (*** usu√°rio) n√£o nos interessa, a segunda conta n√£o possui os privil√©gios necess√°rios, mas o usu√°rio shadmin se parece com o administrador que voc√™ est√° procurando.  Infelizmente, o algoritmo MS-CACHE2 possui grande complexidade computacional e um ataque direto de for√ßa bruta √© ineficiente.  A fun√ß√£o MS-CACHEv2 cont√©m um "segredo computacional" - salt (o nome da conta √© usado como "salt"), que a protege contra ataques nas tabelas Rainbow.  No entanto, no futuro, tabelas de valores de hash podem aparecer para contas padr√£o - "Administrador", "Administrador" etc.  Por uma quest√£o de interesse, enviamos o ‚Äúhash de cache‚Äù encontrado para o servi√ßo em nuvem [8] - [11] (sobre os resultados e a efic√°cia de tais servi√ßos no final do artigo).  Enquanto a nuvem est√° pensando, estamos tentando encontrar outros DCCs.  Analisamos a lista de hosts obtidos na etapa 0, verificamos quais servidores podemos acessar no administrador local usando as senhas obtidas na etapa 1. Como no controlador de dom√≠nio, o administrador local √© bloqueado e o servidor de email geralmente √© mais protegido, voc√™ precisa experimentar servidores secund√°rios.  No nosso caso, um servidor com o nome discreto Upd foi encontrado na lista de servidores.  O login com a senha ‚ÄúPa $$ word2‚Äù encontrada na etapa 1 foi bem-sucedida.  Conclu√≠mos que no host Upd: <br><br><ol><li>  Nenhum software antiv√≠rus instalado. </li><li>  Ele executa o Apache, que √© o servidor de gerenciamento de antiv√≠rus corporativo (isso significa que tamb√©m h√° uma senha para a conta usada para instalar o software antiv√≠rus remotamente e, teoricamente, voc√™ pode tir√°-lo de l√°). </li><li>  O host n√£o audita as tentativas de logon com falha. </li><li>  Vers√£o do sistema operacional - Windows 2008 R2. </li></ol><br>  Ap√≥s despejar o registro HKLM \ Security, obtemos o hash DCC da conta CORP.LOCAL \ Administrator (e v√°rias outras): <br><br><img src="https://habrastorage.org/webt/a5/3t/--/a53t--0v2fycjxm29xiytiqri3g.png" alt="imagem"><br><br>  Teoricamente, voc√™ pode tentar encontrar a senha do administrador atrav√©s de um servi√ßo em nuvem.  No entanto, como mencionei acima, um ataque de for√ßa bruta ao MS-CACHEv2 √© in√∫til (embora, talvez, em alguns anos a situa√ß√£o mude).  Deixe o DCC em paz e passe a procurar sess√µes de logon.  Verifique qual usu√°rio fez logon no host Upd: <br><br><img src="https://habrastorage.org/webt/57/ri/fa/57rifa8peyelwyvtbw6d4nwrofu.png" alt="imagem"><br><br>  Vemos que duas sess√µes inativas ficam penduradas na m√°quina Upd - o administrador e o usu√°rio Shadmin, que j√° conhecemos, o que significa que podemos obter hashes NT de suas senhas roubando o segredo da LSA.  Essa √© a chave para determinar o sucesso de todo o ataque.  Para roubar um hash, use a explora√ß√£o Lslsass [3].  Para execut√°-lo, voc√™ precisa de direitos de administrador local (ou melhor, direitos para processos de depura√ß√£o), que j√° temos.  N√≥s obtemos a lista de segredos do LSA (no formato "dom√≠nio \ conta: LM hash: NT hash :::"): <br><br><pre><code class="hljs pgsql">lslsass v1<span class="hljs-number"><span class="hljs-number">.0</span></span> - Copyright (C) <span class="hljs-number"><span class="hljs-number">2010</span></span> Bjorn Brolin, Truesec (www.truesec.com) <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> Lsass pid: <span class="hljs-number"><span class="hljs-number">520</span></span> Lsass process <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:&lt;i&gt;<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e&lt;/i&gt;::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>\UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>: &lt;b&gt; c690e441dc78bc5da8b389e78daa6392 &lt;/b&gt;::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \shadmin::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>: &lt;b&gt; <span class="hljs-number"><span class="hljs-number">5794</span></span>cba8b464364eacf366063ff70e78 &lt;/b&gt; :::</code> </pre> <br>  As linhas destacadas em negrito cont√™m os hashes de senha necess√°rios.  Observe tamb√©m o hash em it√°lico na sexta linha.  J√° o vimos em algum lugar, certo? <br><br>  <b>Resultado.</b>  Sucesso.  Temos o hash de senha do NT da conta de administrador do dom√≠nio em nossas m√£os.  Mas qual √© o uso de um hash se a restaura√ß√£o da senha original em um tempo aceit√°vel n√£o for poss√≠vel?  Sobre isso na pr√≥xima etapa. <br><br><h4>  Etapa 3. Engane a sess√£o de autentica√ß√£o NTLM </h4><br>  <b>Teoria</b>  O Windows nunca usa uma senha pura para autentica√ß√£o, o sistema autenticado sempre apresenta um hash.  Isso d√° origem √† ideia: substituindo o nome de usu√°rio, o dom√≠nio de login e o hash do NT na sess√£o de Logon do usu√°rio conectado pelos valores apropriados de administrador de dom√≠nio, podemos autenticar usando o protocolo NTLM antes do sistema remoto como administrador de dom√≠nio.  Este ataque [7] √© poss√≠vel apenas com autentica√ß√£o usando o protocolo NTLM.  Apesar do amplo uso do protocolo Kerberos, o NTLM √© a √∫nica maneira poss√≠vel de autenticar um cliente ao acessar um compartilhamento de rede, n√£o pelo nome simb√≥lico, mas pelo endere√ßo IP [13]. <br><br>  <b>Objeto de ataque.</b>  Sess√£o de logon do administrador local. <br><br>  <b>Pr√°tica.</b>  Existem v√°rias explora√ß√µes dispon√≠veis que permitem implementar um ataque nas plataformas Windows Server 2008 x86 e x64.  A principal explora√ß√£o √© o Editor de credenciais do Windows [4].  Para realizar o ataque, vamos ao host do LAB2 usando as credenciais "Administrador" \ "Pa $$ word2".  Usando [4], substitu√≠mos o nome da conta, o dom√≠nio de login e os dados de hash do NT na sess√£o de Logon pelos valores correspondentes do Shadmin que obtivemos na etapa anterior: <br><br><img src="https://habrastorage.org/webt/ww/kp/hc/wwkphcbxcv5fjhsrlk_1ydcakze.png" alt="imagem"><br><br>  O nome da conta do administrador do dom√≠nio e seu hash NT s√£o passados ‚Äã‚Äãpara o comando wce como um argumento na linha de comando.  Resultado - o hash foi alterado com sucesso.  Observo que a participa√ß√£o do usu√°rio no grupo e o token de acesso n√£o s√£o alterados durante o ataque: <br><br><img src="https://habrastorage.org/webt/jg/jn/ym/jgjnymw3o3j8yv9cfd1sjojagbe.png" alt="imagem"><br><br>  Ainda somos o administrador local, o nome do host em verde na captura de tela acima est√° manchado de verde - LAB2.  No entanto, durante a autentica√ß√£o NTLM, o sistema remoto ser√° apresentado com o nome de dom√≠nio CORP.LOCAL, nome de usu√°rio Shadmin e hash de senha Shadmin.  Aqui est√° um despejo de um √∫nico pacote de rede que cont√©m a sess√£o de blob de seguran√ßa NTLM: <br><br><img src="https://habrastorage.org/webt/tt/c7/_x/ttc7_xrvp9e81zvathjqultz5sc.png" alt="imagem"><br><br>  O nome do dom√≠nio (CORP.LOCAL) e o nome do host (LAB2) est√£o acinzentados em verde), uma conta √© apresentada - Shadmin.  Agora tentamos conectar-se √† parti√ß√£o raiz do volume do sistema no controlador de dom√≠nio com o comando net use usando o endere√ßo IP do controlador de dom√≠nio: <br><br><img src="https://habrastorage.org/webt/ja/ga/2h/jaga2h8xrnj_wbn5acv-fe6zlqs.png" alt="imagem"><br><br>  Com sucesso.  Para verificar o acesso, criei um arquivo de texto na raiz (localize-o na captura de tela).  Depois de criar um arquivo em lote no disco do controlador de dom√≠nio com a sequ√™ncia de comandos que precisamos, usando [5], podemos executar a opera√ß√£o necess√°ria no controlador de dom√≠nio (por exemplo, adicionar o usu√°rio ao grupo de administradores de dom√≠nio).  A opera√ß√£o ser√° realizada com os direitos da conta Shadmin.  Para ilustrar, crie um arquivo em lotes simples em um host remoto que adicione um usu√°rio local: <br><br>  <i>usu√°rio l√≠quido Pa TstUsr $$ word / add</i> <br><br>  Execute-o remotamente a partir do host LAB2: <br><br><img src="https://habrastorage.org/webt/q3/3l/qf/q33lqf4cb4u9rw8zwqpcfpwhw-c.png" alt="imagem"><br><br>  Ele ser√° executado no sistema remoto 192.168.13.125 com os privil√©gios do usu√°rio da nossa sess√£o atual - shadmin (ou seja, administrador de dom√≠nio).  Verificamos: <br><br><img src="https://habrastorage.org/webt/cq/oj/wp/cqojwpt8bb1c0volgimww9gsv-c.png" alt="imagem"><br><br>  A segunda sa√≠da do comando net user mostra o novo usu√°rio.  Apesar da impossibilidade de iniciar aplicativos que requerem intera√ß√£o interativa do usu√°rio dessa maneira (por exemplo, snap-ins do MMC), uma ampla gama de a√ß√µes pode ser executada usando scripts. <br><br>  <b>Resultado.</b>  Sucesso.  Obteve acesso ao sistema de arquivos e ao shell do controlador de dom√≠nio. <br><br><h4>  Sum√°rio </h4><br>  Resumidamente, a cadeia de ataques ficou assim: Reunindo informa√ß√µes sobre a estrutura da rede -&gt; Obtendo uma senha de administrador local -&gt; Usando esta senha para efetuar login em um dos servidores secund√°rios -&gt; Roubo de credenciais de administrador de dom√≠nio "deixadas sem vigil√¢ncia" -&gt; Modificando sua sess√£o de Logon e escala√ß√£o de privil√©gios. <br><br>  O sucesso do ataque foi facilitado por: <br><br><ol><li>  Prote√ß√£o fraca da zona DNS da transfer√™ncia para hosts n√£o confi√°veis. </li><li>  Pol√≠tica de senha fraca.  A maioria dos computadores do dom√≠nio usava a mesma senha para a conta de administrador local, vulner√°vel a um ataque de dicion√°rio. </li><li>  A aus√™ncia ou configura√ß√£o fraca do software antiv√≠rus em hosts cr√≠ticos. </li><li>  Prote√ß√£o de hashes de senha fraca - duas sess√µes de Logon de administrador inativas no host Upd, hashes de LM no banco de dados SAM. </li><li>  Pol√≠tica de auditoria ruim. </li></ol><br><br>  Com base nisso, podem ser derivadas recomenda√ß√µes gerais de prote√ß√£o: <br><br>  0. Esconda completamente a estrutura interna da rede dos poss√≠veis invasores.  Portanto, os usu√°rios n√£o devem conseguir obter o conte√∫do completo do arquivo de zona DNS.  Usu√°rios n√£o confi√°veis ‚Äã‚Äã(por exemplo, estagi√°rios, funcion√°rios que n√£o conclu√≠ram o per√≠odo de avalia√ß√£o etc.), faz sentido transferir para uma sub-rede separada usando NAT para falsificar endere√ßos (incluindo, por exemplo, modificar respostas de DNS). <br><br>  1. A pol√≠tica correta para atribuir senhas ao administrador local.  A senha do administrador local deve ser diferente nos hosts com diferentes graus de prote√ß√£o contra acesso n√£o autorizado.  Comprometer a senha do administrador local em qualquer um dos hosts do dom√≠nio deve minimizar a possibilidade de um invasor usar essa senha. <br><br>  2. O armazenamento do hash LM no SAM deve ser proibido pelas pol√≠ticas de seguran√ßa. <br><br>  3. N√£o use o nome da empresa ou seu dom√≠nio como parte da senha do administrador) Isso tornar√° dif√≠cil para um invasor atacar o dicion√°rio.  Mas, mesmo usando uma senha complexa, n√£o se esque√ßa e verifique regularmente seu hash quanto √† durabilidade usando servi√ßos online. <br><br>  4. N√£o √© recomend√°vel executar opera√ß√µes de rotina nos computadores do dom√≠nio na conta de administrador do dom√≠nio.  Isso proteger√° a conta de interceptar os dados da sess√£o de logon e de obter o hash da senha no cache do DCC. <br><br>  5. Crie uma regra para n√£o deixar a sess√£o de Logon do administrador do dom√≠nio sem supervis√£o.  Pr√°tica recomendada: trabalho finalizado - efetue logout. <br><br>  6. Os utilit√°rios de falsifica√ß√£o de LSA s√£o bastante pequenos.  Faz sentido acompanhar sua evolu√ß√£o e verificar sua detec√ß√£o bem-sucedida por software antiv√≠rus corporativo. <br><br>  7. Um usu√°rio, mesmo com direitos de administrador local, n√£o poder√° alterar as configura√ß√µes de um antiv√≠rus corporativo.  Desativar o servi√ßo antiv√≠rus nas esta√ß√µes de trabalho do dom√≠nio deve resultar em uma notifica√ß√£o ao administrador do dom√≠nio (nesse sentido, o Symantec Endpoint Protection funcionou bem durante o teste). <br><br><h4>  Ap√™ndice 1. Comportamento antiv√≠rus </h4><br>  Os computadores da empresa usavam tr√™s tipos de antiv√≠rus: KAV, atual no momento do teste do Symantec Endpoint Protection, e um produto desatualizado da Trend Micro.  Na maioria dos casos, as ferramentas usadas durante o ataque foram identificadas como a Hack Tool / Rootkit / Trojan.  O KAV os excluiu sem aviso e o SEP (mesmo desligado) emitiu um aviso e o moveu para a quarentena, impedindo o in√≠cio.  No entanto, ter direitos de administrador local permite desativar o KAV, e a prote√ß√£o do SEP foi ignorada definindo manualmente um caminho de exce√ß√£o para verifica√ß√£o, novamente usando a conta de administrador local.  O antiv√≠rus da Trend Micro instalado em alguns hosts n√£o reagiu de forma alguma ao lan√ßamento de explora√ß√µes. <br><br><h4>  Adenda 2. Efici√™ncia no uso de servi√ßos de verifica√ß√£o de hash online </h4><br>  Existem muitos servi√ßos online dispon√≠veis para testar a for√ßa dos hashes de senha.  Eles permitem que voc√™ trabalhe com os hashes mais comuns - LM, NTLM, MD4, MD5, WPA, com hashes usando sal, etc.  Para verificar o hash, a enumera√ß√£o direta √© usada usando o poder de processamento das GPUs modernas, enumera√ß√£o de dicion√°rio, ataques h√≠bridos etc.  Uma vez aberto, o hash pode reabastecer o banco de dados e ser usado no futuro.  O servi√ßo pode ser gratuito para verificar uma senha curta (menos de 8 caracteres) ou cobrar uma pequena taxa.  Durante o teste, usei quatro desses servi√ßos, os links s√£o fornecidos no final do artigo.  Enviei v√°rios hashes encontrados na etapa 2 e ap√≥s 15 meses recebi uma notifica√ß√£o do servi√ßo On-line Hash Crack [9] sobre a restaura√ß√£o bem-sucedida de um deles) <br><br><h4>  Refer√™ncias </h4><br>  <b>Ferramentas usadas</b> <br><br>  [1] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Cain &amp; Abel</a> - uma ferramenta de recupera√ß√£o de senha para os sistemas operacionais da Microsoft.  Ele permite a recupera√ß√£o f√°cil de v√°rios tipos de senhas, detectando a rede, decifrando senhas criptografadas usando ataques Dictionary, Brute-Force e Cryptanalysis, gravando conversas VoIP, decodificando senhas codificadas, recuperando chaves de rede sem fio, revelando caixas de senhas, revelando caixas de senhas, descobrindo senhas em cache e analisando o roteamento protocolos. <br>  [2] Rachadura de 0pht. <br>  [3] Explora√ß√£o de Lslsass.  Despeja hashes de senha de sess√£o de logon ativo do processo lsass. <br>  [4] P√≥s-explora√ß√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Windows Credentials Editor</a> .  Ferramenta para alterar credenciais de logon. <br>  [5] PsExec da PS Tools <br><br>  <b>Descri√ß√µes detalhadas da vulnerabilidade</b> <br><br>  [6] S√©rie de artigos "Obtendo efetivamente um hash de senha no Windows" em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">www.securitylab.ru</a> <br>  [7] Pass-the-Hash, uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">descri√ß√£o de um ataque</a> a um sistema remoto, fornecendo um hash comprometido. <br><br>  <b>Servi√ßos de hackers em Hash na nuvem</b> <br>  [8] Question-defense.com (parece estar fora de ordem no momento da publica√ß√£o () <br>  [9] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">www.onlinehashcrack.com</a> <br>  [10] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">www.cloudcracker.com</a> <br>  [11] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Assassino de hash on-line</a> <br><br>  <b>Materiais adicionais</b> <br><br>  [12] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Seguran√ßa e ajuste de DNS no Windows Server</a> <br>  [13] O <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kerberos n√£o √© usado quando voc√™ se conecta a compartilhamentos SMB usando o endere√ßo IP.</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt423937/">https://habr.com/ru/post/pt423937/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt423925/index.html">Semin√°rio on-line aberto "Modelo recursivo estranho"</a></li>
<li><a href="../pt423927/index.html">10 motores de busca promissores para melhorar o SEO</a></li>
<li><a href="../pt423931/index.html">Como ignorar a autentica√ß√£o de SMS ao se conectar a redes Wi-Fi p√∫blicas?</a></li>
<li><a href="../pt423933/index.html">Microsoft Office Security: Objetos incorporados</a></li>
<li><a href="../pt423935/index.html">A Embox responde a perguntas populares do festival de TI TechTrain</a></li>
<li><a href="../pt423939/index.html">Programa√ß√£o din√¢mica ou dividir e conquistar</a></li>
<li><a href="../pt423941/index.html">Relat√≥rios do iOS mitap Redmadrobot</a></li>
<li><a href="../pt423943/index.html">Otimiza√ß√£o de pre√ßo de varejo offline</a></li>
<li><a href="../pt423945/index.html">A Suprema Corte especificou o procedimento para considerar casos com republica√ß√µes e curtidas</a></li>
<li><a href="../pt423947/index.html">Nossos dados pessoais n√£o custam nada</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>