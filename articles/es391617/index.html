<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∂ ‚úåüèº ü•î Sustituci√≥n del ajuste anal√≥gico por digital en la fuente de alimentaci√≥n del laboratorio HY3005D üó®Ô∏è üèòÔ∏è üò¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El art√≠culo discutir√° el reemplazo de potenci√≥metros est√°ndar con codificadores mec√°nicos EC11 (sensores de √°ngulo de acumulaci√≥n) en una unidad de fu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sustituci√≥n del ajuste anal√≥gico por digital en la fuente de alimentaci√≥n del laboratorio HY3005D</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/391617/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;El art√≠culo discutir√° el reemplazo de potenci√≥metros est√°ndar con codificadores mec√°nicos EC11 (sensores de √°ngulo de acumulaci√≥n) en una unidad de fuente de alimentaci√≥n Mastech HY3005D usando un microcontrolador PIC16F1829 y un registro de desplazamiento 74HC595 que implementa un DAC en una matriz de resistencia R2R</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√≥logo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Hace unos a√±os, compr√© una fuente de alimentaci√≥n Mastech HY3005D. No hace mucho tiempo hab√≠a problemas con la regulaci√≥n de voltaje: el revestimiento de grafito de los re√≥statos estaba desgastado y establecer el voltaje requerido se convirti√≥ en una tarea dif√≠cil. No hab√≠a re√≥statos adecuados, y decid√≠ no comprar otros similares, sino cambiar el m√©todo de ajuste. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;El nivel de voltaje y corriente de salida se establece mediante el voltaje de referencia suministrado a los amplificadores operacionales. Por lo tanto, puede deshacerse por completo de los potenci√≥metros reemplaz√°ndolos con un DAC capaz de entregar voltaje en el rango deseado.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;En el cat√°logo de microchip, no pude encontrar un microcontrolador adecuado que tenga dos DAC a bordo, y los DAC externos no tienen un precio peque√±o y demasiada funcionalidad adicional. </font><font style="vertical-align: inherit;">Por lo tanto, adquir√≠ los registros de desplazamiento 74HC595 y las resistencias para la matriz R2R. </font><font style="vertical-align: inherit;">El microcontrolador PIC16F1829 ya estaba en stock. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Para poder volver al circuito original, se minimizan todos los cambios, reemplazando la unidad de ajuste realizada en una placa separada.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descripci√≥n del puesto</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;El circuito se basa en el microcontrolador </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PIC16F1829 que</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> funciona a una frecuencia de 32 MHz. La frecuencia del reloj la establece el generador de reloj incorporado, de acuerdo con la hoja de datos no es demasiado precisa, pero para este circuito no es cr√≠tica. La ventaja de este MK es la presencia de resistencias pull-up en todas las entradas digitales y dos m√≥dulos MSSP que implementan SPI. Se utilizan los 18 pines l√≥gicos del microcontrolador. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;En cuatro registros de desplazamiento </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">74HC595</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y las matrices R2R implementaron dos DAC de 16 bits. Las ventajas de este registro incluyen la presencia de un registro de desplazamiento y un registro de almacenamiento separados. Esto le permite escribir datos en el registro sin romper los valores de salida actuales. La matriz R2R se ensambla en resistencias con un error del 1%. Vale la pena se√±alar que las mediciones selectivas mostraron un error de no m√°s de 10 ohmios. Inicialmente, se plane√≥ usar 3 registros, pero al conectar el tablero no me pareci√≥ una buena soluci√≥n, adem√°s, era necesario agregar mordiscos.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Las resistencias pull-up integradas en el MC se activan en todas las entradas y simplifican el circuito. Todas las salidas de los codificadores est√°n conectadas directamente a los terminales MK, un total de 4 codificadores tienen dos salidas cada una para el sensor de rotaci√≥n y una para el bot√≥n incorporado. Un total de 12 conclusiones MK se utiliza para procesar datos de entrada. El rebote de contacto se suaviza con una capacidad de 100nF. Despu√©s de cambiar los valores de las memorias intermedias de voltaje y corriente de 16 bits de acuerdo con los datos de entrada de los codificadores, los valores se transfieren a los registros de desplazamiento 74HC595 a trav√©s de SPI. Para reducir el tiempo de transferencia de datos, se utilizan dos m√≥dulos SPI, lo que permite que los datos se transmitan simult√°neamente para corriente y voltaje. Despu√©s de que los datos se transfieren al registro, se env√≠a un comando para transferir datos desde el b√∫fer de cambio al b√∫fer de almacenamiento. Las salidas del registro est√°n conectadas a la matriz R2R que act√∫a como un divisor para el DAC.El voltaje de salida de la matriz se transmite a las entradas de los amplificadores operacionales.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Los botones integrados en los codificadores establecen el m√≠nimo (bot√≥n del codificador para un ajuste suave) o el m√°ximo (bot√≥n del codificador para el ajuste aproximado), respectivamente, para corriente o voltaje.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esquema</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;En Internet, no encontr√© un esquema que coincidiera completamente con el m√≠o, as√≠ que tom√© el primer enlace. </font><font style="vertical-align: inherit;">Se realizaron correcciones en las inconsistencias reveladas y luego se agregaron los cambios. </font><font style="vertical-align: inherit;">Dibuj√© un diagrama del bloque de ajuste en TinyCAD: descargue el archivo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HY3005D-regulator.dsn</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El original</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/c04/fe1/917/c04fe19174fe4b469bd80b9a6c45139c.gif"><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de encontrar imprecisiones</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/484/820/123/4848201239bc4dfd95b06a98798a6289.gif"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El esquema final despu√©s del refinamiento La </font></font><br>
<img src="https://habrastorage.org/files/b3e/41c/9f1/b3e41c9f1ed941efb654903269157775.gif"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
unidad port√°til con ajuste (resaltada en rojo) se coloc√≥ en un esquema separado. </font></font><br>
<img src="https://habrastorage.org/files/306/7ff/1b6/3067ff1b6f29462ba6d4adffad1526f7.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se conecta un volt√≠metro digital con una pantalla en el panel frontal (no est√° en los diagramas) al conector J3.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Componentes utilizados</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A continuaci√≥n se muestra una lista de los componentes utilizados (el caso se indica entre par√©ntesis). </font><font style="vertical-align: inherit;">Todos fueron comprados en diferentes momentos en China. </font><font style="vertical-align: inherit;">Es importante utilizar LED con las mismas caracter√≠sticas que los nativos, como </font><font style="vertical-align: inherit;">se colocan en serie en el circuito de salida de los amplificadores operacionales (tom√© los mismos que estaban en mi placa base).</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">U1: PIC16F1829I / ML microcontrolador (QFN)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">U2 - U5: registro de desplazamiento 74HC595BQ (DHVQFN16 o SOT-763)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">U6: regulador de voltaje lineal AMS1117 5V (SOT-223)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RE1 - RE4: sensor de √°ngulo de acumulaci√≥n mec√°nico EC11</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Matrices R1, R2 y R2R: resistencias de 1 y 2 kŒ© (SMD 0402)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C1 - C12, C14-C17: Condensadores de cer√°mica GRM21BR71E104KA01L 100nF (SMD 0805)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C13: condensador de tantalio 22mkF 16V (tiv B)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D1, D2: LED de voltaje / corriente del panel frontal</font></font></li>
</ul><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarifa</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Cre√© la placa en Sprint Layout 6: descargue el archivo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HY3005D-regulator.lay6</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Desafortunadamente, el original en el que hice mi versi√≥n no se conserv√≥, ya en formato lay6 con correcciones identificadas durante el ensamblaje:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agregu√© puentes al lado de la interfaz de firmware a la conexi√≥n de interrupci√≥n del codificador de control de corriente suave, porque </font><font style="vertical-align: inherit;">las capacidades de filtrado de rebote de contacto impidieron el parpadeo del controlador</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se agregaron puentes faltantes para el suelo entre los lados</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se movi√≥ el conjunto estabilizador de 5 V al otro lado para reducir a trav√©s de puentes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Condensadores de suavizado agregados en la l√≠nea de alimentaci√≥n ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discusi√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
</ol><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Foto despu√©s del grabado y la perforaci√≥n (primera versi√≥n)</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/getpro/geektimes/post_images/593/555/618/593555618b46cfb0ea30bc3fb40f31e6.jpg"><br>
<img src="https://habrastorage.org/getpro/geektimes/post_images/6ec/ebc/c47/6ecebcc4789fd48ab80a8ef7f690049a.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Hecho con pel√≠cula fotorresistente. </font><font style="vertical-align: inherit;">Sufr√≠ durante mucho tiempo con un peque√±o cableado de registros. </font><font style="vertical-align: inherit;">En la √∫ltima versi√≥n, hubo peque√±os defectos que tuvieron que limpiarse despu√©s del grabado. </font><font style="vertical-align: inherit;">Pero en general, la junta fall√≥. </font><font style="vertical-align: inherit;">Todav√≠a no hay suficientes dos puentes para conectar el suelo en los lados frontal y posterior.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de ingresar los problemas identificados (segunda versi√≥n)</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/450/175/2fe/4501752fed894a78be212939a76b2794.png"><br>
<img src="https://habrastorage.org/files/a69/089/610/a6908961064b4f25984f5c1ee53dd8b6.png"><br>
       0    SMD 0805.<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Foto despu√©s de soldar e instalar en su lugar</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/getpro/geektimes/post_images/be4/678/8d1/be46788d12079fd0ca782c1f084cf166.jpg"><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     .   ‚Äî     .          ‚Äî   12.<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Como puede ver, los cambios son m√≠nimos, todos los conectores antiguos permanecieron sin cambios. </font><font style="vertical-align: inherit;">Tuve que agregar comida por separado, porque </font><font style="vertical-align: inherit;">El √∫nico voltaje que llega a la placa de ajuste de 2.5V no es adecuado para el divisor nativo. </font><font style="vertical-align: inherit;">Si quita el diodo zener a 2.5V (V5A) en la placa principal de la unidad de fuente de alimentaci√≥n y coloca un puente en el lugar de la resistencia (R1A), puede prescindir de una fuente de alimentaci√≥n adicional de 12V.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firmware</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√≥digo C para el compilador XC8. </font><font style="vertical-align: inherit;">Cosido el PICkit original 3.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title">config.h</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// PIC16F1829 Configuration Bit Settings</span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// 'C' source line config statements</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#include &lt;xc.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// #pragma config statements should precede project file includes.</span></span>
<span class="hljs-comment"><span class="hljs-comment">// Use project enums instead of #define for ON and OFF.</span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// CONFIG1</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config FOSC = INTOSC    // Oscillator Selection (INTOSC oscillator: I/O function on CLKIN pin)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config WDTE = OFF       // Watchdog Timer Enable (WDT disabled)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config PWRTE = OFF      // Power-up Timer Enable (PWRT disabled)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config MCLRE = OFF      // MCLR Pin Function Select (MCLR/VPP pin function is digital input)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CP = OFF         // Flash Program Memory Code Protection (Program memory code protection is disabled)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CPD = OFF        // Data Memory Code Protection (Data memory code protection is disabled)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config BOREN = OFF      // Brown-out Reset Enable (Brown-out Reset disabled)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CLKOUTEN = OFF   // Clock Out Enable (CLKOUT function is disabled. I/O or oscillator function on the CLKOUT pin)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config IESO = OFF       // Internal/External Switchover (Internal/External Switchover mode is disabled)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config FCMEN = OFF      // Fail-Safe Clock Monitor Enable (Fail-Safe Clock Monitor is disabled)</span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// CONFIG2</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config WRT = OFF        // Flash Memory Self-Write Protection (Write protection off)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config PLLEN = OFF      // PLL Enable (4x PLL disabled)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config STVREN = ON      // Stack Overflow/Underflow Reset Enable (Stack Overflow or Underflow will cause a Reset)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config BORV = LO        // Brown-out Reset Voltage Selection (Brown-out Reset Voltage (Vbor), low trip point selected.)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config LVP = OFF        // Low-Voltage Programming Enable (High-voltage on MCLR/VPP must be used for programming)</span></span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title">main.c</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#include "config.h"</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _XTAL_FREQ 32000000</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> intrinsic(_delay)</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _delay(unsigned <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>);
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __delay_us(x) _delay((unsigned long)((x)*(_XTAL_FREQ/4000000.0)))</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __delay_ms(x) _delay((unsigned long)((x)*(_XTAL_FREQ/4000.0)))</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TransferNotDone          !(SSP2STAT&amp;0b00000001)</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> StoreAll                 LATA4</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ResetAll                 LATC6</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSharpCHA          RC1</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSharpCHB          RC0</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSharpBTN          RA2</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSmoothCHA         RB5</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSmoothCHB         RB4</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSmoothBTN         RC2</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSharpCHA          RC5</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSharpCHB          RC4</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSharpBTN          RC3</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSmoothCHA         RA1</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSmoothCHB         RA0</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSmoothBTN         RA3</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageRateSharp         0x0100</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageRateSmooth        0x0010</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentRateSharp         0x0040</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentRateSmooth        0x0004</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageMax               0xC000</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentMax               0x5000</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageMin               0x0000</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentMin               0x0000</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageStart             0x1E00</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentStart             CurrentMax</span></span><font></font>
<font></font>
unsigned <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> VoltageBuff;<font></font>
unsigned <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> CurrentBuff;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> interrupt </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tc_int</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {<font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {<font></font>
    SSP1BUF = VoltageBuff&gt;&gt;<span class="hljs-number"><span class="hljs-number">8</span></span>;<font></font>
    SSP2BUF = CurrentBuff&gt;&gt;<span class="hljs-number"><span class="hljs-number">8</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( TransferNotDone );<font></font>
    SSP1BUF = VoltageBuff;<font></font>
    SSP2BUF = CurrentBuff;<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( TransferNotDone );<font></font>
    StoreAll = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
    StoreAll = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {
    <span class="hljs-comment"><span class="hljs-comment">// Configure oscillator for 32MHz</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
    OSCCON     = <span class="hljs-number"><span class="hljs-number">0b11110000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B1</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Enable individual pull-ups</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
    OPTION_REG = <span class="hljs-number"><span class="hljs-number">0b01111111</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B1</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Configure analog port (1 - enable, 0 - disable)</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
    ANSELA     = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B3</span></span>
    ANSELB     = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B3</span></span>
    ANSELC     = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B3</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Reset latch</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
    LATA       = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B2</span></span>
    LATB       = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B2</span></span>
    LATC       = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B2</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Alternate pin function (set SDO2 on RA5)</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
    APFCON0    = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B2</span></span>
    APFCON1    = <span class="hljs-number"><span class="hljs-number">0b00100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B2</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Configure digital port (1 - input, 0 - output)</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
    TRISA      = <span class="hljs-number"><span class="hljs-number">0b00001111</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B1</span></span>
    TRISB      = <span class="hljs-number"><span class="hljs-number">0b00110000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B1</span></span>
    TRISC      = <span class="hljs-number"><span class="hljs-number">0b00111111</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B1</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Configure input level (1 - CMOS, 0 - TTL)</span></span>
    INLVLA     = <span class="hljs-number"><span class="hljs-number">0b11000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B7</span></span>
    INLVLB     = <span class="hljs-number"><span class="hljs-number">0b00001111</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B7</span></span>
    INLVLC     = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B7</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Configure individual pull-ups (1 - enable, 0 - disable)</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
    WPUA       = <span class="hljs-number"><span class="hljs-number">0b00111111</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span>
    WPUB       = <span class="hljs-number"><span class="hljs-number">0b11110000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span>
    WPUC       = <span class="hljs-number"><span class="hljs-number">0b11111111</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span><font></font>
<font></font>
    ResetAll = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    ResetAll = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Configure SPI in master mode</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
  <span class="hljs-comment"><span class="hljs-comment">//SSP1ADD    = 0b00000000; //B4</span></span>
    SSP1STAT   = <span class="hljs-number"><span class="hljs-number">0b01000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span>
    SSP1CON3   = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span>
    SSP1CON1   = <span class="hljs-number"><span class="hljs-number">0b00100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span>
  <span class="hljs-comment"><span class="hljs-comment">//SSP1ADD    = 0b00000000; //B4</span></span>
    SSP2STAT   = <span class="hljs-number"><span class="hljs-number">0b01000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span>
    SSP2CON3   = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span>
    SSP2CON1   = <span class="hljs-number"><span class="hljs-number">0b00100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span><font></font>
<font></font>
    VoltageBuff = VoltageStart;<font></font>
    CurrentBuff = CurrentStart;<font></font>
    __delay_ms(<span class="hljs-number"><span class="hljs-number">50</span></span>);<font></font>
    SendData();<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( <span class="hljs-number"><span class="hljs-number">1</span></span> ) {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !VoltageSharpCHA ) {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( VoltageSharpCHB ) { VoltageBuff-=VoltageRateSharp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( VoltageBuff &gt; VoltageMax ) VoltageBuff = VoltageMin; }
                              <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { VoltageBuff+=VoltageRateSharp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( VoltageBuff &gt; VoltageMax ) VoltageBuff = VoltageMax; }
            <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !VoltageSharpCHA );<font></font>
            SendData();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !VoltageSmoothCHA ) {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( VoltageSmoothCHB ) { VoltageBuff-=VoltageRateSmooth; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( VoltageBuff &gt; VoltageMax ) VoltageBuff = VoltageMin; }
                               <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { VoltageBuff+=VoltageRateSmooth; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( VoltageBuff &gt; VoltageMax ) VoltageBuff = VoltageMax; }
            <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !VoltageSmoothCHA ); <font></font>
            SendData();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !CurrentSharpCHA ) {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( CurrentSharpCHB ) { CurrentBuff-=CurrentRateSharp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( CurrentBuff &gt; CurrentMax ) CurrentBuff = CurrentMin; }
                              <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { CurrentBuff+=CurrentRateSharp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( CurrentBuff &gt; CurrentMax ) CurrentBuff = CurrentMax; }
            <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !CurrentSharpCHA );<font></font>
            SendData();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !CurrentSmoothCHA ) {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( CurrentSmoothCHB ) { CurrentBuff-=CurrentRateSmooth; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( CurrentBuff &gt; CurrentMax ) CurrentBuff = CurrentMin; }
                               <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { CurrentBuff+=CurrentRateSmooth; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( CurrentBuff &gt; CurrentMax ) CurrentBuff = CurrentMax; }
            <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !CurrentSmoothCHA );<font></font>
            SendData();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !VoltageSharpBTN  ) { VoltageBuff = VoltageMax; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !VoltageSharpBTN  ); SendData(); }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !VoltageSmoothBTN ) { VoltageBuff = VoltageMin; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !VoltageSmoothBTN ); SendData(); }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !CurrentSharpBTN  ) { CurrentBuff = CurrentMax; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !CurrentSharpBTN  ); SendData(); }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !CurrentSmoothBTN ) { CurrentBuff = CurrentMin; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !CurrentSmoothBTN ); SendData(); }<font></font>
    };<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Para los valores m√≠nimos, VoltageMin y CurrentMin se establecen en 1, porque a 0 en el b√∫fer, el ajuste deja de funcionar hasta que entiendo d√≥nde est√° el problema. Tarifas * Tarifa * seleccionado m√∫ltiple y m√°s conveniente en mi opini√≥n. Para el m√©todo SendData, no pas√© variables como par√°metros para guardar las instrucciones de la m√°quina y la memoria. El modo Firmware de bajo voltaje (LVP) debe estar apagado; de lo contrario, RA3 no funcionar√° como entrada digital. Las interrupciones no se usan, el m√©todo tc_int est√° presente en el c√≥digo para que el compilador coloque el bloque principal al comienzo de la ROM. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Para el firmware, es suficiente eliminar los puentes, conectar el PICkit 3 (u otro programador) y ejecutar el firmware. En la primera versi√≥n no hab√≠a puentes en el CLK y DAT, as√≠ que tuve que soldar los condensadores de suavizado, flashearlos y luego soldarlos. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de instalar capacidades adicionales en la l√≠nea de alimentaci√≥n, desapareci√≥ el problema de salir del contador desde la posici√≥n cero. </font><font style="vertical-align: inherit;">Tambi√©n tuve que cambiar la direcci√≥n de rotaci√≥n. </font><font style="vertical-align: inherit;">Aparentemente, el ruido del rectificador AMS1117 impidi√≥ el reconocimiento correcto del estado de los codificadores. </font><font style="vertical-align: inherit;">Adem√°s, agregu√© una configuraci√≥n de valores iniciales, ahora el voltaje predeterminado est√° configurado en 5 voltios (la corriente todav√≠a est√° al m√°ximo). </font><font style="vertical-align: inherit;">Antes del primer env√≠o de datos, se insert√≥ un retraso de 50 ms en los registros (el valor del retraso se tom√≥ con un gran margen) para esperar a que se inicialicen los m√≥dulos SPI.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caracter√≠sticas de voltaje de salida</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Despu√©s del ensamblaje final del dispositivo, se realiz√≥ una medici√≥n de voltaje entre los contactos J4.1 - J4.2 (regulaci√≥n de voltaje) y J4.1 - J4.7 (regulaci√≥n de corriente). </font><font style="vertical-align: inherit;">De acuerdo con los datos obtenidos, se trazan gr√°ficos (debajo del spoiler) de las dependencias de valor / voltaje para el DAC.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gr√°ficos</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/2d2/2ca/05e/2d22ca05eaf84ab9bebb6ae56a42c00c.png"><br>
<img src="https://habrastorage.org/files/ef9/598/de4/ef9598de451f4cec96892e3486ada893.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los valores calculados de los voltajes se obtienen mediante la f√≥rmula (U * D) / (2 ^ K), donde </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
U es el voltaje en la salida del registro, teniendo en cuenta los divisores en el circuito principal (para la corriente DAC - 4950mV, para el voltaje DAC - 3550mV); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D es el valor decimal del contador DAC; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
K - Profundidad de bits DAC (16 bits)</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© se puede mejorar?</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">agregar valores de temporizador de ahorro</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ate los valores est√°ndar a los botones del codificador, por ejemplo, para voltaje: 3.3; </font><font style="vertical-align: inherit;">5.0; </font><font style="vertical-align: inherit;">7.5; </font><font style="vertical-align: inherit;">12V</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para protegerse contra un valor desconocido en el inicio, es mejor conectar MR a 1 y tirar del OE a trav√©s de la resistencia a 1 y restablecer a 0 despu√©s de inicializar el MK.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reemplace el DAC con un PWM con una cadena de suavizado ( </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">aqu√≠ se</font></a><font style="vertical-align: inherit;"> sugiere   </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LampTester</font></font></a> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></li>
</ul></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es391617/">https://habr.com/ru/post/es391617/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es391607/index.html">La historia de Chuwi: desde reproductores de MP3 en 2004 hasta tabletas en Windows 10 en 2016</a></li>
<li><a href="../es391609/index.html">Todas las misiones de investigaci√≥n espacial en una infograf√≠a.</a></li>
<li><a href="../es391611/index.html">Parque del per√≠odo del pollo: los cient√≠ficos han cultivado una pata de dinosaurio en pollo</a></li>
<li><a href="../es391613/index.html">Las autoridades estadounidenses quieren acceder a los datos de usuario de WhatsApp. Messenger presenta encriptaci√≥n de tr√°fico de voz</a></li>
<li><a href="../es391615/index.html">Fotos y videos del eclipse solar 9 de marzo de 2016</a></li>
<li><a href="../es391619/index.html">Western Digital present√≥ un HDD de $ 46 con una capacidad de 314 GB espec√≠ficamente para el Raspberry Pi en Pi Day</a></li>
<li><a href="../es391621/index.html">Mesa redonda en HSE: tendencias de la industria del juego</a></li>
<li><a href="../es391623/index.html">Tecnolog√≠a robada: la "fortaleza voladora" de la URSS</a></li>
<li><a href="../es391625/index.html">Coche econ√≥mico Honda Civic LX con piloto autom√°tico en la carretera</a></li>
<li><a href="../es391631/index.html">M-commerce crece 300% m√°s r√°pido que E-commerce</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>