<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§® üïü üßìüèº Gera√ß√£o de Eventos, CQRS e Laravel üèôÔ∏è ü•ì ü§∞üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A tradu√ß√£o do artigo foi preparada para os alunos do curso profissional "Framework Laravel" 
 



 1. Introdu√ß√£o 
 Este artigo √© dedicado aos conceito...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gera√ß√£o de Eventos, CQRS e Laravel</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/461899/">  <i>A tradu√ß√£o do artigo foi preparada para os alunos do curso profissional <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Framework Laravel"</a></i> <i><br></i> <br><img src="https://habrastorage.org/webt/h8/4u/y5/h84uy5i5spnt3rdmpaiw2aynd0s.png"><br><br><hr><br><h2>  1. Introdu√ß√£o </h2><br>  Este artigo √© dedicado aos conceitos b√°sicos da cria√ß√£o de sistemas CQRS de eventos na linguagem PHP e na estrutura do Laravel.  Sup√µe-se que voc√™ esteja familiarizado com o esquema de desenvolvimento usando o barramento de comando e tenha uma id√©ia de eventos (em particular, a publica√ß√£o de eventos para uma matriz de ouvintes).  Para atualizar esse conhecimento, voc√™ pode usar o servi√ßo Laracasts.  Al√©m disso, sup√µe-se que voc√™ tenha um certo entendimento do princ√≠pio do CQRS.  Caso contr√°rio, recomendo ouvir duas palestras: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Workshop de Mathias Verraes sobre Gera√ß√£o de Eventos</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CQRS e Gera√ß√£o de Eventos de Greg Young</a> . <br><a name="habracut"></a><br>  N√£o use o c√≥digo fornecido aqui em seus projetos!  √â uma plataforma de aprendizado para entender as id√©ias por tr√°s do CQRS.  Esse c√≥digo n√£o pode ser considerado confi√°vel, √© mal testado e, al√©m disso, raramente programa interfaces, portanto ser√° muito mais dif√≠cil alterar partes individuais do c√≥digo.  Um exemplo muito melhor de um pacote CQRS que voc√™ pode usar √© o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Broadway, desenvolvido pelo Qandidate Lab</a> .  Este √© um c√≥digo limpo e pouco acoplado, no entanto, algumas abstra√ß√µes n√£o tornam totalmente claro se voc√™ nunca encontrou sistemas de eventos. <br><br>  E o √∫ltimo - meu c√≥digo est√° conectado aos eventos e ao barramento de comando do Laravel.  Eu queria ver como o c√≥digo ficaria no Laravel (eu costumo usar essa estrutura para projetos de pequenas ag√™ncias); no entanto, olhando para tr√°s, acho que devo criar minhas pr√≥prias implementa√ß√µes.  Espero que meu c√≥digo seja claro, mesmo para aqueles que n√£o usam frameworks. <br><br>  No github, o c√≥digo est√° localizado em <a href="">https://github.com/scazz/cqrs-tutorial.git</a> e, em nosso guia, consideraremos seus componentes para aumentar a l√≥gica. <br><br>  Criaremos um sistema de registro inicial para uma escola de surf.  Com sua ajuda, os clientes da escola podem se inscrever para as aulas.  Para o processo de grava√ß√£o, formulamos as seguintes regras: <br><br><ul><li>  Cada li√ß√£o deve ter pelo menos um cliente ... </li><li>  ... mas n√£o mais que tr√™s. </li></ul><br>  Um dos recursos mais impressionantes dos sistemas CQRS baseados em eventos √© a cria√ß√£o de modelos de leitura espec√≠ficos para cada m√©trica necess√°ria ao sistema.  Voc√™ encontrar√° exemplos de proje√ß√£o de modelos de leitura no ElasticSearch, e Greg Young implementou uma linguagem orientada a assuntos em seu armazenamento de eventos para lidar com eventos complexos.  No entanto, para simplificar, nossa proje√ß√£o de leitura ser√° um banco de dados SQL padr√£o para uso com o Eloquent.  Como resultado, teremos uma tabela para classes e outra para clientes. <br><br>  O conceito de gera√ß√£o de eventos tamb√©m permite processar eventos offline.  Mas neste artigo, aderirei ao m√°ximo aos modelos de desenvolvimento ‚Äútradicionais‚Äù (novamente por simplicidade), e nossas proje√ß√µes de leitura ser√£o atualizadas em tempo real, imediatamente ap√≥s os eventos serem armazenados na loja. <br><br><h2>  Configura√ß√£o do projeto e primeiro teste </h2><br><pre><code class="plaintext hljs">git clone https://github.com/scazz/cqrs-tutorial</code> </pre> <br>  Crie um novo projeto Laravel 5 <br><br><pre> <code class="plaintext hljs">$&gt; laravel new cqrs-tutorial</code> </pre> <br>  E, para come√ßar, precisamos de um teste.  Usaremos o teste de integra√ß√£o, que garantir√° que o registro do cliente para as aulas leve ao fato de que a li√ß√£o √© criada em nosso modelo Eloquent. <br><br>  Listando tests / CQRSTest.php: <br><br><pre> <code class="plaintext hljs">use Illuminate\Foundation\Bus\DispatchesCommands; class CQRSTest extends TestCase { use DispatchesCommands;</code> </pre><br><pre> <code class="bash hljs">/** *  ,   BookLesson       * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> void */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFiringEventUpdatesReadModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span> = <span class="hljs-string"><span class="hljs-string">'123e4567-e89b-12d3-a456-426655440000'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>); <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertNotNull(Lesson::find(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>)); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals( Lesson::find(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>)-&gt;clientName, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> ); } }</code> </pre> <br>  Pr√©-atribu√≠mos a nova atividade a um ID, criamos uma equipe para se inscrever em uma nova atividade e pedimos ao Laravel para envi√°-la.  Na tabela de li√ß√µes, precisamos criar um novo registro que possamos ler usando o modelo Eloquent.  Como precisamos de um banco de dados, preencha seu arquivo .env corretamente. <br><br>  Cada evento gravado em nosso armazenamento de eventos √© anexado √† raiz do agregado, que chamaremos simplesmente de entidade (Entidade) - uma abstra√ß√£o para fins educacionais apenas adiciona confus√£o.  O ID √© um identificador exclusivo universal (UUID).  O armazenamento de eventos n√£o se importa se o evento se aplica √† li√ß√£o ou ao cliente.  Ele s√≥ sabe que est√° associado a um ID. <br><br>  Com base nos erros identificados durante o teste, podemos criar classes ausentes.  Primeiro, criaremos a classe LessonId, depois o comando BookLesson (n√£o se preocupe com o m√©todo manipulador ainda, apenas continue executando o teste).  A classe Lesson √© um modelo de leitura fora do espa√ßo de nomes da li√ß√£o.  Um modelo de leitura exclusivo - a l√≥gica da √°rea de assunto nunca ser√° armazenada aqui.  Em conclus√£o, precisaremos criar uma migra√ß√£o para a tabela de li√ß√µes. <br><br>  Para manter a clareza do c√≥digo, usarei a biblioteca de verifica√ß√£o de asser√ß√µes.  Pode ser adicionado com o seguinte comando: <br><br><pre> <code class="plaintext hljs">$&gt; composer require beberlei/assert</code> </pre> <br>  Considere o processo que deve ser iniciado por este comando: <br><br><ol><li>  Valida√ß√£o: comandos imperativos podem falhar e os eventos j√° ocorreram e, portanto, n√£o devem falhar. </li><li>  Crie um novo evento LessonWasBooked (inscrito em uma li√ß√£o). </li><li>  Atualize o status da atividade.  (O modelo de registro deve estar ciente do estado do modelo para poder executar a valida√ß√£o.) </li><li>  Inclua este evento no fluxo de eventos n√£o confirmados armazenados no modelo de registro de atividade. </li><li>  Salve o fluxo de eventos n√£o confirmados no reposit√≥rio. </li><li>  Aumente o evento LessonWasBooked globalmente para informar todos os projetores de leitura para atualizar a tabela de li√ß√µes. </li></ol><br>  Primeiro, voc√™ precisa criar um modelo de grava√ß√£o para a li√ß√£o.  Usaremos o m√©todo de f√°brica est√°tico <code>Lesson::bookClientOntoNewLesson()</code> .  Ele gera um novo evento <code>LessonWasOpened</code> (a li√ß√£o est√° aberta), aplica esse evento a si mesmo (apenas define seu ID), adiciona o novo evento √† lista de eventos n√£o confirmados na forma de <code>DomainEventMessage</code> (o evento mais alguns metadados que usamos ao salvar no armazenamento de eventos). <br><br>  O processo √© repetido para adicionar um cliente ao evento.  Ao aplicar o evento <code>ClientWasBookedOntoLesson</code> (o cliente foi inscrito na li√ß√£o), o modelo de grava√ß√£o n√£o rastreia os nomes dos clientes, mas apenas o n√∫mero de clientes registrados.  Os modelos de registro n√£o precisam saber os nomes dos clientes para garantir consist√™ncia. <br><br>  Os m√©todos <code>applyClientWasBookedOntoLesson</code> e <code>applyClientWasBookedOntoLesson</code> podem parecer um pouco estranhos <code>applyClientWasBookedOntoLesson</code> momento.  N√≥s os usaremos mais tarde quando precisarmos reproduzir eventos antigos para formar o estado do modelo de grava√ß√£o.  N√£o √© f√°cil de explicar, por isso darei um c√≥digo que ajudar√° voc√™ a entender esse processo.  Mais tarde, extrairemos o c√≥digo que processa eventos n√£o confirmados e gera mensagens de eventos do dom√≠nio. <br><br><pre> <code class="bash hljs">app/School/Lesson/Lesson.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> openLesson( LessonId <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ) { /*      ,      ,       */ <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;apply( new LessonWasOpened( <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>) ); } protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyLessonWasOpened( LessonWasOpened <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId = <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;getLessonId(); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients = 0; } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> bookClient( <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients &gt;= 3) { throw new TooManyClientsAddedToLesson(); } <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;apply( new ClientBookedOntoLesson( <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>) ); } /** *       ‚Äî *  ,       *      ,       , *      . */ protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyClientBookedOntoLesson( ClientBookedOntoLesson <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients++; }</code> </pre> <br>  Podemos extrair os componentes do CQRS do nosso modelo de grava√ß√£o - fragmentos da classe envolvidos no processamento de eventos n√£o confirmados.  Tamb√©m podemos limpar a API de uma entidade gerada por evento, criando uma fun√ß√£o <code>apply()</code> segura que aceita o evento, chama o m√©todo <code>applyEventName()</code> correspondente e adiciona um novo evento <code>DomainEventMessage</code> √† lista de eventos n√£o confirmados.  A classe extra√≠da √© um detalhe da implementa√ß√£o do CQRS e n√£o cont√©m l√≥gica de dom√≠nio; portanto, podemos criar um novo espa√ßo para nome: App \ CQRS: <br><br>  <i>Preste aten√ß√£o ao c√≥digo <code>app/CQRS/EventSourcedEntity.php</code></i> <i><br></i>  <i>Para que o c√≥digo funcione, precisamos adicionar a classe <code>DomainEventMessage</code> , que √© um DTO simples - ele pode ser encontrado em <code>app/CQRS/DomainEventMessage.php</code></i> <br><br>  Assim, obtivemos um sistema que gera eventos para cada tentativa de grava√ß√£o e usa eventos para registrar as altera√ß√µes necess√°rias para evitar invariantes.  O pr√≥ximo passo √© salvar esses eventos na loja (EventStore).  Primeiro de tudo, esse reposit√≥rio de eventos precisa ser criado.  Para simplificar, usaremos o modelo Eloquent, uma tabela SQL simples com os seguintes campos: * <code>UUID</code> (para saber a qual entidade aplicar o evento) * <code>event_payload</code> (mensagem serializada contendo tudo o necess√°rio para recriar o evento) * <code>recordedAt</code> - timestamp para saber quando o evento aconteceu.  Se voc√™ revisar cuidadosamente o c√≥digo, ver√° que eu criei dois comandos - para criar e destruir nossa tabela de armazenamento de eventos: <br><br><ul><li>  php artisan eloquenteventstore: create (App \ CQRS \ EloquentEventStore \ CreateEloquentEventStore) </li><li>  php artisan eloquenteventstore: drop (App \ CQRS \ EloquentEventStore \ DropEloquentEventStore) (n√£o esque√ßa de adicion√°-los ao App \ Console \ Kernel.php para que eles carreguem). </li></ul><br>  H√° dois motivos muito bons para n√£o usar o SQL como um armazenamento de eventos: ele n√£o implementa o modelo somente de acr√©scimo (apenas a adi√ß√£o de dados, os eventos devem ser imut√°veis) e tamb√©m porque o SQL n√£o √© uma linguagem de consulta ideal para bancos de dados temporais.  Programamos a interface para facilitar a substitui√ß√£o do armazenamento de eventos nas publica√ß√µes subsequentes. <br><br>  Para salvar eventos, use o reposit√≥rio.  Sempre que <code>save()</code> √© chamado para o modelo de grava√ß√£o, salvamos a lista de eventos n√£o confirmados no armazenamento de eventos.  Para armazenar eventos, precisamos de um mecanismo para serializa√ß√£o e desserializa√ß√£o.  Crie um serializador para isso.  Precisamos de metadados, como uma classe de evento (por exemplo, <code>App\School\Lesson\Events\LessonWasOpened</code> ) e uma carga √∫til de evento (dados necess√°rios para reconstruir um evento). <br><br>  Tudo isso ser√° codificado no formato JSON e, em seguida, gravado em nosso banco de dados junto com a entidade UUID e o registro de data e hora.  Queremos atualizar nossos modelos de leitura ap√≥s a captura de eventos, para que o reposit√≥rio acione todos os eventos ap√≥s salvar.  O serializador ser√° respons√°vel por escrever a classe do evento, enquanto o evento ser√° respons√°vel por serializar sua carga √∫til.  Um evento totalmente serializado ser√° mais ou menos assim: <br><br><pre> <code class="plaintext hljs"> { class: "App\\School\\Lesson\\Events\\", event: $event-&gt;serialize() }</code> </pre> <br>  Como todos os eventos exigem um m√©todo de serializa√ß√£o e desserializa√ß√£o, podemos criar uma interface <code>SerializableEvent</code> e adicionar uma indica√ß√£o do tipo de valor esperado.  Atualize nosso evento <code>LessonWasOpened</code> : <br><br><pre> <code class="bash hljs">app/School/Lesson/Events/LessonWasOpened.php class LessonWasOpened implements SerializableEvent { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array( <span class="hljs-string"><span class="hljs-string">'lessonId'</span></span>=&gt; (string) <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getLessonId() ); } }</code> </pre> <br>  Crie um reposit√≥rio <code>LessonRepository</code> .  Podemos refatorar e extrair os componentes principais do CQRS posteriormente. <br><br> <code>app/School/Lesson/LessonRepository.php</code> <br> <pre> <code class="plaintext hljs">eventStoreRepository = new EloquentEventStoreRepository( new EventSerializer() ); } public function save(Lesson $lesson) { /** @var DomainEventMessage $domainEventMessage */ foreach( $lesson-&gt;getUncommittedDomainEvents() as $domainEventMessage ) { $this-&gt;eventStoreRepository-&gt;append( $domainEventMessage-&gt;getId(), $domainEventMessage-&gt;getEvent(), $domainEventMessage-&gt;getRecordedAt() ); Event::fire($domainEventMessage-&gt;getEvent()); } } }</code> </pre> <br>  Se voc√™ executar o teste de integra√ß√£o novamente e depois verificar a tabela SQL <code>domain_events</code> , dever√° ver dois eventos no banco de dados. <br><br>  Nossa etapa final para passar com √™xito no teste √© ouvir os eventos de transmiss√£o e atualizar a proje√ß√£o do modelo de leitura da li√ß√£o.  Os eventos de transmiss√£o da li√ß√£o ser√£o interceptados pelo <code>LessonProjector</code> , que aplicar√° as altera√ß√µes necess√°rias no <code>LessonProjection</code> (modelos eloquentes da tabela de li√ß√µes): <br><br><pre> <code class="bash hljs"> app/School/Lesson/Projections/LessonProjector.php class LessonProjector { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyLessonWasOpened( LessonWasOpened <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span> = new LessonProjection(); <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span>-&gt;id = <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;getLessonId(); <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span>-&gt;save(); } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> subscribe(Dispatcher <span class="hljs-variable"><span class="hljs-variable">$events</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$fullClassName</span></span> = self::class; <span class="hljs-variable"><span class="hljs-variable">$events</span></span>-&gt;listen( LessonWasOpened::class, <span class="hljs-variable"><span class="hljs-variable">$fullClassName</span></span>.<span class="hljs-string"><span class="hljs-string">'@applyLessonWasOpened'</span></span>); } }  app/School/Lesson/Projections/LessonProjection.php class LessonProjection extends Model { public <span class="hljs-variable"><span class="hljs-variable">$timestamps</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; protected <span class="hljs-variable"><span class="hljs-variable">$table</span></span> = <span class="hljs-string"><span class="hljs-string">"lessons"</span></span>; }</code> </pre> <br>  Se voc√™ executar o teste, ver√° que ocorreu um erro SQL: <br><br><pre> <code class="plaintext hljs">Unknown column 'clientName' in 'field list'</code> </pre> <br>  Assim que criarmos uma migra√ß√£o para adicionar <code>clientName</code> √† tabela de li√ß√µes, passaremos no teste com √™xito.  Implementamos a funcionalidade b√°sica do CQRS: as equipes criam eventos que s√£o usados ‚Äã‚Äãpara gerar modelos de leitura. <br><br><h2>  Melhorando o modelo de leitura com links </h2><br>  Atingimos um marco significativo, mas isso n√£o √© tudo!  At√© agora, o modelo de leitura suporta apenas um cliente (n√≥s especificamos tr√™s em nossas regras de dom√≠nio).  As altera√ß√µes que fazemos no modelo de leitura s√£o bastante simples: apenas criamos um modelo de proje√ß√£o do cliente e um <code>ClientProjector</code> que captura o evento <code>ClientBookedOntoLesson</code> .  Primeiro, atualizamos nosso teste para refletir as altera√ß√µes que queremos ver em nosso modelo de leitura: <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFiringEventUpdatesReadModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals( <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;id, (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ); <span class="hljs-variable"><span class="hljs-variable">$client</span></span> = <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients()-&gt;first(); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals(<span class="hljs-variable"><span class="hljs-variable">$client</span></span>-&gt;name, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); }</code> </pre><br>  Esta √© uma demonstra√ß√£o clara de como √© f√°cil alterar os modelos de leitura.  Tudo, at√© o reposit√≥rio de eventos, permanece inalterado.  Como b√¥nus, ao usar o sistema de eventos, obtemos dados para testes b√°sicos - ao trocar o projetor do modelo de leitura, ouvimos todos os eventos que j√° aconteceram em nosso sistema. <br><br>  Reproduzimos esses eventos usando o novo projetor, verificamos exce√ß√µes e comparamos os resultados com as proje√ß√µes anteriores.  Depois que o sistema estiver funcionando h√° algum tempo, teremos uma sele√ß√£o bastante representativa de eventos para testar nossos projetores. <br><br>  Atualmente, nosso modelo de grava√ß√£o n√£o tem capacidade para carregar o estado atual.  Se quisermos adicionar um segundo cliente √† li√ß√£o, podemos simplesmente criar um segundo evento ClientWasAddedToLesson, mas n√£o podemos fornecer prote√ß√£o contra invariantes.  Para maior clareza, proponho escrever um segundo teste simulando a grava√ß√£o de dois clientes por aula. <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testLoadingWriteModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span> = <span class="hljs-string"><span class="hljs-string">"Fred"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertClientCollectionContains(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients, <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertClientCollectionContains(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients, <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span>); }</code> </pre> <br>  Para o nosso modelo de grava√ß√£o, precisamos implementar um m√©todo de "carregar" uma entidade para a qual os eventos j√° se aplicam a ela no armazenamento de eventos.  Podemos conseguir isso reproduzindo todos os eventos que se referem ao UUID da entidade.  Em termos gerais, o processo √© o seguinte: <br><br><ol><li>  Recebemos todas as mensagens de eventos relevantes do armazenamento de eventos. </li><li>  Para cada mensagem, recriamos o evento correspondente. </li><li>  Criamos um novo modelo de registro de entidade e reproduzimos cada evento. </li></ol><br>  No momento, nossos testes lan√ßam exce√ß√µes, portanto, come√ßaremos criando o <code>BookClientOntoLesson</code> necess√°rio (registrar um cliente para a li√ß√£o), usando o comando <code>BookLesson</code> como modelo.  O m√©todo manipulador ter√° a seguinte apar√™ncia: <br><br><pre> <code class="bash hljs"> app/School/Lesson/Commands/BookClientOntoLesson.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> handle(LessonRepository <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>) { /** @var Lesson <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> */ <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>-&gt;load(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;bookClient(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;clientName); <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>-&gt;save(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>); }      : app/School/Lesson/LessonRepository.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> load(LessonId <span class="hljs-variable"><span class="hljs-variable">$id</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$events</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;eventStoreRepository-&gt;load(<span class="hljs-variable"><span class="hljs-variable">$id</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = new Lesson(); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;initializeState(<span class="hljs-variable"><span class="hljs-variable">$events</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>; }</code> </pre> <br>  A fun√ß√£o de carregamento do reposit√≥rio retorna uma matriz de eventos recriados.  Para fazer isso, ela primeiro encontra mensagens sobre eventos no reposit√≥rio e depois as transmite ao <code>Serializer</code> para converter cada mensagem em um evento.  <code>Serializer</code> cria mensagens a partir de eventos, portanto, precisamos adicionar o m√©todo <code>deserialize()</code> para executar a transforma√ß√£o inversa.  Lembre-se de que o <code>Serializer</code> √© passado para cada evento para serializar os dados do evento (por exemplo, o nome do cliente).  Faremos o mesmo para executar a transforma√ß√£o inversa, enquanto nossa interface <code>SerializableEvent</code> deve ser atualizada usando o m√©todo <code>deserialize()</code> .  Vejamos o c√≥digo para que tudo se encaixe.  A primeira √© a <code>EventStoreRepository</code> carregamento <code>EventStoreRepository</code> : <br><br><pre> <code class="bash hljs">app/CQRS/EloquentEventStore/EloquentEventStoreRepository.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> load(<span class="hljs-variable"><span class="hljs-variable">$uuid</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$eventMessages</span></span> = EloquentEventStoreModel::<span class="hljs-built_in"><span class="hljs-built_in">where</span></span>(<span class="hljs-string"><span class="hljs-string">'uuid'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$uuid</span></span>)-&gt;get(); <span class="hljs-variable"><span class="hljs-variable">$events</span></span> = []; foreach(<span class="hljs-variable"><span class="hljs-variable">$eventMessages</span></span> as <span class="hljs-variable"><span class="hljs-variable">$eventMessage</span></span>) { /*       event_payload,        . */ <span class="hljs-variable"><span class="hljs-variable">$events</span></span>[] = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;eventSerializer-&gt;deserialize( json_decode(<span class="hljs-variable"><span class="hljs-variable">$eventMessage</span></span>-&gt;event_payload)); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$events</span></span>; }</code> </pre><br>  Usando a fun√ß√£o de desserializa√ß√£o apropriada no <code>eventSerializer</code> : <br><br><pre> <code class="bash hljs">app/CQRS/Serializer/EventSerializer.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> serialize( SerializableEvent <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array( <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; get_class(<span class="hljs-variable"><span class="hljs-variable">$event</span></span>), <span class="hljs-string"><span class="hljs-string">'payload'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;serialize() ); } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> deserialize( <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$eventClass</span></span> = <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span>-&gt;class; <span class="hljs-variable"><span class="hljs-variable">$eventPayload</span></span> = <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span>-&gt;payload; <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$eventClass</span></span>::deserialize(<span class="hljs-variable"><span class="hljs-variable">$eventPayload</span></span>); }</code> </pre> <br>  Em conclus√£o, usaremos o m√©todo est√°tico de f√°brica <code>deserialize()</code> em <code>LessonWasOpened</code> (precisamos adicionar esse m√©todo a cada evento) <br><br><pre> <code class="bash hljs">app/School/Lesson/Events/LessonWasOpened.php public static <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> deserialize(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>-&gt;lessonId); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> new self(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>); }</code> </pre> <br>  Agora temos uma matriz de todos os eventos que acabamos de reproduzir em rela√ß√£o ao nosso modelo de registro de entidade para inicializar o estado no m√©todo <code>initializeState</code> em <code>app/CQRS/EventSouredEntity.php</code> <br><br>  Agora execute nosso teste.  Bingo! <br>  De fato, no momento n√£o temos um teste para verificar a conformidade com nossas regras de dom√≠nio, ent√£o vamos escrever: <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMoreThan3ClientsCannotBeAddedToALesson</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"bob"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"george"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"fred"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;setExpectedException( TooManyClientsAddedToLesson::class ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"emma"</span></span>) ); }</code> </pre> <br>  Observe que precisamos apenas de <code>lessonId</code> - esse teste reinicializa o estado da li√ß√£o durante cada comando. <br><br>  No momento, simplesmente transferimos <code>UUID</code> criados manualmente, enquanto na realidade queremos ger√°-los automaticamente.  Vou usar o pacote <code>Ramsy\UUID</code> , ent√£o vamos instal√°-lo com o <code>composer</code> : <br><br><pre> <code class="plaintext hljs">$&gt; composer require ramsey/uuid</code> </pre> <br>  Agora atualize nossos testes para usar o novo pacote: <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testEntityCreationWithUUIDGenerator</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"bob"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertInstanceOf( Lesson::class, Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>) ); }</code> </pre><br>  Agora, o novo desenvolvedor de projeto pode examinar o c√≥digo, consulte <code>App\School\ReadModels</code> , que cont√©m um conjunto de modelos Eloquent, e usar esses modelos para gravar altera√ß√µes na tabela de li√ß√µes.  Podemos evitar isso criando uma classe <code>ImmutableModel</code> que estende a classe Eloquent Model e substitui o m√©todo save em <code>app/CQRS/ReadModelImmutableModel.php</code> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt461899/">https://habr.com/ru/post/pt461899/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt461885/index.html">EDS √© outro tipo de fraude</a></li>
<li><a href="../pt461887/index.html">Entrando no Aeronet Epis√≥dio 2: Homing Drone</a></li>
<li><a href="../pt461891/index.html">Como fizemos amigos na infraestrutura banc√°ria usando o ManageIQ</a></li>
<li><a href="../pt461895/index.html">Aprenda enquanto viaja - como dirigimos no 1¬∫ Dia Europeu da An√°lise de Neg√≥cios</a></li>
<li><a href="../pt461897/index.html">Como mantemos a estabilidade do aplicativo Lamoda</a></li>
<li><a href="../pt461901/index.html">Tr√™s anos de autoteste: como aumentar a velocidade e n√£o apenas</a></li>
<li><a href="../pt461903/index.html">Advers√°rio misterioso: empr√©stimos confusos</a></li>
<li><a href="../pt461905/index.html">Tic Tac Toe, parte 7: pytest e Travis CI</a></li>
<li><a href="../pt461907/index.html">An√°lise de produto em um est√∫dio de ciclo completo</a></li>
<li><a href="../pt461913/index.html">Usabilidade m√≥vel no com√©rcio eletr√¥nico: an√°lise das 20 principais lojas online da R√∫ssia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>