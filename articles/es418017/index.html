<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè≠ üçº ü§πüèª An√°lisis del comportamiento del troyano Pegasus en la red. ü§∏üèø üë≤üèø ü•ï</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El c√≥digo fuente del troyano bancario Pegasus ha sido publicado recientemente. A pesar de la menci√≥n del grupo Carbanak en el nombre del archivo, los ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√°lisis del comportamiento del troyano Pegasus en la red.</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/418017/">  El c√≥digo fuente del troyano bancario Pegasus ha sido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">publicado</a> recientemente.  A pesar de la menci√≥n del grupo Carbanak en el nombre del archivo, los investigadores de Minerva Labs <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">negaron la</a> participaci√≥n del troyano en este grupo y demostraron su participaci√≥n en el grupo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Buhtrap</a> (Ratopak).  Dentro del archivo hay una breve descripci√≥n del trabajo del troyano, sus c√≥digos fuente, una descripci√≥n del sistema de pago bancario y los datos de los empleados de muchos bancos rusos. <br><br>  La arquitectura del c√≥digo fuente de este malware es bastante interesante.  La funcionalidad se divide en m√≥dulos ensamblados en un solo "binpack" en la etapa de compilaci√≥n.  El proceso de compilaci√≥n tambi√©n incluye la firma de archivos ejecutables con un certificado del archivo tric.pfx, que no est√° en el archivo. <br><br>  No menos curiosa es la actividad de red de Pegasus, que, despu√©s de la infecci√≥n, intenta propagarse dentro del dominio y sabe c√≥mo proxy de datos entre m√°quinas que utilizan tuber√≠as y el transporte Mailslot.  Nos centramos en estudiar las caracter√≠sticas de la actividad de red del troyano y r√°pidamente agregamos los detectores de Pegasus al producto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PT Network Attack Discovery</a> .  Esto permitir√° a todos sus usuarios detectar oportunamente la actividad de este troyano y sus modificaciones en su red.  En este art√≠culo, dar√© una descripci√≥n detallada de los mecanismos de distribuci√≥n de red y la interacci√≥n entre copias de Pegasus. <br><br><img src="https://habrastorage.org/webt/yn/sn/-u/ynsn-udu1ai9y-xbrolf4fubrta.png"><a name="habracut"></a><br><br><h2>  Introducci√≥n </h2><br>  Una vez en la m√°quina, el m√≥dulo principal InstallerExe inyecta el c√≥digo en svchost.exe utilizando la t√©cnica Process Hollowing y, despu√©s de inicializar los m√≥dulos principales, Pegasus inicia varios procesos paralelos: <br><br><ol><li>  Replicaci√≥n de dominio: se dedica a la inteligencia dentro de la red e intenta extenderse a otras m√°quinas con Windows. </li><li>  El oyente Mailslot escucha los mensajes de transmisi√≥n de correo, a trav√©s de los cuales Pegasus env√≠a cuentas minadas.  El nombre del espacio se genera en tiempo de compilaci√≥n. </li><li>  Pipe Server Listener escucha Windows Pipe con el nombre generado en nombre de la m√°quina.  Estas tuber√≠as se utilizan principalmente para detectar otras copias de Pegasus en la red y su interacci√≥n. </li><li>  Las contrase√±as de inicio de sesi√≥n peri√≥dicamente cada pocos minutos intentan volcar los datos de la cuenta con un m√≥dulo de Mimikatz. </li><li>  Network Connectivity es responsable de la comunicaci√≥n con el servidor CnC y de los mensajes peri√≥dicos. </li></ol><br><pre><code class="bash hljs">// start transports <span class="hljs-built_in"><span class="hljs-built_in">which</span></span> links data with our CB-manager pwInitPipeServerAsync(dcmGetServerCallback()); mwInitMailslotServer(dcmGetServerCallback()); ... // start broadcasting creds to other machines cmStartupNetworkBroadcaster();</code> </pre> <br><h2>  Replicaci√≥n de dominio </h2><br>  Uno de los subsistemas en Pegasus es responsable del movimiento lateral en una red de Windows.  La distribuci√≥n se divide en dos pasos importantes: <br><br><ol><li>  Detecci√≥n de autos vecinos. </li><li>  Intento de replicaci√≥n a una m√°quina. </li></ol><br>  El descubrimiento de m√°quinas vecinas en un dominio se realiza a trav√©s de dos llamadas API: <br><br><img src="https://habrastorage.org/webt/-p/6f/sj/-p6fsjb6pe8v-rdjacycwncholk.png" align="left">  NetServerEnum, que requiere el servicio del navegador y llamadas a WNetOpenEnum / WNetEnumResource. <br>  Todas las m√°quinas encontradas en el dominio deben analizarse si ya est√°n infectadas.  Pegasus sondea el nombre de la tuber√≠a generada cada 200 milisegundos durante m√°s de 20 veces seguidas.  Utilizamos este comportamiento anormal como uno de los indicadores de la actividad de Pegaso en el dominio.  Al no haber detectado ning√∫n signo de infecci√≥n, el malware contin√∫a con el siguiente paso: el intento de replicaci√≥n. <br><br><img src="https://habrastorage.org/webt/j0/nw/yl/j0nwylxgv6mvqzd8krxwf2su2x8.png" align="left">  La replicaci√≥n es la siguiente.  Usando las cuentas encontradas (KM) en el host, Pegasus intenta iniciar sesi√≥n en las bolas IPC $ y ADMIN $ en la m√°quina a trav√©s de SMB, y si hay acceso a IPC $ y no hay acceso a ADMIN $, entonces Pegasus concluye que es correcto la cuenta es insuficiente y debe marcarse como no v√°lida.  Despu√©s de obtener acceso a ADMIN $ ball, que es un alias para la carpeta% windir%, el malware intenta determinar la arquitectura de la m√°quina para poder utilizar el m√≥dulo apropiado en el futuro. <br><br>  El algoritmo de determinaci√≥n de arquitectura se basa en encabezados de archivos PE en la m√°quina remota.  Como tal archivo, Pegasus intenta leer los primeros 4 kilobytes de notepad.exe de la carpeta% windir%.  Un inconveniente obvio de este m√©todo es que en Windows Server 2012, el bloc de notas se encuentra en la ruta% windir% \ System32. <br><br>  Ubicaci√≥n notepad.exe en Windows 7: <br><br><pre> <code class="bash hljs">C:\Users\Administrator&gt;<span class="hljs-built_in"><span class="hljs-built_in">where</span></span> notepad.exe C:\Windows\System32\notepad.exe C:\Windows\notepad.exe</code> </pre><br>  En Windows Server 2012: <br><br><pre> <code class="bash hljs">C:\Users\Administrator&gt;<span class="hljs-built_in"><span class="hljs-built_in">where</span></span> notepad.exe C:\Windows\System32\notepad.exe</code> </pre><br>  Si no detecta notepad.exe, Pegasus no puede infectar el servidor, incluso si tiene informaci√≥n de cuenta con los derechos necesarios.  La simple ausencia de bloc de notas en% windir% puede detener la distribuci√≥n de Pegasus en Windows Server 2012. El uso de regedit.exe a este respecto es m√°s confiable. <br><br>  Despu√©s de definir con √©xito la arquitectura del servidor de destino, Pegasus carga un peque√±o gotero RSE (Remote Service Exe) de aproximadamente 10 kilobytes de tama√±o, cuya tarea es cargar el binpack desde los m√≥dulos de Pegasus a trav√©s de la tuber√≠a en forma transparente y transferir el control al m√≥dulo Shellcode.  El nombre del cuentagotas est√° compuesto de manera pseudoaleatoria y consiste en una cadena de caracteres hexadecimales de 8 a 15 caracteres de longitud.  El generador pseudoaleatorio se inicializa seg√∫n el nombre de la m√°quina de destino y ser√° el mismo entre arranques para evitar el posible desorden de% windir% con copias anteriores del cuentagotas. <br><br><img src="https://habrastorage.org/webt/pu/qb/hf/puqbhf_9-i8k7civefzklrqegxk.png"><br><br>  El antivirus verifica la integridad y la posible eliminaci√≥n por parte del antivirus, luego de lo cual es lanzado por uno de los dos mecanismos implementados: SCM o WMI, y en primer lugar, Pegasus intenta iniciar RSE a trav√©s del mecanismo WMI, y solo luego utilizando el Administrador de control de servicios (SCM).  Esto se debe a que SCM deja m√°s rastros en los registros de Windows.  Los creadores de Pegasus tambi√©n planearon otros m√©todos de distribuci√≥n: Wsh Remote, Powershell remoting, Task Scheduler y un m√≥dulo para ejecutar comandos a trav√©s de RDP estaba en desarrollo. <br><br>  Como se mencion√≥ anteriormente, despu√©s de un lanzamiento exitoso, el cuentagotas verifica y abre la tuber√≠a para escuchar y transfiere el control a la carga √∫til entrante. <br><br><img src="https://habrastorage.org/webt/od/zt/to/odztto9o8_yrp0galq3-9_owej4.png"><br><br>  Dado que el m√©todo Process Hollowing inyecta el c√≥digo Pegasus en el proceso svchost.exe, ni el m√≥dulo InstallerExe original debe permanecer en el disco en caso de una infecci√≥n primaria, ni el cuentagotas RSE en caso de distribuci√≥n.  Si el gotero a√∫n es accesible por una ruta conocida, Pegasus lo elimina a su manera: <br><br><ol><li>  sobrescribir el contenido del archivo con datos aleatorios; </li><li>  sobrescribir con datos vac√≠os (ceros); </li><li>  renombrar archivo; </li><li>  eliminaci√≥n de archivos </li></ol><br><img src="https://habrastorage.org/webt/up/ti/uy/uptiuydt0vx1zc9lz29l2kcdy80.png"><br><br>  Despu√©s de una infecci√≥n exitosa, el proceso de distribuci√≥n de Replicaci√≥n de dominio comienza nuevamente. <br><br><h2>  Trabajos de correo </h2><br><img src="https://habrastorage.org/webt/z1/oa/hu/z1oahuoskry5bzymotu4d6n_9kk.png" align="left">  Despu√©s de que Pegasus obtenga acceso a los datos de la cuenta, ya sea desde otra copia de Pegasus o desde el m√≥dulo mod_LogonPasswords, comenzar√° a transmitir datos de EE. UU. Por dominio.  La distribuci√≥n se lleva a cabo utilizando el mecanismo SMB basado en Mailslot, que permite la transmisi√≥n unidireccional de una peque√±a porci√≥n de datos a trav√©s de un dominio.  La distribuci√≥n se realiza de acuerdo con un nombre de ranura generado aleatoriamente y para que todas las m√°quinas infectadas en el dominio puedan enviar y recibir datos con un solo nombre, el generador pseudoaleatorio para nombres se inicializa desde la variable TARGET_BUILDCHAIN_HASH especificada en la configuraci√≥n durante la compilaci√≥n. <br><br>  Dado que el mecanismo de Mailslot impone un l√≠mite en el tama√±o m√°ximo de paquete, solo se env√≠a un KM a la vez de acuerdo con el principio del √∫ltimo tiempo de env√≠o: entre todos los KM disponibles, el dominio cuya √∫ltima fecha de env√≠o es la m√°s antigua se env√≠a por dominio. <br><br><img src="https://habrastorage.org/webt/e6/rw/wt/e6rwwt8svxdb_yzrszemgjeonlk.png" align="right">  Los datos en Mailslot no se transmiten en texto claro, sino que se envuelven en tres capas de cifrado XOR, y las claves se transmiten junto con los datos.  La primera capa de datos es el sobre NetMessageEnvelope con comprobaci√≥n de integridad de datos por el algoritmo SHA1, utilizado para todos los datos transmitidos a trav√©s de la red local.  4 bytes de datos al comienzo del paquete son la clave, que se cambia mediante desplazamientos de 5 bits a la derecha por ciclo.  Dentro del sobre hay una estructura de datos codificada XOR con campos directos de EE. UU. Y la fecha en que se agregaron.  La clave de 8 y bytes tambi√©n se encuentra al comienzo de la estructura, pero se aplica sin compensaciones.  Despu√©s de decodificar la estructura KM, solo queda deserializar los campos individuales de las estructuras ENC_BUFFER, como el nombre de la computadora, el nombre de dominio, el nombre de usuario y la contrase√±a.  Estos campos est√°n encriptados con una clave de 8 bytes con compensaciones.  El script para descifrar el paquete Mailslot y un ejemplo de dicho paquete se pueden encontrar aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">script</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PCAP</a> . <br><br>  El per√≠odo para enviar mensajes de Mailslot en la versi√≥n de lanzamiento var√≠a de 20 segundos a 11 minutos. <br><br><pre> <code class="bash hljs">// some random <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> before making next step DbgPrint(<span class="hljs-string"><span class="hljs-string">"going to sleep"</span></span>); <span class="hljs-comment"><span class="hljs-comment">#ifdef _DEBUG // debug - 2-5 s Sleep(rg.rgGetRnd(&amp;rg, 2000, 5000)); #else // release - 20 - 650 s //Sleep(rg.rgGetRnd(&amp;rg, 2000, 65000) * 10); Sleep(rg.rgGetRnd(&amp;rg, 2000, 15000)); #endif</span></span></code> </pre> <br>  Adem√°s de intercambiar cuentas, el mecanismo Mailslot se utiliza para buscar una m√°quina infectada con acceso a Internet y para anunciar el acceso a Internet.  El sobre NetMessageEnvelope almacena el tipo de mensaje que se env√≠a.  El intercambio de datos entre la m√°quina sin acceso y la m√°quina con acceso a Internet se realiza a trav√©s de las tuber√≠as. <br><br><h2>  Tuber√≠as </h2><br>  Para la comunicaci√≥n bidireccional o la transferencia de grandes cantidades de datos, las copias de Pegasus usan tuber√≠as como canal de comunicaci√≥n.  El nombre de la tuber√≠a, aunque tambi√©n es generado por un generador pseudoaleatorio, depende del nombre de la m√°quina y la construcci√≥n y, por lo tanto, permite que las partes del cliente y del servidor usen el mismo nombre. <br><br>  En la comunicaci√≥n unidireccional, por ejemplo, al transferir binpack durante la replicaci√≥n a otra m√°quina, los datos no se cifran y se transmiten de forma clara.  Binpack comienza con una estructura SHELLCODE_CONTEXT con una longitud de 561 bytes. <br><br><img src="https://habrastorage.org/webt/qf/ja/89/qfja89-eipqz2lncisi7fkcuqbe.png"><br><br>  Durante la transmisi√≥n bidireccional, por ejemplo, proxy de datos entre una copia de Pegasus sin acceso a Internet y un servidor CnC, se utiliza la misma estructura de sobre de NetMessageEnvelope con cifrado XOR como en el caso de Mailslot, porque  le permite distinguir entre diferentes tipos de mensajes en el campo id. <br><br>  Arquitect√≥nicamente, la representaci√≥n de datos se realiza a trav√©s de una solicitud para transferir una parte de los datos (PMI_SEND_QUERY), recibir el id de la solicitud en respuesta y consultar el estado de la tarea por id (PMI_CHECK_STATUS_QUERY).  Como regla general, otra estructura de envolvente se transfiere como una carga, agregando varias funcionalidades y otra capa de cifrado. <br><br>  Adem√°s, trabajar con tuber√≠as no termina en la interacci√≥n entre m√°quinas infectadas.  El m√≥dulo mod_KBRI_hd inyecta c√≥digo en los procesos cmd.exe que intercepta las llamadas MoveFileExW y analiza todos los datos que se copian, ya que esto es parte del proceso de pago.  Si el archivo copiado contiene datos que son de inter√©s para los atacantes: datos con pagos, se env√≠a una notificaci√≥n al servidor CnC.  La comunicaci√≥n entre el m√≥dulo mod_KBRI inyectado en cmd.exe y una copia de Pegasus se lleva a cabo dentro de la m√°quina infectada a trav√©s de una tuber√≠a cuyo nombre no se genera pero est√° codificado en el c√≥digo fuente: <br><br><pre> <code class="bash hljs">\.\pipe\pg0F9EC0DB75F67E1DBEFB3AFA2</code> </pre> <br><img src="https://habrastorage.org/webt/xr/eh/uj/xrehuj7ia40r-g4ka-osjtq9gjc.png" align="left">  La funcionalidad del m√≥dulo tambi√©n incluye la sustituci√≥n de cuentas de datos sobre la marcha de acuerdo con la plantilla.  Un ejemplo de patrones para buscar en la captura de pantalla. <br><br><h2>  Tr√°fico cnc </h2><br>  Una secuencia separada es responsable del intercambio directo de datos con el servidor CnC, que comprueba la cola de fragmentos de datos de procesos internos u otras copias de malware cada pocos minutos y los env√≠a al servidor. <br><br>  Durante la inicializaci√≥n del m√≥dulo mod_NetworkConnectivity, realiza una comprobaci√≥n de varias etapas de la conexi√≥n de red: <br><br>  1) Detectar la configuraci√≥n del servidor proxy e intentar conectarse a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.google.com</a> : <br><br><ul><li>  En la rama del registro \\ Software \\ Microsoft \\ Windows \\ CurrentVersion \\ Configuraci√≥n de Internet. </li><li>  V√≠a WPAD (llame a WinHttpGetProxyForUrl). </li><li>  A trav√©s de la configuraci√≥n del proxy para el usuario actual (llame a WinHttpGetIEProxyConfigForCurrentUser). </li></ul><br>  2) Verificaci√≥n de la conexi√≥n con los servidores de actualizaci√≥n de Microsoft y los datos devueltos ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">authrootseq.txt</a> , <a href="">authrootstl.cab</a> , <a href="">rootsupd.exe</a> ) <br><br>  3) Prueba de conexiones HTTPS con una de 6 direcciones: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">safebrowsing.google.com</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aus3.mozilla.org</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">addons.mozilla.org</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fhr.data.mozilla.com</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">versioncheck-bg.addons.mozilla.org</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">services.addons.mozilla.org</a> </li></ul><br>  Solo despu√©s de pasar todos los controles, Pegasus cree que tiene el acceso necesario a la red externa y puede anunciar esto a trav√©s del dominio Mailslot con un mensaje.  Adem√°s, Pegasus puede disfrazarse y comunicarse con el servidor CnC solo durante el horario comercial, de 9 a.m. a 7 p.m., hora local. <br><br>  Pegasus env√≠a fragmentos de datos envueltos en un sobre con el c√°lculo del hash de la cantidad en forma cifrada usando el cifrado DES en el modo CRYPT_MODE_CBC / PKCS5_PADDING.  La clave de cifrado depende solo de la variable durante la compilaci√≥n y, por lo tanto, podemos descifrar el tr√°fico entre el malware y el servidor conociendo solo su BUILDCHAIN_HASH.  En el c√≥digo fuente dentro del archivo, esta variable ten√≠a el valor 0x7393c9a643eb4a76.  Aqu√≠ se puede encontrar un script para descifrar Check-in en el servidor y un ejemplo de dicho paquete: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">script</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PCAP</a> . <br><br>  Transfiere dicho contenido (estructura INNER_ENVELOPE) al servidor CnC durante el Check-in, o junto con cualquier dato.  Inicialmente, hay 28 bytes de un sobre con un campo de longitud y una suma SHA1. <br><br><img src="https://habrastorage.org/webt/po/zs/7s/pozs7shklsxh653kgnbxkgnmgl0.png"><br><br>  Los mismos datos se transfieren entre m√°quinas durante la transmisi√≥n a trav√©s de tuber√≠as, pero se envuelven dentro del sobre NetMessageEnvelope que conocemos con una suma hash y un cifrado XOR. <br><br>  El operador CnC puede enviar comandos para su ejecuci√≥n a copias de Pegasus y mensajes con comandos u otros datos, por ejemplo, EID_CREDENTIALS_LIST puede contener sus propias capas de cifrado de campo, como vimos en el ejemplo de las cuentas de difusi√≥n. <br><br><h2>  Detecci√≥n </h2><br>  En primer lugar, est√°bamos interesados ‚Äã‚Äãen detectar la actividad de Pegasus en la red y, despu√©s de estudiar cuidadosamente los c√≥digos fuente y ejecutar en el entorno de prueba, descubrimos esas anomal√≠as y artefactos de red que indican claramente la presencia de este complejo malware en la red.  Pegasus realmente se puede llamar vers√°til: utiliza activamente el protocolo SMB para enviar mensajes y establecer comunicaci√≥n con otras copias, se extiende a otras m√°quinas y se comunica con el servidor CnC de su propia manera especial.  Al instalar una red punto a punto en el dominio, las copias de Pegasus allanan el camino a la red externa y se comunican con el servidor CnC mediante la transmisi√≥n de tr√°fico entre s√≠.  El uso de certificados para firmar archivos ejecutables y el acceso a los recursos de Microsoft y Mozilla durante la verificaci√≥n de la conexi√≥n dificulta la detecci√≥n de su actividad y detecci√≥n en el host. <br><br>  El proyecto de c√≥digo fuente de Pegasus est√° bastante bien estructurado y descrito, por lo que en el futuro cercano podemos esperar que otros programas maliciosos tomen prestados partes de su c√≥digo y que aparezcan modificaciones. <br><br>  Muchos de los mecanismos para ejecutar comandos de forma remota y buscar datos de la cuenta no se realizaron, los desarrolladores tambi√©n agregar√≠an la capacidad de cambiar el c√≥digo shell durante la implementaci√≥n sobre la marcha.  Y estas no son todas sus ideas. <br><br>  Hemos desarrollado varias firmas para PT NAD e IDS Suricata, que nos permiten identificar la actividad de red espec√≠fica de Pegasus en diferentes etapas, comenzando desde los primeros segundos de su actividad.  Puede encontrar firmas abiertas para IDS de Suricata en nuestro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Twitter</a> , que llegar√°n autom√°ticamente a su Suricata si utiliza el mecanismo de actualizaci√≥n de actualizaci√≥n de Suricata. <br><br>  Puede ver c√≥mo funcionan las firmas para la actividad de Pegasus en la captura de pantalla a continuaci√≥n.  Este es nuestro nuevo producto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PT Network Attack Discovery</a> que identifica incidentes y ayuda a investigarlos: <br><br> <a href=""><img src="https://habrastorage.org/webt/cc/ok/ou/ccokou2rr1ed01valiivylk6prs.png"></a> <br><br>  Adem√°s, se pueden utilizar los siguientes indicadores de compromiso (IC) para la detecci√≥n: <br><br><pre>  MAILSLOT \ 46CA075C165CBB2786 
 pipe \ pg0F9EC0DB75F67E1DBEFB3AFA2<font></font>
<font></font>
 hxxp: //denwer/pegasus/index.php
 hxxp: //mp3.ucrazy.org/music/index.php
 hxxp: //support.zakon-auto.net/tuning/index.asp
 hxxp: //video.tnt-online.info/tnt-comedy-tv/stream.php </pre><br>  <b>Publicado por</b> Cyril Shipulin de @attackdetection, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Twitter</a> |  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Telegrama</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es418017/">https://habr.com/ru/post/es418017/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es418007/index.html">Desarrollo multiplataforma con .NET, programaci√≥n reactiva, patr√≥n MVVM y generaci√≥n de c√≥digo</a></li>
<li><a href="../es418009/index.html">Node.js y representaci√≥n del servidor en Airbnb</a></li>
<li><a href="../es418011/index.html">P√°ginas individuales y SEO. Secretos de optimizaci√≥n</a></li>
<li><a href="../es418013/index.html">El Intel Core i7-8086K (parte 3)</a></li>
<li><a href="../es418015/index.html">Nuevo Vasyuki. Desarrollo innovador de Mosc√∫ hasta 2100</a></li>
<li><a href="../es418023/index.html">Los punteros en C son m√°s abstractos de lo que piensas</a></li>
<li><a href="../es418025/index.html">El libro "Learning Java EE. Programaci√≥n moderna para grandes empresas ‚Äù</a></li>
<li><a href="../es418027/index.html">Microservice Blitz</a></li>
<li><a href="../es418029/index.html">ReactOS 0.4.9: los que odian tendr√°n que buscar nuevos argumentos</a></li>
<li><a href="../es418031/index.html">Apilamiento masivo de modelos ML en producci√≥n: ¬øreal o no?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>