<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüíª üçà üè™ Auf Anfrage eingebetteter Entwickler: Erkennen von Fehlern in Amazon FreeRTOS üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø üçß üåø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Jeder, der Mikrocontroller programmiert, kennt FreeRTOS wahrscheinlich oder hat zumindest von diesem Betriebssystem geh√∂rt. Amazon-Entwickler haben be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Auf Anfrage eingebetteter Entwickler: Erkennen von Fehlern in Amazon FreeRTOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/473966/">  Jeder, der Mikrocontroller programmiert, kennt FreeRTOS wahrscheinlich oder hat zumindest von diesem Betriebssystem geh√∂rt.  Amazon-Entwickler haben beschlossen, die Funktionen dieses Betriebssystems f√ºr die Arbeit mit AWS Internet of Things-Diensten zu verbessern.  So erschien Amazon FreeRTOS.  Wir, Entwickler des statischen Code-Analysators PVS-Studio, wurden per E-Mail und in Kommentaren gebeten, diese Projekte zu √ºberpr√ºfen.  Nun, jetzt holen Sie sich, wonach Sie gefragt haben.  Lesen Sie weiter, um herauszufinden, was dabei herausgekommen ist. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cee/9b7/a98/cee9b7a984f45dc365b4baea89adb019.png"></div><br><a name="habracut"></a><br><h2>  Kurz √ºber Projekte </h2><br>  Zun√§chst erz√§hle ich Ihnen etwas √ºber den Vorl√§ufer des getesteten Projekts - FreeRTOS (der Quellcode ist hier per <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Link</a> verf√ºgbar).  Laut Wikipedia ist FreeRTOS ein Echtzeit-Multitasking-Betriebssystem f√ºr eingebettete Systeme. <br><br>  Es ist in gutem alten C geschrieben, was nicht √ºberraschend ist - dieses Betriebssystem sollte unter f√ºr Mikrocontroller typischen Bedingungen funktionieren: geringe Verarbeitungsleistung, wenig RAM und dergleichen.  Die C-Sprache erm√∂glicht es Ihnen, mit Ressourcen auf niedrigem Niveau zu arbeiten und hat eine hohe Leistung. Daher ist sie am besten geeignet, um ein solches Betriebssystem zu entwickeln. <br><br>  Nun zur√ºck zu Amazon, das immer in Bewegung ist und verschiedene vielversprechende Richtungen entwickelt.  Zum Beispiel entwickelt Amazon eine AAA-Engine von Amazon Lumberyard, die wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ebenfalls √ºberpr√ºft haben</a> . <br><br>  Eine dieser Richtungen ist das Internet der Dinge (IoT).  Um sich in diesem Bereich weiterzuentwickeln, hat Amazon beschlossen, ein eigenes Betriebssystem zu schreiben - und den FreeRTOS-Kern zugrunde gelegt. <br><br>  Das resultierende System, Amazon FreeRTOS, ist so positioniert, dass es "eine sichere Verbindung zu Amazon Web Services wie AWS IoT Core oder AWS IoT Greengrass bereitstellt".  Der Quellcode dieses Projekts <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ist</a> auf Github <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">verf√ºgbar</a> . <br><br>  In diesem Artikel erfahren Sie, ob FreeRTOS fehlerhaft ist und wie sicher das Amazon-Betriebssystem in Bezug auf die statische Code-Analyse ist. <br><br><h2>  Der Verlauf der Pr√ºfung </h2><br>  Die √úberpr√ºfung wurde mit dem Tool zur automatischen Fehlersuche durchgef√ºhrt - dem statischen Code-Analysator PVS-Studio.  Es kann Fehler in Programmen erkennen, die in C, C ++, C # und Java geschrieben wurden. <br><br>  Vor der Analyse m√ºssen wir das Projekt erstellen.  Auf diese Weise bin ich sicher, dass ich alle erforderlichen Abh√§ngigkeiten habe und das Projekt zur √úberpr√ºfung bereit ist.  Das Projekt kann auf verschiedene Arten √ºberpr√ºft werden - beispielsweise mithilfe eines Kompilierungs√ºberwachungssystems.  In diesem Fall habe ich die Analyse mit dem Plugin f√ºr Visual Studio durchgef√ºhrt. Es ist gut, dass die Repositorys beider Projekte die S√§tze von Projektdateien enthalten, die das Erstellen unter Windows vereinfachen. <br><br>  Ich musste nur Projekte erstellen, um sicherzustellen, dass ich alles f√ºr die √úberpr√ºfung bereit hatte.  Als n√§chstes f√ºhrte ich die Analyse durch und - voila!  - Ich habe einen vorgefertigten Analysatorbericht vor mir. <br><br>  In diesen Projekten enthaltene Bibliotheken von Drittanbietern k√∂nnen ebenfalls Fehler enthalten und sich nat√ºrlich auch auf das Programm auswirken.  Ich habe sie jedoch aus Gr√ºnden der Reinheit der Erz√§hlung von der Analyse ausgeschlossen. <br><br>  So werden die Projekte analysiert, Berichte empfangen, interessante Fehler hervorgehoben.  Es ist Zeit, ihre Bewertung zu erhalten! <br><br><h2>  Was FreeRTOS versteckt </h2><br>  Anfangs hatte ich erwartet, zwei separate Artikel zu schreiben: einen f√ºr jedes Betriebssystem.  Ich habe mir schon die H√§nde gerieben?  als ich mich darauf vorbereitete, einen guten Artikel √ºber FreeRTOS zu schreiben.  Als ich die Entdeckung von mindestens ein paar saftigen Fehlern (wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CWE-457</a> ) erwartete, sah ich mir die sp√§rlichen Warnungen des Analysators an und ... fand nichts.  Ich habe keinen interessanten Fehler gefunden. <br><br>  Viele der vom Analyseger√§t ausgegebenen Warnungen waren f√ºr FreeRTOS nicht relevant.  Solche Warnungen waren beispielsweise 64-Bit-Fehler wie das <i>Umwandeln</i> von <i>size_t</i> in <i>uint32_t</i> .  Dies h√§ngt mit der Tatsache zusammen, dass FreeRTOS f√ºr Ger√§te mit einer Zeigergr√∂√üe von nicht mehr als 32 Bit vorgesehen ist. <br><br>  Ich habe alle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V1027-</a> Warnungen, die auf Abg√ºsse zwischen Zeigern auf nicht verwandte Strukturen hinweisen, gr√ºndlich √ºberpr√ºft.  Wenn gegossene Strukturen die gleiche Ausrichtung haben, ist ein solches Gie√üen ein Fehler.  Und ich habe kein einziges gef√§hrliches Casting gefunden! <br><br>  Alle anderen verd√§chtigen Stellen waren entweder mit dem Codierungsstil verbunden oder mit einem Kommentar versehen, der erkl√§rte, warum dies so gemacht wurde und warum es kein Fehler war. <br><br>  Daher m√∂chte ich FreeRTOS-Entwickler ansprechen.  Leute, du bist gro√üartig!  Wir haben kaum so saubere und qualitativ hochwertige Projekte gesehen wie Ihre.  Und es war eine Freude, den sauberen, ordentlichen und gut dokumentierten Code zu lesen.  Hut ab vor euch. <br><br>  Obwohl ich an diesem Tag keine interessanten Fehler finden konnte, wusste ich, dass ich hier nicht aufh√∂ren w√ºrde.  Ich ging mit der festen Zuversicht nach Hause, dass die Amazon-Version zu 100% etwas Interessantes haben w√ºrde und dass ich morgen definitiv genug Fehler f√ºr den Artikel finden w√ºrde.  Wie Sie vielleicht erraten haben, hatte ich recht. <br><br><h2>  Was Amazon FreeRTOS verbirgt </h2><br>  Die Amazon-Version des Systems erwies sich als ... gelinde gesagt etwas schlechter.  Das Erbe von FreeRTOS blieb ebenso sauber, w√§hrend die neuen Verbesserungen viele interessante Probleme verdeckten. <br><br>  Bei einigen Fragmenten war die Programmlogik fehlerhaft, bei anderen wurden Zeiger falsch behandelt.  An einigen Stellen konnte der Code zu undefiniertem Verhalten f√ºhren, und es gab F√§lle, in denen der Programmierer einfach nicht √ºber das Muster eines von ihm gemachten Fehlers Bescheid wusste.  Ich habe sogar einige schwerwiegende potenzielle Sicherheitsl√ºcken gefunden. <br><br>  Scheint, als h√§tte ich mich mit der Einf√ºhrung versch√§rft.  Lassen Sie uns anfangen, Fehler herauszufinden! <br><br><h3>  Unterbrechung der Programmlogik </h3><br>  Beginnen wir mit Problemstellen, die offensichtlich darauf hinweisen, dass das Programm nicht so funktioniert, wie es der Programmierer erwartet hat.  Die Behandlung verd√§chtiger Arrays steht an erster Stelle: <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @brief Pool of request and associated response buffers, * handles, and configurations. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> _requestPool_t _requestPool = { <span class="hljs-number"><span class="hljs-number">0</span></span> }; .... <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _scheduleAsyncRequest(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> reqIndex, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currentRange) { .... <span class="hljs-comment"><span class="hljs-comment">/* Set the user private data to use in the asynchronous callback context. */</span></span> _requestPool.pRequestDatas[reqIndex].pConnHandle = &amp;_connHandle; _requestPool.pRequestDatas[reqIndex].pConnConfig = &amp;_connConfig; _requestPool.pRequestDatas[reqIndex].reqNum = reqIndex; _requestPool.pRequestDatas[reqIndex].currRange = currentRange; _requestPool.pRequestDatas[reqIndex].currDownloaded = <span class="hljs-number"><span class="hljs-number">0</span></span>; _requestPool.pRequestDatas[reqIndex].numReqBytes = numReqBytes; .... _requestPool.pRequestDatas-&gt;scheduled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; .... }</code> </pre> <br>  PVS-Studio hat zwei Warnungen f√ºr diesen Code ausgegeben: <br><br><ul><li>  V619 Das Array '_requestPool.pRequestDatas' wird als Zeiger auf ein einzelnes Objekt verwendet.  iot_demo_https_s3_download_async.c 973 </li><li>  V574 Der Zeiger '_requestPool.pRequestDatas' wird gleichzeitig als Array und als Zeiger auf ein einzelnes Objekt verwendet.  √úberpr√ºfen Sie die Zeilen: 931, 973. iot_demo_https_s3_download_async.c 973 </li></ul><br>  F√ºr alle F√§lle m√∂chte ich Sie daran erinnern: Der Array-Name ist der Zeiger auf das erste Element.  Das hei√üt, wenn <i>_requestPool.pRequestDatas</i> ein Array von Strukturen ist, ist <i>_requestPool.pRequestDatas [i] .scheduled</i> eine Bewertung f√ºr das <i>geplante</i> Mitglied der <i>i-</i> Array-Struktur. <i>Und</i> wenn wir <i>_requestPool.pRequestDatas-&gt; Scheduled</i> schreiben, stellt sich heraus, dass dies der <i>Fall ist</i> Auf das Mitglied der ersten Array-Struktur wird zugegriffen. <br><br>  Im obigen Auszug des Codes passiert genau das.  In der letzten Zeile wird nur der Wert des Mitglieds der ersten Array-Struktur ge√§ndert.  An sich ist ein solcher Zugriff bereits verd√§chtig, aber hier ist der Fall noch deutlicher: <i>Das</i> Array <i>_requestPool.pRequestDatas</i> wird im gesamten Funktionsk√∂rper anhand des Index bewertet.  Am Ende wurde der Indizierungsvorgang jedoch vergessen. <br><br>  So wie ich es verstehe, sollte die letzte Zeile so aussehen: <br><br><pre> <code class="cpp hljs">_requestPool.pRequestDatas[reqIndex].scheduled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre> <br>  Der n√§chste Fehler liegt in einer kleinen Funktion, also werde ich es komplett geben: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Return true if the string " pcString" is found * inside the token pxTok in JSON file pcJson. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> BaseType_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prvGGDJsoneq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pcJson, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">jsmntok_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pxTok, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pcString )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ulStringSize = ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) pxTok-&gt;end - ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) pxTok-&gt;start; BaseType_t xStatus = pdFALSE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pxTok-&gt;type == JSMN_STRING ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>( pcString ) == ulStringSize ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>( &amp;pcJson[ pxTok-&gt;start ], <span class="hljs-comment"><span class="hljs-comment">// &lt;= pcString, ulStringSize ) == 0 ) { xStatus = pdTRUE; } } } return xStatus; }</span></span></code> </pre> <br>  <b>PVS-Studio-Warnung:</b> V642 [CWE-197] Das Speichern des Funktionsergebnisses 'strncmp' in der Variablen 'short' ist unangemessen.  Die signifikanten Bits k√∂nnten verloren gehen und die Logik des Programms brechen.  aws_greengrass_discovery.c 637 <br><br>  Werfen wir einen Blick auf die Definition der Funktion strncmp: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strncmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *rhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count )</span></span></span></span>;</code> </pre> <br>  Im Beispiel wird das Ergebnis des 32-Bit-Typs <i>int</i> in eine Variable vom Typ <i>int16_t</i> konvertiert.  Bei dieser "Verengungs" -Konvertierung gehen die √§lteren Bits des zur√ºckgegebenen Werts verloren.  Wenn die Funktion <i>strncmp</i> beispielsweise <i>0x00010000</i> zur√ºckgibt, geht die Einheit w√§hrend der Konvertierung verloren und die Bedingung wird ausgef√ºhrt. <br><br>  Es ist tats√§chlich seltsam, ein solches Casting in diesem Zustand zu sehen.  Warum wird es hier jemals ben√∂tigt, wenn ein gew√∂hnliches <i>int</i> mit Null verglichen werden kann?  Auf der anderen Seite, wenn ein Programmierer wollte, dass diese Funktion manchmal <i>true zur√ºckgibt,</i> auch wenn dies nicht der <i>Fall sein</i> sollte, warum nicht solch kniffliges Verhalten mit einem Kommentar unterst√ºtzen?  Aber auf diese Weise ist es eine Art Hintert√ºr.  Wie auch immer, ich neige dazu zu denken, dass es ein Fehler ist.  Was denkst du? <br><br><h3>  Undefiniertes Verhalten und Zeiger </h3><br>  Hier kommt ein gro√ües Beispiel.  Es deckt eine m√∂gliche Nullzeiger-Dereferenzierung ab: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _networkReceiveCallback(....) { IotHttpsReturnCode_t status = IOT_HTTPS_OK; _httpsResponse_t* pCurrentHttpsResponse = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; IotLink_t* pQItem = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... <span class="hljs-comment"><span class="hljs-comment">/* Get the response from the response queue. */</span></span> IotMutex_Lock(&amp;(pHttpsConnection-&gt;connectionMutex)); pQItem = IotDeQueue_PeekHead(&amp;(pHttpsConnection-&gt;respQ)); IotMutex_Unlock(&amp;(pHttpsConnection-&gt;connectionMutex)); <span class="hljs-comment"><span class="hljs-comment">/* If the receive callback is invoked * and there is no response expected, * then this a violation of the HTTP/1.1 protocol. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pQItem == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { IotLogError(....); fatalDisconnect = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; status = IOT_HTTPS_NETWORK_ERROR; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> iotCleanup; } .... iotCleanup : <span class="hljs-comment"><span class="hljs-comment">/* Report errors back to the application. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status != IOT_HTTPS_OK) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( pCurrentHttpsResponse-&gt;isAsync &amp;&amp; pCurrentHttpsResponse-&gt;pCallbacks-&gt;errorCallback) { pCurrentHttpsResponse-&gt;pCallbacks-&gt;errorCallback(....); } pCurrentHttpsResponse-&gt;syncStatus = status; } .... }</code> </pre> <br>  <b>PVS-Studio-Warnung:</b> V522 [CWE-690] M√∂glicherweise wird ein potenzieller Nullzeiger 'pCurrentHttpsResponse' dereferenziert.  iot_https_client.c 1184 <br><br>  Der letzte <i>if-</i> Block enth√§lt problematische Dereferenzen.  Lassen Sie uns herausfinden, was hier los ist. <br><br>  Die Funktion beginnt mit den Variablen <i>pCurrentHttpsResponse</i> und <i>pQItem</i> , die durch den Wert <i>NULL</i> initialisiert wurden, und die Statusvariable wird durch den Wert <i>IOT_HTTPS_OK</i> initialisiert, was bedeutet, dass alles korrekt ist. <br><br>  <i>Weiterem pQItem</i> wird der Wert zugewiesen, der von der Funktion <i>IotDeQueue_PeekHead zur√ºckgegeben</i> wird, die den Zeiger auf den Anfang der doppelt verkn√ºpften Warteschlange zur√ºckgibt. <br><br>  Was passiert, wenn die Warteschlange leer ist?  In diesem Fall gibt die Funktion <i>IotDeQueue_PeekHead</i> <i>NULL zur√ºck:</i> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> IotLink_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IotDeQueue_PeekHead</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IotDeQueue_t* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pQueue)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IotListDouble_PeekHead(pQueue); } .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> IotLink_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IotListDouble_PeekHead</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IotListDouble_t* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pList)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/* @[declare_linear_containers_list_double_peekhead] */</span></span></span><span class="hljs-function"> </span></span>{ IotLink_t* pHead = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pList != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IotListDouble_IsEmpty(pList) == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { pHead = pList-&gt;pNext; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pHead; }</code> </pre> <br>  Ferner wird die Bedingung <i>pQItem == NULL</i> wahr und der Kontrollfluss wird von <i>goto</i> an den unteren Teil der Funktion √ºbergeben.  Zu diesem Zeitpunkt bleibt der <i>pCurrentHttpsResponse-</i> Zeiger null, w√§hrend der <i>Status</i> nicht gleich <i>IOT_HTTPS_OK ‚Äã‚Äãist</i> .  Am Ende kommen wir zum selben Zweig und ... boom!  Nun, Sie kennen die Konsequenzen einer solchen Dereferenzierung. <br><br>  Okay  Es war ein etwas kniffliges Beispiel.  Nun schlage ich vor, dass Sie sich eine sehr einfache und verst√§ndliche m√∂gliche Dereferenzierung ansehen: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PKI_mbedTLSSignatureToPkcs11Signature</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pxSignaturePKCS, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pxMbedSignature )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xReturn = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> * pxNextLength; <span class="hljs-comment"><span class="hljs-comment">/* The 4th byte contains the length of the R component */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> ucSigComponentLength = pxMbedSignature[ <span class="hljs-number"><span class="hljs-number">3</span></span> ]; <span class="hljs-comment"><span class="hljs-comment">// &lt;= if( ( pxSignaturePKCS == NULL ) || ( pxMbedSignature == NULL ) ) { xReturn = FAILURE; } .... }</span></span></code> </pre> <br>  <b>PVS-Studio-Warnung:</b> V595 [CWE-476] Der Zeiger 'pxMbedSignature' wurde verwendet, bevor er gegen nullptr verifiziert wurde.  √úberpr√ºfen Sie die Zeilen: 52, 54. iot_pki_utils.c 52 <br><br>  Diese Funktion empf√§ngt Zeiger auf <i>uint8_t</i> .  Beide Zeiger werden auf <i>NULL</i> √ºberpr√ºft, was eine gute Vorgehensweise ist. Solche Situationen sollten sofort gekl√§rt werden. <br><br>  Aber hier ist das Problem: <i>Wenn pxMbedSignature</i> √ºberpr√ºft wird, wird es bereits eine Zeile dar√ºber buchst√§blich dereferenziert.  Ta-daa! <br><br>  Ein weiteres Beispiel f√ºr spekulativen Code: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">CK_RV </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vAppendSHA256AlgorithmIdentifierSequence</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * x32ByteHashedMessage, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * x51ByteHashOidBuffer )</span></span></span><span class="hljs-function"> </span></span>{ CK_RV xResult = CKR_OK; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> xOidSequence[] = pkcs11STUFF_APPENDED_TO_RSA_SIG; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( x32ByteHashedMessage == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) || ( x51ByteHashOidBuffer == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) ) { xResult = CKR_ARGUMENTS_BAD; } <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>( x51ByteHashOidBuffer, xOidSequence, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( xOidSequence ) ); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>( &amp;x51ByteHashOidBuffer[ <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( xOidSequence ) ], x32ByteHashedMessage, <span class="hljs-number"><span class="hljs-number">32</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> xResult; }</code> </pre> <br>  <b>PVS-Studio-Warnungen:</b> <br><br><ul><li>  V1004 [CWE-628] Der Zeiger 'x51ByteHashOidBuffer' wurde unsicher verwendet, nachdem er gegen nullptr √ºberpr√ºft wurde.  √úberpr√ºfen Sie die Zeilen: 275, 280. iot_pkcs11.c 280 </li><li>  V1004 [CWE-628] Der Zeiger 'x32ByteHashedMessage' wurde unsicher verwendet, nachdem er gegen nullptr √ºberpr√ºft wurde.  √úberpr√ºfen Sie die Zeilen: 275, 281. iot_pkcs11.c 281 </li></ul><br>  Der Analysator warnt davor, dass Funktionsparameter, die Zeiger sind, nach ihrer Pr√ºfung auf <i>NULL nicht</i> sicher verwendet werden.  In der Tat werden die Argumente √ºberpr√ºft.  Falls jedoch einer von ihnen nicht <i>NULL ist</i> , werden keine Ma√ünahmen ergriffen, au√üer in <i>xResult</i> zu schreiben <i>.</i>  In diesem Abschnitt des Codes hei√üt es: "Ja, die Argumente haben sich als schlecht herausgestellt.  Wir werden es jetzt bemerken, und Sie - machen Sie weiter, machen Sie weiter. ‚Äú <br><br>  Ergebnis: <i>NULL</i> wird an <i>memcpy √ºbergeben.</i>  Was kann daraus werden?  Wo und welche werden die Werte kopiert?  In der Tat hilft das Erraten nicht, da der Standard <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eindeutig besagt,</a> dass ein solcher Aufruf zu undefiniertem Verhalten f√ºhrt (siehe Abschnitt 1). <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cf7/7d6/856/cf77d6856666f6a1529a1744832bd5bf.png" alt="Abbildung 3"></div><br><br>  Es gibt andere Beispiele f√ºr die falsche Behandlung von Zeigern im Analysebericht in Amazon FreeRTOS, aber ich denke, dass gegebene Beispiele ausreichen, um die F√§higkeiten von PVS-Studio bei der Erkennung solcher Fehler zu demonstrieren.  Schauen wir uns etwas Neues an. <br><br><h3>  WAHR! = 1 </h3><br>  Es gab mehrere Fehler im Zusammenhang mit dem Muster, die leider oft √ºbersehen werden. <br><br>  Tatsache ist, dass sich der <i>Bool-</i> Typ (aus C ++) vom <i>BOOL-</i> Typ (√ºblicherweise in C verwendet) unterscheidet.  Der erste kann nur einen <i>wahren</i> oder <i>falschen</i> Wert enthalten.  Der zweite ist der Typedef eines Integer-Typs ( <i>int</i> , <i>long</i> und andere).  Der <i>0-</i> Wert ist daf√ºr "falsch", und jeder andere von Null abweichende Wert ist "wahr". <br><br>  Da es in C keinen integrierten Booleschen Typ gibt, werden diese Konstanten der Einfachheit halber definiert: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FALSE 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TRUE 1</span></span></code> </pre> <br>  Schauen wir uns das Beispiel an. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mbedtls_hardware_poll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* output, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* olen)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lStatus = MBEDTLS_ERR_ENTROPY_SOURCE_FAILED; HCRYPTPROV hProv = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Unferenced parameter. */</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)data; <span class="hljs-comment"><span class="hljs-comment">/* * This is port-specific for the Windows simulator, * so just use Crypto API. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == CryptAcquireContextA( &amp;hProv, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PROV_RSA_FULL, CRYPT_VERIFYCONTEXT)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == CryptGenRandom(hProv, len, output)) { lStatus = <span class="hljs-number"><span class="hljs-number">0</span></span>; *olen = len; } CryptReleaseContext(hProv, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lStatus; }</code> </pre> <br>  <b>PVS-Studio-Warnungen:</b> <br><br><ul><li>  V676 [CWE-253] Es ist falsch, die Variable vom Typ BOOL mit TRUE zu vergleichen.  aws_entropy_hardware_poll.c 48 </li><li>  V676 [CWE-253] Es ist falsch, die Variable vom Typ BOOL mit TRUE zu vergleichen.  Der richtige Ausdruck lautet: 'FALSE! = CryptGenRandom (hProv, len, output)'.  aws_entropy_hardware_poll.c 51 </li></ul><br>  Haben Sie einen Fehler gefunden?  Zweifeln Sie nicht, es ist hier :) Die Funktionen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><i>CryptAcquireContextA</i></a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><i>CryptGenRandom</i></a> sind Standardfunktionen aus dem Header <i>wincrypt.h</i> .  Bei Erfolg geben sie den Wert ungleich Null zur√ºck.  Lassen Sie mich betonen, dass es <i>nicht Null ist</i> .  Theoretisch k√∂nnte es sich also um einen anderen Wert als Null handeln: <i>1</i> , <i>314</i> , <i>42</i> , <i>420</i> . <br><br>  Anscheinend hat der Programmierer, der die Funktion aus dem Beispiel geschrieben hat, nicht dar√ºber nachgedacht, und am Ende werden die resultierenden Werte mit einem verglichen. <br><br>  Wie wahrscheinlich ist es, dass die <i>TRUE == CryptGenRandom (....)</i> Bedingung nicht erf√ºllt wird?  Es ist schwer zu sagen.  Vielleicht gibt <i>CryptGenRandom</i> 1 h√§ufiger zur√ºck als andere Werte, aber vielleicht gibt es nur 1 zur√ºck. Wir k√∂nnen dies nicht sicher wissen: Die Implementierung dieser kryptografischen Funktion ist vor den Augen sterblicher Programmierer verborgen :) <br><br>  Es ist wichtig zu bedenken, dass solche Vergleiche potenziell gef√§hrlich sind.  Anstelle von: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == GetBOOL())</code> </pre> <br>  Verwenden Sie eine sicherere Version des Codes: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FALSE != GetBOOL())</code> </pre> <br><h3>  Optimierungsprobleme </h3><br>  Mehrere Warnungen des Analysators bezogen sich auf langsam arbeitende Strukturen.  Zum Beispiel: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _IotHttpsDemo_GetS3ObjectFileSize(....) { .... pFileSizeStr = <span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(contentRangeValStr, <span class="hljs-string"><span class="hljs-string">"/"</span></span>); .... }</code> </pre> <br>  <b>PVS-Studio-Warnung:</b> V817 Es ist effizienter, nach '/' als nach einer Zeichenfolge zu suchen.  iot_demo_https_common.c 205 <br><br>  Es ist kurz und einfach, nicht wahr?  Die Funktion <i>strstr</i> wird hier verwendet, um nur ein Zeichen zu suchen, das im Parameter als Zeichenfolge √ºbergeben wird (in doppelten Anf√ºhrungszeichen). <br><br>  Dieser Ort kann m√∂glicherweise optimiert werden, indem <i>strstr</i> durch <i>strchr ersetzt wird</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _IotHttpsDemo_GetS3ObjectFileSize(....) { .... pFileSizeStr = <span class="hljs-built_in"><span class="hljs-built_in">strchr</span></span>(contentRangeValStr, <span class="hljs-string"><span class="hljs-string">'/'</span></span>); .... }</code> </pre> <br>  Auf diese Weise funktioniert die Suche etwas schneller.  Eine kleine, aber feine Sache. <br><br>  Nun, solche Optimierungen sind gut, aber der Analysator hat auch einen anderen Ort gefunden, der viel deutlicher optimiert werden k√∂nnte: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vRunOTAUpdateDemo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; ; ) { .... xConnectInfo.cleanSession = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; xConnectInfo.clientIdentifierLength = (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span>)<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(clientcredentialIOT_THING_NAME); xConnectInfo.pClientIdentifier = clientcredentialIOT_THING_NAME; .... } }</code> </pre> <br>  <b>PVS-Studio-Warnung:</b> V814 Leistungsminderung.  Die 'strlen'-Funktion wurde innerhalb des K√∂rpers einer Schleife mehrmals aufgerufen.  aws_iot_ota_update_demo.c 235 <br><br>  Hmm ... Innerhalb der Schleife wird bei jeder Iteration <i>strlen</i> aufgerufen, das jedes Mal die L√§nge derselben Zeile auswertet.  Nicht die effektivste Operation :) <br><br>  Schauen wir uns die Definition von <i>clientcredentialIOT_THING_NAME an</i> : <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * @brief Host name. * * @todo Set this to the unique name of your IoT Thing. */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> clientcredentialIOT_THING_NAME </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span></span></code> </pre> <br>  Der Benutzer wird aufgefordert, hier den Namen seines Ger√§ts einzugeben.  Standardm√§√üig ist es leer und in diesem Fall ist alles in Ordnung.  Was ist, wenn ein Benutzer dort einen langen und sch√∂nen Namen eingeben m√∂chte?  Zum Beispiel w√ºrde ich meine Idee gerne " <i>Die leidenschaftliche und hoch entwickelte Kaffeemaschine BarBarista-N061E The Ultimate Edition</i> " nennen.  K√∂nnen Sie sich vorstellen, wie meine √úberraschung w√§re, wenn meine sch√∂ne Kaffeemaschine danach etwas langsamer arbeiten w√ºrde?  √Ñrgernis! <br><br>  Um den Fehler zu korrigieren, lohnt es sich, <i>strlen</i> au√üerhalb der K√∂rperschleife zu nehmen.  Schlie√ülich √§ndert sich der Name des Ger√§ts w√§hrend der Programmarbeit nicht.  Oh, <i>constexpr</i> aus C ++ w√ºrde hier perfekt passen ... <br><br>  Okay, lass uns die Lilie nicht vergolden.  Wie mein Kollege Andrey Karpov feststellte, wissen moderne Compiler, was <i>strlen ist,</i> und er beobachtete sie pers√∂nlich mit einer Konstante im Bin√§rcode, wenn sie feststellen, dass sich die L√§nge der Zeile nicht √§ndern kann.  Es besteht also eine gute Chance, dass im Release-Erstellungsmodus anstelle einer tats√§chlichen Zeilenl√§ngenbewertung der vorab bewertete Wert verwendet wird.  Dies funktioniert jedoch nicht immer, so dass das Schreiben eines solchen Codes keine gute Praxis ist. <br><br><h2>  Ein paar Worte zu MISRA </h2><br>  Der PVS-Studio-Analysator verf√ºgt √ºber zahlreiche Regeln, mit denen Sie Ihren Code auf √úbereinstimmung mit den Standards MISRA C und MISRA C √ºberpr√ºfen k√∂nnen.  Was sind diese Standards? <br><br>  MISRA ist der Codierungsstandard f√ºr verantwortungsbewusste eingebettete Systeme.  Es enth√§lt eine Reihe strenger Regeln und Richtlinien zum Schreiben von Code und zum Einrichten eines Entwicklungsprozesses.  Diese Regeln sind ziemlich umfangreich und zielen nicht nur darauf ab, schwerwiegende Fehler zu beseitigen, sondern auch auf verschiedene "Code-Ger√ºche".  Es zielt auch darauf ab, den verst√§ndlichsten und lesbarsten Code zu schreiben. <br><br>  Das Befolgen des MISRA-Standards hilft somit nicht nur, Fehler und Schwachstellen zu vermeiden, sondern auch die Wahrscheinlichkeit ihres Auftretens in bereits vorhandenem Code erheblich zu verringern. <br><br>  MISRA wird in der Luft- und Raumfahrt, in der Medizin, in der Automobilindustrie und im Milit√§r eingesetzt, wo das Leben von Menschen von der Qualit√§t eingebetteter Software abh√§ngt. <br><br>  Anscheinend kennen Amazon FreeRTOS-Entwickler diesen Standard und befolgen ihn gr√∂√ütenteils.  Ein solcher Ansatz ist absolut vern√ºnftig: Wenn Sie ein breit angelegtes Betriebssystem f√ºr eingebettete Systeme schreiben, m√ºssen Sie √ºber Sicherheit nachdenken. <br><br>  Ich habe jedoch ziemlich viele Verst√∂√üe gegen den MISRA-Standard festgestellt.  Ich werde keine Beispiele f√ºr Regeln wie "Union nicht verwenden" oder "Funktion sollte nur eine R√ºckkehr am Ende des K√∂rpers haben" nennen - leider sind sie nicht spektakul√§r, wie die meisten MISRA-Regeln.  Ich m√∂chte Ihnen lieber Beispiele f√ºr Verst√∂√üe nennen, die m√∂glicherweise schwerwiegende Folgen haben k√∂nnen. <br><br>  Beginnen wir mit Makros: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FreeRTOS_ms_to_tick(ms) ( ( ms * configTICK_RATE_HZ + 500 ) / 1000 )</span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SOCKETS_htonl( ulIn ) ( ( uint32_t ) \ ( ( ( ulIn &amp; 0xFF ) </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; 24 ) | ( ( ulIn &amp; 0xFF00 ) &lt;&lt; 8 ) \ | ( ( ulIn &amp; 0xFF0000 ) &gt;&gt; 8 ) | ( ( ulIn &amp; 0xFF000000 ) &gt;&gt; 24 ) ) )</span></span></span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LEFT_ROTATE( x, c ) ( ( x </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; c ) | ( x &gt;&gt; ( 32 - c ) ) )</span></span></span></span></code> </pre> <br>  <b>PVS-Studio-Warnungen:</b> <br><br><ul><li>  V2546 [MISRA C 20.7] Das Makro und seine Parameter sollten in Klammern stehen.  √úberpr√ºfen Sie den Parameter 'ms' des Makros 'FreeRTOS_ms_to_tick'.  FreeRTOS_IP.h 201 </li><li>  V2546 [MISRA C 20.7] Das Makro und seine Parameter sollten in Klammern stehen.  √úberpr√ºfen Sie den Parameter 'ulIn' des Makros 'SOCKETS_htonl'.  iot_secure_sockets.h 512 </li><li>  V2546 [MISRA C 20.7] Das Makro und seine Parameter sollten in Klammern stehen.  √úberpr√ºfen Sie die Parameter 'x', 'c' des Makros 'LEFT_ROTATE'.  iot_device_metrics.c 90 </li></ul><br>  Ja, genau das denkst du.  Die Parameter dieser Makros sind nicht in Klammern angegeben.  Wenn jemand versehentlich so etwas schreibt <br><br><pre> <code class="cpp hljs">val = LEFT_ROTATE(A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span>, B);</code> </pre> <br>  Ein solcher "Aufruf" eines Makros wird erweitert in: <br><br><pre> <code class="cpp hljs">val = ( ( A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; B ) | ( A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt; ( <span class="hljs-number"><span class="hljs-number">32</span></span> - B ) ) );</code> </pre> <br>  Erinnern Sie sich an die Priorit√§ten der Operationen?  Zuerst wird eine bitweise Verschiebung vorgenommen, und erst danach - ein bitweises "oder".  Daher wird die Logik des Programms unterbrochen.  Ein einfacheres Beispiel: Was w√ºrde passieren, wenn der Ausdruck " <i>x + y</i> " im Makro <i>FreeRTOS_ms_to_tick √ºbergeben wird</i> ?  Eines der Hauptziele von MISRA ist es, solche Situationen zu verhindern. <br><br>  Einige k√∂nnten argumentieren: "Wenn Sie Programmierer haben, die nichts davon wissen, kann Ihnen kein Standard helfen!"  Dem werde ich nicht zustimmen.  Programmierer sind auch Menschen, und egal wie erfahren eine Person ist, sie k√∂nnen auch m√ºde werden und am Ende des Tages einen Fehler machen.  Dies ist einer der Gr√ºnde, warum MISRA dringend empfiehlt, automatische Analysetools zu verwenden, um ein Projekt auf Konformit√§t zu testen. <br><br>  Lassen Sie mich die Entwickler von Amazon FreeRTOS ansprechen: PVS-Studio hat 12 weitere unsichere Makros gefunden, daher m√ºssen Sie vorsichtig mit ihnen sein :) <br><br>  Ein weiterer interessanter MISRA-Versto√ü: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @brief Callback for an asynchronous request to notify * that the response is complete. * * @param[in] 0pPrivData - User private data configured * with the HTTPS Client library request configuration. * @param[in] respHandle - Identifier for the current response finished. * @param[in] rc - Return code from the HTTPS Client Library * signaling a possible error. * @param[in] status - The HTTP response status. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _responseCompleteCallback(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* pPrivData, IotHttpsResponseHandle_t respHandle, IotHttpsReturnCode_t rc, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> status) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>* pUploadSuccess = (<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>*)pPrivData; <span class="hljs-comment"><span class="hljs-comment">/* When the remote server response with 200 OK, the file was successfully uploaded. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status == IOT_HTTPS_STATUS_OK) { *pUploadSuccess = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { *pUploadSuccess = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* Post to the semaphore that the upload is finished. */</span></span> IotSemaphore_Post(&amp;(_uploadFinishedSem)); }</code> </pre> <br>  Kannst du den Fehler selbst finden? <br><br>  <b>PVS-Studio-Warnung:</b> V2537 [MISRA C 2.7] Funktionen sollten keine nicht verwendeten Parameter haben.  √úberpr√ºfen Sie den Parameter: 'rc'.  iot_demo_https_s3_upload_async.c 234 <br><br>  Schauen Sie genauer hin: Der Parameter <i>rc</i> wird nirgendwo im Funktionsk√∂rper verwendet.  W√§hrend der Kommentar der Funktion eindeutig besagt, dass dieser Parameter ein R√ºckkehrcode einer anderen Funktion ist und einen Fehler signalisieren kann.  Warum wird dieser Parameter in keiner Weise behandelt?  Hier stimmt eindeutig etwas nicht. <br><br>  Selbst ohne solche Kommentare weisen nicht verwendete Parameter h√§ufig auf die fehlerhafte Logik des Programms hin.  Warum brauchen Sie sie sonst in der Funktionssignatur? <br><br>  Hier habe ich eine kleine Funktion angegeben, die f√ºr ein Beispiel im Artikel gut ist.  Au√üerdem habe ich 10 weitere nicht verwendete Parameter gefunden.  Viele von ihnen werden in gr√∂√üeren Funktionen verwendet, und es ist nicht einfach, sie zu erkennen. <br><br>  Verd√§chtigerweise wurden sie noch nie gefunden.  Schlie√ülich k√∂nnen Compiler solche F√§lle leicht erkennen. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b80/6c7/bb9/b806c7bb94c335ce2712e9b46cffc560.png" alt="Abbildung 1"></div><br><br><h2>  Fazit </h2><br>  Dies waren nicht alle vom Analyseger√§t gefundenen Probleme, aber der Artikel erwies sich bereits als ziemlich gro√ü.  Ich hoffe, dass die Entwickler von amazon FreeRTOS dank dieser Funktion einige M√§ngel beheben k√∂nnen und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PVS-Studio</a> m√∂glicherweise sogar selbst <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ausprobieren</a> m√∂chten.  Auf diese Weise ist es bequemer, Warnungen gr√ºndlich zu untersuchen.  Tats√§chlich ist das Arbeiten mit einer praktischen Benutzeroberfl√§che viel einfacher als das Betrachten eines Textberichts. <br><br>  Vielen Dank f√ºr das Lesen unserer Artikel!  Wir sehen uns in der n√§chsten Ver√∂ffentlichung: D. <br><br>  PS Es ist einfach so passiert, dass dieser Artikel am 31. Oktober ver√∂ffentlicht wurde. Fr√∂hliches Halloween, Jungs und M√§dels! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de473966/">https://habr.com/ru/post/de473966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de473952/index.html">Als ich AI f√ºr rundenbasierte Strategie schrieb</a></li>
<li><a href="../de473956/index.html">Geheime Informationen einer Telefongesellschaft eines Drogendealers</a></li>
<li><a href="../de473958/index.html">Japaner von NICT f√ºhrten einen funktionierenden Glasfasercluster mit einer Bandbreite von 1 Pbit / s ein</a></li>
<li><a href="../de473960/index.html">Strategien zur Inhaltslokalisierung</a></li>
<li><a href="../de473962/index.html">Der dunkle Modus ist jetzt √ºberall. Ist es so n√ºtzlich? (am Ende der Nachbefragung)</a></li>
<li><a href="../de473972/index.html">Im Auftrag von Embedded-Entwicklern: Suche nach Fehlern in Amazon FreeRTOS</a></li>
<li><a href="../de473974/index.html">Intercom'19 - Eine Konferenz √ºber Kommunikationsautomatisierung von Voximplant findet am 14. November statt</a></li>
<li><a href="../de473976/index.html">AWS Elasticsearch: Grundlegend fehlerhaftes Produkt</a></li>
<li><a href="../de473978/index.html">Solche Schmerzen, solche Schmerzen, Registrierkasse als Dienstleistung 2: 0</a></li>
<li><a href="../de473980/index.html">Technologie und die reale Welt: 4 Start-ups, die die Zukunft der Innenarchitektur ver√§ndern</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>