<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤸🏿 🤨 💶 Cómo usar módulos PAM para autenticación local en Linux usando claves GOST-2012 en Rutoken 🖐🏾 🧗🏿 📮</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Las contraseñas simples no protegen, y las contraseñas complejas no se pueden recordar. Por lo tanto, a menudo se encuentran en una etiqueta debajo de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cómo usar módulos PAM para autenticación local en Linux usando claves GOST-2012 en Rutoken</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/aktiv-company/blog/461199/"><img src="https://habrastorage.org/webt/em/xk/dv/emxkdvyl4drekv2we2jbgk0e7no.jpeg"><br><br>  Las contraseñas simples no protegen, y las contraseñas complejas no se pueden recordar.  Por lo tanto, a menudo se encuentran en una etiqueta debajo del teclado o en el monitor.  Para que las contraseñas permanezcan en la cabeza de los usuarios "olvidadizos" y no se pierda la confiabilidad de la protección, existe la autenticación de dos factores (2FA). <a name="habracut"></a><br><br>  Debido a la combinación de factores de propiedad del dispositivo y el conocimiento de su código PIN, el código PIN en sí mismo puede ser más simple y fácil de recordar.  Las deficiencias en la longitud o aleatoriedad del PIN se compensan con el requisito de propiedad física y las restricciones en la búsqueda del PIN. <br><br>  Además, en las instituciones estatales sucede que quieren que todo funcione de acuerdo con GOST.  Acerca de esta opción 2FA para ingresar a Linux y se discutirá.  Comenzaré desde lejos. <br><br><h1>  Módulos PAM </h1><br>  Los módulos de autenticación enchufables (PAM) son módulos con una API estándar e implementaciones de varios mecanismos de autenticación en las aplicaciones. <br>  Todas las utilidades y aplicaciones que pueden trabajar con PAM los recogen y pueden usar para autenticar al usuario. <br>  En la práctica, esto funciona de la siguiente manera: el comando de inicio de sesión se convierte en PAM, que realiza todas las comprobaciones necesarias utilizando los módulos especificados en el archivo de configuración y devuelve el resultado al comando de inicio de sesión. <br><br>
<h2>  librtpam </h2><br>  El módulo desarrollado por la compañía Active agrega autenticación de dos factores de usuarios que usan tarjetas inteligentes o tokens USB que usan claves asimétricas de acuerdo con los últimos estándares de criptografía doméstica. <br><br>  Considere el principio de su trabajo: <br><ul><li>  el token almacena el certificado del usuario y su clave privada; </li><li>  El certificado se guarda en el directorio de inicio del usuario como confiable. </li></ul><br><br>  El proceso de autenticación es el siguiente: <br><ol><li>  Rutoken busca el certificado personal del usuario. </li><li>  Se solicita un PIN de token. </li><li>  Los datos aleatorios se firman en una clave privada directamente en el chip Rutoken. </li><li>  La firma recibida se verifica utilizando la clave pública del certificado de usuario. </li><li>  El módulo devuelve el resultado de la verificación de firma a la aplicación que realiza la llamada. </li></ol><br><br>  Puede autenticarse utilizando las claves GOST R 34.10-2012 (longitud 256 o 512 bits) o GOST R 34.10-2001 obsoleto. <br><br>  No hay necesidad de preocuparse por la seguridad de las claves: se generan directamente en Rutoken y nunca dejan su memoria durante las operaciones criptográficas. <br><br><img src="https://habrastorage.org/webt/t7/zy/aj/t7zyajv_ajx2gbcbk9arxuwocke.jpeg"><br><br>  Rutoken EDS 2.0 está certificado por FSB y FSTEC para NDV 4, por lo tanto, se puede utilizar en sistemas de información que procesan información confidencial. <br><br><h2>  Uso práctico </h2><br>  Casi cualquier Linux moderno es adecuado, por ejemplo, usaremos xUbuntu 18.10. <br><h3>  1) Instale los paquetes necesarios </h3><br> <code>sudo apt-get install libccid pcscd opensc</code> <br>  Si desea agregar un bloqueo de escritorio con un protector de pantalla, instale adicionalmente el <code>libpam-pkcs11</code> . <br><br><h3>  2) Agregue un módulo PAM con soporte para GOST </h3><br>  Descargue la biblioteca de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://download.rutoken.ru/Rutoken/PAM/</a> <br>  Copie el contenido de la carpeta PAM librtpam.so.1.0.0 a la carpeta del sistema <br>  <code>/usr/lib/</code> o <code>/usr/lib/x86_64-linux-gnu/</code> o <code>/usr/lib64</code> <br><br><h3>  3) Instale el paquete con librtpkcs11ecp.so </h3><br>  Descargue e instale el paquete DEB o RPM desde el enlace: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://www.rutoken.ru/support/download/pkcs/</a> <br><br><h3>  4) Verificamos que Rutoken EDS 2.0 funciona en el sistema </h3><br>  En la terminal, ejecute <br> <code>$ pkcs11-tool --module /usr/lib/librtpkcs11ecp.so -T</code> <br>  Si ve la línea <code>Rutoken ECP &lt;no label&gt;</code> , entonces todo está bien. <br><br><h3>  5) Lea el certificado </h3><br>  Verifique que el dispositivo tenga un certificado <br> <code>$ pkcs11-tool --module /usr/lib/librtpkcs11ecp.so -O</code> <br>  Si después de la línea: <br> <code>Using slot 0 with a present token (0x0)</code> <br> <ul><li>  <b>Si se muestra información</b> sobre claves y certificados, debe leer el certificado y guardarlo en el disco.  Para hacer esto, ejecute el siguiente comando, donde en lugar de {id} necesita sustituir el certificado de ID que vio en la salida del comando anterior: <br> <code>$ pkcs11-tool --module /usr/lib/librtpkcs11ecp.so -r -y cert --id {id} --output-file cert.crt</code> <br>  Si se crea el archivo cert.crt, vaya al paso 6). </li><li>  <b>no hay nada</b> , entonces el dispositivo está vacío.  Póngase en contacto con su administrador o cree las claves y el certificado usted mismo siguiendo el siguiente paso. </li></ul><br><br><h4>  5.1) Crear un certificado de prueba </h4><br><blockquote>  Atencion  Los métodos descritos para crear claves y certificados son adecuados para la prueba y no están destinados para su uso en modo de combate.  Para hacer esto, debe usar claves y certificados emitidos por una autoridad de certificación de confianza de su organización o una autoridad de certificación acreditada. <br>  El módulo PAM está diseñado para proteger las computadoras locales e implica trabajar en organizaciones pequeñas.  Como hay pocos usuarios, el Administrador puede supervisar él mismo la revocación de certificados y bloquear cuentas manualmente, así como el período de validez de los certificados.  El módulo PAM aún no puede verificar los certificados por CRL y construir cadenas de confianza. </blockquote><br><br><h4>  Manera fácil (a través del navegador) </h4><br>  Para obtener un certificado de prueba, use el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">servicio web del Centro de registro de Rootoken</a> .  El proceso no tomará más de 5 minutos. <br><br><h4>  Ruta geek (a través de la consola y posiblemente compilador) </h4><br>  <b>Verifique la versión de OpenSC</b> <br> <code>$ opensc-tool --version</code> <br>  Si la versión es inferior a 0.20, actualice o recopile <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la rama pkcs11-tool con el soporte GOST 2012</a> de nuestro GitHub (en el momento de la publicación de este artículo, aún no se ha lanzado el 0.20) o de la rama maestra del proyecto principal de OpenSC a más tardar con el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">compromiso 8cf1e6f</a> <br><br>  Generamos un par de claves con parámetros: <br> <code>--key-type: GOSTR3410-2012-512: (-2012 512  c  ), GOSTR3410-2012-256:A (-2012 256    A)</code> <br> <br>  <code>--id:</code> identificador de objeto (CKA_ID) como números de caracteres de dos dígitos en hexadecimal de la tabla ASCII.  Utilice solo códigos ASCII para caracteres impresos, como  id necesitará pasar OpenSSL como una cadena.  Por ejemplo, los códigos ASCII "3132" corresponden a la cadena "12".  <b>Para mayor comodidad, puede utilizar el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">servicio en línea para convertir cadenas a códigos ASCII</a></b> . <br><br> <code>$ ./pkcs11-tool --module /usr/lib/librtpkcs11ecp.so --keypairgen --key-type GOSTR3410-2012-512:A -l --id 3132</code> <br> <br>  A continuación crearemos un certificado.  A continuación se describirán dos formas: la primera a través de la CA (utilizaremos CA de prueba), la segunda, autofirmada.  Para hacer esto, primero debe instalar y configurar OpenSSL versión 1.1 o posterior para trabajar con Rutoken a través de un módulo rtengine especial utilizando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el</a> manual de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">instalación y configuración de OpenSSL</a> . <br>  Por ejemplo: para '- <code>-id 3132</code> ' en OpenSSL, debe especificar " <code>pkcs11:id=12</code> ". <br><br>  Puede usar los servicios de una CA de prueba, de los cuales hay muchos, por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aquí</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aquí</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aquí</a> , para esto crearemos una solicitud de certificado <br><br>  Otra opción es sucumbir a la pereza y crear un autofirmado <br> <code>$ openssl req -utf8 <b>-new</b> -keyform engine -key "pkcs11:id=12" -engine rtengine -out req.csr</code> <br> <br>  Descargar el certificado al dispositivo <br> <code>$ openssl req -utf8 <b>-x509</b> -keyform engine -key "pkcs11:id=12" -engine rtengine -out cert.cer</code> <br> <br><h3>  6) Registrar el certificado en el sistema </h3><br>  Asegúrese de que su certificado se vea como un archivo base64: <br><br><img src="https://habrastorage.org/webt/ri/mh/cu/rimhcu-wkts8cx7hyqqp_qhmrco.png"><br><br>  Si su certificado se ve así: <br><br><img src="https://habrastorage.org/webt/tg/8b/so/tg8bsoyf7it4iinbhotb2ydbvka.png"><br><br>  entonces necesita convertir el certificado del formato DER al formato PEM (base64) <br><br> <code>$ openssl x509 -in cert.crt -out cert.pem -inform DER -outform PEM</code> <br>  Nuevamente comprobamos que ahora todo está en orden. <br><br>  Agregar un certificado a la lista de certificados confiables <br> <code>$ mkdir ~/.eid <br> $ chmod 0755 ~/.eid <br> $ cat cert.pem &gt;&gt; ~/.eid/authorized_certificates <br> $ chmod 0644 ~/.eid/authorized_certificates</code> <br>  La última línea protege la lista de certificados confiables de cambios accidentales o intencionales de otros usuarios.  Esto elimina la situación cuando alguien agrega su certificado aquí y puede iniciar sesión en su nombre. <br><br><h3>  7) Configurar autenticación </h3><br>  La configuración de nuestro módulo PAM es completamente estándar y se realiza igual que la configuración de otros módulos.  Creamos en el archivo <code>/usr/share/pam-configs/rutoken-gost-pam</code> contiene el nombre completo del módulo, si está habilitado de forma predeterminada, la prioridad del módulo y los parámetros de autenticación. <br>  En los parámetros de autenticación hay requisitos para el éxito de la operación: <br><ul><li>  requerido: tales módulos deben devolver una respuesta positiva.  Si el resultado de la llamada del módulo contiene una respuesta negativa, esto conducirá a un error de autenticación.  La solicitud se restablecerá, pero se llamará al resto de los módulos. </li><li>  requisito (requerido): similar al requerido, pero inmediatamente conduce a una falla de autenticación e ignora el resto de los módulos. </li><li>  suficiente: si frente a dicho módulo ninguno de los módulos necesarios o suficientes devuelve un resultado negativo, el módulo devolverá una respuesta positiva.  Los módulos restantes serán ignorados. </li><li>  opcional (opcional): si no hay módulos necesarios en la pila y ninguno de los módulos suficientes arrojó un resultado positivo, entonces al menos uno de los módulos opcionales debería devolver una respuesta positiva. </li></ul><br>  El contenido completo del archivo <code>/usr/share/pam-configs/rutoken-gost-pam</code> : <br> <code>Name: Rutoken PAM GOST <br> Default: yes <br> Priority: 800 <br> Auth-Type: Primary <br> Auth: sufficient /usr/lib/librtpam.so.1.0.0 /usr/lib/librtpkcs11ecp.so</code> <br> <br><img src="https://habrastorage.org/webt/x4/s8/lm/x4s8lmf9wad0qson9-cdveilens.png"><br><br>  guarde el archivo, luego ejecute <br> <code>$ sudo pam-auth-update</code> <br>  en la ventana que aparece, coloque un asterisco cerca de <b>Rutoken PAM GOST</b> y haga <b>clic</b> en <b>Aceptar</b> <br><br><img src="https://habrastorage.org/webt/i-/pk/u-/i-pku-qe0vc8gu0kh1kmgcyzye0.png"><br><br><h3>  8) Verifique la configuración </h3><br>  Para comprender que todo está configurado, pero no perder la capacidad de iniciar sesión, ingrese el comando <br> <code>$ sudo login</code> <br>  Ingrese su nombre de usuario.  Todo está configurado correctamente si el sistema requiere un PIN del dispositivo. <br><br><img src="https://habrastorage.org/webt/3n/mv/-q/3nmv-q20lo_mhv4c2csju_bx-qq.png"><br><br><h3>  9) Configure el bloqueo de la computadora al extraer el token </h3><br>  El <code>libpam-pkcs11</code> incluye la utilidad <code>pkcs11_eventmgr,</code> que le permite realizar diversas acciones cuando se producen eventos PKCS # 11. <br>  Para configurar <code>pkcs11_eventmgr</code> use el archivo de configuración: <code>/etc/pam_pkcs11/pkcs11_eventmgr.conf</code> <br>  <i>Para varias distribuciones de Linux, el comando que hace que la cuenta se bloquee al eliminar tarjetas inteligentes o tokens será diferente.</i>  <i>Ver <code>event card_remove</code> .</i> <br>  A continuación se presenta un ejemplo de archivo de configuración: <br><br><pre> <code class="xml hljs">pkcs11_eventmgr { #    daemon = true; #    debug = false; #     polling_time = 1; #  -    # - 0 expire_time = 0; #  pkcs11      pkcs11_module = usr/lib/librtpkcs11ecp.so; #    #  : event card_insert { #     (  ) on_error = ignore ; action = "/bin/false"; } #   event card_remove { on_error = ignore; #     #  GNOME action = "dbus-send --type=method_call --dest=org.gnome.ScreenSaver /org/gnome/ScreenSaver org.gnome.ScreenSaver.Lock"; #  XFCE # action = "xflock4"; #  Astra Linux (FLY) # action = "fly-wmfunc FLYWM_LOCK"; } #     event expire_time { #     (  ) on_error = ignore; action = "/bin/false"; } }</code> </pre> <br><br>  Después de eso, agregue la aplicación <code>pkcs11_eventmgr</code> a la carga automática.  Para hacer esto, edite el archivo .bash_profile: <br> <code>$ nano /home/&lt;_&gt;/.bash_profile</code> <br>  Agregue la línea pkcs11_eventmgr al final del archivo y reinicie. <br><br>  <b>Los pasos descritos para configurar el sistema operativo se pueden usar como instrucciones en cualquier distribución moderna de Linux, incluidas las domésticas.</b> <br><br><img src="https://habrastorage.org/webt/t0/hw/sc/t0hwsc-bgtngftj0stl9d14rdta.png"><br><br><h2>  Conclusión </h2><br>  Las PC con Linux se están volviendo cada vez más populares en las agencias gubernamentales rusas, y configurar una autenticación confiable de dos factores en este sistema operativo no siempre es fácil.  Estaremos encantados con esta guía para ayudarlo a resolver el "problema de contraseña" y proteger de manera confiable el acceso a su PC sin perder mucho tiempo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/461199/">https://habr.com/ru/post/461199/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461185/index.html">JsonDiscovery: cambiando la experiencia de ver JSON en un navegador</a></li>
<li><a href="../461191/index.html">Grabaciones del verano DIYorDIE Meetup 16 de junio</a></li>
<li><a href="../461193/index.html">Contigo PhysTech.Science: elimina la distorsión cognitiva y comprende los secretos de la mente</a></li>
<li><a href="../461195/index.html">Interfaz IR, Frambuesa y LIRC</a></li>
<li><a href="../461197/index.html">Historias sobre las duras víctimas rusas de TI y digitalización</a></li>
<li><a href="../461201/index.html">Temas y estilos en aplicaciones de Android</a></li>
<li><a href="../461205/index.html">Mejores sistemas de gestión de pruebas 2019</a></li>
<li><a href="../461207/index.html">Sysadmins, hoy es nuestro día</a></li>
<li><a href="../461209/index.html">Sprint o maratón?</a></li>
<li><a href="../461211/index.html">Donde enseñan a enseñar (no solo en el ped. Institute)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>