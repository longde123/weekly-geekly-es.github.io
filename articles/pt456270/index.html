<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚è≥ ü§ûüèø üëµ Redis Stream - Confiabilidade e escalabilidade dos seus sistemas de mensagens üè¥ ü§πüèø üì£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Redis Stream - um novo tipo de dado abstrato introduzido no Redis com o lan√ßamento da vers√£o 5.0 
 Conceitualmente, o Redis Stream √© uma lista √† qual ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Redis Stream - Confiabilidade e escalabilidade dos seus sistemas de mensagens</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/456270/"><img src="https://habrastorage.org/webt/4z/my/lg/4zmylgmptsa7q0dqxbekaq4gvai.png" alt="imagem"><br><br>  Redis Stream - um novo tipo de dado abstrato introduzido no Redis com o lan√ßamento da vers√£o 5.0 <br>  Conceitualmente, o Redis Stream √© uma lista √† qual voc√™ pode adicionar entradas.  Cada entrada possui um identificador exclusivo.  Por padr√£o, um identificador √© gerado automaticamente e inclui um carimbo de data / hora.  Portanto, voc√™ pode solicitar intervalos de grava√ß√£o por tempo ou receber novos dados conforme eles chegam no fluxo, pois o comando tail -f do Unix l√™ o arquivo de log e congela antecipando novos dados.  Observe que v√°rios clientes podem ouvir o fluxo ao mesmo tempo, pois muitos processos ‚Äútail -f‚Äù podem ler um arquivo ao mesmo tempo, sem conflitar entre si. <br><br>  Para entender todas as vantagens do novo tipo de dados, vamos relembrar brevemente as estruturas Redis existentes h√° muito tempo que repetem parcialmente a funcionalidade do Redis Stream. <br><a name="habracut"></a><br><h1>  Excurs√£o hist√≥rica </h1><br><h4>  Redis pub / sub </h4><br>  O Redis Pub / Sub √© um sistema simples de mensagens j√° incorporado ao seu armazenamento de valores-chave.  No entanto, para simplificar, voc√™ deve pagar: <br><br><ul><li>  Se, por algum motivo, o editor falhar, ele perder√° todos os seus assinantes </li><li>  O editor precisa saber o endere√ßo exato de todos os seus assinantes. </li><li>  Um editor pode sobrecarregar seus assinantes se os dados forem publicados mais rapidamente do que processados </li><li>  A mensagem √© exclu√≠da do buffer do editor imediatamente ap√≥s a publica√ß√£o, independentemente de quantos assinantes ele entregou e com que rapidez eles conseguiram processar essa mensagem. </li><li>  Todos os assinantes receber√£o a mensagem ao mesmo tempo.  Os pr√≥prios assinantes devem, de alguma forma, concordar entre si sobre como processar a mesma mensagem. </li><li>  N√£o h√° mecanismo interno para confirmar o processamento bem-sucedido de uma mensagem por um assinante.  Se o assinante recebeu uma mensagem e caiu durante o processamento, o editor n√£o a saber√°. </li></ul><br><h4>  Lista de Redis </h4><br>  Redis List √© uma estrutura de dados que suporta comandos de leitura de bloqueio.  Voc√™ pode adicionar e ler mensagens do in√≠cio ou do fim da lista.  Com base nessa estrutura, voc√™ pode criar uma boa pilha ou fila para o seu sistema distribu√≠do e isso, na maioria dos casos, ser√° suficiente.  As principais diferen√ßas de Redis Pub / Sub: <br><br><ul><li>  A mensagem √© entregue a um cliente.  O primeiro cliente bloqueado pela leitura receber√° os dados primeiro. </li><li>  Clint deve iniciar uma opera√ß√£o de leitura para cada mensagem.  Lista n√£o sabe nada sobre clientes. </li><li>  As mensagens s√£o armazenadas at√© que algu√©m as conte ou as exclua explicitamente.  Se voc√™ configurar um servidor Redis para liberar dados no disco, a confiabilidade do sistema aumentar√° drasticamente. </li></ul><br><h1>  Introdu√ß√£o ao Stream </h1><br><h4>  Adicionando um registro a um fluxo </h4><br>  O comando <b>XADD</b> adiciona um novo registro ao fluxo.  Um registro n√£o √© apenas uma sequ√™ncia, consiste em um ou mais pares de valores-chave.  Assim, cada registro j√° est√° estruturado e se assemelha √† estrutura de um arquivo CSV. <br><br><pre><code class="go hljs">&gt; XADD mystream * sensor-id <span class="hljs-number"><span class="hljs-number">1234</span></span> temperature <span class="hljs-number"><span class="hljs-number">19.8</span></span> <span class="hljs-number"><span class="hljs-number">1518951480106</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span></code> </pre> <br>  No exemplo acima, adicionamos dois campos ao fluxo com o nome (chave) "mystream": "sensor-id" e "temperature" com os valores "1234" e "19,8", respectivamente.  Como segundo argumento, o comando aceita o identificador que ser√° atribu√≠do ao registro - esse identificador identifica exclusivamente cada registro no fluxo.  No entanto, nesse caso, passamos * porque queremos que o Redis gere um novo identificador para n√≥s.  Cada novo identificador aumentar√°.  Portanto, cada novo registro ter√° um identificador maior em rela√ß√£o aos registros anteriores. <br><br><h4>  Formato de identifica√ß√£o </h4><br>  O identificador de registro retornado pelo comando <b>XADD</b> consiste em duas partes: <br><br> <code>{millisecondsTime}-{sequenceNumber} <br></code> <br>  <i>millisecondsTime</i> - hora do Unix em milissegundos (hora do servidor Redis).  No entanto, se a hora atual for igual ou menor que a hora do registro anterior, o carimbo de hora do registro anterior ser√° usado.  Portanto, se a hora do servidor retornar ao passado, o novo identificador ainda manter√° a propriedade de aumento. <br><br>  <i>sequenceNumber √©</i> usado para registros criados no mesmo milissegundo.  <i>sequenceNumber</i> ser√° aumentado em 1 em rela√ß√£o ao registro anterior.  Como <i>sequenceNumber</i> tem tamanho de 64 bits, na pr√°tica voc√™ n√£o deve ter um limite no n√∫mero de registros que podem ser gerados em um milissegundo. <br><br>  O formato desses identificadores √† primeira vista pode parecer estranho.  Um leitor incr√©dulo pode se perguntar por que o tempo faz parte de um identificador.  O motivo √© que os fluxos Redis suportam solicita√ß√µes de intervalo por identificadores.  Como o identificador est√° associado √† hora em que o registro foi criado, isso possibilita solicitar intervalos de tempo.  Veremos um exemplo concreto quando passarmos ao estudo do <b>comando XRANGE</b> . <br><br>  Se, por qualquer motivo, o usu√°rio precisar especificar seu pr√≥prio identificador, que, por exemplo, est√° associado a algum sistema externo, podemos transmiti-lo ao <b>comando XADD em</b> vez do sinal *, como mostrado abaixo: <br><br><pre> <code class="go hljs">&gt; XADD somestream <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> field value <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> &gt; XADD somestream <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> foo bar <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span></code> </pre><br>  Observe que, nesse caso, voc√™ deve monitorar o aumento no identificador.  No nosso exemplo, o identificador m√≠nimo √© "0-1", portanto a equipe n√£o aceitar√° outro identificador igual ou menor que "0-1". <br><br><pre> <code class="go hljs">&gt; XADD somestream <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> foo bar (error) ERR The ID specified in XADD is equal or smaller than the target stream top item</code> </pre><br><h4>  O n√∫mero de registros no fluxo </h4><br>  Voc√™ pode obter o n√∫mero de registros em um fluxo simplesmente usando o comando <b>XLEN</b> .  Para o nosso exemplo, este comando retornar√° o seguinte valor: <br><br><pre> <code class="go hljs">&gt; XLEN somestream (integer) <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br><h4>  Solicita√ß√µes de intervalo - XRANGE e XREVRANGE </h4><br>  Para solicitar dados para um intervalo, precisamos especificar dois identificadores - o in√≠cio e o fim do intervalo.  O intervalo retornado incluir√° todos os elementos, incluindo bordas.  H√° tamb√©m dois identificadores especiais "-" e "+", respectivamente, significando o menor (primeiro registro) e o maior (√∫ltimo registro) identificador no fluxo.  O exemplo abaixo exibir√° todas as entradas do fluxo. <br><br><pre> <code class="go hljs">&gt; XRANGE mystream - + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1518951480106</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"sensor-id"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"1234"</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-string"><span class="hljs-string">"temperature"</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-string"><span class="hljs-string">"19.8"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1518951482479</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"sensor-id"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"9999"</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-string"><span class="hljs-string">"temperature"</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-string"><span class="hljs-string">"18.2"</span></span></code> </pre><br>  Cada registro retornado √© uma matriz de dois elementos: um identificador e uma lista de pares de valores-chave.  J√° dissemos que os identificadores de registro est√£o relacionados ao tempo.  Portanto, podemos solicitar o intervalo de um per√≠odo espec√≠fico de tempo.  No entanto, podemos especificar na solicita√ß√£o n√£o o identificador completo, mas apenas o tempo Unix, omitindo a parte relacionada ao <i>sequenceNumber</i> .  A parte omitida do identificador √© automaticamente igual a zero no in√≠cio do intervalo e ao valor m√°ximo poss√≠vel no final do intervalo.  A seguir, √© apresentado um exemplo de como solicitar um intervalo de dois milissegundos. <br><br><pre> <code class="go hljs">&gt; XRANGE mystream <span class="hljs-number"><span class="hljs-number">1518951480106</span></span> <span class="hljs-number"><span class="hljs-number">1518951480107</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1518951480106</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"sensor-id"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"1234"</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-string"><span class="hljs-string">"temperature"</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-string"><span class="hljs-string">"19.8"</span></span></code> </pre><br>  Temos apenas um registro nesse intervalo, no entanto, em conjuntos de dados reais, o resultado retornado pode ser enorme.  Por esse motivo, o <b>XRANGE</b> suporta a op√ß√£o COUNT.  Ao especificar a quantidade, podemos simplesmente obter os primeiros N registros.  Se precisarmos obter as pr√≥ximas N entradas (pagina√ß√£o), podemos usar o √∫ltimo identificador recebido, aumentar seu <i>sequenceNumber</i> em um e solicitar novamente.  Vejamos isso no exemplo a seguir.  Estamos come√ßando a adicionar 10 elementos usando o <b>XADD</b> (suponha que o fluxo mystream j√° tenha sido preenchido com 10 elementos).  Para iniciar a itera√ß√£o, obtendo 2 elementos por comando, come√ßamos com o intervalo completo, mas com COUNT igual a 2. <br><br><pre> <code class="go hljs">&gt; XRANGE mystream - + COUNT <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1519073278252</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"value_1"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1519073279157</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"value_2"</span></span></code> </pre><br>  Para continuar a itera√ß√£o com os dois elementos a seguir, precisamos selecionar o √∫ltimo identificador recebido, que √© 1519073279157-0, e adicionar 1 ao <i>sequenceNumber</i> . <br>  O identificador resultante, neste caso 1519073279157-1, agora pode ser usado como um novo argumento para o in√≠cio do intervalo para a pr√≥xima chamada <b>XRANGE</b> : <br><br><pre> <code class="go hljs">&gt; XRANGE mystream <span class="hljs-number"><span class="hljs-number">1519073279157</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> + COUNT <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1519073280281</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"value_3"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1519073281432</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"value_4"</span></span></code> </pre><br>  E assim por diante  Como a complexidade do <b>XRANGE</b> √© O (log (N)) para pesquisar e, em seguida, O (M) para retornar elementos M, cada etapa da itera√ß√£o √© r√°pida.  Assim, usando o <b>XRANGE,</b> √© poss√≠vel <b>iterar os</b> fluxos com efici√™ncia. <br><br>  O comando <b>XREVRANGE</b> √© equivalente a <b>XRANGE</b> , mas retorna os elementos na ordem inversa: <br><br><pre> <code class="go hljs">&gt; XREVRANGE mystream + - COUNT <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1519073287312</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"value_10"</span></span></code> </pre><br>  Observe que o comando <b>XREVRANGE</b> aceita os argumentos do intervalo de in√≠cio e parada na ordem inversa. <br><br><h4>  Lendo novos registros com o XREAD </h4><br>  Geralmente, h√° uma tarefa de se inscrever no fluxo e receber apenas novas mensagens.  Esse conceito pode parecer um Pub / Sub Redis ou uma Lista Redis bloqueadora, mas existem diferen√ßas fundamentais em como usar o Redis Stream: <br><br><ol><li>  Cada nova mensagem √© entregue a cada assinante por padr√£o.  Esse comportamento √© diferente de bloquear a lista Redis, onde uma nova mensagem ser√° lida por apenas um assinante. </li><li>  Enquanto no Redis Pub / Sub todas as mensagens s√£o esquecidas e nunca s√£o salvas, no Stream todas as mensagens s√£o armazenadas por um per√≠odo indeterminado (a menos que o cliente solicite explicitamente a exclus√£o). </li><li>  O Redis Stream permite diferenciar o acesso √†s mensagens em um stream.  Um assinante espec√≠fico pode ver apenas seu hist√≥rico de mensagens pessoais. </li></ol><br>  Voc√™ pode se inscrever no fluxo e receber novas mensagens usando o comando <b>XREAD</b> .  Isso √© um pouco mais complicado que o <b>XRANGE</b> , portanto, come√ßaremos com exemplos mais simples primeiro. <br><br><pre> <code class="go hljs">&gt; XREAD COUNT <span class="hljs-number"><span class="hljs-number">2</span></span> STREAMS mystream <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"mystream"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1519073278252</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"value_1"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1519073279157</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"value_2"</span></span></code> </pre><br>  No exemplo acima, um formul√°rio <b>XREAD</b> sem bloqueio √© <b>especificado</b> .  Observe que a op√ß√£o COUNT √© opcional.  De fato, a √∫nica op√ß√£o de comando necess√°ria √© a op√ß√£o STREAMS, que define a lista de fluxos junto com o identificador m√°ximo correspondente.  Escrevemos "STREAMS mystream 0" - queremos obter todos os registros do fluxo mystream com um identificador maior que "0-0".  Como voc√™ pode ver no exemplo, o comando retorna o nome do fluxo, porque podemos assinar v√°rios threads ao mesmo tempo.  Poder√≠amos escrever, por exemplo, ‚ÄúSTREAMS mystream otherstream 0 0‚Äù.  Observe que, ap√≥s a op√ß√£o STREAMS, primeiro precisamos fornecer os nomes de todos os fluxos necess√°rios e somente uma lista de identificadores. <br><br>  Nesta forma simples, o comando n√£o faz nada de especial em compara√ß√£o com o <b>XRANGE</b> .  No entanto, o interessante √© que podemos facilmente transformar o <b>XREAD</b> em um comando de bloqueio especificando o argumento BLOCK: <br><br> <code>&gt; XREAD BLOCK 0 STREAMS mystream $ <br></code> <br>  No exemplo acima, uma nova op√ß√£o BLOCK √© especificada com um tempo limite de 0 milissegundos (isso significa espera sem fim).  Al√©m disso, em vez de passar o identificador usual para o fluxo mystream, o identificador especial $ foi passado.  Esse identificador especial significa que o <b>XREAD</b> deve usar o identificador m√°ximo no fluxo mystream como identificador.  Portanto, receberemos apenas novas mensagens, a partir do momento em que come√ßamos a ouvir.  De certa forma, isso √© semelhante ao comando tail -f do Unix. <br><br>  Observe que, ao usar a op√ß√£o BLOCK, n√£o precisamos usar o identificador especial $.  Podemos usar qualquer identificador existente no fluxo.  Se a equipe puder atender a nossa solicita√ß√£o imediatamente, sem bloquear, isso ser√° feito, caso contr√°rio, ser√° bloqueada. <br><br>  O bloqueio do <b>XREAD</b> tamb√©m pode ouvir v√°rios fluxos de uma s√≥ vez, basta especificar seus nomes.  Nesse caso, o comando retornar√° um registro do primeiro fluxo no qual os dados chegaram.  O primeiro assinante bloqueado para este fluxo receber√° os dados primeiro. <br><br><h3>  Grupos de consumidores </h3><br>  Em determinadas tarefas, queremos diferenciar o acesso de assinantes a mensagens dentro do mesmo encadeamento.  Um exemplo em que isso pode ser √∫til √© uma fila de mensagens com trabalhadores que receber√£o mensagens diferentes do fluxo, permitindo escalar o processamento de mensagens. <br><br>  Se imaginarmos que temos tr√™s assinantes C1, C2, C3 e um fluxo que cont√©m as mensagens 1, 2, 3, 4, 5, 6, 7, o servi√ßo de mensagens ocorrer√° como no diagrama abaixo: <br><br> <code>1 -&gt; C1 <br> 2 -&gt; C2 <br> 3 -&gt; C3 <br> 4 -&gt; C1 <br> 5 -&gt; C2 <br> 6 -&gt; C3 <br> 7 -&gt; C1 <br></code> <br>  Para obter esse efeito, o Redis Stream usa um conceito chamado Grupo de Consumidores.  Esse conceito √© semelhante a um pseudo-assinante que recebe dados de um fluxo, mas na verdade √© atendido por v√°rios assinantes dentro de um grupo, fornecendo certas garantias: <br><br><ol><li>  Cada mensagem √© entregue a diferentes assinantes dentro do grupo. </li><li>  Dentro de um grupo, os assinantes s√£o identificados pelo nome, que √© uma sequ√™ncia que diferencia mai√∫sculas de min√∫sculas.  Se algum assinante sair temporariamente do grupo, ele poder√° ser restaurado no grupo por seu pr√≥prio nome exclusivo. </li><li>  Cada grupo de consumidores segue o conceito de "primeira mensagem n√£o lida".  Quando um assinante solicita novas mensagens, ele pode receber apenas mensagens que nunca foram entregues a nenhum assinante dentro de um grupo. </li><li>  Existe um comando para confirmar explicitamente o processamento bem-sucedido da mensagem pelo assinante.  At√© que este comando seja chamado, a mensagem solicitada permanecer√° no status "pendente". </li><li>  Dentro do Grupo de Consumidores, cada assinante pode solicitar um hist√≥rico de mensagens entregues a ele, mas ainda n√£o foram processadas (no status "pendente") </li></ol><br>  Em certo sentido, o estado de um grupo pode ser representado da seguinte maneira: <br><br><pre> <code class="go hljs">+----------------------------------------+ | consumer_group_name: mygroup | consumer_group_stream: somekey | last_delivered_id: <span class="hljs-number"><span class="hljs-number">1292309234234</span></span><span class="hljs-number"><span class="hljs-number">-92</span></span> | | consumers: | <span class="hljs-string"><span class="hljs-string">"consumer-1"</span></span> with pending messages | <span class="hljs-number"><span class="hljs-number">1292309234234</span></span><span class="hljs-number"><span class="hljs-number">-4</span></span> | <span class="hljs-number"><span class="hljs-number">1292309234232</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> | <span class="hljs-string"><span class="hljs-string">"consumer-42"</span></span> with pending messages | ... (and so forth) +----------------------------------------+</code> </pre><br>  Agora √© hora de se familiarizar com as principais equipes do Grupo de Consumidores, a saber: <br><br><ul><li>  <b>XGROUP √©</b> usado para criar, destruir e gerenciar grupos. </li><li>  <b>XREADGROUP √©</b> usado para ler um fluxo atrav√©s de um grupo. </li><li>  <b>XACK</b> - este comando permite que o assinante marque a mensagem como processada com √™xito </li></ul><br><h4>  Cria√ß√£o de grupo de consumidores </h4><br>  Suponha que um fluxo mystream j√° exista.  Em seguida, o comando de cria√ß√£o de grupo ser√° semelhante a: <br><br> <code>&gt; XGROUP CREATE mystream mygroup $ <br> OK <br></code> <br>  Ao criar um grupo, devemos passar um identificador come√ßando com o qual o grupo receber√° mensagens.  Se queremos apenas receber todas as novas mensagens, podemos usar o identificador especial $ (como no nosso exemplo acima).  Se voc√™ especificar 0 em vez de um identificador especial, todas as mensagens do fluxo estar√£o dispon√≠veis para o grupo. <br><br>  Agora que o grupo foi criado, podemos come√ßar imediatamente a ler as mensagens usando o <b>comando XREADGROUP</b> .  Este comando √© muito semelhante ao <b>XREAD</b> e suporta a op√ß√£o opcional BLOCK.  No entanto, existe uma op√ß√£o obrigat√≥ria GROUP, que sempre deve ser especificada com dois argumentos: o nome do grupo e o nome do assinante.  A op√ß√£o COUNT tamb√©m √© suportada. <br><br>  Antes de ler o fluxo, vamos colocar algumas mensagens l√°: <br><br><pre> <code class="go hljs">&gt; XADD mystream * message apple <span class="hljs-number"><span class="hljs-number">1526569495631</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> &gt; XADD mystream * message orange <span class="hljs-number"><span class="hljs-number">1526569498055</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> &gt; XADD mystream * message strawberry <span class="hljs-number"><span class="hljs-number">1526569506935</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> &gt; XADD mystream * message apricot <span class="hljs-number"><span class="hljs-number">1526569535168</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> &gt; XADD mystream * message banana <span class="hljs-number"><span class="hljs-number">1526569544280</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span></code> </pre><br>  Agora vamos tentar ler este fluxo atrav√©s do grupo: <br><br><pre> <code class="go hljs">&gt; XREADGROUP GROUP mygroup Alice COUNT <span class="hljs-number"><span class="hljs-number">1</span></span> STREAMS mystream &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"mystream"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1526569495631</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"message"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"apple"</span></span></code> </pre><br>  O comando acima, literalmente, √© o seguinte: <br><br>  "Eu, o assinante de Alice, um membro do meu grupo, quero ler uma mensagem do mystream que nunca foi entregue a ningu√©m antes." <br><br>  Cada vez que um assinante realiza uma opera√ß√£o com um grupo, ele deve indicar seu nome, identificando-se exclusivamente dentro do grupo.  H√° outro detalhe muito importante no comando acima - o identificador especial "&gt;".  Esse identificador especial filtra as mensagens, deixando apenas as que at√© agora nunca foram entregues. <br><br>  Al√©m disso, em casos especiais, voc√™ pode especificar um identificador real, como 0 ou qualquer outro identificador v√°lido.  Nesse caso, o comando <b>XREADGROUP</b> retornar√° para voc√™ o hist√≥rico de mensagens com o status "pendente", que foram entregues ao assinante especificado (Alice), mas ainda n√£o foram confirmadas usando o <b>comando XACK</b> . <br><br>  Podemos verificar esse comportamento especificando imediatamente o identificador 0, sem a op√ß√£o <b>COUNT</b> .  Apenas vemos a √∫nica mensagem pendente, ou seja, a mensagem com a ma√ß√£: <br><br><pre> <code class="go hljs">&gt; XREADGROUP GROUP mygroup Alice STREAMS mystream <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"mystream"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1526569495631</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"message"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"apple"</span></span></code> </pre><br>  No entanto, se confirmarmos a mensagem como processada com √™xito, ela n√£o ser√° mais exibida: <br><br><pre> <code class="go hljs">&gt; XACK mystream mygroup <span class="hljs-number"><span class="hljs-number">1526569495631</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> (integer) <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; XREADGROUP GROUP mygroup Alice STREAMS mystream <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"mystream"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) (empty list or set)</code> </pre><br>  Agora √© a vez de Bob ler algo: <br><br><pre> <code class="go hljs">&gt; XREADGROUP GROUP mygroup Bob COUNT <span class="hljs-number"><span class="hljs-number">2</span></span> STREAMS mystream &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"mystream"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1526569498055</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"message"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"orange"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1526569506935</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"message"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"strawberry"</span></span></code> </pre><br>  Bob, um membro do meu grupo, pediu n√£o mais que duas mensagens.  O comando relata apenas mensagens n√£o entregues devido ao identificador especial "&gt;".  Como voc√™ pode ver, a mensagem "ma√ß√£" n√£o √© exibida, pois j√° foi entregue a Alice, ent√£o Bob recebe "laranja" e "morango". <br><br>  Assim, Alice, Bob e qualquer outro assinante do grupo podem ler mensagens diferentes do mesmo fluxo.  Eles tamb√©m podem ler o hist√≥rico de mensagens brutas ou marcar as mensagens como processadas. <br><br>  H√° algumas coisas a serem lembradas: <br><br><ul><li>  Assim que o assinante considerar a mensagem como o comando <b>XREADGROUP</b> , essa mensagem entrar√° no estado "pendente" e ser√° atribu√≠da a esse assinante espec√≠fico.  Outros assinantes do grupo n√£o poder√£o ler esta mensagem. </li><li>  Os assinantes s√£o criados automaticamente na primeira men√ß√£o, n√£o h√° necessidade de cria√ß√£o expl√≠cita. </li><li>  Com o <b>XREADGROUP,</b> voc√™ pode ler mensagens de v√°rios fluxos diferentes ao mesmo tempo; no entanto, para que isso funcione, √© necess√°rio primeiro criar grupos com o mesmo nome para cada fluxo usando <b>XGROUP</b> </li></ul><br><h4>  Recupera√ß√£o de falha </h4><br>  O assinante pode se recuperar da falha e reler sua lista de mensagens com o status "pendente".  No entanto, no mundo real, os assinantes podem falhar.  O que acontece com a mensagem pendente de um assinante se ele n√£o pode se recuperar ap√≥s uma falha? <br>  O Grupo de consumidores oferece um recurso usado especificamente para esses casos - quando voc√™ precisa alterar o propriet√°rio das mensagens. <br><br>  Primeiro, voc√™ precisa chamar o comando <b>XPENDING</b> , que exibe todas as mensagens do grupo com o status "pendente".  Na sua forma mais simples, um comando √© chamado com apenas dois argumentos: o nome do fluxo e o nome do grupo: <br><br><pre> <code class="go hljs">&gt; XPENDING mystream mygroup <span class="hljs-number"><span class="hljs-number">1</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1526569498055</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-number"><span class="hljs-number">1526569506935</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"Bob"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"2"</span></span></code> </pre><br>  A equipe imprimiu o n√∫mero de mensagens n√£o processadas para todo o grupo e para cada assinante.  Temos apenas Bob com duas mensagens n√£o processadas, porque a √∫nica mensagem solicitada por Alice foi confirmada com o <b>XACK</b> . <br><br>  Podemos solicitar informa√ß√µes adicionais usando mais argumentos: <br><br> <code>XPENDING {key} {groupname} [{start-id} {end-id} {count} [{consumer-name}]] <br></code> <br>  {start-id} {end-id} - intervalo de identificadores (voc√™ pode usar "-" e "+") <br>  {count} - o n√∫mero de tentativas de entrega <br>  {nome do consumidor} - nome do grupo <br><br><pre> <code class="go hljs">&gt; XPENDING mystream mygroup - + <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1526569498055</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"Bob"</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">74170458</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1526569506935</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"Bob"</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">74170458</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Agora, temos os detalhes de cada mensagem: identificador, nome do assinante, tempo de inatividade em milissegundos e, finalmente, o n√∫mero de tentativas de entrega.  Temos duas mensagens de Bob e elas ficam inativas por 74170458 milissegundos, cerca de 20 horas. <br><br>  Observe que ningu√©m est√° nos impedindo de verificar qual era o conte√∫do da mensagem usando <b>XRANGE</b> . <br><br><pre> <code class="go hljs">&gt; XRANGE mystream <span class="hljs-number"><span class="hljs-number">1526569498055</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">1526569498055</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1526569498055</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"message"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"orange"</span></span></code> </pre><br>  N√≥s apenas temos que repetir o mesmo identificador duas vezes nos argumentos.  Agora que temos alguma id√©ia, Alice pode decidir que Bob provavelmente n√£o se recuperar√° ap√≥s 20 horas de inatividade, e √© hora de solicitar essas mensagens e continuar processando-as em vez de Bob.  Para fazer isso, usamos o comando <b>XCLAIM</b> : <br><br> <code>XCLAIM {key} {group} {consumer} {min-idle-time} {ID-1} {ID-2} ... {ID-N} <br></code> <br>  Usando este comando, podemos obter uma mensagem "estrangeira" que ainda n√£o foi processada, alterando o propriet√°rio para {consumidor}.  No entanto, tamb√©m podemos fornecer um tempo de inatividade m√≠nimo {min-idle-time}.  Isso ajuda a evitar uma situa√ß√£o em que dois clientes tentam alterar simultaneamente o propriet√°rio das mesmas mensagens: <br><br> <code>Client 1: XCLAIM mystream mygroup Alice 3600000 1526569498055-0 <br> Clinet 2: XCLAIM mystream mygroup Lora 3600000 1526569498055-0 <br></code> <br>  O primeiro cliente redefinir√° o tempo de inatividade e aumentar√° o contador do n√∫mero de entregas.  Portanto, o segundo cliente n√£o poder√° solicit√°-lo. <br><br><pre> <code class="go hljs">&gt; XCLAIM mystream mygroup Alice <span class="hljs-number"><span class="hljs-number">3600000</span></span> <span class="hljs-number"><span class="hljs-number">1526569498055</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1526569498055</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"message"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"orange"</span></span></code> </pre><br>  A mensagem foi reivindicada com sucesso por Alice, que agora pode processar a mensagem e reconhec√™-la. <br><br>  A partir do exemplo acima, √© claro que a execu√ß√£o bem-sucedida da solicita√ß√£o retorna o conte√∫do da pr√≥pria mensagem.  No entanto, isso n√£o √© necess√°rio.  A op√ß√£o JUSTID pode ser usada para retornar apenas identificadores de mensagem.  Isso √© √∫til se voc√™ n√£o estiver interessado nos detalhes da mensagem e desejar aumentar o desempenho do sistema. <br><br><h3>  Balc√£o de entrega </h3><br>  O contador que voc√™ observa na sa√≠da <b>XPENDING</b> √© o n√∫mero de entregas de cada mensagem.  Esse contador √© incrementado de duas maneiras: quando a mensagem √© solicitada com √™xito por meio do <b>XCLAIM</b> ou quando a chamada <b>XREADGROUP</b> √© <b>usada</b> . <br><br>  √â normal que algumas mensagens sejam entregues v√°rias vezes.  O principal √© que, como resultado, todas as mensagens s√£o processadas.  √Äs vezes, ao processar uma mensagem, h√° problemas devido a danos √† pr√≥pria mensagem ou ao processar a mensagem causa um erro no c√≥digo do manipulador.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nesse caso, pode acontecer que ningu√©m consiga processar esta mensagem. </font><font style="vertical-align: inherit;">Como temos um contador de tentativas de entrega, podemos us√°-lo para detectar essas situa√ß√µes. </font><font style="vertical-align: inherit;">Portanto, assim que o contador de entrega atingir um grande n√∫mero especificado por voc√™, provavelmente ser√° mais razo√°vel colocar essa mensagem em outro fluxo e enviar uma notifica√ß√£o ao administrador do sistema.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Status do segmento </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O comando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XINFO √©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usado para solicitar v√°rias informa√ß√µes sobre um fluxo e seus grupos. </font><font style="vertical-align: inherit;">Por exemplo, a forma b√°sica do comando √© a seguinte:</font></font><br><br><pre> <code class="go hljs">&gt; XINFO STREAM mystream <span class="hljs-number"><span class="hljs-number">1</span></span>) length <span class="hljs-number"><span class="hljs-number">2</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) radix-tree-keys <span class="hljs-number"><span class="hljs-number">4</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>) radix-tree-nodes <span class="hljs-number"><span class="hljs-number">6</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>) groups <span class="hljs-number"><span class="hljs-number">8</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>) first-entry <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1524494395530</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"a"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"1"</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-string"><span class="hljs-string">"b"</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>) last-entry <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1526569544280</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"message"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"banana"</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O comando acima exibe informa√ß√µes gerais no fluxo especificado. </font><font style="vertical-align: inherit;">Agora, um exemplo um pouco mais complexo:</font></font><br><br><pre> <code class="go hljs">&gt; XINFO GROUPS mystream <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) name <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"mygroup"</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) consumers <span class="hljs-number"><span class="hljs-number">4</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>) pending <span class="hljs-number"><span class="hljs-number">6</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) name <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"some-other-group"</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) consumers <span class="hljs-number"><span class="hljs-number">4</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>) pending <span class="hljs-number"><span class="hljs-number">6</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O comando acima exibe informa√ß√µes gerais para todos os grupos do fluxo especificado </font></font><br><br><pre> <code class="go hljs">&gt; XINFO CONSUMERS mystream mygroup <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) name <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"Alice"</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) pending <span class="hljs-number"><span class="hljs-number">4</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>) idle <span class="hljs-number"><span class="hljs-number">6</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">9104628</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) name <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"Bob"</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) pending <span class="hljs-number"><span class="hljs-number">4</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>) idle <span class="hljs-number"><span class="hljs-number">6</span></span>) (integer) <span class="hljs-number"><span class="hljs-number">83841983</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O comando acima exibe informa√ß√µes sobre todos os assinantes do fluxo e grupo especificados. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ esquecer a sintaxe do comando, entre em contato com o comando para obter ajuda:</font></font><br><br><pre> <code class="go hljs">&gt; XINFO HELP <span class="hljs-number"><span class="hljs-number">1</span></span>) XINFO {subcommand} arg arg ... arg. Subcommands are: <span class="hljs-number"><span class="hljs-number">2</span></span>) CONSUMERS {key} {groupname} -- Show consumer groups of group {groupname}. <span class="hljs-number"><span class="hljs-number">3</span></span>) GROUPS {key} -- Show the stream consumer groups. <span class="hljs-number"><span class="hljs-number">4</span></span>) STREAM {key} -- Show information about the stream. <span class="hljs-number"><span class="hljs-number">5</span></span>) HELP -- Print this help.</code> </pre><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Limite de tamanho do fluxo </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Muitos aplicativos n√£o desejam coletar dados no fluxo para sempre. </font><font style="vertical-align: inherit;">Geralmente, √© √∫til ter o n√∫mero m√°ximo de mensagens no fluxo. </font><font style="vertical-align: inherit;">Em outros casos, √© √∫til transferir todas as mensagens do fluxo para outro armazenamento persistente quando o tamanho do fluxo especificado for atingido. </font><font style="vertical-align: inherit;">Voc√™ pode limitar o tamanho do fluxo usando o par√¢metro MAXLEN no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comando XADD</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="go hljs">&gt; XADD mystream MAXLEN <span class="hljs-number"><span class="hljs-number">2</span></span> * value <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1526654998691</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> &gt; XADD mystream MAXLEN <span class="hljs-number"><span class="hljs-number">2</span></span> * value <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1526654999635</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> &gt; XADD mystream MAXLEN <span class="hljs-number"><span class="hljs-number">2</span></span> * value <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1526655000369</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> &gt; XLEN mystream (integer) <span class="hljs-number"><span class="hljs-number">2</span></span> &gt; XRANGE mystream - + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1526654999635</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"value"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1526655000369</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"value"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"3"</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao usar o MAXLEN, os registros antigos s√£o exclu√≠dos automaticamente quando o comprimento especificado √© atingido; portanto, o fluxo tem um tamanho constante. </font><font style="vertical-align: inherit;">No entanto, o corte nesse caso n√£o ocorre da maneira mais produtiva na mem√≥ria do Redis. </font><font style="vertical-align: inherit;">A situa√ß√£o pode ser </font><font style="vertical-align: inherit;">melhorada da </font><font style="vertical-align: inherit;">seguinte maneira: O </font><font style="vertical-align: inherit;">argumento ~ no exemplo acima significa que n√£o precisamos limitar o comprimento do fluxo a um valor espec√≠fico. </font><font style="vertical-align: inherit;">No nosso exemplo, esse n√∫mero pode ser maior ou igual a 1000 (por exemplo, 1000, 1010 ou 1030). </font><font style="vertical-align: inherit;">Apenas indicamos explicitamente que queremos que nosso fluxo armazene pelo menos 1000 registros. </font><font style="vertical-align: inherit;">Isso torna o trabalho com mem√≥ria muito mais eficiente dentro do Redis. </font><font style="vertical-align: inherit;">H√° tamb√©m um comando </font><b><font style="vertical-align: inherit;">XTRIM</font></b><font style="vertical-align: inherit;"> separado </font><font style="vertical-align: inherit;">que faz a mesma coisa:</font></font><br><br> <code>XADD mystream MAXLEN ~ 1000 * ... entry fields here ... <br></code> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br><br> <code>&gt; XTRIM mystream MAXLEN 10 <br> <br> &gt; XTRIM mystream MAXLEN ~ 10 <br></code> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Armazenamento e replica√ß√£o persistentes </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Redis Stream √© replicado de forma ass√≠ncrona nos n√≥s escravos e salvo em arquivos como AOF (instant√¢neo de todos os dados) e RDB (log de todas as opera√ß√µes de grava√ß√£o). </font><font style="vertical-align: inherit;">A replica√ß√£o de estado de Grupos de Consumidores tamb√©m √© suportada. </font><font style="vertical-align: inherit;">Portanto, se a mensagem estiver no status ‚Äúpendente‚Äù no n√≥ principal, nos n√≥s escravos essa mensagem ter√° o mesmo status.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Removendo itens individuais de um fluxo </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para excluir mensagens, existe um comando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XDEL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> especial </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O comando obt√©m o nome do fluxo, seguido pelos identificadores da mensagem que precisa ser exclu√≠da:</font></font><br><br><pre> <code class="go hljs">&gt; XRANGE mystream - + COUNT <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1526654999635</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"value"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1526655000369</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"value"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"3"</span></span> &gt; XDEL mystream <span class="hljs-number"><span class="hljs-number">1526654999635</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> (integer) <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; XRANGE mystream - + COUNT <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1526655000369</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"value"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"3"</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ao usar este comando, √© necess√°rio considerar que, de fato, a mem√≥ria n√£o ser√° liberada imediatamente. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fluxos de comprimento zero </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A diferen√ßa entre fluxos e outras estruturas de dados Redis √© que, quando outras estruturas de dados n√£o tiverem mais elementos em si mesmas, como efeito colateral, a pr√≥pria estrutura de dados ser√° exclu√≠da da mem√≥ria. </font><font style="vertical-align: inherit;">Portanto, por exemplo, o conjunto classificado ser√° completamente exclu√≠do quando a chamada do ZREM remover o √∫ltimo item. </font><font style="vertical-align: inherit;">Em vez disso, √© permitido que os threads permane√ßam na mem√≥ria sem ter um √∫nico elemento dentro.</font></font><br><br><h4>  Conclus√£o </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Redis Stream √© ideal para criar intermedi√°rios de mensagens, filas de mensagens, logs unificados e sistemas de bate-papo que armazenam hist√≥rico. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nicklaus Wirth</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> disse uma vez </font><font style="vertical-align: inherit;">, os programas s√£o algoritmos e estruturas de dados, e o Redis j√° oferece os dois.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt456270/">https://habr.com/ru/post/pt456270/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt456258/index.html">Livre como um vento e livre como uma tradu√ß√£o de cerveja de "Livre como na liberdade" para o russo sob a licen√ßa GNU FDL 1.3</a></li>
<li><a href="../pt456260/index.html">Conversa sobre economia justa</a></li>
<li><a href="../pt456262/index.html">R√°dio definido por software - como funciona? Parte 9</a></li>
<li><a href="../pt456264/index.html">Crie arquivos bin√°rios do Android usando o NDK do Android e de origem. Desenvolvemos o utilit√°rio screencap</a></li>
<li><a href="../pt456266/index.html">O resumo de materiais interessantes para o desenvolvedor m√≥vel 302 (de 10 a 16 de junho)</a></li>
<li><a href="../pt456272/index.html">O que √© o Android Lint e como ele ajuda a escrever c√≥digo suportado</a></li>
<li><a href="../pt456274/index.html">Psic√≥logos: rob√¥s sexuais levar√£o a um aumento no n√∫mero de pessoas sem um casal que n√£o precisa de relacionamentos com outras pessoas</a></li>
<li><a href="../pt456276/index.html">O que √© informa√ß√£o?</a></li>
<li><a href="../pt456280/index.html">Introdu√ß√£o ao stm32 ou n√£o repita meus erros</a></li>
<li><a href="../pt456282/index.html">Gr√°ficos multidimensionais em Python - de tridimensionais a seis dimensionais</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>