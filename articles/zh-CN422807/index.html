<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗯️ 🧜🏽 🎓 AliceVision：命令行摄影测量 🙍🏿 🎽 👏🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="您是否需要自动化大量的摄影测量扫描？ 那我对你有个好消息。 


 该视频显示了开源的Meshroom摄影测量程序。 这个项目已经以各种形式存在了一段时间，但是最近开发人员已经发布了二进制文件，因此您可以简单地下载和使用它们。 该视频演示了如何使用GUI加载图像，处理图像，更改参数等。 我建议您尝试...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>AliceVision：命令行摄影测量</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/422807/"> 您是否需要自动化大量的摄影测量扫描？ 那我对你有个好消息。 <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/v_O6tYKQEBA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br> 该视频显示了开源的<i>Meshroom</i>摄影测量程序。 这个项目已经以各种形式存在了一段时间，但是最近开发人员已经发布了二进制文件，因此您可以简单地下载和使用它们。 该视频演示了如何使用GUI加载图像，处理图像，更改参数等。 我建议您尝试使用该程序。 <br><br> 但是我对完全自动化感兴趣。 如果您有一个扫描安装程序，每天要进行100次或更多次扫描，则需要一个全自动解决方案来批量处理这些文件。 这篇文章是解决此问题的指南和/或教程。 <br><a name="habracut"></a><br> 对于初学者来说，重要的是要了解<i>Meshroom</i>不是一个庞大的整体项目。 实际上，处理本身是由从命令行运行的单独的C ++程序执行的， <i>Meshroom</i>是执行适当调用的瘦Python编码程序。 因此，我们将直接使用这些程序，而不是使用<i>Meshroom</i> 。 请注意，完整的源代码可用，因此您可以直接链接库。 <br><br>  <i>Meshroom的</i>另一个便利功能是：在每次操作期间，其命令都显示在终端中。 因此，为了创建此过程的各个阶段，我只是与<i>Meshroom</i>合作，并考察了团队。 然后我查看了代码以更改一些参数。 另外，似乎在启动Meshroom时，可以命令它从命令行收集一组图像，但是我不希望连接这些步骤。 <br><br><h2> 准备和安装 </h2><br>  <strong>0：要求</strong> <br><br>  <i>Meshroom</i> / <i>AliceVision</i>不会在所有平台上运行。 一些步骤需要CUDA，因此要构建深度图，您将需要NVIDIA GPU。 不幸的是，不可能使用CPU后备（将GPU功能的执行转移到CPU），否则，该程序在Windows和Linux上也可以正常工作。 本文中的说明适用于Windows，但只需进行很少的更改，即可针对Linux进行微调。 <br><br>  <strong>1：下载Meshroom版本</strong> <br><br>  <a href="">网格房2018.1.0</a> <br><br> 首先要做的是安装<i>Meshroom</i> 。 选择您要从中进行工作的文件夹，然后下载最新版本。 该zip文件包含所有依赖项的二进制文件。 <br><br> 如果您喜欢冒险，可以尝试自己组装程序。 发布动态链接库工作正常（/ MD），但是我不得不破解cmake文件来创建调试版本和/或静态链接版本。 如果要在Windows下构建程序，则极力推荐使用VCPKG。 <br><br>  <strong>2：下载数据</strong> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">alicevision / dataset_monstree</a> <br><br> 显然，摄影测量软件的要点是处理您自己的图像，但首先我建议您使用适合的图像。 如果出现问题，它们将使您找到问题的根源。 幸运的是，开发人员为其测试树发布了一组图像。 <br><br>  <strong>3：下载<i>run_alicevision.py</i>脚本</strong> <br><br>  <a href="">run_alicevision.zip</a> <br><br> 这是我们将使用的脚本。 只需下载zip文件并将其解压缩到您的工作文件夹中即可。 <br><br>  <strong>4：安装Python</strong> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.python.org/download/releases/2.7/</a> <br><br> 如果尚未安装Python，请先安装。 是的，我仍在为Python 2.7.0编写代码。 从发行版安装<i>Windows X86-64 MSI安装程序</i>的最简单方法。 <br><br>  <strong>5：安装Meshlab（可选）</strong> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">网格实验室</a> <br><br> 作为可选步骤，您还必须安装<i>MeshLab</i> 。 实际上，将不需要进行处理，但是在几个阶段中，数据会显示在PLY点文件中。 它们无法下载到<i>Maya</i> ，因此我使用<i>MeshLab</i>进行查看。 <br><br> 解<i>压缩</i>所有文件后，该文件夹应如下所示（由脚本生成的<i>build_files</i>文件夹除外）： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bfd/ee8/853/bfdee88535c3e87f5a77c729e9fddcb9.png"></div><br><br> 以下是： <br><br><ul><li>  <strong>build_files：</strong>我们已编译<strong>的</strong>文件。 </li><li>  <strong>dataset_monstree-master：</strong>源图像 </li><li>  <strong>Meshroom-2018.1.0：</strong> <i>Meshroom</i> / <i>AliceVision二进制文件</i> 。 </li><li>  <strong>其他所有内容：</strong>运行它们的脚本，该脚本取自<a href="">run_alicevision.zip</a> 。 </li></ul><br><h2> 启动AliceVision </h2><br> 现在是时候仔细看看<i>run_alicevision.py</i> <br><br>  Python文件接收5个参数： <br><br> <code>python run_alicevision.py &amp;ltbaseDir&amp;gt &amp;ltimgDir&amp;gt &amp;ltbinDir&amp;gt &amp;ltnumImages&amp;gt &amp;ltrunStep&amp;gt</code> <br> <br><ol><li>  <strong>baseDir</strong> ：您要在其中放置临时文件的文件夹。 </li><li>  <strong>imgDir</strong> ：包含源图像的文件夹。 在我们的例子中， <i>IMG_1024.JPG</i> （及其他）。 </li><li>  <strong>binDir</strong> ：包含<i>AliceVision可执行</i>文件的文件夹，例如<i>aliceVision_cameraInit.exe</i> 。 </li><li>  <strong>numImages</strong> ：在我们的例子6中，为<strong>imgDir中</strong>的图像数。当然，您可以自动识别此数字，但是目标是创建尽可能简单的python脚本，因此您需要自己指定此数字。 </li><li>  <strong>runStep</strong> ：要执行的操作。 </li></ol><br> 总结一下：我们从6张看起来像这样的图像开始： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/29f/777/05f/29f77705fac634cceb67d813ec2cee6c.png"></div><br> 使用<i>run_alicevision.py</i> python脚本<i>，</i>我们将创建以下文件夹结构： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/91b/6f3/707/91b6f37070d53f55a030219b44d72c0f.png"></div><br> 在<i>11_Texturing</i>文件夹中，将在<i>Meshlab</i>中打开一个现成的模型： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/979/62e/06a/97962e06a4b6f86d8fd29dbdf233c45d.jpg"></div><br> 这些文件夹中的每一个都是步骤之一。 我们可以使用<i>run_monstree_runXX.bat</i>文件依次运行它们，也可以使用<i>run_monstree_all.bat</i>一次收集它们。 <br><br> 仅此而已。 现在，您可以运行文件<i>run_monstree_all.bat</i> ，或一次执行一个步骤。 您可以查看脚本以了解其工作。 对于那些希望能够自定义处理管道的人，我准备了各个步骤的简介。 <br><br>  <strong>00_CameraInit</strong> <br><br> 第一步将生成一个SFM文件。  SFM文件是JSON文件，用于存储相机大小，传感器信息，找到的3d点（观测值），失真因子和其他信息。 此文件夹中的初始SFM文件将仅包含有关传感器的信息，并从本地传感器数据库中选择默认值。 后续步骤将创建SFM文件，其中包含外部摄像机参数，点等的完整矩阵。 <br><br> 您可能需要配置此步骤。 如果您使用带有4个摄像机的设置，但要在转盘上旋转的物体拍摄10张照片，则您需要一个SFM文件，其中包含40张图像，但只有4种不同的传感器校准。 这就是为什么我喜欢<i>AliceVision</i>的结构的<i>主要原因</i> 。 在其中轻松设置批处理操作（例如，生成自己的SFM文件），而无需设置其他最好不要改动的软件元素。 <br><br>  <strong>01_FeatureExtraction</strong> <br><br> 下一阶段从图像中提取特征特征，以及这些特征的描述符。 它将根据提取的特征类型更改文件扩展名。 <br><br>  <strong>02_ImageMatching</strong> <br><br>  <i>02_ImageMatching</i>是一个后处理步骤，它确定哪些图像可以逻辑映射到彼此。 如果您有一组1000张图像，则要对所有1000张图像进行粗略搜索以匹配所有1000张图像，则需要100万对。 这会花费很多时间（实际上是一半，但是您了解原理）。 阶段<i>02_ImageMatching</i>切断了这些对。 <br><br>  <strong>03_FeatureMatching</strong> <br><br>  <i>03_FeatureMatching</i>使用特征描述符匹配图像。 它生成的txt文件不需要解释。 <br><br>  <strong>04_StructureFromMotion</strong> <br><br> 因此，这是第一个严肃的阶段。 基于<i>04_StructureFromMotion</i>对应关系， <i>它将</i>计算摄像机的位置以及摄像机的内部参数。 应当注意，术语“从运动开始的结构”用作计算相机位置的通用术语。 如果您有10个同步摄像机的摄影测量设置，则即使没有真正移动，也可以使用“运动构造”来捕捉它们。 <br><br> 默认情况下， <i>Meshroom</i>将所有计算出的数据存储为<i>Alembic</i>文件，但我更喜欢将其存储在SFM文件中。 此阶段创建中间数据，以确保正确链接摄像机。 在输出中，脚本创建可以在<i>Meshlab中</i>查看的PLY文件。 以下文件很重要： <br><br><ul><li>  <strong>bundle.sfm：</strong>具有所有观察结果的SFM文件。 </li><li>  <strong>camera.fm：</strong>仅包含附加摄像机数据<strong>的</strong> SFM文件。 </li><li>  <strong>cloud_and_poses.ply：</strong>找到的点和摄像机。 </li></ul><br><br> 这是<i>cloud_and_poses.ply</i>文件。 绿点是相机。 我认为这种格式最适合检查相机装订中是否没有严重错误。 如果某处发生错误，则可以返回并更改功能，对应关系或SFM参数。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1cc/1fd/9fa/1cc1fd9fabcc181bd231cbf261d3c0f6.jpg"></div><br><br>  <strong>05_PrepareDenseScene</strong> <br><br>  <i>05_PrepareDenseScene</i>的主要任务是消除图像失真。 它生成没有失真的EXR图像，因此在计算深度和投影的后续步骤中，无需从失真函数执行往返转换。 图片如下所示： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c42/b58/3d3/c42b583d37d4e7eacf1d9f9118454096.jpg"></div><br><br> 请注意，您会看到黑色区域。  <i>AliceVision的</i>后续步骤不使用真实的相机矩阵。 取而代之的是，我们假设相机具有一个没有失真的新矩阵，并且<i>05_PrepareDenseScene</i>将原始图像变形为该虚拟矩阵。 由于此新的虚拟传感器大于实际传感器，因此某些区域将显示为空白（黑色）。 <br><br>  <strong>06_CameraConnection</strong> <br><br> 严格来说，此阶段违反了我们工作流程的原则。 所有阶段的设计都使每个文件夹成为一个完全独特的单独阶段。 但是， <i>06_CameraConnection</i>在<i>05_PrepareDenseScene</i>文件夹中创建<i>camsPairsMatrixFromSeeds.bin</i>文件，因为此文件必须与图像位于同一文件夹中且不能变形。 <br><br>  <strong>07_DepthMap</strong> <br><br> 这是<i>AliceVision</i>的最长阶段：生成深度图。 它为每个图像创建一个深度图作为EXR文件。 我对其进行设置以使其更容易注意到。 您会看到一个小的“舌头”从树上伸出来。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0e1/333/ff8/0e1333ff8b1f58bd48c5fb6102b2fba0.jpg"></div><br> 由于此阶段需要很多时间，因此有一个参数允许我们将不同摄像机的组作为不同的单独命令运行。 因此，如果您有1000个摄像机，则可以为不同农场计算机上的摄像机组创建深度图。 或者，您可以将工作分成几小组，这样一台计算机崩溃时，您无需再次重复整个过程。 <br><br>  <strong>08_DepthMapFilter</strong> <br><br> 源深度图将不完全一致。 一些深度图将需要查看与其他深度图重叠的区域。 阶段<i>08_DepthMapFilter</i>隔离了这些区域并<i>增强了</i>深度一致性。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7e7/456/6ac/7e74566ac815acdd3a3287d281931d87.jpg"></div><br>  <strong>09_啮合</strong> <br><br> 这是直接生成网格的第一步。 网格可能存在一些小问题，可以用...解决。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/206/f86/0e8/206f860e8c42f1d095727927043564e6.jpg"></div><br>  <strong>10_MeshFiltering</strong> <br><br> 阶段<i>10_MeshFiltering</i>接收<i>09_Meshing</i>网格并对其进行<i>优化</i> 。 它执行以下操作： <br><br><ul><li> 平滑网格。 </li><li> 消除大三角形。 </li><li> 保存最大的网格，但删除其余的网格。 </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/634/ee8/c73/634ee8c731347eb889630d0dd51c5aef.jpg"></div><br> 其中某些操作在某些情况下并不总是理想的，因此可以根据需要调整参数。 <br><br>  <strong>11_纹理</strong> <br><br> 最后阶段。  <i>11_Texturing</i>创建UV并<i>投影</i>纹理。 至此，一切都结束了！ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/979/62e/06a/97962e06a4b6f86d8fd29dbdf233c45d.jpg"></div><br> 您可以使用<i>Meshlab</i>做的最后一个技巧：可以将不同的OBJ和PLY文件拖放为图层。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a82/d84/32e/a82d8432e8095d19b4f651894b5ff155.jpg"></div><br> 在我的示例中，完成的网格和点/摄像机SFM都有一层。 有时，网格的平滑步骤可能会比必要时稍微激进一些，因此比较原始网格和平滑网格很有用。 如果网格看起来破裂，可以方便地使用来自PLY的sfm数据和来自OBJ的网格来跟踪管道中的问题。 <br><br>  <strong>致谢</strong> <br><br> 没有<i>AliceVision</i>和<i>OpenMVG</i>的开发团队的<i>帮助</i> ，这篇文章将不完整。 灵感来源是<i>libmv</i>项目。 这个项目是<i>OpenMVG</i>的前身， <i>OpenMVG</i>是计算机视觉工程师/研究人员用于开发新算法的存储库。  <i>AliceVision</i>是<i>OpenMVG</i>的分支，专门用于将这些算法转换为成品形式的独立解决方案。 <br><br>  <i>AliceVision / Meshroom</i>是一个雄心勃勃的大型开源项目。 他的主要成就是通过如此认真的项目完成了这样的最终项目，我们对他有很多贡献。 我们还要感谢<i>OpenMVG</i>团队（和<i>libmv</i> ），他们的基础工作使<i>AliceVision</i>得以<i>创建</i> 。 <br><br> 最后，我要特别感谢Microsoft的<i>VCPKG</i> 。  <i>VCPKG</i>是一个程序包管理器，极大地简化了Windows大型开源项目的组装。 几年前，我尝试在Windows下构建<i>OpenMVG</i> 。 结局不是很好。 因此，几个月前，当我听说<i>AliceVision</i>时，我曾尝试对其进行编译，但即使使用简单的东西也失败了。 然后，我尝试了<i>VCPKG</i> ，一切都<i>立即生效</i> 。 很难量化使用<i>VCPKG之</i>类的项目的优势，但它确实为Windows的开源生态系统提供了帮助。 <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">github.com/alicevision</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">github.com/openMVG/openMVG</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">github.com/libmv/libmv</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">github.com/Microsoft/vcpkg</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN422807/">https://habr.com/ru/post/zh-CN422807/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN422797/index.html">我们如何用常规IP摄像机制作小型云录像机</a></li>
<li><a href="../zh-CN422799/index.html">Microsoft如何隐藏整个服务器以及如何找到它</a></li>
<li><a href="../zh-CN422801/index.html">了解Kubernetes中的RBAC</a></li>
<li><a href="../zh-CN422803/index.html">仓储成本计算器，或我们如何打开“黑匣子”</a></li>
<li><a href="../zh-CN422805/index.html">快速退订Mail.Ru Mail中的邮件列表</a></li>
<li><a href="../zh-CN422809/index.html">我的住所不是房屋或街道：21世纪的住所将是什么</a></li>
<li><a href="../zh-CN422811/index.html">敲响天堂：使用SAP Ariba管理云中的采购</a></li>
<li><a href="../zh-CN422815/index.html">Zextras将参加俄罗斯RedHat论坛2018</a></li>
<li><a href="../zh-CN422817/index.html">IFA 2018柏林未来电子展：过去</a></li>
<li><a href="../zh-CN422819/index.html">GosSOPKA的意思。 翻译术语</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>