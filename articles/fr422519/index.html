<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò± üë©üèø‚Äç‚öïÔ∏è üëá Distribution de billets de faveur: fils non frein√©s en Java. M√©tier √† projet üßëüèº üë®üèæ‚Äçü§ù‚Äçüë®üèª üë©üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Voulez-vous dans les threads Java qui ne mangent pas de m√©moire comme s'ils n'√©taient pas en eux-m√™mes et ne ralentissent pas? Bon cr√©dit, et ce probl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Distribution de billets de faveur: fils non frein√©s en Java. M√©tier √† projet</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/422519/"><p>  Voulez-vous dans les threads Java qui ne mangent pas de m√©moire comme s'ils n'√©taient pas en eux-m√™mes et ne ralentissent pas?  Bon cr√©dit, et ce probl√®me r√©pond √† cette question. </p><br><p>  Nous expliquons le travail de Project Loom sur les bo√Ætes √† pizza!  Allez! </p><br><p>  Tout cela est supprim√© et √©crit <b>sp√©cifiquement pour Habr</b> . </p><br><br><p><br clear="all"></p><a name="habracut"></a><br><h1 id="pozyvnye">  Indicatifs d'appel </h1><br><p>  Voyez-vous souvent cette image sur votre service Web: au d√©but, tout allait bien, puis un million de Chinois sont venus vers vous, le service a fait un million de fils et s'est noy√© en enfer? </p><br><p><img src="https://habrastorage.org/webt/ym/_-/3r/ym_-3rq8a8g56hsmrvjhprnih8y.png"><br><br></p><br><p>  Voulez-vous une si belle photo? </p><br><p><img src="https://habrastorage.org/webt/38/s-/04/38s-04z5nak6trs_p2lei9chjku.png"><br><br></p><br><p>  En d'autres termes, voulez-vous dans les threads Java qui ne mangent pas de m√©moire mais ne sont pas en eux-m√™mes et ne ralentissent pas?  Bon cr√©dit, et ce probl√®me r√©pond √† cette question. </p><br><p>  Nous allons, en fait, <em>d√©baller le nouveau cadre</em> .  Rappelez-vous comment Wylsacom a d√©ball√© les iPhones?  Certains ne se souviennent pas d√©j√† des anciens commentateurs, mais pourquoi?  Parce que Habr est un bastion traditionnel, et les vid√©os payantes sont, d√©sol√©es, les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rayons de la diarrh√©e</a> .  Dans cet article, nous traiterons exclusivement du hardcore technique. </p><br><p>  Tout d'abord, deux minutes pour les globes oculaires, l'avertissement et les autres d√©chets, qui doivent √™tre dit.  Vous pouvez l'ignorer si vous √™tes trop paresseux. </p><br><p>  Tout d'abord, tout ce qui est dit dans la vid√©o est ma pens√©e personnelle, et cela n'a rien √† voir avec l'employeur ou la glorieuse soci√©t√© Oracle, le gouvernement mondial des l√©zards et une fichue chose dans un mortier.  J'√©cris m√™me ceci √† trois heures du matin pour qu'il soit clair que c'est mon initiative personnelle, mes ordures personnelles.  <em>Tous les matchs sont purement al√©atoires.</em> </p><br><p>  Mais il y a un autre objectif bonus.  Nous parlons constamment de coroutines √† Kotlin.  R√©cemment, il y a eu des entretiens avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Roma Elizarov</a> , le dieu de Corutin, et avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pasha Finkelstein</a> , qui va leur √©crire des backends.  Bient√¥t, il y aura une interview d'Andrei Breslav - qui est le p√®re de Kotlin.  Et partout, le projet Loom est mentionn√© d'une mani√®re ou d'une autre, car il s'agit d'un analogue de la coroutine.  Et si vous ne savez pas ce qu'est Loom, vous pourriez devenir stupide en lisant ces interviews.  Il y a des mecs sympas, ils discutent de choses sympas.  Et vous y √™tes, et vous n'√™tes pas avec eux, schmuck.  C'est vraiment stupide. </p><br><p>  Ne faites pas √ßa, lisez ce qu'est Loom dans cet article, ou regardez cette vid√©o plus loin, je vais tout vous expliquer. </p><br><p>  Alors, quelle est la complication.  Il y a un tel mec, Ron Presler. </p><br><br><p><img src="https://habrastorage.org/webt/w-/tq/ut/w-tqutfyx33olnhdavtq_asdv9u.png"><br><br></p><br><p>  L'ann√©e derni√®re, il <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">est all√© sur la liste de diffusion</a> , a d√©clar√© que les threads en Java √©taient nuls et lui a sugg√©r√© d'ex√©cuter le runtime et de le corriger.  Et tout le monde se moquait de lui et jetait des pierres, de la merde, sinon pour le fait qu'il avait √©crit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Quasar</a> plus t√¥t, et c'est en fait tr√®s cool.  Vous pouvez jurer sur Quasar pendant longtemps, mais il semble √™tre l√† et cela fonctionne, et dans l'ensemble, c'est probablement un exploit. </p><br><p>  Il y a beaucoup de govnokodery qui ne font rien, dites-le.  Eh bien, faites-le bien, je suis le m√™me.  Ou il y a des gens qui semblent √™tre des ing√©nieurs sympas, mais en g√©n√©ral dans l'inconscient, ils disent ceci: "En Java, vous devez am√©liorer les threads."  Que faut-il am√©liorer?  Quels sont les fils? </p><br><p>  Les gens sont g√©n√©ralement trop paresseux pour penser. </p><br><p>  Comme dans une blague: <br>  Petka et Vasily Ivanovich volent dans un avion. <br>  Vasily Ivanovich demande: - Petka, appareils? <br>  Petka r√©pond: - 200! <br>  Vasily Ivanovich: - Et qu'en est-il de 200? <br>  Petka: - Et les √©lectrom√©nagers? </p><br><p>  Je vais raconter une histoire.  J'√©tais en Ukraine ce printemps, nous avons pris l'avion depuis la Bi√©lorussie (vous comprenez pourquoi c'est impossible directement depuis Saint-P√©tersbourg).  Et √† la douane, nous nous sommes assis pendant environ deux heures, rien de moins.  Les agents des douanes sont tr√®s gentils, ont demand√© s√©rieusement si Java est une technologie obsol√®te.  Des gens assis √† proximit√© qui volent vers le m√™me konf.  Et je suis un type de conf√©rencier, je dois jouer un coup de pied, me tenir debout et, comme pr√©vu, parler sans vergogne de choses que je n'utilise pas du tout.  Et en cours de route, il a parl√© de la distribution JDK appel√©e Liberica, c'est un tel JDK pour le Raspberry Pi. </p><br><p>  Et qu'en pensez-vous.  Pas m√™me six mois ne s'√©coulent avant que les gens frappent sur mon chariot et disent que, √©coutez, nous avons d√©pos√© une solution dans Liber sur la prod, et j'ai d√©j√† un rapport √† ce sujet au jfuture.by konf bi√©lorusse.  Telle est l'approche.  Ce n'est pas un mauvais √©vang√©liste, mais un mec, un ing√©nieur normal. </p><br><blockquote>  Soit dit en passant, nous aurons bient√¥t une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">conf√©rence Joker 2018</a> , qui comprendra √† la fois <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Andrei Breslav</a> (√©videmment en fouillant dans les coroutines), et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pasha Finkelshtein</a> , et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Josh Long</a> peut √™tre interrog√© sur le soutien de Spring √† Loom.  Eh bien, et un tas d'experts √©minents cool, allez! </blockquote><p>  Et maintenant, revenons aux discussions.  Les gens essaient de se faire une id√©e √† travers leurs deux neurones d√©grad√©s, comme la morve enroul√©e sur leur poing, et marmonnent: "En Java, les threads ne sont pas comme √ßa, en Java, les threads ne sont pas comme √ßa."  Appareils!  Quels appareils?  C'est g√©n√©ralement l'enfer. </p><br><p>  Et voici Presler, un mec normal et non d√©grad√©, et au d√©but, il fait une description sens√©e.  Un an plus tard, j'ai vu une d√©mo de travail.  J'ai dit tout cela pour que vous compreniez qu'une description normale des probl√®mes, une documentation normale est un tel h√©ro√Øsme d'un genre sp√©cial.  Et la d√©mo est g√©n√©ralement de l'espace.  C'est la premi√®re personne √† avoir fait quoi que ce soit dans ce sens.  Il en a le plus besoin. </p><br><p>  Avec la d√©mo, Presler a pris la parole lors de la conf√©rence et a publi√© cette vid√©o: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/J31o0ZMQEnI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  En fait, tout cet article est un examen de ce qui a √©t√© dit l√†-bas.  Je ne pr√©tends pas du tout √† l'unicit√© de ce mat√©riau, tout ce qui se trouve dans cet article a √©t√© invent√© par Ron. </p><br><p>  La discussion porte sur trois sujets douloureux: </p><br><ul><li>  Continations </li><li>  Les fibres </li><li>  Appels de queue </li></ul><br><p>  Probablement, il √©tait tellement √©coeur√© en sciant Quasar et en se battant avec ses p√©pins qu'il n'y a pas de force - vous devez le mettre en phase d'ex√©cution. </p><br><p>  C'√©tait il y a un an, et depuis lors, ils ont sci√© un prototype.  Certains ont d√©j√† perdu espoir de voir un jour une d√©mo, mais il y a un mois, ils y ont donn√© naissance et ont montr√© ce qui est visible <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur ce tweet</a> . </p><br><br><p><img src="https://habrastorage.org/webt/ck/hp/mc/ckhpmcchdv2k6_4vfbw733evg6c.png"><br><br></p><br><p>  Les trois sujets douloureux de cette d√©mo sont soit directement dans le code, soit au moins moralement pr√©sents.  Eh bien, oui, ils n'ont pas encore ma√Ætris√© les appels de queue, mais ils le veulent. </p><br><h1 id="problematika">  Probl√®me </h1><br><p>  Les utilisateurs m√©contents, les d√©veloppeurs d'applications, lorsqu'ils cr√©ent une API, sont oblig√©s de choisir entre deux chaises.  Les pics sont int√©gr√©s sur une chaise, les fleurs poussent sur l'autre.  Et ni l'un ni l'autre ne nous conviennent. </p><br><br><p><img src="https://habrastorage.org/webt/tn/nx/k-/tnnxk-iwzuj7sybfwllour9qozq.png"><br><br></p><br><p>  Par exemple, si vous √©crivez un service qui fonctionne de mani√®re synchrone, il fonctionne tr√®s bien avec le code h√©rit√©, il est facile de d√©boguer et de surveiller les performances.  Des probl√®mes surgiront avec la bande passante et l'√©volutivit√©.  Tout simplement parce que le nombre de threads que vous pouvez d√©sormais ex√©cuter sur un simple mat√©riel, sur du mat√©riel de base - disons, deux mille.  C'est beaucoup moins que le nombre de connexions qui pourraient √™tre ouvertes sur ce serveur.  Ce qui du point de vue du netcode peut √™tre presque sans fin. </p><br><p>  (Eh bien, oui, cela a quelque chose √† voir avec le fait que les sockets en Java sont arrang√©s idiotes, mais c'est un sujet pour une autre conversation) </p><br><p>  Imaginez que vous √©crivez une sorte de MMO. </p><br><br><p><img src="https://habrastorage.org/webt/ye/mg/pm/yemgpm6on0pidozkhmco3epwapa.png"><br><br></p><br><p>  Par exemple, pendant la guerre du Nord dans EVE Online, deux mille quatre cents pilotes se sont rassembl√©s √† un point dans l'espace, chacun d'eux - conditionnellement, s'il √©tait √©crit en Java - ne serait pas un fil, mais plusieurs.  Et le pilote, bien s√ªr, est une logique m√©tier complexe, et non la publication d'un code HTML qui peut √™tre exclu √† la main dans une loupe. </p><br><p>  Le temps de r√©ponse dans cette bataille a √©t√© si long que le joueur a d√ª attendre quelques minutes pour attendre le tir.  Pour autant que je sache, CCP sp√©cifiquement pour cette bataille a jet√© les √©normes ressources mat√©rielles de son cluster. </p><br><p>  Bien que, je cite probablement EVE comme exemple en vain, car, pour autant que je comprends, tout est √©crit en Python, et en Python avec multithreading, il est encore pire que le n√¥tre - et nous pouvons consid√©rer une mauvaise concurrence des fonctionnalit√©s du langage.  Mais alors l'exemple est clair et avec des photos. </p><br><p>  Si vous √™tes int√©ress√© par le sujet de l'OMI en g√©n√©ral et l'histoire de la ¬´guerre du Nord¬ª en particulier, r√©cemment une tr√®s bonne vid√©o sur ce sujet est apparue sur la cha√Æne Bulzhat (quel que soit son nom), regardez depuis mon horodatage. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/AkAtiTNvjz8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Nous revenons au sujet. </p><br><p>  D'un autre c√¥t√©, vous pouvez utiliser une sorte de framework asynchrone.  Il est √©volutif.  Mais nous tomberons imm√©diatement dans un d√©bogage tr√®s difficile, un profilage compliqu√© de la performance, nous ne pourrons pas l'int√©grer de mani√®re transparente avec l'h√©ritage, vous devrez r√©√©crire beaucoup de choses, les envelopper dans des emballages abominables et avoir g√©n√©ralement l'impression que nous venons d'√™tre viol√©s.  Plusieurs fois de suite.  Pendant des jours, en fait, tout le temps que nous √©crivons ceci, vous devrez vous sentir comme √ßa. </p><br><p>  J'ai demand√© √† l'expert, le c√©l√®bre acad√©micien Escobar, ce qu'il en pensait: </p><br><br><p><img width="300" src="https://habrastorage.org/webt/7g/hf/mg/7ghfmg3x8aqhdl0jcyrbpairqsc.png"><br><br></p><br><p>  Que faire?  Les soi-disant faybers se pr√©cipitent √† la rescousse. </p><br><p>  Dans le cas g√©n√©ral, les fibres sont de tels fils l√©gers qui fouillent √©galement dans l'espace d'adressage (car les miracles ne se produisent pas, vous comprenez).  Mais contrairement aux threads ordinaires, ils n'utilisent pas le multit√¢che pr√©emptif, mais le multit√¢che coop√©ratif.  En savoir plus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur Wikipedia</a> . </p><br><p>  La fibre peut r√©aliser les avantages de la programmation synchrone et asynchrone.  Par cons√©quent, l'utilisation du fer est augment√©e et nous utilisons moins de serveurs dans le cluster pour la m√™me t√¢che.  Eh bien, dans notre poche pour cela, nous obtenons de la lavande.  Babos.  Lave.  L'argent.  Eh bien, vous obtenez le point.  Pour le serveur enregistr√©. </p><br><h1 id="na-raspute">  √Ä la crois√©e des chemins </h1><br><p>  La premi√®re chose que je veux discuter.  Les gens ne comprennent pas la diff√©rence entre les continuations et la fibre. <br>  Maintenant, il y aura une illumination culte! </p><br><p>  Nous allons annoncer le fait: la poursuite et la fibre sont deux choses diff√©rentes. </p><br><h1 id="continuations">  Continuations </h1><br><p>  Les fibres sont construites au sommet d'un m√©canicien appel√© Continuations. </p><br><p>  Les continuations (plus pr√©cis√©ment, les continuations d√©limit√©es) sont une sorte de calcul, d'ex√©cution, un morceau de programme qui peut s'endormir, puis se r√©veiller et continuer l'ex√©cution depuis l'endroit o√π il s'est endormi.  Il peut m√™me parfois √™tre clon√© ou s√©rialis√©, m√™me pendant qu'il dort. </p><br><p>  J'utiliserai le mot ¬´continuation¬ª, et non ¬´continuation¬ª (comme il est √©crit sur Wikip√©dia), car nous communiquons tous en <em>anglais</em> .  En utilisant la terminologie russe normale, on peut facilement arriver √† une situation o√π la diff√©rence entre le terme russe et l'anglais devient trop grande et personne d'autre ne comprend le sens de ce qui a √©t√© dit. </p><br><p>  J'utiliserai √©galement parfois le mot ¬´crowding out¬ª au lieu de la version anglaise de ¬´yield¬ª.  Juste le mot "c√©der" - c'est une sorte de vraiment m√©chant.  Il y aura donc ¬´√©viction¬ª. </p><br><p>  Alors voil√†.  Il est tr√®s important qu'il n'y ait pas de concurrence dans le continuum.  C'est en soi la primitive minimale de ce processus. </p><br><p> Vous pouvez consid√©rer la continuation comme un <code>Runnable</code> , √† l'int√©rieur duquel vous pouvez appeler la m√©thode <code>pause()</code> .  C'est √† l'int√©rieur et directement, car notre multit√¢che est coop√©ratif.  Et puis vous pouvez l'ex√©cuter √† nouveau, et au lieu de tout recalculer, il continuera l√† o√π il s'√©tait arr√™t√©.  Ce genre de magie.  Nous reviendrons √† la magie. </p><br><p>  O√π obtenir une d√©mo avec des suites de travail - nous discuterons √† la toute fin.  Parlons maintenant de ce qui existe. </p><br><p>  La classe de continuation elle-m√™me est situ√©e sur java.base, tous les liens seront dans la description.  ( <code>src/java.base/share/classes/java/lang/Continuation.java</code> ).  Mais cette classe est tr√®s grande, volumineuse, il est donc logique de ne regarder que quelque sorte de compression. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Continuation</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Runnable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Continuation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContinuationScope scope, Runnable body)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yield</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContinuationScope scope)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isDone</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPinned</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Reason reason)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"Pinned: "</span></span> + reason); } }</code> </pre> <br><p>  Notez qu'en fait ce fichier est en constante √©volution.  Par exemple, √† la veille, la poursuite n'a pas impl√©ment√© l'interface <code>Runnable</code> .  Traitez cela comme une sorte d'esquisse. </p><br><p>  Jetez un oeil au constructeur.  <code>body</code> - c'est le code que vous essayez d'ex√©cuter, et <code>scope</code> - est une sorte de skop qui vous permet d'imbriquer des continuations dans des continuations. </p><br><p>  En cons√©quence, vous pouvez soit planifier ce code √† la fin avec la m√©thode <code>run</code> , soit le remplacer par un tableau sp√©cifique en utilisant la m√©thode <code>yield</code> (le tableau est n√©cessaire ici pour quelque chose comme le transfert d'actions aux gestionnaires imbriqu√©s, mais nous ne nous soucions pas en tant qu'utilisateurs).  Vous pouvez demander √† l'aide de la m√©thode <code>isDone</code> si tout est termin√© jusqu'√† la fin. </p><br><p>  Et pour des raisons dict√©es uniquement par les besoins de l'impl√©mentation actuelle (mais tr√®s probablement, elle sera √©galement incluse dans la version), il n'est pas toujours possible de faire du <code>yield</code> .  Par exemple, si √† l'int√©rieur de la suite nous avons eu une transition vers le code natif et qu'un cadre natif est apparu sur la pile, alors il est impossible de se coincer.  Cela se produira √©galement si vous essayez de vous √©vincer pendant qu'un moniteur natif, tel qu'une m√©thode synchronis√©e, est pris √† l'int√©rieur du corps du continuum.  Par d√©faut, lorsque vous essayez de simuler cela, une exception est lev√©e ... mais les fibres construites au-dessus des suites surchargent cette m√©thode et font autre chose.  Ce sera un peu plus tard. </p><br><p>  Vous pouvez l'utiliser de la mani√®re suivante: </p><br><pre> <code class="java hljs">Continuation cont = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Continuation(SCOPE, () -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { System.out.println(<span class="hljs-string"><span class="hljs-string">"before"</span></span>); Continuation.yield(SCOPE); System.out.println(<span class="hljs-string"><span class="hljs-string">"after"</span></span>); } }); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!cont.isDone()) { cont.run(); }</code> </pre> <br><p>  Ceci est un exemple de la pr√©sentation de Presler.  Encore une fois, ce n'est pas un code "trivial", c'est une sorte de croquis. </p><br><p>  Ceci est une esquisse de ce que nous faisons continuation, au milieu de cette continuation nous sommes √©vinc√©s puis dans un cycle sans fin nous demandons si la continuation a fonctionn√© jusqu'au bout et si elle doit √™tre poursuivie. </p><br><p>  Mais en g√©n√©ral, il n'est pas pr√©vu que les programmeurs d'applications ordinaires se rapportent √† cette API.  Il est destin√© aux cr√©ateurs de frameworks syst√®me.  Les frameworks de formation de syst√®mes comme le Spring Framework adopteront imm√©diatement cette fonctionnalit√© d√®s sa sortie.  Tu verras.  Consid√©rez ceci comme une pr√©diction.  Une telle pr√©diction l√©g√®re, car tout est assez √©vident ici.  Toutes les donn√©es de pr√©diction sont.  Cette fonctionnalit√© est trop importante pour ne pas s'adapter.  Par cons√©quent, il n'est pas n√©cessaire de s'inqui√©ter √† l'avance que quelqu'un vous torture avec l'encodage sous cette forme.  Eh bien, si vous √™tes un d√©veloppeur Spring, vous saviez ce que vous faisiez. </p><br><p>  Et maintenant, en plus des suites, des fibres sont construites. </p><br><h1 id="fibers">  Les fibres </h1><br><p>  Alors, ce qui dans notre cas signifie fibre. <br><br>  C'est une sorte d'abstraction, qui est: </p><br><ul><li>  Threads l√©gers trait√©s dans la JVM elle-m√™me, et non dans le syst√®me d'exploitation; </li><li>  Avec des frais g√©n√©raux extr√™mement bas pour cr√©er, maintenir la vie, changer de t√¢che; </li><li>  Qui peut √™tre ex√©cut√© des millions de fois. </li></ul><br><p>  De nombreuses technologies tentent de fabriquer la fibre d'une mani√®re ou d'une autre.  Par exemple, dans Kotlin, il existe des coroutines impl√©ment√©es sur une g√©n√©ration de bytecode tr√®s intelligente.  <em>TR√àS INTELLIGENT</em> .  Mais le runtime est un meilleur endroit pour impl√©menter de telles choses. </p><br><p>  Au minimum, la JVM sait d√©j√† bien g√©rer les threads, et tout ce que nous devons faire est de rationaliser le processus de codage pour le multithreading.  Vous pouvez utiliser des API asynchrones, mais cela peut difficilement √™tre appel√© ¬´simplification¬ª: m√™me en utilisant des choses comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Reactor</a> , Spring Project Reactor, qui permettent d'√©crire du code apparemment lin√©aire, ne vous sera d'aucune utilit√© si vous devez d√©boguer des probl√®mes complexes. </p><br><p>  Donc fibre. </p><br><p>  La fibre se compose de deux composants.  C‚Äôest: </p><br><ul><li>  Continuation </li><li>  Planificateur </li></ul><br><p>  Soit: </p><br><ul><li>  Continuation </li><li>  Planificateur </li></ul><br><br><p><img src="https://habrastorage.org/webt/ga/wc/yk/gawcykupqgqwqjwfxcpccyltenu.jpeg"><br><br></p><br><p>  Vous pouvez d√©cider qui est le planificateur ici.  Je pense que le planificateur ici est Jay. </p><br><ul><li>  Fibre encapsule le code que vous souhaitez ex√©cuter dans une continuation </li><li>  Le planificateur les lance sur un pool de threads de support </li></ul><br><p>  <em>Je les appellerai des fils de support.</em> </p><br><br><br><p><img src="https://habrastorage.org/webt/j4/hc/gw/j4hcgwglzzsi6qe-cxczwcewohy.jpeg"><br><br></p><br><p>  Le prototype actuel utilise <code>java.util.concurrent.Executor</code> et le planificateur <code>ForkJoinPool</code> .  Nous avons tout.  √Ä l'avenir, quelque chose de plus intelligent pourrait y appara√Ætre, mais pour l'instant, comme √ßa. </p><br><p>  Comment se comporte la suite: </p><br><ul><li>  Il est √©vinc√© (rendement) lorsqu'un verrouillage se produit (par exemple, sur IO); </li><li>  Continue lorsque vous √™tes pr√™t √† continuer (par exemple, l'op√©ration d'E / S est termin√©e et vous pouvez continuer). </li></ul><br><p>  √âtat actuel des travaux: </p><br><ul><li>  L'accent principal sur la philosophie, les concepts; </li><li>  L'API n'est pas fixe, c'est "pour le show".  Ceci est un prototype de recherche; </li><li>  Il existe un prototype de travail cod√© pr√™t √† l'emploi de la classe <code>java.lang.Fiber</code> . </li></ul><br><p>  Il en sera question. </p><br><p>  Ce qui a d√©j√† √©t√© sci√© dans la fibre: </p><br><ul><li>  Il ex√©cute un lancement de t√¢che; </li><li>  Parking voiture non gar√© sur un transporteur; </li><li>  En attente de l'ach√®vement de la fibre. </li></ul><br><h1 id="principialnaya-shema">  Sch√©ma du circuit </h1><br><pre> <code class="java hljs">mount(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { cont.run(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> () { unmount(); }</code> </pre> <br><ul><li>  Nous pouvons monter une fibre sur un porte-fil; </li><li>  Ex√©cutez ensuite la suite; </li><li>  Et attendez qu'elle soit √©vinc√©e ou qu'elle s'arr√™te honn√™tement; </li><li>  Au final, on laisse toujours le fil. </li></ul><br><p>  Ce pseudo-code sera ex√©cut√© sur le <code>ForkJoinPool</code> ou sur un autre (qui finira par √™tre dans la version finale). </p><br><h1 id="ispolzovanie-v-realnosti">  Utilisation en r√©alit√© </h1><br><pre> <code class="java hljs">Fiber f = Fiber.execute( () -&gt; { System.out.println(<span class="hljs-string"><span class="hljs-string">"Good Morning!"</span></span>); readLock.lock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { System.out.println(<span class="hljs-string"><span class="hljs-string">"Good Afternoon"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { readLock.unlock(); } System.out.println(<span class="hljs-string"><span class="hljs-string">"Good Night"</span></span>); });</code> </pre> <br><p>  Regardez, nous cr√©ons une fibre dans laquelle: </p><br><ul><li>  bienvenue √† tous; </li><li>  nous bloquons le loke r√©entrant; </li><li>  √† votre retour, f√©licitations pour votre d√©jeuner; </li><li>  lib√©rer enfin le verrou; </li><li>  et dis au revoir. </li></ul><br><p>  Tout est tr√®s simple. </p><br><p>  Nous n'engendrons pas directement le surpeuplement.  Project Loom lui-m√™me sait que lorsque <code>readLock.lock();</code> d√©clench√© <code>readLock.lock();</code>  il devrait intervenir et faire implicitement de la r√©pression.  L'utilisateur ne voit pas cela, mais cela se produit l√†-bas. </p><br><h1 id="steki-povsyudu-steki">  Des piles, des piles partout! </h1><br><p>  Montrons ce qui se passe en utilisant la pile de pizza comme exemple. </p><br><p>  Au d√©but, le thread porteur est dans un √©tat d'attente et rien ne se produit. </p><br><p><img src="https://habrastorage.org/webt/8y/gw/mr/8ygwmr7dc_owazfdj-wa4trrs4g.png"><br><br></p><br><p>  Haut de la pile en haut, rappelez-vous. </p><br><p>  L'ex√©cution de la fibre a ensuite √©t√© planifi√©e et la t√¢che de fibre a commenc√© √† s'ex√©cuter. </p><br><p><img src="https://habrastorage.org/webt/pd/ya/mn/pdyamn0chhcnelgtphtxeg6eniq.png"><br><br></p><br><p>  En lui-m√™me, il lance √©videmment une suite, dans laquelle le vrai code est d√©j√† localis√©. </p><br><p><img src="https://habrastorage.org/webt/33/nw/fb/33nwfb3dz0klj1oiog21iegsbuy.png"><br><br></p><br><p>  Du point de vue de l'utilisateur, nous n'avons encore rien lanc√© ici. </p><br><p>  Ce n'est que la premi√®re image du code utilisateur apparue sur la pile, et elle est marqu√©e en violet. </p><br><p>  En outre, le code est ex√©cut√©, ex√©cut√©, √† un moment donn√©, la t√¢che tente de capturer le verrou et de le bloquer, ce qui conduit √† un √©viction automatique. </p><br><p><img src="https://habrastorage.org/webt/vv/lk/ah/vvlkahftvyuefpupb4fyidb5gdq.png"><br><br></p><br><p>  Tout ce qui se trouve sur la pile de continuation est stock√© dans un certain endroit magique.  Et dispara√Æt. </p><br><p><img src="https://habrastorage.org/webt/hz/oq/6n/hzoq6nmzmezadhp8-ntn6_qerxk.png"><br><br></p><br><p>  Comme vous pouvez le voir, le flux revient √† la fibre, √† l'instruction qui suit <code>Continuation.run</code> .  Et c'est la fin du code fibre. </p><br><p>  La t√¢che de fibre se termine, le support m√©dia attend un nouveau travail. </p><br><p><img src="https://habrastorage.org/webt/l4/nt/k9/l4ntk9qfl8dpcamol4ufahy8sa0.png"><br><br></p><br><p>  La fibre est gar√©e, quelque part se trouve, le continuum est compl√®tement √©vinc√©. </p><br><p>  T√¥t ou tard, le moment vient o√π celui qui poss√®de la serrure la lib√®re. <br>  Cela conduit au fait que la fibre, qui attendait la lib√©ration du verrou, est d√©ball√©e.  La t√¢che de cette fibre recommence. </p><br><ul><li>  Reentrantlock.unlock </li><li>  Locksupport.unpark </li><li>  Fiber.unpark </li><li>  ForkJoinPool.execute </li></ul><br><p>  Et nous retournons rapidement √† la pile, qui √©tait r√©cemment. </p><br><p><img src="https://habrastorage.org/webt/hz/oq/6n/hzoq6nmzmezadhp8-ntn6_qerxk.png"><br><br></p><br><p>  De plus, le fil porteur peut √™tre compl√®tement diff√©rent.  Et cela a du sens! </p><br><p>  Ex√©cutez √† nouveau la suite. </p><br><p><img src="https://habrastorage.org/webt/ll/c-/mx/llc-mxgfttlpleiqtprwm6igcju.png"><br><br></p><br><p>  Et voici la MAGIE !!!  La pile est restaur√©e et l'ex√©cution se poursuit avec l'instruction apr√®s <code>Continuation.yield</code> . </p><br><p><img src="https://habrastorage.org/webt/la/4t/pp/la4tppjy2spiy4_auvwdikgm8nu.png"><br><br></p><br><p>  Nous rampons hors du verrou juste parqu√© et commen√ßons √† ex√©cuter tout le code restant dans la suite: </p><br><p><img src="https://habrastorage.org/webt/yt/ce/ht/ytcehtff1fomwn5cehnzkegzpts.png"><br><br></p><br><p>  La t√¢che utilisateur se termine et le contr√¥le revient √† la t√¢che fibre imm√©diatement apr√®s l'instruction continuation.run </p><br><p><img src="https://habrastorage.org/webt/sz/m8/cc/szm8ccxgwntcgjzwqcl_gcernqg.png"><br><br></p><br><p>  Dans le m√™me temps, l'ex√©cution de la fibre se termine, et nous nous retrouvons √† nouveau en mode veille. </p><br><p><img src="https://habrastorage.org/webt/l4/nt/k9/l4ntk9qfl8dpcamol4ufahy8sa0.png"><br><br></p><br><p>  Le prochain lancement de la fibre amorce √† nouveau tout le cycle de renaissances d√©crit ci-dessus. </p><br><p><img src="https://habrastorage.org/webt/c7/z9/wm/c7z9wmktfbsithnlvyuea4mtqki.jpeg"><br><br></p><br><h1 id="zhivye-primery">  Exemples en direct </h1><br><p>  Et qui a d√©j√† dit que tout cela fonctionne?  S'agit-il de quelques microbenchmarks √©crits au cours de la soir√©e? </p><br><p>  √Ä titre d'exemple du fonctionnement des p√©tards, les Oraklovites ont √©crit un petit serveur Web et l'ont aliment√© en requ√™tes pour qu'il s'√©touffe.  Ensuite, ils ont √©t√© transf√©r√©s sur fibre.  Le serveur a cess√© de s'√©touffer et nous en avons conclu que les fibres fonctionnent. </p><br><p>  Je n'ai pas le code exact pour ce serveur, mais si cet article obtient suffisamment de likes et de commentaires, j'essaierai d'√©crire un exemple moi-m√™me et de cr√©er de vrais graphiques. </p><br><h1 id="problemy">  Les probl√®mes </h1><br><p>  Y a-t-il des probl√®mes ici?  Oui bien s√ªr!  Toute l'histoire des faybers est une histoire de probl√®mes et de compromis continus. </p><br><h2 id="filosofskie-problemy">  Probl√®mes philosophiques </h2><br><ul><li>  Faut-il r√©inventer les fils? </li><li>  <em>Tout</em> le code existant devrait-il fonctionner correctement √† l'int√©rieur de la fibre? </li></ul><br><p>  Le prototype actuel fonctionne avec des limitations.  Ce qui peut entrer dans la version, bien que je ne le veuille pas.  Pourtant, OpenJDK est une chose qui respecte la compatibilit√© sans fin. </p><br><p>  Quelles sont les limitations techniques?  Les limitations les plus √©videntes sont 2 pi√®ces. </p><br><h2 id="problema-raz--nelzya-vytesnit-nativnye-freymy">  Le probl√®me est une fois - vous ne pouvez pas remplacer les cadres natifs </h2><br><pre> <code class="java hljs">PrivilegedAction&lt;Void&gt; pa = () -&gt; { readLock.lock(); <span class="hljs-comment"><span class="hljs-comment">// may park/yield try { // } finally { readLock.unlock(); } return null; } AccessController.doPrivileged(pa); //native method</span></span></code> </pre> <br><p>  Ici, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">doPrivileged</a> appelle la m√©thode native. </p><br><p>  Vous appelez <code>doPrivileged</code> , sautez hors de la machine virtuelle, un cadre natif appara√Æt sur votre pile, apr√®s quoi vous essayez de vous garer sur la ligne <code>readLock.lock()</code> .  Et √† ce moment-l√†, le fil porteur sera tach√© jusqu'√† ce qu'il soit d√©croch√©.  Autrement dit, le fil dispara√Æt.  Dans ce cas, les fils porteurs peuvent se terminer, et en g√©n√©ral, cela rompt toute l'id√©e de fibre. </p><br><p>  La mani√®re de r√©soudre ce probl√®me est d√©j√† connue et des discussions sont en cours √† ce sujet. </p><br><h2 id="problema-dva---synchronized-bloki">  Probl√®me deux - blocs synchronis√©s </h2><br><p>  Ce sont des ordures beaucoup plus graves </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (object) { <span class="hljs-comment"><span class="hljs-comment">//may park object.wait(); //may park }</span></span></code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (object) { <span class="hljs-comment"><span class="hljs-comment">//may park socket.getInputStream().read(); //may park }</span></span></code> </pre> <br><p>  En cas de capture du moniteur dans la fibre, les fils du support d√©marrent √©galement. </p><br><p>  Il est clair que dans un code compl√®tement nouveau, vous pouvez changer les moniteurs en verrous directs, au lieu d'attendre + de notifier, vous pouvez utiliser des objets de condition, mais que faire de l'h√©ritage?  C'est un probl√®me. </p><br><h1 id="thread-api-threadcurrentthread-thread-locals">  API de thread?  Thread.currentThread ()?  Thread locaux? </h1><br><p>  Dans le prototype actuel, <code>Thread</code> et <code>Fiber</code> ont cr√©√© une superclasse commune appel√©e <code>Strand</code> . </p><br><p>  Cela vous permet de transf√©rer l'API de la mani√®re la plus minimale. <br>  Que faire ensuite - comme toujours dans ce projet, est une question. </p><br><p>  Que se passe-t-il avec l'API Thread maintenant? </p><br><ul><li>  La premi√®re utilisation de <code>Thread.currentThread()</code> dans une fibre cr√©e une sorte de thread fant√¥me, Shadow Thread; </li><li>  du point de vue du syst√®me, il s'agit d'un thread ¬´non publi√©¬ª, et il n'y a aucune m√©ta-information VM dedans; </li><li>  ST essaie d'imiter tout ce qu'il peut; </li><li>  mais vous devez comprendre que l'ancienne API a beaucoup de d√©chets; </li><li>  plus sp√©cifiquement, Shadow Thread impl√©mente l'API Thread pour tout sauf <code>stop</code> , <code>suspend</code> , <code>resume</code> et g√©rer les exceptions non intercept√©es. </li></ul><br><p>  Que faire des sections locales de threads? </p><br><ul><li>  maintenant les sections locales de fil se transforment en sections locales de fibre; </li><li>  il y a beaucoup de probl√®mes avec cela, tout cela est en discussion; </li><li>  un ensemble d'utilisations est particuli√®rement discut√©; </li><li>  Les threads ont historiquement utilis√© √† la fois correctement et incorrectement (ceux qui utilisent incorrectement esp√®rent toujours quelque chose, et vous ne pouvez pas les d√©cevoir compl√®tement); </li><li>  en g√©n√©ral, cela cr√©e toute une gamme d'applications: <br><ul><li>  Haut niveau: cache des connexions ou des mots de passe dans le conteneur; </li><li>  Bas niveau: processeur dans les biblioth√®ques syst√®me. </li></ul></li></ul><br><h1 id="skolko-vse-eto-zhret">  Combien tout cela mange </h1><br><p><img src="https://habrastorage.org/webt/pl/7-/pi/pl7-pidz-d2o3l98qx2srbmezxi.png"><br><br></p><br><p>  Discussion: </p><br><ul><li>  Pile: 1 Mo et 16 Ko sur les structures de donn√©es du noyau; </li><li>  Par instance de thread: 2300 octets, y compris les m√©ta-informations VM. </li></ul><br><p>  Fibre: </p><br><ul><li>  Pile de continuation: de centaines d'octets √† kilo-octets; </li><li>  Par instance de fibre: 200-240 octets. </li></ul><br><p>  La diff√©rence est √©norme! <br>  Et c‚Äôest exactement ce qui permet √† des millions de personnes de s‚Äôactiver. </p><br><h1 id="chto-mozhet-parkovatsya">  Que peut garer </h1><br><p>  Il est clair que la chose la plus magique est le stationnement automatique lorsque certains √©v√©nements se produisent.  Qu'est-ce qui est actuellement pris en charge? </p><br><ul><li>  Thread.sleep, rejoignez; </li><li>  java.util.concurrent et LockSupport.lock; </li><li>  IO: r√©seau sur sockets (socket lire, √©crire, connecter, accepter), fichiers, tubes; </li><li>  Tout cela n'est pas termin√©, mais la lumi√®re dans le tunnel est visible. </li></ul><br><h1 id="kommunikaciya-mezhdu-fayberami">  Communication entre fibre </h1><br><p>  Une autre question que tout le monde se pose est: comment √©changer de mani√®re comp√©titive des informations entre les fibres. </p><br><ul><li>  Le prototype actuel lance des t√¢ches dans <code>Runnable</code> , peut √™tre converti en <code>CompletableFuture</code> , si pour une raison quelconque vous en avez besoin; </li><li>  java.util.concurrent "fonctionne juste."  Vous pouvez tout t√¢tonner de mani√®re standard; </li><li>  il peut y avoir de nouvelles API pour le multithreading, mais ce n'est pas exact; </li><li>  un tas de petites questions comme ¬´les fibres devraient-elles renvoyer des valeurs?¬ª;  tout est discut√©, ils ne sont pas dans le prototype. </li></ul><br><h1 id="kak-realizovany-kontinuacii-v-prototipe">  Comment les suites sont-elles impl√©ment√©es dans le prototype? </h1><br><p>  Des exigences √©videntes sont impos√©es √† la suite: vous devez utiliser le moins de RAM possible et vous devez basculer entre elles le plus rapidement possible.  Sinon, cela ne fonctionnera pas pour les garder par millions.  La t√¢che principale ici est en quelque sorte de ne pas faire une copie compl√®te de la pile pour chaque parking-uppark.  Et il y a un tel sch√©ma!  Essayons d'expliquer cela dans les images. </p><br><p>  La fa√ßon la plus cool serait, bien s√ªr, de simplement mettre toutes les piles sur une hanche java et de les utiliser directement.  Mais il n'est pas clair comment coder maintenant, donc le prototype utilise la copie.  Mais copier avec un petit mais important hack. </p><br><p>  Nous avons deux chaises ... Je veux dire, deux piles.  Deux tableaux java dans la hanche.  L'un est un tableau d'objets, o√π nous stockons les r√©f√©rences aux objets.  Le second est primitif (par exemple, intime), qui g√©rera tout le reste. </p><br><p><img src="https://habrastorage.org/webt/33/tf/cj/33tfcj897awloqfisxfwwl-4ypy.png"><br><br></p><br><p>  Nous sommes maintenant dans un √©tat o√π la poursuite est sur le point d'√™tre effectu√©e pour la toute premi√®re fois. </p><br><p>  <code>run</code> appelle une m√©thode interne appel√©e <code>enter</code> : </p><br><p><img src="https://habrastorage.org/webt/j6/d5/ki/j6d5kioz8ygupanxditl3iaslbi.png"><br><br></p><br><p>  Et puis le code utilisateur est ex√©cut√©, jusqu'au premier √©viction. </p><br><p><img src="https://habrastorage.org/webt/ab/on/6c/abon6cdsoepe-ts69pkmm9sk35i.png"><br><br></p><br><p>  √Ä ce stade, un appel VM est effectu√©, ce qui <code>freeze</code> appels.  Dans ce prototype, cela se fait directement physiquement - en utilisant la copie. </p><br><p><img src="https://habrastorage.org/webt/iu/or/jv/iuorjvmb6xrjnycvx3nxbdcqxxc.png"><br><br></p><br><p>  Nous commen√ßons le processus de copie s√©quentielle des images de la pile native vers java hip. </p><br><p><img src="https://habrastorage.org/webt/ln/nu/sm/lnnusmrix2hsqpwxmzkeemd_or0.png"><br><br></p><br><p>  Il est n√©cessaire de v√©rifier si les moniteurs y sont maintenus ou si le code natif est utilis√©, ou autre chose qui ne nous permettra vraiment pas de continuer √† travailler. </p><br><p><img src="https://habrastorage.org/webt/vl/5c/k0/vl5ck0i3jtouapded9snnl9brvy.png"><br><br></p><br><p>  Et si tout va bien, nous copions d'abord dans un tableau primitif: </p><br><p><img src="https://habrastorage.org/webt/ka/z_/gl/kaz_glkmthfyd1x8rzdprn3v8ym.png"><br><br></p><br><p>  Ensuite, nous isolons les r√©f√©rences aux objets et les enregistrons dans le tableau d'objets: </p><br><p><img src="https://habrastorage.org/webt/xc/2q/nb/xc2qnbafy_2eybwzif-3s3vmaym.png"><br><br></p><br><p>  En fait, deux th√©s √† tous ceux qui ont lu cet endroit! </p><br><p>  De plus, nous continuons cette proc√©dure pour tous les autres √©l√©ments de la pile native. </p><br><p><img src="https://habrastorage.org/webt/6e/sp/-0/6esp-07i4dyasxj5esb9qu6fh5i.png"><br><br></p><br><p>  Hourra!  Nous avons tout copi√© dans le nid dans la hanche.  Vous pouvez sauter en toute s√©curit√© sur le lieu de l'appel sans craindre que nous ayons perdu quelque chose.  Tout est branch√©. </p><br><p><img src="https://habrastorage.org/webt/bq/sz/ju/bqszjuffw-s4f14audafvzbmqzc.png"><br><br></p><br><p>  T√¥t ou tard, le code appelant appellera √† nouveau notre continuation.  Et elle doit continuer de l'endroit o√π elle a √©t√© laiss√©e la derni√®re fois.  Telle est notre t√¢che. </p><br><p><img src="https://habrastorage.org/webt/8i/bg/x9/8ibgx9r_26wedxrahar1vfqdifi.png"><br><br></p><br><p>  V√©rifier si la continuation √©tait en cours, dit oui, elle √©tait en cours.  Donc, vous devez appeler VM, nettoyer de l'espace sur la pile et appeler la fonction interne de <code>thaw</code> VM.  ¬´D√©gel¬ª est traduit en russe par ¬´d√©gel¬ª, ¬´d√©geler¬ª, ce qui semble assez logique.  Il est n√©cessaire de lib√©rer les images de la pile de continuation dans notre pile native principale. </p><br><p>  Je ne suis pas s√ªr que le d√©givrage du th√© soit assez clair.  La mauvaise abstraction est comme un chaton avec une porte.  Mais cela fera l'affaire pour nous. </p><br><p><img src="https://habrastorage.org/webt/ra/sv/5v/rasv5v_5w8_dpegomn_omgtdiza.png"><br><br></p><br><p>  Nous faisons des copies assez √©videntes. </p><br><p>  Tout d'abord avec un tableau primitif: </p><br><p><img src="https://habrastorage.org/webt/wc/he/vg/wchevg-fsflrnicy0itprkp0q2e.png"><br><br></p><br><p>  Puis √† partir du lien: </p><br><p><img src="https://habrastorage.org/webt/o_/o2/6s/o_o26sakm0n5hyq9wisbo7vouge.png"><br><br></p><br><p>  Vous devez patcher un peu le copi√© pour obtenir la pile correcte: </p><br><p><img src="https://habrastorage.org/webt/sm/h7/0n/smh70naepp3kshxaa78zxv1g2du.png"><br><br></p><br><p>  R√©p√©tez l'obsc√©nit√© pour toutes les images: </p><br><p><img src="https://habrastorage.org/webt/cg/dv/61/cgdv617uqeriqmuqcyc2jkjpnbe.png"><br><br></p><br><p>  Vous pouvez maintenant revenir en arri√®re et continuer comme si de rien n'√©tait. </p><br><p><img src="https://habrastorage.org/webt/gn/dd/xw/gnddxwqqsrwuidc9ev2nxwmiwqc.png"><br><br></p><br><p>  Le probl√®me est qu'une copie compl√®te de la pile n'est pas du tout ce que nous aimerions avoir.  C'est tr√®s inhibiteur.  Tout cela est l'isolement des liens, v√©rifie l'√©pinglage, ce n'est pas rapide.  Et surtout - tout cela d√©pend lin√©airement de la taille de la pile!  En un mot, l'enfer.  Pas besoin de faire √ßa. </p><br><p>  Au lieu de cela, nous avons une autre id√©e - la copie paresseuse. </p><br><p>  Revenons √† l'endroit o√π nous avons d√©j√† une continuation fig√©e. </p><br><p><img src="https://habrastorage.org/webt/5b/hw/tg/5bhwtgg8cfg-agcwu_kdtrqlify.png"><br><br></p><br><p>  Nous continuons le processus comme auparavant: </p><br><p><img src="https://habrastorage.org/webt/rj/ac/f9/rjacf9tmfekskko8jwojuocxixm.png"><br><br></p><br><p>  De la m√™me mani√®re que pr√©c√©demment, nous nettoyons l'endroit sur la pile native: </p><br><p><img src="https://habrastorage.org/webt/nm/ol/ow/nmolowac-dkmdefuobd-kaijyeq.png"><br><br></p><br><p>  Mais nous ne copions pas tout de suite, mais seulement une ou deux images: </p><br><p><img src="https://habrastorage.org/webt/3a/ca/1x/3aca1xglgfbq8yzwxkjypelxpqy.png"><br><br></p><br><p>  Maintenant, le hack.  Vous devez patcher l'adresse de retour de la m√©thode <code>C</code> afin qu'elle pointe vers une certaine barri√®re de retour: </p><br><p><img src="https://habrastorage.org/webt/zs/si/3z/zssi3zgaadvvsrg883agxsmq3pc.png"><br><br></p><br><p>  Maintenant, vous pouvez revenir en toute s√©curit√© au <code>yield</code> : </p><br><p><img src="https://habrastorage.org/webt/e1/f_/2s/e1f_2snf4bh-ggjcv5lrgabqkwk.png"><br><br></p><br><p>  Ce qui √† son tour conduira √† un appel au code utilisateur dans la m√©thode <code>C</code> : </p><br><p><img src="https://habrastorage.org/webt/y2/nl/rm/y2nlrmn9lczwhcaa3f41ii69nq0.png"><br><br></p><br><p>  Imaginez maintenant que <code>C</code> veut revenir au code qui l'a appel√©.  Mais son invocateur est <code>B</code> , et il n'est pas sur la pile!  Par cons√©quent, lorsqu'il tentera de revenir, il ira √† l'adresse de retour, et cette adresse est maintenant la barri√®re de retour.  Et, vous savez, cela attirera √† nouveau un appel de <code>thaw</code> : </p><br><p><img src="https://habrastorage.org/webt/hb/6g/8d/hb6g8dfw35ujqntvi-y7lzyskis.png"><br><br></p><br><p>  Et le <code>thaw</code> lib√©rera la prochaine image sur la pile de continuation, et c'est <code>B</code> : </p><br><p><img src="https://habrastorage.org/webt/cp/mp/ao/cpmpao3_arvnvgykenc9r4fgwsk.png"><br><br></p><br><p>  En fait, nous l'avons copi√© paresseusement, sur demande. </p><br><p>  Ensuite, nous supprimons <code>B</code> de la pile de continuation et d√©finissons √† nouveau la barri√®re (la barri√®re doit √™tre d√©finie car il reste quelque chose sur la pile de continuation).  Et ainsi de suite. </p><br><p><img src="https://habrastorage.org/webt/gv/yo/0u/gvyo0u4iwzunuqovy1yv_-jbutq.png"><br><br></p><br><p>  Mais supposons que <code>B</code> ne revienne pas au code appelant, mais appelle d'abord une autre m√©thode <code>D</code>  Et cette nouvelle m√©thode veut √©galement √™tre √©vinc√©e. </p><br><p><img src="https://habrastorage.org/webt/f9/1i/t9/f91it9xn705zsxuzvvbqh5gdoqi.png"><br><br></p><br><p>  Dans ce cas, lorsque viendra le temps de <code>freeze</code> , nous n'aurons besoin de copier que le haut de la pile native sur la pile de continuation: </p><br><p><img src="https://habrastorage.org/webt/pt/8b/ul/pt8buljt77lsp-wj-rswobc4v_y.png"><br><br></p><br><p>  Ainsi, la quantit√© de travail effectu√©e ne d√©pend pas lin√©airement de la taille de la pile.  Cela d√©pend lin√©airement uniquement du nombre d'images que nous avons r√©ellement utilis√©es dans le travail. </p><br><h1 id="chto-ostalos">  Que reste-t-il? </h1><br><p>  Les d√©veloppeurs gardent √† l'esprit certaines fonctionnalit√©s, mais ils ne sont pas entr√©s dans le prototype. </p><br><ul><li>  S√©rialisation et clonage.  La possibilit√© de continuer sur une autre machine, √† un autre moment, etc. </li><li>  JVM TI et d√©bogage, comme s'il s'agissait de threads normaux.  Si vous √™tes bloqu√© √† la lecture de la prise, vous ne verrez pas un beau saut de rendement, dans le prototype le fil sera simplement bloqu√©, comme tout autre fil ordinaire. </li><li>  La r√©cursivit√© de la queue n'a m√™me pas √©t√© touch√©e. </li></ul><br><p>  Prochaines √©tapes: </p><br><ul><li>  Cr√©ez une API humaine; </li><li>  Ajoutez toutes les fonctionnalit√©s manquantes; </li><li>  Am√©liorez les performances. </li></ul><br><h1 id="gde-vzyat">  O√π trouver </h1><br><p>  Le prototype est r√©alis√© sous forme de brunch dans le r√©f√©rentiel OpenJDK.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vous pouvez t√©l√©charger le prototype ici</a> en passant aux <code>fibers</code> brunch. </p><br><p>  C'est fait comme ceci: </p><br><pre> <code class="bash hljs">$ hg <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> http://hg.openjdk.java.net/loom/loom $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> loom $ hg update -r fibers $ sh configure $ make images</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme vous le savez, tout cela va commencer l'assemblage de ce putain d'OpenJDK. </font><font style="vertical-align: inherit;">Par cons√©quent, premi√®rement, la prochaine demi-heure de votre vie devra faire autre chose, pendant que tout cela se passe.</font></font></p><br><p><img src="https://habrastorage.org/webt/gk/qz/3-/gkqz3-f8gmkcwkynnnrp4opp1rg.png"><br><br></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deuxi√®mement, vous devez disposer d'un ordinateur correctement configur√© avec une cha√Æne d'outils C ++ et des biblioth√®ques GNU. </font><font style="vertical-align: inherit;">Je laisse entendre qu'il n'est pas recommand√© de le faire sous Windows. </font><font style="vertical-align: inherit;">S√©rieusement, m√™me en t√©l√©chargeant VirtualBox et en y installant un nouvel Ubuntu, vous passerez des ordres de grandeur moins de temps que d'essayer de r√©aliser une autre erreur inhumaine lors de la construction √† partir de Cygwin ou msys64. </font><font style="vertical-align: inherit;">C'est l√† que msys est encore pire que Cygwin.</font></font></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bien que ce ne soit, bien s√ªr, qu'un mensonge, je me lasse de vous √©crire </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des instructions de montage</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p><br><p>   -   ,   mercurial extension   fsmonitor. ,   ,   <code>hg help -e fsmonitor</code> . <br>      ~/.hgrc  : </p><br><pre> <code class="plaintext hljs">[fsmonitor] mode = on</code> </pre> <br><p>  -           .             -, <code>cp -R ./loom ./loom-backup</code> . </p><br><p>  ,          . ,   Java-    ,       . </p><br><p> <code>sh configure</code>    - . ,     Ubuntu,     Autoconf ( <code>sudo apt-get install autoconf</code> ).  ‚Äî     OpenJDK   Ubuntu,     ,  .  Windows      ,   . </p><br><p> ,     ,   <code>hg diff --stat -r default:fibers</code> . </p><br><p>  ,          ,   ,     . </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>      ¬´, ¬ª.   ¬´¬ª, . ¬´Loom¬ª ‚Äî  ¬´ ¬ª.  Project Loom         . </p><br><p>          ,        . ,      ¬´¬ª  ,  ,      ‚Äî  , ,  , ‚Äî  . </p><br><p> ,   ,          XIX    ,        . </p><br><br><img src="https://habrastorage.org/getpro/habr/post_images/305/64e/143/30564e14316852dd18d4235b3850e134.jpg"><br><p>      . -,  . </p><br><p> ,                 .        IDE   . </p><br><p>          ,       ,   ,    ¬´ ¬ª, ¬´¬ª, ¬´ ¬ª   . </p><br><p>       ?   .   . </p><br><p>  Je vous remercie </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr422519/">https://habr.com/ru/post/fr422519/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr422509/index.html">R√©sum√© du livre "Never Eat Alone"</a></li>
<li><a href="../fr422511/index.html">Chargement des donn√©es dans Splunk: Universal Forwarder vs Heavy Forwarder. Quelle est la diff√©rence?</a></li>
<li><a href="../fr422513/index.html">7 conseils pour ne pas exasp√©rer un coll√®gue testeur pendant ses vacances</a></li>
<li><a href="../fr422515/index.html">Deux mitaps Apache Ignite et webinaire sur l'informatique en m√©moire en septembre</a></li>
<li><a href="../fr422517/index.html">TelegramBot dans le Wolfram Cloud</a></li>
<li><a href="../fr422521/index.html">Pr√©diction de l'in√©vitable</a></li>
<li><a href="../fr422525/index.html">"La matrice de l'amiti√©." Le graphique social le plus ancien pour le plus petit</a></li>
<li><a href="../fr422527/index.html">R√©sum√© des nouvelles de PostgreSQL. Num√©ro 10</a></li>
<li><a href="../fr422529/index.html">Cours sp√©cial Groupe-IB: ¬´S√©curit√© des applications mobiles¬ª</a></li>
<li><a href="../fr422531/index.html">Optimisation Web: le plus important</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>