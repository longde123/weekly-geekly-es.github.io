<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>碉 达 锔 Cirug铆a card铆aca: c贸mo reescribimos el componente principal de un sistema DLP   锔</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Reescribir el c贸digo heredado como un viaje al dentista parece ser que todos entienden que deben ir, pero sin embargo postergan e intentan retrasar lo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cirug铆a card铆aca: c贸mo reescribimos el componente principal de un sistema DLP</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/solarsecurity/blog/419385/">  Reescribir el c贸digo heredado como un viaje al dentista parece ser que todos entienden que deben ir, pero sin embargo postergan e intentan retrasar lo inevitable, porque saben que doler谩.  En nuestro caso, las cosas fueron a煤n peores: tuvimos que reescribir la parte clave del sistema y, debido a circunstancias externas, no pudimos reemplazar los viejos fragmentos de c贸digo con partes nuevas en partes, solo de una vez y en su totalidad.  Y todo esto en condiciones de falta de tiempo, recursos y documentaci贸n, pero con el requisito de gesti贸n que como resultado de la "operaci贸n" ning煤n cliente deber铆a sufrir. <br><br>  Debajo del corte, la historia de c贸mo reescribimos el componente principal del producto con una historia de 17 a帽os (!) De Scheme a Clojure, y todo funcion贸 de inmediato (bueno, casi :)). <br><br><img src="https://habrastorage.org/webt/_6/o3/5d/_6o35dz5ilq8ube742dj-_nu1bk.jpeg"><br><a name="habracut"></a><br><h4>  17 a帽os en el "reloj" </h4><br>  Solar Dozor es un sistema DLP con una historia muy larga.  La primera versi贸n apareci贸 en 2001 como un servicio relativamente peque帽o para filtrar el tr谩fico de correo.  Durante 17 a帽os, el producto se ha convertido en un gran paquete de software que recopila, filtra y analiza informaci贸n heterog茅nea que se ejecuta dentro de la organizaci贸n y protege el negocio de los clientes de las amenazas internas. <br><br>  Al desarrollar la sexta versi贸n de Solar Dozor, sacudimos el producto de manera decisiva, desechamos muletas viejas del c贸digo <s>y las reemplazamos por otras nuevas</s> , actualizamos la interfaz, revisamos la funcionalidad en la direcci贸n de las realidades modernas, en general, hicimos que el producto fuera arquitect贸nico y conceptualmente m谩s hol铆stico. <br><br>  En ese momento, bajo el cap贸 del Solar Dozor actualizado, hab铆a una enorme capa de c贸digo heredado monol铆tico: el servicio de filtrado, que durante todos estos 17 a帽os se ha convertido gradualmente en una nueva funcionalidad, que incorpora soluciones a largo plazo y tareas comerciales a corto plazo, pero logr贸 mantenerse dentro de la arquitectura original paradigmas <br><br><img src="https://habrastorage.org/webt/ql/0n/0e/ql0n0e6i9ulsdjuud0_-bjmuhy4.png"><br>  <i>Servicio de filtrado</i> <br><br>  No es necesario decir que la introducci贸n de cualquier cambio en un c贸digo tan antiguo requer铆a especial delicadeza.  Los desarrolladores tuvieron que tener mucho cuidado de no arruinar accidentalmente la funcionalidad creada hace una d茅cada.  Adem谩s, se forzaron a introducir soluciones interesantes bastante nuevas en el lecho de arquitectura Procrustean, inventado en los albores de la era. <br><br>  Entender que surgi贸 la necesidad de actualizar el sistema apareci贸 hace bastante tiempo.  Pero faltaba claramente el esp铆ritu de tocar un servicio de sistema enorme y antiguo. <br><br><h4>  No tratando de retrasar lo inevitable </h4><br>  Los productos con una larga historia de desarrollo tienen una caracter铆stica interesante.  No importa cu谩n extra帽o pueda parecer cualquier funcionalidad, si ha sobrevivido con 茅xito hasta nuestros d铆as, esto significa que fue creado no a partir de las ideas te贸ricas de los desarrolladores, sino en respuesta a las necesidades espec铆ficas de los clientes. <br><br>  En esta situaci贸n, no se puede hablar de ning煤n reemplazo por etapas.  Era imposible cortar y rehacer la funcionalidad en partes, porque todas estas partes eran demandadas por los clientes, y no pod铆amos "cerrarlas para la reconstrucci贸n".  Era necesario eliminar cuidadosamente el servicio anterior y proporcionarle un reemplazo completo.  Solo en su totalidad, solo a la vez. <br><br>  Mejorar el proceso de desarrollo del producto, la velocidad de hacer cambios y mejorar la calidad en su conjunto era una condici贸n necesaria pero no suficiente.  La gerencia se pregunt贸 qu茅 beneficios aportar铆a el cambio a nuestros clientes.  La respuesta fue expandir el conjunto de interfaces para interactuar con los nuevos sistemas de intercepci贸n, lo que proporcionar铆a una retroalimentaci贸n r谩pida y permitir铆a a los interceptores responder m谩s r谩pidamente a los incidentes. <br><br>  Tambi茅n tuvimos que luchar para reducir el consumo de recursos, manteniendo (e idealmente aumentando) la tasa de procesamiento actual. <br><br><h4>  Un poco sobre relleno </h4><br>  A lo largo de la ruta de desarrollo del producto, el equipo de Solar Dozor tendi贸 hacia un enfoque funcional.  Esto lleva a una elecci贸n m谩s bien no est谩ndar de lenguajes de programaci贸n para una industria madura.  En diferentes etapas de la vida del sistema, estos fueron Scheme, OCaml, Scala, Clojure, adem谩s de C (++) tradicional y Java. <br><br>  El principal servicio de filtrado y otros servicios que ayudan a recibir y transmitir mensajes fueron escritos y desarrollados en el lenguaje Scheme en sus diversas implementaciones (Racket utiliz贸 este 煤ltimo).  No importa cu谩nto quiera cantar las alabanzas de la simplicidad y elegancia de este lenguaje, uno no puede dejar de admitir que su desarrollo cumple con m谩s intereses acad茅micos que los industriales.  El retraso es especialmente notable en comparaci贸n con otros servicios m谩s modernos de Solar Dozor, que se desarrollan principalmente en Scala y Clojure.  El nuevo servicio tambi茅n se decidi贸 implementar en Clojure. <br><br><h4>  Clojure?! </h4><br>  Aqu铆, por supuesto, debo decir algunas palabras sobre por qu茅 elegimos Clojure como el principal lenguaje de implementaci贸n. <br><br>  En primer lugar, no quer铆a perder la experiencia 煤nica del equipo que se desarrolla en Scheme.  Clojure tambi茅n es un miembro moderno de la familia de idiomas Lisp, y cambiar de un Lisp a otro suele ser bastante simple. <br><br>  En segundo lugar, gracias a un compromiso con los principios funcionales y una serie de soluciones arquitect贸nicas 煤nicas, Clojure proporciona una facilidad sin precedentes para manipular flujos de datos.  Tambi茅n es importante que Clojure opere en la plataforma JVM, lo que significa que puede usar una base de datos conjunta con otros servicios en Java y Scala, as铆 como tambi茅n usar numerosas herramientas para la creaci贸n de perfiles y la depuraci贸n. <br><br>  En tercer lugar, Clojure es un lenguaje conciso y expresivo.  Esto facilita la lectura del c贸digo de otra persona y hace que sea f谩cil pasar el c贸digo a un compa帽ero de equipo. <br><br>  Finalmente, valoramos Clojure por su facilidad de creaci贸n de prototipos y el llamado desarrollo centrado en REPL.  En casi cualquier situaci贸n donde haya dudas, simplemente puede crear un prototipo y continuar la discusi贸n de una manera m谩s sustantiva, con nuevos datos.  El desarrollo orientado a REPL ofrece un retorno r谩pido, porque para verificar la funcionalidad de una funci贸n no es necesario volver a compilar el programa, sino incluso reiniciarlo (incluso si el programa es un servicio ubicado en un servidor remoto). <br><br>  Mirando hacia el futuro, puedo decir: creo que no hemos perdido la elecci贸n. <br><br><h4>  Poniendo la funcionalidad poco a poco </h4><br>  Cuando hablamos de un reemplazo con todas las funciones, la primera pregunta que surge es la recopilaci贸n de informaci贸n sobre la funcionalidad existente. <br><br>  Esto se ha convertido en una tarea bastante interesante.  Parece que aqu铆 hay un sistema que funciona, aqu铆 est谩 la documentaci贸n para ello, aqu铆 hay personas, expertos que trabajan estrechamente con el sistema y ense帽an a otros sobre 茅l.  Pero para obtener una imagen completa de toda la variedad, y a煤n m谩s, los requisitos para el desarrollo resultaron no ser tan simples. <br><br>  El conjunto de requisitos no se considera en vano una disciplina de ingenier铆a separada.  La implementaci贸n existente parad贸jicamente resulta ser el papel de alg煤n "est谩ndar corrupto".  Muestra c贸mo y c贸mo deber铆a funcionar, pero al mismo tiempo, los desarrolladores esperan que la nueva versi贸n resulte mejor que la original.  Es necesario separar los momentos necesarios para la implementaci贸n (generalmente relacionados con interfaces externas) de aquellos que pueden mejorarse de acuerdo con las expectativas de los usuarios. <br><br><img src="https://habrastorage.org/webt/xp/qm/jj/xpqmjjwfro1gpmhwfuxongl5-ko.png"><br>  <i>Proceso de filtrado de mensajes</i> <br><br><h4>  La documentaci贸n no es suficiente. </h4><br>  驴Cu谩l es la funcionalidad real del sistema?  La respuesta a esta pregunta viene dada por varias descripciones, como documentaci贸n del usuario, manuales y documentos arquitect贸nicos, que reflejan la estructura del servicio en varios aspectos.  Pero cuando se trata de eso, entiendes muy bien cu谩nto divergen las ideas y la realidad, cu谩ntos matices y posibilidades no explicadas contiene el antiguo c贸digo. <br><br>  Quiero contactar a todos los desarrolladores.  隆Cuida tu c贸digo!  Este es tu activo m谩s importante.  No conf铆e en la documentaci贸n.  Conf铆e solo en el c贸digo fuente. <br><br>  Afortunadamente para nosotros, el c贸digo Scheme, debido a la naturaleza misma del lenguaje creado para la programaci贸n de la ense帽anza, es bastante f谩cil de leer incluso para una persona no capacitada.  Lo principal es acostumbrarse a algunas formas individuales que llevan un ligero toque de Lisp-arcaico. <br><br><h4>  Construye un proceso </h4><br>  El volumen de trabajo fue enorme y el equipo es muy peque帽o.  Por lo tanto, no fue sin dificultades organizativas.  El flujo de trabajo de errores y solicitudes de arreglos (y mejoras menores) al antiguo servicio de filtrado ni siquiera se detuvo.  Los desarrolladores regularmente ten铆an que distraerse con estas tareas. <br><br>  Afortunadamente, fue posible evitar las solicitudes de incrustar nuevas piezas de gran funcionalidad en el filtro antiguo.  Es cierto, bajo la promesa de integrar esta funcionalidad en un nuevo servicio.  Sin embargo, el conjunto de tareas de lanzamiento crec铆a lenta pero seguramente. <br><br>  Otro factor que agreg贸 muchos problemas fueron las dependencias externas del servicio.  Al ser un componente central, el servicio de filtrado utiliza numerosos servicios para desempacar y analizar contenido (textos, im谩genes, huellas digitales, etc.).  El trabajo con ellos fue parcialmente guiado por antiguas decisiones arquitect贸nicas.  Durante el proceso de desarrollo, tambi茅n fue necesario reescribir algunos componentes de una manera moderna (y algunos en un lenguaje moderno). <br><br>  En tales condiciones, se construy贸 un sistema de pruebas funcionales paso a paso.  Crecimos el servicio a un cierto estado, que fue reforzado por pruebas activas, y luego pasamos a implementar uno nuevo. <br><br><h4>  Iniciar desarrollo </h4><br>  En primer lugar, se implement贸 el marco principal del servicio, los mecanismos b谩sicos para recibir mensajes y desempaquetar archivos.  Este fue el m铆nimo absoluto necesario para comenzar a probar la velocidad y la correcci贸n del servicio futuro. <br><br>  Aqu铆 debe aclararse que desempaquetar se refiere al proceso recursivo de obtener partes de un archivo y extraer informaci贸n 煤til de ellas.  Entonces, por ejemplo, un documento de Word puede contener no solo texto, sino tambi茅n im谩genes, un documento de Excel incrustado, objetos OLE y mucho m谩s. <br><br>  El mecanismo de desempaque no distingue entre el uso de bibliotecas internas, programas externos o servicios de terceros, proporcionando una interfaz 煤nica para organizar las canalizaciones de desempaque. <br><br>  Otro cumplido hacia Clojure: obtuvimos un prototipo funcional, en el que delineamos los contornos de la funcionalidad futura, en el menor tiempo posible. <br><br><h4>  DSL para la pol铆tica </h4><br>  El segundo paso fue agregar validaci贸n de mensajes utilizando pol铆ticas de filtrado. <br><br>  Para describir las pol铆ticas, se cre贸 un DSL especial, un lenguaje simple sin adornos, que nos permiti贸 presentar las reglas y condiciones de la pol铆tica en una forma m谩s o menos legible para los humanos.  Se llama MFLang. <br><br>  El script en MFLang "sobre la marcha" se interpreta en el c贸digo Clojure, almacena en cach茅 los resultados de las verificaciones en el mensaje, mantiene un registro detallado del trabajo (y, francamente, merece un art铆culo separado). <br><br>  El uso de DSL apel贸 a los evaluadores.  隆Abajo excavando en la base de datos o en el formato de exportaci贸n!  Ahora era posible enviar simplemente la regla generada para verificaci贸n, e inmediatamente qued贸 claro qu茅 condiciones se verificaron.  Tambi茅n fue posible obtener un registro detallado de verificaci贸n de mensajes, a partir del cual queda claro qu茅 datos se tomaron para la verificaci贸n y qu茅 resultados fueron devueltos por la funci贸n de comparaci贸n. <br><br>  Podemos decir con confianza que MFLang result贸 ser una herramienta absolutamente invaluable para la funcionalidad de depuraci贸n. <br><br><h4>  En plena fuerza </h4><br>  En la tercera etapa, se agreg贸 un mecanismo para aplicar las acciones definidas por la pol铆tica de seguridad al mensaje, as铆 como enlaces de servicio que permiten la inclusi贸n de nuevos componentes en el complejo Solar Dozor.  Finalmente, pudimos lanzar el servicio y observar el resultado del trabajo en toda su diversidad. <br><br>  La pregunta principal, por supuesto, era c贸mo la funcionalidad implementada corresponde a lo que se esperaba y cu谩n plenamente la implementa. <br><br>  Observo que si la necesidad de pruebas unitarias no se ha cuestionado durante mucho tiempo (aunque las pr谩cticas TDD en s铆 mismas todav铆a causan un debate vivo), la introducci贸n de pruebas automatizadas de la funcionalidad del sistema a menudo se encuentra con una resistencia abierta. <br><br>  El desarrollo de pruebas autom谩ticas ayuda a todos los miembros del equipo a comprender mejor el proceso del producto, ahorra energ铆a en la regresi贸n e infunde cierta confianza en el rendimiento del producto.  Pero el proceso de su creaci贸n est谩 plagado de una serie de dificultades: recopilar los datos necesarios, determinar los indicadores de inter茅s y las opciones de prueba.  Los programadores inevitablemente perciben la creaci贸n de pruebas autom谩ticas como un trabajo adicional opcional, que es mejor evitar si es posible. <br><br>  Pero si logra superar la resistencia, se crea una base bastante s贸lida que le permite construir una idea de la salud del sistema. <br><br><h4>  Reemplazamos </h4><br>  Y entonces lleg贸 un momento importante: incluimos el servicio en el paquete de entrega.  Hasta ahora, junto con el anterior.  Por lo tanto, un equipo podr铆a realizar un cambio de versi贸n y comparar el comportamiento de los servicios. <br><br>  En este modo paralelo, el nuevo servicio de filtrado dur贸 una versi贸n.  Durante este tiempo, logramos recopilar estad铆sticas adicionales sobre el trabajo, delinear e implementar las mejoras necesarias. <br><br>  Finalmente, despu茅s de reunir nuestra fuerza, eliminamos el antiguo servicio de filtrado del producto.  La etapa final de aceptaci贸n interna fue, los errores fueron corregidos, los desarrolladores comenzaron a cambiar gradualmente a otras tareas.  De alguna manera imperceptible, sin alardes ni aplausos, se lanz贸 un producto con un nuevo servicio. <br><br>  Y solo cuando comenzaron a surgir preguntas del equipo de implementaci贸n, se lleg贸 al entendimiento: el servicio en el que hab铆amos estado trabajando durante tanto tiempo, ya estaba en los sitios y ... 隆funcionando! <br><br>  Por supuesto, hubo errores y mejoras menores, sin embargo, despu茅s de un mes de uso activo, los clientes emitieron un veredicto: la introducci贸n de un producto con una nueva versi贸n del servicio de filtrado caus贸 menos problemas que la implementaci贸n de versiones anteriores.  Hey  Parece que lo hicimos! <br><br><h4>  Al final </h4><br>  El desarrollo de un nuevo servicio de filtraci贸n tom贸 aproximadamente un a帽o y medio.  M谩s largo de lo que se pensaba originalmente, pero no cr铆tico, especialmente porque la intensidad laboral real del trabajo coincidi贸 con la evaluaci贸n inicial.  M谩s importante a煤n, pudimos cumplir con las expectativas de la gerencia y los clientes y sentar las bases para futuras mejoras del producto.  Ya en el estado actual, puede ver una reducci贸n significativa en el consumo de recursos, a pesar de que el producto todav铆a tiene amplias oportunidades para la optimizaci贸n. <br><br>  Puedo agregar algunas impresiones personales. <br><br>  Reemplazar un componente central con una larga historia es un soplo de aire fresco para el desarrollo.  Por primera vez en mucho tiempo, existe la confianza de que el control del producto est谩 volviendo a nuestras manos. <br><br>  Es dif铆cil sobreestimar los beneficios de un proceso de comunicaci贸n y desarrollo debidamente organizado.  En este caso, era importante establecer un trabajo no tanto dentro del equipo como con numerosos consumidores del producto, que ten铆an preferencias y expectativas claras del sistema, y deseos vagos. <br><br>  Para nosotros, esta fue la primera experiencia en el desarrollo de un proyecto a gran escala en Clojure.  Inicialmente, hab铆a preocupaciones relacionadas con la naturaleza din谩mica del lenguaje, la velocidad y la tolerancia a errores.  Afortunadamente, no se materializaron. <br><br>  Solo queda desear que el nuevo componente funcione durante tanto tiempo y con 茅xito como su predecesor. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es419385/">https://habr.com/ru/post/es419385/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es419373/index.html">Comparaci贸n de React y Vue en un ejemplo pr谩ctico</a></li>
<li><a href="../es419375/index.html">MiRNA circulantes</a></li>
<li><a href="../es419379/index.html">Por qu茅 Tesla y Deutsche Bank rechazan los contratos en papel</a></li>
<li><a href="../es419381/index.html">C贸mo los muchachos de Storyline regresaron de Silicon Valley a Minsk con $ 770 mil para una startup</a></li>
<li><a href="../es419383/index.html">Nueva t茅cnica de ataque WPA2 que no requiere un cliente en el AP</a></li>
<li><a href="../es419387/index.html">Vulnerabilidades de OWASP Top 10. A1: 2017 - Inyecciones (Parte 1)</a></li>
<li><a href="../es419389/index.html">Motor de renderizado angular 6 e Ivy</a></li>
<li><a href="../es419391/index.html">Poder, dinero y c贸digo abierto. Contando c贸mo funciona la comunidad con Apache Ignite</a></li>
<li><a href="../es419393/index.html">Cree una puerta de enlace API simple en ASP.NET Core</a></li>
<li><a href="../es419395/index.html">Explicaci贸n de expresiones lambda</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>