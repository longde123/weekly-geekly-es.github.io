<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>âš±ï¸ ğŸ‘µğŸ¿ ğŸ˜¦ Trik Pemrosesan Metrik di Kapacitor ğŸ”· ğŸ˜¡ ğŸ™†ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kemungkinan besar, hari ini tidak ada yang memiliki pertanyaan mengapa mereka perlu mengumpulkan metrik layanan. Langkah logis berikutnya adalah mengo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Trik Pemrosesan Metrik di Kapacitor</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/478702/">  Kemungkinan besar, hari ini tidak ada yang memiliki pertanyaan mengapa mereka perlu mengumpulkan metrik layanan.  Langkah logis berikutnya adalah mengonfigurasikan peringatan untuk metrik yang dikumpulkan, yang akan memberi tahu Anda tentang penyimpangan dalam data di saluran yang nyaman bagi Anda (mail, Slack, Telegram).  Dalam layanan reservasi online hotel <a href="https://www.habr.com/%3Futm_source%3Dhabr%26utm_medium%3Dpr%26utm_campaign%3DErmolaev_dec19%26utm_content%3Darticle">Ostrovok.ru</a> , semua metrik layanan kami dituangkan ke InfluxDB dan ditampilkan di Grafana, peringatan dasar juga ditetapkan di sana.  Untuk tugas-tugas seperti "Anda perlu menghitung sesuatu dan membandingkannya," kami menggunakan Kapacitor. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/oe/cl/5h/oecl5hgip8nkmeau21l2qaem8ek.png"></div><br>  Kapacitor adalah bagian dari TICK stack yang dapat menangani metrik dari InfluxDB.  Dia dapat menghubungkan beberapa dimensi satu sama lain (bergabung), menghitung sesuatu yang berguna dari data yang diterima, menulis hasilnya kembali ke InfluxDB, mengirim peringatan ke Slack / Telegram / mail. <br><br>  Seluruh tumpukan memiliki <a href="">dokumentasi yang</a> keren dan terperinci, tetapi selalu ada hal-hal berguna yang tidak ditentukan secara eksplisit dalam manual.  Dalam artikel ini, saya memutuskan untuk mengumpulkan sejumlah tips yang tidak jelas yang berguna (sintaks TICKscipt dasar dijelaskan di <a href="https://docs.influxdata.com/kapacitor/v1.5/tick/syntax/">sini</a> ) dan menunjukkan bagaimana mereka dapat diterapkan, menggunakan contoh pemecahan salah satu masalah kita. <br><br>  Ayo pergi! <br><a name="habracut"></a><br><h4>  float &amp; int, kesalahan perhitungan </h4><br>  Benar-benar masalah standar, diselesaikan melalui kasta: <br><br><pre><code class="python hljs">var alert_float = <span class="hljs-number"><span class="hljs-number">5.0</span></span> var alert_int = <span class="hljs-number"><span class="hljs-number">10</span></span> data|eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: float(<span class="hljs-string"><span class="hljs-string">"value"</span></span>) &gt; alert_float OR float(<span class="hljs-string"><span class="hljs-string">"value"</span></span>) &lt; float(<span class="hljs-string"><span class="hljs-string">"alert_int"</span></span>))</code> </pre> <br><h4>  Menggunakan default () </h4><br>  Jika tag / bidang tidak diisi, kesalahan akan terjadi dalam perhitungan: <br><br><pre> <code class="python hljs">|default() .tag(<span class="hljs-string"><span class="hljs-string">'status'</span></span>, <span class="hljs-string"><span class="hljs-string">'empty'</span></span>) .field(<span class="hljs-string"><span class="hljs-string">'value'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br><h4>  isi gabung (dalam vs luar) </h4><br>  Secara default, bergabung akan menjatuhkan titik di mana tidak ada data (batin). <br>  Dengan fill ('null'), join luar akan dieksekusi, setelah itu Anda perlu melakukan default () dan mengisi nilai-nilai kosong: <br><br><pre> <code class="python hljs">var data = res1 |join(res2) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'res1'</span></span>, <span class="hljs-string"><span class="hljs-string">'res2) .fill('</span></span>null<span class="hljs-string"><span class="hljs-string">') |default() .field('</span></span>res1.value<span class="hljs-string"><span class="hljs-string">', 0.0) .field('</span></span>res2.value<span class="hljs-string"><span class="hljs-string">', 100.0)</span></span></code> </pre><br>  Masih ada nuansa.  Jika dalam contoh di atas salah satu seri (res1 atau res2) kosong, seri terakhir (data) juga akan kosong.  Ada beberapa tiket pada topik ini di github ( <a href="https://github.com/influxdata/kapacitor/issues/1633">1633</a> , <a href="https://github.com/influxdata/kapacitor/issues/1871">1871</a> , <a href="https://github.com/influxdata/influxdb/issues/6967">6967</a> ) - kami sedang menunggu perbaikan dan sedikit menderita. <br><br><h4>  Menggunakan kondisi dalam perhitungan (jika dalam lambda) </h4><br><pre> <code class="python hljs">|eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-string"><span class="hljs-string">"value"</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, true, false)</code> </pre><br><h4>  Lima menit terakhir dari pipa selama periode tersebut </h4><br>  Misalnya, Anda perlu membandingkan nilai lima menit terakhir dengan minggu sebelumnya.  Anda dapat mengambil dua paket data dengan dua batch'ami yang terpisah atau menarik sebagian data dari periode yang lebih besar: <br><br><pre> <code class="python hljs"> |where(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: duration((unixNano(now()) - unixNano(<span class="hljs-string"><span class="hljs-string">"time"</span></span>))/<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>u) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>m)</code> </pre><br>  Alternatif untuk lima menit terakhir bisa menggunakan simpul BarrierNode, yang memotong data sebelum waktu yang ditentukan: <br><br><pre> <code class="python hljs">|barrier() .period(<span class="hljs-number"><span class="hljs-number">5</span></span>m)</code> </pre><br><h2>  Contoh menggunakan pola Go'sh dalam pesan </h2><br>  Template sesuai dengan format dari paket <a href="https://golang.org/pkg/text/template/">text.template</a> , di bawah ini adalah beberapa tugas umum. <br><br><h4>  jika ada </h4><br>  Kami menertibkan, kami tidak memicu orang dengan teks sekali lagi: <br><br><pre> <code class="python hljs">|alert() ... .message( <span class="hljs-string"><span class="hljs-string">'{{ if eq .Level "OK" }}It is ok now{{ else }}Chief, everything is broken{{end}}'</span></span> )</code> </pre><br><h4>  Dua tempat desimal dalam pesan </h4><br>  Meningkatkan keterbacaan pesan: <br><br><pre> <code class="python hljs">|alert() ... .message( <span class="hljs-string"><span class="hljs-string">'now value is {{ index .Fields "value" | printf "%0.2f" }}'</span></span> )</code> </pre><br><h4>  Memperluas variabel dalam pesan </h4><br>  Kami menampilkan lebih banyak informasi dalam pesan untuk menjawab pertanyaan "Mengapa berteriak?" <br><br><pre> <code class="python hljs">var warnAlert = <span class="hljs-number"><span class="hljs-number">10</span></span> |alert() ... .message( <span class="hljs-string"><span class="hljs-string">'Today value less then '</span></span>+string(warnAlert)+<span class="hljs-string"><span class="hljs-string">'%'</span></span> )</code> </pre><br><h4>  Pengidentifikasi Tanda Unik </h4><br>  Hal yang benar ketika ada lebih dari satu grup dalam data, jika tidak hanya satu peringatan yang akan dihasilkan: <br><br><pre> <code class="python hljs">|alert() ... .id(<span class="hljs-string"><span class="hljs-string">'{{ index .Tags "myname" }}/{{ index .Tags "myfield" }}'</span></span>)</code> </pre><br><h4>  Penangan kustom </h4><br>  Daftar besar penangan memiliki exec, yang memungkinkan Anda untuk mengeksekusi skrip Anda dengan parameter yang dilewati (stdin) - kreativitas dan banyak lagi! <br><br>  Salah satu alat khusus kami adalah skrip python kecil untuk mengirim notifikasi menjadi kendur. <br>  Pertama, kami ingin mengirim gambar dari graphane yang dilindungi oleh otorisasi dalam pesan.  Setelah - tulis OK di utas ke peringatan sebelumnya dari grup yang sama, dan bukan sebagai pesan terpisah.  Beberapa saat kemudian - untuk menambahkan kesalahan paling umum pada menit-menit terakhir pesan. <br><br>  Topik terpisah adalah komunikasi dengan layanan lain dan tindakan apa pun yang diprakarsai oleh peringatan (hanya jika pemantauan Anda cukup baik). <br>  Contoh deskripsi handler, di mana slack_handler.py adalah skrip yang ditulis sendiri: <br><br><pre> <code class="python hljs">topic: slack_graph id: slack_graph.alert match: level() != INFO AND changed() == TRUE kind: <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> options: prog: /sbin/slack_handler.py args: [<span class="hljs-string"><span class="hljs-string">"-c"</span></span>, <span class="hljs-string"><span class="hljs-string">"CHANNELID"</span></span>, <span class="hljs-string"><span class="hljs-string">"--graph"</span></span>, <span class="hljs-string"><span class="hljs-string">"--search"</span></span>]</code> </pre><br><h2>  Bagaimana cara debut? </h2><br><h4>  Opsi keluaran log </h4><br><pre> <code class="python hljs">|log() .level(<span class="hljs-string"><span class="hljs-string">"error"</span></span>) .prefix(<span class="hljs-string"><span class="hljs-string">"something"</span></span>)</code> </pre><br>  Tonton (cli): kapacitor -url <a href="http://host-or-ip/">host-or-ip</a> : 9092 logs lvl = error <br><br><h4>  Varian dengan httpOut </h4><br>  Menampilkan data dalam pipa saat ini: <br><br><pre> <code class="python hljs">|httpOut(<span class="hljs-string"><span class="hljs-string">'something'</span></span>)</code> </pre><br>  Tonton (dapatkan): <a href="http://host-or-ip/">host-atau-ip</a> : 9092 / kapacitor / v1 / task / task_name / something <br><br><h4>  Skema eksekusi </h4><br><ul><li>  Setiap tugas mengembalikan run tree dengan angka yang berguna dalam format <a href="https://www.graphviz.org/">graphviz</a> . </li><li>  Ambil blok <a href="http://host-or-ip:9092/kapacitor/v1/tasks/task_name%3Fdot-view%3Dlabels">dot</a> . </li><li>  Kami masukkan ke dalam viewer, selamat <a href="https://dreampuf.github.io/GraphvizOnline">menikmati</a> . <br></li></ul><br><br><h2>  Di mana lagi saya bisa mendapatkan rake </h2><br><h4>  timestamp influxdb pada writeback </h4><br>  Misalnya, kami menyiapkan lansiran untuk jumlah permintaan per jam (grupDengan (1j)) dan ingin merekam lansiran yang terjadi di influxdb (untuk menampilkan fakta masalah pada grafik di grafana) dengan indah. <br><br>  influxDBOut () akan menulis nilai waktu dari peringatan ke timestamp, masing-masing, titik pada grafik akan dicatat lebih awal / lebih lambat dari peringatan tiba. <br><br>  Ketika akurasi diperlukan: kami melewati masalah ini dengan memanggil penangan khusus, yang akan menulis data ke influxdb dengan cap waktu saat ini. <br><br><h4>  buruh pelabuhan, bangun dan gunakan </h4><br>  Saat startup, kapacitor dapat memuat tugas, templat, dan handler dari direktori yang ditentukan dalam konfigurasi di blok [load]. <br><br>  Untuk membuat tugas dengan benar, hal-hal berikut diperlukan: <br><br><ol><li>  Nama file - meluas ke id / nama skrip </li><li>  Jenis - aliran / kumpulan </li><li>  dbrp - kata kunci untuk menunjukkan di mana basis data + kebijakan skrip bekerja (dbrp "pemasok". "autogen") </li></ol><br>  Jika tidak ada baris dengan dbrp dalam beberapa tugas batch, seluruh layanan akan menolak untuk memulai dan dengan jujur â€‹â€‹menuliskannya di log. <br><br>  Dalam chronograf, sebaliknya, baris ini tidak boleh, tidak diterima melalui antarmuka dan membuat kesalahan. <br><br>  Meretas ketika membangun wadah: Dockerfile keluar dengan -1 jika ada baris dengan //.+dbrp, yang akan segera memahami alasan file ketika membangun build. <br><br><h4>  gabung satu ke banyak </h4><br>  Contoh tugas: Anda perlu mengambil persentil ke-95 dari waktu pengoperasian layanan per minggu, bandingkan setiap menit dari 10 menit terakhir dengan nilai ini. <br><br>  Anda tidak dapat bergabung satu ke banyak, terakhir / rata-rata / median oleh sekelompok titik mengubah node menjadi stream, kesalahan "tidak dapat menambahkan tepi anak tidak cocok: batch -&gt; stream" akan kembali. <br><br>  Hasil batch, sebagai variabel dalam ekspresi lambda, juga tidak diganti. <br><br>  Ada opsi untuk menyimpan nomor yang diperlukan dari batch pertama ke file melalui udf dan memuat file ini melalui sideload. <br><br><h2>  Apa yang kita putuskan? </h2><br>  Kami memiliki sekitar 100 pemasok hotel, masing-masing dari mereka dapat memiliki beberapa koneksi, sebut saja saluran.  Ada sekitar 300 saluran ini, masing-masing saluran mungkin jatuh.  Dari semua metrik yang direkam, kami akan memantau tingkat kesalahan (permintaan dan kesalahan). <br><br><h4>  Kenapa tidak grafana? </h4><br>  Peringatan kesalahan yang dikonfigurasi dalam grafan memiliki beberapa kelemahan.  Ada yang kritis, ada yang bisa menutup mata, tergantung situasinya. <br><br>  Grafana tidak tahu bagaimana menghitung antara dimensi + peringatan, tetapi kami membutuhkan tingkat (permintaan-kesalahan) / permintaan. <br><br>  Kesalahan terlihat ganas: <br><br><img src="https://habrastorage.org/webt/iq/0h/nq/iq0hnqauk_l0nm4akwynyeb0hbc.png"><br><br>  Dan kurang ganas jika dilihat dengan permintaan yang sukses: <br><br><img src="https://habrastorage.org/webt/mw/vs/ok/mwvsok9hb7qfa3lifpna4_rrno4.png"><br><br>  Oke, kita bisa menghitung di dalam layanan sebelum grafana, dan dalam beberapa kasus akan dilakukan.  Tapi bukan milik kita, karena  untuk setiap saluran, rasionya dianggap â€œnormalâ€, dan peringatan bekerja sesuai dengan nilai statis (kita melihat dengan mata kita, berubah, jika sering waspada). <br><br>  Ini adalah contoh "normal" untuk saluran yang berbeda: <br><br><img src="https://habrastorage.org/webt/3f/d5/fg/3fd5fg6los9dg7pjlkuanfuv_mk.png"><br><br><img src="https://habrastorage.org/webt/hp/n-/q6/hpn-q6cnqtaugwlsmch1jvapnuc.png"><br><br>  Kami mengabaikan paragraf sebelumnya dan menganggap bahwa semua pemasok memiliki gambaran "normal".  Sekarang semuanya baik-baik saja, dan bisakah kita bertahan dengan peringatan di grafana? <br>  Kita bisa, tetapi benar-benar tidak mau, karena kita harus memilih salah satu opsi: <br>  a) membuat banyak grafik untuk setiap saluran secara terpisah (dan dengan susah payah menyertai mereka) <br>  b) meninggalkan satu bagan dengan semua saluran (dan tersesat dalam garis berwarna dan peringatan yang disetel) <br><br><img src="https://habrastorage.org/webt/sk/8c/-b/sk8c-bayyodb08xuchmfbfjhe8q.png"><br><br><h4>  Bagaimana kamu melakukannya? </h4><br>  Sekali lagi, dokumentasi memiliki contoh awal yang baik ( <a href="https://docs.influxdata.com/kapacitor/v1.5/guides/join_backfill/">Menghitung tingkat di seluruh seri bergabung</a> ), Anda dapat mengintip atau mengambil sebagai dasar dalam tugas serupa. <br><br>  Apa yang Anda lakukan sebagai hasilnya: <br><br><ul><li>  bergabung dengan dua episode dalam beberapa jam, pengelompokan berdasarkan saluran; </li><li>  isi seri dengan kelompok, jika tidak ada data; </li><li>  bandingkan median 10 menit terakhir dengan data sebelumnya; </li><li>  kita berteriak jika kita menemukan sesuatu; </li><li>  tulis harga yang dihitung dan peringatan yang muncul di influxdb; </li><li>  mengirim pesan yang bermanfaat ke slack. </li></ul><br>  Menurut pendapat saya, kami mengelola segala hal seindah mungkin yang ingin kami dapatkan pada keluaran (dan bahkan sedikit lagi dengan penangan khusus). <br><br>  Di github.com Anda dapat melihat <a href="">kode sampel</a> dan <a href="">diagram minimal (graphviz) dari</a> skrip yang dihasilkan. <br><br><div class="spoiler">  <b class="spoiler_title">Contoh kode yang dihasilkan:</b> <div class="spoiler_text"><pre> <code class="python hljs">dbrp <span class="hljs-string"><span class="hljs-string">"supplier"</span></span>.<span class="hljs-string"><span class="hljs-string">"autogen"</span></span> var name = <span class="hljs-string"><span class="hljs-string">'requests.rate'</span></span> var grafana_dash = <span class="hljs-string"><span class="hljs-string">'pczpmYZWU/mydashboard'</span></span> var grafana_panel = <span class="hljs-string"><span class="hljs-string">'26'</span></span> var period = <span class="hljs-number"><span class="hljs-number">8</span></span>h var todayPeriod = <span class="hljs-number"><span class="hljs-number">10</span></span>m var every = <span class="hljs-number"><span class="hljs-number">1</span></span>m var warnAlert = <span class="hljs-number"><span class="hljs-number">15</span></span> var warnReset = <span class="hljs-number"><span class="hljs-number">5</span></span> var reqQuery = <span class="hljs-string"><span class="hljs-string">'SELECT sum("count") AS value FROM "supplier"."autogen"."requests"'</span></span> var errQuery = <span class="hljs-string"><span class="hljs-string">'SELECT sum("count") AS value FROM "supplier"."autogen"."errors"'</span></span> var prevErr = batch |query(errQuery) .period(period) .every(every) .groupBy(<span class="hljs-number"><span class="hljs-number">1</span></span>m, <span class="hljs-string"><span class="hljs-string">'channel'</span></span>, <span class="hljs-string"><span class="hljs-string">'supplier'</span></span>) var prevReq = batch |query(reqQuery) .period(period) .every(every) .groupBy(<span class="hljs-number"><span class="hljs-number">1</span></span>m, <span class="hljs-string"><span class="hljs-string">'channel'</span></span>, <span class="hljs-string"><span class="hljs-string">'supplier'</span></span>) var rates = prevReq |join(prevErr) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'req'</span></span>, <span class="hljs-string"><span class="hljs-string">'err'</span></span>) .tolerance(<span class="hljs-number"><span class="hljs-number">1</span></span>m) .fill(<span class="hljs-string"><span class="hljs-string">'null'</span></span>) //   ,     |default() .field(<span class="hljs-string"><span class="hljs-string">'err.value'</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>) .field(<span class="hljs-string"><span class="hljs-string">'req.value'</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>) // <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>:  ,     |eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-string"><span class="hljs-string">"err.value"</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100.0</span></span> * (float(<span class="hljs-string"><span class="hljs-string">"req.value"</span></span>) - float(<span class="hljs-string"><span class="hljs-string">"err.value"</span></span>)) / float(<span class="hljs-string"><span class="hljs-string">"req.value"</span></span>), <span class="hljs-number"><span class="hljs-number">100.0</span></span>)) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) //      rates |influxDBOut() .quiet() .create() .database(<span class="hljs-string"><span class="hljs-string">'kapacitor'</span></span>) .retentionPolicy(<span class="hljs-string"><span class="hljs-string">'autogen'</span></span>) .measurement(<span class="hljs-string"><span class="hljs-string">'rates'</span></span>) //     <span class="hljs-number"><span class="hljs-number">10</span></span> ,   var todayRate = rates |where(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: duration((unixNano(now()) - unixNano(<span class="hljs-string"><span class="hljs-string">"time"</span></span>)) / <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>u) &lt; todayPeriod) |median(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'median'</span></span>) var prevRate = rates |median(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'median'</span></span>) var joined = todayRate |join(prevRate) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'today'</span></span>, <span class="hljs-string"><span class="hljs-string">'prev'</span></span>) |httpOut(<span class="hljs-string"><span class="hljs-string">'join'</span></span>) var trigger = joined |alert() .warn(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: (<span class="hljs-string"><span class="hljs-string">"prev.median"</span></span> - <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) &gt; warnAlert) .warnReset(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: (<span class="hljs-string"><span class="hljs-string">"prev.median"</span></span> - <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) &lt; warnReset) .flapping(<span class="hljs-number"><span class="hljs-number">0.25</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .stateChangesOnly() //   message      .message( <span class="hljs-string"><span class="hljs-string">'{{ .Level }}: {{ index .Tags "channel" }} err/req ratio ({{ index .Tags "supplier" }}) {{ if eq .Level "OK" }}It is ok now{{ else }} '</span></span>+string(todayPeriod)+<span class="hljs-string"><span class="hljs-string">' median is {{ index .Fields "today.median" | printf "%0.2f" }}%, by previous '</span></span>+string(period)+<span class="hljs-string"><span class="hljs-string">' is {{ index .Fields "prev.median" | printf "%0.2f" }}%{{ end }} http://grafana.ostrovok.in/d/'</span></span>+string(grafana_dash)+ <span class="hljs-string"><span class="hljs-string">'?var-supplier={{ index .Tags "supplier" }}&amp;var-channel={{ index .Tags "channel" }}&amp;panelId='</span></span>+string(grafana_panel)+<span class="hljs-string"><span class="hljs-string">'&amp;fullscreen&amp;tz=UTC%2B03%3A00'</span></span> ) .id(<span class="hljs-string"><span class="hljs-string">'{{ index .Tags "name" }}/{{ index .Tags "channel" }}'</span></span>) .levelTag(<span class="hljs-string"><span class="hljs-string">'level'</span></span>) .messageField(<span class="hljs-string"><span class="hljs-string">'message'</span></span>) .durationField(<span class="hljs-string"><span class="hljs-string">'duration'</span></span>) .topic(<span class="hljs-string"><span class="hljs-string">'slack_graph'</span></span>) // <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>   <span class="hljs-string"><span class="hljs-string">"value"</span></span>,        (keep) trigger |eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'value'</span></span>) .keep() |influxDBOut() .quiet() .create() .database(<span class="hljs-string"><span class="hljs-string">'kapacitor'</span></span>) .retentionPolicy(<span class="hljs-string"><span class="hljs-string">'autogen'</span></span>) .measurement(<span class="hljs-string"><span class="hljs-string">'alerts'</span></span>) .tag(<span class="hljs-string"><span class="hljs-string">'alertName'</span></span>, name)</code> </pre><br></div></div><br><h2>  Apa kesimpulannya? </h2><br>  Kapacitor sangat baik dalam memonitor peringatan dengan sekelompok grup, melakukan perhitungan tambahan pada metrik yang sudah direkam, melakukan tindakan kustom dan menjalankan skrip (udf). <br><br>  Ambang entri tidak terlalu tinggi - coba jika grafana atau alat lain tidak sepenuhnya memenuhi Daftar Keinginan Anda. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id478702/">https://habr.com/ru/post/id478702/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id478690/index.html">Perakitan dinamis dan penyebaran gambar Docker dengan werf menggunakan contoh situs dokumentasi versi</a></li>
<li><a href="../id478692/index.html">Bagaimana Java 8 didukung di Android</a></li>
<li><a href="../id478694/index.html">Karena kami merekomendasikan katalog terbaru di bioskop online ivi (+ kode Python)</a></li>
<li><a href="../id478696/index.html">Bagaimana Saya Mengunjungi Urban Tech 2019. Laporan Acara</a></li>
<li><a href="../id478698/index.html">Kami membuat rencana medan interaktif dalam 15 menit</a></li>
<li><a href="../id478706/index.html">Arsitek beban tinggi. Kursus baru dari OTUS</a></li>
<li><a href="../id478708/index.html">Bagaimana pengacak memungkinkan Anda menghembuskan kehidupan baru ke dalam game lama</a></li>
<li><a href="../id478710/index.html">Penerapan aplikasi yang mudah dan santai di Tarantool Cartridge (bagian 1)</a></li>
<li><a href="../id478712/index.html">Bagaimana tidak membayar hosting Java atau mulai cepat dengan Google App Engine</a></li>
<li><a href="../id478720/index.html">Siaran publik Heisenbug dan Mobius</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>