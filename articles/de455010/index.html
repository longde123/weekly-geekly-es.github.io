<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå¥ üï∑Ô∏è üêΩ Asynchrone Benutzerskripte in reinem Rust ohne Frameworks und SMS üë®üèº‚Äçüè´ üë©üèæ‚Äçüé§ üéã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! 

 Bei der Entwicklung von Netzwerkdiensten und Benutzeroberfl√§chen m√ºssen manchmal komplizierte Interaktionsszenarien mit Verzweigungen u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Asynchrone Benutzerskripte in reinem Rust ohne Frameworks und SMS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455010/">  Hallo Habr! <br><br>  Bei der Entwicklung von Netzwerkdiensten und Benutzeroberfl√§chen m√ºssen manchmal komplizierte Interaktionsszenarien mit Verzweigungen und Schleifen behandelt werden.  Solche Szenarien passen nicht in eine einfache Zustandsmaschine - es reicht nicht aus, alle Daten im Sitzungsobjekt zu speichern. Es ist auch ratsam, die Route des Systems zu verfolgen, um in den einen oder anderen Zustand zu gelangen. In einigen F√§llen k√∂nnen Sie einige Schritte zur√ºckgehen, den Dialog in einer Schleife wiederholen und so weiter. .d.  Zuvor mussten Sie zu diesem Zweck eigene Datenstrukturen entwickeln, die den Stack-Computer imitieren, oder sogar Skriptsprachen von Drittanbietern verwenden.  Mit dem Aufkommen asynchroner Funktionen in fast allen Programmiersprachen ist es m√∂glich geworden, Skripte in derselben Sprache zu schreiben, in der der Dienst geschrieben ist.  Das Skript mit seinem Stapel und seinen lokalen Variablen ist eigentlich eine Benutzersitzung, dh es speichert sowohl Daten als auch die Route.  Zum Beispiel l√∂st Goroutine mit blockierendem Lesen aus dem Kanal dieses Problem leicht, aber erstens ist der gr√ºne Thread <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">nicht frei</a> , und zweitens schreiben wir in Rust, wo es keine gr√ºnen Threads gibt, sondern <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Generatoren</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Async / Warten</a> . <a name="habracut"></a><br><br>  Zum Beispiel schreiben wir einen einfachen http-Bot, der ein HTML-Formular im Browser anzeigt und dem Benutzer Fragen stellt, bis er antwortet, dass er sich gut f√ºhlt.  Das Programm ist der einfachste Single-Threaded-http-Server, wir schreiben das Bot-Skript in Form eines Rust-Generators.  Ich m√∂chte Sie daran erinnern, dass <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JavaScript-Generatoren</a> den <i>bidirektionalen Datenaustausch erm√∂glichen, dh</i> , innerhalb des Generators k√∂nnen Sie die Frage √ºbergeben: <i>my_generator.next (my_question);</i> <br>  und <i>gib</i> die Antwort zur√ºck: <i>return my_response;</i> <br>  In Rust wurde die √úbertragung von Werten innerhalb des Generators noch nicht implementiert (die Funktion <i>resume ()</i> hat keine Parameter, obwohl es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eine Diskussion gibt</a> , um dies zu beheben), daher organisieren wir den Datenaustausch √ºber eine gemeinsam genutzte Zelle, in der die Struktur mit den empfangenen und gesendeten Daten liegt.  Das Skript unseres Bots wird von der Funktion <i>create_scenario () erstellt</i> , die eine Instanz des Generators zur√ºckgibt, im Wesentlichen den Abschluss, in den der Parameter verschoben wird - einen Zeiger auf die <i>udata-Datenzelle</i> .  F√ºr jede Benutzersitzung speichern wir unsere eigene Zelle mit Daten und unserer eigenen Instanz des Generators, mit dem eigenen Status des Stapels und den Werten lokaler Variablen. <br><br><pre><code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#[derive(Default, Clone)]</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserData</span></span></span></span> { sid: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, msg_in: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, msg_out: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, script: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserDataCell</span></span></span></span> = Rc&lt;RefCell&lt;UserData&gt;&gt;; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserSession</span></span></span></span> { udata: UserDataCell, scenario: Pin&lt;<span class="hljs-built_in"><span class="hljs-built_in">Box</span></span>&lt;dyn Generator&lt;Yield = (), Return = ()&gt;&gt;&gt;, } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserSessions</span></span></span></span> = HashMap&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, UserSession&gt;; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_scenario</span></span></span></span>(udata: UserDataCell) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Generator&lt;Yield = (), Return = ()&gt; { <span class="hljs-keyword"><span class="hljs-keyword">move</span></span> || { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> uname; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> umood; udata.borrow_mut().msg_out = <span class="hljs-built_in"><span class="hljs-built_in">format!</span></span>(<span class="hljs-string"><span class="hljs-string">"Hi, what is you name ?"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> (); uname = udata.borrow().msg_in.clone(); udata.borrow_mut().msg_out = <span class="hljs-built_in"><span class="hljs-built_in">format!</span></span>(<span class="hljs-string"><span class="hljs-string">"{}, how are you feeling ?"</span></span>, uname); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> (); <span class="hljs-symbol"><span class="hljs-symbol">'not_ok</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> { umood = udata.borrow().msg_in.clone(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> umood.to_lowercase() == <span class="hljs-string"><span class="hljs-string">"ok"</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'not_ok</span></span>; } udata.borrow_mut().msg_out = <span class="hljs-built_in"><span class="hljs-built_in">format!</span></span>(<span class="hljs-string"><span class="hljs-string">"{}, think carefully, maybe you're ok ?"</span></span>, uname); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> (); umood = udata.borrow().msg_in.clone(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> umood.to_lowercase() == <span class="hljs-string"><span class="hljs-string">"ok"</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'not_ok</span></span>; } udata.borrow_mut().msg_out = <span class="hljs-built_in"><span class="hljs-built_in">format!</span></span>(<span class="hljs-string"><span class="hljs-string">"{}, millions of people are starving, maybe you're ok ?"</span></span>, uname); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> (); } udata.borrow_mut().msg_out = <span class="hljs-built_in"><span class="hljs-built_in">format!</span></span>(<span class="hljs-string"><span class="hljs-string">"{}, good bye !"</span></span>, uname); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (); } }</code> </pre> <br>  Jeder Schritt des Skripts besteht aus einfachen Aktionen - einen Link zum Inhalt der Zelle abrufen, Benutzereingaben in lokalen Variablen speichern, den Antworttext festlegen und durch <i>Ertrag</i> die Kontrolle nach au√üen <i>geben</i> .  Wie aus dem Code ersichtlich ist, gibt unser Generator ein leeres Tupel () zur√ºck, und alle Daten werden durch eine gemeinsame Zelle mit einem Referenzz√§hler <i>Ref &lt;Cell &lt;... &gt;&gt; √ºbertragen</i> .  Innerhalb des Generators m√ºssen Sie sicherstellen, dass das Ausleihen des Inhalts der <i>bor () -Zelle die Flie√ügrenze</i> nicht √ºberschreitet. Andernfalls k√∂nnen die Daten nicht von au√üerhalb des Generators aktualisiert werden. Daher k√∂nnen Sie zu Beginn des Algorithmus leider nicht einmal schreiben. <i>Lassen Sie udata_mut = udata.borrow_mut ()</i> und Sie m√ºssen nach jeder Rendite einen Wert ausleihen. <br><br>  Wir implementieren unsere eigene Ereignisschleife (Lesen aus dem Socket) und erstellen f√ºr jede eingehende Anforderung entweder eine neue Benutzersitzung oder suchen die vorhandene per Sid und aktualisieren die darin enthaltenen Daten: <br><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> udata: UserData = read_udata(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> stream); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> sid = udata.sid.clone(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> session; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sid == <span class="hljs-string"><span class="hljs-string">""</span></span> { <span class="hljs-comment"><span class="hljs-comment">//new session sid = rnd.gen::&lt;u64&gt;().to_string(); udata.sid = sid.clone(); let udata_cell = Rc::new(RefCell::new(udata)); sessions.insert( sid.clone(), UserSession { udata: udata_cell.clone(), scenario: Box::pin(create_scenario(udata_cell)), } ); session = sessions.get_mut(&amp;sid).unwrap(); } else { match sessions.get_mut(&amp;sid) { Some(s) =&gt; { session = s; session.udata.replace(udata); } None =&gt; { println!("unvalid sid: {}", &amp;sid); continue; } } }</span></span></code> </pre><br>  Als n√§chstes √ºbertragen wir die Steuerung in den entsprechenden Generator und aktualisieren die aktualisierten Daten zur√ºck in den Socket.  Im letzten Schritt, wenn das gesamte Skript abgeschlossen ist, l√∂schen wir die Sitzung aus der Hashmap und verbergen das Eingabefeld mithilfe eines js-Skripts auf der HTML-Seite. <br><br><pre> <code class="rust hljs">udata = <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> session.scenario.as_mut().resume() { GeneratorState::Yielded(_) =&gt; session.udata.borrow().clone(), GeneratorState::Complete(_) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> ud = sessions.remove(&amp;sid).unwrap().udata.borrow().clone(); ud.script = <span class="hljs-built_in"><span class="hljs-built_in">format!</span></span>(<span class="hljs-string"><span class="hljs-string">"document.getElementById('form').style.display = 'none'"</span></span>); ud } }; write_udata(&amp;udata, &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> stream);</code> </pre><br>  Vollst√§ndiger Arbeitscode hier: <br>  <a href="">github.com/epishman/habr_samples/blob/master/chatbot/main.rs</a> <br><br>  Ich entschuldige mich f√ºr die http-Analyse der ‚ÄûKollektivfarm‚Äú, die nicht einmal kyrillische Eingaben unterst√ºtzt, aber alles wird mit Standard-Sprachwerkzeugen ohne Frameworks, Bibliotheken und SMS durchgef√ºhrt.  Ich mag es nicht wirklich, Strings zu klonen, und das Skript selbst sieht aufgrund der <i>h√§ufigen</i> Verwendung von <i>bor_mut ()</i> und <i>clone ()</i> nicht sehr kompakt aus.  Wahrscheinlich erfahrene Rastamane k√∂nnen dies vereinfachen (z. B. mithilfe von Makros).  Die Hauptsache ist, dass das Problem mit minimalen Mitteln gel√∂st wird, und ich hoffe, dass wir bald einen vollst√§ndigen Satz asynchroner Tools in einer stabilen Version erhalten. <br><br>  PS <br>  Zum Kompilieren ben√∂tigen Sie einen n√§chtlichen Build: <br><pre> <code class="bash hljs">rustup default nightly rustup update</code> </pre><br>  Genossen vom englischen Stapel√ºberlauf halfen mir, mit den Generatoren umzugehen: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">stackoverflow.com/questions/56460206/how-can-i-transfer-some-values-into-a-rust-generator-at-each-step</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de455010/">https://habr.com/ru/post/de455010/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de454994/index.html">Was sind die Vorteile des kabellosen Ladens und warum steckt die Zukunft dahinter? Pers√∂nliche Erfahrung f√ºr 2019</a></li>
<li><a href="../de454996/index.html">Cosmonaut Training Center benannt nach Yu.A. Gagarin und Roscosmos begannen mit der offenen Rekrutierung in den Kosmonauten-Trupp</a></li>
<li><a href="../de455002/index.html">Willkommen zur Top 3D Expo im September</a></li>
<li><a href="../de455004/index.html">Einheit: Eine endlose prozedural erzeugte Stadt, die mit dem WFC-Algorithmus erhalten wurde (Wellenfunktionskollaps)</a></li>
<li><a href="../de455006/index.html">Fernbedienung mit drei Befehlen und einem Programm von 290 16-Bit-W√∂rtern</a></li>
<li><a href="../de455012/index.html">H√§ufig gestellte Fragen zum zellul√§ren Abfangen: Was sind IMSI-Abfangj√§ger / SCATs und kann ich mich vor ihnen sch√ºtzen?</a></li>
<li><a href="../de455016/index.html">Wir erstellen die unzug√§nglichste Website mit einer idealen Bewertung Leuchtturm</a></li>
<li><a href="../de455018/index.html">Der Posten der gro√üen Liebe f√ºr kleine Unternehmen</a></li>
<li><a href="../de455020/index.html">Vor- und Nachteile der Verwendung von Flutter f√ºr die mobile Entwicklung</a></li>
<li><a href="../de455024/index.html">5 Common-Sense-Prinzipien zum Erstellen von Cloud-nativen Apps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>