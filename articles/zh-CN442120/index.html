<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎆 👦🏼 ⛸️ 使用Azure机器学习服务训练TensorFlow模型 🎞️ 🤰🏾 🙆🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="为了使用TensorFlow进行深度神经网络（DNN）培训，Azure机器学习提供了TensorFlow用户类Estimator评估工具。 Azure SDK中的TensorFlow评估TensorFlow （不要与tf.estimator.Estimator类混淆）可以轻松地为Azure计算资源中...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>使用Azure机器学习服务训练TensorFlow模型</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/442120/"><p>为了使用TensorFlow进行深度神经网络（DNN）培训，Azure机器学习提供了<code>TensorFlow</code>用户类<code>Estimator</code>评估工具。  Azure SDK中的<code>TensorFlow</code>评估<code>TensorFlow</code> （不要与<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>tf.estimator.Estimator</code></a>类混淆）可以轻松地为Azure计算资源中的单节点和分布式运行提交TensorFlow培训作业。 </p><br><img src="https://habrastorage.org/webt/vc/ug/bv/vcugbv2krcfpaqlxwymazqdloba.jpeg"><a name="habracut"></a><br><br><h2> 单点培训 </h2><br><p> 使用<code>TensorFlow</code>评估<code>TensorFlow</code>学习与使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>  Estimator</code></a>类似，因此请先阅读操作方法文章并学习概念。 </p><br><p> 要完成TensorFlow任务，您必须创建一个<code>TensorFlow</code>对象。 您应该已经创建了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">目标计算资源</a>的<code>compute_target</code>对象。 </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> azureml.train.dnn <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TensorFlow script_params = { <span class="hljs-string"><span class="hljs-string">'--batch-size'</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">'--learning-rate'</span></span>: <span class="hljs-number"><span class="hljs-number">0.01</span></span>, } tf_est = TensorFlow(source_directory=<span class="hljs-string"><span class="hljs-string">'./my-tf-proj'</span></span>, script_params=script_params, compute_target=compute_target, entry_script=<span class="hljs-string"><span class="hljs-string">'train.py'</span></span>, conda_packages=[<span class="hljs-string"><span class="hljs-string">'scikit-learn'</span></span>], use_gpu=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre> <br><p> 在TensorFlow构造函数中指定以下参数。 </p><table><thead><tr><th width="150"> 参量 </th><th> 说明 </th></tr></thead><tbody><tr><td> <code>source_directory</code> </td> <td> 本地目录，其中包含完成培训所需的所有代码。 该文件夹从本地计算机复制到远程计算资源。 </td></tr><tr><td> <code>script_params</code> </td> <td> 一个字典，用于将<code>entry_script</code>培训<code>entry_script</code>命令行参数指定为成对&lt;命令行参数，值&gt;。 </td></tr><tr><td> <code>compute_target</code> </td> <td> 训练脚本将在其上运行的远程计算目标。 在我们的例子中，这是Azure机器学习计算环境（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AmlCompute</a> ）的群集。 </td></tr><tr><td> <code>entry_script</code> </td> <td> 将在远程计算资源上执行的训练脚本文件的路径（相对于<code>source_directory</code> ）。 此文件和它依赖的其他文件应位于此文件夹中。 </td></tr><tr><td> <code>conda_packages</code> </td> <td> 使用conda安装培训脚本所需的Python软件包列表。 在这种情况下，训练脚本使用<code>sklearn</code>下载数据，因此您必须指定此软件包进行安装。 构造函数的<code>pip_packages</code>参数可用于所有必需的pip包。 </td></tr><tr><td> <code>use_gpu</code> </td> <td> 将此标志设置为<code>True</code>可使用GPU进行训练。 默认值为<code>False</code> 。 </td></tr></tbody></table><p> 由于您使用的是TensorFlow评估工具，因此默认情况下，用于训练的容器将包含TensorFlow软件包以及在CPU和GPU中进行训练所需的相关依赖项。 </p><br><p> 然后提交TensorFlow作业： </p><br><pre> <code class="python hljs">run = exp.submit(tf_est)</code> </pre> <br><h2> 分布式培训 </h2><br><p>  TensorFlow评估工具还允许您在Azure虚拟机的CPU和GPU群集中训练模型。  TensorFlow分布式培训是通过几个API调用提供的，其中Azure机器学习服务在后台管理完成这些工作负载所需的基础结构和业务流程功能。 </p><br><p>  Azure机器学习服务在TensorFlow中支持两种分布式学习方法。 </p><br><ul><li> 使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Horovod</a>平台的基于MPI的分布式学习。 </li><li> 使用参数服务器方法的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">TensorFlow</a>本机<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">分布式培训</a> 。 </li></ul><br><h3> 霍罗沃德 </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Horovod</a>是Uber开发的一种基于开源分布式学习的环减少算法。 </p><br><p> 要使用Horovod平台运行TensorFlow分布式培训，请创建TensorFlow对象，如下所示： </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> azureml.train.dnn <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TensorFlow tf_est = TensorFlow(source_directory=<span class="hljs-string"><span class="hljs-string">'./my-tf-proj'</span></span>, script_params={}, compute_target=compute_target, entry_script=<span class="hljs-string"><span class="hljs-string">'train.py'</span></span>, node_count=<span class="hljs-number"><span class="hljs-number">2</span></span>, process_count_per_node=<span class="hljs-number"><span class="hljs-number">1</span></span>, distributed_backend=<span class="hljs-string"><span class="hljs-string">'mpi'</span></span>, use_gpu=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre> <br><p> 上面的代码在TensorFlow构造函数中显示了以下新选项。 </p><table><thead><tr><th width="190"> 参量 </th><th> 说明 </th><th width="100"> 预设值 </th></tr></thead><tbody><tr><td> <code>node_count</code> </td> <td> 用于训练任务的节点数。 </td><td> <code>1</code> </td> </tr><tr><td> <code>process_count_per_node</code> </td> <td> 每个节点上正在运行的进程（或工作角色）的数量。 </td><td> <code>1</code> </td> </tr><tr><td> <code>distributed_backend</code> </td> <td>  MPI评估工具提供的用于运行分布式学习的服务器端。 若要使用MPI（和Horovod）执行并行或分布式训练（例如， <code>node_count</code> &gt; 1或<code>process_count_per_node</code> &gt; 1，或两者都进行），请设置<code>distributed_backend='mpi'</code> mpi'。Azure机器学习使用MPI <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Open MPI</a>实现。 </td><td> <code>None</code> </td> </tr></tbody></table><p> 在上面的示例中，将使用两个工作角色执行分布式培训-每个节点一个工作角色。 </p><br><p>  Horovod及其依赖项将自动安装，因此您只需将它们导入到<code>train.py</code>培训<code>train.py</code> ，如下所示： </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tensorflow <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tf <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> horovod</code> </pre> <br><p> 最后，提交您的TensorFlow作业： </p><br><pre> <code class="python hljs">run = exp.submit(tf_est)</code> </pre> <br><h3> 参数服务器 </h3><br><p> 您也可以使用参数服务器模型开始<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">自己的TensorFlow分布式培训</a> 。 在这种方法中，培训是在参数服务器和工作角色的集群中进行的。 在培训期间，工作人员角色将计算梯度，而参数服务器将对梯度进行统计处理。 </p><br><p> 创建一个TensorFlow对象： </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> azureml.train.dnn <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TensorFlow tf_est = TensorFlow(source_directory=<span class="hljs-string"><span class="hljs-string">'./my-tf-proj'</span></span>, script_params={}, compute_target=compute_target, entry_script=<span class="hljs-string"><span class="hljs-string">'train.py'</span></span>, node_count=<span class="hljs-number"><span class="hljs-number">2</span></span>, worker_count=<span class="hljs-number"><span class="hljs-number">2</span></span>, parameter_server_count=<span class="hljs-number"><span class="hljs-number">1</span></span>, distributed_backend=<span class="hljs-string"><span class="hljs-string">'ps'</span></span>, use_gpu=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre> <br><p> 在上面的代码中，请注意TensorFlow构造函数中的以下参数。 </p><table><thead><tr><th width="150"> 参量 </th><th> 说明 </th><th width="100"> 预设值 </th></tr></thead><tbody><tr><td> <code>worker_count</code> </td> <td> 工作角色的数量。 </td><td> <code>1</code> </td> </tr><tr><td> <code>parameter_server_count</code> </td> <td> 参数服务器的数量。 </td><td> <code>1</code> </td> </tr><tr><td> <code>distributed_backend</code> </td> <td> 用于分布式训练的服务器部分，要使用参数服务器进行分布式训练，请设置值<code>distributed_backend='ps'</code> 。 </td><td> <code>None</code> </td> </tr></tbody></table><h4> 关于<code>TF_CONFIG</code>注释 </h4><br><p> 您还将需要<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>tf.train.ClusterSpec</code></a>群集网络地址和端口，因此Azure机器学习服务会自动设置<code>TF_CONFIG</code>环境<code>TF_CONFIG</code> 。 </p><br><p>  <code>TF_CONFIG</code>环境<code>TF_CONFIG</code>是JSON字符串。 以下是参数服务器的示例变量。 </p><br><pre> <code class="python hljs">TF_CONFIG=<span class="hljs-string"><span class="hljs-string">'{ "cluster": { "ps": ["host0:2222", "host1:2222"], "worker": ["host2:2222", "host3:2222", "host4:2222"], }, "task": {"type": "ps", "index": 0}, "environment": "cloud" }'</span></span></code> </pre> <br><p> 如果您使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>tf.estimator</code></a> TensorFlow高级API， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>tf.estimator</code></a>将解析此<code>TF_CONFIG</code>变量并形成集群规范。 </p><br><p> 如果您使用较低级别的API进行培训，则需要自己分析<code>TF_CONFIG</code>变量，并在培训代码中创建<code>tf.train.ClusterSpec</code> 。 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此示例中，</a>这些操作在<strong>训练脚本</strong>中执行，如下所示： </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os, json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tensorflow <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tf tf_config = os.environ.get(<span class="hljs-string"><span class="hljs-string">'TF_CONFIG'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> tf_config <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> tf_config == <span class="hljs-string"><span class="hljs-string">""</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> ValueError(<span class="hljs-string"><span class="hljs-string">"TF_CONFIG not found."</span></span>) tf_config_json = json.loads(tf_config) cluster_spec = tf.train.ClusterSpec(cluster)</code> </pre> <br><p> 完成训练脚本并创建TensorFlow对象后，提交训练任务： </p><br><pre> <code class="python hljs">run = exp.submit(tf_est)</code> </pre> <br><h2> 例子 </h2><br><p> 对于分布式深度学习笔记本，请参阅GitHub存储库 </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Azureml的用法/深度学习培训</a> </li></ul><br><p> 按照有关<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">如何使用Jupyter笔记本学习此服务</a>的文章中的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">说明，学习如何运行笔记本</a> 。 </p><br><h2> 附加信息 </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在培训期间跟踪绩效指标</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">超级设定</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">部署训练有素的模型</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN442120/">https://habr.com/ru/post/zh-CN442120/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN442110/index.html">反模式Vim</a></li>
<li><a href="../zh-CN442112/index.html">新的编程语言悄悄地杀死了我们与现实的联系</a></li>
<li><a href="../zh-CN442114/index.html">智能合约自动审核指南。 第3部分：秘银</a></li>
<li><a href="../zh-CN442116/index.html">使用React.memo（）改善React组件的功能</a></li>
<li><a href="../zh-CN442118/index.html">Coinhive矿池停止工作</a></li>
<li><a href="../zh-CN442122/index.html">一个简单的莫斯科Levelord：采访Nukem公爵的创造者</a></li>
<li><a href="../zh-CN442124/index.html">Facebook将为用户提供清理故事的机会</a></li>
<li><a href="../zh-CN442128/index.html">粒子上的生命</a></li>
<li><a href="../zh-CN442130/index.html">Raspberry Pi 3B +和WebMeeting更新上的3CX v16测试</a></li>
<li><a href="../zh-CN442132/index.html">使用Python SDK入门Azure机器学习</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>