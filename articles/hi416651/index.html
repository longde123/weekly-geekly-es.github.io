<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯОи ЁЯОб ЁЯШ╢ 1 рд╕реАрдкреАрдпреВ рдХреЛрд░ рдкрд░ 1M HTTP рдЖрд░рдкреАрдПрд╕ред рдирдЧреАрдиреЗрдХреНрд╕ + рд▓рд╛рдЗрдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рдЯреАрд╕реАрдкреА / рдЖрдИрдкреА рдХреЗ рдмрдЬрд╛рдп рдбреАрдкреАрдбреАрдХреЗ ЁЯЩЗЁЯП╛ ЁЯеЙ ЁЯМйя╕П</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдореИрдВ рдбреАрдкреАрдбреАрдХреЗ рдЬреИрд╕реА рдЪреАрдЬ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВ - рдпрд╣ рдХрд░реНрдиреЗрд▓ рдХреЛ рджрд░рдХрд┐рдирд╛рд░ рдХрд░ рдиреЗрдЯрд╡рд░реНрдХ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд░реВрдкрд░реЗрдЦрд╛ рд╣реИред рдпрд╛рдиреА рдЖрдк рдХрд┐рд╕реА рднреА рд╕рд┐рд╕реНрдЯрдо рдХреЙ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>1 рд╕реАрдкреАрдпреВ рдХреЛрд░ рдкрд░ 1M HTTP рдЖрд░рдкреАрдПрд╕ред рдирдЧреАрдиреЗрдХреНрд╕ + рд▓рд╛рдЗрдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рдЯреАрд╕реАрдкреА / рдЖрдИрдкреА рдХреЗ рдмрдЬрд╛рдп рдбреАрдкреАрдбреАрдХреЗ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416651/">  рдореИрдВ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдбреАрдкреАрдбреАрдХреЗ</a> рдЬреИрд╕реА рдЪреАрдЬ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╣реВрдВ</a> - рдпрд╣ рдХрд░реНрдиреЗрд▓ рдХреЛ рджрд░рдХрд┐рдирд╛рд░ рдХрд░ рдиреЗрдЯрд╡рд░реНрдХ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд░реВрдкрд░реЗрдЦрд╛ рд╣реИред  рдпрд╛рдиреА  рдЖрдк рдХрд┐рд╕реА рднреА рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЗ рдмрд┐рдирд╛ рд╕реАрдзреЗ рдиреЗрдЯрд╡рд░реНрдХ рдХрд╛рд░реНрдб рдХреА рдХрддрд╛рд░ рдореЗрдВ рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП userland \ рд╕реЗ рд▓рд┐рдЦ рд╕рдХрддреЗ рд╣реИрдВред  рдпрд╣ рдЖрдкрдХреЛ рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдмрдирд╛рдиреЗ рдФрд░ рдЕрдзрд┐рдХ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рд╕рд╛рд░реЗ рдУрд╡рд░рд╣реЗрдб рдмрдЪрд╛рддрд╛ рд╣реИред  рдПрдХ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд░реВрдк рдореЗрдВ, рдореИрдВ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд▓рд┐рдЦреВрдВрдЧрд╛ рдЬреЛ http рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рдкрд░реАрдХреНрд╖рдг рдкреГрд╖реНрда рджреЗрддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХреА рдЧрддрд┐ nginx рдХреЗ рд╕рд╛рде рддреБрд▓рдирд╛ рдХрд░рддрд╛ рд╣реИред <br><a name="habracut"></a><br>  DPDK рдХреЛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдпрд╣рд╛рдБ</a> рдбрд╛рдЙрдирд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╣реИ</a> ред  рд╕реНрдерд┐рд░ рди рд▓реЗрдВ - рдпрд╣ рдореЗрд░реЗ рд▓рд┐рдП EC2 рдкрд░ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, 18.05 рд▓реЗрдВ - рдЗрд╕рдХреЗ рд╕рд╛рде рд╕рдм рдХреБрдЫ рд╢реБрд░реВ рд╣реБрдЖред  рд╢реБрд░реВ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ, рдЖрдкрдХреЛ рдлреНрд░реЗрдорд╡рд░реНрдХ рдХреЗ рд╕рд╛рдорд╛рдиреНрдп рд╕рдВрдЪрд╛рд▓рди рдХреЗ рд▓рд┐рдП <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕рд┐рд╕реНрдЯрдо</a> рдореЗрдВ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╣реИрд╡реАрдкреЗрдЬреЛрдВ</a> рдХреЛ рдЖрд░рдХреНрд╖рд┐рдд <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдХрд░рдирд╛ рд╣реЛрдЧрд╛</a> ред  рд╕рд┐рджреНрдзрд╛рдВрдд рд░реВрдк рдореЗрдВ, рдкрд░реАрдХреНрд╖рдг рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд╡рд┐рд╢рд╛рд▓рдХрд╛рдп рдмрд┐рдирд╛ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд╡рд┐рдХрд▓реНрдк рдХреЗ рд╕рд╛рде рд▓реЙрдиреНрдЪ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдореИрдВрдиреЗ рд╣рдореЗрд╢рд╛ рдЙрдиреНрд╣реЗрдВ рд╢рд╛рдорд┐рд▓ рдХрд┐рдпрд╛ред  * Grub-mkconfig рдХреЗ рдмрд╛рдж рдЕрдкрдбреЗрдЯ-рдЧреНрд░реБрдм рдХреЛ рди рднреВрд▓реЗрдВ * рдЬрдм рдЖрдк рдмрд╣реБрдд рдмрдбрд╝реЗ рдкреИрдорд╛рдиреЗ рдкрд░ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЬрд╛рддреЗ рд╣реИрдВ, рддреЛ рддреБрд░рдВрдд ./usertools/dpdk-setup.py рдкрд░ рдЬрд╛рдПрдВ - рдпрд╣ рдЪреАрдЬрд╝ рд╕рдм рдХреБрдЫ рдПрдХрддреНрд░ рдФрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдЧреАред  Google рдореЗрдВ рдЖрдк dpdk-setup.py рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рдЗрдХрдЯреНрдард╛ рдХрд░рдиреЗ рдФрд░ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреА рд╕рд┐рдлрд╛рд░рд┐рд╢ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдирд┐рд░реНрджреЗрд╢ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ - рдРрд╕рд╛ рди рдХрд░реЗрдВред  рдареАрдХ рд╣реИ, рдЖрдк рдпрд╣ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдХреЗрд╡рд▓ рдореЗрд░реЗ рд╕рд╛рде, рдЬрдмрдХрд┐ рдореИрдВрдиреЗ dpdk-setup.py рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛, рдХреБрдЫ рднреА рдХрд╛рдо рдирд╣реАрдВ рдХрд┐рдпрд╛ред  рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ, dpdk-setup.py рдХреЗ рдЕрдВрджрд░ рдХреНрд░рд┐рдпрд╛рдУрдВ рдХрд╛ рдХреНрд░рдо: <br><br><ul><li>  x86_x64 linux рдмрдирд╛рдПрдБ </li><li>  рд▓реЛрдб igb рдпреВрдЖрдИрдУ рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ </li><li>  рдирдХреНрд╢рд╛ рд╡рд┐рд╢рд╛рд▓ / mnt / рд╡рд┐рд╢рд╛рд▓ </li><li>  рдпреВрдЖрдИрдУ рдореЗрдВ рд╡рд╛рдВрдЫрд┐рдд рдирд┐рдХ рдХреЛ рдмрд╛рдВрдзреЗрдВ (рдЗрд╕рд╕реЗ рдкрд╣рд▓реЗ ifconfig ethX рдХреЛ рдХрд░рдирд╛ рди рднреВрд▓реЗрдВ) </li></ul><br>  рдЙрд╕рдХреЗ рдмрд╛рдж, рдЖрдк рдЗрд╕рдХреЗ рд╕рд╛рде рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рд░рди рдмрдирд╛рдХрд░ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВред  рдХреЗрд╡рд▓ рдПрдХ рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ RTE_SDK рдмрдирд╛рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдЬреЛ DPDK рдХреЗ рд╕рд╛рде рдПрдХ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИред <br><br>  <a href="">рдпрд╣рд╛рдБ</a> рдкреВрд░реНрдг рдЙрджрд╛рд╣рд░рдг рдХреЛрдб рдирд┐рд╣рд┐рдд рд╣реИред  рдЗрд╕рдореЗрдВ рдЖрд░рдВрднреАрдХрд░рдг, рдЯреАрд╕реАрдкреА / рдЖрдИрдкреА рдФрд░ рдЖрджрд┐рдо http рдкрд╛рд░реНрд╕рд░ рдХреЗ рдЖрджрд┐рдо рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╢рд╛рдорд┐рд▓ рд╣реИред  рдЖрдЗрдП рдЖрд░рдВрдн рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВред <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">** argv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret; <span class="hljs-comment"><span class="hljs-comment">//  dpdk ret = rte_eal_init(argc, argv); if (ret &lt; 0) { rte_panic("Cannot init EAL\n"); } //  memory pool g_packet_mbuf_pool = rte_pktmbuf_pool_create("mbuf_pool", 131071, 32, 0, RTE_MBUF_DEFAULT_BUF_SIZE, rte_socket_id()); if (g_packet_mbuf_pool == NULL) { rte_exit(EXIT_FAILURE, "Cannot init mbuf pool\n"); } g_tcp_state_pool = rte_mempool_create("tcp_state_pool", 65535, sizeof(struct tcp_state), 0, 0, NULL, NULL, NULL, NULL, rte_socket_id(), 0); if (g_tcp_state_pool == NULL) { rte_exit(EXIT_FAILURE, "Cannot init tcp_state pool\n"); } //  hash table struct rte_hash_parameters hash_params = { .entries = 64536, .key_len = sizeof(struct tcp_key), .socket_id = rte_socket_id(), .hash_func_init_val = 0, .name = "tcp clients table" }; g_clients = rte_hash_create(&amp;hash_params); if (g_clients == NULL) { rte_exit(EXIT_FAILURE, "No hash table created\n"); } //    1     uint8_t nb_ports = rte_eth_dev_count(); if (nb_ports == 0) { rte_exit(EXIT_FAILURE, "No Ethernet ports - bye\n"); } if (nb_ports &gt; 1) { rte_exit(EXIT_FAILURE, "Not implemented. Too much ports\n"); } //     struct rte_eth_conf port_conf = { .rxmode = { .split_hdr_size = 0, .header_split = 0, /**&lt; Header Split disabled */ .hw_ip_checksum = 0, /**&lt; IP checksum offload disabled */ .hw_vlan_filter = 0, /**&lt; VLAN filtering disabled */ .jumbo_frame = 0, /**&lt; Jumbo Frame Support disabled */ .hw_strip_crc = 0, /**&lt; CRC stripped by hardware */ }, .txmode = { .mq_mode = ETH_MQ_TX_NONE, }, }; //          port_conf.txmode.offloads |= DEV_TX_OFFLOAD_IPV4_CKSUM; port_conf.txmode.offloads |= DEV_TX_OFFLOAD_TCP_CKSUM; ret = rte_eth_dev_configure(0, RX_QUEUE_COUNT, TX_QUEUE_COUNT, &amp;port_conf); if (ret &lt; 0) { rte_exit(EXIT_FAILURE, "Cannot configure device: err=%d\n", ret); } //     for (uint16_t j=0; j&lt;RX_QUEUE_COUNT; ++j) { ret = rte_eth_rx_queue_setup(0, j, 1024, rte_eth_dev_socket_id(0), NULL, g_packet_mbuf_pool); if (ret &lt; 0) { rte_exit(EXIT_FAILURE, "rte_eth_rx_queue_setup:err=%d\n", ret); } } //    struct rte_eth_txconf txconf = { .offloads = port_conf.txmode.offloads, }; for (uint16_t j=0; j&lt;TX_QUEUE_COUNT; ++j) { ret = rte_eth_tx_queue_setup(0, j, 1024, rte_eth_dev_socket_id(0), &amp;txconf); if (ret &lt; 0) { rte_exit(EXIT_FAILURE, "rte_eth_tx_queue_setup:err=%d\n", ret); } } // NIC ret = rte_eth_dev_start(0); if (ret &lt; 0) { rte_exit(EXIT_FAILURE, "rte_eth_dev_start:err=%d\n", ret); } //   lcore_hello(NULL); return 0; }</span></span></code> </pre> <br>  рдЙрд╕ рд╕рдордп, рдЬрдм dpdk-setup.py рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣рдо рдЪрдпрдирд┐рдд рдиреЗрдЯрд╡рд░реНрдХ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЛ dpdk рдбреНрд░рд╛рдЗрд╡рд░ рд╕реЗ рдмрд╛рдБрдзрддреЗ рд╣реИрдВ, рдпрд╣ рдиреЗрдЯрд╡рд░реНрдХ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХрд░реНрдиреЗрд▓ рдХреЗ рд▓рд┐рдП рд╕реБрд▓рдн рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред  рдЙрд╕рдХреЗ рдмрд╛рдж, рдиреЗрдЯрд╡рд░реНрдХ рдХрд╛рд░реНрдб рдЗрд╕ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдореЗрдВ рдЖрдиреЗ рд╡рд╛рд▓реЗ рдХрд┐рд╕реА рднреА рдкреИрдХреЗрдЯ рдХреЛ рдбреАрдПрдордП рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЙрд╕ рдХрддрд╛рд░ рдореЗрдВ рд░рд┐рдХреЙрд░реНрдб рдХрд░реЗрдЧрд╛ рдЬреЛ рд╣рдордиреЗ рдЙрд╕реЗ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдерд╛ред <br><br>  рдФрд░ рдпрд╣рд╛рдБ рдкреИрдХреЗрдЯ рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ рд▓реВрдк рд╣реИред <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rte_mbuf</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packets</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MAX_PACKETS</span></span></span><span class="hljs-class">];</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> rx_current_queue = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//  unsigned packet_count = rte_eth_rx_burst(0, (++rx_current_queue) % RX_QUEUE_COUNT, packets, MAX_PACKETS); for (unsigned j=0; j&lt;packet_count; ++j) { struct rte_mbuf* m = packets[j]; //   ethernet  struct ether_hdr* eth_header = rte_pktmbuf_mtod(m, struct ether_hdr*); //  IP  if (RTE_ETH_IS_IPV4_HDR(m-&gt;packet_type)) { do { //   if (rte_pktmbuf_data_len(m) &lt; sizeof(struct ether_hdr) + sizeof(struct ipv4_hdr) + sizeof(struct tcp_hdr)) { TRACE; break; } struct ipv4_hdr* ip_header = (struct ipv4_hdr*)((char*)eth_header + sizeof(struct ether_hdr)); if ((ip_header-&gt;next_proto_id != 0x6) || (ip_header-&gt;version_ihl != 0x45)) { TRACE; break; } if (ip_header-&gt;dst_addr != MY_IP_ADDRESS) { TRACE; break; } if (rte_pktmbuf_data_len(m) &lt; htons(ip_header-&gt;total_length) + sizeof(struct ether_hdr)) { TRACE; break; } if (htons(ip_header-&gt;total_length) &lt; sizeof(struct ipv4_hdr) + sizeof(struct tcp_hdr)) { TRACE; break; } struct tcp_hdr* tcp_header = (struct tcp_hdr*)((char*)ip_header + sizeof(struct ipv4_hdr)); size_t tcp_header_size = (tcp_header-&gt;data_off &gt;&gt; 4) * 4; if (rte_pktmbuf_data_len(m) &lt; sizeof(struct ether_hdr) + sizeof(struct ipv4_hdr) + tcp_header_size) { TRACE; break; } if (tcp_header-&gt;dst_port != 0x5000) { TRACE; break; } size_t data_size = htons(ip_header-&gt;total_length) - sizeof(struct ipv4_hdr) - tcp_header_size; void* data = (char*)tcp_header + tcp_header_size; //     hash table struct tcp_key key = { .ip = ip_header-&gt;src_addr, .port = tcp_header-&gt;src_port }; //    tcp process_tcp(m, tcp_header, &amp;key, data, data_size); } while(0); } else if (eth_header-&gt;ether_type == 0x0608) // ARP { //     -       ARP- do { if (rte_pktmbuf_data_len(m) &lt; sizeof(struct arp) + sizeof(struct ether_hdr)) { TRACE; break; } struct arp* arp_packet = (struct arp*)((char*)eth_header + sizeof(struct ether_hdr)); if (arp_packet-&gt;opcode != 0x100) { TRACE; break; } if (arp_packet-&gt;dst_pr_add != MY_IP_ADDRESS) { TRACE; break; } send_arp_response(arp_packet); } while(0); } else { TRACE; } rte_pktmbuf_free(m); } }</span></span></code> </pre> <br>  Rte_eth_rx_burst рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрддрд╛рд░ рд╕реЗ рдкреИрдХреЗрдЯ рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрджрд┐ рдХрддрд╛рд░ рдореЗрдВ рдХреБрдЫ рд╣реИ, рддреЛ рдпрд╣ рдкреИрдХреЗрдЯ рдХреЛ рдкрдврд╝реЗрдЧрд╛ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдПрдХ рд╕рд░рдгреА рдореЗрдВ рдбрд╛рд▓ рджреЗрдЧрд╛ред  рдпрджрд┐ рдХрддрд╛рд░ рдореЗрдВ рдХреБрдЫ рднреА рдирд╣реАрдВ рд╣реИ, рддреЛ 0 рд╡рд╛рдкрд╕ рдЖ рдЬрд╛рдПрдЧрд╛, рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рдЖрдкрдХреЛ рддреБрд░рдВрдд рдЗрд╕реЗ рдлрд┐рд░ рд╕реЗ рдХреЙрд▓ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред  рд╣рд╛рдВ, рдпрд╣ рджреГрд╖реНрдЯрд┐рдХреЛрдг "рдХреБрдЫ рд╕рдордп рдХреЗ рд▓рд┐рдП рд╕реАрдкреАрдпреВ" рдЦрд░реНрдЪ рдХрд░рддрд╛ рд╣реИ рдпрджрд┐ рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдХреЛрдИ рдбреЗрдЯрд╛ рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рдЕрдЧрд░ рд╣рдордиреЗ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдбреАрдкреАрдбреАрдХреЗ рд▓рд┐рдпрд╛ рд╣реИ, рддреЛ рдпрд╣ рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рд╣рдорд╛рд░рд╛ рдорд╛рдорд▓рд╛ рдирд╣реАрдВ рд╣реИред  * рдорд╣рддреНрд╡рдкреВрд░реНрдг, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдлрд╝рдВрдХреНрд╢рди рдереНрд░реЗрдб-рд╕реБрд░рдХреНрд╖рд┐рдд</a> рдирд╣реАрдВ рд╣реИ, рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдореЗрдВ рдПрдХ рд╣реА рдХрддрд╛рд░ рд╕реЗ рдирд╣реАрдВ рдкрдврд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ * рдкреИрдХреЗрдЬ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, rte_pktmbuf_free рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред  рдПрдХ рдкреИрдХреЗрдЯ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдк rte_eth_tx_burst рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ rte_mbuf рд╕реЗ рдкреНрд░рд╛рдкреНрдд rte_pktmbuf_alloc рдХреЛ рдиреЗрдЯрд╡рд░реНрдХ рдХрд╛рд░реНрдб рдХрддрд╛рд░ рдореЗрдВ рд░рдЦрддрд╛ рд╣реИред <br><br>  рдкреИрдХреЗрдЬ рд╣реЗрдбрд░ рдХреЗ рдбрд┐рд╕рд╛рдЗрдб рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж, tcp рд╕реЗрд╢рди рдмрдирд╛рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реЛрдЧрд╛ред  Tcp рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╡рд┐рднрд┐рдиреНрди рд╡рд┐рд╢реЗрд╖ рдорд╛рдорд▓реЛрдВ, рд╡рд┐рд╢реЗрд╖ рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдФрд░ рд╕реЗрд╡рд╛ рд╕реЗ рд╡рдВрдЪрд┐рдд рд╣реЛрдиреЗ рдХреЗ рдЦрддрд░реЛрдВ рд╕реЗ рднрд░рд╛ рд╣реБрдЖ рд╣реИред  рдЕрдзрд┐рдХ рдпрд╛ рдХрдо рдкреВрд░реНрдг tcp рдХрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдПрдХ рдЕрдиреБрднрд╡реА рдбреЗрд╡рд▓рдкрд░ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрддреНрдХреГрд╖реНрдЯ рдЕрднреНрдпрд╛рд╕ рд╣реИ, рд▓реЗрдХрд┐рди рдлрд┐рд░ рднреА, рдпрд╣рд╛рдВ рдврд╛рдВрдЪреЗ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдирд╣реАрдВ рд╣реИред  рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рдкрд░реАрдХреНрд╖рдг рдХреЗ рд▓рд┐рдП tcp рдХреЛ рдкрд░реНрдпрд╛рдкреНрдд рд░реВрдк рд╕реЗ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">Dpdk рдХреЗ рд╕рд╛рде рдЖрдкреВрд░реНрддрд┐ рдХреА рдЧрдИ рд╣реИрд╢</a> рддрд╛рд▓рд┐рдХрд╛ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдПрдХ рд╕рддреНрд░ рддрд╛рд▓рд┐рдХрд╛ рдХреЛ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛, рдПрдХ tcp рдХрдиреЗрдХреНрд╢рди рдХреА рд╕реНрдерд╛рдкрдирд╛ рдФрд░ рддреЛрдбрд╝рдХрд░, рдЦрд╛рддреЗ рдХреЗ рдиреБрдХрд╕рд╛рди рдФрд░ рдкреИрдХреЗрдЯ рдкреБрди: рд╕рдВрдЪрд╛рд▓рди рдореЗрдВ рдбреЗрдЯрд╛ рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд┐рдП рдмрд┐рдирд╛ рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ред  Dpdk рдХреА рд╣реИрд╢ рдЯреЗрдмрд▓ рдореЗрдВ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реАрдорд╛ рд╣реИ рдЬрд┐рд╕реЗ рдЖрдк рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ рд▓реЗрдХрд┐рди рдХрдИ рдереНрд░реЗрдбреНрд╕ рдкрд░ рдирд╣реАрдВ рд▓рд┐рдЦ рд╕рдХрддреЗред  рдЙрджрд╛рд╣рд░рдг рдХреЛ рдПрдХрд▓-рдереНрд░реЗрдбреЗрдб рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдпрд╣ рд╕рдорд╕реНрдпрд╛ рдпрд╣рд╛рдВ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдирд╣реАрдВ рд╣реИ, рдФрд░ рдХрдИ рдХреЛрд░ рдкрд░ рдЯреНрд░реИрдлрд┐рдХ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдЖрдк рдЖрд░рдПрд╕рдПрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдПрдХ рд╣реИрд╢ рдЯреЗрдмрд▓ рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдмрд┐рдирд╛ рдмреНрд▓реЙрдХ рдХрд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред <br><br><div class="spoiler">  <b class="spoiler_title">рдЯреАрд╕реАрдкреА рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">tatic </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_tcp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct rte_mbuf* m, struct tcp_hdr* tcp_header, struct tcp_key* key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data_size)</span></span></span><span class="hljs-function"> </span></span>{ TRACE; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcp_state</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rte_hash_lookup_data(g_clients, key, (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)&amp;state) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//Documentaion lies!!! { TRACE; if ((tcp_header-&gt;tcp_flags &amp; 0x2) != 0) // SYN { TRACE; struct ether_hdr* eth_header = rte_pktmbuf_mtod(m, struct ether_hdr*); if (rte_mempool_get(g_tcp_state_pool, (void**)&amp;state) &lt; 0) { ERROR("tcp state alloc fail"); return; } memcpy(&amp;state-&gt;tcp_template, &amp;g_tcp_packet_template, sizeof(g_tcp_packet_template)); memcpy(&amp;state-&gt;tcp_template.eth.d_addr, &amp;eth_header-&gt;s_addr, 6); state-&gt;tcp_template.ip.dst_addr = key-&gt;ip; state-&gt;tcp_template.tcp.dst_port = key-&gt;port; state-&gt;remote_seq = htonl(tcp_header-&gt;sent_seq); #pragma GCC diagnostic push #pragma GCC diagnostic ignored "-Wpointer-to-int-cast" state-&gt;my_seq_start = (uint32_t)state; // not very secure. #pragma GCC diagnostic pop state-&gt;fin_sent = 0; state-&gt;http.state = HTTP_START; state-&gt;http.request_url_size = 0; //not thread safe! only one core used if (rte_hash_add_key_data(g_clients, key, state) == 0) { struct tcp_hdr* new_tcp_header; struct rte_mbuf* packet = build_packet(state, 12, &amp;new_tcp_header); if (packet != NULL) { new_tcp_header-&gt;rx_win = TX_WINDOW_SIZE; new_tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_start); state-&gt;my_seq_sent = state-&gt;my_seq_start+1; ++state-&gt;remote_seq; new_tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq); new_tcp_header-&gt;tcp_flags = 0x12; // mss = 1380, no window scaling uint8_t options[12] = {0x02, 0x04, 0x05, 0x64, 0x03, 0x03, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01}; memcpy((uint8_t*)new_tcp_header + sizeof(struct tcp_hdr), options, 12); new_tcp_header-&gt;data_off = 0x80; send_packet(new_tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp synack"); } } else { ERROR("can't add connection to table"); rte_mempool_put(g_tcp_state_pool, state); } } else { ERROR("lost connection"); } return; } if ((tcp_header-&gt;tcp_flags &amp; 0x2) != 0) // SYN retransmit { //not thread safe! only one core used if (rte_hash_del_key(g_clients, key) &lt; 0) { ERROR("can't delete key"); } else { rte_mempool_put(g_tcp_state_pool, state); return process_tcp(m, tcp_header, key, data, data_size); } } if ((tcp_header-&gt;tcp_flags &amp; 0x10) != 0) // ACK { TRACE; uint32_t ack_delta = htonl(tcp_header-&gt;recv_ack) - state-&gt;my_seq_start; uint32_t my_max_ack_delta = state-&gt;my_seq_sent - state-&gt;my_seq_start; if (ack_delta == 0) { if ((data_size == 0) &amp;&amp; (tcp_header-&gt;tcp_flags == 0x10)) { ERROR("need to retransmit. not supported"); } } else if (ack_delta &lt;= my_max_ack_delta) { state-&gt;my_seq_start += ack_delta; } else { ERROR("ack on unsent seq"); } } if (data_size &gt; 0) { TRACE; uint32_t packet_seq = htonl(tcp_header-&gt;sent_seq); if (state-&gt;remote_seq == packet_seq) { feed_http(data, data_size, state); state-&gt;remote_seq += data_size; } else if (state-&gt;remote_seq-1 == packet_seq) // keepalive { struct tcp_hdr* new_tcp_header; struct rte_mbuf* packet = build_packet(state, 0, &amp;new_tcp_header); if (packet != NULL) { new_tcp_header-&gt;rx_win = TX_WINDOW_SIZE; new_tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_sent); new_tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq); send_packet(new_tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp ack keepalive"); } } else { struct tcp_hdr* new_tcp_header; struct rte_mbuf* packet = build_packet(state, state-&gt;http.last_message_size, &amp;new_tcp_header); TRACE; if (packet != NULL) { new_tcp_header-&gt;rx_win = TX_WINDOW_SIZE; new_tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_sent - state-&gt;http.last_message_size); new_tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq); memcpy((char*)new_tcp_header+sizeof(struct tcp_hdr), &amp;state-&gt;http.last_message, state-&gt;http.last_message_size); send_packet(new_tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp fin ack"); } //ERROR("my bad tcp stack implementation((("); } } if ((tcp_header-&gt;tcp_flags &amp; 0x04) != 0) // RST { TRACE; //not thread safe! only one core used if (rte_hash_del_key(g_clients, key) &lt; 0) { ERROR("can't delete key"); } else { rte_mempool_put(g_tcp_state_pool, state); } } else if ((tcp_header-&gt;tcp_flags &amp; 0x01) != 0) // FIN { struct tcp_hdr* new_tcp_header; struct rte_mbuf* packet = build_packet(state, 0, &amp;new_tcp_header); TRACE; if (packet != NULL) { new_tcp_header-&gt;rx_win = TX_WINDOW_SIZE; new_tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_sent); new_tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq + 1); if (!state-&gt;fin_sent) { TRACE; new_tcp_header-&gt;tcp_flags = 0x11; // !@#$ the last ack } send_packet(new_tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp fin ack"); } //not thread safe! only one core used if (rte_hash_del_key(g_clients, key) &lt; 0) { ERROR("can't delete key"); } else { rte_mempool_put(g_tcp_state_pool, state); } } }</span></span></code> </pre> <br></div></div><br>  Http рдкрд╛рд░реНрд╕рд░ рдХреЗрд╡рд▓ GET рдХреЛ рд╡рд╣рд╛рдВ рд╕реЗ URL рдкрдврд╝рдиреЗ рдФрд░ рдЕрдиреБрд░реЛрдзрд┐рдд URL рдХреЗ рд╕рд╛рде html рд╡рд╛рдкрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдерди рдХрд░реЗрдЧрд╛ред <br><br><div class="spoiler">  <b class="spoiler_title">HTTP рдкрд╛рд░реНрд╕рд░</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">feed_http</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data_size, struct tcp_state* state)</span></span></span><span class="hljs-function"> </span></span>{ TRACE; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> remaining_data = data_size; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* current = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)data; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http_state</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (http-&gt;state == HTTP_BAD_STATE) { TRACE; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (remaining_data &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(http-&gt;state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_START: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'G'</span></span>) { http-&gt;state = HTTP_READ_G; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_BAD_STATE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_G: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'E'</span></span>) { http-&gt;state = HTTP_READ_E; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_BAD_STATE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_E: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'T'</span></span>) { http-&gt;state = HTTP_READ_T; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_BAD_STATE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_T: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">' '</span></span>) { http-&gt;state = HTTP_READ_SPACE; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_BAD_STATE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_SPACE: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current != <span class="hljs-string"><span class="hljs-string">' '</span></span>) { http-&gt;request_url[http-&gt;request_url_size] = *current; ++http-&gt;request_url_size; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (http-&gt;request_url_size &gt; MAX_URL_SIZE) { http-&gt;state = HTTP_BAD_STATE; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_READ_URL; http-&gt;request_url[http-&gt;request_url_size] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_URL: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\r'</span></span>) { http-&gt;state = HTTP_READ_R1; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_R1: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { http-&gt;state = HTTP_READ_N1; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\r'</span></span>) { http-&gt;state = HTTP_READ_R1; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_READ_URL; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_N1: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\r'</span></span>) { http-&gt;state = HTTP_READ_R2; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_READ_URL; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_R2: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { TRACE; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> content_length[<span class="hljs-number"><span class="hljs-number">32</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(content_length, <span class="hljs-string"><span class="hljs-string">"%lu"</span></span>, g_http_part2_size - <span class="hljs-number"><span class="hljs-number">4</span></span> + http-&gt;request_url_size + g_http_part3_size); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> content_length_size = <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(content_length); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> total_data_size = g_http_part1_size + g_http_part2_size + g_http_part3_size + http-&gt;request_url_size + content_length_size; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcp_hdr</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcp_header</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rte_mbuf</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packet</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">build_packet</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">total_data_size</span></span></span><span class="hljs-class">, &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcp_header</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (packet != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { tcp_header-&gt;rx_win = TX_WINDOW_SIZE; tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_sent); tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq + data_size); <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> KEEPALIVE state-&gt;my_seq_sent += total_data_size; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> state-&gt;my_seq_sent += total_data_size + 1; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//+1 for FIN tcp_header-&gt;tcp_flags = 0x11; state-&gt;fin_sent = 1; #endif char* new_data = (char*)tcp_header + sizeof(struct tcp_hdr); memcpy(new_data, g_http_part1, g_http_part1_size); new_data += g_http_part1_size; memcpy(new_data, content_length, content_length_size); new_data += content_length_size; memcpy(new_data, g_http_part2, g_http_part2_size); new_data += g_http_part2_size; memcpy(new_data, http-&gt;request_url, http-&gt;request_url_size); new_data += http-&gt;request_url_size; memcpy(new_data, g_http_part3, g_http_part3_size); memcpy(&amp;http-&gt;last_message, (char*)tcp_header+sizeof(struct tcp_hdr), total_data_size); http-&gt;last_message_size = total_data_size; send_packet(tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp data"); } http-&gt;state = HTTP_START; http-&gt;request_url_size = 0; } else if (*current == '\r') { http-&gt;state = HTTP_READ_R1; } else { http-&gt;state = HTTP_READ_URL; } break; } default: { ERROR("bad http state"); return; } } if (http-&gt;state == HTTP_BAD_STATE) { return; } --remaining_data; ++current; } }</span></span></span></span></code> </pre> <br></div></div><br>  рдЙрджрд╛рд╣рд░рдг рддреИрдпрд╛рд░ рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж, рдЖрдк рдирдЧреАрдирдХреНрд╕ рдХреЗ рд╕рд╛рде рдкреНрд░рджрд░реНрд╢рди рдХреА рддреБрд▓рдирд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдХреНрдпреЛрдВрдХрд┐  рдореИрдВ рдШрд░ рдкрд░ рдПрдХ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕реНрдЯреИрдВрдб рдЗрдХрдЯреНрдард╛ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛, рдореИрдВрдиреЗ рдЕрдореЗрдЬрд╝реЕрди рдИрд╕реА 2 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ред  EC2 рдиреЗ рдкрд░реАрдХреНрд╖рдг рдореЗрдВ рдЗрд╕рдХреЗ рд╕реБрдзрд╛рд░ рдХрд┐рдП - рдореБрдЭреЗ рдХрдиреЗрдХреНрд╢рди рдЫреЛрдбрд╝рдирд╛ рдкрдбрд╝рд╛: рдХрд░реАрдмреА рдЕрдиреБрд░реЛрдз, рдХреНрдпреЛрдВрдХрд┐  рдкрд░реАрдХреНрд╖рдг рд╢реБрд░реВ рд╣реЛрдиреЗ рдХреЗ рдХреБрдЫ рд╕реЗрдХрдВрдб рдмрд╛рдж 300k rps SYN рдХреЗ рдкреИрдХреЗрдЯ рдореЗрдВ рдХреБрдЫ рдмреВрдВрджреЗрдВ рдЧрд┐рд░рдирд╛ рд╢реБрд░реВ рд╣реБрдИрдВред  рдЬрд╛рд╣рд┐рд░ рд╣реИ, SYN-рдмрд╛рдврд╝ рдХреЗ рдЦрд┐рд▓рд╛рдл рдХрд┐рд╕реА рдкреНрд░рдХрд╛рд░ рдХрд╛ рд╕рдВрд░рдХреНрд╖рдг рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдЬреАрд╡рд┐рдд рд░рдЦрд╛ рдЧрдпрд╛ рдерд╛ред  EC2 рдкрд░, dpdk рд╕рднреА рдЙрджрд╛рд╣рд░рдгреЛрдВ рдкрд░ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП m1.medium рдкрд░ рдпрд╣ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред  рд╕реНрдЯреИрдВрдб рдиреЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рд╕рд╛рде 1 рдЗрдВрд╕реНрдЯреЗрдВрд╕ r4.8xlarge рдФрд░ рд▓реЛрдб рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП 2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ r4.8xlarge рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ред  рд╡реЗ рдПрдХ рдирд┐рдЬреА рд╡реАрдкреАрд╕реА рд╕рдмрдиреЗрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣реЛрдЯрд▓ рдиреЗрдЯрд╡рд░реНрдХ рдЗрдВрдЯрд░рдлреЗрд╕ рдкрд░ рд╕рдВрд╡рд╛рдж рдХрд░рддреЗ рд╣реИрдВред  рдореИрдВрдиреЗ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдЙрдкрдпреЛрдЧрд┐рддрд╛рдУрдВ рдХреЗ рд╕рд╛рде рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХреА: рдПрдмреА, рдЖрд░рдХреЗ, рдПрдЪ тАЛтАЛ2 рд▓реЛрдб, рдШреЗрд░рд╛рдмрдВрджреАред  рд╕рдмрд╕реЗ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ wrk рдерд╛, рдХреНрдпреЛрдВрдХрд┐  рдпрджрд┐ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рддреНрд░реБрдЯрд┐рдпрд╛рдВ рд╣реИрдВ, рддреЛ ab рдПрдХрд▓-рдереНрд░реЗрдбреЗрдб рд╣реИ рдФрд░ рд╡рд┐рдХреГрдд рдЖрдВрдХрдбрд╝реЗ рддреИрдпрд╛рд░ рдХрд░рддрд╛ рд╣реИред <br><br>  EC2 рдореЗрдВ рдмрд╣реБрдд рдЕрдзрд┐рдХ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреЗ рд╕рд╛рде, рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рдмреВрдВрджреЛрдВ рдХреЛ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рд╕рд╛рдзрд╛рд░рдг рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рдпрд╣ рдЕрджреГрд╢реНрдп рд╣реЛрдЧрд╛, рд▓реЗрдХрд┐рди рдПрдм рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдХреЛрдИ рднреА рдкреНрд░рддрд┐рд╕рд╛рдж рдХреБрд▓ рд╕рдордп рдФрд░ рдПрдмрдЯ рд▓реЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рдХреЗ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк рдкреНрд░рддрд┐ рд╕реЗрдХрдВрдб рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рдФрд╕рдд рд╕рдВрдЦреНрдпрд╛ рдкрд░ рдбреЗрдЯрд╛ рдЕрдиреБрдкрдпреБрдХреНрдд рд╣реИрдВред  рдмреВрдВрджреЛрдВ рдХреЗ рдХрд╛рд░рдгреЛрдВ рд╕реЗ рдЕрд▓рдЧ рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрд▓рдЧ рд░рд╣рд╕реНрдп рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐, рддрдереНрдп рдпрд╣ рд╣реИ рдХрд┐ рди рдХреЗрд╡рд▓ рдбреАрдкреАрдбреАрдХреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп рд╕рдорд╕реНрдпрд╛рдПрдВ рд╣реИрдВ, рдмрд▓реНрдХрд┐ рдирдЧрдиреЗрдХреНрд╕ рдХреЗ рд╕рд╛рде рднреА, рдпрд╣ рдмрддрд╛рддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдХреБрдЫ рдЧрд▓рдд рдХрд╛ рдЙрджрд╛рд╣рд░рдг рдирд╣реАрдВ рд▓рдЧрддрд╛ рд╣реИред <br><br>  рдореИрдВрдиреЗ рджреЛ рдЪрд░рдгреЛрдВ рдореЗрдВ рдкрд░реАрдХреНрд╖рдг рдХрд┐рдпрд╛, рдкрд╣рд▓реЗ рдореИрдВрдиреЗ 1 рдЙрджрд╛рд╣рд░рдг рдкрд░, рдлрд┐рд░ 2 рдкрд░ рд░реЗрдХ рдЪрд▓рд╛рдпрд╛ред  рдпрджрд┐ 2 рдЙрджрд╛рд╣рд░рдгреЛрдВ рдореЗрдВ рд╕реЗ рдХреБрд▓ рдкреНрд░рджрд░реНрд╢рди 1 рд╣реИ, рддреЛ рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдореИрдВ рдЦреБрдж рд╣реА wrk рдХреЗ рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ рдирд╣реАрдВ рдЖрдпрд╛ рдерд╛ред <br><br><div class="spoiler">  <b class="spoiler_title">R4.8xlarge рдкрд░ dpdk рдЙрджрд╛рд╣рд░рдг рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдкрд░рд┐рдгрд╛рдо</b> <div class="spoiler_text">  рд▓реЙрдиреНрдЪ wrk c 1 рдЙрджрд╛рд╣рд░рдг <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 32.19ms 63.43ms 817.26ms 85.01% <br> Req/Sec 15.97k 4.04k 113.97k 93.47% <br> Latency Distribution <br> 50% 2.58ms <br> 75% 17.57ms <br> 90% 134.94ms <br> 99% 206.03ms <br> 10278064 requests in 10.10s, 1.70GB read <br> Socket errors: connect 0, read 17, write 0, timeout 0 <br> Requests/sec: 1017645.11 <br> Transfer/sec: 172.75MB</code> <br>  рдПрдХ рд╣реА рд╕рдордп рдореЗрдВ 2 рдЙрджрд╛рд╣рд░рдгреЛрдВ рд╕реЗ рдЪрд▓ рд░рд╣рд╛ рд╣реИ <br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 67.28ms 119.20ms 1.64s 88.90% <br> Req/Sec 7.99k 4.58k 132.62k 96.67% <br> Latency Distribution <br> 50% 2.31ms <br> 75% 103.45ms <br> 90% 191.51ms <br> 99% 563.56ms <br> 5160076 requests in 10.10s, 0.86GB read <br> Socket errors: connect 0, read 2364, write 0, timeout 1 <br> Requests/sec: 510894.92 <br> Transfer/sec: 86.73MB <br> <br> root@ip-172-30-0-225:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 74.87ms 148.64ms 1.64s 93.45% <br> Req/Sec 8.22k 2.59k 42.51k 81.21% <br> Latency Distribution <br> 50% 2.41ms <br> 75% 110.42ms <br> 90% 190.66ms <br> 99% 739.67ms <br> 5298083 requests in 10.10s, 0.88GB read <br> Socket errors: connect 0, read 0, write 0, timeout 148 <br> Requests/sec: 524543.67 <br> Transfer/sec: 89.04MB</code> <br> </div></div><br><div class="spoiler">  <b class="spoiler_title">Nginx рдиреЗ рдРрд╕реЗ рдкрд░рд┐рдгрд╛рдо рджрд┐рдП</b> <div class="spoiler_text">  рд▓реЙрдиреНрдЪ wrk c 1 рдЙрджрд╛рд╣рд░рдг <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 14.36ms 56.41ms 1.92s 95.26% <br> Req/Sec 15.27k 3.30k 72.23k 83.53% <br> Latency Distribution <br> 50% 3.38ms <br> 75% 6.82ms <br> 90% 10.95ms <br> 99% 234.99ms <br> 9813464 requests in 10.10s, 2.12GB read <br> Socket errors: connect 0, read 1, write 0, timeout 3 <br> Requests/sec: 971665.79 <br> Transfer/sec: 214.94MB</code> <br> <br>  рдПрдХ рд╣реА рд╕рдордп рдореЗрдВ 2 рдЙрджрд╛рд╣рд░рдгреЛрдВ рд╕реЗ рдЪрд▓ рд░рд╣рд╛ рд╣реИ <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 52.91ms 82.19ms 1.04s 82.93% <br> Req/Sec 8.05k 3.09k 55.62k 89.11% <br> Latency Distribution <br> 50% 3.66ms <br> 75% 94.87ms <br> 90% 171.83ms <br> 99% 354.26ms <br> 5179253 requests in 10.10s, 1.12GB read <br> Socket errors: connect 0, read 134, write 0, timeout 0 <br> Requests/sec: 512799.10 <br> Transfer/sec: 113.43MB <br> <br> root@ip-172-30-0-225:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 64.38ms 121.56ms 1.67s 90.32% <br> Req/Sec 7.30k 2.54k 34.94k 82.10% <br> Latency Distribution <br> 50% 3.68ms <br> 75% 103.32ms <br> 90% 184.05ms <br> 99% 561.31ms <br> 4692290 requests in 10.10s, 1.01GB read <br> Socket errors: connect 0, read 2, write 0, timeout 21 <br> Requests/sec: 464566.93 <br> Transfer/sec: 102.77MB</code> <br> </div></div><br><div class="spoiler">  <b class="spoiler_title">nginx config</b> <div class="spoiler_text">  рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ www-рдбреЗрдЯрд╛; <br>  рдХрд╛рд░реНрдпрдХрд░реНрддрд╛_рдкреНрд░реЛрд╕реЗрд╕ рдСрдЯреЛ; <br>  pid /run/nginx.pid; <br>  рдХрд╛рд░реНрдпрдХрд░реНрддрд╛_рдкреНрд░рдореБрдЦ_рдирд┐рд░реАрдХреНрд╖рдг 50000; <br>  рдШрдЯрдирд╛рдПрдБ { <br>  worker_connections 10000; <br>  } <br>  http { <br>  рдкрд░ рднреЗрдЬ рджреЗрдирд╛; <br>  tcp_nopush on; <br>  tcp_nodelay on; <br>  Keepalive_timeout 65; <br>  type_hash_max_size 2048; <br><br>  /etc/nginx/mime.types рд╢рд╛рдорд┐рд▓ рдХрд░реЗрдВ; <br>  default_type рдкрд╛рда / рд╕рд╛рджреЗ; <br><br>  error_log /var/log/nginx/error.log; <br>  access_log рдмрдВрдж; <br><br>  рд╕рд░реНрд╡рд░ { <br>  80 default_server рдмреИрдХрд▓реЙрдЧ = 10000 рдкреБрди: рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ; <br>  рд╕реНрдерд╛рди / { <br>  рд╡рд╛рдкрд╕реА 200 "answer.padding _____________________________________________________________________"; <br>  } <br>  } <br>  } <br></div></div><br>  рдХреБрд▓ рдореЗрдВ, рд╣рдо рджреЗрдЦрддреЗ рд╣реИрдВ рдХрд┐ рджреЛрдиреЛрдВ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдореЗрдВ рд╣рдореЗрдВ рдкреНрд░рддрд┐ рд╕реЗрдХрдВрдб рд▓рдЧрднрдЧ 1M рдЕрдиреБрд░реЛрдз рдорд┐рд▓рддреЗ рд╣реИрдВ, рдХреЗрд╡рд▓ nginx рдиреЗ рдЗрд╕рдХреЗ рд▓рд┐рдП рд╕рднреА 32 рд╕реАрдкреАрдпреВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рд╣реИ, рдФрд░ рдХреЗрд╡рд▓ рдПрдХ рд╣реА dpdkред  рд╢рд╛рдпрдж EC2 рдлрд┐рд░ рд╕реЗ рдЗрд╕рдореЗрдВ рдПрдХ рд╕реБрдЕрд░ рдбрд╛рд▓рддрд╛ рд╣реИ рдФрд░ 1M rps рдПрдХ рдиреЗрдЯрд╡рд░реНрдХ рд▓рд┐рдорд┐рдЯреЗрд╢рди рд╣реИ, рд▓реЗрдХрд┐рди рдЕрдЧрд░ рдРрд╕рд╛ рд╣реИ рднреА, рддреЛ рдкрд░рд┐рдгрд╛рдо рдмрд╣реБрдд рд╡рд┐рдХреГрдд рдирд╣реАрдВ рд╣реИрдВ, рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдХреЗ рд▓рд┐рдП рджреЗрд░реА рдЬреЛрдбрд╝ рд░рд╣рд╛ рд╣реИ <i>(int x = 0; x &lt;100; ++ x) http</i> рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдПред <i>тЖТ request_url [0] = 'a' + (http-&gt; request_url [0]% 10)</i> рдкреИрдХреЗрдЯ рднреЗрдЬрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ, рдЗрд╕рдиреЗ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЖрд░рдкреАрдПрд╕ рдХрдо рдХрд░ рджрд┐рдпрд╛, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдЙрдкрдпреЛрдЧреА рдХрд╛рдо рдХреЗ рд╕рд╛рде рд▓рдЧрднрдЧ рдкреВрд░реНрдг рд╕реАрдкреАрдпреВ рд▓реЛрдб рдХрд░рдирд╛ред <br><br>  рдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рджреМрд░рд╛рди, рдПрдХ рд░рд╣рд╕реНрдп рдХрд╛ рдкрддрд╛ рдЪрд▓рд╛, рдЬрд┐рд╕реЗ рдореИрдВ рдЕрднреА рднреА рд╣рд▓ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ред  рдпрджрд┐ рдЖрдк рдЪреЗрдХрд╕рдо рдСрдлрд╝рд▓реЛрдбрд┐рдВрдЧ рд╕рдХреНрд╖рдо рдХрд░рддреЗ рд╣реИрдВ, рдЕрд░реНрдерд╛рдд, рдиреЗрдЯрд╡рд░реНрдХ рдХрд╛рд░реНрдб рджреНрд╡рд╛рд░рд╛ рд╣реА рдЖрдИрдкреА рдФрд░ рдЯреАрд╕реАрдкреА рд╣реЗрдбрд░ рдХреЗ рд▓рд┐рдП рдЪреЗрдХрд╕рдо рдХреА рдЧрдгрдирд╛, рддреЛ рд╕рдордЧреНрд░ рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ рдЧрд┐рд░рд╛рд╡рдЯ рдЖрддреА рд╣реИ, рдФрд░ рд╡рд┐рд▓рдВрдмрддрд╛ рдореЗрдВ рд╕реБрдзрд╛рд░ рд╣реЛрддрд╛ рд╣реИред <br>  рдпрд╣рд╛рдВ рдСрдлрд▓реЛрдбрд┐рдВрдЧ рд╕рдХреНрд╖рдо рдХреЗ рд╕рд╛рде рд╢реБрд░реБрдЖрдд рд╣реИ <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 5.91ms 614.33us 28.35ms 96.17% <br> Req/Sec 10.48k 1.51k 69.89k 98.78% <br> Latency Distribution <br> 50% 5.91ms <br> 75% 6.01ms <br> 90% 6.19ms <br> 99% 6.99ms <br> 6738296 requests in 10.10s, 1.12GB read <br> Requests/sec: 667140.71 <br> Transfer/sec: 113.25MB</code> <br> <br>  рдФрд░ рдпрд╣рд╛рдБ рд╕реАрдкреАрдпреВ рдкрд░ рдЪреЗрдХрд╕рдо рдХреЗ рд╕рд╛рде <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 32.19ms 63.43ms 817.26ms 85.01% <br> Req/Sec 15.97k 4.04k 113.97k 93.47% <br> Latency Distribution <br> 50% 2.58ms <br> 75% 17.57ms <br> 90% 134.94ms <br> 99% 206.03ms <br> 10278064 requests in 10.10s, 1.70GB read <br> Socket errors: connect 0, read 17, write 0, timeout 0 <br> Requests/sec: 1017645.11 <br> Transfer/sec: 172.75MB</code> <br> <br>  рдареАрдХ рд╣реИ, рдореИрдВ рдкреНрд░рджрд░реНрд╢рди рдбреНрд░реЙрдк рдХреЛ рдЗрд╕ рддрдереНрдп рд╕реЗ рд╕рдордЭрд╛ рд╕рдХрддрд╛ рд╣реВрдВ рдХрд┐ рдиреЗрдЯрд╡рд░реНрдХ рдХрд╛рд░реНрдб рдзреАрдорд╛ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдпрд╣ рдЕрдЬреАрдм рд╣реИ, рдЗрд╕реЗ рддреЗрдЬ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред  рд▓реЗрдХрд┐рди рдХреНрдпреЛрдВ, рд╡рд┐рд▓рдВрдмрддрд╛ рдХреЗ рдирдХреНрд╢реЗ рдкрд░ рдЪреЗрдХрд╕рдо рдХреА рдЧрдгрдирд╛ рдХреЗ рд╕рд╛рде, рд▓рдЧрднрдЧ 6ms рдХреЗ рдмрд░рд╛рдмрд░ рд╕реНрдерд┐рд░ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рдпрджрд┐ рдЖрдк рд╕реАрдкреАрдпреВ рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ 2.5ms рд╕реЗ 817ms рддрдХ рддреИрд░рддрд╛ рд╣реИ?  рдПрдХ рдЧреИрд░-рдЖрднрд╛рд╕реА рд╕реНрдЯреИрдВрдб рджреНрд╡рд╛рд░рд╛ рдкреНрд░рддреНрдпрдХреНрд╖ рдХрдиреЗрдХреНрд╢рди рдХреЗ рд╕рд╛рде рдХрд╛рд░реНрдп рдХреЛ рдмрд╣реБрдд рд╕рд░рд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рд▓реЗрдХрд┐рди рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ, рдореЗрд░реЗ рдкрд╛рд╕ рдпрд╣ рдирд╣реАрдВ рд╣реИред  DPDK рд╕реНрд╡рдпрдВ рд╕рднреА рдиреЗрдЯрд╡рд░реНрдХ рдХрд╛рд░реНрдб рдкрд░ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ, рдЖрдкрдХреЛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕реВрдЪреА рдХреА</a> рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред <br><br>  рдФрд░ рдЕрдВрдд рдореЗрдВ, рдПрдХ рд╕рд░реНрд╡реЗрдХреНрд╖рдгред </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi416651/">https://habr.com/ru/post/hi416651/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi416639/index.html">рдХрд╛рдпрд╛рдХрд▓реНрдк рдХреЗ рдЕрдЧреНрд░рдгреА рдХреЗ рд╕рд╛рде рд╕рд╛рдХреНрд╖рд╛рддреНрдХрд╛рд░</a></li>
<li><a href="../hi416641/index.html">рдореЛрдмрд╛рдЗрд▓ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ 8 рдЪрд░рдг</a></li>
<li><a href="../hi416643/index.html">10 рдЪрд░рдгреЛрдВ рдореЗрдВ рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдХреЗ рд╕рд╛рде рдПрдбрдмреНрд▓реНрдпреВрдПрд╕ рдкрд░ рдПрд▓рд┐рдпрд╕реНрдЯрд┐рдХреНрд╕ рдХреА рдЦреЛрдЬ</a></li>
<li><a href="../hi416645/index.html">рдЖрдИрдЖрдИрдПред рдЕрдиреБрд╕рдВрдзрд╛рди рдкреИрдЯрд░реНрди</a></li>
<li><a href="../hi416647/index.html">рдХреНрдпрд╛ рд╕рд░рдХрд╛рд░реА рдПрдЬреЗрдВрд╕рд┐рдпрд╛рдВ тАЛтАЛрдЗрд▓реЗрдХреНрдЯреНрд░рд┐рдХ рдЬреЛрдЦрд┐рдо рдХрд╛ рд╕рдкрдирд╛ рджреЗрдЦрддреА рд╣реИрдВ?</a></li>
<li><a href="../hi416653/index.html">рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд╕реЙрд░реНрдЯ</a></li>
<li><a href="../hi416657/index.html">рджреЛ-рддрд┐рд╣рд╛рдИ рдореЗрдореЛрд░реА рдХрд╛рд░реНрдб рдореЗрдВ рдкрд┐рдЫрд▓реЗ рдорд╛рд▓рд┐рдХреЛрдВ рдХреЗ рд╡реНрдпрдХреНрддрд┐рдЧрдд рдбреЗрдЯрд╛ рд╣реЛрддреЗ рд╣реИрдВ</a></li>
<li><a href="../hi416659/index.html">рдХрд┐рд╕ рд╡рдЬрд╣ рд╕реЗ рдЧрд┐рдЧ рдЗрдХреЙрдирдореА рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд┐рдЯрд▓ рднреБрдЧрддрд╛рди рдХреА рдорд╛рддреНрд░рд╛ $ 1.2 рдЯреНрд░рд┐рд▓рд┐рдпрди рдбреЙрд▓рд░ рддрдХ рдкрд╣реБрдВрдЪ рдЬрд╛рдПрдЧреА</a></li>
<li><a href="../hi416661/index.html">рдореЛрдмрд╛рдЗрд▓ рдмреИрдВрдХрд┐рдВрдЧ рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдФрд░ рдкреНрд░рджрд╛рддрд╛рдУрдВ рджреНрд╡рд╛рд░рд╛ рдХреНрдпрд╛ рд░реБрдЭрд╛рдиреЛрдВ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП</a></li>
<li><a href="../hi416665/index.html">рд╕реЛрдирд╛рдЯрд╛рдЗрдк рдиреЗрдХреНрд╕рд╕ рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдУрдПрд╕рдПрд╕ рдХреЗ рд╕рд╛рде рдирд┐рдЬреА рдПрдВрдбреНрд░реЙрдЗрдб рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХрд╛ рдкреБрди: рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>