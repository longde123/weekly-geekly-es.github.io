<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöû üç∑ ü•í Usando o c√¥nsul para dimensionar servi√ßos estatais üèáüèº üë®üèΩ‚Äçüíº üôÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em 22 de setembro, realizamos nossa primeira mitap n√£o padronizada para desenvolvedores de sistemas altamente carregados. Foi muito legal, muito feedb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Usando o c√¥nsul para dimensionar servi√ßos estatais</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pixonic/blog/424777/">  <i>Em 22 de setembro, realizamos nossa primeira <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mitap n√£o padronizada</a> para desenvolvedores de sistemas altamente carregados.</i>  <i>Foi muito legal, muito feedback positivo sobre os relat√≥rios e, portanto, decidiu n√£o apenas envi√°-los, mas tamb√©m descriptografar para Habr.</i>  <i>Hoje publicamos um discurso de Ivan Bubnov, DevOps do BIT.GAMES.</i>  <i>Ele falou sobre a implementa√ß√£o do servi√ßo de descoberta da Consul em um projeto de alta carga j√° em funcionamento, para a possibilidade de dimensionamento e failover r√°pidos de servi√ßos com estado.</i>  <i>E tamb√©m sobre a organiza√ß√£o de um espa√ßo de nome flex√≠vel para aplicativos de back-end e armadilhas.</i>  <i>Agora uma palavra para Ivan.</i> <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/X4VYCrOCD3A" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Administro a infraestrutura de produ√ß√£o no est√∫dio BIT.GAMES e conto a hist√≥ria da implementa√ß√£o do c√¥nsul da Hashicorp em nosso projeto ‚ÄúGuild of Heroes‚Äù - RPG de fantasia com pvp ass√≠ncrono para dispositivos m√≥veis.  Dispon√≠vel no Google Play, App Store, Samsung, Amazon.  DAU cerca de 100.000, on-line de 10 a 13 mil.  Como criamos o jogo no Unity, escrevemos o cliente em C # e usamos nossa pr√≥pria linguagem de script BHL para a l√≥gica do jogo.  N√≥s escrevemos a parte do servidor em Golang (mudou para PHP).  A seguir, a arquitetura esquem√°tica do nosso projeto. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/dd/-v/gu/dd-vgufl1o4g4sjqu8luww4f56k.png"><br>  <i>De fato, existem muito mais servi√ßos, existem apenas o b√°sico da l√≥gica do jogo.</i> <br><br>  Ent√£o, o que temos.  Dos servi√ßos sem estado, estes s√£o: <br><br><ul><li>  nginx, que usamos como balanceadores de front-end e de carga e distribu√≠mos clientes para nossos back-end por coeficientes de peso; </li><li>  back-end, aplicativos compilados do Go.  Esse √© o eixo central da nossa arquitetura, eles executam a maior parte do trabalho e se comunicam com todos os outros servi√ßos de back-end. </li></ul><br>  Dos servi√ßos com estado, os principais que temos s√£o: <br><br><ul><li>  Redis, que usamos para armazenar informa√ß√µes quentes (tamb√©m usamos para organizar bate-papos no jogo e armazenar notifica√ß√µes para nossos jogadores); </li><li>  O Percona Server for Mysql √© um reposit√≥rio de informa√ß√µes persistentes (provavelmente o maior e o mais lento em qualquer arquitetura).  Usamos o fork do MySQL e aqui falaremos mais detalhadamente hoje. </li></ul><br>  Durante o processo de design, n√≥s (como todo mundo) esper√°vamos que o projeto fosse bem-sucedido e proporcionasse um mecanismo de fragmenta√ß√£o.  Consiste em duas entidades do banco de dados MAINDB e nos pr√≥prios shards. <br><br><img src="https://habrastorage.org/webt/y2/sj/h-/y2sjh-qfoxlosksflpkvxuq3cxk.png"><br><br>  MAINDB √© um tipo de √≠ndice - ele armazena informa√ß√µes sobre quais dados de fragmentos espec√≠ficos sobre o progresso do player est√£o armazenados.  Assim, a cadeia completa de recupera√ß√£o de informa√ß√µes se parece com isso: o cliente acessa o front-end, que por sua vez o redistribui em peso a um dos back-end, o back-end vai para o MAINDB, localiza o shard do jogador e, em seguida, seleciona os dados diretamente do pr√≥prio shard. <br><br>  Mas quando projetamos, n√£o √©ramos um grande projeto, por isso decidimos fazer shards shards apenas nominalmente.  Eles estavam todos localizados no mesmo servidor f√≠sico e provavelmente no particionamento de banco de dados no mesmo servidor. <br><br>  Para backup, usamos a replica√ß√£o principal de escravo mestre.  N√£o era uma solu√ß√£o muito boa (vou dizer o porqu√™ daqui a pouco), mas a principal desvantagem dessa arquitetura era que todos os nossos back-end conheciam outros servi√ßos de back-end exclusivamente por endere√ßos IP.  E, no caso de outro acidente rid√≠culo no datacenter do tipo " <i>desculpe, nosso engenheiro apertou o cabo do servidor enquanto fazia a manuten√ß√£o de outro e demoramos muito tempo para descobrir por que o servidor n√£o entra em contato</i> " foram necess√°rios movimentos consider√°veis ‚Äã‚Äãde nossa parte.  Em primeiro lugar, trata-se da reconstru√ß√£o e pr√©-instala√ß√£o de back-end do servidor de backup IP para o local do que falhou.  Em segundo lugar, ap√≥s o incidente, √© necess√°rio restaurar nosso mestre do backup da reserva, porque ele estava em um estado inconsistente e traz√™-lo para um estado coordenado usando a mesma replica√ß√£o.  Em seguida, remontamos os back-ends e recarregamos novamente.  Tudo isso, √© claro, causou tempo de inatividade. <br><br>  Chegou um momento em que nosso diretor t√©cnico (pelo qual agrade√ßo muito a ele) disse: ‚ÄúGente, parem de sofrer, precisamos mudar alguma coisa, vamos procurar maneiras de sair‚Äù.  Antes de tudo, quer√≠amos obter um processo simples, compreens√≠vel e mais importante - de gerenciamento f√°cil de dimensionamento e migra√ß√£o de um lugar para outro de nossos bancos de dados, se necess√°rio.  Al√©m disso, quer√≠amos obter alta disponibilidade automatizando o failover. <br><br><img src="https://habrastorage.org/webt/lb/96/ys/lb96yszgjsbjtriury8zxqr0loa.png"><br><br>  O eixo central de nossa pesquisa tornou-se o Consul da Hashicorp.  Em primeiro lugar, fomos avisados ‚Äã‚Äãe, em segundo lugar, ficamos muito atra√≠dos por sua simplicidade, simpatia e excelente pilha de tecnologia em uma caixa: servi√ßo de descoberta com verifica√ß√£o de sa√∫de, armazenamento de valores-chave e a coisa mais importante que quer√≠amos usar era DNS que resolve para n√≥s endere√ßos do dom√≠nio service.consul. <br><br>  O Consul tamb√©m fornece excelentes UIs da Web e APIs REST para gerenciar tudo isso. <br><br>  Quanto √† alta disponibilidade, escolhemos dois utilit√°rios para failover autom√°tico: <br><br><ul><li>  MHA para MySQL </li><li>  Redis-sentinela </li></ul><br><img src="https://habrastorage.org/webt/bc/e5/dg/bce5dg_dxoi0irv9gic5e4d1jki.png"><br><br>  No caso do MHA para MySQL, despejamos agentes em n√≥s com bancos de dados e eles monitoravam seu estado.  Houve um certo tempo limite com a falha do mestre, ap√≥s o qual um escravo de parada foi feito para manter a consist√™ncia e nosso mestre de backup do mestre aparecido em um estado inconsistente n√£o coletou os dados.  E adicionamos um gancho da web a esses agentes, que registraram l√° o novo IP do mestre de backup no pr√≥prio Consul, ap√≥s o qual entrou na emiss√£o do DNS. <br><br>  Com o Redis-sentinel, tudo √© ainda mais simples.  Como ele pr√≥prio realiza a maior parte do trabalho, tudo o que nos resta a fazer √© levar em considera√ß√£o na verifica√ß√£o de sa√∫de que o Redis-sentinela deve ocorrer exclusivamente no n√≥ mestre. <br><br>  No come√ßo, tudo funcionou perfeitamente, como um rel√≥gio.  N√£o tivemos problemas na bancada de testes.  Mas valeu a pena mudar para o ambiente natural de transfer√™ncia de dados de um data center carregado, pensando em algumas mortes por OOM (isso est√° sem mem√≥ria, no qual o processo √© morto pelo n√∫cleo do sistema) e restaurando o servi√ßo ou coisas mais sofisticadas que afetam a disponibilidade do servi√ßo - como conseguimos imediatamente um s√©rio risco de falsos positivos ou nenhuma resposta garantida (se voc√™ tentar fazer algumas tentativas para tentar escapar dos falsos positivos). <br><br><img src="https://habrastorage.org/webt/a9/8t/7i/a98t7i3cvbb18duz7mkcr8f4vqg.png"><br><br>  Antes de tudo, tudo depende da dificuldade de escrever a verifica√ß√£o de sa√∫de correta.  Parece que a tarefa √© bastante trivial - verifique se o servi√ßo est√° sendo executado no servidor e na porta pingani.  Mas, como a pr√°tica subseq√ºente demonstrou, escrever uma verifica√ß√£o de sa√∫de ao implementar o Consul √© um processo extremamente complexo e demorado.  Como muitos fatores que afetam a disponibilidade do seu servi√ßo no datacenter n√£o podem ser previstos - eles s√£o detectados somente ap√≥s um certo tempo. <br><br>  Al√©m disso, o datacenter n√£o √© uma estrutura est√°tica com a qual voc√™ √© inundado e funciona como planejado.  Infelizmente, infelizmente (ou felizmente), descobrimos isso mais tarde, mas por enquanto est√°vamos inspirados e confiantes de que implementar√≠amos tudo na produ√ß√£o. <br><br><img src="https://habrastorage.org/webt/c3/kt/uz/c3ktuzba_fzzjqodfbfsdv6sj6k.png"><br><br>  Quanto ao dimensionamento, direi brevemente: tentamos encontrar uma bicicleta pronta, mas todas elas foram projetadas para arquiteturas espec√≠ficas.  E, como no caso de Jetpants, n√£o conseguimos atender √†s condi√ß√µes que ele imp√¥s √† arquitetura de um armazenamento persistente de informa√ß√µes. <br><br>  Portanto, pensamos em nossa pr√≥pria liga√ß√£o de script e adiamos essa pergunta.  Decidimos agir de forma consistente e come√ßar com a implementa√ß√£o do Consul. <br><br><img src="https://habrastorage.org/webt/99/em/bk/99embkj_f7vdi-kta4rdme6ga6k.png"><br><br>  O Consul √© um cluster distribu√≠do e descentralizado que opera com base no protocolo de fofocas e no algoritmo de consenso Raft. <br><br>  Temos um equorum independente de cinco servidores (cinco para evitar a situa√ß√£o do c√©rebro dividido).  Para cada n√≥, aplicamos o agente Consul no modo de agente e aplicamos todas as verifica√ß√µes de sa√∫de (ou seja, n√£o foi poss√≠vel enviar uma verifica√ß√£o de sa√∫de para um servidor espec√≠fico e outras para servidores espec√≠ficos).  A verifica√ß√£o de sa√∫de foi escrita para que eles passem apenas onde houver um servi√ßo. <br><br>  Tamb√©m usamos outro utilit√°rio para que n√£o precis√°ssemos aprender nosso back-end para resolver endere√ßos de um dom√≠nio espec√≠fico em uma porta n√£o padr√£o.  Usamos o Dnsmasq - ele fornece a capacidade de resolver de forma totalmente transparente os endere√ßos nos n√≥s do cluster que precisamos (que, no mundo real, por assim dizer, n√£o existem, mas existem exclusivamente dentro do cluster).  Preparamos um script autom√°tico para preencher o Ansible, carregamos tudo para a produ√ß√£o, ajustamos o espa√ßo para nome e garantimos que tudo estivesse completo.  E, cruzando os dedos, recarregamos nossos back-end, que foram acessados ‚Äã‚Äãn√£o por endere√ßos IP, mas por esses nomes no dom√≠nio server.consul. <br><br>  Tudo come√ßou da primeira vez, nossa alegria n√£o tinha limites.  Mas era muito cedo para se alegrar, porque em uma hora percebemos que em todos os n√≥s em que nossos back-ends est√£o localizados, o indicador de carga m√©dia aumentou de 0,7 para 1,0, o que √© um indicador bastante complexo. <br><br><img src="https://habrastorage.org/webt/em/ua/v_/emuav_oozpbvjdoa7yg1ldfeag0.png"><br><br>  Entrei no servidor para ver o que estava acontecendo e ficou √≥bvio que a CPU estava comendo o Consul.  Aqui come√ßamos a descobrir, come√ßamos a xamanizar com strace (um utilit√°rio para sistemas unix que permite rastrear qual syscall o processo est√° executando), despejando as estat√≠sticas do Dnsmasq para entender o que est√° acontecendo nesse n√≥, e percebemos que perdemos um ponto muito importante.  Planejando a integra√ß√£o, perdemos o armazenamento em cache dos registros DNS e verificamos que nosso back-end extra√≠a o Dnsmasq para cada um de seus movimentos e, por sua vez, recorreu ao Consul e tudo isso resultou em 940 consultas DNS doentias por segundo. <br><br>  A sa√≠da parecia √≥bvia - basta girar ttl e tudo ficar√° melhor.  Mas aqui era imposs√≠vel ser fan√°tico, porque quer√≠amos implementar essa estrutura para obter um espa√ßo para nome din√¢mico, facilmente controlado e que mudasse rapidamente (portanto, n√£o era poss√≠vel definir, por exemplo, 20 minutos).  Torcemos ttl para os valores √≥timos m√°ximos para n√≥s, conseguimos reduzir a taxa de consultas por segundo para 540, mas isso n√£o afetou o indicador de consumo da CPU. <br><br>  Decidimos sair de uma maneira complicada, usando o arquivo hosts personalizado. <br><br><img src="https://habrastorage.org/webt/0p/li/01/0pli01ivofxzndxm9pa9xrtvu6m.png"><br><br>  √â bom termos tudo para isso: um excelente sistema de modelos da Consul, que, com base no estado do cluster e no script do modelo, gera um arquivo de qualquer tipo, qualquer configura√ß√£o √© tudo o que voc√™ deseja.  Al√©m disso, o Dnsmasq possui um par√¢metro de configura√ß√£o addn-hosts que permite usar um arquivo de hosts que n√£o s√£o do sistema como o mesmo arquivo de hosts adicionais. <br><br>  O que fizemos, novamente preparamos o script em Ansible, o carregamos para produ√ß√£o e ele come√ßou a ter algo parecido com isto: <br><br><img src="https://habrastorage.org/webt/p6/qe/3i/p6qe3iaqlloehk1ld7ptisb_0dg.png"><br><br>  Havia um elemento adicional e um arquivo est√°tico no disco, que √© regenerado rapidamente.  Agora a cadeia parecia bastante simples: o gamed virou-se para o Dnsmasq e, por sua vez (em vez de puxar o agente Consula, que perguntaria aos servidores onde t√≠nhamos esse ou aquele n√≥) apenas olhava o arquivo.  Isso resolveu o problema com o consumo de CPU pelo Consul. <br><br>  Agora tudo come√ßou a parecer como planejado - absolutamente transparente para a nossa produ√ß√£o, praticamente sem consumir recursos. <br><br>  Ficamos bastante atormentados naquele dia e com grande apreens√£o fomos para casa.  Eles n√£o tiveram medo em v√£o, porque √† noite um alerta de monitoramento me acordou e me informou que t√≠nhamos uma explos√£o de erros em larga escala (embora a curto prazo). <br><br><img src="https://habrastorage.org/webt/yg/yj/z_/ygyjz_upz8khxqgriqbsye0_xma.png"><br><br>  Lidando com os logs pela manh√£, vi que todos os erros eram do mesmo tipo de host desconhecido.  N√£o ficou claro por que o Dnsmasq n√£o p√¥de usar um ou outro servi√ßo de um arquivo - parecia que n√£o existia.  Para tentar entender o que estava acontecendo, adicionei uma m√©trica personalizada para gerar novamente o arquivo - agora eu sabia exatamente o momento em que ele seria regenerado.  Al√©m disso, o pr√≥prio modelo do Consul tem uma excelente op√ß√£o de backup, ou seja,  Voc√™ pode ver o estado anterior do arquivo regenerado. <br><br>  Durante o dia, o incidente se repetiu v√°rias vezes e ficou claro que em algum momento (embora fosse espor√°dico, de natureza assistem√°tica), o arquivo de hosts sem servi√ßos espec√≠ficos seria renderizado novamente.  Descobriu-se que em um data center espec√≠fico (n√£o farei anti-publicidade), existem redes bastante inst√°veis ‚Äã‚Äã- devido √†s redes fracassadas, absolutamente imprevisivelmente paramos de passar por verifica√ß√µes de sa√∫de ou mesmo os n√≥s ca√≠ram do cluster.  Parecia algo assim: <br><br><img src="https://habrastorage.org/webt/3v/_q/ve/3v_qvengzywl6bqdchzxs2fshl4.png"><br><br>  O n√≥ caiu do cluster, o agente do Consul foi imediatamente notificado sobre isso e o modelo do Consul regenerou imediatamente o arquivo de hosts sem o servi√ßo necess√°rio.  Isso geralmente era inaceit√°vel, porque o problema √© rid√≠culo: se o servi√ßo n√£o estiver dispon√≠vel por alguns segundos, configure tempos limite e repeti√ß√µes (eles n√£o se conectaram uma vez, mas na segunda vez).  Mas provocamos uma nova estrutura no vendedor quando o servi√ßo simplesmente desaparece da vista e n√£o havia como se conectar a ele. <br><br>  Come√ßamos a pensar no que fazer e torcer o par√¢metro timeout no Consul, ap√≥s o qual √© identificado ap√≥s o quanto o n√≥ cai.  Conseguimos resolver esse problema com um indicador bastante pequeno, os n√≥s pararam de cair, mas isso n√£o ajudou na verifica√ß√£o de sa√∫de. <br><br>  Come√ßamos a pensar em escolher par√¢metros diferentes para a verifica√ß√£o de sa√∫de, tentando entender de alguma forma quando e como isso acontece.  Mas, devido ao fato de que tudo aconteceu esporadicamente e imprevisivelmente, n√£o fomos capazes de faz√™-lo. <br><br>  Em seguida, fomos ao modelo do Consul e decidimos fazer um tempo limite para ele, ap√≥s o qual ele reage a uma altera√ß√£o no estado do cluster.  Novamente, era imposs√≠vel ser fan√°tico, porque poder√≠amos chegar a uma situa√ß√£o em que o resultado n√£o seria melhor que o DNS cl√°ssico, quando busc√°vamos um completamente diferente. <br><br>  E mais uma vez nosso diretor t√©cnico veio em socorro e disse: ‚ÄúGente, vamos tentar desistir de toda essa interatividade, estamos todos em produ√ß√£o e n√£o h√° tempo para pesquisas, precisamos resolver esse problema.  Vamos tirar proveito de coisas simples e compreens√≠veis. ‚Äù  Ent√£o, chegamos ao conceito de usar o armazenamento de valores-chave como fonte para gerar um arquivo de hosts. <br><br><img src="https://habrastorage.org/webt/ar/qm/kx/arqmkxvbfzahdo6qrlom1htydq4.png"><br><br>  Como parece: recusamos todas as verifica√ß√µes de integridade din√¢micas, reescrevemos nosso script de modelo para gerar um arquivo com base nos dados registrados no armazenamento de valores-chave.  No armazenamento de valores-chave, descrevemos toda a nossa infraestrutura na forma do nome da chave (este √© o nome do servi√ßo que precisamos) e o valor da chave (este √© o nome do n√≥ no cluster).  I.e.  se o n√≥ estiver presente no cluster, obteremos seu endere√ßo IP com muita facilidade e gravamos no arquivo hosts. <br><br>  Testamos tudo, enchemos a produ√ß√£o e ela se tornou uma bala de prata em uma situa√ß√£o espec√≠fica.  Novamente, n√≥s praticamente nos atormentamos o dia inteiro e voltamos para casa, mas voltamos descansados, entusiasmados, porque esses problemas n√£o voltaram a ocorrer e n√£o foram repetidos na submiss√£o por um ano.  Pelo qual concluo pessoalmente que essa foi a decis√£o certa (especificamente para n√≥s). <br><br>  Ent√£o  Finalmente conseguimos o que quer√≠amos e organizamos um espa√ßo para nome din√¢mico para nossos back-ends.  Al√©m disso, fomos no sentido de garantir alta disponibilidade. <br><br><img src="https://habrastorage.org/webt/m9/k0/nu/m9k0nueo_w_79ywwhcco0tgnq5u.png"><br><br>  Mas o fato √© que, com muito medo da integra√ß√£o do Consul, e por causa dos problemas que encontramos, pensamos e decidimos que a introdu√ß√£o do failover autom√°tico n√£o √© uma solu√ß√£o t√£o boa, porque novamente corremos o risco de falsos positivos ou falhas.  Este processo √© opaco e incontrol√°vel. <br><br>  Portanto, seguimos um caminho mais simples (ou complexo): decidimos deixar o failover na consci√™ncia do administrador de plant√£o, mas fornecemos a ele outra ferramenta adicional.  Substitu√≠mos a replica√ß√£o principal do escravo pela replica√ß√£o principal do mestre no modo Somente leitura.  Isso remove uma enorme quantidade de dor de cabe√ßa no processo de failover'ov - quando voc√™ obt√©m um assistente, tudo o que voc√™ precisa fazer √© alterar o valor no armazenamento k / v usando a interface da Web da Web ou um comando na API e, antes disso, modo somente leitura mestre de backup. <br><br>  Ap√≥s o t√©rmino do incidente, o mestre entra em contato e automaticamente entra em um estado coordenado sem nenhuma a√ß√£o desnecess√°ria.  Paramos nessa op√ß√£o e a usamos como antes - para n√≥s, √© o mais conveniente poss√≠vel e, o mais importante, o mais simples, claro e controlado poss√≠vel. <br><br><img src="https://habrastorage.org/webt/mr/fn/tc/mrfntctgtpanvrkqhlqmbm9liue.png"><br>  <i>Consul Web Interface</i> <br><br>  √Ä direita est√° o armazenamento k / v e nossos servi√ßos s√£o vis√≠veis, que usamos em jogos;  value √© o nome do n√≥. <br><br>  Quanto ao dimensionamento - come√ßamos a implement√°-lo quando os shards j√° estavam lotados em um servidor, as bases cresceram, ficaram lentas, o n√∫mero de jogadores aumentou, trocamos e tivemos a tarefa de distribuir todos os shards para nossos diferentes servidores separados. <br><br><img src="https://habrastorage.org/webt/0b/yc/zg/0byczgl-2ugpi8z_dgwzytcmrw4.png"><br><br>  Como ficou: usando o utilit√°rio XtraBackup, restauramos nosso backup em um novo par de servidores, ap√≥s o qual o novo mestre foi pendurado com um escravo no antigo.  Chegou a um estado consistente, alteramos o valor da chave no armazenamento k / v do nome do n√≥ do antigo mestre para o nome do n√≥ do novo mestre.  Ent√£o (quando acreditamos que tudo correu corretamente e todas as suas sele√ß√µes, atualiza√ß√µes e inser√ß√µes foram para o novo mestre), tivemos que matar a replica√ß√£o e criar o cobi√ßado banco de dados de gota na produ√ß√£o, como todos gostamos de fazer com bancos de dados desnecess√°rios. <br><br><img src="https://habrastorage.org/webt/1x/6k/pw/1x6kpwybgw6-wsgscd6r1kylk-u.png"><br><br>  Ent√£o n√≥s quebramos os estilha√ßos.  Todo o processo de mudan√ßa durou de 40 minutos a uma hora e n√£o causou tempo de inatividade, era completamente transparente para os nossos back-ends e, por si s√≥, foi completamente transparente para os jogadores (exceto que, assim que eles se mudaram, ficou mais f√°cil e agrad√°vel para eles jogarem). <br><br><img src="https://habrastorage.org/webt/gm/du/bj/gmdubjovhtlet9n2-bljkeqz7oq.png"><br><br>  Quanto aos processos de failover, aqui o tempo de comuta√ß√£o √© de 20 a 40 segundos, mais o tempo de rea√ß√£o do administrador do sistema em servi√ßo.  √â assim que tudo parece conosco agora. <br><br>  O que eu gostaria de dizer em conclus√£o - infelizmente, nossas esperan√ßas de uma automa√ß√£o abrangente e absoluta colidiram com a dura realidade do meio de transmiss√£o de dados em um data center carregado e fatores aleat√≥rios que n√£o poder√≠amos prever. <br><br>  Em segundo lugar, ele nos ensinou mais uma vez que um teta simples e comprovado nas m√£os do administrador do sistema √© melhor do que um guindaste auto-reagente e auto-dimensionado, em um lugar al√©m das nuvens, que voc√™ nem entende se est√° desmoronando ou realmente come√ßou a escalar. <br><br>  A introdu√ß√£o de qualquer infraestrutura e automa√ß√£o em sua produ√ß√£o n√£o deve causar dor de cabe√ßa desnecess√°ria para a equipe que a atende;  n√£o deve aumentar significativamente o custo de manuten√ß√£o da produ√ß√£o de infraestrutura - a solu√ß√£o deve ser simples, clara, transparente para seus clientes, conveniente e controlada. <br><br><h3>  Perguntas da plat√©ia </h3><br>  <b>Como voc√™ escreve k / v com servidores - um script ou apenas o corrige?</b> <br><br> K/v-     Consul-   -  ,     http- RESTful API  Web UI. <br><br>     ,   -             ,     ,   . <br><br> <b>       ,     Redis?</b> <br><br>        ,    - . <br><br> -,          backend. -,      backend',       ‚Äî    .  I.e.       ,     MAINDB        ,   .        .                  -  ,       . <br><br>      - ,       inmemory key-value    -. <br><br> <b>   ?</b> <br><br>    MySQL ‚Äî Percona server. <br><br> <b>            ?      Maria,     MHA for MySQL,    Galera.</b> <br><br>      Galera.    -   ¬´ ¬ª       Galera       ,     .       ,       . <br><br>    ,     ‚Äî         ,         ,     -  ,    ,         ,   . <br><br><h3>    Pixonic DevGAMM Talks </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CICD:        </a> ( ,   Pixonic); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">     -  Quake Champions</a> ( , backend- Saber Interactive); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> -  - Tacticool</a> ( , Lead Software Engineer  PanzerDog); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> ECS, C# Job System  SRP    </a> ( , Field Engineer  Unity); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> KISS  </a> ( , Lead Game Programmer  1C Game Studios); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">      </a> ( , Deputy Technical Officer  Pixonic). </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Cucumber  :  BDD-    </a> ( , Technical Product Manager  ALICE Platform). </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt424777/">https://habr.com/ru/post/pt424777/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt424763/index.html">Um editor de texto n√£o √© a sua matem√°tica mais alta, aqui voc√™ precisa pensar</a></li>
<li><a href="../pt424765/index.html">Gerenciamento de estado em aplicativos Flutter</a></li>
<li><a href="../pt424767/index.html">N√≥s fazemos um bolo de Habr. Novamente</a></li>
<li><a href="../pt424771/index.html">Experi√™ncia pessoal: de uma ideia e uma folha em branco a uma vers√£o de rascunho de um site</a></li>
<li><a href="../pt424773/index.html">Biofarma e modelagem num√©rica: experi√™ncia e pr√°tica da Amgen</a></li>
<li><a href="../pt424779/index.html">SPA de v√°rias p√°ginas em Python</a></li>
<li><a href="../pt424781/index.html">Ensinando e testando redes neurais no PyTorch usando o Ignite</a></li>
<li><a href="../pt424787/index.html">Entrevista com Aaron Patterson, presidente da Confer√™ncia RubyRussia 2018</a></li>
<li><a href="../pt424789/index.html">Como implantar um aplicativo Ruby on Rails com o HAProxy Ingress, unicorn / puma e soquetes da web</a></li>
<li><a href="../pt424791/index.html">Expandindo os recursos de rede de um rel√© program√°vel usando WI-FI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>