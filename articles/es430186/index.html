<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∞üèª üé® üñáÔ∏è Computaci√≥n perezosa en la vida cotidiana üåí üë®‚Äç‚öïÔ∏è üßùüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Y aunque las personas que usan scripts de python para escribir una lista de compras o compilan datos de alquiler compilan por cabeza, pero si sucede q...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Computaci√≥n perezosa en la vida cotidiana</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430186/"><p>  Y aunque las personas que usan scripts de python para escribir una lista de compras o compilan datos de alquiler compilan por cabeza, pero si sucede que usas scripts para resolver tareas rutinarias y, a veces, los scripts funcionan durante un tiempo inaceptablemente largo, entonces la idea es usar c√°lculos perezosos a todo lo que se mueva, te gustar√°. </p><a name="habracut"></a><br><p>  En los cap√≠tulos anteriores de mi carta, di una descripci√≥n gratuita del funcionamiento de la biblioteca evalcache. <br>  Enlace: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Almacenamiento en cach√© de disco de √°rboles de computaci√≥n diferida</a> </p><br><p>  Para no aburrirlo con la necesidad de estudiar ese material antes de leer esto, un breve resumen de la √∫ltima parte: </p><br><p> evalcache envuelve datos, funciones y m√©todos en objetos perezosos.  Cada objeto vago tiene una clave hash especial caracterizada por el m√©todo de su construcci√≥n.  Las operaciones se pueden realizar en objetos perezosos, lo que lleva a la generaci√≥n de nuevos objetos perezosos.  Estas operaciones se ven exactamente como operaciones en datos ordinarios, pero en realidad no se realizan c√°lculos; en cambio, se construye un √°rbol de objetos perezosos que se refieren entre s√≠, recordando sus operaciones y sus argumentos.  Si es necesario obtener datos, se realiza una operaci√≥n para abrir el objeto vago, que activa la cadena de c√°lculos o extrae el resultado del cach√©, si el objeto con esta clave se calcul√≥ antes. </p><br><h2 id="o-nekotoryh-izmeneniyah">  Sobre algunos cambios </h2><br><p>  Desde que escrib√≠ el √∫ltimo art√≠culo, evalcache ha obtenido algunos mecanismos adicionales. </p><br><h3 id="mehanika-nekeshiruemogo-ispolneniya">  Mec√°nica de ejecuci√≥n no almacenada en cach√© </h3><br><p>  Resulta que el hash de un objeto perezoso es algo tan √∫til que desea usarlo en una situaci√≥n en la que el almacenamiento en cach√© del objeto en s√≠ es imposible e innecesario. </p><br><p>  Se ha introducido una sintaxis especial para este prop√≥sito: </p><br><pre><code class="python hljs">lazyhash = evalcache.LazyHash() <span class="hljs-comment"><span class="hljs-comment">#: #evalcache.Lazy(self, cache=None, fastdo=True) @lazyhash def foo(): ...</span></span></code> </pre> <br><p>  En esta versi√≥n, el objeto se calcula inmediatamente en el momento de la creaci√≥n, pero de todos modos se devuelve un archivo diferido.  Esto le permite construir √°rboles de c√°lculo sin la necesidad de almacenar en cach√© algunos objetos. </p><br><h3 id="mehanika-neyavnogo-raskrytiya">  Mec√°nica de divulgaci√≥n impl√≠cita </h3><br><p>  La divulgaci√≥n impl√≠cita es el comportamiento esperado de un recordatorio.  Aunque evalcache se dise√±√≥ originalmente no para la memorizaci√≥n, sino para trabajar con √°rboles de c√°lculo, se puede lograr una divulgaci√≥n impl√≠cita basada en algoritmos de evalcache.  Se <code>onuse</code> introducido dos nuevas opciones en el <code>onplace</code> y en <code>onuse</code> para esto.  onplace conduce a la divulgaci√≥n del objeto perezoso inmediatamente despu√©s de la creaci√≥n, y se usa cuando se intenta usarlo en algunas de las operaciones permitidas para el objeto perezoso. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> evalcache lazy = evalcache.Lazy(cache={}, onuse=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-comment"><span class="hljs-comment">#lazy = evalcache.Lazy(cache={}, onplace=True) ###   . #lazy = evalcache.Memoize() ###   . #lazy = evalcache.Memoize(onplace=True) ###   . @lazy def fib(n): if n &lt; 2: return n return fib(n - 1) + fib(n - 2) for i in range(0,100): print(fib(i))</span></span></code> </pre> <br><p>  Pero no estamos hablando de esta adici√≥n innecesaria, dise√±ada para hacer que la biblioteca sea un poco m√°s similar a otros lenificadores.  Y sobre archivos perezosos: </p><br><h3 id="lenivye-fayly">  Archivos perezosos </h3><br><p>  Evalcache contiene un complemento para lenificar funciones que generan archivos.  Inicialmente, se supon√≠a que esta funcionalidad se utilizar√≠a para lenificar la generaci√≥n de capturas de pantalla.  Como result√≥ m√°s tarde, utilizando la mec√°nica de los archivos perezosos, puede hacer otras cosas interesantes. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> evalcache <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> evalcache.lazyfile lazyfile = evalcache.lazyfile.LazyFile(cache = evalcache.DirCache(<span class="hljs-string"><span class="hljs-string">".evalfile"</span></span>)) @lazyfile(field=<span class="hljs-string"><span class="hljs-string">"path"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data, path)</span></span></span><span class="hljs-function">:</span></span> f = open(path, <span class="hljs-string"><span class="hljs-string">"w"</span></span>) f.write(data) f.close() foo(<span class="hljs-string"><span class="hljs-string">"HelloWorld"</span></span>,<span class="hljs-string"><span class="hljs-string">"data.dat"</span></span>)</code> </pre> <br><p>  ¬øC√≥mo funciona? <br>  En general, la l√≥gica del trabajo es la misma que con todos los objetos perezosos. <br>  <code>foo("HelloWorld","data.dat")</code> Comienza a construir un objeto vago cuya clave hash est√° vinculada a los argumentos que se le pasan.  Despu√©s de eso, se aplica la mec√°nica de la divulgaci√≥n impl√≠cita, lo que lleva a un inicio instant√°neo del c√°lculo. </p><br><p>  Pero luego cambia el curso de acci√≥n. <br>  <code>@lazyfile(field="path")</code> decorador lazyfile analiza un par√°metro con el nombre especificado en el campo.  El decorador espera que, tras la ejecuci√≥n de la funci√≥n, se cree un archivo a lo largo de esta ruta.  evalcache toma este archivo y crea un enlace r√≠gido en el directorio hash <code>".evalfile"</code> .  El nombre del archivo de enlace duro corresponde a la clave hash del objeto vago.  M√°s tarde, cuando un archivo con ese nombre est√° en el cach√©, evalcache, al expandir el objeto en lugar de llamar a la funci√≥n, simplemente crea un enlace fijo en el lugar requerido para el archivo existente en el cach√©. </p><br><p>  Es √∫til que un archivo diferido sea un objeto diferido ordinario, y se pueden usar otros objetos diferidos para generarlo. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> evalcache <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> evalcache.lazyfile lazy = evalcache.lazy.Lazy(cache = evalcache.DirCache(<span class="hljs-string"><span class="hljs-string">".evalcache"</span></span>)) lazyfile = evalcache.lazyfile.LazyFile(cache = evalcache.DirCache(<span class="hljs-string"><span class="hljs-string">".evalfile"</span></span>)) @lazyfile(field=<span class="hljs-string"><span class="hljs-string">"path"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data, path)</span></span></span><span class="hljs-function">:</span></span> f = open(path, <span class="hljs-string"><span class="hljs-string">"w"</span></span>) f.write(data) f.close() @lazy <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">datagenerator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"HelloWorld"</span></span> foo(datagenerator(),<span class="hljs-string"><span class="hljs-string">"data.dat"</span></span>)</code> </pre> <br><h2 id="primenenie-lenifikacii-k-montazhu-video-cherez-instrument-moviepy">  Aplicando lenificaci√≥n a la edici√≥n de video a trav√©s de la herramienta moviepy. </h2><br><p>  Como sabes, cualquier tarea se puede resolver con un script de Python.  El conjunto de bibliotecas de Python es tan vasto que es muy dif√≠cil encontrar una tarea que no est√© cubierta por los m√≥dulos de Python. </p><br><p>  En particular, la biblioteca moviepy y las dos horas de estudio de la documentaci√≥n nos proporcionan un editor de video simple y funcional.  Instalaci√≥n - por favor.  Sonido para imponer, por favor.  Efectos especiales, por favor. </p><br><p>  Sin embargo, como siempre, trabajar con scripts tiene un inconveniente.  Cada vez que se ejecuta el script, todos los artefactos se reconstruyen nuevamente.  Al instalar un video de una hora, la operaci√≥n de dicho script puede durar mucho tiempo. </p><br><p>  El uso de la biblioteca evalcache ayud√≥ a hacer ajustes a esta situaci√≥n. </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python3 #coding:utf-8 import sys import types from moviepy.editor import * import evalcache.lazyfile lazyhash = evalcache.LazyHash() lazyfile = evalcache.lazyfile.LazyFile() LazyVideoClip = lazyhash(VideoClip) VideoFileClip = lazyhash(VideoFileClip) AudioFileClip = lazyhash(AudioFileClip) CompositeVideoClip = lazyhash(CompositeVideoClip) concatenate_videoclips = lazyhash(concatenate_videoclips) @lazyfile("path") def lazy_write_videofile(path, clip): clip.write_videofile(path) source = VideoFileClip("source.mp4") music0 = AudioFileClip("music0.mp3") music1 = AudioFileClip("music1.mp3") music = music0 dur = 3 s0 = 1 s1 = 8 s2 = 16 part0 = source.subclip(s0, s0 + dur) part1 = source.subclip(s1, s1 + dur * 2).fl_time(lambda t: t * 2).set_duration(2) part2 = source.subclip(s2, s2 + dur * 4).fl_time(lambda t: t * 5).set_duration(2) clip = concatenate_videoclips([part0, part1, part2]) clip = clip.set_audio(music.set_duration(clip.duration)) lazy_write_videofile("part0.mp4", part0) lazy_write_videofile("part1.mp4", part1) lazy_write_videofile("part2.mp4", part2) lazy_write_videofile("part0_mus.mp4", part0.set_audio(music.set_duration(part0.duration))) lazy_write_videofile("part1_mus.mp4", part1.set_audio(music.set_duration(part1.duration))) lazy_write_videofile("part2_mus.mp4", part2.set_audio(music.set_duration(part2.duration))) if len(sys.argv) &gt; 1 and sys.argv[1] == "compile": clip.lazy_write_videofile("clip.mp4", clip)</span></span></code> </pre> <br><p>  Lo que hay </p><br><p>  Usamos mecanismos de ejecuci√≥n no almacenados en cach√©, ya que no existe el deseo o la necesidad de lidiar con el almacenamiento en cach√© de objetos moviepy.  Al hacerlo, obtenemos todos los beneficios de los objetos perezosos para rastrear cambios en el √°rbol de ejecuci√≥n. </p><br><p>  Envuelva las llamadas de la biblioteca en lenificadores: </p><br><pre> <code class="python hljs">LazyVideoClip = lazyhash(VideoClip) VideoFileClip = lazyhash(VideoFileClip) AudioFileClip = lazyhash(AudioFileClip) CompositeVideoClip = lazyhash(CompositeVideoClip) concatenate_videoclips = lazyhash(concatenate_videoclips)</code> </pre> <br><p>  Usando esta construcci√≥n, generaremos los archivos: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@lazyfile("path") def lazy_write_videofile(path, clip): clip.write_videofile(path)</span></span></code> </pre> <br><p>  Una vez completadas las operaciones necesarias en la secuencia de video, escribimos partes de nuestro clip en archivos separados.  Con y sin m√∫sica: </p><br><pre> <code class="plaintext hljs">lazy_write_videofile("part0.mp4", part0) lazy_write_videofile("part1.mp4", part1) lazy_write_videofile("part2.mp4", part2) lazy_write_videofile("part0_mus.mp4", part0.set_audio(music.set_duration(part0.duration))) lazy_write_videofile("part1_mus.mp4", part1.set_audio(music.set_duration(part1.duration))) lazy_write_videofile("part2_mus.mp4", part2.set_audio(music.set_duration(part2.duration)))</code> </pre> <br><p>  Estos archivos se recompilar√°n solo cuando cambien las ramas de ejecuci√≥n correspondientes. </p><br><p>  Cuando el resultado est√© completo, recolecte las partes en un archivo grande usando la opci√≥n 'compilar': </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(sys.argv) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-string"><span class="hljs-string">"compile"</span></span>: clip.lazy_write_videofile(<span class="hljs-string"><span class="hljs-string">"clip.mp4"</span></span>, clip)</code> </pre> <br><h2 id="vmesto-zaklyucheniya">  En lugar de una conclusi√≥n: </h2><br><p>  Este texto muestra c√≥mo, con la ayuda de la biblioteca evalcache, puede indultar un algoritmo que asume la generaci√≥n de archivos. <br>  Este enfoque le permite reducir la dependencia de un software especializado o evitar escribir una l√≥gica compleja del ensamblaje selectivo. </p><br><h3 id="ssylki">  Referencias </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Proyecto Github</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Proyecto Pypi</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es430186/">https://habr.com/ru/post/es430186/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es430168/index.html">Usando ClickHouse en VK, o por qu√© escribimos KittenHouse</a></li>
<li><a href="../es430172/index.html">Sitio est√°tico sin servidor utilizando IPFS</a></li>
<li><a href="../es430178/index.html">Sol artificial chino ...</a></li>
<li><a href="../es430180/index.html">"La mente est√° en l√≠nea". Contacto con una mente diferente</a></li>
<li><a href="../es430182/index.html">CodeOne 2018 como JavaOne pero solo en m√°scara</a></li>
<li><a href="../es430188/index.html">Configuraci√≥n de HTTP / 2 usando Apache 2.4, PHP 7 y Ubuntu 18.04 LTS como ejemplo</a></li>
<li><a href="../es430190/index.html">Credibilidad, valores P y la crisis de reproducibilidad</a></li>
<li><a href="../es430194/index.html">Gu√≠a: Crear aplicaciones sin servidor</a></li>
<li><a href="../es430196/index.html">Go lintpack: administrador de linter composable</a></li>
<li><a href="../es430198/index.html">Desde un contador Geiger, f√≥sforos y arduins. Primera parte - Teor√≠a</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>