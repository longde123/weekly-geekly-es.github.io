<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👸🏿 🍤 🍇 Trik untuk menautkan dan mengunduh file Mach-O 🕉️ 🔺 👨‍🔬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saya mempersembahkan kepada Anda terjemahan artikel saya dari blog Darling Project. Sedikit bantuan pada konsep yang digunakan: Darwin - sistem operas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Trik untuk menautkan dan mengunduh file Mach-O</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417507/"><p> <em>Saya mempersembahkan kepada Anda terjemahan artikel saya dari blog Darling Project.</em>  <em>Sedikit bantuan pada konsep yang digunakan: Darwin - sistem operasi open source yang mendasari macOS, iOS dan sistem operasi lain dari Apple;</em>  <em>Mach-O adalah format biner dari file dan perpustakaan yang dapat dieksekusi yang digunakan di Darwin;</em>  <em>dyld - bootloader dinamis yang digunakan Darwin untuk mengunduh file Mach-O;</em>  <em>dylib adalah pustaka yang dapat dimuat secara dinamis (biasanya memiliki ekstensi <code>.dylib</code> ).</em> </p><br><p><img src="https://habrastorage.org/webt/q4/to/tb/q4totbx7ltcbh_gj58-qnayiffg.png" alt="Gambar untuk menarik perhatian"></p><br><p>  Tujuan dari Proyek Darling adalah untuk mengaktifkan aplikasi macOS untuk berjalan di Linux, dan kemampuan untuk mengunduh file biner dalam format Mach-O adalah salah satu langkah kunci menuju tujuan ini. </p><br><p>  Awalnya, Darling dibangun berdasarkan penerapan Mach-O loader dan gagasan penyiaran panggilan antara API Darwin tingkat tinggi dan rekan-rekan Linux-nya.  Sejak itu, fokus kami telah bergeser ke menjalankan kode dalam wadah Darwin yang semakin terisolasi.  Karena kami <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">beralih menggunakan Mach-O untuk komponen internal Darling</a> , kami dapat menggunakan dyld asli Apple, serta membangun banyak komponen open source Darwin lainnya.  Kita masih membutuhkan bootloader Mach-O sederhana untuk boot dyld itu sendiri. </p><a name="habracut"></a><br><p>  Mach-O, bersama dengan Mach sendiri, mungkin merupakan ciri khas Darwin yang paling menonjol, dan berbagai perpustakaan dan kerangka kerja yang disediakan oleh Apple memanfaatkan banyak fitur tidak jelas dari format Mach-O.  Ini menjadikan bekerja dengan Mach-O salah satu tugas paling penting dan terkemuka dalam mengembangkan Darling.  Dari implementasi pemuat Mach-O asli hingga perakitan komponen Darwin (pertama dalam bentuk file ELF khusus, dan sekarang dalam bentuk Mach-O nyata) - kita perlu memahami struktur internal Mach-O pada tingkat yang jauh lebih dalam daripada yang biasanya diperlukan dari biasa pengembang untuk platform Darwin. </p><br><p>  Kami menyelesaikan pengantar ini dan melanjutkan untuk membahas beberapa trik yang ditawarkan format Mach-O kepada kami. </p><br><h2 id="ustanovochnye-imena">  Nama pemasangan </h2><br><p>  Pada Windows dan Linux, pustaka dinamis direferensikan dengan namanya (misalnya, <code>libc.so</code> ), setelah itu tugas penghubung dinamis adalah menemukan pustaka dengan nama yang cocok di salah satu direktori pustaka standar.  Darwin segera menggunakan (hampir) path lengkap ke file perpustakaan, yang disebut nama instal untuk perpustakaan ini.  Agaknya, ini dilakukan untuk mencegah <em>penggantian dylib</em> [pembajakan dylib] - serangan di mana dylib palsu ditempatkan di direktori di mana ia akan ditemukan oleh penghubung dinamis lebih awal dari yang asli, yang memungkinkan dylib palsu untuk mengeksekusi kode arbitrer atas nama program, yang dengan demikian meyakinkan hal ini unduh dylib. </p><br><p>  Tidak hanya executable dan libraries menyimpan nama instalasi penuh dari dependensi mereka, tetapi dependensi Mach-O sendiri “tahu” nama instalasinya sendiri.  Sebenarnya, ini adalah bagaimana linker mempelajari nama instalasi mana yang akan digunakan untuk dependensi: ia membacanya dari dependensi itu sendiri. </p><br><p>  Saat menautkan dylib, Anda menentukan nama instalasinya menggunakan opsi ld <code>-dylib_install_name</code> atau <code>-dylib_install_name</code> : </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -install_name /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib/libfoo.dylib</code> </pre> <br><p>  Sekarang ketika Anda menautkan file Mach-O lain (misalnya <code>libbar.dylib</code> ) ke <code>libfoo.dylib</code> , ld akan menulis nama instalasi libfoo - <code>/usr/local/lib/libfoo.dylib</code> <code>libbar</code> <code>/usr/local/lib/libfoo.dylib</code> <code>libbar</code> - dalam <code>libbar</code> dependensi <code>libbar</code> , dan di situlah dyld berada akan mencari <code>libfoo</code> saat runtime. </p><br><p>  Menggunakan path lengkap berfungsi cukup baik untuk pustaka sistem, yang, pada kenyataannya, dipasang di tempat-tempat yang sebelumnya dikenal dalam sistem file;  tetapi dengan perpustakaan yang datang sebagai bagian dari bundel aplikasi, ada masalah.  Meskipun setiap aplikasi dapat berasumsi bahwa itu akan diinstal di <code>/Applications/AppName.app</code> , secara umum, itu berarti bahwa rakitan aplikasi bersifat portabel dan dapat dipindahkan secara bebas di sekitar sistem file, sehingga jalur pustaka tertentu di dalam rakitan tersebut tidak dapat diketahui terlebih dahulu. </p><br><p>  Sebagai solusi untuk masalah ini, Darwin mengizinkan nama instalasi untuk memulai dengan <code>@executable_path</code> , <code>@loader_path</code> , atau <code>@rpath</code> - yaitu, tidak mutlak, tetapi menunjukkan jalur pustaka relatif ke jalur ke file yang dapat dieksekusi utama, jalur ke "memuat" (file atau pustaka yang dapat dieksekusi, yang secara langsung tergantung pada pustaka ini) atau relatif terhadap daftar path yang ditentukan oleh file executable utama, masing-masing.  <code>@executable_path</code> dan <code>@loader_path</code> berfungsi tanpa kerumitan tambahan, tetapi jika setidaknya satu dari dependensi Anda (atau dependensi transitifnya) memiliki nama setup menggunakan <code>@rpath</code> , Anda harus secara eksplisit mengatur <code>@rpath</code> ketika menautkan file executable Anda menggunakan opsi ld <code>-rpath</code> berapa banyak yang Anda butuhkan: </p><br><pre> <code class="bash hljs">$ ld -o runme -rpath @executable_path/../Frameworks -rpath @executable_path/../bin/lib</code> </pre> <br><p>  (Konsep rpath sampai batas tertentu menghancurkan ide asli jalur perpustakaan terkenal, dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">membuka</a> kemungkinan serangan spoofing dylib. Kita dapat mengasumsikan bahwa ini membuat segala sesuatu yang berhubungan dengan nama instalasi cukup tidak berguna.) </p><br><h2 id="ciklicheskie-zavisimosti">  Ketergantungan siklik </h2><br><p>  Ketika kode sumber proyek menempati beberapa file, sangat normal jika file-file ini saling bergantung satu sama lain.  Ini berfungsi dengan baik selama semua file ini dikompilasi menjadi biner tunggal - file yang dapat dieksekusi atau perpustakaan.  Apa yang tidak berfungsi adalah ketika beberapa pustaka dinamis saling bergantung. </p><br><p>  Anda mungkin berpendapat bahwa alih-alih menggunakan dependensi siklik antara pustaka dinamis, ada baiknya mendesain ulang arsitektur proyek, dan saya setuju dengan Anda.  Tetapi jika ada sesuatu yang khas dari Apple, itu adalah bahwa mereka tidak pernah berhenti untuk memikirkan semuanya dan melakukannya dengan benar;  sebaliknya, mereka meletakkan tongkat dan trik di atas satu sama lain.  Dalam hal ini, untuk Sayang, kita perlu membuat dependensi melingkar berfungsi, karena berbagai libSystem <code>libSystem</code> , seperti <code>libsystem_dyld</code> , <code>libsystem_kernel</code> dan <code>libsystem_pthread</code> , semuanya saling bergantung satu sama lain.  (Sampai saat ini, kami juga harus secara siklik menghubungkan kerangka kerja Kakao seperti AppKit, Core Graphics dan Core OpenGL, karena cara Core OpenGL diimplementasikan di The Cocotron, tetapi kami <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">mendesain ulang</a> arsitektur implementasi Core OpenGL kami dan dapat menyingkirkan siklus ini. dependensi.) </p><br><p>  Pada prinsipnya, dependensi melingkar harus berfungsi dengan baik: penghubung dinamis sudah tahu cara memuat setiap perpustakaan hanya sekali, sehingga tidak akan memiliki masalah dengan rekursi tak terbatas.  Masalahnya adalah bahwa pustaka semacam itu tidak dapat dengan mudah <em>dihubungkan</em> , karena setiap panggilan tautan hanya membuat satu pustaka, dan ketika menautkan binari apa pun, semua ketergantungannya yang sudah ditautkan harus ditransfer ke tautan tersebut.  Kami harus menautkan salah satu perpustakaan kami terlebih dahulu, dan saat ini yang lain belum siap, jadi kami tidak akan dapat mentransfernya ke tautan tersebut. </p><br><p>  Kuncinya di sini adalah menghubungkan beberapa (atau untuk kesederhanaan, semua) perpustakaan ini <em>dua kali</em> .  Untuk pertama kalinya, beri tahu tautan untuk mengabaikan dependensi yang hilang, dan sungguh, jangan lulus dependensi: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -flat_namespace -undefined suppress $ ld -o libbar.dylib bar.o -flat_namespace -undefined suppress</code> </pre> <br><p>  (Lihat di bawah untuk <code>-flat_namespace</code> .) </p><br><p>  Tentu saja, jika Anda mencoba untuk langsung menggunakan dylib yang dihasilkan, Anda akan mendapatkan kesalahan tautan dinamis pada saat run time.  Sebagai gantinya, tautkan pustaka-pustaka ini untuk kedua kalinya, dengan meneruskan dylib yang dihasilkan sebagai dependensi: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o libbar.dylib $ ld -o libbar.dylib bar.o libfoo.dylib</code> </pre> <br><p>  Kali ini, penghubung melihat semua karakter, jadi kami tidak menyuruhnya mengabaikan kesalahan (dan jika beberapa karakter benar-benar hilang, Anda akan mendapatkan kesalahan). </p><br><p>  Terlepas dari kenyataan bahwa beberapa, jika tidak semua, perpustakaan terkait dengan salinan dependensi yang "salah", dyld akan melihat versi yang benar saat runtime.  Agar ini berfungsi, pastikan kedua salinan dari masing-masing perpustakaan memiliki nama instalasi yang sama. </p><br><p>  Detail lain di sini adalah urutan inisialisasi.  Kode apa pun dapat mendeklarasikan fungsi penginisialisasi menggunakan perintah <code>__attribute__((constructor))</code> compiler (daftar inisialisasi tersebut masuk ke bagian <code>__mod_init_func</code> di file Mach-O).  Fungsi-fungsi ini dipanggil oleh dyld saat memuat biner di mana mereka berada sebelum memanggil <code>main()</code> .  Biasanya, inisialisasi masing-masing perpustakaan dijalankan setelah inisialisasi dependensinya, sehingga setiap inisialisasi dapat berharap bahwa perpustakaan dependensi sudah diinisialisasi dan siap untuk bekerja.  Tentu saja, ini tidak dapat dijamin untuk dependensi siklik;  dyld akan menjalankan inisialisasi mereka dalam <em>beberapa</em> urutan.  Anda dapat menandai dependensi sebagai dependensi ke atas untuk menyesuaikan pesanan ini;  dyld akan menginisialisasi perpustakaan yang telah ditandai oleh seseorang sebagai ketergantungannya, terakhir.  Jadi, untuk membuat <code>libfoo</code> diinisialisasi setelah <code>libbar</code> , tautkan mereka seperti ini: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o libbar.dylib $ ld -o libbar.dylib bar.o -upward_library libfoo.dylib</code> </pre> <br><p>  Untuk membuatnya lebih nyaman, kami memiliki fungsi Darling CMake yang disebut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>add_circular</code></a> , yang menangani semua kesulitan dan memungkinkan Anda untuk menggunakannya seperti itu secara sederhana dan secara deklaratif: </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(DYLIB_INSTALL_NAME <span class="hljs-string"><span class="hljs-string">"/usr/lib/system/libdispatch.dylib"</span></span>) add_circular(libdispatch_shared FAT SOURCES <span class="hljs-variable"><span class="hljs-variable">${dispatch_SRCS}</span></span> SIBLINGS system_c system_kernel system_malloc system_blocks system_pthread system_dyld system_duct unwind platform compiler_rt UPWARD objc )</code> </pre> <br><h2 id="dvuhurovnevoe-prostranstvo-imyon-simvolov">  Namespace karakter dua tingkat </h2><br><p>  Tabel simbol di Mach-O tidak hanya menyimpan nama simbol, mereka juga "mengingat" dari perpustakaan mana (atau file yang dapat dieksekusi) simbol mana yang diambil.  Dengan kata lain, nama simbol ada dalam ruang nama yang ditentukan oleh biner yang mendefinisikannya;  karenanya "namespace dua tingkat" (level lain berarti nama simbol itu sendiri). </p><br><p>  Ruang nama dua tingkat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">diperkenalkan</a> untuk mencegah konflik nama simbol.  Biasanya, jika beberapa perpustakaan menentukan karakter dengan nama yang sama, Anda akan mendapatkan kesalahan saat menautkan;  tetapi ini mungkin tidak berfungsi jika Anda memuat pustaka saat runtime (misalnya, plugin) atau ketika versi pustaka pada waktu tautan dan runtime berbeda.  Untuk perpustakaan yang menggunakan namespace dua tingkat, ini bukan masalah - ini memungkinkan banyak perpustakaan untuk mendefinisikan karakter dengan nama yang sama tanpa membuat konflik. </p><br><p>  Ruang nama dua tingkat dapat dimatikan dengan kembali menggunakan "ruang nama datar" (salah satu alasan untuk ini adalah bahwa menggunakan ruang nama dua tingkat menyiratkan bahwa setiap karakter harus diizinkan selama menghubungkan, sehingga ruang nama datar diperlukan untuk <code>-undefined_suppress</code> , karena kami lihat di atas).  Ld memiliki dua flag yang memungkinkan menonaktifkan namespace dua tingkat selama menghubungkan: <code>-flat_namespace</code> , yang hanya mempengaruhi satu file Mach-O, dan <code>-force_flat_namespace</code> , yang hanya bekerja dengan file yang dapat dieksekusi, bukan perpustakaan, dan memaksa seluruh proses untuk menggunakan flat namespace.  Selain itu, Anda dapat memaksa dyld untuk menggunakan namespace datar saat runtime dengan mengatur variabel lingkungan <code>DYLD_FORCE_FLAT_NAMESPACE</code> . </p><br><p>  Salah satu fitur menggunakan namespace dua-tingkat adalah bahwa Anda harus selalu menghubungkan setiap Mach-O secara eksplisit ke semua pustaka dan kerangka kerja tempat bergantung.  Misalnya, jika Anda menautkan ke AppKit, Anda tidak bisa hanya menggunakan Yayasan;  Anda harus menautkannya secara eksplisit.  Fitur lain adalah bahwa, sebagai penulis perpustakaan atau kerangka kerja, Anda tidak dapat dengan bebas memindahkan implementasi simbol "turun" di sepanjang rantai ketergantungan, seperti yang biasa Anda lakukan (misalnya, Anda tidak bisa hanya memindahkan kode dari AppKit ke Foundation).  Untuk memungkinkan ini, Mach-O, ld, dan dyld memiliki beberapa fitur tambahan, yaitu <em>sub-perpustakaan</em> , <em>ekspor ulang</em> <em>karakter,</em> dan <em>meta-karakter</em> . </p><br><h2 id="podbiblioteki">  Sub perpustakaan </h2><br><p>  Sub-perpustakaan - suatu mekanisme yang memungkinkan satu perpustakaan (disebut perpustakaan <em>fasad</em> [perpustakaan payung] atau perpustakaan payung [perpustakaan payung]) untuk mendelegasikan pelaksanaan sebagian fungsinya ke perpustakaan lain (disebut sub-perpustakaannya [sub-perpustakaan]);  atau, jika Anda melihatnya dari sisi lain, memungkinkan perpustakaan untuk mengekspor kembali simbol yang disediakan oleh perpustakaan lain ke publik. </p><br><p>  Tempat utama di mana ini digunakan adalah, sekali lagi, <code>libSystem</code> dengan sub-pustaka yang ada di <code>/usr/lib/system</code> ;  tetapi dapat digunakan dengan sepasang perpustakaan: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -lobjc -sub_library libobjc <span class="hljs-comment"><span class="hljs-comment"># : $ ld -o libfoo.dylib foo.o -reexport-lobjc</span></span></code> </pre> <br><p>  Satu-satunya hal yang memengaruhi ini dibandingkan dengan hanya menautkan ke perpustakaan itu adalah bahwa perintah <code>LC_REEXPORT_DYLIB</code> ditulis ke file yang dihasilkan alih-alih <code>LC_LOAD_DYLIB</code> biasa (termasuk simbol dari sub-perpustakaan saat menautkan <em>tidak</em> disalin ke perpustakaan payung, sehingga tidak perlu lagi tautan jika karakter baru ditambahkan ke sublibrary nanti).  Pada saat runtime, <code>LC_REEXPORT_DYLIB</code> juga bekerja mirip dengan <code>LC_LOAD_DYLIB</code> : dyld akan memuat sub-perpustakaan dan membuat karakternya tersedia untuk yang lainnya (tetapi tidak seperti <code>LC_LOAD_DYLIB</code> , dalam hal namespace dua tingkat, karakter akan berasal dari perpustakaan payung). </p><br><p>  Apa yang benar-benar berbeda tentang <code>LC_REEXPORT_DYLIB</code> adalah apa yang saya lakukan ketika Anda menautkan perpustakaan <em>lain</em> ke <code>libfoo</code> : alih-alih hanya mencari simbol di semua objek dan file dylib yang diteruskan ke sana, ld juga akan membuka dan melihat sublibrary yang diekspor kembali (dalam hal ini contoh <code>libobjc</code> ). </p><br><p>  Bagaimana dia tahu di mana mencarinya?  Satu-satunya yang disimpan di <code>libfoo.dylib</code> adalah nama instalasi <code>libobjc.dylib</code> , jadi di situlah ld berharap untuk menemukannya.  Ini berarti bahwa perpustakaan harus dipasang di tempatnya sebelum dapat digunakan sebagai sub-perpustakaan untuk hal lain;  ini berfungsi dengan baik untuk pustaka sistem seperti <code>libobjc</code> , tetapi bisa sangat tidak nyaman atau sama sekali tidak mungkin jika Anda mencoba untuk mengekspor kembali sub-pustaka Anda sendiri. </p><br><p>  Untuk mengatasi masalah ini, ld menyediakan opsi <code>-dylib_file</code> , yang memungkinkan Anda menentukan jalur dylib yang berbeda untuk digunakan selama menautkan: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -reexport_library /path/to/libsubfoo.dylib $ ld -o libbar.dylib bar.o libfoo.dylib -dylib_file @executable_path/lib/foo/libsubfoo.dylib:/path/to/libsubfoo.dylib</code> </pre> <br><p>  Meskipun <code>libSystem</code> dan beberapa pustaka sistem lainnya mengekspor kembali sub-pustaka mereka, Anda tidak harus menggunakan <code>-dylib_file</code> saat menautkan masing-masing file yang dapat dieksekusi pada macOS;  ini karena pustaka sistem sudah diinstal sesuai dengan nama instalasinya.  Tetapi ketika membangun Darling di Linux, kita harus memberikan beberapa opsi <code>-dylib_file</code> (dan argumen umum lainnya) untuk setiap panggilan ld.  Kami melakukan ini dengan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">fungsi khusus</a> yang secara otomatis diterapkan ketika menggunakan <code>add_darling_library</code> , <code>add_darling_executable</code> , dan lainnya. </p><br><h2 id="pereeksportirovanie-simvolov">  Mengekspor ulang karakter </h2><br><p>  Terkadang perpustakaan mungkin perlu mengekspor kembali beberapa karakter - tetapi tidak sekaligus - dari perpustakaan lain.  Sebagai contoh, Core Foundation <code>NSObject</code> , yang dalam versi terbaru diimplementasikan di dalam runtime Objective-C, untuk kompatibilitas. </p><br><p>  (Jika Anda tertarik mengapa <code>NSObject</code> dulunya berada di Core Foundation dan bukan Foundation, itu karena bagaimana <em>konversi gratis</em> [bridging bebas pulsa, kemampuan untuk secara langsung melemparkan antara Core Foundation dan tipe Foundation yang sesuai tanpa konversi tambahan], mensyaratkan bahwa kelas pembungkus pribadi lebih dari jenis dari Core Foundation (misalnya, <code>__NSCFString</code> ) diimplementasikan di Core Foundation, dan sebagai objek Objective-C, mereka harus diwarisi dari <code>NSObject</code> . Mungkin, semua ini dapat diwujudkan dengan ke yang lain, meninggalkan <code>NSObject</code> dengan semua ahli warisnya di Yayasan dan loop  esky menghubungkan Core Foundation dan Foundation, tetapi Apple memutuskan untuk memigrasi kelas privat pembantu ini bersama dengan <code>NSObject</code> ke Core Foundation, dan di Darling kami melakukannya dengan cara yang sama untuk menjaga kompatibilitas.) </p><br><p>  Anda dapat mengirimkan daftar karakter yang akan <code>-reexported_symbols_list</code> menggunakan opsi <code>-reexported_symbols_list</code> -nya: </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> .objc_class_name_NSObject &gt; reexport_list.exp $ ld -o CoreFoundation CFFiles.o -lobjc -reexported_symbols_list reexport_list.exp</code> </pre> <br><p>  Meskipun mengekspor kembali <em>beberapa</em> simbol terdengar sangat mirip dengan mengekspor kembali <em>semua</em> simbol, mekanisme penerapannya sangat berbeda dari cara kerja sub-perpustakaan.  Tidak ada perintah <code>LC_*_DYLIB</code> yang digunakan;  sebaliknya, <em>simbol tidak langsung</em> khusus (ditunjukkan oleh bendera <code>N_INDIR</code> ) dimasukkan ke dalam tabel nama, dan itu berperilaku seperti simbol yang didefinisikan dalam perpustakaan ini.  Jika perpustakaan itu sendiri menggunakan simbol ini, salinan kedua dari simbol tersebut akan <em>muncul</em> di tabel nama (seperti yang terjadi tanpa ekspor ulang). </p><br><p>  Satu hal kecil yang perlu diingat ketika menggunakan ekspor ulang karakter secara eksplisit adalah Anda kemungkinan besar perlu mengekspor kembali karakter dengan nama yang berbeda untuk arsitektur yang berbeda.  Memang, konvensi penamaan [name mangling] konvensi untuk Objective-C dan antarmuka biner Objective-C [ABI] untuk i386 dan x86-64 berbeda, jadi pada i386 Anda hanya perlu <code>.objc_class_name_NSObject</code> , dan pada x86-64 - <code>_OBJC_CLASS_$_NSObject</code> , <code>_OBJC_IVAR_$_NSObject.isa</code> dan <code>_OBJC_METACLASS_$_NSObject</code> .  Anda tidak perlu memikirkannya saat menggunakan sub-perpustakaan, karena di sana semua simbol yang tersedia secara otomatis untuk setiap arsitektur diekspor kembali secara otomatis. </p><br><p>  Sebagian besar alat untuk bekerja dengan Mach-O secara transparan menangani biner "tebal" atau universal (file Mach-O berisi beberapa sub-Mach-O untuk beberapa arsitektur).  Dentang dapat mengkompilasi binari universal dengan semua arsitektur yang diminta, dapat memilih arsitektur mana untuk memuat dari dylib, melihat di mana arsitektur yang dapat dieksekusi mendukung, dan alat-alat seperti ld, otool dan nm bekerja dengan arsitektur yang sesuai dengan arsitektur komputer (mis. .x86-64), kecuali jika Anda secara eksplisit memerlukan arsitektur yang berbeda dengan bendera khusus. ,  -   ,     –  ,         ,      . </p><br><p>         .  ld          ,  ,     dylib-           lipo: </p><br><pre> <code class="bash hljs">$ ld -o CF_i386.dylib CFFiles.o -arch i386 -lobjc -reexported_symbols_list reexport_i386.exp $ ld -o CF_x86-64.dylib CFFiles.o -arch x86_64 -lobjc -reexported_symbols_list reexport_x86_64.exp $ lipo -arch i386 CF_i386.dylib -arch x86_64 CF_x86-64.dylib -create -output CoreFoundation</code> </pre> <br><p>  Darling   CMake-   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>add_separated_framework</code></a> ,        lipo,    CMake-   Core Foundation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">  </a> : </p><br><pre> <code class="cmake hljs">add_separated_framework(CoreFoundation CURRENT_VERSION SOURCES <span class="hljs-variable"><span class="hljs-variable">${cf_sources}</span></span> VERSION <span class="hljs-string"><span class="hljs-string">"A"</span></span> DEPENDENCIES objc system icucore LINK_FLAGS <span class="hljs-comment"><span class="hljs-comment"># ...    ) set_property(TARGET CoreFoundation_i386 APPEND_STRING PROPERTY LINK_FLAGS " -Wl,-reexported_symbols_list,${CMAKE_CURRENT_SOURCE_DIR}/reexport_i386.exp") set_property(TARGET CoreFoundation_x86_64 APPEND_STRING PROPERTY LINK_FLAGS " -Wl,-reexported_symbols_list,${CMAKE_CURRENT_SOURCE_DIR}/reexport_x86_64.exp")</span></span></code> </pre> <br><h2 id="meta-simvoly"> - </h2><br><p> - –   , ,   Apple     ,    . </p><br><p>   Mach-O-       macOS,   ,     <code>-mmacosx-version-min=10.x</code> (    iOS, tvOS, watchOS    ,  Apple      ).     ;   ,         <code>AVAILABLE_MAC_OS_X_VERSION_10_13_AND_LATER</code>      C++  <code>libstdc++</code> (  GNU)  <code>libc++</code> (  LLVM).      ,        Mach-O.  ,   ld   <code>-macosx_version_min</code> (        <code>m</code> ),     Mach-O- <code>LC_VERSION_MIN_MACOSX</code> ( dyld,    ,        ). </p><br><p>    ,  ld  <code>-macosx_version_min</code>   ,  - <em></em> Mach-O- . - –  ,     <code>$ld$</code> ,  ld,    ,    :     ,   .      <code>$ld$$$</code> .  <code></code>   <code>os10.5</code>  ,       - –  ,        <em></em>   Mach-O-   <em></em> ,   ; <code></code>   <code>add</code> , <code>hide</code> , <code>install_name</code>  <code>compatibility_version</code> ,   ld ,          <code></code> ,  <code></code>          ( )  , . </p><br><p>  <code></code>     , ,  ,             ; ,   -,   <code>libobjc</code> ,   <code>NSObject</code>  ,      macOS: </p><br><pre> <code class="hljs perl">$ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_METACLASS_$_NSObject</code> </pre> <br><p>           ,   ,   ,          ,   <em></em>   . </p><br><h2 id="rezolvery-simvolov">   </h2><br><p>      dyld –   <em> </em> [symbol resolvers],     .    ,  ,          ,  dyld     ,     . </p><br><p>         ld,     .          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a> <code>.symbol_resolver</code> : </p><br><pre> <code class="hljs mel">;    foo _foo1: movl <span class="hljs-number"><span class="hljs-number">1</span></span>, %eax ret _foo2: movl <span class="hljs-number"><span class="hljs-number">2</span></span>, %eax ret .symbol_resolver _foo ;  -  call _condition jz .ret_foo2 movq _foo1, %rax ret .ret_foo2: movq _foo2, %rax ret ;   ,   _foo  ;   ,     , ;     . .<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> _foo _foo:</code> </pre> <br><p>    C          ,    ,     C: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//         return 0; } static void *foo_resolver() { __asm__(".symbol_resolver _foo"); return condition() ? &amp;foo1 : &amp;foo2; }</span></span></code> </pre> <br><p> (     <code>_foo</code>   <code>foo</code> ,    Darwin        C,          .  ,      Mach-O    Darling,            ELF-,     .) </p><br><p>   <code>_foo</code>     ,          (           ),  <code>foo()</code>  <code>foo_resolver()</code>     ,  : </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ __asm__(<span class="hljs-string"><span class="hljs-string">".symbol_resolver _foo"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> condition() ? &amp;foo1 : &amp;foo2; }</code> </pre> <br><p>   ,    –     - ,   <code>foo()</code>   ,      (      <code>int</code> -).  ,  ,       :  <code>dlsym("_foo")</code>    <code>_foo</code> –  ,      ,       , –         . ,       ,    ,      <code>foo()</code>    <code>_foo</code> . </p><br><p>         .  Apple    <code>libplatform</code>                     : </p><br><pre> <code class="hljs tex">#define _OS_VARIANT_RESOLVER(s, v, ...) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__attribute__((visibility(OS_STRINGIFY(v)))) extern void* s(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>void* s(void) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__asm__(".symbol_resolver _" OS_STRINGIFY(s)); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__VA_ARGS__ <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>} #define _OS_VARIANT_UPMP_RESOLVER(s, v) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>_OS_VARIANT_RESOLVER(s, v, <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>uint32_t *_c = (void*)(uintptr_t)_COMM_PAGE_CPU_CAPABILITIES; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>if (*_c &amp; kUP) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>extern void OS_VARIANT(s, up)(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return &amp;OS_VARIANT(s, up); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>} else { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>extern void OS_VARIANT(s, mp)(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return &amp;OS_VARIANT(s, mp); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>})</code> </pre> <br><p>    ,  –    –     (   <code>kUP</code>    ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">commpage</a> ), , ,       [spinlock].            ,                . </p><br><p>  Darling          :    Mach-O-   ELF-  Linux,    [host,    ,      Darling] – ,   <code>libX11</code>  <code>libcairo</code> . </p><br><p>     ELF- –  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>libelfloader</code></a> ,     ELF,        ,   ld-linux,  dyld  Linux,    ld-linux      ELF-.    <code>libelfloader</code>  Mach-O     <code>/usr/lib/darling/libelfloader.dylib</code>   Darwin-chroot-;  ,       Darwin-. </p><br><p>     ,  <code>libelfloader</code>  <em></em>     Mach-O  ELF.    ( <code>_elfcalls</code> ),  <a href=""> </a> <code>libSystem</code> ,  Darwin      ,        ELF-  Linux. «» Darwin  Linux         –   ,      C ( <code>libSystem_c</code>  <code>glibc</code> , ). </p><br><p>     ELF-   Darwin,   - <code>libelfloader</code> API  <code>_elfcalls-&gt;dlsym_fatal(_elfcalls-&gt;dlopen_fatal("libX11.so"), "XOpenDisplay")</code> . ,       <a href="">wrapgen</a> ,   ELF-    ,       ,   The Cocotron –          Linux –   .   wrapgen  ELF- (, <code>libX11.so</code> ),           : </p><br><pre> <code class="hljs delphi">#include &lt;elfcalls.h&gt; extern struct elf_calls* _elfcalls; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> void* lib_handle; __attribute__((<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function">)) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initializer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ lib_handle = _elfcalls-&gt;dlopen_fatal("libX11.so"); }</span></span></span><span class="hljs-function"> __</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attribute__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">((</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">destructor</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">destructor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ _elfcalls-&gt;dlclose_fatal(lib_handle); }</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">XOpenDisplay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ __asm__(".symbol_resolver _XOpenDisplay"); return _elfcalls-&gt;dlsym_fatal(lib_handle, "XOpenDisplay"); }</span></span></span></span></code> </pre> <br><p>       Mach-O-     <code>/usr/lib/native/libX11.dylib</code> ,   Mach-O-     ,     <em></em> <code>libX11.so</code> ,    Mach-O.  ,    CMake-   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>wrap_elf</code></a> ,    wrapgen,  Mach-O-     <code>/usr/lib/native</code> :   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a> <code>wrap_elf(X11 libX11.so)</code>      <code>libX11</code> ,         Mach-O-. </p><br><p>       Linux        <em></em> .    ,   Darling   ,      Darwin    Linux,     .  Darling –     Darwin ( ,  Darwin); , , ,           Darwin,   <code>libSystem</code> , dyld, XNU  launchd,        ,     ,   commpage.       ,   <code>libsystem_kernel</code> ,    ,         Linux,   «»   Darwin- – Linux  GNU/Linux   .          Linux-    ,   Linux   (  X server)      ,     [witnessing a magic trick] –     <code>libelfloader</code> ,    wrapgen, ,  .   ,    ,   , ,  ,   . </p><br><h2 id="poryadok-simvolov">   </h2><br><p>   -   ,      Mach-O-,    ld      . ( ,     – <em></em> ,  Apple,  ,  .) </p><br><p>   ,   ,     ,      ,  <em> </em> [order file],     ld   : </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -order_file foo.order</code> </pre> <br><p>     <code>-reexported_symbols_list</code> ,     , <code>-order_file</code>  ,    : </p><br><pre> <code class="hljs 1c">symbol1 symbol2 <span class="hljs-meta"><span class="hljs-meta">#  . # #    ,     , # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   (   C)  #        . foo.o: _static_function3 #  ,   ,     #     ;    # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">       #  lipo,   </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  # . i386:symbol4</span></span></code> </pre> <br><p>   ( ,    ,  )         «»        .         ,       ,    ,        ,       <code>.subsections_via_symbols</code> ,    Mach-O-   ,     , ,   ,   . </p><br><p>   ,   Apple    –     <code>libdispatch</code> . <code>libdispatch</code>     , «OS object»,     ,       .          Objective-C,  <code>libdispatch</code>   <em> </em> (    Core Foundation),     <code>libdispatch</code> -  Objective-C-    ,     Objective-C-.  ,      <code>dispatch_data_t</code>  <code>NSData *</code>      API  Cocoa (    ). </p><br><p>   <a href=""></a>     ,    ,   Objective-C-   <em>OS object vtables</em>     .   ,    <a href=""><code>DISPATCH_OBJECT_TFB</code></a> , ,   Objective-C     <code>libdispatch</code> -,    <code>isa</code>  <code>vtable</code> - <code>dispatch_object</code>  <code>object</code> : </p><br><pre> <code class="hljs tex">#define DISPATCH_OBJECT_TFB(f, o, ...) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>if (slowpath((uintptr_t)((o)._os_obj-&gt;os_obj_isa) &amp; 1) || <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>slowpath((Class)((o)._os_obj-&gt;os_obj_isa) &lt; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>(Class)OS_OBJECT_VTABLE(dispatch_object)) || <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>slowpath((Class)((o)._os_obj-&gt;os_obj_isa) &gt;= <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>(Class)OS_OBJECT_VTABLE(object))) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return f((o), ##__VA_ARGS__); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>}</code> </pre> <br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">  </a> ,   ,     <code>libdispatch</code> . </p><br><h2 id="podmena-simvolov">   </h2><br><p>       (   ) –    <code>DYLD_INSERT_LIBRARIES</code> ,  dyld     Mach-O-          . ,         ,    ,          <code>DYLD_FORCE_FLAT_NAMESPACE</code> . </p><br><p>  ,      ,    <em></em> -  .     (   ),     <code>dlsym()</code>   <code>RTLD_NEXT</code> ,  : </p><br><pre> <code class="hljs lua">int <span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, int flags, mode_t mode) { printf(<span class="hljs-string"><span class="hljs-string">" open(%s)\n"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>); // <span class="hljs-string"><span class="hljs-string">"  "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strcmp(<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, <span class="hljs-string"><span class="hljs-string">"foo"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">path</span></span> = <span class="hljs-string"><span class="hljs-string">"bar"</span></span>; } int (*original_open)(const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *, int, mode_t); original_open = dlsym(RTLD_NEXT, <span class="hljs-string"><span class="hljs-string">"open"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> original_open(<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, flags, mode); }</code> </pre> <br><p>    , dyld     ,  <em>dyld-</em> [dyld iterposing].      Mach-O-   <code>__interpose</code> , dyld      ,    –    . </p><br><p>   ,       – ,        <code>__interpose</code> –    <em> </em> [implicit interposing].   ,  <code>__interpose</code>       (     ),  dyld      .  , dyld- <em></em>       ,      - .  , dyld  ,      -    ,     - (   Mach-O-): </p><br><pre> <code class="hljs pgsql">static <span class="hljs-type"><span class="hljs-type">int</span></span> my_open(const <span class="hljs-type"><span class="hljs-type">char</span></span>* <span class="hljs-type"><span class="hljs-type">path</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> flags, mode_t mode) { printf("Called open(%s)\n", <span class="hljs-type"><span class="hljs-type">path</span></span>); // "  " <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strcmp(<span class="hljs-type"><span class="hljs-type">path</span></span>, "foo") == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-type"><span class="hljs-type">path</span></span> = "bar"; } //    ,    //  <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>()      my_open(). <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-type"><span class="hljs-type">path</span></span>, flags, mode); } //      __interpose __attribute__ ((section ("__DATA,__interpose"))) static struct { <span class="hljs-type"><span class="hljs-type">void</span></span> *replacement, *replacee; } replace_pair = { my_open, <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> };</code> </pre> <br><p>  ,      –          –       Mach-O-  -        [relocation table].        ,   dyld      (    ),     . </p><br><p> ,      <code>dyld_dynamic_interpose</code> ,       : </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *replacement, *replacee; } replacement_tuple; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mach_header</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dso_handle</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dyld_dynamic_interpose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> struct mach_header*, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> replacement_tuple replacements[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interpose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ replacement_tuple replace_pair = { my_open, open }; dyld_dynamic_interpose(&amp;__dso_handle, &amp;replace_pair, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br><p> ,     ,         ,     . </p><br><p> <code>DYLD_INSERT_LIBRARIES</code>  dyld-         Objective-C,   C,  - ,       Objective-C- ( <code>IMP</code> ),    Objective-C       ,   <em>method swizzling</em> ( <em>isa swizzling</em> ). </p><br><p>      Darling     xtrace,       . </p><br><p>   Darwin    Darwin (    –   BSD    Mach- [Mach traps]).        <code>libsystem_kernel</code> ,   ABI     userspace.  Darling,    <code>libsystem_kernel</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a>    Darwin     Linux    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Darling-Mach</a> ,    Linux,  Mach   . </p><br><p> strace,       Linux,    ,  Linux-;  strace    Darwin,   Darling,     Linux,       Darwin (    Linux,    ELF- ).   ,    Darwin  Linux      ,   ,    Darwin   –  ,       –   . </p><br><p>        , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">xtrace</a> .    strace,           ,   <code>ptrace()</code> API, xtrace          .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a> <code>DYLD_INSERT_LIBRARIES=/usr/lib/darling/libxtrace.dylib</code> ,   - [trampoline functions]       ,        .  xtrace   ,  strace,       ,       ,   : </p><br><pre> <code class="bash hljs">Darling [~]$ xtrace arch &lt;......&gt; [223] mach_timebase_info_trap (...) [223] mach_timebase_info_trap () -&gt; KERN_SUCCESS [223] issetugid (...) [223] issetugid () -&gt; 0 [223] host_self_trap () [223] host_self_trap () -&gt; port right 2563 [223] mach_msg_trap (...) [223] mach_msg_trap () -&gt; KERN_SUCCESS [223] _kernelrpc_mach_port_deallocate_trap (task=2563, name=-6) [223] _kernelrpc_mach_port_deallocate_trap () -&gt; KERN_SUCCESS [223] ioctl (...) [223] ioctl () -&gt; 0 [223] fstat64 (...) [223] fstat64 () -&gt; 0 [223] ioctl (...) [223] ioctl () -&gt; 0 [223] write_nocancel (...) i386 [223] write_nocancel () -&gt; 5 [223] <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> (...)</code> </pre> <br><p>    ,       BSD  Mach.   ,   <code>write()</code>  <code>exit()</code> ,     Linux-,       . ,  Mach-   <code>ioctl</code> -   <code>/dev/mach</code> ,     ;   BSD- <code>ioctl()</code> ,   stdio   ,      stdin  stdout (    tty) <a href=""></a>     <code>readlink()</code>    <code>/proc/self/fd/</code> . </p><br><hr><br><p>          Mach-O,        ,     dyld.      : </p><br><ul><li>    ,       ,     dylib,  ,  <em> </em>  . ld       <code>-bundle_loader</code> . </li><li>   ,  <code>LC_LOAD_DYLIB</code> , <code>LC_REEXPORT_DYLIB</code>  <code>LC_DYLIB_ID</code>    ,   <em></em>  <em></em>  [compatibility version, current version] ,    –    ,    .              ld <code>-current_version</code>  <code>-compatibility_version</code> , .     dyld ,       ,    ,     . </li><li>      ,  Mach-O     <em>  </em> [source version].     , <code>LC_SOURCE_VERSION</code> .        ld <code>-source_version</code> ,    ,       Mach-O- –    <code>-add_source_version</code>  <code>-no_source_version</code> . </li><li>    <code>Info.plist</code>   <code>__info_plist</code> Mach-O-    [codesign] ,           <code>Info.plist</code> .    <a href="">ad-hoc </a>  Security.framework,  ,      <code>CFBundle</code> / <code>NSBundle</code> API,       ,     ,  . </li></ul><br><p> ,  ,       , ld  dyld    ,    « »,   <code>libSystem</code> ,  -.            <code>/usr/lib/</code> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id417507/">https://habr.com/ru/post/id417507/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id417495/index.html">Tim Rusia dan Ukraina menang atas orang Eropa di Final Eropa Kompetisi InnovateFPGA Intel</a></li>
<li><a href="../id417497/index.html">4 tahun Ilmu Data di Grup Media Schibsted</a></li>
<li><a href="../id417501/index.html">Lifehacks memproduksi papan dua lapis (LUT)</a></li>
<li><a href="../id417503/index.html">Apa yang harus diingat pengembang web untuk melakukan SEO-Feng Shui</a></li>
<li><a href="../id417505/index.html">Intel Merilis Patch untuk Kerentanan Firmware ME Baru</a></li>
<li><a href="../id417509/index.html">Kiat & trik Kubernetes: mempercepat bootstrap dari database besar</a></li>
<li><a href="../id417511/index.html">Intel Mengakuisisi eASIC - Pengembang ASIC Struktural</a></li>
<li><a href="../id417513/index.html">Analog dengan Python dan JavaScript. Bagian dua</a></li>
<li><a href="../id417515/index.html">Apa yang saya pelajari dengan membuat 100 game dalam 5 tahun</a></li>
<li><a href="../id417517/index.html">Halaman sejarah Intel. Foto Kronik dan Kuis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>