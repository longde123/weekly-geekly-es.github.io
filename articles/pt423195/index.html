<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå¨Ô∏è üë∞üèø üçæ O que h√° de novo no JPA 2.2 üê∫ üë©üèø‚Äçü§ù‚Äçüë©üèæ ‚òîÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Feliz feriado a todos! 

 De repente, aconteceu que o in√≠cio do segundo grupo "Java Enterprise Developer" coincidiu com o 256¬∫ dia do ano. Coincid√™nci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>O que h√° de novo no JPA 2.2</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/423195/">  Feliz feriado a todos! <br><br>  De repente, aconteceu que o in√≠cio do segundo grupo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Java Enterprise Developer"</a> coincidiu com o 256¬∫ dia do ano.  <s>Coincid√™ncia?</s>  <s>Eu acho que n√£o.</s> <br><br>  Bem, compartilhamos o pen√∫ltimo interesse: que novidades o JPA 2.2 trouxe - resultados de streaming, convers√£o aprimorada de datas, novas anota√ß√µes - apenas alguns exemplos de melhorias √∫teis. <br><br>  Vamos l√°! <br><br>  A Java Persistence API (JPA) √© uma especifica√ß√£o Java EE fundamental que √© amplamente usada no setor.  Independentemente de voc√™ estar desenvolvendo para a plataforma Java EE ou para a estrutura Java alternativa, o JPA √© sua escolha para salvar dados.  O JPA 2.1 melhorou a especifica√ß√£o, permitindo que os desenvolvedores resolvessem problemas como gera√ß√£o autom√°tica de esquemas de banco de dados e trabalho eficiente com procedimentos armazenados no banco de dados.  A vers√£o mais recente, JPA 2.2, aprimora a especifica√ß√£o com base nessas altera√ß√µes. <br>  Neste artigo, falarei sobre novas funcionalidades e darei exemplos que ajudar√£o voc√™ a come√ßar.  Como exemplo, eu uso o projeto "Java EE 8 Playground", dispon√≠vel no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> .  O aplicativo de amostra √© baseado na especifica√ß√£o Java EE 8 e usa as estruturas JavaServer Faces (JSF), Enterprise JavaBeans (EJB) e JPA para persist√™ncia.  Voc√™ precisa estar familiarizado com o JPA para entender do que se trata. <br><br><img src="https://habrastorage.org/webt/2a/o5/xl/2ao5xlvs1k6qa91gdq0ndz3akis.png"><br><a name="habracut"></a><br>  <b>Usando o JPA 2.2</b> <br><br>  O JPA vers√£o 2.2 faz parte da plataforma Java EE 8. √â importante notar que apenas os servidores de aplicativos compat√≠veis com Java EE 8 fornecem uma especifica√ß√£o pronta para uso imediato.  No momento da reda√ß√£o deste texto (final de 2017), havia muitos servidores de aplicativos.  No entanto, √© f√°cil usar o JPA 2.2 com Java EE7.  Primeiro, voc√™ precisa baixar os arquivos JAR apropriados usando o <a href="">Maven Central</a> e adicion√°-los ao projeto.  Se voc√™ estiver usando o Maven em seu projeto, adicione as coordenadas ao arquivo POM do Maven: <br><br><pre><code class="java hljs">&lt;dependency&gt; &lt;groupId&gt;javax.persistence&lt;/groupId&gt; &lt;artifactId&gt;javax.persistence-api&lt;/artifactId&gt; &lt;version&gt;<span class="hljs-number"><span class="hljs-number">2.2</span></span>&lt;/version&gt; &lt;/dependency&gt;</code> </pre> <br>  Em seguida, selecione a implementa√ß√£o JPA que voc√™ deseja usar.  A partir do JPA 2.2, o EclipseLink e o Hibernate t√™m implementa√ß√µes compat√≠veis.  Como exemplos neste artigo, eu uso o <a href="">EclipseLink</a> adicionando a seguinte depend√™ncia: <br><br><pre> <code class="java hljs">&lt;dependency&gt; &lt;groupId&gt;org.eclipse.persistence&lt;/groupId&gt; &lt;artifactId&gt;eclipselink&lt;/artifactId&gt; &lt;version&gt;<span class="hljs-number"><span class="hljs-number">2.7</span></span>.0 &lt;/version&gt; &lt;/dependency&gt;</code> </pre> <br>  Se voc√™ estiver usando um servidor compat√≠vel com Java EE 8, como GlassFish 5 ou Payara 5, poder√° especificar a √°rea "fornecida" para essas depend√™ncias no arquivo POM.  Caso contr√°rio, especifique a √°rea "compilar" para inclu√≠-los na montagem do projeto. <br><br>  <b>Suporte a data e hora do Java 8</b> <br><br>  Talvez uma das adi√ß√µes mais positivas seja o suporte √† API de data e hora do Java 8.  Desde o lan√ßamento do Java SE 8 em 2014, os desenvolvedores usaram solu√ß√µes alternativas para usar a API Date and Time com JPA.  Embora a maioria das solu√ß√µes alternativas seja bastante simples, a necessidade de adicionar suporte b√°sico para a API de data e hora atualizada est√° atrasada.  O suporte JPA para a API Data e hora inclui os seguintes tipos: <br><br><ul><li> <code>java.time.LocalDate</code> </li> <li> <code>java.time.LocalTime</code> </li> <li> <code>java.time.LocalDateTime</code> </li> <li> <code>java.time.OffsetTime</code> </li> <li> <code>java.time.OffsetDateTime</code> </li> </ul><br>  Para um melhor entendimento, explicarei primeiro como o suporte √† API de data e hora funciona sem o JPA 2.2.  O JPA 2.1 s√≥ pode funcionar com constru√ß√µes de data mais antigas, como <code>java.util.Date</code> e <code>java.sql.Timestamp</code> .  Portanto, voc√™ deve usar um conversor para converter a data armazenada no banco de dados em um design antigo suportado pelo JPA 2.1 e, em seguida, convert√™-lo em uma API de Data e Hora atualizada para uso no aplicativo.  Um conversor de data no JPA 2.1 capaz dessa convers√£o pode se parecer com a Listagem 1. O conversor nele √© usado para converter entre <code>LocalDate</code> e <code>java.util.Date</code> . <br><br>  <i>Listagem 1</i> <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Converter</span></span>(autoApply = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocalDateTimeConverter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AttributeConverter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocalDate</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Date</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Date </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertToDatabaseColumn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LocalDate entityValue)</span></span></span><span class="hljs-function"> </span></span>{ LocalTime time = LocalTime.now(); Instant instant = time.atDate(entityValue) .atZone(ZoneId.systemDefault()) .toInstant(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Date.from(instant); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> LocalDate </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertToEntityAttribute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Date databaseValue)</span></span></span></span>{ Instant instant = Instant.ofEpochMilli(databaseValue.getTime()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LocalDateTime.ofInstant(instant, ZoneId.systemDefault()).toLocalDate(); } }</code> </pre> <br>  O JPA 2.2 n√£o precisa mais gravar esse conversor, pois voc√™ est√° usando tipos de data e hora suportados.  O suporte para esses tipos √© incorporado, portanto, voc√™ pode simplesmente especificar o tipo suportado no campo de classe da entidade sem c√≥digo adicional.  O trecho de c√≥digo abaixo demonstra esse conceito.  Observe que n√£o h√° necessidade de adicionar anota√ß√£o ao c√≥digo <code>@Temporal</code> , porque o mapeamento de tipo ocorre automaticamente. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Job</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class"> </span></span>{ . . . <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"WORK_DATE"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LocalDate workDate; . . . }</code> </pre> <br>  Como os tipos de data e hora suportados s√£o objetos de primeira classe na JPA, eles podem ser especificados sem cerim√¥nias adicionais.  No JPA 2.1 <code>@Temporal</code> anota√ß√£o deve ser descrita em todos os campos e propriedades constantes dos <code>java.util.Calendar</code> e <code>java.util.Calendar</code> . <br><br>  Vale ressaltar que apenas alguns dos tipos de data e hora s√£o suportados nesta vers√£o, mas o conversor de atributos pode ser facilmente gerado para funcionar com outros tipos, por exemplo, para converter <code>LocalDateTime</code> em <code>ZonedDateTime</code> .  O maior problema ao escrever esse conversor √© determinar a melhor forma de converter entre tipos diferentes.  Para facilitar ainda mais, os conversores de atributos agora podem ser implementados.  Vou dar um exemplo de implementa√ß√£o abaixo. <br><br>  O c√≥digo na Listagem 2 mostra como converter o tempo de <code>LocalDateTime</code> para <code>ZonedDateTime</code> . <br><br>  <i>Listagem 2</i> <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Converter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocalToZonedConverter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AttributeConverter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZonedDateTime</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocalDateTime</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> LocalDateTime </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertToDatabaseColumn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ZonedDateTime entityValue)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> entityValue.toLocalDateTime(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ZonedDateTime </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertToEntityAttribute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LocalDateTime databaseValue)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ZonedDateTime.of(databaseValue, ZoneId.systemDefault()); } }</code> </pre> <br>  Especificamente, este exemplo √© muito direto porque <code>ZonedDateTime</code> cont√©m m√©todos f√°ceis de converter.  A convers√£o ocorre chamando o m√©todo <code>toLocalDateTime()</code> .  A convers√£o inversa pode ser feita chamando o m√©todo <code>ZonedDateTimeOf()</code> e passando o valor <code>LocalDateTime</code> junto com <code>ZoneId</code> para usar o fuso hor√°rio. <br><br>  <b>Conversores de atributos incorporados</b> <br><br>  Os conversores de atributo foram uma adi√ß√£o muito interessante ao JPA 2.1, pois permitiram que os tipos de atributo fossem mais flex√≠veis.  A atualiza√ß√£o do JPA 2.2 adiciona uma capacidade √∫til para tornar os conversores de atributos implement√°veis.  Isso significa que voc√™ pode incorporar recursos CDI (Contexts and Injection Dependency Injection) diretamente no conversor de atributos.  Essa modifica√ß√£o √© consistente com outros aprimoramentos de CDI nas especifica√ß√µes do Java EE 8, como conversores JSF avan√ßados, pois agora eles tamb√©m podem usar a inje√ß√£o de CDI. <br><br>  Para aproveitar esse novo recurso, basta incorporar os recursos CDI no conversor de atributos, conforme necess√°rio.  A Listagem 2 fornece um exemplo de conversor de atributo e agora vou desmont√°-lo, explicando todos os detalhes importantes. <br><br>  A classe converter deve implementar a interface <code>javax.persistence.AttributeConverter</code> , transmitindo os valores X e Y. O valor X corresponde ao tipo de dados no objeto Java e o valor Y deve corresponder ao tipo da coluna do banco de dados.  Em seguida, a classe do conversor deve ser anotada com <code>@Converter</code> .  Por fim, a classe deve substituir os <code>convertToDatabaseColumn()</code> e <code>convertToEntityAttribute()</code> .  A implementa√ß√£o em cada um desses m√©todos deve converter valores de tipos espec√≠ficos e retornar a eles. <br><br>  Para aplicar o conversor automaticamente toda vez que o tipo de dados especificado for usado, adicione "autom√°tico", como em <code>@Converter(autoApply=true)</code> .  Para aplicar um conversor a um √∫nico atributo, use a anota√ß√£o @Converter no n√≠vel do atributo, conforme mostrado aqui: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Convert</span></span>(converter=LocalDateConverter.java) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LocalDate workDate;</code> </pre> <br>  O conversor tamb√©m pode ser aplicado no n√≠vel da classe: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Convert</span></span>(attributeName=<span class="hljs-string"><span class="hljs-string">"workDate"</span></span>, converter = LocalDateConverter.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Job</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class"> </span></span>{ . . .</code> </pre> <br>  Suponha que eu queira criptografar os valores contidos no campo <code>creditLimit</code> da entidade <code>Customer</code> quando ele for salvo.  Para implementar esse processo, os valores devem ser criptografados antes de serem salvos e descriptografados ap√≥s serem recuperados do banco de dados.  Isso pode ser feito pelo conversor e, usando o JPA 2.2, posso incorporar o objeto de criptografia no conversor para obter o resultado desejado.  A Listagem 3 fornece um exemplo. <br><br>  <i>Listagem 3</i> <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Converter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreditLimitConverter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AttributeConverter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BigDecimal</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BigDecimal</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> CreditLimitEncryptor encryptor; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertToDatabaseColumn</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BigDecimal entityValue)</span></span></span><span class="hljs-function"> </span></span>{ String encryptedFormat = encryptor.base64encode(entityValue.toString()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BigDecimal.valueOf(Long.valueOf(encryptedFormat)); } ... }</code> </pre> <br>  Nesse c√≥digo, o processo √© realizado <code>CreditLimitEncryptor</code> classe <code>CreditLimitEncryptor</code> no conversor e, em seguida, usando-a para ajudar no processo. <br><br>  <b>Resultados da consulta de streaming</b> <br><br>  Agora voc√™ pode tirar proveito f√°cil dos recursos de fluxos do Java SE 8 ao trabalhar com os resultados da consulta.  Os threads n√£o apenas simplificam a leitura, grava√ß√£o e manuten√ß√£o de c√≥digo, mas tamb√©m ajudam a melhorar o desempenho da consulta em algumas situa√ß√µes.  Algumas implementa√ß√µes de encadeamentos tamb√©m ajudam a evitar um n√∫mero simult√¢neo excessivamente grande de solicita√ß√µes de dados, embora em alguns casos o uso da pagina√ß√£o <code>ResultSet</code> possa funcionar melhor que os fluxos. <br><br>  Para ativar essa fun√ß√£o, o m√©todo <code>getResultStream()</code> foi adicionado √†s <code>TypedQuery</code> <code>Query</code> e <code>TypedQuery</code> .  Essa pequena altera√ß√£o permite que a JPA retorne simplesmente um fluxo de resultados em vez de uma lista.  Portanto, se voc√™ estiver trabalhando com um <code>ResultSet</code> grande, faz sentido comparar o desempenho entre uma nova implementa√ß√£o de encadeamento e um <code>ResultSets</code> ou pagina√ß√£o rol√°vel.  O motivo √© que as implementa√ß√µes de encadeamento recuperam todos os registros de uma s√≥ vez, armazenam-nos em uma lista e depois os devolvem.  Uma <code>ResultSet</code> rol√°vel e uma t√©cnica de pagina√ß√£o recuperam dados aos poucos, o que pode ser melhor para grandes conjuntos de dados. <br><br>  Os provedores de persist√™ncia podem decidir substituir o novo m√©todo <code>getResultStream()</code> uma implementa√ß√£o aprimorada.  O Hibernate j√° inclui um m√©todo stream () que usa um <code>ResultSet</code> rol√°vel para analisar os resultados dos registros em vez de retorn√°-los completamente.  Isso permite que o Hibernate trabalhe com conjuntos de dados muito grandes e fa√ßa-o bem.  Pode-se esperar que outros provedores substituam esse m√©todo para fornecer recursos semelhantes que s√£o ben√©ficos para a JPA. <br><br>  Al√©m do desempenho, a capacidade de transmitir resultados √© uma boa adi√ß√£o ao JPA, que fornece uma maneira conveniente de trabalhar com dados.  Vou demonstrar alguns cen√°rios em que isso pode ser √∫til, mas as possibilidades s√£o infinitas.  Nos dois cen√°rios, eu consulto a entidade <code>Job</code> e retorno o fluxo.  Primeiro, observe o c√≥digo a seguir, onde eu simplesmente analiso o fluxo de <code>Jobs</code> rela√ß√£o a um <code>Customer</code> espec√≠fico, chamando o m√©todo de interface <code>Query</code> <code>getResultStream()</code> .  Ent√£o, eu uso esse encadeamento para exibir detalhes sobre o <code>customer</code> e a <code>work date</code> Job'a. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findByCustomer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PoolCustomer customer)</span></span></span></span>{ Stream&lt;Job&gt; jobList = em.createQuery(<span class="hljs-string"><span class="hljs-string">"select object(o) from Job o "</span></span> + <span class="hljs-string"><span class="hljs-string">"where o.customer = :customer"</span></span>) .setParameter(<span class="hljs-string"><span class="hljs-string">"customer"</span></span>, customer) .getResultStream(); jobList.map(j -&gt; j.getCustomerId() + <span class="hljs-string"><span class="hljs-string">" ordered job "</span></span> + j.getId() + <span class="hljs-string"><span class="hljs-string">" - Starting "</span></span> + j.getWorkDate()) .forEach(jm -&gt; System.out.println(jm)); }</code> </pre> <br><br>  Este m√©todo pode ser ligeiramente modificado para que ele retorne uma lista de resultados usando o m√©todo <code>Collectors .toList()</code> seguinte maneira. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Job&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findByCustomer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PoolCustomer customer)</span></span></span></span>{ Stream&lt;Job&gt; jobList = em.createQuery( <span class="hljs-string"><span class="hljs-string">"select object(o) from Job o "</span></span> + <span class="hljs-string"><span class="hljs-string">"where o.customerId = :customer"</span></span>) .setParameter(<span class="hljs-string"><span class="hljs-string">"customer"</span></span>, customer) .getResultStream(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jobList.collect(Collectors.toList()); }</code> </pre> <br>  No cen√°rio a seguir, mostrado abaixo, encontro uma <code>List</code> tarefas relacionadas aos conjuntos de um formul√°rio espec√≠fico.  Nesse caso, retorno todas as tarefas que correspondem ao formul√°rio enviado como uma sequ√™ncia.  Semelhante ao primeiro exemplo, primeiro retorno um fluxo de registros de <code>Jobs</code> .  Em seguida, filtro os registros com base no formul√°rio do pool de clientes.  Como voc√™ pode ver, o c√≥digo resultante √© muito compacto e f√°cil de ler. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Job&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findByCustPoolShape</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String poolShape)</span></span></span></span>{ Stream&lt;Job&gt; jobstream = em.createQuery( <span class="hljs-string"><span class="hljs-string">"select object(o) from Job o"</span></span>) .getResultStream(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jobstream.filter( c -&gt; poolShape.equals(c.getCustomerId().getPoolId().getShape())) .collect(Collectors.toList()); }</code> </pre><br>  Como mencionei anteriormente, √© importante lembrar o desempenho em cen√°rios em que grandes quantidades de dados s√£o retornadas.  Existem condi√ß√µes em que os threads s√£o mais √∫teis na consulta de bancos de dados, mas tamb√©m existem aqueles em que eles podem causar degrada√ß√£o no desempenho.  Uma boa regra geral √© que, se os dados puderem ser consultados como parte de uma consulta SQL, faz sentido fazer exatamente isso.  √Äs vezes, os benef√≠cios do uso de sintaxe de encadeamento elegante n√£o superam o melhor desempenho poss√≠vel com a filtragem SQL padr√£o. <br><br>  <b>Suporte de anota√ß√£o duplicada</b> <br><br>  Quando o Java SE 8 foi lan√ßado, as anota√ß√µes duplicadas se tornaram poss√≠veis, permitindo que voc√™ reutilizasse as anota√ß√µes na declara√ß√£o.  Algumas situa√ß√µes exigem o uso da mesma anota√ß√£o em uma classe ou campo v√°rias vezes.  Por exemplo, pode haver mais de uma anota√ß√£o <code>@SqlResultSetMapping</code> para uma determinada classe de entidade.  Nas situa√ß√µes em que o suporte √† re-anota√ß√£o √© necess√°rio, a anota√ß√£o do cont√™iner deve ser usada.  As anota√ß√µes duplicadas n√£o apenas reduzem o requisito de agrupar cole√ß√µes de anota√ß√µes id√™nticas nas anota√ß√µes de cont√™iner, mas tamb√©m podem facilitar a leitura do c√≥digo. <br><br>  Isso funciona da seguinte maneira: a implementa√ß√£o da classe de anota√ß√£o deve ser marcada com a meta-anota√ß√£o <code>@Repeatable</code> para indicar que ela pode ser usada mais de uma vez.  A meta-anota√ß√£o <code>@Repeatable</code> usa o tipo da classe de anota√ß√£o do cont√™iner.  Por exemplo, a <code>NamedQuery</code> anota√ß√£o <code>NamedQuery</code> agora <code>NamedQuery</code> marcada com a <code>@Repeatable(NamedQueries.class)</code> .  Nesse caso, a anota√ß√£o de cont√™iner ainda est√° em uso, mas voc√™ n√£o precisa pensar nisso ao usar a mesma anota√ß√£o na declara√ß√£o ou classe, porque <code>@Repeatable</code> abstrai esse detalhe. <br><br>  N√≥s damos um exemplo.  Se voc√™ deseja adicionar mais de uma anota√ß√£o <code>@NamedQuery</code> a uma classe de entidade no JPA 2.1, precisar√° encapsul√°-las dentro da anota√ß√£o <code>@NamedQueries</code> , conforme mostrado na Listagem 4. <br><br>  <i>Listagem 4</i> <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"CUSTOMER"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@XmlRootElement</span></span> <span class="hljs-meta"><span class="hljs-meta">@NamedQueries</span></span>({ <span class="hljs-meta"><span class="hljs-meta">@NamedQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"Customer.findAll"</span></span>, query = <span class="hljs-string"><span class="hljs-string">"SELECT c FROM Customer c"</span></span>) , <span class="hljs-meta"><span class="hljs-meta">@NamedQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"Customer.findByCustomerId"</span></span>, query = <span class="hljs-string"><span class="hljs-string">"SELECT c FROM Customer c "</span></span> + <span class="hljs-string"><span class="hljs-string">"WHERE c.customerId = :customerId"</span></span>) , <span class="hljs-meta"><span class="hljs-meta">@NamedQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"Customer.findByName"</span></span>, query = <span class="hljs-string"><span class="hljs-string">"SELECT c FROM Customer c "</span></span> + <span class="hljs-string"><span class="hljs-string">"WHERE c.name = :name"</span></span>) . . .)}) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Customer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class"> </span></span>{ . . . }</code> </pre> <br>  No entanto, na JPA 2.2, tudo √© diferente.  Como <code>@NamedQuery</code> √© uma anota√ß√£o duplicada, ela pode ser especificada na classe de entidade mais de uma vez, conforme mostrado na Listagem 5. <br><br>  <i>Listagem 5</i> <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"CUSTOMER"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@XmlRootElement</span></span> <span class="hljs-meta"><span class="hljs-meta">@NamedQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"Customer.findAll"</span></span>, query = <span class="hljs-string"><span class="hljs-string">"SELECT c FROM Customer c"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NamedQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"Customer.findByCustomerId"</span></span>, query = <span class="hljs-string"><span class="hljs-string">"SELECT c FROM Customer c "</span></span> + <span class="hljs-string"><span class="hljs-string">"WHERE c.customerId = :customerId"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NamedQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"Customer.findByName"</span></span>, query = <span class="hljs-string"><span class="hljs-string">"SELECT c FROM Customer c "</span></span> + <span class="hljs-string"><span class="hljs-string">"WHERE c.name = :name"</span></span>) . . . <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Customer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class"> </span></span>{ . . . }</code> </pre> <br>  Lista de anota√ß√µes duplicadas: <br><br><ul><li> <code>@AssociationOverride</code> </li> <li> <code>@AttributeOverride</code> </li> <li> <code>@Convert</code> </li> <li> <code>@JoinColumn</code> </li> <li> <code>@MapKeyJoinColumn</code> </li> <li> <code>@NamedEntityGraphy</code> </li> <li> <code>@NamedNativeQuery</code> </li> <li> <code>@NamedQuery</code> </li> <li> <code>@NamedStoredProcedureQuery</code> </li> <li> <code>@PersistenceContext</code> </li> <li> <code>@PersistenceUnit</code> </li> <li> <code>@PrimaryKeyJoinColumn</code> </li> <li> <code>@SecondaryTable</code> </li> <li> <code>@SqlResultSetMapping</code> </li> </ul><br>  <b>Conclus√£o</b> <br><br>  A vers√£o JPA 2.2 possui algumas altera√ß√µes, mas as melhorias inclu√≠das s√£o significativas.  Por fim, o JPA est√° alinhado com o Java SE 8, permitindo que os desenvolvedores usem recursos como a API de Data e Hora, transmitindo resultados de consultas e repetindo anota√ß√µes.  Esta vers√£o tamb√©m aprimora a consist√™ncia do CDI, adicionando a capacidade de incorporar recursos CDI em conversores de atributos.  O JPA 2.2 j√° est√° dispon√≠vel e faz parte do Java EE 8, acho que voc√™ gostaria de us√°-lo. <br><br>  O FIM <br><br>  Como sempre, estamos aguardando perguntas e coment√°rios. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt423195/">https://habr.com/ru/post/pt423195/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt423185/index.html">N√£o coma! Impress√£o √∫til de a√ß√∫car 3D</a></li>
<li><a href="../pt423187/index.html">Certificados raiz e intermedi√°rios das autoridades de certifica√ß√£o autorizadas da R√∫ssia</a></li>
<li><a href="../pt423189/index.html">Pesquisa: metade das empresas corrige vulnerabilidades em um m√™s - por qu√™?</a></li>
<li><a href="../pt423191/index.html">Lan√ßamento dos elementos das plataformas offshore. Parte 1</a></li>
<li><a href="../pt423193/index.html">Configurar notifica√ß√µes por push da Web usando pywebpush passo a passo</a></li>
<li><a href="../pt423197/index.html">LOLWUT: uma obra de arte em uma equipe de db</a></li>
<li><a href="../pt423203/index.html">L√≠der de equipe legal ser√° respons√°vel pelo servi√ßo</a></li>
<li><a href="../pt423205/index.html">Projeto de armazenamento no MS SQL Server, integra√ß√£o com 1C 7.7 e automa√ß√£o de desenvolvimento em SSDT</a></li>
<li><a href="../pt423207/index.html">Como fazer uma atualiza√ß√£o autom√°tica de um cliente de jogo online</a></li>
<li><a href="../pt423209/index.html">Formul√°rio 2 do assassino? Vis√£o geral da impressora 3D dental MoonRay S100</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>