<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòÅ ü§∞üèª üßúüèº Introdu√ß√£o √† autoriza√ß√£o Kubernetes do c√¥nsul Hashicorp üòí üöΩ üïò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√â isso mesmo, ap√≥s o lan√ßamento do Hashicorp Consul 1.5.0 no in√≠cio de maio de 2019 no Consul, voc√™ pode autorizar aplicativos e servi√ßos em execu√ß√£o ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Introdu√ß√£o √† autoriza√ß√£o Kubernetes do c√¥nsul Hashicorp</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/473014/"><img src="https://habrastorage.org/webt/ge/q3/ey/geq3eyqujybgzgmalsngtz3azuu.png"><br><p>  √â isso mesmo, ap√≥s o lan√ßamento do <a href="">Hashicorp Consul 1.5.0</a> no in√≠cio de maio de 2019 no Consul, voc√™ pode autorizar aplicativos e servi√ßos em execu√ß√£o no Kubernetes nativamente. </p><br><p>  Neste tutorial, criaremos passo a passo um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">POC</a> (Prova de conceito, PoC - prova de conceito) - demonstrando esse novo recurso. O conhecimento b√°sico do Kubernetes e do C√¥nsul de Hashicorp √© esperado de voc√™. voc√™ pode usar qualquer plataforma em nuvem ou ambiente local; neste guia, usaremos a plataforma em nuvem do Google. </p><a name="habracut"></a><br><h2>  Revis√£o </h2><br><p>  Se recorrermos √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Consul sobre seu m√©todo de autoriza√ß√£o</a> , obteremos uma breve vis√£o geral de sua finalidade e caso de uso, al√©m de alguns detalhes t√©cnicos e uma vis√£o geral da l√≥gica.  Eu recomendo a leitura pelo menos uma vez antes de continuar, pois vou explicar e mastigar tudo agora. </p><br><img src="https://habrastorage.org/webt/ca/xp/mp/caxpmprm5u-8bupb1_fpjgehvcw.png"><br><p>  <i>Figura 1: Vis√£o geral do m√©todo de autoriza√ß√£o do c√¥nsul oficial</i> </p><br><p>  Vamos dar uma olhada na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o para o m√©todo de autoriza√ß√£o espec√≠fico do Kubernetes</a> . </p><br><p>  Obviamente, h√° informa√ß√µes √∫teis, mas n√£o h√° um guia sobre como realmente usar tudo isso.  Portanto, como qualquer pessoa s√£, voc√™ vasculha a Internet em busca de orienta√ß√£o.  E ent√£o ... Seja derrotado.  Isso acontece  Vamos consertar. </p><br><p>  Antes de prosseguirmos com a cria√ß√£o do nosso POC, vamos voltar √† vis√£o geral dos m√©todos de autoriza√ß√£o do Consul (Figura 1) e refin√°-lo no contexto do Kubernetes. </p><br><h2 id="arhitektura">  Arquitetura </h2><br><p>  Neste guia, criaremos um servidor Consul em uma m√°quina separada que ir√° interagir com o cluster Kubernetes com o cliente Consul instalado.  Em seguida, criaremos nosso aplicativo fict√≠cio na lareira e usaremos nosso m√©todo de autoriza√ß√£o personalizado para ler em nosso reposit√≥rio de chaves / valores Consul. </p><br><p>  O diagrama abaixo mostra em detalhes a arquitetura que criamos neste guia, bem como a l√≥gica do m√©todo de autoriza√ß√£o, que ser√° explicada mais adiante. </p><br><img src="https://habrastorage.org/webt/az/zn/kj/azznkjy-wrxrndezbwxezarbs-4.png"><br><p>  <em>Figura 2: Vis√£o geral do m√©todo de autoriza√ß√£o no Kubernetes</em> </p><br><p>  Uma observa√ß√£o r√°pida: o servidor consul n√£o precisa viver fora do cluster Kubernetes para que isso funcione.  Mas sim, ele pode fazer isso e aquilo. </p><br><p> Portanto, pegando o diagrama de vis√£o geral do Consul (Esquema 1) e aplicando o Kubernetes, obtemos o diagrama acima (Esquema 2), e aqui a l√≥gica ser√° a seguinte: </p><br><ol><li>  Cada pod ter√° uma conta de servi√ßo anexada contendo um token JWT gerado e conhecido pelo Kubernetes.  Esse token tamb√©m √© inserido no sub por padr√£o. </li><li>  Nosso aplicativo ou servi√ßo dentro da lareira inicia um comando para entrar no nosso cliente Consul.  A solicita√ß√£o de login tamb√©m indicar√° nosso token e o nome de um m√©todo de autoriza√ß√£o <strong>criado especialmente</strong> (como o Kubernetes).  Esta etapa n¬∫ 2 corresponde √† etapa 1 do esquema Consul (esquema 1). </li><li>  Nosso cliente C√¥nsul encaminhar√° essa solicita√ß√£o ao nosso servidor C√¥nsul. </li><li>  M√ÅGICA!  √â aqui que o servidor Consul consulta a autenticidade da solicita√ß√£o, coleta informa√ß√µes sobre a identidade da solicita√ß√£o e a compara com as regras predefinidas associadas.  Abaixo est√° outro diagrama para ilustrar isso.  Esta etapa corresponde √†s etapas 3, 4 e 5 do diagrama de vis√£o geral do Consul (Esquema 1). </li><li>  Nosso servidor Consul Consul gera um token Consul com permiss√µes de acordo com as regras do m√©todo de autoriza√ß√£o que especificamos (que determinamos) em rela√ß√£o √† identidade do solicitante.  Ent√£o ele enviar√° esse token de volta.  Isso corresponde √† etapa 6 do esquema Consul (esquema 1). </li><li>  Nosso cliente Consul redireciona o token para o aplicativo ou servi√ßo solicitante. </li></ol><br><p>  Nosso aplicativo ou servi√ßo agora pode usar esse token Consul para se comunicar com os dados do Consul, conforme determinado pelos privil√©gios do token. </p><br><h2 id="volshebstvo-raskryto">  A m√°gica √© revelada! </h2><br><p>  Para aqueles de voc√™s que n√£o est√£o felizes apenas com o coelho do chap√©u e querem saber como ele funciona ... deixe-me "mostrar o qu√£o profunda √© a <strong>toca</strong> do <strong>coelho</strong> ". </p><br><p>  Como mencionado anteriormente, nossa etapa "m√°gica" (Esquema 2: Etapa 4) √© que o servidor Consul verifique a autenticidade da solicita√ß√£o, colete informa√ß√µes sobre a solicita√ß√£o e a compare com as regras predefinidas associadas.  Esta etapa corresponde √†s etapas 3, 4 e 5 do diagrama de vis√£o geral do Consul (Esquema 1).  Abaixo est√° um diagrama (Esquema 3), cujo objetivo √© mostrar claramente o que realmente acontece <em>sob o cap√¥ de um</em> m√©todo de autoriza√ß√£o espec√≠fico do Kubernetes. </p><br><img src="https://habrastorage.org/webt/5e/5w/eg/5e5wegybhhtjkwkotfs1disgzc8.png"><br><p>  <em>Esquema 3: A m√°gica √© revelada!</em> </p><br><ol><li>  Como ponto de partida, nosso cliente Consul redireciona a solicita√ß√£o de logon para o servidor Consul com o token da conta Kubernetes e o nome da inst√¢ncia espec√≠fica do m√©todo de autoriza√ß√£o criado anteriormente.  Este passo corresponde ao passo 3 na explica√ß√£o anterior do circuito. </li><li>  Agora, o servidor Consul (ou l√≠der) precisa verificar a autenticidade do token recebido.  Portanto, ele consultar√° o cluster Kubernetes (por meio do cliente Consul) e, com as permiss√µes apropriadas, descobriremos se o token √© genu√≠no e a quem pertence. </li><li>  Em seguida, a solicita√ß√£o verificada retorna ao l√≠der do Consul e o servidor Consul procura uma inst√¢ncia do m√©todo de autoriza√ß√£o com o nome especificado na solicita√ß√£o de login (e digite Kubernetes). </li><li>  O l√≠der do c√¥nsul determina a inst√¢ncia especificada do m√©todo de autoriza√ß√£o (se houver) e l√™ o conjunto de regras vinculativas anexadas a ele.  Ele ent√£o l√™ essas regras e as compara com os atributos de identidade verificados. </li><li>  Tada!  V√° para o passo 5 na explica√ß√£o anterior do circuito. </li></ol><br><h2 id="zapustite-consul-server-na-obychnoy-virtualnoy-mashine">  Execute o Consul-server em uma m√°quina virtual comum </h2><br><p>  A partir de agora, darei principalmente instru√ß√µes para a cria√ß√£o deste POC, geralmente em pontos, sem frases completas explicativas.  Al√©m disso, como observado anteriormente, usarei o GCP para criar toda a infraestrutura, mas voc√™ pode criar a mesma infraestrutura em qualquer outro lugar. </p><br><ul><li>  Inicie a m√°quina virtual (inst√¢ncia / servidor). </li></ul><br><img src="https://habrastorage.org/webt/gg/5m/j-/gg5mj-dyw9frdaglrfwizvbkna8.png"><br><ul><li>  Crie uma regra para firewall (grupo de seguran√ßa na AWS): </li><li>  Eu gosto de atribuir o mesmo nome de m√°quina √† regra e √† tag de rede, neste caso, √© "skywiz-consul-server-poc". </li><li>  Encontre o endere√ßo IP do seu computador local e adicione-o √† lista de endere√ßos IP de origem para que possamos acessar a interface do usu√°rio. </li><li>  Abra a porta 8500 para a interface do usu√°rio.  Clique em Create.  Mudaremos esse firewall [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> ] novamente em breve. </li><li>  Adicione a regra do firewall √† inst√¢ncia.  Retorne ao painel da VM no servidor Consul e adicione "skywiz-consul-server-poc" ao campo de tag de rede.  Clique em Save. </li></ul><br><img src="https://habrastorage.org/webt/o3/7i/52/o37i52gc_8k8fxu4ve113oh7ljc.png"><br><ul><li>  Instale o Consul em uma m√°quina virtual, confira aqui.  Lembre-se de que voc√™ precisa da vers√£o do Consul ‚â• 1.5 [link] </li><li>  Crie um Consul de n√≥ √∫nico - a configura√ß√£o √© a seguinte. </li></ul><br><pre><code class="plaintext hljs">groupadd --system consul useradd -s /sbin/nologin --system -g consul consul mkdir -p /var/lib/consul chown -R consul:consul /var/lib/consul chmod -R 775 /var/lib/consul mkdir /etc/consul.d chown -R consul:consul /etc/consul.d</code> </pre> <br><ul><li>  Para um guia mais detalhado sobre a instala√ß√£o do Consul e a configura√ß√£o de um cluster de 3 n√≥s, consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </li><li>  Crie o arquivo /etc/consul.d/agent.json da seguinte maneira [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> ]: </li></ul><br><pre> <code class="plaintext hljs">### /etc/consul.d/agent.json { "acl" : { "enabled": true, "default_policy": "deny", "enable_token_persistence": true } }</code> </pre> <br><ul><li>  Inicie nosso servidor Consul: </li></ul><br><pre> <code class="plaintext hljs">consul agent \ -server \ -ui \ -client 0.0.0.0 \ -data-dir=/var/lib/consul \ -bootstrap-expect=1 \ -config-dir=/etc/consul.d</code> </pre> <br><ul><li>  Voc√™ deve ver v√°rios resultados e terminar com "... atualiza√ß√£o bloqueada por ACLs". </li><li>  Localize o endere√ßo IP externo do servidor Consul e abra um navegador com esse endere√ßo IP na porta 8500. Verifique se a interface do usu√°rio √© aberta. </li><li>  Tente adicionar um par de chave / valor.  Deve haver um erro.  Isso ocorre porque carregamos o servidor Consul usando a ACL e negamos todas as regras. </li><li>  Volte para o seu shell no servidor Consul e inicie o processo em segundo plano ou de alguma outra maneira para que ele funcione e digite o seguinte: </li></ul><br><pre> <code class="plaintext hljs">consul acl bootstrap</code> </pre> <br><ul><li>  Encontre o valor "SecretID" e volte para a interface do usu√°rio.  Na guia ACL, insira o identificador secreto do token que voc√™ acabou de copiar.  Copie o SecretID em outro lugar, precisaremos mais tarde. </li><li>  Agora adicione um par de chave / valor.  Para este POC, adicione o seguinte: key: ‚Äúcustom-ns / test_key‚Äù, valor: ‚ÄúEstou na pasta custom-ns!‚Äù </li></ul><br><h2 id="zapusk-kubernetes-klastera-dlya-nashego-prilozheniya-s-consul-klientom-v-kachestve-daemonset">  Inicie o Kubernetes Cluster para nosso aplicativo com o Consul Client como Daemonset </h2><br><ul><li>  Crie um cluster K8s (Kubernetes).  Vamos cri√°-lo na mesma zona do servidor para acesso mais r√°pido e, portanto, podemos usar a mesma sub-rede para facilitar a conex√£o com endere√ßos IP internos.  Vamos cham√°-lo de skywiz-app-with-consul-client-poc. </li></ul><br><img src="https://habrastorage.org/webt/_l/vp/gu/_lvpgupywaktqzykauebirhibm0.png"><br><ul><li>  Como observa√ß√£o, aqui est√° um bom guia que encontrei ao configurar um cluster do Consul POC com o Consul Connect. </li><li>  Tamb√©m usaremos o gr√°fico de leme Hashicorp com um arquivo de valores estendidos. </li><li>  Instale e configure o Helm.  Etapas de configura√ß√£o: </li></ul><br><pre> <code class="plaintext hljs">kubectl create serviceaccount tiller --namespace kube-system kubectl create clusterrolebinding tiller-admin-binding \ --clusterrole=cluster-admin --serviceaccount=kube-system:tiller ./helm init --service-account=tiller ./helm update</code> </pre> <br><ul><li>  gr√°fico de leme: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.consul.io/docs/platform/k8s/helm.html</a> </li><li>  Use o seguinte arquivo de valores (observe que a maioria das pessoas desabilitou): </li></ul><br><pre> <code class="plaintext hljs">### poc-helm-consul-values.yaml global: enabled: false image: "consul:latest" # Expose the Consul UI through this LoadBalancer ui: enabled: false # Allow Consul to inject the Connect proxy into Kubernetes containers connectInject: enabled: false # Configure a Consul client on Kubernetes nodes. GRPC listener is required for Connect. client: enabled: true join: ["&lt;PRIVATE_IP_CONSUL_SERVER&gt;"] extraConfig: | { "acl" : { "enabled": true, "default_policy": "deny", "enable_token_persistence": true } } # Minimal Consul configuration. Not suitable for production. server: enabled: false # Sync Kubernetes and Consul services syncCatalog: enabled: false</code> </pre> <br><ul><li>  Aplique o gr√°fico de leme: </li></ul><br><pre> <code class="plaintext hljs">./helm install -f poc-helm-consul-values.yaml ./consul-helm - name skywiz-app-with-consul-client-poc</code> </pre> <br><ul><li>  Ao tentar iniciar, ele precisar√° de permiss√µes para o servidor Consul, ent√£o vamos adicion√°-las. </li><li>  Preste aten√ß√£o ao "intervalo de endere√ßos do pod" localizado no painel do cluster e retorne √† nossa regra para o firewall skywiz-consul-server-poc. </li><li>  Inclua o intervalo de endere√ßos para o IPA na lista de endere√ßos IP e abra as portas 8301 e 8300. </li></ul><br><img src="https://habrastorage.org/webt/gh/wu/bi/ghwubingk53amwe3qnbiendjgvm.png"><br><ul><li>  V√° para a interface do usu√°rio do c√¥nsul e em alguns minutos voc√™ ver√° que nosso cluster aparecer√° na guia n√≥. </li></ul><br><img src="https://habrastorage.org/webt/j1/l_/h5/j1l_h5fj5iusg3ea3rxc7qc_sb8.png"><br><h2 id="nastroyka-metoda-avtorizacii-putem-integracii-consul-s-kubernetes">  Configure o m√©todo de autoriza√ß√£o integrando o Consul ao Kubernetes </h2><br><ul><li>  Retorne ao shell do servidor Consul e exporte o token que voc√™ salvou anteriormente: </li></ul><br><pre> <code class="plaintext hljs">export CONSUL_HTTP_TOKEN=&lt;SecretID&gt;</code> </pre> <br><ul><li>  Precisamos de informa√ß√µes do nosso cluster Kubernetes para criar uma inst√¢ncia do m√©todo auth: </li><li>  kubernetes-host </li></ul><br><pre> <code class="plaintext hljs">kubectl get endpoints | grep kubernetes</code> </pre> <br><ul><li>  kubernetes-service-account-jwt </li></ul><br><pre> <code class="plaintext hljs">kubectl get sa &lt;helm_deployment_name&gt;-consul-client -o yaml | grep "\- name:" kubectl get secret &lt;secret_name_from_prev_command&gt; -o yaml | grep token:</code> </pre> <br><ul><li>  O token √© codificado em base64, ent√£o decodifique-o usando sua ferramenta favorita [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> ] </li><li>  kubernetes-ca-cert </li></ul><br><pre> <code class="plaintext hljs">kubectl get secret &lt;secret_name_from_prev_command&gt; -o yaml | grep ca.crt:</code> </pre> <br><ul><li>  Pegue o certificado ‚Äúca.crt‚Äù (ap√≥s decodificar com base64) e grave-o no arquivo ‚Äúca.crt‚Äù. </li><li>  Agora crie uma inst√¢ncia do m√©todo auth, substituindo os espa√ßos reservados pelos valores que voc√™ acabou de receber. </li></ul><br><pre> <code class="plaintext hljs">consul acl auth-method create \ -type "kubernetes" \ -name "auth-method-skywiz-consul-poc" \ -description "This is an auth method using kubernetes for the cluster skywiz-app-with-consul-client-poc" \ -kubernetes-host "&lt;k8s_endpoint_retrieved earlier&gt;" \ -kubernetes-ca-cert=@ca.crt \ -kubernetes-service-account- jwt="&lt;decoded_token_retrieved_earlier&gt;"</code> </pre> <br><ul><li>  Em seguida, precisamos criar uma regra e anex√°-la √† nova fun√ß√£o.  Voc√™ pode usar a UI do Consul para esta parte, mas usaremos a linha de comando. </li><li>  Escreva uma regra </li></ul><br><pre> <code class="plaintext hljs">### kv-custom-ns-policy.hcl key_prefix "custom-ns/" { policy = "write" }</code> </pre> <br><ul><li>  Aplique a regra </li></ul><br><pre> <code class="plaintext hljs">consul acl policy create \ -name kv-custom-ns-policy \ -description "This is an example policy for kv at custom-ns/" \ -rules @kv-custom-ns-policy.hcl</code> </pre> <br><ul><li>  Encontre o identificador da regra que voc√™ acabou de criar a partir da sa√≠da. </li><li>  Crie uma fun√ß√£o com uma nova regra. </li></ul><br><pre> <code class="plaintext hljs">consul acl role create \ -name "custom-ns-role" \ -description "This is an example role for custom-ns namespace" \ -policy-id &lt;policy_id&gt;</code> </pre> <br><ul><li>  Agora, associaremos nossa nova fun√ß√£o √† inst√¢ncia do m√©todo auth.  Observe que o sinalizador seletor determina se nossa solicita√ß√£o de login receber√° essa fun√ß√£o.  Confira as outras op√ß√µes do seletor aqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.consul.io/docs/acl/auth-methods/kubernetes.html#trusted-identity-attributes</a> </li></ul><br><pre> <code class="plaintext hljs">consul acl binding-rule create \ -method=auth-method-skywiz-consul-poc \ -bind-type=role \ -bind-name='custom-ns-role' \ -selector='serviceaccount.namespace=="custom-ns"'</code> </pre> <br><h2 id="konfiguracii-naposledok">  √öltimas configura√ß√µes </h2><br><h3 id="prava-dostupa">  Direitos de acesso </h3><br><ul><li>  Crie permiss√µes.  Precisamos dar √† Consul permiss√£o para verificar e identificar a identidade do token da conta de servi√ßo K8s. </li><li>  Escreva o seguinte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[link]</a> no arquivo: </li></ul><br><pre> <code class="plaintext hljs">###skywiz-poc-consul-server_rbac.yaml --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: review-tokens namespace: default subjects: - kind: ServiceAccount name: skywiz-app-with-consul-client-poc-consul-client namespace: default roleRef: kind: ClusterRole name: system:auth-delegator apiGroup: rbac.authorization.k8s.io --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: name: service-account-getter namespace: default rules: - apiGroups: [""] resources: ["serviceaccounts"] verbs: ["get"] --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: get-service-accounts namespace: default subjects: - kind: ServiceAccount name: skywiz-app-with-consul-client-poc-consul-client namespace: default roleRef: kind: ClusterRole name: service-account-getter apiGroup: rbac.authorization.k8s.io</code> </pre> <br><ul><li>  Criar direitos de acesso </li></ul><br><pre> <code class="plaintext hljs">kubectl create -f skywiz-poc-consul-server_rbac.yaml</code> </pre> <br><h3 id="podklyuchenie-k-consul-client">  Conecte-se ao Consul Client </h3><br><ul><li>  Conforme observado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> , existem v√°rias op√ß√µes para conectar-se ao daemonset, mas passaremos √† seguinte solu√ß√£o simples: </li><li>  Aplique o seguinte arquivo [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> ]. </li></ul><br><pre> <code class="plaintext hljs">### poc-consul-client-ds-svc.yaml apiVersion: v1 kind: Service metadata: name: consul-ds-client spec: selector: app: consul chart: consul-helm component: client hasDNS: "true" release: skywiz-app-with-consul-client-poc ports: - protocol: TCP port: 80 targetPort: 8500</code> </pre> <br><ul><li>  Em seguida, use o seguinte comando interno para criar o configmap [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> ].  Observe que nos referimos ao nome do nosso servi√ßo, substitua-o se necess√°rio. </li></ul><br><pre> <code class="plaintext hljs">cat &lt;&lt;EOF | kubectl apply -f - apiVersion: v1 kind: ConfigMap metadata: labels: addonmanager.kubernetes.io/mode: EnsureExists name: kube-dns namespace: kube-system data: stubDomains: | {"consul": ["$(kubectl get svc consul-ds-client -o jsonpath='{.spec.clusterIP}')"]} EOF</code> </pre> <br><h2 id="testirovanie-auth-metoda">  Testando o m√©todo de autentica√ß√£o </h2><br><p>  Agora vamos ver a m√°gica em a√ß√£o! </p><br><ul><li>  Crie mais algumas pastas de chaves com a mesma chave de n√≠vel superior (ou seja, &lt;nova_pasta&gt; / amostra_chave) e o valor de sua escolha.  Crie pol√≠ticas e fun√ß√µes apropriadas para novos caminhos-chave.  Faremos as liga√ß√µes mais tarde. </li></ul><br><img src="https://habrastorage.org/webt/qm/yi/jn/qmyijnz6f7yy4kx-3l6owupoulk.png"><br><h3 id="polzovatelskiy-test-prostranstva-imen">  Teste de namespace personalizado: </h3><br><ul><li>  Crie nosso pr√≥prio espa√ßo para nome: </li></ul><br><pre> <code class="plaintext hljs">kubectl create namespace custom-ns</code> </pre> <br><ul><li>  Crie abaixo em nosso novo espa√ßo para nome.  Escreva a configura√ß√£o para a lareira. </li></ul><br><pre> <code class="plaintext hljs">###poc-ubuntu-custom-ns.yaml apiVersion: v1 kind: Pod metadata: name: poc-ubuntu-custom-ns namespace: custom-ns spec: containers: - name: poc-ubuntu-custom-ns image: ubuntu command: ["/bin/bash", "-ec", "sleep infinity"] restartPolicy: Never</code> </pre> <br><ul><li>  Criar em: </li></ul><br><pre> <code class="plaintext hljs">kubectl create -f poc-ubuntu-custom-ns.yaml</code> </pre> <br><ul><li>  Quando o cont√™iner iniciar, v√° at√© l√° e instale o curl. </li></ul><br><pre> <code class="plaintext hljs">kubectl exec poc-ubuntu-custom-ns -n custom-ns -it /bin/bash apt-get update &amp;&amp; apt-get install curl -y</code> </pre> <br><ul><li>  Agora enviaremos uma solicita√ß√£o para entrar no Consul usando o m√©todo de autoriza√ß√£o que criamos anteriormente [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> ]. </li><li>  Para visualizar o token inserido da sua conta de servi√ßo: </li></ul><br><pre> <code class="plaintext hljs">cat /run/secrets/kubernetes.io/serviceaccount/token</code> </pre> <br><ul><li>  Escreva o seguinte em um arquivo dentro do cont√™iner: </li></ul><br><pre> <code class="plaintext hljs">### payload.json { "AuthMethod": "auth-method-test", "BearerToken": "&lt;jwt_token&gt;" }</code> </pre> <br><ul><li>  Entrar! </li></ul><br><pre> <code class="plaintext hljs">curl \ --request POST \ --data @payload.json \ consul-ds-client.default.svc.cluster.local/v1/acl/login</code> </pre> <br><ul><li>  Para concluir as etapas acima em uma √∫nica linha (como executaremos v√°rios testes), voc√™ pode fazer o seguinte: </li></ul><br><pre> <code class="plaintext hljs">echo "{ \ \"AuthMethod\": \"auth-method-skywiz-consul-poc\", \ \"BearerToken\": \"$(cat /run/secrets/kubernetes.io/serviceaccount/token)\" \ }" \ | curl \ --request POST \ --data @- \ consul-ds-client.default.svc.cluster.local/v1/acl/login</code> </pre> <br><ul><li>  Isso funciona!  Deve pelo menos.  Agora pegue o SecretID e tente acessar a chave / valor ao qual devemos ter acesso. </li></ul><br><pre> <code class="plaintext hljs">curl \ consul-ds-client.default.svc.cluster.local/v1/kv/custom-ns/test_key --header ‚ÄúX-Consul-Token: &lt;SecretID_from_prev_response&gt;‚Äù</code> </pre> <br><ul><li>  Voc√™ pode decodificar o "Value" base64 e verificar se ele corresponde ao valor em custom-ns / test_key na interface do usu√°rio.  Se voc√™ usou o mesmo valor acima neste manual, seu valor codificado seria IkknbSBpbiB0aGUgY3VzdG9tLW5zIGZvbGRlciEi. </li></ul><br><h3 id="test-uchetnoy-zapisi-polzovatelskoy-sluzhby">  Teste da conta de servi√ßo do usu√°rio: </h3><br><ul><li>  Crie uma ServiceAccount personalizada com o seguinte comando [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> ]. </li></ul><br><pre> <code class="plaintext hljs">kubectl apply -f - &lt;&lt;EOF apiVersion: v1 kind: ServiceAccount metadata: name: custom-sa EOF</code> </pre> <br><ul><li>  Crie um novo arquivo de configura√ß√£o para a lareira.  Observe que eu ativei a instala√ß√£o do curl para economizar trabalho :) </li></ul><br><pre> <code class="plaintext hljs">###poc-ubuntu-custom-sa.yaml apiVersion: v1 kind: Pod metadata: name: poc-ubuntu-custom-sa namespace: default spec: serviceAccountName: custom-sa containers: - name: poc-ubuntu-custom-sa image: ubuntu command: ["/bin/bash","-ec"] args: ["apt-get update &amp;&amp; apt-get install curl -y; sleep infinity"] restartPolicy: Never</code> </pre> <br><ul><li>  Depois disso, execute o shell dentro do cont√™iner. </li></ul><br><pre> <code class="plaintext hljs">kubectl exec -it poc-ubuntu-custom-sa /bin/bash</code> </pre> <br><ul><li>  Entrar! </li></ul><br><pre> <code class="plaintext hljs">echo "{ \ \"AuthMethod\": \"auth-method-skywiz-consul-poc\", \ \"BearerToken\": \"$(cat /run/secrets/kubernetes.io/serviceaccount/token)\" \ }" \ | curl \ --request POST \ --data @- \ consul-ds-client.default.svc.cluster.local/v1/acl/login</code> </pre> <br><ul><li>  Permiss√£o negada.  Ah, esquecemos de adicionar uma nova liga√ß√£o de regra com as permiss√µes apropriadas, vamos faz√™-lo agora. </li></ul><br><p>  Repita as etapas anteriores acima: <br>  a) Crie uma pol√≠tica id√™ntica para o prefixo "custom-sa /". <br>  b) Crie uma fun√ß√£o, nomeie-a "custom-sa-role" <br>  c) Anexe a pol√≠tica √† fun√ß√£o. </p><br><ul><li>  Crie uma vincula√ß√£o de regras (poss√≠vel apenas a partir de cli / api).  Observe o valor diferente do sinalizador seletor. </li></ul><br><pre> <code class="plaintext hljs">consul acl binding-rule create \ -method=auth-method-skywiz-consul-poc \ -bind-type=role \ -bind-name='custom-sa-role' \ -selector='serviceaccount.name=="custom-sa"'</code> </pre> <br><ul><li>  Efetue login novamente no cont√™iner poc-ubuntu-custom-sa.  Sucesso! </li><li>  Verifique nosso acesso ao caminho custom-sa / key. </li></ul><br><pre> <code class="plaintext hljs">curl \ consul-ds-client.default.svc.cluster.local/v1/kv/custom-sa/test_key --header ‚ÄúX-Consul-Token: &lt;SecretID&gt;‚Äù</code> </pre> <br><ul><li>  Voc√™ tamb√©m pode garantir que esse token n√£o forne√ßa acesso ao kv em "custom-ns /".  Apenas repita o comando acima depois de substituir "custom-sa" pelo prefixo "custom-ns". <br>  Permiss√£o negada. </li></ul><br><h3 id="primer-overleya">  Exemplo de sobreposi√ß√£o: </h3><br><ul><li>  Vale ressaltar que todos os mapeamentos de liga√ß√£o de regra ser√£o adicionados ao token com esses direitos. </li><li>  Nosso cont√™iner poc-ubuntu-custom-sa est√° no espa√ßo de nomes padr√£o - ent√£o vamos us√°-lo para outra liga√ß√£o de regra. </li><li>  Repita as etapas anteriores: <br>  a) Crie uma pol√≠tica id√™ntica para o prefixo da chave ‚Äúpadr√£o /‚Äù. <br>  b) Crie uma fun√ß√£o, nomeie-a como "default-ns-role" <br>  c) Anexe a pol√≠tica √† fun√ß√£o. </li><li>  Criar vincula√ß√£o de regras (poss√≠vel apenas a partir de cli / api) </li></ul><br><pre> <code class="plaintext hljs">consul acl binding-rule create \ -method=auth-method-skywiz-consul-poc \ -bind-type=role \ -bind-name='default-ns-role' \ -selector='serviceaccount.namespace=="default"'</code> </pre> <br><ul><li>  Volte ao nosso cont√™iner poc-ubuntu-custom-sa e tente acessar o caminho / kv padr√£o. </li><li>  Permiss√£o negada. <br>  Voc√™ pode visualizar as credenciais especificadas para cada token na interface do usu√°rio em ACL&gt; Tokens.  Como voc√™ pode ver, apenas uma "custom-sa-role" est√° anexada ao nosso token atual.  O token que estamos usando no momento foi gerado quando efetuamos login e havia apenas uma liga√ß√£o de regra, que ent√£o correspondia.  Precisamos fazer login novamente e usar o novo token. </li><li>  Certifique-se de ler os caminhos ‚Äúcustom-sa /‚Äù e ‚Äúdefault /‚Äù kv. <br>  Sucesso! <br>  Isso ocorre porque o nosso poc-ubuntu-custom-sa corresponde √†s liga√ß√µes das regras custom-sa e default-ns. </li></ul><br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><h3 id="ttl-token-mgmt">  Token TTL mgmt? </h3><br><p>  No momento da reda√ß√£o deste documento, n√£o havia uma maneira integrada de determinar o TTL para tokens gerados por este m√©todo de autoriza√ß√£o.  Seria uma oportunidade fant√°stica para fornecer automa√ß√£o segura da autoriza√ß√£o do Consul. </p><br><p>  √â poss√≠vel criar manualmente um token com TTL: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.consul.io/docs/acl/acl-system.html#acl-tokens</a> <br>  Tempo de expira√ß√£o - o hor√°rio em que esse token ser√° revogado.  (Opcional; adicionado no Consul 1.5.0) </li><li>  Existe apenas para cria√ß√£o / atualiza√ß√£o manual <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.consul.io/api/acl/tokens.html#expirationtime</a> </li></ul><br><p>  Espero que, em um futuro pr√≥ximo, possamos controlar como os tokens s√£o gerados (para cada regra ou m√©todo de autoriza√ß√£o) e adicionar TTL. </p><br><p>  At√© ent√£o, prop√µe-se usar em sua l√≥gica o ponto final da sa√≠da do sistema. </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.consul.io/api/acl/acl.html#logout-from-auth-method</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.consul.io/docs/acl/acl-auth-methods.html#overall-login-process</a> </li></ul><br><h3 id="takzhe-chitayte-drugie-stati-v-nashem-bloge">  Leia tamb√©m outros artigos em nosso blog: </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Qual foi o resultado da migra√ß√£o do ClickHouse sem autoriza√ß√£o para o ClickHouse com autoriza√ß√£o</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Como executar v√°rios pipelines usando o GitLab CI / CD</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tr√™s truques simples para reduzir as imagens do docker</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Traefik como um controlador de ingresso para K8S</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fazendo backup de um grande n√∫mero de projetos da web heterog√™neos</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bot de telegrama para Redmine.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Como simplificar a vida para si e para as pessoas</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt473014/">https://habr.com/ru/post/pt473014/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt473000/index.html">Um breve guia de matem√°tica para estrangeiros</a></li>
<li><a href="../pt473002/index.html">Explica√ß√£o do paradoxo de Fermi no √¢mbito da sociologia espacial Liu Qixin</a></li>
<li><a href="../pt473006/index.html">DevOps - tudo</a></li>
<li><a href="../pt473008/index.html">A Lei de Acelerar Retornos (Parte 2)</a></li>
<li><a href="../pt473012/index.html">Resultados da Advantech Partner Conference em Moscou</a></li>
<li><a href="../pt473016/index.html">Principais modelos de neg√≥cios rent√°veis, implementados pelo crescimento do Uber como aplicativos de t√°xi</a></li>
<li><a href="../pt473018/index.html">Dicas para candidatos de um programador que conduz entrevistas no Facebook</a></li>
<li><a href="../pt473024/index.html">O que voc√™ precisa saber sobre a Internet das coisas: programa educacional fundamental</a></li>
<li><a href="../pt473026/index.html">Om-yum-yum e valida√ß√£o de dados</a></li>
<li><a href="../pt473028/index.html">Na R√∫ssia come√ßou a importar res√≠duos radioativos da Europa? Resolvido</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>