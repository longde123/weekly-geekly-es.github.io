<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèçÔ∏è üë®üèª‚Äçüè≠ üë®‚Äçüîß Na sequ√™ncia do Industrial Ninja: como o PLC foi hackeado no Positive Hack Days 9 ü§û ü§≠ üëâ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No PHDays 9, realizamos um concurso para invadir uma usina de bombeamento de g√°s - o concurso Ninja Industrial . Havia tr√™s estandes no local com par√¢...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Na sequ√™ncia do Industrial Ninja: como o PLC foi hackeado no Positive Hack Days 9</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/460615/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/qt/2p/3g/qt2p3gfe43jhcxqqpuer8lzvgvc.png"></a> <br><br>  No PHDays 9, realizamos um concurso para invadir uma usina de bombeamento de g√°s - o concurso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ninja Industrial</a> .  Havia tr√™s estandes no local com par√¢metros de seguran√ßa diferentes (sem seguran√ßa, baixa seguran√ßa, alta seguran√ßa) emulando o mesmo processo industrial: o ar era bombeado para dentro do bal√£o (e depois descia) sob press√£o. <br><br>  Apesar dos v√°rios par√¢metros de seguran√ßa, o hardware dos estandes era o mesmo: Siemens Simatic S7-300 PLC;  bot√£o de sopro de emerg√™ncia e dispositivo de medi√ß√£o de press√£o (conectado √†s entradas digitais do CLP (DI));  v√°lvulas para bombeamento e sangramento (conectadas √†s sa√≠das digitais do PLC (DO)) - veja a figura abaixo. <br><br><img src="https://habrastorage.org/webt/2u/fq/om/2ufqommgoloxmjwohpy2sphrbha.png"><br><br>  O PLC, dependendo das leituras de press√£o e de acordo com seu programa, decidiu soprar ou inflar a bola (abriu e fechou as v√°lvulas correspondentes).  No entanto, foi fornecido um modo de controle manual em todas as bancadas, o que possibilitou o controle dos estados das v√°lvulas sem restri√ß√µes. <br><br>  Os estandes foram distinguidos pela complexidade de ativar esse modo: em um estande desprotegido, era o mais f√°cil de fazer e, no estande de alta seguran√ßa, consequentemente, era mais dif√≠cil. <br><br>  Em dois dias, cinco dos seis problemas foram resolvidos;  o vencedor do primeiro lugar ganhou 233 pontos (ele passou uma semana se preparando para a competi√ß√£o).  Tr√™s vencedores: Coloco - a1exdandy, II - Rubikoid, III - Ze. <br><br>  No entanto, durante o PHDays, nenhum dos participantes conseguiu superar os tr√™s estandes, por isso decidimos fazer um concurso online e publicamos a tarefa mais dif√≠cil no in√≠cio de junho.  Os participantes tiveram que concluir a tarefa em um m√™s, encontrar a bandeira, descrever a solu√ß√£o em detalhes e de forma interessante. <br><br>  Publicamos uma an√°lise da melhor solu√ß√£o para a tarefa enviada ao longo do m√™s, que foi encontrada por Alexey Kovrizhnykh (a1exdandy) da empresa de Seguran√ßa Digital, que ficou em primeiro lugar na competi√ß√£o durante os PHDays.  Abaixo, fornecemos seu texto com nossos coment√°rios. <a name="habracut"></a><br><br><h2>  An√°lise inicial </h2><br>  Portanto, na tarefa havia um arquivo com arquivos: <br><br><ul><li>  block_upload_traffic.pcapng </li><li>  DB100.bin </li><li>  hints.txt </li></ul><br>  O arquivo hints.txt cont√©m as informa√ß√µes e dicas necess√°rias para resolver a tarefa.  Aqui est√° o seu conte√∫do: <br><br><blockquote><ol><li>  Petrovich me disse ontem que do PlcSim voc√™ pode baixar blocos no Step7. </li><li>  No estande, foram utilizados CLPs da s√©rie Siemens Simatic S7-300. </li><li>  O PlcSim √© um emulador de PLC que permite executar e depurar programas para PLCs Siemens S7. </li></ol></blockquote><br><pre>  O arquivo DB100.bin, aparentemente, cont√©m um bloco de dados do DB100 PLC:
 00000000: 0100 0102 6e02 0401 0206 0100 0101 0102 .... n ...........
 00000010: 1002 0501 0202 2002 0501 0206 0100 0102 ...... .........
 00000020: 0102 7702 0401 0206 0100 0103 0102 0a02 ..w .............
 00000030: 0501 0202 1602 0501 0206 0100 0104 0102 ................
 00000040: 7502 0401 0206 0100 0105 0102 0a02 0501 u ...............
 00000050: 0202 1602 0501 0206 0100 0106 0102 3402 ........... 4
 00000060: 0401 0206 0100 0107 0102 2602 0501 0202 .......... &amp; .....
 00000070: 4c02 0501 0206 0100 0108 0102 3302 0401 L ........... 3 ...
 00000080: 0206 0100 0109 0102 0a02 0501 0202 1602 ................
 00000090: 0501 0206 0100 010a 0102 3702 0401 0206 .......... 7 .....
 000000a0: 0100 010b 0102 2202 0501 0202 4602 0501 ...... "..... F ...
 000000b0: 0206 0100 010c 0102 3302 0401 0206 0100 ........ 3 .......
 000000c0: 010d 0102 0a02 0501 0202 1602 0501 0206 ................
 000000d0: 0100 010e 0102 6d02 0401 0206 0100 010f ...... m .........
 000000e0: 0102 1102 0501 0202 2302 0501 0206 0100 ........ # .......
 000000f0: 0110 0102 3502 0401 0206 0100 0111 0102 .... 5 ...........
 00000100: 1202 0501 0202 2502 0501 0206 0100 0112 ......% .........
 00000110: 0102 3302 0401 0206 0100 0113 0102 2602 ..3 ........... &amp;.
 00000120: 0501 0202 4c02 0501 0206 0100 .... L ....... </pre><br>  A julgar pelo nome, o arquivo block_upload_traffic.pcapng cont√©m um despejo de tr√°fego de carregamento de bloco para o PLC. <br><br>  Vale ressaltar que esse despejo de tr√°fego no local da competi√ß√£o durante a confer√™ncia foi um pouco mais dif√≠cil de obter.  Para isso, foi necess√°rio entender o script do arquivo de projeto do TeslaSCADA2.  A partir dele, foi poss√≠vel entender onde o dump criptografado com o RC4 est√° localizado e qual chave deve ser usada para descriptograf√°-lo.  Despejos de blocos de dados no site podem ser obtidos usando o cliente do protocolo S7.  Eu usei o cliente de demonstra√ß√£o do pacote Snap7 para isso. <br><br><h2>  Extraindo unidades de processamento de sinal de um despejo de tr√°fego </h2><br>  Observando o conte√∫do do despejo, podemos entender que os blocos de processamento de sinal OB1, FC1, FC2 e FC3 s√£o transmitidos nele: <br><br><img src="https://habrastorage.org/webt/sz/43/yd/sz43ydme-e17zhg3yuudd1xxmva.png"><br><br>  √â necess√°rio extrair esses blocos.  Isso pode ser feito, por exemplo, com o seguinte script, depois de converter o tr√°fego do formato pcapng para pcap: <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python2 import struct from scapy.all import * packets = rdpcap('block_upload_traffic.pcap') s7_hdr_struct = '&gt;BBHHHHBB' s7_hdr_sz = struct.calcsize(s7_hdr_struct) tpkt_cotp_sz = 7 names = iter(['OB1.bin', 'FC1.bin', 'FC2.bin', 'FC3.bin']) buf = '' for packet in packets: if packet.getlayer(IP).src == '10.0.102.11': tpkt_cotp_s7 = str(packet.getlayer(TCP).payload) if len(tpkt_cotp_s7) &lt; tpkt_cotp_sz + s7_hdr_sz: continue s7 = tpkt_cotp_s7[tpkt_cotp_sz:] s7_hdr = s7[:s7_hdr_sz] param_sz = struct.unpack(s7_hdr_struct, s7_hdr)[4] s7_param = s7[12:12+param_sz] s7_data = s7[12+param_sz:] if s7_param in ('\x1e\x00', '\x1e\x01'): # upload buf += s7_data[4:] elif s7_param == '\x1f': with open(next(names), 'wb') as f: f.write(buf) buf = ''</span></span></code> </pre> <br>  Depois de estudar os blocos recebidos, voc√™ pode notar que eles sempre come√ßam com os bytes 70 70 (pp).  Agora voc√™ precisa aprender como analis√°-los.  Uma dica para a tarefa sugere que voc√™ precisa usar o PlcSim para isso. <br><br><h2>  Obtendo instru√ß√µes leg√≠veis por humanos a partir de blocos </h2><br>  Primeiro, vamos tentar programar o S7-PlcSim carregando nele v√°rios blocos com instru√ß√µes repetidas (= Q 0.0) usando o software Simatic Manager e salve o resultado no emulador de PLC no arquivo example.plc.  Observando o conte√∫do do arquivo, √© poss√≠vel determinar facilmente o in√≠cio dos blocos carregados pela assinatura 70 70, que descobrimos anteriormente.  Antes dos blocos, aparentemente, o tamanho do bloco √© escrito na forma de um valor little-endian de 4 bytes. <br><br><img src="https://habrastorage.org/webt/01/vp/ra/01vpra5veml-vbfozvhainxy-ig.png"><br><br>  Depois de recebermos informa√ß√µes sobre a estrutura dos arquivos plc, apareceu o seguinte plano de a√ß√£o para a leitura dos programas PLC S7: <br><br><ol><li>  Usando o Simatic Manager, criamos uma estrutura de blocos no S7-PlcSim semelhante √† que recebemos do dump.  Os tamanhos dos blocos devem corresponder (alcan√ßados preenchendo os blocos com o n√∫mero certo de instru√ß√µes) e seus identificadores (OB1, FC1, FC2, FC3). </li><li>  Salve o PLC em um arquivo. </li><li>  Substitu√≠mos o conte√∫do dos blocos no arquivo recebido pelos blocos do despejo de tr√°fego.  O in√≠cio dos blocos √© determinado pela assinatura. </li><li>  O arquivo resultante √© carregado no S7-PlcSim e examinamos o conte√∫do dos blocos no Simatic Manager. </li></ol><br>  Os blocos podem ser substitu√≠dos, por exemplo, pelo seguinte c√≥digo: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'original.plc'</span></span>, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: plc = f.read() blocks = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> fname <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">'OB1.bin'</span></span>, <span class="hljs-string"><span class="hljs-string">'FC1.bin'</span></span>, <span class="hljs-string"><span class="hljs-string">'FC2.bin'</span></span>, <span class="hljs-string"><span class="hljs-string">'FC3.bin'</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(fname, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: blocks.append(f.read()) i = plc.find(<span class="hljs-string"><span class="hljs-string">b'pp'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> block <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> blocks: plc = plc[:i] + block + plc[i+len(block):] i = plc.find(<span class="hljs-string"><span class="hljs-string">b'pp'</span></span>, i + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'target.plc'</span></span>, <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(plc)</code> </pre> <br><blockquote>  Aleksey foi possivelmente mais complicado, mas ainda assim.  Assumimos que os participantes usariam o NetToPlcSim para que o PlcSim pudesse se comunicar pela rede, carregasse blocos no PlcSim via Snap7 e depois baixasse esses blocos como um projeto do PlcSim usando o ambiente de desenvolvimento. </blockquote><br>  Ao abrir o arquivo resultante no S7-PlcSim, voc√™ pode ler os blocos substitu√≠dos usando o Simatic Manager.  As principais fun√ß√µes de gerenciamento de dispositivos s√£o registradas no bloco FC1.  A vari√°vel # TEMP0 atrai aten√ß√£o especial, quando est√° ligada, parece que o controle do PLC foi alternado para o modo manual com base nos valores da mem√≥ria de bits M2.2 e M2.3.  # TEMP0 √© definido por FC3. <br><br><img src="https://habrastorage.org/webt/02/tq/pt/02tqptegvjst2hzny9d8sc4rmva.png"><br><br>  Para resolver o problema, √© necess√°rio analisar a fun√ß√£o FC3 e entender o que precisa ser feito para que ela retorne uma unidade l√≥gica. <br><br>  Os blocos de processamento de sinal do PLC no estande de baixa seguran√ßa no local da competi√ß√£o foram organizados da mesma maneira, mas para definir o valor da vari√°vel # TEMP0, bastava escrever a linha do meu caminho ninja no bloco DB1.  A verifica√ß√£o do valor no bloco foi organizada de forma clara e n√£o exigia um conhecimento aprofundado da linguagem de programa√ß√£o do bloco.  Obviamente, no n√≠vel de alta seguran√ßa, ser√° muito mais dif√≠cil obter o controle manual e √© necess√°rio entender os meandros da linguagem STL (uma das maneiras de programar o S7 PLC). <br><br><h2>  Bloco reverso FC3 </h2><br><div class="spoiler">  <b class="spoiler_title">O conte√∫do do bloco FC3 na representa√ß√£o STL:</b> <div class="spoiler_text"><pre> <code class="python hljs"> LB<span class="hljs-comment"><span class="hljs-comment">#16#0 T #TEMP13 T #TEMP15 LP#DBX 0.0 T #TEMP4 CLR = #TEMP14 M015: L #TEMP4 LAR1 OPN DB 100 L DBLG TAR1 &lt;=D JC M016 L DW#16#0 T #TEMP0 L #TEMP6 LW#16#0 &lt;&gt;I JC M00d LP#DBX 0.0 LAR1 M00d: LB [AR1,P#0.0] T #TEMP5 LW#16#1 ==I JC M007 L #TEMP5 LW#16#2 ==I JC M008 L #TEMP5 LW#16#3 ==I JC M00f L #TEMP5 LW#16#4 ==I JC M00e L #TEMP5 LW#16#5 ==I JC M011 L #TEMP5 LW#16#6 ==I JC M012 JU M010 M007: +AR1 P#1.0 LP#DBX 0.0 LAR2 LB [AR1,P#0.0] LC#8 *I +AR2 +AR1 P#1.0 LB [AR1,P#0.0] JL M003 JU M001 JU M002 JU M004 M003: JU M005 M001: OPN DB 101 LB [AR2,P#0.0] T #TEMP0 JU M006 M002: OPN DB 101 LB [AR2,P#0.0] T #TEMP1 JU M006 M004: OPN DB 101 LB [AR2,P#0.0] T #TEMP2 JU M006 M00f: +AR1 P#1.0 LB [AR1,P#0.0] LC#8 *IT #TEMP11 +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP7 LP#M 100.0 LAR2 L #TEMP7 LC#8 *I +AR2 TAR2 #TEMP9 TAR1 #TEMP4 OPN DB 101 LP#DBX 0.0 LAR1 L #TEMP11 +AR1 LAR2 #TEMP9 LB [AR2,P#0.0] TB [AR1,P#0.0] L #TEMP4 LAR1 JU M006 M008: +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP3 +AR1 P#1.0 LB [AR1,P#0.0] JL M009 JU M00b JU M00a JU M00c M009: JU M005 M00b: L #TEMP3 T #TEMP0 JU M006 M00a: L #TEMP3 T #TEMP1 JU M006 M00c: L #TEMP3 T #TEMP2 JU M006 M00e: +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP7 LP#M 100.0 LAR2 L #TEMP7 LC#8 *I +AR2 TAR2 #TEMP9 +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP8 LP#M 100.0 LAR2 L #TEMP8 LC#8 *I +AR2 TAR2 #TEMP10 TAR1 #TEMP4 LAR1 #TEMP9 LAR2 #TEMP10 LB [AR1,P#0.0] LB [AR2,P#0.0] AW INVI T #TEMP12 LB [AR1,P#0.0] LB [AR2,P#0.0] OW L #TEMP12 AW TB [AR1,P#0.0] L DW#16#0 T #TEMP0 L MB 101 T #TEMP1 L MB 102 T #TEMP2 L #TEMP4 LAR1 JU M006 M011: +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP7 LP#M 100.0 LAR2 L #TEMP7 LC#8 *I +AR2 TAR2 #TEMP9 +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP8 LP#M 100.0 LAR2 L #TEMP8 LC#8 *I +AR2 TAR2 #TEMP10 TAR1 #TEMP4 LAR1 #TEMP9 LAR2 #TEMP10 LB [AR1,P#0.0] LB [AR2,P#0.0] -ITB [AR1,P#0.0] L DW#16#0 T #TEMP0 L MB 101 T #TEMP1 L MB 102 T #TEMP2 L #TEMP4 LAR1 JU M006 M012: L #TEMP15 INC 1 T #TEMP15 +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP7 LP#M 100.0 LAR2 L #TEMP7 LC#8 *I +AR2 TAR2 #TEMP9 +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP8 LP#M 100.0 LAR2 L #TEMP8 LC#8 *I +AR2 TAR2 #TEMP10 TAR1 #TEMP4 LAR1 #TEMP9 LAR2 #TEMP10 LB [AR1,P#0.0] LB [AR2,P#0.0] ==I JCN M013 JU M014 M013: LP#DBX 0.0 LAR1 T #TEMP4 LB#16#0 T #TEMP6 JU M006 M014: L #TEMP4 LAR1 L #TEMP13 LL#1 +IT #TEMP13 JU M006 M006: L #TEMP0 T MB 100 L #TEMP1 T MB 101 L #TEMP2 T MB 102 +AR1 P#1.0 L #TEMP6 + 1 T #TEMP6 JU M005 M010: LP#DBX 0.0 LAR1 L 0 T #TEMP6 TAR1 #TEMP4 M005: TAR1 #TEMP4 CLR = #TEMP16 L #TEMP13 LL#20 ==IS #TEMP16 L #TEMP15 ==IA #TEMP16 JC M017 L #TEMP13 LL#20 &lt;IS #TEMP16 L #TEMP15 ==IA #TEMP16 JC M018 JU M019 M017: SET = #TEMP14 JU M016 M018: CLR = #TEMP14 JU M016 M019: CLR O #TEMP14 = #RET_VAL JU M015 M016: CLR O #TEMP14 = #RET_VAL</span></span></code> </pre> </div></div><br>  O c√≥digo √© bastante volumoso e, para uma pessoa n√£o familiarizada com STL, pode parecer complicado.  N√£o faz sentido desmontar cada instru√ß√£o na estrutura deste artigo; para obter instru√ß√µes detalhadas e recursos da linguagem STL, consulte o manual correspondente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">STL (Lista de</a> instru√ß√µes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">) para a programa√ß√£o S7-300 e S7-400</a> .  Aqui darei o mesmo c√≥digo ap√≥s o processamento - renomeando r√≥tulos e vari√°veis ‚Äã‚Äãe adicionando coment√°rios descrevendo o algoritmo de trabalho e algumas constru√ß√µes da linguagem STL.  Percebo imediatamente que no bloco em considera√ß√£o √© implementada uma m√°quina virtual que executa algum bytecode localizado no bloco DB100, cujo conte√∫do conhecemos.  As instru√ß√µes da m√°quina virtual s√£o 1 byte de c√≥digo operacional e bytes de argumentos, um byte para cada argumento.  Todas as instru√ß√µes revisadas t√™m dois argumentos, designei seus valores nos coment√°rios como X e Y. <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de p√≥s-processamento</b> <div class="spoiler_text">  ] <br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#    LB#16#0 T #CHECK_N #     T #COUNTER_N #     LP#DBX 0.0 T #POINTER #     CLR = #PRE_RET_VAL #     - LOOP: L #POINTER LAR1 OPN DB 100 L DBLG TAR1 &lt;=D #       JC FINISH L DW#16#0 T #REG0 L #TEMP6 LW#16#0 &lt;&gt;I JC M00d LP#DBX 0.0 LAR1 #  switch - case     M00d: LB [AR1,P#0.0] T #OPCODE LW#16#1 ==I JC OPCODE_1 L #OPCODE LW#16#2 ==I JC OPCODE_2 L #OPCODE LW#16#3 ==I JC OPCODE_3 L #OPCODE LW#16#4 ==I JC OPCODE_4 L #OPCODE LW#16#5 ==I JC OPCODE_5 L #OPCODE LW#16#6 ==I JC OPCODE_6 JU OPCODE_OTHER #   01:    DB101[X]   Y # OP01(X, Y): REG[Y] = DB101[X] OPCODE_1: +AR1 P#1.0 LP#DBX 0.0 LAR2 LB [AR1,P#0.0] #   X (  DB101) LC#8 *I +AR2 +AR1 P#1.0 LB [AR1,P#0.0] #   Y ( ) JL M003 #  switch - case    Y JU M001 #      . JU M002 #       JU M004 #      M003: JU LOOPEND M001: OPN DB 101 LB [AR2,P#0.0] T #REG0 #   DB101[X]  REG[0] JU PRE_LOOPEND M002: OPN DB 101 LB [AR2,P#0.0] T #REG1 #   DB101[X]  REG[1] JU PRE_LOOPEND M004: OPN DB 101 LB [AR2,P#0.0] T #REG2 #   DB101[X]  REG[2] JU PRE_LOOPEND #   02:   X   Y # OP02(X, Y): REG[Y] = X OPCODE_2: +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP3 +AR1 P#1.0 LB [AR1,P#0.0] JL M009 JU M00b JU M00a JU M00c M009: JU LOOPEND M00b: L #TEMP3 T #REG0 JU PRE_LOOPEND M00a: L #TEMP3 T #REG1 JU PRE_LOOPEND M00c: L #TEMP3 T #REG2 JU PRE_LOOPEND #  03    ,    ... #   04:   X  Y # OP04(X, Y): REG[0] = 0; REG[X] = (REG[X] == REG[Y]) OPCODE_4: +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP7 #   - X LP#M 100.0 LAR2 L #TEMP7 LC#8 *I +AR2 TAR2 #TEMP9 # REG[X] +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP8 LP#M 100.0 LAR2 L #TEMP8 LC#8 *I +AR2 TAR2 #TEMP10 # REG[Y] TAR1 #POINTER LAR1 #TEMP9 # REG[X] LAR2 #TEMP10 # REG[Y] LB [AR1,P#0.0] LB [AR2,P#0.0] AW INVI T #TEMP12 # ~(REG[Y] &amp; REG[X]) LB [AR1,P#0.0] LB [AR2,P#0.0] OW L #TEMP12 AW # (~(REG[Y] &amp; REG[X])) &amp; (REG[Y] | REG[X]) -     TB [AR1,P#0.0] L DW#16#0 T #REG0 L MB 101 T #REG1 L MB 102 T #REG2 L #POINTER LAR1 JU PRE_LOOPEND #   05:   Y  X # OP05(X, Y): REG[0] = 0; REG[X] = REG[X] - REG[Y] OPCODE_5: +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP7 LP#M 100.0 LAR2 L #TEMP7 LC#8 *I +AR2 TAR2 #TEMP9 # REG[X] +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP8 LP#M 100.0 LAR2 L #TEMP8 LC#8 *I +AR2 TAR2 #TEMP10 # REG[Y] TAR1 #POINTER LAR1 #TEMP9 LAR2 #TEMP10 LB [AR1,P#0.0] LB [AR2,P#0.0] -I # ACCU1 = ACCU2 - ACCU1, REG[X] - REG[Y] TB [AR1,P#0.0] L DW#16#0 T #REG0 L MB 101 T #REG1 L MB 102 T #REG2 L #POINTER LAR1 JU PRE_LOOPEND #   06:  #CHECK_N    X  Y # OP06(X, Y): #CHECK_N += (1 if REG[X] == REG[Y] else 0) OPCODE_6: L #COUNTER_N INC 1 T #COUNTER_N +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP7 # REG[X] LP#M 100.0 LAR2 L #TEMP7 LC#8 *I +AR2 TAR2 #TEMP9 # REG[X] +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP8 LP#M 100.0 LAR2 L #TEMP8 LC#8 *I +AR2 TAR2 #TEMP10 # REG[Y] TAR1 #POINTER LAR1 #TEMP9 # REG[Y] LAR2 #TEMP10 # REG[X] LB [AR1,P#0.0] LB [AR2,P#0.0] ==I JCN M013 JU M014 M013: LP#DBX 0.0 LAR1 T #POINTER LB#16#0 T #TEMP6 JU PRE_LOOPEND M014: L #POINTER LAR1 #   #CHECK_N L #CHECK_N LL#1 +IT #CHECK_N JU PRE_LOOPEND PRE_LOOPEND: L #REG0 T MB 100 L #REG1 T MB 101 L #REG2 T MB 102 +AR1 P#1.0 L #TEMP6 + 1 T #TEMP6 JU LOOPEND OPCODE_OTHER: LP#DBX 0.0 LAR1 L 0 T #TEMP6 TAR1 #POINTER LOOPEND: TAR1 #POINTER CLR = #TEMP16 L #CHECK_N LL#20 ==IS #TEMP16 L #COUNTER_N ==IA #TEMP16 #   ,  #CHECK_N == #COUNTER_N == 20 JC GOOD L #CHECK_N LL#20 &lt;IS #TEMP16 L #COUNTER_N ==IA #TEMP16 JC FAIL JU M019 GOOD: SET = #PRE_RET_VAL JU FINISH FAIL: CLR = #PRE_RET_VAL JU FINISH M019: CLR O #PRE_RET_VAL = #RET_VAL JU LOOP FINISH: CLR O #PRE_RET_VAL = #RET_VAL</span></span></code> </pre> </div></div><br>  Tendo uma id√©ia das instru√ß√µes da m√°quina virtual, escreveremos um pequeno desmontador para analisar o bytecode no bloco DB100: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> string alph = string.ascii_letters + string.digits <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'DB100.bin'</span></span>, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: m = f.read() pc = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> pc &lt; len(m): op = m[pc] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> op == <span class="hljs-number"><span class="hljs-number">1</span></span>: print(<span class="hljs-string"><span class="hljs-string">'R{} = DB101[{}]'</span></span>.format(m[pc + <span class="hljs-number"><span class="hljs-number">2</span></span>], m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>])) pc += <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> op == <span class="hljs-number"><span class="hljs-number">2</span></span>: c = chr(m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>]) c = c <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> alph <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'?'</span></span> print(<span class="hljs-string"><span class="hljs-string">'R{} = {:02x} ({})'</span></span>.format(m[pc + <span class="hljs-number"><span class="hljs-number">2</span></span>], m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>], c)) pc += <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> op == <span class="hljs-number"><span class="hljs-number">4</span></span>: print(<span class="hljs-string"><span class="hljs-string">'R0 = 0; R{} = (R{} == R{})'</span></span>.format( m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>], m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>], m[pc + <span class="hljs-number"><span class="hljs-number">2</span></span>])) pc += <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> op == <span class="hljs-number"><span class="hljs-number">5</span></span>: print(<span class="hljs-string"><span class="hljs-string">'R0 = 0; R{} = R{} - R{}'</span></span>.format( m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>], m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>], m[pc + <span class="hljs-number"><span class="hljs-number">2</span></span>])) pc += <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> op == <span class="hljs-number"><span class="hljs-number">6</span></span>: print(<span class="hljs-string"><span class="hljs-string">'CHECK (R{} == R{})\n'</span></span>.format( m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>], m[pc + <span class="hljs-number"><span class="hljs-number">2</span></span>])) pc += <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: print(<span class="hljs-string"><span class="hljs-string">'unk opcode {}'</span></span>.format(op)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre> <br>  Como resultado, obtemos o seguinte c√≥digo de m√°quina virtual: <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo da m√°quina virtual</b> <div class="spoiler_text"><pre> <code class="python hljs">R1 = DB101[<span class="hljs-number"><span class="hljs-number">0</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">6</span></span>e (n) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">1</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">10</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">20</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">2</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">77</span></span> (w) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">3</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">0</span></span>a (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">16</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">4</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">75</span></span> (u) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">5</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">0</span></span>a (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">16</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">6</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">34</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">7</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">26</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">4</span></span>c (L) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">8</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">33</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">9</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">0</span></span>a (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">16</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">10</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">37</span></span> (<span class="hljs-number"><span class="hljs-number">7</span></span>) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">11</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">22</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">46</span></span> (F) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">12</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">33</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">13</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">0</span></span>a (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">16</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">14</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">6</span></span>d (m) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">15</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">11</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">23</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">16</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">35</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">17</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">12</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">25</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">18</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">33</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">19</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">26</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">4</span></span>c (L) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0)</code> </pre> </div></div><br>  Como voc√™ pode ver, este programa simplesmente verifica cada s√≠mbolo do DB101 quanto √† igualdade em rela√ß√£o a um determinado valor.  A linha final para passar todas as verifica√ß√µes: n0w u 4r3 7h3 m4573r.  Se esta linha for colocada no bloco DB101, o controle manual do PLC ser√° ativado e ser√° poss√≠vel explodir ou desinflar o bal√£o. <br><br>  Isso √© tudo!  Alexey demonstrou um alto n√≠vel de conhecimento digno de um ninja industrial :) Enviamos pr√™mios memor√°veis ‚Äã‚Äãao vencedor.  Muito obrigado a todos os participantes! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt460615/">https://habr.com/ru/post/pt460615/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt460599/index.html">Not√≠cias do mundo do OpenStreetMap no 468 (02/07/2019 - 08.07.2019)</a></li>
<li><a href="../pt460603/index.html">V2G. Carros el√©tricos ajudar√£o a equilibrar a produ√ß√£o e o consumo de eletricidade</a></li>
<li><a href="../pt460605/index.html">Est√∫dio Fotogr√°fico Autom√°tico, Parte 1</a></li>
<li><a href="../pt460607/index.html">Loja de aplicativos de seguran√ßa ofensiva com ferramentas de hackers do Android</a></li>
<li><a href="../pt460611/index.html">Failover: o perfeccionismo nos destr√≥i e ... pregui√ßa</a></li>
<li><a href="../pt460617/index.html">Toda a verdade sobre o RTOS. Artigo 30. Procedimentos de inicializa√ß√£o e inicializa√ß√£o do N√∫cleo SE</a></li>
<li><a href="../pt460621/index.html">Tic Tac Toe Parte 4: Interagindo com o back-end do frasco usando HTTP</a></li>
<li><a href="../pt460623/index.html">Sobre a tortura de Julian Assange</a></li>
<li><a href="../pt460625/index.html">Como n√£o consegui o primeiro lugar na competi√ß√£o para desenvolvedores de JavaScript do Telegram</a></li>
<li><a href="../pt460627/index.html">vGPU - o uso n√£o pode ser ignorado</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>