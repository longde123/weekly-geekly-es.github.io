<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üó£Ô∏è üöª üßÄ So konfigurieren Sie die Installation der Umgebungsvariablen von Nuxt.j zur Laufzeit oder wie Sie alles tun, was nicht jedem gef√§llt, und es nicht bereuen üå°Ô∏è üë©üèª‚Äçüé§ üë©üèæ‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="( Abbildung ) 

 Die leitenden Webentwickler Anton und Alexei setzen die Geschichte des schwierigen Kampfes mit Nuxt fort. In der vorherigen Runde des...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So konfigurieren Sie die Installation der Umgebungsvariablen von Nuxt.j zur Laufzeit oder wie Sie alles tun, was nicht jedem gef√§llt, und es nicht bereuen</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/umbrellaitcom/blog/429756/"><img src="https://habrastorage.org/webt/8q/ab/wl/8qabwlstgtbibz-j7p0ltkhkiv0.png"><br>  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><i>Abbildung</i></a> ) <br><br>  <i>Die leitenden Webentwickler Anton und Alexei setzen die Geschichte des schwierigen Kampfes mit Nuxt fort.</i>  <i>In der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vorherigen Runde des Kampfes</a> mit diesem Framework haben sie gezeigt, wie man ein Projekt auf Nuxt startet, damit alle gl√ºcklich sind.</i>  <i>In einem neuen Artikel werden wir √ºber die tats√§chliche Anwendung des Frameworks sprechen.</i> <br><br>  Wir haben begonnen, das Projekt mit einer enormen technischen Verschuldung umzuschreiben.  Das monatliche Publikum betrug 6-7 Millionen Besucher, aber die vorhandene Plattform verursachte zu viele Probleme.  Daher wurde beschlossen, sie in den Ruhestand zu schicken.  Nat√ºrlich war die Leistung unser gr√∂√ütes Anliegen, aber ich wollte auch keine SEO verschwenden. <br><br>  Nach einigen Diskussionsrunden entschieden sie sich, sich nicht nur beim serverseitigen Rendern auf den traditionellen Ansatz zu verlassen, sondern sich nicht beim clientseitigen Rendern zu engagieren.  Als Ergebnis haben wir begonnen, eine L√∂sung zu entwickeln, die auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nuxt.js</a> basiert. <br><a name="habracut"></a><br><h2>  Gute alte Nuxt.js </h2><br>  Wir verwenden das "Framework f√ºr Framework" basierend auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Vue.js,</a> das uns bereits <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">im letzten Artikel bekannt war,</a> um universelle Client-Server-Anwendungen zu erstellen.  In unserem Fall arbeitet die Anwendung in Verbindung mit einer ziemlich komplizierten API (den Feinheiten von Microservices, aber zu einem anderen Zeitpunkt) und mehreren Ebenen des Caching. Sie rendert Inhalte, die von Editoren bearbeitet werden k√∂nnen, und gibt bereits statische Inhalte f√ºr blitzschnelle Leistung zur√ºck.  Gro√üartig, richtig? <br><br>  Tats√§chlich gibt es hier nichts Neues.  Was Nuxt.js jedoch interessant macht, ist die M√∂glichkeit, ein Projekt mit Client-Server-Rendering schnell zu starten.  Manchmal m√ºssen Sie gegen das etablierte Framework des Frameworks versto√üen.  Das haben wir getan. <br><br><h2>  Keine Zeit zu erkl√§ren, einmal zu bauen, viele einzusetzen! </h2><br>  Eines Tages kam ein Techlide auf uns zu und war verwirrt: Wenn wir √Ñnderungen am Repository vornehmen, m√ºssen wir jede Umgebung (Entwicklungs-, B√ºhnen- und Produktumgebung) separat erstellen.  Es war langsam.  Aber was ist der Unterschied zwischen diesen Builds?  Ja, nur in Umgebungsvariablen!  Und was er verlangte, klang logisch und vern√ºnftig.  Aber unsere erste Reaktion war: O_o <br><br>  Das einmalige Erstellen vieler Strategien ist in der Welt der Softwareentwicklung sinnvoll.  Aber in der Javascript-Welt ... Wir haben eine ganze Reihe von Compilern, Transpilern, Vor- und Nachprozessoren sowie Tests und Lintern.  All dies braucht Zeit, um sie f√ºr jede der Umgebungen zu konfigurieren.  Dar√ºber hinaus gibt es viele potenzielle Probleme mit dem Verlust vertraulicher Daten (Geheimnisse, API-Schl√ºssel usw., die in Konfigurationen gespeichert werden k√∂nnen). <br><br><h2>  Und wir fingen an </h2><br>  Nat√ºrlich haben wir mit einer Suche bei Google begonnen.  Dann haben wir mit den Betreuern von Nuxt.j gesprochen, aber ohne gro√üen Erfolg.  Was zu tun ist - ich musste selbst eine L√∂sung finden und diese nicht aus StackOverflow kopieren (dies ist die Grundlage unserer Aktivit√§ten, oder?). <br><br><h3>  Lassen Sie uns herausfinden, wie Nuxt.js das macht. </h3><br>  Nuxt.js hat eine Konfigurationsdatei mit dem erwarteten Namen nuxt.config.js.  Es wird verwendet, um Konfigurationen programmgesteuert an die Anwendung zu √ºbertragen: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'nuxt.config.js'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> nuxt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Nuxt(config)</code> </pre> <br>  Es ist m√∂glich, die Umgebung √ºber env-Variablen festzulegen.  Im Allgemeinen ist es √ºblich, die Konfigurationsdatei dynamisch zu verbinden.  All dies wird dann in das definePlugin-Webpack √ºbertragen und kann auf Client und Server verwendet werden. <br><br>  process.env.propertyName <br>  // oder <br>  context.env.propertyName. <br><br>  Diese Variablen werden w√§hrend der Montage gebacken. Weitere Informationen finden Sie hier: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nuxt.js env-Seite</a> . <br>  Haben Sie das Webpack bemerkt?  Ja, das bedeutet Zusammenstellung, und das wollen wir nicht. <br><br><h3>  Versuchen wir es anders </h3><br>  Zu verstehen, wie Nuxt.js funktioniert, bedeutet f√ºr uns: <br><br><ul><li>  In nuxt.config.js k√∂nnen wir env nicht mehr verwenden. </li><li>  Alle anderen dynamischen Variablen (z. B. innerhalb von head.meta) sollten zur Laufzeit an das Objekt nuxt.config.js √ºbergeben werden. </li></ul><br><br>  Code in server / index.js: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../nuxt.config.js'</span></span>)</code> </pre><br>  Wechseln zu: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    Nuxt.js const config = require('./utils/extendedNuxtConfig.js').default</span></span></code> </pre><br>  Wo utils / extendedNuxtConfig.js: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'config'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash/get'</span></span> <span class="hljs-comment"><span class="hljs-comment">//   Nuxt.js const defaultConfig = require('../../nuxt.config.js') //   const extendedConfig = {} //   Nuxt.js const nuxtConfig = { ...defaultConfig, ...extendedConfig } //     //       if (get(nuxtConfig, 'head.meta')) { nuxtConfig.head.meta.push({ hid: 'og:url', property: 'og:url', content: config.get('app.canonical_domain') }) } export default nuxtConfig</span></span></code> </pre><br><h3>  Wir haben den Elefanten nicht einmal bemerkt </h3><br>  Nun, wir haben das Problem gel√∂st, dynamische Variablen von au√üerhalb der env-Eigenschaft des Konfigurationsobjekts in nuxt.config.js zu erhalten.  Das urspr√ºngliche Problem ist jedoch immer noch nicht gel√∂st. <br><br>  Es wurde angenommen, dass einige abstrakte sharedEnv.js verwendet werden f√ºr: <br><br><ul><li>  client - Erstellen Sie eine env.js-Datei, die global heruntergeladen wird (window.env.envKey). </li><li>  Server - wird bei Bedarf in Module importiert, </li><li>  isomorpher Code, so etwas wie <br>  context.isClient?  window.env [Schl√ºssel]: global.sharedEnv [Schl√ºssel]. </li></ul><br>  Irgendwie nicht so toll.  Diese Abstraktion w√ºrde das schwerwiegendste Problem l√∂sen - das Durchsickern vertraulicher Daten in die Clientanwendung, da es notwendig w√§re, den Wert bewusst zu erh√∂hen. <br><br><h2>  Vuex wird uns helfen </h2><br>  Bei der Untersuchung des Problems haben wir festgestellt, dass der Vuex-Speicher in ein Fensterobjekt exportiert wird.  Diese L√∂sung muss den Isomorphismus von Nuxt, js, unterst√ºtzen.  Vuex ist ein von Flux inspiriertes Data Warehouse, das speziell f√ºr Vue.js-Anwendungen entwickelt wurde. <br><br>  Warum nicht f√ºr unsere gemeinsamen Variablen verwenden?  Dies ist ein organischerer Ansatz - Daten in einem globalen Repository passen zu uns. <br><br>  Beginnen wir mit server / utils / sharedEnv.js: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'config'</span></span> <span class="hljs-comment"><span class="hljs-comment">/** *  ,      *  ,     *  ,       * * @type {Object} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> sharedEnv = { <span class="hljs-comment"><span class="hljs-comment">// ... canonicalDomain: config.get('app.canonical_domain'), } export default sharedEnv</span></span></code> </pre><br>  Der obige Code wird beim Serverstart ausgef√ºhrt.  F√ºgen Sie es dann dem Vuex-Repository hinzu: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** *   . *        * .   * https://nuxtjs.org/guide/vuex-store/#the-nuxtserverinit-action * * @return {Object} Shared environment variables. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getSharedEnv = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> process.server ? <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'~/server/utils/sharedEnv'</span></span>).default || {} : {} <span class="hljs-comment"><span class="hljs-comment">// ... export const state = () =&gt; ({ // ... sharedEnv: {} }) export const mutations = { // ... setSharedEnv (state, content) { state.sharedEnv = content } } export const actions = { nuxtServerInit ({ commit }) { if (process.server) { commit('setSharedEnv', getSharedEnv()) } } }</span></span></code> </pre><br>  Wir werden uns darauf verlassen, dass nuxtServerInit w√§hrend der Serverinitialisierung gestartet wird.  Es gibt einige Schwierigkeiten: Achten Sie auf die Methode getSharedEnv. Hier wird die √úberpr√ºfung auf wiederholte Ausf√ºhrung auf dem Server hinzugef√ºgt. <br><br><h3>  Was ist passiert? </h3><br>  Jetzt haben wir gemeinsame Variablen, die in Komponenten wie diesen extrahiert werden k√∂nnen: <br>  this. $ store.state.sharedEnv.canonicalDomain <br><br>  <b>Sieg!</b> <br><br><h3>  Oh nein.  Was ist mit Plugins? </h3><br>  Einige Plugins erfordern Umgebungsvariablen zum Konfigurieren.  Und wenn wir sie nutzen wollen: <br>  Vue.use (MyPlugin, {someEnvOption: 'Es gibt keinen Zugriff auf den vuex-Speicher'}) <br><br>  Vue.js versucht, sich selbst zu initialisieren, bevor Nuxt.js sharedEnvobject im Vuex-Repository registriert. <br><br>  Obwohl die Funktion zum Registrieren von Plugins den Zugriff auf das Context-Objekt erm√∂glicht, das den Repository-Link enth√§lt, ist sharedEnv noch leer.  Dies ist ganz einfach zu l√∂sen - machen wir das Plugin zu einer asynchronen Funktion und warten, bis nuxtServerInit ausgef√ºhrt wird: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Vue <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'vue'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MyPlugin <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'my-plugin'</span></span> <span class="hljs-comment"><span class="hljs-comment">/** *   MyPlugin . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (context) =&gt; { <span class="hljs-comment"><span class="hljs-comment">//  ,      sharedEnv await context.store.dispatch('nuxtServerInit', context) const env = { ...context.store.state.sharedEnv } Vue.use(MyPlugin, { option: env.someKey }) }</span></span></code> </pre><br>  <b>Jetzt ist der Sieg.</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de429756/">https://habr.com/ru/post/de429756/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de429736/index.html">Hogweed von Sosnowski. In MO wurden Bu√ügelder f√ºr den Vertrieb eingef√ºhrt</a></li>
<li><a href="../de429738/index.html">Optimale Shard-Anordnung im Elasticsearch-Petabyte-Cluster: Lineare Programmierung</a></li>
<li><a href="../de429744/index.html">Lerne OpenGL. Lektion 6.4 - IBL. Spiegelexposition</a></li>
<li><a href="../de429750/index.html">Entwicklerkochbuch: DDD-Rezepte (Teil 3, Anwendungsarchitektur)</a></li>
<li><a href="../de429754/index.html">Schwerwiegende Hardware-Integrationsfehler</a></li>
<li><a href="../de429758/index.html">Warum SRE-Dokumentation wichtig ist. Teil 1</a></li>
<li><a href="../de429762/index.html">MiniDV Camcorder Streamer</a></li>
<li><a href="../de429764/index.html">Spiel "Life" auf FPGA Altera Cyclone IV</a></li>
<li><a href="../de429766/index.html">.NET-Guru Dino Esposito: "Sei kein Passagier in einem Zug, der bergab f√§hrt"</a></li>
<li><a href="../de429768/index.html">"DNS √ºber HTTPS" wird in RFC 8484 ausgegeben - aber nicht jeder ist damit zufrieden</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>