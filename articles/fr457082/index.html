<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüéì ‚è™ üß° Octroi imperceptible de droits d'administrateur üßúüèΩ üëΩ üïπÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vendredi, mes amis. Aujourd'hui, nous partageons avec vous un autre mat√©riel traduit √† la veille du lancement du cours de r√©tro-ing√©nierie . 



 J'ai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Octroi imperceptible de droits d'administrateur</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/457082/">  Vendredi, mes amis.  Aujourd'hui, nous partageons avec vous un autre mat√©riel traduit √† la veille du lancement du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cours de r√©tro-ing√©nierie</a> . <br><br><img src="https://habrastorage.org/webt/cv/me/5s/cvme5snsza_im0wjpdevttzzcz4.png"><br><br>  J'ai eu une bonne id√©e de comment amener un utilisateur √† ex√©cuter votre application sans ing√©nierie sociale ou √† l'aide d'exploits tiers.  De plus, vous pouvez simplement aller de l'avant et lancer une infection de masse des fichiers ex√©cutables, mais cela peut provoquer de nombreux probl√®mes impr√©vus et signifiera √©galement que les applications sign√©es num√©riquement des fournisseurs de confiance appara√Ætront comme des fichiers non approuv√©s.  C'est une bonne id√©e de ¬´capturer¬ª une seule DLL.  Je n'appellerai pas cette m√©thode contourner UAC (Contr√¥le de compte d'utilisateur), car vous devez toujours obtenir la permission d'ex√©cuter l'application (pas la v√¥tre). <br><a name="habracut"></a><br><h2>  Biblioth√®que de chargement </h2><br>  Vous connaissez peut-√™tre d√©j√† ce concept, mais je vais tout de m√™me vous expliquer de quoi il s'agit.  Lorsque l'application appelle LoadLibrary dans la DLL, mais ne fournit pas le chemin d'acc√®s complet au fichier, le syst√®me v√©rifie d'abord la cl√© de registre KnownDlls, dans laquelle il recherche le chemin d'acc√®s, s'il n'y est pas, le syst√®me cherchera dans le r√©pertoire √† partir duquel l'application a √©t√© ex√©cut√©e, puis il recherchera dans les chemins syst√®me tels que system32 / syswow64. <br><br>  Vous pouvez bien placer votre DLL dans le m√™me r√©pertoire que l'application et lui donner le m√™me nom qu'une DLL syst√®me normalement charg√©e, mais dans tous les cas, votre DLL doit r√©pondre aux exigences suivantes: <br><br><ul><li>  L'application doit t√©l√©charger la dll par son nom et non par le chemin complet (comme c'est souvent le cas); </li><li>  La biblioth√®que requise ne doit pas exister dans HKLM \ SYSTEM \ CurrentControlSet \ Control \ Session Manager \ KnownDLLs; </li><li>  Votre DLL doit correspondre √† l'architecture du processeur (rappelez-vous que les processeurs 64 bits ignoreront simplement les biblioth√®ques 32 bits et vice versa); </li><li>  La biblioth√®que est situ√©e dans System32 ou Syswow64, car des chemins sp√©cifiques ne fonctionnent souvent pas. </li></ul><br>  Le virus ZeroAccess a utilis√© cette m√©thode pour tirer parti de ¬´l'ing√©nierie sociale¬ª et forcer l'utilisateur √† ex√©cuter le fichier.  Pour commencer, le programme d'installation d'Adobe Flash a √©t√© t√©l√©charg√© √† partir de celui officiel, la DLL du bot a √©t√© enregistr√©e dans le m√™me r√©pertoire que le programme d'installation, puis le programme d'installation a √©t√© lanc√©.  Lorsque le programme d'installation est ex√©cut√©, le contr√¥le de compte d'utilisateur affiche un message indiquant que l'application est fournie par une source fiable de ¬´Adobe Systems Incorporated¬ª, et l'utilisateur est le plus susceptible d'installer cette application (cela conduit √† l'ex√©cution d'une DLL de bot malveillante). <br><br><img src="https://habrastorage.org/webt/nv/9y/me/nv9ymec9x5znwvun7_kiiihga6a.png"><br>  <i>S'agit-il d'une v√©ritable mise √† jour de Flash Player?</i>  <i>Ou ZeroAccess?</i>  <i>Personne ne le sait.</i> <br><br><h2>  M√©thode moins invasive </h2><br>  Imaginez qu'il existe un dossier dans lequel se trouvent 90% des applications n√©cessitant des droits de compte √©lev√©s et qu'il est accessible en √©criture sans ce type de droits.  Eh bien, un tel dossier existe et c'est le <code>%userprofile%Downloads</code> .  Vous comprenez probablement o√π je veux en venir. <br><br>  Je ne m'attendais pas √† trouver une DLL qui charge la plupart des applications et remplit en m√™me temps tous les crit√®res d'une DLL malveillante, et apr√®s environ cinq minutes de recherche, j'ai trouv√© une mine d'or: <code>dwmapi.dll</code> .  Cette biblioth√®que remplissait non seulement tous les crit√®res, mais t√©l√©chargeait √©galement tous les fichiers d'installation.  Maintenant, cr√©ons notre propre DLL, nommez-la <code>‚Äúdwmapi.dll‚Äù</code> , placez-la dans le dossier T√©l√©chargements et ex√©cutez le fichier d'installation. <br><br><img src="https://habrastorage.org/webt/8w/qr/2u/8wqr2u8hmdbdwm4nkuzb81leen4.png"><br><br>  Succ√®s!  Mais le fait est que d√®s que nous d√©marrons l'installation, cela ne fonctionnera pas, car nous avons remplac√© une biblioth√®que importante, mais c'est facile √† corriger.  Nous infectons la DLL. <br><br><h2>  Cr√©ation d'une DLL d'infect </h2><br>  Au d√©but, je voulais simplement ajouter un nouvel en-t√™te de section, modifier le champ NumberOfSections dans l'en-t√™te PE, puis ajouter ma section √† la fin du fichier PE.  Il s'est av√©r√© qu'imm√©diatement apr√®s le dernier en-t√™te de section, il existe un r√©pertoire d'importation associ√© qui sera √©cras√© par notre en-t√™te de section.  Par cons√©quent, apr√®s environ 2 heures d'√©criture d'une application pour restaurer tout PE √† partir de z√©ro, quelqu'un m'a rappel√© que le r√©pertoire d'importation li√© n'existe que pour acc√©l√©rer le t√©l√©chargement des fichiers import√©s et peut √™tre √©cras√©, puis simplement d√©sactiv√© dans l'en-t√™te PE. <br><br>  Pendant les 15 minutes suivantes, j'ai tenu CTRL + Z pour revenir √† mon point de d√©part et me suis senti stupide.  Apr√®s deux lignes de code, mon infecteur a fonctionn√© comme il se doit et j'ai pu passer √† l'√©tape suivante.  D√©sormais, l'infecteur d√©connecte et r√©√©crit simplement le r√©pertoire d'importation associ√© avec un nouvel en-t√™te de section, ajoute une nouvelle section √† la fin du fichier PE, ajuste SizeOfImage pour accueillir la nouvelle section, puis modifie AddressOfEntryPoint pour pointer vers notre nouvelle section. <br><br>  Tout ce dont nous avons besoin maintenant, c'est du code que nous y mettons. <br><br><h2>  Shellcode </h2><br>  Le choix √©vident √©tait de forcer la section ajout√©e √† ex√©cuter le shellcode, nous n'avons donc pas eu √† nous soucier des d√©localisations et de l'importation.  Le code r√©el est assez simple et √©crit en utilisant des macros FASM pratiques, je vais rapidement expliquer comment cela fonctionne. <br><br><ul><li>  La pile est v√©rifi√©e pour s'assurer que dwmapi.dll a √©t√© appel√© par DLL_PROCESS_ATTACH; </li><li>  La structure Ldr PEB est utilis√©e pour obtenir l'adresse de base de Kernel32 et Ntdll; </li><li>  Une impl√©mentation GetProcAddress simple est utilis√©e pour importer les fonctions suivantes: NtOpenProcessToken, NtQueryInformationToken, NtClose, ExpandEnvironmentStringsA, CreateProcessA; </li><li>  Le jeton de processus actuel est ouvert et le code lui demande de confirmer que l'application √† partir de laquelle nous d√©marrons dispose des droits d'administrateur UAC; </li><li>  Il s'av√®re que le chemin cmd.exe, puis la ligne de commande est appel√©e; </li><li>  L'ex√©cution est retransf√©r√©e au point d'entr√©e r√©el de dwmapi.dll, c'est pourquoi l'ex√©cution peut continuer. </li></ul><br><h2>  Tout mettre ensemble </h2><br>  Le r√©sultat final de l'op√©ration infecte dwmapi.dll avec notre shellcode et le place dans le dossier de t√©l√©chargement, d√®s que l'utilisateur t√©l√©charge et ex√©cute le programme d'installation, ce qui n√©cessite des droits d'administrateur, une ligne de commande sera appel√©e en tant qu'administrateur (en raison de Wow64FsRedirect et du fait que la plupart des param√®tres fonctionnent sous wow64, nous pouvons utiliser le m√™me code sur les syst√®mes Windows 32 bits et 64 bits). <br><br>  Vous pouvez trouver l'infecteur complet et le shellcode sur mon github: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/MalwareTech/UACElevator</a> . <br><br>  C‚Äôest tout.  Rendez-vous sur le parcours! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr457082/">https://habr.com/ru/post/fr457082/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr457068/index.html">Files d'attente - qu'est-ce que c'est, pourquoi et comment l'utiliser? Jetez un ≈ìil aux fonctionnalit√©s d'AWS SQS</a></li>
<li><a href="../fr457070/index.html">Textolite au lieu de carton. Quelques mots sur le badge interactif OFFZONE 2019</a></li>
<li><a href="../fr457072/index.html">Comment r√©soudre un ancien probl√®me en utilisant ML en Python et .Net</a></li>
<li><a href="../fr457074/index.html">L'√©volution des d√©veloppeurs: √† quels jeux faut-il s'attendre √† l'avenir</a></li>
<li><a href="../fr457078/index.html">Comment transformer votre avatar Telegram en montre</a></li>
<li><a href="../fr457086/index.html">Motif architectural "Builder" dans l'univers de "Swift" et "iOS" / "macOS"</a></li>
<li><a href="../fr457090/index.html">Lits de s√©curit√©: JWT</a></li>
<li><a href="../fr457092/index.html">Nous √©tudions MITRE ATT & CK. Matrices mobiles: acc√®s aux appareils. Partie 5</a></li>
<li><a href="../fr457094/index.html">Compl√©ment Excel qui facilite la d√©finition de filtres lorsque vous travaillez avec des cubes (VBA)</a></li>
<li><a href="../fr457096/index.html">Nous lib√©rons nos mains de plusieurs analystes: API Livy pour l'automatisation des t√¢ches bancaires typiques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>