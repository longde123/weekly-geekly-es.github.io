<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤗 🤸🏽 👃🏼 验尸故事：我们如何扭转汉西托 🚽 ✌️ 👩‍❤️‍💋‍👩</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="对于那些已经对crackme拼图足够玩的人，我们带来了一个新的Trojan。 在野外，仍然可以在其自然栖息地-垃圾邮件中找到Hancitor下载程序。 当前，它被积极地用于下载熊猫银行木马，这是臭名昭著的宙斯的一种改进。 

 一个寒冷的夏天晚上，我们面对面见了他，看着垃圾邮件。 如果您想观看恶意软...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>验尸故事：我们如何扭转汉西托</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vyshtech/blog/418185/"><img src="https://habrastorage.org/webt/dn/-j/1o/dn-j1ohonpxz_urf0totdzgdxa4.jpeg"><br><br> 对于那些已经对<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">crackme拼图</a>足够玩的人，我们带来了一个新的Trojan。 在野外，仍然可以在其自然栖息地-垃圾邮件中找到Hancitor下载程序。 当前，它被积极地用于下载熊猫银行木马，这是臭名昭著的宙斯的一种改进。 <br><br> 一个寒冷的夏天晚上，我们面对面见了他，看着垃圾邮件。 如果您想观看恶意软件的内幕，请阅读我们的新反向解析。 <br><a name="habracut"></a><br> 我们的恶意文档如下所示： <br><br><img src="https://habrastorage.org/webt/am/z_/bu/amz_buin-rjqprnnk-v2xuaio28.png"><br><br> 默认情况下，宏被阻止，因此系统警告：“宏已被禁用。” 但是，消息的内容表明应包含宏。 好吧，让我们做吧。 单击“启用内容”按钮后，计算机被感染。 现在，让我们看看执行哪种宏以及感染如何发生。 可以通过在“视图”-&gt;“ Vacros” \“查看宏”选项卡中立即在Word中完成此操作。 <br><br><img src="https://habrastorage.org/webt/ly/uq/kd/lyuqkdosmy1commpds7-nu96gsa.png"><br><br> 您可以做的更专业-使用oletools软件包中的olevba。 您可以在链接处安装软件包。 接下来，键入olevba doc_file –c –decode&gt; source.txt并获取宏源。 <br><br><img src="https://habrastorage.org/webt/tc/tk/gp/tctkgps17vavk9-zgtmzyjgparw.png"><br><br> 通过代码，我立即想说木马属于下载程序类。 该脚本只是从某个地方散播到Malwara。 为了证明这一点，让我们解码base64字符串。 对于我们来说，通过hiew立即执行此操作更为方便，这样我们就不会复制粘贴一百次。 为此，我们使用一个特殊的插件，在此进行介绍。 这是发生了什么： <br><br><img src="https://habrastorage.org/webt/az/tv/jo/aztvjo9bo-8zxu7vaus2mzxadcc.png"><br><br> 这是一个恶意脚本，分为两个部分并另存为1.hta。 原则上，我们对其运作方式并不特别感兴趣。 这都是很平常的事。 唯一重要的一点是确定下载恶意文件的URL。 让我们尝试找到他，因为此信息可能对<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">安全性</a>有用。 他们可以添加网络规则以阻止对此类URL的请求，从而可以避免公司受到感染。 <br><br> 哈！ 没有链接。 但是6.exe文件从哪里开始（以1.hta开始）？ 是时候再看一下hiew中的dock文件了，但是要更加小心： <br><br><img src="https://habrastorage.org/webt/b2/cc/y1/b2ccy1ewmolwz5wnaqojxdracbm.png"><br><br> 是的，dock文档中内置了exe-shnik。 是的，而且包装很重。 让我们解释发生了什么。 宏将恶意的1.hta脚本放到Temp文件夹中并启动它，然后1.hta从其目录中启动6.exe。 显然，6.exe是我们在屏幕上看到的相同的打包PE-shnik。 但是现在我们想知道6.exe如何降低％temp％。 发生这种情况的原因是Microsoft Office套件中的一项有趣功能。 事实是，在任何OLE文档中，都可以嵌入Ole10Native格式的任何其他文件。 <br><br> 如果是这种情况，则在启动时，MS-Office本身会以Ole10Native结构头中指定的名称将以此方式生成的文件拖放到％temp％文件夹中。 让我们看一下这个对象。  FAR-manager- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">OLE2Viewer</a>插件帮助我们。 我们在插件中打开恶意文档，转到ObjectPool \ _1593522492目录，然后看到以下内容： <br><br><img src="https://habrastorage.org/webt/cc/wn/mx/ccwnmx32xpqyiizulnovkdnrkla.png"><br><br> 复制此文件（Ole10Native）并在hiew中打开。 <br><br><img src="https://habrastorage.org/webt/vr/xb/37/vrxb37l9_urz13rlu0jvxphqpus.png"><br><br> 在这里，我们看到OLE对象的名称-5c.pif将放入％temp％文件夹中。 现在回到我们的宏。 他的任务是启动一个醉酒的exe-shnik。 <br><br><img src="https://habrastorage.org/webt/lo/wk/li/lowkli2uxojiyiq0gsoq6iuxh7e.png"><br><br> 实际上，确切地说，该宏并不总是通过1.hta来启动删除的文件，而是还像这样：Shell“ cmd.exe / c ping localhost -n 100 &amp;&amp;”＆Environ（“ Temp”）＆“ \ 6 .pif“，vbHide <br><br><img src="https://habrastorage.org/webt/ut/8p/va/ut8pvaykzvbydqbqdfw3wuapvyy.png"><br><br> 如我们所见，启动方法取决于系统中是否存在以下进程：bdagent.exe和PSUAMain.exe。 为什么然后需要ping localhost -n 100？ 以防万一，这是古希腊人为制造人为延迟的技巧。 通常，它的变体用于自我删除。 <br><br> 在此阶段，我们检查了恶意文档的操作。 一眼看上去，该文件本身并不属于Trojan-Downloader类型的恶意软件，但它适合Trojan-Dropper类型。 这是启动时发生的事情： <br><br><img src="https://habrastorage.org/webt/rd/qp/ki/rdqpkibxofr7rfrqloll1p_xf_q.png"><br><br> 现在仍然需要自行拆卸有效载荷。 我们已经意识到木马已经打包，因此我们必须先将其解压缩。 通常，此过程分为两个阶段： <br>  1.卸下解压缩的转储+恢复导入表。 <br>  2.分析和纯化全局变量。 <br><br> 我们需要第二阶段，因为有许多API函数会由于它们的工作而将非重复值返回给我们。 例如，CreatHeap将向我们返回一个堆描述符，该描述符将进一步用于工作。 通常，代码中会进行类型检查： <i>如果堆描述符== 0，则获取堆描述符，否则使用已经初始化的堆描述符</i> 。 但是在转储时，包含给定描述符的变量已经由他初始化，并且那时描述符是有效的。 当我们尝试开始转储时，带有描述符的变量将包含旧值，即不等于0，这意味着测试将通过。 <br><br> 此后，一旦程序尝试使用此描述符，操作系统将引发异常，程序将因错误而崩溃。 因此，为避免这种情况，您需要将这些变量清零。 它们通常位于数据的可写部分。 可能您建议在十六进制编辑器中打开此部分并用零覆盖所有内容？ 您的观点是正确的，但您不应轻率地采取行动。 有一些木马程序检查变量不是在0上，而是在随机DWORD上。 并且根据测试是否被测试，采取各种措施。 您不必走得太远，例如。 只需看一下<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Cridex</a> （最近它就已经从雷达中消失了，显然已经完全升级到了EMOTETA）。 <br><br> 因此，让我们运行示例（当然是在虚拟机中）。 还希望将离开虚拟机的流量通过VPN。 <br><br> 我们启动了特洛伊木马程序，该程序只是挂起。 太好了！ 通常，木马会快速执行操作，然后立即结束并自我毁灭。 因此，您必须在代码中寻找负责这些操作的位置，暂停它们，然后转储。 就我们而言，我们可以那样做。 <br><br> 对于转储，我们使用了出色的实用程序-Process Dump，可在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a>找到。 该实用程序不仅找到所有隐藏的可执行模块并将其转储，而且还还原了导入表本身。 该实用程序必须以管理员身份通过以下方式运行：pd / pid xxxx，其中xxxx是Trojan进程的ID。 之后，该实用程序将转储所有过程模块。 我们删除了多余的，剩下的就是： <br><br><img src="https://habrastorage.org/webt/tg/je/db/tgjedb068z9unx10xyhit2dftii.png"><br><br>  Trojan进程的可执行文件的名称是1.exe。 事实证明，解压后的木马位于0x2C0000。 在hiew中打开它： <br><br><img src="https://habrastorage.org/webt/84/je/fc/84jefcffxabgt-pihoargfo-raa.png"><br><br> 只是眼睛高兴！ 现在该文件已解压缩，清晰可见。 导入表也被识别。 让我们在IDA-PRO中打开它。 <br><br><img src="https://habrastorage.org/webt/fn/hd/nc/fnhdncwcqiqd7jx_f7m8czjyf3m.png"><br><br> 在对示例进行排序时，我们已经重命名了一些函数。 特洛伊木马首先要做的就是确定其模块的加载地址。 真的：他怎么知道他的存根打开了什么地址？ 这是通过一种古老的行之有效的技术完成的-将内存页面相对于当前地址的位置翻转回0x1000，直到遇到“ MZ”字节为止。 这是可行的，因为可执行模块始终将OS加载到0x1000倍数的地址上。 自己检查一下。 在我们的情况下，设置的剥离限制为100。 <br><br><img src="https://habrastorage.org/webt/7z/cy/5c/7zcy5cbgu4nls8b9yxz8gv9x3ai.png"><br><br> 如果某人不了解哪里有倒退，那么这里是： <br> 结果+ = 0xFFFFF000等效于结果-= 0x1000。 <br><br> 收到其模块的下载地址后，解包的特洛伊木马会收到其操作所需功能的地址。 首先，搜索两个函数的地址-LoadLibraryA和GetProcAddress。 知道了这些功能的地址后，您就可以使用它们来获取所有剩余的功能。 这些函数在kernel32库中。 通过读取环形列表的第一个（零-ntdll，第一个kernelbase等）元素来获取其地址，该元素描述了使用_LDR_DATA_TABLE_ENTRY结构按初始化顺序加载的所有模块。 指向列表的指针是从PEB中提取的。 <br><br><img src="https://habrastorage.org/webt/zx/o3/s3/zxo3s3kevu7prcaoffacdxvklow.png"><br><br> 接收到地址kernel32.dll（从Windows 7开始-kernelBase.dll）后，木马可以手动解析其导出表并找到必要的两个功能，这些功能可以在sub_EF1E60子例程中执行。 <br><br><img src="https://habrastorage.org/webt/7k/xz/4v/7kxz4vk7-ad4q4d221g-ealmkko.png"><br><br> 现在看一下我们称为getHeap的函数。 <br><br><img src="https://habrastorage.org/webt/qc/gv/oz/qcgvozmioggzgsidsap-5frkfas.png"><br><br> 在这里，我们仅观察到上述情况。 在转储时，hHeap变量包含的值为600000h。 因此，将不会调用GetProcessHeap。 相反，程序将转到loc_EF11DD标签，在该标签中使用无效的句柄调用HeapAlloc，这将给我们带来错误。 因此，我们采用十六进制编辑器并将此数字清零。 我们计算了六个类似的地方。 <br><br> 接下来，乐趣开始了。 特洛伊木马根据硬盘的序列号和MAC地址生成唯一的“客户端” ID。 此处收到的信息： <br><br><img src="https://habrastorage.org/webt/hx/fo/ce/hxfoceeap2k3oqut_yjgwqsjnwu.png"><br><br> 我们还会得到以下信息：IP地址，操作系统版本，网络名称和用户名。 基于所有这些，将向管理面板生成一个HTTP请求，我们尚不知道其地址。 它不在生产线上（即使是未包装的形式）。 但是它不存在，因为它已在配置中加密。 可以从代码中提取其地址： <br><br><img src="https://habrastorage.org/webt/vw/9n/ej/vw9nej-cbxk5jgjljgjgasiwikw.png"><br><br> 该配置的权重为0x2008字节，格式如下：前8个字​​节是RC4密钥，0x2000字节是加密数据。 <br><br><img src="https://habrastorage.org/webt/tf/ne/je/tfneje_zc_aeq5nzmnzmkfd5r6c.png"><br><br> 从以下清单中可以清楚地看到使用RC4加密算法的事实： <br><br><img src="https://habrastorage.org/webt/4g/jc/ci/4gjccirc5sxslir_xgfoiytzjhc.png"><br><br> 请注意，仅前8个字节并不是RC4的关键。 关键是这些字节的SHA1哈希。 您还需要注意函数CryptDeriveKey的标志0x280011。  MSDN关于此标志有免责声明： <br><br><img src="https://habrastorage.org/webt/_t/2m/lu/_t2mlufhbsvpfivk9knvzdnoas0.png"><br><br> 从中可以明显看出，该标志的高16位以位为单位设置密钥大小。 也就是说，密钥大小以字节为单位：（0x280011 &gt;&gt; 16）/ 8 =5。因此，密钥将是配置的前八个字节中哈希值的前五个字节。 让我们转储配置并编写一个Python脚本，它将为我们解密。 该脚本如下所示： <br><br><img src="https://habrastorage.org/webt/fo/ow/7t/foow7ta0eo02epz-qp8vtkiozfy.png"><br><br> 他的工作结果就是config.rc4文件。 在hiew中打开它： <br><br><img src="https://habrastorage.org/webt/rc/tz/dj/rctzdjyqwmh4ysz7pt7lhahlpna.png"><br><br> 我们看到一个解密的管理区域列表。 第一个单词是“ 19nep07”-内部版本号。 为此分配了16个字节。 接下来是用“ |”分隔的管理URL列表。 <br><br> 因此，第一次调用管理面板将采用以下格式： <br>  GUID = 3068075364164635648＆BUILD = 19nep07＆INFO = WIN-56G04BL06SL @ WIN -56G04BL06SL \反向＆IP = 35.0.127.52＆TYPE = 1＆WIN = 6.1（x32 <br><br><img src="https://habrastorage.org/webt/1e/5o/bg/1e5obgayvnhe8mlproaehfms000.png"><br><br> 然后，首先在管理面板列表中发送生成的请求。 <br><br><img src="https://habrastorage.org/webt/ou/u8/ue/ouu8ueyhzcz_3hh2zbkmdh_hqvw.png"><br><br> 接下来，如果仍然有效，则读取来自管理员的响应。 答案应为base64编码。 如果不是这种情况，则使用列表中的下一个管理员。 有时现场管理员会返回一个奇怪的答案： <br><br><img src="https://habrastorage.org/webt/lu/d_/uo/lud_uoa61fkscmma-05nbxlkoic.png"><br><br> 很熟悉，不是吗？ 是的，这些是相同的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">数字</a> ！ 实际上，一位作者知道为什么管理员开始退还他们！ 正常情况下，命令返回。 不幸的是，由于没有流量，所以不可能完全确定地说响应格式是什么，所有管理员都死了。 解码后的文件将另外解码为0x7A： <br><br><img src="https://habrastorage.org/webt/f0/sc/8k/f0sc8kchkod-u2luugrrlty75t8.png"><br><br> 响应中应包含一个命令。 如果不是，请转到下一个管理面板。 命令代码编码为“ x：”，其中x是编码特定命令的字母。 其中有7个：“ r”，“ l”，“ e”，“ b”，“ d”，“ c”，“ n”。 考虑“ b”和“ r”命令。 <br><br> 这些命令的处理程序具有相同的功能。 我们将其命名为GetExe。 看起来是这样的： <br><br><img src="https://habrastorage.org/webt/_a/rz/lk/_arzlkrepv0wjyhlt0k4krtjtv8.png"><br><br> 我认为这里一切都清楚了。 特洛伊木马发出http请求，并以压缩形式返回可执行文件作为响应，然后将其解压缩。 这样就有可能出现变化。 对于“ b”命令，将发生以下三个操作： <br><br>  <b>1.以冻结形式创建svchost进程</b> <br><br><img src="https://habrastorage.org/webt/lz/yw/cy/lzywcy3d56o5tmkxdz8yu5ttvp4.png"><br><br>  <b>2.注入下载模块过程的地址空间</b> <br><br><img src="https://habrastorage.org/webt/7b/ab/fe/7babfemu0nyrag5bv6jtadst3o8.png"><br><br>  <b>3.控制权转移到注入的模块</b> <br><br><img src="https://habrastorage.org/webt/xj/m4/i5/xjm4i5ch6cpnogd79cz47tn1pny.png"><br><br> 对于r命令，将发生以下三个操作： <br>  1.通过调用GetExe函数下载可执行文件。 <br>  2.将下载的文件以随机名称保存到临时文件夹中。 <br>  3.启动删除的文件。 <br><br><img src="https://habrastorage.org/webt/qk/go/sj/qkgosjsrb_45ny1kkfi7cguuvbm.png"><br><br> 完成 <br><br>  PS下次我们可以解析Panda或某些加密器。 在评论中写下您最感兴趣的恶意软件（当然，是出于研究目的）。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN418185/">https://habr.com/ru/post/zh-CN418185/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN418169/index.html">Veeam可用性控制台2.0 Update 1中有哪些新增功能？</a></li>
<li><a href="../zh-CN418171/index.html">如果用户在网站上执行的转换很少，那么要依靠什么指标？</a></li>
<li><a href="../zh-CN418173/index.html">神经网络的往返或文本分析中自动编码器使用的回顾</a></li>
<li><a href="../zh-CN418177/index.html">编辑.heic图像而不会丢失颜色</a></li>
<li><a href="../zh-CN418183/index.html">语音分析在商业中的应用</a></li>
<li><a href="../zh-CN418187/index.html">在美国，他们建议使用Amazon集线器替换所有库。 公众很愤慨</a></li>
<li><a href="../zh-CN418189/index.html">宙斯的继承人：为什么IcedID木马对银行客户有害</a></li>
<li><a href="../zh-CN418191/index.html">Python和JavaScript中的类似物。 第三部分</a></li>
<li><a href="../zh-CN418193/index.html">在2017年为Game Boy制作游戏的感觉如何</a></li>
<li><a href="../zh-CN418195/index.html">麻省理工学院的课程“计算机系统安全”。 讲座4：“共享特权”，第1部分</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>