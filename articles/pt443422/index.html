<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öæÔ∏è üõÄüèæ üëêüèª Armazenamento flex√≠vel de dados no MySQL (JSON) üò≤ üòú üí§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alexander Rubin trabalha na Percona e se apresentou no HighLoad ++ mais de uma vez, familiar aos participantes como um especialista em MySQL. √â l√≥gico...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Armazenamento flex√≠vel de dados no MySQL (JSON)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/443422/">  Alexander Rubin trabalha na Percona e se apresentou no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HighLoad ++ mais</a> de uma vez, familiar aos participantes como um especialista em MySQL.  √â l√≥gico supor que hoje falaremos sobre algo relacionado ao MySQL.  √â assim, mas apenas parcialmente, porque tamb√©m falaremos sobre a <strong>Internet das coisas</strong> .  A hist√≥ria ser√° meio divertida, especialmente sua primeira parte, na qual analisamos o dispositivo que Alexander criou para colher damascos.  Essa √© a natureza de um verdadeiro engenheiro - se voc√™ quer frutas, compra uma taxa. <br><br><img src="https://habrastorage.org/webt/71/jf/vp/71jfvpzudizjhoc1ikzgfuakds8.jpeg"><br><br><h2>  Antecedentes <br></h2><br>  Tudo come√ßou com um simples desejo de plantar uma √°rvore frut√≠fera em sua √°rea.  Parece muito simples fazer isso - voc√™ vem √† loja e compra uma muda.  Mas na Am√©rica, a primeira pergunta que os vendedores fazem √© quanta luz solar a √°rvore receber√°.  Para Alexander, isso acabou sendo um mist√©rio gigante - n√£o se sabe ao certo quanto luz solar existe no local. <br><br>  Para descobrir, um aluno pode sair diariamente para o quintal, ver a quantidade de sol e escrev√™-lo em um caderno.  Mas este n√£o √© o caso - √© necess√°rio equipar tudo e automatiz√°-lo. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/X5iLzmyZcto" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <em>Durante a apresenta√ß√£o, muitos exemplos foram executados e tocados ao vivo.</em>  <em>Quer uma imagem mais completa do que no texto, mude para assistir ao v√≠deo.</em> <br><br>  Portanto, para n√£o registrar observa√ß√µes meteorol√≥gicas em um notebook, h√° um grande n√∫mero de dispositivos para coisas na Internet - Raspberry Pi, o novo Raspberry Pi, Arduino - milhares de plataformas diferentes.  Mas eu escolhi um dispositivo chamado <b>Particle Photon</b> para este projeto.  √â muito f√°cil de usar, custa US $ 19 no site oficial. <br><br>  A coisa boa sobre o Particle Photon √©: <br><br><ol><li>  Solu√ß√£o 100% na nuvem; </li><li>  Qualquer sensor √© adequado, por exemplo, para o Arduino.  Todos custam menos de um d√≥lar. </li></ol><br>  Eu fiz esse dispositivo e coloquei na grama no local.  Possui uma nuvem de dispositivo de part√≠culas e um console.  Este dispositivo se conecta via ponto de acesso Wi-Fi e envia dados: luz, temperatura e umidade.  O testador durou 24 horas com uma bateria pequena, o que √© muito bom. <br><br>  Al√©m disso, preciso n√£o apenas medir a ilumina√ß√£o e transferi-las para o telefone (o que √© realmente bom - posso ver em tempo real que tipo de ilumina√ß√£o tenho), mas tamb√©m <strong>armazenar dados</strong> .  Para isso, naturalmente, como veterano do MySQL, escolhi o MySQL. <br><br><h2>  Como escrevemos dados no MySQL <br></h2><br>  Eu escolhi um esquema bastante complicado: <br><br><ul><li>  Eu obtenho dados do console do Particle; <br></li><li>  Eu uso o Node.js para escrev√™-los no MySQL. <br></li></ul><br>  Estou usando a API Particle JS, que pode ser baixada no site da Particle.  Eu estabele√ßo uma conex√£o com o MySQL e escrevo, ou seja, apenas insiro os valores INSERT INTO.  Tal pipeline. <br><br>  Assim, o dispositivo fica no quintal, se conecta via Wi-Fi ao roteador dom√©stico e, usando o protocolo MQTT, transfere dados para o Particle.  Em seguida, o pr√≥prio esquema: o programa no Node.js √© executado na m√°quina virtual, que recebe dados do Particle e os grava no MySQL. <br><br>  Para come√ßar, constru√≠ os gr√°ficos a partir dos dados brutos em R. Os gr√°ficos mostram que a temperatura e a ilumina√ß√£o aumentam durante o dia, caem √† noite e a umidade aumenta - isso √© natural.  Mas tamb√©m h√° ru√≠do no gr√°fico, o que √© t√≠pico para dispositivos da Internet das Coisas.  Por exemplo, quando um bug entra no dispositivo e o fecha, o sensor pode transmitir dados completamente irrelevantes.  Isso ser√° importante para uma an√°lise mais aprofundada. <br><br>  Agora vamos falar sobre MySQL e JSON, o que mudou ao trabalhar com JSON do MySQL 5.7 para o MySQL 8. Em seguida, mostrarei uma demonstra√ß√£o para a qual uso o MySQL 8 (no momento do relat√≥rio, esta vers√£o ainda n√£o estava pronta para produ√ß√£o, uma vers√£o est√°vel j√° foi lan√ßada). <br><br><h2>  Armazenamento de dados MySQL <br></h2><br>  Quando tentamos armazenar dados recebidos dos sensores, nosso primeiro pensamento √© <strong>criar uma tabela no MySQL</strong> : <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">'sensor_wide'</span></span> ( <span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">'light'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'temp'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'humidity'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">'id'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span></code> </pre> <br>  Aqui, para cada sensor e para cada tipo de dados, h√° uma coluna: luz, temperatura, umidade. <br><br>  Isso √© l√≥gico o suficiente, mas <strong>h√° um problema - n√£o √© flex√≠vel</strong> .  Suponha que desejemos adicionar outro sensor e medir outra coisa.  Por exemplo, algumas pessoas medem a cerveja restante em um barril.  O que fazer neste caso? <br><br><pre> <code class="plaintext hljs">alter table sensor_wide add water level double ...;</code> </pre><br>  Como perverter para adicionar algo √† tabela?  Voc√™ precisa criar uma tabela de altera√ß√£o, mas se voc√™ fez uma tabela de altera√ß√£o no MySQL, ent√£o voc√™ sabe do que estou falando - isso √© completamente dif√≠cil.  Alterar tabela no MySQL 8 e MariaDB √© muito mais simples, mas historicamente este √© um grande problema.  Portanto, se precisarmos adicionar uma coluna, por exemplo, com o nome da cerveja, n√£o ser√° t√£o simples. <br><br>  Novamente, os sensores aparecem, desaparecem, o que devemos fazer com os dados antigos?  Por exemplo, paramos de receber informa√ß√µes sobre ilumina√ß√£o.  Ou estamos criando uma nova coluna - como armazenar o que n√£o existia antes?  A abordagem padr√£o √© nula, mas, para an√°lise, n√£o ser√° muito conveniente. <br><br>  Outra op√ß√£o √© um armazenamento de chave / valor. <br><br><h3>  Armazenamento de dados MySQL: chave / valor <br></h3><br>  Isso ser√° <strong>mais flex√≠vel</strong> : em chave / valor, haver√° um nome, por exemplo, temperatura e, consequentemente, dados. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">'cloud_data'</span></span> ( <span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">'name'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'data'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'updated_at'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">'id'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span></code> </pre><br>  Nesse caso, <strong>outro problema</strong> aparece <strong>- n√£o h√° tipos</strong> .  N√£o sabemos o que estamos armazenando no campo 'dados'.  Teremos que declar√°-lo como um campo de texto.  Quando crio meu dispositivo Internet of things, sei que tipo de sensor existe e, portanto, o tipo, mas se voc√™ precisar armazenar os dados de outra pessoa na mesma tabela, n√£o saberei quais dados est√£o sendo coletados. <br><br>  Voc√™ pode armazenar muitas tabelas, mas criar uma nova tabela inteira para cada sensor n√£o √© muito boa. <br><br>  O que pode ser feito?  - Use JSON. <br><br><h3>  Armazenamento de dados MySQL: JSON <br></h3><br>  A boa not√≠cia √© que no MySQL 5.7 voc√™ pode armazenar JSON como um campo. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">'cloud_data_json'</span></span> ( <span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">'name'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JSON</span></span>, <span class="hljs-string"><span class="hljs-string">'updated_at'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">'id'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>;</code> </pre><br>  Antes do MySQL 5.7 aparecer, as pessoas tamb√©m armazenavam JSON, mas como um campo de texto.  O campo JSON no MySQL permite armazenar o pr√≥prio JSON com mais efici√™ncia.  Al√©m disso, com base no JSON, voc√™ pode criar colunas e √≠ndices virtuais com base neles. <br><br>  O √∫nico pequeno problema √© <strong>que a tabela aumentar√° de tamanho durante o armazenamento</strong> .  Mas ent√£o temos muito mais flexibilidade. <br><br>  O campo JSON √© melhor para armazenar JSON do que o campo de texto porque: <br><br><ul><li>  Fornece <strong>valida√ß√£o autom√°tica de documentos</strong> .  Ou seja, se tentarmos escrever algo que n√£o √© v√°lido l√°, ocorrer√° um erro. <br></li><li>  Este √© um <strong>formato de armazenamento otimizado</strong> .  O JSON √© armazenado no formato bin√°rio, que permite alternar de um documento JSON para outro - o que √© chamado de ignorar. <br></li></ul><br>  Para armazenar dados em JSON, podemos simplesmente usar o SQL: fa√ßa um INSERT, coloque 'data' l√° e obtenha dados do dispositivo. <br><br><pre> <code class="sql hljs">‚Ä¶ stream.on('event', function(data) { var query = connection.query( '<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> cloud_data_json (client_name, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (?, ?)<span class="hljs-string"><span class="hljs-string">', ['</span></span>particle<span class="hljs-string"><span class="hljs-string">', JSON.stringify(data)] ) ‚Ä¶ (demo)</span></span></code> </pre><br><h3>  Demo <br></h3><br>  Para demonstrar ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> no come√ßo do v√≠deo), o exemplo usa uma m√°quina virtual na qual existe SQL. <br><br><img src="https://habrastorage.org/webt/r1/mb/po/r1mbpoyh-czzxtsbz2f_umippjc.jpeg"><br><br>  Abaixo est√° um fragmento do programa. <br><br><img src="https://habrastorage.org/webt/ap/fm/pq/apfmpqvjrdx5k8f9z6thallawri.jpeg"><br><br>  <code>INSERT INTO cloud_data (name, data)</code> , j√° obtenho os dados no formato JSON e posso grav√°-los diretamente no MySQL, sem pensar no que est√° dentro. <br><br>  Como se viu, usando essa nuvem, voc√™ pode acessar n√£o apenas os dados do meu dispositivo, mas geralmente <strong>todos os dados</strong> que esse Particle usa.  Parece funcionar at√© agora.  As pessoas que usam o Particle Photon em todo o mundo est√£o enviando alguns dados: a porta da garagem est√° aberta, ou o resto da cerveja √© tal e tal ou algo mais.  N√£o se sabe onde esses dispositivos est√£o localizados, mas esses dados podem ser obtidos.  A √∫nica diferen√ßa √© que, quando obtenho meus dados, escrevo algo como: <code>deviceId: 'mine'</code> . <br><br>  Quando executamos o c√≥digo, obtemos um fluxo de alguns dados dos dispositivos de outras pessoas que est√£o fazendo algo. <br><br><img src="https://habrastorage.org/webt/sw/wk/c5/swwkc5xibzuqncd-kuuo_figddg.jpeg"><br><br>  N√£o sabemos absolutamente o que s√£o esses dados: TTL, publicado_at, coreid, status da porta (porta aberta), retransmitir. <br><br>  Este √© um √≥timo exemplo.  Suponha que eu tente colocar isso no MySQL em uma estrutura de dados normal.  Eu deveria saber qual √© a porta, por que est√° aberta e quais par√¢metros gerais ela pode receber.  Se eu tenho JSON, escrevo-o diretamente no MySQL como um campo JSON. <br><br><img src="https://habrastorage.org/webt/9o/pi/k4/9opik4nqfqiand6n4fhae0zi31u.jpeg"><br><br>  Por favor, tudo foi gravado. <br><br><img src="https://habrastorage.org/webt/wz/n0/ph/wzn0phesbal_lwsjutyiy3569jq.jpeg"><br><br><h3>  Armazenamento de documentos <br></h3><br>  O armazenamento de documentos √© uma tentativa no MySQL de fazer armazenamento para JSON.  Eu realmente amo SQL, estou familiarizado com ele, posso fazer qualquer consulta SQL, etc.  Mas muitas pessoas n√£o gostam do SQL por v√°rios motivos, e o reposit√≥rio de documentos pode ser uma solu√ß√£o para eles, porque com ele voc√™ pode abstrair do SQL, conectar-se ao MySQL e escrever JSON diretamente l√°. <br><img src="https://habrastorage.org/webt/w5/9z/5y/w59z5ykdgg9nqfnuuzjdhgrfcmu.jpeg"><br><br>  Existe outra possibilidade que apareceu no MySQL 5.7: usar um protocolo diferente, uma porta diferente e outro driver tamb√©m √© necess√°rio.  Para o Node.js (de fato, para qualquer linguagem de programa√ß√£o - PHP, Java etc.), n√≥s nos conectamos ao MySQL usando um protocolo diferente e podemos transferir dados no formato JSON.  Novamente, n√£o sei o que tenho neste JSON - informa√ß√µes sobre portas ou qualquer outra coisa, apenas despejo os dados no MySQL e depois vamos descobrir. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mysqlx = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'@mysql/xdevapi*); // MySQL Connection var mySession = mysqlx.gctSession({ host: '</span></span>localhost<span class="hljs-string"><span class="hljs-string">', port: 33060, dbUser: '</span></span>photon* }); ‚Ä¶ session.getSchema(<span class="hljs-string"><span class="hljs-string">"particle"</span></span>).getCollection(<span class="hljs-string"><span class="hljs-string">"cloud_data_docstore"</span></span>) .add( data ) .execute(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">row</span></span></span><span class="hljs-function">) </span></span>{ }).catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err); }) .then( -<span class="hljs-built_in"><span class="hljs-built_in">Function</span></span> (notices) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Wrote to MySQL"</span></span>) }); ...https:<span class="hljs-comment"><span class="hljs-comment">//dev.mysql.com/doc/dev/connector-nodejs/</span></span></code> </pre><br>  Se voc√™ quiser experimentar isso, pode configurar o MySQL 5.7 para que ele entenda e ou√ßa no armazenamento de documentos da porta apropriada ou no X DevAPI.  Eu usei connector-nodejs. <br><br>  Este √© um exemplo do que escrevo l√° em baixo: cerveja, etc. Eu absolutamente n√£o sei o que est√° l√°.  Agora, escrevemos e analisamos mais tarde. <br><br><img src="https://habrastorage.org/webt/vo/cw/jn/vocwjnriy8x0mgrsepta-nrcpcm.jpeg"><br><br>  O pr√≥ximo ponto do nosso programa √© como ver o que h√° l√°? <br><br><h3>  Armazenamento de dados MySQL: √≠ndices JSON + <br></h3><br>  H√° um √≥timo recurso no JSON e no MySQL 5.7 que pode extrair campos do JSON.  Esse √© um a√ß√∫car sint√°tico na fun√ß√£o JSON_EXTRACT.  Eu acho que isso √© muito conveniente. <br><br>  Os dados no nosso caso s√£o o nome da coluna na qual o JSON est√° armazenado e o nome √© o nosso campo.  Nome, dados, publicado_at - √© tudo o que podemos extrair dessa maneira. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.name'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> data_name, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.published_at'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> published <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;<span class="hljs-string"><span class="hljs-string">'$.published_at'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre><br>  Neste exemplo, quero ver o que escrevi na tabela MySQL e os √∫ltimos 10 registros.  Eu fa√ßo esse pedido e tento execut√°-lo.  Infelizmente, <strong>isso funcionar√° por muito tempo</strong> . <br><br>  De uma maneira l√≥gica, o MySQL n√£o utilizar√° nenhum √≠ndice nesse caso.  Retiramos os dados do JSON e tentamos aplicar algum tipo de filtro e classifica√ß√£o.  Nesse caso, obtemos Using filesort. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXPLAIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.name'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> data_name ... <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.published_at'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> select_type: SIMPLE <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>: cloud_data_json possible_keys: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>: <span class="hljs-number"><span class="hljs-number">101589</span></span> filtered: <span class="hljs-number"><span class="hljs-number">100.00</span></span> Extra: <span class="hljs-keyword"><span class="hljs-keyword">Using</span></span> filesort</code> </pre><br>  O uso do filesort √© muito ruim, √© uma classifica√ß√£o externa. <br><br>  A boa not√≠cia √© que voc√™ pode dar dois passos para acelerar. <br><br><h4>  Etapa 1. Crie uma coluna virtual <br></h4><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> published_at DATETIME(<span class="hljs-number"><span class="hljs-number">6</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">STR_TO_DATE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.published_at'</span></span>,<span class="hljs-string"><span class="hljs-string">"%Y-%m-%dT%T.%fZ"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">VIRTUAL</span></span>; Query OK, 0 rows affected (0.01 sec) Records: 0 Duplicates: 0 Warnings: 0</code> </pre><br>  Eu fa√ßo EXTRACT, ou seja, extraio dados do JSON e, com base nele, crio uma coluna virtual.  A coluna virtual n√£o √© armazenada no MySQL 5.7 e no MySQL 8 - √© apenas a capacidade de criar uma coluna separada. <br><br>  Voc√™ pergunta como √©, voc√™ disse que o ALTER TABLE √© uma opera√ß√£o t√£o longa.  Mas aqui n√£o √© t√£o ruim.  <strong>Criar uma coluna virtual √© r√°pido</strong> .  Existe uma falha l√°, mas na verdade no MySQL h√° um bloqueio em todas as opera√ß√µes DDL.  ALTER TABLE √© uma opera√ß√£o bastante r√°pida e n√£o reconstr√≥i a tabela inteira. <br><br>  Criamos uma coluna virtual aqui.  Eu tive que converter a data, porque no JSON ela √© armazenada no formato iso, mas aqui o MySQL usa um formato completamente diferente.  Para criar uma coluna, chamei-a, dei um tipo e disse que gravaria l√°. <br><br>  Para otimizar a consulta original, voc√™ precisa extrair o nome_da publica√ß√£o.  Published_at j√° existe, o nome √© mais f√°cil - basta criar uma coluna virtual. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> data_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.name'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VIRTUAL</span></span>; Query OK, 0 rows affected (0.01 sec) Records: 0 Duplicates: 0 Warnings: 0</code> </pre><br><h4>  Etapa 2. Criando um √çndice <br></h4><br>  No c√≥digo abaixo, eu crio um √≠ndice em publish_at e executo a consulta: <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (published_at); Query OK, 0 rows affected (0.31 sec) Records: 0 Duplicates: 0 Warnings: 0 mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> data_name, published_at, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> published_at <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>\G <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>: cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> possible_keys: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>: published_at key_len: <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> filtered: <span class="hljs-number"><span class="hljs-number">100.00</span></span> Extra: Backward <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">scan</span></span></code> </pre><br>  Voc√™ pode ver que o MySQL realmente usa o √≠ndice.  Esta √© uma otimiza√ß√£o por pedido.  Neste exemplo, dados e nome n√£o s√£o indexados.  O MySQL usa a ordem por dados e, como temos um √≠ndice em publish_at, ele o usa. <br><br>  Al√©m disso, eu poderia usar a mesma sintaxe a√ß√∫car <code>STR_TO_DATE(data-&gt;&gt;'$.published_at',"%Y-%m-%dT%T.%fZ")</code> vez de publicado_at em ordem.  O MySQL ainda entenderia que existe um √≠ndice nesta coluna e come√ßaria a us√°-lo. <br><br>  Na verdade, h√° um pequeno problema com isso.  Suponha que eu queira classificar os dados n√£o apenas por publish_at, mas tamb√©m por nome. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> data_name, published_at, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> published_at <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, data_name <span class="hljs-keyword"><span class="hljs-keyword">asc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>\G select_type: SIMPLE <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>: cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">partitions</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: ALL possible_keys: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> key_len: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>: <span class="hljs-number"><span class="hljs-number">101589</span></span> filtered: <span class="hljs-number"><span class="hljs-number">100.00</span></span> Extra: <span class="hljs-keyword"><span class="hljs-keyword">Using</span></span> filesort</code> </pre><br>  Se o seu dispositivo processar dezenas de milhares de eventos por segundo, o publish_at n√£o fornecer√° uma boa classifica√ß√£o, pois haver√° duplicatas.  Portanto, adicionamos outra classifica√ß√£o por data_name.  Essa √© uma consulta t√≠pica, n√£o apenas para a Internet das coisas: forne√ßa os √∫ltimos 10 eventos, mas os classifique por data e, por exemplo, pelo sobrenome da pessoa em ordem crescente.  Para fazer isso, no exemplo acima, existem dois campos e duas chaves de classifica√ß√£o s√£o especificadas: decrescente e crescente. <br><br>  Primeiro de tudo, neste caso, o MySQL n√£o usar√° √≠ndices.  Nesse caso em particular, o MySQL decide que uma varredura completa de tabela ser√° mais lucrativa do que usar um √≠ndice e, novamente, a opera√ß√£o muito lenta de separa√ß√£o de arquivos √© usada. <br><br><h2>  Novo no MySQL 8.0 <br></h2><br><h3>  <strong>descendente / ascendente</strong> <br></h3><br>  No MySQL 5.7, essa consulta n√£o pode ser otimizada, mesmo que √† custa de outras coisas.  No MySQL 8, havia uma oportunidade real de especificar a classifica√ß√£o para cada campo. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> published_at_data_name (published_at <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, data_name <span class="hljs-keyword"><span class="hljs-keyword">asc</span></span>); Query OK, 0 rows affected (0.44 sec) Records: 0 Duplicates: 0 Warnings: 0</code> </pre><br>  O mais interessante √© que a chave descendente / ascendente ap√≥s o nome do √≠ndice est√° no SQL h√° muito tempo.  Mesmo na primeira vers√£o do MySQL 3.23, voc√™ poderia especificar o publish_at descending ou o publicado_at ascending.  O MySQL aceitou isso, <strong>mas n√£o fez nada</strong> , ou seja, sempre classificou em uma dire√ß√£o. <br><br>  No MySQL 8, isso foi corrigido e agora existe esse recurso.  Voc√™ pode criar um campo em ordem decrescente e com classifica√ß√£o padr√£o. <br><br>  Vamos voltar um segundo e ver o exemplo da etapa 2 novamente. <br><br>  Por que funciona, caso contr√°rio, n√£o funciona?  Isso funciona porque, nos √≠ndices do MySQL, √© uma √°rvore B, e os √≠ndices da √°rvore B podem ser lidos desde o in√≠cio e at√© o final.  Nesse caso, o MySQL l√™ o √≠ndice do final e est√° tudo bem.  Mas se fizermos descendente e ascendente, voc√™ n√£o poder√° ler.  Voc√™ pode ler na mesma ordem, mas <strong>n√£o pode combinar duas classifica√ß√µes</strong> - √© necess√°rio reordenar. <br><br>  Como estamos otimizando um caso muito espec√≠fico, podemos criar um √≠ndice para ele e especificar uma classifica√ß√£o espec√≠fica: aqui o publish_at est√° descendo, o data_name est√° subindo.  O MySQL usa esse √≠ndice, e tudo ficar√° bem e r√°pido. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> data_name, published_at, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> published_at <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>\G select_type: SIMPLE <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>: cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">partitions</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> possible_keys: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>: published_at_data_name key_len: <span class="hljs-number"><span class="hljs-number">267</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> filtered: <span class="hljs-number"><span class="hljs-number">100.00</span></span> Extra: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span></code> </pre><br>  Esse √© um recurso do MySQL 8, que est√° agora, no momento da publica√ß√£o, j√° dispon√≠vel e pronto para uso na produ√ß√£o. <br><br><h3>  Resultados de Sa√≠da <br></h3><br>  H√° mais duas coisas interessantes que quero mostrar: <br><br>  1. Impress√£o bonita, ou seja, uma sa√≠da bonita de dados para a tela.  Com o SELECT normal, o JSON n√£o ser√° formatado. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> json_pretty(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%beer%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>\G ‚Ä¶ json_pretty(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>): { <span class="hljs-string"><span class="hljs-string">"ttl"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"data"</span></span>: <span class="hljs-string"><span class="hljs-string">"FvGav,tagkey=beer-store spFridge=7.00,pvFridge=7.44"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"LOG_DATA_DEBUG"</span></span>, <span class="hljs-string"><span class="hljs-string">"coreid"</span></span>: <span class="hljs-string"><span class="hljs-string">"3600...."</span></span>, <span class="hljs-string"><span class="hljs-string">"published_at"</span></span>: <span class="hljs-string"><span class="hljs-string">"2017-09-28T18:21:16.517Z"</span></span> }</code> </pre><br>  2. Podemos dizer que o MySQL produzir√° o resultado na forma de uma matriz JSON ou objeto JSON, especificar os campos e, em seguida, a sa√≠da ser√° formatada como JSON. <br><br><h2>  Pesquisa de texto completo em documentos JSON <br></h2><br>  Se usarmos um sistema de armazenamento flex√≠vel e n√£o soubermos o que est√° dentro do nosso JSON, seria l√≥gico usar a pesquisa de texto completo. <br><br>  Infelizmente, <strong>a pesquisa de texto completo tem suas limita√ß√µes</strong> .  A primeira coisa que tentei foi apenas criar uma chave de texto completo.  Eu tentei fazer uma coisa dessas: <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json_indexes <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> fulltext <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>); ERROR 3152 (42000): JSON column 'data' supports indexing only via generated columns on a specified ISON path.</code> </pre><br>  Infelizmente isso n√£o funciona.  Mesmo no MySQL 8, criar um √≠ndice de texto completo simplesmente pelo campo JSON √© infelizmente imposs√≠vel.  Obviamente, eu gostaria de ter essa fun√ß√£o - a capacidade de pesquisar pelo menos pelas chaves JSON seria muito √∫til. <br><br>  Mas se isso ainda n√£o for poss√≠vel, vamos criar uma coluna virtual.  No nosso caso, h√° um campo de dados e seria interessante ver o que est√° dentro. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json_indexes -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> data_data <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VIRTUAL</span></span>; Query OK, 0 rows affected (0.01 sec) Records: 0 Duplicates: 0 Warnings: 0 mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json_indexes <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> fulltext <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> ft_json(data_name, data_data); ERROR 3106 (HY000): 'Fulltext index on virtual generated column' is not supported for generated columns.</code> </pre><br>  Infelizmente, isso tamb√©m n√£o funciona - <strong>voc√™ n√£o pode criar um √≠ndice de texto completo em uma coluna virtual</strong> . <br><br>  Nesse caso, vamos criar uma coluna armazenada.  O MySQL 5.7 permite declarar uma coluna como um campo armazenado. <br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json_indexes -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> data_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> UTF8MB4 -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.name'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">STORED</span></span>; Query OK, 123518 rows affected (1.75 sec) Records: 123518 Duplicates: 0 Warnings: 0 mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json_indexes <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> fulltext <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> ft_json(data_name); Query OK, 0 rows affected, 1 warning (3.78 sec) Records: 0 Duplicates: 0 Warnings: 1 mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">warnings</span></span>; +<span class="hljs-comment"><span class="hljs-comment">------------+--------+---------------------------------------------------+ | Level | Code | Message | +------------+--------+---------------------------------------------------+ | Warning | 124 | InnoDB rebuilding table to add column FTS_DOC_ID | +------------+--------+---------------------------------------------------+</span></span></code> </pre><br>  Nos exemplos anteriores, criamos colunas virtuais que n√£o s√£o armazenadas, mas os √≠ndices s√£o criados e armazenados.  Nesse caso, eu tive que dizer ao MySQL que esta √© uma coluna STORED, ou seja, ela ser√° criada e os dados ser√£o copiados para ela.  Depois disso, o MySQL criou um √≠ndice de texto completo, para isso tivemos que recriar a tabela.  Mas essa limita√ß√£o √© realmente a pesquisa de texto completo do InnoDB e do InnoDB: voc√™ precisa recriar a tabela para adicionar um identificador de pesquisa de texto completo especial. <br><br>  Curiosamente, no MySQL 8 havia uma <strong>nova codifica√ß√£o</strong> <strong>UTF8</strong> <strong>MB4 para emoticons</strong> .  Claro, n√£o exatamente para eles, mas porque no UTF8MB3 existem alguns problemas com o russo, chin√™s, japon√™s e outros idiomas. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json_indexes -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> data_data <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> UTF8MB4 -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> UTF8MB4) ) <span class="hljs-keyword"><span class="hljs-keyword">STORED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Query</span></span> OK, <span class="hljs-number"><span class="hljs-number">123518</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> affected (<span class="hljs-number"><span class="hljs-number">3.14</span></span> sec) <span class="hljs-keyword"><span class="hljs-keyword">Records</span></span>: <span class="hljs-number"><span class="hljs-number">123518</span></span> Duplicates: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Warnings</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Assim, o MySQL 8 deve armazenar dados JSON em UTF8MB4.  Mas, devido ao fato de o Node.js se conectar ao Device Cloud, e algo estar escrito l√° incorretamente ou ser um bug da vers√£o beta, isso n√£o aconteceu.  Portanto, tive que converter os dados antes de grav√°-los em uma coluna armazenada. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json_indexes <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> ft_json, <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> FULLTEXT <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> ft_json(data_name, data_data); Query OK, 0 rows affected (1.85 sec) Records: 0 Duplicates: 0 Warnings: 0</code> </pre><br>  Depois disso, consegui criar uma pesquisa de texto completo em dois campos: no nome JSON e nos dados JSON. <br><br><h2>  N√£o apenas a IoT <br></h2><br>  JSON n√£o √© apenas a Internet das coisas.  Pode ser usado para outras coisas interessantes: <br><br><ul><li>  Campos personalizados (CMS); </li><li>  Estruturas complexas, etc; </li></ul><br>  Algumas coisas podem ser muito mais convenientemente implementadas usando um esquema flex√≠vel de armazenamento de dados.  Um excelente exemplo foi fornecido no Oracle OpenWorld: reservas de cinema.  √â muito dif√≠cil implementar isso no modelo relacional - voc√™ obt√©m muitas tabelas dependentes, jun√ß√µes etc.  Por outro lado, podemos armazenar a sala inteira como uma estrutura JSON, respectivamente, grav√°-la no MySQL em outras tabelas e us√°-la da maneira usual: criar √≠ndices com base no JSON, etc.  <b>Estruturas complexas s√£o convenientemente armazenadas no formato JSON.</b> <br><br><img src="https://habrastorage.org/webt/9m/i3/th/9mi3thcaas9caominanputmpaua.jpeg"><br><br>  Esta √© uma √°rvore que foi plantada com sucesso.  Infelizmente, alguns anos depois, o cervo comeu, mas essa √© uma hist√≥ria completamente diferente. <br><br><blockquote>  Este relat√≥rio √© um excelente exemplo de como uma se√ß√£o inteira cresce de um t√≥pico em uma grande confer√™ncia e depois de um evento separado.  No caso da Internet das coisas, recebemos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">InoThings ++</a> - uma confer√™ncia para profissionais do mercado da Internet das Coisas, que ser√° realizada pela segunda vez em 4 de abril. <br><br>  O evento central da confer√™ncia, ao que parece, ser√° a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mesa redonda</a> ‚ÄúPrecisamos de padr√µes nacionais na Internet das Coisas?‚Äù, Que organicamente ser√° complementada por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relat√≥rios</a> aplicados abrangentes.  Venha se seus sistemas com muita carga estiverem se movendo corretamente para a IIoT. <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt443422/">https://habr.com/ru/post/pt443422/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt443408/index.html">F√≥tons, quanta e estado de Fock: manipula√ß√µes em n√≠vel qu√¢ntico com um ressonador de radiofrequ√™ncia</a></li>
<li><a href="../pt443412/index.html">Por que os programadores continuam a usar Java detalhado, embora haja Python conciso</a></li>
<li><a href="../pt443414/index.html">Placa de sinaliza√ß√£o: quando os pontos de interrup√ß√£o n√£o s√£o suficientes</a></li>
<li><a href="../pt443416/index.html">Winnti: um ataque √†s cadeias de suprimentos - desenvolvedores de jogos asi√°ticos est√£o na vanguarda</a></li>
<li><a href="../pt443418/index.html">M√©todos de teste de software</a></li>
<li><a href="../pt443424/index.html">Reescrevendo o caso de teste do front-end j√∫nior para TypeScript e ganchos de rea√ß√£o</a></li>
<li><a href="../pt443426/index.html">Marca negra - como o OpenShift protege contra vulnerabilidades de cont√™iner com o SELinux</a></li>
<li><a href="../pt443428/index.html">Palmer Lucky, o "pai" de Oculus Rift, est√° desenvolvendo um sistema virtual de campos de batalha para o Pent√°gono</a></li>
<li><a href="../pt443430/index.html">Por que √© ruim quando a Internet sabe tudo sobre voc√™?</a></li>
<li><a href="../pt443432/index.html">Lan√ßamento do Blazor 0.9.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>