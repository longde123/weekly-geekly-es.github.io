<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêô ‚ö†Ô∏è üë©üèº‚Äçüè≠ Como incorporar uma biblioteca C em uma estrutura Swift ü§±üèΩ üö∂üèæ üôÖüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em 2014, o Swift foi introduzido, uma nova linguagem para o desenvolvimento de aplicativos de ecossistema da Apple. A novidade trouxe n√£o apenas novos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como incorporar uma biblioteca C em uma estrutura Swift</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/435650/"><img src="https://habrastorage.org/webt/gg/tp/h0/ggtph083gn7erbdli6yhp2kxh_k.jpeg"><br><br>  Em 2014, o Swift foi introduzido, uma nova linguagem para o desenvolvimento de aplicativos de ecossistema da Apple.  A novidade trouxe n√£o apenas novos recursos e fun√ß√µes, mas tamb√©m problemas - para aqueles que queriam usar as boas e antigas bibliotecas C.  Neste artigo, discutirei um deles - o agrupamento da biblioteca C na estrutura Swift.  Existem v√°rias maneiras de resolv√™-lo;  neste caso, explicarei como fazer isso com m√≥dulos expl√≠citos clang. <br><br>  Por exemplo, pegamos a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca</a> C <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">libgif</a> externa e a incorporamos em nossa estrutura Swift GifSwift.  Se voc√™ quiser ver o resultado imediatamente, o projeto completo pode ser visto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><a name="habracut"></a><br><h1>  Preparando libgif </h1><br>  Antes de incorporar a biblioteca libgif em nosso projeto, voc√™ precisa compil√°-la a partir da fonte. <br><br><ol><li>  Fa√ßa o download do tarball mais recente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br></li><li>  Descompacte o arquivo morto, usando o console, v√° para a pasta e execute: <br><br><pre><code class="plaintext hljs">./configure &amp;&amp; make check</code> </pre> <br>  <b>Nota:</b> por simplicidade, estamos construindo uma biblioteca para a plataforma x86-64 e, portanto, ela funcionar√° apenas no simulador iOS ou no macOS.  Construir uma biblioteca est√°tica de v√°rias arquiteturas √© um t√≥pico separado, sobre o qual n√£o falo neste artigo.  Instru√ß√µes √∫teis podem ser encontradas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br></li><li>  Se tudo ocorrer sem erros, os arquivos da biblioteca podem ser encontrados em <code>${lib_gif_source}/lib/.libs</code> .  Estamos interessados ‚Äã‚Äãem dois arquivos: <br><br><pre> <code class="plaintext hljs">lib/.libs/libgif.a #   lib/gif_lib.h # </code> </pre></li></ol><br><h1>  Configura√ß√£o do projeto </h1><br>  Agora vamos personalizar o projeto para as nossas necessidades. <br><br><ol><li>  Crie um novo projeto usando o modelo Cocoa Touch Framework, d√™ o nome de <i>GifSwift</i> . <br></li><li>  Adicione os arquivos da biblioteca <i>libgif</i> que criamos a um grupo separado dentro do projeto. <br></li><li>  Inclua um novo destino para o aplicativo de teste no projeto para ver o resultado. <br></li></ol><br>  A estrutura final do projeto deve se parecer com isso: <br><br><img src="https://habrastorage.org/webt/jz/7_/fw/jz7_fw3f9ht0opyxv5moxnr8v18.png"><br><br><h1>  Importar para o Swift </h1><br>  Para importar uma biblioteca C para o Swift, devemos descrev√™-la como um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">m√≥dulo</a> .  A descri√ß√£o √© um arquivo <b>.modulemap</b> que cont√©m uma lista de arquivos de cabe√ßalho para importa√ß√£o e bibliotecas est√°ticas para vincula√ß√£o.  O m√≥dulo resultante pode ser importado para o c√≥digo Swift ou Objective-C (usando <code>@import</code> ). <br><br>  Esse m√©todo de importa√ß√£o da biblioteca para a estrutura funcionar√° na maioria dos casos (leia mais sobre essa abordagem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> ).  Funciona muito bem se voc√™ estiver criando uma estrutura interna ou apenas dividindo seu aplicativo em m√≥dulos.  Mas esse m√©todo tamb√©m tem desvantagens.  Por exemplo, √© ineficaz se voc√™ deseja transferir sua biblioteca para algu√©m usando Carthage, Cocoapods ou devido a um artefato bin√°rio.  O motivo √© que a estrutura resultante geralmente n√£o √© port√°til, porque ao compil√°-la √© vinculada a um local espec√≠fico dos arquivos e bibliotecas de cabe√ßalho do mapa do m√≥dulo no seu computador. <br><br><h1>  M√≥dulo Expl√≠cito </h1><br>  Para contornar essas limita√ß√µes, usaremos outra maneira - o m√≥dulo <b>expl√≠cito</b> da biblioteca.  Um m√≥dulo expl√≠cito √© um m√≥dulo que √© declarado como um subm√≥dulo usando a palavra-chave <i>expl√≠cita</i> , √© colocado no m√≥dulo pai e <i>n√£o</i> √© <i>importado</i> automaticamente.  Funciona de maneira semelhante a <code>*_Private.h</code> para <code>*_Private.h</code> de Objective-C.  Se voc√™ deseja usar a API declarada nele, importe o m√≥dulo <b>explicitamente (explicitamente).</b> <br><br>  Estamos criando um m√≥dulo expl√≠cito para a biblioteca C dentro da estrutura.  Para fazer isso, precisamos redefinir o m√≥dulo Xcode gerado.  Al√©m disso, observe que n√£o especificamos a biblioteca libgif.a para o link (link gif), mas o fazemos diretamente no projeto usando a interface do Xcode. <br><br>  <i>Nota: para saber mais sobre m√≥dulos expl√≠citos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">, clique aqui.</a></i> <br><br><ol><li>  Adicione um arquivo chamado <i>GifSwift.modulemap</i> √† pasta raiz do projeto: <br><br><pre> <code class="plaintext hljs">framework module GifSwift { umbrella header "GifSwift.h" explicit module CLibgif { private header "gif_lib.h" } export * }</code> </pre><br>  Este arquivo cont√©m a especifica√ß√£o para o m√≥dulo <i>CLibgif</i> expl√≠cito e consiste em um arquivo de cabe√ßalho declarado (j√° que existe apenas um em nossa biblioteca).  O arquivo √© carregado no m√≥dulo resultante para a estrutura. <br></li><li>  O arquivo de descri√ß√£o do m√≥dulo n√£o precisa ser adicionado √† estrutura, mas deve ser especificado nas configura√ß√µes de destino: <br><br><pre> <code class="plaintext hljs">Build Settings ‚Äî Packaging ‚Äî Module Map (MODULEMAP_FILE) = $SRCROOT/GifSwift/GifSwift.modulemap</code> </pre> </li><li>  Os arquivos libgif devem ser adicionados ao destino da estrutura como um cabe√ßalho privado ( <i>gif_lib.h</i> ) e uma biblioteca est√°tica ( <i>libgif.a</i> ).  Observe que o arquivo de cabe√ßalho da biblioteca C foi adicionado ao destino como privado.  Isso √© necess√°rio para o nosso m√≥dulo expl√≠cito.  Nada impede a adi√ß√£o desse arquivo de cabe√ßalho como p√∫blico, mas nossa tarefa √© ocultar os detalhes da implementa√ß√£o o mais simples poss√≠vel. <br><br><img src="https://habrastorage.org/webt/7d/jm/vv/7djmvvleep47_kqy7za8yys17f8.png"><br></li><li>  Agora voc√™ pode importar o m√≥dulo expl√≠cito dentro da estrutura usando <code>import GifSwift.CLibgif</code> <br></li></ol><br><h1>  Empacotador r√°pido </h1><br>  Agora voc√™ pode fazer a interface do nosso framework.  Uma classe √© suficiente, que √© um gif com algumas propriedades: <br><br><pre> <code class="plaintext hljs">import Foundation import GifSwift.CLibgif public class GifFile { private let path: URL private let fileHandlePtr: UnsafeMutablePointer&lt;GifFileType&gt; private var fileHandle: GifFileType { return self.fileHandlePtr.pointee } deinit { DGifCloseFile(self.fileHandlePtr, nil) } // MARK: - API public init?(path: URL) { self.path = path let errorCode = UnsafeMutablePointer&lt;Int32&gt;.allocate(capacity: 1) if let handle = path.path.withCString({ DGifOpenFileName($0, errorCode) }) { self.fileHandlePtr = handle DGifSlurp(handle) } else { debugPrint("Error opening file \(errorCode.pointee)") return nil } } public var size: CGSize { return CGSize(width: Double(fileHandle.SWidth), height: Double(fileHandle.SHeight)) } public var imagesCount: Int { return Int(fileHandle.ImageCount) } }</code> </pre> <br>  <code>GifFile.swift</code> interfaces de programa√ß√£o de baixo n√≠vel para processar arquivos e acessa algumas propriedades, mapeando-as para tipos de funda√ß√£o mais convenientes. <br><br><h1>  Verifique </h1><br>  Para testar nossa biblioteca, adicionei o arquivo <i>cat.gif</i> ao projeto: <br><br><pre> <code class="plaintext hljs">import UIKit import GifSwift class ViewController: UIViewController {   override func viewDidLoad() {       super.viewDidLoad()       if let file = GifFile(path: Bundle.main.url(forResource: "cat", withExtension: "gif")!) {           debugPrint("Image has size: \(file.size) and contains \(file.imagesCount) images")       }   } }</code> </pre> <br>  Quando executamos esse c√≥digo no console, veremos o seguinte: <br><br>  <b>"A <i>imagem possui tamanho: (250.0, 208.0) e cont√©m 44 imagens"</i></b> <b><br><br></b> <h1>  <b>Conclus√µes</b> </h1> <b><br></b>  A estrutura resultante cont√©m tudo o que voc√™ precisa usar, possui uma interface Swift e, por padr√£o, oculta o c√≥digo C dos clientes.  No entanto, isso n√£o √© totalmente verdade.  Como escrevi acima, a importa√ß√£o do <i>GifSwift.CLibgif</i> fornecer√° acesso a todos os m√≥dulos privados; no entanto, por padr√£o, esse m√©todo de encapsulamento √© suficiente para ocultar os detalhes da implementa√ß√£o da estrutura. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt435650/">https://habr.com/ru/post/pt435650/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt435640/index.html">Resumo de eventos para profissionais de RH na √°rea de TI em janeiro de 2019</a></li>
<li><a href="../pt435642/index.html">Pentax Auto 110: ‚Äúem que punho est√° a c√¢mera?‚Äù</a></li>
<li><a href="../pt435644/index.html">Zoo AFL Phasers</a></li>
<li><a href="../pt435646/index.html">NB-IoT, Internet das coisas em banda estreita. Informa√ß√µes gerais, recursos de tecnologia</a></li>
<li><a href="../pt435648/index.html">Bot gera tutoriais de artigos da Wikipedia</a></li>
<li><a href="../pt435652/index.html">Como n√£o senhas em scripts Python</a></li>
<li><a href="../pt435654/index.html">Armadilhas das propriedades CSS personalizadas</a></li>
<li><a href="../pt435656/index.html">Scooter Rolls Royce - Ninebot KickScooter ES4 da Segway</a></li>
<li><a href="../pt435662/index.html">‚ÄúConfiabilidade e confiabilidade como no Google‚Äù - e n√£o apenas: tradu√ß√£o do artigo ‚ÄúC√°lculo da confiabilidade do servi√ßo‚Äù</a></li>
<li><a href="../pt435664/index.html">Falsifica√ß√£o do mecanismo de pesquisa do Google</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>