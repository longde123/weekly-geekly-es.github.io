<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëäüèº üë° üèüÔ∏è Machines d'√©tat au service de MVP. Conf√©rence Yandex üñïüèæ üå®Ô∏è üßõüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le mod√®le de machine √† √©tats finis (FSM) est utilis√© pour √©crire du code pour une grande vari√©t√© de plates-formes, y compris Android. Il vous permet d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Machines d'√©tat au service de MVP. Conf√©rence Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/418561/">  Le mod√®le de machine √† √©tats finis (FSM) est utilis√© pour √©crire du code pour une grande vari√©t√© de plates-formes, y compris Android.  Il vous permet de rendre le code moins lourd, s'int√®gre bien dans le paradigme Model-View-Presenter (MVP) et se pr√™te √† des tests simples.  Le d√©veloppeur Vladislav Kuznetsov a expliqu√© √† la Droid Party comment ce mod√®le aide au d√©veloppement de l'application Yandex.Disk. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/U3StVUzqmzc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  - Tout d'abord, parlons de th√©orie.  Je pense que chacun de vous a entendu parler de MVP et de la machine d'√©tat, mais nous allons le r√©p√©ter. <a name="habracut"></a><br><br><img src="https://habrastorage.org/webt/ok/59/iy/ok59iyqnwvzdxm3a6_ozothgyka.jpeg"><br><br>  Parlons de la motivation, expliquons pourquoi tout cela est n√©cessaire et comment cela peut nous aider.  Passons √† ce que nous avons fait, avec un exemple r√©el, je vais montrer des morceaux de code.  Et √† la fin, nous parlerons des tests, de la fa√ßon dont cette approche a aid√© √† tout tester facilement. <br><br>  La machine d'√©tat et MVP, ou quelque chose de similaire - probablement MVI - ont √©t√© utilis√©s par tout le monde. <br><br>  Il y a beaucoup de machines d'√©tat.  Voici la d√©finition la plus simple qui puisse leur √™tre donn√©e: il s'agit d'une sorte d'abstraction math√©matique, pr√©sent√©e sous la forme d'un ensemble fini d'√©tats, d'√©v√©nements et de transitions de l'√©tat actuel vers un nouvel √©tat en fonction de l'√©v√©nement. <br><br><img src="https://habrastorage.org/webt/x_/o0/be/x_o0befettgekq2bf9h8rz4np3u.jpeg"><br><br>  Voici un sch√©ma simple d'un programmeur abstrait qui dort parfois, mange parfois, mais √©crit principalement du code.  Cela nous suffit.  Il existe un grand nombre de vari√©t√©s de machines √† √©tats finis, mais cela nous suffit. <br><br><img src="https://habrastorage.org/webt/5q/hw/iu/5qhwiuh6zfcmumsokpxa8xpethq.jpeg"><br><br>  La port√©e de la machine d'√©tat est assez grande.  Pour chaque √©l√©ment, ils sont utilis√©s et appliqu√©s avec succ√®s. <br><br><img src="https://habrastorage.org/webt/6k/z6/mx/6kz6mxlq_mdtra5x-duehczdoro.jpeg"><br><br>  Comme toute approche, MVP divise notre application en plusieurs couches.  Vue - le plus souvent une activit√© ou un fragment, dont la t√¢che est de transmettre une action √† l'utilisateur, pour identifier le pr√©sentateur que l'utilisateur a fait quelque chose.  Nous consid√©rons Model comme un fournisseur de donn√©es.  Cela peut √™tre comme une base de donn√©es, si nous parlons d'architecture propre ou d'Interactor, tout peut l'√™tre.  Et Presenter est un interm√©diaire qui connecte la vue et le mod√®le, tout en pouvant r√©cup√©rer et mettre √† jour la vue √† partir du mod√®le.  Cela nous suffit. <br><br>  Qui peut dire en une phrase ce qu'est un programme?  Code ex√©cutable?  Trop g√©n√©ral, plus d√©taill√©.  Un algorithme?  Un algorithme est une s√©quence d'actions. <br><br>  Il s'agit d'un ensemble de donn√©es et d'une sorte de flux de contr√¥le.  Peu importe qui manipule ces donn√©es: l'utilisateur ou non.  Il s'ensuit que, √† tout moment, l'√©tat d'une application est d√©termin√© par la totalit√© de toutes ses donn√©es.  Et plus il y a de donn√©es dans l'application, plus il est difficile de les g√©rer, plus une situation impr√©visible peut survenir en cas de probl√®me. <br><br><img src="https://habrastorage.org/webt/nw/zj/ck/nwzjck2q097uwbqk89wzm98pe7e.jpeg"><br><br>  Imaginez une classe simple avec trois drapeaux bool√©ens.  Pour vous assurer de couvrir tous les sc√©narios de combinaison de ces indicateurs, vous avez besoin de 2¬≥ sc√©narios.  Il est n√©cessaire de couvrir huit sc√©narios avec une garantie de dire que je traite toutes les combinaisons d'indicateurs √† coup s√ªr.  Si vous ajoutez un autre indicateur, il augmente proportionnellement. <br><br>  Nous avons fait face √† un probl√®me similaire.  Cela semblait √™tre une t√¢che simple, mais au fur et √† mesure que nous l'avons d√©velopp√©e et travaill√©e, nous avons commenc√© √† r√©aliser que quelque chose n'allait pas.  Je vais parler des fonctionnalit√©s que nous avons lanc√©es.  Cela s'appelle la suppression de photos locales.  Le fait est que l'utilisateur t√©l√©charge certaines donn√©es dans le cloud en mode automatique.  Il s'agit tr√®s probablement de photos et de vid√©os qu'il a prises sur son t√©l√©phone.  Il s'av√®re que les fichiers semblent √™tre dans le cloud.  Pourquoi occuper un espace pr√©cieux sur votre t√©l√©phone lorsque vous pouvez supprimer ces photos? <br><br><img src="https://habrastorage.org/webt/3n/3p/lh/3n3plhy4_4mu3v2m4p4gkygdkky.jpeg"><br><br>  Les concepteurs ont dessin√© un tel concept.  Cela ressemble √† un simple dialogue, il a un en-t√™te o√π la quantit√© d'espace que nous pouvons lib√©rer est dessin√©e, le texte du message et une coche indiquant qu'il existe deux modes de nettoyage: supprimer toutes les photos que l'utilisateur a t√©l√©charg√©es, ou seulement celles qui ont plus d'un mois. <br><br><img src="https://habrastorage.org/webt/mx/rh/ww/mxrhwwwyscc58l0l_q0dddos4zk.jpeg"><br><br>  Nous avons regard√© - il ne semble y avoir rien de compliqu√©.  Bo√Æte de dialogue, deux TextViews, case √† cocher, boutons.  Mais lorsque nous avons commenc√© √† travailler sur ce probl√®me en d√©tail - nous avons r√©alis√© que l'obtention de donn√©es sur le nombre de fichiers que nous pouvons supprimer est une t√¢che √† long terme.  Par cons√©quent, nous devons montrer √† l'utilisateur une sorte de talon.  Ceci est un pseudo code, dans la vraie vie, il semble diff√©rent, mais le sens est le m√™me. <br><br><img src="https://habrastorage.org/webt/70/if/kj/70ifkjrvmkxonvj7fybqkwuii_4.jpeg"><br><br>  Nous v√©rifions un √©tat, v√©rifions que nous calculons et dessinons une prise ¬´Wait¬ª. <br><br><img src="https://habrastorage.org/webt/v5/zl/-r/v5zl-rzfbiupzf3xas9oatuev6c.jpeg"><br><br>  Une fois les calculs termin√©s, nous avons plusieurs options pour ce que l‚Äôutilisateur doit afficher.  Par exemple, le nombre de fichiers que nous pouvons supprimer est z√©ro.  Dans ce cas, nous envoyons un message √† l'utilisateur qu'il n'y a rien √† supprimer, alors venez la prochaine fois.  Ensuite, les concepteurs viennent √† nous et disent que nous devons distinguer les situations o√π l'utilisateur a d√©j√† effac√© les fichiers ou n'a rien effac√©, rien charg√©.  Par cons√©quent, une autre condition appara√Æt que nous attendons le d√©marrage et lui dessinons un autre message. <br><br><img src="https://habrastorage.org/webt/o_/_v/qy/o__vqyedqzkarkomv1xtyvpmqr4.jpeg"><br><br>  Ensuite, il y a des situations o√π quelque chose a quand m√™me fonctionn√©, et par exemple, l'utilisateur a une coche pour ne pas supprimer les nouveaux fichiers.  Dans ce cas, il existe √©galement deux options.  Soit les fichiers peuvent √™tre nettoy√©s, soit les fichiers ne peuvent pas √™tre nettoy√©s, c'est-√†-dire qu'ils ont d√©j√† effac√© tous les fichiers, nous vous avertissons donc que vous avez d√©j√† supprim√© tous les nouveaux fichiers. <br><br><img src="https://habrastorage.org/webt/dl/oj/dj/dlojdj0k01zqxtfetujqmgjnwc4.jpeg"><br><img src="https://habrastorage.org/webt/xp/m2/k9/xpm2k931n5l9uj8kkmtl17qjuja.jpeg"><br><br>  Il y a une autre condition quand nous pouvons vraiment supprimer quelque chose.  D√©coch√©, et il y a une option que vous pouvez supprimer quelque chose.  Vous regardez ce code et il semble que quelque chose ne va pas.  Je n'ai pas encore tout r√©pertori√©, nous avons une v√©rification permanente, car rien ne fonctionne sans eux, nous ne pouvons pas toucher les fichiers sur la carte, et nous devons √©galement v√©rifier que l'utilisateur a activ√© le chargement automatique, car les fonctionnalit√©s sont inutiles sans chargement automatique, ce que nous allons nettoyer.  Et quelques autres conditions.  Et putain, cela semble si simple, et tant de probl√®mes sont survenus √† cause de cela. <br><br>  Et √©videmment, plusieurs probl√®mes se posent imm√©diatement.  Tout d'abord, ce code est illisible.  Ici, un certain pseudo-code est repr√©sent√©, mais dans un projet r√©el, il est r√©parti sur diff√©rentes fonctions, morceaux de code, il n'est pas si facile √† percevoir √† l'≈ìil nu.  La prise en charge d'un tel code est √©galement assez compliqu√©e.  Surtout quand vous arrivez √† un nouveau projet, on vous dit que vous devez faire une telle fonctionnalit√©, vous ajoutez une condition, v√©rifiez un sc√©nario positif, tout fonctionne, mais ensuite les testeurs viennent et disent que sous certaines conditions tout s'est cass√©.  Cela se produit parce que vous n'avez simplement pris en compte aucun sc√©nario. <br><br>  De plus, il est redondant dans le sens o√π, comme nous avons une large branche de conditions, nous devons v√©rifier √† l'avance toutes les conditions qui ne nous conviennent pas.  Ils sont n√©gatifs √† l'avance, mais comme ils sont √©crits avec de telles branches, nous devons les v√©rifier.  Le fait est que dans l'exemple, j'ai une sorte de drapeaux bool√©ens, mais en pratique, vous pouvez avoir des appels √† des fonctions qui vont quelque part plus profond√©ment dans la base de donn√©es.  Tout peut √™tre, en raison de la redondance, il y aura des freins suppl√©mentaires. <br><br>  Et le plus triste est un comportement impr√©vu qui a √©t√© manqu√© pendant la phase de test, rien ne s'est pass√© l√†-bas, et quelque part dans la production, l'utilisateur ne s'est pas produit au mieux, une sorte de courbe d'interface utilisateur, et au pire - il est tomb√© ou les donn√©es ont √©t√© perdues .  Seule l'application ne s'est pas comport√©e de mani√®re coh√©rente. <br><br>  Comment r√©soudre ce probl√®me?  Par la puissance de la machine d'√©tat. <br><br><img src="https://habrastorage.org/webt/_7/tj/-0/_7tj-0szm6wntxwaty3doc69isg.jpeg"><br><br>  La t√¢che principale prise en charge par la machine d'√©tat consiste √† prendre une grande t√¢che complexe et √† la diviser en petits √©tats discrets plus faciles √† interagir et √† g√©rer.  Apr√®s s'√™tre assis, avoir r√©fl√©chi, puisque nous essayons de faire quelque chose de MVP, comment lier notre √©tat √† tout cela?  Nous sommes arriv√©s √† peu pr√®s √† un tel sch√©ma.  Quiconque lit le livre GOF est un mod√®le d'√©tat classique, juste ce qu'on appelle le contexte, je l'ai appel√© un √©tat-oner, et en fait c'est un pr√©sentateur.  Le pr√©sentateur a cet √©tat, sait comment les changer et peut toujours fournir des donn√©es √† nos √©tats s'il veut savoir quelque chose, par exemple, la taille du fichier ou s'il souhaite demander une demande asynchrone, s√©lectionnez. <br><br><img src="https://habrastorage.org/webt/9r/kk/dz/9rkkdzixpvbrbgzcijhav5ap22k.jpeg"><br><br>  Il n'y a rien de super-duper ici, la diapositive suivante est plus importante. <br><br><img src="https://habrastorage.org/webt/w0/ct/ae/w0ctaej1zhv5xticgrxlmaasybo.jpeg"><br><br>  Avec cela, vous devez d√©marrer le d√©veloppement lorsque vous commencez √† cr√©er une machine d'√©tat.  Vous √™tes assis √† votre ordinateur ou quelque part autour de la table, et sur un morceau de papier ou dans des outils sp√©ciaux, dessinez un diagramme d'√©tat.  Il n'y a √©galement rien de compliqu√©, mais cette √©tape pr√©sente de nombreux avantages.  Premi√®rement, √† un stade pr√©coce, vous pouvez imm√©diatement d√©tecter certaines incoh√©rences dans la logique m√©tier.  Vos produits peuvent venir, exprimer leur d√©sir, tout va bien, mais lorsque vous commencez √† √©crire du code, vous comprenez que quelque chose ne va pas ensemble.  Je pense que tout le monde a eu une telle situation.  Mais lorsque vous cr√©ez un diagramme, vous pouvez voir √† un stade pr√©coce que quelque chose n'est pas ancr√©.  Il est dessin√© tout simplement, il existe des outils sp√©ciaux tels que PlantUML, dans lesquels vous n'avez m√™me pas besoin de pouvoir dessiner, vous devez √™tre capable d'√©crire du pseudocode, et il g√©n√®re lui-m√™me des graphiques. <br><br>  Notre graphique ressemble √† ceci, qui d√©crit l'√©tat de cette bo√Æte de dialogue.  Il y a plusieurs √©tats et la logique de la transition entre eux. <br><br><img src="https://habrastorage.org/webt/ec/84/hl/ec84hlidyk6-olcmjrar9s2oiq0.jpeg"><br><br>  Passons au code.  Indiquez lui-m√™me, il n'y a rien d'important, l'essentiel est qu'il dispose de trois m√©thodes: onEnter, qui, lors de la saisie, appelle d'abord invalidateView.  Pourquoi est-ce fait?  De sorte que d√®s que nous entrons dans l'√©tat, l'interface utilisateur est mise √† jour.  De plus, il y a la m√©thode invalidateView, que nous surchargeons si nous devons faire quelque chose avec l'interface utilisateur, et la m√©thode onExit, dans laquelle nous pouvons faire quelque chose si nous quittons l'√©tat. <br><br><img src="https://habrastorage.org/webt/zo/ld/5s/zold5sqpcjeu_1z3mq48c4jnos4.jpeg"><br><br>  StateOwner.  Une interface qui offre la possibilit√© de cliquer sur l'√©tat.  Comme nous l'avons d√©couvert, ce sera un futur pr√©sentateur.  Et ce sont des m√©thodes qui fournissent un acc√®s suppl√©mentaire aux donn√©es.  Si des donn√©es sont fouill√©es entre les √©tats, nous pouvons les conserver dans le pr√©sentateur et les transmettre via cette interface.  Dans ce cas, nous pouvons donner la taille des fichiers que nous pouvons nettoyer et donner la possibilit√© de faire une sorte de demande.  Nous sommes dans un √©tat, nous voulons demander quelque chose et via StateOwner nous pouvons appeler une m√©thode. <br><br>  Une autre utilit√© de ce type est que lui aussi peut renvoyer un lien vers la vue.  Ceci est fait de sorte que si vous avez un √©tat et que certaines donn√©es arrivent, vous ne voulez pas passer √† un nouvel √©tat, c'est juste redondant, vous pouvez directement mettre √† jour la vue, le texte.  Nous l'utilisons afin de mettre √† jour le nombre de chiffres que l'utilisateur voit lorsqu'il regarde le dialogue.  Nous sommes en train de t√©l√©charger des fichiers √† l'ex√©cution, il regarde le dialogue et les chiffres sont mis √† jour.  Nous ne passons pas √† un nouvel √©tat, nous mettons simplement √† jour la vue actuelle. <br><br><img src="https://habrastorage.org/webt/og/ug/pq/ogugpqbvlhyh5rfxwyofcz22my8.jpeg"><br><br>  Voici le MVP standard, tout devrait √™tre extr√™mement simple, pas de logique, des m√©thodes simples qui dessinent quelque chose.  J'adh√®re √† ce concept.  Il ne devrait y avoir aucune logique, au moins une sorte d'action.  Nous prenons proprement une vue texte, changez-la, pas plus. <br><br><img src="https://habrastorage.org/webt/8h/-f/zf/8h-fzfwagetflmtss66is8shzly.jpeg"><br><br>  Pr√©sentateur  Il y a des choses plus int√©ressantes.  Tout d'abord, nous pouvons fouiller les donn√©es √† travers elle pour certains √©tats, nous avons deux variables marqu√©es avec l'annotation State.  Qui a utilis√© Icepick le conna√Æt.  Nous n'√©crivons pas la s√©rialisation avec nos mains en Partible, nous utilisons une biblioth√®que pr√™te √† l'emploi. <br><br>  Voici l'√©tat initial.  Il est toujours utile de d√©finir l'√©tat initial, m√™me s'il ne fait rien.  L'utilit√© est que vous n'avez pas besoin de faire de v√©rifications nulles, mais si nous disons que cela peut faire quelque chose.  Par exemple, vous devez faire quelque chose une fois pour le cycle de vie de votre application, lorsque nous d√©marrons, vous devez ex√©cuter la proc√©dure une fois et ne plus jamais la refaire.  Lorsque nous quittons l'√©tat initial, nous pouvons toujours faire quelque chose comme √ßa, et nous ne revenons jamais √† cet √©tat.  Tapez pour que le diagramme d'√©tat soit dessin√©.  Bien que qui sache qui va dessiner, vous pouvez peut-√™tre revenir. <br><br>  Je suis en faveur de minimiser les contr√¥les pour Null et ainsi de suite, donc ici je garde un lien vers une impl√©mentation de vue simple.  Nous n'avons pas besoin de synchroniser quoi que ce soit, juste √† un moment o√π le d√©tachement se produit, nous rempla√ßons la vue par une vue vide, et le pr√©sentateur peut basculer quelque part dans les √©tats, penser qu'il y a une vue, la mettre √† jour, mais en fait cela fonctionne avec une impl√©mentation vide. <br><br>  Il existe plusieurs autres m√©thodes pour enregistrer l'√©tat, mais nous voulons faire l'exp√©rience du bouleversement de l'activit√©, dans ce cas, tout se fait via le constructeur.  Tout est un peu plus compliqu√©, voici un exemple exag√©r√©. <br><br><img src="https://habrastorage.org/webt/rk/a2/1m/rka21mszygspy9cjuprcqgv9afi.jpeg"><br><br>  Il est n√©cessaire de transmettre saveState, si quelqu'un a travaill√© avec des biblioth√®ques similaires, tout est assez trivial.  Vous pouvez √©crire avec vos mains.  Et deux m√©thodes sont tr√®s importantes: attacher, appel√© onStart, et d√©tacher, appel√© onStop. <br><br><img src="https://habrastorage.org/webt/p4/dq/n2/p4dqn2m5adpxmsfybd7fctrjc0a.jpeg"><br><br>  Quelle est leur importance?  Initialement, nous avions pr√©vu d'attacher et de d√©tacher dans onCreateView, onDestroyView, mais ce n'√©tait pas tout √† fait suffisant.  Si vous avez une vue, votre texte peut √™tre mis √† jour ou un fragment de bo√Æte de dialogue peut appara√Ætre.  Et si vous ne vous retrouvez pas sur onStop, puis essayez d'afficher le fragment, vous interceptez l'exception bien connue selon laquelle vous ne pouvez pas valider une transaction lorsque nous avons encore l'√©tat.  Soit utiliser commit state loss, soit ne pas le faire.  Par cons√©quent, nous sommes d√©taill√©s dans onStop, tandis que le pr√©sentateur continuera √† travailler l√†-bas, changer d'√©tat, intercepter des √©v√©nements.  Et au moment o√π le d√©marrage se produit, nous d√©clencherons l'√©v√©nement attach√© √† la vue, et le pr√©sentateur mettra √† jour l'interface utilisateur pour correspondre √† l'√©tat actuel. <br><br><img src="https://habrastorage.org/webt/fk/r6/op/fkr6op8zellkewd81kh7omqaxto.jpeg"><br><img src="https://habrastorage.org/webt/my/sb/t8/mysbt8ecs5ap56d5o_jyndzgp_a.jpeg"><br><br>  Il existe une m√©thode de lib√©ration, elle est g√©n√©ralement appel√©e dans onDestroy, vous effectuez un d√©tachement et lib√©rez √©galement des ressources. <br><br><img src="https://habrastorage.org/webt/f9/lg/-d/f9lg-db1fwe27xwd09pg1yltu44.jpeg"><br><br>  Une autre m√©thode setState importante.  Puisque nous pr√©voyons de changer l'interface utilisateur dans onEnter et onExit, il y a une v√©rification pour le thread principal.  Cela cr√©e une restriction pour nous que nous ne faisons rien de lourd ici, toutes les demandes doivent √™tre adress√©es √† l'interface utilisateur ou doivent √™tre asynchrones.  L'avantage de cet endroit est qu'ici nous pouvons r√©server l'entr√©e et la sortie de l'√©tat, c'est tr√®s utile lors du d√©bogage, par exemple, quand quelque chose ne va pas, vous pouvez voir comment le syst√®me a cliqu√© et comprendre ce qui n'allait pas. <br><br><img src="https://habrastorage.org/webt/sh/bx/nx/shbxnx_e_4myifye8ucidtdpj7e.jpeg"><br><br>  Quelques exemples de conditions.  Il existe un √©tat initial, il d√©clenche simplement le calcul de l'espace dont vous avez besoin pour lib√©rer au moment o√π la vue est devenue disponible.  Cela se produira apr√®s onStart.  D√®s que onStart se produit, nous entrons dans un nouvel √©tat et le syst√®me commence √† demander des donn√©es. <br><br><img src="https://habrastorage.org/webt/nt/cy/i3/ntcyi3chfp0yvgyiauig5gegy2c.jpeg"><br><br><img src="https://habrastorage.org/webt/f4/bq/j-/f4bqj-kaebdsnml-dpa-azvgrmm.jpeg"><br><br>  Un exemple de l'√©tat est Calcul, nous indiquerons la taille des fichiers avec stateOwner, il rampe en quelque sorte dans la base de donn√©es, puis il y a toujours un inValidateView, nous mettons √† jour l'interface utilisateur actuelle.  Et viewAttached est appel√© si la vue est rattach√©e.  Si nous √©tions en arri√®re-plan, le calcul √©tait en arri√®re-plan, nous retournons √† nouveau √† notre activit√©, cette m√©thode est appel√©e et met √† jour toutes les donn√©es. <br><br><img src="https://habrastorage.org/webt/eu/fg/5f/eufg5fb-rwg6keerfqik_skfo44.jpeg"><br><br>  Un exemple d'√©v√©nement, nous avons demand√© √† stateOwner combien de fichiers peuvent √™tre lib√©r√©s, et il appelle la m√©thode filesSizeUpdated.  Ici, j'√©tais trop paresseux, il √©tait possible d'√©crire trois m√©thodes distinctes, telles que mises √† jour, il y a autant d'anciens fichiers que de s√©parer diff√©rents √©v√©nements.  Mais vous devez comprendre, une fois que ce sera difficile pour vous, une fois que ce sera beaucoup plus simple.  Il n'est pas n√©cessaire de tomber dans une ing√©nierie excessive pour que chaque √©v√©nement soit une m√©thode distincte.  Vous pouvez vous en tirer avec un simple si, je ne vois rien de mal √† cela. <br><br><img src="https://habrastorage.org/webt/r0/ge/tx/r0getxszg4i3mwlruqqybl-mffm.jpeg"><br><br>  Je vois plusieurs am√©liorations potentielles.  Je n'aime pas que nous soyons oblig√©s de jeter nos mains autour de ces m√©thodes, telles que onStart, on Stop, onCreate, onSave, et plus encore.  Vous pouvez vous attacher √† Lifecycle, mais on ne sait pas quoi faire avec saveState.  Il y a une id√©e, par exemple, pour faire un fragment de pr√©sentateur.  Pourquoi pas?  Un fragment sans interface utilisateur qui rattrape le cycle de vie, et en g√©n√©ral alors nous n'aurons besoin de rien, tout volera jusqu'√† nous par lui-m√™me. <br><br>  Un autre point int√©ressant: ce pr√©sentateur est recr√©√© √† chaque fois, et si vous avez des donn√©es volumineuses stock√©es dans le pr√©sentateur, vous √™tes all√© √† la base de donn√©es, maintenez un √©norme curseur, alors il est inacceptable de demander chaque fois que vous faites pivoter l'√©cran.  Par cons√©quent, vous pouvez mettre en cache le pr√©sentateur, comme c'est le cas, par exemple, ViewModule √† partir des composants d'architecture, cr√©er un fragment qui contiendra le cache des pr√©sentateurs et les retourner pour chaque vue. <br><br>  Vous pouvez utiliser la m√©thode tabulaire pour sp√©cifier les machines √† √©tats, car le mod√®le d'√©tat que nous utilisons pr√©sente un inconv√©nient important: d√®s que vous devez ajouter une m√©thode √† un nouvel √©v√©nement, vous devez ajouter l'impl√©mentation √† tous les descendants.  Au moins vide.  Ou faites-le dans un √©tat de base.  Ce n'est pas tr√®s pratique.  Ainsi, la mani√®re tabulaire de sp√©cifier les machines √† √©tats est utilis√©e dans toutes les biblioth√®ques - si vous recherchez sur GitHub le mot FSM, vous trouverez un grand nombre de biblioth√®ques qui vous fournissent une sorte de g√©n√©rateur dans lequel vous d√©finissez l'√©tat initial, l'√©v√©nement et l'√©tat final.  L'expansion et la maintenance d'une telle machine d'√©tat sont beaucoup plus faciles. <br><br>  Un autre point int√©ressant: si vous utilisez le mod√®le d'√©tat, si votre machine d'√©tat commence √† se d√©velopper, vous devrez tr√®s probablement g√©rer certains √©v√©nements de la m√™me mani√®re afin que le code ne se copie pas, vous cr√©ez un √©tat de base.  Plus il y a d'√©v√©nements, plus les conditions de base commencent √† appara√Ætre, la hi√©rarchie se d√©veloppe et quelque chose tourne mal. <br><br>  Comme nous le savons, l'h√©ritage doit √™tre remplac√© par la d√©l√©gation, et les machines √† √©tats hi√©rarchiques aident √† r√©soudre ce probl√®me.  Vous avez des √©tats qui ne d√©pendent pas du niveau d'h√©ritage - cr√©ez simplement un arbre d'√©tats qui passe le gestionnaire ci-dessus.  Vous pouvez √©galement lire s√©par√©ment, une chose tr√®s utile.  Dans Android, par exemple, les machines √† √©tats hi√©rarchiques sont utilis√©es dans WatchDog Wi-Fi, qui surveille l'√©tat du r√©seau, elles sont l√†, directement dans la source Android. <br><br><img src="https://habrastorage.org/webt/kd/qn/cn/kdqncnx-u10ovabuexg_h-kdxiu.jpeg"><br><br>  Dernier point mais non le moindre.  Comment cela peut-il √™tre test√©?  Tout d'abord, les √©tats d√©terministes peuvent √™tre test√©s.  Il y a un √©tat s√©par√©, nous cr√©ons une instance, tirons la m√©thode onEnter et voyons que les valeurs correspondantes sont appel√©es dans la vue.  Ainsi, nous validons que notre √©tat met correctement √† jour la vue.  Si votre vue ne fait rien de grave, vous couvrirez tr√®s probablement un grand nombre de sc√©narios. <br><br><img src="https://habrastorage.org/webt/bc/mn/o_/bcmno_pvrehzh447tidyzn3nd5w.jpeg"><br><br>  Vous pouvez verrouiller certaines m√©thodes avec une fonction qui renvoie la taille, appeler un autre √©v√©nement apr√®s onEnter et voir comment un √©tat particulier r√©pond √† des √©v√©nements sp√©cifiques.  Dans ce cas, lorsque l'√©v√©nement filesSizeUpdated se produit et lorsque AllFilesSize est sup√©rieur √† z√©ro, nous devons passer au nouvel √©tat CleanAllFiles.  Avec l'aide de la mise en page, nous v√©rifions tout cela. <br><br><img src="https://habrastorage.org/webt/1z/pu/lp/1zpulp09kyd3vcr2xhcevmum4rm.jpeg"><br><br>  Et le dernier - nous pouvons tester l'ensemble du syst√®me.  Nous construisons l'√©tat, lui envoyons un √©v√©nement et v√©rifions le comportement du syst√®me.  Nous avons trois √©tapes de test.  ,   UI,  ,    ,   ,       . <br><br>      ,     70%.  80%     .  ,    . <br><br><img src="https://habrastorage.org/webt/tu/pz/qx/tupzqxbhu35qyqjpzhx0_xc6kxu.jpeg"><br><br>   ,   ?    ‚Äî . -        . <br><br> .        .   - ,   ,  -     ,   ‚Äî    ,          . <br><br>     -  ,  ,    ,    .    ,   ,     .    ,        ,     .    -    ,    ,   .    , ,   .     lock   .   - ,     . <br><br>   ‚Äî .   ,       ,           ,     ,   . ,   - , ,  -,    ,   .     ,      .   , . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418561/">https://habr.com/ru/post/fr418561/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418549/index.html">Cr√©ation d'un bot pour participer √† l'IA mini cup 2018 bas√© sur un r√©seau neuronal r√©current (partie 3)</a></li>
<li><a href="../fr418551/index.html">Combien un programmeur devrait-il conna√Ætre les math√©matiques?</a></li>
<li><a href="../fr418553/index.html">Kotlin + React contre Javasript + React</a></li>
<li><a href="../fr418557/index.html">Calcul des processus ondulatoires dans une conduite hydraulique √† l'aide de la m√©thode des caract√©ristiques</a></li>
<li><a href="../fr418559/index.html">NL2API: cr√©ation d'interfaces en langage naturel pour l'API Web</a></li>
<li><a href="../fr418563/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 263 (23 juillet - 29 juillet)</a></li>
<li><a href="../fr418565/index.html">En route vers une couverture de code √† 100% avec des tests dans Go en utilisant sql-dumper comme exemple</a></li>
<li><a href="../fr418567/index.html">Dell cessera d'√™tre une soci√©t√© priv√©e et, pour la premi√®re fois en 5 ans, mettra des actions en bourse</a></li>
<li><a href="../fr418569/index.html">Nouveaux satellites - nouveaux bugs: le capteur infrarouge satellite GOES-17 ne refroidit pas bien</a></li>
<li><a href="../fr418573/index.html">Waterius: Transf√©rez les relev√©s d'eau sur un t√©l√©phone via Wi-Fi (4 ans sur batterie)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>