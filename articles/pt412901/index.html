<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëàüèª üë©üèø‚Äçü§ù‚Äçüë®üèæ üâë Monitoramento e Kubernetes (revis√£o e reportagem em v√≠deo) üïé üíáüèº üëæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em 28 de maio, na confer√™ncia RootConf 2018, realizada como parte do festival RIT ++ 2018, na se√ß√£o "Logging and Monitoring", foi entregue um relat√≥ri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Monitoramento e Kubernetes (revis√£o e reportagem em v√≠deo)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/412901/">  Em 28 de maio, na confer√™ncia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RootConf</a> 2018, realizada como parte do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">festival</a> RIT ++ 2018, na se√ß√£o "Logging and Monitoring", foi entregue um relat√≥rio "Monitoring and Kubernetes".  Ele conta sobre a experi√™ncia de monitorar a instala√ß√£o com o Prometheus, que foi obtida por Flant como resultado da opera√ß√£o de dezenas de projetos Kubernetes em produ√ß√£o. <br><br><img src="https://habrastorage.org/webt/pm/o9/dm/pmo9dmnz9jf7b-yhej9shmir92q.jpeg"><br><br>  Por tradi√ß√£o, temos o prazer de apresentar um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><b>v√≠deo com um relat√≥rio</b></a> (cerca de uma hora, <b>muito mais</b> informativo <b>que o</b> artigo) e o aperto principal em forma de texto.  Vamos l√°! <a name="habracut"></a><br><br><h2>  O que √© monitoramento? </h2><br>  Existem muitos sistemas de monitoramento: <br><br><img src="https://habrastorage.org/webt/pa/07/i0/pa07i0ojuohdqwxbk6lvf86lgls.png"><br><br>  Parece que pegar e instalar um deles - isso √© tudo, a quest√£o est√° encerrada.  Mas a pr√°tica mostra que n√£o √© assim.  E aqui est√° o porqu√™: <br><br><ol><li>  <b>Veloc√≠metro mostra velocidade</b> .  Se medirmos a velocidade uma vez por minuto pelo veloc√≠metro, a velocidade m√©dia, calculada com base nesses dados, n√£o coincidir√° com os dados do od√¥metro.  E se, no caso de um carro, isso √© √≥bvio, ent√£o, quando se trata de muitos e muitos indicadores para o servidor, muitas vezes esquecemos. <br><img src="https://habrastorage.org/webt/s9/13/fv/s913fvrbguhqbp3iuuobwrmazt8.png"><br>  <i>O que medimos e como realmente viajamos</i> </li><li>  <b>Mais medi√ß√µes</b> .  Quanto mais indicadores <i>diferentes</i> obtivermos, mais preciso ser√° o diagn√≥stico dos problemas ... mas apenas com a condi√ß√£o de que sejam indicadores realmente √∫teis, e n√£o apenas tudo o que voc√™ conseguiu coletar. </li><li>  <b>Alertas</b> .  N√£o h√° nada complicado no envio de alertas.  No entanto, dois problemas t√≠picos: a) alarmes falsos ocorrem com tanta frequ√™ncia que paramos de responder a qualquer alerta; b) os alertas chegam em um momento em que √© tarde demais (tudo j√° explodiu).  E alcan√ßar no monitoramento que esses problemas n√£o surgiram √© arte genu√≠na! </li></ol><br>  O monitoramento √© um conjunto de tr√™s camadas, cada uma das quais √© cr√≠tica: <br><br><ol><li>  Antes de tudo, este √© um sistema que permite a <b>preven√ß√£o de acidentes</b> , a <b>notifica√ß√£o de acidentes</b> (se eles n√£o puderam ser evitados) e <b>o diagn√≥stico r√°pido de</b> problemas. </li><li>  O que √© necess√°rio para isso?  <b>Dados precisos</b> , <b>gr√°ficos √∫teis</b> (olhe para eles e entenda onde est√° o problema), <b>alertas relevantes</b> (cheguem na hora certa e contenham informa√ß√µes claras). </li><li>  E, para que tudo isso funcione, <b>√©</b> necess√°rio um <b>sistema de monitoramento</b> . </li></ol><br>  A configura√ß√£o adequada de um sistema de monitoramento que realmente funciona n√£o √© uma tarefa f√°cil, exigindo uma abordagem criteriosa da implementa√ß√£o, mesmo sem o Kubernetes.  Mas o que acontece com sua apar√™ncia? <br><br><h2>  Especifica√ß√µes de monitoramento do Kubernetes </h2><br><h3>  No. 1.  Maior e mais r√°pido </h3><br>  O Kubernetes est√° mudando bastante porque a infraestrutura est√° ficando maior e mais r√°pida.  Se anteriormente, com servidores comuns de ferro, seu n√∫mero era muito limitado e o processo de adi√ß√£o era muito longo (demorava dias ou semanas); ent√£o, nas m√°quinas virtuais, o n√∫mero de entidades aumentava significativamente e o tempo de sua introdu√ß√£o na batalha era reduzido para segundos. <br><br>  Com o Kubernetes, o n√∫mero de entidades cresceu em uma ordem de magnitude, sua adi√ß√£o √© totalmente automatizada (gerenciamento de configura√ß√£o √© necess√°rio, porque sem uma descri√ß√£o, um novo pod simplesmente n√£o pode ser criado), toda a infraestrutura se tornou muito din√¢mica (por exemplo, os pods s√£o exclu√≠dos e liberados toda vez s√£o criados novamente). <br><br><img src="https://habrastorage.org/webt/01/fv/cf/01fvcfbc_i2roepw7nh0q6womsk.png"><br><br>  O que isso muda? <br><br><ol><li>  Em princ√≠pio, paramos de observar vagens ou cont√™ineres individuais - agora estamos interessados <b>apenas em grupos de objetos</b> . </li><li>  <b>A descoberta de servi√ßos se torna estritamente obrigat√≥ria</b> , porque as "velocidades" j√° s√£o tais que, em princ√≠pio, n√£o podemos iniciar / excluir manualmente novas entidades, como antes, quando novos servidores foram comprados. </li><li>  <b>A quantidade de dados est√° crescendo significativamente</b> .  Se m√©tricas anteriores foram coletadas de servidores ou m√°quinas virtuais, agora de pods, cujo n√∫mero √© muito maior. </li><li>  A mudan√ßa mais interessante que chamei de " <b>fluxo de metadados</b> " e vou falar mais sobre isso. </li></ol><br>  Vou come√ßar com esta compara√ß√£o: <br><br><ul><li>  Quando voc√™ envia seu filho para o jardim de inf√¢ncia, ele recebe uma caixa pessoal, que √© atribu√≠da a ele para o pr√≥ximo ano (ou mais) e na qual seu nome √© indicado. </li><li>  Quando voc√™ chega √† piscina, seu arm√°rio n√£o √© assinado e √© emitido para voc√™ por uma "sess√£o". </li></ul><br>  Portanto, <b>os sistemas cl√°ssicos de monitoramento pensam que s√£o um jardim de inf√¢ncia</b> , n√£o uma piscina: eles assumem que o objeto de monitoramento os procurou para sempre ou por um longo tempo, e lhes d√£o arm√°rios de acordo.  Mas as realidades em Kubernetes s√£o diferentes: um pod chegou √† piscina (isto √©, foi criado), nadou (at√© uma nova implanta√ß√£o) e saiu (foi destru√≠do) - tudo isso acontece de forma r√°pida e regular.  Assim, o sistema de monitoramento deve entender que os objetos que monitora t√™m uma vida curta e devem ser capazes de esquec√™-lo completamente no momento certo. <br><br><h3>  No. 2.  A realidade paralela existe </h3><br>  Outro ponto importante - com o advento do Kubernetes, temos simultaneamente duas "realidades": <br><br><ol><li>  Kubernetes mundo em que existem namespaces, implanta√ß√µes, pods, cont√™ineres.  Este √© um mundo complexo, mas √© l√≥gico, estruturado. </li><li>  O mundo "f√≠sico", composto por muitos (literalmente - mont√µes) de cont√™ineres em cada n√≥. </li></ol><br><img src="https://habrastorage.org/webt/1p/wc/xj/1pwcxjjt1xbgwqufldfm1upua10.png"><br>  <i>Um e o mesmo cont√™iner na ‚Äúrealidade virtual‚Äù do Kubernetes (acima) e no mundo f√≠sico dos n√≥s (abaixo)</i> <br><br>  E no processo de monitoramento, precisamos <b>comparar</b> constantemente <b>o mundo f√≠sico dos cont√™ineres com a realidade do Kubernetes</b> .  Por exemplo, quando olhamos para algum espa√ßo para nome, queremos saber onde est√£o localizados todos os seus cont√™ineres (ou os cont√™ineres de uma de suas lareiras).  Sem isso, os alertas n√£o ser√£o visuais e convenientes de usar - porque √© importante entendermos quais objetos eles est√£o relatando. <br><br><img src="https://habrastorage.org/webt/2p/n7/3t/2pn73tojozunuxdnjiba8yqw7-y.png"><br>  <i>Diferentes tipos de alertas - o √∫ltimo √© mais visual e conveniente no trabalho do que o resto</i> <br><br>  <b>As conclus√µes</b> aqui s√£o: <br><br><ol><li>  O sistema de monitoramento deve usar as primitivas internas do Kubernetes. </li><li>  H√° mais de uma realidade: geralmente os problemas n√£o acontecem com a lareira, mas com um n√≥ espec√≠fico, e precisamos entender constantemente em que tipo de "realidade" eles est√£o. </li><li>  Em um cluster, como regra, existem v√°rios ambientes (al√©m da produ√ß√£o), o que significa que isso deve ser levado em considera√ß√£o (por exemplo, para n√£o receber alertas noturnos sobre problemas no desenvolvedor). </li></ol><br>  Portanto, temos tr√™s condi√ß√µes necess√°rias para que tudo d√™ certo: <br><br><ol><li>  Entendemos bem o que √© monitoramento. </li><li>  Conhecemos seus recursos, que aparecem no Kubernetes. </li><li>  Adotamos o Prometeu. </li></ol><br>  E assim, para realmente funcionar, resta apenas fazer <i>muito</i> esfor√ßo!  A prop√≥sito, por que exatamente Prometeu? <br><br><h2>  Prometeu </h2><br>  H√° duas maneiras de responder √† pergunta sobre a escolha do Prometheus: <br><br><ol><li>  Veja quem e o que geralmente √© usado para monitorar o Kubernetes. </li><li>  Considere suas vantagens t√©cnicas. </li></ol><br>  No primeiro, usei os dados da pesquisa do The New Stack (do e-book <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O estado do ecossistema Kubernetes</a> ), segundo o qual o Prometheus √© pelo menos mais popular do que outras solu√ß√µes (tanto de c√≥digo aberto quanto de SaaS), e, se voc√™ observar, possui uma vantagem estat√≠stica em cinco vezes . <br><br>  Agora vamos ver como o Prometheus funciona, em paralelo com a forma como seus recursos se combinam com o Kubernetes e resolvem desafios relacionados. <br><br><h2>  Como o Prometheus est√° estruturado? </h2><br>  O Prometheus √© escrito em Go e distribu√≠do como um √∫nico arquivo bin√°rio, no qual tudo est√° embutido.  O algoritmo b√°sico para sua opera√ß√£o √© o seguinte: <br><br><img src="https://habrastorage.org/webt/nh/xt/hp/nhxthp-dm3wveymrgbejbanainw.png"><br><br><ul><li>  <b>O coletor</b> l√™ a <b>tabela de destinos</b> , ou seja,  uma lista de objetos a serem monitorados e a frequ√™ncia de suas pesquisas (por padr√£o - 60 segundos). </li><li>  Depois disso, o coletor envia uma solicita√ß√£o HTTP para cada pod de que voc√™ <b>precisa</b> e recebe uma resposta com um conjunto de m√©tricas - pode haver cem, mil, dez mil ... Cada m√©trica possui um nome, valor e <b>r√≥tulos</b> . </li><li>  A resposta recebida √© <b>armazenada</b> no banco de dados <b>TSDB</b> , onde o <b>registro de</b> data e hora do recebimento e os r√≥tulos do objeto do qual foi retirado s√£o adicionados aos dados m√©tricos recebidos. <br><br><div class="spoiler">  <b class="spoiler_title">Brevemente sobre TSDB</b> <div class="spoiler_text">  <i>TSDB - banco de dados de s√©ries temporais (DB para s√©ries temporais) on Go, que permite armazenar dados por um n√∫mero especificado de dias e o faz com muita efici√™ncia (em tamanho, mem√≥ria e entrada / sa√≠da).</i>  <i>Os dados s√£o armazenados apenas localmente, sem cluster e replica√ß√£o, o que √© um plus (funciona de maneira simples e garantida) e um sinal de menos (n√£o h√° dimensionamento horizontal do armazenamento), mas, no caso do Prometheus, o sharding √© bem feito, federa√ß√£o - mais sobre isso posteriormente.</i> <br></div></div></li><li>  Apresentado no esquema, o <b>Service Discovery</b> √© um mecanismo de descoberta de servi√ßo integrado ao Prometheus que permite receber dados (por meio da API Kubernetes) para criar uma tabela de objetivos pronta para uso. </li></ul><br>  Como √© esta tabela?  Para cada entrada, ele armazena o URL usado para obter m√©tricas, a frequ√™ncia de chamadas e r√≥tulos. <br><br><img src="https://habrastorage.org/webt/xu/9m/c_/xu9mc_ikwk-sdzkrs_fjt6lsfj0.png"><br><br>  Os r√≥tulos s√£o usados ‚Äã‚Äãpara justapor os "mundos" de Kubernetes com o f√≠sico.  Por exemplo, para encontrar um pod com o Redis, precisamos ter o namespace dos valores, o servi√ßo (usado em vez da implanta√ß√£o devido aos recursos t√©cnicos de um caso espec√≠fico) e o pod real.  Assim, esses tr√™s r√≥tulos s√£o armazenados nas entradas da tabela de metas para as m√©tricas do Redis. <br><br>  Essas entradas na tabela s√£o formadas com base na <code>scrape_configs</code> do Prometheus na qual os objetos de monitoramento s√£o descritos: na se√ß√£o <code>scrape_configs</code> , <code>scrape_configs</code> definidas, indicando por quais r√≥tulos procurar objetos para monitorar, como filtr√°-los e quais r√≥tulos devem ser registrados. <br><br><h2>  Quais dados o Kubernetes coleta? </h2><br><ul><li>  Primeiro, o <b>assistente</b> no Kubernetes √© bastante complicado - e √© essencial monitorar o estado de seu trabalho (kube-apiserver, kube-controller-manager, kube-scheduler, kube-scheduler, kube-etcd3 ...); al√©m disso, est√° vinculado ao n√≥ do cluster. </li><li>  Em segundo lugar, √© importante saber o que est√° acontecendo no <b>Kubernetes.Para</b> fazer isso, obtemos dados de: <br><ul><li>  <i>kubelet</i> - esse componente Kubernetes est√° sendo executado em cada n√≥ do cluster (e se conecta ao assistente do K8s);  o cAdvisor √© incorporado a ele (todas as m√©tricas por cont√™ineres) e tamb√©m armazena informa√ß√µes sobre volumes persistentes conectados; </li><li>  <i>m√©tricas do estado do kube</i> - na verdade, este √© o Exportador do Prometheus para a API do Kubernetes (permite obter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">informa√ß√µes sobre objetos</a> armazenados no Kubernetes: pods, servi√ßos, implanta√ß√µes etc.); por exemplo, n√£o saberemos sem ele status de cont√™iner ou lareira); </li><li>  <i>exportador de n√≥</i> - fornece informa√ß√µes sobre o pr√≥prio n√≥, m√©tricas b√°sicas no sistema Linux (CPU, diskstats, meminfo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">etc.</a> ). </li></ul></li><li>  A seguir, est√£o os <b>componentes do Kubernetes</b> , como kube-dns, kube-prometheus-operator e kube-prometheus, ingress-nginx-controller, etc. </li><li>  A pr√≥xima categoria de objetos a monitorar √© na verdade o <b>software</b> lan√ßado no Kubernetes.  Esses s√£o servi√ßos t√≠picos de servidor como nginx, php-fpm, Redis, MongoDB, RabbitMQ ... Fazemos isso sozinhos para que, quando adicionamos determinados r√≥tulos ao servi√ßo, ele automaticamente comece a coletar os dados necess√°rios, o que cria o painel atual no Grafana. </li><li>  Por fim, a categoria para todo o resto √© <b>personalizada</b> .  As ferramentas do Prometheus permitem automatizar a coleta de m√©tricas arbitr√°rias (por exemplo, o n√∫mero de pedidos) adicionando simplesmente um r√≥tulo de <code>prometheus-custom-target</code> √† descri√ß√£o do servi√ßo. </li></ul><br><img src="https://habrastorage.org/webt/0s/e6/c3/0se6c3ygspys909x3ju6m9aq7uu.gif"><br><h2>  Gr√°ficos </h2><br>  Os dados recebidos <i>(descritos acima) s√£o</i> usados ‚Äã‚Äãpara enviar alertas e criar gr√°ficos.  <b>Desenhamos</b> gr√°ficos usando <b>Grafana</b> .  E um "detalhe" importante aqui √© o <b>PromQL</b> , a linguagem de consulta do Prometheus que se integra perfeitamente ao Grafana. <br><br><img src="https://habrastorage.org/webt/_a/sl/7w/_asl7wbfscz1eyxstacdij_liio.png"><br><br>  √â bastante simples e conveniente para a maioria das tarefas <i>(mas, por exemplo, juntar jun√ß√µes j√° √© inconveniente, mas voc√™ ainda precisa)</i> .  O PromQL permite que voc√™ resolva todas as tarefas necess√°rias: selecione rapidamente as m√©tricas necess√°rias, compare valores, realize opera√ß√µes aritm√©ticas nelas, agrupe, trabalhe com intervalos de tempo e muito mais.  Por exemplo: <br><br><img src="https://habrastorage.org/webt/3h/1d/0v/3h1d0vskm__dosoxpx1rzd5jis8.png"><br><br>  Al√©m disso, o Prometheus possui um <b>Avaliador</b> , que, usando o mesmo PromQL, pode acessar o TSDB com a frequ√™ncia especificada.  Por que isso?  Exemplo: comece a enviar alertas nos casos em que, de acordo com as m√©tricas dispon√≠veis, tivermos um erro 500 no servidor da web nos √∫ltimos 5 minutos.  Al√©m dos r√≥tulos que estavam na solicita√ß√£o, o Avaliador adiciona outros dados aos alertas (como configuramos), ap√≥s o que s√£o enviados no formato JSON para outro componente do Prometheus - <b>Alertmanager</b> . <br><br>  O Prometheus periodicamente (uma vez a cada 30 segundos) envia alertas ao Alertmanager, que os deduplica (tendo recebido o primeiro alerta, ele ser√° enviado e os pr√≥ximos n√£o ser√£o enviados novamente). <br><br><img src="https://habrastorage.org/webt/ju/0e/lg/ju0elg1u57wtxfjopy6wz38vtfg.png"><br><br>  <i><b>Nota</b> : N√≥s n√£o usamos o Alertmanager em casa, mas enviamos dados do Prometheus diretamente para o nosso sistema, com o qual nossos atendentes trabalham, mas isso n√£o importa no esquema geral.</i> <br><br><h2>  Prometeu em Kubernetes: o panorama geral </h2><br>  Agora vamos ver como esse pacote completo do Prometheus funciona no Kubernetes: <br><br><img src="https://habrastorage.org/webt/w-/gu/ue/w-guue_2b8q12romg-qv7uw2hpi.png"><br><br><ul><li>  O Kubernetes possui seu pr√≥prio namespace para Prometheus <i>(temos o <code>kube-prometheus</code> na ilustra√ß√£o)</i> . </li><li>  Esse espa√ßo para nome hospeda o pod com a instala√ß√£o do Prometheus, que a cada 30 segundos coleta m√©tricas de todos os destinos recebidos por meio da descoberta de servi√ßos no cluster. </li><li>  Ele tamb√©m abriga um pod com o Alertmanager, que recebe dados do Prometheus e envia alertas <i>(para correio, Slack, PagerDuty, WeChat, integra√ß√£o de terceiros e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">assim por diante</a> )</i> . </li><li>  O Prometheus est√° enfrentando um balanceador de carga - um servi√ßo regular em Kubernetes - e o Grafana acessa o Prometheus por meio dele.  Para <b>garantir a toler√¢ncia a falhas, o Prometheus</b> usa v√°rios pods com instala√ß√µes do Prometheus, cada um dos quais coleta todos os dados e os armazena em seu TSDB.  Atrav√©s do balanceador, Grafana atinge um deles. </li><li>  O n√∫mero de pods com o Prometheus √© controlado pela configura√ß√£o <i>StatefulSet</i> - geralmente fazemos no m√°ximo dois pods, mas voc√™ pode aumentar esse n√∫mero.  Da mesma forma, o Alertmanager √© implantado atrav√©s do StatefulSet, cuja toler√¢ncia a falhas √© necess√°ria pelo menos 3 pods (j√° que √© necess√°rio um quorum para tomar decis√µes sobre o envio de alertas). <br></li></ul><br>  O que est√° faltando aqui? .. <br><br><h2>  Federa√ß√£o para Prometeu </h2><br>  Quando os dados s√£o coletados a cada 30 (ou 60) segundos, o local para armazen√°-los rapidamente termina e, pior ainda, requer muitos recursos de computa√ß√£o (ao receber e processar um n√∫mero t√£o grande de pontos do TSDB).  Mas queremos armazenar e ter a capacidade de baixar informa√ß√µes por <b>grandes <i>e</i> e intervalos de tempo</b> .  Como conseguir isso? <br><br>  √â suficiente adicionar <b>mais uma instala√ß√£o do Prometheus</b> (a <i>longo prazo</i> ) ao esquema geral, no qual o Service Discovery est√° desabilitado, e na tabela de objetivos h√° o √∫nico registro est√°tico que leva ao Prometheus <i>principal</i> ( <i>principal</i> ).  <b>Isso √© poss√≠vel gra√ßas √† <a href="">federa√ß√£o</a></b> : o Prometheus permite retornar os valores mais recentes de todas as m√©tricas em uma √∫nica consulta.  Portanto, a primeira instala√ß√£o do Prometheus ainda funciona (acessa a cada 60 ou, por exemplo, 30 segundos) a todos os destinos no cluster Kubernetes e a segunda - uma vez a cada 5 minutos, recebe dados do primeiro e o armazena para poder assistir dados por um longo per√≠odo ( mas sem detalhes profundos). <br><br><img src="https://habrastorage.org/webt/zc/uj/k3/zcujk3s5oxler1lhwaaswadmiyy.png"><br>  <i>A segunda instala√ß√£o do Prometheus n√£o precisa do Service Discovery e a tabela de objetivos consistir√° em uma linha</i> <br><br><img src="https://habrastorage.org/webt/od/zr/ow/odzrowlvdyq3qmhfldvy085naou.png"><br>  <i>O quadro completo com as instala√ß√µes do Prometheus de dois tipos: principal (superior) e de longo prazo</i> <br><br>  O toque final √© <b>conectar o Grafana</b> √†s instala√ß√µes do Prometheus e criar pain√©is de maneira especial para que voc√™ possa alternar entre as fontes de dados ( <i>principal</i> ou a <i>longo prazo</i> ).  Para fazer isso, usando o mecanismo de modelo, substitua a vari√°vel <code>$prometheus</code> vez da fonte de dados em todos os pain√©is. <br><br><img src="https://habrastorage.org/webt/ju/v3/9u/juv39un0v2qdtwegrt07qpg-1yi.png"><br><br><h2>  O que mais √© importante nos gr√°ficos? </h2><br>  Dois pontos-chave a serem considerados na organiza√ß√£o de agendas s√£o o suporte √†s primitivas do Kubernetes e a capacidade de <b>detalhar</b> rapidamente da imagem geral (ou uma "exibi√ß√£o" inferior)) para um servi√ßo espec√≠fico e vice-versa. <br><br>  O suporte a primitivos (namespaces, pods etc.) j√° foi mencionado - essa √© uma condi√ß√£o necess√°ria em princ√≠pio para um trabalho confort√°vel nas realidades do Kubernetes.  E aqui est√° um exemplo sobre drill down: <br><br><ul><li>  Observamos os gr√°ficos do consumo de recursos em tr√™s projetos (ou seja, tr√™s espa√ßos para nome) - vemos que a parte principal da CPU (ou mem√≥ria, ou rede, ...) fica no projeto A. </li><li>  Observamos os mesmos gr√°ficos, mas j√° para os servi√ßos do Projeto A: qual deles consome mais CPU? </li><li>  Passamos aos gr√°ficos do servi√ßo desejado: qual pod √© "culpado"? </li><li>  Passamos aos gr√°ficos do grupo desejado: qual recipiente √© o "culpado"?  Este √© o objetivo desejado! </li></ul><br><img src="https://habrastorage.org/webt/fq/vb/ly/fqvblyn0wdnoqqzqgwi0ublftjy.png"><br><h2>  Sum√°rio </h2><br><ul><li>  Declare com precis√£o o que √© o monitoramento.  <i>(Deixe o ‚Äúbolo de tr√™s camadas‚Äù servir como um lembrete disso ... assim como o fato de que assar com compet√™ncia n√£o √© f√°cil, mesmo sem o Kubernetes!)</i> </li><li>  Lembre-se de que o Kubernetes adiciona especifica√ß√µes obrigat√≥rias: agrupamento de destinos, descoberta de servi√ßos, grandes quantidades de dados, fluxo de metadados.  Al√©m disso: <br><ul><li>  sim, alguns deles s√£o magicamente resolvidos em Prometeu; </li><li>  no entanto, resta outra parte que precisa ser monitorada de maneira independente e cuidadosa. </li></ul></li></ul><br>  E lembre-se de que o <b>conte√∫do √© mais importante que um sistema</b> , ou seja,  gr√°ficos e alertas corretos s√£o prim√°rios, e n√£o o Prometheus (ou qualquer outro software similar) como tal. <br><br><img src="https://habrastorage.org/webt/ml/61/ou/ml61oub7wmavnyfdmjepkm7bd-y.png"><br><br><h2>  V√≠deos e slides </h2><br>  V√≠deo da apresenta√ß√£o (cerca de uma hora): <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/zj6SlzzBRaA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Apresenta√ß√£o do relat√≥rio: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/https://translate" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h2>  PS </h2><br>  Outros relat√≥rios em nosso blog: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bancos de dados e Kubernetes</a> ";  <i>(Dmitry Stolyarov; 8 de novembro de 2018 no HighLoad ++)</i> ; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Melhores pr√°ticas de CI / CD com Kubernetes e GitLab</a> ‚Äù;  <i>(Dmitry Stolyarov; 7 de novembro de 2017 no HighLoad ++)</i> ; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Nossa experi√™ncia com o Kubernetes em pequenos projetos</a> ‚Äù;  <i>(Dmitry Stolyarov; 6 de junho de 2017 na RootConf)</i> ; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Coletamos imagens do Docker para CI / CD de forma r√°pida e conveniente com o dapp</a> ‚Äù <i>(Dmitry Stolyarov; 8 de novembro de 2016 no HighLoad ++)</i> ; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pr√°ticas de entrega cont√≠nua com Docker</a> ‚Äù <i>(Dmitry Stolyarov; 31 de maio de 2016 na RootConf)</i> . </li></ul><br>  Voc√™ tamb√©m pode estar interessado nas seguintes publica√ß√µes: <br><br><ul><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O dispositivo e mecanismo de opera√ß√£o do Operador Prometheus em Kubernetes</a> ‚Äù; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Monitoramento com Prometheus em Kubernetes em 15 minutos</a> ‚Äù; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Infraestrutura com o Kubernetes como um servi√ßo acess√≠vel</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt412901/">https://habr.com/ru/post/pt412901/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt412891/index.html">E / S do Citrix XenServer 7.0 n√£o otimizada Agente de Gerenciamento n√£o instalado</a></li>
<li><a href="../pt412893/index.html">Para alcan√ßar um programador s√™nior em quatro anos: o m√©todo "Escola 21"</a></li>
<li><a href="../pt412895/index.html">Vesta Matveeva: a luta contra o cibercrime √© uma escolha moral</a></li>
<li><a href="../pt412897/index.html">Monitorando produtos Atlassian com Prometheus</a></li>
<li><a href="../pt412899/index.html">Leitura de fim de semana: 30 materiais sobre som, a hist√≥ria das marcas de √°udio e a ind√∫stria cinematogr√°fica</a></li>
<li><a href="../pt412903/index.html">Como pintamos Habr</a></li>
<li><a href="../pt412905/index.html">Sobre a LL Parsing: uma abordagem para analisar atrav√©s do conceito de corte de cordas</a></li>
<li><a href="../pt412911/index.html">Desenvolvedores falam sobre recursos cortados de jogos</a></li>
<li><a href="../pt412913/index.html">"Baikal-T1" foi colocado √† venda por 3990 rublos</a></li>
<li><a href="../pt412915/index.html">Determina√ß√£o da densidade do g√°s a partir dos resultados da medi√ß√£o de press√£o e temperatura com sensores Arduino</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>