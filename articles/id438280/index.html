<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍👨‍👦 👩🏻‍✈️ 🥇 "Menghapus" objek di Django ♨️ 🌫️ 🍧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cepat atau lambat, pengembang menghadapi tugas menghapus data yang tidak perlu. Dan semakin rumit layanannya, semakin banyak nuansa yang perlu Anda pe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>"Menghapus" objek di Django</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/438280/"><img src="https://habrastorage.org/webt/6h/-4/-w/6h-4-wzp5wlydal3wkp2df8aq5a.jpeg"><br><br>  Cepat atau lambat, pengembang menghadapi tugas menghapus data yang tidak perlu.  Dan semakin rumit layanannya, semakin banyak nuansa yang perlu Anda pertimbangkan.  Pada artikel ini, saya akan menjelaskan bagaimana kami menerapkan "penghapusan" dalam database dengan ratusan tautan. <br><a name="habracut"></a><br><h2>  Latar belakang </h2><br>  Untuk memantau operasi sebagian besar proyek, <b>Mail.ru Group</b> dan <b>VKontakte</b> menggunakan layanan pengembangan mereka sendiri - <b>Pemantauan</b> .  Memulai sejarahnya dari akhir 2012, lebih dari 6 tahun proyek ini telah berkembang menjadi sistem besar, yang telah memperoleh banyak fungsi.  Pemantauan secara teratur memeriksa ketersediaan server dan kebenaran tanggapan terhadap permintaan, mengumpulkan statistik pada memori yang digunakan, pemanfaatan CPU, dll.  Ketika parameter dari server yang dipantau melebihi nilai yang diizinkan, mereka yang bertanggung jawab untuk server menerima pemberitahuan di sistem dan melalui SMS. <br><br>  Semua pemeriksaan dan insiden dicatat untuk melacak dinamika kinerja server, sehingga database telah mencapai urutan ratusan juta catatan.  Server baru muncul secara berkala, dan yang lama tidak lagi digunakan.  Informasi tentang server yang tidak digunakan harus dihapus dari sistem Pemantauan untuk: <i>a) tidak membebani antarmuka dengan informasi yang tidak perlu,</i> dan <i>b) melepaskan pengidentifikasi unik</i> . <br><br><h2>  Hapus </h2><br>  Saya sadar dalam judul artikel kata "delete" ditulis dalam tanda kutip.  Ada beberapa cara untuk menghapus objek dari sistem: <br><br><ul><li>  sepenuhnya dihapus dari basis data; </li><li>  menandai objek sebagai terhapus dan bersembunyi dari antarmuka.  Sebagai penanda, Anda dapat menggunakan Boolean, atau DateTime untuk pencatatan yang lebih akurat. </li></ul><br><h4>  Iterasi # 1 </h4><br>  Awalnya, pendekatan pertama digunakan, ketika kita cukup mengeksekusi <code>object.delete()</code> dan objek itu dihapus dengan semua dependensi.  Tetapi seiring berjalannya waktu, kami harus meninggalkan pendekatan ini, karena satu objek dapat memiliki ketergantungan dengan jutaan objek lainnya, dan penghapusan cascading tabel yang diblokir secara kaku.  Dan karena layanan melakukan ribuan cek setiap detik dan mencatatnya, memblokir tabel menyebabkan perlambatan serius dalam layanan, yang tidak dapat diterima bagi kami. <br><br><h4>  Iterasi # 2 </h4><br>  Untuk menghindari kunci panjang, kami memutuskan untuk menghapus data dalam batch.  Ini akan memungkinkan perekaman data pemantauan aktual dalam interval antara penghapusan objek.  Daftar semua objek yang akan dihapus dalam kaskade dapat diperoleh dengan metode yang digunakan di panel admin saat menghapus objek (saat mengkonfirmasi penghapusan): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.contrib.admin.util <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> NestedObjects <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.db <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DEFAULT_DB_ALIAS collector = NestedObjects(using=DEFAULT_DB_ALIAS) collector.collect([obj]) objects_to_delete = collector.nested() <span class="hljs-comment"><span class="hljs-comment"># Recursive delete objects</span></span></code> </pre> <br>  Situasi membaik: beban didistribusikan seiring waktu, data baru mulai direkam lebih cepat.  Tapi kami segera berlari ke perangkap berikutnya.  Faktanya adalah bahwa daftar objek yang akan dihapus dibentuk pada awal penghapusan, dan jika objek dependen baru ditambahkan dalam proses penghapusan "sebagian", elemen induk tidak dapat dihapus. <br><br>  Kami segera meninggalkan ide kesalahan dalam penghapusan rekursif untuk mengumpulkan kembali data pada dependensi baru atau melarang menambahkan catatan dependen saat menghapus, karena <i>a) Anda dapat masuk ke loop tak terbatas</i> atau <i>b) Anda harus menemukan semua objek dependen dalam seluruh kode</i> . <br><br><h4>  Iterasi # 3 </h4><br>  Kami memikirkan penghapusan tipe kedua, saat data ditandai dan disembunyikan dari antarmuka.  Awalnya, pendekatan ini ditolak, karena sepertinya tugas setidaknya selama seminggu untuk menemukan semua pertanyaan dan menambahkan filter karena tidak adanya orang tua yang dihapus.  Selain itu, ada kemungkinan besar kehilangan kode yang diperlukan, yang akan menyebabkan konsekuensi yang tidak terduga. <br><br>  Kemudian kami memutuskan untuk menggunakan dekorator untuk mengganti manajer kueri.  Lebih jauh lebih baik melihat kode daripada menulis seratus kata. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exclude_objects_for_deleted_hosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*fields)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Decorator that adds .exclude({field__}is_deleted=True) for model_class.objects.get_queryset :param fields: fields for exclude condition """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(model_class)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply_filters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(qs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> field <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filter_fields: qs = qs.exclude(**{ <span class="hljs-string"><span class="hljs-string">'{}is_deleted'</span></span>.format(<span class="hljs-string"><span class="hljs-string">'{}__'</span></span>.format(field) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> field <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> qs model_class.all_objects = copy.deepcopy(model_class.objects) filter_fields = set(fields) get_queryset = model_class.objects.get_queryset model_class.objects.get_queryset = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: apply_filters(get_queryset()) <span class="hljs-comment"><span class="hljs-comment"># save info about model decorator setattr(model_class, DECORATOR_DEL_HOST_ATTRIBUTE, filter_fields) return model_class return wrapper</span></span></code> </pre><br>  <code>exclude_objects_for_deleted_hosts(fields)</code> untuk bidang yang ditentukan dari model bidang secara otomatis menambahkan filter <code>exclude</code> untuk setiap permintaan, yang hanya menghilangkan entri yang tidak boleh ditampilkan di antarmuka. <br><br>  Sekarang sudah cukup bagi semua model yang akan terkena dampak karena beberapa cara untuk menambahkan dekorator: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@exclude_objects_for_deleted_hosts('host') class Alias(models.Model): host = models.ForeignKey(to=Host, verbose_name='Host', related_name='alias')</span></span></code> </pre><br>  Sekarang, untuk menghapus objek <code>Host</code> , cukup ubah atribut <code>is_deleted</code> : <br><br><pre> <code class="python hljs">host.is_deleted = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-comment"><span class="hljs-comment"># after this save the host and all related objects will be inaccessible host.save()</span></span></code> </pre> <br>  Semua kueri akan secara otomatis mengecualikan catatan yang merujuk objek jarak jauh: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># model decorator @exclude_objects_for_deleted_hosts('checker__monhost', 'alias__host') CheckerToAlias.objects.filter( alias__hostname__in=['cloud.spb.s', 'cloud.msk.s'] ).values('id')</span></span></code> </pre><br>  Ternyata permintaan SQL berikut: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> monitoring_checkertoalias.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> monitoring_checkertoalias <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> monitoring_checker <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`monitoring_checkertoalias`</span></span>.<span class="hljs-string"><span class="hljs-string">`checker_id`</span></span> = monitoring_checker.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Hosts</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`monitoring_checker`</span></span>.<span class="hljs-string"><span class="hljs-string">`monhost_id`</span></span> = Hosts.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dcmap_alias <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`monitoring_checkertoalias`</span></span>.<span class="hljs-string"><span class="hljs-string">`alias_id`</span></span> = dcmap_alias.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Hosts</span></span> T5 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`dcmap_alias`</span></span>.<span class="hljs-string"><span class="hljs-string">`host_id`</span></span> = T5.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (<span class="hljs-string"><span class="hljs-string">`Hosts`</span></span>.<span class="hljs-string"><span class="hljs-string">`is_deleted`</span></span> = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- ,   monitoring_checker AND NOT (T5.`is_deleted` = TRUE) -- ,   dcmap_alias AND dcmap_alias.name IN ('dir1.server.p', 'dir2.server.p') );</span></span></code> </pre> <br>  Seperti yang Anda lihat, <code>`is_deleted` = TRUE</code> tambahan untuk bidang yang ditentukan dalam dekorator dan pemeriksaan untuk <code>`is_deleted` = TRUE</code> ditambahkan ke permintaan. <br><br><h2>  Sedikit tentang angka </h2><br>  Adalah logis bahwa bergabung dan kondisi tambahan meningkatkan waktu eksekusi permintaan.  Studi tentang masalah ini menunjukkan bahwa tingkat "komplikasi" tergantung pada struktur database, jumlah catatan, dan keberadaan indeks. <br><br>  Secara khusus, dalam kasus kami, untuk setiap tingkat ketergantungan permintaan didenda sekitar 30%.  Ini adalah penalti maksimum yang kami dapatkan di meja terbesar dengan jutaan catatan, pada tabel yang lebih kecil, penalti dikurangi menjadi beberapa persen.  Untungnya, kami memiliki indeks yang perlu dikonfigurasi, dan untuk sebagian besar pertanyaan kritis, gabungan yang diperlukan sudah ada di sana, jadi kami tidak merasakan perbedaan besar dalam kinerja. <br><br><h2>  Pengidentifikasi unik </h2><br>  Sebelum menghapus data, mungkin perlu untuk membebaskan pengidentifikasi yang direncanakan untuk digunakan di masa depan, karena ini dapat menimbulkan kesalahan non-unik saat membuat objek baru.  Terlepas dari kenyataan bahwa tidak ada objek yang akan terlihat di aplikasi Django, mereka masih akan ada di database.  Oleh karena itu, untuk objek yang dihapus, kami menambahkan uuid ke pengidentifikasi. <br><br><pre> <code class="python hljs">host.hostname = <span class="hljs-string"><span class="hljs-string">'{}_{}'</span></span>.format(host.hostname, uuid.uuid4()) host.is_deleted = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> host.save()</code> </pre><br><h2>  Operasi </h2><br>  Untuk setiap model atau ketergantungan baru, dekorator perlu diperbarui jika perlu.  Untuk menyederhanakan pencarian model dependen, kami menulis tes "pintar": <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_deleted_host_decorator_for_models</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">recursive_host_finder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(model, cache, path, filters)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># cache for skipping looked models cache.add(model) # process all related models for field in (f for f in model._meta.fields if isinstance(f, ForeignKey)): if field.related_model == Host: filters.add(path + field.name) elif field.related_model not in cache: recursive_host_finder(field.related_model, cache.copy(), path + field.name + '__', filters) # check all models for current_model in apps.get_models(): model_filters = getattr(current_model, DECORATOR_DEL_HOST_ATTRIBUTE, set()) found_filters = set() if current_model == Host: found_filters.add('') else: recursive_host_finder(current_model, set(), '', found_filters) if found_filters or model_filters: try: self.assertSetEqual(model_filters, found_filters) except AssertionError as err: err.args = ( '{}\n !!! Fix decorator "exclude_objects_for_deleted_hosts" ' 'for model {}'.format(err.args[0], current_model), ) raise err</span></span></code> </pre><br>  Tes secara rekursif memeriksa semua model apakah ada ketergantungan pada model yang akan dihapus, kemudian terlihat untuk melihat apakah dekorator untuk bidang yang diperlukan telah ditetapkan untuk model ini.  Jika ada sesuatu yang hilang, tes akan dengan lembut memberi tahu Anda di mana harus menambahkan dekorator. <br><br><h2>  Epilog </h2><br>  Dengan demikian, dengan bantuan dekorator, dimungkinkan untuk menerapkan "penghapusan kecil" data yang memiliki banyak dependensi.  Semua permintaan secara otomatis menerima filter <code>exclude</code> diperlukan.  Pengenaan kondisi tambahan memperlambat proses memperoleh data, tingkat "komplikasi" tergantung pada struktur database, jumlah catatan, dan ketersediaan indeks.  Tes yang diusulkan akan memberi tahu Anda model mana yang perlu Anda tambahkan dekorator, dan di masa depan akan memantau konsistensi mereka. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id438280/">https://habr.com/ru/post/id438280/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id438266/index.html">Mengapa pentesting penting untuk bisnis Anda?</a></li>
<li><a href="../id438270/index.html">Love Kubernetes di Mail.ru Group: 14 Februari</a></li>
<li><a href="../id438272/index.html">Bagaimana kami mengirim SMS dari gua</a></li>
<li><a href="../id438274/index.html">Definisi "kepribadian beracun" di TI</a></li>
<li><a href="../id438278/index.html">Mengajar anak-anak ke program</a></li>
<li><a href="../id438286/index.html">Bekerja dengan zona waktu dalam JavaScript</a></li>
<li><a href="../id438288/index.html">Perlindungan tanpa rasa takut. Keamanan Memori dalam Karat</a></li>
<li><a href="../id438290/index.html">Post-mortem dengan GGJ-2019: bagaimana cara mendapatkan gundukan, tetapi tetap membuat game</a></li>
<li><a href="../id438292/index.html">Otomasi Apartemen dengan HomePod, Raspberry Pi dan Node.js</a></li>
<li><a href="../id438294/index.html">Menemukan Stream Twitch dalam Pertandingan PUBG</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>