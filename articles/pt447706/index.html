<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüîß üâê ü§Ωüèº Nem um √∫nico ORM ‚õπÔ∏è üñ•Ô∏è üö¥üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nem um √∫nico ORM 


 Ol√° pessoal! Sou respons√°vel pelo departamento de Desenvolvimento de parceiros do servi√ßo de reservas de hot√©is Ostrovok.ru . Nes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nem um √∫nico ORM</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/447706/"><h1 id="ne-ormom-edinym">  Nem um √∫nico ORM </h1><br><p>  Ol√° pessoal!  Sou respons√°vel pelo departamento de Desenvolvimento de parceiros do servi√ßo de reservas de hot√©is <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ostrovok.ru</a> .  Neste artigo, gostaria de falar sobre como usamos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Django ORM</a> em um projeto. </p><br><p>  Na verdade, eu estava enganando, o nome deveria ter sido " <del>  N√£o </del>  ORM single ". Se voc√™ est√° se perguntando por que escrevi isso, bem como se: </p><br><ul><li> Voc√™ tem Django na pilha e deseja <code>Model.objects.all()</code> o m√°ximo do ORM, n√£o apenas <code>Model.objects.all()</code> , </li><li>  Voc√™ deseja transferir parte da l√≥gica de neg√≥cios para o n√≠vel do banco de dados, </li><li>  Ou voc√™ deseja descobrir por que a desculpa mais frequente para desenvolvedores no B2B.Ostrovok.ru √© <em>"t√£o historicamente"</em> , </li></ul><br><p>  ... bem vindo ao gato. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/66b/308/b1c/66b308b1cd5afefead46ef7bffdbbddf.jpg" alt="cdpv"></p><a name="habracut"></a><br><p>  Em 2014, lan√ßamos o B2B.Ostrovok.ru - um servi√ßo de reservas on-line de hot√©is, transfers, carros e outros servi√ßos de viagens para profissionais do mercado de turismo (agentes de viagens, operadoras e clientes corporativos). </p><br><p>  No B2B, projetamos e usamos com sucesso um modelo de pedido abstrato com base na meta-ordem <code>MetaOrder</code> - <code>MetaOrder</code> . </p><br><p>  Uma meta-ordem √© uma entidade abstrata que pode ser usada independentemente do tipo de ordem a que pertence: um hotel ( <code>Hotel</code> ), um servi√ßo adicional ( <code>Upsell</code> ) ou um carro ( <code>Car</code> ).  No futuro, outros tipos podem aparecer. </p><br><p>  Isso nem sempre foi assim.  Quando o servi√ßo B2B foi lan√ßado, somente hot√©is podiam ser reservados por ele e toda a l√≥gica de neg√≥cios estava focada neles.  Muitos campos foram criados, por exemplo, para exibir as taxas de c√¢mbio do valor da venda e do valor do reembolso da reserva.  Com o tempo, percebemos a melhor forma de armazenar e reutilizar esses dados, dadas as meta-ordens.  Mas o c√≥digo inteiro n√£o p√¥de ser reescrito e parte dessa heran√ßa entrou na nova arquitetura.  Na verdade, isso levou a dificuldades nos c√°lculos, que utilizam v√°rios tipos de pedidos.  O que fazer - t√£o <em>historicamente</em> ... </p><br><p>  Meu objetivo √© mostrar o poder do Django ORM em nosso exemplo. </p><br><h2 id="predystoriya">  Antecedentes </h2><br><p>  Para planejar suas despesas, nossos clientes B2B realmente n√£o tinham informa√ß√µes sobre quanto eles precisam pagar agora / amanh√£ / tarde, se eles t√™m d√≠vidas pendentes em pedidos e qual √© o seu tamanho, al√©m de quanto mais eles podem gastar dentro de seus limites.  Decidimos mostrar essas informa√ß√µes na forma de um painel - um soquete t√£o simples com um diagrama claro. </p><br><p><img src="https://habrastorage.org/webt/2a/rj/yo/2arjyoaa9_xfe8ddcaz5qn4w5mu.gif" alt="dash1"><br>  <em>(todos os valores s√£o testados e n√£o se aplicam a um parceiro espec√≠fico)</em> </p><br><p>  √Ä primeira vista, tudo √© bem simples - filtramos todos os pedidos do parceiro, resumimos e mostramos. </p><br><h2 id="varianty-resheniya">  Op√ß√µes de solu√ß√£o </h2><br><p>  Uma pequena explica√ß√£o sobre como fazemos c√°lculos.  Somos uma empresa internacional, nossos parceiros de diferentes pa√≠ses realizam opera√ß√µes - compram e revendem reservas - em diferentes moedas.  Al√©m disso, eles devem receber demonstra√ß√µes financeiras na moeda escolhida (geralmente local).  Seria tolice e impratic√°vel armazenar todos os dados poss√≠veis sobre as taxas de todas as moedas; portanto, voc√™ precisa escolher uma moeda de refer√™ncia, por exemplo, o rublo.  Assim, voc√™ pode armazenar as taxas de todas as moedas apenas no rublo.  Assim, quando um parceiro deseja receber um resumo, convertemos os valores √† taxa definida no momento da venda. </p><br><h3 id="v-lob">  "Na testa" </h3><br><p>  De fato, este √© <code>Model.objects.all()</code> e o loop de condi√ß√µes: </p><br><div class="spoiler">  <b class="spoiler_title">Model.objects.all () com condi√ß√µes</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">output</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(partner_id)</span></span></span><span class="hljs-function">:</span></span> today = dt.date.today() <span class="hljs-comment"><span class="hljs-comment"># query_get_one -    partner = query_get_one(Partner.objects.filter(id=partner_id)) #    -  query = MetaOrder.objects.filter(partner=partner) result = defaultdict(Decimal) for morder in query: #  ,     #     payment_pending = morder.get_payment_pending() payment_due = morder.get_payment_due() #        # (     ) payable = morder.get_payable_in_cur() #       if payment_pending &gt; today: result['payment_pending'] += payable # ,     if payment_pending &lt; today and payment_due &gt; today: result['payment_due'] += payable return result</span></span></code> </pre> </div></div><br><p>  Esta consulta retornar√° um gerador que potencialmente cont√©m v√°rias centenas de reservas.  Uma solicita√ß√£o ao banco de dados ser√° feita para cada uma dessas reservas e, portanto, o ciclo funcionar√° por um per√≠odo muito longo. </p><br><p>  Voc√™ pode acelerar um pouco as coisas adicionando o m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>prefetch_related</code></a> : </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># object -      GenericForeignKey. query = query.prefetch_related('object')</span></span></code> </pre> <br><p>  Em seguida, haver√° um pouco menos de consultas ao banco de dados ( <code>GenericForeignKey</code> na <code>GenericForeignKey</code> ), mas no final pararemos com seu n√∫mero, porque a consulta ao banco de dados ainda ser√° feita a cada itera√ß√£o do loop. </p><br><p>  O m√©todo de <code>output</code> pode (e deve) ser armazenado em cache, mas a primeira chamada ainda cumpre a ordem de um minuto, o que √© completamente inaceit√°vel. </p><br><p>  Aqui est√£o os resultados dessa abordagem: </p><br><p><img src="https://habrastorage.org/webt/yz/ur/wq/yzurwquhxoeqczgncqi66je8570.png" alt="timing_before"></p><br><p>  O tempo m√©dio de resposta √© de 4 segundos e h√° picos chegando a 21 segundos.  Muito tempo. </p><br><p>  N√£o lan√ßamos o painel para todos os parceiros e, portanto, n√£o t√≠nhamos muitos pedidos, mas ainda √© suficiente entender que essa abordagem n√£o √© eficaz. </p><br><p><img src="https://habrastorage.org/webt/f0/rz/yn/f0rzynfsqypr3z0mh1cnwoi6ee0.png" alt="count_before"><br>  <em>Os n√∫meros do canto inferior direito s√£o o n√∫mero de consultas: m√≠nimo, m√°ximo, m√©dia, total.</em> </p><br><h3 id="s-umom">  Sabiamente </h3><br><p>  O prot√≥tipo da testa foi bom para entender a complexidade da tarefa, mas n√£o ideal para uso.  Decidimos que seria muito mais r√°pido e com menos recursos fazer v√°rias consultas complexas no banco de dados do que muitas simples. </p><br><h4 id="plan-zaprosa">  Solicitar plano </h4><br><p>  Os tra√ßos largos do plano de consulta podem ser descritos assim: </p><br><ul><li>  coletar pedidos de acordo com as condi√ß√µes iniciais, </li><li>  preparar campos para o c√°lculo atrav√©s da <code>annotate</code> , </li><li>  calcular valores de campo </li><li>  <code>aggregate</code> pela quantidade e quantidade </li></ul><br><h4 id="nachalnye-usloviya">  Condi√ß√µes iniciais </h4><br><p>  Os parceiros que visitam o site podem ver informa√ß√µes apenas em seus contratos. </p><br><pre> <code class="python hljs">partner = query_get_one(Partner.objects.filter(id=partner_id))</code> </pre> <br><p>  Caso n√£o desejemos mostrar novos tipos de pedidos / reservas, precisamos apenas filtrar os suportados: </p><br><pre> <code class="python hljs">query = MetaOrder.objects.filter( partner=partner, content_type__in=[ Hotel.get_content_type(), Car.get_content_type(), Upsell.get_content_type(), ] )</code> </pre> <br><p>  O status do pedido √© importante (mais sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>Q</code></a> ): </p><br><pre> <code class="python hljs">query = query.filter( Q(hotel__status__in=[<span class="hljs-string"><span class="hljs-string">'completed'</span></span>, <span class="hljs-string"><span class="hljs-string">'cancelled'</span></span>]) <span class="hljs-comment"><span class="hljs-comment">#     ,    # | Q(car__status__in=[...]) )</span></span></code> </pre> <br><p>  Tamb√©m costumamos usar solicita√ß√µes pr√©-preparadas, por exemplo, para excluir todos os pedidos que n√£o podem ser pagos.  H√° muita l√≥gica de neg√≥cios, o que n√£o √© muito interessante para n√≥s na estrutura deste artigo, mas, em ess√™ncia, esses s√£o apenas filtros adicionais.  Um m√©todo que retorna uma consulta preparada pode ser assim: </p><br><pre> <code class="python hljs">query = MetaOrder.exclude_non_payable_metaorders(query)</code> </pre> <br><p>  Como voc√™ pode ver, este √© um m√©todo de classe que tamb√©m retornar√° um <code>QuerySet</code> . </p><br><p>  Tamb√©m prepararemos algumas vari√°veis ‚Äã‚Äãpara constru√ß√µes condicionais e para armazenar resultados de c√°lculos: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> typing.decimal <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Decimal today = dt.date.today() result = defaultdict(Decimal)</code> </pre> <br><h4 id="podgotovka-poley-annotatehttpsdocsdjangoprojectcomen21refmodelsquerysetsannotate">  Prepara√ß√£o de Campo ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>annotate</code></a> ) </h4><br><p>  Devido ao fato de termos que nos referir aos campos, dependendo do tipo de pedido, usaremos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>Coalesce</code></a> .  Assim, podemos abstrair qualquer n√∫mero de novos tipos de pedidos em um √∫nico campo. </p><br><p>  Aqui est√° a primeira parte do bloco de <code>annotate</code> : </p><br><div class="spoiler">  <b class="spoiler_title">Primeira anota√ß√£o</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     , #      from app.helpers.numbers import ZERO, ONE query_annoted = query.annotate( _payment_pending=Coalesce( 'hotel__payment_pending', 'car__payment_pending', 'upsell__payment_pending', ), _payment_due=Coalesce( 'hotel__payment_due', 'car__payment_due', 'upsell__payment_due', ), _refund=Coalesce( 'hotel__refund', Value(ZERO) ), _refund_currency_rate=Coalesce( 'hotel__refund_currency_rate', Value(ONE) ), _sell=Coalesce( 'hotel__sell', Value(ZERO) ), _sell_currency_rate=Coalesce( 'hotel__sell_currency_rate', Value(ONE) ), )</span></span></code> </pre> </div></div><br><p>  <code>Coalesce</code> trabalha aqui com um estrondo, porque os pedidos de hot√©is t√™m v√°rias propriedades especiais e, em todos os outros casos (servi√ßos adicionais e carros), essas propriedades n√£o s√£o importantes para n√≥s.  √â assim que o <code>Value(ZERO)</code> para valores e o <code>Value(ONE)</code> para taxas de c√¢mbio aparecem.  <code>ZERO</code> e <code>ONE</code> s√£o <code>Decimal('0')</code> e <code>Decimal(1)</code> , apenas na forma de constantes.  Uma abordagem amadora, mas em nosso projeto √© aceita assim. </p><br><p>  Voc√™ pode ter uma pergunta: por que n√£o colocar alguns campos em um n√≠vel em uma meta ordem?  Por exemplo, <code>payment_pending</code> , que est√° em toda parte.  De fato, com o tempo, transferimos esses campos para uma meta-ordem, mas agora o c√≥digo funciona bem, portanto essas tarefas n√£o s√£o nossa prioridade. </p><br><h4 id="esche-odna-podgotovka-i-raschety">  Outra prepara√ß√£o e c√°lculos </h4><br><p>  Agora, precisamos fazer alguns c√°lculos com os valores que recebemos no √∫ltimo bloco de <code>annotate</code> .  Observe que aqui voc√™ n√£o precisa mais estar vinculado ao tipo de pedido (exceto uma exce√ß√£o). </p><br><div class="spoiler">  <b class="spoiler_title">Segunda anota√ß√£o</b> <div class="spoiler_text"><pre> <code class="python hljs">.annotate( <span class="hljs-comment"><span class="hljs-comment">#  _base     _sell_base=( F('_sell') * F('_sell_currency_rate') ), _refund_base=( F('_refund') * F('_refund_currency_rate') ), _payable_base=( F('_sell_base') - F('_refund_base') ), _reporting_currency_rate=Case( When( content_type=Hotel.get_content_type(), then=RawSQL( '(hotel.currency_data-&gt;&gt;%s)::numeric', (partner.reporting_currency,), ), ), output_field=DecimalField(), default=Decimal('1'), ), )</span></span></code> </pre> </div></div><br><p>  A parte mais interessante desse bloco √© o campo <code>_reporting_currency_rate</code> ou a taxa de c√¢mbio da moeda de refer√™ncia no momento da venda.  Os dados sobre as taxas de c√¢mbio de todas as moedas para a moeda de refer√™ncia para um pedido de hotel s√£o armazenados em <code>currency_data</code> .  Este √© apenas JSON.  Por que mantemos isso?  <em>Este √© historicamente o caso</em> . </p><br><p>  E aqui, ao que parece, por que n√£o usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>F</code></a> e substituir o valor da moeda do contrato?  Ou seja, seria legal se voc√™ pudesse fazer isso: </p><br><pre> <code class="python hljs">F(<span class="hljs-string"><span class="hljs-string">f'currency_data__</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{partner.reporting_currency}</span></span></span><span class="hljs-string">'</span></span>)</code> </pre> <br><p>  Mas <code>f-strings</code> n√£o <code>f-strings</code> suportadas em <code>F</code>  Embora o fato do Django ORM j√° tenha a capacidade de acessar campos json aninhados seja muito agrad√°vel - <code>F('currency_data__USD')</code> . </p><br><p>  E o √∫ltimo bloco de <code>annotate</code> √© o c√°lculo <code>_payable_in_cur</code> , que ser√° resumido para todos os pedidos.  Este valor deve estar na moeda do contrato. </p><br><p><img src="https://habrastorage.org/webt/3g/hi/rd/3ghirdq4rnexrp2vnhwucju7rkw.png" alt="dash2"></p><br><pre> <code class="python hljs">.annotate( _payable_in_cur=( F(<span class="hljs-string"><span class="hljs-string">'_payable_base'</span></span>) / F(<span class="hljs-string"><span class="hljs-string">'_reporting_currency_rate'</span></span>) ) )</code> </pre> <br><p>  A peculiaridade do m√©todo <code>annotate</code> √© que ele gera uma grande quantidade de constru√ß√µes <code>SELECT something AS something_else</code> que n√£o est√£o diretamente envolvidas na solicita√ß√£o.  Isso pode ser visto descarregando a consulta SQL - <code>query.__str__()</code> . </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√â assim que o</a> c√≥digo SQL gerado pelo Django ORM para <code>base_query_annotated</code> .  Voc√™ precisa l√™-lo com frequ√™ncia para entender onde pode otimizar sua consulta. </p><br><h4 id="zaklyuchitelnye-podschety">  C√°lculos finais </h4><br><p>  Haver√° um pequeno inv√≥lucro para <code>aggregate</code> , para que, no futuro, se o parceiro precisar de alguma outra m√©trica, ele possa ser facilmente adicionado. </p><br><p><img src="https://habrastorage.org/webt/ky/qm/pi/kyqmpiht-jwpwuripuf6wlfiqv0.png" alt="dash3"></p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_data_from_query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(query: QuerySet)</span></span></span><span class="hljs-function"> -&gt; Decimal:</span></span> result = query.aggregate( _sum_payable=Sum(F(<span class="hljs-string"><span class="hljs-string">'_payable_in_cur'</span></span>)), ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result[<span class="hljs-string"><span class="hljs-string">'_sum_payable'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> ZERO</code> </pre> <br><p>  E mais uma coisa: esta √© a √∫ltima filtragem por condi√ß√£o comercial, por exemplo, precisamos de todos os pedidos que precisar√£o ser pagos em breve. </p><br><p><img src="https://habrastorage.org/webt/xz/rj/ss/xzrjssl1barwnpvtegjkg1tkvs0.png" alt="dash4"></p><br><pre> <code class="python hljs">before_payment_pending_query = _get_data_from_query( base_query_annotated.filter(_payment_pending__gt=today) )</code> </pre> <br><h4 id="otladka-i-proverka">  Depura√ß√£o e verifica√ß√£o </h4><br><p>  Uma maneira muito conveniente de verificar a exatid√£o da solicita√ß√£o criada √© compar√°-la com uma vers√£o mais leg√≠vel dos c√°lculos. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> morder <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> query: payable = morder.get_payable_in_cur() payment_pending = morder.get_payment_pending() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> payment_pending &gt; today: result[<span class="hljs-string"><span class="hljs-string">'payment_pending'</span></span>] += payable</code> </pre> <br><p>  Voc√™ conhece o m√©todo "testa"? </p><br><h3 id="finalnyy-kod">  C√≥digo final </h3><br><p>  Como resultado, obtivemos algo como o seguinte: </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo final</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_data_from_query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(query: QuerySet)</span></span></span><span class="hljs-function"> -&gt; tuple:</span></span> result = query.aggregate( _sum_payable=Sum(F(<span class="hljs-string"><span class="hljs-string">'_payable_in_cur'</span></span>)), ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result[<span class="hljs-string"><span class="hljs-string">'_sum_payable'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> ZERO <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">output</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(partner_id: int)</span></span></span><span class="hljs-function">:</span></span> today = dt.date.today() partner = query_get_one(Partner.objects.filter(id=partner_id)) query = MetaOrder.objects.filter(partner=partner, content_type__in=[ Hotel.get_content_type(), Car.get_content_type(), Upsell.get_content_type(), ]) result = defaultdict(Decimal) query_annoted = query.annotate( _payment_pending=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__payment_pending'</span></span>, <span class="hljs-string"><span class="hljs-string">'car__payment_pending'</span></span>, <span class="hljs-string"><span class="hljs-string">'upsell__payment_pending'</span></span>, ), _payment_due=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__payment_due'</span></span>, <span class="hljs-string"><span class="hljs-string">'car__payment_due'</span></span>, <span class="hljs-string"><span class="hljs-string">'upsell__payment_due'</span></span>, ), _refund=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__refund'</span></span>, Value(ZERO) ), _refund_currency_rate=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__refund_currency_rate'</span></span>, Value(Decimal(<span class="hljs-string"><span class="hljs-string">'1'</span></span>)) ), _sell=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__sell'</span></span>, Value(ZERO) ), _sell_currency_rate=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__sell_currency_rate'</span></span>, Value(Decimal(<span class="hljs-string"><span class="hljs-string">'1'</span></span>)) ), ).annotate( <span class="hljs-comment"><span class="hljs-comment"># Calculated fields _sell_base=( F('_sell') * F('_sell_currency_rate') ), _refund_base=( F('_refund') * F('_refund_currency_rate') ), _payable_base=( F('_sell_base') - F('_refund_base') ), _reporting_currency_rate=Case( # Only hotels have currency_data, therefore we need a # check and default value When( content_type=Hotel.get_content_type(), then=RawSQL( '(hotel.currency_data-&gt;&gt;%s)::numeric', (partner.reporting_currency,), ), ), output_field=DecimalField(), default=Decimal('1'), ), ) .annotate( _payable_in_cur=( F('_payable_base') / F('_reporting_currency_rate') ) ) before_payment_pending_query = _get_data_from_query( base_query_annotated.filter(_payment_pending__gt=today) ) after_payment_pending_before_payment_due_query = _get_data_from_query( base_query_annotated.filter( Q(_payment_pending__lte=today) &amp; Q(_payment_due__gt=today) ) )</span></span></code> </pre></div></div><br><p>  √â assim que funciona agora: </p><br><p><img src="https://habrastorage.org/webt/xg/1i/rf/xg1irfnazuk-rqk14wdlxn32nhi.png" alt="timing_after"></p><br><p><img src="https://habrastorage.org/webt/mt/k7/cq/mtk7cqefuzlx96roihjpgvpeaz8.png" alt="count_after"></p><br><h2 id="vyvody">  Conclus√µes </h2><br><p>  Depois de reescrever e otimizar a l√≥gica, conseguimos fazer um tratamento bastante r√°pido das m√©tricas de afiliados e reduzir bastante o n√∫mero de consultas no banco de dados.  A solu√ß√£o acabou sendo boa e reutilizaremos essa l√≥gica em outras partes do projeto.  ORM √© o nosso tudo. </p><br><p>  Escreva coment√°rios, fa√ßa perguntas - tentaremos responder!  Obrigada </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt447706/">https://habr.com/ru/post/pt447706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt447696/index.html">Por que as cidades se op√µem ao Amazon Go, as primeiras lojas que n√£o s√£o de caixa</a></li>
<li><a href="../pt447698/index.html">Red Hogwarts: acad√™mico sem diploma</a></li>
<li><a href="../pt447700/index.html">A flexibilidade emocional √© a chave para o crescimento pessoal.</a></li>
<li><a href="../pt447702/index.html">O c√≠rculo matem√°tico ideal n√£o existe</a></li>
<li><a href="../pt447704/index.html">Escalada Elbrus - Reconhecimento em batalha. Parte t√©cnica 1. Registros, pilhas e outros detalhes t√©cnicos</a></li>
<li><a href="../pt447708/index.html">Yandex presenteou jovens cientistas e l√≠deres cient√≠ficos com os primeiros pr√™mios Ilya Segalovich</a></li>
<li><a href="../pt447712/index.html">Ol√° SaaS | SaaS russo 2018 - resultados</a></li>
<li><a href="../pt447714/index.html">Sobre a aplica√ß√£o da teoria dos processos ARMA na pr√°tica de engenharia</a></li>
<li><a href="../pt447716/index.html">Unidade: desenhe muitas barras de sa√∫de em uma chamada</a></li>
<li><a href="../pt447718/index.html">Tudo vai conforme o planejado</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>