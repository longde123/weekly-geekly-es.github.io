<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßôüèæ üîπ üßïüèæ 2 hacks de vida: alternativas a la b√∫squeda cl√°sica en Microsoft SQL Server üë©üèø‚Äçüåæ üå± üë®üèæ‚Äçüíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! Nuestros amigos de Softpoint han preparado un interesante art√≠culo sobre Microsoft SQL Server. Analiza dos ejemplos pr√°cticos del uso de la...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>2 hacks de vida: alternativas a la b√∫squeda cl√°sica en Microsoft SQL Server</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/470139/">  Hola Habr!  Nuestros amigos de Softpoint han preparado un interesante art√≠culo sobre Microsoft SQL Server.  Analiza dos ejemplos pr√°cticos del uso de la b√∫squeda de texto completo: <br><br><ul><li>  Busque en l√≠neas "infinitas" (p. Ej., Comentarios) en lugar de una b√∫squeda regular a trav√©s de LIKE; </li><li>  Buscar por n√∫meros de documento con prefijos.  Donde generalmente no se puede usar la b√∫squeda de texto completo: los prefijos constantes interfieren con ella.  Se analizan 2 enfoques: preprocesar el n√∫mero de documento y agregar su propio separador de palabras de la biblioteca. </li></ul><br>  √önete ahora! <br><br><img src="https://habrastorage.org/webt/cj/iu/to/cjiutotj7eknpw4cyapmoqw3yys.png"><a name="habracut"></a><br><br>  <i>Le doy la palabra al autor</i> <br><br>  Una b√∫squeda efectiva en gigabytes de datos acumulados es una especie de "santo grial" de los sistemas de contabilidad.  Todos quieren encontrarlo y obtener la gloria inmortal, pero en el proceso de b√∫squeda una y otra vez resulta que no hay una soluci√≥n milagrosa √∫nica. <br><br>  La situaci√≥n se complica por el hecho de que los usuarios generalmente desean buscar una subcadena; en alg√∫n lugar resulta que el n√∫mero de contrato deseado est√° "enterrado" en el medio del comentario;  en alguna parte, el operador no recuerda exactamente el nombre del cliente, pero record√≥ que se llamaba "Alexey Evgrafovich";  en alg√∫n lugar, solo necesita omitir la forma recurrente de propiedad de BYUBL y buscar de inmediato por el nombre de la organizaci√≥n.  Para los DBMS relacionales cl√°sicos, tal b√∫squeda es una muy mala noticia.  Muy a menudo, dicha b√∫squeda de subcadenas se reduce al desplazamiento met√≥dico de cada fila de la tabla.  No es la estrategia m√°s efectiva, especialmente si el tama√±o de la tabla crece a varias decenas de gigabytes. <br><br>  En busca de una alternativa, a menudo recuerdo la "b√∫squeda de texto completo".  La alegr√≠a de encontrar una soluci√≥n generalmente pasa r√°pidamente despu√©s de una revisi√≥n superficial de la pr√°ctica existente.  Resulta r√°pidamente que, seg√∫n la opini√≥n popular, la b√∫squeda de texto completo: <br><br><ul><li>  Dif√≠cil de configurar </li><li>  Poco a poco actualizado </li><li>  Cuelga el sistema al actualizar </li><li>  Tiene alg√∫n tipo de sintaxis <s>est√∫pida e</s> inusual </li><li> No encuentra lo que preguntan </li></ul><br>  El conjunto de mitos puede continuar durante mucho tiempo, pero incluso Plat√≥n nos ense√±√≥ a ser esc√©pticos y no aceptar ciegamente la opini√≥n de otra persona sobre la fe.  ¬øA ver si el demonio es tan terrible como est√° pintado? <br><br>  Y, aunque no estamos profundamente inmersos en el estudio, acordaremos de <b>inmediato una condici√≥n importante</b> .  El motor de b√∫squeda de texto completo puede hacer mucho m√°s que una b√∫squeda de cadena normal.  Por ejemplo, puede definir un diccionario de sin√≥nimos y usar la palabra "contacto" para buscar "tel√©fono".  O busque palabras sin tener en cuenta la forma y las terminaciones.  Estas opciones pueden ser muy √∫tiles para los usuarios, pero en este art√≠culo consideramos la b√∫squeda de texto completo solo como una alternativa a la b√∫squeda de l√≠nea cl√°sica.  Es decir, <b>solo buscaremos la subcadena que se especificar√° en la barra de b√∫squeda</b> , sin tener en cuenta los sin√≥nimos, sin traer palabras a la forma "normal" y otra magia. <br><br><h2>  C√≥mo funciona la b√∫squeda de texto completo de MS SQL </h2><br>  La funcionalidad de b√∫squeda de texto completo en MS SQL se ha eliminado parcialmente del servicio principal de DBMS (cerca del final del art√≠culo veremos por qu√© esto puede ser extremadamente √∫til).  Para la b√∫squeda, se forma un √≠ndice especial con su estructura, a diferencia de los √°rboles equilibrados habituales. <br><br>  Es importante que para crear un √≠ndice de b√∫squeda de texto completo, sea necesario que exista un √≠ndice √∫nico en la tabla de claves, que consista en una sola columna; es su b√∫squeda de texto completo la que se utilizar√° para identificar las filas de la tabla.  A menudo, la tabla ya tiene dicho √≠ndice en la Clave primaria, pero a veces tendr√° que crearse adicionalmente. <br><br>  El √≠ndice de b√∫squeda de texto completo se rellena de forma asincr√≥nica y fuera de transacci√≥n.  Despu√©s de cambiar una fila de la tabla, se pone en cola para su procesamiento.  El proceso de actualizaci√≥n del √≠ndice recibe de la fila de la tabla (fila) todos los valores de cadena, "suscritos" al √≠ndice, y los divide en palabras separadas.  Despu√©s de esto, las palabras se pueden reducir a una cierta forma "est√°ndar" (por ejemplo, sin terminaciones), de modo que sea m√°s f√°cil buscar por formas de palabras.  Se arrojan "palabras de detenci√≥n" (preposiciones, art√≠culos y otras palabras que no tienen significado).  Las coincidencias de enlace de palabra a cadena restantes se escriben en el √≠ndice de b√∫squeda de texto completo. <br><br>  Resulta que cada columna de la tabla incluida en el √≠ndice pasa a trav√©s de dicha canalizaci√≥n: <br><br>  L√≠nea larga -&gt; separador de palabras -&gt; conjunto de partes (palabras) -&gt; stemmer -&gt; palabras normalizadas -&gt; [opcional] excepci√≥n de palabra de detenci√≥n -&gt; escribir en √≠ndice <br><br>  Como se mencion√≥, el proceso de actualizaci√≥n del √≠ndice es as√≠ncrono.  De esto se desprende: <br><br><ol><li>  La actualizaci√≥n no bloquea las acciones del usuario </li><li>  La actualizaci√≥n espera la finalizaci√≥n de la transacci√≥n de cambio de fila y comienza a aplicar los cambios no antes de la confirmaci√≥n </li><li>  Los cambios en el √≠ndice de texto completo se aplican con cierto retraso en relaci√≥n con la transacci√≥n principal.  Es decir, entre agregar una fila y el momento en que se puede encontrar, habr√° un retraso dependiendo de la longitud de la cola de actualizaci√≥n del √≠ndice </li><li>  La consulta puede monitorear el n√∫mero de elementos contenidos en el √≠ndice: </li></ol><br><pre><code class="cs hljs">SELECT cat.name, FULLTEXTCATALOGPROPERTY(cat.name,<span class="hljs-string"><span class="hljs-string">'ItemCount'</span></span>) AS [ItemCount] FROM sys.fulltext_catalogs AS cat</code> </pre> <br><h2>  Pruebas pr√°cticas  Busqueda fisica  personas por nombre </h2><br><h4>  Llenar la tabla con datos </h4><br>  Para los experimentos, crearemos una nueva base vac√≠a con una tabla donde se almacenar√°n las "contrapartes".  Dentro del campo "descripci√≥n" habr√° una l√≠nea con el nombre del contrato, donde se mencionar√° el nombre de la contraparte.  Algo como esto: <br><br>  "Contrato con Borovik Demyan Emelyanovich" <br><br>  M√°s o menos: <br><br>  "Perro.  con Borovik-Romanov Anatoly Avdeevich " <br><br>  S√≠, quiero dispararme de inmediato a partir de esa "arquitectura", pero, desafortunadamente, esa aplicaci√≥n de "comentarios" o "descripciones" a menudo se encuentra entre los usuarios de negocios. <br><br>  Adem√°s, agregamos algunos campos "para peso": si solo hay 2 columnas en la tabla, un escaneo simple lo leer√° en unos instantes.  Necesitamos "inflar" la tabla para que la exploraci√≥n sea larga.  Esto nos acerca a casos comerciales reales: almacenamos no solo la ‚Äúdescripci√≥n‚Äù en la tabla, sino tambi√©n mucha otra informaci√≥n √∫til [del diablo]. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">create table </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">partners</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id bigint identity (</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function">, [description] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">max</span></span></span><span class="hljs-function">), [address] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> N'107240, ,  ., 168', [phone] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> N'+7 (</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">495</span></span></span></span></span><span class="hljs-function">) 111-222-33', [contact_name] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> N'', [bio] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2048</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> N'     . , ,  .  ,    .        ,     .   ,  , ,       ,  .    . ,    ,   .       ,  ,            .       ,    ,     , .          ,   ,   .       .    .') --  ,    ..       </span></span></code> </pre> <br><br>  La siguiente pregunta es ¬ød√≥nde obtener tantos apellidos √∫nicos, nombres y patron√≠micos?  Yo, seg√∫n un viejo h√°bito, actuaba como un estudiante ruso normal, es decir.  fue a wikipedia: <br><br><ul><li>  Nombres tomados de la p√°gina Categor√≠a: nombres masculinos rusos </li><li>  Reescribir manualmente los segundos nombres a partir de los nombres, cambiando las terminaciones </li><li>  Con los apellidos result√≥ ser un poco m√°s complicado.  Al final, se encontr√≥ la categor√≠a "hom√≥nimos".  Un peque√±o chamanismo con Python y en una tabla separada result√≥ 46.5 mil nombres.  (un script para descargar apellidos est√° disponible aqu√≠) </li></ul><br>  Por supuesto, hubo variaciones extra√±as entre los apellidos, pero para los prop√≥sitos del estudio esto fue bastante aceptable. <br><br><img src="https://habrastorage.org/webt/0z/to/16/0zto16d8rkkkygbiuqvdorvlxdc.png"><br><br>  Escrib√≠ un script sql que adjunta un n√∫mero aleatorio de nombres y patron√≠micos a cada apellido.  5 minutos de espera y en una mesa separada ya hab√≠a 4.5 millones de combinaciones.  No esta mal!  Para cada apellido hab√≠a de 20 a 231 combinaciones del nombre + segundo nombre, en promedio se obtuvieron 97 combinaciones.  La distribuci√≥n por nombre y patron√≠mico result√≥ estar ligeramente sesgada "a la izquierda", pero pensar en un algoritmo m√°s equilibrado parec√≠a redundante. <br><br><img src="https://habrastorage.org/webt/lb/yx/ug/lbyxugz2sjsri9uw7bi7rzornl4.png"><br><br>  Los datos est√°n preparados, podemos comenzar nuestros experimentos. <br><br><h4>  Configuraci√≥n de b√∫squeda de texto completo </h4><br>  Cree un √≠ndice de texto completo en el nivel de MS SQL.  Primero necesitamos crear un repositorio para este √≠ndice: un cat√°logo de texto completo. <br><br><pre> <code class="cs hljs">USE [like_vs_fulltext] GO CREATE FULLTEXT CATALOG [basic_ftc] WITH ACCENT_SENSITIVITY = OFF AS DEFAULT AUTHORIZATION [dbo] GO</code> </pre> <br>  Hay un cat√°logo, estamos tratando de agregar un √≠ndice de texto completo para nuestra tabla ... y nada funciona. <br><br><img src="https://habrastorage.org/webt/-v/rd/ge/-vrdge8hjpp_c8pgt4j3imsmks4.png"><br><br>  Como dije, para un √≠ndice de texto completo necesita un √≠ndice regular con una columna √∫nica.  Recordamos que ya tenemos el campo requerido: un identificador de identificaci√≥n √∫nico.  Creemos un √≠ndice de cl√∫ster √∫nico en √©l (aunque ser√≠a suficiente uno no agrupado): <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">create unique clustered index ndx1 </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">on</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">partners</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id</span></span></span><span class="hljs-function">)</span></span></code> </pre> <br>  Despu√©s de crear un nuevo √≠ndice, finalmente podemos agregar el √≠ndice de b√∫squeda de texto completo.  Esperemos unos minutos hasta que el √≠ndice est√© lleno (recuerde que se actualiza de forma as√≠ncrona).  Puedes proceder a las pruebas. <br><br><h4>  Prueba </h4><br>  Comencemos con el escenario m√°s simple, cerca de la aplicaci√≥n real de la b√∫squeda.  Simulamos una "vista de lista": una selecci√≥n de ventana de 45 l√≠neas con selecci√≥n por m√°scara de b√∫squeda.  Ejecutamos la solicitud con un nuevo √≠ndice de texto completo, notamos el tiempo - 0 segundos - ¬°excelente! <br><br><img src="https://habrastorage.org/webt/m8/ci/bk/m8cibkgbrwb2xkruwbspp3axfgk.png"><br><br>  Ahora, una vieja y probada b√∫squeda a trav√©s de "me gusta".  Tom√≥ 3 segundos para formar el resultado.  No est√° tan mal, la derrota total no funcion√≥.  Tal vez entonces no tiene sentido configurar una b√∫squeda de texto completo: ¬øfunciona todo bien? <br><br><img src="https://habrastorage.org/webt/bl/gr/hl/blgrhlafampbhbssctycbcweuis.png"><br><br>  De hecho, nos perdimos un detalle importante: la solicitud se ejecut√≥ sin ordenar.  En primer lugar, dicha consulta combinada con "seleccionar los primeros N registros" devuelve un resultado injustificado.  Cada inicio puede devolver N registros aleatorios y no hay garant√≠a de que dos inicios consecutivos den el mismo conjunto de datos.  En segundo lugar, si estamos hablando de "ver la lista con una ventana deslizante", por lo general, esta misma "ventana" se ordena por cualquier columna, por ejemplo, por nombre.  Despu√©s de todo, el operador necesita saber qu√© obtendr√° cuando se mueva a la siguiente "ventana". <br><br>  Corrige el experimento.  Agregue clasificaci√≥n, digamos, por n√∫mero de tel√©fono: <br><br><img src="https://habrastorage.org/webt/tc/n-/i9/tcn-i9py1gxkrbrl927ygqqyudq.png"><br><br>  <b>La b√∫squeda de texto completo gana con una puntuaci√≥n ensordecedora: ¬°0 segundos frente a 172 segundos!</b> <br><br>  Si observa los planes de consulta, queda claro por qu√© es as√≠.  Debido a la adici√≥n de pedidos al texto de la consulta, apareci√≥ una operaci√≥n de clasificaci√≥n durante la ejecuci√≥n.  Esta es la llamada operaci√≥n de "bloqueo", que no puede completar la solicitud hasta que reciba la cantidad total de datos para ordenar.  No podemos recoger los primeros 45 registros que tenemos, tenemos que ordenar todo el conjunto de datos. <br><br>  Y en la etapa de obtenci√≥n de datos para la clasificaci√≥n, se produce una diferencia dram√°tica.  Una b√∫squeda con "me gusta" tiene que navegar a trav√©s de toda la tabla disponible.  Esto lleva 172 segundos.  Pero la b√∫squeda de texto completo tiene su propia estructura optimizada, que devuelve inmediatamente enlaces a todas las entradas necesarias. <br><br><img src="https://habrastorage.org/webt/gq/nu/fw/gqnufwndwjmo5skv5_uq6ewvdkc.png"><br><br><img src="https://habrastorage.org/webt/uv/ew/c9/uvewc93qvfchgagsclaqi55hvt8.png"><br><br>  ¬øPero deber√≠a haber una mosca en la pomada?  Hay uno  Como se indic√≥ al principio, una b√∫squeda de texto completo solo puede buscar desde el principio de una palabra.  Y si queremos encontrar "Ivan Poddubny" junto a la subcadena "* oak *", una b√∫squeda de texto completo no mostrar√° nada √∫til. <br><br>  Afortunadamente, para buscar por nombre, este no es el escenario m√°s popular. <br><br><h4>  Buscar un documento por n√∫mero </h4><br>  Probemos algo m√°s complicado.  El segundo caso de uso popular para la b√∫squeda es encontrar un documento por parte de su n√∫mero.  Adem√°s, a menudo el n√∫mero de documento consta de dos partes: el prefijo de la letra y el n√∫mero real que contiene ceros a la izquierda. <br><br>  No hay espacios ni caracteres de servicio entre estas partes.  Al mismo tiempo, buscar por el n√∫mero completo es monstruosamente inconveniente: debe recordar cu√°ntos ceros a la izquierda despu√©s del prefijo deben estar antes del comienzo de la parte significativa.  Resulta que la b√∫squeda de texto completo "fuera de la caja" es simplemente in√∫til en tal escenario.  Tratemos de arreglarlo. <br><br>  Para la prueba, cre√© una nueva tabla llamada documento, en la que agregu√© 13.5 millones de registros con n√∫meros √∫nicos del tipo "ORG".  La numeraci√≥n fue en orden, todos los n√∫meros comenzaron con "ORG".  Puedes empezar. <br><br><h4>  Pre-dividir un n√∫mero </h4><br>  La b√∫squeda de texto completo puede buscar palabras de manera eficiente.  Bueno, ayud√©moslo y separemos el n√∫mero "inc√≥modo" en palabras convenientes de antemano.  El plan de acci√≥n es el siguiente: <br><br><ol><li>  Agregue una columna adicional a la tabla de origen donde se almacenar√° el n√∫mero convertido especialmente </li><li>  Agregue un disparador, que al cambiar el n√∫mero lo dividir√° en varias partes peque√±as, separadas por un espacio </li><li>  La b√∫squeda de texto completo ya sabe c√≥mo dividir una cadena en partes por espacios, de modo que indexar√° nuestro n√∫mero modificado sin problemas </li></ol><br>  Veamos c√≥mo funcionar√° esto. <br><br>  Agregue una columna adicional a la tabla. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">alter table document </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">add</span></span></span><span class="hljs-function"> number_parts </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">128</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> ''</span></span></code> </pre> <br>  Un disparador que llena una nueva columna se puede escribir ‚Äúfrente‚Äù, ignorando posibles duplicados (¬øcu√°ntos triples repetidos hay en el n√∫mero ‚Äú0000012‚Äù?) Y puede agregar algo de magia XML y registrar solo partes √∫nicas.  La primera implementaci√≥n ser√° m√°s r√°pida, la segunda dar√° un resultado m√°s compacto.  De hecho, la elecci√≥n es entre velocidad de escritura y velocidad de lectura, elija lo que es m√°s importante en su situaci√≥n.  Ahora solo revisa un <a href="">script</a> que procesa los n√∫meros existentes. <br><br><img src="https://habrastorage.org/webt/jh/su/yi/jhsuyix1k3vmyz-m4_2lit8mn0c.png"><br><br>  Agregar √≠ndice de texto completo <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">create fulltext index </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">on</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">document</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">number_parts</span></span></span><span class="hljs-function">) key index ndx1 with change_tracking</span></span> = Auto</code> </pre> <br>  Y verifica el resultado.  El experimento es el mismo: modelar una selecci√≥n de "ventana" de una lista de documentos.  No repetimos los errores anteriores e inmediatamente ejecutamos la solicitud ordenando, en este caso por fecha. <br><br><img src="https://habrastorage.org/webt/2a/mc/aq/2amcaqolncb-oewf7l9dfivqstq.png"><br><br>  Funciona!  Ahora intentemos un n√∫mero m√°s aut√©ntico: <br><br><img src="https://habrastorage.org/webt/fe/a4/k9/fea4k9kc2isour1u-jkv5fla1pm.png"><br><br>  Y luego ocurre un fallo de encendido.  La longitud de la cadena de b√∫squeda es m√°s larga que la longitud de las "palabras" almacenadas.  De hecho, la base de datos de b√∫squeda simplemente no tiene una sola l√≠nea de 4 caracteres, por lo que honestamente devuelve un resultado vac√≠o.  Tendremos que batir la cadena de b√∫squeda en partes: <br><br><img src="https://habrastorage.org/webt/0z/tv/sy/0ztvsyfiijs2wuzppnutvugt-dy.png"><br><br>  Otra cosa!  Nuevamente tenemos una b√∫squeda r√°pida.  S√≠, impone sus gastos generales en mantenimiento, pero el resultado es cientos de veces m√°s r√°pido que la b√∫squeda cl√°sica.  Notamos que el intento cont√≥, pero intente simplificar el mantenimiento de alguna manera, en la siguiente secci√≥n. <br><br><h4>  ¬°Lo dividiremos en palabras a nuestra manera! </h4><br>  De hecho, ¬øqui√©n dijo que las palabras deber√≠an estar separadas por espacios?  ¬°Tal vez quiero ceros entre palabras!  (y, si es posible, el prefijo para que tambi√©n se ignore y no interfiera bajo los pies).  En general, no hay nada imposible en esto.  Recordemos el esquema de operaci√≥n de b√∫squeda de texto completo desde el principio del art√≠culo: un componente separado, el separador de palabras, es responsable de dividir en palabras y, afortunadamente, Microsoft le permite implementar su propio "separador de palabras". <br><br>  Y aqu√≠ comienza lo interesante.  Wordbreaker es un dll separado que se conecta al motor de b√∫squeda de texto completo.  La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n oficial</a> dice que hacer esta biblioteca es muy simple: simplemente implemente la interfaz IWordBreaker.  Y aqu√≠ hay un par de listados cortos de inicializaci√≥n en C ++.  Con mucho √©xito, ¬°acabo de encontrar un tutorial adecuado! <br><br><img src="https://habrastorage.org/webt/48/vk/hh/48vkhhkmxbga2tnxudfiktk2c4k.png">  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fuente</a> ) <br><br>  En serio, la documentaci√≥n para crear su propio rompehielos en Internet es muy peque√±a.  Incluso menos ejemplos y plantillas.  Pero todav√≠a encontr√© el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">proyecto de una</a> persona amable que escribi√≥ en C ++ una implementaci√≥n que desglosa las palabras no por separadores, sino simplemente por triples (s√≠, ¬°como en la secci√≥n anterior!) Adem√°s, la carpeta del proyecto ya contiene un binario cuidadosamente compilado, que solo necesita conectarse al motor de b√∫squeda <br><br>  Solo enchufar ... En realidad no es muy f√°cil.  Veamos los pasos: <br><br>  Necesita copiar la biblioteca a la carpeta con SQL Server: <br><br><img src="https://habrastorage.org/webt/oy/tj/wk/oytjwkzpv1b8mo6uvysgipl7fq0.png"><br><br>  Registrar un nuevo "idioma" en la b√∫squeda de texto completo <br><br><pre> <code class="cs hljs">exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\CLSID\{d225281a-7ca9-4a46-ae7d-c63a9d4815d4}'</span></span>, <span class="hljs-string"><span class="hljs-string">'DefaultData'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_SZ'</span></span>, <span class="hljs-string"><span class="hljs-string">'sqlngram.dll'</span></span> exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\CLSID\{0a275611-aa4d-4b39-8290-4baf77703f55}'</span></span>, <span class="hljs-string"><span class="hljs-string">'DefaultData'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_SZ'</span></span>, <span class="hljs-string"><span class="hljs-string">'sqlngram.dll'</span></span> exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\Language\ngram'</span></span>, <span class="hljs-string"><span class="hljs-string">'Locale'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_DWORD'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\Language\ngram'</span></span>, <span class="hljs-string"><span class="hljs-string">'WBreakerClass'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_SZ'</span></span>, <span class="hljs-string"><span class="hljs-string">'{d225281a-7ca9-4a46-ae7d-c63a9d4815d4}'</span></span> exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\Language\ngram'</span></span>, <span class="hljs-string"><span class="hljs-string">'StemmerClass'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_SZ'</span></span>, <span class="hljs-string"><span class="hljs-string">'{0a275611-aa4d-4b39-8290-4baf77703f55}'</span></span> exec sp_fulltext_service <span class="hljs-string"><span class="hljs-string">'verify_signature'</span></span> , <span class="hljs-number"><span class="hljs-number">0</span></span>; exec sp_fulltext_service <span class="hljs-string"><span class="hljs-string">'update_languages'</span></span>; exec sp_fulltext_service <span class="hljs-string"><span class="hljs-string">'restart_all_fdhosts'</span></span>; exec sp_help_fulltext_system_components <span class="hljs-string"><span class="hljs-string">'wordbreaker'</span></span>;</code> </pre> <br>  Edite manualmente varias claves en el registro (el autor iba a automatizar el proceso, pero no hay novedades desde 2016. Sin embargo, este fue originalmente un "ejemplo de implementaci√≥n", gracias por eso) <br><br><img src="https://habrastorage.org/webt/dx/yd/iq/dxydiqkbefi03iseanfv_tzfcii.png"><br><br>  Los pasos se describen en detalle en la p√°gina del proyecto. <br><br>  Listo  Eliminemos el √≠ndice de texto completo anterior, porque no puede haber dos √≠ndices de texto completo para una tabla.  Cree uno nuevo e indexe nuestros n√∫meros de documento.  Como columna clave, indicamos los n√∫meros mismos, no se necesitan m√°s columnas sustitutas previamente divididas.  Aseg√∫rese de especificar el "idioma n√∫mero 1" para usar el rompedor de palabras reci√©n instalado. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">drop fulltext index </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">on</span></span></span><span class="hljs-function"> document go create fulltext index </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">on</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">document</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">number Language </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">) key index ndx1 with change_tracking</span></span> = Auto</code> </pre> <br>  Cheque? <br><br><img src="https://habrastorage.org/webt/1p/se/zz/1psezzovwm3mnoweyyfkpoo6o34.png"><br><br>  Funciona!  Funciona tan r√°pido como todos los ejemplos discutidos anteriormente. <br><br>  Veamos la larga l√≠nea en la que se tropez√≥ la opci√≥n anterior: <br><br><img src="https://habrastorage.org/webt/iq/to/n8/iqton8zugajg5e85tcaieenab7k.png"><br><br>  La b√∫squeda funciona de forma transparente para el usuario y el programador.  Wordbreaker rompe independientemente la cadena de b√∫squeda en pedazos y encuentra el resultado deseado. <br><br>  Resulta que ahora no necesitamos columnas y disparadores adicionales, es decir, la soluci√≥n es m√°s simple (l√©ase: m√°s confiable) que nuestro intento anterior.  Bueno, en t√©rminos de soporte, tal implementaci√≥n es m√°s simple y m√°s transparente, hay menos posibilidades de errores. <br><br>  Entonces, para, ¬ødije "m√°s confiable"?  ¬°Acabamos de conectar una biblioteca de terceros a nuestro DBMS!  ¬øY qu√© pasar√° si ella se cae?  ¬°Incluso inadvertidamente arrastra todo el servicio de base de datos! <br><br>  Aqu√≠ debe recordar c√≥mo al principio del art√≠culo mencion√© el servicio de b√∫squeda de texto completo, separado del proceso principal de DBMS.  Es aqu√≠ donde queda claro por qu√© esto es importante.  La biblioteca se conecta al servicio de indexaci√≥n de texto completo, que puede operar con derechos reducidos.  Y, lo que es m√°s importante, si caen componentes de terceros, solo caer√° el servicio de indexaci√≥n.  La b√∫squeda se detendr√° por un tiempo (pero ya es as√≠ncrona), y el motor de la base de datos continuar√° funcionando como si nada hubiera pasado. <br><br>  Para resumir.  Agregar su propio rompecorazones puede ser todo un desaf√≠o.  Pero cuando se juega "a la larga", estos esfuerzos dan resultado con una mayor flexibilidad y facilidad de mantenimiento.  La elecci√≥n, como siempre, es tuya. <br><br><h2>  ¬øPor qu√© es todo esto necesario? </h2><br>  Un lector curioso probablemente se pregunt√≥ m√°s de una vez: "todo esto es genial, pero ¬øc√≥mo puedo usar estas funciones si no puedo cambiar las consultas de b√∫squeda desde mi aplicaci√≥n?"  Pregunta razonable  La inclusi√≥n de la b√∫squeda de MS SQL de texto completo requiere cambiar la sintaxis de las consultas, y a menudo esto simplemente no es posible en la arquitectura existente. <br><br>  Puede intentar enga√±ar a la aplicaci√≥n "deslizando" una funci√≥n con valores de tabla del mismo nombre en lugar de una tabla normal, que ya realizar√° la b√∫squeda de la manera que deseamos.  Puede intentar vincular la b√∫squeda como una especie de fuente de datos externa.  Hay otra soluci√≥n, Softpoint Data Cluster, un servicio especial que instala un "reenv√≠o" entre la aplicaci√≥n de origen y el servicio SQL Server, escucha el tr√°fico y puede cambiar las solicitudes "sobre la marcha" de acuerdo con reglas especiales.  Usando estas reglas, podemos encontrar consultas regulares con LIKE y convertirlas a CONTAINS con b√∫squeda de texto completo. <br><br>  ¬øPor qu√© tantas dificultades?  A√∫n as√≠, la velocidad de b√∫squeda es cautivadora.  En un sistema muy cargado, donde los operadores a menudo buscan registros en millones de tablas, la velocidad de respuesta es cr√≠tica.  Ahorrar tiempo en la operaci√≥n m√°s frecuente da como resultado docenas de aplicaciones procesadas adicionales, y esto es dinero real, con lo que cualquier negocio est√° contento.  Al final, unos d√≠as o incluso semanas para estudiar e implementar la tecnolog√≠a dar√° sus frutos con una mayor eficiencia del operador. <br><br>  Todos los scripts mencionados en el art√≠culo est√°n disponibles en el repositorio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/frrrost/mssql_fulltext</a> <br><br><h2>  Sobre el autor </h2><br><img src="https://habrastorage.org/webt/xh/rm/q5/xhrmq5imxl5i7n9cp6lfjejy9w8.png" align="left" width="120">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Alexander Denisov</a> - Analista de rendimiento de la base de datos MS SQL Server.  En los √∫ltimos 6 a√±os, como parte del equipo de Softpoint, he estado ayudando a encontrar cuellos de botella en las solicitudes de otras personas y aprovechar al m√°ximo las bases de datos de los clientes. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/470139/">https://habr.com/ru/post/470139/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../470125/index.html">No juzgues estrictamente el c√≥digo de otra persona</a></li>
<li><a href="../470127/index.html">Compositor con una larga memoria a corto plazo.</a></li>
<li><a href="../470129/index.html">Gesti√≥n declarativa de memoria</a></li>
<li><a href="../470133/index.html">C√≥mo recopilar m√©tricas no distorsionadas por referencia de tiempo con Prometheus</a></li>
<li><a href="../470135/index.html">¬øUna aplicaci√≥n web interactiva sin programaci√≥n? F√°cil! Mavo en tus brazos</a></li>
<li><a href="../470145/index.html">‚Äú¬°Cuidado, FAS!‚Äù: ¬øPor qu√© es peligroso el boleto militar en la publicidad, por qu√© es importante saber matem√°ticas y si siempre se necesita la verdad?</a></li>
<li><a href="../470149/index.html">No habr√° colecciones inmutables en Java, ni ahora ni nunca</a></li>
<li><a href="../470153/index.html">Diccionario del modelo de datos</a></li>
<li><a href="../470155/index.html">Caracter√≠sticas del reconocimiento nacional de patrones</a></li>
<li><a href="../470159/index.html">Primera generaci√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>