<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÇüèª üï∞Ô∏è üëÅÔ∏è PHP ass√≠ncrono e a hist√≥ria de uma bicicleta ‚õ©Ô∏è üèª ü§£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ap√≥s o lan√ßamento do PHP7, tornou-se poss√≠vel escrever aplicativos de longa dura√ß√£o a um custo relativamente baixo. Para programadores, projetos como ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP ass√≠ncrono e a hist√≥ria de uma bicicleta</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451916/"><p> Ap√≥s o lan√ßamento do PHP7, tornou-se poss√≠vel escrever aplicativos de longa dura√ß√£o a um custo relativamente baixo.  Para programadores, projetos como <code>prooph</code> , <code>broadway</code> , <code>prooph</code> , <code>messenger</code> foram disponibilizados, cujos autores assumem a solu√ß√£o dos problemas mais comuns.  Mas e se voc√™ der um pequeno passo adiante, investigando a quest√£o? </p><br><p>  Vamos tentar descobrir o destino de outra bicicleta, que permite implementar o aplicativo Publicar / Assinar. </p><a name="habracut"></a><br><p>  Para come√ßar, tentaremos revisar brevemente as tend√™ncias atuais no mundo do PHP, bem como uma breve vis√£o da opera√ß√£o ass√≠ncrona. </p><br><h3 id="php-sozdan-chtoby-umirat">  PHP criado para morrer </h3><br><p>  Durante muito tempo, o PHP foi usado principalmente no fluxo de trabalho de solicita√ß√£o / resposta.  Do ponto de vista dos desenvolvedores, isso √© bastante conveniente, porque n√£o h√° necessidade de se preocupar com vazamentos de mem√≥ria, monitorar conex√µes. </p><br><p>  Todas as consultas ser√£o executadas isoladamente, os recursos utilizados ser√£o liberados e as conex√µes, por exemplo, com o banco de dados ser√£o fechadas quando o processo for conclu√≠do. </p><br><p>  Como exemplo, voc√™ pode usar um aplicativo CRUD regular, escrito com base na estrutura do Symfony.  Para ler o banco de dados e retornar o JSON, √© necess√°rio executar v√°rias etapas (para economizar espa√ßo e tempo, exclua as etapas para gerar / executar opcodes): </p><br><ul><li>  An√°lise da configura√ß√£o; </li><li>  Compila√ß√£o de cont√™ineres; </li><li>  Solicitar roteamento </li><li>  Cumprimento; </li><li>  Renderizando o resultado. </li></ul><br><p>  Como no caso do PHP (usando aceleradores), a estrutura usa ativamente o armazenamento em cache (algumas tarefas n√£o ser√£o conclu√≠das na pr√≥xima solicita√ß√£o), bem como a inicializa√ß√£o atrasada.  A partir da vers√£o 7.4, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pr√©</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">carregamento</a> estar√° dispon√≠vel, o que otimizar√° ainda mais a inicializa√ß√£o do aplicativo. </p><br><p>  No entanto, n√£o √© poss√≠vel remover completamente todos os custos indiretos da inicializa√ß√£o. </p><br><h3 id="pomozhem-php-vyzhit">  Vamos ajudar o PHP a sobreviver </h3><br><p>  A solu√ß√£o para o problema parece bastante simples: se voc√™ executar o aplicativo sempre que for muito caro, precisar√° inicializ√°-lo uma vez e depois passar solicita√ß√µes para ele, controlando sua execu√ß√£o. </p><br><p>  Existem projetos no ecossistema PHP, como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">php-pm</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RoadRunner</a> .  Ambos conceitualmente fazem a mesma coisa: </p><br><ul><li>  √â criado um processo pai que atua como um supervisor; </li><li>  Um conjunto de processos filhos √© criado; </li><li>  Quando uma solicita√ß√£o √© recebida, o mestre recupera o processo do pool e passa a solicita√ß√£o para ele.  O cliente est√° pendente neste momento; </li><li>  Depois que a tarefa √© conclu√≠da, o mestre retorna o resultado ao cliente e o processo filho √© enviado de volta ao pool. </li></ul><br><p>  Se algum processo filho morrer, o supervisor o cria novamente e o adiciona ao pool.  Criamos um daemon de nosso aplicativo com um √∫nico objetivo: remover a sobrecarga de inicializa√ß√£o, aumentando significativamente a velocidade das solicita√ß√µes de processamento.  Essa √© a maneira mais indolor de aumentar a produtividade, mas n√£o a √∫nica. </p><br><blockquote>  Nota: <br>  muitos exemplos da s√©rie ‚Äúpegue o ReactPHP e acelere o Laravel N times‚Äù andam na rede.  √â importante entender a diferen√ßa entre demonizar (e, como resultado, economizar tempo ao inicializar o aplicativo) e multitarefa. <br>  Ao usar php-pm ou roadrunner, seu c√≥digo n√£o fica bloqueado.  Voc√™ economiza tempo na inicializa√ß√£o. <br>  Comparando php-pm, roadrunner e ReactPHP / Amp / Swoole √© incorreto por defini√ß√£o. </blockquote><br><h5 id="php-i-io">  PHP e E / S </h5><br><p>  A intera√ß√£o com E / S no PHP √© executada por padr√£o no modo de bloqueio.  Isso significa que, se executarmos uma solicita√ß√£o para atualizar as informa√ß√µes na tabela, o fluxo de execu√ß√£o ser√° interrompido, aguardando uma resposta do banco de dados.  Quanto mais essas chamadas estiverem no processo de processamento da solicita√ß√£o, mais tempo os recursos do servidor estar√£o inativos.  De fato, no processo de processamento da solicita√ß√£o, precisamos acessar o banco de dados v√°rias vezes, escrever algo no log e retornar o resultado ao cliente, no final - tamb√©m uma opera√ß√£o de bloqueio. </p><br><blockquote>  Imagine que voc√™ √© um operador de call center e precisa ligar para 50 clientes em uma hora. <br>  Voc√™ disca o primeiro n√∫mero e l√° est√° ocupado (o assinante discute por telefone a √∫ltima s√©rie de Game of Thrones e o que a s√©rie trouxe). <br>  E agora voc√™ est√° sentado e tentando alcan√ß√°-lo antes da vit√≥ria.  O tempo passa, a mudan√ßa est√° chegando ao fim.  Tendo perdido 40 minutos tentando alcan√ßar o primeiro assinante, voc√™ perdeu a oportunidade de entrar em contato com outras pessoas e naturalmente recebida do chefe. <br>  Mas voc√™ pode fazer o contr√°rio: n√£o espere at√© que o primeiro assinante esteja livre e assim que ouvir um sinal sonoro, desligue e comece a discar o pr√≥ximo n√∫mero.  Voc√™ pode retornar ao primeiro um pouco mais tarde. <br>  Com essa abordagem, as chances de telefonar para o n√∫mero m√°ximo de pessoas aumentam bastante, e a velocidade do seu trabalho n√£o depende da tarefa mais lenta. </blockquote><p>  O c√≥digo que n√£o bloqueia o encadeamento de execu√ß√£o (n√£o usa chamadas de E / S de bloqueio, al√©m de fun√ß√µes como <code>sleep()</code> ) √© chamado de ass√≠ncrono. </p><br><p>  Vamos voltar ao nosso aplicativo Symfony CRUD.  √â quase imposs√≠vel faz√™-lo funcionar no modo ass√≠ncrono devido √† abund√¢ncia do uso de fun√ß√µes de bloqueio: todos trabalham com configura√ß√µes, caches, log, renderiza√ß√£o da resposta, intera√ß√£o com o banco de dados. </p><br><p>  Mas essas s√£o todas as conven√ß√µes, vamos tentar lan√ßar o Symfony e usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Amp</a> , que fornece uma implementa√ß√£o do Event Loop (incluindo v√°rios binders), Promises e Coroutines, como uma cereja no bolo para resolver nosso problema. </p><br><p>  Promessa √© uma maneira de organizar c√≥digo ass√≠ncrono.  Por exemplo, precisamos acessar algum recurso http. </p><br><p>  Criamos um objeto de solicita√ß√£o e o passamos para o transporte, que o Promise retorna para n√≥s contendo o estado atual.  Existem tr√™s estados poss√≠veis: </p><br><ul><li>  Sucesso: nossa solicita√ß√£o foi conclu√≠da com sucesso; </li><li>  Erro: durante a execu√ß√£o da solicita√ß√£o, algo deu errado (por exemplo, o servidor retornou uma resposta de 500); </li><li>  Aguardando: o processamento da solicita√ß√£o ainda n√£o foi iniciado. </li></ul><br><p>  Cada promessa tem um m√©todo (no exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">promessa √©</a> analisada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">por Amp</a> ) - <code>onResolve()</code> , no qual uma fun√ß√£o de retorno de chamada com dois argumentos √© passada </p><br><pre> <code class="php hljs">$promise-&gt;onResolve( <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(?/Throwable $throwable, $result)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> !== $throwable) { <span class="hljs-comment"><span class="hljs-comment">/**   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/**  */</span></span> } );</code> </pre> <br><p>  Depois que recebemos o Promise, surge a pergunta: quem ir√° monitorar seu status e nos notificar sobre a altera√ß√£o de status? </p><br><p>  Para isso, o Loop de Eventos √© usado. </p><br><p>  Em ess√™ncia, um loop de eventos √© um planejador que monitora a execu√ß√£o.  Assim que a tarefa for conclu√≠da (n√£o importa como), a chamada que passamos para o Promise ser√° chamada. </p><br><p>  Quanto √†s nuances, eu recomendaria a leitura de um artigo de Nikita Popov: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">multitarefa cooperativa usando corotinas</a> .  Isso ajudar√° a esclarecer o que est√° acontecendo e onde est√£o os geradores. </p><br><p>  Armado com novos conhecimentos, vamos tentar retornar √† nossa tarefa de renderiza√ß√£o JSON. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://github.com/amphp/">Um exemplo de</a> processamento de uma solicita√ß√£o http recebida usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://github.com/amphp/">servidor anfph / http</a> . <br>  Assim que recebemos a solicita√ß√£o, √© executada uma leitura ass√≠ncrona do banco de dados (obtemos Promise) e, ap√≥s a conclus√£o, o usu√°rio receber√° o cobi√ßado JSON, formado com base nos dados recebidos. </p><br><blockquote>  Se precisarmos ouvir uma porta de v√°rios processos, podemos olhar para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">anfph / cluster</a> </blockquote><p>  A principal diferen√ßa √© que um √∫nico processo pode atender a v√°rias solicita√ß√µes por vez, devido ao fato de o encadeamento de execu√ß√£o n√£o estar bloqueado.  O cliente receber√° sua resposta quando a leitura do banco de dados estiver conclu√≠da e, enquanto n√£o houver resposta, voc√™ poder√° come√ßar a atender a pr√≥xima solicita√ß√£o. </p><br><h3 id="divnyy-mir-asinhronnogo-php">  O maravilhoso mundo do PHP ass√≠ncrono </h3><br><blockquote>  Isen√ß√£o de responsabilidade <br>  PHP ass√≠ncrono √© considerado no contexto de ex√≥ticos e n√£o √© considerado algo saud√°vel / normal.  Basicamente, eles v√£o esperar risadas no estilo de "pegue GO / Kotlin, um tolo", etc.  Eu n√£o diria que essas pessoas est√£o erradas, mas ... </blockquote><p>  Existem v√°rios projetos que ajudam a escrever c√≥digo PHP sem bloqueio.  Na estrutura do artigo, n√£o analisarei completamente todos os pr√≥s e contras, mas tentarei apenas examinar cada um deles superficialmente. </p><br><h5 id="swoolehttpswwwswoolecouk">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Swoole</a> </h5><br><p>  Uma estrutura ass√≠ncrona escrita em contraste com as outras em C e entregue como uma extens√£o do PHP.  Possui talvez os melhores indicadores de desempenho no momento. </p><br><p>  H√° uma implementa√ß√£o de canais, corutin e outras coisas saborosas, mas ele tem 1 grande menos - a documenta√ß√£o.  Embora seja parcialmente em ingl√™s, na minha opini√£o, n√£o √© muito detalhado, e a API em si n√£o √© muito √≥bvia. </p><br><p>  Quanto √† comunidade, tamb√©m n√£o √© tudo simples e inequ√≠voco.  Pessoalmente, n√£o conhe√ßo uma √∫nica pessoa viva que use Swoole em batalha.  Talvez eu supere meus medos e migrei para ele, mas isso n√£o acontecer√° no futuro pr√≥ximo. </p><br><p>  √Äs desvantagens, voc√™ tamb√©m pode adicionar que contribuir para o projeto (usando solicita√ß√£o de recebimento) com quaisquer altera√ß√µes tamb√©m √© dif√≠cil se voc√™ n√£o conhece C no n√≠vel adequado. </p><br><h5 id="workermanhttpsgithubcomwalkorworkerman">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Trabalhador</a> </h5><br><p>  Se perder em velocidade para o seu concorrente (falando sobre Swoole), isso n√£o √© muito percept√≠vel e a diferen√ßa em v√°rios cen√°rios pode ser negligenciada. </p><br><p>  Possui integra√ß√£o com o ReactPHP, que, por sua vez, expande o n√∫mero de implementa√ß√µes de problemas de infraestrutura.  Para economizar espa√ßo, descreverei os contras, juntamente com o ReactPHP. </p><br><h5 id="reactphphttpsreactphporg">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ReactPHP</a> </h5><br><p>  As vantagens incluem uma comunidade bastante grande e um grande n√∫mero de exemplos.  Os contras come√ßam a aparecer no processo de uso - esse √© o conceito da Promise. <br>  Se voc√™ precisar executar v√°rias opera√ß√µes ass√≠ncronas, o c√≥digo se transformar√° em um lixo intermin√°vel de chamadas (aqui est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um exemplo de uma conex√£o simples com o RabbiqMQ</a> sem criar troca / fila e seus ligantes). </p><br><p>  Com algum refinamento em um arquivo (considerado a norma), voc√™ pode obter uma implementa√ß√£o da corotina, que ajudar√° a se livrar do inferno da Promise. </p><br><p>  Sem o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">projeto recoilphp / recoil, o</a> uso do ReactPHP, na minha opini√£o, n√£o √© poss√≠vel em um aplicativo sensato. </p><br><p>  Al√©m disso, al√©m de tudo o mais, sente-se que seu desenvolvimento desacelerou muito.  N√£o basta, por exemplo, trabalho normal com o PostgreSQL. </p><br><h5 id="amphttpsamphporgamp">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Amp</a> </h5><br><p>  Na minha opini√£o, a melhor das op√ß√µes que existem no momento atual. <br>  Al√©m da promessa usual, h√° uma implementa√ß√£o da Coroutine, que facilita muito o processo de desenvolvimento e o c√≥digo parece mais familiar aos programadores de PHP. </p><br><p>  Os desenvolvedores constantemente complementam e melhoram o projeto, com feedback tamb√©m n√£o h√° problemas. </p><br><p>  Infelizmente, com todas as vantagens da estrutura, a comunidade √© relativamente pequena, mas ao mesmo tempo h√° implementa√ß√µes, por exemplo, trabalhando com o PostgreSQL, al√©m de todas as coisas b√°sicas (sistema de arquivos, cliente http, DNS, etc). </p><br><p>  Ainda n√£o entendo bem o destino do projeto ext-async, mas os caras o acompanham.  O que vir√° disso na 3¬™ vers√£o, o tempo dir√°. </p><br><h3 id="pristupaem-k-realizacii">  Introdu√ß√£o </h3><br><p>  Ent√£o, resolvemos um pouco a parte te√≥rica, √© hora de praticar e preencher os incha√ßos. </p><br><p>  Primeiro, formalizamos um pouco os requisitos: </p><br><ul><li>  Mensagens ass√≠ncronas (o conceito de <code>message</code> si pode ser dividido em 2 tipos) <br><ul><li>  <code>command</code> : indica a necessidade de concluir a tarefa.  N√£o retorna um resultado (pelo menos no caso de comunica√ß√£o ass√≠ncrona); </li><li>  <code>event</code> : relata qualquer altera√ß√£o de estado (por exemplo, como resultado de um comando). </li></ul></li><li>  Formato sem bloqueio para trabalhar com E / S; </li><li>  A capacidade de aumentar facilmente o n√∫mero de processadores; </li><li>  Capacidade de escrever manipuladores de mensagens em qualquer idioma. </li></ul><br><blockquote>  Qualquer mensagem √© inerentemente uma estrutura simples e compartilhada apenas pela sem√¢ntica.  A nomea√ß√£o de mensagens √© extremamente importante do ponto de vista da compreens√£o do tipo e objetivo (embora este ponto seja ignorado no exemplo). </blockquote><p>  Para uma lista de requisitos, √© mais adequada uma implementa√ß√£o simples do padr√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Publicar / Assinar</a> . <br>  Para garantir a execu√ß√£o distribu√≠da, usaremos o RabbitMQ como um intermedi√°rio de mensagens. </p><br><p>  O prot√≥tipo foi escrito usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ReactPHP</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bunny</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DoctrineDBAL</a> . <br>  Um leitor atento pode perceber que o Dbal usa chamadas de bloqueio de pdo / mysqli internamente, mas no est√°gio atual isso n√£o era particularmente importante, pois voc√™ tinha que entender o que deveria acontecer no final. </p><br><p>  Um dos problemas foi a falta de bibliotecas para trabalhar com o PostgreSQL.  Existem alguns rascunhos, mas isso n√£o √© suficiente para o trabalho completo (mais sobre isso abaixo). </p><br><p>  Ap√≥s uma breve pesquisa, o ReactPHP foi removido em favor do Amp, pois √© relativamente simples e se desenvolve ativamente. </p><br><h5 id="rabbitmq-transport">  RabbitMQ transport </h5><br><p>  Mas com todas as vantagens do Amp, houve um problema: O Amp n√£o possui um driver para o RabbitMQ (o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bunny</a> suporta apenas o ReactPHP). </p><br><p>  Em teoria, o Amp permite usar o Promise de um concorrente.  Parece que tudo deve ser simples, mas o ReactPHP usa o Event Loop para trabalhar com soquetes na biblioteca. <br>  Em um determinado momento, obviamente, dois Loops de Eventos diferentes n√£o puderam ser iniciados, portanto n√£o pude usar a fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">adap ()</a> . </p><br><p>  Infelizmente, a qualidade do c√≥digo no bunny deixou muito a desejar e n√£o foi poss√≠vel substituir adequadamente uma implementa√ß√£o por outra.  Para n√£o interromper o trabalho, foi decidido reescrever a biblioteca um pouco para que funcione com o Amp e n√£o leve ao bloqueio do fluxo de execu√ß√£o. </p><br><p>  Essa adapta√ß√£o parecia muito assustadora, o tempo todo eu tinha muita vergonha, mas o mais importante era que funcionava.  Bem, como n√£o h√° nada mais permanente do que tempor√°rio, o adaptador permaneceu na expectativa de uma pessoa que n√£o tem pregui√ßa de lidar com a implementa√ß√£o do driver. </p><br><p>  E esse homem foi encontrado.  O projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PHPinnacle</a> , entre outras coisas, fornece uma implementa√ß√£o de um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">adaptador</a> personalizado para o Amp. </p><br><blockquote>  O nome do autor √© Anton Shabovta, que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">falar√° sobre php ass√≠ncrono</a> dentro da estrutura do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PHP Russia</a> e sobre o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">desenvolvimento de drivers</a> para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PHP nos dias √∫teis</a> . </blockquote><br><h5 id="postgresql">  PostgreSQL </h5><br><p>  A segunda caracter√≠stica do trabalho √© a intera√ß√£o com o banco de dados.  Nas condi√ß√µes do PHP ‚Äútradicional‚Äù, tudo √© simples: temos uma conex√£o e todos os pedidos s√£o executados sequencialmente. </p><br><p>  No caso de execu√ß√£o ass√≠ncrona, precisamos executar simultaneamente v√°rias solicita√ß√µes (por exemplo, 3 transa√ß√µes).  Para poder fazer isso, √© necess√°ria uma implementa√ß√£o do conjunto de conex√µes. </p><br><p>  O mecanismo do trabalho √© bastante simples: </p><br><ul><li>  abrimos <em>N</em> conex√µes na inicializa√ß√£o (ou inicializa√ß√£o atrasada, n√£o √© o ponto); </li><li>  se necess√°rio, retiramos a conex√£o do pool, garantindo que ningu√©m mais possa us√°-lo; </li><li>  Executamos a solicita√ß√£o e destru√≠mos a conex√£o ou a devolvemos ao pool (preferencial). </li></ul><br><p>  Primeiro, ele permite iniciar v√°rias transa√ß√µes ao mesmo tempo e, em segundo lugar, acelera o trabalho devido √† presen√ßa de conex√µes j√° abertas.  O Amp possui um componente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">amphp / postgres</a> .  Ele cuida das conex√µes: monitora o n√∫mero, a vida √∫til e tudo isso sem bloquear o fluxo de execu√ß√£o. </p><br><p>  A prop√≥sito, ao usar, por exemplo, o ReactPHP, voc√™ precisar√° implementar isso sozinho se quiser trabalhar com um banco de dados. </p><br><h5 id="mutex">  Mutex </h5><br><p>  Para uma opera√ß√£o eficaz e, mais importante, adequada do aplicativo, √© necess√°rio implementar algo semelhante aos mutexes.  Podemos distinguir tr√™s cen√°rios para seu uso: </p><br><ul><li>  Dentro da estrutura de um processo, um mecanismo simples de mem√≥ria √© adequado sem excedentes; </li><li>  Se queremos fornecer bloqueio em v√°rios processos, podemos usar o sistema de arquivos (√© claro, no modo sem bloqueio); </li><li>  Se no contexto de v√°rios servidores, voc√™ j√° precisa pensar em algo como o Zookeeper. </li></ul><br><p>  Mutexes s√£o necess√°rios para resolver problemas de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">condi√ß√£o de corrida</a> .  Afinal, n√£o sabemos (e n√£o sabemos) em que ordem nossas tarefas ser√£o executadas, mas, no entanto, precisamos garantir a integridade dos dados. </p><br><h5 id="logirovaniekonteksty">  Log / Contextos </h5><br><p>  Para o registro, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Monolog</a> j√° se tornou padr√£o, mas com algumas ressalvas: n√£o podemos usar os manipuladores internos, pois eles levar√£o a bloqueios. <br>  Para gravar no stdOut, voc√™ pode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">usar o anfph / log</a> ou escrever uma mensagem simples enviando para algum Graylog. </p><br><p>  Como em um momento, podemos processar muitas tarefas e, ao registrar registros, voc√™ precisa entender em que contexto os dados s√£o gravados.  Durante os experimentos, foi decidido fazer <code>trace_id</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">rastreamento distribu√≠do</a> ).  A linha inferior √© que toda a cadeia de chamadas deve ser acompanhada por um identificador de passagem que possa ser rastreado.  Al√©m disso, no momento do recebimento da mensagem, <code>package_id</code> gerado, o que indica exatamente a mensagem recebida. </p><br><p>  Assim, usando os dois identificadores, podemos rastrear facilmente a que determinado registro se refere.  O fato √© que, no PHP tradicional, todos os registros que obtemos no log est√£o principalmente na ordem em que foram gravados.  No caso de execu√ß√£o ass√≠ncrona, n√£o h√° padr√£o na ordem das entradas. </p><br><h5 id="terminating">  Terminando </h5><br><p>  Outra das nuances do desenvolvimento ass√≠ncrono √© controlar o desligamento do nosso daemon.  Se voc√™ simplesmente finalizar o processo, todas as tarefas em andamento n√£o ser√£o conclu√≠das e os dados ser√£o perdidos.Na abordagem usual, existe um problema, mas n√£o √© t√£o grande, porque apenas uma tarefa √© executada por vez. </p><br><p>  Para concluir a execu√ß√£o corretamente, precisamos: </p><br><ul><li>  Cancele a inscri√ß√£o na fila.  Em outras palavras, torne imposs√≠vel receber novas mensagens; </li><li>  Conclua todas as tarefas restantes (aguarde a resolu√ß√£o de promessas); </li><li>  E somente depois disso termine o script. </li></ul><br><h5 id="utechki-otladka">  Vazamentos, depura√ß√£o </h5><br><p>  Ao contr√°rio da cren√ßa popular, no PHP moderno n√£o √© t√£o simples enfrentar situa√ß√µes nas quais ocorre um vazamento de mem√≥ria.  √â necess√°rio fazer algo absolutamente errado. </p><br><p>  No entanto, uma vez confrontado com isso, mas por causa do descuido banal.  Durante a implementa√ß√£o da pulsa√ß√£o, um novo timer foi adicionado a cada 40 segundos para consultar a conex√£o.  N√£o √© dif√≠cil adivinhar que, depois de algum tempo, o uso da mem√≥ria come√ßou a surgir rapidamente. </p><br><p>  Al√©m disso, ele escreveu um observador simples que iniciar√° opcionalmente a cada 10 minutos e chamar√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gc_collect_cycles ()</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gc_mem_caches ()</a> . <br>  Mas o in√≠cio for√ßado do coletor de lixo n√£o √© algo necess√°rio e fundamental. </p><br><p>  Para ver constantemente o uso da mem√≥ria, um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MemoryUsageProcessor</a> padr√£o foi adicionado ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">log</a> . </p><br><p>  Se surgir o pensamento de que o Loop de Eventos est√° bloqueando algo, isso tamb√©m pode ser verificado com facilidade: basta conectar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">LoopBlockWatcher</a> . </p><br><p>  Mas voc√™ precisa garantir que esse observador n√£o inicie no ambiente de produ√ß√£o.  Esse recurso √© usado exclusivamente durante o desenvolvimento. </p><br><h3 id="rezultaty">  Resultados </h3><br><p>     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">php-service-bus</a> ,    Message Based . </p><br><p>    ,         : </p><br><pre> <code class="plaintext hljs">composer create-project php-service-bus/skeleton pub-sub-example cd pub-sub-example docker-compose up --build -d</code> </pre> <br><p>   ,      ,   . </p><br><p>   <code>/bin/consumer</code>   ,    . <br>   <code>/src</code>  3 : <code>Ping</code>   ; <code>Pong</code> :    ; <code>PingService</code> : ,   . <br>     <code>PingService</code> ,      2 : </p><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@CommandHandler</span></span></span><span class="hljs-comment">() */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ping $command, KernelContext $context)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $context-&gt;delivery(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pong()); } <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@EventListener</span></span></span><span class="hljs-comment">() */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">whenPong</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Pong $event, KernelContext $context)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $context-&gt;logContextMessage(<span class="hljs-string"><span class="hljs-string">'Pong message received'</span></span>); }</code> </pre> <br><ul><li> <code>handle</code>    (        1 ).      <code>@CommandHandler</code> ; <br><ul><li>   Promise ,        RabbitMQ (   <code>delivery()</code> ).       ,   RabbitMQ    . </li></ul></li><li> <code>whenPong</code> ‚Äî   <code>Pong</code> .            .     <code>@EventListener</code> ; <br><blockquote>  ,     ‚Äî   . , , ,     .     php-service-bus  , ,            . <br></blockquote></li></ul><br><p>     2 : ,   (  )  .          ,     ,     (, ). </p><br><p>     <code>Ping</code> ,      <code>Pong</code> .     . </p><br><p>    ,       RabbitMQ: </p><br><pre> <code class="plaintext hljs">tools/ping</code> </pre> <br><p>    ,  php-service-bus     ,  Message based . </p><br><p> Ping\Pong,    ‚Äî ,  ,  <code>Hello, world</code>       . </p><br><p>     ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> . </p><br><p>     - ,    , , Saga pattern (Process manager)        . </p><br><h3 id="nu-i-kak-zhe-ne-pomeryatsya">       </h3><br><p>   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  symfony/messenger</a> . </p><br><p>    ,      ,      . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt451916/">https://habr.com/ru/post/pt451916/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt451902/index.html">Acampamento do desenvolvedor do Microsoft Azure na R√∫ssia</a></li>
<li><a href="../pt451904/index.html">√Äs vezes, mais √© menos. Quando uma diminui√ß√£o na carga leva a um aumento no atraso</a></li>
<li><a href="../pt451906/index.html">Vulnerabilidade do Exchange: Como detectar eleva√ß√£o de privil√©gio para um administrador de dom√≠nio</a></li>
<li><a href="../pt451908/index.html">A hist√≥ria dos computadores: uma noite no Museu Yandex</a></li>
<li><a href="../pt451912/index.html">Rede neural profunda do MuseNet grava m√∫sica</a></li>
<li><a href="../pt451918/index.html">Para a quest√£o da TI</a></li>
<li><a href="../pt451920/index.html">Otimize o armazenamento de mensagens no Zimbra Collaboration Suite</a></li>
<li><a href="../pt451922/index.html">Aritm√©tica de ponto fixo em C ++</a></li>
<li><a href="../pt451926/index.html">Sobre o c√≥digo ao vivo ap√≥s 130 transmiss√µes</a></li>
<li><a href="../pt451928/index.html">Como configurar a an√°lise da web nas p√°ginas AMP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>