<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äç‚ù§Ô∏è‚Äçüë© üë®‚Äçüöí üíø Novamente sobre abstra√ß√µes holey (ou sobre um ambiente imprevis√≠vel) ‚ò∏Ô∏è ü•Ñ üå•Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Portanto, uma parte bastante simples do programa para Windows. H√° um arquivo contendo v√°rias entradas. E eles precisam ser filtrados de uma certa mane...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Novamente sobre abstra√ß√µes holey (ou sobre um ambiente imprevis√≠vel)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450700/">  Portanto, uma parte bastante simples do programa para Windows.  H√° um arquivo contendo v√°rias entradas.  E eles precisam ser filtrados de uma certa maneira. <br><br>  A solu√ß√£o √© bastante simples - abra o arquivo, leia os registros um por um, escrevemos os necess√°rios em um arquivo tempor√°rio.  Feche o arquivo  N√≥s o exclu√≠mos.  Renomeie o tempor√°rio para o original.  Tudo √© t√£o simples que eu nem vou dar o c√≥digo.  Essa √© realmente uma raz√£o suficiente para o artigo? <br><br>  Enquanto tudo funciona, n√£o h√° realmente nenhuma raz√£o para escrever sobre isso.  Mas, de repente, um dia "tudo cai", porque  renomear n√£o ocorre devido a um erro de acesso negado.  Isso acontece muito raramente, mas com muito mais frequ√™ncia suspeitar dos raios c√≥smicos. <br><a name="habracut"></a><br>  Come√ßamos a escava√ß√£o.  A primeira pista encontrada: no processo de escava√ß√£o, esta cita√ß√£o da documenta√ß√£o da Microsoft alertou: <br><blockquote>  A fun√ß√£o DeleteFile marca um arquivo para exclus√£o ao fechar.  Portanto, a exclus√£o do arquivo n√£o ocorre at√© que o √∫ltimo identificador do arquivo seja fechado.  As chamadas subseq√ºentes ao CreateFile para abrir o arquivo falham com ERROR_ACCESS_DENIED. </blockquote>  Em termos de sintomas, √© muito parecido, mas de onde v√™m esses "outros manipuladores", se, al√©m de n√≥s, ningu√©m faz e n√£o deve fazer nada com esse arquivo?  E n√£o temos outros t√≥picos com t√≥picos que fariam algo com esse arquivo? <br><br>  O culpado foi encontrado gra√ßas ao SysInternals e seu ProcessMonitor.  N√≥s o iniciamos, instalamos o filtro em nosso arquivo de longa dura√ß√£o e tentamos reproduzi-lo por um longo e persistente.  N√≥s reproduzimos.  N√≥s olhamos.  E o que vemos l√°? <br><blockquote>  01.2: 30: 28.3162097 PM our_prog.exe 1288 CreateFile our.file SUCESSO Acesso desejado: leitura / grava√ß√£o gen√©rica <br>  02. 2: 25: 28.3164513 PM our_prog.exe 1288 WriteFile our.file SUCCESS Offset: 0, Comprimento: 898, Prioridade: Normal <br>  ... <br>  34.2: 25: 28.3173405 PM our_prog.exe 1288 WriteFile our.file SUCCESS Offset: 35.290, Comprimento: 1.113 <br>  35.2: 25: 28.3173493 PM our_prog.exe 1288 WriteFile our.file SUCCESS Offset: 36.403, Comprimento: 1.128 <br>  36.2: 25: 28.3173736 PM our_prog.exe 1288 FlushBuffersFile our.file SUCCESS <br>  37.2: 25: 28.3174212 PM our_prog.exe 1288 WriteFile our.file SUCCESS Offset: 0, Length: 40.960, <br>  38.2: 25: 28.3175927 PM Explorer.EXE 1884 QueryBasicInformationFile our.file SUCCESS <br>  39.2: 25: 28.3176144 PM Explorer.EXE 1884 FecharFile our.file SUCESSO <br>  40.2: 25: 28.3263642 PM Explorer.EXE 1884 CreateFile our.file SUCESSO Acesso desejado: atributos de leitura, <br>  41.2: 25: 28.3294990 PM our_prog.exe 1288 FecharFile our.file SUCCESS <br>  42.2: 25: 28.3351356 PM our_prog.exe 1288 CreateFile our.file SUCESSO Acesso desejado: ler atributos, excluir, <br>  43.2: 25: 28.3351856 PM our_prog.exe 1288 QueryAttributeTagFile our.file SUCESSO Atributos: A, ReparseTag: 0x0 <br>  44.2: 25: 28.3352020 PM our_prog.exe 1288 SetDispositionInformationFile our.file SUCCESS Excluir: True <br>  45.2: 25: 28.3352218 PM our_prog.exe 1288 FecharFile our.file SUCCESS <br>  46.2: 25: 28.3358275 PM our_prog.exe 1288 CreateFile our.file DELETE PENDING Acesso desejado: leitura / grava√ß√£o gen√©rica, <br>  47.2: 25: 28.3362207 PM our_prog.exe 1288 CreateFile our.file DELETE PENDING Acesso desejado: leitura / grava√ß√£o gen√©rica, <br>  48.2: 25: 28.3367696 PM Explorer.EXE 1884 QueryBasicInformationFile our.file SUCCESS <br>  49.2: 25: 28.4279152 PM Explorer.EXE 1884 FecharFile our.file SUCESSO <br>  50.2: 25: 28.4282859 PM Explorer.EXE 1884 CreateFile our.file NOME N√ÉO ENCONTRADO Acesso desejado: atributos de leitura, <br>  ... <br>  83.2: 25: 29.3497760 PM our_prog.exe 1288 CreateFile our.file SUCESSO Acesso desejado: leitura / grava√ß√£o gen√©rica, </blockquote>  E vemos o seguinte l√° (dados extras foram exclu√≠dos para n√£o desorganizar).  Linhas 1 a 36 - criamos um arquivo, escrevemos nele, fazemos flush.  O mais interessante come√ßa nas linhas 38-40.  Explorer.exe aparece do nada e come√ßa a ler nosso arquivo. <br><br>  Na linha 41, fechamos nosso arquivo.  Na linha 42 - excluir.  E como o explorer.exe ainda est√° lendo, o arquivo n√£o √© exclu√≠do.  O que podemos ver nas linhas 46 e 47 quando tentamos renomear nosso arquivo tempor√°rio para o principal (status DELETE PENDING PENDING em vez de SUCESSO). <br><br>  Explorer.exe termina a leitura apenas na linha 49. Somente nesse momento o arquivo √© fisicamente exclu√≠do (como a linha 50 indica indiretamente, onde nosso persister explorer.exe novamente tenta abrir o arquivo para leitura, mas falha porque o arquivo n√£o mais). <br><br>  O que se segue disso?  Gra√ßas ao Microsoft Windows, mesmo uma opera√ß√£o simples de exclus√£o de arquivos agora precisa ser feita no estilo de programa√ß√£o paran√≥ica.  Eles chamaram a fun√ß√£o de exclus√£o, certificaram-se de que ela retornou OK e entraram no ciclo de espera "at√© que o arquivo j√° tenha sido fisicamente exclu√≠do".  Bem, sim, sem saber que "ela tem um n√©on por dentro", quase nada pode ser feito ... <br><br>  Mas agora a d√∫vida est√° me atormentando de que tal abordagem √© uma pr√°tica geralmente aceita.  Para ter em mente, durante qualquer trabalho com arquivos no Windows, que o SO, a qualquer momento, decida fazer algo com os arquivos sem o seu conhecimento e escreva um c√≥digo resistente a isso.  Nesse contexto, a pesquisa √© menor. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt450700/">https://habr.com/ru/post/pt450700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt450686/index.html">Tr√™s outros recursos n√£o √≥bvios do Zimbra Collaboration Suite que ajudar√£o a aumentar a produtividade dos funcion√°rios</a></li>
<li><a href="../pt450692/index.html">Como as empresas usam 7 pecados capitais nas vendas de produtos</a></li>
<li><a href="../pt450694/index.html">Por que Jeff Bezos recomenda falhas de escala e assistindo a fic√ß√£o cient√≠fica</a></li>
<li><a href="../pt450696/index.html">Gerador de widget CRUD para Yii</a></li>
<li><a href="../pt450698/index.html">Engrenagens em Box2D</a></li>
<li><a href="../pt450702/index.html">O lugar √© maldito?</a></li>
<li><a href="../pt450704/index.html">Semana 19 de Seguran√ßa: Vulnerabilidades em c√¢meras IP, rastreadores GPS e monitores sem fio</a></li>
<li><a href="../pt450708/index.html">Python no Visual Studio Code - vers√£o de abril de 2019</a></li>
<li><a href="../pt450710/index.html">V√≠deos sobre reconstru√ß√£o de Midi a partir de Synthesia (e similares)</a></li>
<li><a href="../pt450712/index.html">DotNetRu na DotNext 2019 Piter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>