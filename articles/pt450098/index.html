<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òÑÔ∏è üìç üñêüèª Yuri Bushmelev ‚ÄúMapa do rake no campo de coleta e entrega de logs‚Äù - transcri√ß√£o do relat√≥rio üìâ üêÜ üè∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Os logs s√£o uma parte importante do sistema, permitindo que voc√™ entenda que ele funciona (ou n√£o), conforme o esperado. Nas condi√ß√µes da arquitetura ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Yuri Bushmelev ‚ÄúMapa do rake no campo de coleta e entrega de logs‚Äù - transcri√ß√£o do relat√≥rio</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450098/"><p>  Os logs s√£o uma parte importante do sistema, permitindo que voc√™ entenda que ele funciona (ou n√£o), conforme o esperado.  Nas condi√ß√µes da arquitetura de microsservi√ßo, o trabalho com logs se torna uma disciplina separada de uma Olimp√≠ada especial.  Voc√™ precisa resolver imediatamente um monte de perguntas: </p><br><ul><li>  como escrever logs do aplicativo; </li><li>  onde escrever logs; </li><li>  como entregar logs para armazenamento e processamento; </li><li>  como processar e armazenar logs. </li></ul><br><p>  O uso de tecnologias de cont√™iner, agora popular, adiciona areia ao rake ao campo de op√ß√µes para resolver o problema. </p><br><p>  Apenas sobre esta decodifica√ß√£o do relat√≥rio de Yuri Bushmelev "Ancinho de mapa no campo da coleta e entrega de toras" </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/NAeedJv-S3I" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Quem se importa, por favor, debaixo do gato. </p><a name="habracut"></a><br><p>  Meu nome √© Yuri Bushmelev.  Eu trabalho na Lazada.  Hoje vou falar sobre como fizemos nossos logs, como os coletamos e o que escrevemos l√°. </p><br><p><img src="https://habrastorage.org/webt/_9/te/o5/_9teo5cvnhsihs4lyyyc_8pcx-m.png"></p><br><p>  De onde n√≥s somos?  Quem somos  Lazada √© a loja on-line n√∫mero 1 em seis pa√≠ses do sudeste asi√°tico.  Todos esses pa√≠ses s√£o distribu√≠dos por data centers.  Agora existem 4 data centers.Por que isso √© importante?  Porque algumas decis√µes se devem ao fato de haver um elo muito fraco entre os centros.  Temos uma arquitetura de microsservi√ßo.  Fiquei surpreso ao descobrir que j√° temos 80 microsservi√ßos.  Quando iniciei a tarefa com logs, havia apenas 20. Al√©m disso, h√° uma parte bastante grande do legado do PHP, com o qual voc√™ tamb√©m precisa conviver e aguentar.  Tudo isso gera para n√≥s no momento mais de 6 milh√µes de mensagens por minuto em todo o sistema como um todo.  Al√©m disso, mostrarei como estamos tentando viver com isso e por que √© assim. </p><br><p><img src="https://habrastorage.org/webt/gy/fj/du/gyfjduafaipfx1ay5efm8xpwtdc.png"></p><br><p>  De alguma forma, precisamos viver com esses 6 milh√µes de mensagens.  O que devemos fazer com eles?  6 milh√µes de mensagens necess√°rias: </p><br><ul><li>  enviar da aplica√ß√£o </li><li>  aceite para entrega </li><li>  entregue para an√°lise e armazenamento. </li><li>  analisar </li><li>  de alguma forma armazenar. </li></ul><br><p><img src="https://habrastorage.org/webt/vq/kr/yt/vqkrytwk4c_gjs9fza8_zn9hanu.png"></p><br><p>  Quando tr√™s milh√µes de mensagens apareceram, eu tinha a mesma apar√™ncia.  Porque come√ßamos com alguns centavos.  √â claro que os logs do aplicativo s√£o gravados l√°.  Por exemplo, n√£o consegui conectar ao banco de dados, consegui conectar ao banco de dados, mas n√£o consegui ler algo.  Al√©m disso, cada um dos nossos microsservi√ßos tamb√©m grava um log de acesso.  Cada solicita√ß√£o que chega a um microsservi√ßo cai no log.  Por que estamos fazendo isso?  Os desenvolvedores querem poder rastrear.  Em cada log de acesso, h√° um campo de rastreamento, ao longo do qual uma interface especial desenrola ainda mais toda a cadeia e exibe lindamente o rastreamento.  O rastreamento mostra como foi a solicita√ß√£o e isso ajuda nossos desenvolvedores a lidar rapidamente com qualquer lixo n√£o identificado. </p><br><p><img src="https://habrastorage.org/webt/me/fd/7d/mefd7deeshbhsvsjb8n7dh81ok4.png"></p><br><p>  Como viver com isso?  Agora vou descrever brevemente o campo de op√ß√µes - como, em geral, esse problema √© resolvido.  Como resolver o problema de coleta, transfer√™ncia e armazenamento de logs. </p><br><p><img src="https://habrastorage.org/webt/0m/f8/4r/0mf84rxvsn0ewrqui_4egxgb2hk.png"></p><br><p>  Como escrever a partir da aplica√ß√£o?  √â claro que existem maneiras diferentes.  Em particular, h√° boas pr√°ticas, como os camaradas da moda nos dizem.  H√° uma velha escola de duas formas, como disseram os av√≥s.  Existem outras maneiras. </p><br><p><img src="https://habrastorage.org/webt/le/7-/_n/le7-_n8o7wl8nh4g0qadwz-jucq.png"></p><br><p>  Com a cole√ß√£o de logs sobre a mesma situa√ß√£o.  N√£o h√° muitas op√ß√µes para resolver esta parte espec√≠fica.  J√° existem mais, mas n√£o tantos. </p><br><p><img src="https://habrastorage.org/webt/kn/id/o2/knido22_ecpa0cgvfjzissz3fei.png"></p><br><p>  Mas com entrega e an√°lise subseq√ºente - o n√∫mero de varia√ß√µes come√ßa a explodir.  N√£o vou descrever cada op√ß√£o agora.  Eu acho que as principais op√ß√µes s√£o ouvidas por todos que estavam interessados ‚Äã‚Äãno t√≥pico. </p><br><p><img src="https://habrastorage.org/webt/qu/zg/z0/quzgz0a21pgjdb0o8ek5d3nxmwc.png"></p><br><p>  Vou mostrar como fizemos na Lazada e como tudo come√ßou. </p><br><p><img src="https://habrastorage.org/webt/tu/b_/xt/tub_xtgrnyznjspm2vxf_lepv7o.png"></p><br><p>  H√° um ano, vim para Lazada e eles me enviaram para um projeto sobre logs.  Foi assim.  O log do aplicativo foi gravado em stdout e stderr.  Eles fizeram tudo de uma maneira elegante.  Mas ent√£o os desenvolvedores jogaram fora dos fluxos padr√£o, e ent√£o os especialistas em infraestrutura resolver√£o isso de alguma maneira.  Entre especialistas em infraestrutura e desenvolvedores, tamb√©m h√° lan√ßamentos que dizem: ‚Äúuh ... bem, vamos envolv√™-los em um arquivo com um shell, s√≥ isso.‚Äù  E como tudo isso est√° no cont√™iner, eles o embrulharam no pr√≥prio cont√™iner, baixaram o cat√°logo e o colocaram l√°.  Eu acho que √© aproximadamente √≥bvio para todos o que veio disso. </p><br><p><img src="https://habrastorage.org/webt/l2/pl/lz/l2pllz5jvccjhbz0zzxcitkrmsk.png"></p><br><p>  Vamos ver um pouco mais longe.  Como entregamos esses logs.  Algu√©m escolheu o agente td, que √© realmente fluente, mas n√£o muito fluente.  Ainda n√£o entendi a rela√ß√£o desses dois projetos, mas eles parecem ter a mesma coisa.  E esse fluente, escrito em Ruby, leu arquivos de log, os analisou em JSON por alguns per√≠odos regulares.  Ent√£o ele os enviou para Kafka.  E em Kafka para cada API, t√≠nhamos 4 t√≥picos separados.  Por que 4?  Porque existe ao vivo, h√° prepara√ß√£o e porque h√° stdout e stderr.  Os desenvolvedores d√£o √† luz e engenheiros de infraestrutura devem cri√°-los em Kafka.  Al√©m disso, Kafka era controlado por outro departamento.  Portanto, era necess√°rio criar um ticket para que eles criassem 4 t√≥picos para cada API l√°.  Todo mundo esqueceu.  Em geral, havia lixo e fuma√ßa. </p><br><p><img src="https://habrastorage.org/webt/x9/2-/5s/x92-5sqis-vgly1ccyh0gjt2mxy.png"></p><br><p>  O que fizemos a seguir com isso?  N√≥s o enviamos para kafka.  Mais longe de Kafka, metade dos toros voou para Logstash.  A outra metade dos logs foi compartilhada.  Parte voou em um Graylog, parte - em outro Graylog.  Como resultado, tudo isso se transformou em um cluster do Elasticsearch.  Ou seja, toda essa bagun√ßa acabou por cair l√°.  Voc√™ n√£o precisa fazer isso! </p><br><p><img src="https://habrastorage.org/webt/ge/w9/kz/gew9kzazsmr5pwee16cuyor6n2w.png"></p><br><p>  √â assim que parece se voc√™ olhar remotamente de cima.  N√£o fa√ßa isso!  Aqui, os n√∫meros indicam imediatamente as √°reas problem√°ticas.  Na verdade, existem mais deles, mas 6 s√£o realmente bastante problem√°ticos, com os quais voc√™ precisa fazer alguma coisa.  Eu vou falar sobre eles separadamente agora. </p><br><p><img src="https://habrastorage.org/webt/2w/xu/eb/2wxuebmewhsjvjbr_9taaq5zhn4.png"></p><br><p>  Aqui (1,2,3) estamos escrevendo arquivos e, consequentemente, aqui est√£o tr√™s rakes ao mesmo tempo. </p><br><p>  O primeiro (1) √© que precisamos escrev√™-los em algum lugar.  Nem sempre eu gostaria de dar √† API a capacidade de gravar diretamente em um arquivo.  √â desej√°vel que a API seja isolada no cont√™iner e, melhor ainda, que seja somente leitura.  Como sou administrador de sistemas, tenho uma vis√£o um pouco alternativa dessas coisas. </p><br><p>  O segundo ponto (2,3) - temos muitas solicita√ß√µes chegando √† API.  A API grava muitos dados em um arquivo.  Arquivos est√£o crescendo.  N√≥s precisamos rotacion√°-los.  Porque, caso contr√°rio, n√£o h√° como obter discos.  A rota√ß√£o deles √© ruim porque eles s√£o redirecionados atrav√©s do shell para um diret√≥rio.  N√£o podemos mov√™-lo de nenhuma maneira.  Um aplicativo n√£o pode ser solicitado para redescobrir descritores.  Porque os desenvolvedores olhar√£o para voc√™ como um tolo: ‚ÄúQuais s√£o os descritores?  Geralmente escrevemos para stdout. ‚Äù  Os engenheiros de infraestrutura fizeram c√≥pias em logrotate, o que faz apenas uma c√≥pia do arquivo e transcreve o original.  Assim, entre esses processos de c√≥pia, o espa√ßo em disco geralmente termina. </p><br><p>  (4) T√≠nhamos formatos diferentes e est√°vamos em APIs diferentes.  Eles eram um pouco diferentes, mas o regexp tinha que ser escrito de maneira diferente.  Como tudo isso era controlado por Puppet, havia um grande grupo de classes com suas baratas.  Al√©m disso, o agente td na maioria das vezes podia comer mem√≥ria, est√∫pido, poderia apenas fingir que funciona e n√£o fazer nada.  L√° fora, era imposs√≠vel entender que ele n√£o estava fazendo nada.  Na melhor das hip√≥teses, ele cair√° e algu√©m o buscar√° mais tarde.  Mais precisamente, o alerta chegar√° e algu√©m passar√° com as m√£os. </p><br><p><img src="https://habrastorage.org/webt/x9/8i/a-/x98ia-rs9owg6hl2qqkfjpza-yg.png"></p><br><p>  (6) E o m√°ximo de lixo e desperd√≠cio - era a pesquisa el√°stica.  Porque era uma vers√£o antiga.  Porque, na √©poca, n√£o t√≠nhamos mestres dedicados.  T√≠nhamos logs heterog√™neos nos quais os campos podiam se cruzar.  Logs diferentes de aplicativos diferentes podem ser gravados com os mesmos nomes de campo, mas ao mesmo tempo pode haver dados diferentes.  Ou seja, um log vem com Inteiro no campo, por exemplo, n√≠vel.  Outro log vem com String no campo level.  Na aus√™ncia de mapeamento est√°tico, uma coisa t√£o maravilhosa √© obtida.  Se, ap√≥s a rota√ß√£o do √≠ndice na elasticsearch, a primeira mensagem com uma string chegar, viveremos normalmente.  E se chegou primeiro com Inteiro, todas as mensagens subseq√ºentes que chegaram com String s√£o simplesmente descartadas.  Porque o tipo de campo n√£o corresponde. </p><br><p><img src="https://habrastorage.org/webt/c9/ym/lq/c9ymlqxv89qg1oohi-lnhknyedg.png"></p><br><p>  Come√ßamos a fazer essas perguntas.  Decidimos n√£o procurar os culpados. </p><br><p><img src="https://habrastorage.org/webt/fl/r1/kv/flr1kvyks_o2kdciv4pekiwtbiy.png"></p><br><p>  Mas algo precisa ser feito!  O √≥bvio √© estabelecer padr√µes.  N√≥s j√° t√≠nhamos alguns padr√µes.  Alguns temos um pouco mais tarde.  Felizmente, um formato de log uniforme para todas as APIs j√° havia sido aprovado naquele momento.  Est√° escrito diretamente nos padr√µes para a intera√ß√£o dos servi√ßos.  Dessa forma, aqueles que desejam receber logs devem grav√°-los neste formato.  Se algu√©m n√£o gravar registros nesse formato, n√£o garantimos nada. </p><br><p>  Al√©m disso, gostaria de estabelecer um padr√£o √∫nico para os m√©todos de registro, entrega e coleta de logs.  Na verdade, onde escrev√™-los e como entreg√°-los.  A situa√ß√£o ideal √© quando os projetos usam a mesma biblioteca.  Aqui est√° uma biblioteca de log separada para Go, h√° uma biblioteca separada para PHP.  Todos que temos - todos devem us√°-los.  No momento, eu diria que conseguimos 80%.  Mas alguns continuam a comer cactos. </p><br><p>  E l√° (no slide) mal apareceu "SLA para entrega de logs".  Ele ainda n√£o est√° l√°, mas estamos trabalhando nisso.  Como √© muito conveniente quando a infra diz que, se voc√™ escreve em um formato tal e tal em tal e tal lugar e n√£o mais que N mensagens por segundo, √© prov√°vel que entregemos tal e qual l√°.  Isso alivia um monte de dores de cabe√ßa.  Se houver um SLA, isso √© maravilhoso! </p><br><p><img src="https://habrastorage.org/webt/im/aq/aj/imaqajo2oi-qoyb--oja3i2fnyy.png"></p><br><p>  Como come√ßamos a resolver o problema?  O rake principal foi com o td-agent.  N√£o estava claro para onde os logs estavam indo.  Eles s√£o entregues?  Eles est√£o indo?  Onde eles est√£o?  Portanto, o primeiro item foi decidido para substituir o td-agent.  Esbocei brevemente as op√ß√µes para substitu√≠-lo. </p><br><p>  Fluente  Primeiro, me deparei com ele em um emprego anterior, e ele tamb√©m periodicamente caiu l√°.  Em segundo lugar, √© o mesmo, apenas no perfil. </p><br><p>  Filebeat.  Como foi conveniente para n√≥s?  O fato de ele estar no Go, e temos muita experi√™ncia no Go.  Portanto, se isso, poder√≠amos, de alguma forma, adicion√°-lo por n√≥s mesmos.  Portanto, n√≥s n√£o aceitamos.  De modo que nem mesmo a tenta√ß√£o come√ßou a reescrev√™-lo para si mesmo. </p><br><p>  A solu√ß√£o √≥bvia para o sysadmin √© todos os syslogs nessa quantidade (syslog-ng / rsyslog / nxlog). </p><br><p>  Ou escreva algo de nossa autoria, mas deixamos de lado, assim como a batida de arquivo.  Se voc√™ escrever algo, √© melhor escrever algo √∫til para os neg√≥cios.  Para a entrega de logs, √© melhor levar algo pronto. </p><br><p>  Portanto, a escolha realmente se resumiu √† escolha entre syslog-ng e rsyslog.  Ele se inclinou para o rsyslog simplesmente porque j√° t√≠nhamos aulas para o rsyslog no Puppet, e eu n√£o encontrei nenhuma diferen√ßa √≥bvia entre eles.  O que √© syslog, o que √© syslog.  Sim, algu√©m tem documenta√ß√£o pior, algu√©m tem melhor.  Ele sabe como, e ele - de uma maneira diferente. </p><br><p><img src="https://habrastorage.org/webt/xl/wg/7y/xlwg7yv4du2k8ktumnmdltwci78.png"></p><br><p>  E um pouco sobre o rsyslog.  Primeiro, √© legal porque tem muitos m√≥dulos.  Possui RainerScript leg√≠vel por humanos (uma linguagem de configura√ß√£o moderna).  O b√¥nus impressionante √© que poder√≠amos emular o comportamento do agente td usando seus meios regulares, e nada mudou para os aplicativos.  Ou seja, estamos mudando td-agent para rsyslog, mas n√£o estamos tocando em tudo o mais.  E imediatamente recebemos uma entrega de trabalho.  Em seguida, mmnormalize √© uma coisa impressionante no rsyslog.  Permite analisar logs, mas n√£o usando Grok e regexp.  Ela cria uma √°rvore de sintaxe abstrata.  Ele analisa os logs aproximadamente, conforme o compilador analisa os c√≥digos-fonte.  Isso permite que voc√™ trabalhe muito rapidamente, coma pouca CPU e, em geral, √© uma coisa muito legal.  Existem toneladas de outros b√¥nus.  Eu n√£o vou parar sobre eles. </p><br><p><img src="https://habrastorage.org/webt/tf/6w/c0/tf6wc0eulg65fu-dy64mmkjyr4g.png"></p><br><p>  O Rsyslog ainda tem um monte de falhas.  Eles s√£o quase os mesmos que b√¥nus.  Os principais problemas - voc√™ precisa ser capaz de cozinh√°-lo e selecionar a vers√£o. </p><br><p><img src="https://habrastorage.org/webt/p-/2l/l5/p-2ll5-sxmfivl2136kopu1oipi.png"></p><br><p>  Decidimos que escrever√≠amos logs no soquete unix.  E n√£o no / dev / log, porque temos mingau nos logs do sistema, existe um di√°rio nesse pipeline.  Ent√£o, vamos escrever para um soquete personalizado.  N√≥s o anexamos a um conjunto de regras separado.  N√≥s n√£o vamos interferir.  Tudo ser√° transparente e claro.  Ent√£o n√≥s realmente fizemos.  O diret√≥rio com esses soquetes √© padronizado e encaminhado para todos os cont√™ineres.  Os cont√™ineres podem ver o soquete de que precisam, abrir e grav√°-lo. </p><br><p>  Por que n√£o um arquivo?  Como todo mundo leu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um artigo sobre Badushechka</a> que tentou encaminhar o arquivo para o docker, descobriu-se que, ap√≥s o rsyslog reiniciar, o descritor de arquivo √© alterado, e o docker perde esse arquivo.  Ele mant√©m algo mais aberto, mas n√£o o mesmo espa√ßo onde eles escrevem.  Decidimos que contorn√°vamos esse problema e, ao mesmo tempo, contorn√°vamos o problema de bloqueio. </p><br><p><img src="https://habrastorage.org/webt/ri/kn/r9/riknr9odspcwgtmywqapeq1htmi.png"></p><br><p>  O Rsyslog executa as a√ß√µes indicadas no slide e envia os logs para a retransmiss√£o ou para Kafka.  Kafka corresponde √† maneira antiga.  Rel√© - Tentei usar o rsyslog puro para entregar logs.  Sem fila de mensagens, ferramentas rsyslog padr√£o.  Basicamente, funciona. </p><br><p><img src="https://habrastorage.org/webt/wh/bl/fv/whblfvj4lnbmdryfev1fypctp74.png"></p><br><p>  Mas existem nuances de como coloc√°-las posteriormente nesta parte (Logstash / Graylog / ES).  Esta parte (rsyslog-rsyslog) √© usada entre data centers.  Aqui est√° um link tcp compactado, que permite economizar largura de banda e, consequentemente, aumentar a probabilidade de recebermos algum tipo de log de outro data center em condi√ß√µes em que o canal est√° cheio.  Porque temos a Indon√©sia, na qual tudo est√° ruim.  √â aqui que est√° esse problema constante. </p><br><p><img src="https://habrastorage.org/webt/zx/bx/gi/zxbxgimmd3xniduuuw0spq0vg1o.png"></p><br><p>  Pensamos em como realmente monitoramos, com que probabilidade os logs que gravamos do aplicativo atingem esse fim?  Decidimos obter as m√©tricas.  O Rsyslog possui seu pr√≥prio m√≥dulo de coleta de estat√≠sticas, que possui algum tipo de contador.  Por exemplo, ele pode mostrar o tamanho da fila ou quantas mensagens vieram em uma a√ß√£o dessas.  Algo j√° pode ser tirado deles.  Al√©m disso, possui contadores personalizados que podem ser configurados e mostrar√°, por exemplo, o n√∫mero de mensagens que alguma API gravou.  Em seguida, escrevi o rsyslog_exporter em Python e enviamos tudo para Prometheus e plotamos.  As m√©tricas do Graylog realmente queriam, mas at√© agora n√£o tivemos tempo para configur√°-las. </p><br><p><img src="https://habrastorage.org/webt/kq/b0/-1/kqb0-1ox3sevtkje8qnb7ekp1is.png"></p><br><p>  Quais s√£o os problemas?  Surgiram problemas com o fato de descobrirmos (SUDDENLY!) Que nossas APIs ativas gravam 50 mil mensagens por segundo.  Esta √© apenas uma API ao vivo sem prepara√ß√£o.  E o Graylog mostra apenas 12 mil mensagens por segundo.  E surgiu uma pergunta razo√°vel, mas onde est√£o as sobras?  A partir do qual conclu√≠mos que Graylog simplesmente n√£o pode lidar.  Eles pareciam e, de fato, o Graylog da Elasticsearch n√£o dominava esse fluxo. </p><br><p>  Al√©m disso, outras descobertas que fizemos no processo. </p><br><p>  A grava√ß√£o no soquete est√° bloqueada.  Como isso aconteceu?  Quando usei o rsyslog para entrega, em algum momento nosso canal entre os data centers quebrou.  Entrega subiu em um lugar, entrega subiu em outro lugar.  Tudo isso chegou a uma m√°quina com APIs que gravam no soquete rsyslog.  Havia uma fila.  Em seguida, a fila para gravar no soquete unix foi preenchida, cujo padr√£o √© 128 pacotes.  E a pr√≥xima grava√ß√£o () no aplicativo est√° bloqueada.  Quando examinamos a biblioteca que usamos nos aplicativos Go, foi escrito l√° que a grava√ß√£o no soquete ocorre no modo sem bloqueio.  T√≠nhamos certeza de que nada est√° bloqueando.  Porque lemos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um artigo sobre Badushechka</a> que escreveu sobre isso.  Mas h√° um momento.  Ao redor dessa liga√ß√£o, ainda havia um ciclo intermin√°vel, no qual era feita uma tentativa constante de empurrar a mensagem para o soquete.  N√≥s n√£o percebemos isso.  Eu tive que reescrever a biblioteca.  Desde ent√£o, ele mudou v√°rias vezes, mas agora nos livramos dos bloqueios em todos os subsistemas.  Portanto, voc√™ pode parar o rsyslog e nada cair√°. </p><br><p>  √â necess√°rio monitorar o tamanho das filas, o que ajuda a n√£o pisar nesse rake.  Primeiro, podemos monitorar quando come√ßamos a perder mensagens.  Em segundo lugar, podemos monitorar que, em princ√≠pio, temos problemas de entrega. </p><br><p>  E outro momento desagrad√°vel - amplifica√ß√£o 10 vezes na arquitetura de microsservi√ßos - √© muito f√°cil.  N√£o temos muitas solicita√ß√µes de entrada, mas, devido ao gr√°fico em que essas mensagens s√£o executadas, devido aos logs de acesso, aumentamos realmente a carga nos logs uma vez a cada dez.  Infelizmente, n√£o tive tempo para calcular os n√∫meros exatos, mas os microsservi√ßos - eles s√£o.  Isso deve ser lembrado.  Acontece que, no momento, o subsistema de coleta de logs √© o mais carregado no Lazada. </p><br><p><img src="https://habrastorage.org/webt/6a/fd/mi/6afdmitt6iid3yqd6cmdgq8_lkq.png"></p><br><p>  Como resolver o problema de elasticsearch?  Se voc√™ precisar obter rapidamente os logs em um √∫nico local, para n√£o percorrer todas as m√°quinas e n√£o colet√°-las, use o armazenamento de arquivos.  Isso √© garantido para o trabalho.  √â feito de qualquer servidor.  Voc√™ s√≥ precisa colar os discos l√° e colocar o syslog.  Depois disso, voc√™ ter√° todos os logs em um s√≥ lugar.  Al√©m disso, j√° ser√° poss√≠vel ajustar lentamente a elasticsearch, graylog, outra coisa.  Mas voc√™ j√° ter√° todos os logs e, al√©m disso, poder√° armazen√°-los o m√°ximo poss√≠vel de matrizes de disco. </p><br><p><img src="https://habrastorage.org/webt/cx/1d/g3/cx1dg33kkvufonoxpwrrpmmabza.png"></p><br><p>  Na √©poca do meu relat√≥rio, o circuito come√ßou a ficar assim.  N√≥s praticamente paramos de gravar no arquivo.  Agora, provavelmente, vamos desligar as sobras.  Em m√°quinas locais executando a API, pararemos de gravar em arquivos.  Em primeiro lugar, existe um armazenamento de arquivos que funciona muito bem.  Em segundo lugar, o local nessas m√°quinas acaba constantemente, √© necess√°rio monitor√°-lo constantemente. </p><br><p>  Essa parte do Logstash e do Graylog realmente aumenta.  Portanto, devemos nos livrar disso.  Voc√™ tem que escolher uma coisa. </p><br><p><img src="https://habrastorage.org/webt/w4/bj/po/w4bjpoxgbdggewegwtrg1ao9mpi.png"></p><br><p>  Decidimos jogar Logstash e Kibana.  Porque n√≥s temos um departamento de seguran√ßa.  Qual √© a conex√£o?  A conex√£o √© que o Kibana sem o X-Pack e sem o Shield n√£o permite diferenciar os direitos de acesso aos logs.  Portanto, eles pegaram Graylog.  Ele tem tudo.  Eu n√£o gosto dele, mas funciona.  Compramos ferro novo, colocamos Graylog fresco l√° e movemos todos os logs com formatos r√≠gidos para um Graylog separado.  Resolvemos o problema com diferentes tipos de campos id√™nticos organizacionalmente. </p><br><p><img src="https://habrastorage.org/webt/cn/hr/41/cnhr41tyx4sf0c0skbjqrgbyb90.png"></p><br><p>  O que exatamente est√° inclu√≠do no novo Graylog.  Acabamos de gravar tudo na janela de encaixe.  Pegamos v√°rios servidores, lan√ßamos tr√™s inst√¢ncias Kafka, 7 servidores Graylog vers√£o 2.3 (porque eu queria o Elasticsearch vers√£o 5).  Tudo isso em ataques do HDD levantados.  Vimos uma taxa de indexa√ß√£o de at√© 100 mil mensagens por segundo.  Vimos a figura de 140 terabytes de dados por semana. </p><br><p><img src="https://habrastorage.org/webt/wv/yd/yj/wvydyj9d_mfo3xztj9elcbvpdaa.png"></p><br><p>  E novamente um ancinho!  Duas vendas est√£o chegando.  Mudamos para 6 milh√µes de mensagens.  Em n√≥s, Graylog n√£o tem tempo para mastigar.  De alguma forma, temos que sobreviver novamente. </p><br><p><img src="https://habrastorage.org/webt/xf/2j/lc/xf2jlclf52i3oi3nsxdksth-xpe.png"></p><br><p>  N√≥s sobrevivemos assim.  Adicionamos mais alguns servidores e SSDs.  No momento, vivemos dessa maneira.  Agora j√° estamos mastigando 160 mil mensagens por segundo.  Ainda n√£o atingimos o limite, portanto ainda n√£o est√° claro o quanto realmente podemos obter disso. </p><br><p><img src="https://habrastorage.org/webt/bn/ck/ss/bnckssznjbmcrm7v4zh7yhgoltw.png"></p><br><p>  Esses s√£o nossos planos para o futuro.  Destes, realmente, o mais importante √© provavelmente a alta disponibilidade.  Ainda n√£o o temos.  V√°rios carros s√£o configurados da mesma forma, mas at√© agora tudo est√° passando por um carro.   ,   failover  . </p><br><p>    Graylog. </p><br><p>  rate limit    ,    API,    bandwidth   . </p><br><p>  ,  - SLA c ,      .    ,  . </p><br><p>   . </p><br><p><img src="https://habrastorage.org/webt/cc/hr/az/cchrazzrhareykxd78meljitrso.png"></p><br><p> ,  ,   . -, . -, syslog ‚Äî . -, rsyslog    ,    .     . </p><br><p> <strong></strong> . </p><br><p> <strong></strong> :  -   ‚Ä¶ (filebeat?) </p><br><p> <strong></strong> :    .   .    API     ,        ,      .    pipe.     : ¬´   ,     , ¬ª?    ,   ,  : ¬´ ,      ¬ª. </p><br><p> <strong></strong> :        HDFS? </p><br><p> <strong></strong> :   .      , , ,       ,       long term solution. </p><br><p> <strong></strong> :      . </p><br><p> <strong></strong> :   .  ""  . </p><br><p> <strong></strong> :    rsyslog.    TCP,  UDP.   UDP,      ? </p><br><p> <strong></strong> :   . ,    ,      .  ,     : ¬´       ,      -   ,  - ¬ª,    ¬´!        ,     ,          ,       .¬ª         .    ,     ?        ,     ?   best effort.           ,     100% .       .       . </p><br><p> <strong></strong> :  API  -       ,       ,         ? -   . </p><br><p> <strong></strong> :  ,      .     .         ,       .    ,   API     .   rsyslog    .   API    ,     ,    timestamp      .      Graylog,      timestamp.    . </p><br><p> <strong></strong> : Timestamp    . </p><br><p> <strong></strong> : Timestamp   API.  , ,  .    NTP. API  timestamp    .   rsyslog . </p><br><p> <strong></strong> :      .       , .     ?      ? </p><br><p> <strong></strong> : .       -  .       ,        .     .     Log Relay.  Rsyslog .      .   .         .    .        .   ,       (),       Graylog.        storage.  ,     ,     .   .    . </p><br><p> <strong></strong> :       ? </p><br><p> <strong></strong> :    (  )  . </p><br><p> <strong></strong> :    ,     ? </p><br><p> <strong></strong> :      ,    .    .  ,   Go API,  .   ,        socket.       .   .        socket.   ,    .      .     ,    .      prometheus,   Grafana   .   .   ,   . </p><br><p> <strong></strong> :  elasticsearch     .    ? </p><br><p> <strong></strong> :  . </p><br><p> <strong></strong> :    ? </p><br><p> <strong></strong> :    .     . </p><br><p> <strong></strong> :   rsyslog  - ? </p><br><p> <strong></strong> :      unix socket.       128 .       .     .     ,   128 . , , ,   ,   .        ,          .         . </p><br><p> <strong>c</strong> :     JSON? </p><br><p> <strong></strong> :  JSON      relay,     .    Graylog,     JSON .    ,   ,       rsyslog.      issue,     . </p><br><p> <strong>c</strong> :  Kafka?   RabbitMQ?   Graylog   ? </p><br><p> <strong></strong> :    Graylog  .  Graylog   .    .   . ,   ,   .      rsyslog   elasticsearch    Kibana.      .     ,    Graylog    Kibana. Logstash    .  ,        rsyslog.         elasticsearch.  Graylog   - .     .       . </p><br><p>  Kafka.   .   ,   ,      .          .   ,  ,    .  RabbitMQ‚Ä¶     c RabbitMQ.  RabbitMQ   .     ,     .      ,     .           .    . Graylog    AMQP 0.9,  rsyslog    AMQP 1.0.     ,     ,  .     .      Kafka.     .   omkafka   rsyslog,   ,      ,     rsyslog.     . </p><br><p> <strong>Pergunta</strong> : Voc√™ usa Kafka porque o tinha?  N√£o √© utilizado para outros fins? </p><br><p>  <strong>Resposta</strong> : Kafka, que foi usado pela equipe do Data Sience.  Este √© um projeto completamente separado, sobre o qual, infelizmente, n√£o posso dizer nada.  Eu n√£o sei  Ela foi administrada pela equipe de ci√™ncia de dados.  Quando os logs come√ßaram, eles decidiram us√°-lo, para n√£o colocar seus pr√≥prios.  Agora, atualizamos o Graylog e perdemos a compatibilidade, porque existe uma vers√£o antiga do Kafka.  N√≥s tivemos que conseguir o nosso.  Ao mesmo tempo, nos livramos desses quatro t√≥picos para cada API.  Criamos um t√≥pico amplo para todos ao vivo, um t√≥pico amplo para todos os est√°gios e apenas marcamos tudo l√°.  Graylog ajusta tudo isso em paralelo. </p><br><p>  <strong>Pergunta</strong> : Por que esse xamanismo com soquetes √© necess√°rio?  Voc√™ j√° tentou usar o driver de log syslog para cont√™ineres? </p><br><p>  <strong>Resposta</strong> : No momento em que fizemos essa pergunta, t√≠nhamos um relacionamento tenso com a janela de encaixe.  Era docker 1.0 ou 0.9.  Docker em si era estranho.  Em segundo lugar, se voc√™ tamb√©m enfiar os logs nele ... tenho uma suspeita n√£o confirmada de que ele passa todos os logs por si mesmo, atrav√©s do dem√¥nio estivador.  Se temos uma API enlouquecendo, o restante das APIs fica preso no fato de que elas n√£o podem enviar stdout e stderr.  N√£o sei aonde isso vai levar.  Suspeito que voc√™ n√£o precise usar o driver syslog do docker neste local.  Nosso departamento de testes funcionais possui seu pr√≥prio cluster Graylog com logs.  Eles usam drivers de log do docker e tudo parece estar bem l√°.  Mas eles imediatamente escrevem GELF para Graylog.  N√≥s, naquele momento em que tudo isso estava acontecendo, precis√°vamos que funcionasse.  Talvez mais tarde, quando algu√©m vier e disser que est√° funcionando normalmente h√° cem anos, tentaremos. </p><br><p>  <strong>Pergunta</strong> : Voc√™ entrega entre os datacenters no rsyslog.  Por que n√£o no Kafka? </p><br><p>  <strong>Resposta</strong> : Estamos fazendo as duas coisas, e assim, na realidade.  Por duas raz√µes.  Se o canal estiver completamente inoperante, todos os logs, mesmo que compactados, n√£o ser√£o rastreados.  E o kafka permite que eles simplesmente se percam no processo.  Dessa maneira, nos livramos de colar esses logs.  N√≥s apenas usamos Kafka neste caso diretamente.  Se temos um bom canal e queremos liber√°-lo, usamos o rsyslog deles.  Mas, na verdade, voc√™ pode configur√°-lo para que ele mesmo elimine o que n√£o foi rastreado.  No momento, estamos apenas em algum lugar usando a entrega do rsyslog diretamente, em algum lugar do Kafka. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt450098/">https://habr.com/ru/post/pt450098/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt450088/index.html">Como desenhar ilustra√ß√µes para resumos de matem√°tica no Inkscape</a></li>
<li><a href="../pt450090/index.html">Not√≠cias do mundo do OpenStreetMap No. 457 (16.04.2019-22.04.2019)</a></li>
<li><a href="../pt450092/index.html">O que √© o qu√™ e quem √© quem no mercado de prote√ß√£o contra DDoS</a></li>
<li><a href="../pt450094/index.html">Caf√© solar: aumentando a efici√™ncia das c√©lulas solares devido √† cafe√≠na</a></li>
<li><a href="../pt450096/index.html">Toalete autom√°tico para gatos</a></li>
<li><a href="../pt450100/index.html">Gera√ß√£o de c√≥digo para o back-end. O que gerar, como e por qu√™?</a></li>
<li><a href="../pt450102/index.html">Rel√≥gio autoajust√°vel com visor eletr√¥nico</a></li>
<li><a href="../pt450104/index.html">Muito dif√≠cil e muito interessante: comunidades de TI no TechTrain</a></li>
<li><a href="../pt450106/index.html">O projeto da organiza√ß√£o da constru√ß√£o e reconstru√ß√£o em condi√ß√µes apertadas no canteiro de obras do SPDS</a></li>
<li><a href="../pt450110/index.html">Patentes de design: parte dois (exemplos da Microsoft, Snapchat, Samsung, Netflix, Airbnb, Tinder)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>