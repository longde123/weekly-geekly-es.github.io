<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ”² ğŸ™ğŸ¼ ğŸ¤´ FreePBX Configuration d'Asterisk pour les notifications par e-mail des appels entrants manquÃ©s dans la file d'attente ğŸ™ƒ ğŸ—’ï¸ ğŸ­</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="IP ATC Asterisk est un puissant processeur de tÃ©lÃ©phonie IP. Et l'interface Web FreePBX crÃ©Ã©e pour Asterisk simplifie considÃ©rablement la configuratio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>FreePBX Configuration d'Asterisk pour les notifications par e-mail des appels entrants manquÃ©s dans la file d'attente</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/463829/"><img src="https://habrastorage.org/webt/ke/dl/08/kedl08qszm8sgw39uk2zteenbja.png" alt="image"><br>  IP ATC Asterisk est un puissant processeur de tÃ©lÃ©phonie IP.  Et l'interface Web FreePBX crÃ©Ã©e pour Asterisk simplifie considÃ©rablement la configuration et abaisse le seuil de connexion. <br>  Si vous pouvez proposer une sorte de tÃ¢che liÃ©e Ã  la tÃ©lÃ©phonie IP, alors elle peut presque certainement Ãªtre implÃ©mentÃ©e dans Asterisk.  Mais soyez sÃ»r que la persÃ©vÃ©rance et l'endurance vous seront demandÃ©es. <br><br>  Nous avons dÃ» configurer des notifications par e-mail des appels manquÃ©s.  Plus prÃ©cisÃ©ment, pour notifier par e-mail les cas oÃ¹ un appel entrant a Ã©tÃ© mis en file d'attente, mais personne (des agents) n'a rÃ©pondu Ã  cet appel entrant. <br><br>  Ã‰tonnamment, nous n'avons trouvÃ© aucun outil rÃ©gulier pour rÃ©soudre ce problÃ¨me dans FreePBX.  Je vais parler de la faÃ§on dont nous avons rÃ©solu ce problÃ¨me sous la coupe. <br><a name="habracut"></a><br>  <b>PrÃ©face</b> <br><br>  Avant de rÃ©soudre le problÃ¨me Â«de frontÂ», nous avons certainement recherchÃ© des informations sur Internet, mais nous n'avons pas trouvÃ© de solutions clÃ© en main (peut-Ãªtre qu'ils cherchaient mal, mais que pouvez-vous faire ...). <br><br>  Il n'y a pas autant de compÃ©tences professionnelles directement dans Asterisk que nous le souhaiterions, de sorte que la solution proposÃ©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> n'a pas Ã©tÃ© entiÃ¨rement comprise et a Ã©tÃ© rejetÃ©e. <br><br>  J'ai aimÃ© la solution proposÃ©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> , mÃªme si elle n'a pas fonctionnÃ©.  Par consÃ©quent, ils ont soulignÃ© que travailler dans Asterisk est nÃ©cessaire dans le contexte des [ext-queues].  Et puisque nous travaillons dans Freepbx, nous devons travailler dans le fichier de configuration Â«extensions_override_freepbx.confÂ».  Nous avons remarquÃ© qu'il est pratique de Â«capturer les appels manquÃ©sÂ» avant l'Ã©vÃ©nement de raccrochage (fin d'un appel). <br>  AprÃ¨s avoir lu la discussion <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> , l'idÃ©e est venue que nous devons filtrer la variable Â«DispositionÂ» dans le CDR pour tous les agents dans la file d'attente.  Et aprÃ¨s avoir lu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ces</a> informations, des Ã©tapes assez spÃ©cifiques ont Ã©tÃ© formÃ©es pour rÃ©soudre la tÃ¢che. <br><br>  <b>Qu'avons-nous:</b> <br><br>  Il existe FreePBX 13.0.197 qui utilise Asterisk 13.12.1.  Version du systÃ¨me d'exploitation SHMZ version 6.6 (finale).  La distribution est basÃ©e sur CentOS. <br><br>  L'astÃ©risque est configurÃ© avec IVR (menu vocal) dispersant les appels entrants dans diffÃ©rentes files d'attente (files d'attente).  Des agents (agents) sont affectÃ©s Ã  chaque file d'attente, c'est-Ã -dire des agents. <br><br>  <b>ThÃ©orie</b> <br><br>  <b>Que se passe-t-il chez Asterisk</b> <br><br>  Lorsqu'un appel entrant arrive Ã  Asterisk, cet appel est dirigÃ© vers l'IVR.  L'appelant fait un choix en appuyant sur un numÃ©ro spÃ©cifique du tÃ©lÃ©phone et entre dans une file d'attente spÃ©cifique.  AprÃ¨s cela, tous les agents libres de la file d'attente reÃ§oivent simultanÃ©ment un appel. <br><br>  Afin de mieux comprendre ce qui se passe en ce moment et ce qui se passe ensuite, nous nous tournons vers Report CDR (Fig. 1). <br><br><img src="https://habrastorage.org/webt/sv/qg/86/svqg86ls1ot8x4lcl5syw7oq3w0.png" alt="image"><br>  <i>Fig.1</i> <br><br>  Lorsqu'un appel entrant tombait dans la file d'attente, pour tous les agents, la valeur de la variable "Disposition" devenait Ã©gale Ã  "AUCUNE RÃ‰PONSE" si les agents n'Ã©taient pas occupÃ©s Ã  ce moment.  La variable "Disposition" peut prendre d'autres valeurs (voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://asterisk-pbx.ru/wiki/asterisk/cf/cdr</a> ), Ã  l'exception de la valeur "ANSWERED".  Et au moment oÃ¹ l'un des agents rÃ©pond Ã  l'appel entrant, la valeur de la variable "Disposition" de cet agent devient Ã©gale Ã  "REPONSE". <br>  Dans le rapport CDR, vous pouvez remarquer que lorsque l'appel est mis en file d'attente (dans la colonne App, la valeur devient Â«QueueÂ»), tous les Ã©vÃ©nements apparaissent avec le mÃªme Â«uniqueidÂ» (colonne System). <br><br>  <b>CDR en bref</b> <br><br>  Il est important de comprendre ce qu'est un CDR et Ã  quel moment dans le CDR les donnÃ©es que nous observons dans le rapport CDR sont entrÃ©es.  Le CDR, relatif au systÃ¨me d'exploitation, est la base de donnÃ©es dans laquelle Asterisk enregistre un rapport d'appel dÃ©taillÃ© (voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://asterisk-pbx.ru/wiki/asterisk/cf/cdr</a> ).  Dans notre cas, il s'agit d'une base de donnÃ©es appelÃ©e asteriskcdrdb, qui se trouve dans mysql.  Empiriquement, nous avons constatÃ© que les donnÃ©es sur un appel avec un certain Â«uniqueidÂ» ne sont pas entrÃ©es dans asteriskcdrdb immÃ©diatement aprÃ¨s l'occurrence d'un Ã©vÃ©nement, mais aprÃ¨s l'Ã©vÃ©nement hangupcall (fin de l'appel). <br><br>  <b>Le principe de la solution crÃ©Ã©e</b> <br><br>  Puisque nous avons plus de connaissances en bash que de connaissances en astÃ©risque, l'idÃ©e principale est la suivante.  Avant l'Ã©vÃ©nement hangupcall, appelez le script bash.  Passez 3 paramÃ¨tres Ã  ce script.  Le premier paramÃ¨tre est Â«uniqueidÂ», pour filtrer les donnÃ©es reÃ§ues du CDR.  Le deuxiÃ¨me paramÃ¨tre est Â«CALLERID (num)Â» (le numÃ©ro de l'appelant) pour savoir qui rappeler.  Le troisiÃ¨me paramÃ¨tre est Â«NODESTÂ» (numÃ©ro de file d'attente), auquel l'appel a Ã©tÃ© reÃ§u, afin de savoir sur quel problÃ¨me il y a eu un appel et Ã  qui envoyer une notification par e-mail d'un appel manquÃ©. <br>  Le script bash doit se connecter Ã  la base de donnÃ©es asteriskcdrdb dans mysql et prendre toutes les valeurs de la variable "Disposition" avec un "uniqueid" spÃ©cifique.  A partir des donnÃ©es obtenues, il faut exclure les valeurs: "PAS DE REPONSE", "OCCUPÃ‰", "ECHEC", "INCONNU".  En consÃ©quence, soit "RÃ‰PONSE" restera - ils ont rÃ©pondu Ã  l'appel entrant, soit rien du tout - l'appel manquÃ©. <br><br>  De plus, si l'appel a Ã©tÃ© manquÃ©, le script doit envoyer une notification par e-mail. <br>  Pour l'avenir, je note un point important.  Asterisk exÃ©cute les commandes sÃ©quentiellement, en attendant leur exÃ©cution (ce qui est gÃ©nÃ©ralement logique).  Et nous appellerons le script bash avant l'exÃ©cution de la commande hangupcall.  Ainsi, au moment oÃ¹ le script est directement exÃ©cutÃ©, les informations sur l'identifiant unique que nous recherchons ne seront pas encore entrÃ©es dans le CDR.  Pour rÃ©soudre ce problÃ¨me, nous appellerons le script bash avec le paramÃ¨tre Â«&amp;Â» afin qu'Asterisk passe immÃ©diatement Ã  l'Ã©tape suivante, c'est-Ã -dire hangupcall.  Et Ã  l'intÃ©rieur du script bash, au tout dÃ©but, nous allons dÃ©finir un petit dÃ©lai pour donner le temps Ã  Asterisk d'entrer les donnÃ©es avec l '"uniqueid" qui nous intÃ©resse dans le CDR. <br><br>  <b>Pratique</b> <br><br>  Avant de configurer Asterisk et de crÃ©er un script bash, vous devez configurer l'envoi de notifications par e-mail.  Pour cela, nous utiliserons l'utilitaire postfix. <br><br>  <b>Configuration de Postfix</b> <br><br>  Nous avons un domaine de messagerie "lucky.ru" situÃ© Ã  Yandex.  Nous configurerons postfix en mode client smtp et enverrons des lettres du compte asterisk@lucky.ru. <br>  La solution est prise Ã  partir d'ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.dmosk.ru/miniinstruktions.php?mini=postfix-over-yandex</a> . <br><br>  PremiÃ¨re installation / mise Ã  jour / vÃ©rification des packages: <br><br><pre><code class="bash hljs">yum install postfix yum install mailx yum install cyrus-sasl cyrus-sasl-lib cyrus-sasl-plain</code> </pre> <br>  Nous n'Ã©craserons pas le fichier de configuration principal de postfix Â«/etc/postfix/main.cfÂ», mais le sauvegarderons: <br><br><pre> <code class="bash hljs">cp /etc/postfix/main.cf /etc/postfix/main.cf.sav</code> </pre> <br>  Nous Ã©ditons le fichier Â«/etc/postfix/main.cfÂ» et le portons sous la forme suivante: <br><br><pre> <code class="bash hljs">nano /etc/postfix/main.cf <span class="hljs-comment"><span class="hljs-comment">##################### relayhost = smtp_sasl_auth_enable = yes smtp_sasl_password_maps = hash:/etc/postfix/private/sasl_passwd smtp_sasl_security_options = noanonymous smtp_sasl_type = cyrus smtp_sasl_mechanism_filter = login smtp_sender_dependent_authentication = yes sender_dependent_relayhost_maps = hash:/etc/postfix/private/sender_relay smtp_generic_maps = hash:/etc/postfix/generic smtp_tls_CAfile = /etc/postfix/ca.pem smtp_use_tls = yes smtputf8_autodetect_classes = all #####################</span></span></code> </pre> <br>  Toutes les lignes de "/etc/postfix/main.cf" ne peuvent pas Ãªtre commentÃ©es.  Les commentaires de certaines lignes ne sont pas dÃ©terminÃ©s par l'analyseur et sont transmis au traitement, ce qui entraÃ®ne des erreurs.  Il vaut mieux refuser les commentaires Ã  l'intÃ©rieur de ce fichier.  Vous pouvez expÃ©rimenter cela en exÃ©cutant Â«tail -f / var / log / messagesÂ» dans la fenÃªtre suivante. <br><br>  Je marquerai la ligne "smtputf8_autodetect_classes = all".  Cette entrÃ©e inclut utf-8 par dÃ©faut, ce qui vous permet d'utiliser l'alphabet cyrillique dans le corps de la lettre et dans la ligne d'objet sans manipulations supplÃ©mentaires (voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://www.postfix.org/SMTPUTF8_README.html</a> ). <br><br>  CrÃ©ez un rÃ©pertoire pour les fichiers de configuration: <br><br><pre> <code class="bash hljs">mkdir /etc/postfix/private</code> </pre> <br>  Nous Ã©ditons le fichier "/ etc / postfix / private / sender_relay".  Dans ce document, vous devez spÃ©cifier Ã  quel serveur smtp vous devez vous rÃ©fÃ©rer lorsque vous utilisez notre domaine de messagerie: <br><br><pre> <code class="bash hljs">nano /etc/postfix/private/sender_relay <span class="hljs-comment"><span class="hljs-comment">##################### @lucky.ru smtp.yandex.ru #####################</span></span></code> </pre> <br>  Nous Ã©ditons le fichier "/ etc / postfix / private / sasl_passwd".  Nous y indiquerons l'adresse e-mail que nous utiliserons pour envoyer des lettres, ainsi que le nom d'utilisateur et le mot de passe de ce compte (nous spÃ©cifions le nom d'utilisateur et le mot de passe via deux points): <br><br><pre> <code class="bash hljs">nano /etc/postfix/private/sasl_passwd <span class="hljs-comment"><span class="hljs-comment">##################### asterisk@lucky.ru asterisk@lucky.ru:password_asterisk #####################</span></span></code> </pre> <br>  Modification du fichier / etc / postfix / generic.  Nous y noterons les rÃ¨gles de remplacement de l'adresse sortante (voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://wiki.merionet.ru/ip-telephoniya/30/postfix-nastrojka-otpravki-pochty-v-asterisk/</a> ): <br><br><pre> <code class="bash hljs">nano /etc/postfix/generic <span class="hljs-comment"><span class="hljs-comment">##################### root asterisk@lucky.ru root@localhost asterisk@lucky.ru root@localhost.localdomain asterisk@lucky.ru root@freepbx asterisk@lucky.ru root@freepbx.localdomain asterisk@lucky.ru root@asterisk asterisk@lucky.ru root@asterisk.localdomain asterisk@lucky.ru asterisk asterisk@lucky.ru asterisk@localhost asterisk@lucky.ru asterisk@localhost.localdomain asterisk@lucky.ru asterisk@freepbx asterisk@lucky.ru asterisk@freepbx.localdomain asterisk@lucky.ru asterisk@asterisk asterisk@lucky.ru asterisk@asterisk.localdomain asterisk@lucky.ru root@localdomain.localdomain asterisk@lucky.ru #####################</span></span></code> </pre> <br>  L'adresse sortante initiale dÃ©pend du contenu de Â«/ etc / hostsÂ» et Â«/ etc / hostnameÂ», ainsi que du nom de l'utilisateur qui enverra la lettre.  Autrement dit, malgrÃ© le fait que nous utilisons le client smtp et envoyons des lettres de asterisk@lucky.ru, de toute faÃ§on, postfix remplacera initialement Â«quelque chose de propreÂ» dans l'adresse de l'expÃ©diteur et cela doit Ãªtre corrigÃ© par les rÃ¨gles de ce fichier de configuration. <br><br>  Je vais lister le contenu de mon fichier / etc / hosts: <br><br><pre> <code class="bash hljs">cat /etc/hosts <span class="hljs-comment"><span class="hljs-comment">##################### 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 asterisk.localdomain 127.0.0.1 localhost.localdomain localhost ::1 asterisk localhost localhost6 #####################</span></span></code> </pre> <br>  Il est important que le serveur ait n'importe quel domaine (la valeur aprÃ¨s la pÃ©riode), car l'utilitaire de messagerie "recherche" le nom de domaine dans "/ etc / hosts" et s'il ne le "trouve" pas immÃ©diatement, il continuera Ã  le faire pendant plusieurs minutes et alors seulement envoyez une lettre.  Autrement dit, si le domaine n'est pas enregistrÃ©, la lettre partira avec un retard de plusieurs minutes. <br><br>  Je vais lister le contenu de mon fichier / etc / hostname: <br><br><pre> <code class="bash hljs">cat /etc/hostname <span class="hljs-comment"><span class="hljs-comment">##################### asterisk #####################</span></span></code> </pre> <br>  Ensuite, vous devez transfÃ©rer les fichiers de configuration crÃ©Ã©s vers des bases de donnÃ©es indexÃ©es, pour ce faire, exÃ©cutez la commande suivante: <br><br><pre> <code class="bash hljs">postmap /etc/postfix/generic &amp;&amp; postmap /etc/postfix/private/{sasl_passwd,sender_relay}</code> </pre> <br>  Ensuite, nous devons tÃ©lÃ©charger et placer le certificat smtp.yandex.ru sur le serveur, pour ce faire, exÃ©cutez la commande suivante: <br><br><pre> <code class="bash hljs">openssl s_client -starttls smtp -crlf -connect smtp.yandex.ru:25 &gt; /etc/postfix/ca.pem</code> </pre> <br>  Mais une fois que les informations techniques seront affichÃ©es Ã  l'Ã©cran, l'Ã©quipe "continuera de se bloquer".  Appuyez sur Ctrl + C pour l'annuler. <br><br>  Maintenant, supprimez manuellement toutes les ordures du fichier rÃ©sultant et ne laissez que le certificat.  Vous devriez obtenir quelque chose comme ceci: <br><br><pre> <code class="bash hljs">nano /etc/postfix/ca.pem <span class="hljs-comment"><span class="hljs-comment">##################### -----BEGIN CERTIFICATE----- MIIGazCCBVOgAwIBAgIQcUU9mJXW4OUs5Gf0JfLtsjANBgkqhkiG9w0BAQsFADBf ... nRG0DfdqYIuPGApFORYe -----END CERTIFICATE----- #####################</span></span></code> </pre> <br>  Enfin, redÃ©marrez postfix: <br><br><pre> <code class="bash hljs">service postfix restart</code> </pre> <br>  Nous envoyons une lettre de test: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"  "</span></span> | mail -s <span class="hljs-string"><span class="hljs-string">" "</span></span> admin@lucky.ru</code> </pre> <br>  admin@lucky.ru - adresse de destination <br><br>  Ceci termine la configuration posfix. <br><br>  <b>Ã‰crire un script bash</b> <br><br>  CrÃ©ez un rÃ©pertoire pour stocker un script bash (ici, quelqu'un l'aime oÃ¹): <br><br><pre> <code class="bash hljs">mkdir /home/asterisk/scripts</code> </pre> <br>  CrÃ©ez un fichier de script bash: <br><br><pre> <code class="bash hljs">touch /home/asterisk/scripts/noanswer.sh</code> </pre> <br>  Nous donnons au fichier de script les autorisations pour exÃ©cuter: <br><br><pre> <code class="bash hljs">chmod +x /home/asterisk/scripts/noanswer.sh</code> </pre> <br>  En cas de doute sur les droits sur le fichier, vous pouvez donner un accÃ¨s complet au fichier pendant le dÃ©bogage.  Mais ce n'est "pas sÃ»r". <br><br><pre> <code class="bash hljs">chmod 777 /home/asterisk/scripts/noanswer.sh</code> </pre> <br>  Le texte du script bash: <br><br><pre> <code class="bash hljs">nano /home/asterisk/scripts/noanswer.sh <span class="hljs-comment"><span class="hljs-comment">##################### #!/bin/bash sleep 7 res_sql="SELECT disposition FROM cdr WHERE uniqueid = '$1'" answer=`mysql -u freepbxuser -pPassword_freepbxuser -D asteriskcdrdb -B -N -e "$res_sql" | grep -E -v "NO ANSWER|BUSY|FAILED|UNKNOWN" | head -n 1` error_kod=0 if [ "$answer" != "ANSWERED" ] then case $3 in 68800) address="big_boss@lucky.ru" subject="  " ;; 63100) address="debian@lucky.ru" subject="  linux debian" ;; 63200) address="windows@lucky.ru" subject="  windows" ;; 63300) address="freebsd@lucky.ru" subject="  freebsd" ;; 63400) address="ubuntu@lucky.ru" subject="  linux ubuntu" ;; 63500) address="centos@lucky.ru" subject="  linux centos" ;; *) address="admin@lucky.ru" error_kod=1 ;; esac case $error_kod in 0) echo "    $2,  $subject." | mail -s "   $2" $address echo "   $address   $2,  $subject. uid=$1" | mail -s "   $2" admin@lucky.ru ;; 1) echo "   $2.  . uid=$1" | mail -s "   $2" admin@lucky.ru ;; esac fi #####################</span></span></code> </pre> <br>  Une brÃ¨ve analyse du script: <br>  "Sleep 7": <br><br>  C'est le mÃªme dÃ©lai que celui que j'ai Ã©crit plus tÃ´t.  Nous avons un dÃ©lai de 7 secondes.  Bien que, je pense, une seconde suffit. <br><br><pre> <code class="sql hljs">Â«res_sql="<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> disposition <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> cdr <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> uniqueid = <span class="hljs-string"><span class="hljs-string">'$1'</span></span><span class="hljs-string"><span class="hljs-string">"Â»:</span></span></code> </pre> <br>  La requÃªte dans mysql nous mettons dans une variable distincte pour plus de commoditÃ©. <br><br>  Ensuite, nous faisons une demande dans mysql et filtrons la sortie rÃ©sultante.  Nous supprimons toutes les options sauf "RÃ‰PONDRE", le cas Ã©chÃ©ant.  S'il y a plusieurs valeurs Â«ANSWEREDÂ», alors une seule doit Ãªtre laissÃ©e.  Ã€ la fin, dans la variable Â«rÃ©ponseÂ», nous obtenons Â«RÃ‰PONSEÂ» ou Â«Â». <br>  Si la valeur de la variable de rÃ©ponse n'est pas Ã©gale Ã  RÃ‰PONSE, il s'agit d'un appel manquÃ©.  En fonction du numÃ©ro de file d'attente, Ã  l'aide de l'opÃ©rateur de cas, nous dÃ©finirons l'adresse Ã  laquelle il est nÃ©cessaire d'envoyer une notification par e-mail, et quoi Ã©crire dans ce message (partie variable du message). <br><br>  Ce qui suit est une option lorsque la file d'attente est dÃ©finie dans Asterisk, mais n'est pas dÃ©crite dans le script.  Dans ce cas, admin@lucky.ru recevra une lettre indiquant que la file d'attente n'est pas connue du script. <br><br>  Si la file d'attente est dÃ©crite, une lettre de destination et une lettre en double seront envoyÃ©es Ã  admin@lucky.ru indiquant Â«uniqueidÂ», afin que vous puissiez suivre les Ã©vÃ©nements de cet appel, si nÃ©cessaire. <br><br>  Ceci termine le script. <br><br>  Je note que pour se connecter Ã  mysql, nous avons utilisÃ© le nom d'utilisateur et le mot de passe que nous avons reconnus Ã  l'avance.  Dans FreePBX, afin de dÃ©couvrir la connexion utilisateur Asterisk dans mysql, exÃ©cutez la commande suivante: <br><br><pre> <code class="bash hljs">cat /etc/amportal.conf | grep AMPDBUSER</code> </pre> <br>  Et afin de trouver le mot de passe de l'utilisateur Asterisk dans mysql, exÃ©cutez la commande suivante: <br><br><pre> <code class="bash hljs">cat /etc/amportal.conf | grep AMPDBPASS</code> </pre> <br>  <b>Configurer Asterisk</b> <br><br>  Nous utilisons FreePBX.  FreePBX a diffÃ©rents types de fichiers de configuration (voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://asterisk-pbx.ru/wiki/freepbx/files</a> ), certains d'entre eux sont remplacÃ©s par FreePBX au redÃ©marrage, et certains ne sont pas Ã©crasÃ©s (ils sont appelÃ©s personnalisÃ©s), car ils sont spÃ©cialement conÃ§us pour l'utilisateur. <br><br>  Nous travaillerons avec le fichier de configuration Â«extensions_override_freepbx.confÂ», car il est de type custom. <br><br>  Tout d'abord, assurez-vous que le fichier Â«extensions_override_freepbx.confÂ» est connectÃ© dans le fichier Â«/etc/asterisk/extensions.confÂ».  Pour ce faire, exÃ©cutez la commande suivante: <br><br><pre> <code class="bash hljs">cat /etc/asterisk/extensions.conf | grep extensions_override_freepbx.conf <span class="hljs-comment"><span class="hljs-comment">##################### #include extensions_override_freepbx.conf #####################</span></span></code> </pre> <br>  Nous Ã©ditons le fichier "/etc/asterisk/extensions_override_freepbx.conf" et le portons sous la forme suivante: <br><br><pre> <code class="bash hljs">nano /etc/asterisk/extensions_override_freepbx.conf <span class="hljs-comment"><span class="hljs-comment">##################### [ext-queues] exten =&gt; h,1,System(/home/asterisk/scripts/noanswer.sh ${CDR(uniqueid)} ${CALLERID(num)} ${NODEST} &amp;) exten =&gt; h,2,Macro(hangupcall,) #####################</span></span></code> </pre> <br>  Comme je l'ai Ã©crit plus tÃ´t, le symbole Â«&amp;Â» Ã  la fin est requis.  Ã‰tant donnÃ© que nous travaillerons dans un script bash avec des donnÃ©es CDR directement Ã  partir de la base de donnÃ©es mysql, et que ces donnÃ©es ne sont entrÃ©es dans mysql qu'aprÃ¨s avoir exÃ©cutÃ© "exten =&gt; h, 2, Macro (hangupcall,)", nous n'avons pas besoin d'attendre la fin du script bash et passez Ã  l'Ã©tape suivante dans Asterisk.  Et le script bash lui-mÃªme doit contenir un dÃ©lai avant d'exÃ©cuter sa partie principale. <br><br>  Pour que les modifications du fichier de configuration Â«/etc/asterisk/extensions_override_freepbx.confÂ» prennent effet, vous devez redÃ©marrer le noyau Asterisk avec la commande suivante: <br><br><pre> <code class="bash hljs">/usr/sbin/asterisk -rx <span class="hljs-string"><span class="hljs-string">"core restart now"</span></span></code> </pre> <br>  Cela doit Ãªtre fait aprÃ¨s la crÃ©ation du script bash. <br><br>  <b>Conclusion</b> <br><br>  C'est probablement la 1001e faÃ§on de Â«capturer les appels manquÃ©sÂ» dans Asterisk.  Partagez dans les commentaires comment vous rÃ©solvez ce problÃ¨me.  Et ce qui, Ã  votre avis, peut Ãªtre amÃ©liorÃ© / refait / optimisÃ©.  Nous serons reconnaissants pour les idÃ©es constructives. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr463829/">https://habr.com/ru/post/fr463829/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr463817/index.html">20 chefs de produits et la structure matricielle la plus multidimensionnelle de tous. Conversation avec Skyeng</a></li>
<li><a href="../fr463819/index.html">Verrous PostgreSQL: 2. Verrous de chaÃ®ne</a></li>
<li><a href="../fr463821/index.html">AMO, Bitrix, 1C et autres: comment choisir par oÃ¹ commencer?</a></li>
<li><a href="../fr463823/index.html">Version Rust 1.37.0: optimisation guidÃ©e par le profil, constantes sans nom et fournisseur de fret</a></li>
<li><a href="../fr463825/index.html">Outil de gestion de projet Google Sheets</a></li>
<li><a href="../fr463831/index.html">Quel est le problÃ¨me avec l'enseignement informatique en Russie</a></li>
<li><a href="../fr463833/index.html">Une petite enquÃªte sur les bloqueurs</a></li>
<li><a href="../fr463835/index.html">Cet IdO dangereux: menaces commerciales et solutions</a></li>
<li><a href="../fr463839/index.html">Museum DataArt. Calculatrices Lunolet et soviÃ©tique</a></li>
<li><a href="../fr463845/index.html">TÃ©lÃ©gramme, c'est qui?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>