<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèæ‚Äçü§ù‚ÄçüßëüèΩ ‚õ∫Ô∏è ü§úüèø Uso de m√≥dulos estrictos en proyectos de Python a gran escala: experiencia de Instagram. Parte 2 ‚ù£Ô∏è ü§¨ üÜñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Presentamos a su atenci√≥n la segunda parte de la traducci√≥n de material dedicado a las caracter√≠sticas de trabajar con m√≥dulos en proyectos de Instagr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Uso de m√≥dulos estrictos en proyectos de Python a gran escala: experiencia de Instagram. Parte 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/475242/">  Presentamos a su atenci√≥n la segunda parte de la traducci√≥n de material dedicado a las caracter√≠sticas de trabajar con m√≥dulos en proyectos de Instagram Python.  La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">primera parte de la</a> traducci√≥n ofreci√≥ una visi√≥n general de la situaci√≥n y mostr√≥ dos problemas.  Uno de ellos se refiere al inicio lento del servidor, el segundo, los efectos secundarios de los comandos de importaci√≥n inseguros.  Hoy esta conversaci√≥n continuar√°.  Consideraremos otro problema y hablaremos sobre los enfoques para resolver todos los problemas planteados. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/nw/wv/sg/nwwvsgregexaj1ae6ds3gpfon-4.png"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Problema 3: estado global mutable</font> </h2><br>  Eche un vistazo a otra categor√≠a de errores comunes. <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myview</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span>     SomeClass.id = request.GET.get(<span class="hljs-string"><span class="hljs-string">"id"</span></span>)</code> </pre> <br>  Aqu√≠ estamos en la funci√≥n de presentaci√≥n y adjuntamos el atributo a una determinada clase en funci√≥n de los datos recibidos de la solicitud.  Probablemente ya entendiste la esencia del problema.  El hecho es que las clases son singletones globales.  Y aqu√≠ ponemos el estado, seg√∫n la solicitud, en un objeto de larga vida.  En un proceso de servidor web que tarda mucho en completarse, esto puede generar una contaminaci√≥n de cada solicitud futura que se realice como parte de este proceso. <br><br>  Lo mismo puede suceder f√°cilmente en las pruebas.  En particular, en los casos en que los programadores intentan usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">parches de mono</a> y no usan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el administrador de contexto</a> , como <code>mock.patch</code> .  Esto puede conducir no a la contaminaci√≥n de las solicitudes, sino a la contaminaci√≥n de todas las pruebas que se realizar√°n en el mismo proceso.  Esta es una raz√≥n seria para el comportamiento poco confiable de nuestro sistema de prueba.  Este es un problema importante y es muy dif√≠cil evitarlo.  Como resultado, abandonamos el sistema de prueba unificado y cambiamos a un esquema de aislamiento de prueba, que puede describirse como "una prueba por proceso". <br><br>  En realidad, este es nuestro tercer problema.  Un estado global mutable es un fen√≥meno no exclusivo de Python.  Lo puedes encontrar en cualquier lugar.  Estamos hablando de clases, m√≥dulos, listas o diccionarios adjuntos a m√≥dulos o clases, sobre objetos √∫nicos creados a nivel de m√≥dulo.  Trabajar en tal ambiente requiere disciplina.  Para evitar la contaminaci√≥n del estado global mientras el programa se est√° ejecutando, necesita un conocimiento muy bueno de Python. <br><br><h2>  <font color="#3AC1EF">Introduciendo m√≥dulos estrictos</font> </h2><br>  Una de las causas principales de nuestros problemas puede ser que usemos Python para resolver problemas para los que este lenguaje no est√° dise√±ado.  En equipos peque√±os y proyectos peque√±os, si sigue las reglas cuando usa Python, este lenguaje funciona bien.  Y deber√≠amos ir a un lenguaje m√°s riguroso. <br><br>  Pero nuestra base de c√≥digo ya ha superado el tama√±o que nos permite al menos hablar sobre c√≥mo reescribirlo en otro idioma.  Y, lo que es m√°s importante, a pesar de todos los problemas que enfrentamos, Python tiene mucho que ver con eso.  Nos da m√°s bien que mal.  A nuestros desarrolladores realmente les gusta este lenguaje.  Como resultado, depende solo de nosotros c√≥mo hacer que Python funcione en nuestra escala y c√≥mo asegurarnos de que podamos continuar trabajando en el proyecto a medida que se desarrolla. <br><br>  Encontrar soluciones a nuestros problemas nos llev√≥ a una idea.  Consiste en utilizar m√≥dulos estrictos. <br><br>  Los m√≥dulos estrictos son m√≥dulos de Python de un nuevo tipo, al principio del cual hay una construcci√≥n <code>__strict__ = True</code> .  Se implementan utilizando muchos de los mecanismos de extensibilidad de bajo nivel que Python ya tiene.  Un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cargador de m√≥dulo</a> especial analiza el c√≥digo usando el m√≥dulo <code>ast</code> , realiza una interpretaci√≥n abstracta del c√≥digo cargado para analizarlo, aplica varias transformaciones al AST y luego lo vuelve a <code>compile</code> en el c√≥digo de bytes de Python usando la funci√≥n de <code>compile</code> incorporada. <br><br><h2>  <font color="#3AC1EF">Sin efectos secundarios de importaci√≥n</font> </h2><br>  Los m√≥dulos estrictos imponen algunas restricciones sobre lo que puede suceder a nivel de m√≥dulo.  Por lo tanto, todo el c√≥digo de nivel de m√≥dulo (incluidos los decoradores y las funciones / inicializadores llamados a nivel de m√≥dulo) debe estar limpio, es decir, el c√≥digo est√° libre de efectos secundarios y no utiliza mecanismos de E / S.  El int√©rprete abstracto verifica estas condiciones utilizando los medios del an√°lisis de c√≥digo est√°tico en tiempo de compilaci√≥n. <br><br>  Esto significa que el uso de m√≥dulos estrictos no causa efectos secundarios al importarlos.  El c√≥digo ejecutado durante la importaci√≥n del m√≥dulo ya no puede causar problemas inesperados.  Debido al hecho de que probamos esto a nivel de interpretaci√≥n abstracta, usando herramientas que comprenden un gran subconjunto de Python, eliminamos la necesidad de limitar excesivamente la expresividad de Python.  Muchos tipos de c√≥digo din√°mico, desprovistos de efectos secundarios, se pueden utilizar de forma segura a nivel de m√≥dulo.  Esto incluye varios decoradores y la definici√≥n de constantes de nivel de m√≥dulo mediante listas o generadores de diccionario. <br><br>  Hag√°moslo m√°s claro, consideremos un ejemplo.  Aqu√≠ est√° el m√≥dulo estricto escrito correctamente: <br><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""Module docstring."""</span></span> __strict__ = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> utils <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> log_to_network MY_LIST = [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>] MY_DICT = {x: x+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> MY_LIST} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log_calls</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(func)</span></span></span><span class="hljs-function">:</span></span>    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_wrapped</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*args, **kwargs)</span></span></span><span class="hljs-function">:</span></span>        log_to_network(<span class="hljs-string"><span class="hljs-string">f"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{func.__name__}</span></span></span><span class="hljs-string"> called!"</span></span>)        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> func(*args, **kwargs)    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _wrapped @log_calls <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello_world</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span>    log_to_network(<span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>)</code> </pre> <br>  En este m√≥dulo, podemos usar las construcciones habituales de Python, incluido el c√≥digo din√°mico, uno que se usa para crear el diccionario y otro que describe el decorador de nivel de m√≥dulo.  Al mismo tiempo, acceder a los recursos de red en las funciones <code>_wrapped</code> o <code>hello_world</code> es completamente normal.  El hecho es que no se llaman a nivel de m√≥dulo. <br><br>  Pero si <code>log_to_network</code> llamada <code>log_to_network</code> a la funci√≥n externa <code>log_calls</code> , o si intent√°ramos usar un decorador que causara efectos secundarios (como <code>@route</code> del ejemplo anterior), o si <code>hello_world()</code> llamada <code>hello_world()</code> a nivel de m√≥dulo, entonces dejar√≠a de ser estrictamente estricto -m√≥dulo <br><br>  ¬øC√≥mo descubrir que no es seguro llamar a <code>log_to_network</code> o <code>route</code> funciones a nivel de m√≥dulo?  Partimos del supuesto de que todo lo importado de m√≥dulos que no son m√≥dulos estrictos es inseguro, con la excepci√≥n de algunas funciones de la biblioteca est√°ndar que se sabe que son seguras.  Si el m√≥dulo <code>utils</code> es un m√≥dulo estricto, entonces podemos confiar en el an√°lisis de nuestro m√≥dulo para informarnos si la funci√≥n <code>log_to_network</code> es <code>log_to_network</code> . <br><br>  Adem√°s de mejorar la confiabilidad del c√≥digo, las importaciones que no tienen efectos secundarios eliminan una barrera seria para asegurar descargas incrementales de c√≥digo.  Esto abre otras posibilidades para explorar formas de acelerar los equipos de importaci√≥n.  Si el c√≥digo de nivel del m√≥dulo no tiene efectos secundarios, esto significa que podemos ejecutar de forma segura las instrucciones individuales del m√≥dulo en modo "diferido", a pedido, al acceder a los atributos del m√≥dulo.  Esto es mucho mejor que seguir el algoritmo "codicioso", en cuya aplicaci√≥n se ejecuta de antemano todo el c√≥digo del m√≥dulo.  Y, teniendo en cuenta el hecho de que la forma de todas las clases en el m√≥dulo estricto es completamente conocida en el momento de la compilaci√≥n, en el futuro incluso podemos tratar de organizar el almacenamiento permanente de los metadatos del m√≥dulo (clases, funciones, constantes) generados por la ejecuci√≥n del c√≥digo.  Esto nos permitir√° organizar la importaci√≥n r√°pida de m√≥dulos sin cambios, lo que no requiere la ejecuci√≥n repetida de bytecode del nivel del m√≥dulo. <br><br><h2>  <font color="#3AC1EF">Inmunidad y atributo __slots__</font> </h2><br>  Los m√≥dulos y clases estrictos declarados en ellos son inmutables despu√©s de su creaci√≥n.  Los m√≥dulos se vuelven inmutables con la ayuda de la transformaci√≥n interna del cuerpo del m√≥dulo en una funci√≥n en la que el acceso a todas las variables globales se organiza a trav√©s de las variables de cierre.  Estos cambios han reducido seriamente la posibilidad de un cambio aleatorio en el estado global, aunque el estado global mutable a√∫n puede resolverse si se decide usarlo a trav√©s de m√≥dulos de nivel de contenedor mutable. <br><br>  Los miembros de las clases declaradas en m√≥dulos estrictos tambi√©n deben declararse en <code>__init__</code> .  Se escriben autom√°ticamente en el atributo <code>__slots__</code> durante la transformaci√≥n AST realizada por el cargador de m√≥dulos.  Como resultado, m√°s tarde ya no puede adjuntar atributos adicionales a la instancia de clase.  Aqu√≠ hay una clase similar: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">:</span></span>    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name, age)</span></span></span><span class="hljs-function">:</span></span>        self.name = name        self.age = age</code> </pre> <br>  Durante la transformaci√≥n AST, que se realiza durante el procesamiento de m√≥dulos estrictos, se detectar√°n las operaciones de asignaci√≥n de valores al <code>name</code> y <code>age</code> atributos de <code>age</code> realizados en <code>__init__</code> , y se adjuntar√° a la clase un atributo de la forma <code>__slots__ = ('name', 'age')</code> .  Esto evitar√° que se agreguen otros atributos a la instancia de clase.  (Si se utilizan anotaciones de tipo, tenemos en cuenta la informaci√≥n sobre los tipos disponibles en el nivel de clase, como <code>name: str</code> , y tambi√©n los agregamos a la lista de espacios). <br><br>  Las limitaciones descritas no solo hacen que el c√≥digo sea m√°s confiable.  Ayudan a acelerar la ejecuci√≥n del c√≥digo.  La transformaci√≥n autom√°tica de clases con la adici√≥n del atributo <code>__slots__</code> aumenta la eficiencia del uso de memoria cuando se trabaja con estas clases.  Esto le permite deshacerse de las b√∫squedas de diccionario cuando trabaja con instancias individuales de clases, lo que acelera el acceso a los atributos.  Adem√°s, podemos continuar optimizando estos patrones durante la ejecuci√≥n del c√≥digo Python, lo que nos permitir√° mejorar a√∫n m√°s nuestro sistema. <br><br><h2>  <font color="#3AC1EF">Resumen</font> </h2><br>  Los m√≥dulos estrictos siguen siendo tecnolog√≠a experimental.  Tenemos un prototipo funcional, estamos en las primeras etapas de implementaci√≥n de estas capacidades en producci√≥n.  Esperamos que despu√©s de obtener suficiente experiencia en el uso de m√≥dulos estrictos, podamos hablar m√°s sobre ellos. <br><br>  <b>Estimados lectores!</b>  ¬øCrees que las caracter√≠sticas que ofrecen los m√≥dulos estrictos son √∫tiles en tu proyecto de Python? <br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/-o/2e/tu/-o2etuqogwhmdnmysb9_vivc9v4.png"></a> </div><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/475242/">https://habr.com/ru/post/475242/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../475226/index.html">Pasant√≠a en la Fundaci√≥n Haxe</a></li>
<li><a href="../475228/index.html">Tenedor de n√≥mina. Eres un programador para mam√°</a></li>
<li><a href="../475236/index.html">Nunca ignores el entrenamiento de refuerzo de nuevo.</a></li>
<li><a href="../475238/index.html">Cronolog√≠a de Blade Runner: noviembre de 2019. ¬øEl pron√≥stico se hizo realidad?</a></li>
<li><a href="../475240/index.html">Uso de m√≥dulos estrictos en proyectos de Python a gran escala: experiencia de Instagram. Parte 1</a></li>
<li><a href="../475244/index.html">Nuevas caracter√≠sticas de JavaScript esperadas que debe conocer</a></li>
<li><a href="../475246/index.html">Programaci√≥n asincr√≥nica de Python: una breve descripci√≥n</a></li>
<li><a href="../475248/index.html">El uso de polyfills al escribir aplicaciones de navegador cruzado</a></li>
<li><a href="../475250/index.html">Como Redash not√≥ y solucion√≥ un problema que caus√≥ la degradaci√≥n del rendimiento del c√≥digo Python</a></li>
<li><a href="../475252/index.html">C√≥mo criticar a Microsoft</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>