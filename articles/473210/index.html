<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üó®Ô∏è üíÄ ‚ôøÔ∏è Representaci√≥n del lado del servidor para la aplicaci√≥n React en Express.js ü§§ ü§ôüèΩ ü§µüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Para escribir este art√≠culo, me llam√≥ la atenci√≥n la falta de un manual m√°s o menos completo sobre c√≥mo hacer Renderizado del lado del servidor para u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Representaci√≥n del lado del servidor para la aplicaci√≥n React en Express.js</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473210/"> Para escribir este art√≠culo, me llam√≥ la atenci√≥n la falta de un manual m√°s o menos completo sobre c√≥mo hacer Renderizado del lado del servidor para una aplicaci√≥n React. <br><br>  Cuando me encontr√© con este problema, ten√≠a 2 opciones para hacerlo, ya sea con el marco <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Next.js</a> o con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Express.js</a> . <br><br>  Se dedicaron aproximadamente 100 horas a la investigaci√≥n de Next.js para obtenerla para nuestra plataforma OTT grande lista para usar, pero hubo tantos problemas que la rechazamos (escribir√© un art√≠culo sobre esto nuevamente), hab√≠a una opci√≥n para una peque√±a, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Express.js</a> , sobre lo que quiero contar. <br><br>  El c√≥digo completo para la demostraci√≥n en este art√≠culo est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><a name="habracut"></a><br>  Comencemos con la tarea inicial y lo que ten√≠amos. <br><br>  Ten√≠amos en ese momento: <br><br><ul><li>  Una aplicaci√≥n completamente preparada, que ya estaba en producci√≥n, con su arquitectura y caracter√≠sticas enumeradas a continuaci√≥n. </li><li>  Usado por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Immutable.js</a> para la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tienda</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Sagas Redux</a> usadas </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">React.lazy</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">React.suspense</a> para importaci√≥n din√°mica </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">React-router 4</a> para enrutamiento </li><li>  Se utilizaron fuentes personalizadas para iconos. </li></ul><br>  Tareas <br><br><ul><li>  La soluci√≥n debe renderizar completamente HTML con datos </li><li>  Esta soluci√≥n deber√≠a afectar m√≠nimamente el c√≥digo existente, es decir, la arquitectura deber√≠a permanecer con cambios m√≠nimos. </li><li>  Continuar usando bibliotecas que ya est√°n en el proyecto. </li><li>  Los metadatos de SEO deben provenir del servidor, junto con la p√°gina </li><li>  Las im√°genes, estilos y fuentes deben cargarse en el servidor y enviarse al cliente, sin descarga posterior </li><li>  Soporte de importaci√≥n din√°mica del lado del cliente </li><li>  Evite la duplicaci√≥n de c√≥digo para precargar en el servidor y al navegar en el lado del cliente </li></ul><br>  Hemos decidido las tareas, veamos c√≥mo hacerlo. <br><br>  A partir de la documentaci√≥n de la reacci√≥n, podemos descubrir que para la SSR puede usar los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">m√©todos renderToString ()</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hydrate ()</a> , pero ¬øqu√© hacer a continuaci√≥n? <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">renderToString</a> : se utiliza para generar HTML en el servidor de nuestra aplicaci√≥n. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hidrato</a> : se utiliza para la representaci√≥n universal en el cliente y en el servidor. <br><br><h2>  Carga de datos </h2><br>  Para descargar datos en el lado del servidor, utilizamos la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">redux-connect</a> , que le permite descargar los datos necesarios antes de llamar al primer render, que es lo que necesitamos.  Para hacer esto, use hoc asyncConnect.  En el lado del servidor, carga datos y, cuando se enruta, funciona como componentDidMount. <br><br><pre><code class="javascript hljs">@asyncConnect([ { <span class="hljs-attr"><span class="hljs-attr">key</span></span>: <span class="hljs-string"><span class="hljs-string">'usersFromServer'</span></span>, <span class="hljs-attr"><span class="hljs-attr">promise</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> ({ <span class="hljs-attr"><span class="hljs-attr">store</span></span>: { dispatch } }) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> dispatch(getUsersData()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve(); }, }, ])</code> </pre> <br>  Necesitamos crear una tienda redux en el lado del servidor.  Todo est√° como siempre, solo cree en el archivo server.js. <br><br>  Tambi√©n en el lado del servidor, usando el m√©todo loadOnServer de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">redux-connect,</a> esperamos la precarga de datos. <br><br>  Usando renderToString obtenemos el HTML de nuestra aplicaci√≥n de datos. <br><br>  Los datos que visitamos pueden recuperarse usando getState () y agregarse mediante la etiqueta &lt;script /&gt; al objeto de la ventana global.  A partir de ese momento, en el cliente obtendremos los datos y los configuraremos en la puerta. <br><br>  Todo se ve as√≠ <br><br><pre> <code class="javascript hljs">app.get(<span class="hljs-string"><span class="hljs-string">'*'</span></span>, (req, res) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = req.originalUrl || req.url; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> history = createMemoryHistory({ <span class="hljs-attr"><span class="hljs-attr">initialEntries</span></span>: [url], }); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = configureStore(initialState, history); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> location = parseUrl(url); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> helpers = {}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> indexFile = path.resolve(<span class="hljs-string"><span class="hljs-string">'./build/main.html'</span></span>); store.runSaga(sagas).toPromise().then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> loadOnServer({ store, location, routes, helpers }) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> context = {}; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context.url) { req.header(<span class="hljs-string"><span class="hljs-string">'Location'</span></span>, context.url); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.send(<span class="hljs-number"><span class="hljs-number">302</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> css = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>(); <span class="hljs-comment"><span class="hljs-comment">// CSS for all rendered React components const insertCss = (...styles) =&gt; styles.forEach(style =&gt; css.add(style._getCss())); const dynamicRoutes = [...routes]; dynamicRoutes[0].routes = [...dynamicRoutes[0].routes, ...StaticRoutesConfig]; const appContent = ReactDOMServer.renderToString( &lt;StyleContext.Provider value={{ insertCss }}&gt; &lt;Provider store={store} key="provider"&gt; &lt;StaticRouter location={location} context={context}&gt; &lt;ReduxAsyncConnect routes={dynamicRoutes} helpers={helpers}/&gt; &lt;/StaticRouter&gt; &lt;/Provider&gt; &lt;/StyleContext.Provider&gt; ); const helmet = Helmet.renderStatic(); fs.readFile(indexFile, 'utf8', (err, data) =&gt; { if (err) { console.log('Something went wrong:', err); return res.status(500).send('Oops, better luck next time!'); } data = data.replace('__STYLES__', [...css].join('')); data = data.replace('__LOADER__', ''); data = data.replace('&lt;div id=app&gt;&lt;/div&gt;', `&lt;div id=app&gt;${appContent}&lt;/div&gt;`); data = data.replace('&lt;div id="app"&gt;&lt;/div&gt;', `&lt;div id="app"&gt;${appContent}&lt;/div&gt;`); data = data.replace('&lt;title&gt;&lt;/title&gt;', helmet.title.toString()); data = data.replace('&lt;meta name="description" content=""/&gt;', helmet.meta.toString()); data = data.replace('&lt;script&gt;__INITIAL_DATA__&lt;/script&gt;', `&lt;script&gt;window.__INITIAL_DATA__ = ${JSON.stringify(store.getState())};&lt;/script&gt;`); return res.send(data); }); }); store.close(); }); });</span></span></code> </pre><br>  Se pasan 2 accesorios al componente ReduxAsyncConnect: <br><br>  el primero son nuestras rutas, los segundos ayudantes (funciones auxiliares), a los que queremos estar accesibles en toda la aplicaci√≥n, una especie de an√°logo de contexto. <br><br>  Para el enrutamiento del servidor, use StaticRouter. <br><br>  La biblioteca del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">casco</a> se utiliza para agregar metaetiquetas seo.  Cada componente de la p√°gina tiene una descripci√≥n con etiquetas. <br><br>  Para que las etiquetas provengan del servidor de inmediato, se utiliza <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> helmet = Helmet.renderStatic(); helmet.title.toString() helmet.meta.toString()</code> </pre><br>  El enrutamiento tuvo que reescribirse en una matriz de objetos, se ve as√≠. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> StaticRoutesConfig = [ { <span class="hljs-attr"><span class="hljs-attr">key</span></span>: <span class="hljs-string"><span class="hljs-string">'usersGender'</span></span>, <span class="hljs-attr"><span class="hljs-attr">component</span></span>: UsersGender, <span class="hljs-attr"><span class="hljs-attr">exact</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'/users-gender/:gender'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">key</span></span>: <span class="hljs-string"><span class="hljs-string">'USERS'</span></span>, <span class="hljs-attr"><span class="hljs-attr">component</span></span>: Users, <span class="hljs-attr"><span class="hljs-attr">exact</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'/users'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">key</span></span>: <span class="hljs-string"><span class="hljs-string">'main'</span></span>, <span class="hljs-attr"><span class="hljs-attr">component</span></span>: Users, <span class="hljs-attr"><span class="hljs-attr">exact</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'/'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">key</span></span>: <span class="hljs-string"><span class="hljs-string">'not-found'</span></span>, <span class="hljs-attr"><span class="hljs-attr">component</span></span>: NotFound, }, ];</code> </pre><br>  Dependiendo de la url que viene al servidor, reaccionar enrutador devolvi√≥ la p√°gina de datos deseada. <br><br>  ¬øC√≥mo se ve el cliente? <br><br>  Aqu√≠ est√° el archivo principal del cliente.  Puede agregar an√°lisis para motores de b√∫squeda y c√≥digo que debe ejecutarse para cada p√°gina en el lado del cliente. <br><br>  <a href="">browser / index.js</a> <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'babel-polyfill'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { browserRender } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../app/app'</span></span>; browserRender();</code> </pre><br>  Archivo <a href="">App.js</a> <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> initialState = !process.env.IS_SERVER ? <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__INITIAL_DATA__ : {}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> history = process.env.IS_SERVER ? createMemoryHistory({ <span class="hljs-attr"><span class="hljs-attr">initialEntries</span></span>: [<span class="hljs-string"><span class="hljs-string">'/'</span></span>], }) : createBrowserHistory(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = configureStore(initialState, history); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!process.env.IS_SERVER) { <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.store = store; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> insertCss = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">...styles</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// eslint-disable-next-line no-underscore-dangle const removeCss = styles.map(style =&gt; style._insertCss()); return () =&gt; removeCss.forEach(dispose =&gt; dispose()); }; export const browserRender = () =&gt; { const dynamicRoutes = [...routes]; dynamicRoutes[0].routes = [...dynamicRoutes[0].routes, ...StaticRoutesConfig]; hydrate( &lt;StyleContext.Provider value={{ insertCss }}&gt; &lt;Provider key="provider" store={store} &gt; &lt;ConnectedRouter history={history}&gt; &lt;ReduxAsyncConnect helpers={{}} routes={dynamicRoutes} /&gt; &lt;/ConnectedRouter&gt; &lt;/Provider&gt; &lt;/StyleContext.Provider&gt;, document.getElementById('app'), ); };</span></span></code> </pre><br>  Para el enrutamiento, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se utiliza</a> el ConnectedRouter de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">conectado-reaccionar-enrutador / inmutable</a> . <br><br>  Para la representaci√≥n del lado del servidor, no podemos usar r <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">eact-router-dom</a> y describir adecuadamente nuestro enrutamiento a trav√©s de Switch: <br><br><pre> <code class="javascript hljs">&lt;Switch&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Route</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"/about"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">About</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Route</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;Route path=<span class="hljs-string"><span class="hljs-string">"/users"</span></span>&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Route</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;Route path=<span class="hljs-string"><span class="hljs-string">"/"</span></span>&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Home</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Route</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;<span class="hljs-regexp"><span class="hljs-regexp">/Switch&gt;</span></span></code> </pre><br>  En cambio, como ya se mencion√≥, tenemos una matriz con las rutas descritas, y para que podamos agregarlas a la aplicaci√≥n, necesitamos usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">react-router-config</a> : <br><br>  <a href="">App / index.js</a> <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React, { Component } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PropTypes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'prop-types'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { connect } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-redux'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Helmet } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-helmet'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { renderRoutes } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-router-config'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { getRouterLocation } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./selectors/router'</span></span>; @connect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> ({ <span class="hljs-attr"><span class="hljs-attr">location</span></span>: getRouterLocation(state), }), <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> propTypes = { <span class="hljs-attr"><span class="hljs-attr">location</span></span>: PropTypes.shape().isRequired, <span class="hljs-attr"><span class="hljs-attr">route</span></span>: PropTypes.shape().isRequired, }; render() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { route } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {renderRoutes(route.routes)} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ); } }</code> </pre><br><h2>  Descargue carnets, estilos y fuentes en el servidor </h2><br>  Para los estilos, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se utiliz√≥ el cargador de estilo isomorfo</a> , ya que el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cargador de software</a> habitual no funciona en el paquete web con el destino: "nodo"; <br><br>  Agrega todos los estilos al DOM, por lo tanto, la p√°gina hermosa y preparada proviene del servidor.  Puede guardar estilos en un archivo separado para que el navegador los pueda almacenar en cach√©. <br><br>  Para mostrar im√°genes y descargar fuentes en el servidor, se utiliz√≥ webpack loader <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">base64-inline-loader</a> . <br><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.(jpe?g|png|ttf|eot|otf|svg|woff(2)?)(\?[a-z0-9=&amp;.]+)?$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: <span class="hljs-string"><span class="hljs-string">'base64-inline-loader?limit=1000&amp;name=[name].[ext]'</span></span>, },</code> </pre><br>  Se incluy√≥ para im√°genes y todo tipo de fuentes que utilizamos.  Como resultado, recibimos un c√≥digo del servidor base64 que mostraba una p√°gina con fuentes e im√°genes sin carga posterior. <br><br>  Para la compilaci√≥n del cliente, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se usaron el</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cargador de</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">archivos</a> y el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">url</a> habituales. <br><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.(eot|svg|otf|ttf|woff|woff2)$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: <span class="hljs-string"><span class="hljs-string">'file-loader'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.(mp4|webm|png|gif)$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: { <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'url-loader'</span></span>, <span class="hljs-attr"><span class="hljs-attr">options</span></span>: { <span class="hljs-attr"><span class="hljs-attr">limit</span></span>: <span class="hljs-number"><span class="hljs-number">10000</span></span>, }, }, },</code> </pre><br>  S√≠, esto aument√≥ el tama√±o de la p√°gina cargada, pero no fue muy notable para el usuario en t√©rminos de velocidad de descarga. <br><br><h2>  Importaci√≥n din√°mica en el servidor </h2><br>  React.js usa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">React.lazy</a> y React.suspense para importar y mostrar din√°micamente el cargador, pero no funcionan para SSR. <br><br>  Usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">react-loadable</a> , que hace lo mismo. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Loadable <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-loadable'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Loader <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./Loader'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> LoadableComponent = Loadable({ <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span>(<span class="hljs-string"><span class="hljs-string">'./my-component'</span></span>), <span class="hljs-attr"><span class="hljs-attr">loading</span></span>: Loader, }); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LoadableComponent</span></span></span></span><span class="xml"><span class="hljs-tag">/&gt;</span></span></span></span>; } }</code> </pre><br>  En el cliente, este c√≥digo muestra el cargador, en el servidor, para que los m√≥dulos se carguen, debe agregar el siguiente c√≥digo: <br><br><pre> <code class="javascript hljs">Loadable.preloadAll().then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { app.listen(PORT, () =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">` Server is listening on port </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${PORT}</span></span></span><span class="hljs-string">`</span></span>); }); });</code> </pre><br>  Loadable.preloadAll (): devuelve una promesa que dice que los m√≥dulos est√°n cargados. <br><br>  Todos los aspectos destacados est√°n resueltos. <br><br>  Hice una mini demostraci√≥n usando todo lo que se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">describi√≥ en el art√≠culo</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/473210/">https://habr.com/ru/post/473210/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../473196/index.html">Convirtiendo guiones en hermosas herramientas de aprendizaje autom√°tico</a></li>
<li><a href="../473198/index.html">Motor paso a paso. Probar el chip L9110</a></li>
<li><a href="../473202/index.html">Probar la localizaci√≥n de juegos m√≥viles para mu√±ecos desde una tetera</a></li>
<li><a href="../473206/index.html">Discusi√≥n: c√≥mo los servicios de transmisi√≥n est√°n cambiando la cultura musical y el enfoque de la composici√≥n</a></li>
<li><a href="../473208/index.html">C√≥mo simplifiqu√© el proceso de trabajar en proyectos de c√≥digo abierto</a></li>
<li><a href="../473214/index.html">Yaga: cuentos eslavos en el entorno m√≥vil</a></li>
<li><a href="../473218/index.html">Entrevista con Ivan Kruglov, desarrollador principal: Service Mesh y herramientas "no est√°ndar" de Booking.com</a></li>
<li><a href="../473220/index.html">Las piedras angulares de la lenta destrucci√≥n del c√≥digo en Wolfram Language: acelerar el c√≥digo decenas, cientos y miles de veces</a></li>
<li><a href="../473222/index.html">Reglas personalizadas de iptables para docker usando zabbix como ejemplo</a></li>
<li><a href="../473224/index.html">Educaci√≥n superior vs competencia. Opini√≥n separada de un juez del Tribunal Constitucional de la Federaci√≥n de Rusia sobre el estado de la educaci√≥n superior</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>