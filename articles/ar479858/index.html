<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ต๐ป ๐ฉ ๐ ุชุจุญุซ ุนู LD_PRELOAD ๐น ๐ ๐คณ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูุชุจุช ูุฐู ุงููุฐูุฑุฉ ูู ุนุงู 2014 ุ ูููู ุชุนุฑุถุช ููุชู ููููุน ูู ุงููุญูุฑ ููู ุชุฑ ุงูููุฑ. ุฃุซูุงุก ุงูุญุธุฑ ุ ูุณูุช ุฐูู ุ ููููู ูุฌุฏุชู ุงูุขู ูู ูุณุฎ ูุณูุฏุฉ. ุงุนุชูุฏ ุงูู ูุงู ูุญุฐ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุชุจุญุซ ุนู LD_PRELOAD</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479858/" style=";text-align:right;direction:rtl">  ูุชุจุช ูุฐู ุงููุฐูุฑุฉ ูู ุนุงู 2014 ุ ูููู ุชุนุฑุถุช ููุชู ููููุน ูู ุงููุญูุฑ ููู ุชุฑ ุงูููุฑ.  ุฃุซูุงุก ุงูุญุธุฑ ุ ูุณูุช ุฐูู ุ ููููู ูุฌุฏุชู ุงูุขู ูู ูุณุฎ ูุณูุฏุฉ.  ุงุนุชูุฏ ุงูู ูุงู ูุญุฐู ุ ูููู ุฑุจูุง ุดุฎุต ูุง ูู ูุชูุงูู ุงููุฏูู. <br><br><img src="https://habrastorage.org/webt/o1/8i/wf/o18iwf72_dlx0j9-qjr8zni5unq.png"><br><br>  ุจุดูู ุนุงู ุ ูููู ูุณุคูู ุงูุฌูุนุฉ ุงูุตุบูุฑ ุจูุฑุงุกุฉ ููุถูุน ุงูุจุญุซ ุนู <i>LD_PRELOAD</i> "ุงููุถููู". <br><a name="habracut"></a><br><h2 style=";text-align:right;direction:rtl">  1. ุงุณุชุทุฑุงุฏุง ุตุบูุฑุง ูุฃููุฆู ุงูุฐูู ููุณูุง ุนูู ุฏุฑุงูุฉ ุจุงุณุชุจุฏุงู ุงููุธููุฉ </h2><br>  ูููู ุฃู ูุฐูุจ ุงูุจุงูู ูุจุงุดุฑุฉ ุฅูู <b>ุงูุฎุทูุฉ 2</b> . <br><br>  ููุจุฏุฃ ุจุงููุซุงู ุงูููุงุณููู: <br><br><pre style=";text-align:right;direction:rtl"><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;time.h&gt; int main() { srand (time(NULL)); for(int i=0; i&lt;5; i++){ printf ("%d\n", rand()%100); } }</span></span></span></span></code> </pre> <br>  ุชุฑุฌูุฉ ุฏูู ุฃู ุฃุนูุงู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ gcc ./ld_rand.c -o ld_rand</code> </pre><br>  ูููุง ูู ูุชููุน ุ ูุญุตู ุนูู 5 ุฃุฑูุงู ุนุดูุงุฆูุฉ ุฃูู ูู 100: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ ./ld_rand 53 93 48 57 20</code> </pre><br>  ููู ูููุชุฑุถ ุฃููุง ูุง ูููู ุงูููุฏ ุงููุตุฏุฑู ููุจุฑูุงูุฌ ุ ููุญู ุจุญุงุฌุฉ ุฅูู ุชุบููุฑ ุงูุณููู. <br><br>  ุฏุนููุง ููุดุฆ ููุชุจุชูุง ุงูุฎุงุตุฉ ุจูููุฐุฌ ูุธููุฉ ุฎุงุต ุจูุง ุ ุนูู ุณุจูู ุงููุซุงู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> </pre><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ gcc -shared -fPIC ./o_rand.c -o ld_rand.so</code> </pre><br>  ูุงูุขู ุฃุตุจุญ ุงุฎุชูุงุฑูุง ุงูุนุดูุงุฆู ูุชููุนูุง ุชูุงููุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># LD_PRELOAD=$PWD/ld_rand.so ./ld_rand 42 42 42 42 42</code> </pre><br>  ุชุจุฏู ูุฐู ุงูุฎุฏุนุฉ ุฃูุซุฑ ุฅุซุงุฑุฉ ููุฅุนุฌุงุจ ุฅุฐุง ูููุง ุฃููุงู ุจุชุตุฏูุฑ ููุชุจุชูุง ูู ุฎูุงู <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ export LD_PRELOAD=$PWD/ld_rand.so</code> </pre><br>  ุฃู ูุจู ุงูุชูููุฐ <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># echo "$PWD/ld_rand.so" &gt; /etc/ld.so.preload</code> </pre><br>  ุซู ูู ุจุชุดุบูู ุงูุจุฑูุงูุฌ ูู ุงููุถุน ุงูุนุงุฏู.  ูู ููู ุจุชุบููุฑ ุณุทุฑ ูุงุญุฏ ูู ุฑูุฒ ุงูุจุฑูุงูุฌ ููุณู ุ ูููู ุณูููู ูุนุชูุฏ ุงูุขู ุนูู ูุธููุฉ ุตุบูุฑุฉ ูู ููุชุจุชูุง.  ุนูุงูุฉ ุนูู ุฐูู ุ ูู ููุช ูุชุงุจุฉ ูุฐุง ุงูุชูุฑูุฑ ุ ูู ุชูู <i>ุงูุฑุงูุฏ</i> ุงููุฒููุฉ ููุฌูุฏุฉ. <br><br>  ูุง ุงูุฐู ุฌุนู ุจุฑูุงูุฌูุง ูุณุชุฎุฏู <i>ุฑุงูุฏ</i> ููููุฉุ  ุฏุนูุง ูุฐูุจ ูู ุฎูุงู ุงูุฎุทูุงุช. <br>  ุนูุฏ ุจุฏุก ุชุดุบูู ุงูุชุทุจูู ุ ูุชู ุชุญููู ููุชุจุงุช ูุนููุฉ ุชุญุชูู ุนูู ุงููุธุงุฆู ุงููุงุฒูุฉ ููุจุฑูุงูุฌ.  ูููููุง ุฑุคูุชูู ุจุงุณุชุฎุฏุงู <i>ldd</i> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># ldd ./ld_rand linux-vdso.so.1 (0x00007ffc8b1f3000) libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fe3da8af000) /lib64/ld-linux-x86-64.so.2 (0x00007fe3daa7e000)</code> </pre><br>  ูุฏ ุชุฎุชูู ูุฐู ุงููุงุฆูุฉ ููููุง ูุฅุตุฏุงุฑ ูุธุงู ุงูุชุดุบูู ุ ูููู ูุฌุจ ุฃู ูููู <i>ููุงู</i> ููู <i>libc.so ููุงู</i> .  ูุฐู ุงูููุชุจุฉ ูู ุงูุชู ุชููุฑ ููุงููุงุช ุงููุธุงู ูุงููุธุงุฆู ุงูุฃุณุงุณูุฉ ุ ูุซู <i>open</i> ุ <i>malloc</i> ุ <i>printf</i> ุ ููุง ุฅูู ุฐูู.  ุชุฃูุฏ ูู ูุฐุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># nm -D /lib/x86_64-linux-gnu/libc.so.6 | grep " rand$" 000000000003aef0 T rand</code> </pre><br>  ุฏุนููุง ูุฑู ูุง ุฅุฐุง ูุงูุช ูุฌููุนุฉ ุงูููุชุจุงุช ุณุชุชุบูุฑ ุนูุฏ ุงุณุชุฎุฏุงู <i>LD_PRELOAD</i> <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># LD_PRELOAD=$PWD/ld_rand.so ldd ./ld_rand linux-vdso.so.1 (0x00007ffea52ae000) /scripts/c/ldpreload/ld_rand.so (0x00007f690d3f9000) libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f690d230000) /lib64/ld-linux-x86-64.so.2 (0x00007f690d405000)</code> </pre><br>  ุงุชุถุญ ุฃู ุงููุชุบูุฑ ุงููุญุฏุฏ <i>LD_PRELOAD</i> ููุฑุถ <i>ld_rand.so</i> ุนูู ุชุญูููู ุ ุนูู ุงูุฑุบู ูู ุฃู ุงูุจุฑูุงูุฌ ููุณู ูุง ูุชุทูุจ ุฐูู.  ููุธุฑูุง ูุฃู ูุธููุฉ <i>rand</i> ูุชู ุชุญููููุง ูุณุจููุง ูู <i>rand</i> ูู <i>libc.so</i> ุ ูุฅููุง ุชุญูู ุงููุฑุฉ. <br><br>  ุญุณููุง ุ ููุฏ ูุฌุญูุง ูู ุงุณุชุจุฏุงู ุงููุธููุฉ ุงูุฃุตููุฉ ุ ูููู ููููุฉ ุงูุชุฃูุฏ ูู ุงูุญูุงุธ ุนูู ูุธุงุฆููุง ูุฅุถุงูุฉ ุจุนุถ ุงูุฅุฌุฑุงุกุงุช.  ูููู ุจุชุนุฏูู ุนุดูุงุฆู ูุฏููุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;dlfcn.h&gt; #include &lt;stdio.h&gt; typedef int (*orig_rand_f_type)(void); int rand() { /*    */ printf("Evil injected code\n"); orig_rand_f_type orig_rand; orig_rand = (orig_rand_f_type)dlsym(RTLD_NEXT,"rand"); return orig_rand(); }</span></span></span></span></code> </pre><br>  ููุง ุ ูุฅุถุงูุฉ ูุฏููุง ุ ูุทุจุน ุณุทุฑูุง ูุงุญุฏูุง ููุท ูู ุงููุต ุ ุซู ููุดุฆ ูุคุดุฑูุง ููุธููุฉ <i>rand</i> ุงูุฃุตููุฉ.  ููุญุตูู ุนูู ุนููุงู ูุฐู ุงููุธููุฉ ุ ูุญุชุงุฌ ุฅูู <i>dlsym</i> - ูุฐู ูุธููุฉ ูู ููุชุจุฉ <i>libdl</i> ุงูุชู ุณุชุฌุฏ <i>ุฑุงูุฏูุง</i> ูู ูุฌููุนุฉ ุงูููุชุจุงุช ุงูุฏููุงููููุฉ.  ุจุนุฏ ุฐูู ุณูู ูุณูู ูุฐู ุงููุธููุฉ ููุนูุฏ ูููุชูุง.  ููููุง ูุฐูู ุ ุณูุญุชุงุฌ ุฅูู ุฅุถุงูุฉ <i>"-ldl"</i> ุนูุฏ ุงูุจูุงุก: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ gcc -ldl -shared -fPIC ./o_rand_evil.c -o ld_rand_evil.so</code> </pre><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ LD_PRELOAD=$PWD/ld_rand_evil.so ./ld_rand Evil injected code 66 Evil injected code 28 Evil injected code 93 Evil injected code 93 Evil injected code 95</code> </pre><br>  ููุณุชุฎุฏู ุจุฑูุงูุฌูุง <i>ุงูุฑุงูุฏ</i> "ุงูุฃุตูู" ุ ุจุนุฏ ุงูููุงู ุจุจุนุถ ุงูุฅุฌุฑุงุกุงุช ุบูุฑ ุงููุงุฆูุฉ. <br><br><h2 style=";text-align:right;direction:rtl">  2. ุงูุจุญุซ ุงูุฏููู </h2><br>  ูุน ุงูุนูู ุจุงูุชูุฏูุฏ ุงููุญุชูู ุ ูุฑูุฏ ุฃู ููุชุดู ุฃูู ุชู ุชูููุฐ <i>ุงูุชุญููู ุงููุณุจู</i> .  ูู ุงููุงุถุญ ุฃู ุฃูุถู ุทุฑููุฉ ููุงูุชุดุงู ูู ุฏูุนูุง ุฅูู ุงูููุงุฉ ุ ููููู ููุช ููุชููุง ุจุงูุชุญุฏูุฏ ูู ุชุนุฑููุงุช ูุณุงุญุฉ ุงููุณุชุฎุฏู. <br><br>  ุจุนุฏ ุฐูู ุ ุณูู ุชุชุญูู ุญููู ุงููุดู ูุฏุญุถูุง ุฅูู ุฃุฒูุงุฌ. <br><br><h2 style=";text-align:right;direction:rtl">  2.1.  ููุจุฏุฃ ุจูู ุจุณุงุทุฉ </h2><br>  ููุง ุฐูุฑูุง ุณุงุจููุง ุ ููููู ุชุญุฏูุฏ ุงูููุชุจุฉ ุงููุฑุงุฏ ุชุญููููุง ุจุงุณุชุฎุฏุงู ูุชุบูุฑ <i>LD_PRELOAD</i> ุฃู ุนู ุทุฑูู ูุชุงุจุชูุง ูู ููู <i>/etc/ld.so.preload</i> .  ุฏุนููุง ุฅูุดุงุก ุงุซููู ูู ุฃุจุณุท ุฃุฌูุฒุฉ ุงููุดู. <br><br>  ุงูุฃูู ูู ุงูุชุญูู ูู ูุชุบูุฑ ุงูุจูุฆุฉ ุงููุญุฏุฏ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;fcntl.h&gt; int main() { char* pGetenv = getenv("LD_PRELOAD"); pGetenv != NULL ? printf("LD_PRELOAD (getenv) [+]\n"): printf("LD_PRELOAD (getenv) [-]\n"); }</span></span></span></span></code> </pre><br>  ูุงูุซุงูู ูู ุงูุชุญูู ูู ูุชุญ ุงูููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;fcntl.h&gt; int main() { open("/etc/ld.so.preload", O_RDONLY) != -1 ? printf("LD_PRELOAD (open) [+]\n"): printf("LD_PRELOAD (open) [-]\n"); }</span></span></span></span></code> </pre><br>  ุชุญููู ุงูููุชุจุงุช: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ export LD_PRELOAD=$PWD/ld_rand.so $ echo "$PWD/ld_rand.so" &gt; /etc/ld.so.preload $ ./detect_base_getenv LD_PRELOAD (getenv) [+] $ ./detect_base_open LD_PRELOAD (open) [+]</code> </pre><br>  ูููุง ููู ุ ูุดูุฑ [+] ุฅูู ุงูุชุดุงู ูุงุฌุญ. <br>  ูููุง ูุฐูู ุ [-] ูุนูู ูุดู ุงูุงูุชูุงููุฉ. <br><br>  ูุง ูุฏู ูุนุงููุฉ ูุฐุง ุงููุงุดูุ  ุฃููุงู ุ ุฏุนูุง ูููู ูุธุฑุฉ ุนูู ูุชุบูุฑ ุงูุจูุฆุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;dlfcn.h&gt; char* (*orig_getenv)(const char *) = NULL; char* getenv(const char *name) { if(!orig_getenv) orig_getenv = dlsym(RTLD_NEXT, "getenv"); if(strcmp(name, "LD_PRELOAD") == 0) return NULL; return orig_getenv(name); }</span></span></span></span></code> </pre><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ gcc -shared -fpic -ldl ./ld_undetect_getenv.c -o ./ld_undetect_getenv.so $ LD_PRELOAD=./ld_undetect_getenv.so ./detect_base_getenv LD_PRELOAD (getenv) [-]</code> </pre><br>  ูุจุงููุซู ุ ูุชุฎูุต ูู ุงูุดููุงุช <i>ุงูููุชูุญุฉ</i> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;string.h&gt; #include &lt;stdlib.h&gt; #include &lt;dlfcn.h&gt; #include &lt;errno.h&gt; int (*orig_open)(const char*, int oflag) = NULL; int open(const char *path, int oflag, ...) { char real_path[256]; if(!orig_open) orig_open = dlsym(RTLD_NEXT, "open"); realpath(path, real_path); if(strcmp(real_path, "/etc/ld.so.preload") == 0){ errno = ENOENT; return -1; } return orig_open(path, oflag); }</span></span></span></span></code> </pre><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ gcc -shared -fpic -ldl ./ld_undetect_open.c -o ./ld_undetect_open.so $ LD_PRELOAD=./ld_undetect_open.so ./detect_base_open LD_PRELOAD (open) [-]</code> </pre><br>  ูุนู ุ ูููู ููุง ุงุณุชุฎุฏุงู ุทุฑู ุฃุฎุฑู ูููุตูู ุฅูู ุงูููู ุ ูุซู <i>open64</i> ุ <i>stat</i> ุ ููุง ุฅูู ุฐูู ุ ูููู ูู ุงููุงูุน ุ ููุงู ุญุงุฌุฉ ุฅูู 5-10 ุณุทูุฑ ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ <i>ูุฎุฏุงุนูู</i> . <br><br><h2 style=";text-align:right;direction:rtl">  2.2.  ุงููุถู ูุฏูุง </h2><br>  ุฃุนูุงู ุ ุงุณุชุฎุฏููุง <i>getenv ()</i> ููุญุตูู ุนูู ูููุฉ <i>LD_PRELOAD</i> ุ ูููู ููุงู ุฃูุถูุง ุทุฑููุฉ "ููุฎูุถุฉ ุงููุณุชูู" ูููุตูู ุฅูู ูุชุบูุฑุงุช <i>ENV</i> .  ูู ูุณุชุฎุฏู ูุธุงุฆู ูุณูุทุฉ ุ ูููู ูุฑุฌู ุงูุฑุฌูุน ุฅูู ุตููู <i>** environ</i> ุ ุญูุซ ูุชู ุชุฎุฒูู ูุณุฎุฉ ูู ุงูุจูุฆุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;string.h&gt; extern char **environ; int main(int argc, char **argv) { int i; char env[] = "LD_PRELOAD"; if (environ != NULL) for (i = 0; environ[i] != NULL; i++) { char * pch; pch = strstr(environ[i],env); if(pch != NULL) { printf("LD_PRELOAD (**environ) [+]\n"); return 0; } } printf("LD_PRELOAD (**environ) [-]\n"); return 0; }</span></span></span></span></code> </pre><br>  ูุธุฑูุง ูุฃููุง ููุง ููุฑุฃ ุงูุจูุงูุงุช ูุจุงุดุฑุฉ ูู ุงูุฐุงูุฑุฉ ุ ูุง ูููู ุงุนุชุฑุงุถ ูุซู ูุฐู ุงูููุงููุฉ ุ ููู ูุนุฏ <i>ุชุฏุฎููุง ูู ุงูุชุดุงู</i> ุฃูุฑ ุงูุชุฏุฎู. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ LD_PRELOAD=./ld_undetect_getenv.so ./detect_environ LD_PRELOAD (**environ) [+]</code> </pre><br>  ูุจุฏู ุฃู ุงููุดููุฉ ูุฏ ุชู ุญููุงุ  ูุง ูุฒุงู ูุฌุฑุฏ ุจุฏุงูุฉ. <br><br>  ุจุนุฏ ุจุฏุก ุชุดุบูู ุงูุจุฑูุงูุฌ ุ ูู ุชุนุฏ ูููุฉ ุงููุชุบูุฑ <i>LD_PRELOAD</i> ูู ุงูุฐุงูุฑุฉ ุถุฑูุฑูุฉ ููููุฑูุนุงุช ุ ุฃู ููููู ูุฑุงุกุชูุง ูุญุฐููุง ูุจู ุชูููุฐ ุฃู ุชุนูููุงุช.  ุจุงูุทุจุน ุ ูุนุฏ ุชุญุฑูุฑ ุตููู ูู ุงูุฐุงูุฑุฉ ุฃุณููุจ ุจุฑูุฌุฉ ุณูุฆูุง ุนูู ุงูุฃูู ุ ููู ูู ูููู ููุฐุง ุฃู ูููู ุดุฎุตูุง ูุง ูุฑุบุจ ูููุง ุฌูุฏูุง ุญููุงุ <br><br>  ููููุงู ุจุฐูู ุ ูุญุชุงุฌ ุฅูู ุฅูุดุงุก ุฏุงูุฉ ููููุฉ <i>(init)</i> ุงูุฎุงุตุฉ ุจูุง ุ ูุงูุชู <i>ูุนุชุฑุถ ูููุง LD_PRELOAD</i> ุงููุซุจุช <i>ูููุฑุฑู</i> ุฅูู ุฑุงุจุทูุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;dlfcn.h&gt; #include &lt;stdlib.h&gt; extern char **environ; char *evil_env; int (*orig_execve)(const char *path, char *const argv[], char *const envp[]) = NULL; //    init //       //   -  void evil_init() { //     LD_PRELOAD static const char *ldpreload = "LD_PRELOAD"; int len = strlen(getenv(ldpreload)); evil_env = (char*) malloc(len+1); strcpy(evil_env, getenv(ldpreload)); int i; char env[] = "LD_PRELOAD"; if (environ != NULL) for (i = 0; environ[i] != NULL; i++) { char * pch; pch = strstr(environ[i],env); if(pch != NULL) { //    LD_PRELOAD unsetenv(env); break; } } } int execve(const char *path, char *const argv[], char *const envp[]) { int i = 0, j = 0, k = -1, ret = 0; char** new_env; if(!orig_execve) orig_execve = dlsym(RTLD_NEXT,"execve"); //       LD_PRELOAD for(i = 0; envp[i]; i++){ if(strstr(envp[i], "LD_PRELOAD")) k = i; } //  LD_PRELOAD     ,    if(k == -1){ k = i; i++; } //    new_env = (char**) malloc((i+1)*sizeof(char*)); //   ,   LD_PRELOAD for(j = 0; j &lt; i; j++) { //    LD_PRELOAD if(j == k) { new_env[j] = (char*) malloc(256); strcpy(new_env[j], "LD_PRELOAD="); strcat(new_env[j], evil_env); } else new_env[j] = (char*) envp[j]; } new_env[i] = NULL; ret = orig_execve(path, argv, new_env); free(new_env[k]); free(new_env); return ret; }</span></span></span></span></code> </pre><br>  ูุญู ุฃุฏุงุก ุ ุชุญูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ gcc -shared -fpic -ldl -Wl,-init,evil_init ./ld_undetect_environ.c -o ./ld_undetect_environ.so $ LD_PRELOAD=./ld_undetect_environ.so ./detect_environ LD_PRELOAD (**environ) [-]</code> </pre><br><h2 style=";text-align:right;direction:rtl">  2.3.  / ุจุฑูู / ุงูููุณ / </h2><br>  ููุน ุฐูู ุ ูุฅู ุงูุฐุงูุฑุฉ ููุณุช ูู ุขุฎุฑ ููุงู ููููู ููู ุงูุชุดุงู ุฎุฏุงุน <i>LD_PRELOAD</i> ุ ูููุงู ุฃูุถูุง <i>/ proc /</i> .  ููุจุฏุฃ <i>ุจุงูุชูุถูุญ / proc / {PID} / environ</i> . <br><br>  ูู ุงููุงูุน ููุงู ุญู ุนุงููู <i>ูููุดู</i> ุนู <i>** environ</i> ู <i>/ proc / self / environ</i> .  ุงููุดููุฉ ูู ุงูุณููู "ุงูุฎุงุทุฆ" ู <i>unsetenv (env)</i> . <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงูุฎูุงุฑ ุงูุตุญูุญ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evil_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     LD_PRELOAD static const char *ldpreload = "LD_PRELOAD"; int len = strlen(getenv(ldpreload)); evil_env = (char*) malloc(len+1); strcpy(evil_env, getenv(ldpreload)); int i; char env[] = "LD_PRELOAD"; if (environ != NULL) for (i = 0; environ[i] != NULL; i++) { char * pch; pch = strstr(environ[i],env); if(pch != NULL) { //    LD_PRELOAD //unsetenv(env); //  unset     for(int j = 0; environ[i][j] != '\0'; j++) environ[i][j] = '\0'; break; } } }</span></span></code> </pre><br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ gcc -shared -fpic -ldl -Wl,-init,evil_init ./ld_undetect_environ_2.c -o ./ld_undetect_environ_2.so $ (LD_PRELOAD=./ld_undetect_environ_2.so cat /proc/self/environ; echo) | tr "\000" "\n" | grep -F LD_PRELOAD $</code> </pre><br></div></div><br>  ููู ูููุชุฑุถ ุฃููุง ูู ูุนุซุฑ ุนูููุง ู <i>/ proc / self / environ</i> ูุญุชูู ุนูู ุจูุงูุงุช "ุฅุดูุงููุฉ". <br><br>  ุฃููุงู ุ ุฌุฑูุจ ุงุณุชุฎุฏุงู "ุชูููู" ุงูุณุงุจู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ (LD_PRELOAD=./ld_undetect_environ.so cat /proc/self/environ; echo) | tr "\000" "\n" | grep -F LD_PRELOAD LD_PRELOAD=./ld_undetect_environ.so</code> </pre><br>  ูุณุชุฎุฏู <i>cat</i> ููุณ <i>open ()</i> ููุชุญ ุงูููู ุ ูุจุงูุชุงูู ูุฅู ุงูุญู ูุดุงุจู ููุง ุชู ูุนูู ุจุงููุนู ูู ุงููุณู 2.1 ุ ููููุง ุงูุขู ูููู ุจุฅูุดุงุก ููู ูุคูุช ุญูุซ ูููู ุจูุณุฎ ููู ุงูุฐุงูุฑุฉ ุงูุญููููุฉ ุฏูู ุฎุทูุท ุชุญุชูู ุนูู <i>LD_PRELOAD</i> . <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;dlfcn.h&gt; #include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;fcntl.h&gt; #include &lt;sys/stat.h&gt; #include &lt;unistd.h&gt; #include &lt;limits.h&gt; #include &lt;errno.h&gt; #define BUFFER_SIZE 256 int (*orig_open)(const char*, int oflag) = NULL; char *soname = "fakememory_preload.so"; char *sstrstr(char *str, const char *sub) { int i, found; char *ptr; found = 0; for(ptr = str; *ptr != '\0'; ptr++) { found = 1; for(i = 0; found == 1 &amp;&amp; sub[i] != '\0'; i++){ if(sub[i] != ptr[i]) found = 0; } if(found == 1) break; } if(found == 0) return NULL; return ptr + i; } void fakeMaps(char *original_path, char *fake_path, char *pattern) { int fd; char buffer[BUFFER_SIZE]; int bytes = -1; int wbytes = -1; int k = 0; pid_t pid = getpid(); int fh; if ((fh=orig_open(fake_path,O_CREAT|O_WRONLY))==-1) { printf("LD: Cannot open write-file [%s] (%d) (%s)\n", fake_path, errno, strerror(errno)); exit (42); } if((fd=orig_open(original_path, O_RDONLY))==-1) { printf("LD: Cannot open read-file.\n"); exit(42); } do { char t = 0; bytes = read(fd, &amp;t, 1); buffer[k++] = t; //printf("%c", t); if(t == '\0') { //printf("\n"); if(!sstrstr(buffer, "LD_PRELOAD")) { if((wbytes = write(fh,buffer,k))==-1) { //printf("write error\n"); } else { //printf("writed %d\n", wbytes); } } k = 0; } } while(bytes != 0); close(fd); close(fh); } int open(const char *path, int oflag, ...) { char real_path[PATH_MAX], proc_path[PATH_MAX], proc_path_0[PATH_MAX]; pid_t pid = getpid(); if(!orig_open) orig_open = dlsym(RTLD_NEXT, "open"); realpath(path, real_path); snprintf(proc_path, PATH_MAX, "/proc/%d/environ", pid); if(strcmp(real_path, proc_path) == 0) { snprintf(proc_path, PATH_MAX, "/tmp/%d.fakemaps", pid); realpath(proc_path_0, proc_path); fakeMaps(real_path, proc_path, soname); return orig_open(proc_path, oflag); } return orig_open(path, oflag); }</span></span></span></span></code> </pre><br>  ููุฏ ุชู ุงูุงูุชูุงุก ูู ูุฐู ุงููุฑุญูุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ (LD_PRELOAD=./ld_undetect_proc_environ.so cat /proc/self/environ; echo) | tr "\000" "\n" | grep -F LD_PRELOAD $</code> </pre><br>  ุงูููุงู ุงููุงุถุญ ุงูุชุงูู ูู <i>/ proc / self / maps</i> .  ููุณ ูู ุงูููุทูู ุงูุงุณุชูุฑุงุฑ ูู ุฐูู.  ุงูุญู ูุทุงุจู ุชูุงููุง ููุญู ุงูุณุงุจู: ูุณุฎ ุงูุจูุงูุงุช ูู ุงูููู ูุทุฑูุญูุง ูููุง ุงูุณุทูุฑ ุจูู <i>libc.so</i> ู <i>ld.so.</i> <br><br><h2 style=";text-align:right;direction:rtl">  2.4.  ุฎูุงุฑ ูู Chokepoint </h2><br>  ุฃุนุฌุจูู ูุฐุง ุงูุญู ุจุดูู ุฎุงุต ุจุณุจุจ ุจุณุงุทุชู.  ูุงุฑู ุจูู ุนูุงููู ุงููุธุงุฆู ุงูุชู ุชู ุชุญููููุง ูุจุงุดุฑุฉู ูู <i>libc</i> ูุนููุงู "NEXT". <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;dlfcn.h&gt; #define LIBC "/lib/x86_64-linux-gnu/libc.so.6" int main(int argc, char *argv[]) { void *libc = dlopen(LIBC, RTLD_LAZY); // Open up libc directly char *syscall_open = "open"; int i; void *(*libc_func)(); void *(*next_func)(); libc_func = dlsym(libc, syscall_open); next_func = dlsym(RTLD_NEXT, syscall_open); if (libc_func != next_func) { printf("LD_PRELOAD (syscall - %s) [+]\n", syscall_open); printf("Libc address: %p\n", libc_func); printf("Next address: %p\n", next_func); } else { printf("LD_PRELOAD (syscall - %s) [-]\n", syscall_open); } return 0; }</span></span></span></span></code> </pre><br>  ูุญููู ุงูููุชุจุฉ ุจุงูุงุนุชุฑุงุถ <i>"open ()"</i> ูููุญุต: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ export LD_PRELOAD=$PWD/ld_undetect_open.so $ ./detect_chokepoint LD_PRELOAD (syscall - open) [+] Libc address: 0x7fa86893b160 Next address: 0x7fa868a26135</code> </pre><br>  ุชุจูู ุฃู ุงูุฏุญุถ ุฃุจุณุท ูู ุฐูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">#define _GNU_SOURCE #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;dlfcn.h&gt; extern void * _dl_sym (void *, const char *, void *); void * dlsym (void * handle, const char * symbol) { return _dl_sym (handle, symbol, dlsym); }</code> </pre><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># LD_PRELOAD=./ld_undetect_chokepoint.so ./detect_chokepoint LD_PRELOAD (syscall - open) [-]</code> </pre><br><h2 style=";text-align:right;direction:rtl">  2.5.  Syscalls </h2><br>  ูุจุฏู ุฃู ูุฐุง ูู ุดูุก ุ ูููู ูุง ูุฒุงู ูุชุนุซุฑ.  ุฅุฐุง ูููุง ุจุชูุฌูู ููุงููุฉ ูุธุงู ูุจุงุดุฑุฉ ุฅูู ุงูููุงุฉ ุ ูุณูู ูุชุญุงูู ุฐูู ุนูู ุนูููุฉ ุงูุงุนุชุฑุงุถ ุจุฃููููุง.  ุงูุญู ุฃุฏูุงู ุ ุจุทุจูุนุฉ ุงูุญุงู ุ <i>ูุนุชูุฏ ุนูู</i> ุงูููุฏุณุฉ ุงููุนูุงุฑูุฉ ( <i>x86_64</i> ).  ุฏุนููุง ูุญุงูู ุชุทุจูู <i>ld.so.preload</i> ูููุดู ุนู ุงููุชุญ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;sys/stat.h&gt; #include &lt;fcntl.h&gt; #define BUFFER_SIZE 256 int syscall_open(char *path, long oflag) { int fd = -1; __asm__ ( "mov $2, %%rax;" // Open syscall number "mov %1, %%rdi;" // Address of our string "mov %2, %%rsi;" // Open mode "mov $0, %%rdx;" // No create mode "syscall;" // Straight to ring0 "mov %%eax, %0;" // Returned file descriptor :"=r" (fd) :"m" (path), "m" (oflag) :"rax", "rdi", "rsi", "rdx" ); return fd; } int main() { syscall_open("/etc/ld.so.preload", O_RDONLY) &gt; 0 ? printf("LD_PRELOAD (open syscall) [+]\n"): printf("LD_PRELOAD (open syscall) [-]\n"); }</span></span></span></span></code> </pre><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ ./detect_syscall LD_PRELOAD (open syscall) [+]</code> </pre><br>  ููุฐู ุงููุดููุฉ ููุง ุญู.  ููุชุทู ูู <i>ุงูุฑุฌู</i> : <br><blockquote style=";text-align:right;direction:rtl">  ptrace ูู ุฃุฏุงุฉ ุชุณูุญ ูุนูููุฉ ุงูุฃุตู ุจูุฑุงูุจุฉ ุชุฏูู ุนูููุฉ ุฃุฎุฑู ูุงูุชุญูู ูููุง ุ ูุนุฑุถ ูุชุบููุฑ ุจูุงูุงุชูุง ูุณุฌูุงุชูุง.  ุนุงุฏุฉู ูุง ูุชู ุงุณุชุฎุฏุงู ูุฐู ุงููุธููุฉ ูุฅูุดุงุก ููุงุท ุชููู ูู ุจุฑูุงูุฌ ุชุตุญูุญ ุงูุฃุฎุทุงุก ูุชุนูุจ ููุงููุงุช ุงููุธุงู. <br><br>  ูููู ุฃู ุชุจุฏุฃ ุงูุนูููุฉ ุงูุฃุตู ูู ุงูุชุชุจุน ุนู ุทุฑูู ุงุณุชุฏุนุงุก ุฏุงูุฉ fork (2) ุฃููุงู ุ ูุจุนุฏ ุฐูู ูููู ุชูููุฐ ุงูุนูููุฉ ุงูุชุงุจุนุฉ ุงููุงุชุฌุฉ PTRACE_TRACEME ุ ูุชุจูุนุฉ ุจู (ุนุงุฏุฉู) exec (3).  ูู ูุงุญูุฉ ุฃุฎุฑู ุ ูููู ุฃู ุชุจุฏุฃ ุงูุนูููุฉ ุงูุฃุตู ูู ุชุตุญูุญ ุงูุนูููุฉ ุงูุญุงููุฉ ุจุงุณุชุฎุฏุงู PTRACE_ATTACH. <br><br>  ุนูุฏ ุงูุชุชุจุน ุ ุชุชููู ุงูุนูููุฉ ุงููุฑุนูุฉ ูู ูู ูุฑุฉ ูุชู ูููุง ุชููู ุฅุดุงุฑุฉ ุ ุญุชู ุฅุฐุง ุชู ุชุฌุงูู ูุฐู ุงูุฅุดุงุฑุฉ.  (ุงูุงุณุชุซูุงุก ูู SIGKILL ุ ูุงูุฐู ูุนูู ุจุงูุทุฑููุฉ ุงููุนุชุงุฏุฉ.) ุณูุชู ุฅุฎุทุงุฑ ุงูุนูููุฉ ุงูุฃุตู ุจูุฐุง ุนูุฏ ุงุณุชุฏุนุงุก ุงูุงูุชุธุงุฑ (2) ุ ูุจุนุฏ ุฐูู ููููู ุนุฑุถ ูุชุนุฏูู ูุญุชููุงุช ุงูุนูููุฉ ุงููุฑุนูุฉ ูุจู ุฃู ุชุจุฏุฃ.  ุจุนุฏ ุฐูู ุ ุชุณูุญ ุงูุนูููุฉ ุงูุฑุฆูุณูุฉ ููุทูู ุจููุงุตูุฉ ุงูุนูู ุ ููู ุจุนุถ ุงูุญุงูุงุช ุชุชุฌุงูู ุงูุฅุดุงุฑุฉ ุงููุฑุณูุฉ ุฅููู ุฃู ุชุฑุณู ุฅุดุงุฑุฉ ุฃุฎุฑู ุจุฏูุงู ูู ุฐูู). <br></blockquote><br>  ูุจุงูุชุงูู ุ ูุฅู ุงูุญู ูู ุชุชุจุน ุงูุนูููุฉ ูุฅููุงููุง ูุจู ุงุณุชุฏุนุงุก ูู ูุธุงู ุ ูุฅุฐุง ูุฒู ุงูุฃูุฑ ุ ูู ุจุฅุนุงุฏุฉ ุชูุฌูู ูุคุดุฑ ุงูุชุฑุงุจุท ุฅูู ูุธููุฉ ุงูููุงุกูุฉ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;fcntl.h&gt; #include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;errno.h&gt; #include &lt;limits.h&gt; #include &lt;sys/ptrace.h&gt; #include &lt;sys/wait.h&gt; #include &lt;sys/reg.h&gt; #include &lt;sys/user.h&gt; #include &lt;asm/unistd.h&gt; #if defined(__x86_64__) #define REG_SYSCALL ORIG_RAX #define REG_SP rsp #define REG_IP rip #endif long NOHOOK = 0; long evil_open(const char *path, long oflag, long cflag) { char real_path[PATH_MAX], maps_path[PATH_MAX]; long ret; pid_t pid; pid = getpid(); realpath(path, real_path); if(strcmp(real_path, "/etc/ld.so.preload") == 0) { errno = ENOENT; ret = -1; } else { NOHOOK = 1; // Entering NOHOOK section ret = open(path, oflag, cflag); } // Exiting NOHOOK section NOHOOK = 0; return ret; } void init() { pid_t program; //    program = fork(); if(program != 0) { int status; long syscall_nr; struct user_regs_struct regs; //     if(ptrace(PTRACE_ATTACH, program) != 0) { printf("Failed to attach to the program.\n"); exit(1); } waitpid(program, &amp;status, 0); //   SYSCALLs ptrace(PTRACE_SETOPTIONS, program, 0, PTRACE_O_TRACESYSGOOD); while(1) { ptrace(PTRACE_SYSCALL, program, 0, 0); waitpid(program, &amp;status, 0); if(WIFEXITED(status) || WIFSIGNALED(status)) break; else if(WIFSTOPPED(status) &amp;&amp; WSTOPSIG(status) == SIGTRAP|0x80) { //     syscall_nr = ptrace(PTRACE_PEEKUSER, program, sizeof(long)*REG_SYSCALL); if(syscall_nr == __NR_open) { //       NOHOOK = ptrace(PTRACE_PEEKDATA, program, (void*)&amp;NOHOOK); //   if(!NOHOOK) { //     //   regs  ptrace(PTRACE_GETREGS, program, 0, &amp;regs); // Push return address on the stack regs.REG_SP -= sizeof(long); //       ptrace(PTRACE_POKEDATA, program, (void*)regs.REG_SP, regs.REG_IP); //  RIP   evil_open regs.REG_IP = (unsigned long) evil_open; //     ptrace(PTRACE_SETREGS, program, 0, &amp;regs); } } ptrace(PTRACE_SYSCALL, program, 0, 0); waitpid(program, &amp;status, 0); } } exit(0); } else { sleep(0); } }</span></span></span></span></code> </pre><br>  ูุชุญูู ูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ ./detect_syscall LD_PRELOAD (open syscall) [+] $ LD_PRELOAD=./ld_undetect_syscall.so ./detect_syscall LD_PRELOAD (open syscall) [-]</code> </pre><br>  <b>+ 0-0 = 5</b> <br><br>  ุดูุฑุง ุฌุฒููุง <br><br>  <a href="https://github.com/haxelion" rel="nofollow">ุชุดุงุฑูุฒ ููุจูู</a> <br>  <a href="https://github.com/chokepoint" rel="nofollow">ููุฑุง</a> <br>  <a href="https://habr.com/ru/users/valdikss/">ValdikSS</a> <br>  <a href="https://github.com/doegox" rel="nofollow">ููููุจ ุชูููู</a> <br>  <a href="https://stackoverflow.com/users/2327517/derhass" rel="nofollow">derhass</a> <br><br>  ุงูุฐูู ููุงูุงุชูู ุ ุฃููุงุฏ ุงููุตุฏุฑ ูุงูุชุนูููุงุช ูุนูุช ุฃูุซุฑ ููู ุจูุซูุฑ ูุฌุนู ูุฐู ุงููุงุฏุฉ ุชุธูุฑ ููุง. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar479858/">https://habr.com/ru/post/ar479858/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar479844/index.html">ุฌูุน ูุฑูู ูู ูุตููู UX ูุฎุณุฑ 7 ููุงููู ุจุณุจุจ ุฃุฎุทุงุก ุงูุชูุธูู</a></li>
<li><a href="../ar479848/index.html">ููุง ูู ุงูุฑุจุน 2019! ููู ุชุบูุฑ ุชูุฑูุฑ Gartner Meeting Solutions ุงูุชุญูููู ููุคุชูุฑุงุช ุงูููุฏูู ุนูู ูุฏู ุฎูุณ ุณููุงุช</a></li>
<li><a href="../ar479850/index.html">ูู ุจุชุซุจูุช Exchange 2019 ุนูู Windows Server Core 2019</a></li>
<li><a href="../ar479852/index.html">ููุงููุงุช ุงูููุฏูู ุชุญุช ุงูุบุทุงุก: ูู ุงูููุงููู ูููููุง ุฅูู 100 ูุดุงุฑู ูู ูุคุชูุฑ ูุงุญุฏ</a></li>
<li><a href="../ar479854/index.html">12 ุฏูุณูุจุฑ ุตุจุงุญ ูุถู ุฌุงูุง</a></li>
<li><a href="../ar479860/index.html">ุชุจุงูู ุญูู ููุถูุน ููุฐุฌุฉ ุงูุญูุงุฉ. ุงูุฌุฒุก 2</a></li>
<li><a href="../ar479862/index.html">ููููุฉ ุญูุธ 15 000 ุฑูุจู ุนูุฏ ุชุณุฌูู ุงูุจุฑูุงูุฌ</a></li>
<li><a href="../ar479864/index.html">ุงููุนุจุฉ ุนูู WinForms + C # ูู 16 ุนุงููุง (ุฌุฒุกุงู)</a></li>
<li><a href="../ar479870/index.html">ูููู ุจุชุบููุฑ ุงูุฅุทุงุฑ ูููู ุชุนุฑูู ุงูุนูู ุฃุซูุงุก ุงูุชููู - ูููุณ ููุท. ูุงุฐุง ุณูุญุฏุซ ูู mitap ุงูุซุงูู ูู PHP NN</a></li>
<li><a href="../ar479874/index.html">ููู ูุตูุช ุฅูู ThoughtWorks ุฃู ููุงุจูุฉ ูุซุงููุฉ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>