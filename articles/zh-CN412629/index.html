<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥅 👨🏻‍🌾 🧗🏻 音频服务的自适应波形 🤪 👧🏻 💾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="当需要为单个广播站点设置音频档案时，除了管理面板外，我还需要音频播放器。 广播持续了40分钟，外加两次音乐暂停。 以如此长的格式使用Waveform特别方便，因此，与许多音乐服务一样，我决定在播放器的设计中使用此解决方案。 

 随着计划中站点的未来重新设计以及可能的未来移动应用的重新设计，此处的光...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>音频服务的自适应波形</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412629/"><img src="https://habrastorage.org/webt/nw/k4/n3/nwk4n3zrjoklldqz2vfmpq25nzs.gif"><br><br> 当需要为单个广播站点设置音频档案时，除了管理面板外，我还需要音频播放器。 广播持续了40分钟，外加两次音乐暂停。 以如此长的格式使用Waveform特别方便，因此，与许多音乐服务一样，我决定在播放器的设计中使用此解决方案。 <br><br> 随着计划中站点的未来重新设计以及可能的未来移动应用的重新设计，此处的光栅波形仅靠在楔形上。 它不是自适应的，如果在栅格中，则重新设计非常耗费资源。 <br><a name="habracut"></a><br> 众所周知的SOUNDCLOUD通过在整个屏幕上相对于静态中心移动整个波形来解决此问题。 但是我不要 <br><br> 广播是通过管理面板完成的，我立即通过ffmpeg制作了音频文件的更多压缩副本。 放弃其功能并生成波形是愚蠢的。 <br><br><h4> 动作算法： </h4><br>  1.以最小尺寸生成波形以进行存储 <br>  2.转换为向量（JSON） <br>  3.为此数组绘制一个播放器 <br>  4.实施适应性：统一减少阵列并返回步骤3 <br><br><h3> 波形产生 </h3><br><br> 据我所知，在实施这种方法时，BBC同志尚未在其实<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">用程序中</a>以JSON发布输出。 目前，我建议您重建它们的实用程序，以删除无用的负数和多余的输出。 关于咬人和其他胡说八道的陈词滥调。 <br> 同时，继续： <br><br> 如果我们采用播放器的设计（此处宽度减小），我们将看到每个条带有2个像素（加上1个像素分隔符）。 这意味着600px将为我们提供1200px的宽度。 <br><br><img src="https://habrastorage.org/webt/p9/dk/wf/p9dkwfisywv4-irpqxeyteuqpvw.jpeg"><br><br> 我认为，将来极不可能需要较大的音频文件表示形式。 好吧，如果您不将设计拉到4K显示器的整个宽度上，则应该考虑一下，但我会停在600x60px。 <br><br> 现在更接近代码： <br><br><pre><code class="php hljs">shell_exec(<span class="hljs-string"><span class="hljs-string">"ffmpeg -y -i '$name.mp3' -filter_complex 'aformat=channel_layouts=mono,compand,showwavespic=s=600x120,crop=in_w:in_h/2:0:0' -c:v png -pix_fmt monob -frames:v 1 '$png_path.png' &gt; /dev/null 2&gt;/dev/null &amp;"</span></span>);</code> </pre> <br>  <i>-filter_complex-</i>连接过滤器 <br><br>  <i>格式</i> -处理声音 <br><br>  <i>channel_layouts</i> <br><br>  <i>-mono-</i>单声道模式 <br><br>  <i>-compand</i>是压缩程序和扩展程序。 在此模式下，安静声音和响亮声音的音量均等，这使您可以在安静和响亮的录音中获得没有峰值和过载的波形。 实际上，波形总是一直延伸到最大。 <br><br>  <i>-showwavespic = s = 600x120</i> -s占用图像的大小。 <br><br>  <i>-crop = in_w：in_h / 2：0：0-</i>裁剪接收到的图像。 通常，输出频率响应围绕x轴镜像。 因此，我们洒了，只剩下冰山一角。 <br><br>  <i>-c：v png -pix_fmt monob -frames：v 1-</i>输出图像格式，bw调色板和仅第一帧（我们不需要动画）。  png8非常适合质量（在我们的情况下无损）/位置。 <br><br>  <i>&gt; / dev / null 2&gt; / dev / null</i>并将输出和工作数据发送到深渊。 并且“＆”允许php不等待控制台完成工作，而是继续进行操作。 <br><br> 在输出中，我们得到以下图像： <br><br><img src="https://habrastorage.org/webt/4f/ee/s6/4fees6nkctphgo1oaxk6j9es7s0.png"><br> 最终文件的大小2.4kb <br><br>  <i>有趣的是，几年前不是白色，而是红色。</i>  <i>开发人员显然更改了默认值。</i> <br><br><h3> 将波形转换为矢量 </h3><br> 生成的图像是以Y为单位的振幅，以X为单位的时间。将其转换为一维JSON数组是基本的。 这些值将用作振幅值，而时间只是其序号。 <br><br> 我决定即时进行翻译，而无需缓存结果，因此很快就可以完成。 <br> 我们从上到下测量沿Y的像素数，然后沿X移至下一个像素。 <br><br><pre> <code class="php hljs">$a = imagecreatefrompng(<span class="hljs-string"><span class="hljs-string">"test.png"</span></span>); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $h = <span class="hljs-string"><span class="hljs-string">'60'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// horizontal movener while ( $i &lt; 600 ) { // vertical movener $y = $h-1; $c = 0; while ( $c &lt; $h ) { //echo imagecolorat($aa, $i, $c ); // test color if(imagecolorat($a, $i, $c ) == "255") { $arr[$i] = $c; break; } else { $arr[$i] = $y; } $c++; } $i++; }; echo json_encode($arr);</span></span></code> </pre><br> 结果数组由600个值组成。 <br><br> <code>[46,28,34,35,34,35,26,33,39,29,29,30,30,30,33,33,28...]</code> <br> <br><h3> 播放器通过JSON渲染 </h3><br> 为了方便工作进度栏，我从Elliot Bentley获得了progressor.js。 他将其用于音频转录服务。 <br><br>  <a href="">github.com/ejb/progressor.js</a> 2.76 KB <br><br> 让我们再次看看我们的播放器。 <br><br><img src="https://habrastorage.org/webt/p9/dk/wf/p9dkwfisywv4-irpqxeyteuqpvw.jpeg"><br><br> 进度栏由两层组成：具有灰色栏和绿色的背景。 <br><br> 在图像下方使用getGraph函数绘制。 <br><br> 其含义是使用列分隔符绘制所需厚度和颜色的列。 <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"canvas"</span></span>); c.width = width; c.height = height; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctx = c.getContext(<span class="hljs-string"><span class="hljs-string">"2d"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getGraph</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fillStyle1,fillStyle2,fillStyle3</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fillStyle3) { <span class="hljs-comment"><span class="hljs-comment">//console.log(fillStyle1); var grd = ctx.createLinearGradient(0,120,0,0); grd.addColorStop(0.5,fillStyle1); grd.addColorStop(1,fillStyle2); fillStyle1 = grd; fillStyle2 = fillStyle3; } json.forEach(function(item, i, arr) { ctx.fillStyle = fillStyle1; ctx.fillRect(i * 3, height, 2, item - height); ctx.fillStyle = fillStyle2; var next = json[i + 1]; if( item &lt;= next ) { h2 = next; } else { h2 = item; } ctx.fillRect(i * 3 + 2, height, 1, h2 - height); }); return c.toDataURL(); }</span></span></code> </pre><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这是一个没有适应性的工作示例</a> <br><br><h3>  4.实施适应性 </h3><br> 现在，我们需要将客户端上的JSON数组减小到所需的大小，并且这里具有适应性。 <br><br><h3> 计划一个 </h3><br> 我想到的第一种方法是每一个周期删除第二，第三，第四...，因此您不能将阵列缩小不到一半，并且此处无法达到像素精度。 <br><br> 通过删除数组值来修改波形是死路一条。 当您执行此操作时，您会看到波形被非人为地撕裂了多少，这是因为您抛出了极端，并且没有求平均邻居的身高。 <br><br> 我们需要重采样算法。 在js上有算法的实现： <br><br>  <a href=""><b>最大三角三斗</b></a> <br><br> 它工作得很好，只要求输入这样的数组，在索引处它会接收XY坐标，我们有一个一维数组，所以我不得不增加一些乐趣并重做该函数。 这个东西是这样的： <br><br><img src="https://habrastorage.org/webt/mf/xx/wt/mfxxwtrk4jf5nddwlkqpmzu3__e.gif"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在这里，</a>您可以使用自适应作为KDPV。 <br><br> 设置html框架在右侧的查看模式。 然后，您可以更改此窗口的宽度。 <br><br><h3> 计划B-吹 </h3><br> 但是，我仍然不想加载客户端。 例如，我要1000点-5000，但要整个屏幕宽度。 如果我有更多分数，那么这东西在手机上的表现如何？ 一方面，这绝对没有问题，看上去也不是那么昂贵，根据算法的演示来看，它很容易获得5000分。 但是，另一方面，一个人应该给予尽可能多的要求。 设计问题。 <br><br> 初级，如果您有Node.Js，则可以将此代码传输到服务器。 而且，如果您有php，则可以在php中找到该算法的实现，但是...我想。 <br><br> 重采样算法在哪里？ 在用于生成JSON的同一本机库GD中。 我们只需从客户端以所需宽度的像素为单位传递参数，然后在转换为JSON之前调整波形大小。 <br><br> 因此，我将扩展开始时编写的代码。 <br><br><pre> <code class="php hljs">$h = <span class="hljs-number"><span class="hljs-number">60</span></span>; $width_new = <span class="hljs-number"><span class="hljs-number">600</span></span>; $a = imagecreatefrompng(<span class="hljs-string"><span class="hljs-string">"$id.png"</span></span>); $width_old = imagesx($a); $aa = imagecreatetruecolor($width_new, $h); imagecopyresized($aa, $a, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, $width_new, $h, $width_old, $h); imagetruecolortopalette($aa, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// horizontal movener while ( $i &lt; $width_new ) { // vertical movener $y = $h-1; $c = 0; while ( $c &lt; $h ){ //echo imagecolorat($aa, $i, $c ); // search what color is needed if(imagecolorat($aa, $i, $c ) == "1"){ $arr[$i] = $c; break; } else { $arr[$i] = $y; } $c++; } $i++; }; echo json_encode($arr);</span></span></code> </pre><br> 之后，您不必担心是否需要更改设计，播放器的宽度，扩展到移动应用程序中。 一切看起来都很灵活而且非常聪明。 <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">代码在这里</a> <br><br><div class="spoiler">  <b class="spoiler_title">。</b> <div class="spoiler_text"> 复活节彩蛋。 <br><br> 可能是晴天。 我们房间的窗户俯瞰着两层9层的旧砖地板，我记得我还是十几岁的时候，我知道一个电车环在它们后面开了，再往前走-老医院，它就在学校后面，以及我试图挖掘的办公室所在的当前建筑物在他的回忆录中，这是一家前未完工的医院，现在是一座纯办公楼。 我记得在我童年时在这里训练过的特种部队是如何在电视上放映的，他们猛烈地冲向一个混凝土结构，周围的一切都长满了。 现在，事实证明，我正在大力震撼闪亮的栏杆，走下楼梯，并欣赏最近的住宅区所反射出的那栋建筑物的变形形式。  （在附近，沿着电车路线，那座古老的大公墓的墙壁打开了。上面刻着绿色的铭文：“鲍里斯当政”和“劳动俄罗斯”。上帝知道他们是谁，何时制造的，但几十年后，他们仍然阅读但仍然完全看不见。从90年代的遗产中，我再也看不到这座城市中更古老的纪念碑了。） <br><br> 在我们的顶层是空的，因为刚开始装在一个装有荞麦的包装中是空的：下面有很多东西而且很紧：特殊的地理智能，2gis办公室，常规的seoshniki造成了一些骗局，而上面的几乎没有谷物。 您是否认为应该从这里的地板上生长出某种东西，但是在过去的5年中，只有洗窗器从先验者和无知的会计师那里疯狂地注视着，他们敲开地板上的所有门来寻找某人，他将解释由于另一个浏览器更新，如何通过疯狂的Internet银行插件来签署付款。 <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN412629/">https://habr.com/ru/post/zh-CN412629/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN412619/index.html">莫斯科的myDribbble聚会2017</a></li>
<li><a href="../zh-CN412621/index.html">如何成为魔术师（第3部分）。 霍格沃茨信</a></li>
<li><a href="../zh-CN412623/index.html">星际公民的新装备将花费27,000美元。</a></li>
<li><a href="../zh-CN412625/index.html">如何快速找到并不会失去AI和数据科学专家</a></li>
<li><a href="../zh-CN412627/index.html">CMEF＆ICMD国际展览会2018年春季在上海（第二部分）</a></li>
<li><a href="../zh-CN412633/index.html">体验配置和使用WSL（Windows 10中的Linux子系统）</a></li>
<li><a href="../zh-CN412637/index.html">是否要重新设计徽标？ 那是问题</a></li>
<li><a href="../zh-CN412639/index.html">创建交易所交易策略需要等待什么：机器学习的效率如何</a></li>
<li><a href="../zh-CN412641/index.html">采矿，格鲁吉亚和伊尔库茨克有什么共同点？</a></li>
<li><a href="../zh-CN412643/index.html">我们如何将支付系统集成到俄罗斯项目中</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>