<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍⚕️ 🤹🏻 🤞 Niveaux d'isolement transactionnel pour les plus petits 👫 🛅 🏙️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aujourd'hui, je voudrais apporter une section extrêmement intéressante, mais souvent couverte de secrets pour les programmeurs mortels ordinaires de l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Niveaux d'isolement transactionnel pour les plus petits</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469415/"><img src="https://habrastorage.org/webt/v3/-j/65/v3-j65ut9hywvpnw1wmt5q6c2sg.jpeg"><br><br>  Aujourd'hui, je voudrais apporter une section extrêmement intéressante, mais souvent couverte de secrets pour les programmeurs mortels ordinaires de la base de données (DB) - les niveaux d'isolement des transactions.  Comme le montre la pratique, de nombreuses personnes associées à l'informatique, en particulier au travail avec des bases de données, ne savent pas très bien pourquoi ces niveaux sont nécessaires et comment ils peuvent être utilisés à leur propre avantage. <br><br><h3>  Un peu de théorie </h3><br>  Les transactions elles-mêmes ne nécessitent pas d'explications particulières; une transaction est N (N≥1) requêtes vers la base de données qui seront exécutées avec succès ensemble ou pas du tout.  L'isolement des transactions montre combien de transactions parallèles s'influencent mutuellement. <br>  En choisissant un niveau de transaction, nous essayons de parvenir à un consensus dans le choix entre une grande cohérence des données entre les transactions et la vitesse de ces mêmes transactions. <br>  Il convient de noter que la vitesse d'exécution la plus élevée et la cohérence la plus faible sont <b>lues sans engagement</b> .  La vitesse d'exécution la plus faible et la cohérence la plus élevée sont <b>sérialisables</b> . <br><a name="habracut"></a><br><h3>  Préparation de l'environnement </h3><br>  Par exemple, le SGBD MySQL a été sélectionné.  PostgreSQL pourrait également être utilisé, mais il ne prend pas en charge le niveau d'isolement <b>non validé en lecture</b> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utilise</a> le niveau <b>validé en</b> <b>lecture à la</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">place</a> .  Et il s'est avéré que différents SGBD perçoivent les niveaux d'isolement différemment.  Ils peuvent avoir diverses nuances pour assurer l'isolement, avoir des niveaux supplémentaires ou ne pas être bien connus. <br><br>  Créez un environnement en utilisant l'image MySQL terminée avec le Docker Hub.  Et remplissez la base de données. <br><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yaml</b> <div class="spoiler_text"><pre><code class="xml hljs">version: '3.4' services: db: image: mysql:8 environment: - MYSQL_ROOT_PASSWORD=12345 command: --init-file /init.sql volumes: - data:/var/lib/mysql - ./init.sql:/init.sql expose: - "3306" ports: - "3309:3306" volumes: data:</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Remplir la base de données</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> bank; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> bank; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> accounts ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> auto_increment primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, login <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, balance <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, created_at <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() ) <span class="hljs-keyword"><span class="hljs-keyword">collate</span></span>=utf8mb4_unicode_ci; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> accounts (login, balance) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'petya'</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> accounts (login, balance) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'vasya'</span></span>, <span class="hljs-number"><span class="hljs-number">2000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> accounts (login, balance) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'mark'</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>);</code> </pre><br></div></div><br>  Voyons comment fonctionnent les niveaux et leurs fonctionnalités. <br>  Nous allons exécuter des exemples sur 2 transactions exécutées simultanément.  Conditionnellement, une transaction dans la fenêtre de gauche sera appelée <i>transaction 1</i> (T1), dans la fenêtre de droite - <i>transaction 2</i> (T2). <br><br><h3>  Lire sans engagement </h3><br>  Le niveau avec la pire cohérence des données, mais la vitesse de transaction la plus élevée.  Le nom du niveau parle de lui-même - chaque transaction voit des changements non validés dans une autre transaction (le phénomène de la <b>lecture sale</b> ).  Voyons comment ces transactions s’affectent mutuellement. <br><br>  <b>Étape 1.</b> Nous commençons 2 transactions parallèles. <br><br><img src="https://habrastorage.org/webt/df/8n/xl/df8nxlfhhcshcjodtparllhouba.png"><br><br>  <b>Étape 2.</b> Nous examinons les informations dont nous disposons au début. <br><br><img src="https://habrastorage.org/webt/hd/38/qz/hd38qzflrzu-nnx7hs91yx7zyhm.png"><br><br>  <b>Étape 3.</b> Maintenant, nous effectuons les opérations INSERT, DELETE, UPDATE dans T1 et voyons ce qu'une autre transaction voit maintenant. <br><br><img src="https://habrastorage.org/webt/ey/k2/sd/eyk2sdewgeir6kmpjchumikl8t4.png"><br><br>  T2 voit les données d'une autre transaction qui n'a pas encore été validée. <br><br>  <b>Étape 4.</b> Et T2 peut obtenir des données. <br><br><img src="https://habrastorage.org/webt/7v/oq/tr/7voqtrzl7ihmkswvkx0tsxao7n8.png"><br><br>  <b>Étape 5.</b> Lorsque vous annulez les modifications sur T1, les données reçues par T2 seront erronées. <br><br><img src="https://habrastorage.org/webt/zp/4r/ja/zp4rjad7h4w67oozlqjhyo7fp1u.png"><br><br>  À ce niveau, il est impossible d'utiliser des données sur la base desquelles des conclusions et des décisions critiques importantes pour l'application sont prises car ces conclusions peuvent être loin de la réalité. <br>  Ce niveau peut être utilisé, par exemple, pour des calculs approximatifs de quelque chose.  Le résultat <i>COUNT (*)</i> ou <i>MAX (*)</i> peut être utilisé dans certains rapports non stricts. <br>  Un autre exemple est le mode débogage.  Lors d'une transaction, vous souhaitez voir ce qui arrive à la base de données. <br><br><h3>  Lire engagé </h3><br>  Pour ce niveau, les transactions exécutées simultanément ne voient que les modifications validées des autres transactions.  Ainsi, ce niveau offre une protection contre <b>les lectures sales</b> . <br><br>  Les étapes 1 et 2 sont similaires à l'exemple précédent. <br><br>  Étape 3. Nous effectuons également 3 opérations simples avec la table des comptes (T1) et faisons une sélection complète de ces tables dans les deux transactions. <br><br><img src="https://habrastorage.org/webt/5q/v6/oe/5qv6oevjrhcoe2ubmwxvmu5wapy.png"><br><br>  Et nous verrons que le phénomène de <b>lecture sale</b> est absent en T2. <br><br>  Étape 4. Nous corrigeons les changements dans T1 et vérifions ce que T2 voit maintenant. <br><br><img src="https://habrastorage.org/webt/mx/8f/i0/mx8fi0low9lqjenhnl2gx0sg6aq.png"><br><br>  Maintenant, T2 voit tout ce que T1 a fait.  Il s'agit du phénomène dit de <b>lecture non répétitive</b> lorsque nous voyons des lignes mises à jour et supprimées (UPDATE, DELETE) et du phénomène de <b>lecture de fantômes</b> lorsque nous voyons des enregistrements ajoutés (INSERT). <br><br><h3>  Lecture répétable </h3><br>  Un niveau pour éviter le phénomène de <b>lecture non répétitive</b> .  C'est-à-dire  nous ne voyons pas les enregistrements modifiés et supprimés dans une autre transaction avec une autre transaction.  Mais nous voyons toujours les enregistrements insérés d'une autre transaction.  <b>La lecture des fantômes</b> ne va nulle part. <br><br>  Répétez à nouveau les étapes 1 et 2. <br><br>  Étape 3. Dans T1, nous exécutons les requêtes INSERT, UPDATE et DELETE.  Après, dans T2, nous essayons de mettre à jour la même ligne que celle mise à jour dans T1. <br><br><img src="https://habrastorage.org/webt/ja/w5/oj/jaw5ojjrb1m7bi-9lhbifndcvye.png"><br><br>  Et nous obtenons le verrouillage: T2 attendra jusqu'à ce que T1 valide les modifications ou annule. <br><br>  Étape 4. Corrigez les modifications apportées par T1.  Et relisez les données du tableau des comptes en T2. <br><br><img src="https://habrastorage.org/webt/75/xu/jj/75xujjftplz_b3r8mhjsqcla7zc.png"><br><br>  Comme vous pouvez le constater, les phénomènes de <b>lecture non répétitive</b> et de <b>lecture de fantômes</b> ne <b>sont</b> pas observés.  Comment se fait-il que, par défaut, la <b>lecture répétable</b> nous permette de ne prévenir que le phénomène de <b>lecture non répétitive</b> ? <br><br>  En fait, MySQL n'a pas l'effet de <b>lire des fantômes</b> pour le niveau de <b>lecture répétable</b> .  Et dans PostgreSQL, ils s'en sont également débarrassés pour ce niveau.  Bien que dans la représentation classique de ce niveau, nous devons observer cet effet. <br><br>  Un petit exemple abstrait est le service de génération de chèques-cadeaux (codes) et leur utilisation.  Par exemple, un attaquant a généré un code de certificat pour lui-même et essaie de l'activer, essayant d'envoyer plusieurs demandes de suite pour activer un coupon.  Dans ce cas, nous commencerons plusieurs transactions exécutées simultanément en travaillant avec le même coupon.  Et dans certaines situations, une double ou même triple activation du coupon peut se produire (l'utilisateur recevra des bonus 2x / 3x).  Avec une <b>lecture répétable,</b> dans ce cas, un verrouillage se produira et l'activation aura lieu une fois, et dans les 2 niveaux précédents, une activation multiple est possible.  Un problème similaire peut également être résolu en utilisant la requête <i>SELECT FOR UPDATE</i> , qui bloquera également l'enregistrement mis à jour (coupon). <br><br><h3>  Sérialisable </h3><br>  Le niveau auquel les transactions se comportent comme si rien d'autre n'existe, il n'y a aucune influence les unes sur les autres.  Dans la représentation classique, ce niveau élimine l'effet de la <b>lecture des fantômes</b> . <br><br>  <b>Étape 1.</b> Démarrez la transaction. <br><br>  <b>Étape 2.</b> T2 nous lisons le tableau des comptes, puis T1 nous essayons de mettre à jour les données lues par T2. <br><br><img src="https://habrastorage.org/webt/ll/kv/yw/llkvywaijh7l7uyfsnqwy1a6ivm.png"><br><br>  Nous obtenons un verrou: nous ne pouvons pas modifier les données d'une transaction lues dans une autre. <br><br>  <b>Étape 3.</b> INSERT et DELETE nous conduisent tous les deux au verrou en T1. <br><br><img src="https://habrastorage.org/webt/ia/kh/lj/iakhljpnwnxyame2qgxmqrhcyyu.png"><br><br>  Tant que T2 n'aura pas terminé ses travaux, nous ne pourrons pas travailler avec les données qu'il a lues.  Nous obtenons une cohérence maximale des données, aucune donnée supplémentaire ne sera enregistrée.  Le prix à payer est une vitesse de transaction lente en raison de verrous fréquents, donc avec une architecture d'application médiocre, cela peut vous jouer un tour. <br><br><h3>  Conclusions </h3><br>  Dans la plupart des applications, le niveau d'isolement change rarement et la valeur par défaut est utilisée (par exemple, dans MySQL, il est <b>reproductible en lecture</b> , dans PostgreSQL, il est <b>lu en lecture</b> ). <br><br>  Mais périodiquement, il est difficile de trouver un meilleur équilibre entre la cohérence élevée des données ou la vitesse de transaction pour résoudre certains problèmes d'application. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr469415/">https://habr.com/ru/post/fr469415/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr469405/index.html">Le Deep Learning est désormais en Java</a></li>
<li><a href="../fr469407/index.html">ARIES PLC110 [M02] -MS4, HMI, OPC et SCADA, ou combien une personne a besoin de thé à la camomille. Partie 1</a></li>
<li><a href="../fr469409/index.html">Profilage Linux avec Analyseur de performances</a></li>
<li><a href="../fr469411/index.html">RE: Douleur et larmes dans Svelte 3</a></li>
<li><a href="../fr469413/index.html">Le condensé de matières fraîches du monde du front-end de la dernière semaine n ° 382 (22-29 septembre 2019)</a></li>
<li><a href="../fr469417/index.html">OUI distribué ou NON distribué? Interview pour ceux qui depuis six mois ne trouvent pas de développeur</a></li>
<li><a href="../fr469421/index.html">Bonjour les personnes handicapées autistes</a></li>
<li><a href="../fr469423/index.html">Holivar. Histoire de Runet. Partie 2. Contre-culture: pAdonki, la marijuana et le Kremlin</a></li>
<li><a href="../fr469425/index.html">Dmitry Matskevich, Dbrain (partie 2): sur la neurobiologie, la liberté interne, la «dopamine bon marché» et l'intuition</a></li>
<li><a href="../fr469427/index.html">Jouets en bois, quatrième partie - 1990</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>