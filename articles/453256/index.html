<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äç‚ù§Ô∏è‚Äçüë® üßíüèΩ üõÄüèΩ SObjectizer-5.6.0: corte en vivo para crecer m√°s üßïüèø üññüèª üíà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Al tercer d√≠a, una nueva versi√≥n de SObjectizer estuvo disponible : 5.6.0 . Su caracter√≠stica principal es el rechazo de la compatibilidad con la rama...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SObjectizer-5.6.0: corte en vivo para crecer m√°s</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453256/"><p><img src="https://habrastorage.org/webt/vp/ah/jx/vpahjx-dkpsauwtfzyeiktnsfp4.jpeg"></p><br><p>  Al tercer d√≠a, una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">nueva versi√≥n de SObjectizer</a> estuvo disponible <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">: 5.6.0</a> .  Su caracter√≠stica principal es el rechazo de la compatibilidad con la rama estable anterior 5.5, que se ha desarrollado constantemente en el transcurso de cuatro a√±os y medio. </p><br><p>  Los principios b√°sicos de funcionamiento de SObjectizer-5 segu√≠an siendo los mismos.  Comunicaciones, agentes, cooperaciones y despachadores todav√≠a est√°n con nosotros.  Pero algo cambi√≥ seriamente, algo generalmente fue desechado.  Por lo tanto, simplemente tomar SO-5.6.0 y volver a compilar su c√≥digo fallar√°.  Algo necesita ser reescrito.  Es posible que haya que redise√±ar algo. </p><br><p>  ¬øPor qu√© nos ocupamos de la compatibilidad durante varios a√±os y luego decidimos tomar y romper todo?  ¬øY qu√© se rompi√≥ m√°s a fondo? </p><br><p>  Tratar√© de hablar sobre esto en este art√≠culo. </p><br><h1 id="zachem-voobsche-potrebovalos-chto-to-lomat">  ¬øPor qu√© necesitabas romper algo? </h1><br><p>  Es as√≠ de simple. </p><a name="habracut"></a><br><p>  SObjectizer-5.5 durante su desarrollo ha absorbido tantas cosas diferentes y diversas que no fueron planificadas originalmente, que como resultado, ha formado demasiadas muletas y accesorios dentro.  Con cada nueva versi√≥n, agregar algo nuevo a SO-5.5 se hizo cada vez m√°s dif√≠cil.  Y finalmente, a la pregunta "¬øPor qu√© necesitamos todo esto?"  No se encontr√≥ una respuesta adecuada. </p><br><p>  Entonces, la primera raz√≥n es la nueva complicaci√≥n de los menudillos de SObjectizer. </p><br><p>  La segunda raz√≥n es que estamos est√∫pidamente cansados ‚Äã‚Äãde centrarnos en los viejos compiladores de C ++.  La rama 5.5 comenz√≥ en 2014, cuando tuvimos, si no me equivoco, gcc-4.8 y MSVS2013.  Y a este nivel, seguimos manteniendo la barra de requisitos para el nivel de soporte para el est√°ndar C ++. </p><br><p>  Inicialmente, ten√≠amos "inter√©s ego√≠sta" en esto.  Adem√°s, durante alg√∫n tiempo consideramos los bajos requisitos de calidad de soporte para el est√°ndar C ++ como nuestra "ventaja competitiva". </p><br><p>  Pero el tiempo contin√∫a, el "inter√©s ego√≠sta" ha terminado.  Algunos beneficios de tal "ventaja competitiva" no son visibles.  Tal vez lo ser√≠an, si trabaj√°ramos con C ++ 98, entonces estar√≠amos interesados ‚Äã‚Äãen la empresa sangrienta.  Pero la empresa sangrienta en aquellos como nosotros, en principio, no est√° interesada.  Por lo tanto, se decidi√≥ dejar de limitarnos y tomar algo m√°s fresco.  As√≠ que tomamos lo m√°s fresco del establo en este momento: C ++ 17. </p><br><p>  Obviamente, no a todos les gustar√° esta soluci√≥n, despu√©s de todo, para muchos C ++ 17, esta es ahora una vanguardia inalcanzable, que todav√≠a est√° muy, muy lejos. </p><br><p>  Sin embargo, nos decidimos por tal riesgo.  De todos modos, el proceso de popularizaci√≥n de SObjectizer no va r√°pido, por lo que cuando SObjectizer tenga una demanda m√°s o menos amplia, C ++ 17 ya no ser√° una "ventaja".  Por el contrario, se tratar√° de la misma manera que ahora en C ++ 11. </p><br><p>  En general, en lugar de continuar construyendo muletas usando un subconjunto de C ++ 11, decidimos rehacer seriamente las partes internas de SObjectizer usando C ++ 17.  Para construir una base sobre la cual SObjectizer puede desarrollarse progresivamente durante los pr√≥ximos cuatro o cinco a√±os. </p><br><h1 id="chto-serezno-pomenyalos-v-sobjectizer-56">  ¬øQu√© ha cambiado seriamente en SObjectizer-5.6? </h1><br><p>  Ahora, repasemos brevemente algunos de los cambios m√°s sorprendentes. </p><br><h2 id="u-kooperaciy-agentov-bolshe-net-strokovyh-imen">  Las cooperaciones de agentes ya no tienen nombres de cadena </h2><br><h3 id="problema">  El problema </h3><br><p>  Desde el principio, SObjectizer-5 exigi√≥ que cada cooperaci√≥n tenga su propio nombre de cadena √∫nico.  Esta caracter√≠stica fue heredada por el quinto SObjectizer del cuarto SObjectizer anterior. </p><br><p>  En consecuencia, SObjectizer necesitaba almacenar los nombres de las cooperaciones registradas.  Verifique su singularidad en el registro.  Busque cooperaci√≥n por nombre durante la baja del registro, etc., etc. </p><br><p>  Desde las primeras versiones, se ha utilizado un esquema simple en SObjectzer-5: un √∫nico diccionario de cooperaciones registradas protegidas por mutex.  Al registrar una cooperaci√≥n, se captura mutex, se verifica la unicidad del nombre de la cooperaci√≥n, la presencia de un padre, etc.  Despu√©s de verificar, el diccionario se modifica, despu√©s de lo cual se libera mutex.  Esto significa que si al mismo tiempo comienza el registro / desregistro de varias cooperaciones a la vez, en algunos puntos se detendr√°n y esperar√°n hasta que una de las operaciones complete el trabajo con el diccionario cooperativo.  Debido a esto, las operaciones cooperativas no escalaron bien. </p><br><p>  De eso quer√≠a deshacerme para mejorar la situaci√≥n con la velocidad de registro de las cooperaciones. </p><br><h3 id="reshenie">  Soluci√≥n </h3><br><p>  Se consideraron dos formas principales de resolver este problema. </p><br><p>  En primer lugar, almacenar nombres de cadenas, pero cambiar la forma en que se almacena el diccionario para que la operaci√≥n de registro de cooperaci√≥n pueda escalar.  Por ejemplo, el fragmento de diccionario, es decir  rompi√©ndolo en varias piezas, cada una de las cuales estar√≠a protegida por su mutex. </p><br><p>  En segundo lugar, un rechazo completo de los nombres de cadena y el uso de algunos identificadores asignados por SObjectizer. </p><br><p> Como resultado, elegimos el segundo m√©todo y abandonamos por completo el nombramiento de las cooperativas.  Ahora en SObjectizer hay algo como <code>coop_handle</code> , es decir  un identificador cuyo contenido est√° oculto para el usuario, pero que se puede comparar con <code>std::weak_ptr</code> . </p><br><p>  SObjectizer devuelve <code>coop_handle</code> al registrar una colaboraci√≥n: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> coop = env.make_coop(); ... <span class="hljs-comment"><span class="hljs-comment">//    . auto coop_id = env.register_coop(std::move(coop)); // . //   coop_id    .</span></span></code> </pre> <br><p>  Este identificador debe usarse para cancelar el registro de la cooperaci√≥n: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> coop = env.make_coop(); ... <span class="hljs-comment"><span class="hljs-comment">//    . auto coop_id = env.register_coop(std::move(coop)); // . //   coop_id    . ... // - . // ,     . //       . env.deregister_coop(coop_id, ...);</span></span></code> </pre> <br><p>  Adem√°s, este identificador debe usarse al establecer una relaci√≥n padre-hijo: </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   . auto parent = env.make_coop(); ... //  parent . auto parent_id = env.register_coop(std::move(parent)); //  . ... //      ,    . auto child = env.make_coop(parent_id); ...</span></span></code> </pre> <br><p>  La estructura del repositorio para la cooperaci√≥n dentro del entorno SObjectizer tambi√©n ha cambiado dr√°sticamente.  Si antes de la versi√≥n 5.5 inclusive era un diccionario com√∫n, ahora cada cooperaci√≥n es un dep√≥sito de enlaces a cooperaciones infantiles.  Es decir  Las cooperativas forman un √°rbol con una ra√≠z en una cooperativa ra√≠z especial oculta al usuario. </p><br><p>  Dicha estructura permite escalar <code>register_coop</code> <code>deregister_coop</code> <code>register_coop</code> y <code>deregister_coop</code> mucho mejor: el bloqueo mutuo de operaciones paralelas se produce solo si ambas pertenecen a la misma cooperaci√≥n principal.  Para mayor claridad, aqu√≠ est√° el resultado del lanzamiento de un <a href="" rel="nofollow">punto de referencia especial</a> que mide el rendimiento de las operaciones con cooperaciones en mi computadora port√°til anterior con Ubuntu 16.04 y GCC-7.3: </p><br><pre> <code class="plaintext hljs">_test.bench.so_5.parallel_parent_child -r 4 -l 7 -s 5 Configuration: roots: 4, levels: 7, level-size: 5 parallel_parent_child: 15.69s 488280 488280 488280 488280 Total: 1953120</code> </pre> <br><p>  Es decir  La versi√≥n 5.6.0 hizo frente a casi 2 millones de cooperaciones en ~ 15.5 segundos. </p><br><p>  Y aqu√≠ est√° la versi√≥n 5.5.24.4, la √∫ltima de la rama 5.5 en este momento: </p><br><pre> <code class="plaintext hljs">_test.bench.so_5.parallel_parent_child -r 4 -l 7 -s 5 Configuration: roots: 4, levels: 7, level-size: 5 parallel_parent_child: 46.856s 488280 488280 488280 488280 Total: 1953120</code> </pre> <br><p>  El mismo escenario, pero el resultado es tres veces peor. </p><br><h2 id="ostalsya-vsego-odin-vid-dispetcherov">  Solo queda un tipo de despachadores </h2><br><p>  Los despachadores son uno de los pilares de SObjectizer.  Son los despachadores quienes determinan d√≥nde y c√≥mo los agentes procesar√°n sus mensajes.  Entonces, sin la idea de despachadores, probablemente no habr√≠a habido un SObjectizer. </p><br><p>  Sin embargo, los propios despachadores evolucionaron, evolucionaron y evolucionaron hasta el punto en que ni siquiera fue dif√≠cil para nosotros crear un nuevo despachador para SObjectizer-5.5.  Pero muy problem√°tico.  Sin embargo, tom√©moslo en orden. </p><br><p>  Inicialmente, todos los despachadores que la aplicaci√≥n necesitaba solo pod√≠an crearse al inicio del SObjectizer: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { <span class="hljs-comment"><span class="hljs-comment">/* -   */</span></span> }, <span class="hljs-comment"><span class="hljs-comment">//    SObjectizer-. []( so_5::environment_params_t &amp; params ) { p.add_named_dispatcher("active_obj", so_5::disp::active_obj::create_disp()); p.add_named_dispatcher("shutdowner", so_5::disp::active_obj::create_disp()); p.add_named_dispatcher("groups", so_5::disp::active_group::create_disp()); ... } );</span></span></code> </pre> <br><p>  No cre√© el despachador necesario antes del inicio: todo, es mi culpa, no puedes cambiar nada. </p><br><p>  Est√° claro que esto es inconveniente y, a medida que se ampliaron los escenarios de uso de SObjectizer, fue necesario resolver este problema.  Por lo tanto, <code>add_dispatcher_if_not_exists</code> m√©todo <code>add_dispatcher_if_not_exists</code> , que verific√≥ la presencia de un despachador y, si no hab√≠a ninguno, permiti√≥ crear una nueva instancia: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { ... <span class="hljs-comment"><span class="hljs-comment">// - . //     . env.add_dispatcher_if_not_exists( "extra_dispatcher", []{ return so_5::disp::active_obj::create_disp(); } ); }, //    SObjectizer-. []( so_5::environment_params_t &amp; params ) {...} );</span></span></code> </pre> <br><p>  Dichos despachadores fueron llamados p√∫blicos.  Los despachadores p√∫blicos ten√≠an nombres √∫nicos.  Y usando estos nombres, los agentes estaban obligados a los despachadores: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { ... <span class="hljs-comment"><span class="hljs-comment">// - . //     . env.add_dispatcher_if_not_exists( "extra_dispatcher", []{ return so_5::disp::active_obj::create_disp(); } ); //         //    . auto coop = env.create_coop( "ping_pong", //     extra_dispatcher. so_5::disp::active_obj::create_disp_binder( "extra_dispatcher" ) ); coop-&gt;make_agent&lt; a_pinger_t &gt;(...); coop-&gt;make_agent&lt; a_ponger_t &gt;(...); ... }, //    SObjectizer-. []( so_5::environment_params_t &amp; params ) {...} );</span></span></code> </pre> <br><p>  Pero los despachadores p√∫blicos ten√≠an una caracter√≠stica desagradable.  Comenzaron a trabajar inmediatamente despu√©s de agregarlos al entorno SObjectizer y continuaron trabajando hasta que el entorno SObjectizer complet√≥ su trabajo. </p><br><p>  De nuevo, con el tiempo, comenz√≥ a interferir.  Era necesario asegurarse de que los despachadores pudieran agregarse seg√∫n fuera necesario y que los despachadores que se volvieran innecesarios se eliminaran autom√°ticamente. </p><br><p>  As√≠ que hab√≠a despachadores "privados".  Estos despachadores no ten√≠an nombres y viv√≠an mientras hubiera referencias a ellos.  Se pod√≠an crear despachadores privados en cualquier momento despu√©s de iniciar el entorno SObjectizer, se destru√≠an autom√°ticamente. </p><br><p>  En general, los despachadores privados resultaron ser un enlace muy exitoso en la evoluci√≥n de los despachadores, pero trabajar con ellos fue muy diferente de trabajar con despachadores p√∫blicos: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { ... <span class="hljs-comment"><span class="hljs-comment">// - . //     . auto disp = so_5::disp::active_obj::create_private_disp(env); //         //    . auto coop = env.create_coop( "ping_pong", //      . disp-&gt;binder() ); coop-&gt;make_agent&lt; a_pinger_t &gt;(...); coop-&gt;make_agent&lt; a_ponger_t &gt;(...); ... }, //    SObjectizer-. []( so_5::environment_params_t &amp; params ) {...} );</span></span></code> </pre> <br><p>  Incluso m√°s despachadores privados y p√∫blicos difer√≠an en la implementaci√≥n.  Por lo tanto, para no duplicar el c√≥digo y escribir por separado el despachador p√∫blico y privado del mismo tipo, tuve que usar construcciones bastante complejas con plantillas y herencia. </p><br><p>  Como resultado, toda esta variedad estaba cansada de acompa√±ar, y en SObjectizer-5.6 solo quedaba un tipo de despachadores.  De hecho, este es un an√°logo de despachadores privados.  Pero solo sin una menci√≥n expl√≠cita de la palabra "privado".  Entonces, el fragmento que se muestra arriba se escribir√° como: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { ... <span class="hljs-comment"><span class="hljs-comment">// - . //     . auto disp = so_5::disp::active_obj::make_dispatcher(env); //         //    . auto coop = env.create_coop( "ping_pong", //      . disp.binder() ); coop-&gt;make_agent&lt; a_pinger_t &gt;(...); coop-&gt;make_agent&lt; a_ponger_t &gt;(...); ... }, //    SObjectizer-. []( so_5::environment_params_t &amp; params ) {...} );</span></span></code> </pre> <br><h2 id="ostalis-tolko-svobodnye-funkcii-send-send_delayed-i-send_periodic">  Solo quedan funciones gratuitas send, send_delayed y send_periodic left </h2><br><p>  El desarrollo de la API para enviar mensajes a SObjectizer es probablemente el ejemplo m√°s sorprendente de c√≥mo SObjectizer ha cambiado a medida que el soporte para C ++ 11 ha mejorado en los compiladores disponibles para nosotros. </p><br><p>  Primero, los mensajes se enviaron as√≠: </p><br><pre> <code class="cpp hljs">mbox-&gt;deliver_message(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> my_message(...));</code> </pre> <br><p>  O, si sigue las "recomendaciones de los mejores criadores de perros" (c): </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;my_message&gt; msg(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> my_message(...)); mbox-&gt;deliver_message(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(msg));</code> </pre> <br><p>  Sin embargo, luego tuvimos a nuestra disposici√≥n compiladores con soporte para plantillas variadas y aparecieron funciones de env√≠o.  Se hizo posible escribir as√≠: </p><br><pre> <code class="cpp hljs">send&lt;my_message&gt;(target, ...);</code> </pre> <br><p>  Es cierto que a toda una familia le tom√≥ m√°s tiempo <code>send_to_agent</code> partir de simples <code>send</code> , incluidos <code>send_to_agent</code> , <code>send_delayed_to_agent</code> , etc.  Y luego, para hacer que esta familia se reduzca al conjunto familiar de <code>send</code> , <code>send_delayed</code> y <code>send_periodic</code> . </p><br><p>  Pero, a pesar del hecho de que la familia de funciones de env√≠o se form√≥ hace bastante tiempo y ha sido la forma recomendada de enviar mensajes durante varios a√±os, los m√©todos antiguos como <code>deliver_message</code> , <code>schedule_timer</code> y <code>single_timer</code> todav√≠a estaban disponibles para el usuario. </p><br><p>  Pero en la versi√≥n 5.6.0, solo las funciones gratuitas <code>send</code> , <code>send_delayed</code> y <code>send_periodic</code> se guardaron en la API p√∫blica de SObjectizer.  Todo lo dem√°s se elimin√≥ por completo o se transfiri√≥ a espacios de nombres internos de SObjectizer. </p><br><p>  Entonces, en SObjectizer-5.6, la interfaz para enviar mensajes finalmente se ha convertido en lo que hubiera sido si hubi√©ramos tenido compiladores con soporte C ++ 11 normal desde el principio.  Bueno, adem√°s de eso, si tuvi√©ramos experiencia usando este C ++ 11 muy normal. </p><br><h2 id="edinyy-format-send_delayed-i-send_periodic">  Formato √∫nico send_delayed y send_periodic </h2><br><p>  Con las <code>send_periodic</code> <code>send_delayed</code> y <code>send_periodic</code> en versiones anteriores de SObjectizer, hubo otro incidente. </p><br><p>  Para usar el temporizador, debe tener acceso al entorno SObjectizer.  Dentro del agente hay un enlace al entorno SObjectizer.  Y dentro de mchain hay tal enlace.  Pero dentro del mbox no estaba all√≠.  Por lo tanto, si se envi√≥ un mensaje pendiente a un agente o a mchain, la llamada <code>send_delayed</code> as√≠: </p><br><pre> <code class="cpp hljs">send_delayed&lt;my_message&gt;(target_agent, pause, ...); send_delayed&lt;my_message&gt;(target_mchain, pause, ...);</code> </pre> <br><p>  Para el caso de mbox, tuvimos que tomar un enlace al SObjectizer Environment desde otro lugar: </p><br><pre> <code class="cpp hljs">send_delayed&lt;my_message&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;so_environment(), target_mbox, pause, ...);</code> </pre> <br><p>  Esta caracter√≠stica de <code>send_delayed</code> y <code>send_periodic</code> fue una peque√±a astilla.  Lo cual no interfiere mucho, pero es bastante molesto.  Y todo porque inicialmente no comenzamos a almacenar el enlace a SObjectizer Environment en mbox-ahs. </p><br><p>  La violaci√≥n de la compatibilidad con versiones anteriores fue una buena raz√≥n para deshacerse de esta astilla. </p><br><p>  Ahora puede averiguar desde mbox para qu√© SObjectizer Environment fue creado.  Y esto hizo posible utilizar los <code>send_delayed</code> √∫nicos <code>send_delayed</code> y <code>send_periodic</code> para cualquier tipo de destinatario de mensaje de temporizador: </p><br><pre> <code class="cpp hljs">send_delayed&lt;my_message&gt;(target_agent, pause, ...); send_delayed&lt;my_message&gt;(target_mchain, pause, ...); send_delayed&lt;my_message&gt;(target_mbox, pause, ...);</code> </pre> <br><p>  En el sentido literal, "un poco, pero agradable". </p><br><h2 id="net-bolshe-ad-hoc-agentov">  No m√°s agentes ad-hoc. </h2><br><p>  Como dice el refr√°n, "Cada accidente tiene un nombre, segundo nombre y apellido".  En el caso de agentes ad-hoc, este es mi primer nombre, segundo nombre y apellido :( </p><br><p>  El punto es este.  Cuando comenzamos a hablar sobre SObjectizer-5 en p√∫blico, escuchamos muchos reproches por la verbosidad del c√≥digo de los ejemplos de SObjectizer.  Y personalmente, esta verbosidad me pareci√≥ un problema grave con el que tengo que tratar seriamente. </p><br><p>  Una fuente de verbosidad es la necesidad de que los agentes hereden del tipo base especial <code>agent_t</code> .  Y de esto, parecer√≠a, no hay escapatoria.  O no? </p><br><p>  Entonces hab√≠a agentes ad-hoc, es decir  agentes, para la determinaci√≥n de que no era necesario escribir una clase separada, solo fue suficiente para establecer la reacci√≥n a los mensajes en forma de funciones lambda.  Por ejemplo, el ejemplo cl√°sico de ping-pong en agentes ad-hoc podr√≠a escribirse as√≠: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pinger = coop-&gt;define_agent(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> ponger = coop-&gt;define_agent(); pinger .on_start( [ponger]{ so_5::send&lt; msg_ping &gt;( ponger ); } ) .event&lt; msg_pong &gt;( pinger, [ponger]{ so_5::send&lt; msg_ping &gt;( ponger ); } ); ponger .event&lt; msg_ping &gt;( ponger, [pinger]{ so_5::send&lt; msg_pong &gt;( pinger ); } );</code> </pre> <br><p>  Es decir  No hay clases propias.  Solo llamamos a <code>define_agent()</code> en la cooperaci√≥n y obtenemos alg√∫n tipo de objeto de agente, que puede suscribirse a los mensajes entrantes. </p><br><p>  Entonces, en SObjectizer-5 hubo una separaci√≥n en agentes regulares y ad-hoc. </p><br><p>  Lo que no trajo ninguna bonificaci√≥n visible, solo los costos laborales adicionales para acompa√±ar tal separaci√≥n.  Y con el tiempo, se hizo evidente que los agentes ad-hoc son como una maleta sin asa: es dif√≠cil de transportar y es una pena irse.  Pero mientras trabajaba en SObjectizer-5.6, se decidi√≥ abandonar. </p><br><p>  Al mismo tiempo, tambi√©n se aprendi√≥ otra lecci√≥n, quiz√°s a√∫n m√°s importante: en cualquier discusi√≥n p√∫blica de la herramienta en Internet, participar√° una gran cantidad de personas que son indiferentes a lo que es la herramienta, por qu√© se necesita, por qu√© se supone que se debe usar, etc.  Es simplemente importante para ellos expresar su fuerte opini√≥n.  En el segmento de Internet en ruso, adem√°s de esto, sigue siendo muy importante transmitir a los desarrolladores de la herramienta cu√°n locos y sin educaci√≥n son y cu√°nto no se necesita el resultado de su trabajo. </p><br><p>  Por lo tanto, debe tener mucho cuidado con lo que le dicen.  Y puede escuchar (y luego con cuidado) solo lo que se dice aqu√≠ en este sentido: "Trat√© de hacer esto en su instrumento y no me gusta la cantidad de c√≥digo que tiene aqu√≠".  Incluso tales deseos deben tratarse con mucho cuidado: "Tomar√≠a tu desarrollo si fuera m√°s f√°cil aqu√≠ y aqu√≠". </p><br><p>  Desafortunadamente, la habilidad de "filtrar" que dijeron los "simpatizantes" en Internet hace unos cinco a√±os era mucho menor que ahora.  Por lo tanto, un experimento tan espec√≠fico como agentes ad-hoc en SObjectizer. </p><br><h2 id="sobjectizer-56-bolshe-ne-podderzhivaet-sinhronnogo-vzaimodeystviya-agentov">  SObjectizer-5.6 ya no admite la interacci√≥n de agente sincronizada </h2><br><p>  El tema de la interacci√≥n sincronizada entre agentes es muy antiguo y doloroso. </p><br><p>  Comenz√≥ en los d√≠as de SObjectizer-4.  Y en SObjectizer-5 continu√≥.  Hasta ahora, finalmente, el llamado  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">solicitudes de servicio</a>  Lo que inicialmente, sin duda, daba miedo como la muerte.  Pero luego logr√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">darles un aspecto m√°s o menos decente</a> . </p><br><p>  Pero este result√≥ ser el caso cuando el primer panqueque sali√≥ grumoso :( </p><br><p>  Dentro de SObjectizer, tuve que implementar la entrega y el procesamiento de mensajes regulares de una manera, y la entrega y el procesamiento de solicitudes sincr√≥nicas en otra.  Es especialmente triste que estas caracter√≠sticas tuvieran que tenerse en cuenta, incluso al implementar sus propios mbox-s. </p><br><p>  Y despu√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">de que</a> se agreg√≥ la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">funcionalidad de los mensajes de sobre</a> a SObjectizer, se hizo necesario observar a√∫n m√°s a menudo y m√°s a fondo las diferencias entre los mensajes regulares y las solicitudes sincr√≥nicas. </p><br><p>  En general, con solicitudes s√≠ncronas durante el mantenimiento / desarrollo de SObjectizer, hubo demasiado dolor de cabeza.  Tanto es as√≠ que al principio hubo un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">deseo concreto de deshacerse de estas solicitudes muy sincronizadas</a> .  Y entonces este deseo se hizo realidad. </p><br><p>  Y as√≠, en SObjectizer-5.6, los agentes pueden interactuar nuevamente solo a trav√©s de mensajes asincr√≥nicos. </p><br><p>  Y dado que a veces todav√≠a se necesita algo como la interacci√≥n sincr√≥nica, se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">ha enviado</a> soporte para este tipo de interacci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">al proyecto so5extra que lo acompa√±a</a> : </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    "-". using my_request_reply = so_5::extra::sync::request_reply_t&lt;my_request, my_reply&gt;; ... //  ,    . class request_handler final : public so_5::agent_t { ... //  .      . void on_request(typename my_request_reply::request_mhood_t cmd) { ... //  . //      cmd-&gt;request(). //   . cmd-&gt;make_reply(...); //      my_reply. } ... void so_define_agent() override { //       . so_subscribe_self().event(&amp;request_handler::on_request); } }; ... //     . so_5::mbox_t handler_mbox = ...; //        15s. //    ,    . my_reply reply = my_request_reply::ask_value(handler_mbox, 15s, ...); //       my_request.</span></span></code> </pre> <br><p>  Es decir  Ahora trabajar con solicitudes s√≠ncronas es fundamentalmente diferente en que el controlador de solicitudes no devuelve un valor del m√©todo de controlador, como lo era antes.  En su lugar, se <code>make_reply</code> m√©todo <code>make_reply</code> . </p><br><p>  La nueva implementaci√≥n es buena ya que tanto la solicitud como la respuesta se env√≠an dentro del SObjectizer como mensajes as√≠ncronos regulares.  De hecho, <code>make_reply</code> es una implementaci√≥n un poco m√°s espec√≠fica de <code>send</code> . </p><br><p>  Y, lo que es m√°s importante, la nueva implementaci√≥n nos permiti√≥ obtener una funcionalidad que antes era inalcanzable: </p><br><ul><li>  Las solicitudes s√≠ncronas (es decir, <code>request_reply_t&lt;Request, Reply&gt;</code> objetos) ahora se pueden guardar y / o reenviar a otros controladores.  Lo que hace posible implementar varios esquemas de equilibrio de carga; </li><li>  Puede hacer que la respuesta a la solicitud venga en un mbox regular del agente que inicia la solicitud.  Y el agente iniciador procesar√° la respuesta de la manera habitual, como cualquier otro mensaje; </li><li>  Puede enviar varias solicitudes a diferentes destinatarios a la vez y luego analizar sus respuestas en el orden en que fueron recibidas: </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> first_dialog = so_5::extra::sync::<span class="hljs-keyword"><span class="hljs-keyword">request_reply_t</span></span>&lt;first_request, first_reply&gt;; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> second_dialog = so_5::extra::sync::<span class="hljs-keyword"><span class="hljs-keyword">request_reply_t</span></span>&lt;second_request, second_reply&gt;; <span class="hljs-comment"><span class="hljs-comment">//         . auto reply_ch = create_mchain(env); //     . first_dialog::initiate_with_custom_reply_to( one_service, reply_ch, so_5::extra::sync::do_not_close_reply_chain, ...); second_dialog::initiate_with_custom_reply_to( another_service, reply_ch, so_5::extra::sync::do_not_close_reply_chain, ...); //    . receive(from(reply_ch).handle_n(2).empty_timeout(15s), [](typename first_dialog::reply_mhood_t cmd) {...}, [](typename second_dialog::reply_mhood_t cmd) {...});</span></span></code> </pre> <br><p>  Entonces, podemos decir que con la interacci√≥n sincr√≥nica en SObjectizer sucedi√≥ lo siguiente: </p><br><ul><li>  durante mucho tiempo se fue por razones ideol√≥gicas; </li><li>  luego se agreg√≥ y result√≥ que a veces esa interacci√≥n es √∫til; </li><li>  pero la experiencia ha demostrado que la primera implementaci√≥n no es muy exitosa; </li><li>  la implementaci√≥n anterior se descart√≥ por completo y, a cambio, se propuso una implementaci√≥n nueva. </li></ul><br><p>  Trabajaron en sus propios errores, en general. </p><br><h1 id="zaklyuchenie">  Conclusi√≥n </h1><br><p>  Este art√≠culo, brevemente, habl√≥ sobre varios cambios en SObjectizer-5.6.0 y las razones detr√°s de estos cambios. </p><br><p>  Puede encontrar una lista m√°s completa de cambios <a href="" rel="nofollow">aqu√≠</a> . </p><br><p>  En conclusi√≥n, me gustar√≠a ofrecer a aquellos que a√∫n no han probado SObjectizer, t√≥melo y pru√©belo.  Y comparte con nosotros tus sentimientos: lo que te gust√≥, lo que no te gust√≥, lo que faltaba. </p><br><p>  Escuchamos atentamente todos los comentarios constructivos / sugerencias.  Adem√°s, en los √∫ltimos a√±os, solo lo que alguien necesita est√° incluido en SObjectizer.  Entonces, si no nos dice qu√© le gustar√≠a tener en SObjectizer, esto no aparecer√°.  Y si me dices, entonces qui√©n sabe ...;) </p><br><p>  El proyecto ahora vive y se desarrolla <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">aqu√≠</a> .  Y para aquellos que est√°n acostumbrados a usar solo GitHub, hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">espejo GitHub</a> .  Este espejo es completamente nuevo, por lo que puede ignorar la falta de estrellas. </p><br><p>  PS.  Puede seguir las noticias relacionadas con SObjectizer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">en este grupo de Google</a> .  All√≠ puede plantear problemas relacionados con SObjectizer. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/453256/">https://habr.com/ru/post/453256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453242/index.html">Zona de juegos para eventos de verano.</a></li>
<li><a href="../453246/index.html">ERP - Sistema de degradaci√≥n continua</a></li>
<li><a href="../453248/index.html">Misi√≥n lunar de Artemis: lanzamiento de la producci√≥n del elemento principal de la estaci√≥n orbital lunar Lunar Gateway</a></li>
<li><a href="../453252/index.html">C√≥mo hicimos el programa del club Sportmaster</a></li>
<li><a href="../453254/index.html">Sobre el c√≥digo de GOST, Grasshopper, su SBox y semillas perdidas</a></li>
<li><a href="../453258/index.html">Hacer un pedal de reverberaci√≥n usando chips PT2399 (Parte 1)</a></li>
<li><a href="../453260/index.html">Caracter√≠sticas de configuraci√≥n de DPI</a></li>
<li><a href="../453262/index.html">¬øD√≥nde se almacenan sus constantes en el microcontrolador CortexM (usando el compilador IAR de C ++ como ejemplo)</a></li>
<li><a href="../453264/index.html">Virtuali-tee: una "camiseta m√©dica" que no cubre pero expone</a></li>
<li><a href="../453272/index.html">Patrocinadores de GitHub: una nueva forma de contribuir al c√≥digo abierto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>