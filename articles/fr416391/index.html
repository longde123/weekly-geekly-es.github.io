<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÜüèº üîΩ üè¥‚Äç‚ò†Ô∏è Optimisation du placement des machines virtuelles sur les serveurs ü§≤üèª üë©üèø‚Äçü§ù‚Äçüë©üèª üë©üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a quelque temps, un de mes coll√®gues a d√©clar√© que la place dans le DC s'√©puisait, qu'il n'y avait nulle part o√π placer le serveur, que la charge...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Optimisation du placement des machines virtuelles sur les serveurs</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416391/">  Il y a quelque temps, un de mes coll√®gues a d√©clar√© que la place dans le DC s'√©puisait, qu'il n'y avait nulle part o√π placer le serveur, que la charge augmentait et que la marche √† suivre n'√©tait pas claire, et vous devrez probablement changer tous les serveurs disponibles en serveurs plus puissants. <br><br>  √Ä cette √©poque, j'√©tais engag√© dans la t√¢che de compiler des plannings optimaux, et je me suis dit - mais que faire si nous appliquons des algorithmes d'optimisation pour augmenter l'utilisation du serveur dans le DC?  De l√† est n√© le projet dont je veux √©crire. <br><br>  Pour les utilisateurs avanc√©s, je dirai tout de suite que dans cet article, nous parlerons de l'emballage de la corbeille, et pour les autres qui veulent apprendre √† √©conomiser jusqu'√† 30% des ressources du serveur √† l'aide de calculs relativement simples, bienvenue √† cat. <br><a name="habracut"></a><br>  Nous avons donc un contr√¥leur de domaine avec environ 100 serveurs, qui h√©bergent environ 7 000 machines virtuelles.  Ce qui est √† l'int√©rieur des machines virtuelles - nous ne savons pas et ne devons pas savoir.  Il est n√©cessaire de placer des machines virtuelles sur des serveurs de mani√®re √† effectuer le SLA et en m√™me temps utiliser le nombre minimum de serveurs. <br><br>  Nous savons: <br><br><ul><li>  liste de serveurs </li><li>  quantit√© de ressources sur chaque serveur (temps CPU, c≈ìurs CPU, RAM, disque, io disque, io r√©seau). </li><li>  liste des machines virtuelles (VM) </li><li>  la quantit√© de ressources consomm√©es par chaque machine virtuelle (temps CPU, c≈ìurs CPU, RAM, disque, io disque, io r√©seau). </li><li>  consommation de ressources par le syst√®me h√¥te sur les serveurs. </li></ul><br>  Nous devons r√©partir les machines virtuelles entre les serveurs afin que pour chacune des ressources sur chaque serveur ne d√©passe pas la quantit√© disponible de la ressource, et en m√™me temps utiliser le nombre minimum de serveurs. <br><br>  Cette t√¢che dans la litt√©rature scientifique est appel√©e probl√®me d'emballage de bacs (comment sera-t-elle en russe?).  En termes simples, il s'agit d'une t√¢che sur la fa√ßon de pousser de petites bo√Ætes de tailles arbitraires dans de grandes bo√Ætes, et en m√™me temps d'utiliser le nombre minimum de grandes bo√Ætes.  Le probl√®me bien connu en math√©matiques, NP-complete, n'est pr√©cis√©ment r√©solu que par une recherche exhaustive, dont le co√ªt cro√Æt de mani√®re combinatoire. <br><br>  L'image ci-dessous illustre l'essence de l'algorithme d'emballage de casier pour le cas unidimensionnel: <br><br><img src="https://habrastorage.org/webt/ft/wo/fx/ftwofxgaz8qtbx56plkh2c1txqi.png"><br>  <i>Fig.</i>  <i>1. Illustration d'un probl√®me d'emballage de bac, placement non optimal</i> <br><br>  Dans la premi√®re figure, les articles sont en quelque sorte r√©partis entre les paniers et 3 paniers sont utilis√©s pour les placer. <br><br><img src="https://habrastorage.org/webt/53/-x/cb/53-xcbdj3zvqgnlx4yov1xybnrw.png"><br>  <i>Fig.</i>  <i>2. Illustration d'un probl√®me d'emballage de bacs, placement optimal</i> <br><br>  La deuxi√®me image montre la distribution optimale, pour laquelle vous n'avez besoin que de 2 paniers. <br><br>  La formulation standard de l'algorithme d'emballage de bacs suppose √©galement que tous les paniers sont identiques.  Nos serveurs ne sont pas les m√™mes, car ils ont √©t√© achet√©s √† des moments diff√©rents et leur configuration est diff√©rente - nombre diff√©rent de c≈ìurs de processeur, m√©moire, disque, puissance de processeur diff√©rente. <br><br>  Une solution sous-optimale peut √™tre obtenue en utilisant l'heuristique, les algorithmes g√©n√©tiques, la recherche d'arbres de monte-carlo et les r√©seaux de neurones profonds.  Nous avons opt√© pour l'algorithme heuristique BestFit, qui converge vers une solution pas plus de 1,7 fois pire que l'optimale, ainsi que sur une certaine variation de l'algorithme g√©n√©tique.  Ci-dessous, je donnerai les r√©sultats de leur application. <br><br>  Mais d'abord, discutons de ce qu'il faut faire avec des mesures variant dans le temps, telles que l'utilisation du processeur, le disque io, le r√©seau io.  Le moyen le plus simple consiste √† remplacer la m√©trique variable par une constante.  Mais comment choisir la valeur de cette constante?  Nous avons pris la valeur maximale de la m√©trique pour une p√©riode caract√©ristique (auparavant le lissage des valeurs aberrantes).  La semaine s'est av√©r√©e √™tre une p√©riode caract√©ristique dans notre cas, car la saisonnalit√© principale de la charge √©tait associ√©e aux jours de travail et aux jours de repos. <br><br>  Dans ce mod√®le, chaque machine virtuelle se voit allouer une bande de ressources de la taille de la valeur de ressource consomm√©e maximale, et chaque machine virtuelle est d√©crite par les constantes utilisation maximale du processeur, RAM, disque, disque max io, r√©seau max io. <br><br>  Ensuite, nous utilisons l'algorithme pour calculer l'emballage optimal et obtenir une carte de l'emplacement de la VM sur les serveurs physiques. <br><br>  La pratique montre que si vous ne laissez pas une certaine marge pour chacune des ressources sur le serveur, alors lorsque la machine virtuelle est allou√©e de mani√®re dense, le serveur devient surcharg√©.  Par cons√©quent, pour l'utilisation du processeur, nous laissons une marge de 30%, pour la RAM 20%, pour le disque io - 20%, pour le r√©seau io - 20%, ces limites sont s√©lectionn√©es empiriquement. <br><br>  Nous avons √©galement plusieurs types de disques (SSD rapides et disques durs bon march√© lents), pour chaque type de disque, nous prenons s√©par√©ment les mesures disque et disque io, de sorte que le mod√®le final devient un peu plus compliqu√© et a plus de dimensions. <br><br>  Le r√©sultat de l'optimisation du placement des machines virtuelles est illustr√© dans le diagramme: <br><br><img src="https://habrastorage.org/webt/-9/vj/wy/-9vjwyj2x4a__iiszz7l9clhopq.png"><br>  <i>Fig.</i>  <i>3. Le r√©sultat de l'optimisation du placement de VM sur les serveurs</i> <br><br>  Horizontal - le nombre de serveurs qui ont √©t√© optimis√©s, vertical - le nombre de serveurs lib√©r√©s pour l'heuristique BestFit et pour l'algorithme g√©n√©tique. <br><br>  Quelles conclusions peut-on tirer du diagramme? <br><br><ol><li>  Pour les t√¢ches en cours, vous pouvez utiliser 20 √† 30% de serveurs en moins. </li><li>  Plus vous optimisez de serveurs √† la fois, plus vous gagnez en%, avec le nombre de serveurs 40 et plus, la saturation se produit. </li><li>  L'algorithme g√©n√©tique est l√©g√®rement sup√©rieur √† l'heuristique BestFit.  Si nous voulons am√©liorer encore nos r√©sultats, nous allons creuser dans cette direction. </li></ol><br>  Quels autres probl√®mes sont apparus dans la pratique? <br><br><ol><li>  Si vous souhaitez secouer une centaine de serveurs avec 7 000 machines virtuelles, le volume des migrations sera tr√®s important, de sorte que l'id√©e ne sera pas r√©alisable.  Mais si vous travaillez avec des groupes de 20 √† 40 serveurs en s√©quence, l'effet que vous obtiendrez sera presque le m√™me, mais le nombre de migrations sera beaucoup moins √©lev√©.  Et vous pouvez optimiser votre DC en plusieurs parties. </li><li>  Si vous devez effectuer des migrations en direct, vous pouvez rencontrer une situation o√π la migration ne peut pas se terminer.  Cela signifie qu'√† l'int√©rieur de la machine virtuelle, il y a une √©criture intensive sur le disque et / ou l'√©tat des changements de m√©moire, et les √©tats de la machine virtuelle entre l'ancienne et la nouvelle r√©plique n'ont pas le temps de se synchroniser jusqu'√† ce que l'√©tat de l'ancienne r√©plique change.  Dans ce cas, vous devez pr√©d√©finir ces machines virtuelles et les marquer comme non mobiles.  √Ä son tour, cela n√©cessite la modification des algorithmes d'optimisation.  Ce qui est agr√©able, c'est que le gain total est pratiquement ind√©pendant du nombre de ces machines, s'il n'y a pas plus de 10 √† 15% du nombre total de VM. </li></ol><br><h2>  Comment la charge du serveur change-t-elle apr√®s l'optimisation du placement des VM? </h2><br>  Ok, nous avons optimis√© le placement des VM.  Peut-√™tre que le nouvel √©tat qui en r√©sulte est tr√®s fragile par rapport √† l'augmentation de charge?  Peut-√™tre que les serveurs fonctionnent √† la limite et toute augmentation de la charge les tuera? <br><br>  Nous avons compar√© l'utilisation des ressources du serveur avant l'optimisation et apr√®s une p√©riode d'une semaine.  Ce qui s'est pass√© est illustr√© √† la figure 2: <br><br><img src="https://habrastorage.org/webt/aj/ab/bw/ajabbwgggnspsugwgwwooscwgta.png"><br>  <i>Fig.</i>  <i>4. Modification de la charge CPU apr√®s optimisation de l'allocation des VM</i> <br><br>  Selon l'utilisation du processeur: l'utilisation moyenne du processeur est pass√©e de 10% √† seulement 18%.  C'est-√†-dire  nous avons une triple marge de performance CPU, tandis que les serveurs resteront dans la zone dite "verte". <br><br><h3>  Comment cela a-t-il √©t√© fait dans le logiciel? </h3><br>  Nous collectons les mesures dont nous avons besoin dans Yandex.ClickHouse (nous avons essay√© InfluxDB, mais sur nos volumes de donn√©es, les requ√™tes avec agr√©gation sont effectu√©es trop lentement) avec une fr√©quence de 30 secondes.  √Ä partir de l√†, la t√¢che de calcul de l'√©tat optimal lit les m√©triques, calcule leur consommation maximale et g√©n√®re une t√¢che de calcul qui est plac√©e dans la file d'attente.  D√®s que la t√¢che de calcul est termin√©e, des tests sont ex√©cut√©s pour v√©rifier que le r√©sultat ne d√©passe pas les limites sp√©cifi√©es. <br><br><h3>  Quelqu'un a-t-il d√©j√† fait cela? </h3><br>  D'apr√®s ce que nous savons, des algorithmes similaires se trouvent dans VMware vSphere et Nutanix et apparaissent dans OpenStack (projet OpenStack Watcher). <br><br><h3>  Est-il possible de faire encore mieux? </h3><br>  Oui tu peux.  Dans le prochain article, je vous dirai comment emballer des machines virtuelles encore plus denses sans violer le SLA, et pourquoi des neurones sont n√©cessaires pour cela. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr416391/">https://habr.com/ru/post/fr416391/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr416377/index.html">Nous devenons des assistants en programmation. Partie 1</a></li>
<li><a href="../fr416379/index.html">Neurobugurt. Comment nous avons appris au r√©seau neuronal √† inventer des m√®mes un an plus t√¥t que Stanford</a></li>
<li><a href="../fr416381/index.html">Rapport du Club de Rome 2018, chapitre 3.13: philanthropie, investissement, crowdsourcing et blockchain</a></li>
<li><a href="../fr416385/index.html">Si la corr√©lation ressort √† 100%, alors quelque part une erreur s'est gliss√©e quelque part: l'exp√©rience de stage chez Rambler Group</a></li>
<li><a href="../fr416387/index.html">Shrimp: redimensionnez et partagez des images HTTP dans C ++ moderne avec ImageMagic ++, SObjectizer et RESTinio</a></li>
<li><a href="../fr416393/index.html">Conf√©rence IIDF: les entreprises ne sont pas contre les startups</a></li>
<li><a href="../fr416397/index.html">Nous automatisons les tests d'interface des applications Android en utilisant le mod√®le d'objet de page</a></li>
<li><a href="../fr416399/index.html">Comment nous avons analys√© les avis sur les applications mobiles √† l'aide de l'apprentissage automatique</a></li>
<li><a href="../fr416401/index.html">Blender: mod√®le 3D d'une puce pour se connecter √† la biblioth√®que KiCad</a></li>
<li><a href="../fr416403/index.html">Recueil Fintech: attaque contre la banque PIR, le Service f√©d√©ral des imp√¥ts et les taxes de transfert de carte √† carte, ainsi que certaines cha√Ænes de blocs et crypto-monnaies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>