<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👎🏿 👌🏼 🥩 Mãos-livres, mas não um telefone. Casa obediente quando não há mãos suficientes 🧛🏽 🧔🏾 👨🏾‍🚀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Olá Comunidade! 

 Eu queria mexer com o microcontrolador novamente e fazer algo útil. O objetivo foi formado quase imediatamente, porque algo me inco...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mãos-livres, mas não um telefone. Casa obediente quando não há mãos suficientes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/408745/">  Olá Comunidade! <br><br>  Eu queria mexer com o microcontrolador novamente e fazer algo útil.  O objetivo foi formado quase imediatamente, porque algo me incomodou no apartamento. <br><br>  Como você sabe, uma mesa de computador é uma mesa de jantar para assistir Drobyshevsky ou ler Giktayms / Green Cat / etc.  ao mesmo tempo que o jantar.  Mas há um problema - eu costumo sair da cozinha com as <b>duas</b> mãos ocupadas e voltar <b>também</b> , <s>porque os copos são empilhados em três pedaços.</s>  Ligue e desligue a luz na cozinha (interruptor triplo - cozinha / banheiro / vaso sanitário) é o ombro, nariz, dedo mindinho.  Ou seja, é inconveniente de qualquer forma, mas é impossível reorganizá-lo.  Havia uma tarefa para gerenciar de alguma maneira remotamente. <br><br>  Todos os sensores de presença e passagem foram imediatamente descartados - não com precisão, não há controle pela vontade do proprietário.  A solução é encontrada no controle de som, voz.  Eu direi imediatamente que não planejei fazer reconhecimento de fala, isso não é necessário aqui.  A luz ligada pelo pop foi descrita na Rádio 80, mas eu não queria fazer isso.  Acabou um tipo de viva-voz quando as mãos estão ocupadas.  Os detalhes estão ativados. <br><a name="habracut"></a><br><h3>  Peça de hardware. </h3><br>  Havia uma placa com Atmega32 com quartzo e periféricos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SEM0007M-32A</a> e uma dispersão de componentes eletrônicos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/65f/1a8/7e9/65f1a87e9d6aad209f747a4419cab7ad.jpg" width="40%" alt="imagem"></div><br>  Havia um microfone e um amplificador operacional.  Para a saída, há um transistor em um pacote sot32 na placa, há também um relé de 7 amp.  Tudo é montado em uma caixa para cartões de visita, o relé é paralelo ao interruptor, o microfone está escondido embaixo da tomada.  O esquema é comum, eu nem o desenhei.  Apenas uma entrada analógica e uma saída MK discreta são usadas.  O SEM é redundante, mas, por enquanto, deixe estar. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/3c0/69f/b83/3c069fb831046a304627595be0730b70.jpg" width="350" alt="imagem"></div>  <i>Placa e fios desmontados.</i>  <i>Então ele refez com mais precisão.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/7ed/8ee/f59/7ed8eef59421665c5cef7009768a8a46.jpg" width="300" alt="imagem"></div>  <i>O interruptor em si, o microfone não é visível sob a tomada desmontada.</i> <br><br><h3>  Procure um algoritmo. </h3><br>  Objetivo: o sensor deve responder a uma palavra, por exemplo, “ <i>luz!</i>  »Com um mínimo de código. <br>  Tarefa: identifique a palavra de comando no contexto de possíveis ruídos, batidas e cliques com a mesma opção.  Ou seja, apenas a análise de amplitude não é adequada e a análise espectral mostrou que há muitos harmônicos na palavra e, é claro, eles mudam.  Portanto, era necessário procurar uma solução simples, mas com imunidade a ruídos aceitável.  Você pode fazer vários filtros de frequência e uma comparação com uma amostra da palavra, mas não precisa lidar com o reconhecimento.  Foi decidido analisar a presença de apenas um som de vogal, por exemplo, o som "E" ou "E". <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/a55/5e2/6cf/a555e26cf616bfab31872bce1794d612.png" alt="imagem"></div>  <i>O som é "E".</i>  <i>Muitos harmônicos são visíveis, por isso a análise é difícil.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/18e/d5c/ab8/18ed5cab8307bf96a2fb8d2ae77e64dd.png" alt="imagem"></div>  <i>O som é "A."</i>  <i>O espectro parece mais limpo, há uma frequência principal.</i> <br><br><h3>  Parte do software </h3><br>  Para conhecer os componentes espectrais do sinal, você pode usar filtros digitais.  Existe um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bom programa na</a> Internet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">para criar filtros FIR e IIR digitais</a> e calcular seus coeficientes - é claro lá e o código C é gerado automaticamente. <br><br><div class="spoiler">  <b class="spoiler_title">Mas eu recusei filtros digitais</b> <div class="spoiler_text">  Para uma filtragem aceitável (4 ou mais pedidos), muitos coeficientes foram obtidos e até um flutuador.  Assim, além de todos os cálculos de filtro no flutuador: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> ACoef[NCoef+<span class="hljs-number"><span class="hljs-number">1</span></span>] = { <span class="hljs-number"><span class="hljs-number">0.00000347268864059354</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.00001389075456237415</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.00002083613184356122</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.00001389075456237415</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000347268864059354</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> BCoef[NCoef+<span class="hljs-number"><span class="hljs-number">1</span></span>] = { <span class="hljs-number"><span class="hljs-number">1.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">-7.09708794063733790000</span></span>, <span class="hljs-number"><span class="hljs-number">22.77454294680684300000</span></span>, <span class="hljs-number"><span class="hljs-number">-43.03321836036351300000</span></span>, <span class="hljs-number"><span class="hljs-number">52.29813665034108500000</span></span>, <span class="hljs-number"><span class="hljs-number">-41.84199842886619100000</span></span>, <span class="hljs-number"><span class="hljs-number">21.53121088556695300000</span></span>, <span class="hljs-number"><span class="hljs-number">-6.52398963450972500000</span></span>, <span class="hljs-number"><span class="hljs-number">0.89383378261285684000</span></span> };</code> </pre> <br>  O microcontrolador pode ter lidado com isso, mas haveria problemas com a depuração - não é fácil ultrapassar os limites do filtro - esses são novos coeficientes a serem calculados. </div></div><br>  Após algumas pesquisas, decidi on-line a transformada de Fourier de frequência única.  Ou seja, a clássica transformada de Fourier discreta, realizada na chegada de cada amostra do sinal com uma frequência de amostragem (1600 Hz), não há passagem pelas frequências, existe apenas uma frequência, por isso é fácil configurá-lo via RS-232 durante o comissionamento.  Como resultado, a análise foi realizada para uma frequência de 128 Hz. <br><br>  Devido a amostras curtas (blocos) e uma janela retangular, a resolução de frequência é baixa, o que fornece sensibilidade seletiva na faixa de 114 ... 140 Hz, <u>e esse é o filtro P que eu queria obter.</u> <br><br>  Primeiro você precisa entender onde o sinal de comando de voz começa a <s>gritar</s> .  Para isso, primeiro é calculado um nível de sinal zero, através da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">suavização exponencial</a> com uma constante de suavização 1/64.  O código está abaixo. <br><br><div class="spoiler">  <b class="spoiler_title">Parte do código do temporizador para processamento de sinal.</b>  <b class="spoiler_title">Frequência do temporizador 1600 Hz</b> <div class="spoiler_text">  O sinal normaliza para a média.  Para determinar o nível de intensidade do som, os valores absolutos do sinal também são calculados com uma constante de 1/16, para a filtragem passa-alta de meias ondas de sinal individuais (este é um análogo do RMS, mas mais fácil de calcular).  Exceder esse nível acima do limite é o início de um comando de voz e é iniciada uma análise sequencial de 5 blocos de 135 amostras (84,3 ms). <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Timer 0 output compare interrupt service routine interrupt [TIM0_COMP] void timer0_comp_isr(void) { a = adc_data[0] &lt;&lt; 2 ; //       4   . a0 = (a0*63 + a+ 63) &gt;&gt; 6; // .   "0".   10%  150  ae = (int)(a - a0); // a = ae; //      . ae = abs(ae); if (ae &lt; 32) { //      ae = 0; }; d = (int)((15 * (long int) d + ae + 15) &gt;&gt; 4); //  .  //   10%  35  if (d &gt; 100) { //    if (snd == 0) { Yz=0; snd++; } //    PORTB.1 = 1; //      }; .....</span></span></code> </pre></div></div><br>  A figura abaixo mostra o sinal, nível do sinal, limite e 5 blocos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/bc9/b82/572/bc9b82572bd90ddb993e5933489e5f5b.png" alt="imagem"></div><br><h3>  Proteção contra interferência </h3><br>  O sinal é dividido em blocos para proteger contra um impulso - um clique ou uma batida.  O pulso, como você sabe, tem uma resposta de frequência uniforme, ou seja, em qualquer banda de frequência, haverá um resultado diferente de zero e provavelmente acima do limite.  Mas o <s>cabelo é longo, mas o</s> impulso <s>da mente</s> é curto.  Ou seja, não haverá mais pulso no próximo bloco, o que significa que o nível na banda de frequência estará abaixo do limite.  Simultaneamente com essa vantagem, os blocos curtos fornecem uma <u>baixa resolução</u> em frequência.  Portanto, algumas diferenças de frequência no sinal ainda caem na linha de frequência selecionada. <br><br><h3>  Conversão de frequência </h3><br>  Em cada bloco, uma transformada de Fourier de frequência única é realizada para uma frequência f. <br><br>  Tradicionalmente, para acelerar os cálculos, as funções sin e cos são tabuladas e redimensionadas para -127 .. + 127. <br>  O índice <code>si(ps)</code> matriz <code>si(ps)</code> é calculado a partir do argumento sin (2 * π * f * t / T), é claro, com um loopback dentro do mesmo período.  O índice de <code>pc</code> para cos (2 * π * f * t / T) é simplesmente empurrado 12 posições para a frente na mesma matriz <code>si</code> . <br><br>  Resultado <b>Y</b> - o nível da linha espectral é obtido como a soma dos valores absolutos das partes reais e imaginárias durante um bloco. <div class="spoiler">  <b class="spoiler_title">Então</b> <div class="spoiler_text">  da maneira certa, você precisa fazer a soma dos quadrados e da raiz, mas isso é terrível para um MK de 8 bits. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">No mesmo timer:</b> <div class="spoiler_text"><pre> <code class="cs hljs"> a_si = (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (a * si[ps]) &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-comment"><span class="hljs-comment">// a*sin a_co = (long int) (a * si[pc]) &gt;&gt; 4; // a*cos Ysi = Ysi + a_si ; // Yco = Yco + a_co; Y = (labs(Ysi) + labs(Yco)) &gt;&gt; 7; //   128    int    rs-232.</span></span></code> </pre></div></div><br>  No final de cada bloco, <b>Y é</b> comparado com um limite, é calculado o número de blocos que excede os blocos acionados pelo limite.  Após os experimentos, verificou-se que o número mínimo de blocos acionados é 3 em 5. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/499/6b1/cbe/4996b1cbe7750d3b010e9b430f391e67.png" alt="imagem"></div>  <i>Um exemplo de intensidade espectral em blocos com um comando de voz.</i>  <i>A equipe já passou.</i> <br><br>  Três ou mais blocos acionados são interpretados como um comando recebido corretamente.  O sinal na saída discreta do MK é invertido, acendendo ou apagando a luz.  Como toda a análise ocorre dentro dos blocos, não há atraso na operação após o último bloco. <br><br>  O tempo de computação é de aproximadamente 1600 ciclos, o temporizador é chamado a cada 9000 ciclos, portanto a carga do MK é baixa - há espaço para novas experiências com reconhecimento.  Ou você pode fazer uma solução completa de tamanhos menores e em um MK fraco. <br><br>  A correção dos algoritmos foi controlada através da troca de variáveis ​​necessárias (log) via RS-232 com o programa VBasic.  A frequência f e os limites são armazenados no eeprom. <br><br>  Como resultado: o sensor mostrou-se muito conveniente, responde às palavras de " <i>A</i> ", por exemplo, <b>" <i>Waaau</i> ", " <i>Taaam</i> ", " <i>Laite</i> ", " <i>Miaaa</i> ", " <i>Yao-Yao</i> "</b> .  O volume é comum para conversas humanas.  A palavra " <i>Lit</i> " teimosamente se recusa a ouvir.  Cliques, batendo nas portas, degraus, derramando água ignora.  Agora você pode andar com as mãos cheias de copos e pratos)). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt408745/">https://habr.com/ru/post/pt408745/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt408735/index.html">O robô humanóide de US $ 800 não era do tamanho de um ser humano. Desculpe ...</a></li>
<li><a href="../pt408737/index.html">Balanças inteligentes QardioBase 2: cada vez melhores</a></li>
<li><a href="../pt408739/index.html">Fotossíntese supercondutora ou como montar um cavalo de vácuo esférico</a></li>
<li><a href="../pt408741/index.html">Pioneira no processador Qualcomm Centriq 2400. Assassino Intel?</a></li>
<li><a href="../pt408743/index.html">O menor laptop para jogos GPD WIN - Do que ele é capaz e quem precisa?</a></li>
<li><a href="../pt408747/index.html">O aparecimento do novo veículo espacial, o primeiro voo do Falcon Heavy, duvida da confiabilidade do Dragon e do Starliner</a></li>
<li><a href="../pt408749/index.html">Feliz aniversário, mouse de computador</a></li>
<li><a href="../pt408751/index.html">Amazon apresenta plataforma de desenvolvimento 3D, VR e AR</a></li>
<li><a href="../pt408753/index.html">Mensagem para Inteligência Artificial Não Amigável</a></li>
<li><a href="../pt408755/index.html">Como planejar o dia de trabalho perfeito, dependendo de como você dorme</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>