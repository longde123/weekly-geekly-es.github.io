<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçë ü¶É üèáüèº Valida√ß√£o em aplicativos Java üöÅ üë®üèø üôÜüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este texto √© dedicado a v√°rias abordagens √† valida√ß√£o de dados: quais as armadilhas que um projeto pode trope√ßar e quais m√©todos e tecnologias devem s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Valida√ß√£o em aplicativos Java</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/haulmont/blog/427543/"><p>  <em>Este texto √© dedicado a v√°rias abordagens √† valida√ß√£o de dados: quais as armadilhas que um projeto pode trope√ßar e quais m√©todos e tecnologias devem ser seguidos ao validar dados em aplicativos Java.</em> </p><br><p><img src="https://habrastorage.org/webt/cj/yc/yj/cjycyj3zf_l1ai9ch_vsgzisstk.png" alt="Valida√ß√£o"></p><br><p>  Muitas vezes vi projetos cujos criadores n√£o se preocuparam em escolher uma abordagem para valida√ß√£o de dados.  As equipes trabalharam no projeto sob uma press√£o incr√≠vel na forma de prazos e requisitos vagos e, como resultado, eles simplesmente n√£o tiveram tempo para uma valida√ß√£o precisa e consistente.  Portanto, seu c√≥digo de valida√ß√£o est√° espalhado por todo o lado: em trechos de Javascript, controladores de tela, em beans de l√≥gica de neg√≥cios, entidades de dom√≠nio, gatilhos e restri√ß√µes de banco de dados.  Esse c√≥digo estava cheio de instru√ß√µes if-else, lan√ßou v√°rias exce√ß√µes e tentou descobrir onde esse dado espec√≠fico √© validado l√° ... Como resultado, √† medida que o projeto se desenvolve, torna-se dif√≠cil e caro cumprir os requisitos (geralmente bastante confusos) e uniformidade de abordagens para valida√ß√£o de dados. </p><br><p>  Existe alguma maneira simples e elegante de validar dados?  Existe uma maneira de nos proteger do pecado da ilegibilidade, uma maneira de reunir toda a l√≥gica da valida√ß√£o e que j√° foi criada para n√≥s pelos desenvolvedores de estruturas Java populares? </p><br><p>  Sim, existe esse caminho. </p><a name="habracut"></a><br><p>  Para n√≥s, desenvolvedores da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plataforma CUBA</a> , √© muito importante que voc√™ possa usar as melhores pr√°ticas.  Acreditamos que o c√≥digo de valida√ß√£o deve: </p><br><ol><li>  Seja reutiliz√°vel e siga o princ√≠pio DRY; </li><li>  Seja natural e compreens√≠vel; </li><li>  Colocado onde o desenvolvedor espera v√™-lo; </li><li>  Poder verificar dados de diferentes fontes: interface do usu√°rio, chamadas SOAP, REST, etc. </li><li>  Trabalhe em um ambiente multithread sem problemas; </li><li>  Chamado dentro do aplicativo automaticamente, sem a necessidade de executar verifica√ß√µes manualmente; </li><li>  Para fornecer ao usu√°rio mensagens claras e localizadas em caixas de di√°logo concisas; </li><li>  Siga os padr√µes. </li></ol><br><p>  Vamos ver como isso pode ser implementado usando um aplicativo de exemplo escrito usando a estrutura da plataforma CUBA.  No entanto, como o CUBA √© baseado no Spring e no EclipseLink, a maioria das t√©cnicas usadas aqui funcionar√° em qualquer outra plataforma Java que suporte as especifica√ß√µes de Valida√ß√£o de JPA e Bean. </p><br><h2 id="validaciya-s-ispolzovaniem-database-constraints">  Valida√ß√£o usando restri√ß√µes de banco de dados </h2><br><p> Talvez a maneira mais comum e √≥bvia de validar dados seja usar restri√ß√µes no n√≠vel do banco de dados, por exemplo, o sinalizador necess√°rio (para campos cujo valor n√£o pode estar vazio), comprimento da linha, √≠ndices exclusivos etc.  Esse m√©todo √© mais adequado para aplicativos corporativos, pois esse tipo de software geralmente √© estritamente focado no processamento de dados.  No entanto, mesmo aqui os desenvolvedores geralmente cometem erros ao definir limites separadamente para cada n√≠vel do aplicativo.  Na maioria das vezes, o motivo est√° na distribui√ß√£o de responsabilidades entre os desenvolvedores. </p><br><p>  Considere um exemplo que muitos de n√≥s sabemos, alguns at√© de nossa pr√≥pria experi√™ncia ... Se a especifica√ß√£o indicar que deve haver 10 caracteres no campo n√∫mero do passaporte, √© muito prov√°vel que isso seja verificado por todos: um arquiteto de banco de dados no DDL, um desenvolvedor de back-end na Entidade correspondente e Servi√ßos REST e, finalmente, o desenvolvedor da interface do usu√°rio diretamente no lado do cliente.  Em seguida, esse requisito muda e o campo aumenta para 15 caracteres.  Os devops alteram os valores das restri√ß√µes no banco de dados, mas nada muda para o usu√°rio, porque no lado do cliente a restri√ß√£o √© a mesma ... </p><br><p>  Qualquer desenvolvedor sabe como evitar esse problema - a valida√ß√£o deve ser centralizada!  No CUBA, essa valida√ß√£o √© encontrada nas anota√ß√µes da entidade JPA.  Com base nessas meta-informa√ß√µes, o CUBA Studio gerar√° o script DDL correto e aplicar√° os validadores apropriados do lado do cliente. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/118/a16/f17/118a16f1705740a1676eb2c0ea164ef4.png" alt="Exemplo de restri√ß√µes"></p><br><p>  Se as anota√ß√µes forem alteradas, o CUBA atualizar√° os scripts DDL e gerar√° os scripts de migra√ß√£o. Portanto, na pr√≥xima vez que voc√™ implantar o projeto, novas restri√ß√µes baseadas em JPA entrar√£o em vigor na interface e no banco de dados do aplicativo. </p><br><p> Apesar da simplicidade e implementa√ß√£o no n√≠vel do banco de dados, o que confere confiabilidade absoluta a esse m√©todo, o escopo das anota√ß√µes JPA √© limitado aos casos mais simples que podem ser expressos no padr√£o DDL e n√£o incluem acionadores de banco de dados ou procedimentos armazenados.  Portanto, restri√ß√µes baseadas em JPA podem tornar um campo de entidade exclusivo ou obrigat√≥rio ou definir um tamanho m√°ximo de coluna.  Voc√™ pode at√© definir uma restri√ß√£o exclusiva na combina√ß√£o de colunas usando a anota√ß√£o <code>@UniqueConstraint</code> .  Mas isso √© provavelmente tudo. </p><br><p>  Seja como for, nos casos que exigem l√≥gica de valida√ß√£o mais complexa, como verificar um campo em busca de um valor m√≠nimo / m√°ximo, validar com uma express√£o regular ou executar uma verifica√ß√£o personalizada espec√≠fica apenas para o seu aplicativo, a abordagem conhecida como <strong>"Valida√ß√£o de Bean"</strong> √© aplicada . </p><br><h2 id="bean-validation">  Valida√ß√£o de Bean </h2><br><p>  Todo mundo sabe que √© uma boa pr√°tica seguir padr√µes que tenham um longo ciclo de vida, cuja efic√°cia foi comprovada em milhares de projetos.  A valida√ß√£o do Java Bean √© uma abordagem documentada nas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JSR 380, 349 e 303</a> e seus aplicativos: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hibernate Validator</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Apache BVal</a> . </p><br><p>  Embora essa abordagem seja familiar para muitos desenvolvedores, geralmente √© subestimada.  Essa √© uma maneira f√°cil de incorporar a valida√ß√£o de dados mesmo em projetos herdados, o que permite criar valida√ß√µes de forma clara, simples, confi√°vel e o mais pr√≥xima poss√≠vel da l√≥gica de neg√≥cios. </p><br><p>  O uso da Valida√ß√£o de Bean oferece ao projeto muitas vantagens: </p><br><ul><li>  A l√≥gica de valida√ß√£o est√° localizada pr√≥xima √† √°rea de assunto: a defini√ß√£o de restri√ß√µes para os campos e m√©todos do compartimento ocorre de maneira natural e verdadeiramente orientada a objetos. </li><li>  O padr√£o de Valida√ß√£o de Bean fornece dezenas de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">anota√ß√µes</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">valida√ß√£o</a> <code>@Size</code> para uso, por exemplo: <code>@NotNull</code> , <code>@Size</code> , <code>@Min</code> , <code>@Max</code> , <code>@Pattern</code> , <code>@Email</code> , <code>@Past</code> , n√£o muito padr√£o <code>@URL</code> , <code>@Length</code> , o mais poderoso <code>@ScriptAssert</code> e muitos outros . </li><li>  O padr√£o n√£o nos limita a anota√ß√µes prontas e nos permite criar as nossas.  Tamb√©m podemos criar uma nova anota√ß√£o combinando v√°rias outras ou defini-la usando uma classe Java separada como validador. <br>  Por exemplo, no exemplo acima, podemos definir a anota√ß√£o do n√≠vel de classe <code>@ValidPassportNumber</code> para verificar se o n√∫mero do passaporte corresponde ao formato, dependendo do valor do campo do <code>country</code> . </li><li>  As restri√ß√µes podem ser definidas n√£o apenas em campos ou classes, mas tamb√©m em m√©todos e seus par√¢metros.  Essa abordagem √© chamada de <strong>"valida√ß√£o por contrato"</strong> e ser√° discutida um pouco mais tarde. </li></ul><br><p>  Quando o usu√°rio envia as informa√ß√µes inseridas, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Plataforma CUBA</a> <em>(como algumas outras estruturas)</em> inicia a Valida√ß√£o de Bean automaticamente, para exibir instantaneamente uma mensagem de erro se a valida√ß√£o falhar, e n√£o precisamos executar os validadores de lixeira manualmente. </p><br><p>  Vamos voltar ao exemplo com o n√∫mero do passaporte, mas desta vez vamos complement√°-lo com v√°rias restri√ß√µes da entidade Pessoa: </p><br><ul><li>  O campo de <code>name</code> deve ter 2 ou mais caracteres e deve ser v√°lido.  (Como voc√™ pode ver, regexp n√£o √© simples, mas "Charles Ogier de Batz de Castelmore, Conde d'Artagnan" passa no teste, mas "R2D2" n√£o); </li><li>  <code>height</code> (altura) deve estar no seguinte intervalo: <code>0 &lt; height &lt;= 300</code> cm; </li><li>  O campo de <code>email</code> deve conter uma sequ√™ncia que corresponda ao formato do email correto. </li></ul><br><p>  Com todas essas verifica√ß√µes, a classe Person ficar√° assim: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Listeners</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NamePattern</span></span>(<span class="hljs-string"><span class="hljs-string">"%s|name"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORTNUMBER_PERSON"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span>(name = <span class="hljs-string"><span class="hljs-string">"passportnumber$Person"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ValidPassportNumber</span></span>(groups = {Default.class, UiCrossFieldChecks.class}) <span class="hljs-meta"><span class="hljs-meta">@FraudDetectionFlag</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StandardEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> serialVersionUID = -<span class="hljs-number"><span class="hljs-number">9150857881422152651L</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Pattern</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Bad formed person name: ${validatedValue}"</span></span>, regexp = <span class="hljs-string"><span class="hljs-string">"^[AZ][az]*(\\s(([az]{1,3})|(([az]+\\')?[AZ][az]*)))*$"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Length</span></span>(min = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"NAME"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@Email</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Email address has invalid format: ${validatedValue}"</span></span>, regexp = <span class="hljs-string"><span class="hljs-string">"^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"EMAIL"</span></span>, length = <span class="hljs-number"><span class="hljs-number">120</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String email; <span class="hljs-meta"><span class="hljs-meta">@DecimalMax</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Person height can not exceed 300 centimeters"</span></span>, value = <span class="hljs-string"><span class="hljs-string">"300"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@DecimalMin</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Person height should be positive"</span></span>, value = <span class="hljs-string"><span class="hljs-string">"0"</span></span>, inclusive = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"HEIGHT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> BigDecimal height; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"COUNTRY"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Integer country; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORT_NUMBER"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, length = <span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String passportNumber; ... }</code> </pre> <br><p>  <a href="">Person.java</a> </p><br><p>  Acredito que o uso de anota√ß√µes como <code>@NotNull</code> , <code>@DecimalMin</code> , <code>@Length</code> , <code>@Pattern</code> e similares √© bastante √≥bvio e n√£o requer coment√°rios.  Vamos dar uma olhada na implementa√ß√£o da anota√ß√£o <code>@ValidPassportNumber</code> . </p><br><p>  Nosso novo <code>@ValidPassportNumber</code> verifica se <code>Person#passportNumber</code> corresponde ao padr√£o de regexp para cada pa√≠s especificado pelo campo <code>Person#country</code> . </p><br><p>  Primeiro, vejamos a documenta√ß√£o (os manuais <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CUBA</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hibernate</a> est√£o bem), de acordo com ela, precisamos marcar nossa classe com esta nova anota√ß√£o e passar o par√¢metro <code>groups</code> para ela, onde <code>UiCrossFieldChecks.class</code> significa que essa valida√ß√£o deve ser executada no cruzamento valida√ß√µes - depois de verificar todos os campos individuais, e <code>Default.class</code> salva a restri√ß√£o no grupo de valida√ß√£o padr√£o. </p><br><p>  A descri√ß√£o da anota√ß√£o fica assim: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Target</span></span>(ElementType.TYPE) <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-meta"><span class="hljs-meta">@Constraint</span></span>(validatedBy = ValidPassportNumberValidator.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> ValidPassportNumber { <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> "Passport number is not valid"</span></span>; Class&lt;?&gt;[] groups() <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> {}; Class&lt;? extends Payload&gt;[] payload() <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> {}; }</code> </pre> <br><p>  <a href="">ValidPassportNumber.java</a> </p><br><p>  Aqui, <code>@Target(ElementType.TYPE)</code> diz que o objetivo desta anota√ß√£o de tempo de execu√ß√£o √© a classe, e <code>@Constraint(validatedBy = ‚Ä¶ )</code> determina que a valida√ß√£o √© executada pela classe <code>ValidPassportNumberValidator</code> que implementa a interface <code>ConstraintValidator&lt;...&gt;</code> .  O c√≥digo de valida√ß√£o em si est√° no m√©todo <code>isValid(...)</code> , que executa a verifica√ß√£o real de uma maneira bastante direta: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidPassportNumberValidator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConstraintValidator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidPassportNumber</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ValidPassportNumber constraint)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, ConstraintValidatorContext context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (person == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (person.country == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || person.passportNumber == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> doPassportNumberFormatCheck(person.getCountry(), person.getPassportNumber()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doPassportNumberFormatCheck</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CountryCode country, String passportNumber)</span></span></span><span class="hljs-function"> </span></span>{ ... } }</code> </pre> <br><p>  <a href="">ValidPassportNumberValidator.java</a> </p><br><p>  Isso √© tudo.  Com a plataforma CUBA, n√£o precisamos escrever nada al√©m de uma linha de c√≥digo que fa√ßa nossa valida√ß√£o personalizada funcionar e forne√ßa mensagens de erro ao usu√°rio. <br>  Nada complicado, certo? </p><br><p>  Agora vamos ver como tudo funciona.  Aqui, o CUBA possui outro nishtyaki: n√£o apenas mostra ao usu√°rio uma mensagem de erro, mas tamb√©m destaca os campos vermelhos que n√£o passaram na valida√ß√£o do bean: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/310/83d/b2b/31083db2b14d67d88de169542b59748a.png" alt="Representa√ß√£o da interface do usu√°rio"></p><br><p>  N√£o √© uma solu√ß√£o elegante?  Voc√™ obt√©m uma exibi√ß√£o adequada dos erros de valida√ß√£o na interface do usu√°rio adicionando apenas algumas anota√ß√µes Java √†s entidades da √°rea de assunto. </p><br><p>  Para resumir a se√ß√£o, listemos brevemente as vantagens da Valida√ß√£o de Bean para entidades mais uma vez: </p><br><ol><li>  √â compreens√≠vel e leg√≠vel; </li><li>  Permite definir restri√ß√µes de valor diretamente nas classes de entidade; </li><li>  Pode ser personalizado e complementado; </li><li>  Integrado em ORMs populares, e as verifica√ß√µes s√£o executadas automaticamente antes que as altera√ß√µes sejam salvas no banco de dados; </li><li>  Algumas estruturas tamb√©m executam a valida√ß√£o de bean automaticamente quando o usu√°rio envia dados para a interface do usu√°rio (e, caso contr√°rio, √© f√°cil chamar a interface do <code>Validator</code> manualmente); </li><li>  A Valida√ß√£o de Bean √© um padr√£o reconhecido e est√° cheio de documenta√ß√£o na Internet. </li></ol><br><p>  Mas e se voc√™ precisar definir uma restri√ß√£o em um m√©todo, construtor ou endere√ßo REST para validar dados provenientes de um sistema externo?  Ou, se voc√™ precisar verificar declarativamente os valores dos par√¢metros do m√©todo, sem escrever c√≥digo chato com muitas condi√ß√µes if-else em cada m√©todo sendo testado? </p><br><p>  A resposta √© simples: a Valida√ß√£o de Bean tamb√©m se aplica a m√©todos! </p><br><h2 id="validation-by-contract">  Valida√ß√£o por contrato </h2><br><p>  √Äs vezes, voc√™ precisa ir al√©m da valida√ß√£o do estado do modelo de dados.  Muitos m√©todos podem se beneficiar da valida√ß√£o autom√°tica de par√¢metros e do valor de retorno.  Isso pode ser necess√°rio n√£o apenas para verificar os dados que v√£o para endere√ßos REST ou SOAP, mas tamb√©m para os casos em que queremos anotar as pr√©-condi√ß√µes e p√≥s-condi√ß√µes de chamadas de m√©todo para garantir que os dados inseridos foram verificados antes da execu√ß√£o do corpo do m√©todo ou que o valor de retorno est√° no intervalo esperado ou, por exemplo, apenas precisamos descrever declarativamente os intervalos dos valores dos par√¢metros de entrada para melhorar a legibilidade do c√≥digo. </p><br><p>  Usando a valida√ß√£o de bean, restri√ß√µes podem ser aplicadas aos par√¢metros de entrada e retornam valores de m√©todos e construtores para verificar as pr√©-condi√ß√µes e p√≥s-condi√ß√µes de suas chamadas em qualquer classe Java.  Esse caminho possui v√°rias vantagens sobre os m√©todos tradicionais de verifica√ß√£o da validade dos par√¢metros e valores de retorno: </p><br><ol><li>  N√£o √© necess√°rio executar verifica√ß√µes manualmente em um estilo imperativo (por exemplo, lan√ßando <code>IllegalArgumentException</code> e similares).  Voc√™ pode definir restri√ß√µes declarativamente e tornar o c√≥digo mais compreens√≠vel e expressivo; </li><li>  As restri√ß√µes podem ser configuradas, reutilizadas e configuradas: voc√™ n√£o precisa escrever a l√≥gica de valida√ß√£o para cada verifica√ß√£o.  Menos c√≥digo significa menos erros. </li><li>  Se a classe, o valor de retorno do m√©todo ou seu par√¢metro estiver marcado com a anota√ß√£o <code>@Validated</code> , as verifica√ß√µes ser√£o executadas automaticamente pela plataforma a cada chamada de m√©todo. </li><li>  Se o execut√°vel estiver marcado com a anota√ß√£o <code>@Documented</code> , suas pr√© e p√≥s-condi√ß√µes ser√£o inclu√≠das no JavaDoc gerado. </li></ol><br><p>  Usando <strong>'valida√ß√£o de contrato'</strong> , obtemos um c√≥digo claro, compacto e de f√°cil manuten√ß√£o. </p><br><p>  Por exemplo, vejamos a interface do controlador REST de um aplicativo CUBA.  A interface <code>PersonApiService</code> permite obter uma lista de pessoas do banco de dados usando o m√©todo <code>getPersons()</code> e adicionar uma nova pessoa usando a <code>addNewPerson(...)</code> . </p><br><p>  E n√£o esque√ßa que a valida√ß√£o de bean √© herdada!  Em outras palavras, se anotamos uma determinada classe, campo ou m√©todo, todas as classes que herdam essa classe ou implementam essa interface estar√£o sujeitas √† mesma anota√ß√£o de valida√ß√£o. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Validated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonApiService</span></span></span><span class="hljs-class"> </span></span>{ String NAME = <span class="hljs-string"><span class="hljs-string">"passportnumber_PersonApiService"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Valid</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredView</span></span>(<span class="hljs-string"><span class="hljs-string">"_local"</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;Person&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPersons</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addNewPerson</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @NotNull @Length(min = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">, max = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">255</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pattern</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Bad formed person name: ${validatedValue}"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, regexp = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"^[AZ][az]*(\\s(([az]{1,3})|(([az]+\\')?[AZ][az]*)))*$"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String name, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecimalMax</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Person height can not exceed 300 cm"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, value = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"300"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecimalMin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Person height should be positive"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, value = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, inclusive = </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> BigDecimal height, @NotNull CountryCode country, @NotNull String passportNumber )</span></span>; }</code> </pre> <br><p>  <a href="">PersonApiService.java</a> </p><br><p>  Esse trecho de c√≥digo √© claro o suficiente? <br>  _ (Exceto a anota√ß√£o <code>@RequiredView(‚Äú_local‚Äù)</code> , espec√≠fica da Plataforma CUBA e verificando se o objeto <code>Person</code> retornado cont√©m todos os campos da tabela <code>PASSPORTNUMBER_PERSON</code> ) ._ </p><br><p>  A <code>@Valid</code> define que cada objeto de cole√ß√£o retornado pelo m√©todo <code>getPersons()</code> tamb√©m deve ser validado com rela√ß√£o √†s restri√ß√µes da classe <code>Person</code> . </p><br><p>  Em um aplicativo CUBA, esses m√©todos est√£o dispon√≠veis nos seguintes endere√ßos: </p><br><ul><li>  / app / rest / v2 / services / passportnumber_PersonApiService / getPersons </li><li>  / app / rest / v2 / services / passportnumber_PersonApiService / addNewPerson </li></ul><br><p>  Vamos abrir o aplicativo Postman e garantir que a valida√ß√£o funcione como deveria: </p><br><p><img src="https://habrastorage.org/webt/qg/ra/qj/qgraqjsxfyeqqa6qcjf2pkf7tcq.png" alt="Postman app"></p><br><p>  Como voc√™ deve ter notado, o n√∫mero do passaporte n√£o √© validado no exemplo acima.  Isso ocorre porque esse campo requer uma verifica√ß√£o cruzada dos par√¢metros do m√©todo <code>addNewPerson</code> , pois a escolha de um modelo de express√£o regular para validar <code>passportNumber</code> depende do valor do campo <code>country</code> .  Essa valida√ß√£o cruzada √© um an√°logo completo das restri√ß√µes de entidade no n√≠vel de classe! </p><br><p>  A valida√ß√£o cruzada de par√¢metros √© suportada pelo JSR 349 ‚Äã‚Äãe 380. Voc√™ pode ler a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">hibernate</a> para aprender como implementar sua pr√≥pria valida√ß√£o cruzada de m√©todos de classe / interface. </p><br><h2 id="za-predelami-bean-validation">  Valida√ß√£o de Bean Externo </h2><br><p>  N√£o h√° perfei√ß√£o no mundo, portanto, a valida√ß√£o de bean tem suas desvantagens e limita√ß√µes: </p><br><ol><li>  √Äs vezes, precisamos apenas verificar o estado de um gr√°fico complexo de objetos antes de salvar as altera√ß√µes no banco de dados.  Por exemplo, voc√™ precisa garantir que todos os elementos de um pedido do cliente sejam colocados em um pacote.  Essa √© uma opera√ß√£o bastante dif√≠cil, e realiz√°-la sempre que o usu√°rio adicionar novos itens ao pedido n√£o √© uma boa ideia.  Portanto, essa verifica√ß√£o pode ser necess√°ria apenas uma vez: antes de salvar o objeto <code>Order</code> e seus subobjetos <code>OrderItem</code> no banco de dados. </li><li>  Algumas verifica√ß√µes precisam ser feitas dentro de uma transa√ß√£o.  Por exemplo, o sistema de armazenamento eletr√¥nico deve verificar se h√° c√≥pias suficientes das mercadorias para atender ao pedido antes de envi√°-lo ao banco de dados.  Essa verifica√ß√£o s√≥ pode ser realizada dentro de uma transa√ß√£o, porque  O sistema √© multiencadeado e a quantidade de mercadorias em estoque pode mudar a qualquer momento. </li></ol><br><p>  A Plataforma CUBA oferece dois mecanismos de valida√ß√£o de dados pr√©-confirmados chamados <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ouvintes de entidade</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ouvintes de transa√ß√£o</a> .  Vamos consider√°-los com mais detalhes. </p><br><h3 id="entity-listemers">  Listemers de entidade </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Os ouvintes de entidade no CUBA s√£o</a> muito semelhantes aos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>PreInsertEvent</code> , <code>PreUpdateEvent</code> e <code>PredDeleteEvent</code></a> que o JPA oferece ao desenvolvedor.  Ambos os mecanismos permitem verificar objetos de entidade antes e depois de serem armazenados no banco de dados. </p><br><p>  No CUBA, √© f√°cil criar e conectar um ouvinte de entidade, para isso voc√™ precisa de duas coisas: </p><br><ol><li>  Crie um bean gerenciado que implemente uma das interfaces do ouvinte da entidade.  3 interfaces s√£o importantes para valida√ß√£o: <br>  <code>BeforeDeleteEntityListener&lt;T&gt;</code> , <br>  <code>BeforeInsertEntityListener&lt;T&gt;</code> , <br> <code>BeforeUpdateEntityListener&lt;T&gt;</code> </li> <li>  Adicione a anota√ß√£o <code>@Listeners</code> ao objeto de entidade que voc√™ planeja rastrear. </li></ol><br><p>  E isso √© tudo. </p><br><p>  Comparadas ao padr√£o JPA (JSR 338, Se√ß√£o 3.5), as interfaces de ouvinte da Plataforma CUBA s√£o digitadas, portanto, voc√™ n√£o precisa converter um argumento do tipo <code>Object</code> em um tipo de entidade para come√ßar a trabalhar com ele.  A plataforma CUBA adiciona entidades relacionadas ou chamadores do EntityManager a capacidade de carregar e modificar outras entidades.  Todas essas altera√ß√µes tamb√©m chamar√£o o ouvinte da entidade correspondente. </p><br><p>  A plataforma CUBA tamb√©m suporta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"exclus√£o reversa"</a> , uma abordagem em que, em vez de excluir registros do banco de dados, eles s√£o marcados apenas como exclu√≠dos e se tornam inacess√≠veis para uso normal.  Portanto, para exclus√£o leve, a plataforma chama ouvintes <code>BeforeDeleteEntityListener</code> / <code>BeforeDeleteEntityListener</code> , enquanto implementa√ß√µes padr√£o chamam <code>PostUpdate</code> / <code>PostUpdate</code> . </p><br><p>  Vejamos um exemplo.  Aqui, o bean de ouvinte de evento se conecta √† classe de entidade com apenas uma linha de c√≥digo: a anota√ß√£o <code>@Listeners</code> , que leva o nome da classe de ouvinte: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Listeners</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NamePattern</span></span>(<span class="hljs-string"><span class="hljs-string">"%s|name"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORTNUMBER_PERSON"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span>(name = <span class="hljs-string"><span class="hljs-string">"passportnumber$Person"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ValidPassportNumber</span></span>(groups = {Default.class, UiCrossFieldChecks.class}) <span class="hljs-meta"><span class="hljs-meta">@FraudDetectionFlag</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StandardEntity</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br><p>  <a href="">Person.java</a> </p><br><p>  A implementa√ß√£o do ouvinte se parece com isso: </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Checks that there are no other persons with the same * passport number and country code * Ignores spaces in the passport number for the check. * So numbers "12 45 768007" and "1245 768007" and "1245768007" * are the same for the validation purposes. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonEntityListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeDeleteEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeInsertEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeUpdateEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBeforeDelete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, EntityManager entityManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationException( <span class="hljs-string"><span class="hljs-string">"Passport and country code combination isn't unique"</span></span>); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBeforeInsert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, EntityManager entityManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// use entity argument to validate the Person object // entityManager could be used to access database // if you need to check the data // throw ValidationException object if validation check failed if (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) throw new ValidationException( "Passport and country code combination isn't unique"); } @Override public void onBeforeUpdate(Person person, EntityManager entityManager) { if (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) throw new ValidationException( "Passport and country code combination isn't unique"); } ... }</span></span></code> </pre> <br><p>  <a href="">PersonEntityListener.java</a> </p><br><p>  Ouvintes de entidade s√£o uma √≥tima op√ß√£o se: </p><br><ul><li>  √â necess√°rio verificar os dados dentro da transa√ß√£o antes que o objeto da entidade seja armazenado no banco de dados; </li><li>  √â necess√°rio verificar os dados no banco de dados durante o processo de valida√ß√£o, por exemplo, para verificar se h√° produto suficiente em estoque para aceitar o pedido; </li><li>  Voc√™ precisa olhar n√£o apenas para o objeto da entidade, como <code>Order</code> , mas tamb√©m para entidades relacionadas, por exemplo, <code>OrderItems</code> para a entidade <code>Order</code> ; </li><li>  Queremos rastrear as opera√ß√µes de inser√ß√£o, atualiza√ß√£o ou exclus√£o apenas para determinadas classes de entidade, por exemplo, apenas para <code>OrderItem</code> <code>Order</code> e <code>OrderItem</code> , e n√£o precisamos verificar altera√ß√µes em outras classes de entidade durante a transa√ß√£o. </li></ul><br><h3 id="transaction-listeners">  Ouvintes de transa√ß√£o </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Os ouvintes de transa√ß√£o CUBA</a> tamb√©m atuam no contexto de transa√ß√µes, mas, comparados aos ouvintes de entidade, eles s√£o chamados para cada transa√ß√£o de banco de dados. </p><br><p>  Isso lhes d√° super poder: </p><br><ul><li>  nada pode escapar da aten√ß√£o deles. </li></ul><br><p>  Mas o mesmo √© determinado por suas defici√™ncias: </p><br><ul><li>  eles s√£o mais dif√≠ceis de escrever; </li><li>  eles podem reduzir significativamente o desempenho; </li><li>  Eles devem ser escritos com muito cuidado: um bug no ouvinte de transa√ß√µes pode interferir mesmo com o carregamento inicial do aplicativo. </li></ul><br><p>  Portanto, os ouvintes de transa√ß√£o s√£o uma boa solu√ß√£o quando voc√™ precisa inspecionar diferentes tipos de entidades usando o mesmo algoritmo, por exemplo, verificando todos os dados em busca de fraudes cibern√©ticas com um √∫nico servi√ßo que atende a todos os seus objetos de neg√≥cios. </p><br><p><img src="https://habrastorage.org/webt/km/v9/co/kmv9cougmokpc3opta_dfk4egqk.jpeg" alt="Voc√™ n√£o deve passar!"></p><br><p>  D√™ uma olhada em uma amostra que verifica se a entidade possui uma anota√ß√£o <code>@FraudDetectionFlag</code> e, se houver, inicia um detector de fraude.  Repito: lembre-se de que esse m√©todo √© chamado no sistema <strong>antes de confirmar cada transa√ß√£o do banco de dados</strong> ; portanto, o c√≥digo deve tentar verificar o menor n√∫mero poss√≠vel de objetos. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_ApplicationTransactionListener"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationTransactionListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeCommitTransactionListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Logger log = LoggerFactory.getLogger(ApplicationTransactionListener.class); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeCommit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EntityManager entityManager, Collection&lt;Entity&gt; managedEntities)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Entity entity : managedEntities) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entity <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> StandardEntity &amp;&amp; !((StandardEntity) entity).isDeleted() &amp;&amp; entity.getClass().isAnnotationPresent(FraudDetectionFlag.class) &amp;&amp; !fraudDetectorFeedAndFastCheck(entity)) { logFraudDetectionFailure(log, entity); String msg = String.format( <span class="hljs-string"><span class="hljs-string">"Fraud detection failure in '%s' with id = '%s'"</span></span>, entity.getClass().getSimpleName(), entity.getId()); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationException(msg); } } } ... }</code> </pre> <br><p>  <a href="">ApplicationTransactionListener.java</a> </p><br><p>  Para se tornar um ouvinte de transa√ß√µes, um bean gerenciado deve implementar a interface <code>BeforeCommitTransactionListener</code> e o m√©todo <code>beforeCommit</code> .  Os ouvintes de transa√ß√£o s√£o vinculados automaticamente quando o aplicativo √© iniciado.  CUBA registra todas as classes que implementam <code>BeforeCommitTransactionListener</code> ou <code>AfterCompleteTransactionListener</code> como ouvintes de transa√ß√£o. </p><br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><p>  A valida√ß√£o de bean <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">(JPA 303, 349 e 980)</a> √© uma abordagem que pode servir como base confi√°vel para 95% dos casos de valida√ß√£o de dados encontrados em um projeto corporativo.  A principal vantagem dessa abordagem √© que a maior parte da l√≥gica de valida√ß√£o est√° concentrada diretamente nas classes de modelo de dom√≠nio.  Portanto, √© f√°cil de encontrar, f√°cil de ler e f√°cil de manter.  Spring, CUBA e muitas outras bibliotecas suportam esses padr√µes e executam automaticamente verifica√ß√µes de valida√ß√£o ao receber dados na camada da interface do usu√°rio, chamar m√©todos validados ou armazenar dados atrav√©s do ORM, portanto, a valida√ß√£o do Bean geralmente parece m√°gica do ponto de vista do desenvolvedor. </p><br><p>  Alguns desenvolvedores de software v√™em a valida√ß√£o no n√≠vel de classes do modelo de assunto como antinatural e muito complexa, dizem que a valida√ß√£o de dados no n√≠vel da interface do usu√°rio √© uma estrat√©gia bastante eficaz.  No entanto, acredito que v√°rios pontos de valida√ß√£o em componentes e controladores de interface do usu√°rio n√£o s√£o a abordagem mais racional.   ,  ,  ,    ,     ,       listener'        . </p><br><p>  ,  ,     : </p><br><ol><li> <strong>JPA </strong>   ,          ,        DDL. </li><li> <strong>Bean Validation</strong> ‚Äî , , ,             .      ,       . </li><li> <strong>  </strong>  bean validation,    .        , ,   REST. </li><li> <strong>Entity listeners:</strong>      ,   Bean Validation,             . ,         .  Hibernate    . </li><li> <strong>Transaction listeners</strong> ‚Äî ,   ,    .  ,      ,                    . </li></ol><br><p> <em>PS: ,              Java,      ,    ,    .</em> </p><br><hr><br><h2 id="poleznye-ssylki">  Links √∫teis </h2><br><div class="spoiler">  <b class="spoiler_title">Texto oculto</b> <div class="spoiler_text"><h3 id="standarty-i-ih-realizacii"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Normas e sua implementa√ß√£o </font></font></h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 303 - Valida√ß√£o de Bean 1.0</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 349 ‚Äã‚Äã- Valida√ß√£o de Bean 1.1</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 349, Especifica√ß√£o de Valida√ß√£o de Bean</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 380, Especifica√ß√£o de Valida√ß√£o de Bean</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refer√™ncia do Hibernate Validator 5.4.2 (JSR 349)</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hibernate Validator 6.10 (JSR 380) reference</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hibernate Validator main page</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hibernate validator 6.10 API docs</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HV 6.10: Declaring and validating method constraints</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HV 6.10: Cross parameter constraints</a> </li></ul><br><h3 id="biblioteki">  Bibliotecas </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CUBA bean validation</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Validation cookbook for CUBA applications</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JavaFX with Bean Validation and CDI 2.0</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OVal ‚Äî non a JSR 303, 349, 380 compliant validation framework</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Spring, Java Bean Validation Basics</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Validation, Data Binding, and Type Conversion in Spring 4.1</a> </li></ul><br><h3 id="filosofiya-validacii-dannyh">    </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Form validation best practices</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JavaFX Form Validation</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Blah vs Bean Validation: you missed the point like Mars Climate Orbiter</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Avoiding Many If Blocks For Validation Checking</a> </li></ul><br><h3 id="materialy-dlya-dalneyshego-chteniya">     </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Validation cookbook for CUBA applications</a> </li></ul></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt427543/">https://habr.com/ru/post/pt427543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt427533/index.html">Rel√≥gios inteligentes que n√£o precisam de carregamento. Existem muitos deles?</a></li>
<li><a href="../pt427535/index.html">Lan√ßamos uma escolha coletiva de solu√ß√µes</a></li>
<li><a href="../pt427537/index.html">Como se tornar um gerente de produto de sucesso: cursos onde voc√™ √© treinado agora</a></li>
<li><a href="../pt427539/index.html">Europa √∫ltima vez que ajusta o rel√≥gio para o inverno</a></li>
<li><a href="../pt427541/index.html">Amazon pede √† Bloomberg que retire alega√ß√µes de alto perfil em um artigo sobre m√≥dulos de spyware chineses em servidores</a></li>
<li><a href="../pt427545/index.html">Sistemas de informa√ß√£o ‚Äúdesembarque esperado‚Äù para registro de transporte a√©reo na R√∫ssia</a></li>
<li><a href="../pt427549/index.html">Relat√≥rio do Club of Rome de 2018, cap√≠tulo 1.6: Curingas de tecnologia</a></li>
<li><a href="../pt427551/index.html">Por que n√£o podemos abandonar o teclado QWERTY</a></li>
<li><a href="../pt427555/index.html">Animais que os humanos aprenderam a rastrear usando a tecnologia de reconhecimento facial</a></li>
<li><a href="../pt427557/index.html">Resumo dos eventos de TI em novembro (primeira parte)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>