<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÖüèª ü§ô üë®üèª‚Äç‚öñÔ∏è D√©veloppement WebAssembly: v√©ritable r√¢teau et exemples üêº üé¥ üåô</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'annonce de WebAssembly a eu lieu en 2015 - mais maintenant, apr√®s des ann√©es, il y en a encore peu qui peuvent s'en vanter en production. Les docume...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©veloppement WebAssembly: v√©ritable r√¢teau et exemples</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/441140/"><img src="https://habrastorage.org/webt/e5/pu/-s/e5pu-s7yjpdm8dddc42_nxa1uve.jpeg"><br><br>  L'annonce de WebAssembly a eu lieu en 2015 - mais maintenant, apr√®s des ann√©es, il y en a encore peu qui peuvent s'en vanter en production.  Les documents sur une telle exp√©rience sont d‚Äôautant plus pr√©cieux: des informations de premi√®re main sur la mani√®re de vivre avec elle dans la pratique sont encore rares. <br><br>  Lors de la conf√©rence HolyJS, un rapport sur l'exp√©rience de l'utilisation de WebAssembly a re√ßu des notes √©lev√©es du public, et maintenant une version texte de ce rapport a √©t√© pr√©par√©e sp√©cialement pour Habr (une vid√©o est √©galement jointe). <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/uqG9DiT80UE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Je m'appelle Andrey, je vais vous parler de WebAssembly.  On peut dire que j'ai commenc√© √† m'engager sur le web au si√®cle dernier, mais je suis modeste, donc je ne le dirai pas.  Pendant ce temps, j'ai r√©ussi √† travailler √† la fois sur le backend et le frontend, et j'ai m√™me dessin√© un peu de design.  Aujourd'hui, je m'int√©resse √† des choses comme WebAssembly, C ++ et d'autres choses natives.  J'aime aussi beaucoup la typographie et collectionne les anciennes technologies. <br><br>  Tout d'abord, je parlerai de la fa√ßon dont l'√©quipe et moi avons impl√©ment√© WebAssembly dans notre projet, puis nous verrons si vous avez besoin de quelque chose de WebAssembly, et terminerons avec quelques conseils au cas o√π vous souhaiteriez l'impl√©menter vous-m√™me. <br><br><h2>  Comment nous avons impl√©ment√© WebAssembly </h2><br>  Je travaille pour Inetra, nous sommes situ√©s √† Novossibirsk et r√©alisons certains de nos propres projets.  L'un d'eux est ByteFog.  Il s'agit d'une technologie peer-to-peer pour fournir des vid√©os aux utilisateurs.  Nos clients sont des services qui distribuent une √©norme quantit√© de vid√©os.  Ils ont un probl√®me: quand un √©v√©nement populaire se produit, par exemple, une conf√©rence de presse ou un √©v√©nement sportif, comment ne pas s'y pr√©parer, un tas de clients arrivent, s'appuient sur le serveur et le serveur est triste.  Les clients re√ßoivent actuellement une tr√®s mauvaise qualit√© vid√©o. <br><br>  Mais tout le monde regarde le m√™me contenu.  Demandons aux appareils voisins des utilisateurs de partager des morceaux de vid√©o, puis nous d√©chargerons le serveur, √©conomiserons la bande passante et les utilisateurs recevront la vid√©o en meilleure qualit√©.  Ces nuages ‚Äã‚Äãsont notre technologie, notre serveur proxy ByteFog. <br><br><img src="https://habrastorage.org/webt/ir/yw/xl/irywxlozwzz4kbedspsf14lx4ie.png"><br><br>  Nous devons √™tre install√©s sur tous les appareils capables d'afficher de la vid√©o, c'est pourquoi nous prenons en charge une tr√®s large gamme de plates-formes: Windows, Linux, Android, iOS, Web, Tizen.  Quelle langue choisir pour avoir une base de code unique sur toutes ces plateformes?  Nous avons choisi C ++ car il s'est av√©r√© avoir le plus d'avantages :-D Plus s√©rieusement, nous avons une bonne expertise en C ++, c'est vraiment un langage rapide, et en portabilit√© c'est probablement juste derri√®re C. <br><br>  Nous avons obtenu une assez grosse application (900 classes), mais cela fonctionne bien.  Sous Windows et Linux, nous compilons en code natif.  Pour Android et iOS, nous construisons une biblioth√®que que nous connectons √† l'application.  Nous parlerons de Tizen une autre fois, mais sur le Web, nous travaillions comme plug-in de navigateur. <br><br>  Il s'agit de la technologie d'API Netscape Plugin.  Comme son nom l'indique, il est assez ancien et pr√©sente √©galement un inconv√©nient: il donne un acc√®s tr√®s large au syst√®me, donc le code utilisateur peut poser un probl√®me de s√©curit√©.  C'est probablement pourquoi Chrome a d√©sactiv√© la prise en charge de cette technologie en 2015, puis tous les navigateurs ont rejoint ce flash mob.  Nous nous sommes donc retrouv√©s sans version Web pendant pr√®s de deux ans. <br><br>  En 2017, un nouvel espoir est venu.  Comme vous pouvez l'imaginer, il s'agit de WebAssembly.  En cons√©quence, nous nous sommes fix√© pour t√¢che de porter notre application sur un navigateur.  √âtant donn√© que la prise en charge de Firefox et Chrome est d√©j√† apparue au printemps, et √† l'automne 2017, Edge et Safari se sont relev√©s. <br><br>  Il √©tait important pour nous d'utiliser le code pr√™t √† l'emploi, car nous avons beaucoup de logique m√©tier que nous ne voulions pas doubler, afin de ne pas doubler le nombre de bogues.  Prenez le compilateur Emscripten.  Il fait ce dont nous avons besoin - compile l'application positive dans le navigateur et recr√©e l'environnement familier de l'application native dans le navigateur.  Nous pouvons dire que Emscripten est un tel code Browserify pour C ++.  Il vous permet √©galement de transf√©rer des objets de C ++ vers JavaScript et vice versa.  Notre premi√®re pens√©e a √©t√©: prenons maintenant Emscripten, compilons simplement, et tout fonctionnera.  Bien s√ªr que non.  De l√† a commenc√© notre voyage le long du r√¢teau. <br><br>  La premi√®re chose que nous avons rencontr√©e √©tait la d√©pendance.  Il y avait plusieurs biblioth√®ques dans notre base de code.  Maintenant, cela n'a aucun sens de les √©num√©rer, mais pour ceux qui comprennent, nous avons Boost.  Il s'agit d'une grande biblioth√®que qui vous permet d'√©crire du code multiplateforme, mais il est tr√®s difficile de configurer la compilation avec.  Je voulais faire glisser le moins de code possible dans le navigateur. <br><br><h3>  Architecture Bytefog </h3><br>  En cons√©quence, nous avons identifi√© le noyau: nous pouvons dire qu'il s'agit d'un serveur proxy qui contient la logique m√©tier principale.  Ce serveur proxy prend les donn√©es de deux sources.  Le premier et le principal est HTTP, c'est-√†-dire un canal vers le serveur de distribution vid√©o, le second est notre r√©seau P2P, c'est-√†-dire un canal vers un autre m√™me proxy d'un autre utilisateur.  Nous donnons les donn√©es principalement au joueur, car notre t√¢che est de montrer un contenu de haute qualit√© √† l'utilisateur.  S'il reste des ressources, nous distribuons le contenu au r√©seau P2P afin que d'autres utilisateurs puissent le t√©l√©charger.  √Ä l'int√©rieur, il y a une cache intelligente qui fait toute la magie. <br><br><img src="https://habrastorage.org/webt/vi/id/zt/viidzt9cctzun2_em3ka8jfm8pu.png"><br><br>  Apr√®s avoir compil√© tout cela, nous sommes confront√©s au fait que WebAssembly est ex√©cut√© dans le sandbox du navigateur.  Cela signifie qu'il ne peut pas faire plus que ce que JavaScript donne.  Alors que les applications natives utilisent beaucoup de choses sp√©cifiques √† la plate-forme, comme un syst√®me de fichiers, un r√©seau ou des nombres al√©atoires.  Toutes ces fonctionnalit√©s devront √™tre impl√©ment√©es en JavaScript en utilisant ce que le navigateur nous donne.  Cette plaque r√©pertorie les remplacements assez √©vidents r√©pertori√©s. <br><br><img src="https://habrastorage.org/webt/ii/uv/bf/iiuvbfvwjvul6pbnkuptqku8amo.png"><br><br>  Pour rendre cela possible, il est n√©cessaire de scier l'impl√©mentation des capacit√©s natives dans une application native et d'y ins√©rer une interface, c'est-√†-dire tracer une certaine fronti√®re.  Ensuite, vous impl√©mentez cela en JavaScript et quittez l'impl√©mentation native, et d√©j√† pendant l'assemblage, celle n√©cessaire est s√©lectionn√©e.  Nous avons donc regard√© notre architecture et trouv√© tous les endroits o√π cette fronti√®re peut √™tre trac√©e.  Par co√Øncidence, il s'agit d'un sous-syst√®me de transport. <br><br><img src="https://habrastorage.org/webt/ok/eq/w-/okeqw-dc-weuwlqxed4iy2x5nn4.png"><br><br>  Pour chacun de ces endroits, nous avons d√©fini une sp√©cification, c'est-√†-dire que nous avons fix√© un contrat: quelles m√©thodes seront, quels param√®tres ils auront, quels types de donn√©es.  Une fois que vous avez fait cela, vous pouvez travailler en parall√®le, chaque d√©veloppeur de son c√¥t√©. <br><br>  Quel est le r√©sultat?  Nous avons remplac√© le principal canal de diffusion vid√©o du fournisseur par l'AJAX habituel.  Nous transmettons des donn√©es au lecteur via la biblioth√®que populaire HLS.js, mais il y a une possibilit√© fondamentale de s'int√©grer avec d'autres joueurs, si n√©cessaire.  Nous avons remplac√© la totalit√© de la couche P2P par WebRTC. <br><br><img src="https://habrastorage.org/webt/g8/dc/mt/g8dcmtbxfugjxpycyzpabtb6nto.png"><br><br>  √Ä la suite de la compilation, plusieurs fichiers sont obtenus.  Le plus important est le .wasm binaire.  Il contient le bytecode compil√© que le navigateur ex√©cutera et qui contient tout votre h√©ritage C ++.  Mais en soi, cela ne fonctionne pas, le soi-disant ¬´code de colle¬ª est n√©cessaire, il est √©galement g√©n√©r√© par le compilateur.  Le code de colle t√©l√©charge un fichier binaire et vous t√©l√©chargez ces deux fichiers en production.  √Ä des fins de d√©bogage, vous pouvez g√©n√©rer une repr√©sentation textuelle de l'assembleur - un fichier .wast et une carte source.  Vous devez comprendre qu'ils peuvent √™tre tr√®s volumineux.  Dans notre cas, ils ont atteint 100 m√©gaoctets ou plus. <br><br><h3>  Collecte du bundle </h3><br>  Examinons de plus pr√®s le code de la colle.  C'est le bon vieux ES5 habituel, assembl√© en un seul fichier.  Lorsque nous le connectons √† une page Web, nous avons une variable globale qui contient l'ensemble de notre module wasm instanci√©, qui est pr√™t √† accepter les demandes √† son API. <br><br>  Mais l'inclusion d'un fichier s√©par√© est une complication assez s√©rieuse pour la biblioth√®que que les utilisateurs utiliseront.  Nous aimerions tout mettre dans un seul paquet.  Pour cela, nous utilisons Webpack et une option de compilation sp√©ciale MODULARIZE. <br><br>  Il enveloppe le code adh√©sif dans le motif ¬´Module¬ª, et nous pouvons le r√©cup√©rer: importez ou utilisez le besoin si nous √©crivons sur ES5 - Webpack comprend calmement cette d√©pendance.  Il y avait un probl√®me avec Babel - il n'aimait pas la grande quantit√© de code, mais c'est un code ES5, il n'a pas besoin d'√™tre transpos√©, nous l'ajoutons juste pour l'ignorer. <br><br>  √Ä la recherche du nombre de fichiers, j'ai d√©cid√© d'utiliser l'option SINGLE_FILE.  Il traduit tous les fichiers binaires r√©sultant de la compilation dans le formulaire Base64 et les pousse dans le code adh√©sif sous forme de cha√Æne.  Cela semble √™tre une excellente id√©e, mais apr√®s cela, le bundle est devenu de 100 m√©gaoctets.  Ni Webpack, ni Babel, ni m√™me le navigateur ne fonctionnent sur un tel volume.  Quoi qu'il en soit, nous ne forcerons pas l'utilisateur √† charger 100 m√©gaoctets?! <br><br>  Si vous y r√©fl√©chissez, cette option n'est pas n√©cessaire.  Le code adh√©sif t√©l√©charge les fichiers binaires de lui-m√™me.  Il le fait via HTTP, donc nous obtenons la mise en cache pr√™te √† l'emploi, nous pouvons d√©finir tous les en-t√™tes que nous voulons, par exemple, activer la compression, et les fichiers WebAssembly sont parfaitement compress√©s. <br><br>  Mais la technologie la plus cool est la compilation en streaming.  Autrement dit, le fichier WebAssembly, lors du t√©l√©chargement √† partir du serveur, peut d√©j√† √™tre compil√© dans le navigateur √† mesure que les donn√©es arrivent, ce qui acc√©l√®re consid√©rablement le chargement de votre application.  En g√©n√©ral, toute la technologie WebAssembly met l'accent sur le d√©marrage rapide d'une grande base de code. <br><br><h3>  Th√©matique </h3><br>  Un autre probl√®me avec le module est qu'il s'agit d'un objet Thenable, c'est-√†-dire qu'il a une m√©thode .then ().  Cette fonction vous permet de suspendre un rappel au d√©marrage du module, et c'est tr√®s pratique.  Mais je voudrais que l'interface corresponde √† Promise.  Th√©rapeutique n'est pas une promesse, mais √ßa va, terminons nous-m√™mes.  √âcrivons un code aussi simple: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { Module(config).then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">module</span></span></span></span></span><span class="hljs-function">) =&gt;</span></span> { resolve(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>); }); });</code> </pre> <br>  Nous cr√©ons Promise, d√©marrons notre module et, en tant que rappel, nous appelons la fonction de r√©solution et transmettons le module que nous y avons install√©.  Tout semble √™tre √©vident, tout va bien, nous lan√ßons - quelque chose ne va pas, notre navigateur est gel√©, nos DevTools sont suspendus et le processeur chauffe sur l'ordinateur.  Nous ne comprenons rien - une sorte de r√©cursivit√© ou une boucle infinie.  Le d√©bogage est assez difficile, et lorsque nous avons interrompu JavaScript, nous nous sommes retrouv√©s dans la fonction Then du module Emscripten. <br><br><pre> <code class="javascript hljs">Module[<span class="hljs-string"><span class="hljs-string">'then'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">func</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Module[<span class="hljs-string"><span class="hljs-string">'calledRun'</span></span>]) { func(Module); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Module[<span class="hljs-string"><span class="hljs-string">'onRuntimeInitialized'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ func(Module); }; }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Module; };</code> </pre><br>  Examinons-le plus en d√©tail.  Terrain <br><br><pre> <code class="javascript hljs">Module[<span class="hljs-string"><span class="hljs-string">'onRuntimeInitialized'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ func(Module); };</code> </pre><br>  responsable de suspendre un rappel.  Tout est clair ici: une fonction asynchrone qui appelle notre rappel.  Tout ce que nous voulons.  Il y a une autre partie √† cette fonctionnalit√©. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Module[<span class="hljs-string"><span class="hljs-string">'calledRun'</span></span>]) { func(Module);</code> </pre><br>  Il est appel√© lorsque le module a d√©j√† d√©marr√©.  Ensuite, le rappel est appel√© de mani√®re synchrone imm√©diatement et le module lui est transmis dans le param√®tre.  Cela imite le comportement de Promise, et cela semble √™tre ce que nous attendons.  Mais alors qu'est-ce qui ne va pas? <br><br>  Si vous lisez attentivement la documentation, il s'av√®re qu'il y a un point tr√®s subtil √† propos de Promise.  Lorsque nous r√©solvons la promesse √† l'aide d'un Thenable, le navigateur d√©ballera les valeurs de ce Thenable et pour ce faire, il appellera la m√©thode .then ().  En cons√©quence, nous r√©solvons la promesse, lui passons le module.  Le navigateur demande: est-ce donc un objet?  Oui, c'est un Thenable.  Ensuite, la fonction .then () est appel√©e sur le module, et la fonction de r√©solution elle-m√™me est pass√©e en tant que rappel. <br><br>  Le module v√©rifie s'il est en cours d'ex√©cution.  Il est d√©j√† en cours d'ex√©cution, donc le rappel est appel√© imm√©diatement et le m√™me module lui est √† nouveau transmis.  En rappel, nous avons la fonction de r√©solution, et le navigateur demande: est-ce un objet Thenable?  Oui, c'est un Thenable.  Et tout recommence.  En cons√©quence, nous tombons dans un cycle sans fin dont le navigateur ne revient jamais. <br><br><img src="https://habrastorage.org/webt/ks/rr/c-/ksrrc-zeix0ffh_uott4ahpt3qc.png"><br><br>  Je n'ai pas trouv√© de solution √©l√©gante √† ce probl√®me.  Par cons√©quent, je supprime simplement la m√©thode .then () avant de r√©soudre, et cela fonctionne. <br><br><h3>  Emscripten </h3><br>  Nous avons donc compil√© le module, assembl√© JS, mais il manque quelque chose.  Nous devons probablement faire un travail utile.  Pour ce faire, transf√©rez des donn√©es et connectez les deux mondes - JS et C ++.  Comment faire  Emscripten propose trois options: <br><br><ul><li>  Le premier est les fonctions ccall et cwrap.  Le plus souvent, vous les rencontrerez dans certains didacticiels sur WebAssembly, mais ils ne conviennent pas au travail r√©el, car ils ne prennent pas en charge les capacit√©s de C ++. </li><li>  Le second est WebIDL Binder.  Il prend d√©j√† en charge les fonctions C ++, vous pouvez d√©j√† travailler avec.  Il s'agit d'un langage de description d'interface s√©rieux utilis√©, par exemple, par le W3C pour leur documentation.  Mais nous ne voulions pas l'int√©grer dans notre projet et avons utilis√© la troisi√®me option </li><li>  Embind.  Nous pouvons dire que c'est une fa√ßon native de connecter des objets pour Emscripten, elle est bas√©e sur des mod√®les C ++ et vous permet de faire beaucoup de choses en transmettant diff√©rentes entit√©s de C ++ √† JS et vice versa. </li></ul><br><br>  Embind vous permet de: <br><br><ul><li>  Appeler des fonctions C ++ √† partir du code JavaScript </li><li>  Cr√©er des objets JS √† partir d'une classe C ++ </li><li>  A partir du code C ++, tournez-vous vers l'API du navigateur (si pour une raison quelconque vous le souhaitez, vous pouvez, par exemple, √©crire l'int√©gralit√© du framework frontal en C ++). </li><li>  L'essentiel pour nous: impl√©menter l'interface JavaScript d√©crite en C ++. </li></ul><br><br><h3>  √âchange de donn√©es </h3><br>  Le dernier point est important, car c'est exactement l'action que vous effectuerez constamment lors du portage de l'application.  Je voudrais donc m'y attarder plus en d√©tail.  Maintenant, il y aura du code C ++, mais n'ayez pas peur, c'est presque comme TypeScript :-D <br><br>  Le sch√©ma est le suivant: <br><br><img src="https://habrastorage.org/webt/y8/b9/w7/y8b9w7ztnudrlcv5p0zzsezuzkm.png"><br><br>  Du c√¥t√© C ++, il y a un noyau auquel nous voulons donner acc√®s, par exemple, √† un r√©seau externe - pour t√©l√©charger la vid√©o.  Il le faisait √† l'aide de sockets natifs, il y avait une sorte de client HTTP qui faisait cela, mais il n'y a pas de sockets natifs dans WebAssembly.  Nous devons en quelque sorte sortir, donc nous avons coup√© l'ancien client HTTP, ins√©r√© l'interface √† cet endroit et impl√©ment√© cette interface en JavaScript en utilisant AJAX normal, de quelque mani√®re que ce soit.  Apr√®s cela, nous transmettrons l'objet r√©sultant √† C ++, o√π le noyau l'utilisera. <br><br>  Faisons le client HTTP le plus simple qui ne puisse faire que des requ√™tes get: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HTTPClient</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; };</code> </pre><br>  √Ä l'entr√©e, il re√ßoit une cha√Æne avec l'URL √† t√©l√©charger et √† la sortie <br>  une cha√Æne avec le r√©sultat de la demande.  En C ++, les cha√Ænes peuvent avoir des donn√©es binaires, donc cela convient √† la vid√©o.  Emscripten nous fait √©crire ici <br>  un Wrapper effrayant: <br><br><img src="https://habrastorage.org/webt/m_/dz/hg/m_dzhg7a0xrywq8rirnyeh1rswa.png"><br><br>  Dans ce document, la chose principale est deux choses - le nom de la fonction du c√¥t√© C ++ (je les ai marqu√©s en vert) et les noms correspondants du c√¥t√© JavaScript (je les ai marqu√©s en bleu).  En cons√©quence, nous r√©digeons une d√©claration de communication: <br><br><img src="https://habrastorage.org/webt/am/ob/qz/amobqzp-sx-3w12rnljcxlfh-fk.png"><br><br>  Il fonctionne comme des blocs Lego, √† partir desquels nous l'assemblons.  Nous avons une classe, cette classe a une m√©thode, et nous voulons h√©riter de cette classe pour impl√©menter l'interface.  C‚Äôest tout.  Nous allons √† JavaScript et h√©ritons.  Cela peut se faire de deux mani√®res.  Le premier est d'√©tendre.  Ceci est tr√®s similaire √† la bonne vieille extension de Backbone. <br><br><img src="https://habrastorage.org/webt/rt/6p/fi/rt6pfi7s3sfipms3y8lfusrqgy8.png"><br><br>  Le module contient tout ce que Emscripten a compil√©, et il a une propri√©t√© avec une interface export√©e.  Nous appelons la m√©thode extend et y passons un objet avec l'impl√©mentation de cette m√©thode, c'est-√†-dire qu'une m√©thode sera impl√©ment√©e dans la fonction get <br>  Obtenez des informations en utilisant AJAX. <br><br>  En sortie, extend nous donne un constructeur JavaScript standard.  Nous pouvons l'appeler autant de fois que n√©cessaire et g√©n√©rer des objets dans la quantit√© dont nous avons besoin.  Mais il y a une situation o√π nous avons un objet, et nous voulons juste le passer du c√¥t√© C ++. <br><br><img src="https://habrastorage.org/webt/ky/ct/es/kycteslqo9rkbq5nyj1ilflq7g0.png"><br><br>  Pour ce faire, liez en quelque sorte cet objet √† un type que C ++ comprendra.  C'est ce que fait la fonction d'impl√©mentation.  En sortie, il ne donne pas un constructeur, mais un objet pr√™t √† l'emploi, notre client, que nous pouvons redonner au C ++.  Vous pouvez le faire, par exemple, comme ceci: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> app = Module.makeApp(client, ‚Ä¶)</code> </pre><br>  Supposons que nous ayons une fabrique qui cr√©e notre application et qui prend ses d√©pendances en param√®tres, par exemple, client et autre chose.  Lorsque cette fonction fonctionne, nous obtenons l'objet de notre application, qui contient d√©j√† l'API dont nous avons besoin.  Vous pouvez faire le contraire: <br><br><pre> <code class="cpp hljs">val client = val::global(‚Ä≥client‚Ä≥); client.call&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;(‚Ä≥get‚Ä≥, val(...) );</code> </pre><br>  Directement √† partir de C ++, sortez notre client de la port√©e globale du navigateur.  De plus, √† la place du client, il peut y avoir n'importe quelle API de navigateur, √† partir de la console, se terminant par l'API DOM, WebRTC - tout ce que vous voulez.  Ensuite, nous appelons les m√©thodes de cet objet, et nous encapsulons toutes les valeurs dans la classe magique val, qu'Emscripten nous fournit. <br><br><h3>  Erreurs contraignantes </h3><br>  En g√©n√©ral, c'est tout, mais lorsque vous d√©marrez le d√©veloppement, des erreurs de liaison vous attendent.  Ils ressemblent √† ceci: <br><br><img src="https://habrastorage.org/webt/bi/jy/uj/bijyujpafhw1vljtsptpvuzxztw.png"><br><br>  Emscripten essaie de nous aider et d'expliquer ce qui ne va pas.  Si tout cela est r√©sum√©, vous devez vous assurer qu'elles co√Øncident (il est facile de sceller et d'obtenir une erreur de liaison): <br><br><ul><li>  Noms </li><li>  Les types </li><li>  Nombre de param√®tres </li></ul><br>  La syntaxe Embind est inhabituelle non seulement pour les fournisseurs frontaux, mais aussi pour les personnes qui traitent avec C ++.  Il s'agit d'une sorte de DSL dans laquelle il est facile de se tromper, il faut suivre cela.  En parlant d'interfaces, lorsque vous impl√©mentez une sorte d'interface en JavaScript, il est n√©cessaire qu'elle corresponde exactement √† ce que vous d√©crivez dans votre contrat. <br><br>  Nous avons eu un cas int√©ressant.  Mon coll√®gue Jura, qui √©tait impliqu√© dans le projet c√¥t√© C ++, a utilis√© Extend pour tester ses modules.  Ils travaillaient parfaitement pour lui, alors il les a commis et me les a transmis.  J'ai utilis√© un outil pour int√©grer ces modules dans un projet JS.  Et ils ont cess√© de travailler pour moi.  Lorsque nous l'avons compris, il s'est av√©r√© que lors de la liaison dans les noms des fonctions, nous avons obtenu une faute de frappe. <br><br>  Comme son nom l'indique, Extend est une extension de l'interface, donc si vous l'avez scell√©e quelque part, Extend ne g√©n√©rera pas d'erreur, il d√©cidera que vous venez d'ajouter une nouvelle m√©thode, et c'est tr√®s bien. <br><br>  Autrement dit, il masque les erreurs de liaison jusqu'√† ce que la m√©thode elle-m√™me soit appel√©e.  Je sugg√®re d'utiliser Implement dans tous les cas o√π cela vous convient, car il v√©rifie imm√©diatement l'exactitude de l'interface transmise.  Mais si vous avez besoin d'Extend, vous devez couvrir avec des tests l'appel de chaque m√©thode afin de ne pas le g√¢cher. <br><br><h3>  √âtendre et ES6 </h3><br>  Un autre probl√®me avec Extend est qu'il ne prend pas en charge les classes ES6.  Lorsque vous h√©ritez d'un objet d√©riv√© d'une classe ES6, Extend s'attend √† ce que toutes les propri√©t√©s soient √©num√©rables, mais pas avec ES6.  Les m√©thodes sont dans le prototype et elles ont une √©num√©ration: false.  J'utilise une b√©quille comme celle-ci, dans laquelle je passe en revue le prototype et allume √©num√©rable: true: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enumerateProto</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.getOwnPropertyNames(obj.prototype) .forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">prop</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty(obj.prototype, prop, {<span class="hljs-attr"><span class="hljs-attr">enumerable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) ) }</code> </pre><br>  J'esp√®re qu'un jour je pourrai m'en d√©barrasser, car il est question dans la communaut√© Emscripten d'am√©liorer le support pour ES6. <br><br><h3>  RAM </h3><br>  En parlant de C ++, on ne peut s'emp√™cher de mentionner la m√©moire.  Lorsque nous avons tout v√©rifi√© sur une vid√©o de qualit√© SD, tout allait bien avec nous, cela a fonctionn√© parfaitement!  D√®s que nous avons fait le test FullHD, il y avait un manque d'erreur de m√©moire.  Peu importe, il y a l'option TOTAL_MEMORY, qui d√©finit la valeur de m√©moire de d√©part pour le module.  Nous avons fait un demi-gigaoctet, tout va bien, mais c'est en quelque sorte inhumain pour les utilisateurs, car nous r√©servons la m√©moire √† tout le monde, mais tout le monde n'a pas d'abonnement au contenu FullHD. <br><br>  Il existe une autre option - ALLOW_MEMORY_GROWTH.  Il vous permet de d√©velopper la m√©moire <br>  progressivement au besoin.  Cela fonctionne comme ceci: Emscripten par d√©faut donne au module 16 m√©gaoctets pour le fonctionnement.  Lorsque vous les avez tous utilis√©s, une nouvelle m√©moire est allou√©e.  Toutes les anciennes donn√©es y sont copi√©es et vous avez toujours la m√™me quantit√© d'espace pour les nouvelles.  Cela se produit jusqu'√† ce que vous atteigniez 4 Go. <br><br>  Supposons que vous ayez allou√© 256 m√©gaoctets de m√©moire, mais vous savez avec certitude que vous pensiez que votre application en a suffisamment 192. Le reste de la m√©moire sera alors utilis√© de mani√®re inefficace.  Vous l'avez mis en surbrillance, vous l'avez pris √† l'utilisateur, mais vous n'en faites rien.  Je voudrais en quelque sorte √©viter cela.  Il y a une petite astuce: nous commen√ßons √† travailler avec la m√©moire augment√©e d'une fois et demie.  Ensuite, dans la troisi√®me √©tape, nous atteignons 192 m√©gaoctets, et c'est exactement ce dont nous avons besoin.  Nous avons r√©duit la consommation de m√©moire par ce reste et √©conomis√© l'allocation de m√©moire inutile, et plus, plus cela prend de temps.  Par cons√©quent, je recommande d'utiliser ces deux options ensemble. <br><br><h3>  Injection de d√©pendance </h3><br>  Il semblerait que c'√©tait tout, mais le r√¢teau est all√© un peu plus.  Il y a un probl√®me avec l'injection de d√©pendance.  Nous √©crivons la classe la plus simple dans laquelle une d√©pendance est n√©cessaire. <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(httpClient) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.httpClient = httpClient } }</code> </pre><br>  Par exemple, nous transmettons notre client HTTP √† notre application.  Nous √©conomisons dans la propri√©t√© de classe.  Il semblerait que tout fonctionnera bien. <br><br><pre> <code class="javascript hljs">Module.App.extend( ‚Ä≥App‚Ä≥, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> App(client) )</code> </pre><br>  Nous h√©ritons de l'interface C ++, cr√©ons d'abord notre objet, lui transmettons la d√©pendance, puis h√©ritons.  Au moment de l'h√©ritage, Emscripten fait quelque chose d'incroyable avec l'objet.  Il est plus facile de penser qu'il tue un ancien objet, en cr√©e un nouveau bas√© sur son mod√®le et y fait glisser toutes les m√©thodes publiques.  Mais en m√™me temps, l'√©tat de l'objet est perdu et vous obtenez un objet qui n'est pas form√© et ne fonctionne pas correctement.  La r√©solution de ce probl√®me est assez simple.  Il est n√©cessaire d'utiliser un constructeur qui fonctionne apr√®s la phase d'h√©ritage. <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ _construct(httpClient) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.httpClient = httpClient <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._parent._construct.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) } }</code> </pre><br>  Nous faisons presque la m√™me chose: nous stockons la d√©pendance dans le champ de l'objet, mais c'est l'objet qui s'est av√©r√© apr√®s l'h√©ritage.  Nous ne devons pas oublier de transmettre l'appel du constructeur √† l'objet parent, qui se trouve du c√¥t√© C ++.  La derni√®re ligne est un analogue de la m√©thode super () dans ES6.  Voici comment l'h√©ritage se produit dans ce cas: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> appConstr = Module.App.extend( ‚Ä≥App‚Ä≥, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> App() ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> app = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> appConstr(client)</code> </pre><br>  Tout d'abord, nous h√©ritons, puis cr√©ons un nouvel objet dans lequel la d√©pendance est d√©j√† pass√©e, et cela fonctionne. <br><br><h3>  Truc de pointeur </h3><br>  Un autre probl√®me est de passer des objets par pointeur de C ++ vers JavaScript.  Nous avons d√©j√† fait un client HTTP.  Par souci de simplicit√©, nous avons manqu√© un d√©tail important. <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url)</span></span></span></span></code> </pre><br>  La m√©thode renvoie imm√©diatement la valeur, c'est-√†-dire qu'il s'av√®re que la demande doit √™tre synchrone.  Mais apr√®s tout, AJAX demande AJAX et qu'ils sont asynchrones, donc dans la vraie vie, la m√©thode ne retournera rien, ou nous pouvons retourner l'ID de la demande.  Mais afin d'avoir quelqu'un pour renvoyer la r√©ponse, nous passons l'√©couteur comme deuxi√®me param√®tre, dans lequel il y aura des rappels √† partir de C ++. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, Listener listener)</span></span></span></span></code> </pre><br>  Dans JS, cela ressemble √† ceci: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, listener</span></span></span><span class="hljs-function">) </span></span>{ fetch(url).then(result) =&gt; { listener.onResult(result) }) }</code> </pre><br>  Nous avons une fonction get qui prend cet objet √©couteur.  Nous commen√ßons le t√©l√©chargement du fichier et raccrochons le rappel.  Lorsque le fichier est t√©l√©charg√©, nous extrayons la fonction souhait√©e de l'√©couteur et lui transmettons le r√©sultat. <br><br>  Il semblerait que le plan soit bon, mais lorsque la fonction get se terminera, toutes les variables locales seront d√©truites et avec eux les param√®tres de la fonction, c'est-√†-dire que le pointeur sera d√©truit et que runtime emscripten d√©truira l'objet du c√¥t√© C ++. <br><br>  Par cons√©quent, lorsqu'il s'agit d'appeler la ligne listener.onResult (result), l'√©couteur n'existera plus et lors de l'acc√®s, une erreur d'acc√®s √† la m√©moire se produira et entra√Ænera le blocage de l'application. <br><br>  Je voudrais √©viter cela, et il y a une solution, mais il a fallu plusieurs semaines pour la trouver. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, listener</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> listenerCopy = listener.clone() fetch(url).then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function">) =&gt;</span></span> { listenerCopy.onResult(result) listenerCopy.delete() }) }</code> </pre><br>  Il s'av√®re qu'il existe une m√©thode pour cloner un pointeur.  Pour une raison quelconque, il n'est pas document√©, mais il fonctionne correctement et vous permet d'augmenter le nombre de r√©f√©rences dans le pointeur Emscripten.  Cela nous permet de le suspendre dans une fermeture, puis, lorsque nous lan√ßons notre rappel, notre √©couteur sera accessible par ce pointeur et nous pourrons travailler selon nos besoins. <br><br>  La chose la plus importante est de ne pas oublier de supprimer ce pointeur, sinon cela entra√Ænera une erreur de fuite de m√©moire, ce qui est tr√®s mauvais. <br><br><h3>  √âcriture rapide dans la m√©moire </h3><br>  Lorsque nous t√©l√©chargeons des vid√©os, ce sont des quantit√©s relativement importantes d'informations, et je voudrais r√©duire la quantit√© de donn√©es de copie dans les deux sens afin d'√©conomiser de la m√©moire et du temps.  Il existe une astuce pour √©crire une grande quantit√© d'informations directement dans la m√©moire de WebAssembly √† partir de JavaScript. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(‚Ä¶); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> size = newData.byteLength; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ptr = Module._malloc(size); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> memory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>( Module.buffer, ptr, size ); memory.set(newData);</code> </pre><br>  newData est nos donn√©es sous forme de tableau typ√©.  Nous pouvons prendre sa longueur et demander l'allocation de m√©moire de la taille dont nous avons besoin depuis le module WebAssembly.  La fonction malloc nous renverra un pointeur, qui est juste l'index du tableau qui contient toute la m√©moire dans WebAssembly.  Du c√¥t√© de JavaScript, il ressemble √† un ArrayBuffer. <br><br>  √Ä l'√©tape suivante, nous allons couper une fen√™tre dans ce ArrayBuffer de la bonne taille √† partir d'un certain endroit et y copier nos donn√©es.  Malgr√© le fait que l'op√©ration set ait une s√©mantique de copie, quand j'ai regard√© cette section dans le profileur, je n'ai pas vu un long processus.  Je pense que le navigateur optimise cette op√©ration √† l'aide de la s√©mantique de mouvement, c'est-√†-dire transf√®re la propri√©t√© de la m√©moire d'un objet √† un autre. <br><br>  Et dans notre application, nous comptons √©galement sur la s√©mantique de d√©placement pour √©conomiser la copie de m√©moire. <br><br><h3>  Adblock </h3><br>  Un probl√®me int√©ressant, plut√¥t, sur le changement, avec Adblock.  Il s'av√®re qu'en Russie, tous les bloqueurs populaires re√ßoivent un abonnement √† RU Adlist, et il a une telle r√®gle merveilleuse qui interdit de t√©l√©charger WebAssembly √† partir de sites tiers.  Par exemple, avec un CDN. <br><br><img src="https://habrastorage.org/webt/os/wt/kg/oswtkgtaeovfuk9r4d-gehdwdwe.png"><br><br>  La solution n'est pas d'utiliser le CDN, mais de tout stocker sur votre domaine (cela ne nous convient pas).  Ou renommez le fichier .wasm pour qu'il ne corresponde pas √† cette r√®gle.  Vous pouvez toujours aller sur le forum de ces camarades et essayer de les convaincre de supprimer cette r√®gle.  Je pense qu'ils se justifient en combattant les mineurs de cette fa√ßon, bien que je ne sache pas pourquoi les mineurs ne peuvent pas deviner de renommer le fichier. <br><br><h2>  La production </h2><br>  En cons√©quence, nous sommes entr√©s en production.  Oui, ce n'√©tait pas facile, cela a pris 8 mois et je veux me demander si √ßa valait le coup.  √Ä mon avis - cela valait la peine: <br><br><h3>  Pas besoin d'installer </h3><br>  Nous avons obtenu que notre code soit livr√© √† l'utilisateur sans installer de programme.  Lorsque nous avions un plug-in de navigateur, l'utilisateur devait le t√©l√©charger et l'installer, et c'est un √©norme filtre pour la distribution de technologies.  Maintenant, l'utilisateur regarde simplement la vid√©o sur le site et ne comprend m√™me pas que toute une machine fonctionne sous le capot, et que tout y est compliqu√©.  Le navigateur t√©l√©charge simplement un fichier suppl√©mentaire avec le code, comme une image ou .css. <br><br><h3>  Base de code unifi√©e et d√©bogage sur diff√©rentes plateformes </h3><br>  Dans le m√™me temps, nous avons pu maintenir notre base de code unique.  Nous pouvons tordre le m√™me code sur diff√©rentes plates-formes et il est arriv√© √† plusieurs reprises que des bogues invisibles sur l'une des plates-formes apparaissent sur l'autre.  Et ainsi, nous pouvons d√©tecter des bugs cach√©s avec diff√©rents outils sur diff√©rentes plateformes. <br><br><h3>  Lib√©ration rapide </h3><br>  Nous avons obtenu une version rapide, car nous pouvons √™tre publi√©s comme une simple application Web et mettre √† jour le code C ++ √† chaque nouvelle version.  Cela ne se compare pas √† la fa√ßon de publier de nouveaux plugins, une application mobile ou une application SmartTV.  La sortie ne d√©pend que de nous: quand on veut, alors elle sortira. <br><br><h3>  R√©troaction rapide </h3><br>  Et cela signifie une r√©troaction rapide: si quelque chose ne va pas, nous pouvons d√©couvrir pendant la journ√©e qu'il y a un probl√®me et y r√©pondre. <br><br>  Je pense que tous ces probl√®mes valaient ces avantages.  Tout le monde n'a pas d'application C ++, mais si vous en avez une et que vous voulez qu'elle soit dans le navigateur - WebAssembly est un cas d'utilisation √† 100% pour vous. <br><br><h2>  O√π postuler </h2><br>  Tout le monde n'√©crit pas en C ++.  Mais non seulement C ++ est disponible pour WebAssembly.  Oui, il s'agit historiquement de la toute premi√®re plate-forme encore disponible dans asm.js, une des premi√®res technologies de Mozilla.  Soit dit en passant, il a donc de tr√®s bons outils, comme  ils sont plus anciens que la technologie elle-m√™me. <br><br><h3>  Rouille </h3><br>  Le nouveau langage Rust, √©galement d√©velopp√© par Mozilla, rattrape et d√©passe d√©sormais le C ++ en termes d'outils.  Tout va au point qu'ils feront le processus de d√©veloppement le plus cool pour WebAssembly. <br><br><h3>  Lua, Perl, Python, PHP, etc. </h3><br>  Presque tous les langages interpr√©t√©s sont √©galement disponibles dans WebAssembly, car leurs interpr√®tes sont √©crits en C ++, ils ont simplement √©t√© compil√©s dans WebAssembly et vous pouvez maintenant tordre PHP dans un navigateur. <br><br><h3>  Allez </h3><br>  Dans la version 1.11, ils ont fait une version b√™ta de la compilation dans WebAssembly, dans 2.0, ils promettent un support de publication.  Leur prise en charge est apparue plus tard, car WebAssembly ne prend pas en charge le garbage collector et Go est un langage √† m√©moire g√©r√©e.  Ils ont donc d√ª faire glisser leur garbage collector sous WebAssembly. <br><br><h3>  Kotlin / Native </h3><br>  √Ä propos de la m√™me histoire avec Kotlin.  Leur compilateur a un support exp√©rimental, mais ils devront √©galement faire quelque chose avec le garbage collector.  Je ne sais pas quel est le statut. <br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Graphiques 3D </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä quoi d'autre pouvez-vous penser? </font><font style="vertical-align: inherit;">La premi√®re chose qui tourne dans le langage, ce sont les applications 3D. </font><font style="vertical-align: inherit;">Et, en effet, historiquement, asm.js et WebAssembly ont commenc√© avec le portage de jeux sur les navigateurs. </font><font style="vertical-align: inherit;">Et il n'est pas surprenant que tous les moteurs populaires soient d√©sormais export√©s vers WebAssembly.</font></font><br><br><img src="https://habrastorage.org/webt/lt/u2/7q/ltu27qaab_yjbryhnm_ayf-edsa.png"><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Traitement des donn√©es localement </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez √©galement penser √† traiter les donn√©es des utilisateurs directement dans son navigateur, sur son ordinateur: prendre une image t√©l√©charg√©e ou √† partir d'un appareil photo, enregistrer du son, traiter une vid√©o. </font><font style="vertical-align: inherit;">Lisez l'archive t√©l√©charg√©e par l'utilisateur ou r√©cup√©rez-la vous-m√™me √† partir d'un tas de fichiers et t√©l√©chargez-la sur le serveur en une seule demande.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> R√©seaux de neurones </font></font></h3><br><br><img src="https://habrastorage.org/webt/2u/mi/dz/2umidzjddihmiikdgktwjdk4hpe.png"><br><br>         . , ,      ,     ,         . , ,        ;   ‚Äî   . <br><br><img src="https://habrastorage.org/webt/0q/-e/0s/0q-e0sqshcd_t-p4ioyhtoe0z-k.png"><br><br> ,  Google Chrome,      ,    WebAssembly-.     npm-  ,   Wasm,     JS.      , ++  -  ‚Äî    . <br><br>      HunSpell ‚Äî      Wasm . <br><br><h3>  </h3><br>      ‚Äî ¬´   ¬ª.     , -        ,       ‚Äî  OpenSSL.       WebAssembly. OpenSSL ‚Äî   ,   ,    . <br><br><h3>     </h3><br>  use case    wotinspector.com.     World of Tanks.     ,  ,    ,   ,  ,      . <br><br>   ‚Äî      .      ,       ,   .    ,  ,  -  ++,    WebAssembly,            (   ,        ). <br><br>        .  ,     ,     .       .     ,     ,      ,   ,      .        .    . <br><br><h3>  </h3><br>      ,      , ++. ,  FFmpeg,      .      ,   ffmpeg.          .     , ,     ,      ,     . <br><br><img src="https://habrastorage.org/webt/aa/tu/u8/aatuu8b5uzbxmnhv_8mjb93jcxa.png"><br><br>     ‚Äî            .   OpenCV ‚Äî    ,   WebAssembly,        .    PDF.      SQLite,    SQL.  SQLite  WebAssembly   Emscripten,      . <br><br><h3> Node.js </h3><br><br><img src="https://habrastorage.org/webt/dl/mf/tn/dlmftnxe8bjvt-ys-jyyy-aunde.png"><br><br>       WebAssembly,    Node.js. ,   Sass ‚Äî  css.     Ruby,       ++ ( libsass).          ,       Webpack',       Node.js.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">node-sass</a>   ,  JS-   . <br><br>  ,         ,      .       .    : <br><br><img src="https://habrastorage.org/webt/bv/s0/rp/bvs0rpy6naa9-dhac6zingbv-cw.png"><br><br>    ,     node-sass    100      .     ,        ( ) .  WebAssembly   :       ,     WebAssembly    . <br><br>                    Node.    ,   WebAssembly     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">libsass-asm</a> .   ,       .      WebAssembly   ‚Ä¶ <br><br><h3>   </h3><br>    Figma ‚Äî    web-.   -   Sketch,     ,     .    ++ (    ),     asm.js.   ,    . <br><br><img src="https://habrastorage.org/webt/ht/ad/2t/htad2t3hmsfx_txwjfhk-_qlh2w.png"><br><br>   WebAssembly,    ,      3 .     ,         . <br><br>     Visual Studio Code,   ,    Electron,        ,          ,   Node-sass. ,     Node,            . ,  ,     ,      WebAssembly. <br><br><h3>     </h3><br><br><img src="https://habrastorage.org/webt/tz/qg/2a/tzqg2a7sw01qlqnvwjcjzkxqkyw.png"><br><br>        ‚Äî AutoCAD.   30 ,    ++,     .      ,    ,              -  JavaScript,    ,      .    WebAssembly <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AutoCAD   -</a> ,     5      . <br><br>   ,    , ,   , ,       ,    , ,    .   FFMpeg ‚Äî   ,     ‚Äî QEMU. ,     ,       KVM,        . <br><br><img src="https://habrastorage.org/webt/zq/3c/aj/zq3cajq6z-ftdftt0a1bnveqj1m.png"><br><br>   2011   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> QEMU  </a> .  ,             .  , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://bellard.org/jslinux/vm.html%3Furl%3D">Linux  </a> ,  Linux-,     , -  . <br><br>   ,    .   bash,    ,     Linux.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://bellard.org/jslinux/vm.html%3Furl%3D">  ‚Äî  GUI</a> .       .  ,    ,        ‚Ä¶ <br><br><img src="https://habrastorage.org/webt/jf/zc/bo/jfzcbori9ee4oah-1nmumj8ebqk.png"><br><br> ,     ,  - . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://bellard.org/jslinux/vm.html%3Furl%3D"> Windows 2000</a> ,  ,   18  ,       .     ,     Chrome ( FireFox). <br><br>   ,  WebAssembly ,    ,   ,      ,     . <br><br><h2>      </h2><br>       ,       WebAssembly. ,     ‚Äî  ,  .   ‚Äî  ,       . <br><br><img src="https://habrastorage.org/webt/ea/ls/ak/ealsak2klb2rgvobxmirs1rn0_s.png"><br><br>  ,     C++      web-.   ,  ,       ‚Äî      .    ‚Äî  ,      ,      ,     . <br><br>  ,      .   ,    C++,      JavaScript,        .     ,         C++.              ,       JS  C++,      . <br><br>         ‚Äî   . <br><br><img src="https://habrastorage.org/webt/fx/nj/wb/fxnjwbotpkneisrtmlze8-0afdy.png"><br><br><h2> CI Pipeline </h2><br>      ?    JS-   ,        Webpack.      ,   ,  (     ),       JS.    webpack   watch,  ,          . <br><br><img src="https://habrastorage.org/webt/zv/s_/r4/zvs_r45efsroktebku2lrdmuv9e.png"><br><br><h2>  </h2><br>  ,     .  ,  ,    . <br><br>   Chrome   DevTools,      Sources   wasm-.     (    - ), ,  ,      . <br><br><img src="https://habrastorage.org/webt/ea/ir/8u/eair8uahusoyylejgtccro0g1-a.png"><br><br>    ,        ,      : ¬´,     , ,    ,  ,   !¬ª.  ,     embedded-,    ,    -     . <br><br>   :     -g4  wast-   ,     . <br><br><img src="https://habrastorage.org/webt/0k/6w/af/0k6wafnm3pp62o-a5t8dcoxivxy.png"><br><br>   ,      100  (  FAR).  ‚Äî  ,       Chrome. E:/_work/bfg/bytefrog/‚Ä¶ ‚Äî    .    ,      ++     .   ,    SourceMap! <br><br><h2> SourceMap </h2><br>  ,     . <br><ul><li>    Firefox. </li><li> --sourcemap-base=http://localhost  ,    SourceMap   -,    . </li><li>     HTTP. </li><li>       . </li><li>  Windows    ¬´:¬ª  .     . </li></ul><br><br>     . CMake        ,        URL  -.    :  wast-       ,    . ,     . <br><br>  ,    : <br><br><img src="https://habrastorage.org/webt/ev/hn/fo/evhnfovmbp4hdynewi_r6buhx_a.png"><br><br>  ++   .    !   ,   ,  stack trace,      .  ,     wasm-  stack trace,   ,   , , ,  . <br><br><img src="https://habrastorage.org/webt/ql/zi/x8/qlzix8vqcrbdziehrmmrmq4uz0a.png"><br><br>  ,      ‚Äî SourceMap     .  ,        ,    .           ,      . <br><br><img src="https://habrastorage.org/webt/vk/e4/vk/vke4vkmnpcbp9gm8tuac-92xany.png"><br><br>             ¬´var0¬ª. <br><br><img src="https://habrastorage.org/webt/yh/rc/xx/yhrcxxqcvj0upcy6negdcw0b9c0.png"><br><br> ,           . ,      SourceMap,       ,   . <br><br><h2>  </h2><br>     .     Chrome,   Firefox.  Firefox  ‚Äî  ¬´¬ª ,    ,      . <br><br><img src="https://habrastorage.org/webt/bv/va/x1/bvvax1w0kvo4gsmx7ry0bgbekhe.png"><br><br> Chrome    ( ,  ,  Mangled  ), ,  ,  ,    . <br><br><img src="https://habrastorage.org/webt/gv/jh/rp/gvjhrpyqjxyvsyq4xjigmdmwxa8.png"><br><br><h2>  </h2><br>   .     ,   : <br><br><ul><li> .     runtime,   .   ++      Rust  Go. </li><li>    JS ‚Äî Wasm.     ,         JS  Wasm.      -,    ,    .      ,    . </li><li>  .  ,   ,     ,       . </li><li> Wasm   . Wasm  ,       JS.  WebAssembly   ,       . </li><li>        JS. </li></ul><br><br>    :    . <br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">wasp_cpp_bench</a> </li><li> Chrome 65.0.3325.181 (64-bit) </li><li> Core i5-4690 </li><li> 24gb ram </li><li> 5 ;  max  min;  </li></ul><br><br>   .         JS ‚Äî  ,     . <br><br><img src="https://habrastorage.org/webt/sg/e7/to/sge7toujmxycrhznogviscz94dy.png"><br><br> ++,   ,   -  .      Grayscale.   C++    ,   .     ( ),   ,    JS. ,  ,       ,   ++,   . <br><h2>     </h2><br>   Sentry,      ‚Äî     wasm. ,   traceKit,    Sentry ‚Äî Raven, ‚Äî    ,    ,  wasm .   , , ,    pull request,     npm install  JS-. <br><br><img src="https://habrastorage.org/webt/rd/vm/-z/rdvm-zijheakjsktoubausmmyc8.png"><br><br>    .   production,     ,   .    debug-,     ,    : <br><br><img src="https://habrastorage.org/webt/gn/e_/_t/gne__tfliahfwe1sfndiid2tmyq.png"><br><br><h2>  </h2><br><ul><li> WebAssembly     ,     . </li><li>     ‚Äî .     8 ,           C++,   ,    . </li><li>   ,      ,   WebAssembly ‚Äî     . </li><li>  ‚Äî   JS.  JS-      ,    ¬´¬ª   ,     ,     . </li></ul><br><br>    , : <br><ul><li>  Emscripten  Embind.     . </li><li>   -   Emscripten ‚Äî   .  ,    ,     3000      Emscripten. </li><li>     Sentry. </li><li>   Firefox. </li></ul><br><br>  Merci de votre attention!      . <br><br><img src="https://habrastorage.org/webt/2h/qu/au/2hquauawvppoc-iu5un4wgevnvo.png"><br><br><blockquote>        HolyJS,  : <b>24-25   </b>   <b>HolyJS</b> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>      (,   Node.js Ryan Dahl!),      ‚Äî   1   . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr441140/">https://habr.com/ru/post/fr441140/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr441130/index.html">Performance du site √©quilibr√©e. Partie 1: Strat√©gie</a></li>
<li><a href="../fr441132/index.html">Pour que Roskomnadzor ne vienne pas SOUDAINEMENT</a></li>
<li><a href="../fr441134/index.html">√âmotions, travail ind√©pendant</a></li>
<li><a href="../fr441136/index.html">Stockage √† long terme des m√©triques Prometheus (Alexey Palazhchenko, Percona)</a></li>
<li><a href="../fr441138/index.html">Solutions de chat en temps r√©el vs plates-formes de chat - Faites votre choix</a></li>
<li><a href="../fr441142/index.html">12 points de croissance de conversion, ou du contenu qui se vend vraiment</a></li>
<li><a href="../fr441146/index.html">R√©seaux sans fil industriels: lequel choisir?</a></li>
<li><a href="../fr441148/index.html">Comment g√©rer correctement les erreurs: le silence n'est pas toujours bon</a></li>
<li><a href="../fr441150/index.html">Premi√®re introduction au protocole HTTP en √©crivant le serveur Web Java le plus simple</a></li>
<li><a href="../fr441152/index.html">Comment minimiser les erreurs lors de l'int√©gration avec des services externes: l'exp√©rience d'un courtier en ligne</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>