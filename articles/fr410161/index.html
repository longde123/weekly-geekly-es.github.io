<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§≤üèΩ üßñüèø üõ°Ô∏è D√©veloppement logiciel pour le contr√¥le moteur DSP TMS320F28 üßõüèª üôÜ üë©üèø‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans mon premier article, j'ai parl√© de cette famille de contr√¥leurs; plus d'une douzaine de personnes m'ont √©crit en PM avec des questions √† ce sujet...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©veloppement logiciel pour le contr√¥le moteur DSP TMS320F28</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/410161/">  Dans mon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">premier article,</a> j'ai parl√© de cette famille de contr√¥leurs; plus d'une douzaine de personnes m'ont √©crit en PM avec des questions √† ce sujet, bien que ce ne soit pas le sujet de l'article.  Les gens ne voulaient cat√©goriquement pas aller sur Google, parlant du manque d'informations.  J'ai √©t√© un peu surpris et j'ai d√©cid√© de v√©rifier - en effet, en russe, il n'y a pratiquement rien sur la famille C2000 (dans le contexte de l'AVR, STM), et surtout, il n'y a pas de guides de d√©marrage clairs.  Les informations peuvent √™tre trouv√©es en anglais, mais l√† encore ce n'est pas suffisant.  Pour moi, c'est quelque peu surprenant, √©tant donn√© que cette famille n'a pas quelques ann√©es.  Par cons√©quent, il a √©t√© d√©cid√© au mieux de leur capacit√© d'influencer la situation. <br><br>  Qui a besoin de ces contr√¥leurs en principe ... Voulez-vous assembler un onduleur de soudage?  Alimentation sans coupure?  Lisseur de galvanoplastie?  Fr√©quence?  Un onduleur pour les √©nergies alternatives?  Machine CNC?  Si au moins un point vous concerne, l'article vous est d√©di√©! <br><br>  D'autres lecteurs seront √©galement int√©ress√©s √† en apprendre davantage sur le "nouveau-ancien" contr√¥leur, pourquoi il est n√©cessaire et comment travailler avec lui.  Cette famille est tr√®s simple (beaucoup plus simple que STM, LPC et autres Cortex), les pierres sont faciles √† acheter (il y a aussi Ali), elles vous permettent de mettre en ≈ìuvre des solutions industrielles tr√®s fiables, sur leur base vous pouvez construire presque n'importe quel syst√®me de contr√¥le industriel. <br><br>  Avez-vous d√©j√† d√©cid√© que ce contr√¥leur est votre r√™ve et √™tes-vous pr√™t √† vous lancer dans la bataille?  Ensuite, nous achetons pour 17 $ le d√©bogage suivant de F28027-LaunchPad: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ed/cd/cv/edcdcvjwp5ewu_jl0jbnwwzsfyc.png"></div><br>  As-tu achet√©?  Maintenant, vous pouvez vous battre.  Si la question se pose de savoir o√π acheter "mieux" et "moins cher", alors nous allons au magasin officiel.  Nous allons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> et voyons le prix de 17 $.  Pour ce montant, vous recevrez des frais de d√©bogage originaux et une livraison par messagerie √† domicile.  J'ai command√© une fois en Chine pour la livraison, il s'est av√©r√© 16 $ et c'est avec une remise et un coupon, ainsi qu'un voyage "bonus" au bureau de poste.  Par cons√©quent, je recommande que ce soit l'officiel.  C'est parti! <br><a name="habracut"></a><br><h2>  Pr√©sentation de la s√©rie C2000 </h2><br>  Vous pouvez lire le plus en d√©tail sur tout sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">site officiel</a> , bien s√ªr, en anglais.  Je vais en parler bri√®vement et exprimer mes r√©flexions sur l'application.  Veuillez noter que ce ne sont que mes sp√©culations et ils ne pr√©tendent pas la v√©rit√©. <br><br>  Tout d'abord, quelques mots sur le C2000 en g√©n√©ral.  Les caract√©ristiques distinctives de la famille, associ√©es √† son objectif principal de contr√¥le moteur, sont la pr√©sence de HRPWM (PWM haute pr√©cision) et CLA (coprocesseur).  Ce dernier est vraiment absent dans le plus jeune Piccolo TMS320F2802x, mais il n'y est pas n√©cessaire, l'essentiel est le HRPWM en place.  Qu'est-ce que c'est ... HRPWM lui-m√™me est un PWM r√©gulier, il n'est que tr√®s pr√©cis et le temps d'enregistrement et de r√©glage pour un nouveau cycle de service est beaucoup plus rapide.  Cela permet par exemple d'obtenir un sinus parfaitement form√© dans un onduleur DC / AC ou de piloter des moteurs pas √† pas dans une machine CNC avec une tr√®s grande pr√©cision. <br><br>  CLA est essentiellement un c≈ìur √† part enti√®re, mais il n'a pas acc√®s aux p√©riph√©riques, uniquement au c≈ìur principal et √† la m√©moire.  Il sert √† d√©charger le noyau principal de l'informatique.  Ce coprocesseur dig√®re tr√®s facilement et naturellement les donn√©es flottantes, ce qui est important lors de la mise en ≈ìuvre de divers algorithmes, filtres, etc. <br><br><img src="https://habrastorage.org/webt/5o/ui/lh/5ouilh691kdhoflkcrtcs4tmwqy.png"><br><br>  Je vais parler de deux familles principales que vous rencontrerez probablement: <br><br><ul><li>  <b>Piccolo.</b>  Les contr√¥leurs les plus jeunes, mais aussi les moins chers.  Mon TMS320F28027 est de cette famille.  Si vous d√©cidez de d√©velopper l'√©lectronique de puissance √† des fins commerciales, ce seront vos pierres principales - elles sont assez bon march√©, payantes (LQFP, QFN, TSSOP) et vous permettent de mettre en ≈ìuvre presque tout.  Par exemple, leurs performances sont suffisantes pour un PFC biphas√©, un onduleur pour panneaux solaires, un convertisseur de fr√©quence jusqu'√† 10 kW avec contr√¥le vectoriel, etc.  Comme vous pouvez le voir, il s'agit d'un segment de produits achet√©s par des particuliers et des entreprises, ce qui signifie qu'il est tr√®s demand√©.  Les principales limitations sont la fr√©quence de 60 MHz, un nombre limit√© de canaux PWM. </li><li>  <b>Delfino.</b>  Id√©ologiquement, ce sont tous les m√™mes Piccolo, uniquement gonfl√©s au meldonium.  Dans ce qu'elle exprime - une fr√©quence allant jusqu'√† 200 MHz, dans les pierres plus anciennes, il y a d√©j√† 2 c≈ìurs √† part enti√®re + 2 coprocesseurs, de gros bo√Ætiers et, par cons√©quent, de nombreuses jambes, de nombreux canaux PWM, de nombreux ADC et, en g√©n√©ral, beaucoup.  Autrement dit, dans les pierres plus anciennes, nous avons 4 c≈ìurs avec une fr√©quence de 200 MHz, une performance de 800 MIPS, ce qui est assez impressionnant.  Une telle puissance peut √™tre utilis√©e de diff√©rentes mani√®res, mais l'application principale est des syst√®mes algorithmiquement complexes, par exemple, le redresseur de Vienne ou autre chose.  √âgalement sur un tel contr√¥leur, vous pouvez impl√©menter l'ensemble du syst√®me de contr√¥le d'une machine CNC, par exemple le fraisage ou le d√©coupage √† la flamme du m√©tal. </li></ul><br><h2>  Finalisation du tableau de d√©bogage </h2><br>  Lorsque vous recevez une bo√Æte avec une carte de d√©bogage, vous y trouverez le quartz et les condensateurs manquants.  Ils ne sont pas n√©cessaires, mais il est conseill√© de se doper.  Je n'ai plus de quartz dans le HC-49, j'ai donc d√ª emprunter √† un ami.  Il choisit AVR et STM, il n'a donc trouv√© que 8 MHz.  Soud√©.  J'ai ajout√© 22 condensateurs pF de l'ancienne m√©moire, comme je l'ai fait sur m√©ga √† l'√©cole. <br><br>  Cette solution n'est pas la meilleure et elle est connect√©e √† la configuration PLL.  Le multiplicateur maximum pour PLL est x12 (plus peut √™tre, mais n'est pas recommand√©, et fonctionne de mani√®re tordue).  La fr√©quence maximale est de 60 MHz.  La valeur maximale du diviseur √† la sortie PLL est 3. La fr√©quence du quartz est de 8 MHz.  Je ne peux pas multiplier par 8 par un entier et obtenir 60. Nous recherchons la valeur totale la plus proche, dans ce cas 240. Autrement dit, je multiplierai 8 par 30, puis en divisant par 4 j'obtiendra les 60 MHz convoit√©s, mais le probl√®me est que le multiplicateur PLL x30 est inacceptable , divider / 4 est √©galement indisponible.  Il y a 2 sorties: <br><br><ul><li>  <b>Mauvais:</b> multipliez la fr√©quence de 8 MHz par 7 et divisez par 1 et obtenez 56 MHz.  Vous pouvez multiplier par 8 et obtenir 64 MHz, cela fonctionnera de mani√®re stable, mais dans les deux cas, la fr√©quence n'est pas maximale de 60 MHz.  Pas assez de perfectionnisme, h√©las.  J'ai juste une telle option, soud√© 8 MHz et fait une fr√©quence de 56 MHz. </li><li>  <b>Bon:</b> allez acheter du quartz √† 10 ou 20 MHz (mieux que 10) et multipliez par 6, eh bien, divisez par 1, nous obtenons le pr√©cieux 60 MHz.  Je vis en dehors de la ville et honn√™tement, c'√©tait trop paresseux pour aller dans un magasin local, ce qui n'est pas le fait qu'il y a du quartz √† 10 MHz.  Bien s√ªr, le circuit RC interne et le quartz 8 MHz seront utilis√©s pour la formation, mais dans vos projets futurs, mettez le quartz 10 MHz, pas les mutants mammouths dans le bo√Ætier HC-49. </li></ul><br><h2>  Architecture et fonctionnalit√©s p√©riph√©riques </h2><br>  Tout ce qui se passera ensuite s'applique au contr√¥leur TMS320F28027.  Pour commencer, regardons simplement la structure tir√©e de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fiche technique</a> : <br><br> <a href=""><img src="https://habrastorage.org/webt/sr/da/hb/srdahbswvkrs9zjzbnvevwgqvho.png"></a> <br><br>  La premi√®re chose √† laquelle vous devez faire attention est que la RAM est divis√©e en 3 secteurs: M0, M1 et SARAM.  Les volumes de ces secteurs de m√©moire dans notre cas sont 1k, 1k et 4k.  Il convient de noter que dans ce cas, le mot n'est pas de 8 bits, mais de 16 bits, c'est-√†-dire, dans une forme plus famili√®re, il est de 2 kB + 2 kB + 8 kB.  La particularit√© de ce module est que les secteurs M0 et M1 sont plus rapides que les 8 Ko restants de RAM.  Formellement, vous pouvez le prendre comme cache.  Les secteurs M0 et M1 stockent g√©n√©ralement les donn√©es les plus fr√©quemment utilis√©es, ainsi que les donn√©es les plus critiques pour les performances de la m√©moire.  Par d√©faut, nous pouvons utiliser l'√©diteur de liens pour sp√©cifier quoi et o√π est stock√©, mais je ne soul√®verai pas cette rubrique dans cet article, ici un article s√©par√© est n√©cessaire au moins. <br><br>  La deuxi√®me caract√©ristique importante est que tous les p√©riph√©riques sont cadenc√©s √† partir du bus syst√®me, c'est-√†-dire √† partir de 60 MHz (dans mon cas, 56 MHz).  Par exemple, je vais donner les microcontr√¥leurs STM32, o√π la fr√©quence de base est, par exemple, 180 MHz pour F4, mais les p√©riph√©riques sont cadenc√©s par une s√©rie de diviseurs.  J'appelle cette approche ¬´faux m√©gahertz¬ª pour moi, bien que cela soit tr√®s exag√©r√©.  Par cons√©quent, 60 MHz pour TMS320F28 et 180 MHz pour stm32 ne sont pas si diff√©rents, et si vous vous souvenez de la pr√©sence de CLA, alors 60 + 60 MHz sont au moins comparables.  Il est clair qu'une telle comparaison n'est pas correcte, mais elle montre clairement que non seulement les m√©gahertz en ont marre. <br><br>  Un point √©galement int√©ressant - faites attention √† la structure g√©n√©rale: HRPWM, ADC, comparateurs avec DAC interne, module de traitement de codeur (eCAP) ... Un convertisseur de fr√©quence pr√™t √† l'emploi avec contr√¥le vectoriel √† l'√©tat pur!  C'est l'essence m√™me de cette famille - le minimalisme.  D'une part, la p√©riph√©rie est assez pauvre par rapport √† Cortex, mais d'autre part, il suffit de mettre en ≈ìuvre une r√©ponse en fr√©quence, dc / dc, dc / ac, et un pilote de moteur pas √† pas.  Pour cette raison, travailler avec les contr√¥leurs TMS320F28 est tr√®s simple, compr√©hensible et n'est pas surcharg√© d'actions inutiles.  Mais si vous avez soudainement besoin de 3 UART, et pour eux une paire d'i2c et de 3 SPI suppl√©mentaires, ces contr√¥leurs ne sont certainement pas pour vous - ils ont des t√¢ches diff√©rentes. <br><br><h2>  Environnement de d√©veloppement </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/5v/vc/iv/5vvcivdcbwzulr9uocxmccv-ba0.png"></div><br>  Avez-vous regard√© le logo Splash?  Souviens-toi d'elle.  Si vous d√©cidez de commencer √† utiliser des articles dans le d√©veloppement des h√©ros de l'article, alors ce logiciel vous appartient, et comme vous le voyez, le <b>logiciel s'appelle controlSUITE</b> . <br><br>  Cette application est une collection et une biblioth√®que de tout ce dont vous avez besoin pour d√©velopper un logiciel pour la famille de contr√¥leurs C2000.  L'installation de cette application est la premi√®re chose √† faire et √† voir sa composition, elle contient: <br><br><ul><li>  Description de tous les contr√¥leurs et cartes de d√©bogage existants bas√©s sur eux.  Sources de circuits, cartes de circuits imprim√©s, nomenclatures principalement dans Altium Designer </li><li>  Exemples de circuits et de conception de cartes de circuits imprim√©s </li><li>  Biblioth√®ques de base pour le d√©veloppement de firmware </li><li>  Biblioth√®ques math√©matiques et DSP, y compris pour une utilisation avec CLA </li><li>  Un exemple de projets logiciels pour chaque type de p√©riph√©rique </li><li>  Un grand nombre d'apnouts pour la mise en ≈ìuvre de la plupart des algorithmes de contr√¥le des moteurs, convertisseurs cc / cc, contr√¥leurs MPPT et autres syst√®mes </li><li>  Un ensemble de programmes qui vous permettent de cr√©er un syst√®me de gestion de moteur sans programmation du tout, simplement en utilisant un environnement graphique </li><li>  L'IDE lui-m√™me, qui sera d√©velopp√© </li></ul><br>  Tout ce que j'ai d√©crit ci-dessus est tr√®s bref et modeste.  Il vous faudra quelques semaines pour voir et faire d√©filer au moins en diagonale.  Bien s√ªr, vous n'aurez pas besoin de la plupart de cette quantit√© de donn√©es au d√©but, mais vous devez vous rappeler o√π aller si quelque chose vous est incompr√©hensible et bizarre. <br><br>  Maintenant, nous allons travailler avec l'IDE aujourd'hui, dont la partie graphique est bas√©e sur la c√©l√®bre Eclipse.  Le compilateur n'est pas GCC, mais le sien du Texas, ce qui, √† mon avis, est certainement meilleur que le premier.  Bien que l'on soup√ßonne que cela est compl√®tement dop√©, tout de m√™me gcc.  L'environnement de d√©veloppement s'appelle <b>Code Composer Studio</b> , la version actuelle 7.4. <br><br><h2>  Cr√©ation de projet </h2><br>  Au d√©but, je voulais impl√©menter une t√¢che identique au premier article, c'est-√†-dire dessiner un sinus.  En principe, dans le cadre d'un article, cela aurait pu √™tre fait en laissant derri√®re un cadre un tr√®s grand volume de petites choses, mais comme vous le savez, l'essentiel est pr√©cis√©ment dans les petites choses.  Il existe plusieurs articles sur le TMS sur Internet, mais ils sont tous tr√®s superficiels et se r√©sument au type de ¬´copier ceci et tout fonctionne¬ª, c'est-√†-dire que le processus lui-m√™me et l'id√©ologie ne sont pas du tout pris en compte.  Par cons√©quent, dans le cadre de cet article, nous allons cr√©er un projet, le nettoyer des composants inutiles, configurer le firmware dans la m√©moire flash du contr√¥leur et apprendre √† travailler avec GPIO, et ils sont tr√®s int√©ressants ici. <br><br>  T√©l√©chargez CCS7 depuis le site Web du fabricant, installez et commencez √† cr√©er le projet de la mani√®re habituelle: <i>Fichier ‚Üí Nouveau ‚Üí Projet CCS ...</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wb/v0/jy/wbv0jyccatp8jysn2nckh7qaooc.png"></div><br>  Nous voyons cette fen√™tre et nous devons y s√©lectionner le contr√¥leur qui nous int√©resse, dans mon cas c'est TMS320F28027, indiquer le nom du projet et prescrire le chemin o√π il sera stock√©.  Vous devez d'abord cr√©er un dossier dans lequel le projet sera stock√©.  Le nom du projet et le nom du dossier peuvent ne pas correspondre.  Cliquez sur le bouton <i>Terminer</i> et notre projet est cr√©√©. <br><br>  Vous devez maintenant remplir notre projet avec du contenu et le connecter.  Avant cela, pour am√©liorer la structure du projet, cr√©ez cet ensemble de dossiers: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ee/cg/er/eecgerskm0jeso2ocebvaheeyrc.png"></div><br><ul><li>  <i>inc</i> - un dossier qui contient tous les fichiers d'en-t√™te </li><li>  <i>system_inc</i> - cette section stockera les fichiers d'en-t√™te des biblioth√®ques standard, les fichiers que nous cr√©erons nous-m√™mes, par exemple, main.c sont dans le dossier inc.  Cela ne cassera pas quelque chose sans r√©fl√©chir ni ne supprimera </li><li>  <i>src</i> - dossier avec toutes les sources </li><li>  <i>system_src</i> - dossier avec les fichiers source pour les biblioth√®ques standard </li></ul><br>  Veuillez noter que cette structure n'est pas une sorte de dogme, mais seulement mon id√©e de commander.  Bien que je le recommande aux personnes ayant une exp√©rience minimale, au fil du temps, vous le modifierez pour l'adapter √† votre vision du monde, mais pour l'instant cela r√©duira le nombre de jambages. <br><br>  Cr√©ez maintenant le fichier main.h dans le dossier inc et connectez-le √† main.c.  Gr√¢ce √† elle, les biblioth√®ques de base seront connect√©es.  Et avant de commencer √† transf√©rer des biblioth√®ques et d'autres fichiers, notons le chemin d'acc√®s aux dossiers o√π nos futurs fichiers d'en-t√™te seront stock√©s dans les param√®tres du projet.  Pour ce faire, cliquez avec le bouton droit sur le projet (Test) dans l'arborescence du projet et cliquez sur <i>Propri√©t√©s</i> en bas ou appuyez simplement sur <i>Alt + Entr√©e</i> .  Dans la fen√™tre qui s'ouvre, allez √† <i>Build ‚Üí C2000 Compiler ‚Üí Include Options</i> et ici nous avons besoin de deux chemins existants - enregistrez le chemin vers les dossiers inc et system_inc.  Cliquez sur <i>Ajouter</i> , puis sur <i>Espace de travail</i> , puis sur le dossier inc souhait√©, puis faites de m√™me et accrochez-vous au deuxi√®me dossier.  Ainsi, nous avons prescrit des chemins relatifs; lors du transfert d'un projet, vous n'aurez rien √† reconfigurer.  En cons√©quence, nous obtenons une telle image et cliquez sur <i>OK</i> : <br><br><img src="https://habrastorage.org/webt/2x/nd/ql/2xndqlhcm5szyalytbw6oeseyka.png"><br><br>  Nous avons maintenant un projet vide avec les chemins et autres param√®tres prescrits, il ne reste plus qu'√† le remplir de biblioth√®ques.  La seule chose √† faire est de v√©rifier si tout est connect√©.  En th√©orie, vous devriez obtenir un tel code et une image, compiler le projet.  Pour ce faire, appuyez sur <i>CTRL + B</i> ou acc√©dez √† <i>Projet ‚Üí Tout construire</i> en haut.  Le projet doit compiler sans erreur et ressembler √† ceci (l'image est cliquable): <br><br> <a href=""><img src="https://habrastorage.org/webt/0b/hv/ur/0bhvurabfuhr1-6lqjgzn4svzp0.png"></a> <br><br>  Parlons maintenant un peu de l'√©diteur de liens.  Initialement, lors de la cr√©ation d'un projet, l'IDE g√©n√®re le fichier <i>28027_RAM_lnk.cmd</i> , il place notre programme en RAM lors du d√©bogage et du firmware.  C'est pratique lorsque nous d√©boguons, car  Les ressources de m√©moire flash ne sont pas gaspill√©es et entrer le d√©bogage dans la RAM est beaucoup plus rapide.  Mais que se passe-t-il si nous voulons coudre en flash?  Pour ce faire, il existe un autre fichier de lien qui placera notre programme en flash.  Je vais montrer cette option. <br><br>  Tout d'abord, supprimez le fichier <i>28027_RAM_lnk.cmd</i> .  Comme je l'ai dit - <b>controlSUITE est</b> notre tout.  Nous l'ouvrons.  Allez maintenant <i>Anglais ‚Üí Appareil ‚Üí Piccolo F2802x ‚Üí Biblioth√®ques prises en charge ‚Üí Fichiers d'en-t√™te pour F28027x</i> .  Sur la droite, nous voyons des dossiers - ce sont les biblioth√®ques standard et tout ce qui est n√©cessaire, y compris les √©diteurs de liens.  Maintenant, nous allons dans le dossier <i>f2802x_common ‚Üí cmd</i> et ici nous voyons un ensemble de linkers pour toutes les pierres de la ligne.  Il n'est pas difficile de deviner les fichiers _RAM pour le t√©l√©chargement de code sur la RAM, et sans cette balise pour le t√©l√©chargement via flash.  Nous prenons le fichier <i>F28027.cmd</i> et le copions dans notre projet √† la place de l'ancien √©diteur de liens distant. <br><br>  Il est maintenant temps de migrer les biblioth√®ques elles-m√™mes.  Nous allons dans le dossier <i>f2802x_common ‚Üí source</i> et voyons un tas de fichiers.  Il existe deux types de biblioth√®ques: les registres standard (similaires √† CMSIS) et une sorte de SPL.  Dans ce cas, nous ne sommes int√©ress√©s que par la premi√®re vue, c'est-√†-dire les fichiers avec le pr√©fixe <i>f2802x_</i> .  Bien s√ªr, vous pouvez tous les faire glisser dans notre projet, mais pourquoi l'obstruer si nous n'utilisons pas tout?  Si vous avez besoin de quelque chose, nous l'ajouterons √† l'avenir.  Pour l'instant, nous nous limitons aux ensembles de fichiers suivants: <br><br><ul><li>  <i>f2802x_codestartbranch.asm</i> </li><li>  <i>f2802x_defaultisr.c</i> </li><li>  <i>f2802x_piectrl.c</i> </li><li>  <i>f2802x_pievect.c</i> </li><li>  <i>f2802x_sysctrl.c</i> </li></ul><br>  Nous copions le fichier de donn√©es et le <i>collons</i> dans notre dossier <i>system_src</i> .  Maintenant, nous allons dans le dossier <i>source f2802x_headers ‚Üí</i> et <i>prenons le</i> fichier <i>F2802x_GlobalVariableDefs.c</i> √† partir de l√† et le copions √† <i>nouveau</i> dans notre dossier <i>system_src</i> .  Ensuite, acc√©dez au dossier <i>f2802x_headers ‚Üí cmd</i> et copiez le fichier <i>F2802x_Headers_nonBIOS.cmd</i> √† partir de l√† dans le m√™me dossier.  Ceci termine le remplissage du dossier <i>system_src</i> et passe aux en-t√™tes. <br><br>  Nous allons dans le dossier <i>f2802x_headers ‚Üí inclure</i> et copier tous les fichiers de l√† dans notre dossier <i>system_inc</i> .  Maintenant, nous allons dans le dossier <i>f2802x_common ‚Üí source</i> et copions les fichiers √† partir de l√†: <br><br><ul><li>  <i>f2802x_examples.h</i> </li><li>  <i>f2802x_globalprototypes.h</i> </li><li>  <i>f2802x_i2c_defines.h</i> </li><li>  <i>f2802x_epwm_defines</i> </li><li>  <i>f2802x_swprioritizedisrlevels.h</i> </li><li>  <i>f2802x_defaultisr.h</i> </li></ul><br>  Nous devrions obtenir cette image dans l'arborescence du projet: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jw/tu/h-/jwtuh-pssz-pn5_ynxlxugmijtw.png"></div><br>  Vous devez maintenant connecter les biblioth√®ques de base, le fichier <i>main.h</i> prend la forme suivante: <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"F2802x_Device.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"F2802x_examples.h"</span></span></span></span></code> </pre> <br>  Nous essayons de compiler.  Si le projet a √©t√© compil√© sans erreurs ni avertissements, alors tout est correctement connect√©.  Si cela ne s'est pas produit, alors rev√©rifiez les 10 fois, et si cela ne fonctionne pas du tout, puis √©crivez au PM - <i>j'aiderai</i> , comme l'a dit Owl: <i>"Baz-woz-mEz-bottom, c'est-√†-dire pour rien</i> . <i>"</i> <br><br><h2>  Initialisation du contr√¥leur et du syst√®me d'horloge </h2><br>  Dans cette section, nous allons √©crire une fonction qui initialise le temporisateur de surveillance et les vecteurs d'interruption, et met les drapeaux d'interruption √† z√©ro.  Nous avons √©galement mis en place le syst√®me d'horloge, √† la suite duquel le quartz externe plut√¥t que la cha√Æne RC interne deviendra la source d'horloge, configurera la PLL et activera la synchronisation pour tous les p√©riph√©riques. <br><br>  Pour la pr√©cision du code, je propose de mettre toutes les initialisations de base dans un fichier s√©par√©, dont le frontend sera la fonction <i>void InitStartSystem (void)</i> .  Pour ce faire, cr√©ez les fichiers <i>systemInitStart.h</i> et <i>systemInitStart.c</i> .  J'√©crirai imm√©diatement une fonction et ensuite nous analyserons simplement son contenu: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitStartSystem</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ DisableDog(); XtalOscSel(); InitPll(TMS320_PLLCR, TMS320_DIVSEL); InitPeripheralClocks(); InitPieCtrl(); InitPieVectTable(); }</code> </pre><br>  Toutes les fonctions appel√©es dans <i>InitStartSystem ()</i> sont standard.  Je vous conseille de voir en d√©tail comment ils sont impl√©ment√©s, pour cela vous pouvez maintenir CTRL et cliquer sur la fonction qui vous int√©resse.  As-tu regard√©?  Maintenant, passez bri√®vement en revue ... <br><br><ul><li>  <i>DisableDog ()</i> - la fonction d√©sactive le "chien".  Il s'agit d'une √©tape obligatoire lors de la configuration de la partie principale des p√©riph√©riques critiques, par exemple, un syst√®me d'horloge.  Dans le code de biblioth√®que, vous voyez souvent cela, il sera dupliqu√© et dupliqu√© </li><li>  <i>XtalOscSel ()</i> - cette fonction impl√©mente le passage d'une source d'horloge interne √† un quartz externe.  <b>Un point important!</b>  Il y a une erreur dans la biblioth√®que standard avec cette fonction - elle n'est pas d√©clar√©e.  On passe au fichier <i>f2802x_globalprototypes.h</i> et parmi tous les autres, on ajoute la ligne <i>extern void XtalOscSel (void)</i> <br><br><img src="https://habrastorage.org/webt/3l/vv/yv/3lvvyvwdfpwbqpek6bphfkheapu.png"><br><br>  <b>Le deuxi√®me point important!</b>  Acc√©dez √† la fonction XtalOscSel et supprimez la fonction de retard. <br><br><img src="https://habrastorage.org/webt/ve/iq/iw/veiqiwa2locaclbj2-xfbpiakpe.png"><br><br>  <b>Le troisi√®me point important!</b>  Nous allons dans le fichier <i>f28027x_exmaples.h</i> et commentons la fonction d'impl√©mentation du retard. <br><br><img src="https://habrastorage.org/webt/t7/jk/jp/t7jkjpu3nbgcqlqt5aolaniwqxg.png"><br></li><li>  <i>InitPll (TMS320_PLLMUL, TMS320_DIVSEL)</i> - la fonction configure la PLL.  2 valeurs lui sont transf√©r√©es: multiplicateur et diviseur.  Leur valeur est sp√©cifi√©e dans le fichier d'en-t√™te.  <b>Un point important!</b>  Nous ouvrons cette fonction dans la biblioth√®que et vous devez commenter le retard tout en bas <br><br><img src="https://habrastorage.org/webt/mg/up/gi/mgupgi_vhx8hvcvg3tgaqsxaxas.png"></li><li>  <i>InitPll (TMS320_PLLMUL, TMS320_DIVSEL)</i> - la fonction configure la PLL.  2 valeurs lui sont transf√©r√©es: multiplicateur et diviseur.  Leur valeur est sp√©cifi√©e dans le fichier d'en-t√™te.  <b>Un point important!</b>  Nous ouvrons cette fonction dans la biblioth√®que et vous devez commenter le retard tout en bas </li><li>  <i>InitPeripheralClocks ()</i> - cette fonction permet simplement de cadencer pour toute la p√©riph√©rie.  Oui, pour tous.  C2000 n'est pas une solution pour les presse-√©toupes aliment√©s par batterie, <br>  cette solution d'unit√©s-dizaines-centaines de kilowatts et path√©tique 2-3 mA ne jouera pas un r√¥le ici.  Eh bien, vous n'avez pas √† vous souvenir de chaque fois que vous allumez l'horloge pour une sorte de SPI ou non </li><li>  <i>InitPieCtrl ()</i> - la fonction d√©sactive toutes les interruptions et r√©initialise les indicateurs d'interruption </li><li>  <i>InitPieVectTable ()</i> - la fonction remplit la table avec des vecteurs d'interruption </li></ul><br>  En fait, ici tout est initialisation.  Je pense que beaucoup ont remarqu√© les ¬´points importants¬ª associ√©s √† la fonction <i>Delay</i> .  Pourquoi l'avons-nous coup√© sur la vigne?  Oui, tout est simple - c'est une b√©quille. <br><br>  Les ing√©nieurs TI ont ajout√© ces retards compl√®tement inutiles √† certaines fonctions, ajout√©s dans les mises √† jour r√©centes.  Pourquoi - un myst√®re non seulement pour moi.  Les registres et autres entr√©es critiques sont d√©j√† prot√©g√©s, donc cela ne rendra pas notre contr√¥leur stupide.  Soit dit en passant, lors de l'initialisation dans l'√©lectronique de puissance, il est impossible de "carr√©ment" du tout, sinon ce sera des poules mouill√©es.  Par cons√©quent, oubliez pour toujours les fonctions de <i>retard</i> et autres diaboliques, seulement les minuteries!  Les retards ne sont autoris√©s qu'√† certaines fins p√©dagogiques, par exemple, pour clignoter rapidement avec une LED. <br><br>  Afin de v√©rifier que le code fonctionne, nous appelons la fonction d'initialisation dans main, compile, flash et <b>hook</b> sur l'oscilloscope <b>GPIO18</b> .  Cette broche est similaire au MCO du STM32, ce qui signifie qu'elle d√©livre la fr√©quence du syst√®me.  Un oscilloscope devrait voir un signal avec une fr√©quence de 56 MHz.  Si l'oscilloscope est bon, alors vous verrez le m√©andre, si les chinois (m√™me bons), alors ce sera probablement quelque chose de plus proche du sinus.  La d√©finition de GPIO18 pour produire la fr√©quence du syst√®me est visible dans la fonction <i>InitPeripheralClocks ()</i> .  Vous devez d'abord ¬´connecter¬ª gpio √† la sortie de fr√©quence, puis r√©gler le diviseur sur 1: <br><br><pre> <code class="cpp hljs"> GpioCtrlRegs.GPAMUX2.bit.GPIO18 = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-comment"><span class="hljs-comment">// GPIO18 = XCLKOUT SysCtrlRegs.XCLK.bit.XCLKOUTDIV=2; // Set XCLKOUT = SYSCLKOUT/1</span></span></code> </pre><br><h2>  Configuration GPIO </h2><br>  Pour travailler avec cette famille, nous n'avons besoin que d'un manuel de r√©f√©rence, que les d√©veloppeurs TI ont divis√© en plusieurs fichiers, chacun d√©crivant une certaine p√©riph√©rie, ce qui est tr√®s pratique.  T√©l√©chargez la fiche technique <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> et allez √† la section <i>Support</i> de la <i>documentation</i> √† la page 126. Ici, nous voyons un ensemble de liens vers la documentation avec sa br√®ve description: errata, un guide pour d√©marrer la gestion du moteur et des guides sur chaque p√©riph√©rie.  Nous sommes int√©ress√©s par un document appel√© <b>TMS320F2802x / TMS320F2802xx Piccolo System Control and Interrupts Reference Guide</b> , il contient la description du GPIO et d'autres param√®tres de base du syst√®me qui nous int√©ressent.  Nous regardons le sch√©ma de principe GPIO: <br><br> <a href=""><img src="https://habrastorage.org/webt/vp/uu/29/vpuu29qhryyngpm2thgtvtquoeo.png"></a> <br><br>  Nous voyons une image assez famili√®re des ports d'entr√©e / sortie de l'appareil.  Ici et la possibilit√© d'activer la suspension interne, et l'utilisation d'un signal avec GPIO pour les interruptions et autres d√©lices.  La principale caract√©ristique de ce p√©riph√©rique dans le C2000 est la possibilit√© de suppression des interf√©rences mat√©rielles, par exemple, le cliquetis des contacts m√©caniques d'un bouton.  Regardons un diagramme int√©ressant: <br><br><img src="https://habrastorage.org/webt/gu/zj/ym/guzjymm5gq08m1gar1284zobjx8.png"><br><br>  Il montre le principe de lecture de l'√©tat des entr√©es.  Dans la plupart des contr√¥leurs, l'√©tat d'entr√©e est lu avec la fr√©quence d'horloge de cette p√©riph√©rie, c'est-√†-dire par d√©faut avec une fr√©quence de 56 MHz dans notre cas, et pour le m√™me stm dans les familles plus anciennes, ces fr√©quences sont encore plus √©lev√©es.  Je pense que tout le monde comprend qu'√† une telle fr√©quence, le contr√¥leur a le temps de ¬´voir¬ª toute interf√©rence et bruit.  Parfois, une telle fr√©quence est n√©cessaire, et parfois pas, par exemple, si nous devons interroger un bouton.  Pourquoi l'interviewerions-nous toutes les 18 ns?  Par cons√©quent, nous avons r√©alis√© la possibilit√© de r√©duire la fr√©quence d'horloge d'un port sp√©cifique en utilisant le registre <i>CTRL</i> et les bits <i>QUALPRDx</i> , o√π X prend une valeur de 0 √† 3: QUALPRD0 est responsable de GPIO0 ... 7, QUALPRD1 est responsable de GPIO8 ... 15 et ainsi de suite.  En fait, il s'agit d'un diviseur de fr√©quence ordinaire avec un coefficient de 1 √† 510. <br><br><img src="https://habrastorage.org/webt/a5/ro/9e/a5ro9eq9hvvmomonnkm8ggkxzcq.png"><br><br>  Souvent, cela n'a aucun sens d'interroger un bouton, nous allons donc r√©gler le diviseur √† 510, c'est-√†-dire au maximum.  Nous regardons √† nouveau le diagramme et voyons que le signal n'est consid√©r√© comme stable que lorsque son niveau est rest√© inchang√© pendant 6 ticks.  Le nombre de mesures n√©cessaires pour la fixation peut √™tre 1, 3 ou 6. <b>Plus le diviseur est grand et plus nous fixons de cycles, plus la protection contre les bavardages est stable.</b>  Lorsqu'il y a un bavardage de contacts, ce sera d'abord des transitions chaotiques de 0 √† 1 et vice versa, lorsque le bavardage passera et que le signal s'arr√™tera et ne changera pas pour 6 horloges, cela signifiera que le bouton est enfonc√©.  Tout ing√©nieux est simple. <br><br>  Maintenant, regardons les registres principaux, nous ne toucherons pas aux interruptions - seulement les param√®tres des ports eux-m√™mes.  Vous devez d'abord dire que les registres sont divis√©s en 2 types: les <b>registres de</b> <b>configuration</b> et <b>les registres de donn√©es</b> .  Les premiers sont responsables de la configuration des propri√©t√©s, par exemple, cette entr√©e ou cette sortie.  Le deuxi√®me groupe est responsable de l'√©criture et de la lecture de l'√©tat du port. <br><br>  <u>Registres de configuration:</u> <br><br><ul><li>  <i>GPxCTRL</i> - inscrivez-vous pour √©crire le diviseur d'horloge.  Au lieu de ¬´x¬ª, nous substituons la lettre ¬´A¬ª - si nous avons GPIO0 ... 31, ¬´B¬ª - si nous utilisons GPIO32 ... 63 et ainsi de suite </li><li>  <i>GPAQSELx</i> - registre pour d√©finir le nombre de ticks pour fixer la valeur √† l'entr√©e </li><li>  <i>GPAMUX1</i> est un registre pour s√©lectionner les p√©riph√©riques connect√©s, par exemple, il indique que GPIO ou UART, ou peut-√™tre PWM, vient au pied. </li><li>  <i>GPADIR</i> - Registre de s√©lection de direction GPIO: entr√©e ou sortie.  Par d√©faut, tous les ports sont configur√©s pour l'entr√©e. </li><li>  <i>GPAPUD</i> est le registre responsable de la connexion du porte-jarretelles interne au VCC. <br>  Il convient de noter que pour certains ports, par d√©faut, le pull-up est d√©sactiv√© et pour une partie, il est activ√©. <br>  C'est important √† retenir! </li></ul><br>  <u>Registres de donn√©es:</u> <br><br><ul><li>  <i>GPADAT</i> - registre d'√©tat de sortie.  Si la sortie est configur√©e pour l'entr√©e, alors nous lisons l'√©tat de l'entr√©e.  S'il est configur√© pour une sortie, alors nous pouvons √©crire la valeur que cette sortie devrait prendre, c'est-√†-dire 0 ou 1 </li><li>  <i>GPASET</i> - registre d√©finissant la sortie sur "1".  Pour mettre √† "1", vous devez √©crire "1", lors de l'√©criture de "0" la commande est ignor√©e </li><li>  <i>GPACLEAR</i> - registre d√©finissant la sortie sur "0".  Pour mettre √† "0", vous devez √©crire "1", lors de l'√©criture de "0" la commande est ignor√©e </li><li>  <i>GPATOGGLE</i> est un registre qui inverse la valeur actuelle de l'√©tat de sortie.  Pour inverser la valeur, √©crivez ¬´1¬ª; lors de l'√©criture de ¬´0¬ª, la commande est ignor√©e </li></ul><br>  Voici un ensemble de registres si simple.  M√™me √† partir de la description ci-dessus, vous pouvez d√©j√† comprendre ce qui doit √™tre fait pour configurer le port, mais les ing√©nieurs ou r√©dacteurs techniques prudents de TI ont fait une autre instruction √©tape par √©tape: <br><br><img src="https://habrastorage.org/webt/ly/tx/mk/lytxmkk_nwnp8qzigdzblyywwx8.png"><br><br>  Je dirai tout de suite que les √©tapes 6 et 7 ne sont pas n√©cessaires pour nous, car  ni le chien ni l'interruption ne sont utilis√©s dans cet article.  Je d√©crirai bri√®vement les √©tapes restantes pour les personnes qui ont √©tudi√© l'allemand √† l'√©cole: <br><br><ul><li>  <i>√âtape 1</i> - d√©terminer la fonctionnalit√© de sortie: que ce sera une entr√©e ou une sortie, <br>  gpio ou sortie vers d'autres p√©riph√©riques et autres </li><li>  <i>√âtape 2</i> - activer ou d√©sactiver le pull-up interne </li><li>  <i>√âtape 3</i> - Configurer la protection contre les horloges et les rebonds pour un port sp√©cifique </li><li>  <i>√âtape 4</i> - s√©lectionnez la fonction souhait√©e: gpio ou p√©riph√©riques </li><li>  <i>√âtape 5</i> - d√©finir la direction de sortie: entr√©e ou sortie </li></ul><br>  C'est toute la configuration, comme vous le voyez, c'est √©l√©mentaire et logique.  Je veux noter tout de suite qu'il n'est pas n√©cessaire dans cet ordre de faire des r√©glages, par exemple, vous pouvez d√©finir la direction (entr√©e ou sortie) d√®s la premi√®re √©tape.  Peu importe. <br><br>  <b>Super important!</b> <br><br>  Lorsque vous travaillez avec des registres de la famille C2000, il est n√©cessaire de prendre en compte le moment o√π ils sont prot√©g√©s.  Tout ce qui est d√©crit ci-dessous s'applique principalement aux registres du groupe de configuration.  Si vous avez examin√© attentivement les fonctions standard, vous y avez probablement vu d'√©tranges commandes: <b>EALLOW;</b>  et <b>EDIS;</b>  .  <i>Commande EALLOW</i> - supprime la protection et donne acc√®s au travail avec les registres syst√®me.  Commande <i>EDIS</i> - active la protection arri√®re et permet d'acc√©der au travail avec les registres syst√®me.  Autrement dit, tout travail avec des registres syst√®me devrait TOUJOURS ressembler √† ceci: <br><br><pre> <code class="cpp hljs">EALLOW; <span class="hljs-comment"><span class="hljs-comment">//    ,   ,  EDIS;</span></span></code> </pre><br>  Une telle op√©ration n'est pas requise si nous travaillons avec des registres de donn√©es, par exemple, si nous d√©finissons notre sortie sur ¬´1¬ª √† l'aide du registre <i>GPxSET</i> , nous n'avons pas besoin de supprimer la protection de celui-ci et, par cons√©quent, de la <i>r√©activer</i> .  Partout, la documentation indique ce qui doit √™tre prot√©g√© et ce qui ne l'est pas, par exemple, comme ceci: <br><br><img src="https://habrastorage.org/webt/ly/tx/mk/lytxmkk_nwnp8qzigdzblyywwx8.png"><br><br>  Sur la base de tout ce qui pr√©c√®de, configurons GPIO0 ... 3 avec des LED pour la sortie.  Je sugg√®re de placer tous les param√®tres GPIO dans la fonction <i>InitLEDgpio</i> et de l'√©crire: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitLEDgpio</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ EALLOW; GpioCtrlRegs.GPADIR.bit.GPIO0 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioCtrlRegs.GPADIR.bit.GPIO1 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioCtrlRegs.GPADIR.bit.GPIO2 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioCtrlRegs.GPADIR.bit.GPIO3 = <span class="hljs-number"><span class="hljs-number">1</span></span>; EDIS; }</code> </pre><br>  Par d√©faut, nos GPIO sont d√©j√† configur√©s comme GPIO, comme  toutes les valeurs de registre sont effac√©es, ce qui signifie que ¬´0¬ª est d√©j√† √©crit dans le registre GPAMUX1.  Pour GPIO0 ... 11, le pull-up est d√©sactiv√© par d√©faut, nous ne pouvons donc prendre et d√©terminer la direction du travail vers la sortie qu'en utilisant GPADIR.  Si vous vous souvenez, les LED sont connect√©es au contr√¥leur par des cathodes, ce qui signifie que imm√©diatement apr√®s l'initialisation, elles brillent.  Fixons ces conclusions directement dans la fonction d'initialisation √† ¬´1¬ª: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitLEDgpio</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ EALLOW; GpioCtrlRegs.GPADIR.bit.GPIO0 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioCtrlRegs.GPADIR.bit.GPIO1 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioCtrlRegs.GPADIR.bit.GPIO2 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioCtrlRegs.GPADIR.bit.GPIO3 = <span class="hljs-number"><span class="hljs-number">1</span></span>; EDIS; GpioDataRegs.GPASET.bit.GPIO0 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioDataRegs.GPASET.bit.GPIO1 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioDataRegs.GPASET.bit.GPIO2 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioDataRegs.GPASET.bit.GPIO3 = <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre><br>  Comme vous pouvez le voir, je n'utilise pas le registre <i>GPADAT</i> pour l'√©criture, mais j'utilise <i>SET, CLEAR, TOGGLE</i> .  Notez √©galement que j'ai effectu√© cette entr√©e en dehors de la zone prot√©g√©e, c'est-√†-dire apr√®s la commande <i>EDIS</i> .  Maintenant, dans la m√™me fonction, configurez GPIO12 pour fonctionner avec le bouton et ajoutez notre fonction: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitLEDgpio</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ EALLOW; GpioCtrlRegs.GPADIR.bit.GPIO0 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioCtrlRegs.GPADIR.bit.GPIO1 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioCtrlRegs.GPADIR.bit.GPIO2 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioCtrlRegs.GPADIR.bit.GPIO3 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioCtrlRegs.GPAPUD.bit.GPIO12 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioCtrlRegs.GPACTRL.bit.QUALPRD1 = <span class="hljs-number"><span class="hljs-number">0xFF</span></span>; GpioCtrlRegs.GPAQSEL1.bit.GPIO12 = <span class="hljs-number"><span class="hljs-number">2</span></span>; EDIS; GpioDataRegs.GPASET.bit.GPIO0 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioDataRegs.GPASET.bit.GPIO1 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioDataRegs.GPASET.bit.GPIO2 = <span class="hljs-number"><span class="hljs-number">1</span></span>; GpioDataRegs.GPASET.bit.GPIO3 = <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre><br>  Tout d'abord, je d√©sactive le serrage interne en √©crivant ¬´1¬ª dans le registre <i>GPAPUD</i> , car  il est activ√© par GPIO12 par d√©faut.  Comme je l'ai √©crit plus t√¥t, tous les ports apr√®s l'initialisation sont configur√©s pour l'entr√©e, comme  les z√©ros sont √©crits dans le registre <i>GPADIR</i> , nous ne le configurons pas ici. <br><br>  Il reste √† configurer la protection contre les rebonds, pour cela on divise les diviseurs <i>0xFF</i> , ce qui correspond √† la valeur / 510.  Dans le registre <i>GPAQSEL1,</i> nous √©crivons la valeur ¬´10¬ª ou 2, qui d√©finit la valeur sur un √©chantillon de 6 mesures.  C'est fait!  Pour lire la valeur d'une entr√©e sp√©cifique, il vous suffit de lire la valeur du registre <i>GPADAT</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GpioDataRegs.GPADAT.bit.GPIO12) { <span class="hljs-comment"><span class="hljs-comment">//      +3.3 (. 1)  ,     }</span></span></code> </pre><br>  C'est ainsi que nous interrogeons les conclusions n√©cessaires.  Appelons maintenant la fonction de configuration gpio dans notre fonction principale et obtenons sa forme finale: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitStartSystem</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ DisableDog(); XtalOscSel(); InitPll(TMS320_PLLMUL, TMS320_DIVSEL); InitPeripheralClocks(); InitPieCtrl(); InitPieVectTable(); <span class="hljs-comment"><span class="hljs-comment">/*********************************/</span></span> InitLEDgpio(); }</code> </pre><br>  Maintenant, nous appelons la fonction <i>InitStartSystem</i> dans le corps principal du programme dans main et ceci termine la configuration.  Nous obtenons le code suivant: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"main.h"</span></span></span><span class="hljs-meta"> int main (void) { InitStartSystem(); while(1) { } }</span></span></code> </pre><br>  Il est temps d'√©crire notre premier programme de test et de tester tout cela.  L'algorithme est le suivant: la LED qui se trouve sur GPIO3 clignote, et lorsque vous appuyez sur le bouton sur GPIO12, nous allumons simplement la LED GPIO0.  Ainsi, nous v√©rifierons le fonctionnement des ports pour l'entr√©e et la sortie.  Nous √©crivons le code suivant: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"main.h"</span></span></span><span class="hljs-meta"> int main (void) { InitStartSystem(); while(1) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (GpioDataRegs.GPADAT.bit.GPIO12) { GpioDataRegs.GPACLEAR.bit.GPIO0 = 1; } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { GpioDataRegs.GPASET.bit.GPIO0 = 1; } GpioDataRegs.GPATOGGLE.bit.GPIO3 = 1; delay(100000); } }</span></span></code> </pre><br>  Nous compilons, allons dans le d√©bogueur, d√©marrez-le et voyons comment une LED clignote constamment, et lorsque vous appuyez sur le bouton, une autre s'allume.  √Ä la fin de la section, je joindrai un projet avec ce code, si quelque chose ne fonctionne pas, examinez-le.  Surtout pour ceux qui sont durs sur les textes ou qui n'ont pas compris tous les points, je sugg√®re de regarder cette vid√©o sur le travail avec GPIO, tout se passe l√†-bas, comme dans la section "GPIO".  Je vous pr√©viens que la vid√©o pendant une heure, morne, longue, mais aussi d√©taill√©e que possible et tout est visible: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/jlyVy73pa98" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h2>  Fichiers de l'article </h2><br><ul><li>  Archive avec le projet pour CCS7 √† t√©l√©charger <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> </li><li>  Vous pouvez voir le code sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> </li></ul><br><h2>  R√©sum√© </h2><br>  √Ä ce stade, je termine l'article d'aujourd'hui.  Je pense que vous avez compris que si je d√©cidais imm√©diatement de montrer la mise en ≈ìuvre de l'onduleur DC / AC, l'article aurait √©t√© plusieurs fois plus grand ou de nombreux d√©tails importants seraient simplement rest√©s dans les coulisses, ce qui, √† mon avis, est inacceptable. <br><br>  J'esp√®re que mon article aidera tout le monde √† commencer le d√©veloppement de cette famille de contr√¥leurs et √† commencer le d√©veloppement dans le domaine de l'√©lectronique de puissance et des machines-outils.  √Ä l'avenir, j'√©crirai probablement autre chose sur ce sujet, par exemple, je voudrais envisager de travailler avec PWM ou de mettre en ≈ìuvre une sorte d'algorithme.  L'essentiel est d'avoir du temps. <br><br>  Si vous avez des questions ou si quelque chose ne fonctionne pas pour vous, vous pouvez m'√©crire dans des messages priv√©s et j'essaierai de r√©pondre √† vos questions et de fournir toute l'aide possible dans l'√©tude.  Je vous souhaite du succ√®s dans la formation! <br><br>  <b>UPD</b>  Merci pour le conseil de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">BelerafonL</a> sur le livre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Embedded High-Performance Digital Control Systems"</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr410161/">https://habr.com/ru/post/fr410161/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr410149/index.html">Comment n√©gocier sur Skype et t√©l√©phone en anglais: instructions et phrases utiles</a></li>
<li><a href="../fr410153/index.html">Le Slutty Middle Age</a></li>
<li><a href="../fr410155/index.html">Bandage vivifiant non amovible</a></li>
<li><a href="../fr410157/index.html">Intel a montr√© des lunettes intelligentes dans lesquelles l'image est transmise √† la r√©tine</a></li>
<li><a href="../fr410159/index.html">Comment un smartphone peut √©couter, regarder et suivre</a></li>
<li><a href="../fr410163/index.html">[CASE] L'impression 3D dans l'industrie l√©g√®re sur l'exemple de FullPower</a></li>
<li><a href="../fr410167/index.html">Comment la salet√© peut sauver l'humanit√© d'une apocalypse infectieuse</a></li>
<li><a href="../fr410169/index.html">[CASE] Comment nous avons r√©alis√© l'am√©nagement du b√¢timent Novo Nordisk</a></li>
<li><a href="../fr410171/index.html">Des robots √† ADN viral ont √©t√© programm√©s pour bloquer les vaisseaux sanguins humains et tuer les tumeurs canc√©reuses.</a></li>
<li><a href="../fr410173/index.html">Yandex biais√© compile ses principales nouvelles, a d√©clar√© la plainte envoy√©e au FAS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>