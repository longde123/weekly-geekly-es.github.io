<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì© üë©üèª‚Äçüè≠ üë®‚Äç‚úàÔ∏è N√£o precisa de logs? üíµ üåÄ üëáüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O desenvolvimento mudou muito nos √∫ltimos anos. Em vez de aplicativos monol√≠ticos, microsservi√ßos e fun√ß√µes vieram. Os bancos de dados de monstros ind...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>N√£o precisa de logs?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/468535/">  O desenvolvimento mudou muito nos √∫ltimos anos.  Em vez de aplicativos monol√≠ticos, microsservi√ßos e fun√ß√µes vieram.  Os bancos de dados de monstros industriais universais degeneraram em alvos estreitos.  Docker mudou de id√©ia sobre a implanta√ß√£o.  Mas nossa ideia de logs mudou? <br><br>  Um dos grandes problemas do Yandex.Verticals eram os logs - 18 TB por dia e 250.000 logs por segundo, tudo √© gravado em arquivos.  Os logs s√£o heterog√™neos porque existem muitas linguagens: Scala, Java, Python, Go.  Em seguida, eles s√£o coletados pela Fluent Bit, escreve em Kafka, manipuladores trabalham em uma m√°quina de ferro, montam a partir de Kafka e escrevem tudo em disco.  Al√©m disso, esta √© a segunda vers√£o dos logs. <br><br><img src="https://habrastorage.org/webt/4i/z8/ws/4iz8wst0a72z7ytipvzx77wnxiq.jpeg"><br><br>  Como resultado, surge um longo problema de pesquisa.  Esses logs s√£o pesquisados ‚Äã‚Äãusando grep.  Em alguns servi√ßos, o grep pode chegar a horas.  Se voc√™ tiver problemas na produ√ß√£o, n√£o procurar√° seus registros por horas.  Para resolver o problema, a Yandex decidiu escrever sua pr√≥pria bicicleta de entrega de logs para pesquisa.  O que aconteceu com <b>Alexei Danilov</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">danevge</a> ) - o desenvolvedor da equipe de infraestrutura da Yandex.Verticals.  Desenvolve, escreve e suporta projetos auto.ru e Yandex.Real Estate. <br><br>  <i>Isen√ß√£o de responsabilidade.</i>  <i>O artigo fala sobre desenvolvimento moderno e √© adequado para arquitetura de microsservi√ßo.</i>  <i>V√°rios produtos s√£o apresentados aqui - essas s√£o as ferramentas usadas no Yandex.Verticals.</i>  <i>Sob outras condi√ß√µes, os an√°logos s√£o poss√≠veis com mais √™xito, mas eles executam quase as mesmas fun√ß√µes.</i> <a name="habracut"></a><br><blockquote>  Nota  O artigo √© uma vers√£o estendida do relat√≥rio de Alexey Danilov, ‚ÄúLogs n√£o s√£o necess√°rios‚Äù no RIT ++ 2019 DevOps Conf, que √© estilisticamente modificado e complementado com novo material.  Voc√™ pode encontrar a grava√ß√£o em v√≠deo do discurso de Alexey <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no link</a> do nosso canal do YouTube. </blockquote><br>  A equipe do Yandex.Vertical tem 300 pessoas, cerca de 100 delas s√£o desenvolvedores.  No desenvolvimento, n√£o somos diferentes da maioria das empresas que criam suas pr√≥prias solu√ß√µes de produtos.  Microsservi√ßos, todo mundo mora no Docker, um mon√≥lito em PHP est√° acumulando poeira em um canto escuro, implantado via Hashicorp Nomad e mantemos um zool√≥gico de idiomas: Scala, Java, Go, Node.js, Python. <br><br>  Um dos grandes problemas de infraestrutura do Yandex.Verticals s√£o os logs de aplicativos.  Quando abordamos esse problema com seriedade, usamos a terceira vers√£o de sua coleta e processamento.  Simplificado, funcionou assim: <br><br><ul><li>  aplicativos gravados em arquivos; <br></li><li>  O Fluent Bit leu os arquivos e os enviou linha a linha para o Kafka; <br></li><li>  Em uma m√°quina de ferro dedicada, havia um aplicativo que lia o t√≥pico Kafka e escrevia nos arquivos do disco. <br></li></ul><br>  Na esta√ß√£o quente, t√≠nhamos 18 TB de toras por dia, ou 250.000 linhas por segundo.  Essa √© uma quantidade muito grande, o que complica o trabalho com esses dados.  A √∫nica maneira de analisar isso √© grep, pois tudo √© armazenado em arquivos.  Para aplicativos grandes, a an√°lise pode levar horas.  Para problemas na produ√ß√£o, voc√™ n√£o tem esse tempo. <br><br>  Solu√ß√µes prontas n√£o cabiam em pre√ßo, recursos ou velocidade.  Eles n√£o podiam lidar de maneira aceit√°vel com o nosso fluxo.  √â dif√≠cil at√© contar o n√∫mero de tentativas de cozinhar o Elasticsearch.  Suponho que n√£o sabemos como cozinh√°-lo.  Mas n√£o √© disso que precisamos, se para us√°-lo como um reposit√≥rio de logs, s√£o necess√°rias habilidades (habilidades) especiais. <br><br>  Nessa situa√ß√£o, decidimos implementar nosso pr√≥prio sistema para coletar e analisar logs. <br><br><h2>  Bicicleta </h2><br><img src="https://habrastorage.org/webt/aw/49/s9/aw49s9cfjgf28z2eqyofr3cx7ea.jpeg"><br><br>  <i>Nota: Se a pr√≥xima bicicleta n√£o for interessante, prossiga imediatamente para a se√ß√£o "Tipifica√ß√£o".</i> <br><br><h3>  Formatar </h3><br>  Usamos v√°rios PLs e adoramos microsservi√ßos.  Para trabalhar com os logs, formamos uniformemente nosso pr√≥prio formato JSON.  Ele cobre a maioria das necessidades de trabalho adicional com logs. <br><br><img src="https://habrastorage.org/webt/z8/8q/g5/z88qg5gh3s5ntz9n91q5opbk0ku.png"><br>  <i>Um exemplo de logs com todos os campos poss√≠veis.</i> <br><br><h2>  Driver de log do Docker </h2><br>  Para coletar os logs, escrevemos nosso pr√≥prio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">driver de log do docker</a> - um aplicativo no Go.  Ele √© montado de uma maneira especial, entregue por comandos do plugin docker, armazenados no registro e executado em uma √∫nica inst√¢ncia executando o Docker. <br><br>  Como qualquer problema com o driver de log pode afetar negativamente todo o trabalho, tentamos escrever uma implementa√ß√£o m√≠nima.  Nosso driver escuta o stdout do cont√™iner e passa imediatamente os logs para o aplicativo que est√° pr√≥ximo.  Ele j√° lida com a parte mais complexa da entrega. <br><br><h3>  Os problemas </h3><br>  Mencionarei separadamente os problemas de atualiza√ß√£o da vers√£o do driver de log do docker. <br><br><img src="https://habrastorage.org/webt/a6/sy/md/a6symdnuvy0z5kekvjv924yth-i.png"><br>  <i>Captura de tela do Grafana interno.</i> <br><br>  √Ä esquerda est√° a propor√ß√£o de vers√µes instaladas para m√°quinas.  Agora, tr√™s vers√µes est√£o instaladas em todo o hardware - nenhum carro √© perdido em lugar nenhum e n√£o h√° instala√ß√µes desnecess√°rias.  √Ä direita est√° o n√∫mero de cont√™ineres que usam esta ou aquela vers√£o. <br><br>  O driver da janela de encaixe n√£o pode ser atualizado imediatamente.  Para fazer isso, voc√™ precisaria reiniciar todos os cont√™ineres e todos os servi√ßos, o que poderia resultar em problemas.  Portanto, para instalar a nova vers√£o, basta aguardar a atualiza√ß√£o de todos os cont√™ineres. <br><br><h2>  Esquema geral </h2><br>  Considere o esquema geral de um novo sistema para coletar e entregar logs.  Outros detalhes n√£o s√£o t√£o interessantes. <br><br><img src="https://habrastorage.org/webt/nm/lx/pq/nmlxpqlg41ntzuar5imu8pw3-km.jpeg"><br><br>  Os aplicativos gravam logs no formato JSON no stdout.  O Docker escuta o pipe do cont√™iner e o redireciona para o driver do Docker.  O driver do Docker l√™ e re-derrete de forma ass√≠ncrona tudo no Pusher. <br><br>  Empurrador est√° em todos os carros de ferro.  Ele prepara, satura, vira e envia logs para a fila de mensagens Yandex.  O fluxo de logs do MQ √© analisado por tr√™s tipos de trabalhadores e gravado nos reposit√≥rios. <br><br>  Existem tr√™s reposit√≥rios para registrar logs. <br><br><ul><li>  <b>Yandex mapReduce</b> para armazenar e analisar logs por um longo per√≠odo de tempo.  Este √© um an√°logo do Hadoop. <br></li><li>  <b>ClickHouse</b> para armazenar logs durante o √∫ltimo dia. <br></li><li>  <b>Humio</b> (como um experimento) para armazenar logs para o √∫ltimo dia. <br></li></ul><br><h3>  Lucro </h3><br>  O formato geral permite gravar e processar logs da mesma maneira.  A coleta de logs √© autom√°tica, sem usar um disco, e a entrega ocorre na √°rea de alguns segundos.  A chave pesquisa de 2 segundos a 5 segundos.  Armazenamento e recupera√ß√£o por um longo per√≠odo de tempo. <br><br>  Para volumes menores, considere alternativas: Humio, Splunk e Elastic.  Os dois √∫ltimos possuem drivers oficiais do Docker.  Se voc√™ mora na AWS, √© o Amazon CloudWatch. <br><br><h3>  Amazon cloudwatch </h3><br>  O Amazon CloudWatch lida com m√©tricas, eventos e logs.  Ele n√£o procura o √∫ltimo, n√£o fornece itens de super busca e n√£o os processa da forma usual.  O Amazon CloudWatch processa logs, an√°lises, filtros e exibi√ß√µes em gr√°ficos. <br><br><img src="https://habrastorage.org/webt/xc/le/o2/xcleo2if8o1ezw7hob29olfzcta.png"><br>  <i>O Amazon CloudWatch converte logs em m√©tricas e gr√°ficos.</i> <br><br><h2>  O que fazer com os logs? </h2><br>  De volta √† nossa bicicleta - ela atende a todos os casos?  N√£o, nossa solu√ß√£o permite encontrar os logs, mas eles exigem uma heterogeneidade muito maior de informa√ß√µes e seus tipos.  Os logs s√£o usados ‚Äã‚Äãem muito mais casos. <br><br>  Assim que voc√™ coletar os logs, a seguinte frase ser√°: "Vamos analisar algo, de alguma forma process√°-lo, anot√°-lo em algum lugar e come√ßar a ser exibido em gr√°ficos, em pain√©is".  Este √© o caminho para o inferno.  Especialmente se estamos falando de ferramentas comuns. <br><br><blockquote>  Se voc√™ imaginar os logs como um certo caos ou log de eventos de qualquer dado, eles n√£o funcionar√£o. </blockquote><br>  Esta ser√° uma grande confus√£o de informa√ß√µes que n√£o podem ser processadas.  Um jogo come√ßar√° na formaliza√ß√£o dos logs: "Vamos escrever essas linhas em um formato especial para que seja conveniente analis√°-las mais tarde!"  Isso tamb√©m n√£o funciona.  Acredite em n√≥s, tentamos. <br><br><h2>  Digita√ß√£o </h2><br>  Se voc√™ dividir os logs em tipos e process√°-los separadamente, poder√° encontrar ferramentas que facilitar√£o o trabalho com eles.  Trabalhando n√£o mais como com logs, mas com dados √∫teis - esse trabalho √© mais transparente e conveniente.  Alguns tipos de logs podem ser descartados por completo. <br><br><h3>  Apenas no caso </h3><br>  Esse tipo de registro "ser" √© o meu favorito.  Se √© imposs√≠vel responder claramente por que essa ou aquela linha √© necess√°ria, ent√£o elas s√£o.  Esse tipo tamb√©m pode ser chamado de "logs apenas por precau√ß√£o". <br><br><pre><code class="plaintext hljs">// validate customer func Validate(customer Customer) { // ??? log.debug(‚ÄúValidate customer %v‚Äù, customer) ‚Ä¶ log.Error(‚ÄúCustomer not valid %v. Reason: %s‚Äù, ...) ‚Ä¶. }</code> </pre> <br><blockquote>  Os logs n√£o s√£o coment√°rios que podem ser exclu√≠dos.  Isso faz parte do c√≥digo que √© mais dif√≠cil de modificar, manter e, mais ainda, excluir. </blockquote><br>  Na melhor das hip√≥teses, esse log pode se transformar em depura√ß√£o ou rastreamento.  Esse tipo <b>desorganiza o c√≥digo</b> .  Devido ao registro precipitado, posso obter dados pessoais, senhas e cookies dos usu√°rios. <br><br>  O caminho certo √© <b>jog√°-los fora e esquec√™-los</b> .  Mas ent√£o nos deparamos com um novo problema.  Como analisar a situa√ß√£o com um erro? <br><br><h3>  Erro fatal / cr√≠tico </h3><br>  Para come√ßar, consideramos apenas erros cr√≠ticos.  Esses s√£o erros devido aos quais usu√°rios e desenvolvedores sofrem.  O primeiro - quando eles n√£o conseguem concluir a opera√ß√£o.  O segundo - quando voc√™ precisa fazer corre√ß√µes manualmente. <br><br>  Por que os logs n√£o se encaixam? <br><br>  <b>Nenhuma resposta r√°pida</b> .  Se a equipe de desenvolvimento aprender sobre o erro dos usu√°rios por meio do suporte ou do Twitter, √© hora de mudar alguma coisa. <br><br>  <b>N√£o h√° contexto</b> .  Uma linha separada do log de erros √© in√∫til.  Temos que coletar o contexto pouco a pouco.  Mesmo assim, pode n√£o ser suficiente, pois esse √© o contexto do processo, n√£o o erro. <br><br>  <b>N√£o existe uma imagem grande</b> .  Nenhuma resposta para as perguntas: <br><br><ul><li>  com que frequ√™ncia esse erro ocorre; <br></li><li>  ocorreu nas r√©plicas restantes do servi√ßo; <br></li><li>  foi antes? <br></li></ul><br>  Para corrigir esses problemas, use uma ferramenta adequada, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sentry.io</a> .  Ele permite que voc√™ trabalhe com informa√ß√µes de erro representativas e completas (contextuais) com <code>alerting rule</code> personaliz√°vel.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O site sentinela</a> descreve as diferen√ßas nos logs do uso de sentry.io. <br><br><h3>  Erro n√£o cr√≠tico </h3><br>  Lan√ßamos erros fatais e cr√≠ticos e agora eles est√£o escritos no Sentry.  Mas houve erros internos - v√°rias bibliotecas ou respostas de servi√ßos de terceiros. <br><br>  Um bom exemplo √© uma nova tentativa bem-sucedida.  Suponha que o servi√ßo A esteja voltado para o servi√ßo B, mas, devido a problemas de rede, n√£o foi poss√≠vel obter uma resposta.  Ap√≥s o erro, o servi√ßo A voltou para o servi√ßo B e recebeu uma resposta v√°lida.  O erro na primeira chamada √© cr√≠tico?  N√£o.  Nesse caso, o processo foi conclu√≠do com √™xito e o usu√°rio p√¥de usar o servi√ßo. <br><br>  Se esses erros n√£o s√£o cr√≠ticos para o servi√ßo funcionar e n√£o afetam o usu√°rio com uma repeti√ß√£o rara, eles n√£o s√£o erros.  Isso √© uma degrada√ß√£o do servi√ßo, embora a resposta ao usu√°rio tenha chegado 50 ms depois.  Este tipo de log refere-se a avisos - aviso. <br><br><h3>  Advert√™ncia </h3><br><blockquote>  Alertas s√£o informa√ß√µes sobre degrada√ß√£o de um servi√ßo. </blockquote><br>  Aqui veremos os mesmos problemas inerentes a erros cr√≠ticos, mas com uma reserva.  A rea√ß√£o a um evento individual n√£o √© importante - sua quantidade ao longo do tempo √© importante. <br><br>  Considere um exemplo em que um servi√ßo n√£o pode recuperar uma entrada de cache e acessa o armazenamento a frio.  Se isso acontecer uma vez por minuto, isso pode ser feito para a opera√ß√£o normal do servi√ßo.  <b>Emiss√µes raras n√£o s√£o importantes</b> . <br><br>  Mas, ao mesmo tempo, voc√™ precisa de uma ferramenta para visualizar o panorama geral, precisa <b>de an√°lise em tempo real</b> .  Para acompanhar as altera√ß√µes por um longo per√≠odo, seria bom ter uma <b>an√°lise retrospectiva</b> tamb√©m.  A degrada√ß√£o acima de um determinado n√≠vel (limites) pode afetar adversamente os usu√°rios - voc√™ precisa de uma <b>rea√ß√£o com degrada√ß√£o grave</b> . <br><br><blockquote>  N√£o precisamos dos logs marcados como Aviso, mas das m√©tricas de degrada√ß√£o. </blockquote><br>  A ferramenta de coleta de m√©tricas mais popular √© o Prometheus, e voc√™ pode usar o Grafana para visualiza√ß√£o.  Se voc√™ precisar de um contexto grande (o mesmo que o erro), o mesmo Sentry far√°, mas com os alertas desativados.  No entanto, na maioria dos casos, haver√° contexto suficiente.  Ser√° usado para gr√°ficos - etiquetas Prometheus. <br><br>  Exemplos. <br><div class="scrollable-table"><table><tbody><tr><td>  etiqueta <br></td><td>  exemplo 1 <br></td><td>  exemplo 2 <br></td><td>  exemplo 3 <br></td></tr><tr><td>  contexto <br></td><td>  db <br></td><td>  internal_service <br></td><td>  cache <br></td></tr><tr><td>  m√≥dulo <br></td><td>  user_service <br></td><td>  user_service <br></td><td>  user_service <br></td></tr><tr><td>  raz√£o <br></td><td>  long_query <br></td><td>  tentar novamente <br></td><td>  miss_cache <br></td></tr><tr><td>  outro <br></td><td>  get_user <br></td><td>  service_b <br></td><td>  user_permisson <br></td></tr></tbody></table></div><br>  Tr√™s eventos ocorreram no <code>user_service</code> condicional.  Eles afetam a opera√ß√£o do servi√ßo: uma longa solicita√ß√£o ao banco de dados, acesso repetido √† API do servi√ßo <code>service_b</code> e nenhum direito do usu√°rio foi encontrado no cache.  Gr√°ficos e alertas ser√£o configurados como importantes para os desenvolvedores do servi√ßo, gra√ßas ao contexto. <br><br><h3>  Rastreamento </h3><br>  Essa √© a primeira coisa a come√ßar, se escolhermos o caminho em que voc√™ precisa analisar os logs.  Por si s√≥, essas informa√ß√µes nos logs s√£o in√∫teis, porque voc√™ precisa criar cadeias de chamadas, ver dados dentro de solicita√ß√µes, erros nas cadeias de chamadas, tempos de resposta, o n√∫mero de RPS. <br><br>  Existem √≥timas ferramentas para rastreamento - Jaeger ou Zipkin.  Eu recomendo usar o OpenTracing, que ambos suportam. <br><br>  Voc√™ pode coletar o rastreamento de tr√™s fontes. <br><br><ul><li>  Se voc√™ usar <b>balanceadores</b> compartilhados, analise os logs deles e envie-os para o Jaeger. <br></li><li>  <b>Os pr√≥prios servi√ßos</b> , se receberem endere√ßos pelo Service Discovery e forem diretamente.  Nesse caso, o rastreamento dos servi√ßos √© enviado diretamente ao Jaeger. <br></li><li>  <b>Malha de servi√ßo</b> inteligente.  Ele sabe como coletar e enviar um rastreamento, por exemplo, Istio. <br></li></ul><br><br><h3>  Informa√ß√£o inicial </h3><br>  Essas informa√ß√µes s√£o sobre chamadas de servi√ßo da API, inicializa√ß√£o do Cron, consultas ao banco de dados ou chamadas para outros servi√ßos. <br><br><pre> <code class="plaintext hljs">{ "_message": "Request: ...; request_id: ...,... ", "_level": "INFO", "_time": "2019-03-08T12:04:05.000+07:00", "_context": "ryawvcHandler", "_tread": "785534" }</code> </pre> <br>  Essas informa√ß√µes pertencem ao bloco "Apenas no caso", mas s√£o separadas porque s√£o mais comuns.  Esta informa√ß√£o √© necess√°ria para analisar o erro e <b>voc√™ pode descart√°-lo</b> . <br><br>  Se as informa√ß√µes sobre chamadas para m√©todos internos s√£o extremamente importantes e voc√™ n√£o pode prescindir dela, mesmo com o contexto coletado em caso de erro, vale a pena instrumentar as chamadas de m√©todo como um rastreio. <br><br><h3>  Tempo de execu√ß√£o </h3><br>  Essas informa√ß√µes s√£o sobre o tempo de execu√ß√£o de m√©todos, APIs, consultas ao banco de dados ou outros servi√ßos. <br><br><pre> <code class="plaintext hljs">{ "_message": "Get customer 12ms", "_level": "INFO", "_time": "2019-03-08T12:04:05.000+07:00", "_context": "ryawvcCustomerRepository", "_tread": "785534" }</code> </pre> <br>  N√£o h√° valor nos logs, porque voc√™ precisa analisar essas informa√ß√µes, exibi-las nos gr√°ficos e configurar limites.  Esse tipo de log precisa ser substitu√≠do por <b>m√©tricas</b> , por exemplo, no Prometheus. <br><br><h3>  Informa√ß√µes comerciais </h3><br>  Essas informa√ß√µes s√£o necess√°rias para an√°lise de neg√≥cios, an√°lise de comportamento do cliente, c√°lculos financeiros.  Nesse local, historicamente usamos a abordagem oposta - logs analisados.  Mas este √© um bom exemplo do que os logs do aplicativo podem degenerar se voc√™ trabalhar com eles dessa maneira. <br><br>  Para logs com dados corporativos, acordos foram formados com campos fixos no formato TSKV, necess√°rios para an√°lises.  Os aplicativos gravaram logs de neg√≥cios em um arquivo dedicado.  Em seguida, os logs foram lidos e enviados linha a linha para o MQ, e um aplicativo separado os processou e os gravou no banco de dados.  Este √© um exemplo do que qualquer an√°lise se transforma. <br><br><blockquote>  N√£o funcionar√° para analisar todo o fluxo de logs na esperan√ßa de que os dados converjam. </blockquote><br>  Conven√ß√µes, formatos, regras e requisitos de confiabilidade est√£o surgindo.  Isso j√° se parece um pouco com os logs do aplicativo.  Nesse caso, o log se torna a fila de entrega de dados com todos os requisitos subsequentes para o MQ.  √â percept√≠vel que o middleware na forma de um log √© sup√©rfluo aqui. <br><br>  Uma boa solu√ß√£o √© enviar esses dados diretamente para o MQ.  J√° ser√£o processados, armazenados no armazenamento apropriado e usados ‚Äã‚Äãpela equipe de an√°lise.  Por exemplo, para exibi√ß√£o, usamos o Tableau. <br><br><h3>  Desempenho </h3><br>  Esse tipo de log raramente √© encontrado nos logs do aplicativo e √© mais frequentemente coletado como uma m√©trica.  Separadamente, acrescento que, para coletar as m√©tricas b√°sicas espec√≠ficas do idioma, basta usar a biblioteca do Prometheus.  Por padr√£o, ela coletar√° tudo o que alcan√ßar.  O custo de adicionar essas m√©tricas √© pequeno. <br><br><img src="https://habrastorage.org/webt/iz/od/jv/izodjvufyysy4-3ihlurtw9rueq.png"><br><br><h3>  Resultado de digita√ß√£o </h3><br>  Depois de classificar os logs por tipo, podemos pegar ferramentas mais poderosas para trabalhar com eles.  N√£o existem sistemas complexos ou tecnologias espaciais como a Amazon, n√£o h√° nada que n√£o possa ser criado amanh√£.  Voc√™ provavelmente j√° possui alguns desses sistemas ou an√°logos: Sentry est√° acumulando poeira em algum lugar, Prometheus est√° trabalhando em algum lugar. <br><br><img src="https://habrastorage.org/webt/69/jj/ik/69jjikx9uuyrghuq-1rpw0bu5o0.png"><br><br><blockquote>  O problema n√£o est√° na tecnologia, mas em uma armadilha cognitiva quando confiamos nos logs como um meio de representa√ß√£o confi√°vel do estado do nosso sistema.  N√£o √© assim, os logs s√£o um conjunto de eventos ca√≥ticos. </blockquote><br>  H√° uma exce√ß√£o - Debug-logs, que pode ser usada em casos raros. <br><br><h3>  Log de depura√ß√£o </h3><br>  Os logs de depura√ß√£o devem ser informa√ß√µes detalhadas.  Eles n√£o devem duplicar o que j√° est√° sendo enviado para os sistemas que descrevemos acima.  Este tipo existe para analisar casos especiais.  Por exemplo, um bug incompreens√≠vel ocorre na produ√ß√£o e, no momento, n√£o est√° claro pelas m√©tricas o que est√° acontecendo. <br><br>  <b>Ative os logs de depura√ß√£o a quente, sem reiniciar o servi√ßo</b> .  Como estamos falando de v√°rios servi√ßos, n√£o haver√° muitos deles.  Infraestrutura sofisticada n√£o √© necess√°ria.  Pilha de ELK suficiente sem "prepara√ß√£o" complicada.  Tamb√©m faz sentido adicionar um alerta ao Sentry com todo o contexto necess√°rio. <br><br>  <b>Os logs de depura√ß√£o podem ser usados ‚Äã‚Äãpara desenvolvimento</b> .  Mas eles s√£o perfeitamente substitu√≠dos por depura√ß√£o. <br><br><h2>  Resumir </h2><br>  <b>N√≥s escrevemos nossa entrega de registro de bicicleta para pesquisa</b> .  N√£o satisfazemos os clientes do servi√ßo - todos eles v√™m at√© n√≥s para analis√°-los, colet√°-los e agreg√°-los em algum lugar.  Isso pode ser evitado - sistemas complexos de processamento de logs n√£o s√£o necess√°rios. <br><br><blockquote>  Os logs brutos s√£o in√∫teis, mas podem ser transformados em m√©tricas √∫teis. </blockquote><br>  Basta criar uma infraestrutura para fornecer m√©tricas e dados √∫teis em torno dos servi√ßos.  Como resultado, ser√£o exibidas m√©tricas √∫teis que falam sobre servi√ßos e mostram transparentemente tudo o que acontece com eles. <br><br><blockquote>  Os erros devem conter o contexto do pr√≥prio erro. </blockquote><br>  Isso ajudar√° a lidar com isso e corrigi-lo imediatamente.  <b>Erros e degrada√ß√£o devem levar √† a√ß√£o</b> , para que os desenvolvedores aprendam instantaneamente sobre os problemas e os corrijam mesmo antes das solicita√ß√µes irritadas dos usu√°rios. <br><br>  <b>As ferramentas certas tornar√£o o trabalho com seus servi√ßos mais agrad√°vel e transparente</b> .  A depura√ß√£o tem um lugar para estar, mas voc√™ precisa ser rigoroso com ela. <br><br><blockquote>  No <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HighLoad ++ 2019</a> em novembro, haver√° uma se√ß√£o DevOps - 13 relat√≥rios sobre cargas na AWS, um sistema de monitoramento em Lamoda, transportadores para entrega de modelos, vida √∫til sem o Kubernetes e muito mais.  Veja a lista completa de t√≥picos e resumos na p√°gina separada ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Relat√≥rios</a> ‚Äù.  E nos encontraremos no DevOpsConf na primavera - inscreva-se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no boletim informativo</a> e informe-nos quando determinarmos as datas e o local. </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt468535/">https://habr.com/ru/post/pt468535/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt468523/index.html">De foguetes a rob√¥s e o que o Python tem a ver com isso. GeekBrains Alumni Story</a></li>
<li><a href="../pt468525/index.html">Brinquedos de madeira, parte um - 1982-1985</a></li>
<li><a href="../pt468529/index.html">Domando Gorynych ou Descompilando o eBPF em Ghidra</a></li>
<li><a href="../pt468531/index.html">O primeiro bot PHP para VKontakte</a></li>
<li><a href="../pt468533/index.html">Carona no DevOps com o Express 42</a></li>
<li><a href="../pt468537/index.html">No√ß√µes b√°sicas de DevOps. Entrada no projeto a partir do zero</a></li>
<li><a href="../pt468541/index.html">Arraste e solte componentes para usu√°rios cegos? Voc√™ est√° brincando</a></li>
<li><a href="../pt468543/index.html">Comit√™ do programa durante a semana FrontendConf. Entrevista com Sergey Popov</a></li>
<li><a href="../pt468545/index.html">"Alice, vamos para o frontend!"</a></li>
<li><a href="../pt468547/index.html">Falando Ingl√™s, CSS, Grade e Acessibilidade no FrontendConf</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>