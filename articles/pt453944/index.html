<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ°Ô∏è üçπ ü¶Ä Erros mascarados no embedd üåØ ü§æüèª ‚è™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Os plugues s√£o inevit√°veis ‚Äã‚Äãao desenvolver qualquer software. Em um embedd, seus generosos cinco centavos tamb√©m podem causar problemas de hardware, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Erros mascarados no embedd</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453944/">  Os plugues s√£o inevit√°veis ‚Äã‚Äãao desenvolver qualquer software.  Em um embedd, seus generosos cinco centavos tamb√©m podem causar problemas de hardware, mas essa √© uma m√∫sica separada.  Mas emboscadas puramente programadas, quando voc√™ fica preso em um lugar aparentemente vazio ... Para mim, existem tr√™s tipos deles. <br><br>  A maneira mais f√°cil √© quando o manual, o padr√£o ou, por exemplo, o procedimento para configurar a biblioteca para ferro n√£o √© totalmente compreendido.  Aqui est√° claro: nem todos os movimentos foram esgotados, paci√™ncia e trabalho, outros cinco ou dois experimentos, e ele ganhar√° vida.  Oscilosc√≥pio e tyk cient√≠fico para ajudar. <br><br><img src="https://habrastorage.org/webt/uy/nn/ia/uynniacpwibqxoyroe7zgfjijjy.png"><br>  <i>Escolhendo um divisor de frequ√™ncia para configurar o barramento CAN</i> <br><br>  Pior ainda, quando o problema √© um erro de digita√ß√£o ou um erro na l√≥gica que voc√™ n√£o consegue ver √† queima-roupa at√© percorrer este lugar vinte vezes com seus olhos e com a depura√ß√£o passo a passo.  Ent√£o amanhece, um golpe sonoro na testa, um grito: "Bem, voc√™ √© meio babai!", Editando.  Isso funciona. <br><br>  E uma terceira vis√£o sombria: uma falha entrincheirada em uma biblioteca estrangeira e rastejando no cruzamento com ferro.  As paix√µes shakespearianas d√£o origem √† luz constante de um monitor.  ‚ÄúPorque, n√£o pode, o sistema n√£o pode se comportar dessa maneira, porque nunca pode!  Bem, s√©rio!  Ah ?!  N√£o.  Receba, assine. <br><br>  Como resultado, a realidade √© mais ampla, mais ampla e mais ampla do que o esperado.  Alguns exemplos: <br><a name="habracut"></a><br><h2>  Hist√≥ria n¬∫ 1.  Unidade flash MicroSD e trabalho DMA </h2><br><h3>  Anamnese </h3><br>  Voc√™ precisa despejar os dados em um arquivo no cart√£o SD.  Obviamente, n√£o tenho tempo nem desejo de escrever o sistema de arquivos e o driver SDIO, ent√£o escolho a biblioteca finalizada.  Eu o configurei para ferro, e tudo funciona bem.  No come√ßo  E ent√£o os dados foram gravados descontroladamente: os volumes s√£o precisos, mas nos arquivos, pares de bytes separados s√£o duplicados e depois desaparecem, sem qualquer regularidade.  N√£o √© bom! <br><br>  As experi√™ncias come√ßam.  Estou escrevendo dados de teste - est√° tudo bem.  Estou escrevendo combate - algum tipo de dem√¥nio.  Eu mudo o tamanho dos buffers de dados, a frequ√™ncia de sua descarga, os modelos de dados s√£o in√∫teis.  Nos pr√≥prios buffers, tudo √© sempre excelente, os dados na mem√≥ria est√£o em toda parte o que voc√™ precisa.  E, no entanto, falhas em uma unidade flash - aqui est√£o elas. <br><br>  Demorou alguns dias para cavar o cachorro. <br><br><h3>  O diagn√≥stico </h3><br>  O problema estava na intera√ß√£o da biblioteca com o equipamento <abbr title="Acesso direto √† mem√≥ria. Transfer√™ncia de dados da RAM para a periferia ou vice-versa sem a participa√ß√£o do processador.">DMA</abbr> . <br><br>  Os cart√µes SD t√™m uma peculiaridade: eles s√£o gravados apenas em blocos de 512 bytes.  Para fazer isso, a biblioteca armazena em buffer os dados em uma matriz de 512 bytes e, ap√≥s preench√™-los, libera a partir da√≠ via DMA para piscar.  Mas! <br><br>  Se eu transferir para o registro um fragmento maior que &lt;512xN + espa√ßo vazio no buffer da biblioteca&gt; bytes, a biblioteca (obviamente, para n√£o empurrar a mem√≥ria para frente e para tr√°s) faz o seguinte: ela reabastece o buffer, grava-o para piscar e os pr√≥ximos bytes 512xN s√£o lan√ßados diretamente no meu DMA do meu buffer!  Bem, se algo for deixado inacabado - ele ser√° copiado novamente at√© a pr√≥xima vez. <br><br>  E tudo ficaria bem, mas o controlador DMA exige que os dados sejam colocados na mem√≥ria alinhados em um limite de 4 bytes.  O buffer da biblioteca est√° sempre t√£o alinhado que a linguagem garante isso.  Mas com que endere√ßo, depois de copiar uma parte dos dados, os restantes 512xN com um pequeno byte come√ßam comigo - Deus sabe.  E a biblioteca n√£o verifica isso: o endere√ßo, como √©, √© passado para o controlador DMA. <br><br>  "Eles enviaram algo desajeitado ... Um cachorro com ele."  O controlador silenciosamente redefine os 2 bits inferiores do endere√ßo transmitido.  E inicia a transfer√™ncia. <br><img src="https://habrastorage.org/webt/cj/vt/eg/cjvtegekkqclanfzdkv8v0xhfsy.png"><br><br>  O endere√ßo, inicialmente n√£o m√∫ltiplo de 4, √© substitu√≠do por um m√∫ltiplo - voila, at√© os √∫ltimos tr√™s bytes do buffer da biblioteca s√£o reescritos no arquivo do meu, e o mesmo n√∫mero de bytes do buffer √© perdido sem deixar rastro.  Como resultado, a quantidade total de dados est√° correta, as opera√ß√µes ocorrem sem problemas, mas o disco n√£o faz sentido. <br><br><h3>  Tratamento </h3><br>  Eu tive que adicionar outro buffer imediatamente antes de chamar a fun√ß√£o de grava√ß√£o de hardware.  Se o endere√ßo de grava√ß√£o n√£o for m√∫ltiplo de 4, os dados ser√£o copiados primeiro para ele.  Ao mesmo tempo, a velocidade m√©dia aumentou devido a uma escolha razo√°vel do tamanho do buffer.  Obviamente, foi preciso mem√≥ria, mas o que significa 4 kilobytes por uma boa causa, quando voc√™ tem √† sua disposi√ß√£o - 192 ilimitados! <br><br><h2>  Hist√≥ria No. 2.  Rantime e um monte </h2><br><h3>  Pr√≥logo </h3><br>  Ap√≥s a pr√≥xima altera√ß√£o, o programa come√ßou a cair e, de alguma forma, caiu muito, jogando o processador no manipulador de <abbr title="Falha grave. O estado do processador em que ele ocorre depois que algo realmente deu errado: por exemplo, ocorreu uma interrup√ß√£o de hardware e o processador n√£o p√¥de ler o endere√ßo da fun√ß√£o de manipulador correspondente">Hard Fault</abbr> .  E ele jogou l√° logo ap√≥s o in√≠cio, mesmo antes da execu√ß√£o chegar a main (), ou seja, nenhuma linha do meu c√≥digo teve tempo de executar. <br><br>  A primeira impress√£o √© "o castor est√° morto, o chip √© para substitui√ß√£o".  E ent√£o o programador deu o carvalho.  Mas n√£o, a vers√£o antiga do firmware funciona de forma est√°vel, mas a nova vers√£o cai constantemente em algumas profundidades obscuras de montagem entre o lan√ßamento e o meu c√≥digo.  Eu n√£o tinha suposi√ß√µes de que tipo de heresia isso era. <br><br><h3>  Cap√≠tulo 1 </h3><br>  Ajudou a Internet a observar como obter pelo menos algumas informa√ß√µes adicionais.  O procedimento para analisar as consequ√™ncias de um padr√£o r√≠gido foi pesquisado: estado dos registros, pilha de despejo.  Dopilil.  Usou. <br><br>  Acontece que ele trava devido a um erro de opera√ß√£o no barramento.  Decidi que isso era novamente um acesso desequilibrado - um problema do mesmo tipo que na primeira hist√≥ria, mas de uma perspectiva diferente.  Mas o mais oposto √© onde ocorreu o erro.  E surgiu dentro da biblioteca de tempo de execu√ß√£o, ou seja, no c√≥digo, que, em teoria, era lambido como os machucados do gato em um dia ensolarado. <br><br>  A continua√ß√£o da an√°lise mostrou que a falha √© uma consequ√™ncia de uma tentativa de inicializar vari√°veis ‚Äã‚Äãest√°ticas locais. <br><br><div class="spoiler">  <b class="spoiler_title">Digress√£o l√≠rica</b> <div class="spoiler_text">  A prop√≥sito, considerando o c√≥digo desmontado, eu encontrei simultaneamente a resposta para uma pergunta que √†s vezes me perguntava, mas estava com pregui√ßa de pesquisar imediatamente: como a situa√ß√£o √© resolvida quando 2 ou mais threads podem tentar inicializar essa vari√°vel ao mesmo tempo.  Verificou-se que, nesse caso, o compilador organiza a inicializa√ß√£o com sem√°foros, garantindo que apenas um thread de cada vez passar√° por todo o procedimento, e o restante aguardar√° at√© que o primeiro termine.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Esse comportamento foi padronizado desde o C ++ 11.</a>  Voc√™ sabia  Eu n√£o </div></div><br><h3>  Cap√≠tulo 2 </h3><br>  Uma vez que o tempo de execu√ß√£o est√° envolvido na constru√ß√£o de vari√°veis, √© tamb√©m para ele chamar destruidores ap√≥s a conclus√£o do programa (mesmo que o programa nunca realmente conclua o trabalho, que √© a norma absoluta para os microcontroladores).  Para fazer isso, ele precisa de um local para armazenar informa√ß√µes sobre todas as vari√°veis ‚Äã‚Äãque ele conseguiu inicializar. <br><br>  √â exatamente no local em que essas informa√ß√µes s√£o armazenadas em algum tipo de lista interna, o tempo de execu√ß√£o tamb√©m caiu.  Como a fun√ß√£o malloc (), atrav√©s da qual a mem√≥ria foi alocada para os elementos desta lista e que, de acordo com o padr√£o, produz blocos garantidos para serem alinhados <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pelo menos no limite de 8 bytes</a> , ap√≥s um n-√©simo n√∫mero de chamadas bem-sucedidas, produz uma pe√ßa que n√£o est√° alinhada nesse limite. <br><br><img src="https://habrastorage.org/webt/sx/0c/bw/sx0cbwlau__vlj2kwrdznxmehew.jpeg"><br><br>  Altera√ß√µes no novo c√≥digo de firmware quebraram malloc ?!  Mas como isso √© poss√≠vel?  N√£o redefini exatamente o malloc; eu mesmo n√£o preciso dele em nenhum outro lugar! <br><br>  √ötil nas op√ß√µes do compilador, para procurar por algumas palavras-chave, ajuda, mas foi dito claramente em todos os lugares: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">malloc () garante a sa√≠da da mem√≥ria alinhada ao longo do limite fundamental.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ou ponteiro nulo, caso n√£o haja mem√≥ria suficiente</a> . <br><br><h3>  Cap√≠tulo 3 </h3><br>  Por um longo tempo, fiquei sem sentido no c√≥digo, estabeleci pontos de interrup√ß√£o, sofri e n√£o entendi nada, at√© que, em algum momento, n√£o deu certo e observei os endere√ßos retornados pelo malloc com cuidado.  Antes disso, toda a an√°lise era para verificar se o √∫ltimo d√≠gito do endere√ßo √© 0x4.  E agora ele come√ßou a comparar inteiramente entre si endere√ßos emitidos por chamadas sucessivas para malloc. <br><br>  E oh, um milagre! <br><br>  Todas as chamadas bem-sucedidas emitiram endere√ßos do espa√ßo RAM (0x20000000 e mais antigo para esta pedra), aumentando seq√ºencialmente de uma chamada para outra.  E o primeiro malsucedido retornou 0x00000036.  Ou seja, o endere√ßo n√£o apenas n√£o estava alinhado, mas tamb√©m n√£o estava no espa√ßo de endere√ßo da RAM!  O processador tentou escrever algo l√° e naturalmente caiu. <br><br>  E, surpreendentemente, mesmo que malloc () agisse de acordo com o padr√£o e retornasse 0 se n√£o houvesse espa√ßo suficiente, isso n√£o teria mudado nada no sentido de uma falha no programa (a menos que a causa do bug tivesse sido esclarecida anteriormente).  O valor retornado pelo malloc ainda n√£o √© verificado, mas entra em a√ß√£o imediatamente.  Isso est√° em tempo de execu√ß√£o. <br><br><h3>  Ep√≠logo </h3><br>  Aumentou o tamanho da pilha no arquivo de configura√ß√£o e tudo foi corrigido. <br><br>  Mas antes desse momento, eu nem pensava no volume.  Se o inferno se rendeu a mim, pensei.  Enfim, tenho todas as vari√°veis ‚Äã‚Äãe objetos est√°ticos ou na pilha.  Portanto, apenas por in√©rcia, deixei 0x300 bytes sob ele, pois algum volume no heap √© alocado em todos os projetos de modelo.  Mas n√£o, o tempo de execu√ß√£o C ++ ainda precisa de mem√≥ria alocada dinamicamente, e em quantidades bastante vis√≠veis, pelos padr√µes dos controladores. <br><br>  Viva e aprenda. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt453944/">https://habr.com/ru/post/pt453944/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt453930/index.html">Compara√ß√£o e sele√ß√£o de sistemas de migra√ß√£o de dados</a></li>
<li><a href="../pt453932/index.html">Algumas palavras em defesa do mon√≥lito</a></li>
<li><a href="../pt453934/index.html">11 perguntas a discutir antes de come√ßar o trabalho</a></li>
<li><a href="../pt453938/index.html">Rastreamento de bicicleta roubada NB-IoT</a></li>
<li><a href="../pt453942/index.html">Sobre √©tica com o exemplo do PMI Codex</a></li>
<li><a href="../pt453950/index.html">Voc√™ deveria estar aqui! 22 anos do lan√ßamento do lend√°rio jogo Duke Nukem 3D</a></li>
<li><a href="../pt453952/index.html">‚ÄúA solicita√ß√£o amadureceu‚Äù: Alexei Fedorov sobre uma nova confer√™ncia sobre sistemas distribu√≠dos</a></li>
<li><a href="../pt453956/index.html">Museum DataArt. Terminal de v√≠deo ADM-3A. O carro √© pesado, confi√°vel, abate</a></li>
<li><a href="../pt453958/index.html">Monoreposit√≥rios: por favor</a></li>
<li><a href="../pt453960/index.html">Global DevOps Bootcamp 2019 em Moscou</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>