<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïû ü§± üë©üèº‚Äçü§ù‚Äçüë®üèΩ Identifique o bloqueio de PKH em um roteador OpenWrt com WireGuard e DNSCrypt üòò üçñ üë®üèæ‚Äç‚öñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Qual √© a diferen√ßa de materiais semelhantes? 


- Implementa√ß√£o pura do OpenWrt 
- Usando o WireGuard 
- A configura√ß√£o do roteador √© organizada usand...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Identifique o bloqueio de PKH em um roteador OpenWrt com WireGuard e DNSCrypt</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440030/"><h2 id="chem-otlichaetsya-ot-podobnyh-materialov">  Qual √© a diferen√ßa de materiais semelhantes? </h2><br><ul><li>  Implementa√ß√£o pura do OpenWrt </li><li>  Usando o WireGuard </li><li>  A configura√ß√£o do roteador √© organizada usando configura√ß√µes OpenWrt, e n√£o um monte em um script </li><li>  Existem situa√ß√µes ao reiniciar a rede e reiniciar </li><li>  Consome poucos recursos do roteador: sub-redes bloqueadas est√£o contidas nas tabelas de ip e n√£o nas tabelas de roteamento.  O que permite que voc√™ implante esse neg√≥cio, mesmo em dispositivos fracos </li><li>  Automatize a configura√ß√£o usando o Ansible (nenhum python √© necess√°rio no roteador) </li></ul><a name="habracut"></a><br><h2 id="videoversiya">  Vers√£o em v√≠deo </h2><br><iframe width="560" height="315" src="https://www.youtube.com/embed/GMvEF0PXN-w" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2 id="pochemu-openwrt-i-wireguard">  Por que OpenWrt e WireGuard? </h2><br><p>  O OpenWrt √© instalado em tantos modelos de roteadores soho, √© configurado e expandido conforme seu cora√ß√£o deseja.  Agora, muitos firmwares de roteador s√£o complementos pelo OpenWrt. </p><br><p>  O Wireguard √© usado devido √† sua configura√ß√£o r√°pida e f√°cil e tamb√©m devido √† alta velocidade de transmiss√£o atrav√©s do t√∫nel. </p><br><h2 id="nemnogo-o-wireguard">  Um pouco sobre o WireGuard </h2><br><p>  No nosso caso, o servidor √© um VPS fora do ILV, o cliente √© um roteador OpenWrt em casa.  Quando voc√™ quer ir para <del>  pornolab </del>  telegrama, seu roteador direcionar√° o tr√°fego atrav√©s de um servidor com o WireGuard. <br>  O WireGuard gera uma conex√£o site a site, ou seja,  o servidor e o cliente t√™m o lado servidor e cliente da configura√ß√£o.  Se n√£o estiver claro, ficar√° claro quando voc√™ ver a configura√ß√£o. </p><br><p>  O servidor e o cliente t√™m suas pr√≥prias chaves p√∫blicas e privadas. </p><br><h2 id="nastroyka-wireguard-na-servere">  Configurando o WireGuard no servidor </h2><br><p>  Estou fazendo tudo no Ubuntu 18.04, mas na documenta√ß√£o oficial h√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="instru√ß√µes de instala√ß√£o">instru√ß√µes de instala√ß√£o</a> para todos os SO conhecidos e n√£o muito. </p><br><h3 id="ustanovka">  Instala√ß√£o </h3><br><pre><code class="bash hljs">sudo add-apt-repository ppa:wireguard/wireguard</code> </pre> <br><blockquote>  Se ocorrer um erro <br><pre> <code class="bash hljs">sudo: add-apt-repository: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> not found</code> </pre> <br><br>  Instalar software-properties-common - o pacote oferece a capacidade de adicionar e remover PPA <br><pre> <code class="bash hljs">sudo apt install software-properties-common</code> </pre> <br></blockquote><br><pre> <code class="bash hljs">sudo apt update sudo apt install wireguard-dkms wireguard-tools</code> </pre> <br><p>  Geramos chaves para o servidor.  Salvaremos as chaves no diret√≥rio WireGuard por conveni√™ncia. </p><br><pre> <code class="plaintext hljs">cd /etc/wireguard/ wg genkey | tee privatekey-server | wg pubkey &gt; publickey-server</code> </pre> <br><p>  Consequentemente, haver√° uma chave privada no arquivo privatekey-server e uma chave p√∫blica no publickey-server. <br>  Tamb√©m geramos imediatamente uma chave para o cliente: </p><br><pre> <code class="plaintext hljs">wg genkey | tee privatekey-client | wg pubkey &gt; publickey-client</code> </pre> <br><p><img src="https://habrastorage.org/webt/k4/xo/m5/k4xom503xmvyxdhjsvelqhaslxo.png"></p><br><h3 id="konfiguraciya">  Configura√ß√£o </h3><br><p>  A configura√ß√£o √© armazenada em /etc/wireguard/wg0.conf.  O lado do servidor fica assim: </p><br><pre> <code class="bash hljs">[Interface] Address = 192.168.100.1 PrivateKey = privatekey-server ListenPort = 51820 PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o ens3 -j MASQUERADE PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o ens3 -j MASQUERADE</code> </pre> <br><p>  <strong>Endere√ßo</strong> - endere√ßo da interface wg (endere√ßo dentro do t√∫nel) <br>  <strong>PrivateKey</strong> - Chave privada (privatekey-server) <br>  <strong>ListenPort</strong> - a porta na qual o servi√ßo est√° aguardando a conex√£o </p><br><p>  Bem, n√≥s fazemos disfarces, porque usaremos este servidor para acessar a Internet <br>  Observe que o nome da interface no seu caso pode ser diferente: </p><br><p>  Parte do cliente </p><br><pre> <code class="bash hljs">[Peer] PublicKey = publickey-client AllowedIPs = 192.168.100.3/24</code> </pre> <br><p>  <strong>PublicKey</strong> - a chave p√∫blica do nosso roteador (publickey-client) <br>  <strong>IPs permitidos</strong> s√£o as sub-redes que estar√£o dispon√≠veis nesse t√∫nel.  O servidor precisa apenas acessar o endere√ßo do cliente. </p><br><p>  Ambas as partes s√£o armazenadas em uma configura√ß√£o. </p><br><p>  Ative a inicializa√ß√£o autom√°tica na reinicializa√ß√£o: </p><br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> wg-quick@wg0</code> </pre> <br><p>  Tornamos o servidor um roteador: </p><br><pre> <code class="bash hljs">sysctl -w net.ipv4.ip_forward=1</code> </pre> <br><p>  Configure o firewall.  Suponha que apenas tenha WireGuard e ssh em nosso servidor: </p><br><pre> <code class="bash hljs">sudo iptables -A INPUT -i lo -j ACCEPT sudo iptables -A INPUT -p udp -m udp --dport 51820 -j ACCEPT sudo iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -p icmp -j ACCEPT sudo iptables -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT sudo iptables -A INPUT -j DROP</code> </pre> <br><p>  Salve a configura√ß√£o do iptables: </p><br><pre> <code class="bash hljs">sudo apt-get install iptables-persistent sudo netfilter-persistent save</code> </pre> <br><p>  Aumentamos a interface wg pela primeira vez manualmente: </p><br><pre> <code class="bash hljs">wg-quick up wg0</code> </pre> <br><p><img src="https://habrastorage.org/webt/1_/me/ai/1_meai1la87gto2qfa7vwmcfmju.png"></p><br><p>  O servidor WireGuard est√° pronto. </p><br><p>  <strong>UPD 27/06/19</strong> Se o seu provedor ainda usa PPoE, voc√™ precisa adicionar uma regra.  Obrigado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">denix123</a> </p><br><pre> <code class="plaintext hljs">iptables -t mangle -I POSTROUTING -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu</code> </pre> <br><h2 id="nastroyka-routera">  Configura√ß√£o do roteador </h2><br><p>  Estou usando o OpenWrt vers√£o 18.06.1 no Xiaomi mi 3G e no Asus RT-N16. </p><br><h3 id="logika-raboty-routera">  A l√≥gica do roteador </h3><br><p>  Carregamos as listas, colocamos em iptables, iptables marca todos os endere√ßos dessas listas com um marcador 0x1.  Al√©m disso, todos os pacotes marcados com 0x1 v√£o para uma tabela de roteamento separada, todos os pacotes que caem nessa tabela de roteamento passam pela interface wg. </p><br><p><img src="https://habrastorage.org/webt/vy/rc/ji/vyrcjihaaozo-vzf1nkm9nlxpl0.gif"></p><br><h3 id="ustanovka-paketov">  Instala√ß√£o do pacote </h3><br><p>  Quanto ao espa√ßo ocupado no flash, tudo precisar√° de aproximadamente 0,9 MB.  Se voc√™ tiver um p√©ssimo lugar, substitua curl pelo wget e talvez n√£o seja necess√°rio instalar o dnscrypt-proxy. </p><br><p>  N√≥s colocamos pacotes.  No OpenWrt, isso √© f√°cil atrav√©s do gerenciador de pacotes opkg: </p><br><pre> <code class="bash hljs">opkg update opkg install ipset wireguard curl</code> </pre> <br><h3 id="zagruzka-spiskov">  Listas de downloads </h3><br><p>  Tudo o que pode ser feito atrav√©s dos recursos padr√£o do OpenWrt √© feito atrav√©s deles.  Tudo o resto (exceto hotplug) eu coloquei em um pequeno script: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh START=99 dir=/tmp/lst mkdir -p $dir echo "Run download lists" curl -z $dir/subnet.lst https://antifilter.download/list/subnet.lst --output $dir/subnet.lst curl -z $dir/ipsum.lst https://antifilter.download/list/ipsum.lst --output $dir/ipsum.lst echo "Firewall restart" /etc/init.d/firewall restart</span></span></code> </pre> <br><p>  As listas de sub-redes e endere√ßos proibidos s√£o obtidas por arquivos.  Para eles, criamos um diret√≥rio em / tmp.  Em / tmp - por ser RAM, esse recurso do OpenWrt √© bastante conveniente.  N√£o vale a pena escrever algo na ROM do roteador novamente. </p><br><p>  Distribu√≠mos as listas com o antifilter.download curl, o sinalizador z significa que o curl baixar√° o arquivo apenas se o arquivo remoto for diferente do local ou se n√£o, como, por exemplo, ao carregar um roteador. </p><br><p>  <em>subnet.lst</em> - uma lista de sub-redes bloqueadas, que n√£o muda frequentemente. <br>  <em>ipsum.lst</em> √© uma lista de endere√ßos bloqueados, resumidos pela m√°scara.  Em vez de 150 mil registros, obtemos 15 mil - convenientemente. </p><br><p>  Depois que tivermos os arquivos, reiniciarmos o firewall, isso √© necess√°rio para o ipset funcionar e adicionar listas ao iptables, configuraremos o ipset em / etc / config / firewall. </p><br><p>  Este script que adicionamos no /etc/init.d/ ser√° chamado hirkn.  Torne execut√°vel </p><br><pre> <code class="bash hljs">chmod +x /etc/init.d/hirkn</code> </pre> <br><p>  Agora, n√£o temos apenas um script, mas um servi√ßo completo.  Para iniciar na inicializa√ß√£o, criamos um link simb√≥lico em /etc/rc.d.  Precisamos que ele inicie ap√≥s todos os outros servi√ßos, portanto criamos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="prefixo S99">prefixo S99</a> </p><br><pre> <code class="bash hljs">ln -s /etc/init.d/hirkn /etc/rc.d/S99hirkn</code> </pre> <br><p>  As listas precisam ser atualizadas periodicamente; adicionamos registro no cron: </p><br><pre> <code class="bash hljs">crontab -e</code> </pre> <br><pre> <code class="bash hljs">0 4 * * * /etc/init.d/hirkn</code> </pre> <br><p>  Parece bastante suficiente atualiz√°-los uma vez por dia.  Lembre-se de que, ao adicionar listas ao ipset, a rede cai; no meu caso, s√£o 2 segundos. <br>  <strong>UPD</strong> : Se voc√™ n√£o quer quebras, ent√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">sigo73</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Grayver</a> sugeriram nos coment√°rios como fazer isso. </p><br><p>  Ligue tamb√©m a coroa, por padr√£o ela est√° desativada: </p><br><pre> <code class="bash hljs">/etc/init.d/cron <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> /etc/init.d/cron start</code> </pre> <br><h3 id="konfiguraciya-tablicy-marshrutizacii">  Configura√ß√£o da tabela de roteamento </h3><br><p>  Crie uma tabela de roteamento para o tr√°fego atrav√©s do t√∫nel, simplesmente adicionando a linha: </p><br><pre> <code class="bash hljs">99 vpn</code> </pre> <br><p>  para o arquivo / etc / iproute2 / rt_tables. </p><br><p>  Voc√™ pode criar uma rota padr√£o para a tabela "vpn" atrav√©s da interface wg com o comando: </p><br><pre> <code class="bash hljs">ip route add table vpn default dev wg0</code> </pre> <br><p>  Por√©m, quando voc√™ reinicia a rede, a rota desaparece, e criamos o arquivo 30-rknroute no diret√≥rio /etc/hotplug.d/iface/ com conte√∫do simples: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ip route add table vpn default dev wg0</span></span></code> </pre> <br><p>  Isso significa que, quando voc√™ liga / desliga as interfaces, nossa rota ser√° adicionada.  E, portanto, essa rota ser√° sempre registrada. </p><br><h3 id="konfiguraciya-seti">  Configura√ß√£o de rede </h3><br><p>  Precisamos configurar o WireGuard e a regra para pacotes rotulados como 0x1. </p><br><p>  A configura√ß√£o do WireGuard est√° localizada em / etc / config / network </p><br><p>  A parte "servidor": </p><br><pre> <code class="bash hljs">config interface <span class="hljs-string"><span class="hljs-string">'wg0'</span></span> option private_key <span class="hljs-string"><span class="hljs-string">'privatekey-client'</span></span> list addresses <span class="hljs-string"><span class="hljs-string">'192.168.100.3/24'</span></span> option listen_port <span class="hljs-string"><span class="hljs-string">'51820'</span></span> option proto <span class="hljs-string"><span class="hljs-string">'wireguard'</span></span></code> </pre> <br><p>  <strong>private_key</strong> √© o privatekey-client que geramos ao configurar o servidor <br>  <strong>listar endere√ßos</strong> - endere√ßo da interface wg <br>  <strong>listen_port</strong> - a porta na qual o WireGuard aceita conex√µes.  Mas a conex√£o ocorrer√° atrav√©s da porta no servidor, portanto, aqui n√£o abriremos a porta no firewall para ela <br>  <strong>proto</strong> - especifique o protocolo para que o openwrt entenda que esta √© uma configura√ß√£o do WireGuard </p><br><p>  Parte "Cliente": </p><br><pre> <code class="bash hljs">config wireguard_wg0 option public_key <span class="hljs-string"><span class="hljs-string">'publickey-server'</span></span> option allowed_ips <span class="hljs-string"><span class="hljs-string">'0.0.0.0/0'</span></span> option route_allowed_ips <span class="hljs-string"><span class="hljs-string">'0'</span></span> option endpoint_host <span class="hljs-string"><span class="hljs-string">'wg-server-ip'</span></span> option persistent_keepalive <span class="hljs-string"><span class="hljs-string">'25'</span></span> option endpoint_port <span class="hljs-string"><span class="hljs-string">'51820'</span></span></code> </pre> <br><p>  <strong>public_key</strong> - chave publickey-server <br>  <strong>allowed_ips</strong> - sub-redes nas quais o tr√°fego pode passar pelo t√∫nel; no nosso caso, n√£o s√£o necess√°rias restri√ß√µes; portanto, 0.0.0.0/0 <br>  <strong>route_allowed_ips</strong> - um sinalizador que faz uma rota atrav√©s da interface wg para as redes listadas a partir do par√¢metro allowed_ips.  No nosso caso, isso n√£o √© necess√°rio, o iptables faz este trabalho <br>  <strong>endpoint_host</strong> - ip / url do nosso servidor wg <br>  <strong>persistent_keepalive</strong> - intervalo de tempo ap√≥s o qual os pacotes s√£o enviados para suportar a conex√£o <br>  <strong>endpoint_port</strong> - porta wireguard no servidor </p><br><p>  Tamb√©m adicionaremos uma regra √† configura√ß√£o da rede que enviar√° todo o tr√°fego marcado como 0x1 para a tabela de roteamento "vpn": </p><br><pre> <code class="bash hljs">config rule option priority <span class="hljs-string"><span class="hljs-string">'100'</span></span> option lookup <span class="hljs-string"><span class="hljs-string">'vpn'</span></span> option mark <span class="hljs-string"><span class="hljs-string">'0x1'</span></span></code> </pre> <br><h3 id="konfiguraciya-firewall">  Configura√ß√£o de firewall </h3><br><p><del>  N√≥s adicionamos duas regras para marcar pacotes, que n√£o se encaixam na sintaxe UCI openwrt, portanto as adicionamos "como est√£o" ao /etc/firewall.user. </del><br>  <strong>UPD</strong> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Grayver</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="sugerido">sugeriu</a> que eles se encaixassem muito bem.  N√≥s os definimos depois de configurar o ipset </p><br><p>  A configura√ß√£o do firewall est√° em / etc / config / firewall </p><br><p>  Adicione uma zona para wireguard.  No openwrt, as zonas s√£o cadeias personalizadas no iptables.  Assim, uma zona com uma / v√°rias interfaces √© criada e as regras j√° est√£o penduradas nela.  A zona para wg fica assim: </p><br><pre> <code class="bash hljs">config zone option name <span class="hljs-string"><span class="hljs-string">'wg'</span></span> option family <span class="hljs-string"><span class="hljs-string">'ipv4'</span></span> option masq <span class="hljs-string"><span class="hljs-string">'1'</span></span> option output <span class="hljs-string"><span class="hljs-string">'ACCEPT'</span></span> option forward <span class="hljs-string"><span class="hljs-string">'REJECT'</span></span> option input <span class="hljs-string"><span class="hljs-string">'REJECT'</span></span> option mtu_fix <span class="hljs-string"><span class="hljs-string">'1'</span></span> option network <span class="hljs-string"><span class="hljs-string">'wg0'</span></span></code> </pre> <br><p>  Permitimos apenas que o tr√°fego saia da interface e habilitemos o mascaramento. </p><br><p>  Agora voc√™ precisa habilitar o encaminhamento da zona lan para a zona wg: </p><br><pre> <code class="bash hljs">config forwarding option src <span class="hljs-string"><span class="hljs-string">'lan'</span></span> option dest <span class="hljs-string"><span class="hljs-string">'wg'</span></span></code> </pre> <br><p>  Bem, a √∫ltima coisa √© criar listas no iptables usando o ipset: </p><br><pre> <code class="bash hljs">config ipset option name <span class="hljs-string"><span class="hljs-string">'vpn_subnets'</span></span> option storage <span class="hljs-string"><span class="hljs-string">'hash'</span></span> option loadfile <span class="hljs-string"><span class="hljs-string">'/tmp/lst/subnet.lst'</span></span> option match <span class="hljs-string"><span class="hljs-string">'dst_net'</span></span> config ipset option name <span class="hljs-string"><span class="hljs-string">'vpn_ipsum'</span></span> option storage <span class="hljs-string"><span class="hljs-string">'hash'</span></span> option loadfile <span class="hljs-string"><span class="hljs-string">'/tmp/lst/ipsum.lst'</span></span> option match <span class="hljs-string"><span class="hljs-string">'dst_net'</span></span></code> </pre> <br><p>  <strong>loadfile</strong> - o arquivo do qual tiramos a lista <br>  <strong>nome</strong> - nome da nossa lista <br>  <strong>armazenamento</strong> , <strong>correspond√™ncia</strong> - aqui especificamos como armazenar e que tipo de dados.  Vamos armazenar o tipo "sub-rede" </p><br><p>  <strong>UPD</strong> : Se voc√™ quiser usar a lista de endere√ßos IP individuais, precisar√° aumentar o tamanho da lista de ipsets.  No ipset de configura√ß√£o, adicione </p><br><pre> <code class="plaintext hljs"> option hashsize '1000000' option maxelem '1000000'</code> </pre> <br><p>  Caso contr√°rio, voc√™ receber√° um erro </p><br><pre> <code class="plaintext hljs">ipset v6.38: Hash is full, cannot add more elements</code> </pre> <br><p>  <strong>UPD</strong> : adicione duas regras para rotular pacotes </p><br><pre> <code class="plaintext hljs">config rule option name 'mark_subnet' option src 'lan' option proto 'all' option ipset 'vpn_subnets' option set_mark '0x1' option target 'MARK' config rule option name 'mark_ipsum' option src 'lan' option proto 'all' option ipset 'vpn_ipsum' option set_mark '0x1' option target 'MARK'</code> </pre> <br><p>  Essas regras implicam que todos os pacotes que v√£o para as sub-redes das listas vpn_subnets e vpn_ipsum devem ser marcados com 0x1. </p><br><p>  Depois disso, reiniciaremos a rede: </p><br><pre> <code class="bash hljs">/etc/init.d/network restart</code> </pre> <br><p><img src="https://habrastorage.org/webt/e6/pm/m6/e6pmm6etqcw0dbz-c3ddqmzqemo.png"></p><br><p>  e execute o script: </p><br><pre> <code class="bash hljs">/etc/init.d/hirkn</code> </pre> <br><p><img src="https://habrastorage.org/webt/e4/q-/6r/e4q-6rktvq2y8znvhmtpxfdsnwi.gif"></p><br><p>  Depois de elaborar o script, tudo deve funcionar para voc√™.  Verifique a rota no cliente do roteador: </p><br><pre> <code class="bash hljs">mtr/traceroute telegram.org/linkedin.com</code> </pre> <br><p><img src="https://habrastorage.org/webt/wp/6e/jp/wp6ejpwtfwu9xkk-iizc8qj_aeu.gif"></p><br><h2 id="bonusom-nastroim-dnscrypt">  B√¥nus de configura√ß√£o do DNSCrypt </h2><br><p>  Porque  Seu provedor pode substituir cuidadosamente o endere√ßo IP do recurso bloqueado, redirecionando voc√™ para seu IP com um stub. Bem, nosso desvio de IP n√£o ajudar√° nesse caso.  Para substitui√ß√£o, nem sempre √© necess√°rio usar o servidor DNS do provedor, suas solicita√ß√µes podem ser interceptadas e as respostas ser√£o substitu√≠das.  Bem, a prop√≥sito, n√£o apenas o provedor pode fazer isso. </p><br><pre> <code class="bash hljs">opkg install dnscrpt-proxy</code> </pre> <br><p>  Configure a configura√ß√£o / etc / config / dnscrypt-proxy da seguinte maneira: </p><br><pre> <code class="bash hljs">config dnscrypt-proxy ns1 option address <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span> option port <span class="hljs-string"><span class="hljs-string">'5353'</span></span> option resolver <span class="hljs-string"><span class="hljs-string">'cpunks-ru'</span></span></code> </pre> <br><p>  Portanto, temos o servi√ßo dnscrypt na porta 5353 dispon√≠vel no host local. </p><br><p>  <strong>Resolver</strong> √© um servidor DNS que suporta criptografia.  No roteador, o arquivo /usr/share/dnscrypt-proxy/dnscrypt-resolvers.csv cont√©m uma lista de servidores dispon√≠veis no momento do lan√ßamento da vers√£o instalada do dnscrypt.  E aqui est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://dnscrypt.info/public-servers/</a> em geral todos os servidores dnscrypt dispon√≠veis.  Voc√™ pode escolher outro resolvedor e / ou adicionar servidores para toler√¢ncia a falhas.  Lembre-se de que, para o DNSCrypt funcionar com o resolvedor selecionado, ele deve ser especificado em dnscrypt-resolvers.csv. </p><br><p>  Configuramos o dnsmasq para funcionar com o dnscrypt.  Em / etc / config / dhcp, comente a linha: </p><br><pre> <code class="bash hljs">option resolvfile <span class="hljs-string"><span class="hljs-string">'/tmp/resolv.conf.auto'</span></span></code> </pre> <br><p>  para que os servidores DNS do provedor n√£o estejam envolvidos. </p><br><p>  E adicione: </p><br><pre> <code class="bash hljs"> list server <span class="hljs-string"><span class="hljs-string">'/pool.ntp.org/208.67.222.222'</span></span> list server <span class="hljs-string"><span class="hljs-string">'127.0.0.1#5353'</span></span></code> </pre> <br><p>  A <strong>entrada 'domain / ip_dns' do servidor de lista</strong> indica qual servidor DNS usar para resolver o dom√≠nio especificado.  Portanto, n√£o usamos dnscrypt para sincroniza√ß√£o ntp - √© importante que o servi√ßo dnscrypt tenha a hora atual. </p><br><p><del>  Quando o roteador √© carregado, o script hirkn √© executado mais rapidamente do que o dnscrypt inicia, para que o dom√≠nio antifilter.download n√£o seja resolvido e as listas n√£o sejam baixadas.  Voc√™ pode adiar ou algo mais, mas at√© agora n√£o vejo raz√£o. </del><br>  <strong>UPD</strong> : precisa adicionar uma linha </p><br><pre> <code class="plaintext hljs">START=99</code> </pre> <br><p>  script hirkn </p><br><p>  Como resultado, obtemos essa inser√ß√£o na configura√ß√£o: </p><br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#option resolvfile '/tmp/resolv.conf.auto' list server '/pool.ntp.org/208.67.222.222' list server '127.0.0.1#5353'</span></span></code> </pre> <br><p>  <strong>UPD</strong> : Em alguns dispositivos, o DNSCrypt √© iniciado assim mesmo ap√≥s o script.  A maneira mais f√°cil de corrigir isso √© adicionar a linha em / etc / config / dhcp </p><br><pre> <code class="plaintext hljs"> list server '/antifilter.download/208.67.222.222'</code> </pre> <br><p>  Desabilitar o uso do DNS do provedor para a interface wan <br>  Em / etc / config / network, adicione a linha </p><br><pre> <code class="plaintext hljs">option peerdns '0'</code> </pre> <br><p>  para a interface wan. <br>  Temos essa configura√ß√£o </p><br><pre> <code class="bash hljs">config interface <span class="hljs-string"><span class="hljs-string">'wan'</span></span> option ifname <span class="hljs-string"><span class="hljs-string">'eth0.2'</span></span> option proto <span class="hljs-string"><span class="hljs-string">'dhcp'</span></span> option peerdns <span class="hljs-string"><span class="hljs-string">'0'</span></span></code> </pre> <br><p>  Reinicie a rede </p><br><pre> <code class="plaintext hljs">/etc/init.d/network restart</code> </pre> <br><p>  Adicione √† inicializa√ß√£o e inicie o dnscrypt: </p><br><pre> <code class="bash hljs">/etc/init.d/dnscrypt-proxy <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> /etc/init.d/dnscrypt-proxy start</code> </pre> <br><p>  Reinicie o dnsmasq: </p><br><pre> <code class="bash hljs">/etc/init.d/dnsmasq restart</code> </pre> <br><p><img src="https://habrastorage.org/webt/i2/b5/90/i2b590nxr6-lqnk1h2-tq-i6t-4.gif"><br>  <em>Ilustra√ß√£o do trabalho sem DNSCrypt e com DNSCrypt</em> </p><br><h2 id="avtomaticheski-razvertyvaem-s-pomoschyu-ansible">  Implantado automaticamente com o Ansible </h2><br><p>  Playbook e modelos est√£o no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="github">github</a> .  Ele usa um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">m√≥dulo</a> , n√£o precisa de python no roteador e h√° suporte para uci.  Tentei garantir que sua configura√ß√£o do OpenWrt permanecesse intocada, mas tome cuidado de qualquer maneira. </p><br><p>  Instale o m√≥dulo gekmihesg / ansible-openwrt: </p><br><pre> <code class="bash hljs">ansible-galaxy install gekmihesg.openwrt</code> </pre> <br><p>  Copie o playbook e tempeyta: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/ansible git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/itdoginfo/ansible-openwrt-hirkn mv ansible-openwrt-hirkn/* . rm -rf ansible-openwrt-hirkn</code> </pre> <br><p>  Adicione seu roteador aos hosts: </p><br><pre> <code class="bash hljs">[openwrt] 192.168.1.1</code> </pre> <br><p>  Substitua suas vari√°veis ‚Äã‚Äãem hirkn.yml: </p><br><pre> <code class="bash hljs"> vars: ansible_template_dir: /etc/ansible/templates/ wg_server_address: wg_server_ip/url wg_private_key: privatekey-client wg_public_key: publickey-server wg_listen_port: 51820 wg_client_port: 51820 wg_client_address: 192.168.100.3/24</code> </pre> <br><p>  Certifique-se de definir: </p><br><p>  <strong>wg_server_address</strong> - servidor de wireguard de ip / url <br>  <strong>wg_private_key</strong> , <strong>wg_public_key</strong> - chave privada do cliente e servidor p√∫blico <br>  O restante n√£o pode ser alterado ou alterado, dependendo de como o servidor WireGuard est√° configurado </p><br><p>  Iniciar playbook </p><br><pre> <code class="bash hljs">ansible-playbook playbooks/hirkn.yml</code> </pre> <br><p>  Depois de concluir o manual, o roteador come√ßar√° imediatamente a ignorar os bloqueios atrav√©s do servidor wireguard. </p><br><h2 id="pochemu-ne-bgp">  Por que n√£o BGP? </h2><br><p>  No openwrt, existem dois utilit√°rios que implementam o BGP - quagga e bird.  Quagg N√£o consegui coletar dados do anti-filtro.  Bird fez amizade com o servi√ßo a meio chute, mas, infelizmente, n√£o entendi como for√ßar a interface padr√£o a ser adicionada √†s sub-redes recebidas.  (Ficarei feliz em saber como isso pode ser implementado). </p><br><p>  Nos coment√°rios sobre esses artigos, vi que os roteadores das pessoas estavam "pensativos" por um tempo, quando colocaram listas na tabela de roteamento.  Com a implementa√ß√£o por ipset, meu Xiaomi mi 3G pensa por 2 segundos (Asus rt-n16 por 5 segundos), quando voc√™ o alimenta com uma lista de 15 mil sub-redes.  Com mais trabalho, n√£o notei a carga no processador. </p><br><p>  <em>Todos os materiais n√£o s√£o um plano de a√ß√£o e s√£o apresentados para familiariza√ß√£o com a funcionalidade do sistema operacional Linux.</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt440030/">https://habr.com/ru/post/pt440030/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt440018/index.html">Exposi√ß√£o local din√¢mica</a></li>
<li><a href="../pt440020/index.html">Regress√£o ou regress√£o no teste</a></li>
<li><a href="../pt440022/index.html">Um pouco da Ferrari: a Rally Rd da startup Fintech permitir√° comprar "a√ß√µes" de carros raros</a></li>
<li><a href="../pt440024/index.html">Redirecionar printf () do STM32 para o Qt Creator Console</a></li>
<li><a href="../pt440026/index.html">Kaggle: n√£o consigo andar - vamos correr</a></li>
<li><a href="../pt440032/index.html">Intelig√™ncia Artificial Horizon Zero Dawn</a></li>
<li><a href="../pt440034/index.html">Arquitetura KISS. Do microsservi√ßo ao mon√≥lito</a></li>
<li><a href="../pt440036/index.html">Digita√ß√£o por toque</a></li>
<li><a href="../pt440040/index.html">Em desenvolvimento - cada um por si. Mas √†s vezes isso leva a um beco sem sa√≠da.</a></li>
<li><a href="../pt440044/index.html">Hist√≥rico detalhado da Qualcomm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>