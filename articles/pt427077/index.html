<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëç üëåüèæ üëçüèø Laplace Blur - √â poss√≠vel blub Laplace em vez de Gauss, quantas vezes √© mais r√°pido e vale a pena a perda da precis√£o de 1/32 üì§ üå† üîà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=""Desfocar" nas pessoas comuns √© um efeito de desfoque no processamento de imagens digitais. Pode ser muito eficaz em si mesmo e como um componente de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Laplace Blur - √â poss√≠vel blub Laplace em vez de Gauss, quantas vezes √© mais r√°pido e vale a pena a perda da precis√£o de 1/32</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427077/"><img src="https://habrastorage.org/webt/ge/pb/p3/gepbp3bpdluk4yg0-xzbn0via3y.jpeg" alt="imagem"><br><br>  "Desfocar" nas pessoas comuns √© um efeito de desfoque no processamento de imagens digitais.  Pode ser muito eficaz em si mesmo e como um componente de anima√ß√µes de interface ou efeitos derivados mais complexos (bloom / focusBlur / motionBlur).  Com tudo isso, o blues honesto na testa √© bastante lento.  E frequentemente as implementa√ß√µes incorporadas na plataforma de destino deixam muito a desejar.  Ou a velocidade √© triste, os artefatos machucam os olhos.  A situa√ß√£o gera muitas implementa√ß√µes de compromisso que s√£o melhores ou piores para determinadas condi√ß√µes.  Uma implementa√ß√£o original com boa qualidade de confiabilidade e velocidade mais alta, enquanto a menor depend√™ncia de hardware est√° esperando por voc√™.  Bom apetite! <br><a name="habracut"></a><br>  (Laplace Blur - Nome proposto do algoritmo original) <br><br>  Hoje, minha demonstra√ß√£o interna me chutou e me for√ßou a escrever um artigo que tinha que ser escrito seis meses atr√°s.  Como amador, no lazer, para desenvolver algoritmos de efeitos originais, eu gostaria de oferecer ao p√∫blico um algoritmo "quase azul gausiano", caracterizado pelo uso de instru√ß√µes de processador excepcionalmente r√°pidas (turnos e m√°scaras) e, portanto, acess√≠veis √† implementa√ß√£o de microcontroladores (extremamente r√°pido em um ambiente limitado). <br><br>  De acordo com minha tradi√ß√£o de escrever artigos sobre o Habr, darei exemplos em JS como a linguagem mais popular e, acredite ou n√£o, √© muito conveniente para fins de prototipagem r√°pida de algoritmos.  Al√©m disso, a capacidade de implementar isso efetivamente no JS veio com matrizes digitadas.  No meu laptop n√£o muito potente, a imagem em tela cheia √© processada a uma velocidade de 30 fps (n√£o h√° multithreading de trabalhadores). <br><br><div class="spoiler">  <b class="spoiler_title">Isen√ß√£o de responsabilidade para Cool Maths</b> <div class="spoiler_text">  Direi imediatamente que estou tirando o chap√©u porque me considero n√£o ser suficientemente experiente em matem√°tica fundamental.  No entanto, sou sempre guiado pelo esp√≠rito geral de uma abordagem fundamental.  Portanto, antes de trair minha abordagem um tanto ‚Äúobservacional‚Äù da aproxima√ß√£o, cuide de calcular a complexidade de bits do algoritmo, que, como voc√™ pensa, pode ser obtida pelos m√©todos cl√°ssicos de aproxima√ß√£o polinomial.  Eu adivinhei certo?  Voc√™ queria aproximar rapidamente deles?  Dado que eles exigem aritm√©tica flutuante, eles ser√£o significativamente mais lentos que um deslocamento de bit √∫nico, o que explicarei no final.  Em uma palavra, n√£o se apresse para o fundamentalismo te√≥rico e n√£o se esque√ßa do contexto em que eu resolvo o problema. <br></div></div><br>  Esta descri√ß√£o est√° presente aqui, em vez de explicar o curso de meus pensamentos e conjecturas que me levaram ao resultado.  Para quem estiver interessado: <br><br>  Fun√ß√£o Gauss original: <br><br><img src="https://habrastorage.org/webt/63/h0/km/63h0kmf5xougnx-tcp05_esii1y.png" alt="imagem"><br><br>  g (x) = a * e ** (- ((xb) ** 2) / c), em que <br>  a √© a amplitude (se tivermos oito bits de cor por canal, ent√£o = 256) <br>  e √© a constante de Euler ~ 2,7 <br>  b - deslocamento do gr√°fico em x (n√£o precisamos = 0) <br>  c - par√¢metro que afeta a largura do gr√°fico associado a ele como ~ w / 2,35 <br><br>  Nossa fun√ß√£o privada (menos o expoente removido com a substitui√ß√£o da multiplica√ß√£o por divis√£o): <br><br><img src="https://habrastorage.org/webt/rj/o-/ns/rjo-nsq8o1nptsuyrbhpit1ozkw.png" alt="imagem"><br><br>  g (x) = 256 / e ** (x * x / c) <br><br>  Deixe a a√ß√£o de aproxima√ß√£o suja come√ßar: <br>  Observe que o par√¢metro c est√° muito pr√≥ximo da meia largura e define 8 (isso ocorre devido a quantas etapas voc√™ pode mudar um canal de 8 bits cada). <br><br>  Tamb√©m substitu√≠mos e por 2, no entanto, observando que isso afeta mais a curvatura do ‚Äúsino‚Äù do que suas bordas.  Na verdade, afeta 2 / e vezes, mas a surpresa √© que esse erro compensa o par√¢metro c, para que as condi√ß√µes de contorno ainda estejam em ordem e o erro apare√ßa apenas em uma "distribui√ß√£o normal" ligeiramente incorreta, para gr√°ficos algoritmos, isso afetar√° a din√¢mica das transi√ß√µes de cores gradientes, mas √© quase imposs√≠vel perceber com os olhos. <br><br>  Ent√£o agora nossa fun√ß√£o √© a seguinte: <br>  gg (x) = 256/2 ** (x * x / 8) ou gg (x) = 2 ** (8 - x * x / 8) <br>  Observe que o expoente (x * x / 8) tem o mesmo intervalo de valor [0-8] que a fun√ß√£o de um abs de ordem inferior (x); portanto, este √∫ltimo √© candidato a substitui√ß√£o.  Vamos verificar rapidamente o palpite, observando como o gr√°fico muda com ele gg (x) = 256 / (2 ** abs (x)): <br><br>  GaussBlur vs LaplasBlur: <br><br><img src="https://habrastorage.org/webt/ri/9m/wn/ri9mwnl06vzoim4atrlhnyi5wye.png" alt="imagem"><br><br>  Os desvios parecem ser muito grandes; al√©m disso, a fun√ß√£o, tendo perdido sua suavidade, agora tem um pico.  Mas ei. <br><br>  Primeiro, n√£o vamos esquecer que a suavidade dos gradientes obtidos pelo desfoque n√£o depende da fun√ß√£o de densidade de probabilidade (que √© a fun√ß√£o de Gauss), mas de sua integral - a fun√ß√£o de distribui√ß√£o.  Naquela √©poca, eu n√£o conhecia esse fato, mas, de fato, tendo realizado uma aproxima√ß√£o "destrutiva" em rela√ß√£o √† fun√ß√£o de densidade de probabilidade (Gauss), a fun√ß√£o de distribui√ß√£o permaneceu bastante semelhante. <br><br>  Foi: <br><br><img src="https://habrastorage.org/webt/gj/nl/_l/gjnl_lzdrv_e_yvi87kxcrnu-e4.png" alt="imagem"><br><br>  Tornou-se: <br><br><img src="https://habrastorage.org/webt/le/nw/te/lenwteibjhhx9mwosint393sgjo.png" alt="imagem"><br><br>  A prova, tirada do algoritmo pronto, coincide: <br><br><img src="https://habrastorage.org/webt/lg/ly/bm/lglybmx2fx4-rtff1eq_natuodm.png" alt="imagem"><br><br>  No futuro, direi que o erro de desfoque do meu algoritmo em rela√ß√£o ao Gausian x5 foi de apenas 3%. <br><br>  Portanto, chegamos muito mais perto da fun√ß√£o de distribui√ß√£o de Laplace.  Quem teria pensado, mas eles podem lavar as imagens 97% n√£o √© pior. <br><br>  Prova, diferen√ßas blura gausiana x5 e "Laplace blura" x7: <br><br><img src="https://habrastorage.org/webt/qy/1g/z1/qy1gz1d0fahnsbstiqwijj-rb3y.png" alt="imagem"><br><br>  (esta n√£o √© uma imagem em preto! Voc√™ pode estudar no editor) <br><br>  A suposi√ß√£o dessa transforma√ß√£o nos permitiu avan√ßar para a id√©ia de obter o valor por filtragem iterativa, √† qual planejei reduzir inicialmente. <br><br>  Antes de contar um algoritmo espec√≠fico, ser√° honesto se eu me antecipar e descrever imediatamente sua √∫nica desvantagem (embora a implementa√ß√£o possa ser corrigida com uma perda de velocidade).  Mas esse algoritmo √© implementado usando aritm√©tica de cisalhamento, e pot√™ncias de 2 s√£o sua limita√ß√£o.  Portanto, o original √© feito para desfocar x7 (o que nos testes √© o mais pr√≥ximo a Gausian x5).  Essa limita√ß√£o da implementa√ß√£o est√° relacionada ao fato de que, com uma cor de oito bits, alterando o valor na unidade de filtro em um bit por etapa, qualquer efeito do ponto termina em no m√°ximo 8 etapas.  Tamb√©m implementei uma vers√£o um pouco mais lenta por meio de propor√ß√µes e adi√ß√µes adicionais, que implementam uma divis√£o r√°pida por 1,5 (resultando em um raio de x15).  Por√©m, com a aplica√ß√£o posterior dessa abordagem, o erro aumenta e a velocidade diminui, o que n√£o permite que ela seja usada dessa maneira.  Por outro lado, vale ressaltar que x15 j√° √© suficiente para n√£o notar a diferen√ßa, o resultado √© obtido a partir do original ou da imagem amostrada em baixa.  Portanto, o m√©todo √© bastante adequado se voc√™ precisar de uma velocidade extraordin√°ria em um ambiente limitado. <br><br>  Portanto, o n√∫cleo do algoritmo √© simples, s√£o executadas quatro passagens do mesmo tipo: <br><br>  1. Metade do valor da unidade t (inicialmente igual a zero) √© adicionada √† metade do valor do pr√≥ximo pixel, o resultado √© atribu√≠do a ele.  Continue desta maneira at√© o final da linha da imagem.  Para todas as linhas. <br><br>  Ap√≥s a conclus√£o da primeira passagem, a imagem √© desfocada em uma dire√ß√£o. <br><br>  2. Na segunda passagem, fazemos o mesmo na dire√ß√£o oposta para todas as linhas. <br>  Temos uma imagem que est√° completamente desfocada horizontalmente. <br><br>  3-4.  Agora fa√ßa a mesma coisa verticalmente. <br>  Feito! <br><br>  Inicialmente, usei um algoritmo de duas passagens com a implementa√ß√£o de back-blur atrav√©s da pilha, mas √© dif√≠cil de entender, n√£o gracioso, e acabou sendo mais lento nas arquiteturas atuais.  Talvez o algoritmo de uma passagem seja mais r√°pido nos microcontroladores, al√©m da capacidade de produzir o resultado progressivamente tamb√©m ser√° um plus. <br><br>  O atual m√©todo de implementa√ß√£o em quatro dire√ß√µes, olhei para Habr√© do guru anterior sobre algoritmos de desfoque.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">habr.com/post/151157</a> Aproveito esta oportunidade para expressar minha solidariedade e profunda gratid√£o a ele. <br><br>  Mas os hacks n√£o terminaram a√≠.  Agora, sobre como calcular os tr√™s canais de cores em uma instru√ß√£o de processador!  O fato √© que o deslocamento de bits usado como divis√£o por dois permite controlar muito bem a posi√ß√£o dos bits resultantes.  O √∫nico problema √© que os bits mais baixos dos canais deslizam para os mais pr√≥ximos, mas voc√™ pode simplesmente redefini-los, resolver o problema com alguma perda de precis√£o.  E, de acordo com a f√≥rmula de filtro descrita, a adi√ß√£o de metade do valor da unidade com metade do valor da pr√≥xima c√©lula (sujeito √† redefini√ß√£o dos bits descarregados) nunca leva ao estouro, portanto, n√£o se preocupe.  E a f√≥rmula do filtro para o c√°lculo simult√¢neo de todos os d√≠gitos passa a ser a seguinte: <br><br>  buf32 [i] = t = (((t &gt;&gt; 1) &amp; 0x7F7F7F) + ((buf32 [i] &gt;&gt; 1) &amp; 0x7F7F7F); <br><br>  No entanto, √© necess√°rio mais um acr√©scimo: verificou-se experimentalmente que a perda de precis√£o nesta f√≥rmula √© muito significativa, o brilho da imagem aumenta visualmente significativamente.  Tornou-se claro que o bit perdido precisa ser arredondado para o todo mais pr√≥ximo e n√£o descartado.  Uma maneira f√°cil de fazer isso na aritm√©tica inteira √© adicionar metade do divisor antes da divis√£o.  Nosso divisor √© dois, ent√£o voc√™ precisa adicionar um, em todos os d√≠gitos, - a constante 0x010101.  Mas com qualquer adi√ß√£o, √© preciso ter cuidado com o excesso.  Portanto, n√£o podemos usar essa corre√ß√£o para calcular metade do valor da pr√≥xima c√©lula.  (Se houver cor branca, o excesso ser√° excedido e, portanto, n√£o a corrigiremos).  Mas aconteceu que o principal erro foi cometido pela divis√£o m√∫ltipla da unidade, que podemos corrigir.  Porque, de fato, mesmo com essa corre√ß√£o, o valor no inversor n√£o aumentar√° acima de 254. Mas, quando adicionado a 0x010101, o estouro n√£o ser√° garantido.  E a f√≥rmula do filtro com corre√ß√£o assume a forma: <br><br>  buf32 [i] = t = (((((0x010101 + t) &gt;&gt; 1) &amp; 0x7F7F7F) + ((buf32 [i] &gt;&gt; 1) &amp; 0x7F7F7F); <br><br>  De fato, a f√≥rmula executa a corre√ß√£o muito bem; portanto, quando voc√™ aplica repetidamente esse algoritmo √† imagem, os artefatos come√ßam a ficar vis√≠veis apenas nas dez √∫ltimas passagens.  (n√£o o fato de que repetir a blura gausiana n√£o produzir√° esses artefatos). <br><br>  Al√©m disso, h√° uma propriedade maravilhosa com muitos passes.  (Isso n√£o se deve ao meu algoritmo, mas √† "normalidade" da distribui√ß√£o normal).  J√° na segunda passagem do Laplace Blura, a fun√ß√£o de densidade de probabilidade (se eu entendi tudo certo) ser√° mais ou menos assim: <br><br><img src="https://habrastorage.org/webt/sl/1m/tk/sl1mtkidvvurt8z7vxiuhjbfzka.png" alt="imagem"><br><br>  O qual, voc√™ v√™, j√° est√° muito pr√≥ximo do gaussiano. <br><br>  Empiricamente, descobri que o uso de modifica√ß√µes com um raio grande √© permitido em pares, porque  a propriedade descrita acima compensa erros se a √∫ltima passagem for mais precisa (o mais preciso √© o algoritmo de desfoque x7 descrito aqui). <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">demonstra√ß√£o</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">rap</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">codpen</a> <br><br>  Um apelo para matem√°ticos legais: <br>  O que seria interessante saber como √© correto usar esse filtro separadamente, n√£o tenho certeza se existe uma imagem de distribui√ß√£o sim√©trica.  Embora a heterogeneidade do olho n√£o seja vis√≠vel. <br><br>  upd: Aqui levantarei links √∫teis, gentilmente apresentados por comentaristas e encontrados em outros khabrovitas. <br>  1. Como os mestres da intel funcionam, contando com o poder do SSE - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">software.intel.com/en-us/articles/iir-gaussian-blur-filter-implementation-using-intel-advanced-vector-extensions</a> (obrigado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">vladimirovich</a> ) <br>  2. Base te√≥rica sobre o t√≥pico ‚ÄúConvolu√ß√µes r√°pidas de imagens‚Äù + algumas de suas aplica√ß√µes personalizadas em rela√ß√£o ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">blues</a> gaussiano honesto - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">blog.ivank.net/fastest-gaussian-blur.html</a> (obrigado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Grox</a> ) <br><br>  Sugest√µes, coment√°rios, cr√≠ticas construtivas s√£o bem-vindas! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt427077/">https://habr.com/ru/post/pt427077/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt427059/index.html">"Humano, humano demais." N√£o nos tornaremos ref√©ns de nossa mente implementando a IA universal?</a></li>
<li><a href="../pt427061/index.html">Assistentes de voz ao volante do carro: para quem o futuro</a></li>
<li><a href="../pt427065/index.html">Classe Atributos Metamorfoses</a></li>
<li><a href="../pt427069/index.html">Reposit√≥rio local do NPM em 5 minutos com seus pacotes e cache</a></li>
<li><a href="../pt427075/index.html">A hist√≥ria de um desenvolvimento</a></li>
<li><a href="../pt427079/index.html">NetApp Insight 2018</a></li>
<li><a href="../pt427081/index.html">Crit√©rios da mente humana, do ponto de vista de um programador</a></li>
<li><a href="../pt427087/index.html">Curso MIT "Seguran√ßa de sistemas de computadores". Palestra 12: Seguran√ßa de Rede, Parte 2</a></li>
<li><a href="../pt427091/index.html">Verifica√ß√£o num√©rica da hip√≥tese abc (sim, essa)</a></li>
<li><a href="../pt427093/index.html">Curso MIT "Seguran√ßa de sistemas de computadores". Aula 12: Seguran√ßa de Rede, Parte 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>