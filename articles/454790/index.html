<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöâ üõ¢Ô∏è üëî Imagen nativa de Java: comprobaci√≥n de usabilidad üìÄ ü•ò ü§úüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No hace mucho tiempo, Oracle lanz√≥ la primera versi√≥n del proyecto GraalVM (https://www.graalvm.org/). Al lanzamiento se le asign√≥ inmediatamente el n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Imagen nativa de Java: comprobaci√≥n de usabilidad</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454790/"><img src="https://habrastorage.org/webt/ge/3k/12/ge3k12jjimph6xn8zteg9n3olqo.jpeg"><br><br>  No hace mucho tiempo, Oracle lanz√≥ la primera versi√≥n del proyecto GraalVM (https://www.graalvm.org/).  Al lanzamiento se le asign√≥ inmediatamente el n√∫mero 19.0.0, aparentemente para convencer de que el proyecto est√° maduro y listo para usar en aplicaciones serias.  Una de las partes de este proyecto: <a href="">Substrate VM</a> es un marco que le permite convertir aplicaciones Java en archivos ejecutables nativos (as√≠ como bibliotecas nativas que pueden conectarse en aplicaciones escritas, por ejemplo, en C / C ++).  Esta caracter√≠stica hasta ahora ha sido declarada experimental.  Tambi√©n vale la pena se√±alar que las aplicaciones Java nativas tienen algunas limitaciones: debe enumerar todos los recursos utilizados para incluirlos en el programa nativo;  debe enumerar todas las clases que se usar√°n con reflexi√≥n y otras restricciones.  Aqu√≠ se proporciona una lista completa de las <a href="">limitaciones de Java de im√°genes nativas</a> .  Habiendo estudiado esta lista, es comprensible en principio que las restricciones no sean tan significativas como para que sea imposible desarrollar aplicaciones m√°s complejas que las palabras infernales.  Establec√≠ este objetivo: desarrollar un peque√±o programa que tenga un servidor web incorporado, use una base de datos (a trav√©s de la biblioteca ORM) y compile en un binario nativo que pueda ejecutarse en sistemas sin una m√°quina Java instalada. <br><a name="habracut"></a><br>  Experimentar√© en Ubuntu 19.04 (Intel Core i3-6100 CPU @ 3.70GHz √ó 4). <br><br><h2>  Instalar GraalVM </h2><br>  La instalaci√≥n de GraalVM se realiza convenientemente con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SDKMAN</a> .  Comando de instalaci√≥n de GraalVM: <br><br><pre><code class="bash hljs">sdk install java 19.0.0-grl</code> </pre> <br>  Se instalar√° OpenJDK GraalVM CE 19.0.0, CE es Community Edition.  Tambi√©n hay Enterprise Edition (EE), pero esta edici√≥n debe descargarse de Oracle Technology Network, el enlace se encuentra en la p√°gina de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">descargas de GraalVM</a> . <br><br>  Despu√©s de instalar GraalVM, ya usando el administrador de actualizaciones de componentes gu de GraalVM, instal√© el soporte de compilaci√≥n en el binario nativo: <br><br><pre> <code class="bash hljs">gu install native-image</code> </pre> <br>  Todo, las herramientas de trabajo est√°n listas, ahora puede comenzar a desarrollar aplicaciones. <br><br><h2>  Aplicaci√≥n nativa simple </h2><br>  Como sistema de compilaci√≥n, uso Maven.  Para crear binarios nativos, hay un complemento maven: <br><br><div class="spoiler">  <b class="spoiler_title">plugin de imagen-nativa-maven</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugins</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.oracle.substratevm<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>native-image-maven-plugin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>${graal.version}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">executions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">execution</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goals</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goal</span></span></span><span class="hljs-tag">&gt;</span></span>native-image<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goal</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goals</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phase</span></span></span><span class="hljs-tag">&gt;</span></span>package<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phase</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">execution</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">executions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">imageName</span></span></span><span class="hljs-tag">&gt;</span></span>nativej<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">imageName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">buildArgs</span></span></span><span class="hljs-tag">&gt;</span></span> --no-server <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">buildArgs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugins</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Todav√≠a es necesario establecer la clase principal de la aplicaci√≥n.  Esto puede hacerse tanto en native-image-maven-plugin como en la forma tradicional, a trav√©s de: <br><br><div class="spoiler">  <b class="spoiler_title">plugin maven-jar</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.apache.maven.plugins<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>maven-jar-plugin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">archive</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mainClass</span></span></span><span class="hljs-tag">&gt;</span></span>nativej.Startup<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mainClass</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">archive</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Crea la clase principal: <br><br><div class="spoiler">  <b class="spoiler_title">Startup.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Startup</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"Hello world!"</span></span>); } }</code> </pre><br></div></div><br>  Ahora puede ejecutar el comando maven para construir la aplicaci√≥n: <br><br><pre> <code class="bash hljs">mvn clean package</code> </pre> <br>  Construir un binario nativo en mi m√°quina lleva 35 segundos.  Como resultado, se obtiene un archivo binario de 2.5 MB de tama√±o en el directorio de destino.  El programa no requiere la m√°quina Java instalada y se ejecuta en m√°quinas donde falta Java. <br><br>  Enlace al repositorio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Github: native-java-helloworld-demo</a> . <br><br><h2>  Controlador JDBC Postgres </h2><br>  Y as√≠, una aplicaci√≥n simple funciona, muestra "Hola mundo".  No se necesitaban soluciones.  Intentar√© ir un nivel m√°s arriba: conectar√© el controlador JDBC de Postgres para solicitar datos de la base de datos.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Los problemas</a> en el github de GraalVM se encuentran con errores relacionados con el controlador Postgres, pero con los candidatos de lanzamiento de GraalVM.  Todos ellos est√°n marcados como fijos. <br><br>  Conecto la dependencia postgresql: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.postgresql<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>postgresql<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>42.2.5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Estoy escribiendo el c√≥digo para extraer datos de la base de datos (se cre√≥ la placa de usuario m√°s simple): <br><br><div class="spoiler">  <b class="spoiler_title">Startup.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Startup</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> SQLException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PGSimpleDataSource ds = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PGSimpleDataSource(); ds.setUrl(<span class="hljs-string"><span class="hljs-string">"jdbc:postgresql://localhost/demo_nativem"</span></span>); ds.setUser(<span class="hljs-string"><span class="hljs-string">"test"</span></span>); ds.setPassword(<span class="hljs-string"><span class="hljs-string">"test"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> ( Connection conn = ds.getConnection(); Statement stmt = conn.createStatement(); ResultSet rs = stmt.executeQuery(<span class="hljs-string"><span class="hljs-string">"SELECT * FROM \"public\".\"user\""</span></span>); ) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(rs.next()){ System.out.print(<span class="hljs-string"><span class="hljs-string">"ID: "</span></span> + rs.getLong(<span class="hljs-string"><span class="hljs-string">"id"</span></span>)); System.out.println(<span class="hljs-string"><span class="hljs-string">", Name: "</span></span> + rs.getString(<span class="hljs-string"><span class="hljs-string">"name"</span></span>)); } } } }</code> </pre><br></div></div><br>  Recopilo el binario nativo e inmediatamente recibo un error de compilaci√≥n: <br><br> <code>Error: No instances are allowed in the image heap for a class that is initialized or reinitialized at image runtime: org.postgresql.Driver. Try marking this class for build-time initialization with --initialize-at-build-time=org.postgresql.Driver <br></code> <br><br>  El hecho es que el creador de aplicaciones nativas inicializa todos los campos est√°ticos durante el proceso de compilaci√≥n (a menos que se especifique lo contrario), y lo hace examinando las dependencias de las clases.  Mi c√≥digo no hace referencia a org.postgresql.Driver, por lo que el recopilador no sabe c√≥mo inicializarlo mejor (al compilar, o cuando se inicia la aplicaci√≥n) y ofrece registrarlo para la inicializaci√≥n al compilar.  Esto se puede hacer agreg√°ndolo a los argumentos de Maven del plugin native-image-maven-plugin, como se indica en la descripci√≥n del error.  Despu√©s de agregar Driver, obtengo el mismo error relacionado con org.postgresql.util.SharedTimer.  Nuevamente, recopilo y encuentro un error de compilaci√≥n: <br><br> <code>Error: Class initialization failed: org.postgresql.sspi.SSPIClient <br></code> <br><br>  No hay recomendaciones para la correcci√≥n.  Pero, mirando el origen de la clase, est√° claro que se relaciona con la ejecuci√≥n de c√≥digo en Windows.  En Linux, su inicializaci√≥n (que ocurre durante el ensamblaje) falla con un error.  Existe la oportunidad de retrasar su inicializaci√≥n al inicio de la aplicaci√≥n: --initialize-at-run-time = org.postgresql.sspi.SSPIClient.  La inicializaci√≥n en Linux no ocurrir√° y ya no obtendremos errores relacionados con esta clase.  Argumentos de construcci√≥n: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">buildArgs</span></span></span><span class="hljs-tag">&gt;</span></span> --no-server --no-fallback --initialize-at-build-time=org.postgresql.Driver --initialize-at-build-time=org.postgresql.util.SharedTimer --initialize-at-run-time=org.postgresql.sspi.SSPIClient <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">buildArgs</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  El ensamblaje comenz√≥ a tomar 1 minuto y 20 segundos y el archivo aument√≥ a 11 MB.  Agregu√© un indicador adicional para construir el binario: --no-fallback proh√≠be generar un binario nativo que requiera una m√°quina Java instalada.  Dicho binario se crea si el recopilador detecta el uso de caracter√≠sticas de lenguaje que no son compatibles con la VM de sustrato o requieren configuraci√≥n, pero a√∫n no hay configuraci√≥n.  En mi caso, el recopilador descubri√≥ el uso potencial de la reflexi√≥n en el controlador JDBC.  Pero esto es solo un uso potencial, no se requiere en mi programa y, por lo tanto, no se requiere configuraci√≥n adicional (c√≥mo se mostrar√° m√°s adelante).  Tambi√©n est√° el indicador --static, que obliga al generador a vincular est√°ticamente libc.  Pero si lo usa, el programa se bloquea con un error de segmentaci√≥n cuando intenta resolver el nombre de la red a una direcci√≥n IP.  Busqu√© alguna soluci√≥n a este problema, pero no encontr√© nada adecuado, as√≠ que dej√© la dependencia del programa en libc. <br><br>  Ejecuto el binario resultante y obtengo el siguiente error: <br><br> <code>Exception in thread "main" org.postgresql.util.PSQLException: Could not find a java cryptographic algorithm: TLS SSLContext not available. <br></code> <br><br>  Despu√©s de investigar un poco, se identific√≥ la causa del error: Postgres establece de forma predeterminada una conexi√≥n TLS utilizando la curva el√≠ptica.  SubstrateVM no incluye la implementaci√≥n de dichos algoritmos para TLS, aqu√≠ est√° el problema abierto correspondiente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">: compatibilidad TLS de ECC de un solo binario (ECDSA / ECDHE) para SubstrateVM</a> .  Hay varias soluciones: coloque la biblioteca del paquete GraalVM: libsunec.so al lado de la aplicaci√≥n, configure la lista de algoritmos en el servidor Postgres, excluya los algoritmos de curva el√≠ptica o simplemente desactive la conexi√≥n TLS en el controlador Postgres (se eligi√≥ esta opci√≥n): <br><br><pre> <code class="java hljs">dataSource.setSslMode(SslMode.DISABLE.value);</code> </pre><br>  Despu√©s de eliminar el error de crear una conexi√≥n con Postgres, inicio la aplicaci√≥n nativa, se ejecuta y muestra datos de la base de datos. <br><br>  Enlace al repositorio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Github: native-java-postgres-demo</a> . <br><br><h2>  Marco DI y servidor web incorporado </h2><br>  Al desarrollar una aplicaci√≥n Java compleja, generalmente usan alg√∫n tipo de marco, por ejemplo, Spring Boot.  Pero a juzgar por este art√≠culo del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">soporte de im√°genes nativas de GraalVM</a> , el trabajo de Spring Boot en la imagen nativa " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">listo</a> para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">usar</a> " se nos promete solo en Spring Boot 5.3. <br><br>  Pero hay un marco maravilloso de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Micronaut</a> que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dice funcionar en la imagen nativa de GraalVM</a> .  En general, conectar un Micronaut a una aplicaci√≥n que se ensamblar√° en un binario no requiere ninguna configuraci√≥n especial o resoluci√≥n de problemas.  De hecho, muchas configuraciones para usar la reflexi√≥n y conectar recursos para la m√°quina virtual Substrate ya est√°n hechas dentro de Micronaut.  Por cierto, la misma configuraci√≥n se puede colocar dentro de su aplicaci√≥n en el archivo de configuraci√≥n META-INF / native-image / $ {groupId} / $ {artifactId} /native-image.properties (Substrate VM recomienda esta ruta para el archivo de configuraci√≥n), aqu√≠ hay una t√≠pica contenido del archivo: <br><br><div class="spoiler">  <b class="spoiler_title">native-image.properties</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Args = \ -H:+ReportUnsupportedElementsAtRuntime \ -H:ResourceConfigurationResources=${.}/resource-config.json \ -H:ReflectionConfigurationResources=${.}/reflect-config.json \ -H:DynamicProxyConfigurationResources=${.}/proxy-config.json \ --initialize-at-build-time=org.postgresql.Driver \ --initialize-at-build-time=org.postgresql.util.SharedTimer \ --initialize-at-run-time=org.postgresql.sspi.SSPIClient</code> </pre><br></div></div><br>  Los archivos resource-config.json, reflect-config.json, proxy-config.json contienen configuraciones para conectar los recursos, la reflexi√≥n y los proxies utilizados (Proxy.newProxyInstance).  Estos archivos se pueden crear manualmente o recuperar utilizando agentlib: native-image-agent.  En el caso de usar native-image-agent, debe ejecutar el jar habitual (y no el binario nativo) usando el agente: <br><br><pre> <code class="bash hljs">java -agentlib:native-image-agent=config-output-dir=output -jar my.jar</code> </pre><br>  donde salida es el directorio donde se ubicar√°n los archivos descritos anteriormente.  En este caso, el programa no solo necesita ejecutarse, sino tambi√©n ejecutar scripts en el programa, porque la configuraci√≥n se escribe en los archivos a medida que usa la reflexi√≥n, abre los recursos y crea un proxy.  Estos archivos se pueden colocar META-INF / native-image / $ {groupId} / $ {artifactId} y hacer referencia en native-image.properties. <br><br>  Decid√≠ conectar el registro utilizando logback: agregu√© una dependencia a la biblioteca logback-classic y al archivo logback.xml.  Despu√©s de eso, compil√© un jar normal y lo ejecut√© usando native-image-agent.  Al final del programa, los archivos de configuraci√≥n necesarios.  Si observa su contenido, puede ver que el agente registr√≥ el uso de logback.xml para compilar en el binario.  Adem√°s, el archivo reflection-config.json contiene todos los casos de uso de la reflexi√≥n: para determinadas clases, la metainformaci√≥n entrar√° en el binario. <br><br>  Luego agregu√© una dependencia a la biblioteca micronaut-http-server-netty para usar el servidor web incorporado basado en netty y cre√© un controlador: <br><br><div class="spoiler">  <b class="spoiler_title">Startup.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Controller</span></span>(<span class="hljs-string"><span class="hljs-string">"/hello"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HelloController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Get</span></span>(<span class="hljs-string"><span class="hljs-string">"/{name}"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span>(MediaType.TEXT_PLAIN) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpResponse&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpResponse.ok(<span class="hljs-string"><span class="hljs-string">"Hello "</span></span> + name); } }</code> </pre><br></div></div><br>  Y clase principal: <br><br><div class="spoiler">  <b class="spoiler_title">HelloController.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Startup</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ Signal.handle(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Signal(<span class="hljs-string"><span class="hljs-string">"INT"</span></span>), sig -&gt; System.exit(<span class="hljs-number"><span class="hljs-number">0</span></span>)); Micronaut.run(Startup.class, args); } }</code> </pre><br></div></div><br>  Ahora puedes intentar construir un binario nativo.  Mi asamblea tom√≥ 4 minutos.  Si lo ejecuta y va a la direcci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http: // localhost: 8080 / hello / user</a> , se produce un error: <br><br><pre> <code class="plaintext hljs">{"_links":{"self":{"href":"/hello/user","templated":false}},"message":"More than 1 route matched the incoming request. The following routes matched /hello/user: GET - /hello/user, GET - /hello/user"}</code> </pre><br>  Honestamente, no est√° del todo claro por qu√© sucede esto, pero despu√©s de buscar escribiendo, descubr√≠ que el error desaparece si las siguientes l√≠neas se eliminan del archivo resource-config.json (que fue creado por el agente): <br><br><pre> <code class="plaintext hljs"> {"pattern":"META-INF/services/com.fasterxml.jackson.databind.Module"}, {"pattern":"META-INF/services/io.micronaut.context.env.PropertySourceLoader"}, {"pattern":"META-INF/services/io.micronaut.http.HttpResponseFactory"}, {"pattern":"META-INF/services/io.micronaut.inject.BeanConfiguration"}, {"pattern":"META-INF/services/io.micronaut.inject.BeanDefinitionReference"},</code> </pre><br>  Micronaut registra estos recursos y parece que el nuevo registro conduce a un doble registro de mi controlador y un error.  Si despu√©s de corregir el archivo, reconstruye el binario y lo ejecuta, no habr√° m√°s errores, el texto "Hola usuario" se mostrar√° en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http: // localhost: 8080 / hello / user</a> . <br><br>  Quiero llamar la atenci√≥n sobre el uso de la siguiente l√≠nea en la clase principal: <br><br><pre> <code class="java hljs">Signal.handle(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Signal(<span class="hljs-string"><span class="hljs-string">"INT"</span></span>), sig -&gt; System.exit(<span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre><br>  Debe insertarse para que Micronaut termine correctamente.  A pesar de que Micronaut cuelga un gancho para apagarse, no funciona en el binario nativo.  Hay un problema correspondiente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Shutdownhook no dispara con nativo</a> .  Est√° marcado como fijo, pero, de hecho, solo tiene una soluci√≥n alternativa usando la clase Signal. <br><br>  Enlace al repositorio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Github: native-java-postgres-micronaut-demo</a> . <br><br><h2>  Conexi√≥n ORM </h2><br>  JDBC es bueno, pero se cansa de c√≥digo repetitivo, interminable SELECT y UPDATE.  Intentar√© facilitar (o complicar, dependiendo de qu√© lado mirar) mi vida conectando alg√∫n tipo de ORM. <br><br><h4>  Hibernar </h4><br>  Al principio decid√≠ probar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hibernate</a> , ya que es uno de los ORM m√°s comunes para Java.  Pero no pude construir una imagen nativa usando Hibernate debido a un error de compilaci√≥n: <br><br><pre> <code class="plaintext hljs">Error: Field java.lang.reflect.Method.defaultValue is not present on type java.lang.reflect.Constructor. Error encountered while analysing java.lang.reflect.Method.getDefaultValue() Parsing context: parsing org.hibernate.annotations.common.annotationfactory.AnnotationProxy.getAnnotationValues(AnnotationProxy.java:63) parsing org.hibernate.annotations.common.annotationfactory.AnnotationProxy(AnnotationProxy.java:52) ...</code> </pre><br>  Hay un problema abierto correspondiente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">[imagen nativa] Micronaut + Hibernate resulta en un error encontrado al analizar java.lang.reflect.Method.getDefaultValue ()</a> . <br><br><h4>  jOOQ </h4><br>  Entonces decid√≠ probar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">jOOQ</a> .  Logr√© construir un binario nativo, aunque tuve que hacer una gran cantidad de configuraciones: especificar qu√© clases inicializar (tiempo de construcci√≥n, tiempo de ejecuci√≥n) y jugar con la reflexi√≥n.  Al final, todo se redujo al hecho de que cuando se inicia la aplicaci√≥n, jOOQ inicializa el proxy org.jooq.impl.ParserImpl $ Ignorar como miembro est√°tico de la clase org.jooq.impl.Tools.  Y este proxy usa MethodHandle, que Substrate VM <a href="">a√∫n no admite</a> .  Aqu√≠ hay un problema abierto similar: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">[imagen nativa] Micronaut + Kafka no puede construir una imagen nativa con el argumento MethodHandle no se puede reducir a lo m√°s en una sola llamada</a> . <br><br><h4>  Apache Cayena </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Apache Cayenne es</a> menos com√∫n, pero parece bastante funcional.  Intentar√© conectarlo.  Cre√© archivos XML para describir el esquema de la base de datos, se pueden crear manualmente o con la herramienta GUI CayenneModeler, o en base a una base de datos existente.  Usando el plugin cayenne-maven-en el archivo pom, se llevar√° a cabo la generaci√≥n de c√≥digo de clases que corresponden a las tablas de la base de datos: <br><br><div class="spoiler">  <b class="spoiler_title">cayenne-maven-plugin</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.apache.cayenne.plugins<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>cayenne-maven-plugin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>${cayenne.version}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">map</span></span></span><span class="hljs-tag">&gt;</span></span>src/main/resources/db/datamap.map.xml<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">map</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">destDir</span></span></span><span class="hljs-tag">&gt;</span></span>${project.build.directory}/generated-sources/cayenne<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">destDir</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">executions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">execution</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goals</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goal</span></span></span><span class="hljs-tag">&gt;</span></span>cgen<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goal</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goals</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">execution</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">executions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Luego agregu√© la clase CayenneRuntimeFactory para inicializar la f√°brica de contexto de la base de datos: <br><br><div class="spoiler">  <b class="spoiler_title">CayenneRuntimeFactory.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Factory</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CayenneRuntimeFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DataSource dataSource; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CayenneRuntimeFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataSource dataSource)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dataSource = dataSource; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ServerRuntime </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cayenneRuntime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ServerRuntime.builder() .dataSource(dataSource) .addConfig(<span class="hljs-string"><span class="hljs-string">"db/cayenne-test.xml"</span></span>) .build(); } }</code> </pre><br></div></div><br>  Controlador HelloController: <br><br><div class="spoiler">  <b class="spoiler_title">HelloController.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Controller</span></span>(<span class="hljs-string"><span class="hljs-string">"/hello"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HelloController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ServerRuntime cayenneRuntime; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HelloController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRuntime cayenneRuntime)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cayenneRuntime = cayenneRuntime; } <span class="hljs-meta"><span class="hljs-meta">@Get</span></span>(<span class="hljs-string"><span class="hljs-string">"/{name}"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span>(MediaType.TEXT_PLAIN) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpResponse&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ObjectContext context = cayenneRuntime.newContext(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;User&gt; result = ObjectSelect.query(User.class).select(context); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.size() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { result.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).setName(name); } context.commitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpResponse.ok(result.stream() .map(x -&gt; MessageFormat.format(<span class="hljs-string"><span class="hljs-string">"{0}.{1}"</span></span>, x.getObjectId(), x.getName())) .collect(Collectors.joining(<span class="hljs-string"><span class="hljs-string">","</span></span>))); } }</code> </pre><br></div></div><br>  Luego lanz√≥ el programa como un jar regular, usando agentlib: native-image-agent, para recopilar informaci√≥n sobre los recursos utilizados y la reflexi√≥n. <br><br>  Recopil√© el binario nativo, ejec√∫telo, vaya a la direcci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http: // localhost: 8080 / hello / user</a> y obtenga un error: <br><br><pre> <code class="plaintext hljs">{"message":"Internal Server Error: Provider com.sun.org.apache.xerces.internal.jaxp.SAXParserFactoryImpl not found"}</code> </pre><br>  Resulta que agentlib: native-image-agent no detect√≥ el uso de esta clase en la reflexi√≥n. <br><br>  Lo agreg√≥ manualmente al archivo reflect-config.json: <br><br><pre> <code class="plaintext hljs">{ "name":"com.sun.org.apache.xerces.internal.jaxp.SAXParserFactoryImpl", "allDeclaredConstructors":true }</code> </pre><br>  Nuevamente, recopilo el binario, inicio, actualizo la p√°gina web y obtengo otro error: <br><br><pre> <code class="plaintext hljs">Caused by: java.util.MissingResourceException: Resource bundle not found org.apache.cayenne.cayenne-strings. Register the resource bundle using the option -H:IncludeResourceBundles=org.apache.cayenne.cayenne-strings.</code> </pre><br>  Aqu√≠ todo est√° claro, agrego la configuraci√≥n, como se indica en la soluci√≥n propuesta.  Nuevamente colecciono el binario (esto es 5 minutos de tiempo), lo inicio una y otra vez un error, otro: <br><br><pre> <code class="plaintext hljs">No DataMap found, can't route query org.apache.cayenne.query.SelectQuery@2af96966[root=class name.voyachek.demos.nativemcp.db.User,name=]"}</code> </pre><br>  Tuve que jugar con este error, despu√©s de numerosas pruebas, estudiando las fuentes, qued√≥ claro que la raz√≥n del error radica en esta l√≠nea de la clase org.apache.cayenne.resource.URLResource: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URLResource(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(url, relativePath));</code> </pre><br>  Al final result√≥ que, Substrate VM carga el recurso por la url, que se indica como la base, y no por la url, que debe formarse sobre la base de la base y la ruta relativa.  Sobre lo que he registrado el siguiente problema: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Contenido de recurso no v√°lido cuando se usa una nueva URL (contexto de URL, especificaci√≥n de cadena)</a> . <br><br>  El error est√° determinado, ahora debe buscar soluciones alternativas.  Afortunadamente, Apache Cayenne result√≥ ser una cosa bastante personalizable.  Debes registrar tu propio cargador de recursos: <br><br><pre> <code class="java hljs">ServerRuntime.builder() .dataSource(dataSource) .addConfig(<span class="hljs-string"><span class="hljs-string">"db/cayenne-test.xml"</span></span>) .addModule(binder -&gt; { binder.bind(ResourceLocator.class).to(ClassLoaderResourceLocatorFix.class); binder.bind(Key.get(ResourceLocator.class, Constants.SERVER_RESOURCE_LOCATOR)).to(ClassLoaderResourceLocatorFix.class); }) .build();</code> </pre><br>  Aqu√≠ est√° su c√≥digo: <br><br><div class="spoiler">  <b class="spoiler_title">ClassLoaderResourceLocatorFix.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassLoaderResourceLocatorFix</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResourceLocator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ClassLoaderManager classLoaderManager; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClassLoaderResourceLocatorFix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Inject ClassLoaderManager classLoaderManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.classLoaderManager = classLoaderManager; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Collection&lt;Resource&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findResources</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Collection&lt;Resource&gt; resources = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Enumeration&lt;URL&gt; urls; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { urls = classLoaderManager.getClassLoader(name).getResources(name); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationException(<span class="hljs-string"><span class="hljs-string">"Error getting resources for "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (urls.hasMoreElements()) { resources.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URLResourceFix(urls.nextElement())); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resources; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URLResourceFix</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URLResource</span></span></span><span class="hljs-class"> </span></span>{ URLResourceFix(URL url) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(url); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Resource </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRelativeResource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String relativePath)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { String url = getURL().toString(); url = url.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, url.lastIndexOf(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>) + relativePath; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URLResource(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URI(url).toURL()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (MalformedURLException | URISyntaxException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CayenneRuntimeException( <span class="hljs-string"><span class="hljs-string">"Error creating relative resource '%s' : '%s'"</span></span>, e, getURL(), relativePath); } } } }</code> </pre><br></div></div><br>  Tiene una linea <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URLResource(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(url, relativePath));</code> </pre><br>  reemplazado por: <br><br><pre> <code class="java hljs">String url = getURL().toString(); url = url.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, url.lastIndexOf(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>) + relativePath; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URLResource(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URI(url).toURL());</code> </pre><br>  Recopilo el binario (70 MB), lo inicio, voy a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http: // localhost: 8080 / hello / user</a> y todo funciona, los datos de la base de datos se muestran en la p√°gina. <br><br>  Enlace al repositorio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Github: native-micronaut-cayenne-demo</a> . <br><br><h2>  Conclusiones </h2><br>  El objetivo se ha logrado: se ha desarrollado una aplicaci√≥n web simple con acceso a la base de datos utilizando ORM.  La aplicaci√≥n se compila en un binario nativo y puede ejecutarse en sistemas sin una m√°quina Java instalada.  A pesar de numerosos problemas, encontr√© una combinaci√≥n de marcos, configuraciones y soluciones que me permitieron obtener un programa de trabajo. <br><br>  S√≠, la capacidad de crear binarios regulares a partir del c√≥digo fuente de Java todav√≠a est√° en estado experimental.  Esto es evidente por la abundancia de problemas, la necesidad de buscar soluciones.  Pero al final, todav√≠a result√≥ lograr el resultado deseado.  ¬øQu√© obtuve? <br><br><ul><li>  El √∫nico archivo aut√≥nomo (casi, hay dependencias en bibliotecas como libc) que pueden ejecutarse en sistemas sin una m√°quina Java. </li><li>  El tiempo de inicio es un promedio de 40 milisegundos versus 2 segundos cuando se inicia un frasco normal. </li></ul><br>  Entre las deficiencias, me gustar√≠a se√±alar el largo tiempo de compilaci√≥n del binario nativo.  Me lleva un promedio de cinco minutos, y lo m√°s probable es que aumente al escribir c√≥digo y conectar bibliotecas.  Por lo tanto, tiene sentido crear archivos binarios basados ‚Äã‚Äãen c√≥digo completamente depurado.  Adem√°s, la informaci√≥n de depuraci√≥n para los binarios nativos solo est√° disponible en la edici√≥n comercial de Graal VM - Enterprise Edition. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/454790/">https://habr.com/ru/post/454790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454774/index.html">Escribimos el c√≥digo m√°s √∫til en nuestra vida, pero lo tiramos a la basura. Con nosotros</a></li>
<li><a href="../454776/index.html">¬øIndependiente u oficina? Respuesta independiente</a></li>
<li><a href="../454778/index.html">El libro "Machine Learning: Algorithms for Business"</a></li>
<li><a href="../454780/index.html">Lo que sabemos sobre microservicios</a></li>
<li><a href="../454788/index.html">Arma de un inversor cauteloso: consideramos el valor razonable de los bonos de inversi√≥n</a></li>
<li><a href="../454792/index.html">Comparaci√≥n de algoritmos de clasificaci√≥n de intercambio</a></li>
<li><a href="../454804/index.html">Crea tu componente con micro-plantillas</a></li>
<li><a href="../454806/index.html">Entrenamiento Cisco 200-125 CCNA v3.0. D√≠a 9. El mundo f√≠sico de los interruptores. Parte 1</a></li>
<li><a href="../454808/index.html">Sobre naves espaciales y espacio. C√≥mo hacer una funci√≥n cambiando todo el producto en el camino</a></li>
<li><a href="../454810/index.html">Aire fresco en Marte: doble una mol√©cula de CO2 y obtenga ox√≠geno</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>