<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧠 👨🏾‍🎨 ↘️ Konfigurasikan cadangan dan pemulihan Zimbra OSE yang lengkap dan terpisah tanpa menggunakan Zextras ✍🏿 🍀 💃🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Di mana untuk memulai 
 Di mana pencadangan dimulai? Perencanaan Saat mencadangkan sistem apa pun, Anda perlu membuat rencana cadangan: apa sebenar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Konfigurasikan cadangan dan pemulihan Zimbra OSE yang lengkap dan terpisah tanpa menggunakan Zextras</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439728/"><img src="https://habrastorage.org/webt/tl/fg/oj/tlfgoj8_4wwdpcdcj5n8ndx2pu0.png" alt="gambar"><br><br><h3>  1. Di mana untuk memulai </h3><br>  Di mana pencadangan dimulai?  Perencanaan  Saat mencadangkan sistem apa pun, Anda perlu membuat rencana cadangan: apa sebenarnya, seberapa sering, berapa lama untuk menyimpan, akankah ada ruang kosong yang cukup?  Dari jawaban atas pertanyaan-pertanyaan ini, jawaban untuk pertanyaan utama berikut - bagaimana cara membuat cadangan? <br><br>  Jika ada banyak ruang kosong, Anda dapat menyimpan seluruh mesin virtual.  Buat cadangan dengan Veeam yang sama sesuai jadwal, dan jangan pikirkan kesulitannya.  Tetapi bagi saya, ini sia-sia, saya biasa melakukan segala sesingkat dan se ekonomis mungkin.  Tentu saja, saya telah menggunakan Veeam, tetapi saya hanya membuat salinan cadangan dari sistem yang tidak mungkin atau bermasalah untuk digunakan dari cadangan untuk waktu yang sangat lama. <br><br>  Tentang skrip alat manajemen lingkungan virtual, saya akan tetap diam dengan penuh makna. <br><br>  Zimbra memiliki alat zmmailbox.  Dan, setelah memeriksa lebih dekat fungsinya, saya menyadari bahwa itu akan lebih dari cukup bagi saya.  Dia dapat membuat cadangan dan memulihkan kotak surat bahkan pada sistem live.  Dan saya menyukai kemampuan untuk membackup kotak surat penting secara terpisah dari cadangan seluruh sistem.  Dengan demikian, ruang yang ditempati oleh cadangan akan dibatasi oleh ukuran kotak surat yang diarsipkan dikalikan dengan jumlah hari "kedalaman cadangan", dan bukan oleh volume seluruh sistem dikalikan dengan jumlah hari yang sama.  Selain itu, sangat sulit untuk memulihkan dari cadangan seluruh sistem, dalam kasus Zimbra.  Jauh lebih mudah untuk menyalin mesin virtual menggunakan Veeam atau alat manajemen lingkungan virtual (Hyper-V, ESXI, masukkan yang diinginkan) segera setelah menyiapkan sistem, dan letakkan "di rak" sehingga pada saat kritis Anda dapat dengan cepat menggunakan VM tanpa berat dan mengunggah. di dalamnya cadangan kotak.  Menurut pendapat saya, ini adalah skenario paling murah dalam semua hal. <br><a name="habracut"></a><br><h3>  2. Sumber data: </h3><br>  <i>Server OS</i> : CentOS 7 <br><br><div class="spoiler">  <b class="spoiler_title">Tentang OS</b> <div class="spoiler_text">  Faktanya, perbedaan antara CentOS7 dan sistem lainnya hanya akan terletak pada perintah ke server untuk menginstal paket, dan, mungkin, lokasi beberapa file.  Pekerjaan dilakukan terutama dengan cmdlet Zimbra, sehingga perbedaan konfigurasi akan minimal. </div></div><br>  <i>Zimbra Domain</i> : zimbramail.home.local <br>  <i>Nama pengguna dan kata sandi untuk akses ke folder bersama</i> : ZimbraBackUp / 123123 <br>  <i>Jalur ke folder bersama</i> : \\ BackUpServer1 \ ZM \ <br>  <i>Jalan untuk memasang bola pada host Zimbra</i> : / mnt / ZM / <br><br><h3>  3. Pengaturan </h3><br>  Jadi mari kita mulai! <br><br>  Kami akan menulis cadangan ke server yang menjalankan Windows di folder bersama.  Jika mau, Anda dapat menggabungkan cadangan di mana saja, tetapi saya sudah mengatur semuanya agar sebagian besar cadangan ditulis ke BackUpServer1.home.local.  Jadi itu: <br><br>  1) Kami membuat di domain pengguna untuk mengakses folder bersama di server ini sehingga dapat dipasang di server Zimbramail.home.local.  Nama pengguna ZimbraBackUp, kata sandi, kondisional, 123123. <br><br>  2) Di server BackUpServer1, buat direktori \ ZM \ di repositori, dan bagikan, berikan hak perubahan untuk pengguna ZimbraBackUp.  Jalan menuju bola adalah: \\ BackUpServer1 \ ZM \ <br><br>  3) Pasang bola ke server Zimbramail.home.local.  Agar folder dapat dipasang secara otomatis, Anda perlu memperbaiki file / etc / fstab dengan menambahkan baris ke dalamnya: <br><br><pre><code class="bash hljs">//BackUpServer/ZM /mnt/ZM cifs user,uid=500,rw,suid,username=ZimbraBackUp,password=123123 0 0</code> </pre> <br>  Tetapi pertama-tama Anda perlu memeriksa apakah mount berfungsi: <br><br><pre> <code class="bash hljs">$ mount -t cifs //BackUpServer/ZM /mnt/ZM -o user=ZimbraBackUp,password=123123</code> </pre> <br>  Seringkali kesalahan seperti ini muncul: <br><br><pre> <code class="bash hljs">mount: wrong fs <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, bad option, bad superblock on //BackUpServer1/ZM/, missing codepage or helper program, or other error (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> several filesystems (eg nfs, cifs) you might need a /sbin/mount.&lt;<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>&gt; helper program) In some cases useful info is found <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> syslog - try dmesg | tail or so.</code> </pre> <br>  Anda dapat memperbaikinya dengan menginstal cifs-utils: <br><br><pre> <code class="bash hljs">$ yum install cifs-utils</code> </pre> <br>  Setelah pengaturan, saya sarankan memulai kembali server. <br><br>  4) Buat 3 file skrip: FullBackUp.sh HandBackUp.sh Restore.sh <br><br>  File pertama akan digunakan untuk secara otomatis membuat cadangan terjadwal, yang kedua untuk kemampuan membuat cadangan kotak surat individual, atau secara manual memulai "bagaimana jika".  Dan skrip ketiga adalah pemulihan satu atau semua kotak sekaligus.  Saya mencoba sebisa mungkin untuk mengomentari karya skrip dan penebangan yang ditentukan. <br><br><div class="spoiler">  <b class="spoiler_title">Isi file FullBackUp.sh:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #    ArchPath="/mnt/ZM/Archive" #    MPath="/mnt/ZM/Mounthly" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #  CDate=$(date +%d-%m-%Y) #   MDay=$(date +%d) #   log="/mnt/ZM/BackUpLog.txt" echo -en "BackUp ALL MailBoxes started in $(date +%T)\n" &gt;&gt; $log #       if [ ! -d $Path ]; then #     echo "    ..." mkdir -p $Path if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "BackUp dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "BackUp dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "    ,      ..." fi #       if [ ! -d $Path/$CDate ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo #        echo "       ..." mkdir -p $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "BackUp CDate dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "BackUp CDate dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo "    ,     ..." fi #     /opt/zimbra/bin/zmprov -l gaa $ZDomain &gt; $MBoxes #    if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Boxes list created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box list is NOT created! in $(date +%T)\n" &gt;&gt; $log exit fi #       for MailBox in $( cat $MBoxes); do echo "    $MailBox..." /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then #        echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi done #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "File $MBoxes clear\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "File $MBoxes can NOT be cleared\n" &gt;&gt; $log fi #      #      if [ ! -d $ArchPath ]; then #    echo "   ..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "   , ..." fi tar -czf $ArchPath/$CDate.tar $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log #         if [ "$MDay" = 1 ]; then #      if [ ! -d $MPath ]; then #     echo "    ..." mkdir -p $MPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Long saving dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Long saving dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else #  echo "    ,     ..." fi cp $ArchPath/$CDate.tgz $MPath/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive is copied in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT copied in $(date +%T)\n" &gt;&gt; $log fi echo "    ( 1 )..." # ,   ,   find $Path -atime +7 | xargs rm -d if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Old BackUps files was deleted\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Old BackUps files is NOT deleted in $(date +%T)\n" &gt;&gt; $log fi #    ( 2 ) echo "     ( 2 )..." find $ArchPath -atime +61 | xargs rm -f if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Old BackUps archives was deleted\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Old BackUps archives is NOT deleted in $(date +%T)\n" &gt;&gt; $log fi fi else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi echo "BackUp job finished in $(date +%T)" #  -     echo -en "BackUp job finished in $(date +%T) $(date +%T)\n" &gt;&gt; $log echo -en "_____________________________________________\n" &gt;&gt; $log</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Konten file HandBackUp.sh:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #    ArchPath="/mnt/ZM/Archive" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #  CDate=$(date +%d-%m-%Y) #   log="/mnt/ZM/BackUpLog.txt" read -p "    (  ),  ALL      : " A if [[ "$A" = "ALL" || "$A" = "all" ]]; then echo -en "BackUp started in $(date +%T)\n" &gt;&gt; $log #     echo "    ..." /opt/zimbra/bin/zmprov -l gaa $ZDomain &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Boxes list created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box list is NOT created! in $(date +%T)\n" &gt;&gt; $log exit fi if ! [ -d $Path/$Date ]; then #    mkdir -p $Path/$CDate/ echo -en "BackUp directory created in $(date +%T)\n" &gt;&gt; $log fi #       echo "      " for MailBox in $( cat $MBoxes); do echo "    $MailBox..." /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi done else MailBox="$A@$ZDomain" #    echo "   ..." Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then #   echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo "  $MailBox ,  ..." echo -en "Required Mail Box $MailBox exist $(date +%T)\n" &gt;&gt; $log #      if ! [ -d $Path/$Date ]; then #    mkdir -p $Path/$CDate/ echo -en "BackUp directory created in $(date +%T)\n" &gt;&gt; $log fi #    $MailBox /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi else #    -  echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo "  $MailBox  .   " echo -en "Required Mail Box $MailBox is not exist\n" &gt;&gt; $log exit fi fi read -p "      $MailBox? [N]: " F if [[ "$F" = "Y" || "$F" = "y" ]]; then #      if [ ! -d $ArchPath ]; then #     echo "   ..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "   , ..." fi #    echo "  ..." if [[ "$A" = "ALL" || "$A" = "all" ]]; then tar -czf $ArchPath/$CDate.tar $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi else tar -czf $ArchPath/$MailBox.tar $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi fi else echo "   " echo -en "User decline archive creating\n" &gt;&gt; $log fi #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo fi echo "BackUp job finished in $(date +%T) $(date +%T)" #  -     echo -en "BackUp job finished in $(date +%T) $(date +%T)\n" &gt;&gt; $log echo -en "_____________________________________________\n" &gt;&gt; $log</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Isi file Restore.sh:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #   log="/mnt/ZM/RestoreLog.txt" read -p "  ,      02-09-2001: " Date if ! [ -d $Path/$Date ]; then echo "     ." echo -en "No BackUp file at $Date $(date +%T)\n" &gt; $log exit fi read -p "    (  ),  ALL        : " A if [[ "$A" = "ALL" || "$A" = "all" ]]; then echo -en "Restore started in $(date +%T)\n" &gt;&gt; $log #     ls "$Path/$Date" &gt; $MBoxes for MailBox in $( cat $MBoxes); do #   echo "   $MailBox" Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Start restore job for $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Mail Box $MailBox does not exist, creating Mail Box $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox  .   $MailBox..." #   Result=$(/opt/zimbra/bin/zmprov ca $MailBox 12345678 displayName "$MailBox") if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Mail Box $MailBox is created, starting restore $(date +%T)\n" &gt;&gt; $log echo " $MailBox  . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Can NOT create Mail Box $MailBox ! $(date +%T)\n" &gt;&gt; $log echo " $MailBox   ." fi fi #  Result=$(/opt/zimbra/bin/zmmailbox -z -m $MailBox postRestURL "//?fmt=tgz&amp;resolve=replace" $Path/$Date/$MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en " $MailBox   $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en " $MailBox  ! $(date +%T)\n" &gt;&gt; $log fi done else #     MailBox="$A@$ZDomain" if [ -a $Path/$Date/$MailBox ]; then #   echo "   $MailBox..." Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Start restore job for $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Mail Box $MailBox does not exist $(date +%T)\n" &gt;&gt; $log echo " $MailBox  ." read -p "            ? [N]: " B if [[ "$B" = "Y" || "$B" = "y" ]]; then echo "   $MailBox..." Result=$(/opt/zimbra/bin/zmprov ca $MailBox 12345678 displayName "$MailBox") #   if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Mail Box $MailBox is created, starting restore $(date +%T)\n" &gt;&gt; $log echo " $MailBox  . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Can NOT create Mail Box $MailBox ! $(date +%T)\n" &gt;&gt; $log echo " $MailBox   .   ..." exit fi else #   ,  .  echo "   .   " exit fi fi #  Result=$(/opt/zimbra/bin/zmmailbox -z -m $MailBox postRestURL "//?fmt=tgz&amp;resolve=replace" $Path/$Date/$MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en " $MailBox   $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en " $MailBox  ! $(date +%T)\n" &gt;&gt; $log fi else #     echo "    .   " echo -en "Required BackUp file is not exist\n" &gt;&gt; $log exit fi fi #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo fi echo "BackUp job finished in $(date +%T) $(date +%T)" #  -     echo -en "Restore job complete in $(date +%T)\n" &gt;&gt; $log echo -en "____________________________________\n" &gt;&gt; $log</span></span></code> </pre></div></div><br>  Ada satu kehalusan.  Jika Anda membuat dan mengedit file skrip untuk bash di Windows, maka ketika Anda mencoba menjalankan skrip, akan muncul kesalahan: <b>/ bin / sh ^ M: penerjemah buruk: Tidak ada file atau direktori seperti itu</b> , yang ditambahkan oleh editor yang berjalan di bawah Windows ke akhir baris adalah karakter carriage return "CR \ LF", yang tidak ditampilkan oleh editor di Linux.  Tapi simbol ini ada di sana, dan belum menghilang.  Untuk menghilangkan kesalahan dan menghapus karakter tambahan kami melakukan hal berikut: <br><br><pre> <code class="bash hljs">$ cat your-script.sh | tr -d <span class="hljs-string"><span class="hljs-string">'\r'</span></span> &gt; corrected-your-script.sh</code> </pre> <br>  Baik, atau Anda dapat menggunakan utilitas dos2unix, tetapi Anda masih harus menginstalnya: <br><br><pre> <code class="bash hljs">$ yum install dos2unix $ dos2unix your-script.sh</code> </pre> <br>  5) Kami membuat skrip dapat dieksekusi: <br><br><pre> <code class="bash hljs">$ chmod 0740 /opt/zimbra/BkUpRestScripts/FullBackUp.sh $ chmod 0740 /opt/zimbra/BkUpRestScripts/HandBackUp.sh $ chmod 0740 /opt/zimbra/BkUpRestScripts/Restore.sh</code> </pre> <br>  6) Saya sarankan Anda menjalankan skrip dengan tangan Anda dan memeriksa apakah mereka bekerja, dan bagaimana cara kerjanya. <br><br>  7) Buat tugas dalam CRON untuk cadangan harian kotak surat: <br><br><pre> <code class="bash hljs">10 0 * * * root /opt/zimbra/ BkUpRestScripts/FullBackUp.sh</code> </pre> <br>  8) Nikmati <br><br><h3>  4. Scripting </h3><br>  Seandainya komentar dalam skrip itu sendiri tidak membantu. <br><br><div class="spoiler">  <b class="spoiler_title">1) Script FullBaclUp.sh:</b> <div class="spoiler_text">  Pada awalnya, variabel ditentukan, mana yang bertanggung jawab untuk apa - semuanya dikomentari. <br><br>  Berikut ini adalah cek untuk tidak adanya direktori untuk cadangan, jika tidak ada, itu dibuat.  Kesimpulan dibuat untuk file log dan ke layar (jika dimulai dengan tangan) tentang keberhasilan atau kegagalan membuat direktori. <br><br>  Periksa katalog yang hilang dengan tanggal hari ini.  Jika tidak ada, itu dibuat, output ke layar dan log dari hasil membuat direktori juga dihasilkan. <br><br>  Menulis ke file semua kotak surat Zimbra yang ada.  Diperlukan untuk reservasi berurutan dari setiap kotak.  Menampilkan hasil dari perintah. <br><br>  Membuat cadangan untuk setiap kotak surat dari daftar yang diterima.  Dengan output dari eksekusi ke layar dan ke file log. <br><br>  Menghapus file dengan daftar kotak.  Karena ketiga skrip berfungsi dengan file ini, disarankan untuk membersihkannya setelah setiap kali dijalankan sehingga tidak ada kejutan.  Anda dapat membersihkannya sebelum skrip dimulai, tetapi entah bagaimana lebih akrab bagi saya untuk tidak menyimpan data tambahan setelah pekerjaan selesai, tetapi untuk melakukan hal yang sama sebelum dan setelah skrip berjalan adalah skizofrenia ringan. <br><br>  Berikutnya adalah blok untuk membuat arsip terkompresi. <br><br>  Memeriksa ketiadaan direktori penyimpanan arsip, membuatnya dalam ketiadaan, dan menampilkan hasil pembuatan di layar dan log <br><br>  Pengarsipan <br><br>  Periksa "bukan hari pertama hari ini?"  Saya lebih suka menyimpan cadangan untuk hari pertama semua bulan untuk waktu yang lama, ini sudah cukup bagi saya untuk bekerja.  Dapat disimpan selama berminggu-minggu, tetapi sering kali ini berlebihan.  Tetapi kondisi untuk menyimpan cadangan untuk seluruh periode operasi server surat diatur di atas, sehingga mereka selalu terbaring di sana.  Jika nomor tersebut adalah yang pertama, maka arsip yang dihasilkan disalin ke direktori "Mounthly" yang terpisah.  Dan untuk menyalinnya di sana, Anda perlu memeriksa apakah ada direktori seperti itu, dan jika tidak, buatlah, yang harus dilaporkan ke layar dan ke file log. <br><br>  Selanjutnya, penyimpanan dibersihkan - semua cadangan yang lebih dari 2 minggu dihapus, serta arsip yang lebih tua dari 61 hari.  Hasil penghapusan ditampilkan di layar dan dalam file log. <br><br>  Setelah itu skrip menulis waktu penyelesaian ke file log dan ke layar, dan mengakhiri kerjanya. </div></div><br><div class="spoiler">  <b class="spoiler_title">2) Script HandBackUp.sh:</b> <div class="spoiler_text">  Pada awalnya, variabel juga didefinisikan, juga mengomentari mengapa mereka diperlukan. <br><br>  Selanjutnya, pengguna diminta untuk memasukkan nama kotak surat yang perlu dicadangkan, tanpa menentukan domain Zimbra.  (ada tertulis di undangan untuk masuk), atau pilih cadangan dari semua kotak surat dengan menulis SEMUA atau semua. <br><br>  Jika Anda memilih untuk mencadangkan semua kotak surat, skrip bekerja hampir sama dengan yang pertama di atas, kecuali bahwa setelah membuat cadangan untuk setiap kotak surat, ia akan bertanya - apakah saya perlu mengarsipkannya? <br><br>  Jika kotak surat tertentu ditulis, maka keberadaannya diperiksa di Zimbra.  Jika kotak dengan nama yang ditentukan ada, maka proses pencadangan kotak ini dimulai, dengan informasi yang sesuai ditampilkan di layar dan dalam file log.  Jika kotak yang ditentukan tidak ada, pengguna akan diberitahu tentang ini, dan skrip akan menyelesaikan pekerjaannya. <br><br>  Setelah cadangan kotak selesai, Anda akan diminta untuk mengarsipkan salinannya.  Jika pengguna setuju - ada pemeriksaan untuk tidak adanya direktori untuk menyimpan arsip dan lebih jauh ke bawah daftar, seperti pada skrip pertama. <br><br>  Setelah pengarsipan selesai, file dengan daftar kotak surat dihapus.  Untuk jaga-jaga. <br><br>  Pada akhirnya, informasi tentang waktu penyelesaian skrip ditampilkan di layar dan dalam file log. </div></div><br><div class="spoiler">  <b class="spoiler_title">3) Script Restore.sh:</b> <div class="spoiler_text">  Seperti dalam file sebelumnya, pertama - definisi variabel dengan komentar. <br><br>  Pengguna diminta untuk memilih tanggal cadangan yang akan dipulihkan.  Jika tanggal yang ditentukan tidak ada dalam cadangan, skrip diakhiri dengan melaporkan ini. <br><br>  Jika cadangan untuk tanggal yang ditentukan ada - minta pengguna untuk memasukkan nama kotak yang harus dipulihkan.  Untuk mengembalikan semua kotak Anda perlu menulis SEMUA atau semua. <br><br>  Jika opsi ALL dipilih, skrip membuat daftar file dalam folder cadangan dalam file, memberi tahu tentang hasil pembuatan. <br><br>  Berikutnya adalah langkah demi langkah pemulihan setiap kotak.  Pertama, periksa keberadaan kotak di sistem, jika tidak, itu dibuat, dan kemudian dipulihkan.  Informasi tentang setiap operasi ditampilkan dalam file log dan di layar. <br><br>  Jika kotak tertentu dipilih, itu hampir sama.  Periksa keberadaan file dengan nama yang diminta.  Output ke layar dan file log hasil. <br><br>  Memeriksa keberadaan kotak di sistem.  Output ke layar dan file log hasil. <br>  Undangan kepada pengguna untuk menyetujui pembuatan kotak jika tidak ada dalam sistem.  Output ke layar dan file log hasil. <br><br>  Buat kotak jika disetujui.  Output ke layar dan file log hasil. <br>  Pemulihan kotak surat.  Output ke layar dan file log hasil. <br><br>  Menghapus file dengan daftar kotak pemulihan. <br><br>  Pada akhirnya, informasi tentang waktu penyelesaian skrip ditampilkan di layar dan dalam file log. </div></div><br><h3>  5. Mengenai pemulihan </h3><br>  Jika Anda sedikit memodifikasi skrip ini, maka skrip tersebut cukup cocok untuk memindahkan surat dari server ke server, cukup dengan membuat kotak surat dengan semua konten di tempat baru.  Anda juga dapat memulihkan sistem dari awal, karena alasan tertentu lebih mudah untuk menaikkan kembali server Zimbra daripada mencoba menghidupkan kembali yang lama.  Seperti dijelaskan di atas, Anda dapat menyimpan gambar mesin virtual yang dikonfigurasi dengan memperluasnya jika perlu, dan mengisinya dengan semua data.  Algoritma yang sama untuk berpindah dari satu server Zimbra ke yang lain.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dan tidak ada utilitas berbayar seperti Zextras yang diperlukan. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6. Kesimpulan </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secara umum, tidak ada yang rumit dalam skrip yang saya tulis. </font><font style="vertical-align: inherit;">Ya, ada banyak syarat di dalamnya, karena saya mencoba memprediksi sebanyak mungkin masalah dan kesalahan dalam pekerjaan mereka, tetapi saya juga mencoba mengomentari naskah sejelas mungkin. </font><font style="vertical-align: inherit;">Kemungkinan besar, di luar kotak, mereka tidak akan bekerja untuk semua orang. </font><font style="vertical-align: inherit;">Mungkin seseorang tidak memiliki metode cadangan ini sama sekali. </font><font style="vertical-align: inherit;">Tetapi saya berharap banyak yang akan merasakan manfaatnya.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7. PS: </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini adalah artikel kedua dalam seri “Bagaimana Saya Menerapkan Zimbra.” </font><font style="vertical-align: inherit;">Yang pertama adalah tentang implementasi, otorisasi LDAP dan pembuatan kotak surat otomatis untuk pengguna AD, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artikel ketiga tentang pembuatan otomatis dan pembaruan milis berbasis AD di Zimbra OSE </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ada di sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan saya juga ingin mencatat bahwa ini adalah pengalaman pertama saya menulis skrip pada bash, karena ini, skrip ternyata sangat besar dan "untuk sangat pintar", seperti yang mereka katakan.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id439728/">https://habr.com/ru/post/id439728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id439718/index.html">Pengembangan Aplikasi pada Elixir / Phoenix dengan Docker</a></li>
<li><a href="../id439720/index.html">Pengantar Pemrograman: Penembak 3D Sederhana dari Bawah ke Atas di Akhir Pekan, Bagian 2</a></li>
<li><a href="../id439722/index.html">Efek filter SVG. Bagian 2. Garis besar teks dengan feMorphology</a></li>
<li><a href="../id439724/index.html">Ikhtisar solusi AI & ML pada 2018 dan perkiraan untuk 2019: Bagian 2 - Alat dan perpustakaan, AutoML, RL, etika dalam AI</a></li>
<li><a href="../id439726/index.html">Lock-in: benar atau fiksi?</a></li>
<li><a href="../id439730/index.html">Organisasi peredam melalui kelas standar</a></li>
<li><a href="../id439732/index.html">Lazarus - animasi sederhana menggunakan komponen TImageFragment</a></li>
<li><a href="../id439734/index.html">Menyebarkan Kubernetes di desktop dalam hitungan menit dengan MicroK8s</a></li>
<li><a href="../id439736/index.html">Koneksi IPSec VPN antara MikroTik dan Kerio Control</a></li>
<li><a href="../id439738/index.html">Mencari tombol "Lakukan dengan baik". Zyxel dalam jaringan bisnis kecil dan menengah</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>