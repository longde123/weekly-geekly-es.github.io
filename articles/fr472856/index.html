<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌕 👨🏽‍🎨 👗 Comment j'ai créé un service de contrôle qualité à partir de tables et de bâtons 🐏 🚴🏼 🧙🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Souvent, lorsqu'ils envisagent de lancer un pilote, les gestionnaires commencent à compliquer la situation, à créer des feuilles de rou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment j'ai créé un service de contrôle qualité à partir de tables et de bâtons</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dodopizzadev/blog/472856/">  Bonjour, Habr!  Souvent, lorsqu'ils envisagent de lancer un pilote, les gestionnaires commencent à compliquer la situation, à créer des feuilles de route et à attendre le MVP des développeurs, au lieu de prendre et de tester l'idée par eux-mêmes.  Sous la coupe, je veux partager l'histoire de la création d'un service de contrôle de qualité basé sur les formulaires Google, VK et des dizaines de lignes de code, dans lequel aucun développeur n'a été blessé, seulement 1 agent de commercialisation. <br><br><img src="https://habrastorage.org/webt/z0/h1/0h/z0h10hxua4cagzjcovtbf5t8oja.png"><br><a name="habracut"></a><br><blockquote>  <b>Avertissement</b> : dans cet article, j'attends des exemples de code qui vous poseront des questions, des doutes, peut-être même des larmes sanglantes et la cécité.  Pour le justifier, il n'y a qu'une seule chose à dire - ce code a fonctionné comme Papa Carlo, et a rempli sa mission à 100%, et certains scripts fonctionnent toujours. </blockquote><h2>  Évaluation du First Dodo Pizzeria </h2><br>  L'un des grands principes de notre entreprise - <b>celui qui ne peut pas être mesuré, n'existe pas</b> .  La pizza existe, ce qui signifie que vous devez en quelque sorte évaluer sa qualité. <br><br>  Tout a commencé en 2013.  A cette époque, il y avait 7 pizzerias sur le réseau.  Puis, à Dodo, ils ont décidé de lancer un projet de contrôle de la qualité et des normes des produits - une note de pizzerias ouverte à tous les partenaires. <br><br>  Il ressemblait à ça. <br><br><img src="https://habrastorage.org/webt/c9/rq/qj/c9rqqjnm6lxlqahi13lral5y7ni.png"><br><br>  Les données ont été tirées des appels des clients, des avis sur le social.  réseaux et un peu de Dodo IS (notre système d'information). <br><br>  Un plus évident à cette époque - la notation a commencé à pousser les pizzerias à gérer la qualité pour être au top. <br><br><h2>  Pizzerias Second Mystery Shop </h2><br>  Environ un an plus tard, nous avons réalisé que nous devions évaluer le produit lui-même et avons pris le fameux modèle - «mystery shoppers».  À ce moment, nous avons fait une percée - le premier en Russie a décidé que nos clients seraient les acheteurs mystères. <br><br><h4>  L'émergence d'un groupe fermé VK </h4><br>  Au départ, nous avons découvert comment ils travaillent avec les clients mystères dans les agences qui fournissent de tels services.  Il s'est avéré qu'ils communiquaient par e-mail ou appelaient directement pour proposer une vérification. <br><br>  Cette option ne nous a pas immédiatement séduits.  Nous n'allions certainement pas appeler, car pour nous, c'était long, mais pour un client, c'était douloureux et comparable au spam.  Le courrier était utilisé pour les envois de masse, mais il a été rapidement abandonné. <br><br>  Nous avons trouvé: <br><br><ol><li>  Pour la communication avec les agents secrets et la coordination des contrôles, ils ont utilisé la page habituelle en VK. </li><li>  Pour collecter des reportages photo, ils ont créé un groupe à VK avec un mur ouvert. </li><li>  Et pour les enquêtes de service, nous avons choisi les formulaires Google.  Quoi?  Idéalement, vous n'avez pas besoin de couper un service distinct, et il est bien affiché sur le téléphone mobile. </li><li>  Toutes les instructions étaient dans Google Docs. </li></ol><br>  Tout est à genoux.  Tout est comme il se doit pour une startup. <br><br><img src="https://habrastorage.org/webt/0x/bu/2u/0xbu2ung5j6no9ltwyi_re80aqe.jpeg"><br>  <i>Photo d'un client mystère.</i>  <i>Oui, ils ont mesuré la largeur avec une règle, ont coupé le bord de la pizza pour montrer la cuisson et la qualité de la pâte.</i> <br><br><div class="spoiler">  <b class="spoiler_title">Plus d'exemples de reportages photo de 2015 sont ici.</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/-v/fx/nh/-vfxnheu2wvm1gxfcc2epiwqyxw.jpeg"><br><img src="https://habrastorage.org/webt/zd/kk/d0/zdkkd0crvk0xqgdidv9roxanw_c.jpeg"><br><img src="https://habrastorage.org/webt/qk/co/fz/qkcofzsjt7iz2qm0czous0dw84o.jpeg"><br><img src="https://habrastorage.org/webt/ca/zq/5a/cazq5atxyea8vjvdtmprmwnstly.jpeg"><br></div></div><br>  La note changeait constamment, de nouveaux critères d'évaluation ont été ajoutés.  Par exemple, il s'agit de 131 points pour l'évaluation de la pizzeria Abakan-1. <br><br><img src="https://habrastorage.org/webt/x9/6c/lj/x96cljo2g-fkxgmsrbbqy8_bcxe.gif"><br><br>  L'enfer du processus était que toutes les violations des points étaient notées manuellement, pas d'automatisation.  Et tout cela a été fait par un employé. <br><br><h4>  La magie des feuilles de calcul Google </h4><br>  En 2016, nous avons appris (mûri) que l'humanité a longtemps inventé des fonctions autres que = SUM.  Et ce qui peut être fait en utilisant des scripts et des fonctions d'importation de données entre les tables ... Construction CRM directe. <br><br>  Par exemple, pour évaluer chaque pizzeria dans le tableau était une feuille, et en elle les critères d'évaluation et les scores.  1 pizzeria = 1 feuille.  Plus il y a de pizzerias, plus il y a de feuilles.  Chaque semaine, un nouveau signe.  En appuyant sur le bouton magique, la feuille de modèle dans le tableau a été développée en 120 feuilles.  Wah, comme c'est bon! <br><br><img src="https://habrastorage.org/webt/k-/s9/fv/k-s9fvqwy1wnaomulahpgn7a7no.gif"><br><br>  Cette étape de l'automatisation «Dodo Controlling» a duré environ six mois.  Nous avons progressé pas à pas: nous avons appris quelque chose de nouveau - mis en œuvre, nous avons appris quelque chose d'autre de nouveau - introduit à nouveau. <br><br><h2>  La limitation comme moteur de progrès </h2><br>  Dès le début, nous avons parlé avec des acheteurs mystères au nom d'un compte personnel dans VK.  Et puis est venu le jour où nous avons été confrontés à des problèmes insolubles de pages personnelles: <br><br><ul><li>  il y a une limite de 10 000 amis; </li><li>  Il y a une limite à l'envoi de messages: parfois nous ne pouvions pas envoyer de messages, parce que VK nous bloquait avec la formulation «vous avez envoyé trop de messages, venez demain». </li></ul><br>  Habituellement, VK a bloqué l'envoi de messages vers 16h00.  C'était une happy hour où l'équipe pouvait se reposer. <br><br>  Peu à peu, nous avons rencontré presque toutes les limites du VK et avons presque réussi à cesser d'aimer ce site.  Mais un miracle s'est produit et VK a donné aux groupes la possibilité de connecter des widgets de messages, des robots de discussion et d'autres goodies. <br><br>  En fait, cette possibilité était antérieure à décembre 2016, mais avec une limitation critique pour nous: le groupe ne pouvait répondre au message que dans les 10 jours suivant l'envoi du dernier message du client.  Lorsqu'ils ont supprimé cette restriction, la vie de notre équipe a commencé à briller de nouvelles couleurs.  Depuis lors, nous avons commencé la voie de l'automatisation à l'aide de l'API VK et des feuilles de calcul Google. <br><br><h2>  Peur et dégoût dans un script utilisateur </h2><br>  Au départ, pour devenir un client mystère, vous deviez remplir un formulaire, puis postuler au groupe, nous écrire un mot de code et attendre que nous répondions.  Cette attente peut durer jusqu'à 48 heures.  Elle a été indécemment longue et le désir de procéder à des vérifications après cet enregistrement s'est estompé. <br><br>  Avec un nouveau magasin de connaissances, nous avons commencé à automatiser l'enregistrement. <br><br>  Nous avions plusieurs méthodes API, un formulaire, plusieurs dizaines de tableaux, une page de destination, un bot en PHP, des scripts dans le tableau qui ont été écrits par le marketing le plus cool Dodo et le premier directeur financier de Dodo en une seule personne, des dizaines de modèles de messages pour différentes situations.  Ensuite, je ne savais même pas que cela s'appelait un script utilisateur: <br><br><ol><li>  Le client mystère a rempli un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">questionnaire</a> (il s'agit d'une version obsolète et maintenant elle ne fonctionne plus). </li><li>  Les données du formulaire sont tombées d'abord dans la base de données, puis dans le tableau.  Le bot a d'abord frappé la base de données pour vérifier les données sur le profil, car le délai de réponse de la plaque en dizaines de milliers de lignes était important, et la base de données la digérait facilement). </li><li>  Après avoir rempli le questionnaire dans le formulaire, un message est apparu à l'écran: «Merci, il reste à rejoindre le groupe (lien) et à écrire le mot de code« Sherlock »». </li><li>  Ensuite, le client mystère a envoyé une demande pour rejoindre le groupe et a écrit le mot de code "Sherlock".  Le mot a été le déclencheur pour exécuter le script de validation: <br>  - une demande a été envoyée à la base de données pour savoir si l'agent nous convient selon l'âge; <br>  - si oui, alors la personne a été ajoutée aux groupes, et dans le tableau en face du questionnaire du candidat, le statut «ok / not ok» a été noté; <br>  - Plus de données ont été peintes en couleur turquoise et c'était important.  Donc, avec mes yeux, il était plus facile de comprendre qui nous convient et avec qui nous pouvons parler.  Le script a peint des profils rouges inappropriés; <br>  - puis l'acheteur secret a été automatiquement accepté dans le groupe, et un message a été envoyé au chat avec d'autres étapes et instructions. </li></ol><br><img src="https://habrastorage.org/webt/so/ty/se/sotysezhht_urug1ax9cnrvc9-g.png"><br><br>  Telle est l'automatisation de l'enregistrement.  Maintenant, toute la procédure est devenue presque simple et compréhensible. <br><br>  De plus, tout s'est passé comme sur des roulettes.  Il est devenu clair que nous pouvons envoyer des messages via des tables directement à PM à des agents secrets via des messages de groupe. <br><br><img src="https://habrastorage.org/webt/zn/px/nd/znpxndqiyuxkqp0y6mnhov7fooc.gif"><br><br>  Et vous n'aviez que 46 lignes de code! <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> range = SpreadsheetApp.getActiveSpreadsheet().getActiveRange(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ss = range.getValues(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> carray = range.offset(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>).getValues(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> marray = range.offset(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>).getValues(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> iarray = range.offset(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>).getValues(); ss.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r, i</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tt = range.getRowIndex(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> add = tt + i; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> check = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet().getRange(<span class="hljs-string"><span class="hljs-string">'L'</span></span> + add).getValue(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (check != <span class="hljs-string"><span class="hljs-string">''</span></span>) { SpreadsheetApp.getActiveSpreadsheet().getActiveSheet().getRange(<span class="hljs-string"><span class="hljs-string">'K'</span></span> + add).setValue(<span class="hljs-string"><span class="hljs-string">""</span></span>).setBackground(<span class="hljs-string"><span class="hljs-string">"#ffff00"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> payload = { <span class="hljs-string"><span class="hljs-string">"message"</span></span> : marray[i][<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-string"><span class="hljs-string">"user_id"</span></span> : r[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-string"><span class="hljs-string">"access_token"</span></span> : <span class="hljs-string"><span class="hljs-string">"    "</span></span>, <span class="hljs-string"><span class="hljs-string">"v"</span></span> : <span class="hljs-string"><span class="hljs-string">"5.74"</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> options = { <span class="hljs-comment"><span class="hljs-comment">//   http- "method" : "post", "header" : "Content-type: application/x-www-form-urlencoded", "payload" : payload, "muteHttpExceptions" : true, }; var jsonData = JSON.parse(UrlFetchApp.fetch("https://api.vk.com/method/messages.send", options).getContentText()); if (jsonData['error'] != undefined) { SpreadsheetApp.getActiveSpreadsheet().getActiveSheet().getRange('K' + add).setValue("").setBackground("#ff0000"); } Logger.log(jsonData); var log = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Log'); var int = log.getRange('A1').getValue(); var d = new Date(); log.getRange('B' + int).setValue(d); log.getRange('C' + int).setValue(r[0] + ""); log.getRange('A1').setValue(int + 1); Utilities.sleep(400); }); }</span></span></code> </pre> <br>  Dans les tableaux, nous avons généré le texte des messages et créé un mailing personnalisé en utilisant la page d'identification.  Nous avons également cessé de copier et d'envoyer des messages manuellement.  Aux heures de pointe, nous pouvions envoyer jusqu'à 3000 messages en 45 minutes à l'aide de tableaux.  Si nous le faisions à la main, je n'écrirais pas cet article, mais continuerais à envoyer des messages. <br><br>  Ensuite, je donne un exemple d'une telle tablette miracle.  J'ai essayé très fort de créer une UX / UI claire et fonctionnelle.  En cliquant sur le bouton rouge, une liste de diffusion a été lancée avec une proposition de procéder à un contrôle secret. <br><br><img src="https://habrastorage.org/webt/ht/be/ix/htbeixa27tdtlix28xnzhsmh6xg.png"><br><br><h2>  Plus de fonctionnalités pour automatiser les processus infernaux </h2><br>  La société dispose de nombreux formulaires Google qui nous aident à collecter régulièrement des statistiques sur les pizzerias.  Chaque formulaire contient une liste de pizzerias qui doivent être tenues à jour.  Il existe au total 53 formulaires de ce type, chacun d'entre eux a été mis à jour manuellement auparavant. <br><br>  Un peu fatigués de ce travail, nous avons réalisé que cette entreprise pouvait être automatisée.  Je me suis de nouveau tourné vers notre responsable marketing, après une heure ou deux, tout était prêt et seulement 47 lignes de code. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myFunction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ss = SpreadsheetApp.getActiveSpreadsheet(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> range = ss.getActiveRange(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> forms = range.offset(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>).getValues(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> items = range.offset(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>).getValues(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sources = range.offset(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>).getValues(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ranges = range.offset(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>).getValues(); forms.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r,i</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> form = FormApp.openById(forms[i]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> values = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sources[i]).getRange(ranges[i]).getValues(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arr = []; values.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">el,ei</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (el[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">''</span></span>) { arr.push(el[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> item = form.getItems()[<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>(items[i])].asListItem(); item.setChoiceValues(arr); Logger.log(item.getTitle()); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ss = SpreadsheetApp.getActiveSpreadsheet(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> range = ss.getSheetByName(<span class="hljs-string"><span class="hljs-string">"    "</span></span>).getRange(<span class="hljs-string"><span class="hljs-string">"A2:C"</span></span>).getValues(); Logger.log(range); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onOpen</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ui = SpreadsheetApp.getUi(); <span class="hljs-comment"><span class="hljs-comment">// Or DocumentApp or FormApp. ui.createMenu('Custom Menu') .addItem('Change', 'myFunction') .addToUi(); } function update() { var ss = SpreadsheetApp.getActiveSpreadsheet(); var range = ss.getSheetByName(" ").getRange("A2:A"); range.activate(); myFunction(); } function createTimeDrivenTriggers() { ScriptApp.newTrigger('update').timeBased().everyDays(1).create(); }</span></span></code> </pre><br>  Les formulaires sont différents, avec différentes listes de pizzerias et l'emplacement de la liste des pizzerias dans le formulaire.  Quelque part, nous avons besoin d'étrangers, quelque part de Russie. <br><br><img src="https://habrastorage.org/webt/wq/h8/g2/wqh8g2jyt3gmwqopaicz4h2u_h8.png"><br><br>  Les colonnes B et C indiquent au script sous quel formulaire mettre à jour et à quel endroit le formulaire affiche la liste.  Et les colonnes D et E, à partir de quelle feuille et plage vous devez prendre la liste pour la mise à jour. <br><br>  Ensuite, nous avons défini un déclencheur pour exécuter le script une fois par jour et avons ainsi réussi à vaincre l'enfer du processus de mise à jour des formulaires d'abord pour notre département, puis pour l'ensemble de l'entreprise.  Ce script fonctionne toujours. <br><br><h2>  Le cas le plus difficile d'un escargot </h2><br>  Une fois, nous voulions recevoir des enregistrements audio des contrôles de livraison. <br><br>  D'où vient l'enregistrement audio: les clients mystères ont enregistré la réunion du courrier avec le client sous forme de message audio dans VK.  Il s'agit généralement de 10 à 15 secondes d'enregistrement audio. <br><br>  Comment nous les avons obtenus: ils ont pris les 20 derniers messages sur l'adresse VK du client mystère, ont recherché le mot «Ulica» parmi eux, puis ont reculé d'un message et ont enlevé le lien vers l'enregistrement audio.  (Spoiler: pas le meilleur mot, souvent ils nous ont écrit le mot "Snail"). <br><br>  Il y a déjà plus de lignes de code, préparez-vous. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastAudio</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ss = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> token = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> range = ss.getActiveRange().getValues(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tt = ss.getActiveRange().getRowIndex(); range.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r,i</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ri = tt + i; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cuid = r[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ci = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> payload1 = { <span class="hljs-string"><span class="hljs-string">"q"</span></span> : <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'peer_id'</span></span> : r[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-string"><span class="hljs-string">"access_token"</span></span> : token, <span class="hljs-string"><span class="hljs-string">"v"</span></span> : <span class="hljs-string"><span class="hljs-string">"5.73"</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> options1 = { <span class="hljs-comment"><span class="hljs-comment">//   http- "method" : "post", "header" : "Content-type: application/x-www-form-urlencoded", "payload" : payload1, "muteHttpExceptions" : true }; var jsonData = JSON.parse(UrlFetchApp.fetch("https://api.vk.com/method/messages.search", options1).getContentText()); Logger.log(jsonData); if (jsonData['response']['items'] == undefined) { ss.getRange("B" + ri).setValue(' ').setBackground('#f00'); return; } var cmid = jsonData['response']['items'][0]['id']; var date = new Date((jsonData['response']['items'][0]['date']*1000)); var fdate = Utilities.formatDate(date, "GMT+3", "dd-MM-yyyy HH:mm:ss"); ss.getRange("B" + ri).setValue(fdate); var payload2 = { "user_id" : cuid, "count" : '20', "access_token" : token, "v" : "5.73", }; var options2 = { //   http- "method" : "post", "header" : "Content-type: application/x-www-form-urlencoded", "payload" : payload2, "muteHttpExceptions" : true }; var jsonData2 = JSON.parse(UrlFetchApp.fetch("https://api.vk.com/method/messages.getHistory", options2).getContentText()); Logger.log(jsonData2); jsonData2['response']['items'].forEach(function (r,i) { if (r['id'] == cmid) { ci = i + 1; Logger.log(jsonData2['response']['items'][ci]); if (jsonData2['response']['items'][ci] == undefined) { ss.getRange("C" + ri).setValue(" "); } else { if (jsonData2['response']['items'][ci] != undefined &amp;&amp; jsonData2['response']['items'][ci]['attachments'] != undefined &amp;&amp; jsonData2['response']['items'][ci]['attachments'][0]['doc'] != undefined &amp;&amp; jsonData2['response']['items'][ci]['attachments'][0]['doc']['url'] != undefined) { ss.getRange("C" + ri).setValue(jsonData2['response']['items'][ci]['attachments'][0]['doc']['url']); } else { ss.getRange("C" + ri).setValue(jsonData2['response']['items'][ci]['body']); } } } }); }); }</span></span></code> </pre><br><h2>  Les feuilles de calcul Google ne sont pas caoutchouteuses, mais je suis un encodeur moyen </h2><br>  Donc tout tournait et tournait, jusqu'à ce que nous soyons passés à 60000 clients mystères au début de 2018. <br><br>  Nous avons donc déjà rencontré des restrictions de table.  Ensuite, un tableau ne pouvait pas contenir plus de 2 millions de cellules, et nous avons utilisé 1,6 million de cellules dans l'une des étiquettes de département les plus fréquentées, dont 135 000 cellules avaient toutes sortes de fonctions de tableau. <br><br>  Un tel backend.  Tout a terriblement ralenti et lorsque plusieurs personnes ont travaillé ensemble, l'assiette a donné "Le document est trop populaire, revenez plus tard". <br><br>  Ensuite, il est devenu clair que je suis un mauvais encodeur, le système ne supporte pas la charge et je dois être remplacé. <br><br><h2>  Et puis le vrai développeur est venu ... </h2><br>  Mais c'est une histoire complètement différente et nous en parlerons plus tard.  J'espère que ces exemples aideront les managers dans leurs projets, où il existe de nombreux processus infernaux.  Les processus peuvent et doivent être automatisés, les tables et zapier (nous l'avons également utilisé) peuvent aider, et héberger des solutions s'il y a des ressources, nous ne les avions pas au départ. <br><br>  Si vous avez une personne dans l'entreprise qui sait quelque chose sur les scripts, alors elle convient pour organiser les processus infernaux dans les tablettes.  Si vous voulez vous-même apprendre quelque chose comme ça, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Telegram</a> a un excellent canal pour cela, à partir duquel j'ai pris des informations sur les fonctions et les scripts. <br><br>  Eh bien, tête de mât pour tous les gestionnaires - connaître les tables chaque jour permet de gagner du temps lorsque vous travaillez avec des données et vous permet de penser et de comprendre au moins un peu ce que le développeur fait avec les données et ce que vous pouvez faire avec les données en général. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr472856/">https://habr.com/ru/post/fr472856/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr472838/index.html">En pratique, dans 80 à 90% des cas, l'application web est lente du fait du front-end: un entretien avec Ivan Akulov</a></li>
<li><a href="../fr472840/index.html">Stockage défini par logiciel, ou qu'est-ce qui a tué les dinosaures?</a></li>
<li><a href="../fr472848/index.html">Réflexions sur une carrière en informatique</a></li>
<li><a href="../fr472850/index.html">Profession ou vie: gagnez un cours de netologie si vous n'avez pas peur</a></li>
<li><a href="../fr472854/index.html">Profilage UI Unity: qui gâche mon lot?</a></li>
<li><a href="../fr472858/index.html">Clients Python et HTTP rapides</a></li>
<li><a href="../fr472860/index.html">Invalidation du cache en cascade. Partie 1</a></li>
<li><a href="../fr472862/index.html">Invalidation du cache en cascade. 2e partie</a></li>
<li><a href="../fr472864/index.html">Check Point: optimisation CPU et RAM</a></li>
<li><a href="../fr472866/index.html">Talisman pour une communication stable</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>