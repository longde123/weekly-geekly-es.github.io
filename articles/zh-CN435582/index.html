<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍🏭 🤽🏼 👎🏼 如何在不停机的情况下在已加载系统24/7上添加索引？ 🧙🏼 👩🏻‍🏭 👎🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="朋友们，在一月底，我们将开设一门名为“ MS SQL Server Developer ”的新课程。 预期它的发布，我们请课程老师Kristina Kucherova编写作者的文章。 如果您的产品上有一个非常流行的表具有24/7访问权限，并且突然意识到您迫切需要添加索引并且在此过程中不破坏任何内容，...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>如何在不停机的情况下在已加载系统24/7上添加索引？</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/435582/">  <i>朋友们，在一月底，我们将开设一门名为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">“ MS SQL Server Developer</a> ”的新课程。</i>  <i>预期它的发布，我们请课程老师<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kristina Kucherova</a>编写作者的文章。</i>  <i>如果您的产品上有一个非常流行的表具有24/7访问权限，并且突然意识到您迫切需要添加索引并且在此过程中不破坏任何内容，那么本文将对您有所帮助。</i> <br><br> 那该怎么办呢？ 传统的CREATE INDEX WITH方法（ONLINE = ON）不适合您，因为，例如，它导致系统崩溃和DBA心脏病发作，所有顶端都密切监视系统的响应时间，如果增加，它们就会来找您和您的DBA进行交谈关于您的工作报酬被高估的数字。 <br><br> 脚本和描述的技术在每分钟负载40万个请求的系统上使用，版本为SQL Server 2012和2016（企业版）。 <br><br> 有两种非常不同的创建索引的方法，这些方法的使用取决于表的大小。 <br><br><h3> 案例1。一个很小但很受欢迎的桌子 </h3><br> 一个有5万条记录的表（很小），但是很受欢迎（每分钟几千次点击）。 您需要一个新的索引，最短的停机时间和对表的锁定。 <br> 在应用程序中，对数据库的所有访问都只能通过过程进行。 <br><br> 如果发生错误，则应用程序将重试访问表。 <br><br><img src="https://habrastorage.org/webt/0b/7k/oj/0b7kojuvqjl6d_ty__et9g3wgiu.png"><br><a name="habracut"></a><br> 您问简单地应用此索引有什么问题？ 句子WITH ONLINE = ON（是的，我们很幸运，而这是Enterprise）。 <br><br> 事实是，通过这种主动访问，需要花费一些时间来获得锁（即使使用Online = ON选项也需要最少的锁）。 在等待的过程中，新请求排队，队列不断累积，CPU不断增长，DBA汗流满面，紧张地对开发人员着眼睛，而在应用程序监视图上，您​​的响应时间开始逐渐增加，但不可避免。 您的工程师副总裁对由于响应时间的增加是否会导致某种系统停机而引起极大的兴趣，请问到年底该应用程序的可用性估计不是5个9（99,999），而是更低？ 然后，在可用性降低的情况下，公司将承担合同，义务和重罚，当然，我们也不会忘记声誉损失。 <br><br> 为了避免这种不幸的情况，我们做了什么？ <br> 系统仍然需要索引。 <br> 他们从除此表上的当前会话以外的所有人获取了权利。 <br> 应用索引。 <br><br> 是的，解决方案有一个缺点：在这几秒钟内转过桌子的每个人都会收到访问被拒绝的信息。 如果您的应用程序正常处理这种情况并向数据库重复查询，那么您应该仔细看一下该选项。 对于我们的项目，此方法效果很好。 同样，您可以安全地删除ONLINE = ON，因为我们知道在创建索引期间只有会话可以访问该表。 <br><br> 应用索引的代码： <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> IX_Users_Email_Status <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>] ([Email],[<span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2]</code> </pre> <br> 负载下测试期间响应时间和错误百分比的计划。 <br><br><img src="https://habrastorage.org/webt/h_/nd/ug/h_ndugyc0hybrm5-bps5pmxinuo.png" alt="图片"><br><br> 如果在上述情况下您有一个小表，并且您知道在没有负载的情况下将在几秒钟内（或您可接受的时间内）创建索引，则可以应用该方法。 同时，从上图可以看出，应用程序的响应时间不会增加，尽管可以看出，无法访问表的错误率（以秒为单位）更高。 <br><br><h3> 案例2。大桌子 </h3><br> 如果您有一个大表并且需要更改其索引，那么通常最轻松的销售方法是在表旁边创建一个具有正确索引的表，然后将数据逐渐转移到新表中。 <br><br> 有两种方法： <br><br><ol><li> 如果您有用于修改表的特殊过程，则只需更改过程代码，以便仅将新数据插入到新表中，从这两个表中删除，也将更新应用于这两个表，并使用UNION ALL从两个表中进行选择。 </li><li> 如果您在代码中有许多不同的部分可以在其中更改表中的数据，那么有两种流行的技巧：使用触发器查看或重写代码的所有部分以将数据插入到新表中，从两个表中删除并更新两个表。 当您创建具有两个表的视图并将其重命名，将当前表重命名为TableOld并将视图重命名为Table时，具有触发器的视图是一个选项。 然后，您将自动获得对视图的所有表调用，在这里使用重命名也可能会出现问题，因为需要SchemaLock，但是重命名会很快通过。 </li></ol><br> 有关重写对新表的调用的稍微详细的版本： <br><br><ol><li> 您具有Orders表，使用相同的方案创建一个新的OrdersNew表，但是具有所需的索引。 同时，如果您使用Indentity，则需要将新表中的identity的第一个值设置为等于旧表中的最大值+更改步长或可以承受的价格以偏离Orders最大值的差距。 </li><li> 创建一个OrdersView，在其中选择Orders UNION ALL OrdersNew </li><li> 更改所有过程/调用以从视图中选择数据，将其插入OrdersNew中，删除并修改两个表。 </li><li> 例如，将数据从旧表迁移到新表，如下所示： <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @rowcount <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @batchsize <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">4999</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> IDENTITY_INSERT dbo.OrdersNew <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rowcount = @batchsize; WHILE @rowcount = @batchsize <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> TOP (@batchsize) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.Orders <span class="hljs-keyword"><span class="hljs-keyword">OUTPUT</span></span> deleted.Id ,deleted.Column1 ,deleted.Column2 ,deleted.Column3 <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.OrdersNew (<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span> ,Column1 ,Column2 ,Column3); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rowcount = @@ROWCOUNT; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ERROR_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ErrorNumber, ERROR_MESSAGE() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ErrorMessage; THROW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> IDENTITY_INSERT dbo.OrdersNew <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre><br></li><li> 使用一张表将所有过程返回到迁移之前的版本。 这可以通过更改或删除和创建过程来完成（然后不要忘记权限），然后可以将新表重命名为Orders，删除空表和视图。 </li></ol><br> 在第2步中，如果加载允许，可以将主表Orders-&gt; OrdersOld和OrdersView-&gt; Orders以及视图本身重命名为OrdersOld UNION ALL OrdersNew，那么您不需要将表中所有可以选择的地方都更改。 <br><br> 当将块从一张表移动到另一张表时，数据将碎片化。 <br> 如果要更改的表被主动用于读取，但是其中的数据很少更改，则可以再次使用触发器-将所有更改的副本写入第三表-通过bcp out和bcp in（或大容量插入）将数据从表中传输到新表中，在数据传输后在其上创建索引，然后将具有更改日志的表中的更改应用于-将一个表切换到另一个表-当前表，将其重命名为TableOld，将新表从TableNew重命名为Table。 <br><br> 在这种情况下出错的可能性会稍高一些，因此请在这种情况下测试更改的应用和不同的切换情况。 <br><br> 所描述的选项不是唯一的。 我在一个负载很重的SQL Server数据库上使用了它们，并且在应用程序期间没有引起问题，这使我们的DBA团队感到满意。 当您可以在活动最少的时间段中安全地应用更改时，对于负载模式较为平稳的碱基通常不需要这种反弹。 使用上述方法的项目用户位于美国和欧洲，并在工作日和周末积极使用该应用程序，并且在工作中不断使用应用了更改的表格。 在开发人员和一名DBA审核脚本之后，通常通过Redgate Toolkit生成的自动脚本来更改更多“更安静”的对象。 <br><br>  <i>对所有人都好！</i>  <i>如果您使用这些方法中的任何一种或描述您的方法，请在评论中分享！</i>  <i>我们还邀请您参加我们的新课程<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">“ MS SQL Server Developer”</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的公开课</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">开放日。</a></i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN435582/">https://habr.com/ru/post/zh-CN435582/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN435572/index.html">Anycubic i3 Mega：Prusa i3的高品质翻拍</a></li>
<li><a href="../zh-CN435574/index.html">Zig如何工作？</a></li>
<li><a href="../zh-CN435576/index.html">1C，无痛苦</a></li>
<li><a href="../zh-CN435578/index.html">圣诞节太空漫步</a></li>
<li><a href="../zh-CN435580/index.html">Java，Spring，Kurento和媒体服务</a></li>
<li><a href="../zh-CN435584/index.html">Slush2018。第一天，第二天</a></li>
<li><a href="../zh-CN435586/index.html">萨满教或Olinuxino定制固件的艺术。 内核和Ubuntu第3部分</a></li>
<li><a href="../zh-CN435588/index.html">推广具有实际数字经验的移动应用程序</a></li>
<li><a href="../zh-CN435590/index.html">再次预测，第1部分</a></li>
<li><a href="../zh-CN435592/index.html">亚速尔群岛：大西洋中部的最后一个植物区系</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>