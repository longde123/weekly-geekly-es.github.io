<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêõ ü§±üèæ ü§µüèø R√©f√©rentiels utiles avec Eloquent? üò≤ üíÜ üöè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La semaine derni√®re, j'ai √©crit un article sur l'inutilit√© du mod√®le de r√©f√©rentiel pour les entit√©s Eloquent , mais j'ai promis de dire comment l'uti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>R√©f√©rentiels utiles avec Eloquent?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445452/"><p>  La semaine derni√®re, j'ai √©crit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un article sur l'inutilit√© du mod√®le de r√©f√©rentiel pour les entit√©s Eloquent</a> , mais j'ai promis de dire comment l'utiliser partiellement avec avantage.  Pour ce faire, je vais essayer d'analyser comment ce mod√®le est g√©n√©ralement utilis√© dans les projets.  L'ensemble minimal requis de m√©thodes pour le r√©f√©rentiel: </p><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Post $post)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span></span>; }</code> </pre> <br><p>  Cependant, dans les projets r√©els, s'il √©tait d√©cid√© d'utiliser des r√©f√©rentiels, des m√©thodes de s√©lection des enregistrements leur sont souvent ajout√©es: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Post $post)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTopPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userId)</span></span></span></span>; }</code> </pre> <a name="habracut"></a><br><p>  Ces m√©thodes pourraient √™tre impl√©ment√©es via des √©tendues Eloquent, mais surcharger les classes d'entit√©s avec des responsabilit√©s pour se r√©cup√©rer n'est pas une bonne id√©e et placer cette responsabilit√© dans les classes de r√©f√©rentiel semble logique.  En est-il ainsi?  J'ai sp√©cifiquement divis√© visuellement cette interface en deux parties.  La premi√®re partie des m√©thodes sera utilis√©e dans les op√©rations d'√©criture. </p><br><p>  Les op√©rations d'√©criture standard sont: </p><br><ul><li>  construire un nouvel <strong>objet</strong> et appeler <strong>PostRepository :: save</strong> </li><li>  <strong>PostRepository :: getById</strong> , manipulation d'entit√© et appel √† <strong>PostRepository :: save</strong> </li><li>  appeler <strong>PostRepository :: delete</strong> </li></ul><br><p>  Il n'y a pas de m√©thodes d'√©chantillonnage dans les op√©rations d'√©criture.  Dans les op√©rations de lecture, seules les m√©thodes get * sont utilis√©es.  Si vous lisez le <strong>principe de s√©paration des interfaces</strong> (lettre <strong>I</strong> dans <strong>SOLID</strong> ), il deviendra clair que notre interface est trop grande et remplit au moins deux responsabilit√©s diff√©rentes.  Il est temps de le diviser en deux.  La m√©thode <strong>getById est</strong> requise dans les deux, mais si l'application <strong>devient</strong> plus compliqu√©e, son impl√©mentation sera diff√©rente.  Nous verrons cela un peu plus tard.  J'ai √©crit sur l'inutilit√© de la partie √©criture dans un article pr√©c√©dent, donc dans ce que j'oublie. </p><br><p>  Lire la partie ne me semble pas si inutile, car m√™me pour Eloquent il peut y avoir plusieurs impl√©mentations.  Comment nommer une classe?  Vous pouvez <strong>ReadPostRepository</strong> , mais il a d√©j√† peu de relation avec le mod√®le de <strong>r√©f√©rentiel</strong> .  Vous pouvez simplement <strong>PostQueries</strong> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostQueries</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTopPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userId)</span></span></span></span>; }</code> </pre> <br><p>  Son impl√©mentation avec Eloquent est assez simple: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EloquentPostQueries</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostQueries</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Post::findOrFail($id); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Post[] | Collection */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Post::orderBy(<span class="hljs-string"><span class="hljs-string">'created_at'</span></span>, <span class="hljs-string"><span class="hljs-string">'desc'</span></span>) -&gt;limit(<span class="hljs-comment"><span class="hljs-comment">/*some limit*/</span></span>) -&gt;get(); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Post[] | Collection */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTopPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Post::orderBy(<span class="hljs-string"><span class="hljs-string">'rating'</span></span>, <span class="hljs-string"><span class="hljs-string">'desc'</span></span>) -&gt;limit(<span class="hljs-comment"><span class="hljs-comment">/*some limit*/</span></span>) -&gt;get(); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $userId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Post[] | Collection */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Post::whereUserId($userId) -&gt;orderBy(<span class="hljs-string"><span class="hljs-string">'created_at'</span></span>, <span class="hljs-string"><span class="hljs-string">'desc'</span></span>) -&gt;get(); } }</code> </pre> <br><p>  L'interface doit √™tre associ√©e √† l'impl√©mentation, par exemple dans <strong>AppServiceProvider</strong> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppServiceProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">register</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;app-&gt;bind(PostQueries::class, EloquentPostQueries::class); } }</code> </pre> <br><p>  Cette classe est d√©j√† utile.  Il prend conscience de sa responsabilit√© en d√©chargeant soit des contr√¥leurs, soit une classe d'entit√©s.  Dans le contr√¥leur, il peut √™tre utilis√© comme ceci: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostsController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lastPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PostQueries $postQueries)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> view(<span class="hljs-string"><span class="hljs-string">'posts.last'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'posts'</span></span> =&gt; $postQueries-&gt;getLastPosts(), ]); } }</code> </pre> <br><p>  La <strong>m√©thode PostsController :: lastPosts</strong> se demande simplement une certaine impl√©mentation de <strong>PostsQueries</strong> et fonctionne avec elle.  Dans le fournisseur, nous avons associ√© <strong>PostQueries</strong> √† la classe <strong>EloquentPostQueries</strong> et cette classe sera remplac√©e dans le contr√¥leur. </p><br><p>  Imaginons que notre application soit devenue tr√®s populaire.  Des milliers d'utilisateurs par minute ouvrent la page avec les derni√®res publications.  Les publications les plus populaires sont √©galement lues tr√®s souvent.  Les bases de donn√©es ne supportent pas tr√®s bien de telles charges, elles utilisent donc la solution standard - cache.  En plus de la base de donn√©es, une certaine p√©pite de donn√©es est stock√©e dans un r√©f√©rentiel optimis√© pour certaines op√©rations - <strong>memcached</strong> ou <strong>redis</strong> . </p><br><p>  La logique de mise en cache n'est g√©n√©ralement pas si compliqu√©e, mais sa mise en ≈ìuvre dans EloquentPostQueries n'est pas tr√®s correcte (du moins en raison du <strong>principe de responsabilit√© unique</strong> ).  Il est beaucoup plus naturel d'utiliser le mod√®le <strong>Decorator</strong> et d'impl√©menter la mise en cache comme d√©coration de l'action principale: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Contracts</span></span>\<span class="hljs-title"><span class="hljs-title">Cache</span></span>\<span class="hljs-title"><span class="hljs-title">Repository</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CachedPostQueries</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostQueries</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> LASTS_DURATION = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> PostQueries */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $base; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> Repository */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $cache; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( PostQueries $base, Repository $cache)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;base = $base; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache = $cache; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Post[] | Collection */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache-&gt;remember(<span class="hljs-string"><span class="hljs-string">'last_posts'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::LASTS_DURATION, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;base-&gt;getLastPosts(); }); } <span class="hljs-comment"><span class="hljs-comment">//      }</span></span></code> </pre> <br><p>  Ignorez l'interface du <strong>r√©f√©rentiel</strong> dans le constructeur.  Pour une raison quelconque, ils ont d√©cid√© d'appeler l'interface de mise en cache dans Laravel. </p><br><p>  La classe <strong>CachedPostQueries</strong> impl√©mente uniquement la mise en cache.  <strong>$ this-&gt; cache-&gt; souvenez-vous de</strong> v√©rifier si l'entr√©e donn√©e est dans le cache et sinon, il appelle le rappel et √©crit la valeur retourn√©e dans le cache.  Il ne reste plus qu'√† impl√©menter cette classe dans l'application.  Nous avons besoin de toutes les classes qui dans l'application demandent l'impl√©mentation de l'interface <strong>PostQueries</strong> pour recevoir une instance de la classe <strong>CachedPostQueries</strong> .  Cependant, <strong>CachedPostQueries</strong> lui-m√™me devrait recevoir la classe <strong>EloquentPostQueries en</strong> tant que param√®tre dans le constructeur, car elle ne peut pas fonctionner sans une "r√©elle" impl√©mentation.  Modifier <strong>AppServiceProvider</strong> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppServiceProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">register</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;app-&gt;bind(PostQueries::class, CachedPostQueries::class); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;app-&gt;when(CachedPostQueries::class) -&gt;needs(PostQueries::class) -&gt;give(EloquentPostQueries::class); } }</code> </pre> <br><p>  Tous mes souhaits sont tout naturellement d√©crits dans le fournisseur.  Ainsi, nous avons impl√©ment√© la mise en cache pour nos demandes uniquement en √©crivant une classe et en modifiant la configuration du conteneur.  Le code pour le reste de l'application n'a pas chang√©. </p><br><p>  Bien s√ªr, pour l'impl√©mentation compl√®te de la mise en cache, il est toujours n√©cessaire d'impl√©menter l'invalidation afin que l'article supprim√© ne reste pas sur le site pendant un certain temps, mais qu'il quitte imm√©diatement (r√©cemment √©crit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un article sur la mise en cache</a> , il peut aider dans les d√©tails). </p><br><p>  Conclusion: nous avons utilis√© non pas un, mais deux mod√®les entiers.  Le mod√®le <strong>CQRS (Command Query Responsibility Segregation)</strong> offre une s√©paration compl√®te des op√©rations de lecture et d'√©criture au niveau de l'interface.  Je suis venu vers lui via le <strong>principe de s√©gr√©gation d'interface</strong> , ce qui signifie que je manipule habilement les mod√®les et les principes et que j'en d√©duis l'un de l'autre comme un th√©or√®me :) Bien s√ªr, tous les projets n'ont pas besoin d'une telle abstraction sur des √©chantillons d'entit√©, mais je partagerai le focus avec vous. <strong>Au</strong> stade initial du d√©veloppement d'applications, vous pouvez simplement cr√©er une classe <strong>PostQueries</strong> avec une impl√©mentation r√©guli√®re via Eloquent: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostQueries</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Post::findOrFail($id); } <span class="hljs-comment"><span class="hljs-comment">//   }</span></span></code> </pre> <br><p>  Lorsque le besoin se fait sentir pour la mise en cache, vous pouvez facilement cr√©er une interface (ou une classe abstraite) √† la place de cette classe <strong>PostQueries</strong> , copier son impl√©mentation dans la classe <strong>EloquentPostQueries</strong> et passer au sch√©ma que j'ai d√©crit pr√©c√©demment.  Le reste du code d'application n'a pas besoin d'√™tre modifi√©. </p><br><p>  Cependant, il reste un probl√®me avec l'utilisation des m√™mes entit√©s Post qui peuvent modifier les donn√©es.  Ce n'est pas exactement CQRS. </p><br><p><img src="https://habrastorage.org/webt/c3/rl/wx/c3rlwxjo18l4kxe9zfjmxr-axfi.png"></p><br><p>  Personne ne d√©range pour obtenir l'entit√© <strong>Post</strong> de <strong>PostQueries</strong> , la modifier et enregistrer les modifications avec un simple <strong>-&gt; save ()</strong> .  Et √ßa marchera. <br>  Apr√®s un certain temps, l'√©quipe passera √† la r√©plication ma√Ætre-esclave dans la base de donn√©es et <strong>PostQueries</strong> fonctionnera avec des r√©plicas en lecture.  Les op√©rations d'√©criture sur les r√©plicas en lecture sont g√©n√©ralement bloqu√©es.  L'erreur s'ouvrira, mais vous devrez travailler dur pour r√©parer tous ces montants. </p><br><p>  La solution √©vidente consiste √† s√©parer compl√®tement les parties de <strong>lecture</strong> et d' <strong>√©criture</strong> .  Vous pouvez continuer √† utiliser Eloquent, mais en cr√©ant une classe pour les mod√®les en lecture seule.  Exemple: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/adelf/freelance-example/blob/master/app/ReadModels/ReadModel.php</a> Toutes les op√©rations de modification des donn√©es sont bloqu√©es.  Cr√©ez un nouveau mod√®le, par exemple <strong>ReadPost</strong> (vous pouvez quitter <strong>Post</strong> , mais le d√©placer vers un autre espace de noms): </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReadPost</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReadModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $table = <span class="hljs-string"><span class="hljs-string">'posts'</span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostQueries</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadPost</span></span></span></span>; }</code> </pre> <br><p>  Ces mod√®les peuvent √™tre en lecture seule et peuvent √™tre mis en cache en toute s√©curit√©. </p><br><p><img src="https://habrastorage.org/webt/ib/eu/wq/ibeuwqyh2aobxpdnlxjy9ypuwqg.png"></p><br><p>  Autre option: abandonner Eloquent.  Il peut y avoir plusieurs raisons √† cela: </p><br><ul><li>  Tous les champs de table ne sont presque jamais n√©cessaires.  Pour la demande <strong>lastPosts</strong> , seuls les champs <strong>id</strong> , <strong>title</strong> et, par exemple, <strong>published_at</strong> sont g√©n√©ralement requis.  Demander quelques textes lourds de publications ne fera que charger inutilement la base de donn√©es ou le cache.  Eloquent ne peut s√©lectionner que les champs obligatoires, mais tout cela est tr√®s implicite.  <strong>Les</strong> clients de <strong>PostQueries</strong> ne savent pas exactement quels champs sont s√©lectionn√©s sans entrer dans l'impl√©mentation. </li><li>  La mise en cache utilise la s√©rialisation par d√©faut.  Les classes √©loquentes prennent trop de place sous forme s√©rialis√©e.  Si pour les entit√©s simples, cela n'est pas particuli√®rement visible, alors pour les entit√©s complexes avec des relations, cela devient un probl√®me (comment faites-vous m√™me glisser des objets d'une taille de m√©gaoctets depuis le cache?).  Sur un projet, une classe ordinaire avec des champs publics dans le cache a pris 10 fois moins d'espace que l'option Eloquent (il y avait beaucoup de petites sous-entit√©s).  Vous ne pouvez mettre en cache des attributs que lors de la mise en cache, mais cela compliquera consid√©rablement le processus. </li></ul><br><p>  Un exemple simple de ce √† quoi cela pourrait ressembler: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostHeader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> int $id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string $title; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime $publishedAt; } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Post</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> int $id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string $title; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string $text; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime $publishedAt; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostQueries</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> PostHeader[] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> PostHeader[] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTopPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> int $userId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> PostHeader[] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userId)</span></span></span></span>; }</code> </pre> <br><p>  Bien s√ªr, tout cela ressemble √† une super-complication sauvage de la logique.  "Prenez les lunettes Eloquent et tout ira bien. Pourquoi trouver tout cela?"  Pour les projets plus simples, c'est correct.  Il n'est absolument pas n√©cessaire de r√©inventer les port√©es.  Mais lorsque le projet est important et que plusieurs d√©veloppeurs sont impliqu√©s dans le d√©veloppement, qui change souvent (ils arr√™tent et de nouveaux arrivent), les r√®gles du jeu deviennent l√©g√®rement diff√©rentes.  Le code doit √™tre prot√©g√© par √©crit afin que le nouveau d√©veloppeur apr√®s quelques ann√©es ne puisse pas faire quelque chose de mal.  Bien s√ªr, il est impossible d'exclure compl√®tement une telle probabilit√©, mais sa probabilit√© doit √™tre r√©duite.  De plus, il s'agit d'une d√©composition syst√®me courante.  Vous pouvez collecter tous les d√©corateurs et classes de mise en cache pour invalider le cache dans un certain "module de mise en cache", √©conomisant ainsi le reste de l'application des informations sur la mise en cache.  J'ai d√ª fouiller dans de grandes demandes entour√©es d'appels de cache.  Cela fait obstacle.  Surtout si la logique de mise en cache n'est pas aussi simple que celle d√©crite ci-dessus. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr445452/">https://habr.com/ru/post/fr445452/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr445440/index.html">Revue de code: mauvais conseils pour le contributeur et le r√©viseur</a></li>
<li><a href="../fr445444/index.html">Mise √† jour des modules solaires haute performance de REC et Trina (solaire)</a></li>
<li><a href="../fr445446/index.html">Comment nous avons utilis√© la r√©plication diff√©r√©e pour la reprise apr√®s sinistre avec PostgreSQL</a></li>
<li><a href="../fr445448/index.html">Configuration de la r√©ception automatique des certificats Letsencrypt √† l'aide de Docker sous Linux</a></li>
<li><a href="../fr445450/index.html">Extension de navigateur pour toster.ru</a></li>
<li><a href="../fr445454/index.html">Afficheur braille Raspberry Pi Zero Inside Handy Tech Active Star 40</a></li>
<li><a href="../fr445456/index.html">Recherche √† 1 To / s</a></li>
<li><a href="../fr445458/index.html">Electronic Arts traitera avec 350 employ√©s et ¬´r√©duira sa pr√©sence¬ª en Russie</a></li>
<li><a href="../fr445460/index.html">Interactivit√© sans gadget</a></li>
<li><a href="../fr445464/index.html">Diminution de la taille de l'√©chantillon des donn√©es exp√©rimentales sans perte d'informations</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>