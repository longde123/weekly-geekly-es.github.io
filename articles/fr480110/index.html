<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶ñ üßëüèª‚Äçü§ù‚Äçüßëüèª üõÇ uMCPIno: √âcriture d'un protocole simple avec livraison garantie pour Arduino üë®üèø‚Äçüç≥ üßëüèΩ‚Äçü§ù‚Äçüßëüèª üë©üèº‚Äçü§ù‚Äçüë®üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salutations, chers amis! 
 √Ä un certain stade de leur vie, chaque bo√Æte de bricolage tenace et tenace cesse de manquer le Kantian Arduino en tant que ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>uMCPIno: √âcriture d'un protocole simple avec livraison garantie pour Arduino</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480110/"><h3>  Salutations, chers amis! </h3><br>  √Ä un certain stade de leur vie, chaque bo√Æte de bricolage tenace et tenace cesse de manquer le Kantian Arduino en tant que ¬´choses en soi¬ª <s>qu'ils ne peuvent tout simplement pas!</s>  : Faire clignoter la LED, prendre les donn√©es des capteurs et les transf√©rer sur le fil vers le PC est certes amusant, mais le Saint Graal est en mobilit√©, en lib√©ration des ¬´liens de cuivre¬ª, en v√©ritable libert√© parmi les vagues d'√©ther universel. <br>  C'est l√† que la dure r√©alit√© des canaux de communication instables, des erreurs de transmission, des messages non livr√©s s'ouvre pour nous. <br>  Dieu ne plaise √† revendiquer l'originalit√© dans ce domaine: l'humanit√© a longtemps utilis√© tout un tas de protocoles pour toutes les occasions. <br>  Mais notre objectif est d'apprendre, et comme je suis un ardent partisan de la reconnaissance au combat, nous √©tudierons en inventant notre propre protocole ¬´v√©lo¬ª. <br>  Aujourd'hui, je propose de d√©velopper un protocole qui garantit la livraison, l'int√©grit√© et la s√©quence des messages entre deux abonn√©s (point √† point, point √† point), sache comment et applique l'algorithme <a href="https://en.wikipedia.org/wiki/Nagle%2527s_algorithm" rel="nofollow">Nagle</a> et le <a href="https://en.wikipedia.org/wiki/Protocol_pipelining" rel="nofollow">pipelining du protocole</a> , quoi que cela signifie.  Dans le m√™me temps, il devrait avoir une <a href="https://en.wikipedia.org/wiki/Overhead_(computing)" rel="nofollow">surcharge</a> minimale et se faufiler jusque dans l'Arduino UNO exigu. <br><br><img src="https://habrastorage.org/webt/jt/7a/_b/jt7a_bc6uynr5uu08ab3plyuucq.png"><br><br>  Je demande √† tous ceux qui sont int√©ress√©s √† bord, on ferme les √©coutilles, on ouvre les pierres de taille, on remplit les ballasts.  Nous avons une excursion dans le pass√©, destination: ann√©e 1974! <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Pour les impatients (je le suis moi-m√™me!)</b> <div class="spoiler_text">  Voici le r√©f√©rentiel github o√π les impl√©mentations sont: <br><ul><li>  <a href="https://github.com/AlekUnderwater/uMCPIno/tree/master/Arduino" rel="nofollow">Pour Arduino</a> </li><li>  <a href="https://github.com/AlekUnderwater/uMCPIno/tree/master/STM32" rel="nofollow">Pour STM32</a> </li><li>  <a href="https://github.com/AlekUnderwater/uMCPIno/tree/master/CSharp" rel="nofollow">Pour PC (C #)</a> </li></ul><br></div></div><br>  Selon la bonne vieille tradition, au moins deux experts reconnus dans ce domaine sont impliqu√©s dans la description des algorithmes et protocoles cryptographiques, si quelqu'un d'autre ne les conna√Æt pas, faites connaissance: <br><div class="spoiler">  <b class="spoiler_title">Alice</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/fb4/6f4/f08/fb46f4f081e1affbfba68c39dcbc7768.jpg" alt="image"><br></div></div><br>  Et <br><div class="spoiler">  <b class="spoiler_title">Bob</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/048/a75/668/048a75668215c8147df3f5720f283899.jpg" alt="image"><br></div></div><br><br><h3>  Nous d√©crivons d'abord une t√¢che simple </h3><br>  Alice et Bob sont assis dans des tranch√©es adjacentes et ne peuvent pas lever la t√™te pour se voir.  Ils ne peuvent parler que par la voix, √† c√¥t√© d'eux des balles sifflent et des obus √©clatent, noyant leurs cris, et en plus, quand l'un d'eux parle, vous devez crier pour ne rien entendre du tout. <br>  La situation est compliqu√©e par le fait qu'ils sont entendus par des ennemis - et vous devez utiliser un langage de code, pour une raison quelconque compos√© de longues s√©quences de nombres. <br>  √âtant donn√© qu'Alice et Bob sont des gens, ils doivent p√©riodiquement sortir manger ou aller aux toilettes, et ils sont tellement impatients qu'ils peuvent l'√™tre au moment le plus inopportun! <br><br><h3>  Comment et pourquoi √©tablir une connexion? </h3><br>  Comment organiser un transfert de donn√©es fiable dans une situation aussi d√©primante, alors qu'il semblerait que tout soit simplement vou√© √† l'√©chec? <br><br>  La premi√®re solution qui peut vous venir √† l'esprit est d'utiliser des phrases cod√©es en mots vides pour d√©marrer et terminer le transfert. <br><br>  Eh bien, disons que si Alice veut envoyer un message, alors elle doit crier ¬´Commencer la transmission!¬ª Et attendre que Bob r√©ponde ¬´Commencer la r√©ception!¬ª. <br>  Si Alice n'attend pas la r√©ponse de Bob, elle r√©p√®te simplement sa demande pour commencer le transfert.  Naturellement, vous ne devriez pas le faire trop souvent, sinon, comme nous le savons, vous n‚Äôentendez simplement pas la r√©ponse de Bob. <br><br>  Super.  Mais que se passe-t-il si Alice en r√©ponse entend de la prochaine tranch√©e, "Commencer la transmission!"? <br>  Il s'av√®re que Bob a √©galement d√©cid√© de transf√©rer des informations importantes d√®s maintenant.  Alice a un caract√®re doux, et elle aurait pu penser: "D'accord, je vais attendre, mon message n'est, en principe, pas urgent, laissez Bob le transmettre en premier."  Pensant √† cela, elle r√©pond: "Commencez la r√©ception!". <br><br>  Comme <s>en temps de guerre, la valeur du sinus peut atteindre quatre, la</s> vitesse du son est finie, et il faut un certain temps pour comprendre ce qu'Alice et Bob ont entendu, et m√™me Bob, en tant que gentleman, peut d√©cider de c√©der √† la dame, il hausse les √©paules et crie ¬´Je commence √† recevoir!¬ª ... <br><br>  Pour illustrer l'indignation, nous utiliserons des chronogrammes.  Le temps leur revient. <br><br>  Le cas o√π Alice et Bob n'√©taient pas d'accord sur le temps: <br><img src="https://habrastorage.org/webt/cz/ye/hn/czyehnoehw9e3wnxveaiwvef5ok.png"><br><br>  Le cas o√π le message a √©t√© perdu: <br><img src="https://habrastorage.org/webt/5u/yk/md/5uykmdq7sxiagt-5twd3uhpnxas.png"><br><br>  Ceci est un fiasco.  Tout devient trop confus et est aggrav√© par le fait que le destinataire peut entendre ou ne pas entendre l'une des phrases, et dans chaque cas, l'interlocuteur ne sait pas si son message a √©t√© entendu par le destinataire. <br><br>  Maintenant, Alice et Bob attendent un accueil.  Il serait logique de r√©aliser qu'un conflit s'est produit et que quelqu'un doit reprendre la transmission.  Mais que se passe-t-il si tout se reproduit d'une nouvelle mani√®re?  Et nous voici √† nouveau l√† o√π nous avons commenc√©. <br><br>  Si vous pensez que la situation est extr√™mement rare, rappelez-vous la derni√®re fois que vous avez parl√© √† quelqu'un via la voix, lorsque votre abonn√© ou vous (ou les deux) avez une connexion Internet lente.  "Bonjour bonjour bonjour, tu disparais."  "Tu n'entends pas bonjour bonjour." <br><br>  Pendant ce temps, dans les tranch√©es, la situation se r√©chauffe, les commandants demandent la transmission des rapports. <br>  Il est temps <s>de se tourner vers les sources primaires: pour √©tudier Marx, Engels</s> reviendra il y a plus de 40 ans et verra comment ces probl√®mes ont √©t√© r√©solus par <a href="https://en.wikipedia.org/wiki/Digital_Equipment_Corporation" rel="nofollow">les</a> ing√©nieurs <a href="https://en.wikipedia.org/wiki/Digital_Equipment_Corporation" rel="nofollow">DEC</a> lors de la conception du protocole <a href="https://en.wikipedia.org/wiki/Digital_Data_Communications_Message_Protocol" rel="nofollow">DDCMP</a> . <br><br>  Selon les d√©veloppeurs de DDCMP, Alice et Bob doivent rejeter les √©motions et devenir comme <a href="https://en.wikipedia.org/wiki/Finite-state_machine" rel="nofollow">des machines √† √©tats finis</a> . <br>  Cela signifie qu'√† partir de maintenant, nos Alice et Bob n'auront que quelques √©tats fixes, les transitions entre ces √©tats peuvent se produire strictement selon certaines r√®gles lorsque certains √©v√©nements se produisent. <br><br>  Tout d'abord, nous listons simplement les √©tats: <br><br><ul><li>  Arr√™t√© </li><li>  D√âBUT INITIAL </li><li>  D√âMARRAGE RECONNU </li><li>  COURIR </li></ul><br><br>  Comme vous pouvez le voir, il n'y en a que quatre.  Et maintenant, quoi qu'il arrive, chacun des abonn√©s sait au moins avec certitude que son vis-√†-vis est dans un seul de ces √©tats.  En fait, en regardant un peu plus loin, je dirai que presque toujours un abonn√© saura dans quel √©tat se trouve le deuxi√®me abonn√©, <s>mais ce n'est pas exact</s> . <br><br><h3>  Examinons les √©tats s√©par√©ment, en d√©tail </h3><br>  <b>HALTED</b> est l'√©tat le plus simple, personne ne va nulle part, tout le monde reste √† sa place, rien n'est transmis et non re√ßu, les stimuli externes sont ignor√©s.  Tous sauf un - la volont√© des autorit√©s sup√©rieures.  Dans le protocole DDCMP d'origine, la transition de l'√©tat <b>HALTED</b> ne peut √™tre dans l'√©tat <b>INITIAL START</b> qu'√† la demande de l'utilisateur - Alice ou Bob re√ßoivent une commande pour √©tablir une connexion. <br><br>  Que se passe-t-il lorsque Alice ou Bob re√ßoivent une telle commande? <br>  Ils constatent imm√©diatement que l'√âtat est pass√© de <b>HALTED</b> √† <b>INITIAL START</b> , cette transition, comme toute autre, implique une s√©quence d'actions strictement d√©finie.  Dans ce cas, vous devez crier "DO IT!" Et r√©gler l'horloge sur l'horloge.  C‚Äôest tout. <br><br>  Alors Alice a cri√© ce qu'on attendait d'elle et a appuy√© sur un bouton du chronom√®tre.  Maintenant, pour comprendre √† quoi s'attendre de Bob, nous allons d√©couvrir ce qui peut arriver √† Alice lorsqu'elle est √† l'√©tat <b>D√âBUT INITIAL</b> . <br><br>  - √Ä partir du moment o√π Alice a remarqu√© que le temps s'est √©coul√©, disons 10 secondes et qu'elle n'a entendu aucune r√©action de Bob (remarque, je ne dis pas que Bob ne lui a rien cri√© - cela n'est pas connu, mais seulement qu'Alice ne sait rien entendu pendant ce temps, Alice est une femme sage et rationnelle et se fie uniquement aux faits).  Nous appelons cet √©v√©nement un d√©lai d'attente - l'intervalle d'attente a √©t√© d√©pass√©.  Dans ce cas, le protocole nous dit de r√©p√©ter: criez ¬´FAITES-LE UNE FOIS!¬ª Et recommencez.  Pas encore √©pais. <br><br>  - Si Alice a entendu que Bob a cri√© la m√™me chose - "FAIRE UNE FOIS!", Alice passe alors de <b>mani√®re non s√©lective</b> √† l'√©tat <b>DE D√âPART RECONNU</b> , √† propos duquel elle devrait imm√©diatement crier "FAIRE DEUX!" Et r√©gler √† nouveau l'horloge. <br><br>  - Encore une fois, si Alice a entendu parler de Bob "FAITES DEUX!", Alors elle passe imm√©diatement √† l'√©tat <b>EN COURS</b> (!), Crie "ACCEPT√â NOOOOOL!".  Si son chronom√®tre a √©t√© d√©marr√©, elle l'√©teint par prudence. <br><br>  Il est tr√®s important de ne pas faire de mouvements inutiles qui ne sont pas pr√©vus par l'√©tat actuel.  Quoi que Bob pleure, peu importe comment maudire ou mendier, Alice ne r√©agit que comme convenu. <br><br>  Il est commode de pr√©senter de telles choses sous la forme d'un tableau.  Commen√ßons donc par les <b>√©tats HALTED</b> et <b>INITIAL START</b> d√©j√† d√©crits, puis nous r√©approvisionnerons davantage le tableau. <br><br><div class="scrollable-table"><table><tbody><tr><th>  √âTAT ACTUEL </th><th>  √âV√âNEMENT <br></th><th>  NOUVELLE CONDITION </th><th>  ACTION <br></th></tr><tr><td>  N'IMPORTE QUI </td><td>  L'ordre "rompre la connexion" </td><td>  Arr√™t√© <br></td><td></td></tr><tr><td>  Arr√™t√© <br></td><td>  Commandez ¬´Connect¬ª <br></td><td>  √âTAT INITIAL </td><td>  1) Criez ¬´FAITES-LE UNE FOIS!¬ª <br>  2) D√©marrer la minuterie <br></td></tr><tr><td rowspan="3">  D√âBUT INITIAL <br></td><td>  J'ai entendu "FAITES-LE UNE FOIS!" <br></td><td>  D√âMARRAGE RECONNU <br></td><td>  1) Criez "FAITES DEUX!" <br>  2) D√©marrer la minuterie <br></td></tr><tr><td>  J'ai entendu "FAIRE DEUX!" </td><td>  COURIR <br></td><td>  1) Criez ¬´NOOOL ACCEPT√â!¬ª <br>  2) Arr√™tez la minuterie <br></td></tr><tr><td>  Le temps est √©coul√© - timeout </td><td>  D√âBUT INITIAL <br></td><td>  1) Criez ¬´FAITES-LE UNE FOIS!¬ª <br>  2) D√©marrer la minuterie <br></td></tr></tbody></table></div><br><br>  J'omet consciemment certains points de la description originale du DDCMP - nous n'en avons pas besoin, nous voulons non seulement r√©p√©ter le DDCMP, mais construire sur sa base <s>le m√™me, seulement un autre</s> nouveau protocole. <br><br>  Mais revenons √† la description des √©tats et des transitions.  Le prochain √©tat est <b>ACKNOWLEDGED START</b> . <br>  Dans cet √©tat, tout ce qui peut inqui√©ter Alice ou Bob est: <br><br>  - comme avant, l'expiration du temps d'attente, dans ce cas, vous devez rester dans le m√™me √©tat, crier "FAITES DEUX!" Et red√©marrez le chronom√®tre <br><br>  - le ¬´DO TWO!¬ª entendu se traduit par l'√©tat <b>RUNNING</b> , tout en criant ¬´ACCEPTED NOOOOL!¬ª Et arr√™te le chronom√®tre; <br><br>  - le "DO IT!" entendu laisse dans le m√™me √©tat, vous devez crier "DO TWO!" Et d√©marrer le chronom√®tre; <br><br>  - entendu ¬´NOOOL ACCEPTED!¬ª - transition vers l'√©tat <b>RUNNING</b> , arr√™tez la minuterie. <br><br>  Nous avons mis tout ce qui pr√©c√®de dans un tableau. <br><div class="scrollable-table"><table><tbody><tr><th>  √âTAT ACTUEL </th><th>  √âV√âNEMENT <br></th><th>  NOUVELLE CONDITION </th><th>  ACTION <br></th></tr><tr><td rowspan="4">  D√âMARRAGE RECONNU <br></td><td>  J'ai entendu "FAITES-LE UNE FOIS!" <br></td><td>  D√âMARRAGE RECONNU <br></td><td>  1) Criez "FAITES DEUX!" <br>  2) D√©marrer la minuterie <br></td></tr><tr><td>  J'ai entendu "FAIRE DEUX!" </td><td>  COURIR <br></td><td>  1) Criez ¬´NOOOL ACCEPT√â!¬ª <br>  2) Arr√™tez la minuterie <br></td></tr><tr><td>  J'ai entendu "NOOOL ACCEPT√â!" </td><td>  COURIR <br></td><td>  1) Arr√™tez la minuterie <br></td></tr><tr><td>  Le temps est √©coul√© - timeout </td><td>  D√âMARRAGE RECONNU </td><td>  1) Criez "FAITES DEUX!" <br>  2) D√©marrer la minuterie <br></td></tr></tbody></table></div><br><br>  Avec une poign√©e de main, presque tout est pr√™t - il ne reste √† consid√©rer qu'un seul √©tat <b>RUNNING</b> , car l'un des abonn√©s peut d√©j√† y entrer, et le second - se pr√©cipiter imm√©diatement aux toilettes, et quand il revient, oubliez tout et essayez d'√©tablir une nouvelle connexion. <br><br>  Du point de vue de la proc√©dure de prise de contact (nous ne traitons pas encore du transfert de donn√©es, pour lequel tout a commenc√© - c'est une histoire distincte) dans l'√©tat <b>RUNNING</b> , nous sommes int√©ress√©s par deux √©v√©nements: <br><br>  - s‚Äôils nous crient "FAITES-LE UNE FOIS!" - tout va tr√®s mal, c‚Äôest une d√©synchronisation compl√®te, il faut tout recommencer.  Le protocole d'origine vous <b>demande d'</b> entrer simplement l'√©tat <b>HALTED</b> .  Mais cela ne nous aidera en rien - si pour une raison quelconque, cela s'est produit sur un Arduino autonome, qui transmet certaines donn√©es de certains capteurs, alors pour nous, c'est un √©chec complet.  Comme nous le savons, √† partir de <b>HALTED,</b> vous ne pouvez acc√©der √† <b>INITIAL START</b> que sur ordre des autorit√©s. <br>  Par cons√©quent, nous <b>modifions</b> le protocole ici: la r√©ception √† l'√©tat <b>HALTED</b> de la commande "DO ONCE!" <b>Devrait</b> fonctionner comme un ordre des autorit√©s - c'est-√†-dire  <b>passer √† l'</b> √©tat <b>D√âMARRAGE INITIAL</b> , crier ¬´FAITES-LE UNE FOIS!¬ª, d√©marrez la minuterie.  De plus, dans certains cas, il est pratique de donner un ordre pour √©tablir la communication imm√©diatement apr√®s vous √™tre aliment√©. <br>  Ainsi, maintenant, dans le cas le plus g√™nant, nous allons simplement r√©initialiser la connexion. <br><br>  - le deuxi√®me √©v√©nement auquel il faut r√©agir √† l'√©tat <b>COURANT</b> - si nous entendons ¬´FAIRE DEUX!¬ª D'une tranch√©e voisine.  C'est d√©j√† plus int√©ressant.  Dans ce cas, vous devez crier ¬´ER ACCEPT√â!¬ª O√π, par ER, on entend le nombre de messages re√ßus avec succ√®s dans la session de communication en cours.  Ceci est un nouveau concept.  Ci-dessous, nous examinerons tout plus en d√©tail, mais pour le moment, nous allons mettre tout ce que nous avons appris √† l'heure actuelle dans un tableau: <br><br><div class="scrollable-table"><table><tbody><tr><th>  √âTAT ACTUEL </th><th>  √âV√âNEMENT <br></th><th>  NOUVELLE CONDITION </th><th>  ACTION <br></th></tr><tr><td rowspan="4">  D√âMARRAGE RECONNU <br></td><td>  J'ai entendu "FAITES-LE UNE FOIS!" <br></td><td>  D√âMARRAGE RECONNU <br></td><td>  1) Criez "FAITES DEUX!" <br>  2) D√©marrer la minuterie <br></td></tr><tr><td>  J'ai entendu "FAIRE DEUX!" </td><td>  COURIR <br></td><td>  1) Criez ¬´NOOOL ACCEPT√â!¬ª <br>  2) Arr√™tez la minuterie <br></td></tr><tr><td>  J'ai entendu "NOOOL ACCEPT√â!" </td><td>  COURIR <br></td><td>  1) Arr√™tez la minuterie <br></td></tr><tr><td>  Le temps est √©coul√© - timeout </td><td>  D√âMARRAGE RECONNU </td><td>  1) Criez "FAITES DEUX!" <br>  2) D√©marrer la minuterie <br></td></tr></tbody></table></div><br><br>  Maintenant, si Alice et Bob suivent strictement le protocole, ils n'ont tout simplement pas d'options <s>pour entrer dans</s> quelque chose d' <s>incompr√©hensible</s> , sauf comment √©tablir une connexion, passer conjointement √† l'√©tat <b>RUNNING</b> ou, dans un mauvais cas, essayer de l'√©tablir avant de <s>cliquer sur</s> la victoire. <br><br>  Un lecteur agressif peut essayer de trier toutes les options et arriver √† la conclusion que la s√©rie d'√©tats et de transitions s'av√®re √™tre ferm√©e et strictement d√©termin√©e.  Nous (avec l'aide des esprits des ing√©nieurs de DEC) avons maintenant li√© Alice et Bob √† un ensemble de r√®gles qui, simplement, apr√®s quoi ils √©tabliront une connexion, si dans les conditions actuelles cela est g√©n√©ralement possible en principe. <br><br><h3>  Comment transf√©rer des donn√©es maintenant? </h3><br>  D'accord, c'√©tait un bon entra√Ænement.  P√©riode de bouquet de bonbons dans la relation de deux n≈ìuds de r√©seau.  Rappelons que nous avons d√©marr√© une entreprise: nous devons transf√©rer des donn√©es avec une livraison garantie et prioritaire!  Avec reprise apr√®s sinistre.  Dans la mesure o√π les ressources mat√©rielles le permettent (apr√®s tout, Alice et Bob peuvent s'av√©rer √™tre de faibles contr√¥leurs 8 bits avec 2 kilo-octets de RAM!). <br><br>  Les ing√©nieurs DEC nous apprennent que les messages dont nous avons besoin pour num√©roter, nous devons compter combien nous avons envoy√©, combien nous avons re√ßu et combien de messages que nous avons envoy√©s ont atteint le destinataire. <br><br><div class="spoiler">  <b class="spoiler_title">Il est temps de faire une digression!</b> <div class="spoiler_text">  Admettez-le.  quand j'ai vu les noms des variables dans la description du protocole DDCMP, j'ai d√©cid√© que ce n'√©tait pas un hasard: les Am√©ricains aiment beaucoup attirer de belles abr√©viations par leurs oreilles. <br><br>  Pour notre commodit√©, il existe m√™me plusieurs ressources o√π les personnes int√©ress√©es peuvent toucher la beaut√©. <br>  Mon pr√©f√©r√© est celui-ci - <a href="https://www.cfa.harvard.edu/~gpetitpas/Links/Astroacro.html" rel="nofollow">Site d'acronymes astronomiques stupides ou trop forc√©s (ou DOOFAAS)</a> <br><br>  Que valent ces fabrications! <br>  Voici un exemple: <br><br>  <b>WASP</b> - Spectrom√®tre analogique √† large bande (mais pas du tout ce que vous pensiez!) <br>  <b>SAURON</b> - Unit√© <b>surfacique</b> spectroscopique pour la recherche sur les n√©buleuses optiques <br>  <b>CISCO</b> - Spectrographe infrarouge refroidi et cam√©ra pour SST (c'est donc ce que cela signifie!) <br><br>  Et ici, il suffit de tirer: <br>  <b>SQUIRT</b> (oh oui, article 18+!) - Satettile QUick Research Testbed <br>  <b>MERDE</b> (Ni plus ni moins!) - T√©lescope interf√©rom√©trique super √©norme, avec l'inscription ¬´regarde par toi-m√™me¬ª, auquel le lien vers le r√©sum√© est attach√© √† l'article du m√™me nom. <br><br>  Ainsi, les variables indiquant le nombre de paquets re√ßus, envoy√©s et livr√©s sur le n≈ìud dans la description originale du protocole sont appel√©es <b>ARN</b> . <br><br>  Ah, pourquoi n'ont-ils pas nomm√© le protocole de cette fa√ßon - l'ARN!  Une sorte de r√©seau d'ARN.  Les protocoles DECnet avaient toutes les chances de devenir des protocoles Internet si l'histoire avait tourn√© diff√©remment. <br></div></div><br><br><h3>  Mais revenons √† nos tranch√©es </h3><br>  La norme de protocole d'origine d√©finit que tous les compteurs sont √† 8 bits et incr√©mentent le module 256. Cela signifie qu'il peut y avoir un maximum de 256 messages envoy√©s pour lesquels aucune confirmation n'a encore √©t√© re√ßue. <br>  Et si la confirmation n'est pas re√ßue, alors ils peuvent avoir besoin d'√™tre retransmis, et si cela peut √™tre requis, alors ils doivent √™tre stock√©s jusqu'√† la confirmation.  Apr√®s tout, nous avons garanti la livraison! <br><br>  Les param√®tres physiques de nos Alice et Bob nous dictent des conditions diff√©rentes.  Dans Arduino 8 bits, cette quantit√© de donn√©es est simplement nulle part o√π stocker et nous devons faire des compromis.  Et je ne parle pas du fait que dans la norme, la longueur des paquets (messages) en octets est limit√©e √† un nombre de 16 bits, c'est-√†-dire  64 kilo-octets est un luxe inadmissible! <br><br><h3>  Ainsi, la connexion est √©tablie.  Et ensuite? </h3><br>  Au moment o√π Alice ou Bob <b>entre dans l'</b> √©tat <b>RUNNING</b> , les compteurs sont r√©initialis√©s. <br>  Comme je l'ai d√©j√† mentionn√©, le protocole d'origine implique la num√©rotation des messages modulo 256, mais nous devons r√©duire ce nombre pour convenir √† la petite quantit√© de m√©moire dans les choses de type Arduino. <br>  Afin de pouvoir imm√©diatement limiter tous les incr√©ments de compteurs, nous allons introduire une certaine constante UMCP_PACKETS_NUMBER, et maintenant tous les incr√©ments se produiront dans ce module. <br><br>  Si vous prenez UMCP_PACKETS_NUMBER = 8 et que la taille maximale des paquets est UMCP_PACKET_DATA_SIZE - les parties des donn√©es transmises √† la fois sont limit√©es √† 64 octets, alors tout ira dans l'Arduino UNO et restera un peu pour les besoins des utilisateurs. <br>  Il est important de se rappeler que ces deux param√®tres doivent √™tre les m√™mes pour les deux parties. <br><br>  De toute √©vidence, maintenant, si Alice et Bob ont r√©ussi √† √©tablir une connexion et que l'un d'eux a besoin de transf√©rer des donn√©es, les donn√©es doivent d'abord √™tre divis√©es en portions ne d√©passant pas 64 octets, et deuxi√®mement, chaque paquet doit √©galement contenir un √©tat deux compteurs d'exp√©diteur: le nombre de messages re√ßus et envoy√©s (R et N). <br><br>  Voyez comme il est maintenant facile d'organiser ce que l'on appelle  pipelining et comment il est facile de g√©rer les situations d'erreur! <br><br>  Si Alice envoie 3 paquets d'affil√©e juste apr√®s l'√©tablissement de la connexion, alors le compteur R sera mis √† 0 √† tous (elle n'a encore re√ßu aucun paquet) et le compteur N augmentera de un √† chaque nouveau paquet. <br><br>  Si Bob les accepte tous avec succ√®s, alors pour confirmer la r√©ception des trois paquets, il lui suffira d'envoyer une confirmation uniquement pour le dernier, en fait, s'il renvoie simplement le statut de ses compteurs R = 3 et N = 0, alors Alice comprendra imm√©diatement que tous les messages envoy√©s ses messages ont atteint le destinataire. <br><br>  C'√©tait un cas id√©al o√π aucun cas de force majeure ne s'√©tait produit.  Voyons maintenant ce qui pourrait mal tourner et comment y faire face. <br><br>  Si pour une raison quelconque, Bob saute le premier paquet et accepte l'un des suivants, il attire imm√©diatement l'attention sur le fait que le compteur N qu'il contient (le nombre de paquets transmis par Alice) d√©passe clairement le compteur R du c√¥t√© de Bob et Bob se rend facilement compte qu'il a rat√© le premier paquet .  Dans ce cas, il a juste besoin de jouer les preuves de capitaine les plus plates et de dire √† Alice l'√©tat de son compteur de paquets re√ßus (R = 0).  Alice comprend en m√™me temps qu'elle est N = 3, et Bob a R = 0, c'est-√†-dire qu'il est n√©cessaire de transf√©rer les paquets d'une nouvelle mani√®re, en commen√ßant par la premi√®re. <br><br>  Si vous examinez attentivement ce sch√©ma, vous pouvez voir que toute transmission du statut de ses compteurs par un abonn√© l'informe imm√©diatement du r√©sultat de la transmission des paquets de donn√©es, et la diff√©rence entre le compteur transmis d'un c√¥t√© et re√ßu de l'autre indique combien de paquets ont √©t√© perdus et de quel nombre il est parti. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est-√†-dire que dans le pire des cas, il y a une retransmission compl√®te de la transmission, dans le cas moyen, le compteur A du c√¥t√© de l'√©metteur augmente √† la valeur du compteur R du c√¥t√© de la r√©ception et "envoie" les paquets perdus. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est facile de comprendre que de cette mani√®re la continuit√© de l'incr√©ment des compteurs est maintenue, ce qui signifie que la transmission des messages (paquets) est garantie. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En plus des variables d'ARN, chaque abonn√© a deux drapeaux SACK et SPEP. Si le premier est install√©, vous devez envoyer une confirmation (Envoyer un accus√© de r√©ception), si le second - alors vous devez envoyer une demande de confirmation (Envoyer REPly √† un message).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soit dit en passant, un autre indicateur a √©t√© impliqu√© dans le DDCMP - SNAK d'origine (accus√© de r√©ception n√©gatif). Son installation implique l'envoi d'un message d'erreur avec une sorte de code. Mais dans notre version du protocole, nous r√©soudrons toutes les erreurs exclusivement √† l'aide du m√©canisme de temporisation, car le protocole peut √™tre utilis√©, par exemple, dans des communications sonar ou radio dans une bande de fr√©quence commune - cela n'a aucun sens de colmater l'environnement commun avec des codes d'erreur. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le message a √©t√© re√ßu avec une erreur d'int√©grit√©, il s'agit √† proprement parler d'un message non accept√©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä ce stade, le lecteur corrosif devrait avoir le sentiment que quelque chose manque. Quelque chose ne va pas avec ce sch√©ma mince.</font></font> Et c'est vrai.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plus d'informations √† ce sujet plus tard. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En attendant, je propose, en suivant l'exemple du processus de configuration de la connexion, de collecter toutes les r√©flexions fragmentaires sur le transfert de donn√©es vers une table. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puisque nous n'avons maintenant qu'un seul √©tat, le tableau ne contiendra que deux colonnes - l'√©v√©nement et les actions √† entreprendre. </font><font style="vertical-align: inherit;">Pour √©viter toute confusion entre ceux √† qui appartiennent les variables, nous marquons les locales avec l'index L et les distantes (celles qui sont contenues dans le message re√ßu avec l'index R).</font></font><br><div class="scrollable-table"><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √âV√âNEMENT </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ACTION </font></font></th></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le paquet de donn√©es est venu NR = RL + 1 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) Arr√™tez le temporisateur </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) Envoyez le paquet √† l'utilisateur </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3) RL = RL + 1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4) Si RR = NL ou AL &lt;= RR &lt;= NL marquez tous </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les paquets transmis avec des nombres de AL √† RR comme </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">confirm√© </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5) AL = RR</font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Une demande de confirmation est arriv√©e - REP </font></font></td><td> 1) SACK = true <br> 2) SREP = false <br></td></tr><tr><td>   ‚Äî ACK </td><td> 1)   <br> 2) SREP = false <br> 3)  RR=NL  AL&lt;=RR&lt;=NL   <br>      AL  RR  <br>  <br> 4) AL=RR <br></td></tr><tr><td>    </td><td> 1) SREP = true </td></tr><tr><td>      SREP </td><td> 1)     REP(RL, NL) <br> 2)   <br></td></tr><tr><td>    AL&lt;NL </td><td> 1)     AL+1 <br> 2)   <br></td></tr><tr><td>  ,   SACK </td><td> 1)   ACK(RL,NL) </td></tr><tr><td>  , AL=NL,  SACK  SREP <br>  ,     <br></td><td> 1) NL=NL+1 <br> 2)     <br></td></tr></tbody></table></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maintenant, regardez bien, faites d√©filer tout le circuit dans la t√™te. Nous r√©alisons ce qui manque ici. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans la description originale de DDCMP, dont nous nous sommes √©loign√©s assez fortement, cela s'appelle l'indicateur SELECT - un n≈ìud (Alice ou Bob) peut ou non √™tre ¬´choisi¬ª. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce qui nous a d√©rout√©s, c'est qu'aucun m√©canisme n'√©tait autoris√© √† autoriser ou √† interdire le transfert. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eh bien, le voici: c'est le drapeau SELECT. Il est appliqu√© tr√®s simplement: si le drapeau est positionn√©, alors il est possible de transmettre, sinon, c'est impossible.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tous les messages de contr√¥le tels que ACK et REP doivent contenir cet indicateur. </font><font style="vertical-align: inherit;">Le dernier paquet de la file d'attente doit √©galement contenir cet indicateur. </font><font style="vertical-align: inherit;">Si un n≈ìud ¬´coud¬ª un drapeau dans un paquet, il le ¬´donne¬ª et, par cons√©quent, il n'est plus install√©. </font><font style="vertical-align: inherit;">Le n≈ìud qui d√©tecte cet indicateur dans le package, au contraire, doit l'installer seul. </font><font style="vertical-align: inherit;">Cela revient √† passer un b√¢ton ou √† jouer une viande hach√©e (rappelez-vous cela?). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La chose la plus importante dans l'utilisation de cet indicateur est que l'un des n≈ìuds doit avoir cet indicateur par d√©faut, et l'autre non. </font><font style="vertical-align: inherit;">C'est un autre temporisateur tr√®s important - le temporisateur de retour du drapeau SELECT. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons maintenant un ensemble complet de r√®gles pour √©tablir une connexion et transmettre des donn√©es par-dessus. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous n'avons pas abord√© uniquement la mise en ≈ìuvre concr√®te de cet ensemble de r√®gles. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eh bien, corrigez-le!</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Formation et format du package </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est ce qu'on appelle le cadrage des messages - les r√®gles d'analyse et de g√©n√©ration des messages et le format. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculons combien nous avons besoin. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Au minimum, nous avons besoin que chaque message contienne l'√©tat des compteurs R et N de l'exp√©diteur. </font><font style="vertical-align: inherit;">Pour Arduino, nous avons convenu que nous pouvons avoir un maximum de 8 messages envoy√©s mais non confirm√©s. </font><font style="vertical-align: inherit;">Mais puisque nous transf√©rons des octets, nous poussons les deux compteurs dans un octet, qu'ils soient de 4 bits. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cet octet sera form√© comme ceci:</font></font><br><pre><code class="cpp hljs"> = (RL &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>) | (NL &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>);</code> </pre> <br>  Et nous lirons le statut des compteurs comme ceci: <br><pre> <code class="cpp hljs">NR = (c &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>; RR = c &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>;</code> </pre> <br>  c - octet correspondant du message <br><br>  2. Nous rappelons √©galement que chaque message doit contenir l'√©tat de l'indicateur SELECT.  Et les diff√©rents types de messages eux-m√™mes seront: <br><div class="scrollable-table"><table><tbody><tr><th>  Nom dr√¥le <br></th><th>  Nom s√©rieux <br></th><th>  La description <br></th><th>  Valeur de l'indicateur SELECT <br></th><th>  Valeur PTYPE </th></tr><tr><td>  "FAITES-LE UNE FOIS!" <br></td><td>  STR <br></td><td>  STaRt <br></td><td>  vrai </td><td>  40 <br></td></tr><tr><td>  "FAITES DEUX!" <br></td><td>  STA <br></td><td>  STart acquitt√© </td><td>  vrai </td><td>  36 </td></tr><tr><td>  "NOOL ACCEPT√â!" <br></td><td>  ACK (NL = 0, RL = 0) <br></td><td>  Reconnaissance <br></td><td>  vrai </td><td>  33 <br></td></tr><tr><td>  "ACCEPT√â PAR ER, ENVOY√â PAR EN" </td><td>  ACK (NL, RL) </td><td>  Reconnaissance </td><td>  vrai </td><td>  33 </td></tr><tr><td>  "CONFIRMER COMMENT JE COMPRENDS?" <br></td><td>  REP (NL, RL) <br></td><td>  REPly √† un message </td><td>  vrai </td><td>  34 </td></tr><tr><td>  "PAQUET DE DONN√âES" <br></td><td>  DTA (NL, RL) <br></td><td>  Paquet de donn√©es </td><td>  faux </td><td>  17 </td></tr><tr><td>  FORFAIT DE DONN√âES EXTR√äMES <br></td><td>  DTE (NL, RL) </td><td>  Paquet DaTa - Fin </td><td>  vrai </td><td>  49 </td></tr></tbody></table></div><br><br>  Autrement dit, seulement 6 types de messages diff√©rents.  Tous les messages sauf DTA "lib√®rent" l'indicateur SELECT - ils ont besoin d'une r√©ponse imm√©diate de l'abonn√© distant et sans l'indicateur, il ne pourra pas le transmettre.  Le message DTA ne renvoie pas d'indicateur pour rendre le pipelining possible. <br><br>  En g√©n√©ral, nous avons suffisamment de 3 bits pour le type de message, mais afin de ne pas jouer avec les bits, nous attribuons un octet entier au type - en cas de r√©vision, nous aurons une certaine libert√© d'action. <br><br>  Si le message contient des donn√©es, nous devons transf√©rer leur quantit√© et leur somme de contr√¥le.  √âtant donn√© que la taille maximale des paquets est de 64 octets, nous prendrons √©galement un octet pour la somme de contr√¥le et pour la longueur - tout √† coup, vous devrez augmenter la taille des paquets. <br><br>  3. Nous avons √©galement besoin d'une signature du d√©but du message et d'une somme de contr√¥le distincte pour l'en-t√™te. <br><br>  Avec tout cela √† l'esprit, l'en-t√™te (alias messages de contr√¥le) ressemble √† ceci: <br><div class="scrollable-table"><table><tbody><tr><th>  D√©calage, octet <br></th><th>  La description </th><th>  Taille, peu </th></tr><tr><td>  0 </td><td>  SIGN = 0xAD <br></td><td>  8 </td></tr><tr><td>  1 </td><td>  PTYPE </td><td>  8 </td></tr><tr><td>  2 </td><td>  TCNT </td><td>  4 <br></td></tr><tr><td>  2 </td><td>  RCNT </td><td>  4 </td></tr><tr><td>  3 </td><td>  Hchk </td><td>  8 </td></tr></tbody></table></div><br><br>  Et le bloc de donn√©es est comme ceci: <br><div class="scrollable-table"><table><tbody><tr><th>  D√©calage, octet <br></th><th>  La description </th><th>  Taille, peu </th></tr><tr><td>  4 </td><td>  DCNT <br></td><td>  8 </td></tr><tr><td>  5..5 + DCNT-1 <br></td><td>  DONN√âES <br></td><td>  8 * DCNT </td></tr><tr><td>  5 + DCNT </td><td>  Dchk </td><td>  8 </td></tr></tbody></table></div><br><br>  C'est tout.  Ceci est une description compl√®te du protocole que nous avons obtenu de DDCMP. <br>  Vous pouvez maintenant passer par l'impl√©mentation. <br><br><h3>  Comment est-il organis√© et comment l'utiliser? </h3><br>  Tout d'abord, un peu sur la structure du r√©f√©rentiel. <br>  Comme je l'ai mentionn√© au d√©but, le code du projet se trouve sur le github: <a href="https://github.com/AlekUnderwater/uMCPIno" rel="nofollow">uMCPIno</a> <br><br>  Afin de voir comment tout fonctionne, vous pouvez ex√©cuter une <a href="" rel="nofollow">application de test</a> sur un PC. <br><br>  Dans l'archive, ex√©cutez uMCPIno_Test.exe, s√©lectionnez le port COM souhait√© et essayez son fonctionnement. <br>  Vous pouvez v√©rifier une paire de ports COM virtuels (je fais g√©n√©ralement cela). <br>  Pourquoi vous pouvez ex√©cuter deux copies de l'application.  N'oubliez pas d'activer ¬´SELECTED BY DEFAULT¬ª dans une copie - ce sera Master, et dans l'autre - d√©sactivez-le.  Au fait, si vous √™tes int√©ress√©, vous pouvez voir ce qui se passe si vous ne respectez pas cette r√®gle =) <br><br>  L'option EXTRAS vous permet de voir tous les mouvements de pens√©es √† l'int√©rieur du cerveau du protocole.  Tous les changements dans l'√©tat des drapeaux SELECT, les √©v√©nements des temporisateurs, les changements dans l'√©tat du n≈ìud, ainsi que les valeurs des variables R et N dans les messages transmis et re√ßus seront affich√©s. <br><br>  Je connecte mon Arduino UNO √† mon ordinateur portable via un convertisseur USB UART &lt;-&gt;.  Les connecteurs √† broches vous permettent de simuler un saut de ligne √† tout moment: <br><img src="https://habrastorage.org/webt/nn/vg/kp/nnvgkplqtoqbazpubopcb8bff-g.jpeg"><br><br>  Si vous ex√©cutez maintenant l'application sur l'ordinateur portable, apr√®s avoir appuy√© sur le bouton "CONNECTER", l'arduina √©tablira une connexion: <br><img src="https://habrastorage.org/webt/cy/jm/lx/cyjmlxn_ga-_zvrzel5yjmfwdz4.png"><br><br>  Et voici comment le syst√®me r√©agit √† une tentative d'envoi via une ligne ¬´d√©chir√©e¬ª: <br><img src="https://habrastorage.org/webt/lu/kb/dw/lukbdwxot1xuopxjdqxgpq1xqsq.png"><br><br>  Pour int√©grer uMCPIno dans votre application pour PC: <br><ol><li>  Le r√©f√©rentiel poss√®de une biblioth√®que uMCPIno.  Connectez-le aux r√©f√©rences de votre projet </li><li>  Il contient la classe uMCPInoPort.  Nous d√©clarons son instance: <br><pre> <code class="cs hljs">uMCPInoPort port; port = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> uMCPInoPort(<span class="hljs-string"><span class="hljs-string">"COM1"</span></span>, UCNLDrivers.BaudRate.baudRate9600, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-number"><span class="hljs-number">8100</span></span>, <span class="hljs-number"><span class="hljs-number">2000</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>);</code> </pre><br>  Param√®tres dans l'ordre: nom du port, puis vitesse du port, √©tat SELECT par d√©faut, intervalle pour SELECT, intervalle de temporisation, taille du paquet et nombre maximal de messages non acquitt√©s. <br></li><li>  Abonnez-vous aux √©v√©nements: <br>  lorsque l'indicateur SELECT - port.Select change: <br><pre> <code class="cs hljs">OnSelectChangedEventHandler</code> </pre> <br>  lorsque l'√©tat change - port.√âtat: <br><pre> <code class="cs hljs">OnStateChangedEventHandler</code> </pre> <br>  L'h√¥te distant confirme la r√©ception du code: <br><pre> <code class="cs hljs">OnDataBlockAcknowledgedEventHandler</code> </pre> <br>  quand arrive le paquet de donn√©es: <br><pre> <code class="cs hljs">OnDataBlockReceivedEventHandler</code> </pre> <br></li><li>  Avant de travailler, ouvrez le port <br><pre> <code class="cs hljs">port.Open();</code> </pre> <br></li><li>  Pour envoyer des donn√©es, nous appelons la m√©thode: <pre> <code class="cs hljs">port.Send(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data);</code> </pre> <br></li><li>  Une fois l'op√©ration termin√©e, fermez le port: <pre> <code class="cs hljs">port.Close();</code> </pre> <br></li></ol><br><br>  Envoyez simplement deux octets! <br><br>  Passons maintenant √† l'impl√©mentation d'Arduino.  Deux exemples se trouvent dans le dossier <a href="https://github.com/AlekUnderwater/uMCPIno/tree/master/Arduino" rel="nofollow">github.com/AlekUnderwater/uMCPIno/tree/master/Arduino</a> <br><br>  <a href="" rel="nofollow">Le premier</a> est juste un convertisseur de et vers uMCP.  Le premier Serial sert √† communiquer avec l'h√¥te, et Serial1 (s'il est sur votre carte) ou SoftwareSerial sur les broches 2 et 3 - pour communiquer avec un autre n≈ìud uMCPIno.  Vous pouvez connecter Bluetooth ou un module radio ici. <br><br>  <a href="" rel="nofollow">Le second</a> est un mod√®le de projet avec prise en charge du protocole uMCPIno <br><br>  Les deux projets ont des param√®tres o√π vous pouvez et devez grimper.  Les voici: <br><br>  L'√©tat par d√©faut de l'indicateur SELECT.  S'il est d√©fini sur (true), m√™me si le n≈ìud distant ne renvoie pas l'indicateur, il sera d√©fini sur true par le temporisateur. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_SELECT_DEFAULT_STATE (false)</span></span></code> </pre> <br><br>  Pour d√©finir la p√©riode de ce temporisateur, il existe le param√®tre suivant: intervalle pour renvoyer l'indicateur SELECT en millisecondes <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_SELECT_DEFAULT_INTERVAL_MS (4000)</span></span></code> </pre> <br><br>  L'intervalle d'attente d'une r√©ponse en millisecondes, il est pr√©f√©rable de le laisser l√©g√®rement inf√©rieur √† l'intervalle de retour de l'indicateur SELECT. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_TIMEOUT_INTERVAL_MS (3000)</span></span></code> </pre> <br><br>  Le d√©bit en bauds r√©el de la ligne.  Ce param√®tre est n√©cessaire pour d√©terminer la fin du transfert. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_LINE_BAUDRATE_BPS (9600)</span></span></code> </pre> <br><br>  Intervalle d'accumulation de donn√©es pour l'algorithme Nagle.  Insolemment, prenez-le √©gal √† 100 millisecondes.  Pendant ce temps, nous attendons un ensemble de paquets, s'il n'est pas tap√©, nous l'envoyons tel quel.  La t√¢che de l'algorithme Nagle est de d√©barrasser le r√©seau d'un tas de petits paquets d'un √† plusieurs octets. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_NAGLE_DELAY_MS (100)</span></span></code> </pre> <br><br>  Ces param√®tres d√©finissent les vitesses de port pour la communication avec le syst√®me de contr√¥le (h√¥te) et la ligne.  Ne confondez pas la vitesse du port avec une ligne avec un taux de transfert physique. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_HOST_CONNECTION_BAUDRATE_BPS (9600) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// Host connection port speed #define CFG_LINE_CONNECTION_BAUDRATE_BPS (9600) // Line connection port speed</span></span></span></span></code> </pre> <br><br>  Si ce param√®tre est activ√©, lorsque le courant est fourni au contr√¥leur, le protocole lui-m√™me se commandera pour commencer √† √©tablir une connexion. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_IS_AUTOSTART_ON_POWERON (true)</span></span></code> </pre> <br><br>  Il s'agit de la taille en octets de la m√©moire tampon pour les paquets de donn√©es entrants. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_IL_RING_SIZE (255)</span></span></code> </pre> <br><br>  Voyons ensuite √† quoi ressemble la boucle d'esquisse principale: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ uMCP_ITimers_Process(); DC_Input_Process(); DC_Output_Process(); <span class="hljs-comment"><span class="hljs-comment">//  ip_ready  ,      if (ip_ready) { uMCP_OnIncomingPacket(); } //        ,     -  if ((state == uMCP_STATE_HALTED) &amp;&amp; ((ih_Cnt &gt; 0) || (isStartup &amp;&amp; CFG_IS_AUTOSTART_ON_POWERON))) { if (isStartup) { isStartup = false; } uMCP_STATE_Set(uMCP_STATE_ISTART); uMCP_CtrlSend(uMCP_PTYPE_STR, 0, 0, true); } else if (state == uMCP_STATE_RUNNING) { uMCP_Protocol_Perform(); //      -   if (il_ready) { il_ready = false; USER_uMCPIno_DataPacketReceived(); } } }</span></span></code> </pre><br><br>  Voyons maintenant comment fonctionne le protocole.  La logique principale est contenue dans la fonction uMCP_Protocol_Perform ();  Voici son code: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uMCP_Protocol_Perform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == uMCP_STATE_RUNNING) { <span class="hljs-comment"><span class="hljs-comment">//              SELECT  if ((!iTimer_State[uMCP_Timer_TX]) &amp;&amp; (!iTimer_State[uMCP_Timer_TMO]) &amp;&amp; (select)) { //     if (ih_Cnt == 0) { //    REP -  if (srep) { uMCP_CtrlSend(uMCP_PTYPE_REP, N, R, true); srep = false; } //     -   else if (sentBlocksCnt &gt; 0) { uMCP_DataBlockResend((A + 1) % UMCP_PACKETS_NUMBER, true, true); } //    SACK  -        //  -       ACK else if ((!selectDefaultState) || (sack)) { uMCP_CtrlSend(uMCP_PTYPE_ACK, N, R, false); sack = false; } } //     -  else if (ih_Cnt &gt; 0) { //              -  if ((ih_Cnt &gt;= UMCP_PACKET_DATA_SIZE) || (millis() &gt;= ih_TS + CFG_NAGLE_DELAY_MS)) { //   N N = (N + 1) % UMCP_PACKETS_NUMBER; uMCP_NextDataBlockSend(); } } } } }</span></span></code> </pre><br><br>  Un analyseur de paquets qui vit dans une fonction <pre> <code class="cpp hljs">On_NewByte_From_Line</code> </pre>  √©galement organis√© selon le principe d'une machine √† √©tats finis et fonctionne "octet par octet".  Ceci est fait afin d'√©conomiser de la m√©moire. <br><br>  Le reste de la mise en ≈ìuvre ne pr√©sente pas d'int√©r√™t particulier.  Nous analyserons mieux la fa√ßon dont l'utilisateur interagit avec le protocole.  Dans cet exemple, il existe quatre ¬´points de contact¬ª. <br><br>  Le premier est la fonction d'envoi de donn√©es sur la ligne uMCPIno: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uMCPIno_SendData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(byte* dataToSend, byte dataSize)</span></span></span></span>;</code> </pre> <br>  Tout est simple ici - vous avez un tampon d'octets dataToSend, sa taille est dataSize.  La fonction renvoie vrai si l'envoi est possible (il y a de la place pour ajouter des donn√©es), et faux sinon. <br>  Afin de ne pas conduire en vain, vous pouvez imm√©diatement v√©rifier la disponibilit√© de suffisamment d'espace en utilisant la fonction: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uMCP_IsCanSend</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(byte dataSize)</span></span></span></span>;</code> </pre> <br><br>  Afin d'analyser les paquets de donn√©es entrants, vous devez ajouter votre code au corps de la fonction <pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">USER_uMCPIno_DataPacketReceived</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre> <br><br>  Les donn√©es entrantes sont √©crites dans le tampon en anneau il_ring.  La lecture peut √™tre organis√©e comme ceci: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (il_Cnt &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { c = il_ring[il_rPos]; il_rPos = (il_rPos + <span class="hljs-number"><span class="hljs-number">1</span></span>) % CFG_IL_RING_SIZE; il_Cnt--; <span class="hljs-comment"><span class="hljs-comment">//   "c" -      }</span></span></code> </pre><br><br>  Pour les plaisirs sophistiqu√©s, il y a une fonction <br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">USER_uMCP_OnTxBufferEmptry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre> <br>  Qui est appel√© lorsque toutes les donn√©es ont √©t√© envoy√©es avec succ√®s.  Il est √©galement possible et n√©cessaire d'y mettre une sorte de code. <br><br><h3>  Pourquoi tout cela et o√π? </h3><br>  Je m'occupais principalement de Just for fun.  De plus, j'avais besoin d'un protocole simple et, surtout, ¬´l√©ger¬ª pour envoyer des donn√©es via nos modems sonar <a href="https://habr.com/ru/post/428367/">uWAVE</a> .  Puisqu'ils transmettent des donn√©es dans l'eau √† une vitesse de seulement 80 bps, et avec leur port√©e de communication maximale de 1000 m√®tres et la vitesse du son dans l'eau d'environ 1500 m / s, la transmission est associ√©e √† des retards notables, et il n'y a qu'un seul canal sonar (sinon le plus !) des plus bruyants, des plus lents et des plus instables. <br>  En grande partie √† cause de cela, j'ai d√ª abandonner le m√©canisme de reconnaissance n√©gative (NAK) - s'il est possible de ne pas transmettre - dans l'eau il vaut mieux ne pas transmettre √† 100%. <br>  En r√©alit√©, le protocole a √©t√© utile lors de la transmission de donn√©es sur un canal radio √† l'aide de modules <a href="http://www.dorji.com/products.php%3FCateId%3D9" rel="nofollow">DORJI</a> et du <a href="https%253A%252F%252Fwww.elecrow.com%252Fdownload%252FHC-12.pdf%26usg%3DAOvVaw2rNtYm7nLdpqPN6HR-LAS8" rel="nofollow">NS-012</a> bien connu des arduinoes. <br><br><h3>  Et ensuite? </h3><br>  S'il reste du temps, je pr√©vois d'ajouter la possibilit√© d'adressage (qui, soit dit en passant, √©tait en DDCMP).  Puisque la t√¢che principale de ce protocole est maintenant de fournir une commodit√© pour toutes sortes de tests de nos modems sonar et d'autres r√©seaux de capteurs, il y a (litt√©ralement!) Des pi√®ges l√†-bas.  Je peux seulement dire que le probl√®me ne peut pas √™tre r√©solu en ajoutant simplement les champs "Sender" et "Target". <br>  Cela viendra peut-√™tre du <a href="https://en.wikipedia.org/wiki/Geographic_routing" rel="nofollow">routage g√©ographique</a> et de tout ce jazz. <br><br><h3>  PS </h3><br>  Traditionnellement, je serai tr√®s reconnaissant des critiques constructives, des souhaits et des suggestions.  Il est toujours important de comprendre si vous faites quelque chose d'utile pour les gens ou si vous perdez du temps. <br>  Peut-√™tre, en essayant d'√©viter la transition de cette longue lecture au roman "Guerre et paix", j'ai manqu√© quelques d√©tails - n'h√©sitez pas √† demander. <br><br><h3>  PPS </h3><br>  Un grand merci √† la honte de mon analphab√©tisme, signalant des erreurs (grammaticales et logiques): <br><ul><li>  <a href="https://habr.com/ru/users/berez/" class="user_link">berez</a> </li><li>  <a href="https://habr.com/ru/users/edo1h/" class="user_link">edo1h</a> </li></ul><br>  Le projet √©tait √† l'origine open source, mais maintenant l'article est √©galement open source. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr480110/">https://habr.com/ru/post/fr480110/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr480100/index.html">D√©butants sur le r√©f√©rencement</a></li>
<li><a href="../fr480102/index.html">Sommaire de novembre sur la gestion des produits</a></li>
<li><a href="../fr480104/index.html">9 astuces HTML utiles</a></li>
<li><a href="../fr480106/index.html">Comment assembler une image Oracle DB pour Testcontainers</a></li>
<li><a href="../fr480108/index.html">La physique dans un projet Unity utilisant le combat mobile comme exemple</a></li>
<li><a href="../fr480112/index.html">Diff√©rences entre C ++ / Visual Basic et Java au niveau g√©n√©ral (pour d√©butants et √©tudiants)</a></li>
<li><a href="../fr480114/index.html">Tout sur les taxes pour les ind√©pendants IT. IE et ind√©pendants. Partie 1</a></li>
<li><a href="../fr480116/index.html">Position du groupe Mail.ru sur le d√©veloppement de l'open source en Russie</a></li>
<li><a href="../fr480118/index.html">Nous √©crivons un simulateur de saisie tactile en utilisant du JavaScript pur. Partie 1</a></li>
<li><a href="../fr480120/index.html">Une nouvelle r√©alisation en cryptographie - Factorisation d'un RSA 795 bits</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>