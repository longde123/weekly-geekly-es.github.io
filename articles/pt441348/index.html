<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ú¥Ô∏è üß° üò§ Roteamento direto e balanceamento com NFT vs Nginx üë©üèΩ‚Äçüíª üì£ üì§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ao desenvolver aplicativos de rede altamente carregados, √© necess√°rio balancear a carga. 

 Uma ferramenta de balanceamento L7 popular √© o Nginx. Perm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Roteamento direto e balanceamento com NFT vs Nginx</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441348/">  Ao desenvolver aplicativos de rede altamente carregados, √© necess√°rio balancear a carga. <br><br>  Uma ferramenta de balanceamento L7 popular √© o Nginx.  Permite armazenar respostas em cache, escolher estrat√©gias diferentes e at√© scripts no LUA. <br><br>  Apesar de todos os encantos do Nginx, se: <br><br><ol><li>  N√£o h√° necessidade de trabalhar com HTTP (s). </li><li>  Voc√™ precisa extrair o m√°ximo da rede. </li><li>  N√£o h√° necessidade de armazenar em cache nada - o balanceador possui servidores de API limpos com din√¢mica. </li></ol><br>  A quest√£o pode surgir: por que voc√™ precisa do Nginx?  Por que gastar recursos equilibrando no L7, n√£o √© mais f√°cil simplesmente encaminhar o pacote SYN?  (Roteamento direto L4). <br><a name="habracut"></a><br><h3>  Balanceamento da camada 4 ou como equilibrar na antiguidade </h3><br>  Uma ferramenta popular de encaminhamento de pacotes era o IPVS.  Ele executou tarefas de balanceamento atrav√©s do t√∫nel e roteamento direto. <br><br>  No primeiro caso, um canal TCP foi estabelecido para cada conex√£o e o pacote do usu√°rio foi para o balanceador, depois para o lacaio e, em seguida, na ordem inversa. <br><br><img src="https://habrastorage.org/webt/cy/so/j6/cysoj6mgraildwjgs1sbwvufpt4.png"><br><br>  Nesse esquema, o principal problema √© vis√≠vel: na dire√ß√£o oposta, os dados v√£o primeiro para o balanceador e depois para o usu√°rio (o Nginx funciona da mesma maneira).  Trabalho desnecess√°rio √© realizado, considerando que geralmente mais dados s√£o enviados ao usu√°rio, esse comportamento leva a alguma perda de desempenho. <br><br>  Essa desvantagem √© privada (mas dotada de novas) de um m√©todo de balanceamento chamado Roteamento Direto.  Esquematicamente, fica assim: <br><br><img src="https://habrastorage.org/webt/hy/9r/5-/hy9r5-brkhgzmjgmotrnnibfta4.png"><br><br>  No caso do roteamento direto, os pacotes de retorno v√£o diretamente para o usu√°rio, ignorando o balanceador.  Obviamente, os recursos do balanceador e a rede s√£o salvos.  Ao economizar recursos de rede, n√£o √© muito poupador de tr√°fego, porque a pr√°tica usual √© conectar os servidores a uma grade separada e n√£o contabilizar o tr√°fego, mas o fato de at√© transferir atrav√©s do balanceador √© uma perda de milissegundos. <br><br>  Este m√©todo imp√µe certas restri√ß√µes: <br><br><ol><li>  O data center em que a infraestrutura est√° localizada deve permitir falsifica√ß√£o de endere√ßos locais.  No diagrama acima, cada subordinado deve enviar pacotes de volta em nome do IP 10.10.0.1, que √© atribu√≠do ao balanceador. </li><li>  O balanceador n√£o sabe nada sobre o estado dos lacaios.  Conseq√ºentemente, as estrat√©gias Least Conn e Least Time n√£o s√£o vi√°veis ‚Äã‚Äãimediatamente.  Em um dos seguintes artigos, tentarei implement√°-los e mostrar o resultado. </li></ol><br><h3>  Aqui Vem NFTables </h3><br>  Alguns anos atr√°s, o Linux come√ßou a promover ativamente o NFTables como um substituto para IPTables, ArpTables, EBTables e todos os outros [az] {1,} Tables.  No momento em que em Adram tivemos a necessidade de extrair cada milissegundo de resposta da rede, decidi retirar o verificador e pesquisar - ou talvez o ipTables tenha aprendido a encaminhar iphash e voc√™ possa aceler√°-lo para equilibr√°-lo.  Ent√£o me deparei com nftables, o que pode e n√£o apenas isso, mas o iptables ainda n√£o pode fazer isso. <br>  Ap√≥s v√°rios dias de teste, finalmente consegui obter o roteamento direto e o roteamento de canais atrav√©s das tabelas NFT no laborat√≥rio de testes e tamb√©m compar√°-los com o nginx. <br><br>  Ent√£o, o laborat√≥rio de teste.  Temos 5 carros: <br><br><ol><li>  nft-router - um roteador que executa a tarefa de conectar o cliente e a sub-rede AppServer.  Possui 2 placas de rede: 192.168.56.254 - analisa a rede do servidor de aplicativos, 192.168.97.254 - analisa os clientes.  Ip_forward est√° ativado e todas as rotas s√£o registradas. </li><li>  nft-client: cliente do qual ab, ip 192.168.97.2 ser√° perseguido </li><li>  nft-balancer: balanceador.  Possui dois IPs: 192.168.56.4, que os clientes acessam e 192.168.13.1, da sub-rede minion. </li><li>  nft-minion-a e nft-minion-b: minions ipy: 192.168.56.2, 192.168.56.3 e 192.168.13.2 e 192.168.13.3 (tentei usar a mesma rede e a outra para equilibrar).  Nos testes, parei com o fato de os lacaios terem tipos "externos" - na sub-rede 192.168.56.0/24 </li></ol><br>  Todas as interfaces MTU 1500. <br><br><h4>  Roteamento direto </h4><br>  Configura√ß√µes de NFTables no balanceador: <br><br><pre><code class="json hljs">table ip raw { chain input { type filter hook prerouting priority -300; policy accept; tcp dport http ip daddr set jhash tcp sport mod 2 map { 0: <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.56</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>, 1: <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.56</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> } } }</code> </pre> <br>  Uma cadeia bruta √© criada, no gancho, com uma prioridade de -300. <br><br>  Se um pacote com um endere√ßo de destino http chegar, dependendo da porta de origem (feita para testar a partir de uma m√°quina, voc√™ realmente precisa de ip saddr), 56.2 ou 56.3 √© selecionado e definido como o endere√ßo de destino no pacote e enviado posteriormente pelas rotas.  Grosso modo, para portas pares 56.2, para portas √≠mpares, respectivamente, 56.3 (de fato, n√£o, porque para hashes pares / √≠mpares, mas √© mais f√°cil entender exatamente isso).  Ap√≥s definir o IP de destino, o pacote volta para a rede.  N√£o ocorre NAT, o pacote chega aos minions com o IP de origem do cliente, e n√£o o balanceador, o que √© importante para o roteamento direto. <br><br>  Configura√ß√µes do Minion NFT: <br><br><pre> <code class="json hljs">table ip raw { chain output { type filter hook output priority -300; policy accept; tcp sport http ip saddr set 192.168.56.4 } }</code> </pre><br>  Um gancho de sa√≠da bruto √© criado com uma prioridade de -300 (prioridade √© muito importante aqui, em n√≠veis mais altos a mengling necess√°ria n√£o funcionar√° para pacotes de resposta). <br><br>  Todo o tr√°fego de sa√≠da da porta http √© assinado por 56,4 (ip balancer) e enviado diretamente ao cliente, ignorando o balancer. <br><br>  Para verificar se tudo funcionar√° corretamente, levei o cliente para outra rede e o deixei passar pelo roteador. <br><br>  Tamb√©m desabilitei arp_filter, rp_filter (para que a falsifica√ß√£o funcionasse) e habilitei o ip_forward no balanceador e no roteador. <br><br>  Para bancos, no caso da NFT, o Nginx + php7.2-FPM √© usado atrav√©s de um soquete unix em cada minion.  N√£o havia nada no balanceador. <br><br>  No caso do Nginx, usamos: nginx no balanceador e php7.2-FPM sobre TCP em minions.  Como resultado, n√£o equilibrei o servidor da Web por tr√°s do balanceador, mas imediatamente o FPM (que ser√° mais honesto com o nginx e mais consistente com a vida real). <br><br>  Para NFT, apenas a estrat√©gia de hash foi usada ( <b>nft dr</b> na tabela), para nginx: hash ( <b>ngx eq</b> ) e menos conn ( <b>ngx lc</b> ) <br><br>  V√°rios testes foram feitos. <br><br><ol><li>  Script r√°pido pequeno <b>(pequeno)</b> . <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> system(<span class="hljs-string"><span class="hljs-string">'hostname'</span></span>);</code> </pre><br></li><li>  O script com um atraso aleat√≥rio <b>(rand)</b> . <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> usleep(mt_rand(<span class="hljs-number"><span class="hljs-number">100000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"ok"</span></span>;</code> </pre></li><li>  Um script com o envio de uma grande quantidade de dados <b>(tamanho)</b> . <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $size=$_GET[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]; $file=<span class="hljs-string"><span class="hljs-string">'/tmp/'</span></span>.$size; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!file_exists($file)) { $dummy=<span class="hljs-string"><span class="hljs-string">""</span></span>; exec (<span class="hljs-string"><span class="hljs-string">"dd if=/dev/urandom of=$file bs=$size count=1 2&gt;&amp;1"</span></span>,$dummy); } fpassthru (fopen($file,<span class="hljs-string"><span class="hljs-string">'rb'</span></span>));</code> </pre><br>  Foram utilizados os seguintes tamanhos: <br>  512.1440.1460.1480.1500.2048.65535.655350 bytes. <br>  Antes dos testes, eu esquentava os arquivos de est√°tica de cada lacaio. <br></li></ol><br>  Testado ab tr√™s vezes cada teste: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash function do_test() { rep=$3 for i in $(seq $rep) do echo "testing $2 # $i" echo "$2 pass $i" &gt;&gt; $2 ab $1 &gt;&gt; $2 echo "--------------------------" &gt;&gt; $2 done } do_test " -n 5000 -c 100 http://192.168.56.4:80/rand.php" "ngx_eq_test_rand" 3 do_test " -n 10000 -c 100 http://192.168.56.4:80/" "ngx_eq_test_small" 3 size=512 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=1440 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=1460 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=1480 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=1500 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=2048 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=65535 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=655350 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3</span></span></code> </pre> <br>  Inicialmente, planejei trazer o tempo do teste, milissegundos e o resto, como resultado, decidi pelo RPS - eles s√£o representativos e se correlacionam com os indicadores de tempo. <br><br>  Obteve os seguintes resultados: <br><br>  Teste de tamanho - colunas - o tamanho dos dados fornecidos. <br><br><img src="https://habrastorage.org/webt/hk/yi/ma/hkyimanxhaoa_7ejz-ehvmecp1s.png"><br><br>  Como voc√™ pode ver, o roteamento direto nft vence por uma margem enorme. <br><br>  Eu estava contando com alguns outros resultados relacionados ao tamanho do quadro Ethernet, mas nenhuma correla√ß√£o foi encontrada.  Talvez 512 corpo n√£o se encaixe em 1500 MTU, embora, duvido, o pequeno teste seja indicativo. <br><br>  Notei que em grandes volumes (650k) o nginx reduz a separa√ß√£o.  Talvez isso tenha algo a ver com buffers e tamanho do Windows TCP. <br><br>  O resultado do teste de rand.  Mostra como o menos conn lida em condi√ß√µes de velocidade diferente da execu√ß√£o do script em diferentes minions. <br><br><img src="https://habrastorage.org/webt/z_/pe/se/z_pesed0h37wmanijte9wjsr7ra.png"><br><br>  Surpreendentemente, o nginx hash funcionou mais r√°pido que o menor n√∫mero de conex√µes, e somente no passe final o menor n√∫mero de conex√µes foi um pouco √† frente, o que n√£o pretende ser significativo. <br>  Os n√∫meros de passes s√£o muito diferentes devido ao fato de 100 threads sa√≠rem de uma s√≥ vez, e o FPM-ok desde o in√≠cio carregar cerca de 10. Na terceira passagem, eles tiveram tempo para se acostumar - o que mostra a aplicabilidade das estrat√©gias para as rajadas. <br><br>  A NFT provavelmente perdeu esse teste.  O Nginx otimiza bem a intera√ß√£o com os FPMs nessas situa√ß√µes. <br><br>  pequeno teste <br><br><img src="https://habrastorage.org/webt/wo/l-/ua/wol-uar4xattjpfztcpppy53hae.png"><br><br>  nft vence marginalmente no RPS, menos conn √© novamente um outsider. <br><br>  A prop√≥sito, neste teste, √© visto que 400-500RPS s√£o emitidos, embora, no teste com o envio de 512 bytes, fosse para 1500 - parece que o sistema consome mil. <br><br><h2>  Conclus√µes </h2><br>  A NFT teve um bom desempenho em uma situa√ß√£o de otimiza√ß√£o de cargas uniformes: quando muitos dados s√£o fornecidos e o tempo de opera√ß√£o do aplicativo √© determinado e os recursos do cluster s√£o suficientes para processar o fluxo de entrada sem entrar em queda. <br><br>  Em uma situa√ß√£o em que a carga para cada solicita√ß√£o √© ca√≥tica e √© imposs√≠vel equilibrar uniformemente a carga do servidor com o restante primitivo da divis√£o de hash, a NFT perde. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt441348/">https://habr.com/ru/post/pt441348/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt441336/index.html">RTOS ou n√£o RTOS √© a quest√£o</a></li>
<li><a href="../pt441338/index.html">Como criamos um sistema de pagamento em criptomoeda: cinco problemas principais</a></li>
<li><a href="../pt441340/index.html">A heran√ßa cultural do Cazaquist√£o em modelos 3D</a></li>
<li><a href="../pt441344/index.html">Entre no c√©u. Uma hist√≥ria honesta sobre uma paix√£o s√©ria pelo paraquedismo</a></li>
<li><a href="../pt441346/index.html">Conhe√ßa um estrategista de conte√∫do: uma entrevista com Dmitry Kabanov, curador do Techstars Startup Digest e consultor SXSW</a></li>
<li><a href="../pt441350/index.html">Haskell √© realmente a linguagem dos g√™nios e da academia?</a></li>
<li><a href="../pt441352/index.html">Padr√µes e anti-padr√µes de CI / CD. Parte 2</a></li>
<li><a href="../pt441356/index.html">Como entender o c√≥digo "estrangeiro" e ingressar em uma nova equipe?</a></li>
<li><a href="../pt441358/index.html">Lan√ßou o primeiro lander lunar comercial da Beresheet</a></li>
<li><a href="../pt441360/index.html">Openshift - artesanato com chap√©u vermelho</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>