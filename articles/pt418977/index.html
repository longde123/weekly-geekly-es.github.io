<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úãüèª üñ§ ‚õé Confiabilidade no World of Tanks Server üåõ üõÉ üìÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O t√≥pico de hoje - a confiabilidade do World of Tanks Server - √© bastante escorregadio. A confiabilidade do jogo √© comprometida, portanto, tudo precis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Confiabilidade no World of Tanks Server</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/418977/"><p>  O t√≥pico de hoje - a confiabilidade do World of Tanks Server - √© bastante escorregadio.  A confiabilidade do jogo √© comprometida, portanto, tudo precisa ser feito rapidamente e rapidamente no desenvolvimento do jogo.  A carga nos servidores √© grande e os usu√°rios tendem a quebrar algo apenas por interesse.  <strong>Levon Avakyan,</strong> da RIT ++, disse o que a Wargaming est√° fazendo para garantir a confiabilidade. </p><br><p>  Geralmente, quando se fala em confiabilidade, monitoramento, teste de estresse, etc., s√£o mencionados o tempo todo.  N√£o h√° nada sobrenatural nisso, e o relat√≥rio foi dedicado a momentos espec√≠ficos de Tanks. </p><br><img src="https://habrastorage.org/webt/x6/id/gr/x6idgr4r-xse32m9p4kqkps8ndi.jpeg"><br><br><p>  <strong>Sobre o palestrante:</strong> Levon Avakyan trabalha para a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Wargaming</a> como chefe de servi√ßos e confiabilidade de jogos da WoT e lida com os problemas de confiabilidade do servidor de tanques. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/x-Uk5xBsstA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br>  Hoje vou falar sobre como fazemos isso, incluindo o que √© o servidor do World Of Tanks, o que consiste, o que √© constru√≠do, para que voc√™ entenda o assunto da conversa.  Al√©m disso, consideraremos o que pode dar errado dentro do pr√≥prio servidor e em torno dele, porque o jogo j√° √© mais do que o servidor.  Tamb√©m falaremos um pouco sobre os processos, porque muitos esquecem que um processo bem estabelecido na produ√ß√£o faz parte do sucesso, n√£o apenas em termos de economia de recursos (muitas pr√°ticas v√™m da produ√ß√£o real), mas afeta a qualidade e a confiabilidade da solu√ß√£o. <br><br><img src="https://habrastorage.org/webt/qa/oj/17/qaoj17globztvoj2lxan-yry9-a.jpeg"><br>  Geralmente, quando eles falam sobre confiabilidade, monitoramento, teste de estresse, etc., s√£o mencionados o tempo todo.  N√£o o inclu√≠ aqui porque acho chato.  N√£o descobrimos nada sobrenatural nisso.  Sim, tamb√©m temos um sistema de monitoramento, realizamos testes de estresse com testes de estresse para aumentar a confiabilidade do sistema e saber onde ele pode cair.  Mas hoje vou falar sobre o que √© mais espec√≠fico para tanques. <br><br>
<h2>  BigWorld Technology <br></h2><br>  Este √© um mecanismo de back-end, bem como um kit de ferramentas para criar MMOs. <br><br>  Esse mecanismo bastante antigo do BigWorld Server (originado no final dos anos 90 - in√≠cio dos anos 2000) √© um conjunto de processos diferentes que suportam o jogo.  Os processos s√£o iniciados em um cluster, interconectados em uma rede de m√°quinas.  Interagindo entre si, os processos mostram ao usu√°rio algum tipo de mec√¢nica de jogo. <br><br>  O mecanismo √© chamado BigWorld, porque √© muito bom fazer jogos nele, nos quais h√° um grande campo (espa√ßo), no qual ocorrem opera√ß√µes militares (batalhas).  Para tanques, isso se encaixa perfeitamente. <br><br>  Em termos de confiabilidade, os seguintes recursos principais foram investidos no BigWorld: <br><br><ul><li>  <strong>Balanceamento de carga.</strong>  O mecanismo aloca recursos, tentando alcan√ßar dois objetivos: <br><ol><li>  use o menor n√∫mero poss√≠vel de m√°quinas; </li><li>  ao mesmo tempo, n√£o carregue seus aplicativos para que a carga deles exceda um determinado limite. </li></ol></li><li>  <strong>Escalabilidade.</strong>  Adicionamos o carro ao cluster, lan√ßamos processos nele - o que significa que voc√™ pode contar mais batalhas e aceitar jogadores. <br></li><li>  <strong>Alta disponibilidade.</strong>  Se, por exemplo, um carro caiu ou algo deu errado com um dos processos do jogo que serve o jogo em si, n√£o h√° com o que se preocupar - o jogo n√£o notar√°, ser√° restaurado em outro local e funcionar√°. </li><li>  <strong>Manter a integridade e consist√™ncia dos dados.</strong>  Este √© o segundo n√≠vel de toler√¢ncia a falhas.  Se houver v√°rios clusters, como em Tanks, e houve algum tipo de desastre no datacenter ou no canal principal, isso n√£o significa que perderemos completamente os dados do jogo que a pessoa jogou.  Vamos nos recuperar, a consist√™ncia ser√°. </li></ul><br>  <strong>Os processos que est√£o em nosso sistema e suas fun√ß√µes</strong> <br><br><ul><li>  <strong>CellApp</strong> √© o processo respons√°vel por processar o espa√ßo do jogo ou parte dele. <br></li></ul>  Como eu disse, o BigWorld trabalha com certos espa√ßos que dividimos em c√©lulas.  Cada c√©lula espec√≠fica do nosso espa√ßo de jogo √© calculada por um aplicativo espec√≠fico. <br><br><ul><li>  <strong>CellAppMgr</strong> - o processo que coordena o trabalho do CellApp, balanceamento de carga. <br></li></ul>  CellApp pode ser muitos, portanto, deve haver um processo que os controle. <br><br><ul><li>  <strong>O BaseApp</strong> gerencia entidades, isola os clientes do trabalho com o CellApp. </li></ul>  Uma das coisas fundamentais no BigWorld √© o conceito de entidade - por exemplo, a conta de um jogador.  Tudo o que fazemos no campo de batalha, fazemos com essa entidade.  CellApps calcula f√≠sica e mec√¢nica de jogo, como tiro.  BaseApp trabalha com entidades.  Serve a conta, tanque, etc. <br><br><ul><li>  <strong>ServiceApp</strong> √© um BaseApp especializado que implementa algum tipo de servi√ßo. </li></ul>  Esta √© uma vers√£o simplificada do BaseApp, um processo que faz v√°rias coisas de servi√ßo.  Por exemplo, algu√©m deve ser capaz de ler no RabbitMQ.  Isso n√£o √© sobre entidades de jogo, mas tamb√©m √© necess√°rio. <br><br><ul><li>  <strong>O BaseAppMgr</strong> gerencia o BaseApp e o ServiceApp, porque tamb√©m existem muitos deles. </li><li>  <strong>O LoginApp</strong> cria novas conex√µes de clientes e tamb√©m proxies de usu√°rios no BaseApp. </li><li>  <strong>O DBApp</strong> implementa uma interface de acesso ao armazenamento (bancos de dados).  Trabalhamos com Percona, mas pode ser outro banco de dados. </li><li>  <strong>O DBAppMgr</strong> coordena o trabalho do DBApp. </li><li>  <strong>O InterClusterMgr</strong> gerencia a comunica√ß√£o entre <strong>clusters</strong> . </li><li>  <strong>O Revisor</strong> √© um inspetor de processos que pode reiniciar os processos. </li><li>  <strong>Bwmachined</strong> <strong>&nbsp;</strong>  - um daemon que √© executado em cada m√°quina no cluster para coordenar seu trabalho.  Ele permite que todos os gerentes da BaseApp se comuniquem. </li></ul><br><img src="https://habrastorage.org/webt/z9/dq/he/z9dqhes39d5hjaah6aq4igy6kzg.jpeg"><br><br>  √â assim que os tanques ficam por dentro, ainda que brevemente: <br><br><ul><li>  Os clientes se conectam via Internet, acessam o LoginApp. </li><li>  O LoginApp os autoriza a usar o DBApp e emite um endere√ßo do BaseApp. </li><li>  Mais clientes jogam com eles. </li></ul><br>  Tudo isso est√° espalhado por muitas m√°quinas, cada uma com um BWMachineD, que pode gerenciar tudo isso, orquestrar etc. <br><br><h2>  Ecossistema do World of Tanks <br></h2><br>  O que h√° por a√≠?  Parece que existe um servidor de jogo e jogadores - escolheu um tanque, foi jogar.  Mas, infelizmente (ou com alegria), o jogo est√° se desenvolvendo e a mec√¢nica do jogo de "apenas atirar" n√£o √© mais suficiente.  Consequentemente, o servidor do jogo come√ßou a ficar cheio de v√°rios servi√ßos, alguns dos quais geralmente eram imposs√≠veis de executar dentro do servidor, enquanto come√ßamos a remover outros especialmente para aumentar a velocidade de entrega de conte√∫do ao jogador.  Ou seja, √© mais r√°pido escrever um pequeno servi√ßo em Python que faz algum tipo de mec√¢nica de jogo do que dentro do servidor em todos os BaseAPPs, clusters de suporte etc. <br><br>  Algumas coisas, por exemplo, sistemas de pagamento foram originalmente emitidos.  N√≥s suportamos outros, porque a Wargaming desenvolve mais de um jogo, afinal.  Esta √© uma trilogia: Tanques, Avi√µes, Navios, e h√° Blitz e planos para novos jogos.  Se eles estivessem dentro do BigWorld, n√£o poderiam ser convenientemente usados ‚Äã‚Äãem outros produtos. <br><br>  Tudo foi muito r√°pido e caoticamente, o que resultou em algumas tecnologias de zool√≥gico usadas em nosso ecossistema de tanques. <br><br>  Principais tecnologias e protocolos: <br><br>  1. Python 2.7, 3.5; <br><br>  2. Erlang; <br><br>  3. Scala; <br><br>  4. JavaScript; <br><br>  Frameworks <br><br>  5. Django; <br><br>  6. Falc√£o; <br><br>  7. ass√≠ncio; <br><br>  Armazenamento: <br><br>  8. Postgres; <br><br>  9. Percona. <br><br>  10. Memcached e Redis para armazenamento em cache. <br><br>  Todos juntos para o jogador, este √© o servidor do tanque: <br><br><ul><li>  Ponto √∫nico de autoriza√ß√£o; </li><li>  Bate-papo </li><li>  Cl√£s; </li><li>  Sistema de pagamento; </li><li>  Sistema de torneios; </li><li>  Meta-jogos (mapa global, √°reas fortificadas); </li><li>  Portal de Tanques, Portal do Cl√£; </li><li>  Gerenciamento de conte√∫do etc. </li></ul><br>  Mas se voc√™ olhar, essas s√£o coisas ligeiramente diferentes escritas em diferentes tecnologias.  Isso causa alguns problemas de confiabilidade. <br><br><img src="https://habrastorage.org/webt/oi/-o/ax/oi-oaxdx4eek4e5omtpwlyp5ism.jpeg"><br><br>  O diagrama mostra nosso servidor tanque junto com seu ecossistema.  H√° um servidor de jogos, servi√ßos da Web (interno e externo), incluindo servi√ßos completamente especiais, localizados na rede de back-end e que executam fun√ß√µes de servi√ßo e servi√ßo para eles, que realmente implementam as interfaces.  Por exemplo, existe um servi√ßo de cl√£ com seu pr√≥prio portal de cl√£s, que permite gerenciar esse cl√£, h√° um portal do pr√≥prio jogo etc. <br><br>  Essa separa√ß√£o nos permite nos preocupar menos com seguran√ßa, porque ningu√©m tem acesso √† rede interna - menos problemas.  Mas isso leva a esfor√ßos adicionais, porque precisamos de proxies que d√™em acesso se for necess√°rio envi√°-lo para fora. <br><br>  Eu j√° disse que tomamos a decis√£o de remover parte da l√≥gica do jogo e outras coisas do servidor.  Havia uma tarefa de alguma forma incluir tudo no cliente.  Temos um maravilhoso Gateway de Cliente que permite que um cliente de tanque acesse diretamente um servidor de algumas das APIs desses Servi√ßos Internos - os mesmos cl√£s ou API de nossos meta-jogos. <br><br>  Al√©m disso, colocamos a CEF (Chromium Embedded Framework) dentro do cliente do tanque.  Agora temos o mesmo navegador.  O jogador n√£o o distingue da janela do jogo.  Isso permite que voc√™ trabalhe com toda a infraestrutura, ignorando o trabalho com o servidor do jogo. <br><br>  Temos muitos clusters - aconteceu - vou lhe dizer o porqu√™.  √â assim que a regi√£o da CEI se parece. <br><br><img src="https://habrastorage.org/webt/rc/w4/ri/rcw4rignlicjgsjz8oeepp9cipa.jpeg"><br><br>  Tudo est√° espalhado pelos data centers.  Os jogadores, dependendo de onde o ping √© melhor, se conectam ao local.  Mas todo o ecossistema n√£o √© dimensionado dessa maneira, √© principalmente na Europa e Moscou, o que tamb√©m nos adiciona alguns problemas de confiabilidade - lat√™ncia e encaminhamento extras. <br><br>  √â assim que o ecossistema do World of Tanks se parece. <br><br>  O que pode dar errado com toda essa economia?  O que voc√™ quiser!  E vai J. Mas vamos desmontar. <br><br><h2>  Pontos principais de falha dentro de um cluster <br></h2><br><h4>  Falha em uma √∫nica m√°quina ou processo <br></h4><br>  A op√ß√£o mais simples que podemos prever √© a falha de uma m√°quina ou processo dentro de um cluster.  Temos grupos de 10 a 100 carros - algo pode voar.  Como eu disse, o pr√≥prio BigWorld fornece mecanismos prontos para uso que nos permitem ser mais confi√°veis. <br><br><img src="https://habrastorage.org/webt/-3/tl/-q/-3tl-qfzv-9slfdcdbymwl--s3a.jpeg"><br><br>  Esquema padr√£o: existem BaseApps espalhados por diferentes m√°quinas.  Nesses BaseApp, existem entidades que cont√™m entidades de estado.  Cada BaseApp faz o backup com Round Robin em outros. <br><br>  Suponha que tiv√©ssemos um arquivo e algum BaseApp morresse ou a m√°quina inteira morresse - tudo bem!  Os BaseApps restantes deixaram essas entidades, elas ser√£o restauradas e a jogabilidade do jogador n√£o sofrer√°. <br><br><img src="https://habrastorage.org/webt/mm/ix/tp/mmixtp-1r1cmzro9zznc1o76a2g.jpeg"><br><br>  Os CellAPPs fazem exatamente a mesma coisa, a √∫nica coisa √© que eles armazenam seus estados no BaseApps tamb√©m, e n√£o em outros CellAPPs. <br><br>  Parece ser um mecanismo confi√°vel, mas ... <br><br><h5>  Voc√™ tem que pagar por tudo <br></h5><br>  Com o tempo, come√ßamos a observar o seguinte. <br><br>  ‚Ä¢ A cria√ß√£o de c√≥pias de seguran√ßa das entidades come√ßa a ocupar cada vez mais recursos do sistema e tr√°fego de rede. <br><br>  De fato, o pr√≥prio processo de backup come√ßa a afetar a estabilidade do sistema quando dentro do cluster a maior parte da rede est√° ocupada transmitindo c√≥pias para Round Robins. <br><br>  ‚Ä¢ O tamanho das entidades aumenta com o tempo, √† medida que novos atributos e mec√¢nicos de jogo s√£o adicionados. <br><br>  Mas o mais desagrad√°vel √© que o tamanho dessas entidades cresce como uma avalanche.  Por exemplo, um jogador executa alguma a√ß√£o (compra a propriedade do jogo) e essa opera√ß√£o come√ßou a ficar mais lenta.  Ainda n√£o o conclu√≠mos, mas salvamos as altera√ß√µes nesses atributos.  Ou seja, o sistema √© muito ruim e ainda estamos come√ßando a aumentar o tamanho do backup que precisa ser feito.  H√° um efeito de bola de neve. <br><br>  ‚Ä¢ A estabilidade geral do sistema diminui <br><br>  Devido ao fato de estarmos tentando escapar da queda de uma m√°quina ou processo, diminu√≠mos a estabilidade de todo o sistema. <br><br>  <strong>O que fizemos para lidar com isso</strong> ?  Decidimos para cada entidade destacar o que realmente precisa ser copiado.  Dividimos os atributos em mut√°veis ‚Äã‚Äãe imut√°veis, e n√£o copiamos toda a entidade, mas fazemos backup apenas de seus atributos mut√°veis.  Dessa forma, simplesmente reduzimos a quantidade de informa√ß√µes que realmente precisam ser mantidas em ferro.  Agora, ao adicionar um novo atributo, quem faz isso deve ver mais claramente onde atribu√≠-lo.  Mas, em geral, isso nos salvou da situa√ß√£o. <br><br>  Para ser completamente franco, esse mecanismo foi estabelecido no BigWorld, mas, em algum momento, no Tanks, ele n√£o era mais suportado at√© o fim, e nem toda entidade pode se recuperar do backup.  Em navios, por exemplo, os caras apoiam isso.  L√°, voc√™ pode desligar as m√°quinas com seguran√ßa - as informa√ß√µes ser√£o restauradas em outras m√°quinas e o cliente n√£o notar√° nada.  Infelizmente, esse nem sempre √© o caso em tanques, mas obteremos o retorno de toda essa funcionalidade para que funcione como deveria. <br><br><h4>  Falha no data center.  Multi-cluster <br></h4><br>  Se de repente n√£o um ou dois carros ca√≠ssem, e come√ßamos a perder todo o data center, ou seja, o cluster completamente, que propriedades o sistema deveria ter para que o jogo n√£o ca√≠sse em tal situa√ß√£o? <br><br><ul><li>  Cada cluster deve ser independente, ou seja: <br><ol><li>  deve ter seu pr√≥prio banco de dados; </li><li>  o cluster processa apenas seus espa√ßos (arenas de batalha). </li></ol>  Assim, se algumas arenas atingem, outras ainda funcionam. </li><li>  Os agrupamentos devem se comunicar entre si para que se possa dizer ao segundo: "Eu ca√≠!"  Quando surgir, os dados ser√£o restaurados a partir das c√≥pias salvas. </li><li>  Tamb√©m √© desej√°vel que voc√™ possa transferir o usu√°rio de cluster para cluster. </li></ul><br>  No momento, o esquema do nosso multi-cluster se parece com isso. <br><br><img src="https://habrastorage.org/webt/ov/qd/2u/ovqd2ufkauofi1ybo1wduomewtu.jpeg"><br><br>  Temos um cluster central e o que chamamos de perif√©ricos nos quais as batalhas reais est√£o sendo travadas.  O CellApp n√£o est√° sendo executado no cluster central, caso contr√°rio, √© exatamente o mesmo que todos os outros.  √â o ponto central do processamento da conta: eles aumentam para l√°, s√£o enviados para a periferia e, na periferia, uma pessoa j√° est√° jogando.  Ou seja, a falha de qualquer um dos clusters n√£o leva √† perda de operacionalidade de todo o jogo.  Mesmo a falha do cluster central simplesmente n√£o permite que novos jogadores entrem, mas aqueles que j√° est√£o jogando na periferia podem continuar o jogo. <br><br>  O fato de que tudo funciona para n√≥s atrav√©s do cluster central acabou porque, em geral, a pr√≥pria tecnologia BigWorld sup√µe que exista um gerenciador especial entre processos de gerenciamento de processos.  De fato, esses gerentes inter claster podem ser um pouco criados. <br><br>  Historicamente, os tanques precisavam de um cluster m√∫ltiplo, porque come√ßaram a crescer avalanche online.  Quando atingimos o pico de 200 mil jogadores, o tr√°fego de entrada deles simplesmente parou de ser colocado no datacenter pela rede.  Tivemos que literalmente ajoelhar algum tipo de solu√ß√£o para que os players pudessem ser lan√ßados em v√°rios data centers. <br><br>  De fato, s√≥ vencemos, porque agora temos um multi-cluster.  Tamb√©m se tornou √∫til para os jogadores, porque o ping, ou seja, a acessibilidade na rede, afeta muito a jogabilidade.  Se o atraso for superior a 50-70 ms, isso j√° come√ßar√° a afetar a qualidade do jogo, porque em Tanks absolutamente tudo √© calculado no servidor.  N√£o h√° c√°lculos no cliente.  Portanto, lembre-se de que praticamente n√£o h√° nada a ser feito.  Obviamente, alguns mods s√£o feitos l√°, mas eles n√£o afetam o processo em si.  Voc√™ pode tentar adivinhar o que vai acontecer, mas afetar a mec√¢nica do jogo - n√£o. <br><br>  Devido a essa abordagem, nosso <strong>cluster central tornou-se um ponto de falha</strong> .  Tudo estava fechado para ele.  Decidimos - j√° que essas m√°quinas e uma grande base de covis de ca√ßa est√£o l√°, deixemos nossos perif√©ricos lidar exclusivamente com a luta.  Ent√£o realmente n√£o h√° necessidade de armazenar grandes quantidades de informa√ß√µes - as batalhas est√£o sendo disputadas e est√£o sendo disputadas - vamos bloquear tudo l√°. <br><br>  Para reescrever absolutamente tudo, a fim de fugir do conceito de cluster central, agora n√£o h√° tempo, nem desejo especial.  Mas decidimos, primeiro, ensinar grupos de perif√©ricos a se comunicarem.  Depois, abrimos um buraco neles para que fosse poss√≠vel influenci√°-los usando servi√ßos de terceiros. <br><br>  Por exemplo, para criar uma batalha mais cedo, era necess√°rio informar ao cluster central que era necess√°rio criar uma batalha em algumas periferias.  Al√©m disso, por mecanismos internos, as entidades se movimentaram, a ess√™ncia da arena foi criada, etc. <br><br>  <strong>Agora √© poss√≠vel entrar em contato diretamente com a periferia, ignorando o cluster central.</strong>  Ent√£o, removemos o trabalho extra dele.  Mas at√© agora n√£o h√° desejo de mudar completamente para um esquema no qual todos os clusters s√£o quase ponto a ponto, e tudo isso √© controlado por alguns processos, mas n√£o pelo cluster. <br><br>  Lembro que, al√©m do cluster de jogos com seus BaseApps, CellApps e outros, temos um ecossistema. <br><br><img src="https://habrastorage.org/webt/oi/-o/ax/oi-oaxdx4eek4e5omtpwlyp5ism.jpeg"><br><br>  Tentamos garantir que o desempenho do ecossistema n√£o afete a jogabilidade.  Na pior das hip√≥teses, por exemplo, o sistema de torneios n√£o funciona, mas voc√™ pode jogar aleatoriamente - de qualquer maneira, a maioria das pessoas joga aleatoriamente.  Sim, reduzimos a qualidade, mas em geral, voc√™ pode sobreviver v√°rias horas sem torneios. <br><br>  Isso nem sempre acontece.  Em primeiro lugar, j√° existem esses servi√ßos da Web que est√£o profundamente embutidos no jogo.  Por exemplo, um √∫nico ponto de autoriza√ß√£o √© um servi√ßo que permite que voc√™ efetue login na Web ou em algum lugar do mesmo lugar e efetue login em todo o universo Wargaming. <br><br>  O segundo exemplo √© um servi√ßo que serve para compras e transa√ß√µes de jogos.  Ele tamb√©m teve que ser trazido para o jogo apenas porque precis√°vamos de um rastro das compras do jogador.  O fato √© que, em algumas regi√µes, somos obrigados a exibir informa√ß√µes ao cliente sobre quais propriedades do jogo foram compradas com dinheiro real e qual foi usada.  O sistema inicialmente n√£o assumiu isso, ningu√©m o exp√¥s h√° cinco anos, mas a <strong>lei √© dura: voc√™ precisa fazer - fa√ßa</strong> . <br><br><h2>  Pontos de falha do ecossistema do World of Tanks <br></h2><br><h3>  N√∫mero do problema 1. Carga aumentada <br></h3><br>  Temos um cluster m√∫ltiplo no qual 10 clusters com um grande n√∫mero de m√°quinas.  Os jogadores jogam e a web √© pequena.  Ningu√©m compra mais cinco m√°quinas em cada data center.  Mas, ao mesmo tempo, fornecemos a mesma funcionalidade e tudo o que √© necess√°rio dentro do cliente.  Esse √© o principal problema. <br><br><blockquote>  A interatividade e reatividade da interface √© a principal fonte de aumento da carga do ecossistema. <br></blockquote><br>  Vou dar dois exemplos do servi√ßo de cl√£: <br><br><ol><li>  Voc√™ quer convidar outro jogador para o cl√£.  Obviamente, quero que o convidado receba imediatamente uma notifica√ß√£o e ele possa se juntar a voc√™.  Para implementar isso, √© necess√°rio fazer com que o servi√ßo do cl√£ notifique o cliente de alguma forma ou solicite ao servi√ßo da web de tempos em tempos: ‚ÄúAlguma coisa mudou?  Tenho novos convites?  Esta √© a primeira op√ß√£o de onde a carga extra pode vir. </li><li>  Os tanques t√™m um regime fortificado.  Suponha que seja jogado n√£o por uma pessoa, mas por v√°rias.  Todos os jogadores t√™m uma janela aberta com √°reas fortificadas.  O comandante construiu o edif√≠cio.  √â aconselh√°vel que, para todos que t√™m essa janela aberta, o pr√©dio apare√ßa imediatamente. </li></ol><br>  A decis√£o na testa com a pesquisa n√£o √© muito boa.  De fato, est√° funcionando, basta que voc√™ aloque tantas capacidades para isso que esse recurso n√£o trar√° nenhum lucro para a empresa.  E se o recurso n√£o gerar lucro, voc√™ n√£o precisar√° faz√™-lo. <br><br><blockquote>  Meu conselho pessoal sobre como lidar com isso: a melhor maneira de tornar o sistema mais confi√°vel sob carga √© geralmente reduzir a carga de alguma maneira l√≥gica. </blockquote><br>  Voc√™ n√£o deve se deitar com ferro, criar sistemas com novos ventiladores, otimizar alguma coisa. De qualquer forma, quanto maior a carga, mais artefatos aparecer√£o dos quais voc√™ n√£o pode se afastar.  Al√©m disso, os artefatos ocorrer√£o mesmo em n√≠veis cada vez mais baixos de abstra√ß√£o - primeiro com aplicativos, depois com diferentes servi√ßos da Web, e voc√™ chegar√° √† rede (Cisco, etc.).  Em algum n√≠vel, voc√™ simplesmente n√£o pode resolver os problemas. <br><br>  Se voc√™ pensar com cuidado, eles podem ser simplesmente evitados. <br><br>  A primeira coisa que fizemos foi <strong>aprender a notificar os clientes por meio de um servidor de jogos</strong> usando sua infraestrutura.  Por exemplo, quando um convite √© enviado ao cl√£, dizemos ao servidor: ‚ÄúConvidamos essas e essas pessoas‚Äù e, em seguida, o pr√≥prio cluster encontra aquele para quem a notifica√ß√£o deve ser enviada, principalmente porque eles t√™m uma conex√£o.  Ou seja, pressionamos o servi√ßo, e ningu√©m constantemente nos derrama.    ,          ,       .   ,   ,    . <br><br>  ‚Äî  <strong>Web-sockets (nginx-pushstream)</strong> . ,      Web-sockets.   ,      Chromium Embedded Framework ‚Äî  ,   , Web-sockets   Nginx.   pushstream,     Web-sockets       . <br><br><h3>  ‚Ññ 2.    <br></h3><br>  ,    ,   ,  <strong> ‚Äî  </strong> .    ,    ,    ‚Äî    . <strong>    ,    </strong> ,   . <br><br>   ?  : -  , - ,             ,    .   - , , .    . <br><br>        . <br><br><img src="https://habrastorage.org/webt/ul/8f/6m/ul8f6mjlivwkgkswzl-cwtxlx-o.jpeg"><br><br>  ,      <strong>120      </strong> <strong>Game Play</strong> .    .         ,     ,      .      ,          .    . <br><br> <strong> </strong> <br><br>  3  ,   : <br><br><ol><li> HTTP API; </li><li> RabbitMQ ‚Äî  ; </li><li> Apache Kafka     . </li></ol><br>     ,    ,  ,  ,      ,    .     ,  -  ‚Äî ,    .          ,      . <br><br> <strong> </strong> <br><br> <strong>1. HTTP</strong> <br><br>    ‚Äî  HTTP.   ,  ,   -,      .      : <br><br><ul><li>      (  ,     ). <br></li></ul><br> ,    ,       .    ,   , ,  Django,    100  200 ,    API,  .    ,   ,   - 30-40 ,     ,   .   ,   ‚Äî     . <br><br><ul><li>      . <br></li></ul><br>  ,    ,   HTTP, ‚Äî       .      .   ‚Äî  ‚Äî  .   , <strong> ,  , ,  </strong> . <br><br><ul><li>     . <br></li></ul><br>     .   .  - ,   - API ‚Äî    API,        . <br><br>      ‚Äî      ,      . ,   ,      . ,      10 ,  -     100    500. ,    HTTP     .    nginx'   ,       ‚Äî  . <br><br>  ,    HTTP  ,         . <br><br> <strong>2. RabbitMQ</strong> <br><br>    RabbitMQ     BigWord     . <br><br><ul><li>     . <br></li></ul><br>         ‚Äî -  ,   ,  , . <br><br><ul><li>   ¬´¬ª,    ,        . <br></li></ul><br>    :      .    ,     API: ¬´      N    ‚Äî    ¬ª.    ,      , , ,  ‚Äî          .      ,      . <br><br>  ¬´¬ª,   ¬´¬ª,    ‚Äî       . <br><br><ul><li>     . <br></li></ul><br> RabbitMQ  ,      , ,      ,      ,   ,      ,   . <br><br><blockquote>   ‚Äî    RabbitMQ     . </blockquote><br> <strong>3. Kafka</strong> <br><br>     ,    ,     ‚Äî   Kafka.   ,   RabbitMQ   -     . <br><br><ul><li>     . <br></li></ul><br>     ,       ,    ,    .  ,  ,        .      .   Kafka. ,    ‚Äî    ,    . <br><br><ul><li>     . <br></li></ul><br>    ,     .        ,    ,     -  ‚Äî     . <br><br>  Kafka   ,    ,        ,    -   ,       .      . <br><br><h2>    <br></h2><br>      ‚Äî    . <br><br><img src="https://habrastorage.org/webt/ke/ty/oc/ketyocondz4qhsiguntwchhmonq.jpeg"><br><br> : <br><br><ul><li>   <strong> </strong> .         ,   - ,   .. </li><li>   <strong> </strong> ‚Äî  , , , . </li><li>      ‚Äî <strong>      </strong> ,    .       ,    ,   . </li></ul><br>     .     , , ,   entity.   .    ,     ,       . <br><br><h2> DLC <br></h2><br>    ,   DLC (Development Lifecycle) ‚Äî ,  ,   . <br><br><img src="https://habrastorage.org/webt/3c/5t/c2/3c5tc2hlxbrgpdtjts88yxrcp3e.jpeg"><br><br>     ,  ,   . DLC   ,        ,          .       ,  . ,      ,       ,     . <br><br>           DLC,       .     ,        ,    ,  . <br><br>     DLC,   ,    : <br><br> ‚Ä¢ <strong>   (      ).</strong> <br><br>     ,    ,    ¬´- ,   ¬ª,   .     ,       , ,    ,    . <br><br> ‚Ä¢        :   SRE. <br><br>    ,  solution-, technical-owner, reability- ‚Äî       ,   -  ,    game-    .    , ,     ,       .   - ,      ,    ,      ,   .    ,     . <br><br> ‚Ä¢ <strong>SRE    .</strong> <br><br>        ‚Äî  -   .          ,        .    ,  SRE     -.    SRE  ,     : ¬´    ,       ,    ,     ‚Äî   !¬ª      ,   . <br><br>        QA ,    , -  , ,    ‚Äî    . <br><br><h2>  <br></h2><br> BigWorld Technology  ¬´¬ª       .      ,  .         .  ¬´ ¬ª,    . <br><br>  ¬´  ¬ª     ,     ,    .   ‚Äî ¬´¬ª (, ) ‚Äî     .      ,        . , -  . <br><br> <i>:         ++.    ,    40        ,    .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a>  ,      .</i> <br><br><blockquote>  RootConf   ‚Äî   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DevOpsConf Russia</a> .        DevOps <b>1  2   </b> ,  .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> ,       . ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a>    ‚Äî    ! <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt418977/">https://habr.com/ru/post/pt418977/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt418963/index.html">Revis√£o do rob√¥ de mesa DoBot Magician</a></li>
<li><a href="../pt418969/index.html">Como est√£o os √∫ltimos dias da corrida em US $ 1 trilh√£o? (UPD.: Apple venceu)</a></li>
<li><a href="../pt418971/index.html">Os mapas de radia√ß√£o de J√∫piter s√£o a chave para novas explora√ß√µes na Europa</a></li>
<li><a href="../pt418973/index.html">Conhe√ßa DevOpsConf Russia</a></li>
<li><a href="../pt418975/index.html">Como medir o sucesso. Estrat√©gias de monitoramento e sua rela√ß√£o com problemas de neg√≥cios</a></li>
<li><a href="../pt418979/index.html">Enquanto eu voava pelo pa√≠s, implementando um projeto para v√°rios milhares de empregos</a></li>
<li><a href="../pt418981/index.html">M√©todos num√©ricos para resolver equa√ß√µes el√≠pticas</a></li>
<li><a href="../pt418985/index.html">An√°lise e design como um todo</a></li>
<li><a href="../pt418987/index.html">O Firefox ignora facilmente a prote√ß√£o na nova interface do Gmail</a></li>
<li><a href="../pt418991/index.html">O microfilme existir√° por meio mil√™nio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>