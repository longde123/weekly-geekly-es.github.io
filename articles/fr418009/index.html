<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÖüèª „äóÔ∏è ü§û Node.js et rendu de serveur dans Airbnb üö£ ‚ô†Ô∏è üññüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le mat√©riel, dont nous publions la traduction aujourd'hui, est consacr√© √† la fa√ßon dont Airbnb optimise les parties serveur des applications Web en te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Node.js et rendu de serveur dans Airbnb</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/418009/">  Le mat√©riel, dont nous publions la traduction aujourd'hui, est consacr√© √† la fa√ßon dont Airbnb optimise les parties serveur des applications Web en tenant compte de l'utilisation toujours croissante des technologies de rendu de serveur.  Au cours de plusieurs ann√©es, la soci√©t√© a progressivement d√©plac√© l'ensemble de son front-end vers une architecture <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">uniforme</a> , selon laquelle les pages Web sont des structures hi√©rarchiques de composants React remplies de donn√©es de leur API.  En particulier, au cours de ce processus, il y a eu un abandon syst√©matique de Ruby on Rails.  En fait, Airbnb pr√©voit de passer √† un nouveau service bas√© uniquement sur Node.js, gr√¢ce auquel les pages enti√®rement pr√©par√©es rendues sur le serveur seront livr√©es aux navigateurs des utilisateurs.  Ce service g√©n√©rera la plupart du code HTML pour tous les produits Airbnb.  Le moteur de rendu en question diff√®re de la plupart des services backend utilis√©s par la soci√©t√© du fait qu'il n'est pas √©crit en Ruby ou Java.  Cependant, il diff√®re des services Node.js traditionnels tr√®s charg√©s, autour desquels les mod√®les mentaux et les outils auxiliaires utilis√©s dans Airbnb sont construits. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/rg/zm/64/rgzm64dbdvumj6ycekqpoxbqxhw.png"></a> <br><a name="habracut"></a><br>
<h2>  <font color="#3AC1EF">Plateforme Node.js</font> </h2><br>  En pensant √† la plate-forme Node.js, vous pouvez imaginer comment une certaine application, con√ßue en tenant compte des capacit√©s de cette plate-forme pour le traitement de donn√©es asynchrones, sert rapidement et efficacement des centaines ou des milliers de connexions parall√®les.  Le service extrait les donn√©es dont il a besoin de partout et les traite un peu afin de r√©pondre aux besoins d'un grand nombre de clients.  Le propri√©taire d'une telle application n'a aucune raison de se plaindre, il est confiant dans le mod√®le l√©ger de traitement simultan√© des donn√©es qu'il utilise (dans ce document, nous utilisons le mot ¬´simultan√©¬ª pour exprimer le terme ¬´simultan√©¬ª, pour le terme ¬´parall√®le¬ª - ¬´parall√®le¬ª).  Elle r√©sout parfaitement la t√¢che qui lui est confi√©e. <br><br>  Le rendu c√¥t√© serveur (SSR) modifie les id√©es de base conduisant √† une vision similaire du probl√®me.  Ainsi, le rendu du serveur n√©cessite beaucoup de ressources informatiques.  Le code dans l'environnement Node.js est ex√©cut√© dans un seul thread, par cons√©quent, pour r√©soudre les probl√®mes de calcul (contrairement aux t√¢ches d'E / S), le code peut √™tre ex√©cut√© simultan√©ment, mais pas en parall√®le.  La plate-forme Node.js est capable de g√©rer un grand nombre d'op√©rations d'E / S parall√®les, mais en ce qui concerne l'informatique, la situation change. <br><br>  √âtant donn√© que lors de l'application du rendu c√¥t√© serveur, la partie informatique de la t√¢che de traitement des demandes augmente par rapport √† la partie li√©e aux entr√©es / sorties, les demandes entrantes affecteront simultan√©ment la vitesse de r√©ponse du serveur car elles se disputent les ressources du processeur.  Il convient de noter que lors de l'utilisation du rendu asynchrone, la concurrence pour les ressources est toujours pr√©sente.  Le rendu asynchrone r√©sout la r√©activit√© d'un processus ou d'un navigateur, mais n'am√©liore pas la situation avec des retards ou des acc√®s simultan√©s.  Dans cet article, nous nous concentrerons sur un mod√®le simple qui inclut exclusivement des charges de calcul.  Si nous parlons d'une charge mixte, qui comprend √† la fois des op√©rations d'entr√©e / sortie et de calcul, les demandes entrantes simultan√©es augmenteront le d√©lai, mais en tenant compte de l'avantage d'un d√©bit syst√®me plus √©lev√©. <br><br>  Consid√©rons une commande de la forme <code>Promise.all([fn1, fn2])</code> .  Si <code>fn1</code> ou <code>fn2</code> sont des promesses r√©solues par le sous-syst√®me d'E / S, alors pendant l'ex√©cution de cette commande, il est possible de r√©aliser l'ex√©cution parall√®le des op√©rations.  Cela ressemble √† ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/96e/6f8/d81/96e6f8d8187475775542576cabbc51ca.png"></div><br>  <i><font color="#999999">Ex√©cution parall√®le d'op√©rations au moyen du sous-syst√®me d'entr√©e / sortie</font></i> <br><br>  Si <code>fn1</code> et <code>fn2</code> sont des t√¢ches de calcul, elles seront ex√©cut√©es comme suit: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8e8/03d/803/8e803d80347cb302f3e86af0bbcd1e84.png"></div><br>  <i><font color="#999999">T√¢ches informatiques</font></i> <br><br>  L'une des op√©rations devra attendre la fin de la deuxi√®me op√©ration, car il n'y a qu'un seul thread dans Node.js. <br><br>  Dans le cas du rendu du serveur, ce probl√®me se produit lorsque le processus serveur doit traiter plusieurs demandes simultan√©es.  Le traitement de ces demandes sera retard√© jusqu'√† ce que les demandes re√ßues plus t√¥t soient trait√©es.  Voici √† quoi √ßa ressemble. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/135/03e/54f/13503e54f4aa44cd1481c0848e7406c7.png"></div><br>  <i><font color="#999999">Traitement des demandes simultan√©es</font></i> <br><br>  En pratique, le traitement des demandes se compose souvent de nombreuses phases asynchrones, m√™me si elles impliquent une charge de calcul importante sur le syst√®me.  Cela peut conduire √† une situation encore plus difficile avec l'alternance des t√¢ches de traitement de telles demandes. <br><br>  Supposons que nos requ√™tes soient compos√©es d'une cha√Æne de t√¢ches qui ressemble √† celle-ci: <code>renderPromise().then(out =&gt; formatResponsePromise(out)).then(body =&gt; res.send(body))</code> .  Lorsqu'une paire de ces demandes arrive dans le syst√®me, avec un petit intervalle entre elles, nous pouvons observer l'image suivante. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/958/ecf/070/958ecf0704405b06a60e230631ac7730.png"></div><br>  <i><font color="#999999">Traitement des demandes qui arrivent √† un petit intervalle, le probl√®me de la lutte pour les ressources processeur</font></i> <br><br>  Dans ce cas, il faut environ deux fois plus de temps pour traiter chaque demande que pour traiter une demande individuelle.  Avec une augmentation du nombre de demandes trait√©es simultan√©ment, la situation devient encore pire. <br><br>  De plus, l'un des objectifs typiques de l'impl√©mentation SSR est la possibilit√© d'utiliser le m√™me code ou un code tr√®s similaire sur le client et le serveur.  La diff√©rence s√©rieuse entre ces environnements est que l'environnement client est essentiellement un environnement dans lequel un client fonctionne, et les environnements de serveur, par leur nature, sont des environnements multi-clients.  Ce qui fonctionne bien sur le client, comme les singletones ou d'autres approches pour stocker l'√©tat global de l'application, entra√Æne des erreurs, des fuites de donn√©es et, en g√©n√©ral, de la confusion, lors du traitement de nombreuses demandes arrivant sur le serveur. <br><br>  Ces fonctionnalit√©s deviennent des probl√®mes dans une situation o√π vous devez traiter plusieurs demandes en m√™me temps.  Tout fonctionne g√©n√©ralement normalement sous des charges plus faibles dans un environnement confortable de l'environnement de d√©veloppement, qui est utilis√© par un client en la personne d'un programmeur. <br><br>  Cela conduit √† une situation tr√®s diff√©rente des exemples d'application Node.js classiques.  Il convient de noter que nous utilisons le runtime JavaScript pour l'ensemble riche de biblioth√®ques disponibles, et en raison du fait qu'il est pris en charge par les navigateurs, et non pour le bien de son mod√®le pour le traitement simultan√© des donn√©es.  Dans cette application, le mod√®le asynchrone de traitement simultan√© des donn√©es pr√©sente tous ses inconv√©nients, non compens√©s par des avantages, qui sont soit tr√®s peu nombreux soit pas du tout. <br><br><h2>  <font color="#3AC1EF">Tutoriels sur le projet Hypernova</font> </h2><br>  Notre nouveau service de rendu, Hyperloop, sera le principal service avec lequel les utilisateurs d'Airbnb interagiront.  Par cons√©quent, sa fiabilit√© et ses performances jouent un r√¥le crucial pour garantir la commodit√© de travailler avec une ressource.  Lors de l'introduction d'Hyperloop en production, nous tenons compte de l'exp√©rience que nous avons acquise en travaillant avec notre syst√®me de rendu de serveur ant√©rieur - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hypernova</a> . <br><br>  Hypernova ne fonctionne pas comme notre nouveau service.  Il s'agit d'un pur syst√®me de rendu.  Il est appel√© √† partir de notre service ferroviaire monolithique, appel√© Monorail, et renvoie uniquement des extraits HTML pour des composants de rendu sp√©cifiques.  Dans de nombreux cas, cet ¬´extrait¬ª repr√©sente la part du lion de la page, et Rails fournit uniquement la mise en page.  Avec la technologie h√©rit√©e, des parties d'une page peuvent √™tre li√©es entre elles √† l'aide d'ERB.  Dans tous les cas, cependant, Hypernova ne charge pas les donn√©es n√©cessaires pour former la page.  C'est la t√¢che de Rails. <br><br>  Ainsi, Hyperloop et Hypernova ont des performances informatiques similaires.  Dans le m√™me temps, Hypernova, en tant que service de production et traitant d'importants volumes de trafic, fournit un bon terrain pour les tests, ce qui permet de comprendre comment le rempla√ßant Hypernova se comportera dans des conditions de combat. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cee/51a/2f7/cee51a2f7e198d242ce8e5294f4e972f.png"></div><br>  <i><font color="#999999">Flux de travail Hypernova</font></i> <br><br>  Voici comment fonctionne Hypernova.  Les demandes des utilisateurs proviennent de notre application principale Rails, Monorail, qui collecte les propri√©t√©s des composants React qui doivent √™tre affich√©s sur une page et fait une demande √† Hypernova, en passant ces propri√©t√©s et noms de composants.  Hypernova rend les composants avec des propri√©t√©s afin de g√©n√©rer le code HTML qui doit √™tre renvoy√© √† l'application Monorail, qui int√®gre ensuite ce code dans le mod√®le de page et le renvoie tout au client. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86d/d7d/35b/86dd7d35b582f66de058a0aa60f5ad0a.png"></div><br>  <i><font color="#999999">Envoi d'une page termin√©e √† un client</font></i> <br><br>  En cas d'urgence (cela peut √™tre une erreur ou le d√©lai de r√©ponse) dans Hypernova, il existe une option de secours, lors de l'utilisation des composants et de leurs propri√©t√©s qui sont incorpor√©s dans la page sans le HTML g√©n√©r√© sur le serveur, apr√®s quoi tout cela est envoy√© au client et rendu l√†-bas esp√©rons-le r√©ussi.  Cela nous a amen√©s √† consid√©rer que le service Hypernova n'√©tait pas un √©l√©ment essentiel du syst√®me.  Par cons√©quent, nous pourrions permettre la survenance d'un certain nombre d'√©checs et de situations dans lesquelles un d√©lai d'attente est d√©clench√©.  En ajustant les d√©lais d'expiration des demandes, nous, en nous basant sur les observations, les avons r√©gl√©s √† environ le niveau P95.  Par cons√©quent, il n'est pas surprenant que le syst√®me ait fonctionn√© avec un taux de r√©ponse de temporisation de base inf√©rieur √† 5%. <br><br>  Dans les situations o√π le trafic a atteint des valeurs de pointe, nous avons pu constater que jusqu'√† 40% des demandes √† Hypernova √©taient ferm√©es par des d√©lais d'attente dans le monorail.  Du c√¥t√© d'Hypernova, nous avons vu des pics de <code>BadRequestError: Request aborted</code> hauteur inf√©rieure.  De plus, ces erreurs existaient dans des conditions normales, tandis qu'en fonctionnement normal, en raison de l'architecture de la solution, les erreurs restantes n'√©taient pas particuli√®rement visibles. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/746/8c1/192/7468c11924fcf883eb3a6e73c734a263.png"></div><br>  <i><font color="#999999">Valeurs de d√©lai maximal (lignes rouges)</font></i> <br><br>  Comme notre syst√®me pouvait fonctionner sans Hypernova, nous n'avons pas pr√™t√© beaucoup d'attention √† ces fonctionnalit√©s, elles √©taient per√ßues davantage comme des bagatelles g√™nantes que comme de graves probl√®mes.  Nous avons expliqu√© ces probl√®mes par les fonctionnalit√©s de la plate-forme, car le lancement de l'application est lent en raison de l'op√©ration de r√©cup√©ration de place initiale assez difficile, en raison des particularit√©s de la compilation de code et de la mise en cache des donn√©es, et pour d'autres raisons.  Nous avions esp√©r√© que les nouvelles versions de React ou Node incluraient des am√©liorations de performances qui att√©nueraient les lacunes du lent lancement du service. <br><br>  Je soup√ßonnais que ce qui se passait √©tait tr√®s probablement le r√©sultat d'un mauvais √©quilibrage de charge ou la cons√©quence de probl√®mes dans le d√©ploiement de la solution, lorsque des retards croissants se manifestaient en raison d'une charge de calcul excessive sur les processus.  J'ai ajout√© une couche auxiliaire au syst√®me pour enregistrer des informations sur le nombre de demandes trait√©es simultan√©ment par des processus individuels, ainsi que pour enregistrer les cas dans lesquels le processus a re√ßu plus d'une demande de traitement. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ce1/5c2/70c/ce15c270c4ccdcd301f40fad7312e769.png"></div><br>  <i><font color="#999999">R√©sultats de recherche</font></i> <br><br>  Nous avons consid√©r√© que le d√©marrage lent du service √©tait √† l'origine des retards, mais en fait, le probl√®me √©tait d√ª √† des demandes parall√®les luttant pour le temps CPU.  Selon les r√©sultats des mesures, il s'est av√©r√© que le temps pass√© par la demande en pr√©vision de l'ach√®vement du traitement des autres demandes correspond au temps pass√© √† traiter la demande.  De plus, cela signifiait qu'une augmentation des retards due au traitement simultan√© des demandes ressemble √† une augmentation des retards due √† une augmentation de la complexit√© de calcul du code, ce qui entra√Æne une augmentation de la charge sur le syst√®me lors du traitement de chaque demande. <br><br>  De plus, cela rendait plus √©vident que l' <code>BadRequestError: Request aborted</code> ne pouvait pas √™tre expliqu√©e en toute confiance par un d√©marrage lent du syst√®me.  L'erreur provenait du code d'analyse du corps de la demande et s'est produite lorsque le client a annul√© la demande avant que le serveur ne puisse lire enti√®rement le corps de la demande.  Le client a cess√© de fonctionner, a ferm√© la connexion, nous privant des donn√©es n√©cessaires pour poursuivre le traitement de la demande.  Il est beaucoup plus probable que cela se soit produit car nous avons commenc√© √† traiter la demande, apr√®s quoi la boucle d'√©v√©nement s'est av√©r√©e √™tre un rendu bloqu√© pour une autre demande, puis nous sommes revenus √† la t√¢che interrompue pour la terminer, mais il s'est av√©r√© que le client qui nous a envoy√© cette demande s'est d√©j√† d√©connect√©, abandonnant la demande.  En outre, les donn√©es transmises dans les demandes adress√©es √† Hypernova √©taient assez volumineuses, en moyenne, de l'ordre de plusieurs centaines de kilo-octets, ce qui, bien entendu, n'a pas contribu√© √† am√©liorer la situation. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b4/b62/bc6/0b4b62bc6a1b5e902413711b0d3272e0.png"></div><br>  <i><font color="#999999">Une erreur caus√©e par la d√©connexion d'un client qui n'a pas attendu de r√©ponse</font></i> <br><br>  Nous avons d√©cid√© de r√©soudre ce probl√®me en utilisant quelques outils standard avec lesquels nous avions une exp√©rience consid√©rable.  Nous parlons d'un serveur proxy inverse ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nginx</a> ) et d'un √©quilibreur de charge ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HAProxy</a> ). <br><br><h2>  <font color="#3AC1EF">Proxy inverse et √©quilibrage de charge</font> </h2><br>  Afin de tirer parti de l'architecture de processeur multic≈ìur, nous ex√©cutons plusieurs processus Hypernova √† l'aide du module de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cluster</a> Node.js int√©gr√©.  √âtant donn√© que ces processus sont ind√©pendants, nous pouvons traiter simultan√©ment les demandes entrantes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9df/cbe/aae/9dfcbeaae2d82fa13007670288d8b461.png"></div><br>  <i><font color="#999999">Traitement parall√®le des demandes arrivant simultan√©ment</font></i> <br><br>  Le probl√®me ici est que chaque processus Node est compl√®tement occup√© tout le temps n√©cessaire pour traiter une demande, y compris la lecture du corps de la demande envoy√©e par le client (Monorail joue son r√¥le dans ce cas).  Bien que nous puissions lire plusieurs requ√™tes en un seul processus en m√™me temps, en ce qui concerne le rendu, cela conduit √† une alternance d'op√©rations de calcul. <br><br>  L'utilisation des ressources de processus Node est li√©e √† la vitesse du client et du r√©seau. <br><br>  Pour r√©soudre ce probl√®me, nous pouvons envisager un serveur proxy inverse de mise en m√©moire tampon, qui nous permettra de maintenir des sessions de communication avec les clients.  Cette id√©e a √©t√© inspir√©e par le serveur Web licorne, que nous utilisons pour nos applications Rails.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les principes</a> d√©clar√©s par la licorne expliquent parfaitement pourquoi il en est ainsi.  Pour cela, nous avons utilis√© nginx.  Nginx lit la demande du client vers le tampon et transmet la demande au serveur Node uniquement apr√®s sa lecture compl√®te.  Cette session de transfert de donn√©es est effectu√©e sur la machine locale, via l'interface de bouclage ou √† l'aide de sockets de domaine Unix, et cela est beaucoup plus rapide et plus fiable que le transfert de donn√©es entre des ordinateurs distincts. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a20/50e/77b/a2050e77b5ff48219773729978481244.png"></div><br>  <i><font color="#999999">Nginx met en m√©moire tampon les demandes, puis les envoie au serveur Node</font></i> <br><br>  √âtant donn√© que nginx est d√©sormais engag√© dans la lecture des demandes, nous avons pu obtenir un chargement plus uniforme des processus Node. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bea/eb0/875/beaeb08758e4926cb3072670993f606f.png"></div><br>  <i><font color="#999999">Chargement de processus uniforme √† l'aide de nginx</font></i> <br><br>  De plus, nous avons utilis√© nginx pour g√©rer certaines requ√™tes qui ne n√©cessitent pas d'acc√®s aux processus Node.  La couche de d√©tection et de routage de notre service utilise des requ√™tes <code>/ping</code> qui ne cr√©ent pas une charge importante sur le syst√®me pour v√©rifier la communication entre les h√¥tes.  Le traitement de tout cela dans nginx √©limine une source importante de charge de travail suppl√©mentaire (quoique petite) pour Node.js. <br><br>  La prochaine am√©lioration concerne l'√©quilibrage de charge.  Nous devons prendre des d√©cisions √©clair√©es sur la r√©partition des demandes entre les processus Node.  Le module de <code>cluster</code> distribue les requ√™tes conform√©ment √† l'algorithme round-robin, dans la plupart des cas avec des tentatives de contournement des processus qui ne r√©pondent pas aux requ√™tes.  Avec cette approche, chaque processus re√ßoit une demande par ordre de priorit√©. <br><br>  Le module de <code>cluster</code> distribue les connexions, pas les requ√™tes, donc tout cela ne fonctionne pas comme nous en avons besoin.  La situation devient encore pire lorsque des connexions persistantes sont utilis√©es.  Toute connexion permanente du client est li√©e √† un seul flux de travail sp√©cifique, ce qui complique la distribution efficace des t√¢ches. <br><br>  L'algorithme √† tour de r√¥le est bon lorsqu'il existe une faible variabilit√© dans les d√©lais de demande.  Par exemple, dans la situation illustr√©e ci-dessous. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/883/4f2/ed5/8834f2ed56f7410de5f306f15e66e5e9.png"></div><br>  <i><font color="#999999">Algorithme de tourniquet et connexions via lesquelles les demandes sont re√ßues de mani√®re stable</font></i> <br><br>  Cet algorithme n'est d√©j√† pas si bon lorsque vous devez traiter des demandes de diff√©rents types, pour le traitement desquelles des co√ªts de temps compl√®tement diff√©rents peuvent √™tre n√©cessaires.  La demande la plus r√©cente envoy√©e √† un certain processus est oblig√©e d'attendre la fin du traitement de toutes les demandes envoy√©es plus t√¥t, m√™me s'il existe un autre processus qui a la capacit√© de traiter une telle demande. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/037/381/8c8/0373818c8632668b96f2ae77c32c9be2.png"></div><br>  <i><font color="#999999">Charge de processus in√©gale</font></i> <br><br>  Si vous distribuez les requ√™tes ci-dessus de mani√®re plus rationnelle, vous obtenez quelque chose comme celle illustr√©e dans la figure ci-dessous. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/944/8a3/b32/9448a3b328094d81d73480e6b0e9d6d6.png"></div><br>  <i><font color="#999999">R√©partition rationnelle des demandes par threads</font></i> <br><br>  Avec cette approche, l'attente est minimis√©e et il devient possible d'envoyer des r√©ponses aux demandes plus rapidement. <br><br>  Cela peut √™tre r√©alis√© en pla√ßant les demandes dans une file d'attente et en les affectant √† un processus uniquement lorsqu'il n'est pas occup√© √† traiter une autre demande.  Pour cela, nous utilisons HAProxy. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fda/2cc/367/fda2cc367f401ef351cad7bff55a13ea.png"></div><br>  <i><font color="#999999">HAProxy et √©quilibrage de charge de processus</font></i> <br><br>  Lorsque nous avons utilis√© HAProxy pour √©quilibrer la charge sur Hypernova, nous avons compl√®tement √©limin√© les pics de temporisation, ainsi que les erreurs <code>BadRequestErrors</code> . <br><br>  Les demandes simultan√©es ont √©galement √©t√© la principale cause de retards en fonctionnement normal; cette approche a r√©duit ces retards.  L'une des cons√©quences de cela √©tait que d√©sormais seulement 2% des demandes √©taient ferm√©es par timeout, et non 5%, avec les m√™mes param√®tres de timeout.  Le fait que nous soyons parvenus √† passer d'une situation avec 40% d'erreurs √† une situation avec un timeout d√©clenchant dans 2% des cas montre que nous allons dans la bonne direction.  Par cons√©quent, nos utilisateurs voient aujourd'hui l'√©cran de chargement du site Web beaucoup moins fr√©quemment.  Il convient de noter que la stabilit√© du syst√®me sera d'une importance particuli√®re pour nous avec la transition attendue vers un nouveau syst√®me qui n'a pas le m√™me m√©canisme de sauvegarde qu'Hypernova. <br><br><h2>  <font color="#3AC1EF">D√©tails sur le syst√®me et ses param√®tres</font> </h2><br>  Pour que tout cela fonctionne, vous devez configurer l'application nginx, HAProxy et Node.  Voici <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un exemple d'une</a> application similaire utilisant nginx et HAProxy, analysant laquelle, vous pouvez comprendre le p√©riph√©rique du syst√®me en question.  Cet exemple est bas√© sur le syst√®me que nous utilisons en production, mais il est simplifi√© et modifi√© afin qu'il puisse √™tre ex√©cut√© au premier plan pour le compte d'un utilisateur non privil√©gi√©.  En production, tout doit √™tre configur√© √† l'aide d'une sorte de superviseur (nous utilisons runit, ou, plus souvent, kubernetes). <br><br>  <a href="">La configuration nginx est</a> assez standard, elle utilise un serveur qui √©coute sur le port 9000, configur√© pour des requ√™tes proxy au serveur HAProxy, qui √©coute sur le port 9001 (dans notre configuration, nous utilisons des sockets de domaine Unix). <br><br>  De plus, ce serveur intercepte les requ√™tes vers le point de terminaison <code>/ping</code> pour traiter directement les requ√™tes visant √† v√©rifier la connectivit√© r√©seau.         nginx ,     <code>worker_processes</code>  1,     nginx ‚Äî           HAProxy  Node-.  ,       ,    ,  Hypernova,     ( ).             . <br><br>  Node.js <code>cluster</code>        .        HAProxy,        <code>cluster</code> ,    .        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pool-hall</a> .  ‚Äî ,        ,   ,   <code>cluster</code> ,        .  <a href=""></a>   <code>pool-hall</code>     ,      . <br><br>  <a href=""> HAProxy</a> ,     9001       ,    9002  9005.     ‚Äî <code>maxconn 1</code> ,     .          .       HAProxy (    8999). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/232/d95/515/232d95515b1541bccfab440f8fe12cc8.png"></div><br> <i><font color="#999999">  HAProxy</font></i> <br><br> HAProxy            .    ,    <code>maxconn</code> .    <code>static-rr</code> (static round-robin),  ,  ,       .   ,      round-robin, ,        , ,   ,     .     ,          ,   .      . <br><br> ,       ,        .       (   ).         ,   ,     ,   ,     .  ,                   ,        . <br><br><h2> <font color="#3AC1EF">  HAProxy</font> </h2><br>         HAProxy.       ,         ,    ,               .  ,    ,    (  )   .      ,        ,    <code>cluster</code> .     ,    . <br><br>       <code>ab</code> (Apache Benchmark)   10000   .       -   .       : <br><br><pre> <code class="hljs powershell">ab <span class="hljs-literal"><span class="hljs-literal">-l</span></span> <span class="hljs-literal"><span class="hljs-literal">-c</span></span> &lt;CONCURRENCY&gt; <span class="hljs-literal"><span class="hljs-literal">-n</span></span> <span class="hljs-number"><span class="hljs-number">10000</span></span> http://&lt;HOSTNAME&gt;:<span class="hljs-number"><span class="hljs-number">9000</span></span>/render</code> </pre> <br>     15    4-  -,    <code>ab</code>     ,        .       ( <code>concurrency=5</code> ),    ( <code>concurrency=13</code> ),     ,        ( <code>concurrency=20</code> ).      ,      . <br><br>         ,  -,      .          ,      .       ,  ,   ,     ,       .  ,     ,       ,     . <br><br>    ,   ‚Äî      . <br><br>     <code>maxconn 1</code>     ,  ,         . <br><br>      HTTP  TCP  ,    ,     ,  .   ,      <code>maxconn</code> ,       .     ,            ,          (, ,    ). <br><br>  ,         , ,   ,  ,      ,       . <br><br>    ‚Äî  ,     .    <code>option redispatch</code>    <code>retries 3</code> ,    ,          ,   , ,    ,   .            . <br><br>     ,  - ,       .        ,       .   ,          ,     .     100    ,        10 ,    ,    .        ,      .   ,            <code>accept</code> . <br><br>      ,        ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">backlog</a> )    ,    .       SYN-ACK ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> ,   , ,        ACK  ).      ,      ,     ,       ,      . <br><br>      ,   ,    ,   ,       .    ,       ,      1.   <code>maxconn</code>                .     0  ,   ,     ,  ,           ,     .       ,     .         -  ,      ,         .  <code>abortonclose</code>        ,    .  ,        <code>abortonclose</code> .            nginx. <br><br>  ,     ,    .       (    )   ,       ,        ,     ,       ,  .  HAProxy          ,      ,        (       ).               ,     ,         ,    HTML.          ,   ,       .  ,       ,       (     ,  ,     ).            ,   ,            .   ,  ,   ,  .           HAProxy,            MAINT    HAProxy. <br><br>   ,     ,   ,  <code>server.close</code>  Node.js    ,     HAProxy   ,       ,      ,      .     ,     ,       ,     ,   ,     . <br><br>  ,  ,    <code>balance first</code> ,           (   <code>worker1</code> )        15%   ,    ,   ,     <code>balance static-rr</code> .        ,       ¬´¬ª .      .     (12 ),  , , -      .   ,  ,       ,   ¬´¬ª     ¬´¬ª.        . <br><br> , ,      Node <code>server.maxconnections</code> , ( ,   ),   ,  ,   ,         .        ,    <code>maxconnection</code> ,      ,  ,    .     JavaScript,          (        ).  ,    ,        ,          .  ,     ,   ,      HAProxy  Node    ,       .     ,        ,         . <br><br>   ,      ,   , , <a href=""></a> . <br><br><h2> <font color="#3AC1EF"></font> </h2><br>     Node.js      .     , , ,    -.      Node.js    .   , ,       ,    ,   ,        , ,  nginx  HAProxy. <br><br> ,   Airbnb  ,   Node.js     . <br><br>  <b>Chers lecteurs!</b>        ? <br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418009/">https://habr.com/ru/post/fr418009/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr417997/index.html">Commencez par vous-m√™me, ou 60 jours Kubuntu</a></li>
<li><a href="../fr417999/index.html">Anglais: perspective de l'ing√©nieur</a></li>
<li><a href="../fr418001/index.html">5 mod√®les de travail d'√©quipe efficace</a></li>
<li><a href="../fr418005/index.html">Les d√©veloppeurs de logiciels ne sont pas d'accord avec la d√©finition de ¬´mat√©riel sp√©cial¬ª du FSB</a></li>
<li><a href="../fr418007/index.html">D√©veloppement multiplateforme avec .NET, programmation r√©active, mod√®le MVVM et g√©n√©ration de code</a></li>
<li><a href="../fr418011/index.html">Pages uniques et r√©f√©rencement. Secrets d'optimisation</a></li>
<li><a href="../fr418013/index.html">Intel Core i7-8086K (partie 3)</a></li>
<li><a href="../fr418015/index.html">Nouveau Vasyuki. D√©veloppement innovant de Moscou jusqu'en 2100</a></li>
<li><a href="../fr418017/index.html">Analyse du comportement du cheval de Troie Pegasus sur le r√©seau</a></li>
<li><a href="../fr418023/index.html">Les pointeurs en C sont plus abstraits que vous ne le pensez</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>