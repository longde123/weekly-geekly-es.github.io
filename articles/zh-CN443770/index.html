<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👋🏾 🕒 🛌🏼 域驱动设计：实践中的价值对象和实体框架核心 👼🏼 👨🏽‍🎤 📰</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在Habré上，不仅撰写了很多有关域驱动设计的文章，包括有关体系结构的一般性文章，以及有关.Net的示例。 但是与此同时，经常很少提及该体系结构中像Value Objects这样重要的部分。 

 在本文中，我将尝试发现使用实体框架核心在.Net Core中实现值对象的细微差别。 

 在猫下，有很...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>域驱动设计：实践中的价值对象和实体框架核心</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443770/"> 在Habré上，不仅撰写了很多有关域驱动设计的文章，包括有关体系结构的一般性文章，以及有关.Net的示例。 但是与此同时，经常很少提及该体系结构中像Value Objects这样重要的部分。 <br><br> 在本文中，我将尝试发现使用实体框架核心在.Net Core中实现值对象的细微差别。 <br><br> 在猫下，有很多代码。 <br><a name="habracut"></a><br><h2> 一点理论 </h2><br> 域驱动设计的体系结构的核心是<b>域</b> -要开发的软件所应用的主题领域。 这是应用程序的整个业务逻辑，通常与各种数据交互。 数据可以有两种类型： <br><br><ul><li> 实体对象 </li><li> 值对象（以下称为VO） </li></ul><br>  <b>实体对象</b>在业务逻辑中定义一个实体，并且始终具有一个标识符，通过该标识符可以找到该实体或将其与另一个实体进行比较。 如果两个实体具有相同的标识符，则这是相同的实体。 几乎总是在变化。 <br>  <b>值对象</b>是一种不可变的类型，其值在创建过程中设置，并且在对象的整个生命周期中都不会改变。 它没有标识符。 如果两个VO在结构上相同，则它们是等效的。 <br><br> 实体可以包含其他实体和VO。  VO可以包括其他VO，但不包括实体。 <br><br> 因此，域逻辑应仅与Entity和VO配合使用-这保证了其一致性。 基本数据类型，例如字符串，整数等。 通常，它们不能充当VO，因为它们可以简单地违反域的状态-这在DDD框架中几乎是一场灾难。 <br><br> 一个例子。 在各种手册中，经常让每个人都讨厌的Person类如下所示： <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Person</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Age { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br> 简单明了-标识符，名称和年龄，您在哪里可以犯错误？ <br><br> 而且这里可能存在一些错误-例如，从业务逻辑的角度来看，名称是强制性的，名称不能为零长度或超过100个字符，并且不应包含特殊字符，标点符号等。 年龄不能小于10或大于120岁。 <br><br> 从编程语言的角度来看，5是一个完全正常的整数，类似地是一个空字符串。 但是域已经处于错误状态。 <br><br><h2> 让我们继续练习 </h2><br> 至此，我们知道VO必须是不可变的，并且包含对业务逻辑有效的值。 <br><br> 通过在创建对象时初始化readonly属性来实现免疫。 <br> 值的验证发生在构造函数（Guard子句）中。 希望使验证本身可以公开使用-以便其他层可以验证从客户端（同一浏览器）接收到的数据。 <br><br> 让我们为姓名和年龄创建一个VO。 此外，我们将任务复杂化了-添加一个将FirstName和LastName组合在一起的PersonalName，并将其应用于Person。 <br><br><div class="spoiler">  <b class="spoiler_title">名称</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Name</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Regex ValidationRegex = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Regex( <span class="hljs-string"><span class="hljs-string">@"^[\p{L}\p{M}\p{N}]{1,100}\z"</span></span>, RegexOptions.Singleline | RegexOptions.Compiled); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Name</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsValid(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"Name is not valid"</span></span>); } Value = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsValid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !String.IsNullOrWhiteSpace(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) &amp;&amp; ValidationRegex.IsMatch(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equals</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Object obj</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Name other &amp;&amp; StringComparer.Ordinal.Equals(Value, other.Value); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Int32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetHashCode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> StringComparer.Ordinal.GetHashCode(Value); } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">人名</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PersonalName</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PersonalName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PersonalName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Name firstName, Name lastName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstName == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(firstName)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastName == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(lastName)); } FirstName = firstName; LastName = lastName; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Name FirstName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Name LastName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String FullName =&gt; <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{FirstName}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{LastName}</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equals</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Object obj</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> PersonalName personalName &amp;&amp; EqualityComparer&lt;Name&gt;.Default.Equals(FirstName, personalName.FirstName) &amp;&amp; EqualityComparer&lt;Name&gt;.Default.Equals(LastName, personalName.LastName); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Int32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetHashCode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HashCode.Combine(FirstName, LastName); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FullName; } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">年龄</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Age</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Age</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Int32 </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsValid(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"Age is not valid"</span></span>); } Value = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Int32 Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsValid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Int32 </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> &lt;= <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">120</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equals</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Object obj</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Age other &amp;&amp; Value == other.Value; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Int32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetHashCode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Value.GetHashCode(); } }</code> </pre> <br></div></div><br> 最后是人： <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Person</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Person</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PersonalName personalName, Age age</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (personalName == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(personalName)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (age == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(age)); } Id = Guid.NewGuid(); PersonalName= personalName; Age = age; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Guid Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PersonalName PersonalName{ <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Age Age { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br> 因此，我们无法创建没有全名或年龄的人。 同样，我们不能创建“错误”名称或“错误”年龄。 一个好的程序员肯定会使用Name.IsValid（“ John”）和Age.IsValid（35）方法在控制器中检查接收到的数据，并在数据不正确的情况下将这一情况通知客户。 <br><br> 如果我们在模型中的任何地方制定一条仅使用实体和VO的规则，那么我们将保护自己免受大量错误的侵害-错误的数据根本不会进入模型。 <br><br><h2> 坚持不懈 </h2><br> 现在，我们需要将我们的数据保存在数据仓库中，并根据需要获取它。 我们将使用实体框架核心作为ORM，数据仓库为MS SQL Server。 <br><br>  DDD明确定义：持久性是基础结构层的一个子类，因为它隐藏了数据访问的特定实现。 <br><br> 该域不需要了解有关持久性的任何信息，这仅决定存储库的接口。 <br><br> 持久性包含特定的实现，映射配置以及UnitOfWork对象。 <br><br> 是否值得创建存储库和工作单元有两种意见。 <br><br> 一方面-不，没有必要，因为在Entity Framework Core中，这已经全部实现。 如果我们具有基于数据存储的DAL-&gt;业务逻辑-&gt;表示形式的多级体系结构，那么为什么不直接使用EF Core的功能。 <br><br> 但是DDD中的域并不依赖于数据存储和所用的ORM，这些都是实现的精妙之处，它们封装在Persistence中，其他任何人都不会感兴趣。 如果我们将DbContext提供给其他层，那么我们将立即公开实现细节，将其紧密绑定到所选的ORM并获得DAL-作为所有业务逻辑的基础，但事实并非如此。 粗略地说，域不应注意到ORM发生了变化，甚至不应注意到持久性丧失了一层。 <br><br> 因此，域中的人员存储库接口： <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IPersons</span></span> { <span class="hljs-function"><span class="hljs-function">Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Person person</span></span></span><span class="hljs-function">)</span></span>; Task&lt;IReadOnlyList&lt;Person&gt;&gt; GetList(); }</code> </pre> <br> 及其在持久性中的实现： <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EfPersons</span></span> : <span class="hljs-title"><span class="hljs-title">IPersons</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> PersonsDemoContext _context; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EfPersons</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">UnitOfWork unitOfWork</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unitOfWork == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(unitOfWork)); } _context = unitOfWork.Context; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Person person</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (person == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(person)); } <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _context.Persons.AddAsync(person); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> Task&lt;IReadOnlyList&lt;Person&gt;&gt; GetList() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _context.Persons.ToListAsync(); } }</code> </pre> <br> 似乎没有什么复杂的，但是有一个问题。 开箱即用的Entity Framework Core仅适用于基本类型（字符串，整数，日期时间等），并且对PersonalName和Age不了解。 让我们教EF Core了解我们的价值目标。 <br><br><h2> 构型 </h2><br>  Fluent API最适合在DDD中配置实体。 属性不合适，因为域不需要了解有关映射细微差别的任何信息。 <br><br> 使用基本配置PersonConfiguration在Persistence中创建一个类： <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PersonConfiguration</span></span> : <span class="hljs-title"><span class="hljs-title">IEntityTypeConfiguration</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Person</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EntityTypeBuilder&lt;Person&gt; builder</span></span></span><span class="hljs-function">)</span></span> { builder.ToTable(<span class="hljs-string"><span class="hljs-string">"Persons"</span></span>); builder.HasKey(p =&gt; p.Id); builder.Property(p =&gt; p.Id).ValueGeneratedNever(); } }</code> </pre> <br> 并将其插入DbContext中： <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnModelCreating</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ModelBuilder builder</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnModelCreating(builder); builder.ApplyConfiguration(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PersonConfiguration()); }</code> </pre> <br><h2> 制图 </h2><br> 编写本材料的部分。 <br><br> 目前，有两种或多或少的便捷方法可将非标准类映射到基本类型-值转换和拥有的类型。 <br><br><h3> 价值转换 </h3><br> 此功能出现在Entity Framework Core 2.1中，使您可以确定两种数据类型之间的转换。 <br><br> 让我们为Age编写转换器（在本节中，所有代码都在PersonConfiguration中）： <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ageConverter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValueConverter&lt;Age, Int32&gt;( v =&gt; v.Value, v =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Age(v)); builder .Property(p =&gt; p.Age) .HasConversion(ageConverter) .HasColumnName(<span class="hljs-string"><span class="hljs-string">"Age"</span></span>) .HasColumnType(<span class="hljs-string"><span class="hljs-string">"int"</span></span>) .IsRequired();</code> </pre><br> 简单简洁的语法，但并非没有缺陷： <br><br><ol><li> 无法转换为null； </li><li> 无法将单个属性转换为表中的多个列，反之亦然； </li><li>  EF Core无法将具有此属性的LINQ表达式转换为SQL查询。 </li></ol><br> 我将更详细地讨论最后一点。 向存储库中添加一个方法，该方法返回给定年龄的Person列表： <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> Task&lt;IReadOnlyList&lt;Person&gt;&gt; GetOlderThan(Age age) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (age == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(age)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _context.Persons .Where(p =&gt; p.Age.Value &gt; age.Value) .ToListAsync(); }</code> </pre> <br> 年龄是有条件的，但是EF Core将无法将其转换为SQL查询，并且到达Where（）时，它将把整个表加载到应用程序内存中，只有使用LINQ，它才能满足条件p.Age.Value&gt; age.Value。 。 <br><br> 通常，“值转换”是一个简单而快速的映射选项，但您需要记住EF Core的此功能，否则，在某些时候，查询大表时，内存可能会用完。 <br><br><h3> 所属类型 </h3><br> 拥有的类型出现在Entity Framework Core 2.0中，并取代了常规Entity Framework中的“复杂类型”。 <br><br> 让我们将年龄设置为拥有类型： <br><br><pre> <code class="cs hljs">builder.OwnsOne(p =&gt; p.Age, a =&gt; { a.Property(u =&gt; u.Value).HasColumnName(<span class="hljs-string"><span class="hljs-string">"Age"</span></span>); a.Property(u =&gt; u.Value).HasColumnType(<span class="hljs-string"><span class="hljs-string">"int"</span></span>); a.Property(u =&gt; u.Value).IsRequired(); });</code> </pre> <br> 还不错 拥有类型不具有值转换的某些缺点，即第2点和第3点。 <br><br>  2. <u>可以</u>将一个属性转换为表中的几列，反之亦然 <br><br> 您需要的PersonalName，尽管语法已经有点重载了： <br><br><pre> <code class="cs hljs">builder.OwnsOne(b =&gt; b.PersonalName, pn =&gt; { pn.OwnsOne(p =&gt; p.FirstName, fn =&gt; { fn.Property(x =&gt; x.Value).HasColumnName(<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>); fn.Property(x =&gt; x.Value).HasColumnType(<span class="hljs-string"><span class="hljs-string">"nvarchar(100)"</span></span>); fn.Property(x =&gt; x.Value).IsRequired(); }); pn.OwnsOne(p =&gt; p.LastName, ln =&gt; { ln.Property(x =&gt; x.Value).HasColumnName(<span class="hljs-string"><span class="hljs-string">"LastName"</span></span>); ln.Property(x =&gt; x.Value).HasColumnType(<span class="hljs-string"><span class="hljs-string">"nvarchar(100)"</span></span>); ln.Property(x =&gt; x.Value).IsRequired(); }); });</code> </pre> <br>  3. EF Core <u>可以</u>将具有此属性的LINQ表达式转换为SQL查询。 <br> 加载列表时添加按姓氏和名字排序： <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> Task&lt;IReadOnlyList&lt;Person&gt;&gt; GetList() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _context.Persons .OrderBy(p =&gt; p.PersonalName.LastName.Value) .ThenBy(p =&gt; p.PersonalName.FirstName.Value) .ToListAsync(); }</code> </pre> <br> 这样的表达式将正确地转换为SQL查询，并且在SQL Server端而不是在应用程序中执行排序。 <br><br> 当然，也有缺点。 <br><br><ol><li>  null的问题尚未消失。 </li><li>  “拥有的类型”字段不能为只读，并且必须具有受保护的或私有的设置器。 </li><li> 拥有的类型被实现为常规实体，这意味着： <br><ul><li> 它们有一个标识符（例如shadow属性，即它不出现在domain类中）； </li><li>  EF Core跟踪拥有类型中的所有更改，与常规实体完全相同。 </li></ul></li></ol><br> 一方面，这根本不是值对象应具有的功能。 它们不能有任何标识符。 不应跟踪VO的更改-因为它们最初是不可变的，因此应跟踪父实体的属性，而不是VO的属性。 <br><br> 另一方面，这些是可以省略的实现细节，但同样，请不要忘记。 跟踪更改会影响性能。 如果在选择单个实体（例如，按ID）或较小列表时不明显，然后对“重”实体的大列表（许多VO属性）进行采样，则由于跟踪，性能下降将非常明显。 <br><br><h2> 简报 </h2><br> 我们弄清楚了如何在域和存储库中实现值对象。 现在该使用所有内容了。 让我们创建两个简单的页面-带有“人”列表和用于添加“人”的表单。 <br><br> 没有Action方法的控制器代码如下所示： <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HomeController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IPersons _persons; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> UnitOfWork _unitOfWork; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HomeController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IPersons persons, UnitOfWork unitOfWork</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persons == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(persons)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unitOfWork == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(unitOfWork)); } _persons = persons; _unitOfWork = unitOfWork; } <span class="hljs-comment"><span class="hljs-comment">// Actions private static PersonModel CreateModel(Person person) { return new PersonModel { FirstName = person.PersonalName.FirstName.Value, LastName = person.PersonalName.LastName.Value, Age = person.Age.Value }; } }</span></span></code> </pre> <br> 添加操作以获取“人员”列表： <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HttpGet</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;IActionResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> persons = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _persons.GetList(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PersonsListModel { Persons = persons .Select(CreateModel) .ToArray() }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(result); }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">检视</b> <div class="spoiler_text"><pre> <code class="xml hljs">@model PersonsListModel @{ ViewData["Title"] = "Persons List"; } <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-center"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"display-4"</span></span></span><span class="hljs-tag">&gt;</span></span>Persons<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"table"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>Last name<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>First name<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>Age<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span><span class="hljs-tag">&gt;</span></span> @foreach (var p in Model.Persons) { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>@p.LastName<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>@p.FirstName<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>@p.Age<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> } <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></div></div><br> 没什么复杂的-我们加载了列表，为每个列表创建了一个数据传输对象（PersonModel） <br><br> 人员并发送到相应的视图。 <br><br><div class="spoiler">  <b class="spoiler_title">结果</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/-j/n0/qu/-jn0qugs50smvtry852ljdmedte.png"><br></div></div><br> 更有趣的是Person的添加： <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HttpPost</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;IActionResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPerson</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PersonModel model</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (model == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BadRequest(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Name.IsValid(model.FirstName)) { ModelState.AddModelError(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(model.FirstName), <span class="hljs-string"><span class="hljs-string">"FirstName is invalid"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Name.IsValid(model.LastName)) { ModelState.AddModelError(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(model.LastName), <span class="hljs-string"><span class="hljs-string">"LastName is invalid"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Age.IsValid(model.Age)) { ModelState.AddModelError(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(model.Age), <span class="hljs-string"><span class="hljs-string">"Age is invalid"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ModelState.IsValid) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> firstName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Name(model.FirstName); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Name(model.LastName); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> person = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Person( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PersonalName(firstName, lastName), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Age(model.Age)); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _persons.Add(person); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _unitOfWork.Commit(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> persons = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _persons.GetList(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PersonsListModel { Persons = persons .Select(CreateModel) .ToArray() }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>, result); }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">检视</b> <div class="spoiler_text"><pre> <code class="xml hljs">@model PersonDemo.Models.PersonModel @{ ViewData["Title"] = "Add Person"; } <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"display-4"</span></span></span><span class="hljs-tag">&gt;</span></span>Add Person<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"row"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"col-md-4"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AddPerson"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-validation-summary</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ModelOnly"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-danger"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-group"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"FirstName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"control-label"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"FirstName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-control"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-validation-for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"FirstName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-danger"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-group"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LastName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"control-label"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LastName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-control"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-validation-for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LastName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-danger"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-group"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Age"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"control-label"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Age"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-control"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-validation-for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Age"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-danger"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-group"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Create"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> @section Scripts { @{await Html.RenderPartialAsync("_ValidationScriptsPartial");} }</code> </pre> <br></div></div><br> 必须对传入数据进行验证： <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Name.IsValid(model.FirstName)) { ModelState.AddModelError(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(model.FirstName), <span class="hljs-string"><span class="hljs-string">"FirstName is invalid"</span></span>); }</code> </pre> <br> 如果不这样做，那么在创建具有错误值的VO时，将引发ArgumentException（记住VO构造函数中的Guard子句）。 通过验证，可以很容易地向用户发送一个值不正确的消息。 <br><br><div class="spoiler">  <b class="spoiler_title">结果</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ej/8m/kr/ej8mkr_4de2x23avg5mezwb6gzg.png"><br></div></div><br> 在这里，您需要做一个小题外话-在Asp Net Core中，使用属性是一种常规的数据验证方法。 但是在DDD中，由于以下几个原因，这种验证方法不正确： <br><br><ul><li> 属性功能可能不足以进行验证逻辑； </li><li> 任何业务逻辑，包括用于验证参数的规则，都是由域专门设置的。 他对此拥有垄断权，所有其他层面都必须考虑到这一点。 可以使用属性，但您不应依赖它们。 如果属性跳过不正确的数据，那么在创建VO时我们将再次获得异常。 </li></ul><br> 返回AddPerson（）。 数据验证之后，将创建PersonalName，Age和Person。 接下来，将对象添加到存储库并保存更改（提交）。 在EfPersons信息库中不要调用Commit非常重要。 存储库的任务是仅对数据执行某些操作。 提交仅在外部（确切地说是程序员决定）时进行。 否则，当在某个业务迭代的中间发生错误时，就有可能出现这种情况-一些数据被保存而另一些则没有。 我们收到的域名处于“损坏”状态。 如果Commit在最后完成，那么如果发生错误，事务将简单地回滚。 <br><br><h2> 结论 </h2><br> 我举例说明了值对象的实现，以及实体框架核心中映射的细微差别。 我希望这些材料将有助于理解如何在实践中应用域驱动设计的元素。 <br><br>  Complete PersonsDemo项目源代码-GitHub <br><br> 如果PersonalName或Age不是Person的必需属性，则该材料没有公开与可选（可空）值对象进行交互的问题。 我想在本文中对此进行描述，但是它已经有些过载了。 如果对此问题感兴趣，请在评论中写，继续。 <br><br> 对于一般“美丽的体系结构”的爱好者，尤其是“领域驱动的设计”的爱好者，我强烈推荐<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">企业工艺</a>资源。 <br><br> 关于.Net的正确体系结构构建和实现示例，有很多有用的文章。 那里借鉴了一些想法，并在“战斗”项目中成功实施，并在本文中得到了部分体现。 <br><br> 还使用了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">所有权类型</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">值转换</a>的官方文档。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN443770/">https://habr.com/ru/post/zh-CN443770/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN443756/index.html">课堂设计：什么是好？</a></li>
<li><a href="../zh-CN443758/index.html">快速绘画Doodle识别：如何结交R，C ++和神经网格</a></li>
<li><a href="../zh-CN443764/index.html">设计师吸烟的东西：不寻常的枪支</a></li>
<li><a href="../zh-CN443766/index.html">立即尝试C ++ 20 Contract编程</a></li>
<li><a href="../zh-CN443768/index.html">用于数百种客户端版本的Monolith：我们如何编写和支持测试</a></li>
<li><a href="../zh-CN443772/index.html">上古：IBM ThinkPad T40，第一个无线设备</a></li>
<li><a href="../zh-CN443774/index.html">神经生物学如何干预美国总统大选</a></li>
<li><a href="../zh-CN443776/index.html">中国在购买地铁时引入了实验性面部识别系统</a></li>
<li><a href="../zh-CN443780/index.html">MCDM项目。 第1部分。概念</a></li>
<li><a href="../zh-CN443782/index.html">开发人员现在可以在他们的Steam游戏中使用Valve的网络API</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>