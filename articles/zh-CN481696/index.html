<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤° ğŸ¤´ğŸ½ ğŸ’§ Ruleguardï¼šGoçš„åŠ¨æ€æ£€æŸ¥ ğŸ§  ğŸ¦ ğŸš¿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è®¨è®ºæ–°çš„go-ruleguardé™æ€åˆ†æåº“ï¼ˆå’Œå®ç”¨ç¨‹åºï¼‰ï¼Œè¯¥åº“å°†gogrepä¸ºå¯ç”¨äºçŸ­ç»’gogrep ã€‚ 


 ç‹¬ç‰¹çš„åŠŸèƒ½ï¼šæ‚¨å¯ä»¥åœ¨ç‰¹æ®Šçš„Go-like DSLä¸Šæè¿°é™æ€åˆ†æçš„è§„åˆ™ï¼Œåœ¨ruleguardçš„ä¸€å¼€å§‹ï¼Œ ruleguardå°±ä¼šå˜æˆä¸€ç»„è¯Šæ–­ã€‚ ä¹Ÿè®¸è¿™æ˜¯ç”¨äºå®æ–½Goçš„è‡ªå®šä¹‰æ£€æŸ¥...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ruleguardï¼šGoçš„åŠ¨æ€æ£€æŸ¥</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481696/"><p><img src="https://habrastorage.org/webt/b5/p-/sq/b5p-sqgr-9b1e5mimtxaftmryau.png"></p><br><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è®¨è®ºæ–°çš„<a href="https://github.com/quasilyte/go-ruleguard"><code>go-ruleguard</code></a>é™æ€åˆ†æåº“ï¼ˆå’Œå®ç”¨ç¨‹åºï¼‰ï¼Œè¯¥åº“å°†<a href="https://github.com/mvdan/gogrep"><code>gogrep</code></a>ä¸ºå¯ç”¨äºçŸ­ç»’<a href="https://github.com/mvdan/gogrep"><code>gogrep</code></a> ã€‚ </p><br><p> ç‹¬ç‰¹çš„åŠŸèƒ½ï¼šæ‚¨å¯ä»¥åœ¨ç‰¹æ®Šçš„Go-like DSLä¸Šæè¿°é™æ€åˆ†æçš„è§„åˆ™ï¼Œåœ¨<code>ruleguard</code>çš„ä¸€å¼€å§‹ï¼Œ <code>ruleguard</code>å°±ä¼šå˜æˆä¸€ç»„è¯Šæ–­ã€‚ ä¹Ÿè®¸è¿™æ˜¯ç”¨äºå®æ–½Goçš„è‡ªå®šä¹‰æ£€æŸ¥çš„æœ€å®¹æ˜“é…ç½®çš„å·¥å…·ä¹‹ä¸€ã€‚ </p><br><p> ä½œä¸ºå¥–åŠ±ï¼Œæˆ‘ä»¬å°†è®¨è®º<a href="https://godoc.org/golang.org/x/tools/go/analysis"><code>go/analysis</code></a>åŠå…¶<a href="https://github.com/go-lintpack/lintpack">å‰èº«</a> ã€‚ </p><a name="habracut"></a><br><h1 id="rasshiryaemost-staticheskogo-analiza"> é™æ€åˆ†æå¯æ‰©å±•æ€§ </h1><br><p>  Goæœ‰<a href="https://github.com/golangci/awesome-go-linters">è®¸å¤š</a>çŸ­æ¯›çŒ«ï¼Œå…¶ä¸­ä¸€äº›å¯ä»¥æ‰©å±•ã€‚ é€šå¸¸ï¼Œè¦æ‰©å±•linterï¼Œæ‚¨éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„linter APIç¼–å†™Goä»£ç ã€‚ </p><br><p> ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š <a href="https://golang.org/pkg/plugin/">Goæ’ä»¶</a>å’ŒMonolithã€‚ æ•´ä½“æ„å‘³ç€æ‰€æœ‰æ”¯ç¥¨ï¼ˆåŒ…æ‹¬æ‚¨çš„ä¸ªäººæ”¯ç¥¨ï¼‰åœ¨ç¼–è¯‘é˜¶æ®µéƒ½å¯ç”¨ã€‚ </p><br><p>  <a href="https://github.com/mgechev/revive"><code>revive</code></a>è¦æ±‚å…¶å†…æ ¸ä¸­åŒ…æ‹¬æ–°çš„æ£€æŸ¥ä»¥è¿›è¡Œæ‰©å±•ã€‚ é™¤äº†è¿™ä¸ªå¯ä»¥æ’å…¥æ’ä»¶çš„<a href="https://github.com/go-critic/go-critic"><code>go-critic</code></a>æ’ä»¶ï¼Œå®ƒä½¿æ‚¨å¯ä»¥æ”¶é›†æ‰©å±•åè€Œä¸ä¸»è¦ä»£ç æ— å…³ã€‚ è¿™ä¸¤ç§æ–¹æ³•éƒ½æš—ç¤ºæ‚¨<a href="https://golang.org/pkg/go/ast/"><code>go/ast</code></a>ä½¿ç”¨linter APIåœ¨Goä¸Šå®ç°<a href="https://golang.org/pkg/go/ast/"><code>go/ast</code></a>å’Œ<a href="https://golang.org/pkg/go/types/"><code>go/types</code></a>æ“ä½œã€‚ å³ä½¿æ˜¯ç®€å•çš„æ£€æŸ¥ä¹Ÿéœ€è¦<a href="">å¤§é‡ä»£ç </a> ã€‚ </p><br><p>  <a href="https://godoc.org/golang.org/x/tools/go/analysis"><code>go/analysis</code></a>æ—¨åœ¨é€šè¿‡ä»¥ä¸‹æ–¹æ¡ˆç®€åŒ–å›¾ç‰‡ï¼šçš®æ£‰æœºçš„â€œæ¡†æ¶â€å‡ ä¹å®Œå…¨ç›¸åŒï¼Œä½†è¿™å¹¶ä¸èƒ½è§£å†³è¯Šæ–­ç¨‹åºæœ¬èº«çš„æŠ€æœ¯å®æ–½å¤æ‚æ€§çš„é—®é¢˜ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">`loader`å’Œ`go / packages'çš„é¢˜å¤–è¯</b> <div class="spoiler_text"><hr><br><p> å½“æ‚¨ä¸ºGoç¼–å†™åˆ†æå™¨æ—¶ï¼Œæ‚¨çš„æœ€ç»ˆç›®æ ‡æ˜¯ä¸ASTå’Œç±»å‹è¿›è¡Œäº¤äº’ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œæ­¤æ“ä½œä¹‹å‰ï¼Œéœ€è¦ä»¥æ­£ç¡®çš„æ–¹å¼â€œåŠ è½½â€æºä»£ç ã€‚ ä¸ºç®€åŒ–èµ·è§ï¼ŒåŠ è½½çš„æ¦‚å¿µåŒ…æ‹¬<a href="https://golang.org/pkg/go/parser/">è§£æ</a> ï¼Œç±»å‹æ£€æŸ¥å’Œ<a href="https://golang.org/pkg/go/importer/">å¯¼å…¥ä¾èµ–é¡¹</a> ã€‚ </p><br><p> ç®€åŒ–æ­¤ç®¡é“çš„ç¬¬ä¸€æ­¥æ˜¯<a href="https://godoc.org/golang.org/x/tools/go/loader"><code>go/loader</code></a>åŒ…ï¼Œå®ƒå°†å…è®¸æ‚¨é€šè¿‡å‡ ä¸ªè°ƒç”¨æ¥â€œä¸‹è½½â€æ‰€éœ€çš„ä¸€åˆ‡ã€‚ ä¸€åˆ‡éƒ½å·®ä¸å¤šäº†ï¼Œç„¶åä»–ä¸èµæˆä½¿ç”¨<a href="https://godoc.org/golang.org/x/tools/go/packages"><code>go/packages</code></a> ã€‚  <code>go/packages</code> APIç•¥æœ‰æ”¹è¿›ï¼Œä»ç†è®ºä¸Šè®²ï¼Œå®ƒä¸æ¨¡å—é…åˆè‰¯å¥½ã€‚ </p><br><p> ç°åœ¨ï¼Œæœ€å¥½ä¸è¦ç›´æ¥ä½¿ç”¨ä»¥ä¸Šä»»ä½•ä¸€ç§æ¥ç¼–å†™åˆ†æå™¨ï¼Œå› ä¸º<a href="https://godoc.org/golang.org/x/tools/go/analysis"><code>go/analysis</code></a>æä¾›äº†<code>go/packages</code>ä»¥å‰çš„è§£å†³æ–¹æ¡ˆæ‰€æ²¡æœ‰çš„ä¸œè¥¿-ç¨‹åºçš„ç»“æ„ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŒ‡å®šçš„<code>go/analysis</code>èŒƒä¾‹ï¼Œå¹¶æ›´æœ‰æ•ˆåœ°é‡ç”¨åˆ†æå™¨ã€‚ è¿™ç§èŒƒä¾‹å…·æœ‰äº‰è®®æ€§ï¼Œä¾‹å¦‚ï¼Œ <code>go/analysis</code>éå¸¸é€‚åˆäºå•ä¸ªè½¯ä»¶åŒ…åŠå…¶ä¾èµ–é¡¹çº§åˆ«çš„åˆ†æï¼Œä½†æ˜¯è¦åœ¨æ²¡æœ‰ç‹¡çŒ¾çš„å·¥ç¨‹æŠ€å·§çš„æƒ…å†µä¸‹å¯¹å…¶è¿›è¡Œå…¨å±€åˆ†æå¹¶ä¸å®¹æ˜“ã€‚ </p><br><p>  <code>go/analysis</code>è¿˜å¯ä»¥ç®€åŒ–<a href="https://godoc.org/golang.org/x/tools/go/analysis/analysistest">åˆ†æä»ªçš„æµ‹è¯•</a> ã€‚ </p><br><hr></div></div><br><h1 id="chto-zhe-takoe-ruleguard"> ä»€ä¹ˆæ˜¯è§„åˆ™å®ˆå«ï¼Ÿ </h1><br><p><img src="https://habrastorage.org/webt/zp/ym/rj/zpymrjjb8zkqa_c069ccd-yf3xg.png"></p><br><p>  <a href="https://github.com/quasilyte/go-ruleguard"><code>go-ruleguard</code></a>æ˜¯é™æ€åˆ†æå®ç”¨ç¨‹åºï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸åŒ…å«å•ä¸ªæ£€æŸ¥ã€‚ </p><br><p>  <code>ruleguard</code>è§„åˆ™ä»ä¸€ä¸ªç‰¹æ®Šçš„<code>gorules</code>æ–‡ä»¶å¼€å§‹åŠ è½½ï¼Œè¯¥æ–‡ä»¶ä»¥å£°æ˜æ–¹å¼æè¿°äº†åº”å‘å…¶å‘å‡ºè­¦å‘Šçš„ä»£ç æ¨¡å¼ã€‚  <code>ruleguard</code>ç”¨æˆ·å¯ä»¥è‡ªç”±ç¼–è¾‘æ­¤æ–‡ä»¶ã€‚ </p><br><p> ä¸å¿…<code>gorules</code>ç”¨äºè¿æ¥æ–°æ”¯ç¥¨<code>gorules</code>æ§åˆ¶ç¨‹åºï¼Œå› æ­¤å¯ä»¥å°†<code>gorules</code>çš„è§„åˆ™ç§°ä¸º<a href="https://habr.com/ru/company/vk/blog/473718/">dynamic</a> ã€‚ </p><br><p>  <code>ruleguard</code>æ§åˆ¶ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"github.com/quasilyte/go-ruleguard/analyzer"</span></span> <span class="hljs-string"><span class="hljs-string">"golang.org/x/tools/go/analysis/singlechecker"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { singlechecker.Main(analyzer.Analyzer) }</code> </pre> <br><p> åŒæ—¶ï¼Œ <code>analyzer</code>é€šè¿‡<a href="https://godoc.org/github.com/quasilyte/go-ruleguard/ruleguard"><code>ruleguard</code></a>ç¨‹åºåŒ…å®ç°çš„ï¼Œå¦‚æœè¦å°†å®ƒç”¨ä½œåº“ï¼Œåˆ™å¿…é¡»ä½¿ç”¨è¯¥ç¨‹åºã€‚ </p><br><h1 id="ruleguard-vs-revive"> å®ˆæŠ¤è€…VSå¤å…´ </h1><br><p> ä¸¾ä¸€ä¸ªç®€å•ä½†çœŸå®çš„ç¤ºä¾‹ï¼šå‡è®¾æˆ‘ä»¬è¦é¿å…åœ¨ç¨‹åºä¸­è°ƒç”¨<a href="https://golang.org/pkg/runtime/"><code>runtime.GC()</code></a> ã€‚ ä¸ºäº†å¤å…´ï¼Œå·²ç»æœ‰ä¸€ä¸ªå•ç‹¬çš„è¯Šæ–­ç¨‹åºï¼Œç§°ä¸º<code>"call-to-gc"</code> ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">Call-to-gcå®ç°ï¼ˆElvenä¸­çš„70è¡Œï¼‰</b> <div class="spoiler_text"><hr><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"go/ast"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/mgechev/revive/lint"</span></span> ) <span class="hljs-comment"><span class="hljs-comment">// CallToGCRule lints calls to the garbage collector. type CallToGCRule struct{} // Apply applies the rule to given file. func (r *CallToGCRule) Apply(file *lint.File, _ lint.Arguments) []lint.Failure { var failures []lint.Failure onFailure := func(failure lint.Failure) { failures = append(failures, failure) } var gcTriggeringFunctions = map[string]map[string]bool{ "runtime": map[string]bool{"GC": true}, } w := lintCallToGC{onFailure, gcTriggeringFunctions} ast.Walk(w, file.AST) return failures } // Name returns the rule name. func (r *CallToGCRule) Name() string { return "call-to-gc" } type lintCallToGC struct { onFailure func(lint.Failure) gcTriggeringFunctions map[string]map[string]bool } func (w lintCallToGC) Visit(node ast.Node) ast.Visitor { ce, ok := node.(*ast.CallExpr) if !ok { return w // nothing to do, the node is not a call } fc, ok := ce.Fun.(*ast.SelectorExpr) if !ok { return nil // nothing to do, the call is not of the form pkg.func(...) } id, ok := fc.X.(*ast.Ident) if !ok { return nil // in case X is not an id (it should be!) } fn := fc.Sel.Name pkg := id.Name if !w.gcTriggeringFunctions[pkg][fn] { return nil // it isn't a call to a GC triggering function } w.onFailure(lint.Failure{ Confidence: 1, Node: node, Category: "bad practice", Failure: "explicit call to the garbage collector", }) return w }</span></span></code> </pre> <br><hr></div></div><br><p> ç°åœ¨ï¼Œä¸<a href="https://github.com/quasilyte/go-ruleguard"><code>go-ruleguard</code></a>æ“ä½œæ–¹å¼è¿›è¡Œæ¯”è¾ƒï¼š </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> gorules <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/quasilyte/go-ruleguard/dsl/fluent"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callToGC</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(m fluent.Matcher)</span></span></span></span> { m.Match(<span class="hljs-string"><span class="hljs-string">`runtime.GC()`</span></span>).Report(<span class="hljs-string"><span class="hljs-string">`explicit call to the garbage collector`</span></span>) }</code> </pre> <br><p> æ²¡ä»€ä¹ˆï¼ŒçœŸæ­£é‡è¦çš„æ˜¯<code>runtime.GC</code>å’Œä¸‡ä¸€è§¦å‘è§„åˆ™éœ€è¦å‘å‡ºçš„æ¶ˆæ¯ã€‚ </p><br><p> æ‚¨å¯èƒ½ä¼šé—®ï¼šä»…æ­¤è€Œå·²å—ï¼Ÿ æˆ‘ç‰¹åˆ«ä»ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹å¼€å§‹ï¼Œä»¥æ˜¾ç¤ºåœ¨ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•çš„æƒ…å†µä¸‹è¿›è¡Œéå¸¸ç®€å•çš„è¯Šæ–­å¯èƒ½éœ€è¦å¤šå°‘ä»£ç ã€‚ æˆ‘ä¿è¯ä¼šæœ‰æ›´å¤šä»¤äººå…´å¥‹çš„ä¾‹å­ã€‚ </p><br><h1 id="quick-start"> å¿«é€Ÿä¸Šæ‰‹ </h1><br><p>  <code>go-critic</code>æœ‰ä¸€ä¸ª<a href="https://go-critic.github.io/overview"><code>rangeExprCopy</code></a>è¯Šæ–­ç¨‹åºï¼Œå¯ä»¥åœ¨ä»£ç ä¸­æŸ¥æ‰¾æ½œåœ¨çš„æ„å¤–æ•°ç»„å‰¯æœ¬ã€‚ </p><br><p> æ­¤ä»£ç éå†æ•°ç»„çš„<strong>å‰¯æœ¬</strong> ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xs [<span class="hljs-number"><span class="hljs-number">2048</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, x := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> xs { <span class="hljs-comment"><span class="hljs-comment">// Copies 2048 bytes // Loop body. }</span></span></code> </pre> <br><p> è§£å†³æ­¤é—®é¢˜çš„æ–¹æ³•æ˜¯æ·»åŠ ä¸€ä¸ªå­—ç¬¦ï¼š </p><br><pre> <code class="diff hljs"> var xs [2048]byte - for _, x := range xs { // Copies 2048 bytes + for _, x := range &amp;xs { // No copy // Loop body. }</code> </pre> <br><p> æœ€æœ‰å¯èƒ½çš„æ˜¯ï¼Œæ‚¨ä¸éœ€è¦æ­¤å¤åˆ¶ï¼Œå¹¶ä¸”æ›´æ­£ç‰ˆæœ¬çš„æ€§èƒ½å§‹ç»ˆæ›´å¥½ã€‚ æ‚¨å¯ä»¥ç­‰åˆ°Goç¼–è¯‘å™¨å˜å¾—æ›´å¥½ä¸ºæ­¢ï¼Œæˆ–è€…å¯ä»¥åœ¨ä»£ç ä¸­æ£€æµ‹åˆ°æ­¤ç±»ä½ç½®ï¼Œå¹¶ç«‹å³ä½¿ç”¨ç›¸åŒçš„<code>go-critic</code>å¯¹å…¶è¿›è¡Œæ›´æ­£ã€‚ </p><br><p> å¯ä»¥ä½¿ç”¨<code>gorules</code>è¯­è¨€ï¼ˆ <code>rules.go</code>æ–‡ä»¶ï¼‰å®æ–½æ­¤è¯Šæ–­ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> gorules <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/quasilyte/go-ruleguard/dsl/fluent"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> _</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(m fluent.Matcher)</span></span></span></span> { m.Match(<span class="hljs-string"><span class="hljs-string">`for $_, $_ := range $x { $*_ }`</span></span>, <span class="hljs-string"><span class="hljs-string">`for $_, $_ = range $x { $*_ }`</span></span>). Where(m[<span class="hljs-string"><span class="hljs-string">"x"</span></span>].Addressable &amp;&amp; m[<span class="hljs-string"><span class="hljs-string">"x"</span></span>].Type.Size &gt;= <span class="hljs-number"><span class="hljs-number">128</span></span>). Report(<span class="hljs-string"><span class="hljs-string">`$x copy can be avoided with &amp;$x`</span></span>). At(m[<span class="hljs-string"><span class="hljs-string">"x"</span></span>]). Suggest(<span class="hljs-string"><span class="hljs-string">`&amp;$x`</span></span>) }</code> </pre> <br><p> è¯¥è§„åˆ™æ‰¾åˆ°æ‰€æœ‰ä½¿ç”¨ä¸¤ä¸ªå¯è¿­ä»£å˜é‡çš„<code>for-range</code>å¾ªç¯ï¼ˆè¿™ç§æƒ…å†µå¯¼è‡´å¤åˆ¶ï¼‰ã€‚ å¯è¿­ä»£è¡¨è¾¾å¼<code>$x</code>å¿…é¡»æ˜¯<a href="https://golang.org/ref/spec"><code>addressable</code></a>å¹¶ä¸”å¿…é¡»å¤§äºæ‰€é€‰é˜ˆå€¼ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ </p><br><p>  <a href="https://godoc.org/github.com/quasilyte/go-ruleguard/dsl/fluent"><code>Report()</code></a>å®šä¹‰äº†è¦å‘é€ç»™ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œ <a href="https://godoc.org/github.com/quasilyte/go-ruleguard/dsl/fluent"><code>Suggest()</code></a>æè¿°äº†ä¸€ä¸ªå¿«é€Ÿ<code>quickfix</code>æ¨¡æ¿ï¼Œè¯¥æ¨¡æ¿å¯ä»¥é€šè¿‡<a href="https://github.com/golang/tools/tree/master/gopls">gopls</a> ï¼ˆLSPï¼‰åœ¨ç¼–è¾‘å™¨ä¸­ä½¿ç”¨ï¼Œå¹¶ä¸”å¦‚æœä½¿ç”¨<code>-fix</code>å‚æ•°è°ƒç”¨<code>ruleguard</code>å¯ä»¥äº¤äº’ä½¿ç”¨ï¼ˆæˆ‘ä»¬å°†è¿”å›æ­¤å†…å®¹ï¼‰ã€‚  <a href="https://godoc.org/github.com/quasilyte/go-ruleguard/dsl/fluent"><code>At()</code></a>å°†è­¦å‘Š<strong>å’Œå¿«é€Ÿ</strong> <code>quickfix</code>é™„åŠ åˆ°æ¨¡æ¿çš„ç‰¹å®šéƒ¨åˆ†ã€‚ æˆ‘ä»¬éœ€è¦ç”¨<code>$x</code> <code>&amp;$x</code>ä»£æ›¿<code>$x</code> ï¼Œè€Œä¸æ˜¯é‡å†™æ•´ä¸ªå¾ªç¯ã€‚ </p><br><p>  <code>Report()</code>å’Œ<code>Suggest()</code>æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²å¯ä»¥æ’å…¥æ¨¡æ¿ä»<code>Match()</code>æ•è·çš„è¡¨è¾¾å¼ã€‚ é¢„å®šä¹‰çš„å˜é‡<code>$$</code>è¡¨ç¤ºâ€œæ‰€æœ‰æ•è·çš„ç‰‡æ®µâ€ï¼ˆåœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ä¸º<code>$0</code> ï¼‰ã€‚ </p><br><p> åˆ›å»º<code>rangecopy.go</code>æ–‡ä»¶ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> example <span class="hljs-comment"><span class="hljs-comment">// sizeof(builtins[...]) = 240 on x86-64 var builtins = [...]string{ "append", "cap", "close", "complex", "copy", "delete", "imag", "len", "make", "new", "panic", "print", "println", "real", "recover", } func builtinID(name string) int { for i, s := range builtins { if s == name { return i } } return -1 }</span></span></code> </pre> <br><p> ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿è¡Œ<code>ruleguard</code> ï¼š </p><br><pre> <code class="bash hljs">$ ruleguard -rules rules.go -fix rangecopy.go rangecopy.go:12:20: builtins copy can be avoided with &amp;builtins</code> </pre> <br><p> å¦‚æœä¹‹åå†æŸ¥çœ‹<code>rangecopy.go</code> ï¼Œåˆ™ä¼šçœ‹åˆ°ä¸€ä¸ªå›ºå®šç‰ˆæœ¬ï¼Œå› ä¸ºä½¿ç”¨<code>-fix</code>å‚æ•°è°ƒç”¨äº†<code>ruleguard</code> ã€‚ </p><br><p> æ— éœ€åˆ›å»º<code>gorules</code>æ–‡ä»¶å³å¯è°ƒè¯•æœ€ç®€å•çš„è§„åˆ™ï¼š </p><br><pre> <code class="plaintext hljs">$ ruleguard -c 1 -e 'm.Match(`return -1`)' rangecopy.go rangecopy.go:17:2: return -1 16 } 17 return -1 18 }</code> </pre> <br><p> ç”±äºä½¿ç”¨äº†<a href="https://godoc.org/golang.org/x/tools/go/analysis/singlechecker"><code>go/analysis/singlechecker</code></a> ï¼Œæˆ‘ä»¬æœ‰äº†<code>-c</code>é€‰é¡¹ï¼Œå®ƒä½¿æˆ‘ä»¬å¯ä»¥æ˜¾ç¤ºæŒ‡å®šçš„ä¸Šä¸‹æ–‡è¡Œä»¥åŠè­¦å‘Šæœ¬èº«ã€‚ æ§åˆ¶æ­¤å‚æ•°æœ‰ç‚¹è¿åç›´è§‰ï¼šç¼ºçœå€¼ä¸º<code>-c=-1</code> ï¼Œè¡¨ç¤ºâ€œæ— ä¸Šä¸‹æ–‡â€ï¼Œè€Œ<code>-c=0</code>å°†è¾“å‡ºä¸Šä¸‹æ–‡çš„ä¸€è¡Œï¼ˆè¯Šæ–­æ‰€æŒ‡ç¤ºçš„ä¸€è¡Œï¼‰ã€‚ </p><br><p> è¿™æ˜¯ä¸€äº›æ›´æœ‰è¶£çš„<code>gorules</code> ï¼š </p><br><ul><li>  <a href="">ç±»å‹æ¨¡æ¿</a> ï¼Œå¯ç”¨äºæŒ‡å®šæœŸæœ›çš„ç±»å‹ã€‚ ä¾‹å¦‚ï¼Œè¡¨è¾¾å¼<code>map[$t]$t</code>æè¿°äº†æ‰€æœ‰å…·æœ‰ä¸é”®ç±»å‹åŒ¹é…çš„å€¼ç±»å‹çš„mapï¼Œè€Œ<code>*[$len]$elem</code>æ•è·äº†æ‰€æœ‰æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆã€‚ </li><li> åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå¯èƒ½æœ‰å¤šä¸ªè§„åˆ™ï¼Œ <br> å‡½æ•°æœ¬èº«åº”ç§°ä¸º<a href="">è§„åˆ™ç»„</a> ã€‚ </li><li> ç»„ä¸­çš„è§„åˆ™æŒ‰ç…§å®šä¹‰çš„é¡ºåºä¾æ¬¡åº”ç”¨ã€‚ è§¦å‘çš„ç¬¬ä¸€ä¸ªè§„åˆ™å–æ¶ˆä¸å…¶ä½™è§„åˆ™çš„æ¯”è¾ƒã€‚ å¯¹äºä¼˜åŒ–è€Œè¨€ï¼Œè¿™ä¸é‡è¦ï¼Œè€Œå¯¹äºç‰¹å®šæƒ…å†µä¸‹çš„ä¸“ç”¨è§„åˆ™è€Œè¨€ï¼Œåˆ™ä¸é‚£ä¹ˆé‡è¦ã€‚ ä¸€ä¸ªæœ‰ç”¨çš„ä¾‹å­æ˜¯å°†<code>$x=$x+$y</code>é‡å†™<code>$x=$x+$y</code> <code>$x+=$y</code> ï¼Œå¯¹äº<code>$y=1</code>çš„æƒ…å†µï¼Œæ‚¨è¦æä¾›<code>$x++</code> ï¼Œè€Œä¸æ˜¯<code>$x+=1</code> ã€‚ </li></ul><br><p> å¯ä»¥åœ¨<a href=""><code>docs/gorules.md</code></a>æ‰¾åˆ°æœ‰å…³æ‰€ç”¨DSLçš„æ›´å¤šä¿¡æ¯ã€‚ </p><br><h1 id="eschyo-bolshe-primerov"> æ›´å¤šä¾‹å­ </h1><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> gorules <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/quasilyte/go-ruleguard/dsl/fluent"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exampleGroup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(m fluent.Matcher)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//     json.Decoder. // . http://golang.org/issue/36225 m.Match(`json.NewDecoder($_).Decode($_)`). Report(`this json.Decoder usage is erroneous`) //   unconvert,    . m.Match(`time.Duration($x) * time.Second`). Where(m["x"].Const). Suggest(`$x * time.Second`) //   fmt.Sprint()    String(), //   $x  . m.Match(`fmt.Sprint($x)`). Where(m["x"].Type.Implements(`fmt.Stringer`)). Suggest(`$x.String()`) //   . m.Match(`!($x != $y)`).Suggest(`$x == $y`) m.Match(`!($x == $y)`).Suggest(`$x != $y`) }</span></span></code> </pre> <br><p> å¦‚æœæ²¡æœ‰å¯¹è§„åˆ™çš„<a href="https://godoc.org/github.com/quasilyte/go-ruleguard/dsl/fluent"><code>Report()</code></a>è°ƒç”¨ï¼Œåˆ™å°†ä½¿ç”¨<a href="https://godoc.org/github.com/quasilyte/go-ruleguard/dsl/fluent"><code>Suggest()</code></a>çš„æ¶ˆæ¯è¾“å‡ºã€‚ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™å¯ä»¥é¿å…é‡å¤ã€‚ </p><br><p> ç±»å‹è¿‡æ»¤å™¨å’Œå­è¡¨è¾¾å¼å¯ä»¥æ£€æŸ¥å„ç§å±æ€§ã€‚ ä¾‹å¦‚ï¼Œ <code>Pure</code>å’Œ<code>Const</code>å±æ€§éå¸¸æœ‰ç”¨ï¼š </p><br><ul><li>  <a href="https://godoc.org/github.com/quasilyte/go-ruleguard/dsl/fluent"><code>Var.Pure</code></a>è¡¨ç¤ºè¯¥è¡¨è¾¾æ²¡æœ‰å‰¯ä½œç”¨ã€‚ </li><li>  <a href="https://godoc.org/github.com/quasilyte/go-ruleguard/dsl/fluent"><code>Var.Const</code></a>è¡¨ç¤ºå¯ä»¥åœ¨æ’å®šä¸Šä¸‹æ–‡ï¼ˆä¾‹å¦‚ï¼Œæ•°ç»„çš„ç»´ï¼‰ä¸­ä½¿ç”¨è¡¨è¾¾å¼ã€‚ </li></ul><br><p> å¯¹äº<a href="https://godoc.org/github.com/quasilyte/go-ruleguard/dsl/fluent"><code>Where()</code></a>æ¡ä»¶ä¸­çš„<code>package-qualified</code>åç§°ï¼Œæ‚¨éœ€è¦ä½¿ç”¨<a href="https://godoc.org/github.com/quasilyte/go-ruleguard/dsl/fluent"><code>Import()</code></a>æ–¹æ³•ã€‚ ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæ‰€æœ‰æ ‡å‡†è½¯ä»¶åŒ…éƒ½æ˜¯ä¸ºæ‚¨å¯¼å…¥çš„ï¼Œå› æ­¤åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦è¿›è¡Œå…¶ä»–å¯¼å…¥ã€‚ </p><br><h1 id="goanalysis-quickfix-actions">  <code>go/analysis</code>ä¿®å¤åŠ¨ä½œ </h1><br><p>  <code>go/analysis</code>ä¸ºæˆ‘ä»¬<code>quickfix</code>å¯¹<code>quickfix</code>æ”¯æŒã€‚ </p><br><p> åœ¨<code>go/analysis</code>æ¨¡å‹ä¸­ï¼Œåˆ†æå™¨ç”Ÿæˆ<a href="https://godoc.org/golang.org/x/tools/go/analysis">è¯Šæ–­</a>å’Œ<a href="https://godoc.org/golang.org/x/tools/go/analysis">äº‹å®</a> ã€‚ è¯Šæ–­å°†å‘é€ç»™ç”¨æˆ·ï¼Œå¹¶ä¸”äº‹å®å°†ä¾›å…¶ä»–åˆ†æä»ªä½¿ç”¨ã€‚ </p><br><p> è¯Šæ–­ç¨‹åºå¯ä»¥å…·æœ‰ä¸€ç»„<a href="https://godoc.org/golang.org/x/tools/go/analysis">å»ºè®®çš„ä¿®å¤ç¨‹åº</a> ï¼Œæ¯ä¸ª<a href="https://godoc.org/golang.org/x/tools/go/analysis">ä¿®å¤ç¨‹åº</a>éƒ½æè¿°äº†å¦‚ä½•åœ¨æŒ‡å®šèŒƒå›´å†…æ›´æ”¹æºä»£ç ï¼Œä»¥ä¿®å¤è¯Šæ–­ç¨‹åºå‘ç°çš„é—®é¢˜ã€‚ </p><br><p> å®˜æ–¹è¯´æ˜ä½äº<a href=""><code>go/analysis/doc/suggested_fixes.md</code></a> ã€‚ </p><br><h1 id="zaklyuchenie"> ç»“è®º </h1><br><p><img src="https://habrastorage.org/webt/m3/bs/zw/m3bszwzp2nwkxrnxdnenypatyjk.png"></p><br><p> åœ¨æ‚¨çš„é¡¹ç›®ä¸Šå°è¯•ä½¿ç”¨<code>ruleguard</code> ï¼Œå¦‚æœæ‚¨å‘ç°é”™è¯¯æˆ–æƒ³è¯·æ±‚æ–°åŠŸèƒ½ï¼Œè¯·<a href="https://github.com/quasilyte/go-ruleguard/issues/new">æ‰“å¼€issue</a> ã€‚ </p><br><p> å¦‚æœæ‚¨ä»ç„¶å¾ˆéš¾ä½¿ç”¨<code>ruleguard</code> ï¼Œè¯·å‚è€ƒä»¥ä¸‹ç¤ºä¾‹ï¼š </p><br><ul><li> å®æ–½è‡ªå·±çš„Goè¯Šæ–­ç¨‹åºã€‚ </li><li> ä½¿ç”¨<code>-fix</code>è‡ªåŠ¨å‡çº§æˆ–é‡æ„ä»£ç ã€‚ </li><li> ä½¿ç”¨<a href=""><code>-json</code></a>å¤„ç†<a href=""><code>-json</code></a>ç»“æœçš„ä»£ç ç»Ÿè®¡ä¿¡æ¯æ”¶é›†ã€‚ </li></ul><br><p>  <code>ruleguard</code>çš„è¿‘æœŸå‘å±•è®¡åˆ’ï¼š </p><br><ul><li>  <code>ruleguard</code> <a href="https://github.com/go-critic/go-critic"><code>go-critic</code></a>ä½œä¸ºæ‰©å±•å®ƒçš„ä¸€ç§æ–¹æ³•ã€‚ </li><li> ä»<a href="https://github.com/quasilyte/talks/tree/master/2019-7-Oct-moscow">Applied Goä»£ç ç›¸ä¼¼æ€§åˆ†æä¸­</a>å°è¯•ä¸€äº›æƒ³æ³•ã€‚ </li><li> å‘DSLæ·»åŠ æ–°åŠŸèƒ½ã€‚  <a href="https://github.com/quasilyte/go-ruleguard/issues/28">å­åŒ¹é…</a>å¯èƒ½æ˜¯æœ‰ç”¨çš„è¡¥å……ã€‚ </li></ul><br><h1 id="poleznye-ssylki-i-resursy"> æœ‰ç”¨çš„é“¾æ¥å’Œèµ„æº </h1><br><ul><li> æ¨èçš„ç¤ºä¾‹è§„åˆ™æ–‡ä»¶ï¼š <a href=""><code>rules.go</code></a> </li><li> <a href="https://godoc.org/github.com/quasilyte/go-ruleguard/dsl/fluent"><code> dsl/fluent</code></a> </li> <li> <a href="https://godoc.org/github.com/quasilyte/go-ruleguard/ruleguard"><code> ruleguard</code></a> </li> <li> äºŒæ‰‹AST <a href="https://github.com/mvdan/gogrep"><code>mvdan/gogrep</code></a> ï¼š <a href="https://github.com/mvdan/gogrep"><code>mvdan/gogrep</code></a> </li><li>  <a href="https://habr.com/ru/company/vk/blog/473718/">NoVerifyä¸­çš„åŠ¨æ€æ£€æŸ¥</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN481696/">https://habr.com/ru/post/zh-CN481696/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN481680/index.html">åœ¨dapä¸Šç¼–å†™TodoMVCã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN481684/index.html">æ¥è‡ªPowerbankçš„ç¬”è®°æœ¬ç”µè„‘ï¼Ÿ</a></li>
<li><a href="../zh-CN481688/index.html">ä¸ºä»€ä¹ˆè¦å­¦ä¹ Javaä»¥åŠå¦‚ä½•æœ‰æ•ˆåœ°å­¦ä¹ Javaã€‚ YandexæŠ¥å‘Š</a></li>
<li><a href="../zh-CN481692/index.html">ä½¿ç”¨è‹±ç‰¹å°”å¤„ç†å™¨è·Ÿè¸ªæ¥è·Ÿè¸ªç³»ç»Ÿç®¡ç†æ¨¡å¼ä»£ç </a></li>
<li><a href="../zh-CN481694/index.html">æˆ‘åœ¨PostgreSQLä¸­è¿›è¡Œåˆ†åŒºçš„æ–¹å¼</a></li>
<li><a href="../zh-CN481698/index.html">è™šæ‹Ÿç°å®åŠå…¶å‘¨å›´çš„WebRTCæµ</a></li>
<li><a href="../zh-CN481700/index.html">å¤§çº¦ä¸€ä¸ªé˜¿å§¨</a></li>
<li><a href="../zh-CN481702/index.html">ä»çƒ¤é¢åŒ…æœºåˆ°æ— äººæœºã€‚ ç‰©è”ç½‘æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Œä¸ºä»€ä¹ˆå®ƒåœ¨30å¹´åæ‰å¯åŠ¨</a></li>
<li><a href="../zh-CN481704/index.html">è¿™æ˜¯æ ‡å‡†-2ï¼šå¦‚ä½•åˆ¶ä½œæ³•çº¿è´´å›¾</a></li>
<li><a href="../zh-CN481706/index.html">ç«èµ›ä¸­ä¸¢å¤±çš„é‡å­è®¡ç®—æœºåŠå…¶è‡´å‘½é”™è¯¯</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>