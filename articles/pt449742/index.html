<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüåæ üîç üïé Processo de desenvolvimento e teste com Docker e Gitlab CI ‚ûø üë©üèø‚Äç‚úàÔ∏è üâê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sugiro que voc√™ se familiarize com a transcri√ß√£o do relat√≥rio de Alexander Sigachev da Inventos "O processo de desenvolvimento e teste com o Docker + ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Processo de desenvolvimento e teste com Docker e Gitlab CI</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449742/"><p>  <strong>Sugiro que voc√™ se familiarize com a transcri√ß√£o do relat√≥rio de Alexander Sigachev da Inventos "O processo de desenvolvimento e teste com o Docker + Gitlab CI"</strong> </p><br><p>  Aqueles que est√£o apenas come√ßando a implementar o processo de desenvolvimento e teste com base no Docker + Gitlab CI geralmente fazem perguntas b√°sicas.  Por onde come√ßar?  Como organizar?  Como testar? </p><br><p>  Este relat√≥rio √© √∫til para informar de maneira estruturada sobre o processo de desenvolvimento e teste usando o Docker e o Gitlab CI.  2017 pr√≥prio relat√≥rio.  Penso que, a partir deste relat√≥rio, voc√™ pode desenhar o b√°sico, metodologia, id√©ia, experi√™ncia de uso. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/lJsqRwULRVA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Quem se importa, por favor, debaixo do gato. <a name="habracut"></a></p><br><p>  Meu nome √© Alexander Sigachev.  Eu trabalho na Inventos.  Vou contar sobre minha experi√™ncia no uso do Docker e como estamos gradualmente implementando-o em projetos na empresa. </p><br><p>  T√≥pico: Processo de desenvolvimento usando o Docker e o Gitlab CI. </p><br><p><img src="https://habrastorage.org/webt/iu/r2/qt/iur2qtjwp2qa_f4vdvmetzii-no.png"></p><br><p>  Esta √© a minha segunda conversa sobre o Docker.  No momento do primeiro relat√≥rio, usamos o Docker apenas no desenvolvimento em m√°quinas de desenvolvimento.  O n√∫mero de funcion√°rios que usaram o Docker foi de cerca de 2 a 3 pessoas.  Gradualmente, a experi√™ncia foi conquistada e avan√ßamos um pouco mais.  Link para o nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primeiro relat√≥rio</a> . </p><br><p>  O que haver√° neste relat√≥rio?  Compartilharemos nossa experi√™ncia sobre qual rake coletamos, que problemas resolvemos.  N√£o era bonito em todos os lugares, mas era permitido seguir em frente. </p><br><p>  Nosso lema √©: encaixe tudo que nossas m√£os alcan√ßarem. </p><br><p><img src="https://habrastorage.org/webt/rg/wx/pb/rgwxpblyvmjf0hb0ly4eecmntf0.png"></p><br><p>  Que problemas resolvemos? </p><br><p>  Quando uma empresa possui v√°rias equipes, o programador √© um recurso compartilhado.  H√° est√°gios em que um programador √© retirado de um projeto e entregue por algum tempo a outro projeto. </p><br><p>  Para que o programador se aprofunde rapidamente nele, ele precisa fazer o download do c√≥digo-fonte do projeto e iniciar o ambiente o mais r√°pido poss√≠vel, o que lhe permitir√° avan√ßar ainda mais na resolu√ß√£o das tarefas desse projeto. </p><br><p>  Normalmente, se voc√™ come√ßar do zero, a documenta√ß√£o no projeto n√£o ser√° suficiente.  Somente os veteranos t√™m informa√ß√µes sobre como configurar.  Os funcion√°rios montam independentemente o local de trabalho em um a dois dias.  Para acelerar isso, usamos o Docker. </p><br><p>  O pr√≥ximo motivo √© a padroniza√ß√£o das configura√ß√µes no Desenvolvimento.  Na minha experi√™ncia, os desenvolvedores sempre tomam a iniciativa.  Em cada quinto caso, um dom√≠nio personalizado √© inserido, por exemplo, vasya.dev.  Perto est√° o vizinho Petya, cujo dom√≠nio √© petya.dev.  Eles est√£o desenvolvendo um site ou algum componente do sistema usando esse nome de dom√≠nio. </p><br><p>  Quando o sistema cresce e esses nomes de dom√≠nio come√ßam a cair na configura√ß√£o, h√° um conflito de ambientes de Desenvolvimento e o caminho do site √© reescrito. </p><br><p> O mesmo acontece com as configura√ß√µes do banco de dados.  Algu√©m n√£o se preocupa com a seguran√ßa e trabalha com uma senha raiz vazia.  Algu√©m no est√°gio de instala√ß√£o do MySQL exigiu uma senha e a senha acabou sendo uma 123. Freq√ºentemente acontece que a configura√ß√£o do banco de dados muda constantemente, dependendo da confirma√ß√£o do desenvolvedor.  Algu√©m corrigiu, algu√©m n√£o corrigiu a configura√ß√£o.  Havia truques quando lan√ßamos algum tipo de configura√ß√£o de teste no <code>.gitignore</code> e cada desenvolvedor teve que instalar um banco de dados.  Isso complicou o processo inicial.  Entre outras coisas, voc√™ precisa se lembrar sobre o banco de dados.  O banco de dados deve ser inicializado, uma senha deve ser registrada, um usu√°rio deve ser registrado, uma placa deve ser criada e assim por diante. </p><br><p>  Outro problema s√£o as diferentes vers√µes das bibliotecas.  Muitas vezes acontece que um desenvolvedor trabalha com projetos diferentes.  Existe um projeto Legacy iniciado h√° cinco anos (a partir de 2017 - nota. Ed.).  No in√≠cio, come√ßamos com o MySQL 5.5.  Tamb√©m existem projetos modernos nos quais estamos tentando introduzir vers√µes mais modernas do MySQL, por exemplo, 5.7 ou mais antigas (em 2017 - nota. Ed.) </p><br><p>  Qualquer pessoa que trabalhe com o MySQL sabe que essas bibliotecas est√£o gerando depend√™ncias.  √â bastante problem√°tico executar duas bases juntas.  No m√≠nimo, √© problem√°tico para clientes antigos se conectarem ao novo banco de dados.  Por sua vez, isso causa v√°rios problemas. </p><br><p>  O pr√≥ximo problema √© quando o desenvolvedor trabalha na m√°quina local, ele usa recursos locais, arquivos locais, RAM local.  Toda a intera√ß√£o no momento do desenvolvimento da solu√ß√£o para o problema √© realizada no √¢mbito do fato de funcionar em uma m√°quina.  Um exemplo √© quando temos servidores back-end na Produ√ß√£o 3, e o desenvolvedor salva os arquivos no diret√≥rio raiz e, a partir da√≠, o nginx leva os arquivos para responder √† solicita√ß√£o.  Quando esse c√≥digo cai em Produ√ß√£o, acontece que o arquivo est√° presente em um dos tr√™s servidores. </p><br><p>  Agora, a dire√ß√£o dos microsservi√ßos est√° se desenvolvendo.  Quando dividimos nossos aplicativos grandes em alguns componentes pequenos que interagem entre si.  Isso permite selecionar a tecnologia para uma pilha de tarefas espec√≠fica.  Tamb√©m permite compartilhar o trabalho e a √°rea de responsabilidade entre os desenvolvedores. </p><br><p>  Frondend-developer, desenvolvendo em JS, praticamente n√£o afeta o Backend.  O desenvolvedor de back-end, por sua vez, desenvolve, no nosso caso, Ruby on Rails e n√£o interfere no Frondend.  A intera√ß√£o √© realizada usando a API. </p><br><p>  Como b√¥nus, com o Docker, pudemos utilizar recursos no teste.  Cada projeto, devido √† sua especificidade, exigiu determinadas configura√ß√µes.  Fisicamente, era necess√°rio selecionar um servidor virtual e configur√°-lo separadamente, ou compartilhar algum tipo de ambiente vari√°vel, e os projetos poderiam influenciar um ao outro, dependendo da vers√£o das bibliotecas. </p><br><p><img src="https://habrastorage.org/webt/ue/fu/5h/uefu5hbokfkhivcwpffwt5xi4hi.png"></p><br><p>  Ferramentas  O que usamos? </p><br><ul><li>  Diretamente o pr√≥prio Docker.  Dockerfile descreve depend√™ncias de um aplicativo. </li><li>  O Docker-compose √© um pacote que re√∫ne alguns de nossos aplicativos Docker. </li><li>  GitLab que usamos para armazenar o c√≥digo fonte. </li><li>  Usamos o GitLab-CI para integra√ß√£o de sistemas. </li></ul><br><p><img src="https://habrastorage.org/webt/yq/z-/zb/yqz-zbkwsjbklpjpkxf6pzqasya.png"></p><br><p>  O relat√≥rio consiste em duas partes. </p><br><p>  A primeira parte abordar√° como executar o Docker em m√°quinas de desenvolvimento. </p><br><p>  A segunda parte abordar√° como interagir com o GitLab, como executamos testes e como implementamos o teste. </p><br><p><img src="https://habrastorage.org/webt/tk/4w/lm/tk4wlm_ul847kzentzlw1ikjypq.png"></p><br><p>  O Docker √© uma tecnologia que permite (usando uma abordagem declarativa) descrever os componentes necess√°rios.  Este √© um exemplo de um Dockerfile.  Aqui anunciamos que estamos herdando da imagem oficial do Ruby Docker: 2.3.0.  Ele cont√©m o Ruby instalado vers√£o 2.3.  Instalamos as bibliotecas de constru√ß√£o necess√°rias e o NodeJS.  Descrevemos que criamos o diret√≥rio <code>/app</code> .  Atribua o diret√≥rio do aplicativo ao diret√≥rio de trabalho.  Neste diret√≥rio, colocamos o Gemfile e Gemfile.lock m√≠nimos necess√°rios.  Em seguida, criamos os projetos que instalam essa imagem de depend√™ncia.  Indicamos que o cont√™iner estar√° pronto para escutar na porta externa 3000. O √∫ltimo comando √© o comando que inicia diretamente nosso aplicativo.  Se executarmos o comando start do projeto, o aplicativo tentar√° executar e iniciar o comando especificado. </p><br><p><img src="https://habrastorage.org/webt/yc/vn/mp/ycvnmp4_o5pcl9r9hobxbchmntw.png"></p><br><p>  Este √© um exemplo m√≠nimo de um arquivo de composi√ß√£o de encaixe.  Nesse caso, mostramos que h√° uma conex√£o entre os dois cont√™ineres.  Isso √© diretamente no servi√ßo de banco de dados e no servi√ßo da web.  Na maioria dos casos, nossos aplicativos da web exigem algum tipo de banco de dados como back-end para armazenamento de dados.  Como usamos o MySQL, o exemplo est√° no MySQL - mas nada nos impede de usar algum tipo de banco de dados de amigos (PostgreSQL, Redis). </p><br><p>  Pegamos a imagem do MySQL 5.7.14 da fonte oficial com o hub Docker inalterado.  A imagem respons√°vel por nosso aplicativo da web que coletamos do diret√≥rio atual.  Ele, durante o primeiro lan√ßamento, coleta uma imagem para n√≥s.  Em seguida, lan√ßa o comando que executamos aqui.  Se voltarmos, veremos que o comando de lan√ßamento atrav√©s do Puma foi definido.  Puma √© um servi√ßo escrito em Ruby.  No segundo caso, redefinimos.  Este comando pode ser arbitr√°rio, dependendo de nossas necessidades ou tarefas. </p><br><p>  Tamb√©m descrevemos o que voc√™ precisa para encaminhar a porta em nossa m√°quina host de 3000 para 3000 porta container.  Isso √© feito automaticamente usando o iptables e seu pr√≥prio mecanismo, diretamente incorporado ao Docker. </p><br><p>  O desenvolvedor pode, como antes, aplicar a qualquer endere√ßo IP dispon√≠vel, por exemplo, 127.0.0.1 endere√ßo IP local ou externo da m√°quina. </p><br><p>  A √∫ltima linha diz que o cont√™iner da web depende do cont√™iner db.  Quando chamamos o lan√ßamento do cont√™iner da web, o docker-compose iniciar√° o banco de dados para n√≥s.  J√° no in√≠cio do banco de dados (de fato, depois de iniciar o cont√™iner! Isso n√£o garante a prontid√£o do banco de dados), lan√ßaremos um aplicativo, nosso back-end. </p><br><p>  Isso permite evitar erros quando o banco de dados n√£o √© gerado e salvar recursos quando paramos o cont√™iner do banco de dados, liberando os recursos para outros projetos. </p><br><p><img src="https://habrastorage.org/webt/s3/r1/9g/s3r19gc5pybevceyecewxzsdyxq.png"></p><br><p>  O que nos d√° o uso do banco de dados de dockeriza√ß√£o no projeto.  Todos os desenvolvedores corrigimos a vers√£o do MySQL.  Isso permite evitar alguns erros que podem ocorrer quando h√° uma diverg√™ncia de vers√µes, quando a sintaxe, a configura√ß√£o e as configura√ß√µes padr√£o s√£o alteradas.  Isso permite que voc√™ especifique um nome de host comum para o banco de dados, login e senha.  Afastamo-nos dos nomes e conflitos do zool√≥gico nos arquivos de configura√ß√£o anteriores. </p><br><p>  Podemos usar uma configura√ß√£o mais ideal para o ambiente de desenvolvimento, que ser√° diferente do padr√£o.  O MySQL √© configurado por padr√£o em m√°quinas fracas e seu desempenho imediato √© muito baixo. </p><br><p><img src="https://habrastorage.org/webt/b2/qh/uz/b2qhuzt2zgbx5upj9etfnoilrnw.png"></p><br><p>  O Docker permite usar o interpretador Python, Ruby, NodeJS, PHP da vers√£o desejada.  N√≥s nos livramos da necessidade de usar algum tipo de gerenciador de vers√µes.  Anteriormente, Ruby usava o pacote rpm, que permitia alterar a vers√£o dependendo do projeto.  Isso tamb√©m permite que o cont√™iner do Docker migre o c√≥digo sem problemas e fa√ßa a vers√£o juntamente com as depend√™ncias.  N√£o temos problemas para entender a vers√£o do int√©rprete e do c√≥digo.  Para atualizar a vers√£o, abaixe o cont√™iner antigo e levante o novo cont√™iner.  Se algo der errado, podemos abaixar o novo cont√™iner, elevar o cont√™iner antigo. </p><br><p>  Ap√≥s a montagem da imagem, os cont√™ineres em Desenvolvimento e Produ√ß√£o ser√£o os mesmos.  Isto √© especialmente verdade para grandes instala√ß√µes. </p><br><p><img src="https://habrastorage.org/webt/c3/vy/yx/c3vyyxestdms3fuo6vqpst5hhus.png">  No Frontend, usamos JavaScipt e NodeJS. </p><br><p>  Agora temos o projeto mais recente no ReacJS.  O desenvolvedor executou todo o cont√™iner e desenvolveu usando hot-reload. </p><br><p>  Em seguida, a tarefa de montar o JavaScipt √© iniciada e o c√≥digo coletado na est√°tica √© fornecido atrav√©s dos recursos de economia do nginx. </p><br><p><img src="https://habrastorage.org/webt/6k/8y/ds/6k8yds401e1tmspqtvsnpv9hyq8.png"></p><br><p>  Aqui eu dei um diagrama do nosso √∫ltimo projeto. </p><br><p>  Que tarefas voc√™ resolveu?  Precisamos criar um sistema com o qual os dispositivos m√≥veis interajam.  Eles obt√™m dados.  Uma das op√ß√µes √© enviar notifica√ß√µes por push para este dispositivo. </p><br><p>  O que fizemos para isso? </p><br><p>  Dividimos em componentes de aplicativos como: a parte administrativa em JS, o back-end, que funciona atrav√©s da interface REST no Ruby on Rails.  O back-end interage com o banco de dados.  O resultado gerado √© fornecido ao cliente.  O administrador com back-end e banco de dados interage via interface REST. </p><br><p>  Tamb√©m precisamos enviar notifica√ß√µes por push.  Antes disso, t√≠nhamos um projeto no qual era implementado um mecanismo respons√°vel por entregar notifica√ß√µes √†s plataformas m√≥veis. </p><br><p>  Desenvolvemos esse esquema: o operador do navegador interage com o painel de administra√ß√£o, o painel de administra√ß√£o interage com o back-end, a tarefa √© enviar notifica√ß√µes por push. </p><br><p>  As notifica√ß√µes por push interagem com outro componente implementado no NodeJS. </p><br><p>  As filas est√£o sendo criadas e o envio de notifica√ß√µes segue seu pr√≥prio mecanismo. </p><br><p>  Dois bancos de dados s√£o desenhados aqui.  No momento, com a ajuda do Docker, usamos 2 bancos de dados independentes, que n√£o est√£o de forma alguma conectados entre si.  Al√©m disso, eles t√™m uma rede virtual comum e os dados f√≠sicos s√£o armazenados em diferentes diret√≥rios na m√°quina do desenvolvedor. </p><br><p><img src="https://habrastorage.org/webt/7l/vd/iz/7lvdizkbaiozesiqkfy6zeu0ila.png"></p><br><p>  A mesma coisa, mas em n√∫meros.  Reutilizar c√≥digo √© importante aqui. </p><br><p>  Se falamos anteriormente sobre a reutiliza√ß√£o de c√≥digo na forma de bibliotecas, neste exemplo, nosso servi√ßo, que responde a notifica√ß√µes por push, √© reutilizado como um servidor completo.  Ele fornece uma API.  E j√° com o nosso novo desenvolvimento interage com ele. </p><br><p>  Naquela √©poca, usamos a vers√£o 4 do NodeJS.  Agora (em 2017 - nota. Ed.) Nos desenvolvimentos recentes, usamos a vers√£o 7 do NodeJS.  N√£o h√° problema em novos componentes para atrair novas vers√µes de bibliotecas. </p><br><p>  Se necess√°rio, voc√™ pode refatorar e atualizar a vers√£o NodeJS do servi√ßo de notifica√ß√£o por push. </p><br><p>  E se podemos manter a compatibilidade da API, podemos substitu√≠-la por outros projetos que foram usados ‚Äã‚Äãanteriormente. </p><br><p><img src="https://habrastorage.org/webt/wd/xv/4a/wdxv4acjvor1iz_4ay2iaxhwylg.png"></p><br><p>  O que voc√™ precisa para adicionar o Docker?  Adicione um Dockerfile ao nosso reposit√≥rio que descreva as depend√™ncias necess√°rias.  Neste exemplo, os componentes s√£o divididos por l√≥gica.  Este √© um conjunto m√≠nimo de desenvolvedor de back-end. </p><br><p>  Ao criar um novo projeto, crie um Dockerfile, descreva o ecossistema desejado (Python, Ruby, NodeJS).  A janela de encaixe-compor descreve a depend√™ncia necess√°ria - o banco de dados.  Descrevemos que precisamos de um banco de dados dessa e de tal vers√£o para armazenar os dados em algum lugar. </p><br><p>  Usamos um terceiro cont√™iner separado com nginx para tornar est√°tico.  Voc√™ pode fazer upload de fotos.  O back-end os coloca em um volume pr√©-preparado, que tamb√©m √© montado em um cont√™iner com nginx, que fornece est√°tica. </p><br><p>  Para armazenar a configura√ß√£o nginx, mysql, adicionamos a pasta Docker, na qual armazenamos as configura√ß√µes necess√°rias.  Quando um desenvolvedor cria um reposit√≥rio git clone em sua m√°quina, ele j√° prepara um projeto para o desenvolvimento local.  N√£o se coloca a quest√£o de qual porta ou quais configura√ß√µes aplicar. </p><br><p><img src="https://habrastorage.org/webt/vx/by/f2/vxbyf2i8sss85npgtavlhvgoe10.png"></p><br><p>  Al√©m disso, temos v√°rios componentes: admin, inform-API, push-Notifications. </p><br><p>  Para executar tudo, criamos outro reposit√≥rio chamado dockerized-app.  Atualmente, usamos v√°rios reposit√≥rios at√© cada componente.  Eles diferem logicamente - no GitLab parece uma pasta e, na m√°quina do desenvolvedor, uma pasta para um projeto espec√≠fico.  Um n√≠vel abaixo s√£o os componentes que ser√£o combinados. </p><br><p><img src="https://habrastorage.org/webt/jd/ny/wq/jdnywqfo2xha1huuqqmnhb1bvpm.png"></p><br><p>  Este √© um exemplo apenas do conte√∫do do aplicativo dockerized.  Tamb√©m trazemos o cat√°logo do Docker aqui, no qual preenchemos as configura√ß√µes necess√°rias para intera√ß√µes de todos os componentes.  Existe o arquivo README.md, que descreve brevemente como iniciar um projeto. </p><br><p>  Aqui usamos dois arquivos de composi√ß√£o de encaixe.  Isso √© feito para poder executar as etapas.  Quando um desenvolvedor trabalha com o kernel, ele n√£o precisa de notifica√ß√µes por push, ele apenas inicia o arquivo de docker-compose e, portanto, o recurso √© salvo. </p><br><p>  Se houver necessidade de integra√ß√£o com notifica√ß√µes por push, o docker-compose.yaml e o docker-compose-push.yaml ser√£o iniciados. </p><br><p>  Como o docker-compose.yaml e o docker-compose-push.yaml est√£o na pasta, uma √∫nica rede virtual √© criada automaticamente. </p><br><p><img src="https://habrastorage.org/webt/hb/sj/ua/hbsjuao3tzaozzkhtv97lzhinn8.png"></p><br><p>  Descri√ß√£o dos componentes.  Este √© um arquivo mais avan√ßado que √© respons√°vel pela coleta de componentes.  O que √© not√°vel aqui?  Aqui apresentamos o componente balanceador. </p><br><p>  Essa √© uma imagem pronta do Docker na qual o nginx √© iniciado e um aplicativo que escuta o soquete do Docker.  Din√¢mico, √† medida que os cont√™ineres s√£o ativados e desativados, a configura√ß√£o do nginx ser√° gerada novamente.  Distribu√≠mos o manuseio de componentes por nomes de dom√≠nio de terceiro n√≠vel. </p><br><p>  Para o ambiente de desenvolvimento, usamos o dom√≠nio .dev - api.informer.dev.  Os aplicativos com o dom√≠nio .dev est√£o dispon√≠veis na m√°quina do desenvolvedor local. </p><br><p>  Em seguida, as configura√ß√µes s√£o transferidas para cada projeto e todos os projetos s√£o lan√ßados juntos ao mesmo tempo. </p><br><p><img src="https://habrastorage.org/webt/ew/i0/_u/ewi0_udkilodmivdjgfjoqt9try.png"></p><br><p>  Se representado graficamente, o cliente √© o nosso navegador ou alguma ferramenta com a qual realizamos solicita√ß√µes para o balanceador. </p><br><p>  O balanceador de nome de dom√≠nio determina qual cont√™iner acessar. </p><br><p>  Pode ser o nginx, que fornece a √°rea de administra√ß√£o do JS.  Pode ser o nginx, que fornece a API ou os arquivos est√°ticos fornecidos ao nginx na forma de carregamento de imagens. </p><br><p>  O diagrama mostra que os cont√™ineres est√£o conectados por uma rede virtual e est√£o ocultos atr√°s do proxy. </p><br><p>  Na m√°quina do desenvolvedor, voc√™ pode acessar o cont√™iner sabendo IP, mas basicamente n√£o o usamos.  A necessidade de tratamento direto praticamente n√£o surge. </p><br><p><img src="https://habrastorage.org/webt/6j/wa/af/6jwaaff9m7e_lwmgvxi88fxxkbi.png"></p><br><p>  Que exemplo procurar para dockerize o aplicativo?  Na minha opini√£o, um bom exemplo √© a imagem oficial do docker para MySQL. </p><br><p>  Isso √© bastante complicado.  Existem muitas vers√µes.  Mas sua funcionalidade permite que voc√™ cubra muitas necessidades que possam surgir no processo de desenvolvimento adicional.  Se voc√™ gastar tempo e descobrir como tudo isso interage, acho que voc√™ n√£o ter√° problemas na auto-implementa√ß√£o. </p><br><p>  No hub.docker.com, geralmente existem links para o github.com, que fornecem dados brutos diretamente a partir dos quais voc√™ pode montar a imagem. </p><br><p>  Mais adiante neste reposit√≥rio est√° o script docker-endpoint.sh, respons√°vel pela inicializa√ß√£o inicial e pelo processamento adicional do lan√ßamento do aplicativo. </p><br><p>  Tamb√©m neste exemplo, h√° a possibilidade de configura√ß√£o usando vari√°veis ‚Äã‚Äãde ambiente.  Ao definir a vari√°vel de ambiente ao iniciar um √∫nico cont√™iner ou via docker-compose, podemos dizer que precisamos definir uma senha vazia para docker on para root no MySQL ou o que desejar. </p><br><p>  Existe uma op√ß√£o para criar uma senha aleat√≥ria.  Dizemos que precisamos de um usu√°rio, precisamos definir uma senha para o usu√°rio e precisamos criar um banco de dados. </p><br><p>  Em nossos projetos, unificamos levemente o Dockerfile, respons√°vel pela inicializa√ß√£o.  L√°, corrigimos nossas necessidades para fazer apenas uma extens√£o dos direitos do usu√°rio que o aplicativo usa.  Isso permitiu no futuro simplesmente criar um banco de dados a partir do console do aplicativo.  Os aplicativos Ruby t√™m um comando para criar, modificar e excluir bancos de dados. </p><br><p><img src="https://habrastorage.org/webt/sj/cn/jy/sjcnjytvgchv17vawenbd66upls.png"></p><br><p>  Este √© um exemplo de como uma vers√£o espec√≠fica do MySQL se parece no github.com.  Voc√™ pode abrir o dockerfile e ver como a instala√ß√£o est√° acontecendo l√°. </p><br><p>  script docker-endpoint.sh respons√°vel pelo ponto de entrada.  Durante a inicializa√ß√£o, algumas etapas de prepara√ß√£o s√£o necess√°rias e todas essas a√ß√µes s√£o executadas apenas no script de inicializa√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/7h/z4/hy/7hz4hyunbt1ftm38hf9lnmesv3q.png"></p><br><p>  Passamos para a segunda parte. </p><br><p>  Para armazenar o c√≥digo fonte, mudamos para o gitlab.  Este √© um sistema bastante poderoso que possui uma interface visual. </p><br><p>  Um dos componentes do Gitlab √© o Gitlab CI.  Ele permite que voc√™ descreva os comandos de acompanhamento que ser√£o usados ‚Äã‚Äãposteriormente para organizar um sistema de entrega de c√≥digo ou executar testes autom√°ticos. </p><br><p>  Relat√≥rio sobre o Gitlab CI 2 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://goo.gl/uohKjI</a> - um relat√≥rio do clube Ruby Russia - bastante detalhado e talvez seja do seu interesse. </p><br><p><img src="https://habrastorage.org/webt/9f/s8/pk/9fs8pkzbqq4uozrmd2bu4tq0-dg.png"></p><br><p>  Agora vamos considerar o que √© necess√°rio para ativar o Gitlab CI.  Para iniciar o Gitlab CI, basta colocar o arquivo .gitlab-ci.yml na raiz do projeto. </p><br><p>  Aqui descrevemos que queremos executar uma sequ√™ncia de estados, como teste, implanta√ß√£o. </p><br><p>  Executamos scripts que chamam diretamente docker-componha a montagem de nosso aplicativo.  Este √© um exemplo de apenas um back-end. </p><br><p>  Em seguida, dizemos que √© necess√°rio conduzir migra√ß√µes para alterar o banco de dados e executar testes. </p><br><p>  Se os scripts forem executados corretamente e n√£o retornarem um c√≥digo de erro, o sistema continuar√° para o segundo est√°gio da implanta√ß√£o. </p><br><p>  A fase de implanta√ß√£o est√° atualmente implementada para prepara√ß√£o.  N√£o organizamos uma reinicializa√ß√£o suave. </p><br><p>  N√≥s extinguimos todos os cont√™ineres √† for√ßa e depois levantamos todos os cont√™ineres, coletados no primeiro est√°gio durante o teste. </p><br><p>  Estamos executando o ambiente vari√°vel atual de migra√ß√£o de banco de dados, que foi escrito pelos desenvolvedores. </p><br><p>  H√° uma observa√ß√£o que aplica isso apenas √† ramifica√ß√£o principal. </p><br><p>  Ao alterar outros ramos n√£o √© executado. </p><br><p>  √â poss√≠vel organizar lan√ßamentos em filiais. </p><br><p><img src="https://habrastorage.org/webt/2x/vc/6t/2xvc6tp0zrtrewnpnekatolnipm.png"></p><br><p>  Para organizar ainda mais isso, precisamos instalar o Gitlab Runner. </p><br><p>  Este utilit√°rio est√° escrito em Golang.  √â um arquivo √∫nico, como √© habitual no mundo Golang, que n√£o requer nenhuma depend√™ncia. </p><br><p>  Na inicializa√ß√£o, registramos o Gitlab Runner. </p><br><p>  N√≥s obtemos a chave na interface da web do Gitlab. </p><br><p>  Ent√£o chamamos o comando init na linha de comando. </p><br><p>  Configurar o Gitlab Runner no modo de di√°logo (Shell, Docker, VirtualBox, SSH) </p><br><p>  O c√≥digo no Gitlab Runner ser√° executado a cada confirma√ß√£o, dependendo da configura√ß√£o .gitlab-ci.yml. </p><br><p><img src="https://habrastorage.org/webt/jj/nx/c-/jjnxc-msfkvaey7qs-t6n3kbzww.png"></p><br><p>  Como √© visualmente visualizado no Gitlab em uma interface da web.  Depois de conectar o IC do GItlab, aparece um sinalizador que mostra o estado atual da compila√ß√£o. </p><br><p>  Vimos que uma confirma√ß√£o foi feita h√° 4 minutos, que passou em todos os testes e n√£o causou problemas. </p><br><p><img src="https://habrastorage.org/webt/da/vg/3h/davg3h0aqnoewa2xlu3eebuz5jg.png"></p><br><p>  Podemos ver as constru√ß√µes com mais detalhes.  Aqui vemos que dois estados j√° passaram.  Testando o status e o status de implementa√ß√£o na prepara√ß√£o. </p><br><p>  Se clicarmos em uma constru√ß√£o espec√≠fica, haver√° uma sa√≠da do console dos comandos que foram iniciados no processo de acordo com .gitlab-ci.yml. </p><br><p><img src="https://habrastorage.org/webt/dg/zq/a5/dgzqa5difiuz1yw0e4i99jzgfik.png"></p><br><p>  √â assim que a hist√≥ria do nosso produto se parece.  Vimos que houve tentativas bem-sucedidas.  Quando os testes s√£o enviados, ele n√£o prossegue para a pr√≥xima etapa e o c√≥digo para prepara√ß√£o n√£o √© atualizado. </p><br><p><img src="https://habrastorage.org/webt/cp/g9/rv/cpg9rvvjttpmkvdmi-ve-ugtoh0.png"></p><br><p>  Que tarefas resolvemos na prepara√ß√£o quando introduzimos o docker?           ,   ,     ,     . </p><br><p>         . </p><br><p>              Docker-compose           . </p><br><p>    ,     Docker .  Docker-compose        . </p><br><p>    ,           . </p><br><p>   ‚Äî   staging   . </p><br><p>            production   80  443 ,     WEB. </p><br><p><img src="https://habrastorage.org/webt/7w/4n/_d/7w4n_dfgts6p7pxijvb6eznq0m0.png"></p><br><p>    ?    Gitlab Runner   . </p><br><p> Gitlab     Gitlab Runner,    -      ,  . </p><br><p>             Gitlab Runner,       . </p><br><p>   nginx-proxy           . </p><br><p>      ,        .       . </p><br><p>        80      ,    . </p><br><p><img src="https://habrastorage.org/webt/az/ke/y8/azkey8kpxp3ruww8fbdc1bnfowk.png"></p><br><p>    ?           root.  root  root  . </p><br><p>     ,    root  ,         root. </p><br><p>         - ,   ,    ,        ,     . </p><br><p>    ?   ,    . </p><br><p>   ,    ? </p><br><p>        ID  (UID)  ID  (GID). </p><br><p>           ID 1000. </p><br><p>               Ubuntu.    Ubuntu    ID 1000. </p><br><p><img src="https://habrastorage.org/webt/wx/th/35/wxth352n7tza8gkpdfcmtaern3m.png"></p><br><p>    ? </p><br><p>    Docker.   ,  . ,    -  ,   . </p><br><p>  ,         . </p><br><p>         . </p><br><p>       Docker    Docker Swarm,    .   -     Docker Swarm. </p><br><p>       .   .    .          web-. </p><br><p><img src="https://habrastorage.org/webt/k8/uh/lw/k8uhlwuir8yffyugvdrupropoba.png"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt449742/">https://habr.com/ru/post/pt449742/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt449722/index.html">Efeitos de canto</a></li>
<li><a href="../pt449724/index.html">Liquidantes de a√ßo</a></li>
<li><a href="../pt449728/index.html">Tr√°fego ou criptografia de tr√°fego no Direct Connect, parte 3</a></li>
<li><a href="../pt449730/index.html">Criptomoeda: vive ou morre? Parte 2. Tend√™ncias pol√≠ticas e econ√¥micas</a></li>
<li><a href="../pt449740/index.html">Assistimos "Janela da cidade" em alta qualidade</a></li>
<li><a href="../pt449744/index.html">Cache de resultados de consulta global no ASP.NET CORE</a></li>
<li><a href="../pt449746/index.html">DockerHub hackeado</a></li>
<li><a href="../pt449748/index.html">Quem √© quem no c√≥digo aberto - Parte 2: biografias de geeks</a></li>
<li><a href="../pt449750/index.html">Uma ferramenta de monitoramento de rede aberta com dispositivos IoT</a></li>
<li><a href="../pt449752/index.html">Cart√µes magn√©ticos caseiros para calculadora Casio PRO fx-1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>