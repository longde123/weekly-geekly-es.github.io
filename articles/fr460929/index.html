<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕺🏿 💍 👩🏽‍🎓 Atlassian Confluence: extensible en python ❣️ 👨‍👨‍👧‍👦 🛵</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans Alfastrakhovanie, nous utilisons activement le "Wiki", dont le moteur est Atlassian Confluence. La première fois que je l'ai rencontré sérieuseme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Atlassian Confluence: extensible en python</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/alfastrah/blog/460929/"><p>  Dans Alfastrakhovanie, nous utilisons activement le "Wiki", dont le moteur est Atlassian Confluence.  La première fois que je l'ai rencontré sérieusement (dans une tentative de créer du contenu), je manquais de «dynamisme» - je voulais pouvoir former par programmation des parties de pages, interagir avec d'autres systèmes, etc. </p><br><p>  Pendant un certain temps, il s'est cogné la tête contre différents murs, mais il a ensuite vu qu '«il n'y avait pas un mur dans la maison».  Je veux partager mon expérience - comment ajouter des haut-parleurs à Confluence.  J'espère que cela sera utile à ceux qui l'utilisent.  Et, comme d'habitude, à tout le monde curieux. </p><a name="habracut"></a><br><h2 id="dinamichnyy-viki">  Wiki dynamique </h2><br><p>  Initialement, Confluence propose une façon universelle d'étendre ses fonctionnalités: les plugins.  Probablement, il est bon, il n'y a qu'un seul inconvénient - un seuil d'entrée élevé (vous devez apprendre beaucoup). </p><br><p>  Après une courte réflexion (selon les normes spatiales), il y avait deux façons plus simples d'étendre ses fonctionnalités: la macro standard "HTML" et "HTML Include", dans cet article, je me concentrerai sur ce dernier plus en détail. </p><br><p>  Il existe un principe de fonctionnement pour ces méthodes: le code HTML est intégré à la page Confluence, il peut être statique (ce qui peut également être intéressant, par exemple, pour un formatage de page non standard), et peut être dynamique (y compris les composants du serveur). </p><br><h2 id="primer-zapros-na-soglasovanie">  Exemple: demande de rapprochement </h2><br><p>  Examinons la façon proposée d'étendre les capacités de Confluence avec un exemple simple - une liste d'approbation de documents. </p><br><p>  Ce que nous voulons faire: ajouter une liste d'approbation à la page afin que tout le monde puisse voir qui devrait être d'accord sur le document, s'il a été accepté et, si oui, quand. </p><br><p>  Pour plus de commodité, nous ferons de l'élément de liste un bouton et y inscrirons le nom du coordinateur.  Le bouton sera actif si la page est consultée par le coordinateur, et pas actif dans tous les autres cas. </p><br><p> Après approbation, le bouton "cessera d'être un bouton" - au lieu du bouton après approbation, nous tracerons sur la page le fait de l'approbation sous forme de texte (le nom de l'approbateur et la date d'approbation).  Dans la version la plus brouillon (sans design), cela peut ressembler à ceci: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3cf/285/175/3cf2851757c85ff0c8994dde698ec5d7.png" alt="image"></p><br><h3 id="shema-vzaimodeystviya">  Schéma d'interaction </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/600/48b/a4c/60048ba4cdef1ccdd55a355cb8bf3c19.png" alt="image"></p><br><p>  Commentaires - comment cela fonctionne: </p><br><ul><li>  la page dans Confluence contient plusieurs macros "html include" - en fait des requêtes HTTP GET avec des paramètres (nous examinerons plus en détail ci-dessous) </li><li>  lors du rendu d'une page, ces requêtes (scripts python) sont exécutées sur le serveur d'application, le résultat (HTML généré) est dessiné sur la page </li><li>  au cours de son travail, le script, par exemple, contacte la base de données avec l'historique de la signature de page, si la page n'a pas encore été "signée" par le signataire - HTML contiendra un bouton (tout comme décrit ci-dessus) </li><li>  lorsque vous cliquez sur le bouton, la soumission se produit - un autre script python est appelé (un script pour traiter le fait de la coordination) </li><li>  ce script enregistre des informations sur le fait de se connecter à la base de données et redirige l'utilisateur vers la page d'origine (lors du rendu dont le fait de la signature sera pris en compte - en cliquant sur le bouton "signer") </li></ul><br><p>  Un peu compliqué en mots, essayons de clarifier le code. </p><br><p>  Nous devons donc créer deux scripts </p><br><ul><li>  le script pour la formation du bouton "signe" (je l'appellerai le bouton "bouton") </li><li>  un script pour déterminer le fait de signer (réaction à un clic sur un bouton - j'appellerai son script "gestionnaire") </li></ul><br><p>  Créons-les, commençons par le bouton. </p><br><h4 id="skript-knopka">  Bouton de script </h4><br><p>  Schématiquement, comment fonctionne le script de bouton: </p><br><pre><code class="python hljs">date = getSignDate() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> date: <span class="hljs-comment"><span class="hljs-comment">#       . else: if user==signee: #    else: #  inactive </span></span></code> </pre> <br><p>  Le script doit être un document HTML valide, dont le corps sous la forme la plus minimale est un formulaire </p><br><ul><li>  l'action du formulaire contient l'URL du script "handler" </li><li>  le bouton actif est soumettre </li><li>  les champs de formulaire masqués contiennent des paramètres supplémentaires pour le gestionnaire (dans notre cas, le nom de la page et la connexion du signataire) </li></ul><br><p>  Une vue approximative du script (par souci de concision, j'ai jeté tout ce qui n'était pas nécessaire - voir le code de travail complet sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> ) </p><br><pre> <code class="python hljs">form = cgi.FieldStorage() signee = form[<span class="hljs-string"><span class="hljs-string">"signee"</span></span>].value <span class="hljs-comment"><span class="hljs-comment">#   (  ) actual = form["actual"].value #    id = form["id"].value #  ,    resHtml = """ &lt;!DOCTYPE HTML&gt; &lt;html&gt; &lt;head&gt;&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;&lt;/head&gt; &lt;body&gt; &lt;form name="input" action="http://172.16.108.216/misc/sign_proc.py" method="get"&gt; """ server, token = wikiLogin() #   Confluence userName = getUserName(token, signee) #        res = getSignDate(id, signee) #     if res: #    resHtml += "&lt;p&gt; ({0}, {1})&lt;/p&gt;".format(userName, res) #   else: #    if signee.lower() == actual.lower(): #      -   resHtml += '&lt;input type="hidden" name="id" value="{0}"&gt;'.format(id) resHtml += '&lt;input type="hidden" name="signee" value="{0}"&gt;'.format(signee) resHtml += "   &lt;input type=\"submit\" value=\"{0}\"&gt;".format(userName) else: #      -    resHtml += "   &lt;input disabled type=\"submit\" value=\"{0}\"&gt;".format(userName) resHtml += "&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;" #   HTML sys.stdout.buffer.write(b'Content-Type: text/html;charset=utf-8\n\n') sys.stdout.buffer.write(resHtml.encode("utf-8"))</span></span></code> </pre> <br><h4 id="skript-obrabotchik">  Script "gestionnaire" </h4><br><p>  La tâche du gestionnaire est très simple - corriger le fait d'appuyer sur le bouton "Accepter".  Redirigez ensuite vers la page d'où provient la demande - lors du rendu de la page, le fait de la coordination sera déjà pris en compte (voir la description ci-dessus). </p><br><p>  Un exemple (abrégé) de script "handler" (la version complète - voir github) </p><br><pre> <code class="python hljs">form = cgi.FieldStorage() signee = form[<span class="hljs-string"><span class="hljs-string">"signee"</span></span>].value <span class="hljs-comment"><span class="hljs-comment">#   id = form["id"].value #  ,    addSignDate(id, signee) #    resHtml = """ &lt;html&gt; &lt;head&gt; &lt;meta http-equiv="refresh" content="5;url=http://wiki.alfastrah.ru/display/DIT/{0}"&gt; &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt; &lt;title&gt; &lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;p&gt;    &lt;b&gt;{0}&lt;/b&gt;  &lt;b&gt;{1}&lt;/b&gt; . &lt;br&gt;      ...&lt;/p&gt; &lt;/body&gt; &lt;/html&gt; """.format(id, signee) sys.stdout.buffer.write(b'Content-Type: text/html;charset=utf-8\n\n') sys.stdout.buffer.write(resHtml.encode("utf-8"))</span></span></code> </pre> <br><h4 id="stranica-v-confluence">  Page dans Confluence </h4><br><p>  La page de Confluence contient trois macro HTML include avec différents paramètres (voir le code ci-dessous) et dans la version la plus simple ressemble à ceci: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/7ba/788/498/7ba788498511262c7e13618503eae77e.png" alt="image"></p><br><p>  Code de page au format de balisage wiki - ici vous pouvez voir les paramètres </p><br><pre> <code class="plaintext hljs">&lt;h1&gt; &lt;/h1&gt; &lt;p&gt; ,  &lt;/p&gt; &lt;h1&gt; &lt;/h1&gt; &lt;ul&gt; &lt;li&gt; &lt;ac:structured-macro ac:macro-id="..." ac:name="html-include" ac:schema-version="1"&gt; &lt;ac:parameter ac:name="url"&gt; &lt;ri:url ri:value="http://z14-0510-wiksap.vesta.ru/misc/sign_btn.py?signee=boss&amp;amp;actual=korolevmv&amp;amp;id=wikitools_sign"/&gt; &lt;/ac:parameter&gt; &lt;/ac:structured-macro&gt; &lt;/li&gt; &lt;li&gt; &lt;ac:structured-macro ac:macro-id="..." ac:name="html-include" ac:schema-version="1"&gt; &lt;ac:parameter ac:name="url"&gt; &lt;ri:url ri:value="http://z14-0510-wiksap.vesta.ru/misc/sign_btn.py?signee=korolevmv&amp;amp;actual=korolevmv&amp;amp;id=wikitools_sign"/&gt; &lt;/ac:parameter&gt; &lt;/ac:structured-macro&gt; &lt;/li&gt; &lt;li&gt; &lt;ac:structured-macro ac:macro-id="..." ac:name="html-include" ac:schema-version="1"&gt; &lt;ac:parameter ac:name="url"&gt; &lt;ri:url ri:value="http://z14-0510-wiksap.vesta.ru/misc/sign_btn.py?signee=maxvar&amp;amp;actual=korolevmv&amp;amp;id=wikitools_sign"/&gt; &lt;/ac:parameter&gt; &lt;/ac:structured-macro&gt; &lt;/li&gt; &lt;/ul&gt;</code> </pre> <br><h3 id="nemnogo-o-nastroyke">  Un peu de mise en place </h3><br><p>  Pour que le schéma décrit fonctionne, il est nécessaire de prendre en compte les éléments suivants: </p><br><h4 id="nalichie-makrosa-html-include">  Disponibilité de la macro HTML Include </h4><br><p>  Parfois, les administrateurs le «cachent» - il y a beaucoup de problèmes supplémentaires (de l'autre côté des possibilités). </p><br><p>  Cette macro est gratuite et fait partie de Confluence - si vous n'en avez pas, contactez les administrateurs, laissez-les regarder ... </p><br><h4 id="belye-spiski-confluence">  Listes blanches Confluence </h4><br><p>  Confluence n'exécutera pas de scripts hébergés sur des sources inconnues, l'hôte sur lequel le script est hébergé doit figurer dans les soi-disant «listes blanches» (contactez les administrateurs).  Cela ne s'applique qu'au script "bouton" - le script du gestionnaire est déjà appelé par le bouton, les restrictions de Confluence ne s'appliquent pas à lui. </p><br><h4 id="vypolnimost-skriptov">  Exécution de script </h4><br><p>  Les scripts (boutons et gestionnaire) doivent être exécutables - copiez l'URL dans le navigateur, cela devrait fonctionner et générer du HTML, si cela ne s'est pas produit, déboguez-le. </p><br><h4 id="oshibki-v-skriptah">  Erreurs de script </h4><br><p>  Si l'un des scripts se bloque avec une erreur - vous ne verrez rien de bon, déboguez correctement avant de publier sur Confluence. </p><br><h2 id="parametry-skriptov">  Options de script </h2><br><p>  Un esprit curieux pourrait prêter attention aux paramètres du script - d'une part, ils sont redondants (par exemple, le nom de la page sur laquelle le bouton d'approbation est placé - est-il connu, pourquoi le remplir?).  D'un autre côté, ils ne sont pas sûrs («l'attaquant» dans notre exemple peut changer le nom de l'approbateur en sien ou supprimer le bouton de réconciliation). </p><br><p>  La redondance peut être "surmontée" par les macros utilisateur (je me demande depuis longtemps - comment peuvent-elles être utiles dans la pratique? J'écrirai brièvement dans un article séparé).  La sécurité dans Confluence est assurée par l'historique des pages - tous les "mouvements" sont enregistrés, vous pouvez tout changer, dans Confluence il reste une merveilleuse "piste d'audit" qui vous permet de comprendre en détail qui a changé quoi et quand. </p><br><h2 id="vzaimodeystvie-so-stranicey">  Interaction avec la page </h2><br><p>  Dans notre pratique, il y a eu des cas où nous avons dû analyser le code de la page pour collecter des données (par exemple, c'est ainsi que nous avons géré le portefeuille de projets).  C'est possible et même pas trop difficile.  Evolutionnellement, nous sommes arrivés à la conclusion que si certaines informations sur une page sont nécessaires uniquement pour le code qui interprète ces informations, alors ces informations sont plus faciles à formuler immédiatement dans le code lui-même (sous la forme de JSON, par exemple): la modifier en mode d'édition de page est assez simple , il est tiré par le programme, mais les économies sur l'analyse et la fiabilité accrue sont importantes. </p><br><h2 id="esche-primery">  Plus d'exemples </h2><br><p>  Sinon, pourquoi avons-nous utilisé ces macros (comme idées - soudain, quelque chose se révèle utile), très brièvement </p><br><p>  Conception de la <strong>page</strong> : si vous souhaitez concevoir la page d'une manière non standard - balisage à l'aide de CSS, qui est contenu dans le bloc HTML </p><br><p>  <strong>Calendrier de vacances</strong> : nous utilisons un calendrier JS simple, le remplissons avec des données de JSON, que nous éditons directement dans le code de la page, nous obtenons une belle assiette avec des vacances ventilées (année, mois, semaine). </p><br><p>  <strong>Impression de cartes de tâches pour une carte Scrum</strong> : nous définissons les paramètres (numéros de tâches dans Jira et attributs supplémentaires) sous la forme directement sur la page wiki (dans le bloc HTML), le côté serveur forme les cartes sous une forme appropriée pour l'envoi à une imprimante. </p><br><p>  <strong>Gestion de portefeuille de projets</strong> : nous avons eu une telle idée.  Les cartes ont été notées directement sur le wiki (la carte de score est une page spécialement marquée), ces cartes ont collecté un plan à gros blocs, qui a été magnifiquement dessiné sous la forme d'un diagramme de Gantt. </p><br><p>  <strong>Glossaire</strong> : la possibilité de visualiser les termes - explications des mots individuels d'une page - à partir d'un dictionnaire commun et de publier des entrées de dictionnaire sous forme de "pop-ups".  Le dictionnaire lui-même est automatiquement collecté en bas de la page. </p><br><p>  <strong>Graphiques</strong> : si vous avez besoin de dessiner un graphique simple, il est très simple de le faire en incorporant le bloc HTML à l'un des packages standard (Google Charts, HighCharts, etc.) </p><br><p>  <strong>Tables</strong> : au-dessus de n'importe quelle table dans Confluence, vous pouvez "accrocher" Datatable - nous obtenons une table filtrée avec "pagination", très agréable et pratique. </p><br><p>  La liste peut être prolongée suffisamment longtemps, pendant le fonctionnement, un inconvénient important a été constaté: les erreurs dans le code du serveur sont mal détectées - 500 erreurs sont mal visualisées et ne contiennent pratiquement aucune information.  Sinon, expérimentez - c'est assez sûr. </p><br><h2 id="chut-podytozhim">  Pour résumer </h2><br><p>  La manière simple décrite ci-dessus pour augmenter le dynamisme de Confluence vous permet de résoudre de nombreux problèmes différents.  Pour l'utiliser, il ne nécessite pas d'outils et de compétences spéciaux.  L'utilisation est suffisamment sûre.  Je le recommande. </p><br><p>  Dans le prochain article, je parlerai de l'expérience de l'utilisation de macros personnalisées dans Confluence - qui, à mon avis, peut vraiment être améliorée avec leur aide. </p><br><p>  Tout est possible dans la programmation - une question de temps et de motivation seulement. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460929/">https://habr.com/ru/post/fr460929/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460911/index.html">Faire le bien, faire le mal: écrire du code maléfique avec Go, partie 2</a></li>
<li><a href="../fr460913/index.html">Visite photo du musée de l'Institut de physique et d'énergie d'Obninsk</a></li>
<li><a href="../fr460915/index.html">Système de gestion de base de données pratique</a></li>
<li><a href="../fr460923/index.html">Tâche de test Yandex</a></li>
<li><a href="../fr460925/index.html">Jeu en ligne avec de vrais robots RC à Tchernobyl. 2e partie</a></li>
<li><a href="../fr460931/index.html">À propos des décorateurs en Python</a></li>
<li><a href="../fr460933/index.html">Semaine de la sécurité 30: vie privée, technologie et société</a></li>
<li><a href="../fr460935/index.html">Prise en main de l'analyseur statique PVS-Studio pour Visual C #</a></li>
<li><a href="../fr460939/index.html">Longrid sur l'histoire de l'exploitation minière russe et l'attitude des régulateurs à son égard</a></li>
<li><a href="../fr460941/index.html">Compromis de courrier électronique professionnel: aucune défense contre les attaques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>