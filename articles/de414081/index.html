<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî§ üë≤üèº ü§ΩüèΩ Chatbot-Entwicklung f√ºr Facebook Messenger auf node.js üëçüèæ üë®‚Äçüíª üôç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Das Material, dessen √úbersetzung wir Ihnen heute vorstellen, ist der Entwicklung eines Chat-Bots f√ºr Facebook Messenger gewidmet. Ein Bot namens Aww B...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Chatbot-Entwicklung f√ºr Facebook Messenger auf node.js</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/414081/">  Das Material, dessen √úbersetzung wir Ihnen heute vorstellen, ist der Entwicklung eines Chat-Bots f√ºr Facebook Messenger gewidmet.  Ein Bot namens Aww Bot, der mit Benutzern kommuniziert, sendet ihnen Bilder von niedlichen Katzen und Hunden. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/lv/_r/ib/lv_ribnji-ia8qpcx065xneusls.jpeg"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Erste Schritte</font> </h2><br>  Beginnen wir mit der Erstellung einer Seite auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Facebook,</a> indem wir die erforderlichen Felder ausf√ºllen.  Diese Seite ist f√ºr den Bot.  Dar√ºber hinaus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">erstellen wir eine</a> Facebook-Anwendung. Anschlie√üend verbinden wir auf der Seite Produkt hinzuf√ºgen das Messenger-Produkt mit der Anwendung.  Als n√§chstes befinden wir uns auf der Seite mit den Messenger-Einstellungen.  Hier m√ºssen Sie den Abschnitt Token-Generierung finden - w√§hlen Sie die Bot-Seite in der Seitenliste aus.  Danach werden wir nach Berechtigungen gefragt und ein Zugriffstoken erstellt.  Der Bot verwendet dieses Token, um die Facebook Messenger-API aufzurufen, mit der er mit Benutzern kommunizieren kann. <br><br><h2>  <font color="#3AC1EF">Webserver-Setup</font> </h2><br>  Wir werden node.js und express.js verwenden, um einen HTTP-Server zu erstellen.  F√ºhren Sie den folgenden Befehl aus: <br><br><pre><code class="hljs sql">npm <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> express <span class="hljs-keyword"><span class="hljs-keyword">body</span></span>-parser request config <span class="hljs-comment"><span class="hljs-comment">--save</span></span></code> </pre> <br>  F√ºgen Sie <code>index.js</code> den folgenden Code <code>index.js</code> , mit dem Sie einen einfachen HTTP-Server erstellen k√∂nnen: <br><br><pre> <code class="hljs javascript"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>),   bodyParser = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'body-parser'</span></span>),   app = express(); app.use(bodyParser.urlencoded({ <span class="hljs-attr"><span class="hljs-attr">extended</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> })); app.use(bodyParser.json()); app.listen(<span class="hljs-number"><span class="hljs-number">8989</span></span>, () =&gt; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Example app listening on port 8989!'</span></span>)); app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, (req, res) =&gt; res.send(<span class="hljs-string"><span class="hljs-string">'Hello World!'</span></span>));</code> </pre> <br>  Wenn Sie nun den Server starten und Ihren Browser unter <code>http://127.0.0.1:8989</code> , wird eine Seite mit der Antwort des Servers angezeigt - <code>Hello World!</code>  . <br><br><h2>  <font color="#3AC1EF">HTTPS und die lokale Entwicklungsumgebung</font> </h2><br>  Bevor wir zur Webhook-Technologie √ºbergehen, m√ºssen wir HTTPS f√ºr die Entwicklungsumgebung konfigurieren.  Der Messenger akzeptiert nicht die Webhook-Adresse, die zum Senden von Benachrichtigungen an unseren Server verwendet wird, wenn Sie ein selbstsigniertes SSL-Zertifikat verwenden.  Ein kostenloses Zertifikat ist bei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Let's Encrypt erh√§ltlich</a> .  Hier k√∂nnen Sie jedoch ein Zertifikat nur f√ºr eine Domain und nicht f√ºr eine IP-Adresse erhalten.  Wir werden den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ngrok-</a> Dienst verwenden, mit dem Sie den Zugriff auf den lokalen Server √ºber eine √∂ffentliche URL organisieren k√∂nnen, die HTTPS verwendet. <br><br><h2>  <font color="#3AC1EF">Ngrok-Setup</font> </h2><br>  <code>ngrok</code> einfach.  Sie m√ºssen nur das komprimierte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Archiv</a> von der Projektsite herunterladen, entpacken und den folgenden Befehl ausf√ºhren: <br><br><pre> <code class="hljs">./ngrok http 80</code> </pre> <br>  Denken Sie daran, Port 80 in den WAN-Einstellungen Ihres Routers auf 8989 umzuleiten.  Infolgedessen erstellt <code>ngrok</code> √∂ffentliche HTTP- und HTTPS-Adressen f√ºr den lokalen Server. <br><br><h2>  <font color="#3AC1EF">Arbeiten mit Webhook-Benachrichtigungen</font> </h2><br>  Der Messenger verwendet die Webhook-Technologie zur Authentifizierung und zum Senden von Benachrichtigungen √ºber Ereignisse an Ihre Anwendung.  Aus programmtechnischer Sicht l√§uft alles auf die √ºblichen R√ºckruffunktionen f√ºr die Verarbeitung von HTTP-Anforderungen hinaus, die Daten zu Ereignissen empfangen, z. B. Nachrichten, die vom Chatbot empfangen werden.  Um GET- und POST-Anforderungen zu analysieren, verwenden wir das <code>body-parser</code> Modul. <br><br>  F√ºgen Sie der Anwendung die folgende Route hinzu.  Es wird f√ºr die Verarbeitung von Webhook-√úberpr√ºfungsanforderungen ben√∂tigt. <br><br><pre> <code class="hljs bash">//   GET-  webhook app.get(<span class="hljs-string"><span class="hljs-string">'/webhook'</span></span>, (req, res) =&gt; {   //  .    ,       <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> VERIFY_TOKEN = <span class="hljs-string"><span class="hljs-string">"SOMETHING_RANDOM"</span></span>;   //      <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> mode = req.query[<span class="hljs-string"><span class="hljs-string">'hub.mode'</span></span>];   <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> token = req.query[<span class="hljs-string"><span class="hljs-string">'hub.verify_token'</span></span>];   <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> challenge = req.query[<span class="hljs-string"><span class="hljs-string">'hub.challenge'</span></span>];   // ,     mode  token   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mode &amp;&amp; token) {       //   mode  token       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mode === <span class="hljs-string"><span class="hljs-string">'subscribe'</span></span> &amp;&amp; token === VERIFY_TOKEN) {           //   challenge             console.log(<span class="hljs-string"><span class="hljs-string">'WEBHOOK_VERIFIED'</span></span>);           res.status(200).send(challenge);       } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {           //   <span class="hljs-string"><span class="hljs-string">'403 Forbidden'</span></span>                res.sendStatus(403);       }   } });</code> </pre> <br>  Jetzt m√ºssen Sie die Messenger-Einstellungen √∂ffnen, dort den Abschnitt Webhooks finden und die Anwendungsintegration mit Webhook-Benachrichtigungen konfigurieren.  Geben Sie auf der Einstellungsseite im Feld R√ºckruf-URL unsere von ngrok empfangene HTTPS-URL ein.  Das Verifikationstoken (das im Code vorhanden ist und eine von uns erstellte zuf√§llige Zeichenfolge darstellt) muss in das Feld Verifikationstoken eingef√ºgt werden.  Danach sollten Sie in der Lage sein, die Einstellungen zu √ºberpr√ºfen und zu speichern, indem Sie auf die Schaltfl√§che √úberpr√ºfen und Speichern klicken, wenn Ihre URL f√ºr die Verarbeitung von Webhook-Benachrichtigungen verf√ºgbar ist und das √úberpr√ºfungstoken mit der im Code √ºbereinstimmt. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6fa/aff/26c/6faaff26cf7d89e6d65991816c8bb747.png"></div><br>  <i><font color="#999999">Konfigurieren Sie das Token und die URL f√ºr die Anwendung, um Webhook-Benachrichtigungen zu erhalten</font></i> <br><br>  W√§hlen Sie nach dem Speichern Ihre Seite aus der Dropdown-Liste aus und abonnieren Sie Seitenereignisse. <br><br>  Erstellen Sie nun eine POST-Route, um POST-Ereignisse vom Messenger zu verarbeiten.  F√ºgen Sie der Anwendung den folgenden Code hinzu. <br><br><pre> <code class="hljs lua">//     webhook app.post(<span class="hljs-string"><span class="hljs-string">'/webhook'</span></span>, (req, res) =&gt; {   let body = req.body;   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (body.object === <span class="hljs-string"><span class="hljs-string">'page'</span></span>) {       // ,               body.entry.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(entry)</span></span></span></span> {           //  entry.messaging  ,            //     ,    <span class="hljs-number"><span class="hljs-number">0</span></span>           let webhook_event = entry.messaging[<span class="hljs-number"><span class="hljs-number">0</span></span>];           console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(webhook_event);           //  PSID            let sender_psid = webhook_event.sender.id;           console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'Sender PSID: '</span></span> + sender_psid);           //  ,  , message   postback,           //     -           <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (webhook_event.message) {               console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(webhook_event.message)           } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (webhook_event.postback) {               console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(webhook_event.postback)           }       });       //  <span class="hljs-string"><span class="hljs-string">'200 OK'</span></span>            res.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>).send(<span class="hljs-string"><span class="hljs-string">'EVENT_RECEIVED'</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {       //  <span class="hljs-string"><span class="hljs-string">'404 Not Found'</span></span>,      ,           res.sendStatus(<span class="hljs-number"><span class="hljs-number">404</span></span>);   } });</code> </pre> <br>  Wir haben die Anwendung so eingerichtet, dass sie zwei Arten von Ereignissen behandelt - <code>message</code> und <code>postback</code> .  √ñffnen Sie den Messenger und senden Sie eine Nachricht an die Bot-Seite, um die Funktion des Webhook-Benachrichtigungsmechanismus zu √ºberpr√ºfen.  Wenn alles ordnungsgem√§√ü funktioniert, werden die PSID, die Ereignisinformationen und der Nachrichteninhalt des Absenders protokolliert.  Jetzt schreiben wir Handlerfunktionen f√ºr die Ereignisse, die f√ºr uns von Interesse sind. <br><br><pre> <code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   message const handleMessage = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sender_psid, received_message)</span></span></span><span class="hljs-function"> =&gt;</span></span> {   let response;   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (received_message.text) {   } } <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   postback const handlePostback = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sender_psid, received_postback)</span></span></span><span class="hljs-function"> =&gt;</span></span> {   let response;   <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    postback   let payload = received_postback.payload;   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(payload === <span class="hljs-string"><span class="hljs-string">'GET_STARTED'</span></span>){   } }</code> </pre> <br>  Die <code>handleMessage()</code> -Methode ist f√ºr die Verarbeitung eingehender Nachrichten verantwortlich, und die <code>handlePostback()</code> -Methode ist f√ºr die Verarbeitung eingehender <code>postback</code> Ereignisse verantwortlich.  Aktualisieren Sie Ihren vorhandenen Code, indem Sie diesen Methoden Aufrufe hinzuf√ºgen: <br><br><pre> <code class="hljs cmake">//   //     - <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (webhook_event.<span class="hljs-keyword"><span class="hljs-keyword">message</span></span>) {   handleMessage(sender_psid, webhook_event.<span class="hljs-keyword"><span class="hljs-keyword">message</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (webhook_event.postback) {   handlePostback(sender_psid, webhook_event.postback); }</code> </pre> <br>  Wenn wir nun <code>message</code> oder <code>postback</code> empfangen, werden die Daten zusammen mit der PSID des Absenders an die entsprechenden Handler √ºbertragen. <br><br><h2>  <font color="#3AC1EF">Konfigurieren des Begr√º√üungsbildschirms und der Postback-Ereignisse zum Starten eines Dialogs mit dem Bot</font> </h2><br>  Wenn ein neuer Benutzer ein Gespr√§ch mit dem Bot beginnt, wird im Chat-Fenster die Schaltfl√§che Erste Schritte angezeigt.  Sie k√∂nnen Ihr eigenes Postback-Ereignis f√ºr diese Situation konfigurieren.  Legen Sie beispielsweise eine Nachricht f√ºr einen Benutzer fest, die den Bot beschreibt und wie er mit ihm kommuniziert.  F√ºhren Sie diesen <code>curl</code> Befehl im Terminal aus, um Ihre eigene Begr√º√üung zu konfigurieren: <br><br><pre> <code class="hljs swift">curl -<span class="hljs-type"><span class="hljs-type">X</span></span> <span class="hljs-type"><span class="hljs-type">POST</span></span> -<span class="hljs-type"><span class="hljs-type">H</span></span> <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> -d '{ <span class="hljs-string"><span class="hljs-string">"greeting"</span></span>: [   {     <span class="hljs-string"><span class="hljs-string">"locale"</span></span>:<span class="hljs-string"><span class="hljs-string">"default"</span></span>,     <span class="hljs-string"><span class="hljs-string">"text"</span></span>:<span class="hljs-string"><span class="hljs-string">"Hello {{user_first_name}}! Are you ready to see the cutests cats and dogs"</span></span>   } ] }' <span class="hljs-string"><span class="hljs-string">"https://graph.facebook.com/v2.6/me/messenger_profile?access_token=YOUR_PAGE_ACCESS_TOKEN"</span></span></code> </pre> <br>  Wir haben Aww Bot so eingerichtet, dass eine Meldung angezeigt wird, in der der Benutzer gefragt wird, ob er bereit ist, die s√º√üesten Katzen und Hunde zu sehen.  F√ºhren Sie diesen Befehl im Terminal aus, um das Postback-Ereignis zu konfigurieren: <br><br><pre> <code class="hljs powershell">curl <span class="hljs-literal"><span class="hljs-literal">-X</span></span> POST <span class="hljs-literal"><span class="hljs-literal">-H</span></span> <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> <span class="hljs-literal"><span class="hljs-literal">-d</span></span> <span class="hljs-string"><span class="hljs-string">'{ "get_started": {"payload": "GET_STARTED"} }'</span></span> <span class="hljs-string"><span class="hljs-string">"https://graph.facebook.com/v2.6/me/messenger_profile?access_token=YOUR_PAGE_ACCESS_TOKEN"</span></span></code> </pre> <br>  So sieht die Chat-Sitzung mit dem Bot aus. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ce/ea2/528/8ceea252800a9c2c505880232a4a2df7.png"></div><br>  <i><font color="#999999">Erste Schritte Bildschirm</font></i> <br><br><h2>  <font color="#3AC1EF">Anwendungssetup</font> </h2><br>  Wir werden das Konfigurationsmodul npm verwenden, um das Seitenzugriffstoken in einer separaten Konfigurationsdatei zu speichern.  Erstellen Sie das <code>config</code> in unserem Projekt und die Datei <code>default.json</code> darin.  In dieser Datei m√ºssen Sie das Zugriffstoken zur Seite hinzuf√ºgen und diese Datei in <code>.gitignore</code> . <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"facebook"</span></span>: {   <span class="hljs-attr"><span class="hljs-attr">"page"</span></span>: {     <span class="hljs-attr"><span class="hljs-attr">"access_token"</span></span>: <span class="hljs-string"><span class="hljs-string">"PAGE_ACCESS_TOKEN"</span></span>   } } }</code> </pre> <br>  Wir erhalten das Seitenzugriffstoken in der <code>callSendAPI()</code> -Methode mit dem <code>config.get('facebook.page.access_token')</code> . <br><br><h2>  <font color="#3AC1EF">Behandlung eines Startereignisses</font> </h2><br>  Hier ist der Code zur Behandlung von Startereignissen. <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> handlePostback = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sender_psid, received_postback</span></span></span><span class="hljs-function">) =&gt;</span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> response;   <span class="hljs-comment"><span class="hljs-comment">//   postback-   let payload = received_postback.payload;   if(payload === 'GET_STARTED'){       response = askTemplate('Are you a Cat or Dog Person?');       callSendAPI(sender_psid, response);   } }</span></span></code> </pre> <br>  Erstellen wir die <code>askTemplate()</code> -Methode, die ein korrekt vorbereitetes <code>askTemplate()</code> f√ºr die Messenger-API <code>askTemplate()</code> .  Die <code>callSendAPI()</code> -Methode sendet eine Nachricht an den Benutzer.  F√ºgen Sie der Anwendung die folgenden Methoden hinzu: <br><br><pre> <code class="hljs coffeescript">const askTemplate = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span><span class="hljs-function"> =&gt;</span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {       <span class="hljs-string"><span class="hljs-string">"attachment"</span></span>:{           <span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"template"</span></span>,           <span class="hljs-string"><span class="hljs-string">"payload"</span></span>:{               <span class="hljs-string"><span class="hljs-string">"template_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"button"</span></span>,               <span class="hljs-string"><span class="hljs-string">"text"</span></span>: text,               <span class="hljs-string"><span class="hljs-string">"buttons"</span></span>:[                   {                       <span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"postback"</span></span>,                       <span class="hljs-string"><span class="hljs-string">"title"</span></span>:<span class="hljs-string"><span class="hljs-string">"Cats"</span></span>,                       <span class="hljs-string"><span class="hljs-string">"payload"</span></span>:<span class="hljs-string"><span class="hljs-string">"CAT_PICS"</span></span>                   },                   {                       <span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"postback"</span></span>,                       <span class="hljs-string"><span class="hljs-string">"title"</span></span>:<span class="hljs-string"><span class="hljs-string">"Dogs"</span></span>,                       <span class="hljs-string"><span class="hljs-string">"payload"</span></span>:<span class="hljs-string"><span class="hljs-string">"DOG_PICS"</span></span>                   }               ]           }       }   } } <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     API Send const callSendAPI = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sender_psid, response, cb = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> =&gt;</span></span> {   <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      let request_body = {       <span class="hljs-string"><span class="hljs-string">"recipient"</span></span>: {           <span class="hljs-string"><span class="hljs-string">"id"</span></span>: sender_psid       },       <span class="hljs-string"><span class="hljs-string">"message"</span></span>: response   };   <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  HTTP-  Messenger Platform   request({       <span class="hljs-string"><span class="hljs-string">"uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://graph.facebook.com/v2.6/me/messages"</span></span>,       <span class="hljs-string"><span class="hljs-string">"qs"</span></span>: { <span class="hljs-string"><span class="hljs-string">"access_token"</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'facebook.page.access_token'</span></span>) },       <span class="hljs-string"><span class="hljs-string">"method"</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>,       <span class="hljs-string"><span class="hljs-string">"json"</span></span>: request_body   }, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err, res, body)</span></span></span><span class="hljs-function"> =&gt;</span></span> {       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!err) {           <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(cb){               cb();           }       } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {           <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(<span class="hljs-string"><span class="hljs-string">"Unable to send message:"</span></span> + err);       }   }); }</code> </pre> <br>  Wir senden dem Benutzer eine Nachricht mit zwei Schaltfl√§chen und Text.  Wenn der Benutzer durch Klicken auf die entsprechende Schaltfl√§che ausw√§hlt, was er ben√∂tigt, wird eine Anfrage mit den Daten des <code>postback</code> Ereignisses an unsere Webhook-Adresse gesendet und von uns verarbeitet. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/378/772/c7c/378772c7c48eab03447ec1ea9dbb6117.png"></div><br>  <i><font color="#999999">Der Benutzer wird aufgefordert, den Bildtyp auszuw√§hlen, der ihn interessiert.</font></i> <br><br><h2>  <font color="#3AC1EF">Behandlung von benutzerdefinierten Postback-Ereignissen</font> </h2><br>  Aktualisieren Sie den Funktionscode des Postback-Ereignishandlers: <br><br><pre> <code class="hljs lua">const handlePostback = (sender_psid, received_postback) =&gt; {   let response;   //   postback-   let payload = received_postback.payload;   //  ,       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload === <span class="hljs-string"><span class="hljs-string">'CAT_PICS'</span></span>) {       response = imageTemplate(<span class="hljs-string"><span class="hljs-string">'cats'</span></span>, sender_psid);       callSendAPI(sender_psid, response, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{           callSendAPI(sender_psid, askTemplate(<span class="hljs-string"><span class="hljs-string">'Show me more'</span></span>));       });   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload === <span class="hljs-string"><span class="hljs-string">'DOG_PICS'</span></span>) {       response = imageTemplate(<span class="hljs-string"><span class="hljs-string">'dogs'</span></span>, sender_psid);       callSendAPI(sender_psid, response, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{           callSendAPI(sender_psid, askTemplate(<span class="hljs-string"><span class="hljs-string">'Show me more'</span></span>));       });   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(payload === <span class="hljs-string"><span class="hljs-string">'GET_STARTED'</span></span>){       response = askTemplate(<span class="hljs-string"><span class="hljs-string">'Are you a Cat or Dog Person?'</span></span>);       callSendAPI(sender_psid, response);   }   //   }</code> </pre> <br>  Wenn der Benutzer auf die Schaltfl√§che <code>Cats</code> klickt, wird eine Anfrage mit einem <code>postback</code> Ereignis mit <code>CAT_PICS</code> Daten an unsere Adresse <code>CAT_PICS</code> , die zur Verarbeitung von Webhook-Benachrichtigungen verwendet wird.  Wenn Sie die Option <code>Dogs</code> <code>postback</code> wird ein <code>postback</code> Ereignis mit <code>DOG_PICS</code> Daten <code>DOG_PICS</code> .  Wir haben dem System eine weitere Methode hinzugef√ºgt, <code>imageTemplate()</code> , die eine Nachricht zur√ºckgibt, die einen Link zu einem Bild einer Katze oder eines Hundes enth√§lt. <br><br><h2>  <font color="#3AC1EF">Erstellen Sie eine einfache API, die Bildverkn√ºpfungen zur√ºckgibt</font> </h2><br>  Wir werden eine einfache API schreiben, um Links zu Bildern von Katzen oder Hunden zur√ºckzugeben, die in Nachrichten verwendet werden, die der Bot an Benutzer sendet.  Erstellen Sie eine <code>pics.js</code> Datei und f√ºgen Sie den folgenden Code hinzu: <br><br><pre> <code class="hljs 1c">module.exports = {   cats : [       'https://i.imgur.com/Qbg7CeM.jpg',       'https://i.imgur.com/nUzkpJY.jpg',       'https://i.imgur.com/NpDcKph.jpg',       'https://i.imgur.com/oJtSDaO.jpg',       'https://i.redd.it/82ajpsrd<span class="hljs-number"><span class="hljs-number">1711</span></span>1.jpg',       'https://i.redd.it/00km1d2rt<span class="hljs-number"><span class="hljs-number">0111</span></span>.jpg',       'https://i.redd.it/rdbavhp0y<span class="hljs-number"><span class="hljs-number">7111</span></span>.jpg',       'https://i.redd.it/5hn3mg0n<span class="hljs-number"><span class="hljs-number">9811</span></span>1.jpg',       'https://i.redd.it/d23pb8mta<span class="hljs-number"><span class="hljs-number">6111</span></span>.jpg',       'https://i.redd.it/d2gyrwgy7oz01.jpg',       'https://i.redd.it/z4sgl84q72z01.jpg',       'https://i.redd.it/wvykzo8n1cy01.jpg'   ],   dogs : [       'https://i.redd.it/6tjihi2qe<span class="hljs-number"><span class="hljs-number">7111</span></span>.jpg',       'https://i.imgur.com/etRCs56.jpg',       'https://i.redd.it/nibw50f8y<span class="hljs-number"><span class="hljs-number">4111</span></span>.jpg',       'https://i.redd.it/izcvnvj1o<span class="hljs-number"><span class="hljs-number">7111</span></span>.jpg',       'https://i.redd.it/eqs1g9dldz011.jpg',       'https://i.redd.it/civ9dnu9u<span class="hljs-number"><span class="hljs-number">1111</span></span>.jpg',       'https://i.redd.it/kk03qwclkp011.jpg',       'https://i.redd.it/<span class="hljs-number"><span class="hljs-number">2694</span></span>pupjne011.jpg',       'https://i.redd.it/qk49ls5y6oy01.jpg',       'https://i.imgur.com/oM3mKgB.jpg',       'https://i.redd.it/8kx2riaulux01.jpg'   ] };</code> </pre> <br>  Verbinden Sie es nun in der Anwendung. <br><br><pre> <code class="hljs perl">images = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./pics'</span></span>);</code> </pre> <br>  F√ºgen Sie dem Code, der zum Erstellen einer Nachricht mit einem Link zum Bild verwendet wird, die folgende Methode hinzu. <br><br><pre> <code class="hljs scala">const = imageTemplate(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_id</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">=&gt;</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {       <span class="hljs-string"><span class="hljs-string">"attachment"</span></span>:{           <span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"image"</span></span>,           <span class="hljs-string"><span class="hljs-string">"payload"</span></span>:{               <span class="hljs-string"><span class="hljs-string">"url"</span></span>: getImage(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_id</span></span></span><span class="hljs-class">),               "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is_reusable</span></span></span><span class="hljs-class">"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>           }       }   } }</code> </pre> <br>  W√§hrend der Benutzerinteraktion mit dem Bot werden Bilder nacheinander aus dem Array extrahiert und als Bot-Antworten an den Benutzer gesendet.  Nach dem Senden des letzten Bildes kehren wir an den Anfang der Liste zur√ºck. <br><br>  Wir f√ºgen dem Projekt den folgenden Code hinzu, mit dem Daten √ºber Benutzer gespeichert und verarbeitet werden sollen, die mit dem Bot kommunizieren. <br><br><pre> <code class="hljs markdown">let users = {}; const = getImage(type, sender<span class="hljs-emphasis"><span class="hljs-emphasis">_id) =&gt; {   //       -     if(users[sender_</span></span>id] === undefined){       users = Object.assign({           [<span class="hljs-string"><span class="hljs-string">sender_id</span></span>] : {               'cats<span class="hljs-emphasis"><span class="hljs-emphasis">_count' : 0,               'dogs_</span></span>count' : 0           }       }, users);   }   let count = images[<span class="hljs-string"><span class="hljs-string">type</span></span>].length, //            user = users[<span class="hljs-string"><span class="hljs-string">sender_id</span></span>], // ,         user<span class="hljs-emphasis"><span class="hljs-emphasis">_type_</span></span>count = user[<span class="hljs-string"><span class="hljs-string">type+'_count'</span></span>];   //          let updated<span class="hljs-emphasis"><span class="hljs-emphasis">_user = {       [sender_</span></span>id] : Object.assign(user, {           [<span class="hljs-string"><span class="hljs-string">type+'_count'</span></span>] : count === user<span class="hljs-emphasis"><span class="hljs-emphasis">_type_</span></span>count + 1 ? 0 : user<span class="hljs-emphasis"><span class="hljs-emphasis">_type_</span></span>count + 1       })   };   //      users = Object.assign(users, updated<span class="hljs-emphasis"><span class="hljs-emphasis">_user);   console.log(users);   return images[type][user_</span></span>type_count]; }</code> </pre> <br>  Wir speichern die PSID jedes Benutzers, der mit dem Bot kommuniziert, als Schl√ºssel im <code>users</code> .  Wenn noch kein Benutzerdatensatz vorhanden ist, erstellen Sie einen neuen Datensatz.  Wir aktualisieren die Bildnummerninformationen jedes Mal, wenn ein Benutzer ein Bild einer Katze oder eines Hundes anfordert.  Dann geben wir den absoluten Pfad zu dem Bild zur√ºck, das in der Nachrichtenvorlage verwendet wird.  Als n√§chstes senden wir eine Nachricht mit dem Bild in Form einer Antwort auf das <code>postback</code> Ereignis, das generiert wird, wenn der Benutzer den <code>postback</code> ausw√§hlt, der ihn interessiert. <br><br><pre> <code class="hljs lua">//  ,    postback- <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload === <span class="hljs-string"><span class="hljs-string">'CAT_PICS'</span></span>) {   response = imageTemplate(<span class="hljs-string"><span class="hljs-string">'cats'</span></span>, sender_psid);   callSendAPI(sender_psid, response, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{       callSendAPI(sender_psid, askTemplate(<span class="hljs-string"><span class="hljs-string">'Show me more'</span></span>));   }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload === <span class="hljs-string"><span class="hljs-string">'DOG_PICS'</span></span>) {   response = imageTemplate(<span class="hljs-string"><span class="hljs-string">'dogs'</span></span>, sender_psid);   callSendAPI(sender_psid, response, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{       callSendAPI(sender_psid, askTemplate(<span class="hljs-string"><span class="hljs-string">'Show me more'</span></span>));   }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(payload === <span class="hljs-string"><span class="hljs-string">'GET_STARTED'</span></span>){   response = askTemplate(<span class="hljs-string"><span class="hljs-string">'Are you a Cat or Dog Person?'</span></span>);   callSendAPI(sender_psid, response); }</code> </pre> <br>  Dar√ºber hinaus √ºbergeben wir nach dem Senden des Bildes eine R√ºckruffunktion an die <code>callSendAPI()</code> -Methode, um dem Benutzer eine neue Frage zu den Bildern zu senden, an denen er interessiert ist.  Bei Erfolg rufen wir diese Funktion auf.  Dieses Arbeitsschema erm√∂glicht es dem Benutzer, unter Ber√ºcksichtigung der Asynchronit√§t der R√ºckruffunktionen eine Nachricht mit einer Frage zum n√§chsten Bild zu empfangen, nachdem ihm eine Nachricht mit dem zuvor angeforderten Bild gesendet wurde. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/23f/b00/4b7/23fb004b75889d58a81726991724c5fd.png"></div><br>  <i><font color="#999999">Kommunikation mit dem Bot</font></i> <br><br><h2>  <font color="#3AC1EF">Zusammenfassung</font> </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hier ist das</a> Repository f√ºr dieses Projekt.  Dort finden Sie in der Datei <code>readme.md</code> Anweisungen zum Installieren und Konfigurieren des Bots.  Damit andere Personen mit Ihrem Bot chatten k√∂nnen, muss Ihre Facebook-Anwendung genehmigt werden.  Bis zu diesem Zeitpunkt k√∂nnen nur Administratoren und Tester Ihrer Anwendung mit dem Bot sprechen.  <a href="">Hier ist ein</a> Video, das den Prozess der Kommunikation mit dem Bot demonstriert. <br><br>  <b>Liebe Leser!</b>  Planen Sie Bots f√ºr Facebook Messenger zu erstellen? <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de414081/">https://habr.com/ru/post/de414081/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de414067/index.html">Starten Sie das mobile Retargeting mit Anpassen: Einstellungen, Berichte und Links</a></li>
<li><a href="../de414069/index.html">Drohnenbeschr√§nkungen w√§hrend der FIFA Fussball-Weltmeisterschaft 2018 (FIFA 2018)</a></li>
<li><a href="../de414071/index.html">Von der √úberwachung bis zum Incident Management. Bericht vom DevOps Moscow Meetup</a></li>
<li><a href="../de414073/index.html">Migration von jQuery zu Vue.js.</a></li>
<li><a href="../de414079/index.html">Funktionen der Arbeit und des internen Ger√§ts express.js</a></li>
<li><a href="../de414083/index.html">Sommer Mitap Apache Ignite in St. Petersburg</a></li>
<li><a href="../de414085/index.html">Wie man Proben f√ºr das Unified Biometric System erstellt und warum es gef√§hrlich sein kann</a></li>
<li><a href="../de414087/index.html">Automatisieren Sie es sofort oder wie Unternehmen heute online arbeiten k√∂nnen</a></li>
<li><a href="../de414089/index.html">Telegrammsperre durch Entscheidung des Moskauer Stadtgerichts best√§tigt</a></li>
<li><a href="../de414093/index.html">Die ganze Wahrheit √ºber RTOS von Colin Walls</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>