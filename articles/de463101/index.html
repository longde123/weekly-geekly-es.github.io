<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔝 👐🏿 🐊 Verwalten von Hunderten von Servern für Lasttests: automatische Skalierung, benutzerdefinierte Überwachung, DevOps-Kultur 🧕🏻 🏽 👂🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In einem früheren Artikel habe ich über unsere große Lasttestinfrastruktur gesprochen. Im Durchschnitt erstellen wir ungefähr 100 Server für die Lastv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Verwalten von Hunderten von Servern für Lasttests: automatische Skalierung, benutzerdefinierte Überwachung, DevOps-Kultur</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/miro/blog/463101/">  In einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">früheren Artikel habe</a> ich über unsere große Lasttestinfrastruktur gesprochen.  Im Durchschnitt erstellen wir ungefähr 100 Server für die Lastversorgung und ungefähr 150 Server für unseren Service.  Alle diese Server müssen erstellt, gelöscht, konfiguriert und ausgeführt werden.  Zu diesem Zweck verwenden wir dieselben Werkzeuge wie auf dem Produkt, um den manuellen Arbeitsaufwand zu reduzieren: <br><br><ul><li>  So erstellen und löschen Sie eine Testumgebung: Terraform-Skripte; </li><li>  So konfigurieren, aktualisieren und ausführen - Ansible-Skripte; </li><li>  Für dynamische Skalierung je nach Auslastung - selbst geschriebene Python-Skripte. </li></ul><br>  Dank der Skripte Terraform und Ansible werden alle Vorgänge vom Erstellen von Instanzen bis zum Starten des Servers mit nur sechs Befehlen ausgeführt: <br><br><pre><code class="plaintext hljs">#     aws ansible-playbook deploy-config.yml #   ansible-playbook start-application.yml #      ansible-playbook update-test-scenario.yml --ask-vault-pass # Jmeter ,      infrastructure-aws-cluster/jmeter_clients:~# terraform apply # jmeter     ansible-playbook start-jmeter-server-cluster.yml # jmeter  ansible-playbook start-stress-test.yml # </code> </pre> <br><a name="habracut"></a><h2>  Dynamische Serverskalierung </h2><br>  Zur Hauptverkehrszeit in der Produktion haben wir mehr als 20.000 Online-Benutzer gleichzeitig, und zu anderen Zeiten können es 6.000 sein.  Es macht keinen Sinn, ständig das gesamte Servervolumen beizubehalten. Daher richten wir die automatische Skalierung für die Board-Server ein, auf denen die Boards zum Zeitpunkt der Benutzereingabe geöffnet sind, sowie für API-Server, die API-Anforderungen verarbeiten.  Jetzt werden Server erstellt und bei Bedarf gelöscht. <br><br>  Dieser Mechanismus ist beim Auslastungstest sehr effektiv: Standardmäßig können wir die Mindestanzahl von Servern haben, und zum Zeitpunkt des Tests steigen diese automatisch in der richtigen Menge an.  Zu Beginn können wir 4 Board-Server haben und in der Spitze bis zu 40. Gleichzeitig werden neue Server nicht sofort erstellt, sondern erst, nachdem die aktuellen Server geladen wurden.  Das Kriterium zum Erstellen neuer Instanzen kann beispielsweise 50% der CPU-Auslastung sein.  Auf diese Weise können Sie das Wachstum virtueller Benutzer im Skript nicht verlangsamen und keine unnötigen Server erstellen. <br><br>  Ein Bonus dieses Ansatzes ist, dass wir dank der dynamischen Skalierung lernen, wie viel Kapazität wir für eine andere Anzahl von Benutzern benötigen, die wir noch nicht im Verkauf hatten. <br><br><h2>  Sammlung von Metriken wie auf Prod </h2><br>  Es gibt viele Ansätze und Werkzeuge zur Überwachung von Stresstests, aber wir sind unseren eigenen Weg gegangen. <br><br>  Wir überwachen die Produktion mit einem Standardstapel: Logstash, Elasticsearch, Kibana, Prometheus und Grafana.  Unser Testcluster ähnelt dem Produkt, daher haben wir uns entschieden, dieselbe Überwachung wie das Produkt mit denselben Metriken durchzuführen.  Dafür gibt es zwei Gründe: <br><br><ul><li>  Sie müssen kein Überwachungssystem von Grund auf neu erstellen, wir haben es bereits vollständig und sofort. </li><li>  Wir testen zusätzlich die Überwachung des Umsatzes: Wenn wir während der Überwachung des Tests verstehen, dass wir nicht über genügend Daten verfügen, um das Problem zu analysieren, reichen diese nicht für die Produktion aus, wenn dort ein solches Problem auftritt. </li></ul><br><img src="https://habrastorage.org/webt/rp/f6/8n/rpf68nydaytyhyw62bd6vegvbmy.png"><br><br><h2>  Was wir in den Berichten zeigen </h2><br><ul><li>  Technische Eigenschaften des Standes; </li><li>  Das Skript selbst, in Worten beschrieben, nicht Code; </li><li>  Ein Ergebnis, das für alle Teammitglieder, sowohl Entwickler als auch Manager, verständlich ist. </li><li>  Diagramme des allgemeinen Standzustands; </li><li>  Diagramme, die einen Engpass anzeigen oder von der im Test überprüften Optimierung betroffen sind. </li></ul><br>  Es ist wichtig, dass alle Ergebnisse an einem Ort gespeichert werden.  Daher ist es praktisch, sie von Start zu Start miteinander zu vergleichen. <br><br>  Wir erstellen Berichte in unserem Produkt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">(Beispiel eines Whiteboards mit einem Bericht)</a> : <br><br><img src="https://habrastorage.org/webt/ot/li/tf/otlitfwav4v-cby0ipnrin4xhxk.png"><br><br>  Das Erstellen eines Berichts nimmt viel Zeit in Anspruch.  Daher planen wir, die Erfassung allgemeiner Informationen mithilfe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">unserer öffentlichen API</a> automatisch <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">durchzuführen</a> . <br><br><h2>  Infrastruktur als Code </h2><br>  Wir sind für die Qualität des Produkts verantwortlich, nicht für QS-Ingenieure, sondern für das gesamte Team.  Stresstests sind eines der Instrumente zur Qualitätssicherung.  Cool, wenn das Team versteht, dass es wichtig ist, die vorgenommenen Änderungen unter Last zu überprüfen.  Um darüber nachzudenken, muss sie für die Produktion verantwortlich werden.  Hier helfen uns die Prinzipien der DevOps-Kultur, die wir in unserer Arbeit umzusetzen begannen. <br><br>  Es ist jedoch nur der erste Schritt, über die Durchführung von Stresstests nachzudenken.  Das Team kann keine Tests durchdenken, ohne das Produktionsgerät zu verstehen.  Wir sind auf ein solches Problem gestoßen, als wir damit begannen, Lasttests in Teams durchzuführen.  Zu diesem Zeitpunkt hatten die Teams keine Möglichkeit, das Produktionsgerät herauszufinden, so dass es für sie schwierig war, an der Gestaltung der Tests zu arbeiten.  Es gab mehrere Gründe: das Fehlen aktueller Unterlagen oder eine Person, die das ganze Bild des Verkaufs in meinem Kopf behalten hätte;  Mehrfachwachstum des Entwicklungsteams. <br><br>  Um den Teams das Verständnis der Vertriebsarbeit zu erleichtern, kann der Infrastrukturansatz als Code verwendet werden, den wir im Entwicklungsteam verwendet haben. <br><br>  Welche Probleme haben wir bereits mit diesem Ansatz zu lösen begonnen: <br><br><ul><li>  Alles muss in Skripten geschrieben sein und kann jederzeit ausgelöst werden.  Dies verkürzt die Wiederherstellungszeit für Verkäufe im Falle eines Rechenzentrumsunfalls erheblich und ermöglicht es Ihnen, die richtige Menge relevanter Testumgebungen beizubehalten </li><li>  Angemessene Einsparungen: Wir stellen Umgebungen auf Openstack bereit, wenn diese teure Plattformen wie AWS ersetzen können. </li><li>  Die Teams selbst erstellen Stresstests, weil sie verstehen, dass sich das Gerät verkauft. </li><li>  Der Code ersetzt die Dokumentation, sodass sie nicht endlos aktualisiert werden muss. Sie ist immer vollständig und aktuell. </li><li>  Sie benötigen keinen separaten Experten auf engstem Raum, um normale Probleme zu lösen.  Jeder Ingenieur kann den Code herausfinden. </li><li>  Mit einer klaren Verkaufsstruktur ist es viel einfacher, Forschungstests wie Chaos-Affentests oder Tests auf lange Speicherlecks zu planen. </li></ul><br>  Ich möchte diesen Ansatz nicht nur auf die Schaffung von Infrastrukturen, sondern auch auf die Unterstützung verschiedener Tools ausweiten.  Zum Beispiel haben wir beim Datenbanktest, über den ich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">in einem früheren Artikel gesprochen habe</a> , vollständig in Code umgewandelt.  Aus diesem Grund verfügen wir anstelle einer vorbereiteten Site über eine Reihe von Skripten, mit denen wir in 7 Minuten die konfigurierte Umgebung in einem vollständig leeren AWS-Konto abrufen und den Test starten können.  Aus dem gleichen Grund prüfen wir nun sorgfältig <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gatling</a> , das die Entwickler als Werkzeug für „Lasttest als Code“ positionieren. <br><br>  Die Herangehensweise an die Infrastruktur als Code beinhaltet eine ähnliche Herangehensweise an das Testen der Infrastruktur und der Skripte, die das Team schreibt, um die Infrastruktur mit neuen Funktionen zu erweitern.  All dies sollte durch Tests abgedeckt werden.  Es gibt auch verschiedene Test-Frameworks wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Molecule</a> .  Es gibt Tools für das Testen von Chaosaffen, für AWS gibt es kostenpflichtige Tools, für Docker gibt es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pumba</a> usw.  Mit ihnen können Sie verschiedene Arten von Aufgaben lösen: <br><br><ul><li>  So überprüfen Sie, ob eine der Instanzen in AWS abstürzt, um zu überprüfen, ob die Last auf den verbleibenden Servern neu verteilt wird und ob der Dienst von einer derart scharfen Umleitung von Anforderungen überlebt; </li><li>  So simulieren Sie den langsamen Betrieb des Netzwerks, seinen Ausfall und andere technische Probleme, nach denen die Logik der Dienstinfrastruktur nicht unterbrochen werden sollte. </li></ul><br>  Die Lösung solcher Probleme in unseren unmittelbaren Plänen. <br><br><h2>  Schlussfolgerungen </h2><br><ol><li>  Es lohnt sich nicht, die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Testinfrastruktur</a> manuell zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">orchestrieren</a> . Es ist besser, diese Aktionen zu automatisieren, um alle Umgebungen, einschließlich Produkte, zuverlässiger zu verwalten. </li><li>  Die dynamische Skalierung reduziert die Kosten für die Aufrechterhaltung des Umsatzes und einer großen Testumgebung erheblich und reduziert auch den menschlichen Faktor bei der Skalierung. </li><li>  Sie können kein separates Überwachungssystem für Tests verwenden, sondern es vom Markt nehmen. </li><li>  Es ist wichtig, dass Stresstestberichte automatisch an einem einzigen Ort gesammelt werden und eine einheitliche Ansicht haben.  Auf diese Weise können sie Änderungen leicht vergleichen und analysieren. </li><li>  Stresstests werden zu einem Prozess im Unternehmen, wenn sich die Teams für den Verkauf verantwortlich fühlen. </li><li>  Lasttests - Infrastrukturtests.  Wenn der Auslastungstest erfolgreich war, wurde er möglicherweise nicht korrekt kompiliert.  Die Validierung der Richtigkeit des Tests erfordert ein tiefes Verständnis des Umsatzes.  Teams sollten die Möglichkeit haben, das Verkaufsgerät unabhängig zu verstehen.  Wir lösen dieses Problem mithilfe der Infrastruktur als Code-Ansatz. </li><li>  Infrastrukturvorbereitungsskripte müssen wie jeder andere Code getestet werden. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de463101/">https://habr.com/ru/post/de463101/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de463085/index.html">Cage Remote File Access System</a></li>
<li><a href="../de463089/index.html">Implementierung eines Unternehmenssuchsystems für Konstrukteure unter Verwendung der Low-Code-Plattform</a></li>
<li><a href="../de463095/index.html">Warum nicht SQL?</a></li>
<li><a href="../de463097/index.html">Go Produktentwicklung: Eine Projekthistorie</a></li>
<li><a href="../de463099/index.html">1000 und 1 Feedback. Wie man Feedback gibt und anderen beibringt, die Lamoda-Erfahrung</a></li>
<li><a href="../de463105/index.html">Mein vierter Tag mit Haiku: Installations- und Bootprobleme</a></li>
<li><a href="../de463107/index.html">ShIoTiny: kleine Automatisierung, das Internet der Dinge oder „sechs Monate vor den Ferien“</a></li>
<li><a href="../de463113/index.html">Daten und Modelle Versionskontrolle im Computer Vision-Meetup</a></li>
<li><a href="../de463115/index.html">Das Türproblem im Shooter-Design</a></li>
<li><a href="../de463117/index.html">Vorladen in PHP 7.4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>