<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯМЧ ЁЯШЪ ЁЯзТЁЯП┐ рд▓рд┐рдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ рд▓рд┐рдЦрдирд╛: I2C тЪХя╕П ЁЯзФЁЯП╜ тШБя╕П</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рд╣реЗрдмреНрд░, рдирдорд╕реНрдХрд╛рд░! 

 рдпрд╣ рд▓реЗрдЦ I2C (рдЗрдВрдЯрд░-рдЗрдВрдЯреАрдЧреНрд░реЗрдЯреЗрдб рд╕рд░реНрдХрд┐рдЯ) рд▓рд┐рдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ рдХреЗ рд╡рд┐рдХрд╛рд╕ рдкрд░ рдХреЗрдВрджреНрд░рд┐рдд рд╣реИред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд I2C рдбреНрд░рд╛рдЗрд╡рд░ рдХреА рдореВрд▓ рд╕рдВрд░рдЪрдирд╛ рдХреЛ рд▓рд╛рдЧреВ рдХрд░...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рд▓рд┐рдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ рд▓рд┐рдЦрдирд╛: I2C</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413249/">  рд╣реЗрдмреНрд░, рдирдорд╕реНрдХрд╛рд░! <br><br>  рдпрд╣ рд▓реЗрдЦ I2C (рдЗрдВрдЯрд░-рдЗрдВрдЯреАрдЧреНрд░реЗрдЯреЗрдб рд╕рд░реНрдХрд┐рдЯ) рд▓рд┐рдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ рдХреЗ рд╡рд┐рдХрд╛рд╕ рдкрд░ рдХреЗрдВрджреНрд░рд┐рдд рд╣реИред  рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд I2C рдбреНрд░рд╛рдЗрд╡рд░ рдХреА рдореВрд▓ рд╕рдВрд░рдЪрдирд╛ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдЖрдк рдЖрд╡рд╢реНрдпрдХ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВред <br><br>  рд╣рдо рдЗрдирдкреБрдЯ рдбреЗрдЯрд╛ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддреЗ рд╣реИрдВ: FPGA рдХреЗ рд▓рд┐рдП рдирдП рдкреНрд░реЛрд╕реЗрд╕рд░ "рд╡рд╛рдпрд░реНрдб" рдХреЗ рд▓рд┐рдП I2C рдмреНрд▓реЙрдХ, рд▓рд┐рдирдХреНрд╕ рд╕рдВрд╕реНрдХрд░рдг 3.18.19 рдФрд░ рдмрд╛рд╣реНрдп рдЙрдкрдХрд░рдгреЛрдВ рдХреЛ рдЪрд▓рд╛рдиреЗ рд╡рд╛рд▓рд╛ (EEPROM AT24C64 рдФрд░ BME280)ред <br><br>  I2C рдХреЗ рд╕рдВрдЪрд╛рд▓рди рдХрд╛ рд╕рд┐рджреНрдзрд╛рдВрдд рдХрд╛рдлреА рд╕рд░рд▓ рд╣реИ, рд▓реЗрдХрд┐рди рдЕрдЧрд░ рдЖрдкрдХреЛ рдЬреНрдЮрд╛рди рдкрд░ рдмреНрд░рд╢ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рддреЛ рдЖрдк <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдпрд╣рд╛рдВ</a> рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВред <br><br><img src="https://habrastorage.org/webt/jq/rh/yg/jqrhyg8bveyubub7hysu0gxrkms.png"><br>  <i>рдЪрд┐рддреНрд░рд╛ 1. I2C рдмрд╕ рд╕рдВрдХреЗрддреЛрдВ рдХрд╛ рд╕рдордп рдЖрд░реЗрдЦ</i> <br><a name="habracut"></a><br>  рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╢реБрд░реВ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ, рдЖрдЗрдП рджреЗрдЦреЗрдВ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реНрдкреЗрд╕ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЗрд╕рдХреЗ рд▓рд┐рдП рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ рдХреЗ рд╕рд╛рде рдХреИрд╕реЗ рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░рддреЗ рд╣реИрдВ: <br><br><ol><li>  рд╣рдо рдПрдХ рдЫреЛрдЯреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реНрдкреЗрд╕ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рдбрд┐рд╡рд╛рдЗрд╕ рдХреА рдЕрджреНрд╡рд┐рддреАрдп I2C рд░рдЬрд┐рд╕реНрдЯрд░ рдЖрдИрдбреА рдХреЛ рдкрдврд╝рдирд╛ рд╣реИред  рдпрд╣ рдЪрд░рдг рдЖрдкрдХреЛ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЛ рд╕рдордЭрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛ рдЬрд┐рд╕рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рдмреАрдЪ рд╡рд┐рдирд┐рдордп рд╣реЛрддрд╛ рд╣реИ; </li><li> рдЖрдЗрдП рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ рджреНрд╡рд╛рд░рд╛ I2C рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рдкреНрд░рд╕рд╛рд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд╡рд┐рдХрд▓реНрдк рд╕реЗ рдкрд░рд┐рдЪрд┐рдд рд╣реЛрдВ; </li><li>  рдЕрд╕реЗрдВрдмрд▓реА рдореЗрдВ рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ рдЬреЛрдбрд╝реЗрдВ рдФрд░ рдбрд┐рд╡рд╛рдЗрд╕ рдЯреНрд░реА рдореЗрдВ рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдВ; </li><li>  рд╣рдо рдХреБрдЫ рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг рдХреЗ рд╕рд╛рде I2C рдЪрд╛рд▓рдХ рдХреА рд╕рд╛рдорд╛рдиреНрдп рд╕рдВрд░рдЪрдирд╛ (рдХрдВрдХрд╛рд▓) рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВред </li></ol><br>  рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ, рд╡рд┐рдХрд╕рд┐рдд рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕реНрд░реЛрддреЛрдВ рдХреЛ рд╕рдВрд▓рдЧреНрди рдХрд░рдирд╛ рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реИред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдореИрдВ рдпрд╣ рдиреЛрдЯ рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВ рдХрд┐ рдирд┐рдпрдВрддреНрд░рдХ рдХреЗ рд╕рднреА рдирд╛рдо, рдирд╛рдо рдФрд░ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд╛рд░реНрдб рдмрджрд▓ рджрд┐рдП рдЧрдП рд╣реИрдВред  рд╡рд┐рдХрд╕рд┐рдд рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХрд╛ рдЖрдзрд╛ рднреА рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рдХрдВрдХрд╛рд▓ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдирд╣реАрдВ рдерд╛, рд╣рд╛рд▓рд╛рдВрдХрд┐, рдбреНрд░рд╛рдЗрд╡рд░ рд╕рдВрд░рдЪрдирд╛ рд╡рд┐рдХрд╛рд╕ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдЪреНрдЫрд╛ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдмрд┐рдВрджреБ рд╣реИред  I2C рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХреЗ рдЙрджрд╛рд╣рд░рдг <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдпрд╣рд╛рдВ</a> рджреЗрдЦреЗ рдЬрд╛ рд╕рдХрддреЗ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╣реИрдВ</a> ред <br><br><h3>  <b>рдкрд╣рд▓рд╛ рдХрджрдо</b> </h3><br>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдЖрдЗрдП i2cdetect рдЙрдкрдпреЛрдЧрд┐рддрд╛ рд╕реЗ рдкрд░рд┐рдЪрд┐рдд рд╣реЛрдВред  I2cdetect рдХрд╛ рдкрд░рд┐рдгрд╛рдо рдирд┐рдореНрдирд╛рдиреБрд╕рд╛рд░ рд╣реИ: <br><pre><code class="cpp hljs">./i2cdetect -y <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> abcdef <span class="hljs-number"><span class="hljs-number">00</span></span>: тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ <span class="hljs-number"><span class="hljs-number">10</span></span>: тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ <span class="hljs-number"><span class="hljs-number">20</span></span>: тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ <span class="hljs-number"><span class="hljs-number">30</span></span>: тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ <span class="hljs-number"><span class="hljs-number">40</span></span>: тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ <span class="hljs-number"><span class="hljs-number">50</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ <span class="hljs-number"><span class="hljs-number">60</span></span>: тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ <span class="hljs-number"><span class="hljs-number">70</span></span>: тАФ тАФ тАФ тАФ тАФ тАФ тАФ тАФ</code> </pre> <br>  рдЙрдкрдпреЛрдЧрд┐рддрд╛ рдХреНрд░рдорд┐рдХ рд░реВрдк рд╕реЗ I2C рдкрд░ рдбрд┐рд╡рд╛рдЗрд╕ рдкрддрд╛ рдмрд╕ рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд░рддреА рд╣реИ рдФрд░, рд╕рдХрд╛рд░рд╛рддреНрдордХ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдиреЗ рдкрд░ (рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рд╕рдХрд╛рд░рд╛рддреНрдордХ рдЬрд╡рд╛рдм рдПрд╕реАрдХреЗ рд╣реИ), рдХрдВрд╕реЛрд▓ рдореЗрдВ рдмрд╕ рдкрд░ рдбрд┐рд╡рд╛рдЗрд╕ рдкрддрд╛ рдирдВрдмрд░ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИред <br><br>  рд╣рдо рдПрдХ рдЫреЛрдЯрд╛ рдкреНрд░реЛрдЧреНрд░рд╛рдо рд▓рд┐рдЦреЗрдВрдЧреЗ рдЬреЛ рддрд╛рдкрдорд╛рди рд╕реЗрдВрд╕рд░ рдХреА рдЕрдиреВрдареА рдЖрдИрдбреА рдХреЛ рдкрдврд╝рддрд╛ рд╣реИ рдФрд░ рдХрдВрд╕реЛрд▓ рдореЗрдВ рдЗрд╕рдХреЗ рдХрд╛рдо рдХрд╛ рдкрд░рд┐рдгрд╛рдо рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИред  рдпрд╣ рдмрд╣реБрдд рд╕рд░рд▓ рд▓рдЧрддрд╛ рд╣реИ: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;fcntl.h&gt; #include &lt;sys/ioctl.h&gt; #include &lt;linux/i2c.h&gt; #include &lt;linux/i2c-dev.h&gt; #define I2C_ADAPTER "/dev/i2c-0" int read_buffer(int fd) { struct i2c_rdwr_ioctl_data data; struct i2c_msg messages[2]; unsigned char write_buf[1] = {0xD0}, read_buf[1] = {0x00}; unsigned char write[200]; /* * .addr -   () * .flags -     (0 - w, 1 - r) * .len - - /  * .buf -      */ messages[0].addr = 0x50; messages[0].flags = 0; messages[0].len = 1; messages[0].buf = write_buf; messages[1].addr = 0x50; messages[1].flags = 1; messages[1].len = 1; messages[1].buf = read_buf; data.msgs = messages; data.nmsgs = 2; if (ioctl(fd, I2C_RDWR, &amp;data) &lt; 0) printf("Cant send data!\n"); else printf("ID = 0x%x\n", read_buf[0]); } int main(int argc, char **argv) { int fd; /* * Open I2C file descriptor. */ fd = open(I2C_ADAPTER, O_RDWR); if (fd &lt; 0) { printf("Unable to open i2c file\n"); return 0; } read_buffer(fd); return 0; }</span></span></span></span></code> </pre><br>  рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ i2c_rdwr_ioctl_data рд╕рдВрджреЗрд╢ рдлрд╝реАрд▓реНрдб рдХреЗ рд░реВрдк рдореЗрдВ рдбреЗрдЯрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИред  рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ i2c_msg рдФрд░ nmsgs рдЬреИрд╕реЗ рдлрд╝реАрд▓реНрдб рд╢рд╛рдорд┐рд▓ рд╣реИрдВ, рдЬрд┐рдирдХрд╛ рдЙрдкрдпреЛрдЧ рдЯреНрд░рд╛рдВрд╕рдорд┐рд╢рди рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ: <br><br><ul><li>  .addr - рдЙрдкрдХрд░рдг рдкрддреЗ; </li><li>  .flags - рдСрдкрд░реЗрд╢рди рдХрд╛ рдкреНрд░рдХрд╛рд░ (рдкрдврд╝реЗрдВ рдпрд╛ рд▓рд┐рдЦреЗрдВ); </li><li>  .len - рд╡рд░реНрддрдорд╛рди рд╕рдВрджреЗрд╢ рдХреА рд▓рдВрдмрд╛рдИ; </li><li>  .buf- рдХреНрд▓рд┐рдкрдмреЛрд░реНрдбред </li></ul><br><h3>  <b>рджреВрд╕рд░рд╛ рдХрджрдо</b> </h3><br>  рдЕрдм, рдореИрдВ рдЗрдирд╕рд╛рдЗрдЯреНрд╕ рдореЗрдВ рддрд▓реНрд▓реАрди рдирд╣реАрдВ рдХрд░рддрд╛, I2C рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рдПрдХ рд╕рдВрд╕реНрдХрд░рдг рд╕реЗ рдкрд░рд┐рдЪрд┐рдд рд╣реЛ рдЧрдпрд╛ред <br>  рдЬреИрд╕рд╛ рдХрд┐ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╕реНрдерд╛рдкрд┐рдд рд╣реИ, рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ рдПрдХ рд╕рдВрд░рдЪрдирд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд▓реЗрдЦрди рдСрдкрд░реЗрд╢рди (рд╣рд╛рд░реНрдбрд╡реЗрдпрд░-рдирд┐рд░реНрднрд░ рднрд╛рдЧ) рдХрд░рддреЗ рд╕рдордп рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рдПрд▓реНрдЧреЛрд░рд┐рдереНрдо рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ: <br><br><ul><li>  рдкрд╣рд▓реЗ TX FIFO рднрд░рд╛ рдЬрд╛рддрд╛ рд╣реИ: рдбрд┐рд╡рд╛рдЗрд╕ рдХрд╛ рдкрддрд╛ рдкрд╣рд▓реЗ рдЖрддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ рд╢реЗрд╖ рдбреЗрдЯрд╛ рдкреНрд░рд╕рд╛рд░рд┐рдд рд╣реЛрддрд╛ рд╣реИ; </li><li>  ISR рд╡реНрдпрд╡рдзрд╛рди рд╕реНрдерд┐рддрд┐ рд░рдЬрд┐рд╕реНрдЯрд░ рд╕рд╛рдлрд╝ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ IER рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ рд╡реНрдпрд╡рдзрд╛рди рд╕рдХреНрд╖рдо рд╣реЛ рдЬрд╛рддреЗ рд╣реИрдВ (рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рдЬрдм TX FIFO рдореЗрдВ рдХреЛрдИ рдбреЗрдЯрд╛ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ рддреЛ рдПрдХ рд╡реНрдпрд╡рдзрд╛рди рдЙрддреНрдкрдиреНрди рд╣реЛрддрд╛ рд╣реИ); </li><li>  рдбреЗрдЯрд╛ рдЯреНрд░рд╛рдВрд╕рдорд┐рд╢рди рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ рдФрд░ рд╕реНрдЯрд╛рд░реНрдЯ рдмрд┐рдЯ рдмрд╕ рдкрд░ рд╕реЗрдЯ рд╣реИред </li></ul><br>  рдмрд╛рдж рдХреЗ рд╕рднреА рдбреЗрдЯрд╛ рд╡рд┐рдирд┐рдордп рдмрд╛рдзрд╛ рд╣реИрдВрдбрд▓рд░ рдореЗрдВ рд╣реЛрдВрдЧреЗред <br>  рдЗрд╕ рдПрд▓реНрдЧреЛрд░рд┐рджрдо рдкрд░ рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдбреНрд░рд╛рдЗрд╡рд░ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдпрд╣рд╛рдВ</a> рджреЗрдЦреЗ рдЬрд╛ рд╕рдХрддреЗ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╣реИрдВ</a> ред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдирд┐рдпрдВрддреНрд░рдХ рдореЗрдВ FIFO рдирд╣реАрдВ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдХреЗрд╡рд▓ рдПрдХ рд╣реА рд╕реНрдерд╛рдирд╛рдВрддрд░рдг рд░рдЬрд┐рд╕реНрдЯрд░ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдПрдХ FIFO рдЖрдХрд╛рд░ рдХреЗ рд╕рд╛рде рдПрдХ рд╡рд┐рд╢реЗрд╖ рдорд╛рдорд▓рд╛ рд╣реИред <br><br><h3>  <b>рдЪрд░рдг рддреАрди</b> </h3><br>  рдЕрд╕реЗрдВрдмрд▓реА рдореЗрдВ рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ рдЬреЛрдбрд╝реЗрдВ рдФрд░ рдбрд┐рд╡рд╛рдЗрд╕ рдЯреНрд░реА рдореЗрдВ рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдВ: <br><br>  1. рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдПрдХ рд╕реНрд░реЛрдд рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдПрдБ: <br><br><pre> <code class="cpp hljs">cd drivers/i2c/busses/ vim i2c-skel.c :wq</code> </pre><br>  рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рдлрд╝рд╛рдЗрд▓ рджрд┐рдЦрд╛рдИ рджреЗрддреА рд╣реИ: <br><br><pre> <code class="cpp hljs">drivers/i2c/busses/i2c-skel.c</code> </pre><br><br>  2. рдбреНрд░рд╛рдЗрд╡рд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ <i>рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ / i2c / busses / Kconfig рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ</i> : <br><br><pre> <code class="cpp hljs">config I2C_SKEL tristate <span class="hljs-string"><span class="hljs-string">"I2C adapter"</span></span> help If you say yes to <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> option, support will be included <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the I2C interface.</code> </pre><br>  3. рдЕрд╕реЗрдВрдмрд▓реА рдореЗрдВ <i>рдбреНрд░рд╛рдЗрд╡рд░ / i2c / busses / Makefile</i> рдбреНрд░рд╛рдЗрд╡рд░ рдЬреЛрдбрд╝реЗрдВ: <br><br><pre> <code class="cpp hljs">obj-$(CONFIG_I2C_SKEL) += i2c-skel.o</code> </pre><br>  4. I2C рдмреНрд▓реЙрдХ рдХрд╛ рд╡рд┐рд╡рд░рдг рдбрд┐рд╡рд┐рд╕реЗрдЯреНрд░реА (* .dts) рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ, рдФрд░ рддреБрд░рдВрдд eeprom рдбрд┐рд╡рд╛рдЗрд╕ рдХрд╛ рднреА рд╕рдорд░реНрдерди рдХрд░реЗрдВ: <br><br><pre> <code class="cpp hljs"> i2c: i2c@f8f01d00 { compatible = <span class="hljs-string"><span class="hljs-string">"skel,skel-i2c"</span></span>; <span class="hljs-meta"><span class="hljs-meta">#address-cells = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;1&gt;; #size-cells = &lt;0&gt;; reg = &lt;0x43c00000 0x100&gt;; interrupt-parent = &lt;&amp;ps7_scugic_0&gt;; interrupts = &lt;0 29 4&gt;; clock-names = "skel-i2c"; clocks = &lt;&amp;clkc 38&gt;; clock-frequency = &lt;100000&gt;; 24c64@50 { compatible = "at,24c64"; pagesize = &lt;32&gt;; reg = &lt;0x50&gt;; }; } ;</span></span></span></span></code> </pre><br>  рдЙрдкрд░реЛрдХреНрдд рдЪрд░рдгреЛрдВ рдХреЛ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдирд╣реАрдВ рдорд╛рдирд╛ рдЬрд╛рдПрдЧрд╛, рд▓реЗрдХрд┐рди рдЬрд┐рдЬреНрдЮрд╛рд╕реБ рдкрд╛рдардХ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдпрд╣рд╛рдВ</a> рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред <br><br><h3>  <b>рдЪреМрдерд╛ рдЪрд░рдг</b> </h3><br>  рдЪрд╛рд▓рдХ рдХреЗ рд╕рд┐рджреНрдзрд╛рдВрдд рдХреЗ рд╕рд╛рде рдЦреБрдж рдХреЛ рдкрд░рд┐рдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЪрд▓реЛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреЗ рд╕рд╛рде рдЖрдЧреЗ рдмрдврд╝реЗрдВред <br>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣реЗрдбрд░ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдХрдиреЗрдХреНрдЯ рдХрд░реЗрдВ, "рд╡рд░реНрдЪреБрдЕрд▓" рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд╛рд░реНрдб рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдВ, рд╕рд╛рде рд╣реА I2C рдбреНрд░рд╛рдЗрд╡рд░ рдХреА рдкреНрд░рд╕реНрддреБрддрд┐ рднреАред <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* i2c-skel.c: I2C bus driver. * * Name Surname &lt;name@surname.ru&gt; * * This file is licensed under the terms of the GNU General Public License * version 2. This program is licensed "as is" without any warranty of any * kind, whether express or implied. */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;linux/module.h&gt; #include &lt;linux/kernel.h&gt; #include &lt;linux/platform_device.h&gt; #include &lt;linux/i2c.h&gt; #include &lt;linux/io.h&gt; #include &lt;linux/clk.h&gt; #include &lt;linux/interrupt.h&gt; #include &lt;linux/time.h&gt; #include &lt;linux/delay.h&gt; #include &lt;linux/device.h&gt; /* * Registers description. */ #define SKEL_I2C_ID 0x00 /* Core Identifier register */ #define SKEL_I2C_ISR 0x14 /* Interrupt Status Register */ #define SKEL_I2C_ISR_DNE BIT(0) /* One byte transaction done */ #define SKEL_I2C_ISR_ARB BIT(1) /* Arbitration lost */ #define SKEL_I2C_ISR_TXE BIT(2) /* RX FIFO nearly full */ #define SKEL_I2C_ISR_NACK BIT(3) /* No ACK */ #define SKEL_I2C_IER 0x18 /* Interrupt Enable Register */ #define SKEL_I2C_IER_DNE BIT(0) /* Enable DNE IRQ */ #define SKEL_I2C_IER_ARB BIT(1) /* Enable ARB LOSR IRQ */ #define SKEL_I2C_IER_TXE BIT(2) /* Enable TX FIFO EPMTY IRQ */ #define SKEL_I2C_IER_NACK BIT(3) /* Enable NACK IRQ */ #define SKEL_I2C_CTRL 0x1C /* Control Register */ #define SKEL_I2C_CTRL_EN BIT(0) /* Enable I2C controller */ #define SKEL_I2C_CTRL_START BIT(1) /* Send START condition */ #define SKEL_I2C_CTRL_R BIT(2) /* Read command */ #define SKEL_I2C_CTRL_W BIT(3) /* Write command */ #define SKEL_I2C_CTRL_STOP BIT(4) /* Send STOP cindition */ #define SKEL_I2C_TX 0x20 /* TX FIFO */ #define SKEL_I2C_RX 0x24 /* RX FIFO */ #define SKEL_I2C_CLK 0x28 /* Clock Prescale Register*/ #define SKEL_I2C_TIMEOUT 100000 #define SKEL_I2C_XFER_TIMEOUT (msecs_to_jiffies(500)) #define FIFO_SIZE_TX 1024 #define FIFO_SIZE_RX 1024 int presc = -1; module_param(presc, int, S_IRUGO | S_IWUSR); /* * skel_i2c - I2C device context * @base: pointer to register struct * @msg: pointer to current message * @mlen: number of bytes transferred in msg * @dev: device reference * @adap: i2c core abstraction * @msg_complete: xfer completion object * @clk: reference for i2c input clock * @err: error occured * @buf: ptr to msg buffer * @bus_clock: current i2c bus clock rate * @lock: spinlock for IRQ synchronization */ struct skel_i2c { void __iomem *base; struct i2c_msg *msg; size_t mlen; struct device *dev; struct i2c_adapter adap; struct completion msg_complete; struct clk *clk; u32 bus_clock; int err; u32 addr; u8 *buf; spinlock_t lock; };</span></span></span></span></code> </pre><br>  рдирд┐рдпрдВрддреНрд░рдХ рдХреЗ рдореБрдЦреНрдп рдирд┐рдпрдВрддреНрд░рдг рд░рдЬрд┐рд╕реНрдЯрд░ рд╣реИрдВ: <br><br><ul><li>  рдирд┐рдпрдВрддреНрд░рдг рд░рдЬрд┐рд╕реНрдЯрд░ (CTRL) - рдирд┐рдпрдВрддреНрд░рдг рд░рдЬрд┐рд╕реНрдЯрд░; </li><li>  рдЗрдВрдЯрд░рдкреНрдЯ рд╕реНрдЯреЗрдЯрд╕ рд░рдЬрд┐рд╕реНрдЯрд░ (ISR) - рд╡реНрдпрд╡рдзрд╛рди рд╕реНрдЯреЗрдЯрд╕ рд░рдЬрд┐рд╕реНрдЯрд░; </li><li>  рдЗрдВрдЯрд░рдкреНрдЯ рдЗрдиреЗрдмрд▓ рд░рдЬрд┐рд╕реНрдЯрд░ (IER) - рдЗрдВрдЯрд░рдкреНрдЯ рдорд╛рд╕реНрдХ рд░рдЬрд┐рд╕реНрдЯрд░ред </li></ul><br>  рдбреНрд░рд╛рдЗрд╡рд░ рдХрд╛ рджрд┐рд▓ skel_i2c рд╕рдВрд░рдЪрдирд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдлрд╝реАрд▓реНрдб рд╢рд╛рдорд┐рд▓ рд╣реИрдВ: <br><br><ul><li>  .base - рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд╛рд░реНрдб рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рд╕реВрдЪрдХ; </li><li>  .msg - рд╡рд░реНрддрдорд╛рди рд╕рдВрджреЗрд╢ рдХреЗ рд▓рд┐рдП рд╕реВрдЪрдХ; </li><li>  .adap - I2C рдЕрдореВрд░реНрдд <a href="">(рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ)</a> ред </li></ul><br>  рдЖрдЗрдП рдЕрдзрд┐рдХ рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рднрд╛рдЧ рдкрд░ рдЪрд▓рддреЗ рд╣реИрдВ, рдЪрд╛рд▓рдХ рджреНрд╡рд╛рд░рд╛ рд╕рдорд░реНрдерд┐рдд рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рдкреНрд░рдХрд╛рд░реЛрдВ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддреЗ рд╣реИрдВ, <br>  I2C рдПрдбрд╛рдкреНрдЯрд░ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдФрд░ I2C рд╕рдВрджреЗрд╢ рдЗрдВрдЯрд░рдлрд╝реЗрд╕: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of_device_id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">skel_i2c_match</span></span></span><span class="hljs-class">[] = {</span></span> { .compatible = <span class="hljs-string"><span class="hljs-string">"skel,skel-i2c"</span></span>, }, { .compatible = <span class="hljs-string"><span class="hljs-string">"at,24c64"</span></span>, }, {}, }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> u32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skel_i2c_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct i2c_adapter *adap)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL; } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i2c_algorithm</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">skel_i2c_algo</span></span></span><span class="hljs-class"> = {</span></span> .master_xfer = skel_i2c_xfer, .functionality = skel_i2c_func, }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">platform_driver</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">skel_i2c_driver</span></span></span><span class="hljs-class"> = {</span></span> .probe = skel_i2c_probe, .remove = skel_i2c_remove, .driver = { .name = <span class="hljs-string"><span class="hljs-string">"skel-i2c"</span></span>, .of_match_table = skel_i2c_match, }, }; module_platform_driver(skel_i2c_driver); MODULE_AUTHOR(<span class="hljs-string"><span class="hljs-string">"Name Surname"</span></span>); MODULE_DESCRIPTION(<span class="hljs-string"><span class="hljs-string">"I2C bus driver"</span></span>); MODULE_LICENSE(<span class="hljs-string"><span class="hljs-string">"GPL"</span></span>); MODULE_ALIAS(<span class="hljs-string"><span class="hljs-string">"platform:skel-i2c"</span></span>);</code> </pre><br>  рд╕рдВрд░рдЪрдирд╛рдУрдВ рдФрд░ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рдирд╛рдо рд╕реЗ, рдЙрдирдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рд╕реНрдкрд╖реНрдЯ рд╣реИ, рд╣рдо рдКрдкрд░ рд╕реЗ рдХреЗрд╡рд▓ рдореБрдЦреНрдп рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддреЗ рд╣реИрдВ: <br><br><ul><li>  skel_i2c_driver - рдбреНрд░рд╛рдЗрд╡рд░ рдХрд╛ рдирд╛рдо, рд╕рдорд░реНрдерд┐рдд рдЙрдкрдХрд░рдгреЛрдВ рдФрд░ рдлрд╝рдВрдХреНрд╢рдВрд╕ рдХреА рдПрдХ рддрд╛рд▓рд┐рдХрд╛ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ рдХреЛ рд╕рд┐рд╕реНрдЯрдо рд╕реЗ рд▓реЛрдб рдпрд╛ рд╣рдЯрд╛рдП рдЬрд╛рдиреЗ рдкрд░ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред </li></ul><br>  рдпрд╣ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ рдкрдВрдЬреАрдХреГрдд рдХрд░рдиреЗ рдХрд╛ рд╕рдордп рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рдирд┐рдпрдВрддреНрд░рдХ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝реЗрд╢рди рдлрд╝рдВрдХреНрд╢рди рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдирд╛, рдФрд░ skel_i2c_probe (рдЬрдм рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ) рдФрд░ skel_i2c_remove (рдЬрдм рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ рд╕рд┐рд╕реНрдЯрдо рд╕реЗ рдирд┐рдХрд╛рд▓рд╛ рдЬрд╛рддрд╛ рд╣реИ) рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдВред <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skel_i2c_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct skel_i2c *rdev)</span></span></span><span class="hljs-function"> </span></span>{ u32 bus_clk_khz = rdev-&gt;bus_clock / <span class="hljs-number"><span class="hljs-number">1000</span></span>; u32 clk_khz = clk_get_rate(rdev-&gt;clk) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> prescale; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> diff; prescale = clk_khz / (<span class="hljs-number"><span class="hljs-number">5</span></span> * bus_clk_khz) - <span class="hljs-number"><span class="hljs-number">1</span></span>; prescale = clamp(prescale, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFF</span></span>); diff = clk_khz / (<span class="hljs-number"><span class="hljs-number">5</span></span> * (prescale <span class="hljs-number"><span class="hljs-number">1</span></span>)) - bus_clk_khz; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(diff) &gt; bus_clk_khz / <span class="hljs-number"><span class="hljs-number">10</span></span>) { dev_err(rdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"Unsupported clock settings: clk: %d KHz, bus: %d KHz\n"</span></span>, clk_khz, bus_clk_khz); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EINVAL; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presc != <span class="hljs-number"><span class="hljs-number">-1</span></span>) i2c_write(presc, rdev-&gt;base, SKEL_I2C_CLK); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> i2c_write(prescale, rdev-&gt;base, SKEL_I2C_CLK); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skel_i2c_probe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct platform_device *pdev)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">skel_i2c</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rdev</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NULL</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">res</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> irq, ret; u32 val; rdev = devm_kzalloc(&amp;pdev-&gt;dev, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*rdev), GFP_KERNEL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!rdev) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -ENOMEM; res = platform_get_resource(pdev, IORESOURCE_MEM, <span class="hljs-number"><span class="hljs-number">0</span></span>); rdev-&gt;base = devm_ioremap_resource(&amp;pdev-&gt;dev, res); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IS_ERR(rdev-&gt;base)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PTR_ERR(rdev-&gt;base); irq = platform_get_irq(pdev, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (irq &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { dev_err(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"Missing interrupt resource\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> irq; } rdev-&gt;clk = devm_clk_get(&amp;pdev-&gt;dev, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IS_ERR(rdev-&gt;clk)) { dev_err(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"Missing clock\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PTR_ERR(rdev-&gt;clk); } rdev-&gt;dev = &amp;pdev-&gt;dev; init_completion(&amp;rdev-&gt;msg_complete); spin_lock_init(&amp;rdev-&gt;lock); val = of_property_read_u32(pdev-&gt;dev.of_node, <span class="hljs-string"><span class="hljs-string">"clock-frequency"</span></span>, &amp;rdev-&gt;bus_clock); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val) { dev_err(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"Default to 100kHz\n"</span></span>); rdev-&gt;bus_clock = <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* default clock rate */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rdev-&gt;bus_clock &gt; <span class="hljs-number"><span class="hljs-number">400000</span></span>) { dev_err(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"Invalid clock-frequency %d\n"</span></span>, rdev-&gt;bus_clock); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EINVAL; } ret = devm_request_irq(&amp;pdev-&gt;dev, irq, skel_i2c_isr, <span class="hljs-number"><span class="hljs-number">0</span></span>, pdev-&gt;name, rdev); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret) { dev_err(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"Failed to claim IRQ %d\n"</span></span>, irq); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } ret = clk_prepare_enable(rdev-&gt;clk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret) { dev_err(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"Failed to enable clock\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } skel_i2c_init(rdev); i2c_set_adapdata(&amp;rdev-&gt;adap, rdev); strlcpy(rdev-&gt;adap.name, pdev-&gt;name, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(rdev-&gt;adap.name)); rdev-&gt;adap.owner = THIS_MODULE; rdev-&gt;adap.algo = &amp;skel_i2c_algo; rdev-&gt;adap.dev.parent = &amp;pdev-&gt;dev; rdev-&gt;adap.dev.of_node = pdev-&gt;dev.of_node; platform_set_drvdata(pdev, rdev); ret = i2c_add_adapter(&amp;rdev-&gt;adap); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret) { clk_disable_unprepare(rdev-&gt;clk); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } dev_info(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"I2C probe complete\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skel_i2c_remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct platform_device *pdev)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">skel_i2c</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rdev</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">platform_get_drvdata</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pdev</span></span></span><span class="hljs-class">);</span></span> clk_disable_unprepare(rdev-&gt;clk); i2c_del_adapter(&amp;rdev-&gt;adap); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  рд╕рдмрд╕реЗ рд╕рд░рд▓ рдХрд╛рд░реНрдп skel_i2c_remove рд╣реИ, рдЬреЛ рдШрдбрд╝реА рдХреЗ рд╕реНрд░реЛрдд рдХреЛ рдмрдВрдж рдХрд░ рджреЗрддрд╛ рд╣реИ рдФрд░ рдЙрдкрдпреЛрдЧ рдХреА рдЧрдИ рдореЗрдореЛрд░реА рдХреЛ рдореБрдХреНрдд рдХрд░рддрд╛ рд╣реИред  Skel_i2c_init рдлрд╝рдВрдХреНрд╢рди I2C рдирд┐рдпрдВрддреНрд░рдХ рдХреЗ рдкреНрд░рд╛рд░рдВрдн рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддрд╛ рд╣реИред <br><br>  рдЬреИрд╕рд╛ рдХрд┐ рдкрд╣рд▓реЗ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, skel_i2c_probe рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ рдкрдВрдЬреАрдХреГрдд рдХрд░рддрд╛ рд╣реИред  рд╕рд╢рд░реНрдд рд░реВрдк рд╕реЗ, рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рдЕрдиреБрдХреНрд░рдо рдХреЛ рджреЛ рдЪрд░рдгреЛрдВ рдореЗрдВ рд╡рд┐рднрд╛рдЬрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: <br><br><ul><li>  рд╕рд┐рд╕реНрдЯрдо рд╕рдВрд╕рд╛рдзрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдФрд░ рдПрдХ рдмрд╛рдзрд╛ рд╣реИрдВрдбрд▓рд░ skel_i2c_isr рдкрдВрдЬреАрдХреГрдд рдХрд░рдирд╛; </li><li>  рд╕рдВрд░рдЪрдирд╛ рдХреНрд╖реЗрддреНрд░реЛрдВ рдореЗрдВ рднрд░рдирд╛ рдФрд░ рдПрдХ рдирдпрд╛ I2C рдПрдбрд╛рдкреНрдЯрд░ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ред </li></ul><br>  рдбреНрд░рд╛рдЗрд╡рд░ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдкрдВрдЬреАрдХреГрдд рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж, рдЖрдк рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдкрд░ рд╕рдВрджреЗрд╢ рд╕реНрдерд╛рдирд╛рдВрддрд░рдг рддрд░реНрдХ рдХреЛ рд▓рд╛рдЧреВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i2c_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *base, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> addr)</span></span></span><span class="hljs-function"> </span></span>{ writel(value, base addr); <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined DEBUG dev_dbg(rdev-&gt;dev, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"iowrite32(0x%x, base 0x%x);\n"</span></span></span><span class="hljs-meta">, value, addr); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> } static inline uint32_t i2c_read(void *base, uint32_t addr) { uint32_t reg = readl(base addr); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined DEBUG dev_dbg(rdev-&gt;dev, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/* ioread32(base 0x%x) == 0x%x */\n"</span></span></span><span class="hljs-meta">, addr, reg); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> return reg; } static irqreturn_t skel_i2c_isr(int irq, void *dev) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (unlikely(int_stat &amp; skel_I2C_ISR_ARB)) { } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (unlikely(int_stat &amp; skel_I2C_ISR_NACK)) { } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (read) fill_rx_fifo(rdev); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> fill_tx_fifo(rdev); complete(&amp;rdev-&gt;msg_complete); return IRQ_HANDLED; } static int skel_i2c_xfer_msg(struct skel_i2c *rdev, struct i2c_msg *msg) { unsigned long time; rdev-&gt;msg = msg; rdev-&gt;mlen = msg-&gt;len; rdev-&gt;addr = msg-&gt;addr; rdev-&gt;buf = msg-&gt;buf; rdev-&gt;err = 0; reinit_completion(&amp;rdev-&gt;msg_complete); skel_i2c_start_trans(rdev, msg); time = wait_for_completion_timeout(&amp;rdev-&gt;msg_complete, skel_I2C_XFER_TIMEOUT); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (time == 0) rdev-&gt;err = -ETIMEDOUT; rdev-&gt;curr; return rdev-&gt;err; } static int skel_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg *msgs, int num) { struct skel_i2c *rdev = i2c_get_adapdata(adap); int i, ret = 0; for (i = 0; (ret == 0) &amp;&amp; (i &lt; num); i) ret = skel_i2c_xfer_msg(rdev, msgs); skel_i2c_snd_stop(rdev); return ret ? : num; }</span></span></code> </pre><br>  рдкрд╣рд▓рд╛ рдЪрд░рдг рд╕рд┐рд╕реНрдЯрдо рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдВрддрд░рд┐рдХреНрд╖ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдХреА рдмрд╛рддрдЪреАрдд рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддрд╛ рд╣реИред  рд╣рдордиреЗ рдбреНрд░рд╛рдЗрд╡рд░ рдЗрдВрдЯрд░реНрдирд▓реНрд╕ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЛ рджреЗрдЦрдирд╛ рдЖрд╕рд╛рди рд╣реИ рдЬрд┐рд╕рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╡рд┐рдирд┐рдордп рд╣реЛрддрд╛ рд╣реИред  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рд╕рдВрджреЗрд╢ рдкрд╛рд╕ рдХрд░рдирд╛ рдирд┐рдореНрдирд╛рдиреБрд╕рд╛рд░ рд╣реИ: <br><br><ul><li>  skel_i2c_xfer - рдлрд╝рдВрдХреНрд╢рди рд╕реАрдзреЗ рдкреНрд░рд╕рд╛рд░рдг рдХреЗ рд▓рд┐рдП рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдХреНрд░рдорд┐рдХ рд░реВрдк рд╕реЗ рдкреНрд░рддреНрдпреЗрдХ рд╕рдВрджреЗрд╢ рдХреЛ skel_i2c_xfer_msg рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рддрд╛ рд╣реИред  рдпрджрд┐ рдбреЗрдЯрд╛ рдЯреНрд░рд╛рдВрд╕рдлрд░ рдХреЗ рджреМрд░рд╛рди рдХреЛрдИ рддреНрд░реБрдЯрд┐ рд╣реБрдИ, рддреЛ рдбреЗрдЯрд╛ рдЯреНрд░рд╛рдВрд╕рдлрд░ рд░реБрдХ рдЬрд╛рддрд╛ рд╣реИ; </li><li>  skel_i2c_xfer_msg - рдлрд╝рдВрдХреНрд╢рди рд╕рднреА рдЖрд╡рд╢реНрдпрдХ рдбреНрд░рд╛рдЗрд╡рд░ рдлрд╝реАрд▓реНрдб рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╕рдВрджреЗрд╢ рдкреНрд░рд╕рд╛рд░рдг рдХреА рд╢реБрд░реБрдЖрдд рдХрд░рддрд╛ рд╣реИ; </li><li>  skel_i2c_isr - рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдирд┐рдпрдорд┐рдд рдХрд░рдирд╛ред  рдпрд╣реАрдВ рдкрд░ рддреНрд░реБрдЯрд┐ рд╕реЗ рдирд┐рдкрдЯрдиреЗ рдФрд░ рдмрд╕ рд╕рдВрдЪрд╛рд░ рд╣реЛрддрд╛ рд╣реИред  рдпрджрд┐ рд╕рднреА рдбреЗрдЯрд╛ рднреЗрдЬреЗ / рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ, рддреЛ рдХрд┐рдП рдЧрдП рдзреНрд╡рдЬ рдХреЛ рдкреВрд░реНрдг рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рд╕рдВрджреЗрд╢ рд╕рдВрдЪрд░рдг рдХреЗ рдкреВрд░рд╛ рд╣реЛрдиреЗ рдХрд╛ рд╕рдВрдХреЗрдд рджреЗрддрд╛ рд╣реИред </li></ul><br>  рд▓реЗрдЦ рдореЗрдВ рдХрд╛рдо рдХреА рдХреБрдЫ рд╕реВрдХреНрд╖реНрдорддрд╛рдУрдВ рдХрд╛ рд╡рд░реНрдгрди рдирд╣реАрдВ рд╣реИред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд░рд┐рдпрд╛рдУрдВ рдХрд╛ рдХреНрд░рдо, рдЪреВрдВрдХрд┐ рдЗрд╕ рдПрд▓реНрдЧреЛрд░рд┐рдереНрдо рдХрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╣рд╛рд░реНрдбрд╡реЗрдпрд░-рдирд┐рд░реНрднрд░ рд╣реИред  рд╣рдордиреЗ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рд╕рд╛рдорд╛рдиреНрдп рднрд╛рдЧ рдХреЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд┐рдпрд╛, рдирд┐рдпрдВрддреНрд░рдХ рдХреА рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХреА рдкрд░рд╡рд╛рд╣ рдХрд┐рдП рдмрд┐рдирд╛ред <br><br>  рдкреВрд░реНрдг рдЪрд╛рд▓рдХ рдХрдВрдХрд╛рд▓ рдиреАрдЪреЗ рд╕рдВрд▓рдЧреНрди рд╣реИред  рдХреГрдкрдпрд╛, рдпрджрд┐ рдЖрдкрдХреЛ рддреНрд░реБрдЯрд┐рдпрд╛рдВ / рдЧрд▓рддрд┐рдпрд╛рдБ рдорд┐рд▓рддреА рд╣реИрдВ, рдпрд╛ рдЖрдкрдХреЗ рдкрд╛рд╕ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рд╣реИ, рддреЛ рдкреАрдПрдо рдпрд╛ рдЯрд┐рдкреНрдкрдгрд┐рдпреЛрдВ рдореЗрдВ рд▓рд┐рдЦреЗрдВред <br><br><div class="spoiler">  <b class="spoiler_title">рдЪрд╛рд▓рдХ рдХрдВрдХрд╛рд▓</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* i2c-skel.c: I2C bus driver. * * Name Surname &lt;name@surname.ru&gt; * * This file is licensed under the terms of the GNU General Public License * version 2. This program is licensed "as is" without any warranty of any * kind, whether express or implied. */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;linux/module.h&gt; #include &lt;linux/kernel.h&gt; #include &lt;linux/platform_device.h&gt; #include &lt;linux/i2c.h&gt; #include &lt;linux/io.h&gt; #include &lt;linux/clk.h&gt; #include &lt;linux/interrupt.h&gt; #include &lt;linux/time.h&gt; #include &lt;linux/delay.h&gt; #include &lt;linux/device.h&gt; /* * Registers description. */ #define SKEL_I2C_ID 0x00 /* Core Identifier register */ #define SKEL_I2C_ISR 0x14 /* Interrupt Status Register */ #define SKEL_I2C_ISR_DNE BIT(0) /* One byte transaction done */ #define SKEL_I2C_ISR_ARB BIT(1) /* Arbitration lost */ #define SKEL_I2C_ISR_TXE BIT(2) /* RX FIFO nearly full */ #define SKEL_I2C_ISR_NACK BIT(3) /* No ACK */ #define SKEL_I2C_IER 0x18 /* Interrupt Enable Register */ #define SKEL_I2C_IER_DNE BIT(0) /* Enable DNE IRQ */ #define SKEL_I2C_IER_ARB BIT(1) /* Enable ARB LOSR IRQ */ #define SKEL_I2C_IER_TXE BIT(2) /* Enable TX FIFO EPMTY IRQ */ #define SKEL_I2C_IER_NACK BIT(3) /* Enable NACK IRQ */ #define SKEL_I2C_CTRL 0x1C /* Control Register */ #define SKEL_I2C_CTRL_EN BIT(0) /* Enable I2C controller */ #define SKEL_I2C_CTRL_START BIT(1) /* Send START condition */ #define SKEL_I2C_CTRL_R BIT(2) /* Read command */ #define SKEL_I2C_CTRL_W BIT(3) /* Write command */ #define SKEL_I2C_CTRL_STOP BIT(4) /* Send STOP cindition */ #define SKEL_I2C_TX 0x20 /* TX FIFO */ #define SKEL_I2C_RX 0x24 /* RX FIFO */ #define SKEL_I2C_CLK 0x28 /* Clock Prescale Register*/ #define SKEL_I2C_TIMEOUT 100000 #define SKEL_I2C_XFER_TIMEOUT (msecs_to_jiffies(500)) #define FIFO_SIZE_TX 1024 #define FIFO_SIZE_RX 1024 int presc = -1; module_param(presc, int, S_IRUGO | S_IWUSR); /* * skel_i2c - I2C device context * @base: pointer to register struct * @msg: pointer to current message * @mlen: number of bytes transferred in msg * @dev: device reference * @adap: i2c core abstraction * @msg_complete: xfer completion object * @clk: reference for i2c input clock * @err: error occured * @buf: ptr to msg buffer * @bus_clock: current i2c bus clock rate * @lock: spinlock for IRQ synchronization */ struct skel_i2c { void __iomem *base; struct i2c_msg *msg; size_t mlen; struct device *dev; struct i2c_adapter adap; struct completion msg_complete; struct clk *clk; u32 bus_clock; int err;; u32 addr; u8 *buf; spinlock_t lock; }; static const struct of_device_id skel_i2c_match[] = { { .compatible = "skel,skel-i2c", }, { .compatible = "at,24c64", }, {}, }; static inline void i2c_write(uint32_t value, void *base, uint32_t addr) { writel(value, base + addr); #if defined DEBUG dev_dbg(rdev-&gt;dev, "iowrite32(0x%x, base 0x%x);\n", value, addr); #endif } static inline uint32_t i2c_read(void *base, uint32_t addr) { uint32_t reg = readl(base + addr); #if defined DEBUG dev_dbg(rdev-&gt;dev, "/* ioread32(base 0x%x) == 0x%x */\n", addr, reg); #endif return reg; } static void skel_i2c_transfer(struct skel_i2c *rdev, u32 data) { i2c_write(data, rdev-&gt;base, SKEL_I2C_TX); } static void fill_tx_fifo(struct skel_i2c *rdev) { size_t tx_fifo_avail = FIFO_SIZE_TX; int bytes_to_transfer = min(tx_fifo_avail, rdev-&gt;mlen); while (bytes_to_transfer-- &gt; 0) { skel_i2c_transfer(rdev, *rdev-&gt;buf); rdev-&gt;mlen--; } } static void fill_rx_fifo(struct skel_i2c *rdev) { size_t rx_fifo_avail = FIFO_SIZE_RX; int receive = min(rx_fifo_avail, rdev-&gt;mlen); while (receive-- &gt; 0) { *rdev-&gt;buf = i2c_read(rdev-&gt;base, SKEL_I2C_RX); rdev-&gt;mlen--; } } void skel_i2c_snd_stop(struct skel_i2c *rdev) { u32 control = i2c_read(rdev-&gt;base, SKEL_I2C_CTRL); i2c_write(control | SKEL_I2C_CTRL_STOP, rdev-&gt;base, SKEL_I2C_CTRL); } static irqreturn_t skel_i2c_isr(int irq, void *dev) { struct skel_i2c *rdev = dev; u32 int_stat, read; int_stat = i2c_read(rdev-&gt;base, SKEL_I2C_ISR); read = rdev-&gt;msg-&gt;flags &amp; I2C_M_RD; if (unlikely(int_stat &amp; SKEL_I2C_ISR_ARB)) { } else if (unlikely(int_stat &amp; SKEL_I2C_ISR_NACK)) { } if (read) fill_rx_fifo(rdev); else fill_tx_fifo(rdev); complete(&amp;rdev-&gt;msg_complete); return IRQ_HANDLED; } static void skel_i2c_start_trans(struct skel_i2c *rdev, struct i2c_msg *msg) { } static int skel_i2c_xfer_msg(struct skel_i2c *rdev, struct i2c_msg *msg) { unsigned long time; rdev-&gt;msg = msg; rdev-&gt;mlen = msg-&gt;len; rdev-&gt;addr = msg-&gt;addr; rdev-&gt;buf = msg-&gt;buf; rdev-&gt;err = 0; reinit_completion(&amp;rdev-&gt;msg_complete); skel_i2c_start_trans(rdev, msg); time = wait_for_completion_timeout(&amp;rdev-&gt;msg_complete, SKEL_I2C_XFER_TIMEOUT); if (time == 0) rdev-&gt;err = -ETIMEDOUT; return rdev-&gt;err; } static int skel_i2c_init(struct skel_i2c *rdev) { u32 bus_clk_khz = rdev-&gt;bus_clock / 1000; u32 clk_khz = clk_get_rate(rdev-&gt;clk) / 1000; int prescale; int diff; prescale = clk_khz / (5 * bus_clk_khz) - 1; prescale = clamp(prescale, 0, 0xFFFF); diff = clk_khz / (5 * (prescale - 1)) - bus_clk_khz; if (abs(diff) &gt; bus_clk_khz / 10) { dev_err(rdev-&gt;dev, "Unsupported clock settings: clk: %d KHz, bus: %d KHz\n", clk_khz, bus_clk_khz); return -EINVAL; } if (presc != -1) i2c_write(presc, rdev-&gt;base, SKEL_I2C_CLK); else i2c_write(prescale, rdev-&gt;base, SKEL_I2C_CLK); return 0; } static int skel_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg *msgs, int num) { struct skel_i2c *rdev = i2c_get_adapdata(adap); int i, ret = 0; for (i = 0; (ret == 0) &amp;&amp; (i &lt; num); i++) ret = skel_i2c_xfer_msg(rdev, msgs); skel_i2c_snd_stop(rdev); return ret ? : num; } static u32 skel_i2c_func(struct i2c_adapter *adap) { return I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL; } static const struct i2c_algorithm skel_i2c_algo = { .master_xfer = skel_i2c_xfer, .functionality = skel_i2c_func, }; static int skel_i2c_probe(struct platform_device *pdev) { struct skel_i2c *rdev = NULL; struct resource *res; int irq, ret; u32 val; rdev = devm_kzalloc(&amp;pdev-&gt;dev, sizeof(*rdev), GFP_KERNEL); if (!rdev) return -ENOMEM; res = platform_get_resource(pdev, IORESOURCE_MEM, 0); rdev-&gt;base = devm_ioremap_resource(&amp;pdev-&gt;dev, res); if (IS_ERR(rdev-&gt;base)) return PTR_ERR(rdev-&gt;base); irq = platform_get_irq(pdev, 0); if (irq &lt; 0) { dev_err(&amp;pdev-&gt;dev, "Missing interrupt resource\n"); return irq; } rdev-&gt;clk = devm_clk_get(&amp;pdev-&gt;dev, NULL); if (IS_ERR(rdev-&gt;clk)) { dev_err(&amp;pdev-&gt;dev, "Missing clock\n"); return PTR_ERR(rdev-&gt;clk); } rdev-&gt;dev = &amp;pdev-&gt;dev; init_completion(&amp;rdev-&gt;msg_complete); spin_lock_init(&amp;rdev-&gt;lock); val = of_property_read_u32(pdev-&gt;dev.of_node, "clock-frequency", &amp;rdev-&gt;bus_clock); if (val) { dev_err(&amp;pdev-&gt;dev, "Default to 100kHz\n"); rdev-&gt;bus_clock = 100000; /* default clock rate */ } if (rdev-&gt;bus_clock &gt; 400000) { dev_err(&amp;pdev-&gt;dev, "Invalid clock-frequency %d\n", rdev-&gt;bus_clock); return -EINVAL; } ret = devm_request_irq(&amp;pdev-&gt;dev, irq, skel_i2c_isr, 0, pdev-&gt;name, rdev); if (ret) { dev_err(&amp;pdev-&gt;dev, "Failed to claim IRQ %d\n", irq); return ret; } ret = clk_prepare_enable(rdev-&gt;clk); if (ret) { dev_err(&amp;pdev-&gt;dev, "Failed to enable clock\n"); return ret; } skel_i2c_init(rdev); i2c_set_adapdata(&amp;rdev-&gt;adap, rdev); strlcpy(rdev-&gt;adap.name, pdev-&gt;name, sizeof(rdev-&gt;adap.name)); rdev-&gt;adap.owner = THIS_MODULE; rdev-&gt;adap.algo = &amp;skel_i2c_algo; rdev-&gt;adap.dev.parent = &amp;pdev-&gt;dev; rdev-&gt;adap.dev.of_node = pdev-&gt;dev.of_node; platform_set_drvdata(pdev, rdev); ret = i2c_add_adapter(&amp;rdev-&gt;adap); if (ret) { clk_disable_unprepare(rdev-&gt;clk); return ret; } dev_info(&amp;pdev-&gt;dev, "I2C probe complete\n"); return 0; } static int skel_i2c_remove(struct platform_device *pdev) { struct skel_i2c *rdev = platform_get_drvdata(pdev); clk_disable_unprepare(rdev-&gt;clk); i2c_del_adapter(&amp;rdev-&gt;adap); return 0; } static struct platform_driver skel_i2c_driver = { .probe = skel_i2c_probe, .remove = skel_i2c_remove, .driver = { .name = "skel-i2c", .of_match_table = skel_i2c_match, }, }; module_platform_driver(skel_i2c_driver); MODULE_AUTHOR("Name Surname"); MODULE_DESCRIPTION("I2C bus driver"); MODULE_LICENSE("GPL"); MODULE_ALIAS("platform:skel-i2c");</span></span></span></span></code> </pre><br></div></div><br>  рдЖрдкрдХрд╛ рдзреНрдпрд╛рди рдХреЗ рд▓рд┐рдП рдзрдиреНрдпрд╡рд╛рдж! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi413249/">https://habr.com/ru/post/hi413249/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi413239/index.html">рд╕реНрдорд╛рд░реНрдЯрдлреЛрди рдХреЛ рдереЛрдбрд╝рд╛ рдбрдореНрдмрд░ рдХреИрд╕реЗ рдмрдирд╛рдпрд╛ рдЬрд╛рдП</a></li>
<li><a href="../hi413241/index.html">рдлреВрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓рд┐рдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рдореЗрдВ рдЕрд╡рд░реЛрдзрди рдХрд╛рд░реНрдп</a></li>
<li><a href="../hi413243/index.html">рдбреЗрдЯрд╛ рд╕реНрдХреВрд▓: рдЧрдгрд┐рдд рдФрд░ рд╡реНрдпрд╡рд╕рд╛рдп рдХреЛ рдХреИрд╕реЗ рдорд┐рд▓рд╛рдПрдВ</a></li>
<li><a href="../hi413245/index.html">рдбреЙрд▓реНрдмреА рдПрдЯрдореЙрд╕ рдЙрдкрдХрд░рдг рдкрд░ - рдХреЗрд╡рд▓ "рджреЗрд╢реА" рдзреНрд╡рдирд┐ред рдбреЙрд▓реНрдмреА рдЧреИрд░-рджреЗрд╢реА рдЙрддреНрдерд╛рди рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд░рддрд╛ рд╣реИ</a></li>
<li><a href="../hi413247/index.html">рднрдВрдбрд╛рд░рдг рдкреНрд░рдгрд╛рд▓рд┐рдпреЛрдВ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХреНрдпреЛрдВ рдХрд░реЗрдВ?</a></li>
<li><a href="../hi413251/index.html">рдкреЙрд▓рд┐рдорд░реЗрдЬрд╝ рдЪреЗрди рд░рд┐рдПрдХреНрд╢рди рдФрд░ рд╡реНрд▓рд╛рджрд┐рд╡реЛрд╕реНрддреЛрдХ</a></li>
<li><a href="../hi413253/index.html">рд░рд┐рдЪрд░реНрдб рд╣реИрдорд┐рдВрдЧ: рдЕрдзреНрдпрд╛рдп 21. рдлрд╛рдЗрдмрд░ рдСрдкреНрдЯрд┐рдХреНрд╕</a></li>
<li><a href="../hi413255/index.html">рд░рд┐рдЪрд░реНрдб рд╣реИрдорд┐рдВрдЧ: рдЕрдзреНрдпрд╛рдп 27. рдЕрдорд╛рдиреНрдп рдбреЗрдЯрд╛</a></li>
<li><a href="../hi413261/index.html">рдЦреЛрдЬ рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддреА рд╣реИ</a></li>
<li><a href="../hi413265/index.html">рдЖрдИрдЯреА рдХреЗ рд╕рд╛рде рд╕реНрдирд╛рдирд╛рдЧрд╛рд░ рдХреЗ рд▓рд┐рдП</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>