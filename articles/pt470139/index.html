<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüè´ üôçüèæ ü§∂ 2 hacks de vida: alternativas √† pesquisa cl√°ssica no Microsoft SQL Server ‚úàÔ∏è üíå üë®üèΩ‚Äçüè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! Nossos amigos da Softpoint prepararam um artigo interessante sobre o Microsoft SQL Server. Ele analisa dois exemplos pr√°ticos de uso da pesq...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>2 hacks de vida: alternativas √† pesquisa cl√°ssica no Microsoft SQL Server</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/470139/">  Ol√° Habr!  Nossos amigos da Softpoint prepararam um artigo interessante sobre o Microsoft SQL Server.  Ele analisa dois exemplos pr√°ticos de uso da pesquisa de texto completo: <br><br><ul><li>  Pesquise em linhas ‚Äúinfinitas‚Äù (por exemplo, Coment√°rios) em oposi√ß√£o a uma pesquisa regular atrav√©s do LIKE; </li><li>  Pesquise por n√∫meros de documentos com prefixos.  Onde geralmente a pesquisa de texto completo n√£o pode ser usada: prefixos constantes interferem nela.  Duas abordagens s√£o analisadas: pr√©-processando o n√∫mero do documento e adicionando seu pr√≥prio separador de palavras da biblioteca. </li></ul><br>  Inscreva-se agora! <br><br><img src="https://habrastorage.org/webt/cj/iu/to/cjiutotj7eknpw4cyapmoqw3yys.png"><a name="habracut"></a><br><br>  <i>Dou a palavra ao autor</i> <br><br>  Uma pesquisa eficaz em gigabytes de dados acumulados √© uma esp√©cie de "santo graal" dos sistemas de contabilidade.  Todo mundo quer encontr√°-lo e obter gl√≥ria imortal, mas no processo de procurar repetidas vezes, verifica-se que n√£o existe uma solu√ß√£o milagrosa. <br><br>  A situa√ß√£o √© complicada pelo fato de os usu√°rios geralmente quererem procurar uma substring - em algum lugar, o n√∫mero do contrato desejado √© "enterrado" no meio do coment√°rio;  em algum lugar, o operador n√£o lembra exatamente o nome do cliente, mas lembra que o nome dele √© "Alexey Evgrafovich";  em algum lugar, basta omitir a forma recorrente de propriedade do BYUBL e pesquisar imediatamente pelo nome da organiza√ß√£o.  Para DBMSs relacionais cl√°ssicos, essa pesquisa √© uma not√≠cia muito ruim.  Na maioria das vezes, essa pesquisa de substring √© reduzida √† rolagem met√≥dica de cada linha da tabela.  N√£o √© a estrat√©gia mais eficaz, especialmente se o tamanho da tabela aumentar para v√°rias dezenas de gigabytes. <br><br>  Em busca de uma alternativa, lembro-me frequentemente da "pesquisa de texto completo".  A alegria de encontrar uma solu√ß√£o geralmente passa rapidamente ap√≥s uma revis√£o superficial da pr√°tica existente.  Acontece rapidamente que, de acordo com a opini√£o popular, a pesquisa de texto completo: <br><br><ul><li>  Dif√≠cil de configurar </li><li>  Atualizado lentamente </li><li>  Trava o sistema ao atualizar </li><li>  Tem algum tipo de sintaxe incomum <s>est√∫pida</s> </li><li> N√£o encontra o que eles pedem </li></ul><br>  O conjunto de mitos pode ser continuado por um longo tempo, mas mesmo Plat√£o nos ensinou a ser c√©ticos e a n√£o aceitar cegamente a opini√£o de algu√©m sobre a f√©.  Vamos ver se o diabo √© t√£o terr√≠vel quanto ele √© pintado? <br><br>  E, embora n√£o estejamos profundamente imersos no estudo, <b>concordaremos imediatamente com uma condi√ß√£o importante</b> .  O mecanismo de pesquisa de texto completo pode fazer muito mais do que uma pesquisa de string comum.  Por exemplo, voc√™ pode definir um dicion√°rio de sin√¥nimos e usar a palavra "contato" para encontrar "telefone".  Ou pesquise palavras sem considerar a forma e os finais.  Essas op√ß√µes podem ser muito √∫teis para os usu√°rios, mas neste artigo consideramos a pesquisa de texto completo apenas como uma alternativa √† pesquisa de linha cl√°ssica.  Ou seja, <b>procuraremos apenas a substring que ser√° especificada na barra de pesquisa</b> , sem levar em conta sin√¥nimos, sem trazer palavras para a forma "normal" e outras magias. <br><br><h2>  Como funciona a pesquisa de texto completo do MS SQL </h2><br>  A funcionalidade de pesquisa de texto completo no MS SQL foi parcialmente removida do servi√ßo DBMS principal (pr√≥ximo ao final do artigo, veremos por que isso pode ser extremamente √∫til).  Para a pesquisa, um √≠ndice especial √© formado com sua estrutura, diferente das √°rvores balanceadas usuais. <br><br>  √â importante que, para criar um √≠ndice de pesquisa de texto completo, seja necess√°rio que exista um √≠ndice exclusivo na tabela de chaves, consistindo em apenas uma coluna - √© a pesquisa de texto completo que ser√° usada para identificar as linhas da tabela.  Freq√ºentemente, a tabela j√° possui esse √≠ndice na Chave Prim√°ria, mas √†s vezes precisar√° ser criada adicionalmente. <br><br>  O √≠ndice de pesquisa de texto completo √© preenchido de forma ass√≠ncrona e fora de transa√ß√£o.  Ap√≥s alterar uma linha da tabela, ela √© colocada na fila para processamento.  O processo de atualiza√ß√£o do √≠ndice recebe da linha da tabela (linha) todos os valores da string "subscritos" no √≠ndice e os divide em palavras separadas.  Depois disso, as palavras podem ser reduzidas a um determinado formul√°rio "padr√£o" (por exemplo, sem finais), para que seja mais f√°cil pesquisar por formul√°rios de palavras.  "Stop words" s√£o jogadas fora (preposi√ß√µes, artigos e outras palavras que n√£o t√™m significado).  As correspond√™ncias restantes do link palavra a sequ√™ncia s√£o gravadas no √≠ndice de pesquisa de texto completo. <br><br>  Acontece que cada coluna da tabela inclu√≠da no √≠ndice passa por esse pipeline: <br><br>  Linha longa -&gt; quebra de palavras -&gt; conjunto de partes (palavras) -&gt; stemmer -&gt; palavras normalizadas -&gt; [opcional] exce√ß√£o de palavra de parada -&gt; grava√ß√£o no √≠ndice <br><br>  Como mencionado, o processo de atualiza√ß√£o do √≠ndice √© ass√≠ncrono.  Segue-se disso: <br><br><ol><li>  A atualiza√ß√£o n√£o bloqueia a√ß√µes do usu√°rio </li><li>  A atualiza√ß√£o aguarda a conclus√£o da transa√ß√£o de altera√ß√£o de linha e come√ßa a aplicar as altera√ß√µes antes da confirma√ß√£o </li><li>  Altera√ß√µes no √≠ndice de texto completo s√£o aplicadas com algum atraso em rela√ß√£o √† transa√ß√£o principal.  Ou seja, entre adicionar uma linha e o momento em que ela pode ser encontrada, haver√° um atraso, dependendo do tamanho da fila de atualiza√ß√£o do √≠ndice </li><li>  O n√∫mero de elementos contidos no √≠ndice pode ser monitorado pela consulta: </li></ol><br><pre><code class="cs hljs">SELECT cat.name, FULLTEXTCATALOGPROPERTY(cat.name,<span class="hljs-string"><span class="hljs-string">'ItemCount'</span></span>) AS [ItemCount] FROM sys.fulltext_catalogs AS cat</code> </pre> <br><h2>  Testes pr√°ticos.  Pesquisa f√≠sica  pessoas por nome </h2><br><h4>  Preenchendo a tabela com dados </h4><br>  Para experimentos, criaremos uma nova base vazia com uma tabela onde as ‚Äúcontrapartes‚Äù ser√£o armazenadas.  Dentro do campo "descri√ß√£o", haver√° uma linha com o nome do contrato, onde o nome da contraparte ser√° mencionado.  Algo assim: <br><br>  "Contrato com Borovik Demyan Emelyanovich" <br><br>  Ou ent√£o: <br><br>  C√£o.  com Borovik-Romanov Anatoly Avdeevich " <br><br>  Sim, quero me afastar imediatamente dessa "arquitetura", mas, infelizmente, essa aplica√ß√£o de "coment√°rios" ou "descri√ß√µes" geralmente est√° entre os usu√°rios corporativos. <br><br>  Al√©m disso, adicionamos alguns campos ‚Äúpara peso‚Äù: se houver apenas 2 colunas na tabela, uma simples varredura ir√° l√™-lo em alguns momentos.  Precisamos "inflar" a tabela para que a verifica√ß√£o seja longa.  Isso nos aproxima de casos reais de neg√≥cios: n√£o apenas armazenamos a "descri√ß√£o" na tabela, mas tamb√©m muitas outras informa√ß√µes √∫teis [do diabo]. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">create table </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">partners</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id bigint identity (</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function">, [description] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">max</span></span></span><span class="hljs-function">), [address] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> N'107240, ,  ., 168', [phone] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> N'+7 (</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">495</span></span></span></span></span><span class="hljs-function">) 111-222-33', [contact_name] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> N'', [bio] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2048</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> N'     . , ,  .  ,    .        ,     .   ,  , ,       ,  .    . ,    ,   .       ,  ,            .       ,    ,     , .          ,   ,   .       .    .') --  ,    ..       </span></span></code> </pre> <br><br>  A pr√≥xima pergunta √© onde obter tantos sobrenomes, nomes e patron√≠micos exclusivos?  Eu, de acordo com um velho h√°bito, agia como um estudante russo normal, ou seja,  foi para a wikipedia: <br><br><ul><li>  Nomes retirados da p√°gina Categoria: Nomes masculinos russos </li><li>  Reescrever manualmente nomes do meio a partir de nomes, alterando finais </li><li>  Com sobrenomes, acabou sendo um pouco mais complicado.  No final, foi encontrada a categoria "namesakes".  Um pouco de xamanismo com Python e em uma tabela separada resultou em 46,5 mil nomes.  (um script para baixar sobrenomes est√° dispon√≠vel aqui) </li></ul><br>  Obviamente, houve varia√ß√µes estranhas entre os sobrenomes, mas, para os prop√≥sitos do estudo, isso foi bastante aceit√°vel. <br><br><img src="https://habrastorage.org/webt/0z/to/16/0zto16d8rkkkygbiuqvdorvlxdc.png"><br><br>  Eu escrevi um script sql que anexa um n√∫mero aleat√≥rio de nomes e nomes patron√≠micos a cada sobrenome.  5 minutos de espera e em uma mesa separada j√° havia 4,5 milh√µes de combina√ß√µes.  Nada mal!  Para cada sobrenome havia de 20 a 231 combina√ß√µes do nome + nome do meio, foram obtidas, em m√©dia, 97 combina√ß√µes.  A distribui√ß√£o por nome e patron√≠mico acabou sendo levemente tendenciosa "para a esquerda", mas parecia redundante criar um algoritmo mais equilibrado. <br><br><img src="https://habrastorage.org/webt/lb/yx/ug/lbyxugz2sjsri9uw7bi7rzornl4.png"><br><br>  Os dados s√£o preparados, podemos come√ßar nossos experimentos. <br><br><h4>  Configura√ß√£o de pesquisa de texto completo </h4><br>  Crie um √≠ndice de texto completo no n√≠vel do MS SQL.  Primeiro, precisamos criar um reposit√≥rio para esse √≠ndice - um cat√°logo de texto completo. <br><br><pre> <code class="cs hljs">USE [like_vs_fulltext] GO CREATE FULLTEXT CATALOG [basic_ftc] WITH ACCENT_SENSITIVITY = OFF AS DEFAULT AUTHORIZATION [dbo] GO</code> </pre> <br>  Existe um cat√°logo, estamos tentando adicionar um √≠ndice de texto completo para a nossa tabela ... e nada funciona. <br><br><img src="https://habrastorage.org/webt/-v/rd/ge/-vrdge8hjpp_c8pgt4j3imsmks4.png"><br><br>  Como eu disse, para um √≠ndice de texto completo, voc√™ precisa de um √≠ndice regular com uma coluna √∫nica.  Lembramos que j√° temos o campo obrigat√≥rio - um ID de identificador exclusivo.  Vamos criar um √≠ndice de cluster exclusivo nele (embora um n√£o clusterizado seja suficiente): <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">create unique clustered index ndx1 </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">on</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">partners</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id</span></span></span><span class="hljs-function">)</span></span></code> </pre> <br>  Depois de criar um novo √≠ndice, podemos finalmente adicionar o √≠ndice de pesquisa de texto completo.  Vamos esperar alguns minutos at√© que o √≠ndice esteja cheio (lembre-se de que ele √© atualizado de forma ass√≠ncrona!).  Voc√™ pode prosseguir para os testes. <br><br><h4>  Teste </h4><br>  Vamos come√ßar com o cen√°rio mais simples, pr√≥ximo √† aplica√ß√£o real da pesquisa.  Simulamos uma "exibi√ß√£o de lista" - uma sele√ß√£o de janela de 45 linhas com sele√ß√£o por m√°scara de pesquisa.  Executamos a solicita√ß√£o com um novo √≠ndice de texto completo, observamos o tempo - 0 segundos - excelente! <br><br><img src="https://habrastorage.org/webt/m8/ci/bk/m8cibkgbrwb2xkruwbspp3axfgk.png"><br><br>  Agora, uma pesquisa antiga e comprovada por "curtir".  Demorou 3 segundos para formar o resultado.  N√£o √© t√£o ruim, a derrota total n√£o funcionou.  Talvez n√£o fa√ßa sentido configurar uma pesquisa de texto completo - tudo funciona bem? <br><br><img src="https://habrastorage.org/webt/bl/gr/hl/blgrhlafampbhbssctycbcweuis.png"><br><br>  De fato, perdemos um detalhe importante: a solicita√ß√£o foi executada sem classifica√ß√£o.  Em primeiro lugar, essa consulta combinada com "selecionando os primeiros N registros" retorna um resultado injustificado.  Cada partida pode retornar registros N aleat√≥rios e n√£o h√° garantia de que duas partidas consecutivas fornecer√£o o mesmo conjunto de dados.  Em segundo lugar, se estamos falando de "visualizar a lista com uma janela deslizante" - geralmente essa mesma "janela" √© classificada por qualquer coluna, por exemplo, por nome.  Afinal, o operador precisa saber o que obter√° quando passar para a pr√≥xima "janela". <br><br>  Corrija o experimento.  Adicione a classifica√ß√£o, digamos, pelo n√∫mero de telefone: <br><br><img src="https://habrastorage.org/webt/tc/n-/i9/tcn-i9py1gxkrbrl927ygqqyudq.png"><br><br>  <b>A pesquisa de texto completo vence com uma pontua√ß√£o ensurdecedora: 0 segundos versus 172 segundos!</b> <br><br>  Se voc√™ observar os planos de consulta, fica claro por que isso acontece.  Devido √† adi√ß√£o de pedidos ao texto da consulta, uma opera√ß√£o de classifica√ß√£o apareceu durante a execu√ß√£o.  Essa √© a chamada opera√ß√£o de "bloqueio", que n√£o pode concluir a solicita√ß√£o at√© receber toda a quantidade de dados para classifica√ß√£o.  N√£o podemos coletar os primeiros 45 registros que temos, precisamos ordenar todo o conjunto de dados. <br><br>  E no est√°gio de obten√ß√£o de dados para classifica√ß√£o, ocorre uma diferen√ßa dram√°tica.  Uma pesquisa com "curtir" precisa navegar por toda a tabela dispon√≠vel.  Isso leva 172 segundos.  Mas a pesquisa de texto completo tem sua pr√≥pria estrutura otimizada, que retorna imediatamente os links para todas as entradas necess√°rias. <br><br><img src="https://habrastorage.org/webt/gq/nu/fw/gqnufwndwjmo5skv5_uq6ewvdkc.png"><br><br><img src="https://habrastorage.org/webt/uv/ew/c9/uvewc93qvfchgagsclaqi55hvt8.png"><br><br>  Mas deve haver uma mosca na pomada?  Existe um.  Conforme declarado no in√≠cio, uma pesquisa em texto completo s√≥ pode pesquisar a partir do in√≠cio de uma palavra.  E se quisermos encontrar "Ivan Poddubny" pela substring "* oak *", uma pesquisa em texto completo n√£o mostrar√° nada de √∫til. <br><br>  Felizmente, para pesquisar por nome, esse n√£o √© o cen√°rio mais popular. <br><br><h4>  Pesquise um documento por n√∫mero </h4><br>  Vamos tentar algo mais complicado.  O segundo caso de uso popular para pesquisa √© encontrar um documento por parte de seu n√∫mero.  Al√©m disso, muitas vezes o n√∫mero do documento consiste em duas partes: o prefixo da letra e o n√∫mero real contendo zeros √† esquerda. <br><br>  N√£o h√° espa√ßos ou caracteres de servi√ßo entre essas partes.  Ao mesmo tempo, pesquisar pelo n√∫mero inteiro √© monstruosamente inconveniente - voc√™ precisa lembrar quantos zeros √† esquerda ap√≥s o prefixo devem estar antes do in√≠cio da parte significativa.  Acontece que a pesquisa de texto completo "pronta para uso" √© simplesmente in√∫til nesse cen√°rio.  Vamos tentar consertar isso. <br><br>  Para o teste, criei uma nova tabela chamada document, na qual adicionei 13,5 milh√µes de registros com n√∫meros exclusivos do tipo "ORG".  A numera√ß√£o foi ordenada, todos os n√∫meros come√ßaram com "ORG".  Voc√™ pode come√ßar. <br><br><h4>  Pr√©-dividindo um n√∫mero </h4><br>  A pesquisa de texto completo pode pesquisar palavras com efici√™ncia.  Bem, vamos ajud√°-lo e dividir o n√∫mero "desconfort√°vel" em palavras convenientes com anteced√™ncia.  O plano de a√ß√£o √© o seguinte: <br><br><ol><li>  Adicione uma coluna adicional √† tabela de origem onde o n√∫mero especialmente convertido ser√° armazenado </li><li>  Adicione um gatilho que, ao alterar o n√∫mero, o divida em v√°rias partes pequenas, separadas por um espa√ßo </li><li>  A pesquisa de texto completo j√° sabe como dividir uma sequ√™ncia em partes por espa√ßos, para indexar nosso n√∫mero modificado sem problemas </li></ol><br>  Vamos ver como isso vai funcionar. <br><br>  Adicione uma coluna adicional √† tabela. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">alter table document </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">add</span></span></span><span class="hljs-function"> number_parts </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">128</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> ''</span></span></code> </pre> <br>  Um gatilho que preenche uma nova coluna pode ser escrito "testa", ignorando poss√≠veis duplicatas (quantos triplos repetidos est√£o no n√∫mero "0000012"?) E voc√™ pode adicionar um pouco de m√°gica em XML e gravar apenas partes √∫nicas.  A primeira implementa√ß√£o ser√° mais r√°pida, a segunda fornecer√° um resultado mais compacto.  De fato, a escolha √© entre velocidade de grava√ß√£o e velocidade de leitura, escolha o que √© mais importante em sua situa√ß√£o.  Agora basta passar por um <a href="">script</a> que processa os n√∫meros existentes. <br><br><img src="https://habrastorage.org/webt/jh/su/yi/jhsuyix1k3vmyz-m4_2lit8mn0c.png"><br><br>  Adicionar √≠ndice de texto completo <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">create fulltext index </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">on</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">document</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">number_parts</span></span></span><span class="hljs-function">) key index ndx1 with change_tracking</span></span> = Auto</code> </pre> <br>  E verifique o resultado.  O experimento √© o mesmo - modelando uma sele√ß√£o de "janela" a partir de uma lista de documentos.  N√£o repetimos os erros anteriores e executamos imediatamente a solicita√ß√£o com classifica√ß√£o, neste caso por data. <br><br><img src="https://habrastorage.org/webt/2a/mc/aq/2amcaqolncb-oewf7l9dfivqstq.png"><br><br>  Isso funciona!  Agora vamos tentar um n√∫mero mais aut√™ntico: <br><br><img src="https://habrastorage.org/webt/fe/a4/k9/fea4k9kc2isour1u-jkv5fla1pm.png"><br><br>  E ent√£o uma falha de igni√ß√£o acontece.  O comprimento da string de pesquisa √© maior que o comprimento das "palavras" armazenadas.  De fato, o banco de dados de pesquisa simplesmente n√£o possui uma √∫nica linha de 4 caracteres, portanto, honestamente, retorna um resultado vazio.  Teremos que dividir a sequ√™ncia de pesquisa em partes: <br><br><img src="https://habrastorage.org/webt/0z/tv/sy/0ztvsyfiijs2wuzppnutvugt-dy.png"><br><br>  Outra coisa!  Novamente, temos uma pesquisa r√°pida.  Sim, ele imp√µe sua sobrecarga √† manuten√ß√£o, mas o resultado √© centenas de vezes mais r√°pido que a pesquisa cl√°ssica.  Observamos a tentativa contada, mas tentamos simplificar a manuten√ß√£o de alguma forma - na pr√≥xima se√ß√£o. <br><br><h4>  Vamos dividi-lo em palavras √† nossa maneira! </h4><br>  De fato, quem disse que as palavras deveriam ser separadas por espa√ßos?  Talvez eu queira zeros entre as palavras!  (e, se poss√≠vel, o prefixo para que ele tamb√©m seja ignorado e n√£o interfira nos p√©s).  Em geral, n√£o h√° nada imposs√≠vel nisso.  Vamos relembrar o esquema da opera√ß√£o de pesquisa de texto completo desde o in√≠cio do artigo - um componente separado, o wordbreaker, √© respons√°vel por dividir as palavras e, felizmente, a Microsoft permite que voc√™ implemente seu pr√≥prio "separador de palavras". <br><br>  E aqui come√ßa o interessante.  O Wordbreaker √© uma dll separada que se conecta ao mecanismo de pesquisa de texto completo.  A <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o oficial</a> diz que fazer esta biblioteca √© muito simples - basta implementar a interface IWordBreaker.  E aqui est√£o algumas listagens curtas de inicializa√ß√£o em C ++.  Com muito sucesso, acabei de encontrar um tutorial adequado! <br><br><img src="https://habrastorage.org/webt/48/vk/hh/48vkhhkmxbga2tnxudfiktk2c4k.png">  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fonte</a> ) <br><br>  S√©rio, a documenta√ß√£o para criar seu pr√≥prio worbreaker na Internet √© muito pequena.  Ainda menos exemplos e modelos.  Mas ainda encontrei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">projeto de uma</a> pessoa gentil que escreveu em C ++ uma implementa√ß√£o que divide as palavras n√£o por separadores, mas simplesmente por triplos (sim, como na se√ß√£o anterior!) Al√©m disso, a pasta do projeto j√° cont√©m um bin√°rio cuidadosamente compilado, do qual voc√™ s√≥ precisa conecte-se ao mecanismo de pesquisa. <br><br>  Apenas ligando ... Na verdade, n√£o √© muito f√°cil.  Vamos seguir as etapas: <br><br>  Voc√™ precisa copiar a biblioteca para a pasta com o SQL Server: <br><br><img src="https://habrastorage.org/webt/oy/tj/wk/oytjwkzpv1b8mo6uvysgipl7fq0.png"><br><br>  Registre um novo "idioma" na pesquisa de texto completo <br><br><pre> <code class="cs hljs">exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\CLSID\{d225281a-7ca9-4a46-ae7d-c63a9d4815d4}'</span></span>, <span class="hljs-string"><span class="hljs-string">'DefaultData'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_SZ'</span></span>, <span class="hljs-string"><span class="hljs-string">'sqlngram.dll'</span></span> exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\CLSID\{0a275611-aa4d-4b39-8290-4baf77703f55}'</span></span>, <span class="hljs-string"><span class="hljs-string">'DefaultData'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_SZ'</span></span>, <span class="hljs-string"><span class="hljs-string">'sqlngram.dll'</span></span> exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\Language\ngram'</span></span>, <span class="hljs-string"><span class="hljs-string">'Locale'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_DWORD'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\Language\ngram'</span></span>, <span class="hljs-string"><span class="hljs-string">'WBreakerClass'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_SZ'</span></span>, <span class="hljs-string"><span class="hljs-string">'{d225281a-7ca9-4a46-ae7d-c63a9d4815d4}'</span></span> exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\Language\ngram'</span></span>, <span class="hljs-string"><span class="hljs-string">'StemmerClass'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_SZ'</span></span>, <span class="hljs-string"><span class="hljs-string">'{0a275611-aa4d-4b39-8290-4baf77703f55}'</span></span> exec sp_fulltext_service <span class="hljs-string"><span class="hljs-string">'verify_signature'</span></span> , <span class="hljs-number"><span class="hljs-number">0</span></span>; exec sp_fulltext_service <span class="hljs-string"><span class="hljs-string">'update_languages'</span></span>; exec sp_fulltext_service <span class="hljs-string"><span class="hljs-string">'restart_all_fdhosts'</span></span>; exec sp_help_fulltext_system_components <span class="hljs-string"><span class="hljs-string">'wordbreaker'</span></span>;</code> </pre> <br>  Edite manualmente v√°rias chaves no registro (o autor automatizaria o processo, mas n√£o h√° not√≠cias desde 2016. No entanto, esse era originalmente um "exemplo de implementa√ß√£o", obrigado por isso tamb√©m) <br><br><img src="https://habrastorage.org/webt/dx/yd/iq/dxydiqkbefi03iseanfv_tzfcii.png"><br><br>  As etapas s√£o descritas em detalhes na p√°gina do projeto. <br><br>  Feito.  Vamos excluir o antigo √≠ndice de texto completo, porque n√£o pode haver dois √≠ndices de texto completo para uma tabela.  Crie um novo e indexe nossos n√∫meros de documentos.  Como coluna principal, indicamos os pr√≥prios n√∫meros, n√£o s√£o necess√°rias mais colunas pr√©-quebradas substitutas.  Certifique-se de especificar o ‚Äúidioma n√∫mero 1‚Äù para usar o quebra-palavras instalado recentemente. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">drop fulltext index </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">on</span></span></span><span class="hljs-function"> document go create fulltext index </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">on</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">document</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">number Language </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">) key index ndx1 with change_tracking</span></span> = Auto</code> </pre> <br>  Verificar? <br><br><img src="https://habrastorage.org/webt/1p/se/zz/1psezzovwm3mnoweyyfkpoo6o34.png"><br><br>  Isso funciona!  Funciona t√£o r√°pido quanto todos os exemplos discutidos acima. <br><br>  Vamos verificar a longa fila na qual a op√ß√£o anterior trope√ßou: <br><br><img src="https://habrastorage.org/webt/iq/to/n8/iqton8zugajg5e85tcaieenab7k.png"><br><br>  A pesquisa funciona de forma transparente para o usu√°rio e o programador.  O Wordbreaker divide independentemente a sequ√™ncia de pesquisa em peda√ßos e encontra o resultado desejado. <br><br>  Acontece que agora n√£o precisamos de colunas e gatilhos adicionais, ou seja, a solu√ß√£o √© mais simples (leia-se: mais confi√°vel) do que nossa tentativa anterior.  Bem, em termos de suporte, essa implementa√ß√£o √© mais simples e transparente, h√° menos chances de erros. <br><br>  Ent√£o, pare, eu disse "mais confi√°vel"?  Acabamos de conectar uma biblioteca de terceiros ao nosso DBMS!  E o que acontecer√° se ela cair?  Mesmo inadvertidamente, arrasta todo o servi√ßo de banco de dados! <br><br>  Aqui, voc√™ precisa se lembrar de como, no in√≠cio do artigo, mencionei o servi√ßo de pesquisa de texto completo, separado do processo principal do DBMS.  √â aqui que fica claro por que isso √© importante.  A biblioteca se conecta ao servi√ßo de indexa√ß√£o de texto completo, que pode operar com direitos reduzidos.  E, mais importante, se componentes de terceiros ca√≠rem, apenas o servi√ßo de indexa√ß√£o cair√°.  A pesquisa ser√° interrompida por um tempo (mas j√° √© ass√≠ncrona) e o mecanismo de banco de dados continuar√° funcionando como se nada tivesse acontecido. <br><br>  Para resumir.  Adicionar seu pr√≥prio separador de palavras pode ser um grande desafio.  Mas, quando se joga "no tempo", esses esfor√ßos s√£o recompensados ‚Äã‚Äãcom maior flexibilidade e facilidade de manuten√ß√£o.  A escolha, como sempre, √© sua. <br><br><h2>  Por que tudo isso √© necess√°rio? </h2><br>  Um leitor curioso provavelmente se perguntou mais de uma vez: "tudo isso √© √≥timo, mas como posso usar esses recursos se n√£o consigo alterar as consultas de pesquisa do meu aplicativo?"  Pergunta razo√°vel.  A inclus√£o da pesquisa em MS SQL com texto completo requer altera√ß√£o da sintaxe das consultas, e geralmente isso simplesmente n√£o √© poss√≠vel na arquitetura existente. <br><br>  Voc√™ pode tentar enganar o aplicativo "deslizando" uma fun√ß√£o com o valor de tabela com o mesmo nome em vez de uma tabela regular, que j√° executar√° a pesquisa da maneira que desejamos.  Voc√™ pode tentar vincular a pesquisa como um tipo de fonte de dados externa.  Existe outra solu√ß√£o - Softpoint Data Cluster - um servi√ßo especial que instala um "encaminhamento" entre o aplicativo de origem e o servi√ßo do SQL Server, escuta o tr√°fego e pode alterar solicita√ß√µes dinamicamente de acordo com regras especiais.  Usando essas regras, podemos encontrar consultas regulares com LIKE e convert√™-las em CONTAINS com pesquisa de texto completo. <br><br>  Por que essas dificuldades?  Ainda assim, a velocidade da pesquisa √© cativante.  Em um sistema muito carregado, em que os operadores geralmente buscam registros em milh√µes de tabelas, a velocidade de resposta √© cr√≠tica.  Economizar tempo na opera√ß√£o mais frequente resulta em dezenas de aplicativos processados ‚Äã‚Äãadicionais, e isso √© dinheiro real, com o qual qualquer empresa est√° satisfeita.  No final, alguns dias ou at√© semanas para estudar e implementar a tecnologia ser√£o recompensados ‚Äã‚Äãcom maior efici√™ncia do operador. <br><br>  Todos os scripts mencionados no artigo est√£o dispon√≠veis no reposit√≥rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/frrrost/mssql_fulltext</a> <br><br><h2>  Sobre o autor </h2><br><img src="https://habrastorage.org/webt/xh/rm/q5/xhrmq5imxl5i7n9cp6lfjejy9w8.png" align="left" width="120">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Alexander Denisov</a> - Analista de Desempenho de Banco de Dados do MS SQL Server.  Nos √∫ltimos 6 anos, como parte da equipe da Softpoint, tenho ajudado a encontrar gargalos nas solicita√ß√µes de outras pessoas e a extrair o m√°ximo dos bancos de dados dos clientes. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt470139/">https://habr.com/ru/post/pt470139/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt470125/index.html">N√£o julgue estritamente o c√≥digo de outra pessoa</a></li>
<li><a href="../pt470127/index.html">Compositor com mem√≥ria de longo prazo</a></li>
<li><a href="../pt470129/index.html">Gerenciamento de mem√≥ria declarativa</a></li>
<li><a href="../pt470133/index.html">Como coletar m√©tricas n√£o distorcidas por refer√™ncia de tempo com o Prometheus</a></li>
<li><a href="../pt470135/index.html">Uma aplica√ß√£o web interativa sem programa√ß√£o? F√°cil! Mavo nos seus bra√ßos</a></li>
<li><a href="../pt470145/index.html">‚ÄúCuidado, FAS!‚Äù: Por que o ingresso militar √© perigoso na publicidade, por que √© importante saber matem√°tica e se a verdade pura √© sempre necess√°ria</a></li>
<li><a href="../pt470149/index.html">N√£o haver√° cole√ß√µes imut√°veis ‚Äã‚Äãem Java - nem agora nem nunca</a></li>
<li><a href="../pt470153/index.html">Dicion√°rio de modelo de dados</a></li>
<li><a href="../pt470155/index.html">Caracter√≠sticas do reconhecimento nacional de padr√µes</a></li>
<li><a href="../pt470159/index.html">Gera√ß√£o Prime</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>