<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòÇ üìï ü•Å IP-KVM via QEMU ‚ôæ üêµ ‚ÅâÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le d√©pannage lors du chargement du syst√®me d'exploitation sur des serveurs sans KVM n'est pas une t√¢che facile. Nous cr√©ons KVM sur IP √† l'aide d'une ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>IP-KVM via QEMU</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/selectel/blog/464565/"><img src="https://habrastorage.org/webt/jr/rx/m6/jrrxm6jhxdczns-5x0qym8maw_u.png"><br><br>  Le d√©pannage lors du chargement du syst√®me d'exploitation sur des serveurs sans KVM n'est pas une t√¢che facile.  Nous cr√©ons KVM sur IP √† l'aide d'une image de r√©cup√©ration et d'une machine virtuelle. <br><br>  En cas de probl√®me avec le syst√®me d'exploitation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur le serveur distant</a> , l'administrateur t√©l√©charge l'image de r√©cup√©ration et effectue le travail n√©cessaire.  Cette m√©thode fonctionne correctement lorsque la cause de l'√©chec est connue et que l'image de r√©cup√©ration et le syst√®me d'exploitation install√©s sur le serveur sont de la m√™me famille.  Si la cause de l'√©chec n'est pas encore connue, vous devez surveiller la progression du chargement du syst√®me d'exploitation. <br><a name="habracut"></a><br><h2>  KVM distant </h2><br>  Vous pouvez acc√©der √† la console du serveur √† l'aide d'outils int√©gr√©s tels que IPMI ou Intel¬Æ vPro ‚Ñ¢, ou √† l'aide de p√©riph√©riques externes appel√©s IP-KVM.  Il existe des situations dans lesquelles toutes les technologies r√©pertori√©es ne sont pas disponibles.  Mais ce n'est pas la fin.  Si le serveur peut √™tre red√©marr√© √† distance dans une image de r√©cup√©ration bas√©e sur le syst√®me d'exploitation Linux, alors KVM-sur-IP peut √™tre rapidement organis√©. <br><br>  L'image de r√©cup√©ration est un syst√®me d'exploitation √† part enti√®re qui r√©side dans la RAM.  Ainsi, nous pouvons ex√©cuter n'importe quel logiciel, y compris les machines virtuelles (VM).  Autrement dit, vous pouvez d√©marrer la machine virtuelle, √† l'int√©rieur de laquelle le syst√®me d'exploitation du serveur fonctionnera.  L'acc√®s √† la console VM peut √™tre organis√©, par exemple, via le VNC. <br><br>  Pour d√©marrer le syst√®me d'exploitation du serveur √† l'int√©rieur de la machine virtuelle, vous devez sp√©cifier les disques de serveur en tant que disques de machine virtuelle.  Sur la famille Linux de syst√®mes d'exploitation, les disques physiques sont repr√©sent√©s comme des p√©riph√©riques blocs de la forme <b>/ dev / sdX</b> , qui peuvent √™tre <b>trait√©s</b> comme des fichiers normaux. <br><br>  Certains hyperviseurs, tels que QEMU et VirtualBox, vous permettent de stocker des donn√©es de machine virtuelle sous une forme brute, c'est-√†-dire uniquement des donn√©es de stockage sans m√©tadonn√©es d'hyperviseur.  Ainsi, une machine virtuelle peut √™tre d√©marr√©e √† l'aide des disques physiques du serveur. <br><br>  Cette m√©thode n√©cessite des ressources pour ex√©cuter l'image de r√©cup√©ration et la machine virtuelle √† l'int√©rieur.  Cependant, avec quatre gigaoctets ou plus de RAM, ce ne sera pas un probl√®me. <br><br><h2>  Pr√©paration de l'environnement </h2><br>  En tant que machine virtuelle, vous pouvez utiliser le programme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">QEMU</a> l√©ger et simple, qui le plus souvent ne fait pas partie de l'image de r√©cup√©ration, il doit donc √™tre install√© s√©par√©ment.  L'image de r√©cup√©ration que nous proposons aux clients est bas√©e sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Arch Linux</a> , qui utilise le <b>gestionnaire de</b> paquets <b>pacman</b> . <br><br>  Vous devez d'abord vous assurer que l'image de r√©cup√©ration utilise le dernier logiciel.  Vous pouvez v√©rifier et mettre √† jour tous les composants du syst√®me d'exploitation avec la commande suivante: <br><br> <code>pacman -Suy</code> <br> <br>  Apr√®s la mise √† jour, vous devez installer QEMU.  La commande d'installation via pacman ressemblera √† ceci: <br><br> <code>pacman -S qemu</code> <br> <br>  V√©rifiez que qemu est install√© correctement: <br><br> <code>root@sel-rescue ~ # qemu-system-x86_64 --version <br> QEMU emulator version 4.0.0 <br> Copyright (c) 2003-2019 Fabrice Bellard and the QEMU Project developers</code> <br> <br>  Si c'est le cas, l'image de r√©cup√©ration est pr√™te √† fonctionner. <br><br><h2>  D√©marrage de la machine virtuelle </h2><br>  Vous devez d'abord d√©terminer la quantit√© de ressources allou√©es √† la machine virtuelle et trouver les chemins d'acc√®s aux disques physiques.  Dans notre cas, nous allouerons deux c≈ìurs et deux gigaoctets de RAM √† la machine virtuelle, et les disques sont situ√©s sur les chemins <b>/ dev / sda</b> et <b>/ dev / sdb</b> .  Ex√©cutez VM: <br><br> <code>qemu-system-x86_64 \ <br> -m 2048M \ <br> -net nic -net user \ <br> -enable-kvm \ <br> -cpu host,nx \ <br> -M pc \ <br> -smp 2 \ <br> -vga std \ <br> -drive file=/dev/sda,format=raw,index=0,media=disk \ <br> -drive file=/dev/sdb,format=raw,index=1,media=disk \ <br> -vnc :0,password \ <br> -monitor stdio</code> <br> <br>  Un peu plus sur la signification de chacun des param√®tres: <br><br><ul><li>  <b>-m 2048M</b> - alloue 2 Go de RAM par VM; </li><li>  <b>-net nic -net user</b> - ajoute une simple connexion r√©seau via un hyperviseur utilisant NAT (Network Address Translation); </li><li>  <b>-enable-kvm</b> - <b>active la</b> virtualisation KVM compl√®te (Kernel Virtual Machine); </li><li>  <b>-cpu host</b> - indique au processeur virtuel d'obtenir toutes les fonctionnalit√©s du processeur de serveur; </li><li>  <b>-M pc</b> - type d'√©quipement PC; </li><li>  <b>-smp 2</b> - le processeur virtuel doit √™tre dual-core; </li><li>  <b>-vga std</b> - s√©lectionnez une carte vid√©o standard qui ne prend pas en charge les r√©solutions de grand √©cran; </li><li>  <b>-drive file = / dev / sda, format = raw, index = 0, media = disk</b> <br><ul><li>  <b>file = / dev / sdX</b> - chemin vers le p√©riph√©rique de bloc repr√©sentant le disque du serveur; </li><li>  <b>format = raw</b> - marque que dans le fichier sp√©cifi√© toutes les donn√©es sont sous la forme "brute", c'est-√†-dire comme sur le disque; </li><li>  <b>index = 0</b> - num√©ro de disque, devrait augmenter de un pour chaque disque suivant; </li><li>  <b>media = disk</b> - la machine virtuelle doit reconna√Ætre ce stockage comme un disque; </li></ul></li><li>  <b>-vnc: 0, mot de passe</b> - ex√©cutez le serveur VNC par d√©faut √† 0.0.0.0:5900, utilisez le mot de passe comme autorisation; </li><li>  <b>-monitor stdio</b> - l'administrateur communiquera avec qemu via des flux d'entr√©e / sortie standard. </li></ul><br>  Si tout est en ordre, le moniteur QEMU d√©marre: <br><br> <code>QEMU 4.0.0 monitor - type 'help' for more information <br> (qemu)</code> <br> <br>  Nous avons indiqu√© que l'autorisation a lieu avec un mot de passe, mais nous n'avons pas sp√©cifi√© le mot de passe lui-m√™me.  Vous pouvez le faire en envoyant la commande change vnc password au moniteur QEMU.  Remarque importante: le mot de passe ne doit pas comporter plus de huit caract√®res. <br><br> <code>(qemu) change vnc password <br> Password: ******</code> <br> <br>  Apr√®s cela, nous pouvons nous connecter avec n'importe quel client VNC, par exemple, Remmina, par l'adresse IP de notre serveur avec le mot de passe que vous avez sp√©cifi√©. <br><br><img src="https://habrastorage.org/webt/hz/c8/gv/hzc8gv9gh83yjki7t3ycmiazdds.png" title="Param√®tres de connexion via VNC"><br><br><img src="https://habrastorage.org/webt/um/qs/sh/umqsshwhmcbnd0c2uc_u0nte-la.png" title="Le client VNC permet de savoir pourquoi le syst√®me d'exploitation n'a pas d√©marr√©."><br><br>  Maintenant, non seulement nous voyons des erreurs possibles au stade du chargement, mais nous pouvons les combattre. <br><br>  √Ä la fin du travail, vous devez terminer la machine virtuelle.  Cela peut √™tre fait soit √† l'int√©rieur du syst√®me d'exploitation en <b>envoyant un</b> signal d'arr√™t, soit vous pouvez donner la commande <b>system_powerdown</b> au moniteur QEMU.  Cela √©quivaudra √† une simple pression sur le bouton d'arr√™t: le syst√®me d'exploitation √† l'int√©rieur de la machine virtuelle s'arr√™tera en douceur. <br><br><h2>  Installation du syst√®me d'exploitation </h2><br>  La machine virtuelle a un acc√®s complet aux disques du serveur et peut donc √™tre utilis√©e pour installer manuellement le syst√®me d'exploitation.  La seule limitation est la quantit√© de RAM: pas toujours l'image ISO peut √™tre plac√©e dans la RAM.  Nous s√©lectionnons quatre gigaoctets de RAM pour stocker l'image dans <b>/ mnt</b> : <br><br> <code>mount -t tmpfs -o size=4G tmpfs /mnt</code> <br> <br>  Nous chargeons √©galement l'image d'installation du syst√®me d'exploitation FreeBSD 12.0: <br><br> <code>wget -P /mnt ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd64/ISO-IMAGES/12.0/FreeBSD-12.0-RELEASE-amd64-bootonly.iso</code> <br> <br>  Vous pouvez maintenant d√©marrer la VM: <br><br> <code>qemu-system-x86_64 \ <br> -m 2048M \ <br> -net nic -net user \ <br> -enable-kvm \ <br> -cpu host,nx \ <br> -M pc \ <br> -smp 2 \ <br> -vga std \ <br> -drive file=/dev/sda,format=raw,index=0,media=disk \ <br> -drive file=/dev/sdb,format=raw,index=1,media=disk \ <br> -vnc :0,password \ <br> -monitor stdio \ <br> -cdrom /mnt/FreeBSD-12.0-RELEASE-amd64-bootonly.iso \ <br> -boot d <br></code> <br><br>  L' <b>indicateur -boot d</b> d√©finit le d√©marrage √† partir du lecteur de CD.  Nous sommes connect√©s par le client VNC et nous voyons le chargeur FreeBSD. <br><br><img src="https://habrastorage.org/webt/j4/jb/hh/j4jbhhidggiupbszepsduhffn0g.png" title="Chargeur de d√©marrage FreeBSD."><br><br>  √âtant donn√© que DHCP a √©t√© utilis√© pour acc√©der √† Internet, il est possible qu'apr√®s la configuration, il soit n√©cessaire de d√©marrer sur le syst√®me nouvellement install√© et de corriger les param√®tres r√©seau.  Dans certains cas, il peut √™tre n√©cessaire d'installer des pilotes de carte r√©seau, car la carte r√©seau install√©e sur le serveur et √©mul√©e dans la machine virtuelle est diff√©rente. <br><br><h2>  Conclusion </h2><br>  Cette m√©thode d'organisation de l'acc√®s √† distance √† la console du serveur consomme une partie des ressources du serveur, cependant, elle n'impose aucune exigence particuli√®re au composant mat√©riel du serveur et peut donc √™tre effectu√©e dans presque toutes les conditions.  L'utilisation de cette solution peut consid√©rablement faciliter le diagnostic des pannes logicielles et restaurer la sant√© d'un serveur distant. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr464565/">https://habr.com/ru/post/fr464565/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr464555/index.html">Un moyen facile de gagner de l'argent sur Bug Bounty</a></li>
<li><a href="../fr464557/index.html">XD Design Bobby Pro: le remake que nous attendions</a></li>
<li><a href="../fr464559/index.html">Caract√©ristiques du transport Universiade et un Alex tr√®s enthousiaste</a></li>
<li><a href="../fr464561/index.html">√âcriture d'applications iOS √† l'aide du mod√®le Redux</a></li>
<li><a href="../fr464563/index.html">S√©curit√© de l'information - ce que vous devez savoir et √™tre consid√©r√© comme un bon sp√©cialiste de la s√©curit√© de l'information?</a></li>
<li><a href="../fr464571/index.html">Cerveau + VPS pour 30 roubles =?</a></li>
<li><a href="../fr464579/index.html">Camp d'√©t√© sur la vision par ordinateur - Intel Summer Vision Summer School</a></li>
<li><a href="../fr464581/index.html">25 types de "C√©sar" et de mots anglais</a></li>
<li><a href="../fr464583/index.html">Un ensemble de donn√©es 3D massif aide les robots √† comprendre les choses</a></li>
<li><a href="../fr464591/index.html">Chimie du poulet frit. Analyse d√©taill√©e</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>