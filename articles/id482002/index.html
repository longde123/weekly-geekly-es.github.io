<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§£ üë®üèø üë®üèΩ‚Äçüè≠ Menulis Blog Layanan Mikro - Bagian 3 ‚ÄúPengguna‚Äù üïì üë®üèΩ‚Äçüíº ü§±üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada bagian kedua dari seri artikel kami ‚ÄúMenulis Blog di Layanan Mikro‚Äù kami menggambarkan API Gateway . 

 Di sini kami menjelaskan implementasi mic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Menulis Blog Layanan Mikro - Bagian 3 ‚ÄúPengguna‚Äù</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/482002/">  Pada bagian kedua dari seri artikel kami ‚ÄúMenulis Blog di Layanan Mikro‚Äù kami menggambarkan <a href="https://habr.com/ru/post/473516/">API Gateway</a> . <br><br>  Di sini kami menjelaskan implementasi microservice pengguna. <br><a name="habracut"></a><br>  Layanan microser kami harus dapat: <br><br><ul><li>  Log panggilan layanan dan status perantara yang menunjukkan TraceId (yang sama dikeluarkan oleh api-gw, lihat <a href="https://habr.com/ru/post/473516/">Bagian 2 "API Gateway"</a> ) </li><li>  Menerapkan fungsi Login (SignIN) dan Registrasi (Signup) </li><li>  Menerapkan fungsi CRUD (membuat, membaca, mengedit, menghapus catatan dalam database).  Gunakan MongoDB sebagai database. </li></ul><br>  Pertama, kami menggambarkan layanan kami di file proto (./services/user/protobuf/user.proto). <br>  Tentukan sintaks yang digunakan - proto3.  Kami menunjukkan nama paket protobuf, dalam paket ini kode yang dibuat secara otomatis dari server dan bagian klien akan diimplementasikan. <br><br>  Kami mengimpor perpustakaan anotasi google / api / annotations.proto, itu akan diperlukan untuk menggambarkan arahan untuk menghasilkan REST API. <br><br><pre><code class="go hljs">syntax = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> protobuf; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"google/api/annotations.proto"</span></span>;</code> </pre> <br>  Deskripsi layanan Pengguna, langsung antarmuka (metode) yang harus dimiliki.  Misalnya, antarmuka SignUp (pendaftaran): ia menerima pesan SignUpRequest yang berisi atribut Username, Password, FirstName, dan LastName dan merespons dengan pesan SignUpResponse yang berisi atribut Slug (UserID), Username, Atribut peran.  Juga di deskripsi antarmuka, di bagian opsi, tentukan direktif pos: "/ api / v1 / user / signup. Berdasarkan hal itu, pembuat kode akan membuat antarmuka REST yang akan menerima permintaan POST di http: {{api_gw_host}} / api / v1 / user / daftar. <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//-------------------------------------------------- //   User //-------------------------------------------------- service UserService { //  rpc SignUp (SignUpRequest) returns (SignUpResponse) { option (google.api.http) = { post: "/api/v1/user/signup" }; } ‚Ä¶ } //-------------------------------------------------- // SignUp //-------------------------------------------------- message SignUpRequest { string Username = 1; string Password = 2; string FirstName = 3; string LastName = 4; } message SignUpResponse { string Slug = 1; string Username = 2; string Role = 3; }</span></span></code> </pre><br>  Dan itu akan mengharapkan struktur berikut di badan permintaan: <br><br><pre> <code class="go hljs">{ Username: <span class="hljs-string"><span class="hljs-string">'username_value'</span></span>, Password: <span class="hljs-string"><span class="hljs-string">'password_value'</span></span>, FirstName: <span class="hljs-string"><span class="hljs-string">'firstname_value'</span></span>, LastName: <span class="hljs-string"><span class="hljs-string">'lastname_value'</span></span>, }</code> </pre><br>  Dan dengan demikian, jika berhasil, itu akan memberikan struktur: <br><br><pre> <code class="go hljs">{ Slug: <span class="hljs-string"><span class="hljs-string">'user_id_value'</span></span>, Username: <span class="hljs-string"><span class="hljs-string">'username_value'</span></span>, Role: <span class="hljs-string"><span class="hljs-string">'role_value'</span></span>, }</code> </pre><br>  Atau kesalahan.  Kami akan memberi tahu Anda lebih banyak tentang kesalahan beberapa saat kemudian di bagian yang menjelaskan fungsi yang mengimplementasikan antarmuka yang dijelaskan dalam protofile. <br><br>  Antarmuka lain (Masuk, Buat, Perbarui, Hapus, Dapatkan, Temukan) dideklarasikan dengan cara yang sama. <br><br>  Sekarang kita memiliki protofile yang sudah jadi.  Kami pergi ke direktori root proyek dan menjalankan perintah sh ./bin/protogen.sh.  Script ini akan menghasilkan kode utama. <br>  Selanjutnya, pergi ke direktori ./services/user dan dalam file functions.go tulis implementasi dari antarmuka yang dideklarasikan. <br><br>  Pertama, kami menerapkan middleware.  Pada setiap permintaan ke layanan, kami mengeluarkan parameter TraceId, UserId, UserRole dari konteks permintaan dan menuliskannya ke file log.  Di sini Anda dapat menerapkan otorisasi permintaan. <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//-------------------------------------------------- // Midelware //-------------------------------------------------- func AccessLogInterceptor(ctx context.Context,req interface{},info *grpc.UnaryServerInfo,handler grpc.UnaryHandler,) (interface{}, error) { start:=time.Now() md,_:=metadata.FromIncomingContext(ctx) // Calls the handler reply, err := handler(ctx, req) var traceId,userId,userRole string if len(md["trace-id"])&gt;0{ traceId=md["trace-id"][0] } if len(md["user-id"])&gt;0{ userId=md["user-id"][0] } if len(md["user-role"])&gt;0{ userRole=md["user-role"][0] } msg:=fmt.Sprintf("Call:%v, traceId: %v, userId: %v, userRole: %v, time: %v", info.FullMethod,traceId,userId,userRole,time.Since(start)) app.AccesLog(msg) return reply, err }</span></span></code> </pre><br>  Dalam metode Pendaftaran, kami menentukan struktur respons. <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//,   STATUS_FAIL out:=&amp;SignUpResponse{}</span></span></code> </pre><br>  Selanjutnya, periksa parameter permintaan. <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//     // Username err:=checkUserName(in.Username) if err!=nil{ log.Printf("[ERR] %s.SignUp, %v", app.SERVICE_NAME,err) return out,err } // Username   err=o.checkUserNameExist(in.Username) if err!=nil{ log.Printf("[ERR] %s.SignUp, %v", app.SERVICE_NAME,err) return out,err } // Password err=checkPassword(in.Password) if err!=nil{ log.Printf("[ERR] %s.SignUp, %v", app.SERVICE_NAME,err) return out,err }</span></span></code> </pre><br>  Dan jika semuanya baik-baik saja, isi struktur Pengguna, tulis ke database dan kembalikan jawabannya. <br><br><pre> <code class="go hljs">user:=&amp;User{ Username:in.Username, FirstName:in.FirstName, LastName:in.LastName, Password:getMD5(in.Password), } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> slug <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> collection:= o.DbClient.Database(<span class="hljs-string"><span class="hljs-string">"blog"</span></span>).Collection(<span class="hljs-string"><span class="hljs-string">"users"</span></span>) insertResult, err := collection.InsertOne(context.TODO(), user) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> out,err } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> oid, ok := insertResult.InsertedID.(primitive.ObjectID); ok { slug=fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"%s"</span></span>,oid.Hex()) }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { err:=app.ErrInsert <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> out,err } out.Slug=slug out.Username=in.Username out.Role=app.ROLE_USER <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> out,<span class="hljs-literal"><span class="hljs-literal">nil</span></span></code> </pre><br>  Secara terpisah, kami memperhatikan pengembalian kesalahan, misalnya: <br><br><pre> <code class="go hljs">err:=app.ErrInsert</code> </pre><br>  Karena pada akhirnya kesalahan ini akan kembali ke api-wg kami (di bagian REST-nya) dan akan lebih baik untuk mengubahnya menjadi kode respons HTTP standar.  Agar tidak menulis banyak kode tambahan, Anda tidak boleh menggunakan standard go error, tetapi status.error dari paket google.golang.org/grpc/status. <br><br>  Semua kesalahan umum dari microservice pengguna dan bagaimana mereka dikonversi ke kode respons HTTP dijelaskan dalam file. / Layanan / pengguna / aplikasi / errors.go. <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"google.golang.org/grpc/codes"</span></span> <span class="hljs-string"><span class="hljs-string">"google.golang.org/grpc/status"</span></span> ) <span class="hljs-comment"><span class="hljs-comment">//    var ( //  ErrEmailIncorrect = status.Error(codes.InvalidArgument, " E-mail") ErrPasswordIsEmpty = status.Error(codes.InvalidArgument, "Password  ") ErrUserNameIsEmpty = status.Error(codes.InvalidArgument, "E-mail  ") ErrUserNameIsExist = status.Error(codes.AlreadyExists, "  ") ErrNotFound = status.Error(codes.NotFound, "  ") ErrIncorrectLoginOrPassword = status.Error(codes.Unauthenticated,"   ") // CRUD ErrInsert = status.Error(codes.Internal, "  ") ErrUpdate = status.Error(codes.Internal, "  ") ) //================================================== // All gRPC err codes //================================================== // codes.OK - http.StatusOK // codes.Canceled - http.StatusRequestTimeout // codes.Unknown - http.StatusInternalServerError // codes.InvalidArgument - http.StatusBadRequest // codes.DeadlineExceeded - http.StatusGatewayTimeout // codes.NotFound - http.StatusNotFound // codes.AlreadyExists - http.StatusConflict // codes.PermissionDenied - http.StatusForbidden // codes.Unauthenticated - http.StatusUnauthorized // codes.ResourceExhausted - http.StatusTooManyRequests // codes.FailedPrecondition - http.StatusBadRequest // codes.Aborted - http.StatusConflict // codes.OutOfRange - http.StatusBadRequest // codes.Unimplemented - http.StatusNotImplemented // codes.Internal - http.StatusInternalServerError // codes.Unavailable - http.StatusServiceUnavailable // codes.DataLoss - http.StatusInternalServerError</span></span></code> </pre><br>  Dan hal terakhir yang ingin saya sampaikan tentang microservice pengguna adalah bagaimana ia memulai dan terhubung ke database.  Operasi ini dilakukan dalam file ./services/user/main.go. <br><br>  Peluncuran Layanan: <br><br><pre> <code class="go hljs">lis,err:= net.Listen(<span class="hljs-string"><span class="hljs-string">"tcp"</span></span>, fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">":%s"</span></span>, Port)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatalf(<span class="hljs-string"><span class="hljs-string">"failed to listen: %v"</span></span>, err) } grpcServer:= grpc.NewServer( grpc.UnaryInterceptor(protobuf.AccessLogInterceptor), ) s:=&amp;protobuf.Server{} ‚Ä¶ <span class="hljs-comment"><span class="hljs-comment">// attach the user service to the server protobuf.RegisterUserServiceServer(grpcServer, s)</span></span></code> </pre><br>  Koneksi ke database (main.go): <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//   s.DbConnect() defer s.DbDisconnect()</span></span></code> </pre><br>  Implementasi fungsi DbConnect (./services/user/functions.go): <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//-------------------------------------------------- // /   //-------------------------------------------------- func (o *Server) DbConnect() error { var client *mongo.Client // Create client strURI:=fmt.Sprintf("mongodb://%s:%s@%s:%s",os.Getenv("MONGO_USER"),os.Getenv("MONGO_PASS"),os.Getenv("MONGO_HOST"),os.Getenv("MONGO_PORT")) client, err:= mongo.NewClient(options.Client().ApplyURI(strURI)) if err != nil { return err } // Create connect err = client.Connect(context.TODO()) if err != nil { return err } o.DbClient=client return nil }</span></span></code> </pre></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id482002/">https://habr.com/ru/post/id482002/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id481990/index.html">Sepuluh tahun malware: botnet terbesar 2010</a></li>
<li><a href="../id481992/index.html">Tekton Pipeline - jaringan pipa asli Kubernetes</a></li>
<li><a href="../id481996/index.html">Detektif Habra di akhir pekan 2. Level baru</a></li>
<li><a href="../id481998/index.html">Mesin Turing, sebagai model program otomat</a></li>
<li><a href="../id482000/index.html">Apakah Anda menyukai bisnis Anda?</a></li>
<li><a href="../id482004/index.html">Kami menguji 1C di server VPS</a></li>
<li><a href="../id482008/index.html">Konstruktor LEGO dan nol absolut</a></li>
<li><a href="../id482010/index.html">"Epik Baru". Untuk dev, ops dan orang yang ingin tahu</a></li>
<li><a href="../id482012/index.html">Raspberry Pi dan iperf - penguji bandwidth untuk perangkat Smart Home dan IoT</a></li>
<li><a href="../id482014/index.html">Terima dan dekode TV analog menggunakan SDR dan Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>