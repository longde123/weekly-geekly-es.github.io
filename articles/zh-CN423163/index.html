<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸœ ğŸ§ğŸ» ğŸ‘¨ğŸ¾â€ğŸ¤â€ğŸ‘¨ğŸ¼ å°†CryptoProè¿æ¥åˆ°Mono ğŸ‘¨â€â¤ï¸â€ğŸ’‹â€ğŸ‘¨ ğŸ‘©ğŸ½â€ğŸ³ ğŸ²</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¸å‘Linuxçš„è¿‡æ¸¡æœ‰å…³ï¼Œæœ‰å¿…è¦å°†æˆ‘ä»¬ç”¨Cï¼ƒç¼–å†™çš„æœåŠ¡å™¨ç³»ç»Ÿä¹‹ä¸€ç§»æ¤åˆ°Monoã€‚ è¯¥ç³»ç»Ÿå¯ä½¿ç”¨å¢å¼ºçš„æ•°å­—ç­¾åï¼Œå› æ­¤æˆ‘ä»¬é¢ä¸´çš„ä»»åŠ¡ä¹‹ä¸€å°±æ˜¯ä»¥å•å£°é“æ–¹å¼æµ‹è¯•CryptoProçš„GOSTè¯ä¹¦çš„æ€§èƒ½ã€‚ CryptoProæœ¬èº«å·²ç»åœ¨Linuxä¸Šå®ç°äº†CSP ï¼Œä½†æ˜¯ä½¿ç”¨å®ƒçš„ç¬¬ä¸€æ¬¡å°è¯•è¡¨æ˜ï¼Œæœ¬æœºMonoå¯†ç å­¦ç±»ï¼ˆ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å°†CryptoProè¿æ¥åˆ°Mono</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423163/"><p> ä¸å‘Linuxçš„è¿‡æ¸¡æœ‰å…³ï¼Œæœ‰å¿…è¦å°†æˆ‘ä»¬ç”¨Cï¼ƒç¼–å†™çš„æœåŠ¡å™¨ç³»ç»Ÿä¹‹ä¸€ç§»æ¤åˆ°Monoã€‚ è¯¥ç³»ç»Ÿå¯ä½¿ç”¨å¢å¼ºçš„æ•°å­—ç­¾åï¼Œå› æ­¤æˆ‘ä»¬é¢ä¸´çš„ä»»åŠ¡ä¹‹ä¸€å°±æ˜¯ä»¥å•å£°é“æ–¹å¼æµ‹è¯•CryptoProçš„GOSTè¯ä¹¦çš„æ€§èƒ½ã€‚  CryptoProæœ¬èº«å·²ç»åœ¨Linuxä¸Šå®ç°äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CSP</a> ï¼Œä½†æ˜¯ä½¿ç”¨å®ƒçš„ç¬¬ä¸€æ¬¡å°è¯•è¡¨æ˜ï¼Œæœ¬æœºMonoå¯†ç å­¦ç±»ï¼ˆç±»ä¼¼äºåŸºæœ¬çš„.Net-X509Storeï¼ŒX509Certificate2ç­‰ï¼‰ä¸ä»…ä¸èƒ½ç”¨äºæ¥å®¾å¯†é’¥ï¼Œå®ƒä»¬ç”šè‡³ä¸è¦åœ¨ä»–ä»¬çš„ä¿é™©åº“ä¸­çœ‹åˆ°ä»–ä»¬ã€‚ å› æ­¤ï¼Œå¿…é¡»é€šè¿‡CryptoProåº“ç›´æ¥è¿æ¥åŠ å¯†æŠ€æœ¯ã€‚ </p><br><a name="habracut"></a><br><h2> è¯ä¹¦å®‰è£… </h2><br><p> åœ¨å®æ–½ä»£ç ä¹‹å‰ï¼Œå¿…é¡»å®‰è£…è¯ä¹¦å¹¶ç¡®ä¿å®ƒå¯ä»¥æ­£å¸¸å·¥ä½œã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">è¯ä¹¦å®‰è£…</b> <div class="spoiler_text"><p>  CryptoPro CSPç»„ä»¶ç‰ˆæœ¬3.9å®‰è£…åœ¨Centos 7çš„/ opt / cprocspæ–‡ä»¶å¤¹ä¸­ã€‚ ä¸ºäº†é¿å…å…·æœ‰ç›¸åŒåç§°çš„monoå’ŒCryptoProå®ç”¨ç¨‹åºï¼ˆä¾‹å¦‚certmgrï¼‰ä¹‹é—´å‘ç”Ÿå†²çªï¼Œæœªå°†æ–‡ä»¶å¤¹çš„è·¯å¾„è¾“å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼Œå¹¶ä¸”åœ¨å®Œæ•´è·¯å¾„ä¸­è°ƒç”¨äº†æ‰€æœ‰å®ç”¨ç¨‹åºã€‚ </p><br><p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªè¯»è€…åˆ—è¡¨ï¼š <br> <code>/opt/cprocsp/bin/amd64/csptest -enum -info -type PP_ENUMREADERS | iconv -f cp1251</code> </p> <br><p> å¦‚æœåˆ—è¡¨ä¸­ç£ç›˜ä¸Šçš„æ–‡ä»¶å¤¹ï¼ˆHDIMAGEï¼‰ä¸­æ²¡æœ‰è¯»å–å™¨ï¼Œåˆ™å°†å…¶æ”¾ç½®ï¼š <br> <code>/opt/cprocsp/sbin/amd64/cpconfig -hardware reader -add HDIMAGE store</code> </p> <br><p> ç„¶åï¼Œæ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨é”®åˆ›å»ºæ–°çš„å®¹å™¨æ¥åˆ›å»ºæ ¼å¼ä¸º'\\ã€‚\ HDIMAGE \ {container name}'çš„å®¹å™¨ï¼š <br> <code>/opt/cprocsp/bin/amd64/csptest -keyset -provtype 75 -newkeyset -cont '\\.\HDIMAGE\test'</code> </p> <br><p> æˆ–é€šè¿‡åˆ›å»º/ var / opt / cprocsp / keys / root / {å®¹å™¨åç§°} .000æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­åŒ…å«æ ‡å‡†çš„CryptoProå®¹å™¨æ–‡ä»¶é›†ï¼ˆ* .keyï¼Œ* .maskç­‰ï¼‰ã€‚ </p><br><p> ä¹‹åï¼Œå¯ä»¥å°†æ¥è‡ªå®¹å™¨çš„è¯ä¹¦å®‰è£…åœ¨è¯ä¹¦å­˜å‚¨ä¸­ï¼š <br> <code>/opt/cprocsp/bin/amd64/certmgr -inst mMy -cont '\\.\HDIMAGE\{ }'</code> </p> <br><p> å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å·²å®‰è£…çš„è¯ä¹¦ï¼š <br> <code>/opt/cprocsp/bin/amd64/certmgr -list mMy</code> </p> <br><p> è¯ä¹¦çš„æ“ä½œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼éªŒè¯ï¼š <br> <code>/opt/cprocsp/bin/amd64/cryptcp â€“ sign -norev -thumbprint {} {} { }</code> <br> <code>/opt/cprocsp/bin/amd64/cryptcp â€“ verify -norev { }</code> </p> <br><p> å¦‚æœè¯ä¹¦ä¸€åˆ‡æ­£å¸¸ï¼Œåˆ™å¯ä»¥ç»§ç»­æ‰§è¡Œä»£ç ä¸­çš„è¿æ¥ã€‚ </p><br></div></div><br><h2> ä»£ç è¿æ¥ </h2><br><p> å°½ç®¡æœ‰ç§»æ¤åˆ°Linuxçš„è¿‡ç¨‹ï¼Œè¯¥ç³»ç»Ÿä»åº”åœ¨Windowsç¯å¢ƒä¸­ç»§ç»­è¿è¡Œï¼Œå› æ­¤ä»è¡¨é¢ä¸Šçœ‹ï¼Œå¿…é¡»é€šè¿‡â€œ byte [] SignDataï¼ˆbyte [] _arDataï¼ŒX509Certificate2 _pCertï¼‰â€å½¢å¼çš„é€šç”¨æ–¹æ³•æ¥è¿›è¡ŒåŠ å¯†å·¥ä½œï¼Œè¯¥æ–¹æ³•åº”ä¸åœ¨Linuxå’ŒWindowsä¸Šã€‚ </p><br><p> äº‹å®è¯æ˜ï¼Œå¯¹å¯†ç åº“æ–¹æ³•çš„åˆ†ææ˜¯æˆåŠŸçš„ï¼Œå› ä¸ºCryptoProå®ç°äº†â€œ libcapi20.soâ€åº“ï¼Œè¯¥åº“å®Œå…¨æ¨¡ä»¿äº†æ ‡å‡†çš„åŠ å¯†åº“Windows-â€œ crypt32.dllâ€å’Œâ€œ advapi32.dllâ€ã€‚ å½“ç„¶ï¼Œä¹Ÿè®¸ä¸æ˜¯å…¨éƒ¨ï¼Œä½†é‚£é‡Œæä¾›äº†æ‰€æœ‰ä½¿ç”¨å¯†ç çš„å¿…è¦æ–¹æ³•ï¼Œå‡ ä¹â€‹â€‹æ‰€æœ‰æ–¹æ³•éƒ½å¯ä»¥ä½¿ç”¨ã€‚ </p><br><p> å› æ­¤ï¼Œæˆ‘ä»¬å½¢æˆä¸¤ä¸ªé™æ€ç±»â€œ WCryptoAPIâ€å’Œâ€œ LCryptoAPIâ€ï¼Œå®ƒä»¬å„è‡ªå°†å¯¼å…¥å¿…è¦çš„æ–¹æ³•é›†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">DllImport(LIBCAPI20, SetLastError = true)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CertCloseStore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCertStore, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _iFlags</span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br><p> æ¯ç§æ–¹æ³•çš„è¿æ¥è¯­æ³•æ—¢å¯ä»¥ç‹¬ç«‹åˆ›å»ºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">pinvoke</a>ç½‘ç«™ï¼Œä¹Ÿå¯ä»¥ä».Netæºä»£ç ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CAPISafe</a>ç±»ï¼‰è¿›è¡Œå¤åˆ¶ã€‚ åœ¨åŒä¸€æ¨¡å—ä¸­ï¼Œæ‚¨å¯ä»¥ç»˜åˆ¶ä¸åŠ å¯†ç›¸å…³çš„å¸¸æ•°å’Œç»“æ„ï¼Œå½“ä½¿ç”¨å¤–éƒ¨åº“æ—¶ï¼Œå®ƒä»¬çš„å­˜åœ¨æ€»æ˜¯ä½¿ç”Ÿæ´»å˜å¾—æ›´è½»æ¾ã€‚ </p><br><p> ç„¶åï¼Œæˆ‘ä»¬å½¢æˆé™æ€ç±»â€œ UCryptoAPIâ€ï¼Œæ ¹æ®ç³»ç»Ÿçš„ä¸åŒï¼Œå®ƒå°†è°ƒç”¨ä»¥ä¸‹ä¸¤ä¸ªç±»ä¹‹ä¸€çš„æ–¹æ³•ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_iFlags"&gt; (  0)&lt;/param&gt; * &lt;param name="_hCertStore"&gt;   &lt;/param&gt; * &lt;returns&gt;   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CertCloseStore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCertStore, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _iFlags</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fIsLinux) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LCryptoAPI.CertCloseStore(_hCertStore, _iFlags); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WCryptoAPI.CertCloseStore(_hCertStore, _iFlags); } <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt;**/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fIsLinux { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iPlatform = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) Environment.OSVersion.Platform; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (iPlatform == <span class="hljs-number"><span class="hljs-number">4</span></span>) || (iPlatform == <span class="hljs-number"><span class="hljs-number">6</span></span>) || (iPlatform == <span class="hljs-number"><span class="hljs-number">128</span></span>); } }</code> </pre><br><p> å› æ­¤ï¼Œä½¿ç”¨UCryptoAPIç±»çš„æ–¹æ³•ï¼Œæ‚¨å¯ä»¥ä¸ºä¸¤ä¸ªç³»ç»Ÿå®ç°å‡ ä¹ç»Ÿä¸€çš„ä»£ç ã€‚ </p><br><h3> è¯ä¹¦æœå¯» </h3><br><p> åŠ å¯†å·¥ä½œé€šå¸¸ä»è¯ä¹¦æœç´¢å¼€å§‹ï¼Œä¸ºæ­¤ï¼Œåœ¨crypt32.dllä¸­æœ‰ä¸¤ä¸ªCertOpenStoreæ–¹æ³•ï¼ˆæ‰“å¼€æŒ‡å®šçš„è¯ä¹¦å­˜å‚¨ï¼‰å’Œä¸€ä¸ªç®€å•çš„CertOpenSystemStoreï¼ˆæ‰“å¼€ç”¨æˆ·çš„ä¸ªäººè¯ä¹¦ï¼‰ã€‚ ç”±äºä½¿ç”¨è¯ä¹¦ä¸ä»…é™äºä¸ªäººç”¨æˆ·è¯ä¹¦ï¼Œå› æ­¤æˆ‘ä»¬è¿æ¥äº†ç¬¬ä¸€ä¸ªè¯ä¹¦ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">è¯ä¹¦æœå¯»</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  (   )&lt;/summary&gt; * &lt;param name="_pFindType"&gt; &lt;/param&gt; * &lt;param name="_pFindValue"&gt; &lt;/param&gt; * &lt;param name="_pLocation"&gt; &lt;/param&gt; * &lt;param name="_pName"&gt; &lt;/param&gt; * &lt;param name="_pCert"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_fVerify"&gt; &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindCertificateCP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _pFindValue, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError, StoreLocation _pLocation = StoreLocation.CurrentUser, StoreName _pName = StoreName.My, X509FindType _pFindType = X509FindType.FindByThumbprint, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _fVerify = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span></span><span class="hljs-function">)</span></span> { _pCert = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; IntPtr hCert = IntPtr.Zero; GCHandle hInternal = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GCHandle(); GCHandle hFull = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GCHandle(); IntPtr hSysStore = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   hSysStore = UCryptoAPI.CertOpenStore(UCConsts.AR_CERT_STORE_PROV_SYSTEM[fIsLinux.ToByte()], UCConsts.PKCS_7_OR_X509_ASN_ENCODING, IntPtr.Zero, UCUtils.MapX509StoreFlags(_pLocation, OpenFlags.ReadOnly), UCConsts.AR_CRYPTO_STORE_NAME[(int)_pName]); if (hSysStore == IntPtr.Zero) { _sError = UCConsts.S_ERR_STORE_OPEN.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } // 1)     if ((_pFindType == X509FindType.FindByThumbprint) || (_pFindType == X509FindType.FindBySerialNumber)) { byte[] arData = _pFindValue.FromHex(); CRYPTOAPI_BLOB cryptBlob; cryptBlob.cbData = arData.Length; hInternal = GCHandle.Alloc(arData, GCHandleType.Pinned); cryptBlob.pbData = hInternal.AddrOfPinnedObject(); hFull = GCHandle.Alloc(cryptBlob, GCHandleType.Pinned); } else { byte[] arData; if(fIsLinux) arData = Encoding.UTF8.GetBytes(_pFindValue); else arData = Encoding.Unicode.GetBytes(_pFindValue); hFull = GCHandle.Alloc(arData, GCHandleType.Pinned); } // 2)  IntPtr hPrev = IntPtr.Zero; do { hCert = UCryptoAPI.CertFindCertificateInStore(hSysStore, UCConsts.PKCS_7_OR_X509_ASN_ENCODING, 0, UCConsts.AR_CRYPT_FIND_TYPE[(int)_pFindType, fIsLinux.ToByte()], hFull.AddrOfPinnedObject(), hPrev); // 2.1)   if(hPrev != IntPtr.Zero) UCryptoAPI.CertFreeCertificateContext(hPrev); // 2.2)    if(hCert == IntPtr.Zero) return UConsts.E_NO_CERTIFICATE; // 2.3)    X509Certificate2 pCert = new ISDP_X509Cert(hCert); if (!_fVerify || pCert.ISDPVerify()) { hCert = IntPtr.Zero; _pCert = pCert; return UConsts.S_OK; } hPrev = hCert; //    hCert = IntPtr.Zero; } while(hCert != IntPtr.Zero); return UConsts.E_NO_CERTIFICATE; } catch (Exception E) { _sError = UCConsts.S_FIND_CERT_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { //      if(hInternal.IsAllocated) hInternal.Free(); if(hFull.IsAllocated) hFull.Free(); if (hCert != IntPtr.Zero) UCryptoAPI.CertFreeCertificateContext(hCert); UCryptoAPI.CertCloseStore(hSysStore, 0); } }</span></span></code> </pre><br></div></div><br> æœç´¢åˆ†å‡ ä¸ªé˜¶æ®µè¿›è¡Œï¼š <br><ol><li> å‚¨å­˜å¼€å£ï¼› </li><li> æˆ‘ä»¬æ­£åœ¨å¯»æ‰¾çš„æ•°æ®ç»“æ„çš„å½¢æˆï¼› </li><li> è¯ä¹¦æœç´¢ï¼› </li><li> å¦‚æœéœ€è¦ï¼Œåˆ™è¿›è¡Œè¯ä¹¦éªŒè¯ï¼ˆåœ¨å•ç‹¬çš„éƒ¨åˆ†ä¸­è¿›è¡Œè¯´æ˜ï¼‰ï¼› </li><li> å…³é—­å­˜å‚¨åº“å¹¶ä»ç¬¬2ç‚¹å¼€å§‹é‡Šæ”¾ç»“æ„ï¼ˆç”±äºåˆ°å¤„éƒ½æœ‰éæ‰˜ç®¡.Netå†…å­˜çš„å·¥ä½œï¼Œæˆ‘ä»¬å°†æ— æ³•å¯¹å…¶è¿›è¡Œæ¸…ç†ï¼‰ï¼› </li></ol><br><p> æœç´¢è¯ä¹¦æ—¶æœ‰ä¸€äº›ç»†å¾®ä¹‹å¤„ã€‚ </p><br><p>  Linuxä¸Šçš„CryptoProä½¿ç”¨ANSIå­—ç¬¦ä¸²ï¼Œè€ŒWindowsä¸Šçš„CryptoProä½¿ç”¨UTF8ï¼Œå› æ­¤ï¼š </p><br><ol><li> å½“è¿æ¥Linuxä¸­æ‰“å¼€å­˜å‚¨çš„æ–¹æ³•æ—¶ï¼Œæœ‰å¿…è¦ä¸ºå­˜å‚¨ä»£ç å‚æ•°æ˜ç¡®æŒ‡ç¤ºå°é€å¤„ç†çš„ç±»å‹[Inï¼ŒMarshalAsï¼ˆUnmanagedType.LPStrï¼‰]ï¼› </li><li> ä¼ é€’æœç´¢å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ï¼Œä¸»é¢˜åç§°ï¼‰æ—¶ï¼Œå¿…é¡»å°†å…¶è½¬æ¢ä¸ºä¸€ç»„å…·æœ‰ä¸åŒç¼–ç çš„å­—èŠ‚ï¼› </li><li> å¯¹äºWindowsä¸­æ‰€æœ‰å› å­—ç¬¦ä¸²ç±»å‹è€Œå¼‚çš„åŠ å¯†å¸¸é‡ï¼ˆä¾‹å¦‚CERT_FIND_SUBJECT_STR_Aå’ŒCERT_FIND_SUBJECT_STR_Wï¼‰ï¼Œå¿…é¡»é€‰æ‹©* _Wï¼Œåœ¨Linuxä¸­é€‰æ‹©* _Aï¼› </li></ol><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">MapX509StoreFlags</a>æ–¹æ³•å¯ä»¥ç›´æ¥ä»Microsoftæ¥æºè·å–è€Œæ— éœ€æ›´æ”¹ï¼Œå®ƒåªæ˜¯åŸºäº.Netæ ‡å¿—å½¢æˆæœ€ç»ˆçš„æ©ç ã€‚ </p><br><p> æ‰§è¡Œæœç´¢çš„å€¼å–å†³äºæœç´¢çš„ç±»å‹ï¼ˆä¸MSDN <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸€èµ·</a>æ£€æŸ¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CertFindCertificateInStore</a> ï¼‰ï¼Œè¯¥ç¤ºä¾‹æ˜¾ç¤ºä¸¤ä¸ªæœ€å¸¸ç”¨çš„é€‰é¡¹-å­—ç¬¦ä¸²æ ¼å¼ï¼ˆåç§°Subjectï¼ŒIssuerç­‰ï¼‰å’ŒäºŒè¿›åˆ¶æ ¼å¼ï¼ˆæŒ‡çº¹ï¼Œåºåˆ—å·ï¼‰ã€‚ </p><br><p> åœ¨Windowså’ŒLinuxä¸Šä»IntPtråˆ›å»ºè¯ä¹¦çš„è¿‡ç¨‹éå¸¸ä¸åŒã€‚  Windowså°†ä»¥ä¸€ç§ç®€å•çš„æ–¹å¼åˆ›å»ºè¯ä¹¦ï¼š <br></p><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509Certificate2(hCert);</code> </pre> <p></p><br><p> åœ¨Linuxä¸Šï¼Œæ‚¨å¿…é¡»åˆ†ä¸¤æ­¥åˆ›å»ºè¯ä¹¦ï¼š <br></p><pre> <code class="cs hljs">X509Certificate2(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509Certificate(hCert));</code> </pre> <p></p><br><p> å°†æ¥ï¼Œæˆ‘ä»¬éœ€è¦è®¿é—®hCertæ‰èƒ½å·¥ä½œï¼Œå¹¶ä¸”å¿…é¡»å°†å…¶å­˜å‚¨åœ¨è¯ä¹¦å¯¹è±¡ä¸­ã€‚ åœ¨Windowsä¸Šï¼Œä»¥åå¯ä»¥ä»Handleå±æ€§ä¸­æ£€ç´¢å®ƒï¼Œä½†æ˜¯Linuxä¼šå°†hCerté“¾æ¥åé¢çš„CERT_CONTEXTç»“æ„è½¬æ¢ä¸ºx509_stï¼ˆOpenSSLï¼‰ç»“æ„çš„é“¾æ¥ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°Handleä¸­ã€‚ å› æ­¤ï¼Œå€¼å¾—ä»X509Certificate2ï¼ˆç¤ºä¾‹ä¸­ä¸ºISDP_X509Certï¼‰åˆ›å»ºç»§æ‰¿ç¨‹åºï¼Œè¯¥ç»§æ‰¿ç¨‹åºä¼šå°†hCertå­˜å‚¨åœ¨ä¸¤ä¸ªç³»ç»Ÿçš„å•ç‹¬å­—æ®µä¸­ã€‚ </p><br><p> ä¸è¦å¿˜è®°è¿™æ˜¯åˆ°éæ‰˜ç®¡å†…å­˜åŒºåŸŸçš„é“¾æ¥ï¼Œåœ¨å·¥ä½œç»“æŸåå¿…é¡»å°†å…¶é‡Šæ”¾ã€‚ å› ä¸º  .NET 4.5ä¸­çš„X509Certificate2ä¸æ˜¯ä¸€æ¬¡æ€§çš„-ä½¿ç”¨CertFreeCertificateContextæ–¹æ³•è¿›è¡Œçš„æ¸…æ´å¿…é¡»åœ¨ææ„å‡½æ•°ä¸­æ‰§è¡Œã€‚ </p><br><h3> ç­¾åå½¢æˆ </h3><br><p> ä½¿ç”¨GOSTè¯ä¹¦æ—¶ï¼Œå‡ ä¹æ€»æ˜¯ä½¿ç”¨å¸¦æœ‰ä¸€ä¸ªç­¾åè€…çš„æ–­å¼€ç­¾åã€‚ ä¸ºäº†åˆ›å»ºè¿™æ ·çš„ç­¾åï¼Œéœ€è¦ä¸€ä¸ªç›¸å½“ç®€å•çš„ä»£ç å—ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ç­¾åå½¢æˆ</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt; * &lt;param name="_arData"&gt;  &lt;/param&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_arRes"&gt; &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SignDataCP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arData, X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arRes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _arRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// 0)   CRYPT_SIGN_MESSAGE_PARA pParams = new CRYPT_SIGN_MESSAGE_PARA(); pParams.cbSize = Marshal.SizeOf(typeof(CRYPT_SIGN_MESSAGE_PARA)); pParams.dwMsgEncodingType = (int)(UCConsts.PKCS_7_OR_X509_ASN_ENCODING); pParams.pSigningCert = _pCert.getRealHandle(); pParams.cMsgCert = 1; pParams.HashAlgorithm.pszObjId = _pCert.getHashAlgirtmOid(); IntPtr pGlobData = Marshal.AllocHGlobal(_arData.Length); GCHandle pGC = GCHandle.Alloc(_pCert.getRealHandle(), GCHandleType.Pinned); try { pParams.rgpMsgCert = pGC.AddrOfPinnedObject(); Marshal.Copy(_arData, 0, pGlobData, _arData.Length); uint iLen = 50000; byte[] arRes = new byte[iLen]; // 1)   if (!UCryptoAPI.CryptSignMessage(ref pParams, true, 1, new IntPtr[1] { pGlobData }, new uint[1] { (uint)_arData.Length }, arRes, ref iLen)) { _sError = UCConsts.S_MAKE_SIGN_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } Array.Resize(ref arRes, (int)iLen); _arRes = arRes; return UConsts.S_OK;; } catch (Exception E) { _sError = UCConsts.S_MAKE_SIGN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { pGC.Free(); Marshal.FreeHGlobal(pGlobData); } }</span></span></code> </pre></div></div><br><p> åœ¨è¯¥æ–¹æ³•çš„å·¥ä½œæœŸé—´ï¼Œå°†å½¢æˆå¸¦æœ‰å‚æ•°çš„ç»“æ„ï¼Œå¹¶è°ƒç”¨ç­¾åæ–¹æ³•ã€‚ å‚æ•°ç»“æ„å¯ä»¥ä½¿æ‚¨å°†è¯ä¹¦ä¿å­˜åœ¨ç­¾åä¸­ä»¥å½¢æˆå®Œæ•´çš„é“¾ï¼ˆcMsgCertå’ŒrgpMsgCertå­—æ®µï¼Œç¬¬ä¸€ä¸ªå­˜å‚¨è¯ä¹¦çš„æ•°é‡ï¼Œç¬¬äºŒä¸ªå­˜å‚¨è¿™äº›è¯ä¹¦çš„ç»“æ„çš„é“¾æ¥åˆ—è¡¨ï¼‰ã€‚ </p><br><p> ç­¾åæ–¹æ³•å¯ä»¥æ¥æ”¶ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡æ¡£ï¼Œä»¥ä½¿ç”¨ä¸€ä¸ªç­¾ååŒæ—¶è¿›è¡Œç­¾åã€‚ é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œè¿™å¹¶ä¸è¿åè”é‚¦æ³•å¾‹63ï¼Œå¹¶ä¸”éå¸¸æ–¹ä¾¿ï¼Œå› ä¸ºç”¨æˆ·ä¸å¤ªå¯èƒ½ä¼šå¯¹éœ€è¦å¤šæ¬¡å•å‡»â€œç­¾åâ€æŒ‰é’®æ„Ÿåˆ°é«˜å…´ã€‚ </p><br><p> è¿™ç§æ–¹æ³•çš„ä¸»è¦ç¼ºç‚¹æ˜¯ï¼Œå®ƒä¸èƒ½åœ¨ä¸¤æ¬¡è°ƒç”¨æ¨¡å¼ä¸‹å·¥ä½œï¼Œè¿™å¯¹äºå¤§å¤šæ•°å¤„ç†å¤§å‹å†…å­˜å—çš„åº“æ–¹æ³•æ¥è¯´æ˜¯å…¸å‹çš„ï¼ˆç¬¬ä¸€ä¸ªä¸ºnull ï¼è¿”å›æ‰€éœ€çš„ç¼“å†²åŒºé•¿åº¦ï¼Œç¬¬äºŒä¸ªå¡«å……ç¼“å†²åŒºï¼‰ã€‚ å› æ­¤ï¼Œæœ‰å¿…è¦åˆ›å»ºä¸€ä¸ªå¤§çš„ç¼“å†²åŒºï¼Œç„¶åå°†å…¶ç¼©çŸ­åˆ°å…¶å®é™…é•¿åº¦ã€‚ </p><br><p> å”¯ä¸€ä¸¥é‡çš„é—®é¢˜æ˜¯æœç´¢ç­¾åæ—¶ä½¿ç”¨çš„å“ˆå¸Œç®—æ³•ï¼ˆæ‘˜è¦ï¼‰çš„OID-ä»¥æ˜¾å¼å½¢å¼ï¼Œå®ƒä¸åœ¨è¯ä¹¦ä¸­ï¼ˆä»…ç­¾åæœ¬èº«çš„ç®—æ³•ï¼‰ã€‚ å¦‚æœåœ¨Windowsä¸Šå¯ä»¥ç”¨ç©ºå­—ç¬¦ä¸²æŒ‡å®šå®ƒ-å®ƒä¼šè‡ªåŠ¨å¯åŠ¨ï¼Œä½†æ˜¯å¦‚æœç®—æ³•ä¸åŒï¼ŒLinuxä¼šæ‹’ç»ç­¾åã€‚ </p><br><p> ä½†æ˜¯æœ‰ä¸€ä¸ªæŠ€å·§-åœ¨æœ‰å…³ç­¾åç®—æ³•ï¼ˆç»“æ„CRYPT_OID_INFOï¼‰çš„ä¿¡æ¯ä¸­ï¼Œç­¾åOIDå­˜å‚¨åœ¨pszOIDä¸­ï¼Œè€Œå“ˆå¸Œç®—æ³•æ ‡è¯†ç¬¦å­˜å‚¨åœ¨Algidä¸­ã€‚ å°†Algidè½¬æ¢ä¸ºOIDå·²ç»æ˜¯ä¸€ä¸ªæŠ€æœ¯é—®é¢˜ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">è·å–å“ˆå¸Œç®—æ³•çš„OID</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; OID   &lt;/summary&gt; * &lt;param name="_hCertHandle"&gt; &lt;/param&gt; * &lt;param name="_sOID"&gt;  OID&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetHashAlgoritmOID</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCertHandle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sOID, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _sOID = <span class="hljs-string"><span class="hljs-string">""</span></span>; IntPtr hHashAlgInfo = IntPtr.Zero; IntPtr hData = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CERT_CONTEXT pContext = (CERT_CONTEXT)Marshal.PtrToStructure(_hCertHandle, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CERT_CONTEXT)); CERT_INFO pCertInfo = (CERT_INFO)Marshal.PtrToStructure(pContext.pCertInfo, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CERT_INFO)); <span class="hljs-comment"><span class="hljs-comment">//  AlgID //  UCryptoAPI.CertAlgIdToOID  Windows   ,   byte[] arData = BitConverter.GetBytes(UCryptoAPI.CertOIDToAlgId(pCertInfo.SignatureAlgorithm.pszObjId)); hData = Marshal.AllocHGlobal(arData.Length); Marshal.Copy(arData, 0, hData, arData.Length); //  OID hHashAlgInfo = UCryptoAPI.CryptFindOIDInfo(UCConsts.CRYPT_OID_INFO_ALGID_KEY, hData, UCConsts.CRYPT_HASH_ALG_OID_GROUP_ID); if (hHashAlgInfo == IntPtr.Zero) { _sError = UCConsts.S_NO_HASH_ALG_ERR.Frm( Marshal.GetLastWin32Error()); return UConsts.E_GEN_EXCEPTION; } CRYPT_OID_INFO pHashAlgInfo = (CRYPT_OID_INFO)Marshal.PtrToStructure(hHashAlgInfo, typeof(CRYPT_OID_INFO)); _sOID = pHashAlgInfo.pszOID; return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_DETERM_HASH_ALG_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { Marshal.FreeHGlobal(hData); } }</span></span></code> </pre></div></div><br><p> ä»”ç»†é˜…è¯»ä»£ç åï¼Œæ‚¨å¯èƒ½ä¼šæƒŠè®¶åœ°å‘ç°ä»¥ç®€å•çš„æ–¹å¼è·å¾—ç®—æ³•æ ‡è¯†ç¬¦ï¼ˆCertOIDToAlgIdï¼‰ï¼Œè€Œå…¶ä¸­çš„Oidå´å¾ˆå¤æ‚ï¼ˆCryptFindOIDInfoï¼‰ã€‚ å‡è®¾åŒæ—¶ä½¿ç”¨å¤æ‚æ–¹æ³•æˆ–åŒæ—¶ä½¿ç”¨è¿™ä¸¤ç§æ–¹æ³•æ˜¯åˆä¹é€»è¾‘çš„ï¼Œå¹¶ä¸”åœ¨Linuxä¸­ï¼Œè¿™ä¸¤ä¸ªé€‰é¡¹éƒ½å¯ä»¥æˆåŠŸå·¥ä½œã€‚ ä½†æ˜¯ï¼Œåœ¨Windowsä¸Šï¼Œè·å–æ ‡è¯†ç¬¦å’Œä»…è·å–OIDçš„å›°éš¾é€‰æ‹©æ˜¯ä¸ç¨³å®šçš„ï¼Œå› æ­¤ï¼Œè¿™ç§å¥‡æ€ªçš„æ··åˆæ–¹å¼å°†æ˜¯ä¸€ç§ç¨³å®šçš„è§£å†³æ–¹æ¡ˆã€‚ </p><br><h3> ç­¾åéªŒè¯ </h3><br><p> ç­¾åéªŒè¯åˆ†ä¸¤ä¸ªé˜¶æ®µè¿›è¡Œï¼Œé¦–å…ˆå¯¹ç­¾åæœ¬èº«è¿›è¡ŒéªŒè¯ï¼Œç„¶åå¯¹ç”Ÿæˆç­¾åçš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼ˆé“¾ï¼Œç­¾åæ—¥æœŸç­‰ï¼‰ã€‚ <br> åœ¨ç­¾åæ—¶ï¼Œè¿˜å¿…é¡»æŒ‡å®šè¦ç­¾åçš„æ•°æ®é›†ï¼Œç­¾åå‚æ•°å’Œç­¾åæœ¬èº«ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ç­¾åéªŒè¯</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;      &lt;/summary&gt; * &lt;returns&gt;&lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> CRYPT_VERIFY_MESSAGE_PARA </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetStdSignVerifyPar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { CRYPT_VERIFY_MESSAGE_PARA pVerifyParams = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CRYPT_VERIFY_MESSAGE_PARA(); pVerifyParams.cbSize = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)Marshal.SizeOf(pVerifyParams); pVerifyParams.dwMsgEncodingType = UCConsts.PKCS_7_OR_X509_ASN_ENCODING; pVerifyParams.hCryptProv = <span class="hljs-number"><span class="hljs-number">0</span></span>; pVerifyParams.pfnGetSignerCertificate = IntPtr.Zero; pVerifyParams.pvGetArg = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pVerifyParams; } <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_arData"&gt;,   &lt;/param&gt; * &lt;param name="_pSign"&gt;&lt;/param&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_fVerifyOnlySign"&gt;  &lt;/param&gt; * &lt;param name="_pRevMode"&gt;  &lt;/param&gt; * &lt;param name="_pRevFlag"&gt;  &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * &lt;remarks&gt;   &lt;/remarks&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckSignCP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arData, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _pSign, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _fVerifyOnlySign = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span><span class="hljs-function"><span class="hljs-params">, X509RevocationMode _pRevMode = X509RevocationMode.Online, X509RevocationFlag _pRevFlag = X509RevocationFlag.ExcludeRoot</span></span></span><span class="hljs-function">)</span></span>{ _pCert = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; IntPtr pHData = Marshal.AllocHGlobal(_arData.Length); GCHandle pCertContext = GCHandle.Alloc(IntPtr.Zero, GCHandleType.Pinned); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Marshal.Copy(_arData, <span class="hljs-number"><span class="hljs-number">0</span></span>, pHData, _arData.Length); CRYPT_VERIFY_MESSAGE_PARA pVerParam = UCUtils.GetStdSignVerifyPar(); <span class="hljs-comment"><span class="hljs-comment">// 0)   bool fRes = UCryptoAPI.CryptVerifyDetachedMessageSignature( ref pVerParam, //   0, //   _pSign, //  _pSign.Length, //   1, // -    new IntPtr[1] { pHData }, //   new int[1] { _arData.Length }, //    pCertContext.AddrOfPinnedObject());//    if (!fRes) { _sError = UCConsts.S_SIGN_CHECK_ERR.Frm(Marshal.GetLastWin32Error().ToString("X")); return UConsts.E_CRYPTO_ERR; } // 1)   _pCert = new ISDP_X509Cert((IntPtr)pCertContext.Target); if (_pCert == null) { _sError = UCConsts.S_SIGN_CHECK_CERT_ERR; return UConsts.E_CRYPTO_ERR; } // 2)   if (!_fVerifyOnlySign) { List&lt;DateTime&gt; pDates; // 2.1)    int iRes = GetSignDateTimeCP(_pSign, out pDates, ref _sError); // 2.2)    iRes = _pCert.ISDPVerify(ref _sError, pDates[0], _pRevMode, _pRevFlag); if (iRes != UConsts.S_OK) return iRes; } return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_SIGN_CHECK_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION;; } finally { Marshal.FreeHGlobal(pHData); if ((_pCert == null) &amp;&amp; pCertContext.IsAllocated &amp;&amp; ((IntPtr)pCertContext.Target != IntPtr.Zero)) UCryptoAPI.CertFreeCertificateContext((IntPtr)pCertContext.Target); pCertContext.Free(); } }</span></span></code> </pre></div></div><br><p> ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œä½¿ç”¨å‚æ•°å½¢æˆç»“æ„çš„è¿‡ç¨‹å·²ç§»è‡³å•ç‹¬çš„æ–¹æ³•ï¼ˆGetStdSignVerifyParï¼‰ã€‚ ä¹‹åï¼Œå°†æ£€æŸ¥ç­¾åæœ¬èº«å¹¶æå–ç¬¬ä¸€ä¸ªç­¾åè€…ï¼ˆè™½ç„¶æœ‰å¿…è¦æå–æ‰€æœ‰ç­¾åï¼Œä½†æ˜¯åŒ…å«å¤šä¸ªç­¾åè€…çš„ç­¾åä»ç„¶å¾ˆå¥‡æ€ªï¼‰ã€‚ </p><br><p> æå–ç­¾ç½²è€…çš„è¯ä¹¦åï¼Œæˆ‘ä»¬ä¼šå°†å…¶è½¬æ¢ä¸ºæˆ‘ä»¬çš„ç±»å¹¶è¿›è¡ŒéªŒè¯ï¼ˆå¦‚æœåœ¨æ–¹æ³•å‚æ•°ä¸­æŒ‡å®šï¼‰ã€‚ ä¸ºäº†è¿›è¡ŒéªŒè¯ï¼Œå°†ä½¿ç”¨ç¬¬ä¸€ä¸ªç­¾åè€…çš„ç­¾åæ—¥æœŸï¼ˆè¯·å‚é˜…æœ‰å…³ä»ç­¾åä¸­æå–ä¿¡æ¯çš„éƒ¨åˆ†ä»¥åŠæœ‰å…³æ£€æŸ¥è¯ä¹¦çš„éƒ¨åˆ†ï¼‰ã€‚ </p><br><h2> æå–ç­¾åä¿¡æ¯ </h2><br><p> å¯†ç ç³»ç»Ÿé€šå¸¸éœ€è¦ç­¾åçš„å°åˆ·è¡¨ç¤ºã€‚ åœ¨æ¯ç§æƒ…å†µä¸‹ï¼Œå®ƒéƒ½æ˜¯ä¸åŒçš„ï¼Œå› æ­¤æœ€å¥½åˆ›å»ºä¸€ç±»æœ‰å…³ç­¾åçš„ä¿¡æ¯ï¼Œå…¶ä¸­å°†ä»¥æ–¹ä¾¿ä½¿ç”¨çš„å½¢å¼åŒ…å«ä¿¡æ¯ï¼Œå¹¶åœ¨å…¶å¸®åŠ©ä¸‹æä¾›å°åˆ·çš„æ¼”ç¤ºæ–‡ç¨¿ã€‚ åœ¨.Netä¸­æœ‰ä¸€ä¸ªæ­¤ç±»-SignedCmsï¼Œä½†æ˜¯ï¼Œå®ƒçš„å¸¦æœ‰CritiPro proç­¾åçš„å•å£°é“ç±»ä¼¼ç‰©é¦–å…ˆæ— æ³•ä½¿ç”¨ï¼Œå…¶æ¬¡å®ƒåŒ…å«å¯†å°çš„ä¿®é¥°ç¬¦ï¼Œå…¶æ¬¡å‡ ä¹æ‰€æœ‰å±æ€§éƒ½è¢«å†™ä¿æŠ¤ï¼Œå› æ­¤æ‚¨å¿…é¡»åˆ›å»ºè‡ªå·±çš„ç±»ä¼¼ç‰©ã€‚ </p><br><p> ç­¾åæœ¬èº«åŒ…å«ä¸¤ä¸ªä¸»è¦å…ƒç´ -è¯ä¹¦åˆ—è¡¨å’Œç­¾åè€…åˆ—è¡¨ã€‚ è¯ä¹¦åˆ—è¡¨å¯èƒ½ä¸ºç©ºï¼Œæˆ–è€…å¯èƒ½åŒ…å«ç”¨äºéªŒè¯çš„æ‰€æœ‰è¯ä¹¦ï¼ŒåŒ…æ‹¬å®Œæ•´çš„é“¾ã€‚ ç­¾åè€…åˆ—è¡¨æŒ‡ç¤ºå®é™…ç­¾åçš„æ•°é‡ã€‚ å®ƒä»¬ä¹‹é—´çš„é€šä¿¡ç”±åºåˆ—å·å’Œå‘è¡Œè€…ï¼ˆå‘è¡Œè€…ï¼‰è¿›è¡Œã€‚ ä»ç†è®ºä¸Šè®²ï¼Œåœ¨ä¸€ä¸ªç­¾åä¸­ï¼Œå¯ä»¥æœ‰ä¸¤ä¸ªæ¥è‡ªä¸åŒå‘å¸ƒè€…çš„è¯ä¹¦ï¼Œä¸”å…·æœ‰ç›¸åŒçš„åºåˆ—å·ï¼Œä½†å®é™…ä¸Šï¼Œåªèƒ½é€šè¿‡åºåˆ—å·æ¥å¿½ç•¥å’Œæœç´¢ã€‚ </p><br><p> è¯»å–ç­¾åå¦‚ä¸‹ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">æå–ç­¾åä¿¡æ¯</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;&lt;/summary&gt; * &lt;param name="_arSign"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Decode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arSign, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { IntPtr hMsg = IntPtr.Zero; <span class="hljs-comment"><span class="hljs-comment">// 0)   try { hMsg = UCryptoAPI.CryptMsgOpenToDecode(UCConsts.PKCS_7_OR_X509_ASN_ENCODING, UCConsts.CMSG_DETACHED_FLAG, 0, IntPtr.Zero, IntPtr.Zero, IntPtr.Zero); if (hMsg == IntPtr.Zero) { _sError = UCConsts.S_CRYP_MSG_FORM_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } // 1)   if (!UCryptoAPI.CryptMsgUpdate(hMsg, _arSign, (uint)_arSign.Length, true)) { _sError = UCConsts.S_CRYP_MSG_SIGN_COPY_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } // 2)   (PKCS7 SignedData) uint iMessType = UCUtils.GetCryptMsgParam&lt;uint&gt;(hMsg, UCConsts.CMSG_TYPE_PARAM); if (UCConsts.CMSG_SIGNED != iMessType) { _sError = UCConsts.S_CRYP_MSG_SIGN_TYPE_ERR.Frm(iMessType, UCConsts.CMSG_SIGNED); return UConsts.E_CRYPTO_ERR; } // 3)    fpCertificates = UCUtils.GetSignCertificates(hMsg); // 4)   uint iSignerCount = UCUtils.GetCryptMsgParam&lt;uint&gt;(hMsg, UCConsts.CMSG_SIGNER_COUNT_PARAM); for (int i = 0; i &lt; iSignerCount; i++) { ISDPSignerInfo pInfo = new ISDPSignerInfo(); fpSignerInfos.Add(pInfo); int iRes = pInfo.Decode(hMsg, i, this, ref _sError); if (iRes != UConsts.S_OK) return iRes; } return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_SIGN_INFO_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hMsg != IntPtr.Zero) UCryptoAPI.CryptMsgClose(hMsg); } }</span></span></code> </pre></div></div><br><p> ç­¾ååˆ†ä¸ºå‡ ä¸ªé˜¶æ®µè¿›è¡Œè§£æï¼Œé¦–å…ˆæ˜¯å½¢æˆæ¶ˆæ¯ç»“æ„ï¼ˆCryptMsgOpenToDecodeï¼‰ï¼Œç„¶åå°†çœŸå®çš„ç­¾åæ•°æ®ï¼ˆCryptMsgUpdateï¼‰è¾“å…¥åˆ°å…¶ä¸­ã€‚ ä»ç„¶éœ€è¦éªŒè¯è¿™æ˜¯çœŸå®çš„ç­¾åï¼Œå¹¶é¦–å…ˆè·å–è¯ä¹¦åˆ—è¡¨ï¼Œç„¶åå†è·å–ç­¾åè€…åˆ—è¡¨ã€‚ è¯ä¹¦åˆ—è¡¨æŒ‰é¡ºåºæ£€ç´¢ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">è·å–è¯ä¹¦åˆ—è¡¨</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;     &lt;/summary&gt; * &lt;param name="_hMsg"&gt;Handle &lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> X509Certificate2Collection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetSignCertificates</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hMsg</span></span></span><span class="hljs-function">)</span></span> { X509Certificate2Collection certificates = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509Certificate2Collection(); <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iCnt = GetCryptMsgParam&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>&gt;(_hMsg, UCConsts.CMSG_CERT_COUNT_PARAM); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; iCnt; i++) { IntPtr hInfo = IntPtr.Zero; IntPtr hCert = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iLen = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!GetCryptMsgParam(_hMsg, UCConsts.CMSG_CERT_PARAM, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> hInfo, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> iLen)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; hCert = UCryptoAPI.CertCreateCertificateContext(UCConsts.PKCS_7_OR_X509_ASN_ENCODING, hInfo, iLen); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hCert != IntPtr.Zero) { certificates.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ISDP_X509Cert(hCert)); hCert = IntPtr.Zero; } } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hInfo != IntPtr.Zero) Marshal.FreeHGlobal(hInfo); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hInfo != IntPtr.Zero) Marshal.FreeHGlobal(hCert); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> certificates; }</code> </pre></div></div><br><p> é¦–å…ˆï¼Œä»CMSG_CERT_COUNT_PARAMå‚æ•°ç¡®å®šè¯ä¹¦çš„æ•°é‡ï¼Œç„¶åé¡ºåºæ£€ç´¢æœ‰å…³æ¯ä¸ªè¯ä¹¦çš„ä¿¡æ¯ã€‚ åˆ›å»ºè¯ä¹¦ä¸Šä¸‹æ–‡å¹¶åŸºäºè¯ä¹¦æœ¬èº«çš„è¿‡ç¨‹å®Œæˆäº†åˆ›å»ºè¿‡ç¨‹ã€‚ </p><br><p> æ£€ç´¢ç­¾åè€…æ•°æ®æ›´åŠ å›°éš¾ã€‚ å®ƒä»¬åŒ…å«è¯ä¹¦æŒ‡ç¤ºå’Œç­¾åå‚æ•°åˆ—è¡¨ï¼ˆä¾‹å¦‚ï¼Œç­¾åæ—¥æœŸï¼‰ã€‚ æ•°æ®æå–è¿‡ç¨‹å¦‚ä¸‹ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">æ£€ç´¢ç­¾åè€…ä¿¡æ¯</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;   &lt;/summary&gt; * &lt;param name="_hMsg"&gt;Handler &lt;/param&gt; * &lt;param name="_iIndex"&gt; &lt;/param&gt; * &lt;param name="_pSignedCms"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Decode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hMsg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _iIndex, ISDPSignedCms _pSignedCms, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1)   uint iLen = 0; // 2)  IntPtr hInfo = IntPtr.Zero; try { if (!UCryptoAPI.CryptMsgGetParam(_hMsg, UCConsts.CMSG_SIGNER_INFO_PARAM, (uint)_iIndex, IntPtr.Zero, ref iLen)) { _sError = UCConsts.S_ERR_SIGNER_INFO_LEN.Frm(_iIndex, Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } hInfo = Marshal.AllocHGlobal((int)iLen); if (!UCryptoAPI.CryptMsgGetParam(_hMsg, UCConsts.CMSG_SIGNER_INFO_PARAM, (uint)_iIndex, hInfo, ref iLen)) { _sError = UCConsts.S_ERR_SIGNER_INFO.Frm(_iIndex, Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } CMSG_SIGNER_INFO pSignerInfo = (CMSG_SIGNER_INFO) Marshal.PtrToStructure(hInfo, typeof(CMSG_SIGNER_INFO)); // 2.1)   byte[] arSerial = new byte[pSignerInfo.SerialNumber.cbData]; Marshal.Copy(pSignerInfo.SerialNumber.pbData, arSerial, 0, arSerial.Length); X509Certificate2Collection pLocCerts = _pSignedCms.pCertificates.Find(X509FindType.FindBySerialNumber, arSerial.Reverse().ToArray().ToHex(), false); if (pLocCerts.Count != 1) { _sError = UCConsts.S_ERR_SIGNER_INFO_CERT.Frm(_iIndex); return UConsts.E_NO_CERTIFICATE; } fpCertificate = pLocCerts[0]; fpSignedAttributes = UCUtils.ReadCryptoAttrsCollection(pSignerInfo.AuthAttrs); return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_ERR_SIGNER_INFO_READ.Frm(_iIndex, E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hInfo != IntPtr.Zero) Marshal.FreeHGlobal(hInfo); } }</span></span></code> </pre></div></div><br><p>        ,       CMSG_SIGNER_INFO.                 .  ,       . </p><br><p>       ,     â€”   (        ,     ). </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;   &lt;/summary&gt; * &lt;param name="_pAttrs"&gt; &lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> CryptographicAttributeObjectCollection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadCryptoAttrsCollection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CRYPT_ATTRIBUTES _pAttrs</span></span></span><span class="hljs-function">)</span></span> { CryptographicAttributeObjectCollection pRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptographicAttributeObjectCollection(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; _pAttrs.cAttr; i++) { IntPtr hAttr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntPtr((<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)_pAttrs.rgAttr + (i * Marshal.SizeOf(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CRYPT_ATTRIBUTE)))); CRYPT_ATTRIBUTE pAttr = (CRYPT_ATTRIBUTE) Marshal.PtrToStructure(hAttr, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CRYPT_ATTRIBUTE)); CryptographicAttributeObject pAttrInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptographicAttributeObject(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Oid(pAttr.pszObjId), GetAsnEncodedDataCollection(pAttr)); pRes.Add(pAttrInfo); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pRes; }</code> </pre></div></div><br><p>        Oid â€“   (     ASN.1).       : </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;      &lt;/summary&gt; * &lt;param name="_sName"&gt;&lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Pkcs9AttributeObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pkcs9AttributeFromOID</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (_sName) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> UCConsts.S_SIGN_DATE_OID : <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pkcs9SigningTime(); <span class="hljs-comment"><span class="hljs-comment">// case UConsts.S_CONTENT_TYPE_OID : return new Pkcs9ContentType(); -&gt;&gt;  Mono  // case UConsts.S_MESS_DIGEST_OID : return new Pkcs9MessageDigest(); default: return new Pkcs9AttributeObject(); } } /**&lt;summary&gt;  ASN&lt;/summary&gt; * &lt;param name="_pAttr"&gt;&lt;/param&gt; * &lt;returns&gt;&lt;/returns&gt; * **/ internal static AsnEncodedDataCollection GetAsnEncodedDataCollection (CRYPT_ATTRIBUTE _pAttr) { AsnEncodedDataCollection pRes = new AsnEncodedDataCollection(); Oid pOid = new Oid(_pAttr.pszObjId); string sOid = pOid.Value; for (uint i = 0; i &lt; _pAttr.cValue; i++) { checked { IntPtr pAttributeBlob = new IntPtr((long)_pAttr.rgValue + (i * Marshal.SizeOf(typeof(CRYPTOAPI_BLOB)))); Pkcs9AttributeObject attribute = new Pkcs9AttributeObject(pOid, BlobToByteArray(pAttributeBlob)); Pkcs9AttributeObject customAttribute = Pkcs9AttributeFromOID(sOid); if (customAttribute != null) { customAttribute.CopyFrom(attribute); attribute = customAttribute; } pRes.Add(attribute); } } return pRes; }</span></span></code> </pre></div></div><br><p>         Pkcs9AttributeObject.   ,      mono          .       Mono       . </p><br><p>        â€”        â€”   SignedCms,        . </p><br><h3>  </h3><br><p>       ,   ,         .                 (,      ,       ). </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_arInput"&gt;  &lt;/param&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;param name="_arRes"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;   ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EncryptDataCP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arInput, X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arRes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _arRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   CRYPT_ENCRYPT_MESSAGE_PARA pParams = new CRYPT_ENCRYPT_MESSAGE_PARA(); pParams.dwMsgEncodingType = UCConsts.PKCS_7_OR_X509_ASN_ENCODING; pParams.ContentEncryptionAlgorithm.pszObjId = _pCert.getEncodeAlgirtmOid(); pParams.cbSize = Marshal.SizeOf(pParams); // 1)   int iLen = 0; if (!UCryptoAPI.CryptEncryptMessage(ref pParams, 1, new IntPtr[] { _pCert.getRealHandle() }, _arInput, _arInput.Length, null, ref iLen)) { _sError = UCConsts.S_CRYPT_ENCODE_LEN_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } // 2)     _arRes = new byte[iLen]; if (!UCryptoAPI.CryptEncryptMessage(ref pParams, 1, new IntPtr[] {_pCert.getRealHandle() }, _arInput, _arInput.Length, _arRes, ref iLen)) { _sError = UCConsts.S_CRYPT_ENCODE_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_CRYPT_ENCODE_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } }</span></span></code> </pre></div></div><br><p>       â€”  ,     .     , ,      . </p><br><p>       ,              ,    . </p><br><p>      .     ,            (    ).        : </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; OID   &lt;/summary&gt; * &lt;param name="_hCertHandle"&gt; &lt;/param&gt; * &lt;param name="_sOID"&gt;  OID&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEncodeAlgoritmOID</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCertHandle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sOID, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fNeedRelease = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; _sOID = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iKeySpec = <span class="hljs-number"><span class="hljs-number">0</span></span>; IntPtr hCrypto = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)    if (!UCryptoAPI.CryptAcquireCertificatePrivateKey(_hCertHandle, 0, IntPtr.Zero, ref hCrypto, ref iKeySpec, ref fNeedRelease)) { _sError = UCConsts.S_CRYPTO_PROV_INIT_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } uint iLen = 1000; byte[] arData = new byte[1000]; uint iFlag = 1; //  // 1)      while (UCryptoAPI.CryptGetProvParam(hCrypto, UCConsts.PP_ENUMALGS, arData, ref iLen, iFlag)){ iFlag = 2; //  PROV_ENUMALGS pInfo = ConvertBytesToStruct&lt;PROV_ENUMALGS&gt;(arData); // 2)   OID     byte[] arDataAlg = BitConverter.GetBytes(pInfo.aiAlgid); IntPtr hDataAlg = Marshal.AllocHGlobal(arDataAlg.Length); try { Marshal.Copy(arDataAlg, 0, hDataAlg, arDataAlg.Length); IntPtr hHashAlgInfo2 = UCryptoAPI.CryptFindOIDInfo(UCConsts.CRYPT_OID_INFO_ALGID_KEY, hDataAlg, UCConsts.CRYPT_ENCRYPT_ALG_OID_GROUP_ID); // 2.1)  -  if (hHashAlgInfo2 != IntPtr.Zero) { CRYPT_OID_INFO pHashAlgInfo2 = (CRYPT_OID_INFO)Marshal.PtrToStructure(hHashAlgInfo2, typeof(CRYPT_OID_INFO)); _sOID = pHashAlgInfo2.pszOID ; return UConsts.S_OK; } } finally { Marshal.FreeHGlobal(hDataAlg); } } // 3)   -  _sError = UCConsts.S_NO_ENCODE_ALG_ERR; return UConsts.E_CRYPTO_ERR; } catch (Exception E) { _sError = UCConsts.S_DETERM_ENCODE_ALG_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; }finally { if((hCrypto != IntPtr.Zero) &amp;&amp; fNeedRelease) UCryptoAPI.CryptReleaseContext(hCrypto, 0); } }</span></span></code> </pre></div></div><br><p>             .        ( , , ,   .),      .          (UCConsts.CRYPT_ENCRYPT_ALG_OID_GROUP_ID).     â€”    . </p><br><p>               (    ). </p><br><h3>  </h3><br><p>  ,   ,               .        .       â€”  ,      : </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_arInput"&gt;  &lt;/param&gt; * &lt;param name="_arRes"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;returns&gt;  ,  UCOnsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecryptDataCP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arInput, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arRes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _arRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; _pCert = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; IntPtr hSysStore = UCryptoAPI.CertOpenSystemStore(IntPtr.Zero, UCConsts.AR_CRYPTO_STORE_NAME[(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)StoreName.My]); GCHandle GC = GCHandle.Alloc(hSysStore, GCHandleType.Pinned); IntPtr hOutCertL = IntPtr.Zero; IntPtr hOutCert = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   CRYPT_DECRYPT_MESSAGE_PARA pParams = new CRYPT_DECRYPT_MESSAGE_PARA(); pParams.dwMsgAndCertEncodingType = UCConsts.PKCS_7_OR_X509_ASN_ENCODING; pParams.cCertStore = 1; pParams.rghCertStore = GC.AddrOfPinnedObject(); pParams.cbSize = Marshal.SizeOf(pParams); int iLen = 0; // 1)     if (!UCryptoAPI.CryptDecryptMessage(ref pParams, _arInput, _arInput.Length, null, ref iLen, ref hOutCertL)) { _sError = UCConsts.S_DECRYPT_LEN_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } // 2)    _arRes = new byte[iLen]; if (!UCryptoAPI.CryptDecryptMessage(ref pParams, _arInput, _arInput.Length, _arRes, ref iLen, ref hOutCert)) { _sError = UCConsts.S_DECRYPT_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } // 3)     if (hOutCert != IntPtr.Zero) _pCert = new ISDP_X509Cert(hOutCert); if(_pCert != null) hOutCert = IntPtr.Zero; //    return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_DECRYPT_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if (hOutCertL != IntPtr.Zero) UCryptoAPI.CertFreeCertificateContext(hOutCertL); if (hOutCert != IntPtr.Zero) UCryptoAPI.CertFreeCertificateContext(hOutCert); GC.Free(); UCryptoAPI.CertCloseStore(hSysStore, 0); } }</span></span></code> </pre></div></div><br><p>     ,          .         ,    ( Linux    ). </p><br><h3>   </h3><br><p>      ,         ,  ,       ,      .          ,   .       : </p><br><ol><li>   ( ,    ,  . .); </li><li>    â€”       ; </li><li>     â€”         ; <br></li><li>     ,  ,         (CRL); </li></ol><br><p>        ,       . </p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»ä»‹ç»ä¸­å·²ç»å¾ˆæ¸…æ¥šï¼Œæ£€æŸ¥è¯ä¹¦çš„æœ‰æ•ˆæ€§æ˜¯æœ€å›°éš¾çš„ä»»åŠ¡ä¹‹ä¸€ã€‚</font><font style="vertical-align: inherit;">è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå›¾ä¹¦é¦†æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥å•ç‹¬å®ç°æ¯ä¸ªé¡¹ç›®ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œä¸ºç®€åŒ–èµ·è§ï¼Œè®©æˆ‘ä»¬è½¬åˆ°</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X509Certificate2.Verifyï¼ˆï¼‰</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ–¹æ³•çš„.Netæºä»£ç </font><font style="vertical-align: inherit;">å¹¶ä»¥æ­¤ä¸ºåŸºç¡€ã€‚</font></font></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> éªŒè¯åŒ…æ‹¬ä¸¤ä¸ªé˜¶æ®µï¼š </font></font><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ä»å¤´åˆ°å°¾å½¢æˆè¯ä¹¦é“¾ï¼› </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> æ£€æŸ¥å…¶ä¸­çš„æ¯ä¸ªè¯ä¹¦ï¼ˆç”¨äºåŠé”€ï¼Œæ—¶é—´ç­‰ï¼‰ï¼› </font></font></li></ol><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­¤ç±»éªŒè¯å¿…é¡»åœ¨å½“å‰æ—¥æœŸè¿›è¡Œç­¾åå’ŒåŠ å¯†ä¹‹å‰ï¼Œä»¥åŠåœ¨ç­¾åæ—¥æœŸè¿›è¡Œç­¾åéªŒè¯æ—¶è¿›è¡Œã€‚</font><font style="vertical-align: inherit;">éªŒè¯æ–¹æ³•æœ¬èº«å¾ˆå°ï¼š</font></font></p><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯ä¹¦éªŒè¯</font></font></b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_iRevFlag"&gt; &lt;/param&gt; * &lt;param name="_iRevMode"&gt; &lt;/param&gt; * &lt;param name="_hPolicy"&gt;   &lt;/param&gt; * &lt;param name="_hCert"&gt; &lt;/param&gt; * &lt;param name="_iCTLTimeout"&gt;   &lt;/param&gt; * &lt;param name="_rOnDate"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VerifyCertificate</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCert, X509RevocationMode _iRevMode, X509RevocationFlag _iRevFlag, DateTime _rOnDate, TimeSpan _iCTLTimeout, IntPtr _hPolicy, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_hCert == IntPtr.Zero) { _sError = UCConsts.S_CRYPTO_CERT_CHECK_ERR; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UConsts.E_NO_CERTIFICATE; } CERT_CHAIN_POLICY_PARA pPolicyParam = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CERT_CHAIN_POLICY_PARA(Marshal.SizeOf(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CERT_CHAIN_POLICY_PARA))); CERT_CHAIN_POLICY_STATUS pPolicyStatus = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CERT_CHAIN_POLICY_STATUS(Marshal.SizeOf(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CERT_CHAIN_POLICY_STATUS))); <span class="hljs-comment"><span class="hljs-comment">// 1)   IntPtr hChain = IntPtr.Zero; try { int iRes = BuildChain(new IntPtr(UCConsts.HCCE_CURRENT_USER), _hCert, __iRevMode, _iRevFlag, _rOnDate, _iCTLTimeout, ref hChain, ref _sError); if (iRes != UConsts.S_OK) return iRes; // 2)   if (UCryptoAPI.CertVerifyCertificateChainPolicy(_hPolicy, hChain, ref pPolicyParam, ref pPolicyStatus)) { if (pPolicyStatus.dwError != 0) { _sError = UCConsts.S_CRYPTO_CHAIN_CHECK_ERR.Frm(pPolicyStatus.dwError); return UConsts.E_CRYPTO_ERR; } } else{ _sError = UCConsts.S_CRYPTO_CHAIN_CHECK_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_CRYPTO_CERT_VERIFY_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hChain != IntPtr.Zero) UCryptoAPI.CertFreeCertificateChain(hChain); } }</span></span></code> </pre></div></div><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é¦–å…ˆï¼Œä½¿ç”¨BuildChainæ–¹æ³•å½¢æˆä¸€ä¸ªé“¾ï¼Œç„¶åå¯¹å…¶è¿›è¡Œæ£€æŸ¥ã€‚</font><font style="vertical-align: inherit;">åœ¨é“¾å½¢æˆè¿‡ç¨‹ä¸­ï¼Œå°†å½¢æˆå‚æ•°çš„ç»“æ„ï¼ŒéªŒè¯æ—¥æœŸå’Œæ£€æŸ¥æ ‡å¿—ï¼š</font></font></p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;    &lt;/summary&gt; * &lt;param name="_hChain"&gt;  &lt;/param&gt; * &lt;param name="_iRevFlag"&gt; &lt;/param&gt; * &lt;param name="_iRevMode"&gt; &lt;/param&gt; * &lt;param name="_hChainEngine"&gt; &lt;/param&gt; * &lt;param name="_hCert"&gt; &lt;/param&gt; * &lt;param name="_rCTLTimeOut"&gt;   &lt;/param&gt; * &lt;param name="_rOnDate"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildChain</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hChainEngine, IntPtr _hCert, X509RevocationMode _iRevMode, X509RevocationFlag _iRevFlag, DateTime _rOnDate, TimeSpan _rCTLTimeOut, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IntPtr _hChain, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)    if (_hCert == IntPtr.Zero) { _sError = UCConsts.S_CRYPTO_CERT_CHAIN_ERR; return UConsts.E_NO_CERTIFICATE; } // 1)  CERT_CHAIN_PARA pChainParams = new CERT_CHAIN_PARA(); pChainParams.cbSize = (uint) Marshal.SizeOf(pChainParams); IntPtr hAppPolicy = IntPtr.Zero; IntPtr hCertPolicy = IntPtr.Zero; try { // 2)    pChainParams.dwUrlRetrievalTimeout = (uint)Math.Floor(_rCTLTimeOut.TotalMilliseconds); // 3)   FILETIME pVerifyTime = new FILETIME(_rOnDate.ToFileTime()); // 4)   uint _iFlags = MapRevocationFlags(_iRevMode, _iRevFlag); // 5)   if (!UCryptoAPI.CertGetCertificateChain(_hChainEngine, _hCert, ref pVerifyTime, IntPtr.Zero, ref pChainParams, _iFlags, IntPtr.Zero, ref _hChain)) { _sError = UCConsts.S_CRYPTO_CHAIN_BUILD_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } } catch(Exception E) { _sError = UCConsts.S_CRYPTO_CHAIN_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { Marshal.FreeHGlobal(hAppPolicy); Marshal.FreeHGlobal(hCertPolicy); } return UConsts.S_OK; }</span></span></code> </pre></div></div><br><p>          ,    Microsoft.  hCertPolicy  hAppPolicy   OID-,    ,     .   ,  ,     . </p><br><p>            (,   ). </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">MapRevocationFlags</a> â€”      .Net   â€”   uint    . </p><br><h3> ç»“è®º </h3><br><p>               : </p><br><ol><li>  10 ; </li><li>  ; </li><li>  byte[] {1, 2, 3, 4, 5}; </li><li>   ; </li><li>   ; </li><li>  byte[] {1, 2, 3, 4, 5}; </li><li>   ; </li></ol><br><p>      Windows   Linux  1-, 10-  50- ,     Linux    .   Linux     -   -  (   ,    ),   Â«Â» .       (deadlock-)   (             Â«Access ViolationÂ»). </p><br><p>           UCryptoAPI    .     fpCPSection  object        : </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> fpCPSection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_hCryptMsg"&gt;  &lt;/param&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CryptMsgClose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCryptMsg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (pCPSection) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fIsLinux) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LCryptoAPI.CryptMsgClose(_hCryptMsg); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WCryptoAPI.CryptMsgClose(_hCryptMsg); } } <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;     &lt;/summary&gt;**/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> pCPSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fpCPSection;} }</code> </pre><br><p>   ,         Linux- . </p><br><p>         mono     Issuer  Subject . , ,    mono   X500DistinguishedName    .  , mono      (     ),           (impl.issuerName  impl.subjectName).         (Reflection)      X500DistinguishedName,       CERT_CONTEXT . </p><br><h2> å‚è€ƒæ–‡çŒ® </h2><br><ol><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>  CAPILite </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> c      # </li><li>  .Net: <br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CAPIBase</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">X509Certificate2</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SignedCMS</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SignerInfo</a> </li></ol><br></li><li>  mono: <br><ol><li>  <a href="">X509Certificate2</a> </li><li>  <a href="">X509CertificateImplBtls</a> </li></ol><br></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN423163/">https://habr.com/ru/post/zh-CN423163/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN423153/index.html">Node.jsæŒ‡å—ï¼Œç¬¬2éƒ¨åˆ†ï¼šJavaScriptï¼ŒV8ï¼Œä¸€äº›å¼€å‘æŠ€å·§</a></li>
<li><a href="../zh-CN423155/index.html">éº»çœç†å·¥å­¦é™¢çš„è¯¾ç¨‹â€œè®¡ç®—æœºç³»ç»Ÿå®‰å…¨â€ã€‚ è®²åº§8ï¼šç½‘ç»œå®‰å…¨æ¨¡å‹ï¼Œç¬¬2éƒ¨åˆ†</a></li>
<li><a href="../zh-CN423157/index.html">ä½¿ç”¨react-reduxçš„connectï¼ˆï¼‰å‡½æ•°</a></li>
<li><a href="../zh-CN423159/index.html">ç¨‹åºå‘˜èŠ‚å¿«ä¹ï¼ çˆ±ä½ çš„å¼€å‘è€…</a></li>
<li><a href="../zh-CN423161/index.html">ä¼ä¸šéœ€è¦ä¸ªäººæ•°æ®</a></li>
<li><a href="../zh-CN423165/index.html">è™šå¹»å¼•æ“4ä¸­çš„åŠ¨æ€ç½‘æ ¼å›¾ç»˜åˆ¶</a></li>
<li><a href="../zh-CN423167/index.html">é©¬å…‹Â·æ‰å…‹ä¼¯æ ¼ï¼ˆMark Zuckerbergï¼‰å…³äºFacebooké—®é¢˜çš„è¯é¢˜ã€‚ ã€Šçº½çº¦å®¢ã€‹æ–‡ç« çš„ä¸»è¦å†…å®¹</a></li>
<li><a href="../zh-CN423169/index.html">ä¸€å¤©çš„å¯åŠ¨ï¼ˆ2018å¹´7æœˆè‡³8æœˆï¼‰</a></li>
<li><a href="../zh-CN423171/index.html">Discordå¦‚ä½•ä½¿ç”¨WebRTCåŒæ—¶è¿›è¡Œ250ä¸‡æ¬¡è¯­éŸ³èŠå¤©</a></li>
<li><a href="../zh-CN423173/index.html">æœ€çŸ­æ—¶é—´-æœ€å¤§ç—›è‹¦</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>