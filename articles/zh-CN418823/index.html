<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤜🏻 👩🏾‍🌾 🏔️ Python很慢。 怎么了 👱 🧀 😉</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="最近，人们可以观察到Python编程语言的日益流行。 它用于DevOps，数据分析，Web开发，安全领域和其他领域。 但这就是速度。这里没有什么可夸耀的。 该材料的作者（我们今天将其翻译发表）决定找出Python缓慢的原因并找到加速它的方法。 

  

 一般规定 
 就性能而言，Java与C或C...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Python很慢。 怎么了</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/418823/"> 最近，人们可以观察到Python编程语言的日益流行。 它用于DevOps，数据分析，Web开发，安全领域和其他领域。 但这就是速度。这里没有什么可夸耀的。 该材料的作者（我们今天将其翻译发表）决定找出Python缓慢的原因并找到加速它的方法。 <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/tv/zp/uz/tvzpuzzfhsgdyegpe8ri3pbl3mw.jpeg"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">一般规定</font> </h2><br> 就性能而言，Java与C或C ++有何关系？ 如何比较C＃和Python？ 这些问题的答案在很大程度上取决于研究人员分析的应用程序类型。 没有完美的基准，但是研究使用不同语言编写的程序的性能时，“计算机语言基准测试”可能是一个不错的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">起点</a> 。 <br><br> 我已经提到计算机语言基准游戏已有十多年了。 与其他语言（例如Java，C＃，Go，JavaScript，C ++）相比，Python是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">最慢的</a>语言之一。 这包括使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">JIT</a>编译（C＃，Java）和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AOT</a>编译（C＃，C ++）的语言，以及诸如JavaScript之类的解释语言。 <br><br> 在这里，我想指出的是，当我说“ Python”时，是指Python解释器的参考实现-CPython。 在本文中，我们将介绍其其他实现。 实际上，在这里我想找到以下问题的答案：为什么Python需要比其他语言多2到10倍的时间来解决类似的问题，以及它是否可以更快地完成。 <br><br> 以下是一些基本理论试图解释Python为何运行缓慢： <br><br><ul><li> 其原因是GIL（全局解释器锁定，全局解释器锁定）。 </li><li> 原因是Python是一种解释性而非编译语言。 </li><li> 原因是动态键入。 </li></ul><br> 我们将分析这些想法，并尝试找到对Python应用程序的性能影响最大的问题的答案。 <br><br><h2>  <font color="#3AC1EF">吉尔</font> </h2><br> 现代计算机具有多核处理器，有时会发现多处理器系统。 为了使用所有这些计算能力，操作系统使用称为线程的低级结构，而进程（例如Chrome浏览器进程）可以启动许多线程并相应地使用它们。 结果，例如，如果一个进程特别急需处理器资源，则可以在几个内核之间分配其执行，这使大多数应用程序可以更快地解决其面临的任务。 <br><br> 例如，当我撰写本文时，我的Chrome浏览器具有44个开放线程。 应该记住，用于流的系统的结构和API在基于Posix的操作系统（Mac OS，Linux）和Windows操作系统家族中有所不同。 操作系统还计划线程。 <br><br> 如果您以前从未遇到过多线程编程，那么现在您需要熟悉所谓的锁（locks）。 锁的含义是，当在多线程环境中，例如，当更改内存中的某个变量时，多个线程无法访问同一内存区域（用于读取或更改）时，它们使您可以确保系统的这种行为。 <br><br> 当CPython解释器创建变量时，它将分配内存，然后计算对这些变量的现有引用数。 这个概念称为参考计数。 如果链接数等于零，则释放相应的内存。 这就是为什么例如在循环范围内创建“临时”变量不会导致应用程序占用的内存量过度增加的原因。 <br><br> 当几个线程共享相同的变量时，最有趣的部分开始了，这里的主要问题是CPython如何精确地执行引用计数。 这是“全局解释器锁”的动作出现的地方，它仔细地控制线程的执行。 <br><br> 解释器一次只能执行一个操作，而不管程序中有多少线程。 <br><br><h3>  <font color="#3AC1EF">ILGIL如何影响Python应用程序的性能？</font> </h3><br> 如果我们有一个在同一Python解释器进程中运行的单线程应用程序，则GIL不会以任何方式影响性能。 例如，如果摆脱了GIL，我们将不会注意到性能上的任何差异。 <br><br> 如果在一个Python解释器进程的框架内，有必要使用多线程机制来实现并行数据处理，并且所使用的流将大量使用I / O子系统（例如，如果它们与网络或磁盘一起工作），那么就有可能观察到GIL如何管理线程。 这是使用两个线程，大量加载进程的情况。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f9e/379/f47/f9e379f4724ba48881f53b489ca5ed1d.png"></div><br>  <i><font color="#999999">GIL可视化（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">从此处获取</a> ）</font></i> <br><br> 如果您有一个Web应用程序（例如，基于Django框架）并且使用WSGI，则对该Web应用程序的每个请求将由一个单独的Python解释器进程处理，即，我们只有1个请求锁。 由于Python解释器启动缓慢，因此在某些WSGI实现中，存在一种所谓的“守护程序模式”，在使用该模式时， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">解释器进程将</a>保持工作状态，从而使系统能够更快地处理请求。 <br><br><h3>  <font color="#3AC1EF">other其他Python解释器的行为如何？</font> </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PyPy</a>有一个GIL，通常比CPython快3倍以上。 <br><br>  Jython中没有GIL，因为Jython中的Python线程表示为Java线程。 此类线程使用JVM的内存管理功能。 <br><br><h3>  <font color="#3AC1EF">the如何用JavaScript组织流控制？</font> </h3><br> 如果我们谈论JavaScript，那么首先应注意，所有JS引擎都使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">标记清除</a>垃圾收集算法。 如前所述，使用GIL的主要原因是CPython中使用的内存管理算法。 <br><br>  JavaScript没有GIL，但是JS是一种单线程语言，因此不需要这种机制。 除了使用并行代码执行之外，JavaScript使用基于事件循环，承诺和回调的异步编程技术。  Python具有<code>asyncio</code>模块提供的类似<code>asyncio</code> 。 <br><br><h2>  <font color="#3AC1EF">Python-解释语言</font> </h2><br> 我经常听到，Python性能差是由于它是一种解释语言。 这样的陈述是基于对CPython实际工作方式的总体简化。 如果在终端中输入<code>python myscript.py</code>类的命令，那么CPython将开始执行一系列长动作，包括读取，词法分析，解析，编译，解释和执行脚本代码。 如果您对这些细节感兴趣，请查看<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此</a>材料。 <br><br> 对我们来说，考虑此过程时，在编译阶段创建一个<code>.pyc</code>文件，并将字节码序列写入<code>__pycache__/</code>目录中的文件特别重要，该文件在Python 3和Python中都使用2。 <br><br> 这不仅适用于我们编写的脚本，还适用于导入的代码，包括第三方模块。 <br><br> 结果，在大多数情况下（除非编写只运行一次的代码），Python将执行完成的字节码。 如果将其与Java和C＃中发生的情况进行比较，结果证明Java代码被编译为“中间语言”，并且Java虚拟机读取字节码并将其JIT编译为机器代码。  “中间语言” .NET CIL（与.NET Common-Language-Runtime，CLR相同）使用JIT编译导航到机器代码。 <br><br> 结果，在Java和C＃中，都使用了一些“中间语言”，并且存在类似的机制。 如果所有这些语言都使用虚拟机和某种字节码，那么为什么Python的基准测试比Java和C＃差得多？ 首先，由于在.NET和Java中使用了JIT编译这一事实。 <br><br>  JIT编译（即时编译，即时编译或即时编译）需要一种中间语言，以允许将代码拆分为片段（帧）。  AOT编译系统（提前编译，在执行之前编译）的设计方式应确保在此代码与系统开始交互之前确保代码的完整功能。 <br><br> 就其本身而言，使用JIT并不能加快代码的执行速度，因为某些字节代码片段已开始执行，就像Python中那样。 但是，JIT允许您在执行过程中执行代码优化。 一个好的JIT优化器能够识别应用程序中负载最大的部分（该应用程序的这一部分称为“热点”）并优化相应的代码片段，用比以前使用的优化的和更有生产力的选项代替它们。 <br><br> 这意味着当某个应用程序一遍又一遍执行某些动作时，这种优化可以显着加快此类动作的执行速度。 另外，请记住Java和C＃是强类型语言，因此优化器可以对有助于提高程序性能的代码做出更多假设。 <br><br>  PyPy中有一个JIT编译器，并且如上所述，该Python解释器实现比CPython快得多。 在本文中可以找到有关比较不同的Python解释器的信息。 <br><br><h3>  <font color="#3AC1EF">▍为什么CPython不使用JIT编译器？</font> </h3><br>  JIT编译器也有缺点。 其中之一是启动时间。  CPython已经相对较慢地启动，而PyPy比CPython慢​​2-3倍。  JVM的长时间运行也是众所周知的事实。  CLR .NET通过在系统引导过程中启动来解决此问题，但应注意，CLR和运行CLR的操作系统均由同一公司开发。 <br><br> 如果您有一个运行了很长时间的Python进程，而在这样的进程中，由于包含了使用率很高的部分，因此可以对其进行优化的代码，那么您应该认真看一下具有JIT编译器的解释器。 <br><br> 但是，CPython是通用Python解释器的实现。 因此，如果您正在使用Python开发命令行应用程序，则每次启动该应用程序时都需要长时间等待JIT编译器启动，这将大大减慢工作速度。 <br><br>  CPython试图为尽可能多的Python用例提供支持。 例如，有可能将JIT编译器连接到Python，但是，实现此想法的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">项目</a>并不是很活跃。 <br><br> 结果，我们可以说，如果您正在使用Python编写一个使用JIT编译器可以提高性能的程序，请使用PyPy解释器。 <br><br><h2>  <font color="#3AC1EF">Python是一种动态类型的语言</font> </h2><br> 在静态类型语言中，声明变量时，必须指定其类型。 在这些语言中，可以注意到C，C ++，Java，C＃，Go。 <br><br> 在动态类型的语言中，数据类型的概念具有相同的含义，但是变量的类型是动态的。 <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">a</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> a = <span class="hljs-string"><span class="hljs-string">"foo"</span></span></code> </pre> <br> 在这个最简单的示例中，Python首先创建第一个变量<code>a</code> ，然后创建第二个变量，其名称相同，类型为<code>str</code> ，并释放分配给第一个变量<code>a</code>的内存。 <br><br> 用动态类型的语言编写文字似乎比使用静态类型的语言编写文字更为方便和简单，但是，这种语言并不是一时兴起的。 在开发过程中，已经考虑了计算机系统的功能。 最后，程序文本中编写的所有内容都归结为处理器指令。 这意味着程序使用的数据（例如以对象或其他类型的数据形式）也将转换为低级结构。 <br><br>  Python自动执行此类转换，程序员看不到这些过程，并且他不需要照顾此类转换。 <br><br> 在声明变量的类型时不必指定变量的类型，这不是使Python变慢的语言的功能。 语言体系结构使几乎任何事物都可以动态化。 例如，在运行时，您可以替换对象方法。 同样，在程序执行期间，可以使用应用于低级系统调用的“猴子补丁”技术。 在Python中，几乎一切皆有可能。 <br><br>  Python架构使优化变得极为困难。 <br><br> 为了说明这个想法，我将使用一个名为DTrace的工具来跟踪MacOS上的系统调用。 <br><br> 在完成的CPython发行版中没有DTrace支持机制，因此将需要使用适当的设置重新编译CPython。 这里使用版本3.6.6。 因此，我们使用以下操作序列： <br><br><pre> <code class="hljs ruby">wget <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/python</span></span><span class="hljs-regexp"><span class="hljs-regexp">/cpython/archive</span></span><span class="hljs-regexp"><span class="hljs-regexp">/v3.6.6.zip unzip v3.6.6.zip cd v3.6.6 ./configure</span></span> --with-dtrace make</code> </pre> <br> 现在，使用<code>python.exe</code> ，您可以使用DTRace来跟踪代码。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在此处</a>阅读有关将DTrace与Python结合使用的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">信息</a> 。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在这里，</a>您可以找到用于使用DTrace测量Python程序的各种性能指标的脚本。 其中包括用于调用函数的参数，程序运行时，处理器使用时间，有关系统调用的信息等等。 这是使用<code>dtrace</code>命令的方法： <br><br><pre> <code class="hljs powershell">sudo dtrace <span class="hljs-literal"><span class="hljs-literal">-s</span></span> toolkit/&lt;tracer&gt;.d <span class="hljs-literal"><span class="hljs-literal">-c</span></span> <span class="hljs-string"><span class="hljs-string">'../cpython/python.exe script.py'</span></span></code> </pre> <br> 这是<code>py_callflow</code>跟踪<code>py_callflow</code>如何显示应用程序中的函数调用。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/13e/bd4/926/13ebd492636a94b23400305293aec346.gif"></div><br>  <i><font color="#999999">使用DTrace进行跟踪</font></i> <br><br> 现在让我们回答动态类型是否影响Python性能的问题。 这是一些想法： <br><br><ul><li> 类型检查和转换是繁重的操作。 每次访问，读取或写入变量时，都会执行类型检查。 </li><li> 具有这种灵活性的语言难以优化。 其他语言比Python快得多的原因是，它们通过在灵活性和性能之间进行选择而妥协。 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Cython</a>项目将Python和静态类型结合在一起，例如，如<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">本文中</a>所示，与常规Python相比，其性能提高了84倍。 如果需要速度，请签出此项目。 </li></ul><br><h2>  <font color="#3AC1EF">总结</font> </h2><br>  Python性能不佳的原因是其动态特性和多功能性。 它可以用作解决各种任务的工具。 为了实现相同的目标，您可以尝试寻找更高效，更优化的工具。 也许他们将能够找到，也许找不到。 <br><br> 可以使用异步代码执行，性能分析工具以及选择正确的解释器的功能来优化用Python编写的应用程序。 因此，要优化那些启动时间不重要并且其性能可能会受益于使用JIT编译器的应用程序的速度，请考虑使用PyPy。 如果您需要最大的性能并且准备好应对静态类型的限制，请查看Cython。 <br><br>  <b>亲爱的读者们！</b> 您如何解决糟糕的Python性能问题？ <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN418823/">https://habr.com/ru/post/zh-CN418823/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN418813/index.html">惊喜：哈勃的常数实际上是善变的</a></li>
<li><a href="../zh-CN418815/index.html">开发人员在培训期间犯的典型错误-以及如何避免这些错误</a></li>
<li><a href="../zh-CN418817/index.html">移动用户体验中的逐步公开：其工作方式</a></li>
<li><a href="../zh-CN418819/index.html">国际空间站上产生的超冷物质</a></li>
<li><a href="../zh-CN418821/index.html">Angular 6.1的新功能</a></li>
<li><a href="../zh-CN418825/index.html">开发网页样式的方法和工具</a></li>
<li><a href="../zh-CN418827/index.html">阿波罗11号月球探险期间发表的19,000小时谈话的录音</a></li>
<li><a href="../zh-CN418829/index.html">作为六个月以来唯一的古老代码行，MMORPG开发人员开始疯狂</a></li>
<li><a href="../zh-CN418833/index.html">Node.js和IoT：相互兼容</a></li>
<li><a href="../zh-CN418835/index.html">我们如何制作第一款俄罗斯智能手机</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>