<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìå üëú üèÆ Apollo: 9 meses - voo normal üçí üôéüèæ üò£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal, meu nome √© Semyon Levenson, trabalho como l√≠der de equipe no projeto Stream do Rambler Group e quero falar sobre a nossa experi√™ncia com ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Apollo: 9 meses - voo normal</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/rambler-co/blog/418417/"><p><img src="https://habrastorage.org/webt/ww/0p/je/ww0pjeoegdfxhlx-zfh54jbxvyw.png" alt="imagem"></p><br><p>  Ol√° pessoal, meu nome √© Semyon Levenson, trabalho como l√≠der de equipe no projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Stream</a> do Rambler Group e quero falar sobre a nossa experi√™ncia com a Apollo. </p><br><p>  Vou explicar o que √© o "Stream".  Este √© um servi√ßo automatizado para empreendedores, que permite atrair clientes da Internet para seus neg√≥cios sem se envolver em publicidade e criar rapidamente sites simples sem ser um especialista em layout. </p><a name="habracut"></a><br><p>  A captura de tela mostra uma das etapas para criar uma p√°gina de destino. </p><br><p><img src="https://habrastorage.org/webt/rf/vg/dj/rfvgdjmcvzpwydgz9qcdu8_3eay.png"></p><br><h3 id="chto-bylo-vnachale">  Qual foi o come√ßo? </h3><br><p> E no come√ßo havia MVP, muitos Twig, jQuery e prazos muito apertados.  Mas seguimos um caminho fora do padr√£o e decidimos fazer um novo design.  O redesenho n√£o est√° no sentido de "estilos corrigidos", mas decidiu revisar completamente o sistema.  E esse foi um bom palco para montarmos o frontend perfeito.  Afinal, n√≥s, a equipe de desenvolvimento, continuamos apoiando isso e implementando outras tarefas com base nisso, alcan√ßando novos objetivos estabelecidos pela equipe de produto. </p><br><p>  Nosso departamento j√° acumulou experi√™ncia suficiente no uso do React.  Como n√£o queria passar duas semanas configurando o webpack, decidi usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CRA</a> (Create React App).  Para estilos, os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Componentes com estilo</a> foram usados ‚Äã‚Äãe onde, sem digitar, eles usaram o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Flow</a> .  Eles levaram o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Redux</a> para a Administra√ß√£o do Estado, mas, como resultado, verificou-se que n√£o precisamos disso, mas mais sobre isso mais tarde. </p><br><p>  Reunimos nossa interface perfeita e percebemos que hav√≠amos esquecido algo.  Como se viu, esquecemos o back-end, ou melhor, a intera√ß√£o com ele.  Quando voc√™ pensou sobre o que podemos usar para organizar essa intera√ß√£o, a primeira coisa que veio √† mente - √© claro, √© Descanse.  N√£o, n√£o fomos descansar (sorrir), mas come√ßamos a falar sobre a API RESTful.  Em princ√≠pio, a hist√≥ria √© familiar, se estende por um longo tempo, mas tamb√©m sabemos sobre os problemas com ela.  N√≥s falaremos sobre eles. </p><br><p>  O primeiro problema √© a documenta√ß√£o.  O RESTful, √© claro, n√£o diz como organizar a documenta√ß√£o.  Aqui h√° uma op√ß√£o para usar a mesma arrog√¢ncia, mas na verdade √© a introdu√ß√£o de uma entidade adicional e a complica√ß√£o de processos. </p><br><p>  O segundo problema √© como organizar o suporte para controle de vers√£o da API. </p><br><p>  A terceira quest√£o importante √© um grande n√∫mero de consultas ou pontos de extremidade personalizados que podemos recompensar.  Suponha que precisamos solicitar postagens, para essas postagens - coment√°rios e mais autores desses coment√°rios.  No descanso cl√°ssico, temos que fazer pelo menos 3 consultas.  Sim, podemos recompensar pontos de extremidade personalizados e tudo isso pode ser reduzido a 1 solicita√ß√£o, mas isso j√° √© uma complica√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/mo/os/uv/moosuvdayfwhr7r2dqswlg9nuuk.png"><br>  <em>Obrigado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Sashko Stubailo</a> pela ilustra√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">.</a></em> </p><br><h3 id="reshenie">  Solu√ß√£o </h3><br><p>  E, neste momento, o Facebook vem em nosso aux√≠lio com o GraphQL.  O que √© o GraphQL?  Essa √© uma plataforma, mas hoje veremos uma de suas partes - essa √© a linguagem de consulta para sua API, apenas uma linguagem e bastante primitiva.  E funciona da maneira mais simples poss√≠vel - √† medida que solicitamos algum tipo de entidade, tamb√©m a obtemos. </p><br><p>  Pedido: </p><br><pre><code class="hljs objectivec">{ me { <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> isAcceptedFreeOffer balance } }</code> </pre> <br><p>  A resposta √©: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"me"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"isAcceptedFreeOffer"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"balance"</span></span>: <span class="hljs-number"><span class="hljs-number">100000</span></span> } }</code> </pre> <br><p>  Mas o GraphQL n√£o se refere apenas √† leitura, mas tamb√©m √† altera√ß√£o de dados.  Para fazer isso, h√° muta√ß√µes no GraphQL.  As muta√ß√µes s√£o dignas de nota, pois podemos declarar a resposta desejada do back-end, com uma altera√ß√£o bem-sucedida.  No entanto, existem algumas nuances.  Por exemplo, se nossa muta√ß√£o afeta dados fora dos limites do gr√°fico. </p><br><p>  Um exemplo de muta√ß√£o na qual usamos uma oferta gratuita: </p><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">mutation</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">acceptOffer</span></span> (_type: FREE) { <span class="hljs-attribute"><span class="hljs-attribute">id</span></span> isAcceptedFreeOffer } }</code> </pre> <br><p>  Em resposta, obtemos a mesma estrutura solicitada </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"acceptOffer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"isAcceptedFreeOffer"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre> <br><p>  A intera√ß√£o com o back-end do GraphQL pode ser feita usando a busca regular. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span>(<span class="hljs-string"><span class="hljs-string">'/graphql'</span></span>, { <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>: <span class="hljs-string"><span class="hljs-string">'POST'</span></span>, headers: { <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span> }, body: <span class="hljs-type"><span class="hljs-type">JSON</span></span>.stringify({ query: <span class="hljs-string"><span class="hljs-string">'{me { id balance } }'</span></span> }) });</code> </pre> <br><h3 id="kakie-zhe-plyusy-u-graphql">  Quais s√£o as vantagens do GraphQL? </h3><br><p>  A primeira vantagem muito interessante que pode ser apreciada quando voc√™ come√ßa a trabalhar com ela √© que esse idioma √© fortemente tipado e auto-documentado.  Ao projetar o esquema GraphQL no servidor, podemos descrever imediatamente tipos e atributos diretamente no c√≥digo. </p><br><p><img src="https://habrastorage.org/webt/7l/oh/ze/7lohze1ioujv7qchctics80_qd8.png"></p><br><p>  Como mencionado acima, o RESTful tem um problema de vers√£o.  O GraphQL implementou uma solu√ß√£o muito elegante para isso - descontinuada. </p><br><p><img src="https://habrastorage.org/webt/zr/la/rr/zrlarrevkaenkyjdx7yzm6wbm5a.png"></p><br><p>  Suponha que tenhamos um filme, que o expandamos e que tenhamos um diretor.  E, em algum momento, tornamos o diretor um tipo separado.  A quest√£o √©: o que fazer com o √∫ltimo campo de diretor?  Existem duas respostas para ele: ou exclu√≠mos este campo ou o marcamos como obsoleto e ele desaparece automaticamente da documenta√ß√£o. </p><br><p>  Decidimos independentemente o que precisamos. </p><br><p>  Recordamos a imagem anterior, onde tudo correu com o REST, aqui temos tudo combinado em uma solicita√ß√£o e n√£o requer nenhuma personaliza√ß√£o do desenvolvimento do back-end.  Uma vez que todos descreveram, n√≥s torcemos, torcemos, fizemos malabarismos. </p><br><p><img src="https://habrastorage.org/webt/k2/rs/rp/k2rsrp234e3xoe6gs8jmwpy1rse.png"></p><br><p>  Mas n√£o sem uma mosca na pomada.  Em princ√≠pio, n√£o existem muitas desvantagens no GraphQL no frontend, porque ele foi originalmente desenvolvido para resolver problemas de frontend.  Mas o back-end n√£o est√° indo t√£o bem ... Eles t√™m um problema como o N + 1.  Tome a consulta como um exemplo: </p><br><pre> <code class="hljs objectivec">{ landings(_page: <span class="hljs-number"><span class="hljs-number">0</span></span>, limit: <span class="hljs-number"><span class="hljs-number">20</span></span>) { nodes { <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> title } totalCount } }</code> </pre> <br><p>  Uma solicita√ß√£o simples, solicitamos 20 sites e o n√∫mero de sites que temos.  E no back-end, isso pode se transformar em 21 consultas ao banco de dados.  Este problema √© conhecido, resolvido.  Para o N√≥ JS, existe um pacote <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dataloader</a> do Facebook.  Para outros idiomas, voc√™ pode encontrar suas pr√≥prias solu√ß√µes. </p><br><p>  H√° tamb√©m o problema de aninhamento profundo.  Por exemplo, temos √°lbuns, esses √°lbuns t√™m m√∫sicas e, atrav√©s da m√∫sica, tamb√©m podemos obter √°lbuns.  Para fazer isso, fa√ßa as seguintes consultas: </p><br><pre> <code class="hljs objectivec">{ album(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">42</span></span>) { songs { title artists } } }</code> </pre> <br><pre> <code class="hljs dos">{ song(id: <span class="hljs-number"><span class="hljs-number">1337</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">title</span></span> album { <span class="hljs-built_in"><span class="hljs-built_in">title</span></span> } } }</code> </pre> <br><p>  Assim, obtemos uma consulta recursiva, que tamb√©m nos fornece uma base elementar. </p><br><pre> <code class="hljs objectivec">query evil { album(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">42</span></span>) { songs { album { songs { album {</code> </pre> <br><p>  Esse problema tamb√©m √© conhecido, a solu√ß√£o para o N√≥ JS √© o limite de profundidade do GraphQL, para outros idiomas tamb√©m existem solu√ß√µes. </p><br><p>  Assim, decidimos pelo GraphQL.  √â hora de escolher uma biblioteca que funcione com a API GraphQL.  O exemplo em algumas linhas com busca, mostrado acima, √© apenas um transporte.  Mas, gra√ßas ao esquema e √† declaratividade, tamb√©m podemos armazenar consultas em cache no in√≠cio e trabalhar com maior desempenho com o back-end do GraphQL. </p><br><p>  Portanto, temos dois jogadores principais - Relay e Apollo. </p><br><h3 id="relay">  Rel√© </h3><br><p>  Relay √© um desenvolvimento do Facebook, eles usam eles mesmos.  Como Oculus, Circle CI, Arsti e sexta-feira. </p><br><h4 id="kakie-plyusy-est-u-relay">  Quais s√£o os profissionais do Relay? </h4><br><p>  A vantagem imediata √© que o desenvolvedor √© o Facebook.  React, Flow e GraphQL s√£o desenvolvimentos do Facebook, todos os quais s√£o quebra-cabe√ßas personalizados um para o outro.  Onde estamos sem estrelas no Github, o Relay tem quase 11.000, o Apollo tem 7600 para compara√ß√£o.O que o Relay tem √© o Relay-compiler, uma ferramenta que otimiza e analisa suas consultas GraphQL no n√≠vel de compila√ß√£o do seu projeto .  Podemos assumir que isso √© apenas uglify para o GraphQL: </p><br><pre> <code class="hljs scala">#  <span class="hljs-type"><span class="hljs-type">Relay</span></span>-compiler foo { # <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">on</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooType</span></span></span><span class="hljs-class"> </span></span>{ # matches the parent <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">so</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extraneous</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">#</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foo</span></span></span><span class="hljs-class"> </span></span>{ id }</code> </pre> <br><h4 id="kakie-minusy-u-relay">  Quais s√£o os contras do Relay? </h4><br><p>  O primeiro sinal de menos * √© a falta de SSR pronto para uso.  O Github ainda tem um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">problema em</a> aberto.  Por que sob o asterisco - porque j√° existem solu√ß√µes, mas eles s√£o de terceiros e, al√©m disso, bastante amb√≠guos. </p><br><p><img src="https://habrastorage.org/webt/ee/1b/rc/ee1brchbmmgdpqka4kpf3ogo2my.png"></p><br><p>  Novamente, o rel√© √© uma especifica√ß√£o.  O fato √© que o GraphQL j√° √© uma especifica√ß√£o e Relay √© uma especifica√ß√£o sobre uma especifica√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/f6/ds/nl/f6dsnlwzog77hrwpboaru95u7_y.png"></p><br><p>  Por exemplo, a pagina√ß√£o de retransmiss√£o √© implementada de maneira diferente, os cursores aparecem aqui. </p><br><pre> <code class="hljs pgsql">{ friends(first: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">after</span></span>: "opaqueCursor") { edges { <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> node { id <span class="hljs-type"><span class="hljs-type">name</span></span> } } pageInfo { hasNextPage } } }</code> </pre> <br><p>  N√£o usamos mais as compensa√ß√µes e os limites usuais.  Para feeds no feed, esse √© um √≥timo t√≥pico, mas quando come√ßamos a fazer todos os tipos de grades, ocorre dor. </p><br><p>  O Facebook resolveu seu problema escrevendo uma biblioteca para o React.  Existem solu√ß√µes para outras bibliotecas, como vue.js, por exemplo - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vue-relay</a> .  Mas se prestarmos aten√ß√£o ao n√∫mero de estrelas e cometer s, tamb√©m aqui, nem tudo √© t√£o suave e pode ser inst√°vel.  Por exemplo, a op√ß√£o Criar aplicativo de rea√ß√£o fora da caixa CRA impede que voc√™ use o compilador de retransmiss√£o.  Mas voc√™ pode contornar essa limita√ß√£o com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">react-app-rewired</a> . </p><br><p><img src="https://habrastorage.org/webt/dj/wb/i2/djwbi2it6brz4qxdipg0wcdyhpa.png"></p><br><h2 id="apollo">  Apollo </h2><br><p>  Nosso segundo candidato √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Apollo</a> .  Desenvolvido por sua equipe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Meteor</a> .  A Apollo usa comandos conhecidos como: AirBnB, ticketmaster, Opentable, etc. </p><br><h3 id="kakie-est-plyusy-u-apollo">  Quais s√£o as vantagens do Apollo? </h3><br><p>  A primeira vantagem significativa √© que o Apollo foi desenvolvido como uma biblioteca independente de framework.  Por exemplo, se agora queremos reescrever tudo no Angular, isso n√£o ser√° um problema, a Apollo trabalha com isso.  E voc√™ pode at√© escrever tudo em Vanilla. </p><br><p>  A Apollo possui uma documenta√ß√£o interessante, existem solu√ß√µes prontas para problemas comuns. </p><br><p><img src="https://habrastorage.org/webt/tq/wu/ko/tqwukoydh-b7fem6dwusyuwklgw.png"></p><br><p>  Outra vantagem do Apollo - uma API poderosa.  Em princ√≠pio, quem trabalhou com o Redux encontrar√° abordagens comuns aqui: existe o ApolloProvider (como o Provux for Redux) e, em vez da loja para o Apollo, isso √© chamado de cliente: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { ApolloProvider } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-apollo'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { ApolloClient } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./ApolloClient'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> App = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ApolloProvider</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">client</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{ApolloClient}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ... </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ApolloProvider</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> );</code> </pre> <br><p>  No n√≠vel do componente em si, temos o graphql HOC fornecido como connect.  E n√≥s escrevemos a consulta GraphQL j√° dentro, como MapStateToProps no Redux. </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { graphql } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-apollo'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> gql <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'graphql-tag'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Landing } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./Landing'</span></span>; graphql(gql<span class="hljs-string"><span class="hljs-string">` { landing(id: 1) { id title } } `</span></span>)(Landing);</code> </pre> <br><p>  Mas quando fazemos o MapStateToProps no Redux, coletamos os dados locais.  Se n√£o houver dados locais, o pr√≥prio Apollo vai ao servidor para eles.  Suportes muito convenientes caem no pr√≥prio componente. </p><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Landing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({ data, loading, error, refetch, </span></span><span class="hljs-rest_arg"><span class="hljs-function"><span class="hljs-params"><span class="hljs-rest_arg">...other</span></span></span></span><span class="hljs-function"><span class="hljs-params"> })</span></span></span><span class="hljs-function"> </span></span>{ ... }</code> </pre> <br><p>  Isto √©: <br>  Dados; <br>  ‚Ä¢ status do download; <br>  ‚Ä¢ um erro se ocorreu; <br>  fun√ß√µes auxiliares como refetch para recarregar dados ou fetchMore para paginar.  H√° tamb√©m uma enorme vantagem para o Apollo e o Relay, que √© a interface do usu√°rio otimista.  Permite confirmar / desfazer / refazer no n√≠vel da solicita√ß√£o: </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.setNotificationStatusMutation({ variables: { ‚Ä¶ }, optimisticResponse: { ‚Ä¶ } });</code> </pre> <br><p>  Por exemplo, o usu√°rio clicou no bot√£o "curtir", e o curtir contou imediatamente.  Nesse caso, uma solicita√ß√£o do servidor ser√° enviada em segundo plano.  Se ocorrer algum erro durante o processo de envio, os dados mut√°veis ‚Äã‚Äãretornar√£o ao seu estado original por conta pr√≥pria. </p><br><p>  A renderiza√ß√£o no servidor foi implementada bem, definimos um sinalizador no cliente e tudo est√° pronto. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">new</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ApolloClient</span></span>({ <span class="hljs-attribute"><span class="hljs-attribute">ssrMode</span></span>: true, ... });</code> </pre> <br><p>  Mas aqui eu gostaria de falar sobre o estado inicial.  Quando Apollo cozinha sozinho, tudo funciona bem. </p><br><pre> <code class="hljs javascript">&lt;script&gt; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__APOLLO_STATE__ = client.extract(); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApolloClient({ <span class="hljs-attr"><span class="hljs-attr">cache</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InMemoryCache().restore(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__APOLLO_STATE__), link });</code> </pre> <br><p>  Mas n√£o temos renderiza√ß√£o no servidor, e o back-end envia uma consulta espec√≠fica do GraphQL para a vari√°vel global.  Aqui voc√™ precisa de uma pequena muleta, precisa escrever uma fun√ß√£o Transform que a resposta do GraphQL do back-end j√° se transformar√° no formato necess√°rio para o Apollo. </p><br><pre> <code class="hljs javascript">&lt;script&gt; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__APOLLO_STATE__ = transform({‚Ä¶}); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApolloClient({ <span class="hljs-attr"><span class="hljs-attr">cache</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InMemoryCache().restore(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__APOLLO_STATE__), link });</code> </pre> <br><p>  Outra vantagem do Apollo √© que ele √© bem personaliz√°vel.  Todos nos lembramos do middleware do Redux, tudo aqui √© o mesmo, apenas isso √© chamado de link. </p><br><p><img src="https://habrastorage.org/webt/va/gw/-z/vagw-zeeg2j0t7pjuawtw4tllq8.png"></p><br><p>  Gostaria de anotar separadamente dois links: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">apollo-link-state</a> , necess√°rio para armazenar o estado local na aus√™ncia de Redux, e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">apollo-link-rest</a> , se quisermos escrever consultas GraphQL na API Rest.  No entanto, com o √∫ltimo voc√™ precisa ser extremamente cuidadoso, porque  certos problemas podem surgir. </p><br><h4 id="minusy-u-apollo-tozhe-est">  Apollo tamb√©m tem contras </h4><br><p>  Vejamos um exemplo.  Ocorreu um problema de desempenho inesperado: 2.000 itens foram solicitados no front-end (era um diret√≥rio) e os problemas de desempenho foram iniciados.  Depois de visualiz√°-lo no depurador, descobriu-se que o Apollo consome muitos recursos durante a leitura, o problema est√° basicamente fechado, agora est√° tudo bem, mas houve um pecado. </p><br><p>  Al√©m disso, a refetch acabou sendo muito √≥bvia ... </p><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Landing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({ loading, refetch, </span></span><span class="hljs-rest_arg"><span class="hljs-function"><span class="hljs-params"><span class="hljs-rest_arg">...other</span></span></span></span><span class="hljs-function"><span class="hljs-params"> })</span></span></span><span class="hljs-function"> </span></span>{ ... }</code> </pre> <br><p>  Parece que, quando solicitamos novamente os dados, se a solicita√ß√£o anterior terminou com um erro, o carregamento deve se tornar verdadeiro.  Mas n√£o! </p><br><p>  Para que isso ocorra, √© necess√°rio especificar notifyOnNetworkStatusChange: true no graphql HOC ou armazenar o estado de busca localmente. </p><br><h3 id="apollo-vs-relay">  Apollo vs.  Rel√© </h3><br><p>  Assim, chegamos a essa mesa, todos pesamos, contamos e t√≠nhamos 76% atr√°s da Apollo. </p><br><p><img src="https://habrastorage.org/webt/ry/if/wx/ryifwxtkdmb4yvc2xczme5xoqkc.png"></p><br><p>  Ent√£o escolhemos a biblioteca e fomos trabalhar. </p><br><p>  Mas eu gostaria de dizer mais sobre a cadeia de ferramentas. </p><br><p>  Tudo √© muito bom aqui, existem v√°rios complementos para editores, em algum lugar melhor, em algum lugar pior.  Tamb√©m existe o apollo-codegen, que gera arquivos √∫teis, por exemplo, tipos de fluxo e basicamente extrai o esquema da API do GraphQL. </p><br><h3 id="rubrika-ochumelye-ruchki-ili-chto-my-sdelali-u-sebya">  O cabe√ßalho "M√£os loucas" ou o que fizemos em casa </h3><br><p>  A primeira coisa que encontramos foi que, basicamente, precisamos solicitar dados. </p><br><pre> <code class="hljs lisp">graphql(<span class="hljs-name"><span class="hljs-name">BalanceQuery</span></span>)(<span class="hljs-name"><span class="hljs-name">BalanceItem</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Temos condi√ß√µes comuns: carregamento, tratamento de erros.  N√≥s escrevemos nosso pr√≥prio falc√£o (asyncCard), que √© conectado atrav√©s da composi√ß√£o de graqhql e asyncCard. </p><br><pre> <code class="hljs lisp">compose( <span class="hljs-name"><span class="hljs-name">graphql</span></span>(<span class="hljs-name"><span class="hljs-name">BalanceQuery</span></span>), AsyncCard )(<span class="hljs-name"><span class="hljs-name">BalanceItem</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Eu tamb√©m gostaria de falar sobre fragmentos.  H√° um componente LandingItem e ele sabe quais dados precisam da API do GraphQL.  Definimos a propriedade do fragmento, onde especificamos os campos da entidade Landing. </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> LandingItem = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content }: Props</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStyle</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ‚Ä¶ </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStyle</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ); LandingItem.fragment = gql<span class="hljs-string"><span class="hljs-string">` fragment LandingItem on Landing { ... } `</span></span>;</code> </pre> <br><p>  Agora, no n√≠vel de uso do componente, usamos seu fragmento na solicita√ß√£o final. </p><br><pre> <code class="hljs bash">query LandingsDashboard { landings(...) { nodes { ...LandingItem } totalCount } <span class="hljs-variable"><span class="hljs-variable">${LandingItem.Fragment}</span></span> }</code> </pre> <br><p>  Digamos que uma tarefa seja executada para adicionar status a esta p√°gina de destino - n√£o √© um problema.  N√≥s adicionamos uma propriedade ao render e ao fragmento.  E est√° tudo pronto.  Princ√≠pio de responsabilidade √∫nica em toda a sua gl√≥ria. </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> LandingItem = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content }: Props</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStyle</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ‚Ä¶ </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> ‚Ä¶ /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStyle</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ); LandingItem.fragment = gql` fragment LandingItem on Landing { ... status } `;</span></span></code> </pre> <br><h4 id="kakaya-u-nas-esche-byla-problema">  Que outro problema tivemos? </h4><br><p>  Temos v√°rios widgets em nosso site que fizeram suas solicita√ß√µes individuais. </p><br><p><img src="https://habrastorage.org/webt/ab/li/-x/abli-xjzcmoq9_p2rtnorl-y3qu.png"></p><br><p>  Durante o teste, tudo ficou mais lento.  Temos verifica√ß√µes de seguran√ßa muito longas e cada solicita√ß√£o √© muito cara.  Isso tamb√©m acabou n√£o sendo problema, existe o Apollo-link-batch-http </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">new</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BatchHttpLink</span></span>({ <span class="hljs-attribute"><span class="hljs-attribute">batchMax</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, batchInterval: <span class="hljs-number"><span class="hljs-number">10</span></span> });</code> </pre> <br><p>  Est√° configurado da seguinte maneira: passamos o n√∫mero de solicita√ß√µes que podemos combinar e quanto tempo esse link aguardar√° ap√≥s a primeira solicita√ß√£o aparecer. <br>  E aconteceu assim: ao mesmo tempo, tudo carrega, e ao mesmo tempo tudo vem.  Vale ressaltar que, se durante essa mesclagem, qualquer uma das subconsultas retornar com um erro, o erro estar√° apenas com ele, e n√£o com toda a solicita√ß√£o. </p><br><h4 id="hochetsya-otdelno-rasskazat-chto-proshloy-osenyu-proizoshlo-obnovlenie-s-pervogo-apollo-na-vtoroy">  Eu gostaria de dizer separadamente que no outono passado houve uma atualiza√ß√£o do primeiro Apollo para o segundo </h4><br><p>  No come√ßo eram Apollo e Redux </p><br><pre> <code class="hljs cs"><span class="hljs-string"><span class="hljs-string">'react-apollo'</span></span> <span class="hljs-string"><span class="hljs-string">'redux'</span></span></code> </pre> <br><p>  Ent√£o a Apollo se tornou mais modular e expans√≠vel, esses m√≥dulos podem ser desenvolvidos de forma independente.  A mesma apollo-cache-inmemory. </p><br><pre> <code class="hljs cs"><span class="hljs-string"><span class="hljs-string">'react-apollo'</span></span> <span class="hljs-string"><span class="hljs-string">'apollo-client'</span></span> <span class="hljs-string"><span class="hljs-string">'apollo-link-batch-http'</span></span> <span class="hljs-string"><span class="hljs-string">'apollo-cache-inmemory'</span></span> <span class="hljs-string"><span class="hljs-string">'graphql-tag'</span></span></code> </pre> <br><p>  Vale a pena notar que o Redux n√£o √© e, como se viu, n√£o √©, em princ√≠pio, necess√°rio. </p><br><h2 id="vyvody">  Conclus√µes: </h2><br><ol><li>  O tempo de entrega dos recursos diminuiu, n√£o perdemos tempo descrevendo a√ß√µes, reduzimos no Redux e tocamos menos no back-end </li><li>  A antifragilidade apareceu porque  A an√°lise est√°tica da API permite que voc√™ anule os problemas quando o front-end espera uma coisa e o back-end retorna um problema completamente diferente. </li><li>  Se voc√™ come√ßar a trabalhar com o GraphQL - tente o Apollo, n√£o fique desapontado. </li></ol><br><p>  PS: Voc√™ tamb√©m pode assistir a um v√≠deo da minha apresenta√ß√£o no Rambler Front &amp; Meet up # 4 </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/rCEoy-V3x8k" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt418417/">https://habr.com/ru/post/pt418417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt418403/index.html">Exemplo de programa√ß√£o do acelerador FPGA</a></li>
<li><a href="../pt418405/index.html">O princ√≠pio da pir√¢mide invertida na an√°lise. Criamos um painel compreens√≠vel</a></li>
<li><a href="../pt418407/index.html">A minera√ß√£o em nuvem Hashflare foi fechada. O dinheiro n√£o volta</a></li>
<li><a href="../pt418411/index.html">Atirador de rede do navegador no Node.js</a></li>
<li><a href="../pt418415/index.html">O Telegram lan√ßou seu pr√≥prio servi√ßo de passaporte para verifica√ß√£o e autoriza√ß√£o de usu√°rios</a></li>
<li><a href="../pt418419/index.html">Como a Dodo Pizza resolve problemas de neg√≥cios usando o Machine Learning</a></li>
<li><a href="../pt418423/index.html">Casa inteligente: uma nova dimens√£o de conforto e busca da excel√™ncia. Parte um</a></li>
<li><a href="../pt418427/index.html">Indexa√ß√£o para dispositivos m√≥veis. Como e por que o gr√°fico de links mudar√°?</a></li>
<li><a href="../pt418429/index.html">Minha experi√™ncia profissional para o papel do treinador √°gil na Europa, parte dois</a></li>
<li><a href="../pt418431/index.html">Problemas imagin√°rios - a raiz do software ruim</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>