<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÉüèæ üò° üêøÔ∏è C√≥mo y por qu√© escribimos un servicio escalable altamente cargado para 1C: Enterprise: Java, PostgreSQL, Hazelcast üë©üèæ ‚úäüèæ üéÖüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo, hablaremos sobre c√≥mo y por qu√© desarrollamos el Sistema de interacci√≥n , un mecanismo que transfiere informaci√≥n entre las aplicaci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo y por qu√© escribimos un servicio escalable altamente cargado para 1C: Enterprise: Java, PostgreSQL, Hazelcast</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/1c/blog/422903/">  En este art√≠culo, hablaremos sobre c√≥mo y por qu√© desarrollamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el Sistema de interacci√≥n</a> , un mecanismo que transfiere informaci√≥n entre las aplicaciones cliente y los servidores 1C: Enterprise, desde la configuraci√≥n de la tarea hasta la reflexi√≥n sobre la arquitectura y los detalles de implementaci√≥n. <br><br>  El Sistema de interacci√≥n (en lo sucesivo, CB) es un sistema distribuido de mensajer√≠a tolerante a fallas con entrega garantizada.  CB est√° dise√±ado como un servicio altamente cargado con alta escalabilidad, y est√° disponible como un servicio en l√≠nea (proporcionado por 1C) y como un producto de circulaci√≥n que se puede implementar en las capacidades de su servidor. <br><br>  CB utiliza el almacenamiento distribuido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hazelcast</a> y el motor de b√∫squeda <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Elasticsearch</a> .  Tambi√©n hablaremos sobre Java y c√≥mo escalamos PostgreSQL horizontalmente. <br><img src="https://habrastorage.org/webt/gh/nq/sq/ghnqsqdgkb0i4ze_7ig8blrfilk.png" alt="imagen"><br><a name="habracut"></a><br><br><h2>  Declaraci√≥n del problema. </h2><br>  Para aclarar por qu√© creamos el Sistema de interacci√≥n, le contar√© un poco sobre c√≥mo funciona el desarrollo de aplicaciones empresariales en 1C. <br><br>  Para empezar, un poco sobre nosotros para aquellos que a√∫n no saben lo que estamos haciendo :) Estamos creando la plataforma de tecnolog√≠a 1C: Enterprise.  La plataforma incluye una herramienta para desarrollar aplicaciones comerciales, as√≠ como tiempo de ejecuci√≥n, que permite que las aplicaciones comerciales funcionen en un entorno multiplataforma. <br><br><h3>  Paradigma de desarrollo cliente-servidor </h3><br>  Las aplicaciones empresariales creadas en "1C: Enterprise" funcionan en la arquitectura <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cliente-servidor de</a> tres niveles "DBMS - servidor de aplicaciones - cliente".  El c√≥digo de aplicaci√≥n escrito en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lenguaje incrustado 1C</a> se puede ejecutar en el servidor de aplicaciones o en el cliente.  Todo el trabajo con objetos de aplicaci√≥n (directorios, documentos, etc.), as√≠ como la lectura y escritura en la base de datos, se realiza solo en el servidor.  La funcionalidad de los formularios y la interfaz de comandos tambi√©n se implementa en el servidor.  El cliente recibe, abre y muestra formularios, "se comunica" con el usuario (advertencias, preguntas ...), peque√±os c√°lculos en formularios que requieren una reacci√≥n r√°pida (por ejemplo, multiplicando el precio por la cantidad), trabajando con archivos locales, trabajando con equipos. <br><br>  En el c√≥digo de la aplicaci√≥n, los encabezados de los procedimientos y funciones deben indicar expl√≠citamente d√≥nde se ejecutar√° el c√≥digo, utilizando las directivas &amp; En el Cliente / y en el Servidor (&amp; AtClient / &amp; AtServer en la versi√≥n en ingl√©s).  Los desarrolladores de 1C me corregir√°n ahora, diciendo que en realidad hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">m√°s</a> directivas, pero para nosotros esto no es esencial ahora. <br><br>  El c√≥digo del servidor se puede llamar desde el c√≥digo del cliente, pero el c√≥digo del cliente no se puede llamar desde el c√≥digo del servidor.  Esta es una limitaci√≥n fundamental que hicimos por varias razones.  En particular, porque el c√≥digo del servidor debe escribirse de manera que se ejecute por igual, sin importar d√≥nde se llame, desde el cliente o desde el servidor.  Y en caso de llamar al c√≥digo del servidor desde otro c√≥digo del servidor, el cliente est√° ausente como tal.  Y porque durante la ejecuci√≥n del c√≥digo del servidor, el cliente que lo caus√≥ podr√≠a cerrarse, salir de la aplicaci√≥n y el servidor no tendr√≠a a qui√©n llamar. <br><br><img src="https://habrastorage.org/webt/3e/pb/eh/3epbeh_fc7t4yipr5halnamtbmg.png" alt="imagen"><br>  <b>El c√≥digo que procesa el bot√≥n hace clic: la llamada de procedimiento del servidor del cliente funcionar√°, la llamada de procedimiento del cliente del servidor no funcionar√°</b> <br><br>  Esto significa que si queremos enviar alg√∫n mensaje a la aplicaci√≥n cliente desde el servidor, por ejemplo, que la formaci√≥n de un informe "de larga duraci√≥n" ha finalizado y el informe puede verse, no tenemos ese m√©todo.  Tenemos que ir a trucos, por ejemplo, desde el c√≥digo del cliente para sondear peri√≥dicamente el servidor.  Pero este enfoque carga el sistema con llamadas innecesarias y, de hecho, no se ve muy elegante. <br><br>  Y tambi√©n es necesario, por ejemplo, cuando llega una llamada telef√≥nica <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SIP</a> , notifique a la aplicaci√≥n del cliente para que, por el n√∫mero de la persona que llama, la encuentre en la base de datos de la contraparte y muestre la informaci√≥n del usuario sobre la contraparte que llama.  O, por ejemplo, al recibir el pedido en el almac√©n, notif√≠queselo a la aplicaci√≥n del cliente del cliente.  En general, hay muchos casos en los que tal mecanismo ser√≠a √∫til. <br><br><h3>  Realmente puesta en escena </h3><br>  Crea un motor de mensajer√≠a.  R√°pido, confiable, con entrega garantizada, con la capacidad de buscar mensajes de manera flexible.  Seg√∫n el mecanismo, implemente un mensajero (mensajes, videollamadas) que funcione dentro de las aplicaciones 1C. <br><br>  Dise√±ar un sistema escalable horizontalmente.  El aumento de la carga debe cerrarse aumentando el n√∫mero de nodos. <br><br><h2>  Implementaci√≥n </h2><br>  Decidimos no incrustar la parte del servidor de SV directamente en la plataforma 1C: Enterprise, sino implementarlo como un producto separado, cuya API se puede llamar desde el c√≥digo de la aplicaci√≥n 1C.  Esto se hizo por varias razones, la principal de las cuales: quer√≠a hacer posible el intercambio de mensajes entre diferentes aplicaciones 1C (por ejemplo, entre la Oficina de Comercio y Contabilidad).  Se pueden ejecutar diferentes aplicaciones de 1C en diferentes versiones de la plataforma 1C: Enterprise, estar en diferentes servidores, etc.  En tales condiciones, la implementaci√≥n de CB como un producto separado ubicado "al costado" de las instalaciones de 1C es la soluci√≥n √≥ptima. <br><br>  Entonces, decidimos hacer CB como un producto separado.  Para peque√±as empresas, recomendamos utilizar el servidor CB que instalamos en nuestra nube (wss: //1cdialog.com) para evitar los gastos generales asociados con la instalaci√≥n y configuraci√≥n del servidor localmente.  Sin embargo, los grandes clientes pueden considerar apropiado instalar su propio servidor CB en sus instalaciones.  Utilizamos un enfoque similar en nuestro producto SaaS basado en la nube <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">1cFresh</a> : se lanza como un producto de circulaci√≥n para la instalaci√≥n de los clientes y tambi√©n se implementa en nuestra nube <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://1cfresh.com/</a> . <br><br><h3>  App </h3><br>  Para el equilibrio de carga y la tolerancia a fallas, implementaremos no una aplicaci√≥n Java, sino varias, colocaremos un equilibrador de carga frente a ellas.  Si necesita transferir un mensaje de nodo a nodo, use publicar / suscribirse en Hazelcast. <br><br>  Comunicaci√≥n del cliente con el servidor - por websocket.  Es muy adecuado para sistemas en tiempo real. <br><br><h3>  Cach√© distribuida </h3><br>  Elija entre Redis, Hazelcast y Ehcache.  En el patio 2015.  Redis acaba de lanzar un nuevo cl√∫ster (demasiado nuevo, aterrador), hay un Sentinel con muchas restricciones.  Ehcache no sabe c√≥mo ensamblar en un cl√∫ster (esta funcionalidad apareci√≥ m√°s adelante).  Decidimos probar con Hazelcast 3.4. <br>  Hazelcast va al grupo fuera de la caja.  En el modo de nodo √∫nico, no es muy √∫til y solo puede caber como cach√©: no sabe c√≥mo volcar datos en el disco, perdi√≥ un solo nodo, perdi√≥ datos.  Implementamos varios Hazelcasts entre los cuales respaldamos datos cr√≠ticos.  El cach√© no es una copia de seguridad, no es una pena. <br><br>  Para nosotros, Hazelcast es: <br><br><ul><li>  Repositorio de sesiones de usuario.  Cada vez, ir a la base de datos para una sesi√≥n es mucho tiempo, por lo que colocamos todas las sesiones en Hazelcast. </li><li>  Cach√©  Buscando un perfil de usuario: verifique en el cach√©.  Escribi√≥ un nuevo mensaje, p√≥ngalo en la cach√©. </li><li>  Temas para comunicar instancias de aplicaciones.  Noda genera un evento y lo coloca en el tema Hazelcast.  Otros nodos de aplicaci√≥n suscritos a este tema reciben y procesan el evento. </li><li>  Grupo de cerraduras.  Por ejemplo, creamos una discusi√≥n sobre una clave √∫nica (discusi√≥n-singleton dentro del marco de la base de datos 1C): </li></ul><br><pre><code class="java hljs">conversationKeyChecker.check(<span class="hljs-string"><span class="hljs-string">""</span></span>); doInClusterLock(<span class="hljs-string"><span class="hljs-string">""</span></span>, () -&gt; { conversationKeyChecker.check(<span class="hljs-string"><span class="hljs-string">""</span></span>); createChannel(<span class="hljs-string"><span class="hljs-string">""</span></span>); });</code> </pre> <br>  Comprobado que no hay canal.  Tomaron la cerradura, revisaron nuevamente, crearon.  Si no verifica el bloqueo despu√©s de tomarlo, existe la posibilidad de que otro hilo en ese momento tambi√©n lo verifique y ahora intente crear la misma discusi√≥n, pero ya existe.  Es imposible hacer el bloqueo a trav√©s del bloqueo Java sincronizado o habitual.  A trav√©s de la base, lentamente, y la base es una pena, a trav√©s de Hazelcast, lo que necesita. <br><br><h3>  Elegir un DBMS </h3><br>  Tenemos una amplia y exitosa experiencia trabajando con PostgreSQL y colaborando con los desarrolladores de este DBMS. <br><br>  PostgreSQL no es f√°cil con un cl√∫ster: tiene <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">XL</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">XC</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Citus</a> , pero, en general, estos no son noSQL, que se escalan de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">f√°brica</a> .  NoSQL no fue considerado como el repositorio principal, fue suficiente que tomamos Hazelcast, con el que no hab√≠amos trabajado antes. <br><br>  Como necesita escalar una base de datos relacional, significa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fragmentaci√≥n</a> .  Como sabe, al fragmentar, dividimos la base de datos en partes separadas para que cada una de ellas se pueda mover a un servidor separado. <br><br>  La primera versi√≥n de nuestro sharding implicaba la capacidad de distribuir cada una de las tablas de nuestra aplicaci√≥n a diferentes servidores en diferentes proporciones.  Hay muchos mensajes en el servidor A, por favor, transfiramos parte de esta tabla al servidor B. Tal soluci√≥n simplemente grit√≥ acerca de la optimizaci√≥n prematura, por lo que decidimos limitarnos a un enfoque multiinquilino. <br><br>  Puede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">leer</a> sobre inquilinos m√∫ltiples, por ejemplo, en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sitio</a> web de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Citus Data</a> . <br><br>  En SV hay conceptos de aplicaci√≥n y suscriptor.  Una aplicaci√≥n es una instalaci√≥n espec√≠fica de una aplicaci√≥n comercial, como ERP o Contabilidad, con sus usuarios y datos comerciales.  Un suscriptor es una organizaci√≥n o un individuo en cuyo nombre la aplicaci√≥n est√° registrada en el servidor CB.  Un suscriptor puede registrar varias aplicaciones, y estas aplicaciones pueden intercambiar mensajes entre s√≠.  El suscriptor tambi√©n se convirti√≥ en el inquilino de nuestro sistema.  Los mensajes de varios suscriptores pueden estar en una base f√≠sica;  Si vemos que alg√∫n suscriptor comenz√≥ a generar mucho tr√°fico, lo llevamos a una base f√≠sica separada (o incluso a un servidor de base de datos separado). <br><br>  Tenemos una base de datos principal donde se almacena una tabla de enrutamiento con informaci√≥n sobre la ubicaci√≥n de todas las bases de datos de suscriptores. <br><br><img src="https://habrastorage.org/webt/yf/3k/bo/yf3kboqvabg3ljf791sdlpn0zay.png" alt="imagen"><br><br>  Para que la base de datos principal no sea un cuello de botella, mantenemos la tabla de enrutamiento (y otros datos solicitados con frecuencia) en la memoria cach√©. <br><br>  Si la base de datos de suscriptores comienza a ralentizarse, la dividiremos en particiones.  En otros proyectos, usamos pg_pathman para particionar tablas grandes. <br><br>  Como perder mensajes de usuario es malo, admitimos nuestras bases de datos con r√©plicas.  La combinaci√≥n de r√©plicas s√≠ncronas y as√≠ncronas le permite estar seguro en caso de p√©rdida de la base de datos principal.  La p√©rdida de mensajes ocurrir√° solo en caso de falla simult√°nea de la base de datos principal y su r√©plica s√≠ncrona. <br><br>  Si se pierde la r√©plica s√≠ncrona, la r√©plica as√≠ncrona se vuelve s√≠ncrona. <br>  Si se pierde la base de datos principal, la r√©plica s√≠ncrona se convierte en la base de datos principal, la r√©plica as√≠ncrona se convierte en la r√©plica s√≠ncrona. <br><br><h3>  Elasticsearch para b√∫squeda </h3><br>  Dado que, entre otras cosas, CB tambi√©n es un mensajero, aqu√≠ necesita una b√∫squeda r√°pida, conveniente y flexible, teniendo en cuenta la morfolog√≠a, por coincidencias inexactas.  Decidimos no reinventar la rueda y usar el motor de b√∫squeda gratuito Elasticsearch, basado en la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lucene</a> .  Tambi√©n implementamos Elasticsearch en un cl√∫ster (maestro - datos - datos) para eliminar problemas en caso de falla de los nodos de la aplicaci√≥n. <br><br>  En github, encontramos un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">complemento de morfolog√≠a rusa</a> para Elasticsearch y lo usamos.  En el √≠ndice Elasticsearch, almacenamos las ra√≠ces de las palabras (que define el complemento) y N-gramos.  A medida que el usuario ingresa el texto para buscar, buscamos el texto escrito entre los N-gramos.  Cuando se almacena en el √≠ndice, la palabra "textos" se dividir√° en los siguientes N-gramos: <br><br>  [esos, tecnolog√≠a, tex, texto, textos, ek, eks, ekst, eksts, ks, kst, kst, kst, st, st, usted], <br><br>  Y tambi√©n se guardar√° la ra√≠z de la palabra "texto".  Este enfoque le permite buscar al principio, en el medio y al final de la palabra. <br><br><h2>  Cuadro general </h2><br><img src="https://habrastorage.org/webt/wo/w3/ke/wow3ke8dq1cqrb_ujsjm4uhevfm.png" alt="imagen"><br>  Repitiendo la imagen desde el comienzo del art√≠culo, pero con explicaciones: <br><br><ul><li>  Balanceador de internet;  tenemos nginx, puede ser cualquiera. </li><li>  Las instancias de aplicaciones Java se comunican entre s√≠ a trav√©s de Hazelcast. </li><li>  Para trabajar con un socket web utilizamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Netty</a> . </li><li>  La aplicaci√≥n Java escrita en Java 8 consta de paquetes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">OSGi</a> .  Los planes: migraci√≥n a Java 10 y transici√≥n a m√≥dulos. </li></ul><br><h2>  Desarrollo y pruebas </h2><br>  En el proceso de desarrollo y prueba de CB, encontramos una serie de caracter√≠sticas interesantes de los productos que utilizamos. <br><br><h3>  Pruebas de carga y p√©rdidas de memoria </h3><br>  El lanzamiento de cada lanzamiento CB es una prueba de esfuerzo.  Tuvo √©xito cuando: <br><br><ul><li>  La prueba funcion√≥ durante varios d√≠as y no hubo denegaci√≥n de servicio. </li><li>  El tiempo de respuesta para las operaciones clave no excedi√≥ un umbral c√≥modo </li><li>  La degradaci√≥n del rendimiento en comparaci√≥n con la versi√≥n anterior no es m√°s del 10% </li></ul><br>  Llenamos la base de prueba con datos: para esto obtenemos informaci√≥n sobre el suscriptor m√°s activo del servidor de producci√≥n, multiplicamos sus n√∫meros por 5 (el n√∫mero de mensajes, discusiones, usuarios) y as√≠ lo probamos. <br><br>  Realizamos pruebas de carga del sistema de interacci√≥n en tres configuraciones: <br><br><ol><li>  Prueba de esfuerzo </li><li>  Solo conexiones </li><li>  Registro de suscriptor </li></ol><br>  Durante la prueba de esfuerzo, comenzamos varios cientos de hilos, y ellos cargan el sistema sin parar: escriben mensajes, crean discusiones, obtienen una lista de mensajes.  Simulamos las acciones de los usuarios comunes (obtener una lista de mis mensajes no le√≠dos, escribir a alguien) y soluciones de software (transferir un paquete de una configuraci√≥n diferente, procesar la notificaci√≥n). <br><br>  Por ejemplo, esto es parte de la prueba de esfuerzo: <br><br><ul><li>  El usuario inicia sesi√≥n. <br><ul><li>  Solicita debates no le√≠dos </li><li>  50% de posibilidades de leer mensajes </li><li>  Con 50% de probabilidad escribe mensajes </li><li>  Pr√≥ximo usuario: <br><ul><li>  Con 20% de probabilidad crea una nueva discusi√≥n. </li><li>  Selecciona aleatoriamente cualquiera de sus discusiones </li><li>  Va adentro </li><li>  Solicita mensajes, perfiles de usuario </li><li>  Crea cinco mensajes dirigidos a usuarios aleatorios de esta discusi√≥n. </li><li>  Fuera de discusi√≥n </li><li>  Se repite 20 veces </li><li>  Cierra la sesi√≥n, vuelve al comienzo del gui√≥n </li></ul><br></li><li>  El chat bot ingresa al sistema (emula el intercambio de mensajes del c√≥digo de soluciones aplicadas) <br><br><ul><li>  Con un 50% de probabilidad crea un nuevo canal para el intercambio de datos (discusi√≥n especial) </li><li>  Con una probabilidad del 50% escribe un mensaje en cualquiera de los canales existentes </li></ul><br></li></ul><br></li></ul><br>  El escenario "Solo conexiones" apareci√≥ por una raz√≥n.  Existe una situaci√≥n: los usuarios conectaron el sistema, pero a√∫n no se han involucrado.  Cada usuario de la ma√±ana a las 09:00 enciende la computadora, establece una conexi√≥n con el servidor y permanece en silencio.  Estos tipos son peligrosos, hay muchos de ellos: de los paquetes solo tienen PING / PONG, pero mantienen la conexi√≥n con el servidor (no pueden mantenerlo, pero de repente un nuevo mensaje).  La prueba reproduce la situaci√≥n cuando en media hora un gran n√∫mero de dichos usuarios intenta iniciar sesi√≥n en el sistema.  Parece una prueba de esfuerzo, pero se enfoca precisamente en esta primera entrada, para que no haya fallas (una persona no usa el sistema, pero ya se est√° cayendo, es dif√≠cil encontrar algo peor). <br><br>  El escenario de registro de suscriptores se origina desde el primer lanzamiento.  Realizamos una prueba de esfuerzo y est√°bamos seguros de que el sistema no se ralentiza en la correspondencia.  Pero los usuarios se fueron y el registro comenz√≥ a caerse en un tiempo de espera.  Al registrarnos, usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">/ dev / random</a> , que est√° vinculado a la entrop√≠a del sistema.  El servidor no logr√≥ acumular suficiente entrop√≠a y se congel√≥ durante decenas de segundos al solicitar un nuevo SecureRandom.  Hay muchas maneras de salir de esta situaci√≥n, por ejemplo: cambiar a menos seguro / dev / urandom, colocar un tablero especial que genere entrop√≠a, generar n√∫meros aleatorios por adelantado y almacenarlos en el grupo.  Cerramos temporalmente el problema con un grupo, pero desde entonces hemos estado ejecutando una prueba separada para registrar nuevos suscriptores. <br><br>  Como generador de carga usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">JMeter</a> .  No sabe c√≥mo trabajar con un socket web; se necesita un complemento.  Los primeros resultados de b√∫squeda para "jmeter websocket" son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culos con BlazeMeter</a> , que recomiendan un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">complemento de Maciej Zaleski</a> . <br><br>  Con √©l decidimos comenzar. <br><br>  Casi inmediatamente despu√©s del inicio de las pruebas serias, encontramos que las p√©rdidas de memoria comenzaron en JMeter. <br><br>  El complemento es una gran historia separada, con 176 estrellas, tiene 132 tenedores en github.  El propio autor no se ha comprometido con √©l desde 2015 (lo tomamos en 2015, luego esto no levant√≥ sospechas), varios problemas de github sobre p√©rdidas de memoria, 7 solicitudes de extracci√≥n no cerradas. <br>  Si decide realizar pruebas de carga con este complemento, preste atenci√≥n a las siguientes discusiones: <br><br><ol><li>  En un entorno multiproceso, se us√≥ la LinkedList habitual, como resultado, recibieron <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NPE</a> en tiempo de ejecuci√≥n.  Se resuelve cambiando a ConcurrentLinkedDeque o mediante bloques sincronizados.  Eligieron la primera opci√≥n para ellos ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/43</a> ). </li><li>  P√©rdida de memoria, la desconexi√≥n no elimina la informaci√≥n de conexi√≥n ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/44</a> ). </li><li>  En el modo de transmisi√≥n (cuando el socket web no se cierra al final de la muestra, pero se usa m√°s en el plan), los patrones de respuesta ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/19</a> ) no funcionan. </li></ol><br>  Este es uno de esos en github.  Que hemos hecho: <br><br><ol><li>  Tomaron el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tenedor Elyran Kogan</a> (@elyrank): los problemas 1 y 3 se solucionaron </li><li>  Problema resuelto 2 </li><li>  Embarcadero actualizado del 9.2.14 al 9.3.12 </li><li>  SimpleDateFormat envuelto en ThreadLocal;  SimpleDateFormat no es seguro para subprocesos, lo que condujo al tiempo de ejecuci√≥n NPE </li><li>  Se elimin√≥ una p√©rdida de memoria m√°s (la conexi√≥n se cerr√≥ incorrectamente cuando se desconect√≥) </li></ol><br>  ¬°Y sin embargo fluye! <br><br>  El recuerdo comenz√≥ a terminar no en un d√≠a, sino en dos.  No quedaba absolutamente ning√∫n tiempo, decidieron ejecutar menos hilos, pero en cuatro agentes.  Eso deber√≠a haber sido suficiente durante al menos una semana. <br><br>  Han pasado dos d√≠as ... <br><br>  Ahora el recuerdo comenz√≥ a agotarse en Hazelcast.  Fue evidente en los registros que despu√©s de un par de d√≠as de pruebas, Hazelcast comienza a quejarse de la falta de memoria, y despu√©s de un tiempo, el grupo se desmorona y los nodos contin√∫an muriendo individualmente.  Conectamos JVisualVM a hazelcast y vimos una "sierra ascendente", que regularmente llamaba GC, pero no pod√≠a borrar su memoria. <br><br><img src="https://habrastorage.org/webt/ha/uc/5y/hauc5ydqebpmxtfirqalulaandi.png" alt="imagen"><br><br>  Result√≥ que en Hazelcast 3.4, al eliminar map / multiMap (map.destroy ()), la memoria no se libera por completo: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/hazelcast/hazelcast/issues/6317</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/hazelcast/hazelcast/issues/4888</a> <br><br>  Ahora el error se corrigi√≥ en 3.5, pero luego fue un problema.  Creamos nuevos mapas m√∫ltiples con nombres din√°micos y los eliminamos de acuerdo con nuestra l√≥gica.  El c√≥digo se parec√≠a a esto: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">join</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ MultiMap&lt;UUID, Authentication&gt; sessions = instance.getMultiMap(sub); sessions.put(auth.getUserId(), auth); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leave</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ MultiMap&lt;UUID, Authentication&gt; sessions = instance.getMultiMap(sub); sessions.remove(auth.getUserId(), auth); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessions.size() == <span class="hljs-number"><span class="hljs-number">0</span></span>) { sessions.destroy(); } }</code> </pre> <br>  Llamada: <br><br><pre> <code class="java hljs">service.join(auth1, <span class="hljs-string"><span class="hljs-string">"____UUID1"</span></span>); service.join(auth2, <span class="hljs-string"><span class="hljs-string">"____UUID1"</span></span>);</code> </pre> <br>  multiMap se cre√≥ para cada suscripci√≥n y se elimin√≥ cuando no era necesario.  Decidimos que comenzaremos Map &lt;String, Set&gt;, la clave ser√° el nombre de la suscripci√≥n y los valores ser√°n los identificadores de sesi√≥n (desde los cuales puede obtener las ID de usuario, si es necesario). <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">join</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ addValueToMap(sub, auth.getSessionId()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leave</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ removeValueFromMap(sub, auth.getSessionId()); }</code> </pre> <br>  Los cuadros se enderezaron. <br><br><img src="https://habrastorage.org/webt/li/_z/ai/li_zaiochcpbgvviybycfvzslz4.png" alt="imagen"><br><br><h4>  ¬øQu√© m√°s aprendimos sobre las pruebas de estr√©s? </h4><br><ol><li>  JSR223 debe escribirse en cach√© de compilaci√≥n habilitado y maravilloso, esto es mucho m√°s r√°pido.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Enlace</a> </li><li>  Los gr√°ficos Jmeter-Plugins son m√°s f√°ciles de entender que el est√°ndar.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Enlace</a> </li></ol><br><br><h3>  Sobre nuestra experiencia con Hazelcast </h3><br>  Hazelcast era un producto nuevo para nosotros, comenzamos a trabajar con √©l desde la versi√≥n 3.4.1, ahora nuestro servidor de producci√≥n tiene la versi√≥n 3.9.2 (en el momento de la redacci√≥n, la √∫ltima versi√≥n de Hazelcast es la 3.10). <br><br><h4>  Generaci√≥n de ID </h4><br>  Comenzamos con identificadores enteros.  Imaginemos que necesitamos otro Long para una nueva entidad.  La secuencia no cabe en la base de datos, las tablas participan en el particionamiento: resulta que hay un ID de mensaje = 1 en DB1 y un ID de mensaje = 1 en DB2, no puede poner dicha ID en Elasticsearch, ya sea en Hazelcast, pero lo peor es si desea reducir los datos de dos bases de datos en una (por ejemplo, decidir que una base de datos es suficiente para estos suscriptores).  Puede crear varios AtomicLongs en Hazelcast y mantener el contador all√≠, luego el rendimiento de obtener una nueva ID aumentar√° y Obtenga m√°s el tiempo para una solicitud en Hazelcast.  Pero hay algo m√°s √≥ptimo sobre Hazelcast: FlakeIdGenerator.  A cada cliente se le asigna un rango de identificaci√≥n al contactar, por ejemplo, el primero de 1 a 10,000, el segundo de 10,001 a 20,000, y as√≠ sucesivamente.  Ahora el cliente puede emitir nuevos identificadores de forma independiente hasta que finalice el rango emitido.  Funciona r√°pidamente, pero cuando reinicia la aplicaci√≥n (y el cliente Hazelcast), comienza una nueva secuencia, de ah√≠ las brechas, etc.  Adem√°s, los desarrolladores no tienen muy claro por qu√© los ID son enteros, pero son tan diferentes.  Todos pesamos y cambiamos a UUID. <br><br>  Por cierto, para aquellos que quieren ser como Twitter, existe una biblioteca de Snowcast: esta es una implementaci√≥n de Snowflake adem√°s de Hazelcast.  Puedes verlo aqu√≠: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/noctarius/snowcast</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/twitter/snowflake</a> <br><br>  Pero no hemos llegado a sus manos. <br><br><h4>  TransactionalMap.replace </h4><br>  Otra sorpresa: TransactionalMap.replace no funciona.  Aqu√≠ hay una prueba: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceInMap_putsAndGetsInsideTransaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ hazelcastInstance.executeTransaction(context -&gt; { HazelcastTransactionContextHolder.setContext(context); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { context.getMap(<span class="hljs-string"><span class="hljs-string">"map"</span></span>).put(<span class="hljs-string"><span class="hljs-string">"key"</span></span>, <span class="hljs-string"><span class="hljs-string">"oldValue"</span></span>); context.getMap(<span class="hljs-string"><span class="hljs-string">"map"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"key"</span></span>, <span class="hljs-string"><span class="hljs-string">"oldValue"</span></span>, <span class="hljs-string"><span class="hljs-string">"newValue"</span></span>); String value = (String) context.getMap(<span class="hljs-string"><span class="hljs-string">"map"</span></span>).get(<span class="hljs-string"><span class="hljs-string">"key"</span></span>); assertEquals(<span class="hljs-string"><span class="hljs-string">"newValue"</span></span>, value); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { HazelcastTransactionContextHolder.clearContext(); } }); } Expected : newValue Actual : oldValue</code> </pre> <br>  Tuve que escribir mi reemplazo usando getForUpdate: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> &lt;K,V&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceInMap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String mapName, K key, V oldValue, V newValue)</span></span></span><span class="hljs-function"> </span></span>{ TransactionalTaskContext context = HazelcastTransactionContextHolder.getContext(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { log.trace(<span class="hljs-string"><span class="hljs-string">"[CACHE] Replacing value in a transactional map"</span></span>); TransactionalMap&lt;K, V&gt; map = context.getMap(mapName); V value = map.getForUpdate(key); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (oldValue.equals(value)) { map.put(key, newValue); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } log.trace(<span class="hljs-string"><span class="hljs-string">"[CACHE] Replacing value in a not transactional map"</span></span>); IMap&lt;K, V&gt; map = hazelcastInstance.getMap(mapName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.replace(key, oldValue, newValue); }</code> </pre> <br>  Pruebe no solo las estructuras de datos regulares, sino tambi√©n sus versiones transaccionales.  Sucede que IMap funciona, pero TransactionalMap se ha ido. <br><br><h4>  Adjunte un nuevo JAR sin tiempo de inactividad </h4><br>  Primero, decidimos grabar objetos de nuestras clases en Hazelcast.  Por ejemplo, tenemos una aplicaci√≥n de clase, queremos guardarla y leerla.  Guardar: <br><br><pre> <code class="java hljs">IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application"</span></span>); map.set(id, application);</code> </pre> <br>  Leemos: <br><br><pre> <code class="java hljs">IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.get(id);</code> </pre> <br>  Todo funciona  Luego decidimos crear un √≠ndice en Hazelcast para buscarlo: <br><br><pre> <code class="java hljs">map.addIndex(<span class="hljs-string"><span class="hljs-string">"subscriberId"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);</code> </pre> <br>  Y al escribir una nueva entidad, comenzaron a recibir una ClassNotFoundException.  Hazelcast intent√≥ complementar el √≠ndice, pero no sab√≠a nada sobre nuestra clase y quer√≠a que tuviera un JAR con esta clase.  Lo hicimos, todo funcion√≥, pero apareci√≥ un nuevo problema: ¬øc√≥mo actualizar el JAR sin detener el cl√∫ster por completo?  Hazelcast no recoge el nuevo JAR durante una actualizaci√≥n inteligente.  En este momento, decidimos que podr√≠amos vivir muy bien sin buscar por √≠ndice.  Despu√©s de todo, si usa Hazelcast como almacenamiento de valor clave, ¬øfuncionar√° todo?  En realidad no  Aqu√≠ nuevamente, el comportamiento diferente de IMap y TransactionalMap.  Donde IMap no importa, TransactionalMap arroja un error. <br><br>  IMap  Escribimos 5000 objetos, lo le√≠mos.  Todo se espera. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get5000</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application"</span></span>); UUID subscriberId = UUID.randomUUID(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">5000</span></span>; i++) { UUID id = UUID.randomUUID(); String title = RandomStringUtils.random(<span class="hljs-number"><span class="hljs-number">5</span></span>); Application application = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application(id, title, subscriberId); map.set(id, application); Application retrieved = map.get(id); assertEquals(id, retrieved.getId()); } }</code> </pre> <br>  Y no funciona en la transacci√≥n, obtenemos una ClassNotFoundException: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_transaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application_t"</span></span>); UUID subscriberId = UUID.randomUUID(); UUID id = UUID.randomUUID(); Application application = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application(id, <span class="hljs-string"><span class="hljs-string">"qwer"</span></span>, subscriberId); map.set(id, application); Application retrievedOutside = map.get(id); assertEquals(id, retrievedOutside.getId()); hazelcastInstance.executeTransaction(context -&gt; { HazelcastTransactionContextHolder.setContext(context); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { TransactionalMap&lt;UUID, Application&gt; transactionalMap = context.getMap(<span class="hljs-string"><span class="hljs-string">"application_t"</span></span>); Application retrievedInside = transactionalMap.get(id); assertEquals(id, retrievedInside.getId()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { HazelcastTransactionContextHolder.clearContext(); } }); }</code> </pre> <br>  En 3.8, apareci√≥ el mecanismo de implementaci√≥n de clase de usuario.  Puede asignar un nodo principal y actualizar el archivo JAR en √©l. <br><br>  Ahora hemos cambiado completamente el enfoque: lo serializamos en JSON y lo guardamos en Hazelcast.  Hazelcast no necesita conocer la estructura de nuestras clases, pero podemos actualizar sin tiempo de inactividad.  El control de versiones de los objetos de dominio est√° controlado por la aplicaci√≥n.  Se pueden iniciar diferentes versiones de la aplicaci√≥n al mismo tiempo, y es posible que una nueva aplicaci√≥n escriba objetos con nuevos campos, pero la anterior no conoce estos campos.  Y al mismo tiempo, la nueva aplicaci√≥n lee los objetos grabados por la aplicaci√≥n anterior, en la que no hay nuevos campos.  Manejamos tales situaciones dentro de la aplicaci√≥n, pero por simplicidad no cambiamos ni eliminamos campos, solo ampliamos las clases agregando nuevos campos. <br><br><h3>  C√≥mo brindamos un alto rendimiento </h3><br><h4>  Cuatro viajes a Hazelcast - bueno, dos a la base de datos - malo </h4><br>  Ir al cach√© para obtener datos siempre es mejor que en la base de datos, pero no desea almacenar registros no reclamados.  La decisi√≥n sobre qu√© almacenar en cach√© la posponemos a la √∫ltima etapa de desarrollo.  Cuando se codifica la nueva funcionalidad, activamos PostgreSQL para registrar todas las consultas (log_min_duration_statement a 0) y ejecutar pruebas de carga durante 20 minutos. Al usar registros recopilados, utilidades como pgFouine y pgBadger pueden generar informes anal√≠ticos.  En los informes, buscamos principalmente consultas lentas y frecuentes.  Para consultas lentas, creamos un plan de ejecuci√≥n (EXPLICAR) y evaluamos si dicha consulta puede acelerarse.  Las solicitudes frecuentes de los mismos datos de entrada est√°n bien almacenadas en cach√©.  Intentamos mantener las solicitudes "planas", una tabla por solicitud. <br><br><h2>  Operaci√≥n </h2><br>  SV como servicio en l√≠nea se lanz√≥ en la primavera de 2017, ya que se lanz√≥ un producto SV por separado en noviembre de 2017 (en ese momento en estado beta). <br><br>  Durante m√°s de un a√±o de operaci√≥n, no ocurrieron problemas serios en la operaci√≥n del servicio en l√≠nea de CB.  Monitoreamos el servicio en l√≠nea a trav√©s de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Zabbix</a> , recopilamos e implementamos desde <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Bamboo</a> . <br><br>  El kit de distribuci√≥n del servidor CB se entrega en forma de paquetes nativos: RPM, DEB, MSI.  Adem√°s, para Windows, proporcionamos un √∫nico instalador en forma de un EXE, que instala el servidor, Hazelcast y Elasticsearch en una m√°quina.  Al principio llamamos a esta versi√≥n de la instalaci√≥n "demo", pero ahora qued√≥ claro que esta es la opci√≥n de implementaci√≥n m√°s popular. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es422903/">https://habr.com/ru/post/es422903/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es422893/index.html">Gu√≠a de Node.js, Parte 1: Informaci√≥n general y primeros pasos</a></li>
<li><a href="../es422895/index.html">Google quiere matar las URL</a></li>
<li><a href="../es422897/index.html">Malo, pero el m√≠o: c√≥mo escribir CSS realmente horrible</a></li>
<li><a href="../es422899/index.html">Bajo supervisi√≥n vigilante: c√≥mo controlar las tarifas de los proveedores de alojamiento y mantener actualizado el cat√°logo de VPS</a></li>
<li><a href="../es422901/index.html">Un monitor de ritmo card√≠aco para Putin, o lo que es un Ritmer</a></li>
<li><a href="../es422905/index.html">Pero dices Ceph ... ¬øes tan bueno?</a></li>
<li><a href="../es422907/index.html">Referencia r√°pida de la aspiradora robot 2018</a></li>
<li><a href="../es422909/index.html">Los 10 videos retro talk m√°s populares del 404 Festival</a></li>
<li><a href="../es422915/index.html">Estoy buscando a un senior sin una oficina y sin cookies: c√≥mo hemos organizado una b√∫squeda de empleados que son 100% remotos</a></li>
<li><a href="../es422917/index.html">No tengo boca, pero tengo que gritar. Reflexiones sobre IA y √©tica</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>