<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèë üêé üì™ Pesadelo do "cavaleiro": uma hist√≥ria instrutiva sobre DevOps üöã üí≠ üñêÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1066, mais de 200 anos se passaram desde o in√≠cio da invas√£o viking da Inglaterra. O rei Harold, colecionando um destacamento de cavaleiros, marchou p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pesadelo do "cavaleiro": uma hist√≥ria instrutiva sobre DevOps</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/moex/blog/458304/"><img src="https://habrastorage.org/webt/im/2a/ct/im2actpwxzvrz1_j4k-2easujdy.jpeg"><br><br>  1066, mais de 200 anos se passaram desde o in√≠cio da invas√£o viking da Inglaterra.  O rei Harold, colecionando um destacamento de cavaleiros, marchou para o rio Derwent para uma batalha decisiva com as tropas de seu hom√¥nimo - o rei noruegu√™s Harald.  Os armeiros trabalharam por um m√™s para forjar armaduras de nova gera√ß√£o suficientes que pudessem proteger o cavaleiro de ser atingido por um machado escandinavo.  E quantas experi√™ncias e testes em torneios haviam sido antes!  Mas a expectativa deveria ter se justificado - equipamentos leves, por√©m confi√°veis, permitiam, mesmo a p√©, sem grandes perdas, dispersar o p√°ssaro Viking.  E, finalmente, eles se conheceram em Stamford Bridge.  O principal destacamento de cavaleiros, liderado por um comandante de armadura brilhante, colidiu no meio de uma ponte com inimigos.  Sim, o a√ßo dos mestres podgorny aguenta o soco! <br><br>  Lenta mas seguramente, os vikings est√£o se movendo para uma defesa round-robin.  A vit√≥ria parece estar pr√≥xima.  E finalmente, no campo de batalha, o comandante do cavaleiro e o jarl noruegu√™s se encontram. <br><a name="habracut"></a><br>  O machado do jarl de duas m√£os j√° est√° quebrado e ele √© for√ßado a se defender com um sax√£o comum, que n√£o pode ser comparado a um cavaleiro e meia espada.  Uma onda com uma adaga - para a armadura do comandante √© como um canivete, mas passa atrav√©s da armadura e ... parece que a magia entrou em jogo - a armadura dos cavaleiros vizinhos est√° espalhada!  Outra onda, novamente no alvo, e agora nos cavaleiros do flanco esquerdo a armadura brilha de repente em brasa.  O terceiro golpe - os cavaleiros nadam diante de seus olhos, trope√ßam, caem e nunca mais se levantam. <br><br>  "*** ** **** ****!"  Gritou Petrovich, acordando √†s 5 da manh√£ de segunda-feira suando frio.  Tudo deu errado: √†s 11 da noite, ele subiu √† Wikipedia em busca de materiais para o relato da crian√ßa sobre a natureza da tundra, mas na hora da noite, de alguma forma, se viu na descri√ß√£o da invas√£o viking da Inglaterra.  E tamb√©m, no fim de semana, eles colocam em batalha o pr√≥ximo lan√ßamento, que deve come√ßar hoje.  Como sempre, n√≥s o testamos por um longo tempo e minuciosamente, conduzimos atrav√©s de sistemas de integra√ß√£o cont√≠nua um milh√£o de vezes, se tudo corre bem ... <br><br>  Felizmente para alguns, mas infelizmente para as v√≠timas, sempre h√° a oportunidade de aprender com os erros dos outros, de melhorar algo em casa e obter uma por√ß√£o extra de confian√ßa.  Com este artigo traduzido, queremos mais uma vez, com mais detalhes, relembrar um dos casos no "nosso" setor. <br><br><hr><br>  No ano passado, na confer√™ncia, falei sobre DevOps, configura√ß√£o como c√≥digo e entrega cont√≠nua.  Usando a hist√≥ria abaixo, expliquei a import√¢ncia de criar implanta√ß√µes totalmente automatizadas e reproduz√≠veis como parte da iniciativa DevOps / Entrega Cont√≠nua.  Ap√≥s a confer√™ncia, v√°rias pessoas me pediram para compartilhar uma hist√≥ria em um blog.  Esta √© uma hist√≥ria absolutamente verdadeira.  Esta √© uma recontagem do que li, eu mesmo n√£o participei disso. <br><br>  Portanto, a hist√≥ria de como uma empresa com ativos de quase US $ 400 milh√µes faliu em 45 minutos devido a uma implanta√ß√£o malsucedida. <br><br><h1>  Um pouco de fundo </h1><br>  O Knight Capital Group ("Knight" em ingl√™s significa "cavaleiro") √© uma empresa financeira global americana envolvida em cria√ß√£o de mercado, execu√ß√£o eletr√¥nica, vendas e negocia√ß√µes institucionais.  Em 2012, Knight era o maior negociador de a√ß√µes dos Estados Unidos, com uma participa√ß√£o de mercado de cerca de 17% na NYSE e NASDAQ.  O Electronic Trading Group (ETG) da Knight gerenciava um volume m√©dio di√°rio de mais de 3,3 bilh√µes de transa√ß√µes por dia, negociando mais de US $ 21 bilh√µes ... por dia.  Isso n√£o √© uma piada! <br><br>  Em 31 de julho de 2012, a Knight possu√≠a aproximadamente US $ 365 milh√µes em dinheiro e equivalentes. <br><br>  Em 1¬∫ de agosto de 2012, a NYSE planejava lan√ßar um novo programa de liquidez de varejo, o Retail Liquidity Program (um programa projetado para melhorar os pre√ßos para investidores de varejo por meio de corretores de varejo, como Knight).  Em prepara√ß√£o para este evento, a Knight atualizou seu roteador algor√≠tmico automatizado, de alta velocidade, SMARS, que envia aplicativos ao mercado para execu√ß√£o.  Uma das principais fun√ß√µes do SMARS √© receber aplicativos de outros componentes da plataforma de negocia√ß√£o Knights (aplicativos "pais"), seguidos pelo envio de um ou mais aplicativos "filhos" para execu√ß√£o.  Em outras palavras, a SMARS receber√° grandes pedidos da plataforma de negocia√ß√£o e os dividir√° em v√°rios pequenos para encontrar um comprador / vendedor de a√ß√µes.  Quanto maior o aplicativo pai, mais aplicativos filhos ser√£o criados. <br><br>  A atualiza√ß√£o do SMARS deveria substituir o c√≥digo antigo e n√£o usado chamado ‚ÄúPower Peg‚Äù - essa funcionalidade que Knight n√£o usava h√° 8 anos (por que o c√≥digo que estava morto por tanto tempo ainda estava na base de c√≥digos √© um mist√©rio, mas essa n√£o √© a principal).  O c√≥digo atualizado reatribuiu o sinalizador antigo usado para ativar a funcionalidade Power Peg.  O c√≥digo foi completamente testado, funcionou corretamente e era confi√°vel.  O que poderia ter dado errado? <br><br><h1>  O que poderia ter dado errado?  E realmente! </h1><br>  Entre 27 de julho de 2012 e 31 de julho de 2012, a Knight implantou manualmente novo software em um n√∫mero limitado de servidores por dia - um total de oito (8) servidores.  Aqui est√° o que o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documento</a> da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SEC</a> diz sobre a implanta√ß√£o manual (a SEC √© a Comiss√£o de Valores Mobili√°rios, o √≥rg√£o regulador americano do mercado de a√ß√µes). <br><br><blockquote>  ‚ÄúDurante a implanta√ß√£o do novo c√≥digo, um dos funcion√°rios da Knight n√£o copiou o novo c√≥digo para um dos oito servidores SMARS.  Knight n√£o conduziu uma segunda revis√£o t√©cnica dessa implanta√ß√£o; portanto, o c√≥digo do Power Peg n√£o foi exclu√≠do do oitavo servidor e o novo c√≥digo RLP n√£o foi adicionado.  A empresa n√£o possu√≠a procedimentos que exigissem reexame. ‚Äù  Vers√£o n¬∫ 70694, 16 de outubro de 2013 </blockquote><br>  Em 1¬∫ de agosto de 2012, √†s 21h30, EST, os mercados foram abertos e a Knight come√ßou a processar solicita√ß√µes de corretoras em nome de seus clientes no novo Programa de Liquidez do Varejo.  Sete (7) servidores implantados corretamente come√ßaram a processar aplicativos corretamente.  E os aplicativos que foram para o oitavo servidor provavelmente ativaram o sinalizador alterado e ressuscitaram o Power Peg. <br><br><h1>  Zombie Attack: Killer Code </h1><br>  Aqui voc√™ precisa explicar por que o c√≥digo Power Peg "morto" foi necess√°rio.  Essa funcionalidade foi projetada para contar as a√ß√µes compradas / vendidas mediante solicita√ß√£o dos pais, √† medida que os pedidos da crian√ßa s√£o conclu√≠dos.  Depois que o aplicativo pai √© executado, o Power Peg pro√≠be o envio de aplicativos filhos.  Em princ√≠pio, o Power Peg rastrear√° os pedidos filhos e interromper√° sua execu√ß√£o ap√≥s o processamento do aplicativo pai.  Em 2005, Knight reverteu essa funcionalidade de rastreamento cumulativo para um est√°gio anterior da execu√ß√£o do c√≥digo (removendo assim o rastreamento de quantidade do Power Peg). <br><br>  Quando o sinalizador Power Peg no oitavo servidor foi ativado, o Power Peg come√ßou a rotear ordens filho para execu√ß√£o, mas n√£o as correlacionou com o n√∫mero de compartilhamentos na ordem pai - um tipo de loop fechado surgiu <br><br><h1>  Infernal 45 minutos </h1><br>  Imagine: voc√™ tem um sistema que pode enviar aplicativos autom√°ticos de alta velocidade ao mercado sem nenhum rastreamento e a capacidade de verificar se aplicativos suficientes foram conclu√≠dos.  Sim, tudo ficou t√£o ruim. <br><br>  Quando o mercado abriu √†s 9h30, as pessoas rapidamente perceberam que algo estava errado.  √Äs 9:31 da manh√£, muitos em Wall Street perceberam que algo s√©rio estava acontecendo.  O mercado foi inundado por ofertas com um volume incomum, comparado com a situa√ß√£o normal, ao volume negociado de determinadas a√ß√µes.  √Äs 9:32 em Wall Street, eles se perguntavam por que essa desgra√ßa n√£o para.  Quase sempre em negocia√ß√µes de alta velocidade.  Por que algu√©m n√£o clicou no bot√£o kill no sistema que fez isso?  Como se viu, n√£o havia interruptor.  Durante os primeiros 45 minutos de negocia√ß√£o, a execu√ß√£o de transa√ß√µes da Knight atingiu mais de 50% do volume negociado, aumentando algumas a√ß√µes em mais de 10% do seu valor.  Como resultado, outras a√ß√µes ca√≠ram de valor devido a transa√ß√µes incorretas. <br><br>  E para piorar a situa√ß√£o, o sistema Knight come√ßou a enviar e-mails automatizados mesmo antes desses eventos - j√° √†s 8:01 da manh√£ (quando a SMARS processava pedidos adequados para negocia√ß√£o antes do mercado).  Nas mensagens, o sistema se referia ao SMARS e mostrava o erro "O Power Peg n√£o est√° dispon√≠vel".  Entre 8:01 e 9:30, 97 cartas foram enviadas aos funcion√°rios da Knight.  Obviamente, essas cartas n√£o pareciam avisos do sistema, ent√£o ningu√©m as olhou imediatamente.  Ai. <br><br>  Por 45 minutos infernais, Knight tentou parar a transa√ß√£o err√¥nea.  N√£o foi poss√≠vel desligar o sistema (como n√£o havia procedimentos documentados para responder a essa situa√ß√£o), portanto, tentando lidar com o problema em condi√ß√µes de negocia√ß√£o ao vivo, eles permaneceram no mercado, onde foram vendidas 8 milh√µes de a√ß√µes a cada minuto.  Como os funcion√°rios da empresa n√£o conseguiram determinar de onde os aplicativos errados vieram, eles removeram o novo c√≥digo dos servidores em que foram implantados corretamente.  Em outras palavras, eles exclu√≠ram o c√≥digo de trabalho e foram quebrados.  Isso s√≥ exacerbou os problemas que causavam solicita√ß√µes adicionais dos pais para ativar o c√≥digo do Power Peg em todos os servidores, e n√£o apenas onde o c√≥digo foi originalmente implantado incorretamente.  No final, consegui parar o sistema - ap√≥s 45 minutos de negocia√ß√£o. <br><br>  Enquanto as negocia√ß√µes estavam em andamento, o c√≥digo do Power Peg recebeu e processou 212 solicita√ß√µes dos pais.  Como resultado, a SMARS enviou milh√µes de subsidi√°rias ao mercado, completou 4 milh√µes de transa√ß√µes em 154 transa√ß√µes com mais de 397 milh√µes de a√ß√µes.  Para os conhecedores do mercado de a√ß√µes, isso significou que a Knight comprou a√ß√µes de 80 empresas diferentes por US $ 3,5 bilh√µes e vendeu a√ß√µes de 74 empresas por US $ 3,15 bilh√µes.No ponto de vista de n√£o profissionais, o Knight Capital Group perdeu US $ 460 milh√µes em 45 minutos.  Mas Knight tem apenas US $ 365 milh√µes em dinheiro e equivalentes.  Em 45 minutos, Knight se transformou do maior negociador de a√ß√µes americanas e um dos principais formadores de mercado da NYSE e NASDAQ em fal√™ncia.  Eles tiveram 48 horas para coletar o valor necess√°rio para cobrir as perdas (o que puderam fazer gra√ßas a um investimento de US $ 400 milh√µes de cerca de meia d√∫zia de investidores).  Por fim, o Knight Capital Group foi adquirido pela Getco LLC (em dezembro de 2012) e agora a empresa combinada se chama KCG Holdings. <br><br><h1>  Que conclus√µes voc√™ precisa tirar </h1><br>  Os eventos de 1¬∫ de agosto de 2012 devem ser uma li√ß√£o para todas as equipes de desenvolvimento e equipes de projeto.  N√£o basta criar um √≥timo software e test√°-lo;  Voc√™ tamb√©m precisa garantir que ele seja entregue corretamente ao mercado para que seus clientes recebam exatamente o valor que voc√™ fornece (e que voc√™ n√£o ir√° √† fal√™ncia da sua empresa).  O (s) engenheiro (s) que implantaram o SMARS n√£o s√£o os √∫nicos respons√°veis ‚Äã‚Äãpelo fato de que o procedimento seguido na Knight n√£o levou em considera√ß√£o os riscos.  O procedimento (ou a sua aus√™ncia) foi obviamente errado.  Sempre que o processo de implanta√ß√£o depende de como as pessoas leem e seguem as instru√ß√µes, voc√™ se coloca em risco.  As pessoas cometem erros.  Os erros podem estar nas instru√ß√µes, na interpreta√ß√£o das instru√ß√µes ou na sua implementa√ß√£o. <br><br>  O layout deve ser automatizado, reproduz√≠vel e o mais livre poss√≠vel de erros humanos.  Se a Knight tivesse implementado um sistema de implanta√ß√£o automatizado - um conjunto de configura√ß√µes, implanta√ß√£o autom√°tica e teste -, o erro que se transformou no pesadelo de Knight poderia ter sido evitado. <br><br>  Aqui est√£o alguns princ√≠pios de entrega cont√≠nua (mesmo que voc√™ n√£o implemente o processo completo de entrega cont√≠nua): <br><br><ul><li>  A libera√ß√£o do software deve ser um processo repet√≠vel e confi√°vel. <br></li><li>  Automatize tudo o que puder. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt458304/">https://habr.com/ru/post/pt458304/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt458290/index.html">Computador biossint√©tico de n√∫cleo duplo em uma c√©lula viva</a></li>
<li><a href="../pt458292/index.html">PHP Digest No. 159 (17 de junho a 1 de julho de 2019)</a></li>
<li><a href="../pt458298/index.html">Fez uma meia engrenagem grande em pain√©is solares por 250.000 rublos (2 partes)</a></li>
<li><a href="../pt458300/index.html">Evolu√ß√£o da ferramenta mais popular de todos os desenvolvedores (no Visual Studio)</a></li>
<li><a href="../pt458302/index.html">Frontend Weekly Digest (24 a 30 de junho de 2019)</a></li>
<li><a href="../pt458306/index.html">O resumo de materiais frescos do mundo do front-end da √∫ltima semana n ¬∞ 371 (24 a 30 de junho de 2019)</a></li>
<li><a href="../pt458308/index.html">Vis√£o geral: Qual ser√° o futuro da Tesla e quais fatores o afetar√£o</a></li>
<li><a href="../pt458310/index.html">Coletando m√©tricas de aplicativos .NET usando Telegraf</a></li>
<li><a href="../pt458312/index.html">Academia Android em Moscou: curso avan√ßado</a></li>
<li><a href="../pt458316/index.html">Yandex Retro Games Battle 2019 - desenvolvimento de jogos para o ZX Spectrum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>