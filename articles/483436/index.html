<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüíº ‚òïÔ∏è üôçüèΩ Juega "osu!", Pero ten cuidado con los errores üë©‚Äçüé§ üò∫ ‚èØÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬°Hola, todos ustedes, coleccionistas de bichos ex√≥ticos y simples! Hoy tenemos un esp√©cimen raro en nuestro banco de pruebas PVS-Studio: un juego llam...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Juega "osu!", Pero ten cuidado con los errores</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/483436/"><p><img src="https://habrastorage.org/getpro/habr/post_images/3ac/9da/a12/3ac9daa12b519fc14e45f7f65abdd204.png" alt="Imagen 1" align="left"></p><br>  ¬°Hola, todos ustedes, coleccionistas de bichos ex√≥ticos y simples!  Hoy tenemos un esp√©cimen raro en nuestro banco de pruebas PVS-Studio: un juego llamado "osu!", Escrito en C #.  Como de costumbre, buscaremos errores, los analizaremos y jugaremos. <br><a name="habracut"></a><br><h2>  El juego </h2><br>  Osu!  es un juego de ritmo de c√≥digo abierto.  Seg√∫n el <a href="https://osu.ppy.sh/home">sitio web</a> del juego, es bastante popular, con m√°s de 15 millones de cuentas de jugadores.  El proyecto presenta jugabilidad gratuita, dise√±o colorido, personalizaci√≥n de mapas, un avanzado sistema de clasificaci√≥n de jugadores en l√≠nea, modo multijugador y un rico conjunto de piezas musicales.  No tiene sentido seguir profundizando en el juego;  Puedes leer todo sobre esto en Internet.  Comience con <a href="https://en.wikipedia.org/wiki/Osu!">esta p√°gina</a> . <br><br>  Estoy m√°s interesado en el c√≥digo fuente del proyecto, que est√° disponible en <a href="https://github.com/ppy/osu">GitHub</a> .  Una cosa que llama la atenci√≥n de inmediato es la gran cantidad de confirmaciones de repositorio (m√°s de 24 mil), que es una se√±al de desarrollo intenso y continuo (el juego se lanz√≥ por primera vez en 2007, pero el trabajo debe haber comenzado incluso antes).  Sin embargo, el proyecto no es grande: solo 1813 archivos .cs con un total de 135 mil LOC no vac√≠os.  Este n√∫mero tambi√©n incluye pruebas, que generalmente no tengo en cuenta al ejecutar cheques.  Las pruebas componen 306 de los archivos .cs con 25 mil LOC.  El proyecto es realmente peque√±o: por ejemplo, el n√∫cleo C # de PVS-Studio tiene aproximadamente 300 mil LOC. <br><br>  Dejando de lado los archivos de prueba, revis√© 1507 archivos de 110 mil LOC de largo.  El cheque revel√≥ algunos errores interesantes, que estoy dispuesto a mostrarle. <br><br><h2>  Los bichos </h2><br>  <a href="https://www.viva64.com/en/w/v3001/">V3001</a> Hay <a href="https://www.viva64.com/en/w/v3001/">subexpresiones</a> id√©nticas 'result == HitResult.Perfect' a la izquierda y a la derecha de '||'  operador  DrawableHoldNote.cs 266 <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckForResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... ApplyResult(r =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (holdNote.hasBroken &amp;&amp; (result == HitResult.Perfect || result == HitResult.Perfect)) result = HitResult.Good; .... }); }</code> </pre> <br>  Este es un buen ejemplo de programaci√≥n orientada a copiar y pegar, que es un t√©rmino humor√≠stico utilizado recientemente por mi compa√±ero de trabajo Valeriy Komarov en su art√≠culo " <a href="https://www.viva64.com/en/b/0699/">Los 10 errores principales encontrados en proyectos Java en 2019</a> ". <br><br>  De todos modos, se ejecutan dos verificaciones id√©nticas en una fila.  Uno de ellos probablemente estaba destinado a verificar alguna otra constante de la enumeraci√≥n <i>HitResult</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> HitResult { None, Miss, Meh, Ok, Good, Great, Perfect, }</code> </pre> <br>  ¬øQu√© constante deb√≠a ser revisada?  ¬øO tal vez la segunda verificaci√≥n no deber√≠a estar all√≠ en absoluto?  Estas son las preguntas que solo los autores pueden responder.  De todos modos, este es un error que distorsiona la l√≥gica de ejecuci√≥n del programa. <br><br>  <a href="https://www.viva64.com/en/w/v3001/">V3001</a> Hay <a href="https://www.viva64.com/en/w/v3001/">subexpresiones</a> id√©nticas 'family! = GetFamilyString (TournamentTypeface.Aquatico)' a la izquierda y a la derecha del operador '&amp;&amp;'.  TournamentFont.cs 64 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWeightString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> family, FontWeight weight</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (weight == FontWeight.Regular &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico) &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico)) weightString = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; .... }</code> </pre> <br>  Copiar y pegar nuevamente.  Refactor√© el c√≥digo para que el error se note f√°cilmente ahora pero originalmente se hab√≠a escrito en una l√≠nea.  Al igual que en el ejemplo anterior, no puedo decir con certeza c√≥mo se debe solucionar este.  La enumeraci√≥n <i>TournamentTypeface</i> contiene solo una constante: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> TournamentTypeface { Aquatico }</code> </pre> <br>  Quiz√°s el error se trata de verificar la variable <i>familiar</i> dos veces, pero puedo estar equivocado. <br><br>  <a href="https://www.viva64.com/en/w/v3009/">V3009</a> [CWE-393] Es extra√±o que este m√©todo siempre devuelva el mismo valor de 'falso'.  KeyCounterAction.cs 19 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> forwards</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!EqualityComparer&lt;T&gt;.Default.Equals(action, Action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; IsLit = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (forwards) Increment(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br>  Este m√©todo devuelve <i>falso</i> cada vez.  En casos como este, generalmente verificar√≠a la llamada a la funci√≥n, porque a menudo puede encontrar que la persona que llama no usa el valor de retorno, lo que significa que no hay problema (aparte del mal estilo).  As√≠ es como se ve la llamada en este caso: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action</span></span></span><span class="hljs-function">)</span></span> =&gt; Target.Children .OfType&lt;KeyCounterAction&lt;T&gt;&gt;() .Any(c =&gt; c.OnPressed(action, Clock.Rate &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre> <br>  Como puede ver, la persona que llama utiliza el valor devuelto por el m√©todo <i>OnPressed</i> .  Como ese valor siempre es <i>falso</i> , la persona que llama siempre devuelve <i>falso</i> tambi√©n.  Es muy probable que este c√≥digo contenga un error y debe ser revisado. <br><br>  Otro error similar: <br><br><ul><li>  V3009 [CWE-393] Es extra√±o que este m√©todo siempre devuelva el mismo valor de 'falso'.  KeyCounterAction.cs 30 </li></ul><br>  <a href="https://www.viva64.com/en/w/v3042/">V3042</a> [CWE-476] Posible NullReferenceException.  El '?.'  y '.'  Los operadores se utilizan para acceder a los miembros del objeto 'val.NewValue' TournamentTeam.cs 41 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TournamentTeam</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Acronym.ValueChanged += val =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) FlagName.Value = val.NewValue.Length &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">// &lt;= ? val.NewValue?.Substring(0, 2).ToUpper() : string.Empty; }; .... }</span></span></code> </pre> <br>  La variable <i>val.NewValue</i> se maneja de forma peligrosa en la condici√≥n del operador <i>?:</i> .  Lo que hace pensar al analizador es el hecho de que m√°s adelante en la bifurcaci√≥n, la misma variable se maneja de manera segura utilizando el operador de acceso condicional: <i>val.NewValue? .Substring (....)</i> . <br><br>  Otro error similar: <br><br><ul><li>  V3042 [CWE-476] Posible NullReferenceException.  El '?.'  y '.'  Los operadores se utilizan para acceder a los miembros del objeto 'val.NewValue' TournamentTeam.cs 48 </li></ul><br>  <a href="https://www.viva64.com/en/w/v3042/">V3042</a> [CWE-476] Posible NullReferenceException.  El '?.'  y '.'  Los operadores se utilizan para acceder a los miembros del objeto 'api' SetupScreen.cs 77 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionableInfo { Label = <span class="hljs-string"><span class="hljs-string">"Current User"</span></span>, ButtonText = <span class="hljs-string"><span class="hljs-string">"Change Login"</span></span>, Action = () =&gt; { api.Logout(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }, Value = api?.LocalUser.Value.Username, .... }, .... } private class ActionableInfo : LabelledDrawable&lt;Drawable&gt; { .... public Action Action; .... }</span></span></code> </pre> <br>  Este es m√°s ambiguo, pero creo que tambi√©n es un error.  El programador crea un objeto de tipo <i>ActionableInfo</i> .  El campo <i>Acci√≥n</i> se inicializa utilizando una funci√≥n lambda, que maneja la <i>API de</i> referencia potencialmente nula de una manera peligrosa.  El analizador piensa que este patr√≥n es un error porque la variable <i>api</i> se maneja de manera segura m√°s tarde, al inicializar el par√°metro <i>Value</i> .  Llam√© a este caso ambiguo porque el c√≥digo en la funci√≥n lambda implica una ejecuci√≥n retrasada, en el momento en que el desarrollador podr√≠a garantizar de alguna manera que la referencia de la <i>API</i> ser√≠a no nula.  Pero no estoy seguro de eso porque el cuerpo de la funci√≥n lambda no parece utilizar ning√∫n manejo de referencia seguro, como verificaciones previas. <br><br>  <a href="https://www.viva64.com/en/w/v3066/">V3066</a> [CWE-683] Posible orden incorrecto de argumentos pasados ‚Äã‚Äãal m√©todo 'Atan2': 'diff.X' y 'diff.Y'.  SliderBall.cs 182 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> completionProgress</span></span></span><span class="hljs-function">)</span></span> { .... Rotation = <span class="hljs-number"><span class="hljs-number">-90</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)(-Math.Atan2(diff.X, diff.Y) * <span class="hljs-number"><span class="hljs-number">180</span></span> / Math.PI); .... }</code> </pre> <br>  El analizador sospecha que los argumentos del m√©todo <i>Atan2</i> se pasan en el orden incorrecto.  Esta es la declaraci√≥n del m√©todo: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Parameters: // y: // The y coordinate of a point. // // x: // The x coordinate of a point. public static double Atan2(double y, double x);</span></span></code> </pre> <br>  Los valores se pasaron en el orden inverso.  No estoy seguro de si esto es un error porque el m√©todo <i>UpdateProgress</i> contiene muchos c√°lculos no triviales;  Solo lo menciono como un posible error. <br><br>  <a href="https://www.viva64.com/en/w/v3080/">V3080</a> [CWE-476] Posible desreferencia nula.  Considere inspeccionar 'Beatmap'.  WorkingBeatmap.cs 57 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Track </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetVirtualTrack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastObject = Beatmap.HitObjects.LastOrDefault(); .... }</code> </pre> <br>  El analizador se√±ala una posible desreferencia nula de <i>Beatmap</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IBeatmap Beatmap { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LoadBeatmapAsync().Result; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (TaskCanceledException) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } }</code> </pre> <br>  Bueno, el analizador es correcto. <br><br>  Para obtener m√°s informaci√≥n sobre c√≥mo PVS-Studio detecta errores como este, y sobre las nuevas caracter√≠sticas agregadas en C # 8.0 que tienen que ver con el manejo de referencias potencialmente nulas, consulte el art√≠culo " <a href="https://www.viva64.com/en/b/0631/">Tipos de referencias anulables en C # 8.0 y an√°lisis est√°tico</a> ". <br><br>  <a href="https://www.viva64.com/en/w/v3083/">V3083</a> [CWE-367] Invocaci√≥n insegura del evento 'ObjectConverted', NullReferenceException es posible.  Considere asignar un evento a una variable local antes de invocarlo.  BeatmapConverter.cs 82 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ObjectConverted != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { converted = converted.ToList(); ObjectConverted.Invoke(obj, converted); } .... }</code> </pre> <br>  Este es un error menor y bastante com√∫n.  Los suscriptores pueden darse de baja del evento entre la verificaci√≥n nula y la invocaci√≥n del evento, lo que resulta en un bloqueo.  Esta es una forma de corregir el error: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... converted = converted.ToList(); ObjectConverted?.Invoke(obj, converted); .... }</code> </pre> <br>  <a href="https://www.viva64.com/en/w/v3095/">V3095</a> [CWE-476] El objeto 'columnas' se us√≥ antes de que se verificara como nulo.  L√≠neas de verificaci√≥n: 141, 142. SquareGraph.cs 141 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">redrawProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ColumnCount; i++) columns[i].State = i &lt;= progress ? ColumnState.Lit : ColumnState.Dimmed; columns?.ForceRedraw(); }</code> </pre> <br>  La iteraci√≥n sobre la colecci√≥n de <i>columnas</i> se realiza de forma peligrosa.  El desarrollador asumi√≥ que la referencia de <i>columnas</i> podr√≠a ser nula, lo que se indica mediante el uso del operador de acceso condicional para acceder a la colecci√≥n m√°s adelante en el c√≥digo. <br><br>  <a href="https://www.viva64.com/en/w/v3119/">V3119</a> Llamar al evento anulado 'OnNewResult' puede conducir a un comportamiento impredecible.  Considere implementar accesores de eventos expl√≠citamente o use una palabra clave 'sellada'  DrawableRuleset.cs 256 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addHitObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TObject hitObject</span></span></span><span class="hljs-function">)</span></span> { .... drawableObject.OnNewResult += (_, r) =&gt; OnNewResult?.Invoke(r); .... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;JudgementResult&gt; OnNewResult;</code> </pre> <br>  El analizador dice que es peligroso usar un evento anulado o virtual.  Consulte la <a href="https://www.viva64.com/en/w/v3119/">descripci√≥n</a> del diagn√≥stico para obtener una explicaci√≥n.  Tambi√©n escrib√≠ un art√≠culo sobre este tema: " <a href="https://www.viva64.com/en/b/0453/">Eventos virtuales en C #: algo sali√≥ mal</a> ". <br><br>  Aqu√≠ hay otra construcci√≥n insegura similar: <br><br><ul><li>  V3119 Llamar a un evento anulado puede conducir a un comportamiento impredecible.  Considere implementar accesores de eventos expl√≠citamente o use una palabra clave 'sellada'  DrawableRuleset.cs 257 </li></ul><br>  <a href="https://www.viva64.com/en/w/v3123/">V3123</a> [CWE-783] Quiz√°s el '??'  El operador funciona de una manera diferente a la esperada.  Su prioridad es inferior a la prioridad de otros operadores en su parte izquierda.  OsuScreenStack.cs 45 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * ((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>; }</code> </pre> <br>  Para una mejor comprensi√≥n, aqu√≠ hay un ejemplo sint√©tico que demuestra la l√≥gica original de este c√≥digo: <br><br><pre> <code class="cs hljs">x = (c * a) ?? b;</code> </pre> <br>  El error se debe al hecho de que la precedencia del operador "*" es mayor que la del "??"  operador  As√≠ es como deber√≠a verse el c√≥digo fijo (con par√©ntesis agregados): <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * (((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>); }</code> </pre> <br>  Otro error similar: <br><br>  <a href="https://www.viva64.com/en/w/v3123/">V3123</a> [CWE-783] Quiz√°s el '??'  El operador funciona de una manera diferente a la esperada.  Su prioridad es inferior a la prioridad de otros operadores en su parte izquierda.  FramedReplayInputHandler.cs 103 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime - NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  Como en el caso anterior, el programador ten√≠a suposiciones err√≥neas sobre la precedencia de los operadores.  La expresi√≥n original pasada al m√©todo <i>Math.Abs</i> se eval√∫a de la siguiente manera: <br><br><pre> <code class="cs hljs">(a ‚Äì b) ?? <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  As√≠ es como se debe solucionar: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime ‚Äì (NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>)) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  <a href="https://www.viva64.com/en/w/v3142/">V3142</a> [CWE-561] C√≥digo inalcanzable detectado.  Es posible que haya un error presente.  DrawableHoldNote.cs 214 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnPressed(action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Result.Type == HitResult.Miss) <span class="hljs-comment"><span class="hljs-comment">// &lt;= holdNote.hasBroken = true; .... }</span></span></code> </pre> <br>  El analizador cree que el c√≥digo del controlador <i>OnPressed</i> es inalcanzable a partir de la segunda instrucci√≥n <i>if</i> .  Esto se deduce del hecho de que la primera condici√≥n siempre es verdadera, es decir, que el m√©todo <i>base.OnPressed</i> siempre devolver√° <i>falso</i> .  Echemos un vistazo a la <i>base.</i> M√©todo <i>OnPressed</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (action != Action.Value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UpdateResult(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> <br>  Y ahora en el m√©todo <i>UpdateResult</i> : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userTriggered</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Time.Elapsed &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Judged) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Judged; }</code> </pre> <br>  Tenga en cuenta que la implementaci√≥n de la propiedad <i>Judged</i> no importa aqu√≠ porque la l√≥gica del m√©todo <i>UpdateResult</i> implica que la √∫ltima declaraci√≥n de <i>devoluci√≥n</i> es equivalente a lo siguiente: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br>  Esto significa que el m√©todo <i>UpdateResult</i> devolver√° <i>false</i> todo el tiempo, lo que provocar√° un problema de c√≥digo inalcanzable anteriormente en la pila. <br><br>  <a href="https://www.viva64.com/en/w/v3146/">V3146</a> [CWE-476] Posible desreferencia nula del 'conjunto de reglas'.  'FirstOrDefault' puede devolver un valor nulo predeterminado.  APILegacyScoreInfo.cs 24 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ScoreInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateScoreInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RulesetStore rulesets</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ruleset = rulesets.GetRuleset(OnlineRulesetID); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mods = Mods != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? ruleset.CreateInstance() <span class="hljs-comment"><span class="hljs-comment">// &lt;= .GetAllMods().Where(....) .ToArray() : Array.Empty&lt;Mod&gt;(); .... }</span></span></code> </pre> <br>  El analizador cree que la llamada al conjunto de reglas. <i>CreateInstance ()</i> no es segura.  Antes de esta llamada, a la variable de <i>conjunto de reglas</i> se le asigna un valor como resultado de llamar al m√©todo <i>GetRuleset</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RulesetInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRuleset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> =&gt; AvailableRulesets.FirstOrDefault(....);</code> </pre> <br>  Como puede ver, la advertencia es v√°lida ya que la secuencia de llamadas incluye el m√©todo <i>FirstOrDefault</i> , que puede devolver <i>nulo</i> . <br><br><h2>  Conclusi√≥n </h2><br>  No hay muchos errores en el c√≥digo de "osu!", Y eso es bueno.  Pero a√∫n as√≠ recomiendo que los autores verifiquen los problemas informados por el analizador.  Espero que esto ayude a mantener la alta calidad y el juego continuar√° brindando alegr√≠a a los jugadores. <br><br>  Como recordatorio, PVS-Studio es una buena opci√≥n si le gusta jugar con el c√≥digo fuente.  El analizador est√° disponible para <a href="https://www.viva64.com/en/pvs-studio-download/">descargar</a> en el sitio web oficial.  Otra cosa que me gustar√≠a tener en cuenta es que las comprobaciones √∫nicas como esta no tienen nada que ver con el uso normal del an√°lisis est√°tico en el proceso de desarrollo real.  Es m√°s efectivo solo cuando se usa regularmente tanto en el servidor de compilaci√≥n como en las computadoras de los desarrolladores (esto se llama an√°lisis incremental).  Su objetivo final es evitar que los errores entren en el sistema de control de versiones al atraparlos en la etapa de codificaci√≥n. <br><br>  ¬°Buena suerte y mantente creativo! <br><br><h2>  Referencias </h2><br>  Este es nuestro primer art√≠culo en 2020. Mientras lo hacemos, aqu√≠ est√°n los enlaces a los controles de los proyectos de C # realizados durante el a√±o pasado: <br><br><ul><li>  <a href="https://www.viva64.com/en/b/0605/">B√∫squeda de errores en el c√≥digo fuente del SDK de Amazon Web Services para .NET</a> </li><li>  <a href="https://www.viva64.com/en/b/0622/">Comprobaci√≥n del c√≥digo fuente de Roslyn</a> </li><li>  <a href="https://www.viva64.com/en/b/0631/">Tipos de referencia anulables en C # 8.0 y an√°lisis est√°tico</a> </li><li>  <a href="https://www.viva64.com/en/b/0653/">WinForms: Errores, Holmes</a> </li><li>  <a href="https://www.viva64.com/en/b/0654/">La historia de c√≥mo PVS-Studio encontr√≥ un error en la biblioteca utilizada en ... PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0656/">Comprobaci√≥n del c√≥digo fuente de las bibliotecas principales de .NET con el analizador est√°tico PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0664/">Comprobaci√≥n de analizadores roslyn</a> </li><li>  <a href="https://www.viva64.com/en/b/0677/">Verificaci√≥n de la interfaz de usuario de Telerik para UWP como una forma de comenzar con PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0678/">Azure PowerShell: mayormente inofensivo</a> </li><li>  <a href="https://www.viva64.com/en/b/0681/">Escaneando el c√≥digo de Orchard CMS en busca de errores</a> </li><li>  <a href="https://www.viva64.com/en/b/0683/">Comprobaci√≥n del OpenCvSharp Wrapper para OpenCV con PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0692/">Azure SDK para .NET: historia sobre una b√∫squeda de errores dif√≠cil</a> </li><li>  <a href="https://www.viva64.com/en/b/0694/">SDK de SARIF y sus errores</a> </li><li>  <a href="https://www.viva64.com/en/b/0698/">Los 10 errores principales encontrados en proyectos de C # en 2019</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/483436/">https://habr.com/ru/post/483436/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../483416/index.html">Intentando automatizar procesos usando Powershell</a></li>
<li><a href="../483418/index.html">Sistemas de tickets: ¬øc√≥mo obtuvo tres OTRS gratuitos pagados?</a></li>
<li><a href="../483424/index.html">DBA: transferencia de valores de SECUENCIA entre bases de datos PostgreSQL</a></li>
<li><a href="../483426/index.html">Encuesta de pesta√±a del viernes</a></li>
<li><a href="../483428/index.html">¬øCu√°l ser√° la gesti√≥n de documentos electr√≥nicos despu√©s de la entrada en vigor de las enmiendas a la ley de firma electr√≥nica?</a></li>
<li><a href="../483438/index.html">Juega "osu!", No te olvides de los errores</a></li>
<li><a href="../483440/index.html">√öltimos compiladores de D</a></li>
<li><a href="../483444/index.html">Informe DORA 2019: C√≥mo mejorar el rendimiento de DevOps</a></li>
<li><a href="../483446/index.html">Los cient√≠ficos han encontrado una nueva forma de reducir los niveles de hierro en el agua potable</a></li>
<li><a href="../483448/index.html">Disney: el mejor bidireccional de la historia humana</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>