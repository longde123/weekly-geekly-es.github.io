<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê´ üéè üë∑üèº Google Drive comme stockage pour une application Web üíØ ü•í üßïüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©face 
 Mon application Web stocke des donn√©es dans localStorage . C'√©tait pratique jusqu'√† ce que je veuille que l'utilisateur voit la m√™me chose l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Google Drive comme stockage pour une application Web</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440844/"><h1>  Pr√©face </h1><br>  Mon application Web stocke des donn√©es dans <code>localStorage</code> .  C'√©tait pratique jusqu'√† ce que je veuille que l'utilisateur voit la m√™me chose lorsqu'il acc√®de au site √† partir de diff√©rents appareils.  Autrement dit, un stockage √† distance √©tait n√©cessaire. <br><br>  Mais l'application est "h√©berg√©e" sur les pages GitHub et n'a pas de partie serveur.  J'ai d√©cid√© de ne pas cr√©er de serveur, mais de stocker les donn√©es avec un tiers.  Cela donne des avantages importants: <br><br><ol><li>  Pas besoin de payer pour le serveur, cela ne fait pas de mal √† la t√™te quant √† sa stabilit√© et sa disponibilit√©. </li><li>  Moins de code, moins d'erreurs. </li><li>  L'utilisateur n'a pas besoin de s'inscrire dans mon application (c'est g√™nant pour beaucoup). </li><li>  La confidentialit√© est plus √©lev√©e et l'utilisateur sait que ses donn√©es sont stock√©es dans un endroit auquel il fait probablement plus confiance que moi. </li></ol><br>  Tout d'abord, le choix s'est <a href="">port√©</a> sur <a href="">remoteStorage.js</a> .  Ils offrent un protocole d'√©change de donn√©es ouvert, une tr√®s jolie API, la possibilit√© de s'int√©grer √† Google Drive et Dropbox, ainsi qu'√† leurs serveurs.  Mais ce chemin s'est av√©r√© √™tre une impasse (pourquoi - une histoire distincte). <br><br>  Au final, j'ai d√©cid√© d'utiliser directement Google Drive et la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">biblioth√®que cliente Google API</a> (ci-apr√®s GAPI) comme biblioth√®que pour y acc√©der. <br><br>  Malheureusement, la documentation de Google est d√©cevante, et la biblioth√®que GAPI semble inachev√©e, d'ailleurs, elle a plusieurs versions, et on ne sait pas toujours laquelle est en cause.  Par cons√©quent, la solution √† mes probl√®mes devait √™tre collect√©e en morceaux √† partir de la documentation, des questions et des r√©ponses sur StackOverflow et des publications al√©atoires sur Internet. <br><br>  J'esp√®re que cet article vous fera gagner du temps si vous d√©cidez d'utiliser Google Drive dans votre application. <br><a name="habracut"></a><br><h1>  La pr√©paration </h1><br>  Voici une description de la fa√ßon d'obtenir des cl√©s pour travailler avec l'API Google.  Si vous n'√™tes pas int√©ress√©, passez directement √† la partie suivante. <br><br><div class="spoiler">  <b class="spoiler_title">R√©ception des cl√©s</b> <div class="spoiler_text">  Dans la console d√©veloppeur de Google, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cr√©ez un</a> nouveau projet, entrez un nom. <br><br>  Dans le "Panneau de configuration", cliquez sur "Activer l'API et les services" et activez Google Drive. <br><br>  Ensuite, acc√©dez √† la section API et services -&gt; Informations d'identification, cliquez sur "Cr√©er des informations d'identification".  Il y a trois choses que vous devez faire: <br><br><ol><li>  Configurez la "fen√™tre de demande d'acc√®s OAuth".  Entrez le nom de l'application, votre domaine dans la section "Domaines autoris√©s" et un lien vers la page principale de l'application.  Les autres champs sont facultatifs. <br></li><li>  Dans la section "Informations d'identification", cliquez sur "Cr√©er des informations d'identification" -&gt; "Identifiant client OAuth".  S√©lectionnez le type ¬´Application Web¬ª.  Dans la fen√™tre des param√®tres, ajoutez "Sources Javascript autoris√©es" et "URI de redirection autoris√©es": <br><ul><li>  Votre domaine (obligatoire) <br></li><li>  <code>http://localhost:8000</code> (facultatif pour travailler localement). <br></li></ul><br><img src="https://habrastorage.org/webt/gg/rv/hc/ggrvhc5j0yclrw6brc5ij0uaape.png"><br></li><li>  Dans la section "Informations d'identification", cliquez sur "Cr√©er des informations d'identification" -&gt; "Cl√© API".  Dans les param√®tres cl√©s, sp√©cifiez les restrictions: <br><ul><li>  Type d'application autoris√© -&gt; r√©f√©rents HTTP (sites Web) <br></li><li>  Acceptez les demandes http provenant des sources de r√©f√©rence (sites) suivantes -&gt; votre domaine et votre h√¥te local (comme au point 2). <br></li><li>  API valides -&gt; API Google Drive <br></li></ul><br><img src="https://habrastorage.org/webt/rj/uo/26/rjuo26cmoytw5p9up_xcbrpy270.png"><br></li></ol><br>  La section des informations d'identification doit ressembler √† ceci: <br><br><img src="https://habrastorage.org/webt/fa/9i/he/fa9ihekdcod48ffftoavoyhejbe.png"><br><br>  Nous y voil√†.  Nous passons au code. <br></div></div><br><h1>  Initialisation et connexion </h1><br>  La m√©thode recommand√©e par Google pour activer GAPI est de coller le code suivant dans votre code HTML: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://apis.google.com/js/api.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onload</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"this.onload=function(){}; gapi.load('client:auth2', initClient)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onreadystatechange</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"if (this.readyState === 'complete') this.onload()"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Apr√®s avoir charg√© la biblioth√®que, la fonction <code>initClient</code> sera appel√©e, que nous devons √©crire nous-m√™mes.  Son aspect typique est le suivant: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initClient</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ gapi.client.init({ <span class="hljs-comment"><span class="hljs-comment">//   API apiKey: GOOGLE_API_KEY, //    clientId: GOOGLE_CLIENT_ID, // ,     Google Drive API v3 discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'], //    application data folder (. ) scope: 'https://www.googleapis.com/auth/drive.appfolder' }).then(() =&gt; { //    / (. ) gapi.auth2.getAuthInstance().isSignedIn.listen(onSignIn) //   initApp() }, error =&gt; { console.log('Failed to init GAPI client', error) //    initApp({showAlert: 'google-init-failed-alert'}) }) }</span></span></code> </pre> <br>  Pour le stockage des donn√©es, nous utiliserons le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dossier des donn√©es d'application</a> .  Ses avantages par rapport √† un dossier ordinaire: <br><br><ol><li>  L'utilisateur ne le voit pas directement: les fichiers qu'il contient n'obstruent pas son espace personnel et il ne peut pas ruiner nos donn√©es. </li><li>  D'autres applications ne le voient pas et ne peuvent pas non plus le g√¢cher. </li><li>  La port√©e, mentionn√©e ci-dessus, donne acc√®s √† l'application, mais ne donne pas acc√®s au reste des fichiers de l'utilisateur.  Autrement dit, nous n'effrayerons pas une personne par des demandes d'acc√®s √† ses donn√©es personnelles. </li></ol><br>  Une fois l'initialisation de l'API Google r√©ussie, la fonction effectue les op√©rations suivantes: <br><br><ol><li>  Commence √† attraper les √©v√©nements de connexion / d√©connexion - tr√®s probablement, cela devrait toujours √™tre fait. </li><li>  Initialise l'application.  Cela peut √™tre fait avant de charger et d'initialiser GAPI - comme vous pr√©f√©rez.  Ma proc√©dure d'initialisation √©tait l√©g√®rement diff√©rente si Google n'√©tait pas disponible.  Quelqu'un peut dire que cela ne se produit pas :) Mais, tout d'abord, vous pouvez √™tre intelligent avec les cl√©s et les droits d'acc√®s √† l'avenir.  Deuxi√®mement, par exemple, en Chine, Google est interdit. </li></ol><br>  La connexion et la d√©connexion se font simplement: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isGapiLoaded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> gapi &amp;&amp; gapi.auth2 } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logIn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isGapiLoaded()) { <span class="hljs-comment"><span class="hljs-comment">//    Google    gapi.auth2.getAuthInstance().signIn() } } function logOut() { if (isGapiLoaded()) { gapi.auth2.getAuthInstance().signOut() } }</span></span></code> </pre> <br>  Vous recevrez les r√©sultats de connexion dans le gestionnaire <code>onSignIn</code> : <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isLoggedIn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> isGapiLoaded() &amp;&amp; gapi.auth2.getAuthInstance().isSignedIn.get() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSignIn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isLoggedIn()) { <span class="hljs-comment"><span class="hljs-comment">//   } else { //   } //   .    "" }</span></span></code> </pre> <br>  Malheureusement, travailler avec des fichiers n'est pas si √©vident. <br><br><h1>  Aide √† la promesse </h1><br>  GAPI ne renvoie pas de promesses normales.  Au lieu de cela, sa propre interface Thennable est utilis√©e, ce qui est similaire aux promesses, mais pas tout √† fait.  Par cons√©quent, pour la commodit√© du travail (principalement pour utiliser <code>async/await</code> ), nous ferons un petit assistant: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prom</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">gapiCall, argObj</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { gapiCall(argObj).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resp</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resp &amp;&amp; (resp.status &lt; <span class="hljs-number"><span class="hljs-number">200</span></span> || resp.status &gt; <span class="hljs-number"><span class="hljs-number">299</span></span>)) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'GAPI call returned bad status'</span></span>, resp) reject(resp) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { resolve(resp) } }, err =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'GAPI call failed'</span></span>, err) reject(err) }) }) }</code> </pre> <br>  Cette fonction prend la m√©thode GAPI et les param√®tres comme premier argument et renvoie Promise.  Ensuite, vous verrez comment l'utiliser. <br><br><h1>  Travailler avec des fichiers </h1><br>  Vous devez toujours vous rappeler que <b>le nom de fichier sur Google Drive n'est pas unique</b> .  Vous pouvez cr√©er un nombre illimit√© de fichiers et de dossiers portant le m√™me nom.  Seul l'identifiant est unique. <br><blockquote>  Pour les t√¢ches de base, vous n'avez pas besoin de travailler avec des dossiers, donc toutes les fonctions ci-dessous fonctionnent avec des fichiers √† la racine du dossier Application Data.  Les commentaires indiquent ce qui doit √™tre modifi√© pour fonctionner avec les dossiers.  La documentation de Google est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </blockquote><h2>  Cr√©er un fichier vide </h2><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createEmptyFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name, mimeType</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> resp = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> prom(gapi.client.drive.files.create, { <span class="hljs-attr"><span class="hljs-attr">resource</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: name, <span class="hljs-comment"><span class="hljs-comment">//     // mimeType = 'application/vnd.google-apps.folder' mimeType: mimeType || 'text/plain', //  'appDataFolder'   ID  parents: ['appDataFolder'] }, fields: 'id' }) //    ‚Äî    return resp.result.id }</span></span></code> </pre> <br>  Cette fonction asynchrone cr√©e un fichier vide et retourne son identifiant (cha√Æne).  Si un tel fichier existe d√©j√†, un nouveau fichier du m√™me nom sera cr√©√© et son ID sera retourn√©.  Si vous ne le souhaitez pas, vous devez d'abord v√©rifier qu'il n'y a pas de fichier du m√™me nom (voir ci-dessous). <br><blockquote>  Google Drive n'est pas une base de donn√©es compl√®te.  Par exemple, si vous souhaitez que plusieurs utilisateurs travaillent <b>simultan√©ment</b> √† partir du m√™me compte Google √† partir de diff√©rents appareils, il peut y avoir des probl√®mes de r√©solution des conflits en raison du manque de transactions.  Pour de telles t√¢ches, il est pr√©f√©rable de ne pas utiliser Google Drive. </blockquote><h2>  Travailler avec le contenu des fichiers </h2><br>  GAPI (pour JavaScript bas√© sur un navigateur) ne fournit pas de m√©thodes pour travailler avec le contenu des fichiers (tr√®s √©trange, n'est-ce pas?).  Au lieu de cela, il existe une m√©thode de <code>request</code> g√©n√©rale (un wrapper fin sur une simple requ√™te AJAX). <br><br>  Par essais et erreurs, je suis arriv√© aux impl√©mentations suivantes: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">upload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fileId, content</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    ,  ,     JSON return prom(gapi.client.request, { path: `/upload/drive/v3/files/${fileId}`, method: 'PATCH', params: {uploadType: 'media'}, body: typeof content === 'string' ? content : JSON.stringify(content) }) } async function download(fileId) { const resp = await prom(gapi.client.drive.files.get, { fileId: fileId, alt: 'media' }) // resp.body      // resp.result ‚Äî    resp.body  JSON. //   ,  resp.result  false // ..    ,   return resp.result || resp.body }</span></span></code> </pre><br><h2>  Recherche de fichiers </h2><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">query</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> ret = [] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> token <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> resp = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> prom(gapi.client.drive.files.list, { <span class="hljs-comment"><span class="hljs-comment">//  'appDataFolder'   ID  spaces: 'appDataFolder', fields: 'files(id, name), nextPageToken', pageSize: 100, pageToken: token, orderBy: 'createdTime', q: query }) ret = ret.concat(resp.result.files) token = resp.result.nextPageToken } while (token) // :    [{id: '...', name: '...'}], //     return ret }</span></span></code> </pre> <br>  Cette fonction, si vous ne sp√©cifiez pas de <code>query</code> , renvoie tous les fichiers du dossier d'application (un tableau d'objets avec des champs <code>id</code> et <code>name</code> ), tri√©s par heure de cr√©ation. <br><br>  Si vous sp√©cifiez la cha√Æne de <code>query</code> (la syntaxe est d√©crite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ), elle renverra uniquement les fichiers correspondant √† la requ√™te.  Par exemple, pour v√©rifier si un fichier nomm√© <code>config.json</code> , vous devez faire <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> find(<span class="hljs-string"><span class="hljs-string">'name = "config.json"'</span></span>)).length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// ()  }</span></span></code> </pre><br><h2>  Suppression de fichiers </h2><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fileId</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> prom(gapi.client.drive.files.delete, { <span class="hljs-attr"><span class="hljs-attr">fileId</span></span>: fileId }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err.status === <span class="hljs-number"><span class="hljs-number">404</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> err } }</code> </pre> <br>  Cette fonction supprime le fichier par ID et renvoie <code>true</code> s'il a √©t√© supprim√© avec succ√®s et <code>false</code> s'il n'y avait pas un tel fichier. <br><br><h1>  Sync </h1><br>  Il est conseill√© que le programme fonctionne principalement avec <code>localStorage</code> , et Google Drive est utilis√© uniquement pour synchroniser les donn√©es de <code>localStorage</code> . <br><br>  Voici une strat√©gie de synchronisation de configuration simple: <br><br><ol><li>  La nouvelle configuration est t√©l√©charg√©e √† partir de Google Drive avec un identifiant, puis toutes les 3 minutes, en √©crasant la copie locale; </li><li>  Les modifications locales sont vers√©es sur Google Drive, √©crasant ce qui s'y trouvait; </li><li>  le <code>fileID</code> configuration <code>fileID</code> est mis en cache dans <code>localStorage</code> pour acc√©l√©rer le travail et r√©duire le nombre de demandes; </li><li>  Les situations correctement g√©r√©es (erron√©es) sont lorsque Google Drive poss√®de plusieurs fichiers de configuration et que quelqu'un a supprim√© notre fichier de configuration ou l'a ruin√©. </li><li>  Les d√©tails de la synchronisation n'affectent pas le reste du code d'application.  Pour travailler avec la configuration, vous n'utilisez que deux fonctions: <code>getConfig()</code> et <code>saveConfig(newConfig)</code> . </li></ol><br>  Dans une application r√©elle, vous souhaiterez probablement impl√©menter une gestion des conflits plus flexible lors du chargement / d√©chargement d'une configuration. <br><br><div class="spoiler">  <b class="spoiler_title">Afficher le code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     const SYNC_PERIOD = 1000 * 60 * 3 // 3  //    const DEFAULT_CONFIG = { // ... } //  ID  ,      let configSyncTimeoutId async function getConfigFileId() { //  configFileId let configFileId = localStorage.getItem('configFileId') if (!configFileId) { //     Google Drive const configFiles = await find('name = "config.json"') if (configFiles.length &gt; 0) { //   (  )  configFileId = configFiles[0].id } else { //   configFileId = await createEmptyFile('config.json') } //  ID localStorage.setItem('configFileId', configFileId) } return configFileId } async function onSignIn() { //   / (. ) if (isLoggedIn()) { //   //  (  -?)    scheduleConfigSync(0) } else { //   //          //   config file ID localStorage.removeItem('configFileId') //  localStorage   ,    } } function getConfig() { let ret try { ret = JSON.parse(localStorage.getItem('config')) } catch(e) {} //    ,    return ret || {...DEFAULT_CONFIG} } async function saveConfig(newConfig) { //    ,     localStorage.setItem('config', JSON.stringify(newConfig)) if (isLoggedIn()) { //  config file ID const configFileId = await getConfigFileId() //     Google Drive upload(configFileId, newConfig) } } async function syncConfig() { if (!isLoggedIn()) { return } //  config file ID const configFileId = await getConfigFileId() try { //   const remoteConfig = await download(configFileId) if (!remoteConfig || typeof remoteConfig !== 'object') { //    ,   upload(configFileId, getConfig()) } else { //  ,    localStorage.setItem('config', JSON.stringify(remoteConfig)) } //  ,  localStorage   } catch(e) { if (e.status === 404) { // -   ,   fileID     localStorage.removeItem('configFileId') syncConfig() } else { throw e } } } function scheduleConfigSync(delay) { //   ,    if (configSyncTimeoutId) { clearTimeout(configSyncTimeoutId) } configSyncTimeoutId = setTimeout(() =&gt; { //      syncConfig() .catch(e =&gt; console.log('Failed to synchronize config', e)) .finally(() =&gt; scheduleSourcesSync()) }, typeof delay === 'undefined' ? SYNC_PERIOD : delay) } function initApp() { //      scheduleConfigSync() }</span></span></code> </pre><br></div></div><br><h1>  Conclusion </h1><br>  Il me semble que le magasin de donn√©es d'un site Web sur Google Drive est id√©al pour les petits projets et le prototypage.  Il est non seulement facile √† mettre en ≈ìuvre et √† prendre en charge, mais contribue √©galement √† r√©duire le nombre d'entit√©s inutiles dans l'univers.  Et mon article, je l'esp√®re, vous aidera √† gagner du temps si vous choisissez ce chemin. <br><br>  <b>PS</b> Le code du vrai projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">se trouve sur GitHub</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vous pouvez l'</a> essayer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr440844/">https://habr.com/ru/post/fr440844/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr440832/index.html">Snapdragon 855: plate-forme mobile pour la 5G, l'IA et la r√©alit√© augment√©e</a></li>
<li><a href="../fr440834/index.html">Conf√©rence DUMP-2019: nous vous invitons √† prendre la parole dans les sections DevOps et Mobile</a></li>
<li><a href="../fr440836/index.html">Protection logicielle contre la copie et le piratage: m√©thodes et strat√©gies de base</a></li>
<li><a href="../fr440838/index.html">Comment nous avons choisi un syst√®me DLP (exp√©rience pratique)</a></li>
<li><a href="../fr440842/index.html">Le livre ¬´Comment g√©rer les intellectuels. I, nerds and geeks "</a></li>
<li><a href="../fr440846/index.html">Minuterie de performance</a></li>
<li><a href="../fr440848/index.html">Le mod√®le d'un noyau solide sans coquilles √©lectroniques, c'est-√†-dire que le noyau est √©gal √† l'atome entier en taille</a></li>
<li><a href="../fr440850/index.html">L'anglais en Inde: une excursion historique</a></li>
<li><a href="../fr440852/index.html">Pourquoi les jeunes am√©ricains pr√©tendent-ils aimer travailler</a></li>
<li><a href="../fr440854/index.html">Des mineurs de crypto ont infiltr√© le Microsoft Store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>