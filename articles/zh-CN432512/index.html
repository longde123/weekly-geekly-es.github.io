<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ’¦ ğŸ¼ ğŸ‘©ğŸ¾â€ğŸ¤â€ğŸ‘©ğŸ½ PostgreSQLï¼šPipelineDB-å®æ—¶èšåˆæŸ¥è¯¢ ğŸ¦ ğŸš½ ğŸ‘©ğŸ¼â€ğŸ’»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æ˜¯å¦æ›¾æœ‰äººè¦æ±‚æ‚¨æ ¹æ®ä¸Šä¸ªæœˆæ•°æ®åº“ä¸­çš„æ•°æ®æ¥è®¡ç®—æŸç‰©çš„æ•°é‡ï¼Œå°†ç»“æœæŒ‰ä¸€äº›å€¼åˆ†ç»„ï¼Œç„¶åæŒ‰å¤©/å°æ—¶å°†å…¶ç»†åˆ†ï¼Ÿ 
 å¦‚æœæ˜¯ï¼Œé‚£ä¹ˆæ‚¨å·²ç»æƒ³è±¡è¿‡å¿…é¡»å†™è¿™æ ·çš„ä¸œè¥¿ï¼Œåªä¼šæ›´ç³Ÿ 



SELECT hour(datetime), somename, count(*), sum(somemetric) from ta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PostgreSQLï¼šPipelineDB-å®æ—¶èšåˆæŸ¥è¯¢</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432512/"> æ˜¯å¦æ›¾æœ‰äººè¦æ±‚æ‚¨æ ¹æ®ä¸Šä¸ªæœˆæ•°æ®åº“ä¸­çš„æ•°æ®æ¥è®¡ç®—æŸç‰©çš„æ•°é‡ï¼Œå°†ç»“æœæŒ‰ä¸€äº›å€¼åˆ†ç»„ï¼Œç„¶åæŒ‰å¤©/å°æ—¶å°†å…¶ç»†åˆ†ï¼Ÿ <br> å¦‚æœæ˜¯ï¼Œé‚£ä¹ˆæ‚¨å·²ç»æƒ³è±¡è¿‡å¿…é¡»å†™è¿™æ ·çš„ä¸œè¥¿ï¼Œåªä¼šæ›´ç³Ÿ <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">hour</span></span>(datetime), somename, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*), <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(somemetric) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime &gt; :monthAgo <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br> æœ‰æ—¶ï¼Œå„ç§å„æ ·çš„æ­¤ç±»è¯·æ±‚å¼€å§‹å‡ºç°ï¼Œå¦‚æœæ‚¨ä¸€æ¬¡å¿å—å¹¶æä¾›å¸®åŠ©ï¼Œå¯æƒœï¼Œå°†æ¥ä¼šå‘å‡ºä¸Šè¯‰ã€‚ <br><br> ä½†æ˜¯è¿™æ ·çš„è¯·æ±‚æ˜¯ä¸å¥½çš„ï¼Œå› ä¸ºå®ƒä»¬åœ¨è¿è¡Œæ—¶ä¼šå¤§é‡æ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œå¹¶ä¸”å¯èƒ½æœ‰å¤ªå¤šçš„æ•°æ®ï¼Œå³ä½¿æ˜¯æ­¤ç±»è¯·æ±‚çš„å‰¯æœ¬ä¹Ÿå¾ˆå¯æƒœï¼ˆåŠå…¶æ—¶é—´ï¼‰ã€‚ <br><br> ä½†æ˜¯ï¼Œå¦‚æœæˆ‘è¯´å¯¹äº†ï¼Œå°±å¯ä»¥åœ¨PostgreSQLä¸­åˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œä½¿å…¶ä»…åœ¨ç›´æ¥ç±»ä¼¼çš„æŸ¥è¯¢ä¸­ä»…è€ƒè™‘æ–°ä¼ å…¥çš„æ•°æ®ï¼Œå¦‚ä¸Šæ‰€è¿°å‘¢ï¼Ÿ <br><br> æ‰€ä»¥-å®ƒå¯ä»¥æ‰©å±•PipelineDB <br><br><div class="spoiler">  <b class="spoiler_title">ä»ä»–ä»¬çš„ç½‘ç«™æ¼”ç¤ºå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/kz/5x/mb/kz5xmbjf4yjqv_ogkuhnirwu-ve.gif"><br></div></div><br><a name="habracut"></a>  PipelineDBä»¥å‰æ˜¯ä¸€ä¸ªå•ç‹¬çš„é¡¹ç›®ï¼Œä½†ç°åœ¨å¯ä½œä¸ºPG 10.1åŠæ›´é«˜ç‰ˆæœ¬çš„æ‰©å±•ã€‚ <br><br> å°½ç®¡æä¾›çš„æœºä¼šåœ¨ä¸“é—¨è®¾è®¡ç”¨äºæ”¶é›†å®æ—¶æŒ‡æ ‡çš„å…¶ä»–äº§å“ä¸­æ—©å·²å­˜åœ¨ï¼Œä½†PipelineDBå…·æœ‰æ˜¾ç€çš„ä¼˜ç‚¹ï¼šå¯¹äºå·²ç»äº†è§£SQLçš„å¼€å‘äººå‘˜è€Œè¨€ï¼Œå…¥é—¨é—¨æ§›è¾ƒä½ã€‚ <br><br> ä¹Ÿè®¸å¯¹äºæŸäº›äººæ¥è¯´ä¸æ˜¯å¿…éœ€çš„ã€‚ å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘ä¸å¤ªæ„¿æ„å°è¯•æ‰€æœ‰ä¼¼ä¹é€‚åˆè§£å†³ç‰¹å®šé—®é¢˜çš„æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä¸ä¼šç«‹å³é‡‡å–è¡ŒåŠ¨é’ˆå¯¹æ‰€æœ‰æƒ…å†µä½¿ç”¨ä¸€ç§æ–°çš„è§£å†³æ–¹æ¡ˆã€‚ å› æ­¤ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä¸æ•¦ä¿ƒåˆ é™¤æ‰€æœ‰å†…å®¹å¹¶ç«‹å³å®‰è£…PipelineDBï¼Œè¿™åªæ˜¯ä¸»è¦åŠŸèƒ½çš„æ¦‚è¿°ï¼Œå› ä¸º è¿™ä»¶äº‹å¯¹æˆ‘æ¥è¯´ä¼¼ä¹å¾ˆå¥½å¥‡ã€‚ <br><br> å› æ­¤ï¼Œæ€»çš„æ¥è¯´ï¼Œä»–ä»¬æœ‰å¾ˆå¥½çš„æ–‡æ¡£ï¼Œä½†æ˜¯æˆ‘æƒ³åˆ†äº«æˆ‘çš„ç»éªŒï¼Œä»¥å®è·µæ–¹å¼å°è¯•è¿™é¡¹ä¸šåŠ¡å¹¶å°†ç»“æœå¸¦ç»™Grafanaã€‚ <br><br> ä¸ºäº†ä¸ä¹±æ‰”æœ¬åœ°è®¡ç®—æœºï¼Œæˆ‘å°†æ‰€æœ‰å†…å®¹éƒ½éƒ¨ç½²åœ¨dockerä¸­ã€‚ <br> ä½¿ç”¨çš„å›¾åƒï¼š <code>postgres:latest</code> ï¼Œ <code>grafana/grafana</code> <br><br><h3> åœ¨Postgresä¸Šå®‰è£…PipelineDB </h3><br> åœ¨å…·æœ‰postgresçš„è®¡ç®—æœºä¸Šï¼ŒæŒ‰é¡ºåºæ‰§è¡Œï¼š <br><br><ol><li> <code>apt update</code> </li> <li> <code>apt install curl</code> </li> <li> <code>curl -s http://download.pipelinedb.com/apt.sh | bash</code> </li> <li> <code>apt install pipelinedb-postgresql-11</code> </li> <li> <code>cd /var/lib/postgresql/data</code> </li> <li> åœ¨ä»»ä½•ç¼–è¾‘å™¨ä¸­æ‰“å¼€<code>postgresql.conf</code>æ–‡ä»¶ </li><li> æŸ¥æ‰¾<code>shared_preload_libraries</code>é”®ï¼Œå–æ¶ˆæ³¨é‡Šå¹¶è®¾ç½®<code>pipelinedb</code>å€¼ </li><li> å…³é”®<code>max_worker_processes</code>è®¾ç½®ä¸º128ï¼ˆæ¨è<code>max_worker_processes</code> ï¼‰ </li><li> é‡æ–°å¯åŠ¨æœåŠ¡å™¨ </li></ol><br><h3> åœ¨PipelineDBä¸­åˆ›å»ºæµå’Œè§†å›¾ </h3><br><div class="spoiler">  <b class="spoiler_title">é‡æ–°å¯åŠ¨pgå-è§‚å¯Ÿæ—¥å¿—ï¼Œä»¥ä¾¿æœ‰è¿™æ ·çš„äº‹æƒ…</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xc/6i/dz/xc6idzmydyyu2qgvpu7emd7aj2i.png"><br></div></div><br><ol><li> æˆ‘ä»¬å°†åœ¨å…¶ä¸­å·¥ä½œçš„æ•°æ®åº“ï¼š <code>CREATE DATABASE testpipe;</code> </li><li> åˆ›å»ºæ‰©å±•ï¼š <code>CREATE EXTENSION pipelinedb;</code> </li><li> ç°åœ¨ï¼Œæœ€æœ‰è¶£çš„æ˜¯åˆ›å»ºæµã€‚ æ‚¨éœ€è¦åœ¨å…¶ä¸­æ·»åŠ æ•°æ®ä»¥è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> flow_stream ( dtmsk <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> zone, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span> pipelinedb;</code> </pre> <br> å®é™…ä¸Šï¼Œè¿™ä¸åˆ›å»ºæ™®é€šè¡¨éå¸¸ç›¸ä¼¼ï¼Œæ‚¨ä¸èƒ½ä»…é€šè¿‡ç®€å•çš„<code>select</code>å°±å¯ä»¥ä»æ­¤æµä¸­è·å–æ•°æ®-æ‚¨éœ€è¦ä¸€ä¸ªè§†å›¾ </li><li> å®é™…å¦‚ä½•åˆ›å»ºå®ƒï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> viewflow <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (ttl = <span class="hljs-string"><span class="hljs-string">'3 month'</span></span>, ttl_column = <span class="hljs-string"><span class="hljs-string">'m'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span>(dtmsk) m, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*), <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flow_stream <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> <br> å®ƒä»¬è¢«ç§°ä¸ºâ€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿ç»­è§†å›¾â€</a> ï¼Œé»˜è®¤ä¸ºå®ç°ï¼Œå³ ä¿ç•™å›½å®¶ã€‚ <br><br>  <code>WITH</code>ä¼ é€’å…¶ä»–å‚æ•°ã€‚ <br><br> åœ¨æˆ‘çš„æƒ…å†µä¸‹ï¼Œ <code>ttl = '3 month'</code>æ„å‘³ç€æ‚¨åªéœ€è¦å­˜å‚¨æœ€è¿‘3ä¸ªæœˆçš„æ•°æ®ï¼Œå¹¶ä»<code>M</code>åˆ—è·å–æ—¥æœŸ/æ—¶é—´<code>M</code> åå°<code>reaper</code>ç¨‹åº<code>reaper</code>è¿‡æ—¶çš„æ•°æ®å¹¶å°†å…¶åˆ é™¤ã€‚ <br><br> å¯¹äºé‚£äº›ä¸çŸ¥é“çš„äººï¼Œ <code>minute</code>åŠŸèƒ½è¿”å›æ²¡æœ‰ç§’çš„æ—¥æœŸ/æ—¶é—´ã€‚ å› æ­¤ï¼Œç”±äºèšåˆï¼Œåœ¨ä¸€åˆ†é’Ÿå†…å‘ç”Ÿçš„æ‰€æœ‰äº‹ä»¶å°†å…·æœ‰ç›¸åŒçš„æ—¶é—´ã€‚ </li><li> è¿™ç§è§†å›¾å‡ ä¹æ˜¯ä¸€å¼ è¡¨ï¼Œå› ä¸ºå¦‚æœå­˜å‚¨äº†å¤§é‡æ•°æ®ï¼Œåˆ™æŒ‰æ—¥æœŸè¿›è¡Œç´¢å¼•çš„ç´¢å¼•å°†éå¸¸æœ‰ç”¨ <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> viewflow (m <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>);</code> </pre> </li></ol><br><h3> ä½¿ç”¨PipelineDB </h3><br> åˆ‡è®°ï¼šå°†æ•°æ®æ’å…¥æµä¸­ï¼Œå¹¶ä»è®¢é˜…å®ƒçš„è§†å›¾ä¸­è¯»å– <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> flow_stream <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">now</span></span>(), <span class="hljs-string"><span class="hljs-string">'act1'</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> flow_stream <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">now</span></span>(), <span class="hljs-string"><span class="hljs-string">'act2'</span></span>, <span class="hljs-number"><span class="hljs-number">33</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> viewflow <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> m <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>()</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">æˆ‘æ‰‹åŠ¨æ‰§è¡Œè¯·æ±‚</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/3j/rb/fy/3jrbfyanqdnf8uhrmwytpmippxa.gif"><br></div></div> é¦–å…ˆï¼Œæˆ‘çœ‹ç¬¬46åˆ†é’Ÿçš„æ•°æ®å˜åŒ– <br> ç¬¬47å·åˆ°æ¥æ—¶ï¼Œå‰ä¸€å·å°†åœæ­¢æ›´æ–°ï¼Œè€Œå½“å‰åˆ†é’Ÿå°†å¼€å§‹è®¡æ—¶ã€‚ <br><br> å¦‚æœæ‚¨æ³¨æ„æŸ¥è¯¢è®¡åˆ’ï¼Œåˆ™å¯ä»¥çœ‹åˆ°å¸¦æœ‰æ•°æ®çš„åŸå§‹è¡¨ <br><br><img src="https://habrastorage.org/webt/z8/pm/fd/z8pmfdnqxflibrane_hjpmyxupa.png"><br><br> æˆ‘å»ºè®®æ‚¨å»äº†è§£ä¸€ä¸‹å¦‚ä½•çœŸæ­£å­˜å‚¨æ‚¨çš„æ•°æ® <br><br><div class="spoiler">  <b class="spoiler_title">Cï¼ƒäº‹ä»¶äº§ç”Ÿå™¨</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Npgsql; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">PipelineDbLogGenerator</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Random _rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] _actions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"foo"</span></span>, <span class="hljs-string"><span class="hljs-string">"bar"</span></span>, <span class="hljs-string"><span class="hljs-string">"yep"</span></span>, <span class="hljs-string"><span class="hljs-string">"goal"</span></span>, <span class="hljs-string"><span class="hljs-string">"ano"</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connString = <span class="hljs-string"><span class="hljs-string">"Host=localhost;port=5432;Username=postgres;Database=testpipe"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NpgsqlConnection(connString)) { conn.Open(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dt = DateTime.UtcNow; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NpgsqlCommand()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> act = GetAction(); cmd.Connection = conn; cmd.CommandText = <span class="hljs-string"><span class="hljs-string">"INSERT INTO flow_stream VALUES (@dtmsk, @action, @duration)"</span></span>; cmd.Parameters.AddWithValue(<span class="hljs-string"><span class="hljs-string">"dtmsk"</span></span>, dt); cmd.Parameters.AddWithValue(<span class="hljs-string"><span class="hljs-string">"action"</span></span>, act); cmd.Parameters.AddWithValue(<span class="hljs-string"><span class="hljs-string">"duration"</span></span>, GetDuration(act)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = cmd.ExecuteNonQuery(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{res}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{dt}</span></span></span><span class="hljs-string">"</span></span>); } Thread.Sleep(_rnd.Next(<span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">230</span></span>)); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> act</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; act.Length; i++) { c += act[i]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _rnd.Next(c); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _actions[_rnd.Next(_actions.Length)]; } } }</code> </pre> <br></div></div><br><h3> ç»“è®ºåœ¨æ ¼æ‹‰æ³•çº³ </h3><br> è¦ä»postgresè·å–æ•°æ®ï¼Œæ‚¨éœ€è¦æ·»åŠ é€‚å½“çš„æ•°æ®æºï¼š <br><br><img src="https://habrastorage.org/webt/_6/5s/lo/_65slonsdesxobympei4ty266es.png"><br><br> åˆ›å»ºä¸€ä¸ªæ–°çš„ä»ªè¡¨æ¿ï¼Œå¹¶å‘å…¶ä¸­æ·»åŠ ä¸€ä¸ªGraphç±»å‹çš„é¢æ¿ï¼Œç„¶åéœ€è¦ç¼–è¾‘è¯¥é¢æ¿ï¼š <br><br><img src="https://habrastorage.org/webt/sm/va/ca/smvacalablhaoaohk0hamjcdrv0.png"><br><br> æ¥ä¸‹æ¥-é€‰æ‹©ä¸€ä¸ªæ•°æ®æºï¼Œåˆ‡æ¢åˆ°sql-queryå†™å…¥æ¨¡å¼å¹¶è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> m <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- Grafana   time count, action from viewflow where $__timeFilter(m) --  ,     ,   col between :startdate and :enddate order by m desc, action;</span></span></code> </pre> <br> ç„¶åï¼Œå¦‚æœæ‚¨å¯åŠ¨äº†äº‹ä»¶ç”Ÿæˆå™¨ï¼Œé‚£ä¹ˆæ‚¨å°†è·å¾—æ­£å¸¸çš„è®¡åˆ’ <br><br><img src="https://habrastorage.org/webt/y-/3j/3k/y-3j3k8kzkwu_p6ipmzovycuqe0.png"><br><br> ä»…ä¾›å‚è€ƒï¼šæ‹¥æœ‰ç´¢å¼•å¯èƒ½éå¸¸é‡è¦ã€‚ å°½ç®¡å…¶ç”¨æ³•å–å†³äºç»“æœè¡¨çš„å®¹é‡ã€‚ å¦‚æœè®¡åˆ’åœ¨å°‘é‡æ—¶é—´å†…å­˜å‚¨å°‘é‡è¡Œï¼Œåˆ™å¾ˆå®¹æ˜“å‘ç°seqæ‰«æä¼šä¾¿å®œä¸€äº›ï¼Œè€Œç´¢å¼•åªä¼šå¢åŠ é¢å¤–çš„å¼€é”€ã€‚ æ›´æ–°å€¼æ—¶åŠ è½½ <br><br> å¯ä»¥å°†å¤šä¸ªè§†å›¾è®¢é˜…åˆ°ä¸€ä¸ªæµã€‚ <br><br> å‡è®¾æˆ‘æƒ³æŸ¥çœ‹ç™¾åˆ†ä½æ•°æ‰§è¡Œå¤šå°‘ä¸ªapiæ–¹æ³• <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> viewflow_per <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (ttl = <span class="hljs-string"><span class="hljs-string">'3 d'</span></span>, ttl_column = <span class="hljs-string"><span class="hljs-string">'m'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span>(dtmsk) m, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">percentile_cont</span></span>(<span class="hljs-number"><span class="hljs-number">0.50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITHIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> p50, <span class="hljs-keyword"><span class="hljs-keyword">percentile_cont</span></span>(<span class="hljs-number"><span class="hljs-number">0.95</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITHIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> p95, <span class="hljs-keyword"><span class="hljs-keyword">percentile_cont</span></span>(<span class="hljs-number"><span class="hljs-number">0.99</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITHIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> p99 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flow_stream <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> viewflow_per (m <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>);</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">æˆ‘ç”¨grafanaåšåŒæ ·çš„æŠ€å·§ï¼Œå¹¶å¾—åˆ°ï¼š</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/rx/zx/kj/rxzxkjagevdpf_v82yx-81b3-7a.png"><br></div></div><br><h3> åˆè®¡ </h3><br> æ€»çš„æ¥è¯´ï¼Œå®ƒè¿è¡Œè‰¯å¥½ï¼Œè¿è¡Œè‰¯å¥½ï¼Œæ²¡æœ‰ä»»ä½•æŠ±æ€¨ã€‚ å°½ç®¡åœ¨dockerä¸‹ï¼Œä½†å°†ä»–ä»¬çš„æ¼”ç¤ºæ•°æ®åº“ä¸‹è½½åˆ°å­˜æ¡£ï¼ˆ2.3 GBï¼‰ä¸­å´æœ‰ç‚¹é•¿ã€‚ <br><br> æˆ‘æƒ³æŒ‡å‡º-æˆ‘æ²¡æœ‰è¿›è¡Œå‹åŠ›æµ‹è¯•ã€‚ <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®˜æ–¹æ–‡ä»¶</a> <br><br><h4> å¯èƒ½å¾ˆæœ‰è¶£ </h4><br><ul><li> æ”¯æŒå°†æ•°æ®<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»Apache Kafka</a>ä¸‹è½½<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åˆ°æµ</a> </li><li> ç±»ä¼¼äº<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Amazon Kinesis</a> </li><li> æ‚¨åªèƒ½<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸ºæ•°æ®è½¬æ¢</a>åˆ›å»ºè§†å›¾ï¼ˆä¸å­˜å‚¨ï¼‰ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PipelineDB Cluster-</a>æœ‰å•†ä¸šç‰ˆæœ¬ã€‚ åœ¨å…¶ä¸­ï¼Œæ‚¨å¯ä»¥æ ¹æ®åˆ†ç‰‡åˆ†å‘è§†å›¾ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é›†ç¾¤å†³ç­–åä¸­çš„</a>æ›´å¤šè¯¦ç»†ä¿¡æ¯ </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN432512/">https://habr.com/ru/post/zh-CN432512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN432500/index.html">PMPè®¤è¯ï¼šåº”ç”¨å®¡æ ¸</a></li>
<li><a href="../zh-CN432502/index.html">äº’è”ç½‘å¯èƒ½ä¼šç”±äºCå’ŒC ++ä¹‹ç±»çš„è¯­è¨€å¯¼è‡´æ¼æ´è€Œå‡ºç°ä¸¥é‡é—®é¢˜</a></li>
<li><a href="../zh-CN432506/index.html">Microsoft Connectï¼ˆï¼‰; 2018å¹´ï¼šæ‰€æœ‰äº‘ä¼šè®®å…¬å‘Š</a></li>
<li><a href="../zh-CN432508/index.html">å…³äºäººå·¥æ™ºèƒ½ä¸­ä½¿ç”¨ç¬¦å·ç³»ç»Ÿçš„éšœç¢</a></li>
<li><a href="../zh-CN432510/index.html">æŒªå¨æ’ç”µå¼ç”µåŠ¨æ±½è½¦çš„å¸‚åœºä»½é¢å‡ ä¹åˆ›ä¸‹æ–°é«˜</a></li>
<li><a href="../zh-CN432514/index.html">ä½¿ç”¨ABBYY RTR SDKå’Œdjangoè¯†åˆ«Android Thingsä¸Šçš„æ–‡æœ¬</a></li>
<li><a href="../zh-CN432516/index.html">ç¦å°”æ‘©æ–¯ï¼Œå¼€é˜”çœ¼ç•Œï¼ è¿˜æ˜¯ä¸ºä»€ä¹ˆç‰©ç†å­¦å®¶éœ€è¦å°æç´å’Œçƒ¹é¥ªæŠ€å·§</a></li>
<li><a href="../zh-CN432518/index.html">ç”µå­ä¸æœ¬æœºåº”ç”¨çš„è¡°é€€</a></li>
<li><a href="../zh-CN432520/index.html">å¦‚ä½•åœ¨åµŒå…¥å¼æ•°æ®åº“ï¼ˆH2ï¼‰ä¸­çš„Atlassian Jiraå’ŒConfluenceä¸­æ›´æ”¹ç®¡ç†å‘˜å¯†ç </a></li>
<li><a href="../zh-CN432524/index.html">ä¸ºä»€ä¹ˆä¸åº”è¯¥å†ä½¿ç”¨Quora</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>