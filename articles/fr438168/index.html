<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßïüèΩ üßíüèΩ üíÉüèø Comment casser un appareil photo cher pour que votre femme ne vous tue pas üòß üç® üë®üèª‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Avertissement: l'√©tude a commenc√© en 2013, donc si vous pensez que certaines m√©thodes sont stupides et dangereuses - vous avez raison, c'est tout. Cep...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment casser un appareil photo cher pour que votre femme ne vous tue pas</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438168/"> <i>Avertissement: l'√©tude a commenc√© en 2013, donc si vous pensez que certaines m√©thodes sont stupides et dangereuses - vous avez raison, c'est tout.</i>  <i>Cependant, j'ai beaucoup appris au cours du processus.</i> <br><br>  <b>Entr√©e</b> <br>  Tout a commenc√© quelques mois avant la naissance de mon premier enfant.  Ma femme et moi avons toujours voulu acheter un appareil photo Leica cool et nous avons soudain r√©alis√© que si nous ne l‚Äôachetions pas maintenant, nous ne pourrions pas le faire pendant longtemps.  Par cons√©quent, nous avons command√© la cam√©ra M240 et ... boom, nous avons √©t√© mis en ligne pendant six mois.  Bient√¥t, j'√©tais fatigu√© d'attendre et j'ai commenc√© √† √©tudier leur site.  Mon attention a √©t√© imm√©diatement attir√©e sur la section des fichiers.  Eh bien, vous pouvez deviner pourquoi ... Firmware! <br><br>  J'ai vu un fichier non chiffr√© et non compress√© ( <code>m8-2_005.upd</code> ) qui commence par la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">magie PWAD</a> .  Reconnaissez-vous?  Oui, c'est vrai, c'est le format Doom Patch WAD.  Les gars semblent aimer les classiques.  Le format est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tr√®s bien document√©</a> , il n'a donc pas √©t√© difficile de l'analyser. <br><a name="habracut"></a><br><h1>  Fichiers du firmware Leica </h1><br><h3>  Micrologiciel Leica M8 </h3><br>  C'est en fait tr√®s dr√¥le, car lorsque j'ai √©tudi√© plus tard le fichier de firmware compress√© de Leica T, j'ai d'abord d√©cid√© de tester les m√©thodes de compression utilis√©es par id Software dans le pass√©. <br><br>  Wikip√©dia dit qu'ils ont utilis√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le format LHA</a> , qui est essentiellement LZW.  Mais les d√©compresseurs LZW courants ne convenaient pas, alors j'ai commenc√© √† chercher une impl√©mentation sp√©cifique du logiciel d'identification - et le tour est jou√©, j'ai trouv√© <a href="">Catacomb Armageddon</a> dans la <a href="">source</a> .  Je dois admettre, chanceux. <br><br>  Dans tous les cas, revenons au M8.  Voici la structure du firmware: <br><br><pre>  R√àGLES: 0x0000008C (3036: 0x00000BDC) - Description XML
 LUTS: 0x00000C68 (183274: 0x0002CBEA)
  GAMMA: 0x0000007C (31760: 0x00007C10)
  GAIN: 0x00007C8C (50344: 0x0000C4A8)
  LEICA: 0x00014134 (7000: 0x00001B58)
  BLEMISH: 0x00015C8C (250: 0x000000FA)
  WREF: 0x00015D88 (82480: 0x00014230)
  OBJ: 0x00029FB8 (11268: 0x00002C04)
  VERSION: 0x0002CBBC (46: 0x0000002E)
 PXA: 0x0002D854 (858384: 0x000D1910)
 BF: 0x000FF164 (134522: 0x00020D7A) - famille de processeurs Blackfin Analog Devices
 GUI: 0x0011FEE0 (3574180: 0x003689A4)
  TRANS: 0x0000005C (59988: 0x0000EA54) - localisation
  IMAGES: 0x0000EAB0 (267433: 0x000414A9)
   21_1PRT: 0x000000CC (18411: 0x000047EB) - photo de JFIF
   21_2GRP: 0x000048B8 (23172: 0x00005A84) - image de JFIF
   21_3PAN: 0x0000A33C (23034: 0x000059FA) - Photo de JFIF
   24_1PRT: 0x0000FD38 (18489: 0x00004839) - image de JFIF
   24_2GRP: 0x00014574 (23230: 0x00005ABE) - image de JFIF
   24_3PAN: 0x0001A034 (22998: 0x000059D6) - image de JFIF
   28_1PRT: 0x0001FA0C (22605: 0x0000584D) - photo de JFIF
   28_2GRP: 0x0002525C (23081: 0x00005A29) - image de JFIF
   28_3PAN: 0x0002AC88 (23282: 0x00005AF2) - image de JFIF
   35_1PRT: 0x0003077C (22496: 0x000057E0) - image de JFIF
   35_2GRP: 0x00035F5C (23532: 0x00005BEC) - photo de JFIF
   35_3PAN: 0x0003BB48 (22881: 0x00005961) - image de JFIF
  FONT1: 0x0004FF5C (1522988: 0x00173D2C)
  FONT2: 0x001C3C88 (1723676: 0x001A4D1C)
  VERSION: 0x003689A4 (0: 0x00000000)
 M16C: 0x00488884 (130406: 0x0001FD66) - Famille Renesas M16C (Motorola S-record)
 FPGA: 0x004A85EC (131604: 0x00020214) - Xilinx Spartan 3
 FSL: 0x004C8800 (814: 0x0000032E) - le chargeur de d√©marrage de premier √©tage </pre><br>  L'IDA pr√™t √† l'emploi ne prend pas en charge les processeurs Blackfin, mais il existe un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plugin tiers</a> . <br><br><h3>  Micrologiciel Leica M9 </h3><br>  Le fichier du firmware du Leica M9 ( <code>m9-1_196.upd</code> ) semble crypt√©: l'histogramme montre une distribution d'environ 0,45%. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ac1/6fc/17d/ac16fc17df9bfb0c9c63bdefaecc83d9.png"><br><br>  La fin de l'histoire?  Peut-√™tre pas.  Le fait est que Leica a utilis√© des processeurs plut√¥t faibles dans les cam√©ras, et √† cette √©poque, le cryptage XOR √©tait souvent utilis√© dans l'√©lectronique grand public, j'ai donc d√©cid√© d'√©crire un outil simple pour l'op√©ration XOR pour comparer le firmware avec moi-m√™me et calculer des statistiques. <br><br>  La longueur de cl√© a √©t√© d√©termin√©e en recherchant le motif de r√©p√©tition le plus long.  Cela est logique, car tout micrologiciel comprend g√©n√©ralement de gros blocs de donn√©es r√©p√©titives, comme un pav√© 0x00 / 0xFF ou des graphiques avec des pixels LUT.  La cl√© elle-m√™me est calcul√©e par la fr√©quence d'octets dans la longueur de la cl√©, o√π l'octet le plus courant va au tampon de cl√©.  Le r√©sultat du programme indiquait clairement le cryptage XOR.  Ensuite, j'ai d√ª <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">modifier un</a> peu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'outil</a> pour obtenir la cl√© potentielle et d√©crypter le code.  Cela s'est av√©r√© √† nouveau √™tre un fichier PWAD. <br><br>  Le contenu de PWAD a r√©v√©l√© la structure suivante: <br><br><pre>  R√àGLES: 0x0000007C (2788: 0x00000AE4) - Description XML
 LUTS: 0x00000B60 (4060616: 0x003DF5C8)
  PROCESSUS: 0x0000004C (3900572: 0x003B849C)
   CR√âER: 0x0000004C (20: 0x00000014) - horodatage
   LUTS: 0x00000060 (427744: 0x000686E0)
   GAINMAP: 0x00068740 (20008: 0x00004E28)
   LENTILLE: 0x0006D568 (3452724: 0x0034AF34)
  CCD: 0x003B84E8 (148662: 0x000244B6)
   CR√âER: 0x0000004C (20: 0x00000014) - horodatage
   BLEMISH: 0x00000060 (1092: 0x00000444)
   WREF: 0x000004A4 (147452: 0x00023FFC)
   LIN: 0x000244A0 (22: 0x00000016)
  ICCPROF: 0x003DC9A0 (4304: 0x000010D0)
   ECI-RGB: 0x0000003C (540: 0x0000021C)
   sRGB: 0x00000258 (3144: 0x00000C48)
   A-RVB: 0x00000EA0 (560: 0x00000230)
  WBPARAM: 0x003DDA70 (7000: 0x00001B58)
 BF561: 0x003E0128 (289128: 0x00046968) - Famille de processeurs Blackfin Analog Devices
  bf0: 0x0000004C (117846: 0x0001CC56) - processeur principal
  bf1: 0x0001CCA4 (117826: 0x0001CC42) - firmware du sous-processeur
  bf0.map: 0x000398E8 (27072: 0x000069C0) - carte de microprogramme du processeur principal avec caract√®res: D
  bf1.map: 0x000402A8 (26304: 0x000066C0) - carte de microprogramme de sous-processeur avec caract√®res: D
 CORPS: 0x00426A90 (143280: 0x00022FB0) - Famille Renesas M16C (Motorola S-record)
 GUI: 0x00449A40 (3647624: 0x0037A888)
  TRANS: 0x0000005C (131656: 0x00020248) - localisation
  IMAGES: 0x000202A4 (267433: 0x000414A9)
   21_1PRT: 0x000000CC (18411: 0x000047EB) - photo de JFIF
   21_2GRP: 0x000048B8 (23172: 0x00005A84) - image de JFIF
   21_3PAN: 0x0000A33C (23034: 0x000059FA) - Photo de JFIF
   24_1PRT: 0x0000FD38 (18489: 0x00004839) - image de JFIF
   24_2GRP: 0x00014574 (23230: 0x00005ABE) - image de JFIF
   24_3PAN: 0x0001A034 (22998: 0x000059D6) - image de JFIF
   28_1PRT: 0x0001FA0C (22605: 0x0000584D) - photo de JFIF
   28_2GRP: 0x0002525C (23081: 0x00005A29) - image de JFIF
   28_3PAN: 0x0002AC88 (23282: 0x00005AF2) - image de JFIF
   35_1PRT: 0x0003077C (22496: 0x000057E0) - image de JFIF
   35_2GRP: 0x00035F5C (23532: 0x00005BEC) - photo de JFIF
   35_3PAN: 0x0003BB48 (22881: 0x00005961) - image de JFIF
  FONT1: 0x00061750 (1522988: 0x00173D2C)
  USBLOGO: 0x001D547C (1775: 0x000006EF) - photo de JFIF
  FONT2: 0x001D5B6C (1723676: 0x001A4D1C)
 FPGA: 0x007C42C8 (150176: 0x00024AA0) - Xilinx Spartan 3A
 BF547: 0x007E8D68 (937576: 0x000E4E68) - Famille de processeurs Blackfin Analog Devices (FSL?) </pre><br><br><h3>  Micrologiciel Leica M240 </h3><br>  J'ai pris l'habitude de v√©rifier la page de t√©l√©chargement avec le firmware Leica chaque matin.  Bient√¥t, un nouveau fichier est apparu: <b>FW_M240_1_1_0_2.FW</b> . <br><br>  Il n'avait pas l'air crypt√©, mais √©tait compress√© ... <br><br><h4>  La compression </h4><br>  L'histogramme montre une √©norme rafale √† 0x9D. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6cb/025/ef7/6cb025ef734f60b1d4104b7301798cad.png"><br><br>  C'est peut-√™tre une sorte de magie de compression.  Une recherche sur Internet [compression 9D +] n'a rien donn√©, sauf que 0x1F9D est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utilis√© comme signature pour la compression LZW</a> .  Si quoi que ce soit, je comprends les types de compression LZ et j'ai d√©cid√© de regarder les octets apr√®s 0x9D.  Et j'ai vu quatre options: <br><br><ol><li> <code>9D 70 C4</code> <br> </li><li> <code>9D 00</code> <br> </li><li> <code>9D XX YY</code> <br> </li><li> <code>9D XX 8Y YY</code> </li> </ol><br>  Qu'avez-vous r√©ussi √† remarquer d'autre: <br><br><ul><li>  la premi√®re option n'appara√Æt qu'une seule fois √† l'adresse 0x30: elle est probablement utilis√©e comme indicateur de donn√©es compress√©es; <br></li><li>  XX ne d√©passe jamais 0x7F; <br></li><li>  le dernier octet de YY dans les troisi√®me et quatri√®me cas ne d√©passe jamais 0x7F </li></ul><br>  D'apr√®s ce que je sais de LZ, c'est tr√®s similaire √† LZ77 ou LZSS, o√π YY est l'√©tape de retrait et XX est le nombre d'octets √† copier.  Et la deuxi√®me option est un cas sp√©cial d'√©mission de 0x9D.  J'ai √©crit une simple fonction C qui impl√©mente cette logique.  Elle a confirm√© que nous allons dans la bonne direction, mais la quatri√®me option ne rentre toujours pas dans le sch√©ma. <br><br>  J'ai essay√© de toutes les mani√®res de l'interpr√©ter, mais rien n'en est sorti.  Par cons√©quent, je me suis tourn√© vers mes camarades pour obtenir des conseils.  Un gars a remarqu√© que, selon mes propres observations, le quatri√®me octet de YY n'appara√Æt que lorsque le bit le plus √©lev√© 0x8Y est d√©fini: ce n'est qu'une distance suppl√©mentaire pour l'√©tape de retrait.  J'avais honte, tout s'est av√©r√© si √©vident ... <br><br>  Enfin, le d√©compresseur a commenc√© √† √©mettre un flux valide ... jusqu'√† ce qu'il se coince au milieu du fichier.  Cela est d√ª √† la longueur inconnue de la fen√™tre coulissante.  Des d√©bogages et des tests suppl√©mentaires ont corrig√© la situation. <br><br>  Il y avait donc un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">outil pour analyser le firmware M240</a> . <br><br><h4>  Structure du firmware </h4><br>  Pour travailler avec un format inconnu, je n'ai rien trouv√© de mieux que de mesurer certains d√©calages et tailles de sections de code - et d'essayer de trouver les valeurs les plus proches dans l'en-t√™te du fichier.  Par exemple, ce bloc: <br><br> <code>0x00: 1E 1C AF 2E 01 01 00 02 07 E1 EA 5E 00 5C 1A B1 <br> 0x10: 01 29 1A 7E AE 38 73 65 9C 3D 75 B4 34 2F 44 6E <br> 0x20: 13 17 8E 6B 00 00 00 01 00 00 00 30 E1 E3 50 D1</code> <br> <br>  finalement transform√© en: <br><br> <code>1E1CAF2E ‚Äî   "LEICA FILE" <br> 01010002 - 1.1.0.2 <br> 005C1AB1 ‚Äî    (big endian) <br> 01291A7E ‚Äî    (big endian) <br> AE3873659C3D75B4342F446E13178E6B ‚Äî  MD5 <br> 00000001 ‚Äî    <br> 00000030 ‚Äî    </code> <br> <br>  En comprenant la structure du firmware, j'ai am√©lior√© mon outil, et au final, il a produit ceci: <br><br> <code>Running with options: <br> + firmware folder: M240_FIRMWARE <br> + verbose enabled <br> <br> Open firmware file: FW_M240_1_1_0_2.FW <br> File size: 6036193 | 0x005C1AE1 <br> <br> Parse container header: <br> version: 1.1.0.2 <br> packed size: 6036145 | 0x005C1AB1 <br> unpacked size: 19470974 | 0x01291A7E <br> body blocks: 1 | 0x00000001 <br> body offset: 48 | 0x00000030 <br> MD5: AE387365 9C3D75B4 342F446E 13178E6B <br> MD5 check: PASSED <br> <br> Uncompress container body: <br> 6036145 -&gt; 19470974 <br> Uncompression: DONE <br> <br> Split container: <br> Number of sections: 9 | 0x00000009 <br> Section table size: 612 | 0x00000264 <br> Section table offset: 36 | 0x00000024 <br> Section 1 <br> Section Name: "[A]IMG_LOKI-212" <br> Section offset: 0 | 0x00000000 <br> Section size: 7340032 | 0x00700000 <br> Section base: 1048576 | 0x00100000 <br> MD5: A8D55AA2 B0ACDB14 0673AD79 707674F3 <br> MD5 check: PASSED <br> Create file: M240_FIRMWARE/IMG_LOKI-212.bin <br> <br> ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ <br> <br> Section 9 <br> Section Name: "[A]IMG-LENSDATA-213" <br> Section offset: 19214844 | 0x012531FC <br> Section size: 255478 | 0x0003E5F6 <br> Section base: 16252928 | 0x00F80000 <br> MD5: 39C2BEC0 27ED23F6 2C1C8513 EEE697B9 <br> MD5 check: PASSED <br> Create file: M240_FIRMWARE/IMG-LENSDATA-213.bin <br> Splitting container: DONE <br> Extraction COMPLETE!</code> <br> <br>  Le firmware M240 comprend un conteneur avec neuf √©l√©ments: <br><br> <code>IMG_LOKI-212.bin -    <br> IMG_LOKI-213.bin -    <br> CTRL_SYS-11.bin -   - <br> IMG-FPGA-212.bin -     () <br> IMG-FPGA-213.bin -     () <br> IMG-DSP-212.bin -  DSP <br> IMG-DSP-213.bin -  DSP <br> IMG-LENSDATA-212.bin -    <br> IMG-LENSDATA-213.bin -   </code> <br> <br>  Comme vous pouvez le voir, dans un micrologiciel, il existe deux ensembles de fichiers.  Plus tard, j'ai appris que le 212 est une version du microcircuit de traitement d'image et deux versions du Leica M240 sont entr√©es en production.  Cette √©tude est bas√©e sur la version 212. <br><br><h1>  Gestion du syst√®me: CTRL_SYS-11.bin </h1><br>  La seule partie commune est le firmware de la puce de contr√¥le du syst√®me.  Il s'agit d'un tr√®s gros binaire, et le code peut facilement deviner √† quoi il est destin√©. <br><br> <code>$ strings CTRL_SYS-11.bin | rg SH <br> -&gt; Test SH7216 data flash driver <br> -&gt; Test SH7216 SCI driver <br> -&gt; Test SH7216 I2C driver <br> -&gt; Test SH7216 MTU2 driver <br> -&gt; Test SH7216 ADC functions <br> -&gt; Test SH7216 CMT driver</code> <br> <br>  Ainsi, nous avons le processeur Renesas SH7216 (SH-2A), qui est responsable de la premi√®re √©tape du chargement, des tests d'E / S et des mises √† jour du firmware.  IDA pr√™t √† l'emploi prend en charge ce type de processeur.  Il ne restait plus qu'√† trouver l'adresse de chargement de base correcte, connue d'apr√®s la description des sections du firmware: c'est <code>0x0</code> . <br><br> <code>Section Name: "[A]CTRL_SYS-11" <br> Section offset: 14680064 | 0x00E00000 <br> Section size: 917277 | 0x000DFF1D <br> Section base: 0 | 0x00000000</code> <br> <br>  Je l'ai charg√© dans l'IDA et reconnu toutes les fonctions, mais je ne l'ai pas creus√© sp√©cialement, car le firmware du processeur principal est beaucoup plus int√©ressant. <br><br>  Ici, on peut √©galement noter que l'UART de cette puce s'ouvre sur le port de service, o√π il affiche le journal de t√©l√©chargement.  Nous y reviendrons plus tard. <br><br><h1>  Puce principale: IMG_LOKI-212.bin </h1><br>  Pour d√©marrer la r√©tro-ing√©nierie de ce firmware, vous devez d'abord r√©pondre √† quelques questions: <br><br><ol><li>  quel type de processeur <br></li><li>  quelle est l'adresse de chargement de base <br></li><li>  sur quel syst√®me d'exploitation est-il bas√©, le cas √©ch√©ant </li></ol><br>  Gr√¢ce √† notre outil, nous connaissons d√©j√† l'adresse de la charge de base: c'est <code>0x100000</code> . <br><br> <code>Section Name: "[A]IMG_LOKI-212" <br> Section offset: 0 | 0x00000000 <br> Section size: 7340032 | 0x00700000 <br> Section base: 1048576 | 0x00100000</code> <br> <br>  Le micrologiciel stocke les r√©ponses restantes sous une forme lisible.  Par exemple, cette ligne: <br><br> <code>$ strings ./IMG_LOKI-212.bin | rg Softune <br> 6Softune REALOS/FR is Realtime OS for FR Family, based on micro-ITRON COPYRIGHT(C) FUJITSU LIMITED 1994-1999 <br> ...</code> <br> <br>  Ainsi, nous avons affaire √† un processeur personnalis√© <b>Fujitsu FR</b> (Leica l'appelle <b>Maestro</b> ) et au <b>syst√®me d'</b> exploitation <b>Softune REALOS</b> .  En fait, c'est beaucoup mieux que Blackfin, car l'IDA pr√™t √† l'emploi prend en charge FR. <br><br><h2>  Module processeur FR </h2><br>  La r√©alit√© n'√©tait pas si brillante, car apr√®s avoir t√©l√©charg√© le fichier du firmware, le programme IDA n'a pas montr√© d'instructions, de liens externes, etc. <br><br>  J'ai d√©cid√© de le r√©parer, mais √† la fin j'ai d√ª <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©√©crire compl√®tement certaines parties du firmware</a> .  Voici le r√©sultat: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9f3/728/c76/9f3728c769d29aa02e2f405c08d8bb9a.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a08/2ea/81d/a082ea81d9056b07935398a19d4df294.png"><br><br>  En plus des corrections en <code>ana</code> , <code>ins</code> et <code>out</code> , un tout nouveau code <code>emu</code> peut: <br><br><ul><li>  reconna√Ætre divers types de code et des liens externes vers des donn√©es; <br></li><li>  Reconna√Ætre les instructions de commutateur <br></li><li>  effectuer le tra√ßage de la pile; <br></li><li>  Arguments de pile s√©par√©s et variables locales <br></li><li>  reconna√Ætre correctement les fonctions. </li></ul><br>  Mais le plus grand changement, comme vous l'avez remarqu√©, ce sont les majuscules pour les instructions :) <br><br>  Vous voulez voir l'ensemble complet des instructions?  Le voici: <br><br><pre>  AJOUTER OU BTSTH LSR MOV BN LDRES EXTSH   
 ADD2 ORH MUL LSR2 JMP BP STRES EXTUH   
 ADDC ORB MULU ASR CALL BV COPOP SRCH0   
 ADDN EOR MULH ASR2 RET BNV COPLD SRCH1   
 ADDN2 EORH MULUH LDI INT BLT COPST SRCHC   
 SUB EORB DIV0S LDI INTE BGE COPSV LDM0    
 SUBC BANDL DIV0U LDI RETI BLE NOP LDM1    
 SUBN BANDH DIV1 LD BRA BGT ANDCCR STM0    
 CMP BORL DIV2 LDUH BNO BLS ORCCR STM1    
 CMP2 BORH DIV3 LDUB BEQ BHI STILM ENTER   
 ET BEORL DIV4S ST BNE DMOV ADDSP CONG√â   
 ANDH BEORH LSL STH BC DMOVH EXTSB XCHB    
 ANDB BTSTL LSL2 STB BNC DMOVB EXTUB </pre><br>  Donc, simple et beau. <br><br>  √Ä propos, vous avez peut-√™tre remarqu√© que certaines instructions ne sont pas align√©es: <br><br><pre>  BRA: D loc_xxx
     LDI: 8 # 0x64, R5 </pre><br>  Ce n'est pas une erreur dans le module processeur, mais en fait une caract√©ristique de la famille Fujitsu FR.  Il est appel√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un slot de retard</a> et est assez typique pour les processeurs RISC. <br><br>  Dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le manuel du processeur FR80</a> (remarque: le lien ne fonctionne plus): <br><br><blockquote>  L'instruction qui se trouve imm√©diatement apr√®s l'instruction de branchement (son emplacement est appel√© ¬´intervalle de retard¬ª) est ex√©cut√©e avant la branchement, et l'instruction √† l'adresse de destination est ex√©cut√©e apr√®s la branchement.  √âtant donn√© que l'instruction dans la tranche de retard est ex√©cut√©e avant l'op√©ration de branchement, la vitesse d'ex√©cution apparente est de 1 cycle. </blockquote><br>  Ainsi, il s'agit essentiellement d'une optimisation du pipeline, et il vaut mieux s'en souvenir, car il est utilis√© partout dans le firmware Leica. <br><br><h2>  Softune REALOS </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Depuis le wiki</a> : <br><br><blockquote>  Softune est l'environnement de d√©veloppement int√©gr√© de Fujitsu pour les familles de processeurs Fujitsu FR, FR-V et F2MC.  Propuls√© par le noyau temps r√©el REALOS ¬µITRON.  Par exemple, il est utilis√© dans les appareils photo reflex num√©riques Nikon (voir Nikon EXPEED) et certains appareils photo Pentax avec K. </blockquote><br>  C'est donc un RTOS d√©cent assez populaire avec des t√¢ches, des s√©maphores et d'autres goodies.  Je me demandais s'il √©tait possible de reconna√Ætre certaines fonctions de biblioth√®que standard dans le firmware Leica. <br><br>  Je dois appeler la premi√®re partie de l'√©tude une grosse perte de temps, et voici pourquoi. <br><br>  L'IDE Softune s'est av√©r√© tr√®s difficile √† trouver, mais j'ai finalement r√©ussi √† obtenir quelque chose.  Comme pr√©vu, l'EDI comprenait des biblioth√®ques.  Il y avait quatre binaires: <br><br><ul><li>  lib911.lib <br></li><li>  lib911e.lib <br></li><li>  lib911if.lib <br></li><li>  lib911p.lib </li></ul><br>  Je ne sais pas pourquoi, peut-√™tre par inertie, comme j'ai pirat√© tout ce qui √©tait li√© √† Leica, j'ai recommenc√© la r√©tro-ing√©nierie du format.  Oui, un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">format de module objet</a> tr√®s bien document√©.  Et oui, bien s√ªr, j'ai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©crit un outil sp√©cial pour cela</a> : <br><br> <code>Fujitsu RISC Library Tool v1.0 <br> Usage: FRLibTool [-s start] [-i imagebase] [-o output] [-f index] [-dv] FIRMWARE.BIN LIBRARY.LIB <br> <br> This tool will help you to find Softune REALOS library functions in FR (Fujitsu RISC) firmware. <br> Use following arguments: <br> -f Specify firmware image file <br> -s Specify firmware image scan offset <br> -b Specify firmware imagebase <br> -o Specify output type (exclusively) <br> list - list of functions <br> idc - IDC script <br> py - IDA python script <br> pat - FLAIR pattern file <br> -i xxx Specify index of particular function <br> -d Dump library <br> -v Be verbose</code> <br> <br>  En l'utilisant, vous pouvez cr√©er des fichiers <code>*.pat</code> et les utiliser comme entr√©e dans l' <b>IDA FLAIR</b> pour g√©n√©rer des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fichiers de signature</a> . <br><br> <code>$ FRLibTool -o pat lib911.lib <br> $ FRLibTool -o pat lib911e.lib <br> $ FRLibTool -o pat lib911if.lib <br> $ FRLibTool -o pat lib911p.lib <br> ... <br> $ sigmake -n "SOFTUNE C/C++ Library" lib911.pat lib911e.pat lib911if.pat lib911p.pat softune.sig</code> <br> <br>  Apr√®s avoir appos√© cette signature, j'ai finalement vu avec plaisir la correspondance dans <b>IMG_LOKI-212.idb</b> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/189/618/145/189618145ab302edfff51fa222ed89b3.png"><br><br><h4>  Disposition </h4><br>  Le nombre de lignes du firmware attire imm√©diatement l'attention.  De nombreuses fonctions sont nomm√©es pour leur fonctionnalit√©.  Ceci est tr√®s utile dans le processus d'ing√©nierie inverse pour comprendre le mod√®le g√©n√©ral. <br><br>  Il est √©galement important de noter que certaines parties du fichier du firmware sont copi√©es √† une adresse diff√©rente dans le gestionnaire de r√©initialisation.  Par exemple, le chargeur int√©gr√© √† l'ex√©cution se d√©place plus haut dans la RAM. <br><br>  J'ai d√ª cr√©er manuellement des sections suppl√©mentaires, par cons√©quent, j'ai obtenu la mise en page suivante: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/70f/d9d/ca3/70fd9dca36e610c7dea2e1c2fd29090c.png"><br><br><h4>  Interruptions </h4><br>  La table des vecteurs d'interruption peut √™tre trouv√©e en acc√©dant √† TBR (Table Base Register): <br><br> <code>LDI:32 #int_table, R0 <br> MOV R0, TBR</code> <br> <br>  Cela se produit g√©n√©ralement dans le gestionnaire de r√©initialisation vectorielle au tout d√©but du micrologiciel. <br><br>  Les adresses des gestionnaires de la table sont stock√©es dans l'ordre inverse selon la formule <code>TBR + (0x3FC - 4 √ó inum)</code> , de sorte que le vecteur de r√©initialisation √† la fin de la table est d√©cal√© <code>0x3FC</code> . <br><br>  J'ai trouv√© la plupart des interruptions du manuel FR et sugg√©r√© que Leica Maestro a une disposition similaire.  Puis il a pris chaque gestionnaire et a essay√© de trouver une cha√Æne ou tout autre indice qui r√©v√®le le but de l'interruption. <br><br>  En cons√©quence, j'ai fait cette liste: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd7/eb8/c29/bd7eb8c291d5368d44576466400cb34b.png"><br><br>  De nombreuses interruptions sont tout √† fait attendues, comme AUDIO / SDIO / VIDEO / JPEG / RAW, mais essayez-vous d'identifier les plus myst√©rieuses d'entre elles?  Je parle d'interrompre <code>int_uart_in</code> .  Il semble que la cam√©ra prenne en charge une sorte de CLI UART en mode console. <br><br><h4>  Appels syst√®me </h4><br>  Comme presque tous les syst√®mes d'exploitation, Softline REALOS utilise des appels syst√®me.  En assembleur, ils ressemblent √† ceci: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/22f/a92/9e3/22fa929e311af81f43be57bf0bbbbc74.png"><br><br>  L'adresse r√©elle du gestionnaire d'appels syst√®me est calcul√©e comme suit.  Commen√ßons par rechercher le gestionnaire d'interruption <code>INT #0x40</code> .  Comme d√©crit ci-dessus, cette <br><br> <code>(0x3FC - 4 √ó inum) = (0x3FC - 4 √ó 0x40) = 0x2FC = int_realos_syscall</code> <br> <br>  Dans le gestionnaire, il est facile de trouver un lien vers le bas de la table d'appels syst√®me avec des mots de 16 bits.  L'enregistrement sp√©cifique dans ce tableau est calcul√© par la formule <code>syscall_table_bottom + (num * 2)</code> : <br><br> <code>[syscall_table_bottom + (-23 * 2)] = [syscall_table_bottom - 0x2E] = [0x1012EA] = 0xE68</code> <br> <br>  Cela ne ressemble pas √† une adresse, car l'adresse r√©elle du gestionnaire d'appels syst√®me est calcul√©e comme <code>syscall_table_bottom + offset</code> .  L'ensemble du processus est illustr√© dans le diagramme. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c5a/240/2bb/c5a2402bb00a171532dabf9ef9aa45ea.png"><br><br>  Tous les appels syst√®me et leurs fonctionnalit√©s sont indiqu√©s dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le manuel du noyau Softline REALOS / FR</a> , j'ai donc r√©ussi √† restaurer tous les gestionnaires impl√©ment√©s dans la table et √† am√©liorer un peu plus IDB. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c6a/b81/57a/c6ab8157a83a3e00613b4a000de45e54.png"><br><br>  Bien s√ªr, vous pouvez rendre le code encore plus beau en d√©finissant les types d'appels syst√®me dans l'IDA. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1e0/75c/099/1e075c099f1bdcb70388427705dd25c0.png"><br><br>  J'ai √©crit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un script Python</a> pour rechercher automatiquement ces appels syst√®me et plus encore. <br><br><h4>  Les t√¢ches </h4><br>  Dans l' <code>sta_tsk</code> syst√®me <code>sta_tsk</code> j'ai remarqu√© que non la fonction principale n'est pas pass√©e en param√®tre, mais pid.  Cela signifie qu'il est temps de rechercher un large √©ventail de descripteurs de t√¢ches.  Et il est logique de commencer par <code>sta_tsk</code> lui-m√™me. <br><br><pre>  ROM: 102180 sys_sta_tsk:
 ROM: 102180 ST RP, @ -R15
 ROM: 102182 LDUB @ (R14, 0x4F), R3
 ROM: 102184 LDI: 32 # word_100B80, R14 </pre><br>  Au tout d√©but, nous voyons quelques liens.  J'ai d√ª bricoler un peu avec les types de donn√©es, mais √† la fin, les √©l√©ments se sont r√©unis: <br><br><pre>  ROM: 100B80 word_100B80: .word 0xF;  nombre de t√¢ches
 ROM: 100B82 .word 0x1C;  taille du descripteur de t√¢che<font></font>
<font></font>
 ROM: 100B84 .long 0x82A09F5C;  descripteur de t√¢che 1
 ROM: 100B88 .long 0x1000D
 ROM: 100B8C .long 0
 ROM: 100B90 .long 0x40000000
 ROM: 100B94 .long sub_1A7DB2;  t√¢che principale
 ROM: 100B98 .long 0x8286EEC0
 ROM: 100B9C .long 0<font></font>
<font></font>
 ROM: 100BA0 .long 0x82A09F88;  descripteur de t√¢che 2
 ROM: 100BA4 .long 0x20010
 ROM: 100BA8 .long 0
 ROM: 100BAC .long 0x40000000
 ROM: 100BB0 .long sub_1A6BD2;  t√¢che principale
 ROM: 100BB4 .long 0x8287EEC0
 ROM: 100BB8 .long 0
 ... </pre><br>  et ainsi de suite.  Seulement 15 t√¢ches.  C'√©tait une question de temps pour examiner chaque fonction principale, d√©terminer le nom et le but de la t√¢che (sauf la derni√®re).  Voici la liste compl√®te: <br><br><ol><li>  <b>SubCPU</b> <br>  Cette t√¢che est apparemment responsable des op√©rations de capture telles que l'exposition, l'observation √† l'√©cran, etc. <br></li><li>  <b>Keymanager</b> <br>  Tr√®s probablement, cette t√¢che est associ√©e √† des boutons mat√©riels. <br></li><li>  <b>Guimanager</b> <br>  Une t√¢che assez importante, dans laquelle la machine d'√©tat de l'interface utilisateur et le rendu de l'interface sont impl√©ment√©s. <br></li><li>  <b>Debugmanager</b> <br>  Oui, il y a quelque chose √† d√©boguer.  Miam miam. <br></li><li>  <b>Gestionnaire de fichiers</b> <br>  Cette t√¢che concerne les op√©rations sur les fichiers. <br></li><li>  <b>Fammanager</b> <br>  Je dirais que la t√¢che est responsable des fichiers et de la m√©moire, car cela d√©pend des t√¢ches du gestionnaire de fichiers et du gestionnaire de m√©moire. <br></li><li>  <b>Memorymanager</b> <br>  Pas de surprise: op√©rations de m√©moire, gestion de pool, etc. <br></li><li>  <b>Imagemanager</b> <br>  Cette t√¢che g√®re les processus de codage / d√©codage et autres processus de traitement d'image. <br></li><li>  <b>Usbmanager</b> <br>  Le d√©fi actuel est le traitement des communications USB, qui comprend MassStorage, PTP et le propre protocole de Leica. <br></li><li>  <b>IOManager</b> <br>  Cette t√¢che semble g√©rer des p√©riph√©riques de stockage tels que les cartes SD et CF (quoi? Quels autres CF? Peut-√™tre du mod√®le 213). <br></li><li>  <b>Systemmanager</b> <br>  Diverses t√¢ches comme les op√©rations g√©n√©rales du syst√®me, la gestion de l'alimentation, etc. <br></li><li>  <b>SettingsManager</b> <br>  G√®re l'√©tat et les param√®tres de la cam√©ra. <br></li><li>  <b>Monitormanager</b> <br>  Suit les changements d'√©tat de la cam√©ra et informe les autres t√¢ches. <br></li><li>  <b>Peripheralmanager</b> <br>  Cette t√¢che contr√¥le le GPS, la luminosit√© et certains autres capteurs. <br></li><li>  <b>Inconnu</b> <br>  Malheureusement, je n'ai rien trouv√© d'important pour elle. </li></ol><br>  Il est int√©ressant de noter qu'apr√®s le tableau principal, il existe un autre descripteur exceptionnel. <br><br> <code>ROM:100D28 dword_100D28: .long 0x82A0A1F0 <br> ROM:100D2C .long 0x21 <br> ROM:100D30 .long 0 <br> ROM:100D34 .long 0x80000000 <br> ROM:100D38 .long tid16_task <br> ROM:100D3C .long 0x8285EEC0 <br> ROM:100D40 .long 0</code> <br> <br>  Et la fonction de la t√¢che est simplement de se ramifier. <br><br> <code>ROM:101494 sub_101494: <br> ROM:101494 BRA sub_101494 ; CODE XREF: sub_101494</code> <br> <br>  Ce descripteur est r√©f√©renc√© √† la fin de la fonction de <code>start</code> , qui est charg√©e de cr√©er d'autres t√¢ches et de configurer le firmware.  C'est donc probablement la t√¢che de l'inaction du syst√®me. <br><br><h4>  Modules et messages </h4><br>  En plus des t√¢ches, vous pouvez d√©finir certains objets logiques, tels que les modules d'E / S et p√©riph√©riques.  Les modules sont pr√©sent√©s comme un groupe de gestionnaires de messages dans le cadre de l'une des t√¢ches. <br><br>  Le groupe IO semble inclure: <br><br><ul><li>  IO Manager </li><li>  Sous-processeur </li><li>  Gestionnaire USB </li><li>  USB PTP </li><li>  Protocole USB Leica </li><li>  Stockage de masse USB </li><li>  Gestionnaire de boutons </li><li>  Gestionnaire de d√©bogage </li><li>  Gestionnaire d'objectifs </li></ul><br>  Et dans le groupe p√©riph√©rique: <br><br><ul><li>  Gestionnaire de p√©riph√©riques </li><li>  Capteur de lumi√®re </li><li>  LEDs </li><li>  Conf√©rencier </li><li>  Capteur d'inclinaison </li><li>  Reconnaissance de la fermeture de la casquette </li><li>  Module GPS </li><li>  Module 3DAxis </li></ul><br>  Le syst√®me de messagerie lui-m√™me utilise les structures SOFTUNE standard: <br><br><pre> <code class="plaintext hljs">struct RealOS_MsgPayload { uint32_t msgID; // +0x0 uint32_t data[]; // +0x4 } struct RealOS_Message { uint32_t os_reserved1; // +0x0 uint32_t os_reserved2; // +0x4 uint32_t to; // +0x8 uint32_t from; // +0xC RealOS_MsgPayload* payload; // +0x10 }</code> </pre> <br>  Comme pr√©vu, IPC dispose √©galement de plusieurs groupes de messages.  √âtant donn√© que de nombreux messages sont trait√©s dans des t√¢ches et des modules, je n'ai pu r√©cup√©rer que certains de ces groupes: <br><br><pre>  0x1101xxxx - messages syst√®me globaux:
              0x11010002 = SYS_UPDATE_BOOTLOADER ou
              0x11010005 = SYS_ERASE_SETTINGS
 0x1102xxxx - messages li√©s √† la capture d'image:
              0x11020001 = CMD_CAP_CAPTURE ou
              0x11020008 = IMAGE_STATUS_CHANGED  
 0x1104xxxx - messages sur les √©v√©nements li√©s √† la lecture:  <font></font>
             0x11040002 = PLY_DISABLE_PLAY_MODE <font></font>
             0x11040004 = PLY_IMAGE_READY  <font></font>
0x1108xxxx -     PTP  .:<font></font>
             0x11080002 = DBG_CHANGE_LEVEL <font></font>
             0x11080012 = DBG_WRITE_ROM_DUMP_SD  <font></font>
0x2201xxxx -  USB PTP<font></font>
             0x22010108 =    <font></font>
             0x22010118 =  DebugObject  <font></font>
0x2202xxxx -     SUBCPU:<font></font>
             0x22020002 = E_SUBCPU_REQUEST_M_EXPOSURE_REQUEST  <font></font>
             0x22020015 = E_IO_SUBCPU_COMMAND_CLEANING_SENSOR  <font></font>
0x2203xxxx -    :<font></font>
             0x22030001 =   <font></font>
0x2204xxxx -   IO:<font></font>
             0x2204000C = / Mass Storage <font></font>
             0x22040012 =    <font></font>
0x330000xx -     UI:<font></font>
             0x33000001 =  <font></font>
             0x33000007 =  <font></font>
0x440000xx -   ,     <font></font>
             0x44000013 = E_IMG_CMD_CHANGE_PINFO  <font></font>
0x55xxxxxx ‚Äî   FAM:  <font></font>
             0x558800xx = - FAM <font></font>
             0x558888xx =     FAM<font></font>
0x6602xxxx ‚Äî     LED, :<font></font>
             0x66020001 -  LED  X <font></font>
             0x66020002 =   LED  <font></font>
0x6604xxxx -  :<font></font>
             0x66040001 =  <font></font>
             0x66040007 =    <font></font>
0x6611xxxx -  ,   <font></font>
0x6622xxxx -   ,   <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x6660xxxx - quelques autres messages li√©s √† la m√©moire:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
             0x66600006 = HISTOGRAMME  </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
             0x66600011 = RAWCOMP  </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x771100xx et 0x77AA00xx - messages li√©s au changement de mode de cam√©ra </font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Malheureusement, de nombreux autres postes restent inconnus. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GUI </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans le fichier du firmware, nous examinerons √©galement les sections suivantes: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTRL_SYS-11</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-LOKI-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-DSP-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-FPGA-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-LENSDATA-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce qui m'a surpris, c'est le manque total de ressources GUI. Mais ils devraient √™tre quelque part et, tr√®s probablement, int√©gr√©s √† </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-LOKI-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'une de mes approches habituelles pour inverser le d√©veloppement du firmware est de restaurer toutes les r√©f√©rences crois√©es possibles. Non seulement dans le code, mais aussi dans la section des donn√©es. Ensuite, je les regarde, essayant de trouver des mod√®les ou des liens vers des parties connues du code.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le firmware Leica ne fait pas exception. </font><font style="vertical-align: inherit;">Il existe de nombreuses s√©quences de donn√©es similaires avec des adresses √† d'autres s√©quences de donn√©es qui vont plus loin, etc. En gravissant la hi√©rarchie des liens, j'ai finalement vu une fonction famili√®re. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par exemple, j'ai trouv√© une structure de donn√©es sans aucun lien:</font></font><br><br><pre> <code class="plaintext hljs">g_data = { ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Une autre structure l'a abord√©: </font></font><br><br><pre> <code class="plaintext hljs">g_data_struct1 = { ... , &amp;g_data }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Qui √† son tour est d√©sign√© par une autre structure: </font></font><br><br><pre> <code class="plaintext hljs">g_data_struct2 = { &amp;g_data, ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cette structure de donn√©es a un lien depuis le code, et elle est pass√©e en param√®tre √† une autre fonction: </font></font><br><br><pre> <code class="plaintext hljs">func1() ‚ï∞ func2(..., &amp;g_data_struct2, ...)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cependant, </font></font><code>func1()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il n'est pas appel√© directement √† partir d'une autre fonction, mais est stock√© dans un tableau:</font></font><br><br><pre> <code class="plaintext hljs">g_func_list1[] = { ..., func1(), ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En regardant ci-dessus, j'ai trouv√© un appel dans le code </font></font><code>g_func_list1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="plaintext hljs">func3() { g_func_list1[x] }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et encore une fois, cette fonction est stock√©e dans un tableau: </font></font><br><br><pre> <code class="plaintext hljs">g_func_list2[] = { ..., func3(), ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un autre code acc√®de au tableau lui-m√™me: </font></font><br><br><pre> <code class="plaintext hljs">func4() { g_func_list2[x] }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Heureusement, cette fois -ci </font><font style="vertical-align: inherit;">la fonction est appel√©e d' une </font><font style="vertical-align: inherit;">autre fonction, et ainsi de </font><font style="vertical-align: inherit;">suite </font></font><code>gui_MADE_ApplicationRun</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="plaintext hljs">gui_Statemachine_DoStateChange() ‚ï∞ gui_MADE_ApplicationRun() ‚ï∞ func5() ‚ï∞ func4()</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Certaines lignes indiquent que le sous-syst√®me GUI est appel√© ¬´MADE¬ª et les transitions de page sont g√©r√©es en utilisant </font></font><code>MADE_GetSysTri</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ce que cela signifie. </font><font style="vertical-align: inherit;">La machine d'√©tat GUI est essentiellement impl√©ment√©e dans une fonction </font></font><code>gui_Statemachine_DoStateChange</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Apr√®s avoir collect√© des informations sur l'interface graphique, l'image g√©n√©rale s'est d√©gag√©e: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4d4/33e/3cf/4d433e3cf679dba11141d58d080daf5b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comme vous pouvez le voir, la fonction principale des ressources de l'interface graphique est </font></font><code>gui_CopyImageDesc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(bien que ce ne soit pas un vrai nom). </font><font style="vertical-align: inherit;">Elle a les arguments suivants:</font></font><br><br><pre> <code class="plaintext hljs">gui_CopyImageDesc( uint32_t dstAddress; // R4 - destination address UIDescType type; // R5 - description type UITarget target; // R6 - rendering target uint32_t descAddress; // R7 - description address uint8_t always0; // (SP + 0x0) - always 0 uint8_t index1; // (SP + 0x4) - index 1 uint8_t index2; // (SP + 0x8) - index 2 uint16_t x_offset; // (SP + 0xC) - x offset uint16_t y_offset; // (SP + 0x10) - y offset uint16_t unknown2; // (SP + 0x14) - uint32_t language1; // (SP + 0x18) - language id 1 uint32_t language2; // (SP + 0x1C) - language id 2 uint32_t funcAddress; // (SP + 0x20) - function address )</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Il existe quatre types de descriptions de ressources: </font></font><br><br><pre> <code class="plaintext hljs">struct UIDescType0Header struct UIDescType1Header struct UIDescType2 struct UIDescType3 { { { { uint32_t address; uint32_t address; uint32_t reg; uint16_t x_offset; uint16_t entries; uint16_t entries; uint32_t address; uint16_t y_offset; uint16_t unknown; uint16_t unknown; uint16_t unknown1; uint32_t address; } } uint16_t unknown2; } uint16_t unknown3; struct UIDescType0Entry struct UIDescType1Entry uint16_t tableoff; { { } uint16_t x_offset; uint16_t x_offset; uint16_t y_offset; uint16_t y_offset; uint32_t address; uint32_t address; } uint16_t objects; uint16_t total_w; uint16_t total_h; uint16_t unknown; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le premier type a un en-t√™te avec une r√©f√©rence √† un tableau d'enregistrements. Chaque enregistrement a des coordonn√©es et une adresse pour les donn√©es de pixels. Le type actuel semble d√©crire des √©l√©ments d√©pendants de l'√©tat, tels que des ic√¥nes, qui peuvent √™tre gris√©s ou dispara√Ætre de l'interface utilisateur. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le deuxi√®me type commence √©galement par un en-t√™te et est utilis√© pour localiser, d√©crire des lignes ou des blocs de texte. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le troisi√®me type d√©crit les cartes de caract√®res pour diff√©rentes langues. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce dernier type est responsable de toutes les autres ressources statiques, telles que les images, les arri√®re-plans, etc. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Examinons maintenant les donn√©es des images elles-m√™mes. </font><font style="vertical-align: inherit;">Les six premiers octets ressemblent √† un petit en-t√™te, suivi d'une sorte de motif r√©p√©titif, o√π chaque deuxi√®me octet est soit </font><font style="vertical-align: inherit;">, soit </font><font style="vertical-align: inherit;">. Il est logique de supposer que </font><font style="vertical-align: inherit;">et</font></font><br><br> <code>+0x00: 00 08 00 14 00 01 A2 FF 0A 04 05 FF 0C 04 03 FF <br> +0x10: 0D 04 03 FF 0E 04 02 FF 0E 04 02 FF 04 04 06 FF <br> +0x20: 04 04 02 FF 04 04 06 FF 04 04 02 FF 04 04 06 FF <br> +0x30: 04 04 02 FF 04 04 06 FF 04 04 02 FF 04 04 06 FF <br> +0x40: 04 04 02 FF 04 04 06 FF 04 04 02 FF 04 04 06 FF <br> +0x50: 04 04 02 FF 04 04 06 FF 04 04 02 FF 0E 04 02 FF <br> +0x60: 0E 04 02 FF 0D 04 03 FF 0D 04 03 FF 0C 04 04 FF <br> +0x70: 04 04 0C FF 04 04 0C FF 04 04 0C FF 04 04 0C FF <br> +0x80: 04 04 0C FF 04 04 0C FF 04 04 0C FF 04 04 0C FF <br> +0x90: 04 04 0D FF 02 04 2D FF 00 06 00 14 00 01 79 FF</code> <br> <br><font style="vertical-align: inherit;"></font><code>0xFF</code><font style="vertical-align: inherit;"></font><code>0x04</code><font style="vertical-align: inherit;"></font><code>0x0008</code><font style="vertical-align: inherit;"></font><code>0x0014</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- largeur et hauteur dans une vue avec un ordre d'octets direct (big endian). √Ä la fin de ce vidage, nous voyons le d√©but d'une autre s√©quence </font></font><code>00 06 00 14 00 01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il s'agit tr√®s probablement de la prochaine ressource (comme le confirme un lien vers celle-ci). Ainsi, la taille des donn√©es d'image r√©elles est de 146 octets. Mais la taille de l'image doit √™tre 0x8 * 0x14 = 0xA0 = 160. Il est clair que les donn√©es ne sont pas des pixels purs et m√™me pas une LUT 8 bits, car elles sont 14 octets plus petites.</font></font> Alors quoi?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probablement une sorte de compression. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En regardant ce vidage hexad√©cimal, il est difficile de croire qu'une sorte de sch√©ma complexe est utilis√©. L'interface graphique de Leica n'est pas tr√®s color√©e, donc d'apr√®s mon exp√©rience, il est pr√©f√©rable d'utiliser la table LUT ici. Dans ce cas, les ressources de l'interface utilisateur r√©p√©teront compl√®tement les indices LUT comme </font></font><code>03 03 03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>1 1 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En r√®gle g√©n√©rale, le compresseur essaie de se d√©barrasser de la duplication des donn√©es, en les rempla√ßant par un lien. Ces tableaux d'index sont id√©aux pour la compression, m√™me avec une m√©thode simple comme RLE </font></font><code>[data][number]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Une simple commande pour √©crire </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(valeur) </font></font><code>number</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fois. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avec tout cela √† l'esprit, j'ai sugg√©r√© que nous regardions tr√®s probablement une image simple avec deux couleurs LUT ( </font></font><code>0xFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>0x04</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), et l'octet devant la couleur est le nombre de pixels √† dessiner.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Et puis vous avez √©crit un autre instrument¬ª, pensez-vous. Mais non, j'ai pris un stylo et du papier et j'ai commenc√© √† remplir les cellules. C'est dr√¥le que j'ai encore cette photo. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/743/b4a/1f3/743b4a1f3a65f485760e8a4f0584d2e6.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelque part en cours de route, j'ai r√©alis√© que 160 pixels ne suffisaient pas pour cette image, donc 0x8 et 0x14 doivent √™tre multipli√©s par deux. Le troisi√®me mot 0x0001 indique si l'image est un caract√®re ASCII, la structure finale d'ImageAsset est donc la suivante:</font></font><br><br><pre> <code class="plaintext hljs">struct ImageAsset { uint16_t width; // /2 (big endian) uint16_t height; // /2 (big endian) uint16_t ascii; // 1,   ASCII struct image_data { uint8_t number; //     uint8_t color; //     LUT } data[]; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais il manque encore une partie: LUT. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce n'√©tait pas si difficile √† trouver, car de nombreux liens et structures ont d√©j√† √©t√© restaur√©s manuellement, j'ai donc lentement parcouru les sections de donn√©es, √† la recherche d'un tableau de 256 √©l√©ments √† partir de valeurs 16 bits ou 32 bits, jusqu'√† ce que je tombe sur ceci: </font><font style="vertical-align: inherit;">Encore une fois, merci Dans mon travail avec Blackmagic Design, j'ai imm√©diatement reconnu les pixels YUV (par exemple, toutes les valeurs avec les nombres 8080). </font><font style="vertical-align: inherit;">Je ne suis pas dupe de dessiner √† nouveau l'int√©gralit√© de l'interface utilisateur manuellement sur papier, alors oui, j'ai √©crit un autre outil - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">M240UITool</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En plus de r√©initialiser toutes les ressources d'image du fichier du micrologiciel vers BMP / PNG, cet outil peut cr√©er des scripts IDC dans IDA pour d√©terminer toutes les ressources d'interface utilisateur.</font></font><br><br> <code>.long 0x7008080, 0x72D8080, 0x73C8080, 0x75A8080, 0x79B8080, 0x71DFF6B, 0x7BE8080, 0x7FF8080 <br> .long 0x77BBD27, 0x75B60E7, 0x7835F4A, 0x7D3089F, 0x7018080, 0x7028080, 0x7038080, 0x7048080 <br> .long 0x7058080, 0x7068080, 0x7078080, 0x7088080, 0x7098080, 0x70A8080, 0x70B8080, 0x70C8080 <br> .long 0x70D8080, 0x70E8080, 0x70F8080, 0x7108080, 0x7118080, 0x7128080, 0x7952B15, 0x7138080 <br> .long 0x7148080, 0x7158080, 0x7168080, 0x7178080, 0x7188080, 0x7198080, 0x71A8080, 0x71C8080 <br> .long 0x71D8080, 0x71E8080, 0x71F8080, 0x7338080, 0x7208080, 0x7218080, 0x7228080, 0x7238080 <br> .long 0x7248080, 0x7248080, 0x7268080, 0x7278080, 0x7288080, 0x7298080, 0x72A8080, 0x72B8080 <br> .long 0x72C8080, 0x75E8080, 0x7608080, 0x7628080, 0x7648080, 0x7678080, 0x7688080, 0x7698080 <br> .long 0x76B8080, 0x76E8080, 0x7708080, 0x7728080, 0x7758080, 0x7778080, 0x7798080, 0x77C8080 <br> .long 0x77E8080, 0x7818080, 0x7838080, 0x7868080, 0x7888080, 0x78B8080, 0x78D8080, 0x7908080 <br> .long 0x7928080, 0x7958080, 0x7978080, 0x7998080, 0x79C8080, 0x79D8080, 0x7668080, 0x79E8080 <br> .long 0x7A18080, 0x7A28080, 0x7A38080, 0x7A68080, 0x7A78080, 0x7A88080, 0x7AB8080, 0x7AC8080 <br> .long 0x7AD8080, 0x7B08080, 0x7B28080, 0x7B58080, 0x7B88080, 0x7B98080, 0x7BC8080, 0x7CC8080 <br> .long 0x7AB3BBB, 0x7E10094, 0x7E4556E, 0x4008080, 0x2922D17, 0x7B2AB00, 0x7C2A262, 0x71DFF6B <br> .long 0x768D4A2, 0x769D4EA, 0x7BD88AE, 0x705997B, 0x70BB377, 0x711CC73, 0x717E66F, 0x7238866 <br> .long 0x729A262, 0x72FBB5E, 0x735D55A, 0x7417751, 0x747914D, 0x74DAA48, 0x753C444, 0x75F663B <br> .long 0x76B9933, 0x7998080, 0x771B32F, 0x77D5526, 0x7836F22, 0x789881E, 0x78FA21A, 0x7159095 <br> .long 0x71AAA91, 0x720C38D, 0x726DD88, 0x7506F6A, 0x7568866, 0x75CA262, 0x762BB5E, 0x76E5E55 <br> .long 0x7747751, 0x77A914D, 0x780AA48, 0x78C4D3F, 0x792663B, 0x7988037, 0x79E9933, 0x7AA3C2A <br> .long 0x7B05526, 0x7B66F22, 0x7BC881E, 0x72488AE, 0x72AA1AA, 0x72FBBA6, 0x735D4A2, 0x7427799 <br> .long 0x7489095, 0x74DAA91, 0x753C38D, 0x77E556E, 0x7836F6A, 0x7898866, 0x78FA262, 0x79C4459 <br> .long 0x7A15E55, 0x7A77751, 0x7AD914D, 0x7BF4D3F, 0x7CC8080, 0x7C5663B, 0x7CB8037, 0x7337FC8 <br> .long 0x73999C4, 0x73FB2C0, 0x745CCBB, 0x7757799, 0x74C54FF, 0x77B9095, 0x780AA91, 0x7AB3C72 <br> .long 0x7B1556E, 0x7B66F6A, 0x7BC8866, 0x74277E1, 0x74890DD, 0x74EAAD9, 0x754C3D5, 0x76066CC <br> .long 0x7667FC8, 0x76C99C4, 0x772B2C0, 0x77E55B7, 0x7846EB3, 0x78A88AE, 0x790A1AA, 0x7526EFB <br> .long 0x75787F7, 0x75DA1F3, 0x763BAEE, 0x76F5DE6, 0x77577E1, 0x77B90DD, 0x781AAD9, 0x78D4CD0 <br> .long 0x79366CC, 0x79F99C4, 0x7E10094, 0x7CF44A1, 0x7DB7799, 0x7E71A90, 0x7ED338C, 0x7FF8080 <br> .long 0x7328080, 0x7DC8080, 0x7C88080, 0x7508080, 0x775CD2C, 0x76944EA, 0x7808080, 0x71A61FF <br> .long 0x7244D40, 0x7242C15, 0xFFF8080, 0xF338080, 0xF668080, 0xF998080, 0xFCC8080, 0xF008080 <br> .long 0xF4C54FF, 0xFAB3BBB, 0xFE10094, 0xFE4556E, 0xF952B15, 0xFDA7751, 0xFB2AB00, 0xFC2A262 <br> .long 0xF1DFF6B, 0xF68D4A2, 0xF69D4EA, 0xFBD88AE, 0xA922D17, 0xC6E4130, 0xE286963, 0x74C55FF <br> .long 0x768D536, 0x7FF8080, 0x7FF8080, 0x7FF8080, 0x2922D17, 0x46E4130, 0x6286963, 0x8080</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br><br> <code>Leica M (typ 240) UI Tool v1.0 <br> Usage: ./M240UITool [-a address] [-i imagebase] [-s script] [-d dump] [-f folder] [-l LUT] [-rbv] FIRMWARE.BIN <br> <br> This tool will help you to find UI resources in firmware. <br> Use following arguments: <br> -a Specify address of the gui_CopyImageDesc function (ex. 0x2F95E0) <br> -i Specify firmware imagebase <br> -s Specify IDC file name <br> -c Specify container file name <br> -d Specify dump image format <br> png - PNG format <br> bmp - BMP (ARGB) format <br> -f Specify folder for dumped images <br> -l Specify LUT for images (filename of address) <br> -b Specify number of bytes to display in verbose mode <br> -r Try to recover string characters <br> -v Be verbose</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous savons d√©j√† qu'√† partir de la fonction cr√©√©e par une page d'interface utilisateur, elle est appel√©e plusieurs fois </font></font><code>gui_CopyImageDesc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">J'ai pens√© qu'il serait formidable de cr√©er un navigateur de ressources d'interface utilisateur et de d√©finir toutes les fonctionnalit√©s de rendu de page. </font><font style="vertical-align: inherit;">L'option </font></font><code>-c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est </font><font style="vertical-align: inherit;">destin√©e √† cela </font><font style="vertical-align: inherit;">- elle cr√©e un conteneur sp√©cial pour l'affichage des ressources. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et qui a dit qu'un navigateur de ressources d'interface utilisateur pourrait ne pas sembler inhabituel? </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b6/5f7/6c3/8b65f76c30a4d4a037719e805141573a.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âtant interactif (boutons translucides sur la capture d'√©cran), cet outil vous permet non seulement de faire d√©filer les pages du menu EVF / LCD, mais √©galement de visualiser les √©tapes de rendu sur une seule page. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Malheureusement, le code source de ce chef-d'≈ìuvre a √©t√© perdu quelque part, mais les fichiers d'en-t√™te sont toujours dans le code M240UITool, donc techniquement, vous pouvez le recr√©er √† partir de z√©ro.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Menu de d√©bogage </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelle ligne recherchons-nous principalement lors du reverse engineering? √Ä mon avis, ce mot </font></font><code>debug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et ses d√©riv√©s. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il y avait beaucoup de lignes int√©ressantes dans le firmware, mais elles sont sp√©ciales: </font><font style="vertical-align: inherit;">il semble que vous pouvez entrer en mode d√©bogage en utilisant une combinaison de touches. Toutes ces lignes sont appel√©es √† partir d'une fonction g√©ante </font><font style="vertical-align: inherit;">, qui impl√©mente une machine d'√©tat de balayage des boutons. Voici √† quoi cela ressemble dans l'IDA:</font></font><br><br> <code>$ strings ./IMG_LOKI-212_1.1.0.2.bin | grep "Debug Mode" <br> GUI: State: %d! Scanning for Debug Mode successful <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> ... <br> GUI: ScanningForDebugWithKeyAndJoyStick(): g_GUI_CheckForDebugWithKeyAndJoyStick = %d</code> <br> <br><font style="vertical-align: inherit;"></font><code>ScanningForDebugWithKeyAndJoyStick</code><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e9e/525/cd2/e9e525cd2bc493e7bb8cc4b3710b1334.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je ne vais pas mentir, il a fallu un certain temps pour comprendre comment les boutons mat√©riels sont trait√©s dans le firmware, puis restaurer les types √©num√©r√©s pour les boutons et le joystick. Mais quand j'ai obtenu la combinaison, j'ai d√©couvert avec chagrin qu'elle ne faisait rien. Cela ne fonctionne probablement qu'√† partir d'une page GUI sp√©cifique. Encore quelques nuits de tra√ßage manuel de la machine d'√©tat GUI - et le probl√®me est r√©solu, et nous avons √©galement r√©ussi √† trouver la page du menu de r√©initialisation. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enfin, bienvenue en mode d√©bogage. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/526/74d/068/52674d068ae127cc7b90b5b1172de325.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai beaucoup pens√© s'il fallait annoncer cette combinaison, mais j'ai d√©cid√© de m'abstenir. Je respecte le travail acharn√© que fait Leica, en lib√©rant ses appareils uniques, et je ne veux pas √™tre responsable du fait que leurs centres de service remplissent les carcasses cass√©es des cam√©ras √† la suite d'une curiosit√© irr√©fl√©chie.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mais quand m√™me, je fournirai quelques types √©num√©r√©s afin de simplifier l'ing√©nierie inverse pour ceux qui sont pr√™ts √† suivre cette voie. </font></font><br><br><pre> <code class="plaintext hljs">enum ControlActionType { kControlAction_Idle, // 0 kControlAction_Push, // 1 kControlAction_Release, // 2 kControlAction_LongPush // 3 }; enum ControlBtnType { kControlBtn_LV, // 0 kControlBtn_PLAY, // 1 kControlBtn_DEL, // 2 kControlBtn_ISO, // 3 kControlBtn_MENU, // 4 kControlBtn_SET // 5 }; enum ControlJoystickType { kControlJoy_INFO, // 0 kControlJoy_Up, // 1 kControlJoy_Down, // 2 kControlJoy_Left, // 3 kControlJoy_Right // 4 };</code> </pre> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ptp </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En pensant √† la t√¢che USB, j'ai d√©fini trois modes (ce qui est √©galement confirm√© dans le menu de d√©bogage): </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ptp </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MSC (classe de stockage de masse) </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Leica custom </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le PTP est le plus int√©ressant car il est bien document√© et vous permet de contr√¥ler la cam√©ra. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est assez facile de trouver des gestionnaires PTP dans le firmware, car il y a beaucoup d'appels √† partir de ce code. </font><font style="vertical-align: inherit;">Tous les appels PTP sont divis√©s en trois groupes: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Legacy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leica Extended (LE)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Production</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les messages de d√©bogage ont aid√© √† √©tablir des noms pour presque tout le code.</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> H√©ritage: Leica √âtendu: Production:                           </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x1001 - GetDeviceInfo 0x9001 - D√©finir les param√®tres de la cam√©ra 0x9100 - Ouvrir la session de production      </font></font><font></font>
0x1002 - OpenSession 0x9002 - Get Camera Settings 0x9101 - Close Production Session     <font></font>
0x1003 - CloseSession 0x9003 - Get Lens Parameter 0x9102 - UpdateFirmware               <font></font>
0x1004 - Get Storage ID 0x9004 - Release Stage 0x9103 - Open OSD Session             <font></font>
0x1005 - Get Storage Info 0x9005 - Open LE Session 0x9104 - Close OSD Session            <font></font>
0x1006 - GetNumObjects 0x9006 - Close LE Session 0x9105 - Get OSD Data                 <font></font>
0x1007 - GetObjectHandles 0x9007 - RequestObjectTransferReady 0x9106 - GetFirmwareStruct            <font></font>
0x1008 - GetObjectInfo 0x9008 - GetGeoTackingData 0x910B - GetDebugMenu                 <font></font>
0x1009 - GetObject 0x900A - Open Debug Session 0x910C - SetDebugMenu                 <font></font>
0x100A - Get Thumb 0x900B - Close Debug Session 0x910D - ODIN Message                 <font></font>
0x100B - Delete Object 0x900C - Get Debug Buffer 0x910E - GetDebugObjectHandles        <font></font>
0x100E - Initiate Capture 0x900D - Debug Command String 0x910F - GetDebugObject               <font></font>
0x1014 - GetDevicePropDesc 0x900E - Get Debug Route 0x9110 - DeleteDebugObject            <font></font>
0x1015 - GetDevicePropV 0x900F - SetIPTCData 0x9111 - GetDebugObjectInfo           <font></font>
0x101C - Initiate Open Capture 0x9010 - GetIPTCData 0x9112 - WriteDebugObject             <font></font>
                                   0x9020 - Get3DAxisData 0x9113 - CreateDebugObject            <font></font>
                                   0x9030 - OpenLiveViewSession 0x9114 - Calibrate 3Daxis             <font></font>
                                   0x9031 - CloseLiveViewSession 0x9115 - Magnetic calibration         <font></font>
                                   0x9033 - Unknown 0x9116 - Get Viewfinder Data </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'impl√©mentation de l'interface PTP elle-m√™me semble standard, mais certaines commandes ont des limitations que j'omet intentionnellement ici. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans tous les cas, tout ce qui pr√©c√®de est assez excitant. </font><font style="vertical-align: inherit;">Vous pourriez penser: ¬´Branchez simplement l'appareil photo via USB et commencez √† sonder avec libptp.¬ª</font></font> C'est vrai. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bon sang ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leica M240 n'a pas de port USB.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Port de poign√©e </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leica propose peu d'accessoires pour cet appareil photo, mais il y en a un particuli√®rement int√©ressant. </font><font style="vertical-align: inherit;">Nous parlons de la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">poign√©e multifonctionnelle Leica M (14495)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il remplace la partie m√©tallique inf√©rieure du bo√Ætier, fournit un GPS int√©gr√© et plusieurs connecteurs comme USB, un terminal flash SCA, DIN / ISO-X et une prise de courant. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fab/250/1b6/fab2501b6e69cb6caf3f62528e413bdb.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et vous dites √† nouveau: "G√©nial, maintenant achetez-le, fixez-le √† l'appareil photo, connectez l'appareil photo via USB et commencez √† sonder √† l'aide de libptp."</font></font> C'est vrai. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais bon sang ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√áa co√ªte pr√®s de 900 dollars. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est pr√®s de neuf cents raisons de cr√©er votre propre adaptateur. </font><font style="vertical-align: inherit;">Cependant, juste au cas o√π, j'ai configur√© des notifications eBay pour cet accessoire.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Connecteur </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le connecteur de l'appareil photo est le suivant: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a29/4f0/388/a294f0388ad2c5ac3d355d0838e01586.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">j'ai essay√© de le trouver sur Internet, mais s√©rieusement, comment le d√©cririez-vous sur Google? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©sesp√©r√© un peu, j'ai commenc√© √† penser √† des choses folles, comme coller du papier d'aluminium ou des aiguilles sur une gomme en caoutchouc. Mais une fois au travail chez Blackmagic Design, en regardant le circuit imprim√© de la cam√©ra, j'ai remarqu√© que l'un des connecteurs avait une forme tr√®s famili√®re. Le lendemain, j'ai amen√© mon Leica M240 au travail - et oui, il avait l'air similaire, juste beaucoup plus longtemps avec beaucoup de pads. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reste √† demander le num√©ro de pi√®ce de notre gestionnaire de composants, puis √† le retrouver dans le catalogue </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Samtec</font></font></a></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">ERM8-013-05.0-L-DV-TR</font></a></b><font style="vertical-align: inherit;"> . </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a60/dc3/d36/a60dc3d36d12216f74690577507fc6db.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons √©galement demand√© √† Samtec s'il √©tait possible d'obtenir un √©chantillon, et ils ont aimablement accept√©.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/dda/752/0d6/dda7520d6691fc48f3f1aaa026e49635.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un peu de travail avec un fer √† souder, du carton et du ruban √©lectrique - et ma propre prise est pr√™te (√©chantillon de 2013). </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ddd/243/fe5/ddd243fe596648709c3f9dccb76f15ea.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cinq ans plus tard, en 2018, j'ai d√©cid√© de demander personnellement √† Samtec d'envoyer un autre √©chantillon. </font><font style="vertical-align: inherit;">Je voulais faire quelque chose de mieux. </font></font><br><br> <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ERCD-013-05.00-TTR-TTR-1-D</font></font></a></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/e1a/56a/995/e1a56a9958b1dda50aca34f0ecac8863.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Encore une fois, beaucoup de travail avec un fer √† souder, jurer, couper le fil, jurer, travailler √† nouveau avec un fer √† souder pour faire une nouvelle option plus attrayante:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/1a5/b78/10d/1a5b7810d3a2ccea73bf4e2d75cad8cd.png"><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Brochage </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il y a 26 contacts dans le connecteur: 13 de chaque c√¥t√©. Avant m√™me de souder ma pi√®ce, j'ai sond√© le connecteur de la cam√©ra avec un multim√®tre et un analyseur logique. Soit dit en passant, vous devez placer un aimant sur le capteur du couvercle inf√©rieur afin que la cam√©ra consid√®re que le couvercle est en place. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terre (appareil photo √©teint, pas de batterie)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Je pars toujours du sol car c'est s√ªr et tr√®s facile √† trouver. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ead/140/15c/ead14015c97177d6717e198616c9114b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ainsi, nous avons huit lignes au sol (gris fonc√©). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Potentiel (cam√©ra allum√©e)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lorsque la cam√©ra est allum√©e, vous pouvez mesurer le potentiel √† chaque broche et avoir une id√©e de la logique et des niveaux de puissance. </font></font><br><br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alexhude.github.io/assets/2019/2019-01-24-hacking-leica-m240/probe2_potential.png</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les performances sur les broches 8‚Äì9 et 11‚Äì13 sont trop √©lev√©es pour les broches logiques, je les ai donc d√©finies comme alimentation (rouge). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sistance (appareil photo √©teint, pas de batterie)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Il est utile de mesurer la r√©sistance. Dans certains cas, cela permet d'identifier les entr√©es et de regrouper certaines lignes. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fa7/fde/1a6/fa7fde1a623a5f13d264a5127a3083d2.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sorties connect√©es (appareil photo √©teint, pas de batterie)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> J'ai ensuite d√©cid√© de v√©rifier tous les pads externes sur le corps de l'appareil photo pour v√©rifier s'ils sont connect√©s au port de service. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f75/61e/c06/f7561ec060796fa8e39a15d533e3de03.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le contact de synchronisation du flash √©tait directement connect√© √† la ligne 10. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyseur logique (appareil photo allum√©)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Les donn√©es de chaque ligne ont √©t√© enregistr√©es dans l'ordre suivant: allumez, l'appareil photo doit √™tre en mode LV, prendre une photo, d√©marrer l'enregistrement vid√©o.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/494/33c/27c/49433c27cf94be5cb9430e4ba518560c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deux lignes montrent la transmission de certaines donn√©es: 01 et 21. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">01</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 115200, transmission de 8 bits, 1 bit d'arr√™t, bit de parit√©, LSB en premier. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/bf7/3a2/fdf/bf73a2fdfbbfeab571c354f2a6d50c9b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toutes les 500 ms, il envoie un compteur </font></font><code>C3 3C 02 81 00 01 00 82, C3 3C 02 81 01 01 00 83, C3 3C 02 81 02 01 00 80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 115200, transmission de 8 bits, 1 bit d'arr√™t, pas de bit de contr√¥le de parit√©, LSB en premier. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f00/423/2dd/f004232dd3f1b8c8f0e665fd63f3fa9b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il envoie le journal du chargeur de d√©marrage √† SH7216 (¬´Leica Camera AG¬ª dans la capture d'√©cran ci-dessus). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Marquons-les en bleu fonc√©. Il est assez triste que le journal Maestro ne s'√©teigne pas, m√™me avec les param√®tres de d√©bogage maximum dans le menu Debug. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c44/541/bb9/c44541bb98c4388f151bdc3faffa1dfe.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sur ces contacts, la r√©sistance est d'environ 310kOhm.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je ne sais pas pourquoi, mais j'ai sugg√©r√© que d'autres lignes de donn√©es pourraient avoir une r√©sistance similaire ou seraient ferm√©es. Par cons√©quent, j'ai d√©fini les lignes ~ 300kOhm, ~ 200kOhm et ~ 100kOhm comme des lignes de donn√©es (nuances de bleu sur l'image). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En g√©n√©ral, l'image suivante a √©t√© dessin√©e. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e7e/31f/f2c/e7e31ff2cc7da6ae304652488ca9db4c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12 candidats sur la ligne de donn√©es. Mais comment les v√©rifier? Apr√®s une courte conversation avec les experts du fer sur la protection √©lectrique des circuits int√©gr√©s, j'ai commenc√© √† piquer des contacts √† travers une r√©sistance de 4 kOhm, ce qui r√©duit le courant √† un niveau que les entr√©es ne devraient pas br√ªler.</font></font><br><br><h4>  UART </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai fait une autre hypoth√®se que la ligne RX devrait √™tre proche du TX. </font><font style="vertical-align: inherit;">Les lignes 02, 03 et 20 ressemblent √† de bons candidats car les deux ont une tension de 3,3 V comme TX. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au d√©part, j'ai essay√© d'explorer ces lignes en utilisant Bus Pirate. </font><font style="vertical-align: inherit;">Malheureusement, le r√©sultat √©tait plut√¥t sale. </font><font style="vertical-align: inherit;">Ensuite, j'ai pris les c√¢bles bas√©s sur SiLabs comme plus fiables et non conflictuels sur macOS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout d'abord, j'ai connect√© le c√¢ble TX √† la broche 20 et j'ai commenc√© √† taper </font></font><code>help</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apr√®s le chargeur de d√©marrage. </font><font style="vertical-align: inherit;">Comme pr√©vu, apr√®s un court d√©lai, la cam√©ra a r√©p√©t√© les caract√®res. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a16/445/c00/a16445c00b6a22a6b37b74c97fc97ca5.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les contacts 02 et 03 ont √©t√© les prochains candidats √† l'UART. </font><font style="vertical-align: inherit;">Malheureusement, il n'y avait aucun signe que ces lignes √©taient exploit√©es. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans le diagramme, les UART bien connus sont indiqu√©s par une nuance de vert plus sombre.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/733/f68/fa1/733f68fa1950518017ad2c09971ac1f8.png"><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> USB </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout a commenc√© par couper un c√¢ble USB en deux avec un en-t√™te au milieu et des r√©sistances de 4 kOhm pour la d√©tection. </font><font style="vertical-align: inherit;">Int√©grit√© du signal d'une paire diff√©rentielle? </font><font style="vertical-align: inherit;">Non, alors je m'en fichais vraiment.</font></font> :) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/891/930/5d3/8919305d35cd2525d420313c2b0e7555.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ensuite, j'ai sond√© plusieurs appareils domestiques USB √† la maison pour avoir une id√©e de ce √† quoi ressemblent les communications sur ce port. </font><b><font style="vertical-align: inherit;">Appareil photo </font></b></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Canon </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/c49/f85/cf8/c49f85cf89650352531c83c970eb609c.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blackmagic Pocket </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/8b7/7e5/bc8/8b77e5bc8c2fa3387083a8e8ec12c3db.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Camcorder Cam√©scope Canon </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/17f/dd4/67a/17fdd467a6627a4129f38d6e476d4ffc.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cam√©scope JVC </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/757/80d/4c8/75780d4c8a85c55c04afe5de9209e09d.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Porte-cl√©s </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/ad9/3a6/382/ad93a63828797eaea1f5d906367b792f.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appareil photo KidiZoom</font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/32e/d73/13a/32ed7313a12ef1cef1444a87c22f3c77.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ils sont tous un peu diff√©rents, mais l'√©tat D-D + initial est faible. </font><font style="vertical-align: inherit;">Eh bien, nous le saurons, et maintenant nous allons v√©rifier que nous avons:</font></font><br><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - peu probable, car D-D + sont une paire diff√©rentielle et devraient √™tre assez proches;</font></font><br></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">04/05</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - c'est peu probable car ils ont des r√©sistances diff√©rentes;</font></font><br></li><li> <b>14/15</b> ‚Äî ,      ; <br></li><li> <b>15/16</b> ‚Äî ,        . </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai donc connect√© l'USB D-D + aux broches 15/16 et je l'ai connect√© √† l'iMac ... </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/777/491/b7f/777491b7f4a3b4b0f8376931db78c6c8.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sur l'√©cran USB PTP, mais la cam√©ra n'apparaissait pas sur l'h√¥te. J'ai essay√© de configurer diff√©rentes options sur la disposition du circuit √©lectronique, mais rien n'a fonctionn√©. Beagle a montr√© beaucoup de paquets endommag√©s et d'autres erreurs. √Ä la fin, j'ai abandonn√© et suis revenu √† la r√©tro-ing√©nierie du firmware. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il s'agit du brochage final, USB est marqu√© en vert fonc√©. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/2ad/07d/289/2ad07d289a684e6db69a02ae9e50c294.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qui aurait pens√© que quelques ann√©es plus tard, la m√™me notification eBay me parviendrait et j'ach√®terai √† bon march√© l'accessoire souhait√©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enfin, je peux tester mes hypoth√®ses sur PTP. Mais au d√©but, il √©tait tr√®s curieux de voir √† quoi ressemblait l'USB PHY √† l'int√©rieur du gadget. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/afe/0b1/afc/afe0b1afc09953f7f9c6dbc451c47c56.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä l'int√©rieur se trouvait le hub </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SMSC 2512b</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sur la route, de la prise de la poign√©e au connecteur Mini USB. La puce fonctionne en mode par d√©faut car il n'y a pas de broches EEPROM ou SCL / SDA. Le premier port en aval est achemin√© vers une prise sur le corps de la cam√©ra, mais le second n'est connect√© √† rien. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai probablement rat√© quelque chose, mais pour moi une telle solution n'a pas beaucoup de sens. Le passeport technique indique que la puce a "des broches USB enti√®rement int√©gr√©es, ainsi que des r√©sistances pour augmenter et diminuer la tension". Peut-√™tre que les ing√©nieurs de Leica ont d√©cid√© de ne pas impl√©menter leur propre PHY USB, mais ont utilis√© celui du concentrateur, qui est bien test√© et fonctionne d√®s le d√©part. En fait, je ne peux pas leur en vouloir, parce qu'avant j'ai essay√© de faire √ßa, et √ßa s'est av√©r√© √™tre une t√¢che difficile. C'est peut-√™tre une fonctionnalit√© de protection contre les faux, qui sait.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En tout cas, si vous comprenez USB PHY et √™tes pr√™t √† aider, n'h√©sitez pas √† m'√©crire: il devrait √™tre possible de travailler via un port USB sans cet accessoire de marque :) </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PTP √† nouveau </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme je l'ai dit, il est temps de jouer avec l'extension Leica PTP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Heureusement, j'ai trouv√© une biblioth√®que C ++ plut√¥t cool au lieu de libptp - c'est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libEasyPTP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il n'a pas non plus fallu beaucoup de temps pour √©crire un outil bas√© sur cette biblioth√®que: je connaissais d√©j√† certaines limites de l'interface Leica PTP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et bien que M240PTPTool soit assez bogu√©, il convient tout √† fait au r√¥le de preuve de concept ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code de programme</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seules deux demandes passent par PTP: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetDebugBuffer (0x900C)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DebugCommandString (0x900D)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Soit dit en passant, pour que les modules remplissent le journal de d√©bogage, vous devez d√©finir le niveau de d√©bogage sur ¬´Debug¬ª ou ¬´Debug RAW¬ª dans le menu. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il existe plusieurs options dans l'interface M240PTPTool:</font></font><br><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quitter</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - fermer l'outil;</font></font><br></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flush</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - fusionner le tampon de d√©bogage de la cam√©ra:</font></font></li></ul><br> <code>M240&gt; flush <br> I:[00:11:468]|01| DATE/TIME CORRECTED by 5921 sec <br> D:[00:12:079]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:179]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:282]|11| Message received from TID 0 for TID 1 over MBX 3 <br> D:[00:12:283]|11| Message received from TID 0 for TID 1 over MBX 3 <br> D:[00:12:301]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:402]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:502]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> ...</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout autre texte est envoy√© √† la cam√©ra en tant que commande de d√©bogage. </font><font style="vertical-align: inherit;">Par exemple, il </font></font><code>help</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">affiche toutes les commandes possibles avec des arguments: La </font><font style="vertical-align: inherit;">liste compl√®te est assez grande, mais regardez, vous pouvez envoyer des messages directs √† Softune pour n'importe quelle t√¢che! </font><font style="vertical-align: inherit;">Ce qui serait si int√©ressant √† envoyer l√†-bas ... </font><font style="vertical-align: inherit;">Une autre ligne populaire qui est souvent recherch√©e dans le firmware est </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Voyons voir si nous en avons un. </font><font style="vertical-align: inherit;">Apparemment, vous pouvez vider le firmware sur la carte SD. </font><font style="vertical-align: inherit;">En utilisant le lien vers la ligne ¬´Dumping files to card¬ª, il est facile de trouver le code responsable de cela. </font><font style="vertical-align: inherit;">Il est situ√© dans le bloc de t√¢ches syst√®me g√©ant (pid 11, comme nous le savons d√©j√†) et est appel√© par le message </font><font style="vertical-align: inherit;">sans arguments. </font><font style="vertical-align: inherit;">Dial </font><font style="vertical-align: inherit;">dans </font><b><font style="vertical-align: inherit;">M240PTPTool</font></b><font style="vertical-align: inherit;"> , appuyez sur Entr√©e et regarder l'√©cran.</font></font><br><br> <code>M240&gt; help <br> ********* debug command description ******** <br> <br> exposure request <br> Description: requests a release from Sub CPU <br> Parameter 1: Exposure Time TV <br> <br> still request <br> Description: simulates the -still request- command flow of Sub CPU <br> Parameter: no <br> <br> ... <br> <br> send Message;[Parameter1];[Parameter2];[Parameter2];...;... <br> Description: Sending Message to Task <br> Parameter 1: Receiver Task ID <br> Parameter 2: Command ID <br> Parameter 3: Command Data[0] (32 Bit) <br> Parameter 4: Command Data[1] (32 Bit) <br> Parameter 5: . <br> Parameter 6: . <br> use maximum 10 Parameter <br> <br> ...</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>dump</code><font style="vertical-align: inherit;"></font><br><br> <code>$ strings IMG_LOKI-212_1.1.0.2.bin | rg -i dump <br> GUI: HEX DUMP: Address: %x, Length: %d <br> HSK: DBG_WRITE_ROM_DUMP_SD: File was properly opened, but it seems to be empty. <br> ROM_DUMP <br> HSK: DBG_WRITE_ROM_DUMP_SD: Flushing Dump to ROM. Size %d <br> SD:\ROM_DUMP.bin <br> HSK: DBG_WRITE_ROM_DUMP_SD Command received! <br> ROM_DUMP.bin <br> HSK: DUMP failed, no cards inserted! <br> HSK: DUMP FlashROM to SD card. <br> HSK: DUMP FlashROM to CF card. <br> Dumping files to card</code> <br> <br><font style="vertical-align: inherit;"></font><code>0x11080006</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>send Message;11;0x11080006</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4de/1cc/e2e/4de1cce2e0ee47a67645df790a7e581c.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retirez ensuite la carte SD et v√©rifiez ce qu'elle contient. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/209/2a8/25e/2092a825e23cb93c4845b416ea11b0e4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le voici, un vidage complet, y compris le firmware. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela ouvre des possibilit√©s infinies. </font><font style="vertical-align: inherit;">Par exemple, vous pouvez faire un petit appareil avec un MCU, la prise en charge d'un h√¥te USB et des boutons pour lancer des s√©quences complexes de messages ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et puis nous avons eu un deuxi√®me enfant.</font></font> :) <br><br><h1>  √âpilogue </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous ne voulez pas casser l'appareil, il existe g√©n√©ralement un moyen de l'examiner sans ouvrir le bo√Ætier ni souder les fils √† la carte de circuit imprim√©. </font><font style="vertical-align: inherit;">Voici mes conseils si vous √™tes int√©ress√©:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retrouvez toutes les informations publiques sur l'appareil: sp√©cifications techniques, donn√©es sur les composants, photos de l'int√©rieur, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vid√©o de l'usine</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;)</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si vous avez un firmware, explorez-le et recherchez des conseils sur les sorties externes; </font></font><br></li><li>        ,     ; <br></li><li>  GND//    ,  ; <br></li><li>     ; <br></li><li>     ,   ; <br></li><li>   ,     (, ); <br></li><li>        ,    Google   (USB/UART/SPI/I2C/1Wire); <br></li><li>      ,      ; <br></li><li>  <s></s>  ,      ; <br></li><li>  ,    . </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/18b/006/166/18b006166a4070202c1be3a9b946c3e9.png"><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/alexhude</a> <br><br> <b>  !</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr438168/">https://habr.com/ru/post/fr438168/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr438152/index.html">¬´Je peux vous parler de la douleur que chaque d√©veloppeur iOS a dans le cul¬ª - 10 questions √† un d√©veloppeur, √©pisode 2</a></li>
<li><a href="../fr438158/index.html">Les courtiers de donn√©es am√©ricains vendent des donn√©es de localisation sans le consentement de l'utilisateur - leur travail sera r√©glement√©</a></li>
<li><a href="../fr438162/index.html">Le tuple d'une personne en bonne sant√©</a></li>
<li><a href="../fr438164/index.html">G√©n√©tique et poulets: prot√©ine CSF1-Fc humaine dans la prot√©ine d'oeuf</a></li>
<li><a href="../fr438166/index.html">Interaction entre un site dans un navigateur et un programme ex√©cut√© localement</a></li>
<li><a href="../fr438170/index.html">Prix ‚Äã‚Äãnomm√© d'apr√®s Ilya Segalovich. Histoire de l'informatique et publications de lancement</a></li>
<li><a href="../fr438172/index.html">Apple incapable de d√©placer la production de ses appareils aux √âtats-Unis</a></li>
<li><a href="../fr438174/index.html">Jaune - Vide - Nuage</a></li>
<li><a href="../fr438176/index.html">Pr√©sentation d'IPSec chez Mikrotik</a></li>
<li><a href="../fr438178/index.html">Cr√©ation de votre premi√®re application ARCore</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>