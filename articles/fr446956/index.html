<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìí üíç üèΩ C'est nocif pour la lumi√®re, ou comment garder la charge d'une batterie de voiture üçë ‚öíÔ∏è ü•™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je poursuis la s√©rie d'articles sur la construction de v√©los dans le domaine de la gestion des circuits √©lectriques basse tension. Cette fois, je vais...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C'est nocif pour la lumi√®re, ou comment garder la charge d'une batterie de voiture</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446956/">  Je poursuis la s√©rie d'articles sur la construction de v√©los dans le domaine de la gestion des circuits √©lectriques basse tension.  Cette fois, je vais parler d'un appareil qui emp√™che la d√©charge profonde d'une batterie de voiture par divers consommateurs secondaires. <br><br><img src="https://habrastorage.org/webt/_p/pt/zv/_pptzvndfwivnln2xsqz7aae224.jpeg"><br>  <i>L'une des cons√©quences possibles d'une d√©charge incontr√¥l√©e.</i> <br><a name="habracut"></a><br>  L'achat de la premi√®re voiture ou moto est une √©tape importante dans la vie de chaque personne, et en particulier d'un ing√©nieur.  Apr√®s tout, qui d'autre que les avantages √©vidents de son nouveau cheval de fer pr√™te imm√©diatement attention √† ses inconv√©nients non √©vidents?  Qui commence imm√©diatement √† penser √† des am√©liorations et des ajouts √† la norme?  Bien s√ªr, s'il s'agit d'une voiture du segment sup√©rieur, et m√™me d'une marque "√† la mode", il peut sembler au d√©part qu'elle a absolument tout.  Mais, comme le montre la pratique, dans ce cas, le temps r√©fute les premi√®res impressions.  Si vous achetez une voiture de classe √©conomique, vos mains commencent √† vous d√©manger litt√©ralement d√®s le premier jour! <br><br>  Le d√©sir de "bourrer" votre voiture de divers appareils √©lectroniques auxiliaires est tout √† fait naturel.  Cependant, peu de temps apr√®s la mise en ≈ìuvre de tous ces plans, la vie confronte le propri√©taire de la voiture √† une dure r√©alit√©.  Il s'av√®re que m√™me les appareils les plus modernes construits sur la derni√®re base √©l√©mentaire sont encore assez avides d'√©lectricit√©.  Et une batterie de voiture qui semble si √©norme n'est pas du tout un r√©acteur nucl√©aire et peut facilement ¬´s'asseoir¬ª sous le poids de tous ces consommateurs apparemment inoffensifs en quelques jours. <br><br>  Afin de ne pas entrer plus loin dans des situations abstraites et hypoth√©tiques, je vais aller directement √† mon histoire.  Apr√®s avoir achet√© une voiture, le premier √©tait le d√©sir d'y mettre un registraire.  Cela a √©t√© fait dans les plus brefs d√©lais, presque compl√®tement dict√© par la rapidit√© de livraison du colis d'AliExpress.  Il est clair que l'alimentation r√©guli√®re de l'allume-cigare √©tait extr√™mement g√™nante, et l'enregistreur a rapidement obtenu une connexion fixe avec la ligne la plus proche du r√©seau de bord via un convertisseur d'impulsions 12 / 5v.  Et depuis  c'√©tait, pour le moins, pas hier, ce convertisseur n'√©tait m√™me pas moderne, pour ses propres besoins, comme il s'est av√©r√© plus tard, il consommait jusqu'√† 21 mA de courant.  Estimons maintenant combien ce convertisseur pourrait alimenter uniquement une batterie neuve et enti√®rement charg√©e d'une capacit√© de 60 Ah.  L'arithm√©tique est extr√™mement simple et d√©cevante. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lj/kz/tb/ljkztbra63ol-bs6xwdpdxd4xjg.png"></div><br>  Ainsi, en moins de quatre mois, un convertisseur qui n'est charg√© de rien fera atterrir la batterie litt√©ralement ¬´√† z√©ro¬ª.  Si nous prenons en compte qu'une batterie qui n'est pas enti√®rement fra√Æche peut facilement devenir moins veuve et que la charge apr√®s la ville de pokatushki est loin de 100%, un jour de pluie commence facilement dans un mois avec un crochet. <br><br>  Et c'est tout, je le r√©p√®te, seulement un convertisseur de tension.  Oui, aujourd'hui, vous pouvez acheter un convertisseur qui ne prend que la moiti√© d'un milliamp√®re pour ses propres besoins, mais j'ai donn√© cet exemple juste pour montrer √† quel point l' <s>eau aff√ªtait une pierre</s> lentement, en toute confiance <s>,</s> m√™me insignifiante, mais agissant constamment, le consommateur tire de l'√©nergie de ce qui semble √™tre si √©norme batterie. <br><br>  Nous allons plus loin, l'enregistreur en mode d'enregistrement FHD @ 30fps consomme pr√®s de 300 mA de la source + 5v, qui apr√®s conversion en tenant compte de l'efficacit√© fournit environ 150 mA de courant du r√©seau embarqu√©.  Supposons que le convertisseur soit remplac√© par un convertisseur moderne, et nous calculons le temps de d√©charge uniquement avec ce courant. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uf/p8/fl/ufp8fldn4t5bfzpl8u8udb6fd3o.png"></div><br>  Un peu plus de deux semaines, mais en pratique - dix jours.  Maintenant, la perspective d'un √©clairage (et √©ventuellement d'un changement de batterie) se profile apr√®s les prochaines vacances ou voyages d'affaires. <br><br>  Et c'est ce qui m'est arriv√©: quand je suis parti pour de courtes vacances forc√©es, je ne pensais pas que dans une semaine environ, m√™me une serrure centrale ne pourrait pas ouvrir la porte pour moi. <br><br>  Beaucoup diront que c'est de leur faute, que tout doit √™tre mis hors tension, ou du moins arr√™ter l'enregistrement, et ils auront raison.  Mais la vie, c'est la vie, et la m√©moire n'est pas la m√™me, et combien de temps dure le petit cong√© de maladie n'est pas toujours possible de savoir √† l'avance.  Par cons√©quent, l'id√©e d'un disjoncteur est imm√©diatement apparue. <br><br>  Il y a, bien s√ªr, une option pour alimenter l'enregistreur √† partir du contacteur d'allumage afin qu'il ne fonctionne que sur la route, mais cette option n'est pas tr√®s importante non plus, car  si la voiture heurte le parking, j'aimerais avoir une chance de voir le coupable.  De plus, peu de temps apr√®s l'installation de l'enregistreur, la voiture √©tait en sous-effectif avec plusieurs autres appareils, y compris un tracker GPS cach√©, qui devrait fonctionner, sinon jusqu'√† la fin, du moins jusqu'√† ce que ¬´presque tout¬ª soit d√©j√† l√†. <br><br>  En g√©n√©ral, pendant plusieurs semaines de r√©flexion passive, l'id√©e d'un appareil qui devrait contr√¥ler la tension du r√©seau de bord et bas√© sur ces donn√©es pour contr√¥ler l'alimentation de deux groupes de consommateurs: secondaire (enregistreur, prise USB) et basique (GPS-tracker et quelques-uns quoi). <br><br><h3>  Comment cela pourrait-il √™tre fait </h3><br>  Les premiers prototypes virtuels de l'appareil ont √©t√© ¬´construits¬ª sur la base des comparateurs analogiques LM393N et ont pu tout ce qui √©tait initialement pr√©vu pour √™tre re√ßu de l'appareil.  Le sch√©ma abstrait √©tait quelque chose comme √ßa. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cf/la/yb/cflaybsmn6m3e6o7mshcfb_1j20.png"></div><br>  Ici, deux comparateurs sont utilis√©s pour commuter les charges.  Un g√©n√©rateur de tension de r√©f√©rence commun, deux diviseurs qui d√©terminent les seuils de fonctionnement, des comparateurs de cerclage, deux interrupteurs de puissance.  La liaison externe de l'appareil fini est pr√©vue comme suit. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0m/77/ew/0m77ewzvozy52h6zr-fg7uaivg0.png"></div><br>  La cl√© primaire reste allum√©e plus longtemps que la cl√© secondaire, donc le convertisseur abaisseur lui-m√™me est aliment√© √† travers elle.  Les charges primaires sont connect√©es directement au convertisseur.  Le commutateur secondaire commute les charges secondaires d√©j√† dans le circuit + 5v √† la sortie du variateur. <br><br><h3>  Ce qui est finalement sorti </h3><br>  Cela semble √™tre tout ce qui est n√©cessaire, mais, comme cela arrive souvent, avec la pens√©e des d√©tails, des id√©es d'impl√©mentations alternatives sont apparues.  Premi√®rement, le circuit analogique contenait une montagne d√©cente d'√©l√©ments discrets qui fournissent des modes de fonctionnement du comparateur, et deuxi√®mement, les seuils de d√©clenchement sont cens√©s √™tre d√©finis √† l'aide de r√©sistances de trim, ce qui complique la configuration et cr√©e la probabilit√© de ¬´s'√©loigner¬ª des secousses et du temps.  Par cons√©quent, il a finalement √©t√© d√©cid√© de s'attarder sur une impl√©mentation num√©rique, qui s'est av√©r√©e √™tre beaucoup plus simple √† la fois sch√©matiquement et dans la configuration, tout en ouvrant d'√©normes opportunit√©s pour am√©liorer l'algorithme de contr√¥le, et, plus important encore, dans ce contexte, il s'est av√©r√© √™tre un ordre de grandeur plus √©conomique en termes de consommation actuelle. <br><br>  Le contr√¥leur ATtiny13A a simplement demand√© le c≈ìur de l'appareil, qui, en plus de sa facilit√© d'utilisation et de son prix abordable, est toujours disponible dans un √©tui DIP √† tube chaud et chaud pour oldfag.  Au d√©part, les capacit√©s d'un contr√¥leur aussi petit semblaient redondantes sur tous les fronts, du nombre d'entr√©es / sorties √† la quantit√© de programme et de RAM, cependant, comme vous le savez, l'app√©tit vient avec un repas.  En cons√©quence, pour l'avenir, je dirai que la version finale du bo√Ætier s'est av√©r√©e √™tre toutes les conclusions du microcircuit, et qu'il n'y avait pas plus de deux douzaines d'octets de m√©moire de programme libre. <br><br>  Pour mesurer la tension du r√©seau de bord, le microcontr√¥leur ne n√©cessitait qu'une seule entr√©e, qui est reli√©e √† l'ADC.  Deux autres sorties logiques consistaient √† g√©rer les consommateurs.  Tout d'abord, apr√®s la transition mentale finale vers le ¬´num√©rique¬ª, il y avait une volont√© d'adapter deux GPIO gratuits √† l'entreprise, et la d√©cision n'a pas tard√© √† venir.  Lorsque, une fois de plus, dans le froid, le d√©marreur a fait tourner le moteur avec une d√©chirure mal dissimul√©e, la pr√©sence d'un capteur de temp√©rature dans le circuit et l'algorithme a sembl√© tr√®s utile.  En cons√©quence, le deuxi√®me ADC a √©t√© utilis√© pour mesurer la temp√©rature.  Et pour que la thermistance ne consomme du courant que lorsque cela est n√©cessaire, il a √©t√© d√©cid√© de l'alimenter √† partir de la derni√®re sortie logique restante. <br><br>  En cons√©quence, le sch√©ma de l'appareil a acquis une telle forme finale. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jh/ct/dt/jhctdt_pol1pk6xum1wwn_n7jzo.png"></div><br>  Ici, nous voyons le minimum de d√©tails, et parmi eux, rien n'est sujet √† aucune sorte de ¬´torsion¬ª.  Passons bri√®vement en revue les points principaux. <br><br>  Pour l'alimentation, le contr√¥leur a besoin d'une tension stable de 1,8 √† 5,5 V, ce qui signifie qu'il doit y avoir un stabilisateur dans le circuit qui abaissera la tension du r√©seau de bord au niveau requis.  Du point de vue des √©conomies d'√©nergie, il peut sembler qu'il y a une place pour un convertisseur abaisseur exclusivement puls√©, mais ce n'est qu'√† premi√®re vue.  Le fait est que ATtiny13A, m√™me dans le mode de fonctionnement le plus √©nergivore (fr√©quence 8 MHz, ex√©cution de code active), ne consomme pas plus de 6 mA.  Dans ce sch√©ma, le contr√¥leur 99% du temps est en mode de sommeil profond et fonctionne √©galement √† une fr√©quence de 1,2 MHz, ce qui entra√Æne une consommation moyenne d'environ moins de 15 ¬µA.  De plus, environ 80 ¬µA aux courants de base des transistors de commande (si les deux charges sont activ√©es).  Eh bien, pendant une petite fraction de seconde, la puissance de la thermistance est activ√©e, ce qui ajoute environ 25 microamp√®res au courant moyen.  Et voici la r√©ponse √† la question ¬´cela vaut-il la peine de charger un convertisseur d'impulsions pour le bien d'une charge d'une consommation ne d√©passant pas 120 ¬µA?¬ª  Cela ne semble pas si simple.  Et si nous consid√©rons qu'il s'agit de mesures analogiques, cela n'en vaut certainement pas la peine.  Par cons√©quent, le stabilisateur lin√©aire LP2950 a √©t√© utilis√©, un analogue fonctionnel du populaire 78L05, mais beaucoup plus √©conomique.  Ce convertisseur peut fournir jusqu'√† 100 mA de courant √† la sortie, tout en ne consommant pas plus de 75 ¬µA pour l'√™tre aim√©. <br><br>  Le diviseur de tension du r√©seau de bord, prot√©g√© par une diode zener et un condensateur, vous permet de mesurer des tensions jusqu'√† 15 V. <br><br><blockquote>  Je sais que maintenant une vague de critiques va me frapper pour une telle d√©cision, mais nous serons objectifs.  Premi√®rement, je ne d√©veloppe pas de satellite, et deuxi√®mement, il n‚Äôexiste pas un seul facteur de ce genre qui conduirait √† une catastrophe.  La r√©sistance de l'√©paule est √©lev√©e, la diode zener est capable de d√©tourner beaucoup plus de courant que celui qui peut traverser le diviseur, m√™me dans le sc√©nario le plus pessimiste.  √Ä partir des impulsions √† haute fr√©quence, lorsque la diode Zener n'a pas assez de vitesse, le condensateur C2 prot√®ge (avec une r√©sistance R7, il cr√©e un filtre passe-bas avec une fr√©quence de coupure de seulement 7 Hz).  D1 et R6 assurent dans une certaine mesure que le syst√®me ne se tombera pas.  Et il ne faut pas oublier la lin√©arit√©, toute m√©thode d'isolement galvanique dans un tel endroit rendra le calcul th√©orique des quantit√©s compl√®tement irr√©aliste, nous devrons calibrer au moins le prototype, mais nous n'en avons pas besoin. </blockquote><br>  La r√©sistance de sortie du diviseur est dix fois sup√©rieure aux 10 kOhm recommand√©s pour la source de signal ADC, mais gr√¢ce au condensateur C2, il n'y a pas de probl√®mes de mesure. <br><br><blockquote>  En g√©n√©ral, l'imp√©dance d'entr√©e des circuits ADC des contr√¥leurs AVR selon la fiche technique est d√©clar√©e d'au moins 100 m√©gohms.  Cependant, la m√™me fiche technique recommande n√©anmoins d'utiliser des sources avec une r√©sistance interne jusqu'√† 10 kOhm.  Pourquoi  Le point est le principe de fonctionnement de cet ADC lui-m√™me.  Le convertisseur fonctionne sur le principe de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'approximation s√©quentielle</a> et son circuit d'entr√©e est un filtre passe-bas d'une r√©sistance et d'un condensateur.  L'obtention d'un √©chantillon de 10 bits est it√©rative, et il est n√©cessaire que le condensateur soit charg√© √† la pleine tension mesur√©e pendant tout le temps de mesure.  Si l'imp√©dance de sortie de la source est trop grande, le condensateur continuera √† √™tre charg√© directement pendant le processus de conversion et le r√©sultat sera inexact.  Dans notre cas, la capacit√© C2 est plus de sept mille fois la capacit√© du filtre ADC, ce qui signifie que lorsque la charge est redistribu√©e entre ces condensateurs lorsqu'ils sont allum√©s au moment de la mesure, la tension d'entr√©e ne diminuera pas de plus de 1/7000, soit sept fois inf√©rieure √† la pr√©cision ultime d'un ADC 10 bits.  Certes, vous devez garder √† l'esprit que cette astuce ne fonctionne que pour des mesures uniques avec des pauses importantes entre elles, vous ne devez donc pas "am√©liorer" le programme de contr√¥le en y ajoutant une boucle pour plusieurs mesures cons√©cutives avec la moyenne du r√©sultat. </blockquote><br>  Le diviseur avec une thermistance en raison de la pr√©sence d'une source d'alimentation contr√¥l√©e est construit en utilisant les valeurs recommand√©es.  Le NTCLE100E3 est utilis√© comme capteur, mais il n'y a aucune restriction, vous pouvez utiliser n'importe quelle thermistance d'environ la m√™me valeur, l'essentiel est de faire des corrections correspondant √† sa caract√©ristique dans les constantes du code source afin que la tension du diviseur soit convertie √† la valeur de temp√©rature correcte. <br><br>  En tant que touches de commande, des MOSFET de canal P de puissance de tout type sont utilis√©s avec une r√©sistance de canal ouvert acceptable et une tension drain-source maximale d'au moins 30 volts.  Le circuit ci-dessus utilise diff√©rents transistors.  Cela est d√ª au fait qu'ils doivent commuter des tensions diff√©rentes et le type de chacun d'eux a √©t√© s√©lectionn√© pour des conditions de travail sp√©cifiques.  Le transistor sup√©rieur doit √™tre plus haute tension, et le inf√©rieur doit, si possible, avoir une r√©sistance de canal ouvert minimale.  Mais, je le r√©p√®te, cette d√©cision est dict√©e par le circuit de commutation de l'appareil (voir ci-dessus), avec une autre inclusion, les exigences pour le transistor inf√©rieur peuvent √™tre diff√©rentes. <br><br>  Pour contr√¥ler les interrupteurs de puissance, une paire de transistors bipolaires identiques est utilis√©e.  Au d√©but, il peut sembler que ces transistors sont superflus, mais ici ce n'est pas si simple.  Les transistors √† effet de champ avec une grille isol√©e commencent √† s'ouvrir non pas √† partir d'une tension de la polarit√© requise sur la grille, mais seulement apr√®s avoir atteint un certain niveau de seuil, qui appara√Æt dans les fiches techniques sous le nom de ¬´tension de seuil grille-source¬ª et est g√©n√©ralement √©gal √† 2..4 V. comptez.  Le circuit de sortie du contr√¥leur peut former deux niveaux logiques: "0" logique avec une tension tendant vers z√©ro;  et ¬´1¬ª logique avec une tension tendant √† fournir.  Lorsqu'elles sont aliment√©es par 5 volts, ce seront des tensions d'environ 0 et 5 V, respectivement.  Par cons√©quent, lors de la commutation d'une source de 12 volts, un ¬´0¬ª logique sur la grille cr√©era une diff√©rence de tension entre la source et la grille 12 - 0 = 12 volts, le transistor de puissance est ouvert.  Tout semble normal, mais le ¬´1¬ª logique avec sa tension de 5 V cr√©era une tension entre 12 - 5 = 7 volts entre la source et la grille, et le transistor de puissance restera toujours ouvert.  Ainsi, le signal de commande de cinq volts ne peut pas contr√¥ler la cl√©, qui commute la tension au-dessus de 7..9 volts.  Par cons√©quent, les transistors bipolaires de commande ne fonctionnent pas vraiment avec des touches de signal comme des amplificateurs qui √©l√®vent la tension de commande de 5 volts √† la tension du r√©seau de bord. <br><br>  La r√©sistance dans le circuit de base de chacun des transistors de commande limite simplement le courant des sorties du contr√¥leur √† un niveau suffisant pour le contr√¥ler.  Leurs valeurs nominales peuvent √™tre r√©duites de deux √† trois fois sans cons√©quences pour le fonctionnement du circuit. <br><br><blockquote>  Il est facile de voir que les transistors de commande n'√©taient pas dans le circuit analogique bas√© sur le LM393N.  Le fait est que l'√©tage de sortie du comparateur s√©lectionn√© est construit selon le circuit √† collecteur ouvert, c'est-√†-dire que sa sortie est simplement la sortie du collecteur √† transistor terminal.  Ce principe de construction n√©cessite que des pi√®ces suppl√©mentaires soient accroch√©es √† la puce pour cr√©er la charge de l'√©tage de sortie, mais, d'autre part, rend la puce tr√®s flexible.  Un collecteur ouvert permet au comparateur de contr√¥ler toute source de courant acceptable, et pas seulement compatible avec celle qui alimente le comparateur lui-m√™me. </blockquote><br>  Je dois dire que limiter la tension de seuil d'un MOSFET de puissance fonctionne non seulement vers les hautes tensions, comme mentionn√© ci-dessus, mais aussi vers les basses.  Apr√®s tout, si la tension d'ouverture minimale du transistor est, disons, de 4 volts, alors lors de la commutation de la source 3,3 V, m√™me la connexion de la grille √† la terre ne cr√©era pas la diff√©rence de tension souhait√©e entre la source et la grille et le transistor restera ferm√©.  Donc, 5 volts est, peut-√™tre, la tension minimale qui peut √™tre commut√©e de mani√®re fiable par les transistors s√©lectionn√©s. <br><br><h3>  Personnalisation </h3><br>  La configuration d'un appareil est une conversation distincte.  D'une part, il n'y a pas un seul √©l√©ment d'accord dans le circuit, mais d'autre part, il s'agit de mesurer des tensions avec une pr√©cision d'au moins 0,1 V. Comment lier tout cela?  Il y a deux fa√ßons.  La premi√®re consiste √† utiliser des r√©sistances R6, R7 et R8 avec une tol√©rance d'au moins 1% (ou mieux 0,1%).  La seconde implique l'utilisation de r√©sistances conventionnelles avec mesure de leurs r√©sistances r√©elles et correction des coefficients dans le code source du programme. <br><br>  La premi√®re m√©thode est bonne pour la production de masse, mais il est beaucoup plus int√©ressant pour nous de ne pas nous soucier de la recherche des valeurs de haute pr√©cision n√©cessaires, alors allons-y dans la deuxi√®me voie.  La r√©sistance peut √™tre mesur√©e avec un multim√®tre ordinaire, sa pr√©cision ici est tout √† fait suffisante.  Un autre objet de mesure sera la tension du stabilisateur alimentant le circuit.  L'ADC du contr√¥leur peut fonctionner dans diff√©rents modes, mais pour plusieurs raisons, il est plus pratique pour nous d'en utiliser un dans lequel le r√©sultat de la conversion num√©rique est compt√© par rapport √† la tension d'alimentation.  C'est pourquoi il est important de le conna√Ætre le plus pr√©cis√©ment possible. <br><br>  Le calcul est extr√™mement simple et consiste √† calculer le coefficient de division du diviseur r√©sistif et la proportion de la traduction du r√©sultat en LSB lors de la conversion analogique-num√©rique. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/s-/-q/vf/s--qvfm_z0imo_xg5r7tnskhze0.png"></div><br>  Ux est la tension d'entr√©e du diviseur; <br>  Ru est la r√©sistance du bras sup√©rieur du diviseur (auquel Ux est fourni); <br>  Rd est la r√©sistance du bras inf√©rieur du diviseur (qui est reli√© √† la terre); <br>  Uref - tension de r√©f√©rence de l'ADC (c'est-√†-dire la tension d'alimentation du contr√¥leur); <br>  1024 - le nombre de valeurs discr√®tes √† la sortie d'un ADC 10 bits; <br>  LSB est la valeur num√©rique obtenue par le programme de l'ADC. <br><br>  Commen√ßons par le diviseur de tension R6-R7.          .     5.0 .      13.5 : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nr/ic/a2/nrica2q5vtygw-ck3mstvspkm4y.png"></div><br>      ,      ,       ,    . <br><br>   ,  ,     ,      Ru,  Ux    Uref.     : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zv/t7/qi/zvt7qi05g21ecwvaquqnjdbhjli.png"></div><br>     R8  ,  R9    NTCLE100E3   0‚Å∞C: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/j5/gp/_k/j5gp_kzjcx3buv0ayejxoazlwcu.png"></div><br><blockquote>   ,        R8  R9      ,  , ,  . .       ,    R9   ,        0.5 m,       .   ,            ,   0.01 . </blockquote><br>         ,  , ,   .     ,                         .    -     ,        . <br><br> ,         ,      ,           . <br><br><h3>  Firmware </h3><br>     AtmelStudio ( gcc-avr 5.4.0)   <a href=""></a> ,     <a href="">hex</a> .      ,    . <br><br><div class="spoiler">  <b class="spoiler_title">Code source</b> <div class="spoiler_text"><pre><code class="cpp">//#define F_CPU 1200000UL //    

#include &lt;avr/io.h&gt;
#include &lt;avr/wdt.h&gt;
#include &lt;avr/sleep.h&gt;
#include &lt;avr/interrupt.h&gt; 
#include &lt;util/delay.h&gt;

//#define DBG

#define TEMPERATURE_OVERHEAT 753 // LSB-  +50‚Å∞C
#define TEMPERATURE_GIST     8   //    ( LSB)     
#define VOLTAGE_GIST         3   //    ( LSB)     

#define INTERVAL             WDTO_1S //     (1 )
#ifndef DBG
#define CELL_CHANGE_TIMEOUT  90  //      (  INTERVAL,   254)
#define OVERHEAT_TIMEOUT     300 //      "" (  INTERVAL)
#else
#define CELL_CHANGE_TIMEOUT  2
#define OVERHEAT_TIMEOUT     3
#endif

typedef unsigned char bool; //    
#define true  0 == 0        //     
#define false 0 != 0        //      

typedef enum {st_none = 0b00, st_primary = 0b01, st_secondary = 0b10, st_both = 0b11} t_states; //    
                                                                                                //       ,      
typedef enum {adc_temperature, adc_voltage} t_measure;                                          //   
typedef enum {move_null, move_up, move_down} t_movement;                                        //      

//    
struct t_coordidates {
  signed char row, col;
};

//       
struct t_correction {
  t_movement voltage, temperature;
};

#define CELLS_ROWS 3 //      ( )
#define CELLS_COLS 5 //      ( )

//  
const t_states CELLS[CELLS_ROWS][CELLS_COLS] = {
  {st_both, st_both,    st_both,    st_primary, st_none},
  {st_both, st_both,    st_primary, st_none,    st_none},
  {st_both, st_primary, st_none,    st_none,    st_none}
};

// LSB- ,      
const unsigned int ROWS_EDGES[CELLS_ROWS - 1] = {
  241, // 0‚Å∞C
  157  // -10‚Å∞C
};

// LSB- ,      
const unsigned int COLS_EDGES[CELLS_COLS - 1] = {
  864, // 13.5V
  800, // 12.5V
  787, // 12.3V
  768  // 12.0V
};

unsigned int overheat_rest_time = 0; //       ""
unsigned char cell_change_time  = 0; //      
unsigned char no_cur_cell_time  = 0; //  ,            

#define NULL_CELL (struct t_coordidates){.col = -1, .row = -1} // ,   
#define NULL_CORRECTION (struct t_correction){.voltage = move_null, .temperature = move_null} // ,   

struct t_correction moved_from = NULL_CORRECTION; //       
struct t_coordidates cur_cell  = NULL_CELL,       //      
                     next_cell = NULL_CELL;       //  -   

//  
static void init_pins() {
  DDRB |= (1 &lt;&lt; PB0) | (1 &lt;&lt; PB1) | (1 &lt;&lt; PB3);     //   2 (PB3), 5 (PB0)  6 (PB1)  
  PORTB &amp;= ~(1 &lt;&lt; PB0) &amp; ~(1 &lt;&lt; PB1) &amp; ~(1 &lt;&lt; PB3); //      2 (PB3), 5 (PB0)  6 (PB1)
}

// /    
static void toggle_thermal_sensor(bool state) {
  if(state) {
    PORTB |= (1 &lt;&lt; PB1);  //  state ,      6 (PB1)

    _delay_ms(5); //    
  } else {
    PORTB &amp;= ~(1 &lt;&lt; PB1); //  state  ,      6 (PB1)
  }
}

//   
static unsigned int measure_adc(t_measure measure) {
  if(measure == adc_temperature) {
    toggle_thermal_sensor(true); //    ,    

    ADMUX = 0b10; //      -   3 (PB4)
  } else {
    ADMUX = 0b01; //      -   7 (PB2)
  }

  ADCSRA = (1 &lt;&lt; ADPS2) | //       = 16 (75 )
           (1 &lt;&lt; ADIE) |  //    
           (1 &lt;&lt; ADEN);   //  

  set_sleep_mode(SLEEP_MODE_ADC); //   "" 
  do {
    sleep_cpu(); //      ,      ,   
  } while(ADCSRA &amp; (1 &lt;&lt; ADSC)); //        ,  

  ADCSRA = 0; //  

  toggle_thermal_sensor(false); //     

  return ADC; //  10-  
}

//    watchdog
static void init_interrupts(void) {
  sleep_enable(); //   

  WDTCR = (1 &lt;&lt; WDCE) | (1 &lt;&lt; WDE); //  watchdog
  WDTCR = (1 &lt;&lt; WDTIE) | INTERVAL; // watchdog      ,  1 

  sei(); //  
}

//          
static void toggle_loads(t_states states) {
  unsigned char port = PORTB &amp; ~((1 &lt;&lt; PB3) | (1 &lt;&lt; PB0)),     //           ,   
                bits = (((states &amp; st_primary) &gt;&gt; 0) &lt;&lt; PB3) | //        
                       (((states &amp; st_secondary) &gt;&gt; 1) &lt;&lt; PB0);

  PORTB = port | bits; //    
}

//     t_coordidates
static bool cells_equal(struct t_coordidates cell1, struct t_coordidates cell2) {
  return cell1.row == cell2.row &amp;&amp; cell1.col == cell2.col;
}

//          LSB- 
static signed char get_cell_row(unsigned int temperature) {
  signed char row = 0;

  while(row &lt; CELLS_ROWS - 1) {          //          
    if(temperature &gt;= ROWS_EDGES[row]) { //  temperature     ,    
      return row;
    } else {
      ++row;
    }
  }

  return CELLS_ROWS - 1; //  temperature         ,       
}

//          LSB- 
static signed char get_cell_col(unsigned int voltage) {
  signed char col = 0;

  while(col &lt; CELLS_COLS - 1) {      //          
    if(voltage &gt;= COLS_EDGES[col]) { //  voltage     ,    
      return col;
    } else {
      ++col;
    }
  }

  return CELLS_COLS - 1; //  voltage         ,       
}

//    ,       
static void get_row_edges(signed char row, unsigned int *upper, unsigned int *lower) {
  *upper = row &gt; 0 ? ROWS_EDGES[row - 1] : 0xffff - TEMPERATURE_GIST; //       ,    
  *lower = row &lt; CELLS_ROWS - 1 ? ROWS_EDGES[row] : TEMPERATURE_GIST; //       ,    
}

//    ,       
static void get_col_edges(signed char col, unsigned int *upper, unsigned int *lower) {
  *upper = col &gt; 0 ? COLS_EDGES[col - 1] : 0xffff - VOLTAGE_GIST; //      (  )  ,    
  *lower = col &lt; CELLS_COLS - 1 ? COLS_EDGES[col] : VOLTAGE_GIST; //      (  )  ,    
}

//    -              
static void gisteresis_correction(struct t_coordidates* new_cell, unsigned int temperature, unsigned int voltage) {
  unsigned int upper_edge, lower_edge;

  get_row_edges(cur_cell.row, &amp;upper_edge, &amp;lower_edge); //    
  if(new_cell-&gt;row &gt; cur_cell.row &amp;&amp; moved_from.temperature == move_up &amp;&amp; temperature &gt;= lower_edge - TEMPERATURE_GIST) {
    --new_cell-&gt;row; //   -   ,    ,        ,    
  }

  if(new_cell-&gt;row &lt; cur_cell.row &amp;&amp; moved_from.temperature == move_down &amp;&amp; temperature &lt;= upper_edge + TEMPERATURE_GIST) {
    ++new_cell-&gt;row; //   -   ,    ,        ,    
  }

  get_col_edges(cur_cell.col, &amp;upper_edge, &amp;lower_edge); //    
  if(new_cell-&gt;col &gt; cur_cell.col &amp;&amp; moved_from.voltage == move_up &amp;&amp; voltage &gt;= lower_edge - VOLTAGE_GIST) {
    --new_cell-&gt;col; //   -   ,     (  ),        ,    
  }

  if(new_cell-&gt;col &lt; cur_cell.col &amp;&amp; moved_from.voltage == move_down &amp;&amp; voltage &lt;= upper_edge + VOLTAGE_GIST) {
    ++new_cell-&gt;col; //   -   ,     (  ),        ,    
  }
}

//       stdlib::abs()
 static unsigned char absolute(signed char value) {
  return value &gt;= 0 ? value : -value;
}

//      -
static void calc_movement(struct t_coordidates new_cell) {
  moved_from = NULL_CORRECTION;                                                   // -   
  if(!cells_equal(new_cell, NULL_CELL) &amp;&amp; !cells_equal(cur_cell, NULL_CELL)) {    //         ,  -
    if(absolute(new_cell.row - cur_cell.row) == 1) {                              //      
      moved_from.temperature = new_cell.row &lt; cur_cell.row ? move_up : move_down; //   
    }

    if(absolute(new_cell.col - cur_cell.col) == 1) {                              //      
      moved_from.voltage = new_cell.col &lt; cur_cell.col ? move_up : move_down;     //   
    }
  }
}

//   -
static void set_next_cell(struct t_coordidates cell) {
  next_cell = cell;
  cell_change_time = 0; //    
}

//    
static void set_cur_cell(struct t_coordidates cell) {
  cur_cell = cell;
  no_cur_cell_time = 0; //        
  set_next_cell(NULL_CELL); //  -
}

// ,      
static void change_cell(struct t_coordidates new_cell) {
  if(cells_equal(new_cell, NULL_CELL)) { //         
    toggle_loads(st_none);
  } else {
    toggle_loads(CELLS[new_cell.row][new_cell.col]); //         
  }

  calc_movement(new_cell); //     
  set_cur_cell(new_cell);  //   
}

//  
static void main_proc(void) {
  unsigned int temperature, voltage; // 10- LSB-    
  struct t_coordidates cell;         //      -

  if(overheat_rest_time) { //      ""  ,          
    --overheat_rest_time;
  } else {
    temperature = measure_adc(adc_temperature); //  
    if(temperature &gt;= TEMPERATURE_OVERHEAT) {   //      +50C,  :
      change_cell(NULL_CELL);                   //      (   )
      overheat_rest_time = OVERHEAT_TIMEOUT;    //        
    } else {
      voltage = measure_adc(adc_voltage);   //  

      cell.col = get_cell_col(voltage);     //    -  
      cell.row = get_cell_row(temperature); //    -  

      if(cells_equal(cur_cell, NULL_CELL)) { //        ,         
        change_cell(cell);
      } else {
        gisteresis_correction(&amp;cell, temperature, voltage); //              

        if(cells_equal(cell, cur_cell)) { //   -   ,      
          set_next_cell(NULL_CELL);
          no_cur_cell_time = 0; //    ,  
        } else {
          if(no_cur_cell_time++ &gt; CELL_CHANGE_TIMEOUT) { //    CELL_CHANGE_TIMEOUT+1        cur_cell,      
            change_cell(cell); //    ,     
          } else {
            if(cells_equal(next_cell, NULL_CELL) || !cells_equal(next_cell, cell)) { //  -       ,   
              set_next_cell(cell);
            } else {
              if(++cell_change_time &gt;= CELL_CHANGE_TIMEOUT) { //   ,       , ,    
                change_cell(cell);
              }
            }
          }
        }
      }
    }
  }
}

//    watchdog
ISR(WDT_vect) {
  WDTCR |= (1 &lt;&lt; WDTIE); //    watchdog   ""    
}

//    ,        ADSC  measure_adc()
EMPTY_INTERRUPT(ADC_vect);

//  
int main(void) {
  init_pins();       //  
  init_interrupts(); //    watchdog
	
  while(true) {                          //  ,       
    set_sleep_mode(SLEEP_MODE_PWR_DOWN); //        
    sleep_cpu();                         //        watchdog 

    main_proc();                         //          
  }
}
</code></pre><br>
<br>
    : L:0x6A, H:0xFF.<br>
</div></div><br>
   .    ,     ‚Äì  ,    ‚Äì .            ,    .     :<br>
<br>
<a href=""><div style="text-align:center;"><img src="https://habrastorage.org/webt/0j/wx/ez/0jwxezo197qadbln8crg05zwlhq.png"></div></a><br>
          ,      .<br>
<br>
,           .        ,        .   ,        ,       .<br>
<br>
<blockquote>,  -      ,       .                ,    ,      . , - ,  ,    ,   ,                .  ..  -   ,           ,      .    .         .      ,      ,     .</blockquote><br>
        ,                  .  ,  , ,  12.5   ,      ,      12.4 .                . ,             .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/_o/d5/9e/_od59e61ylpgaqhsrwwlwsro3dw.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lo/bu/uu/lobuuuqhkbahdsyinpg5hhokeyw.png"></div><br>
 ,               , ,   .            ,    .           ¬´¬ª 8-9 .<br>
<br>
<blockquote>         ,     .        ¬´¬ª    ,          .   ,      ,    ¬´¬ª ,     -    (,   ,   ,    ,  ,     -  ).</blockquote><br>
      ,        +50‚Å∞C  ,     .        ,  ,  ,       .                 .<br>
<br>
  ¬´¬ª,   ,    (watchdog).                    .<br>
<br>
<blockquote> ,          ‚Äì  .       . Watchdog   ,  ,     ,     .  ,    ,         ,     watchdog.   ,      ,        .</blockquote><br>
           .       1006 ,      -  .<br>
<br>
<blockquote>,       ,  .   ,        O2,   ,       Os  ,      1024 .             -,      .</blockquote><br>
                       .<br>
<br>
<div class="spoiler"><b class="spoiler_title">    </b><div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/1b/gg/nv/1bggnvmw6h-x7nab-h9ljuag1lq.png"></div><br>
     Eagle  <a href=""></a>.<br>
</div></div></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr446956/">https://habr.com/ru/post/fr446956/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr446942/index.html">Serveur, vous m'entendez? Attaque BROP sur l'exemple de la t√¢che NeoQUEST-2019</a></li>
<li><a href="../fr446944/index.html">Pourquoi investir dans des entreprises non rentables?</a></li>
<li><a href="../fr446948/index.html">Comment le cheval de Troie Android Gustuff supprime la cr√®me (fiat et crypto) de vos comptes</a></li>
<li><a href="../fr446950/index.html">76% des fabricants n'ont aucune exp√©rience de la mise en ≈ìuvre d'additifs - pourquoi est-ce bon</a></li>
<li><a href="../fr446952/index.html">Cr√©er des histogrammes anim√©s √† l'aide de R</a></li>
<li><a href="../fr446958/index.html">Tricky Perl Quine</a></li>
<li><a href="../fr446960/index.html">La maison que Jack a construite</a></li>
<li><a href="../fr446962/index.html">Phishing et pas de chimie</a></li>
<li><a href="../fr446964/index.html">Int√©gration avec SAP ERP. Mise en place d'un v√©rificateur de prix mobile dans un magasin</a></li>
<li><a href="../fr446966/index.html">Actualit√©s de la semaine: principaux √©v√©nements informatiques et scientifiques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>