<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äç‚úàÔ∏è ‚õ±Ô∏è ü§ΩüèΩ Como come√ßamos a registrar caixas registradoras para nossos clientes üö∂üèº üêû ‚õé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="De acordo com as emendas ao 54-, desde julho deste ano, quase todas as empresas comerciais s√£o obrigadas a usar caixas eletr√¥nicas on-line que transmi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como come√ßamos a registrar caixas registradoras para nossos clientes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/420033/">  De acordo com as emendas ao 54-, desde julho deste ano, quase todas as empresas comerciais s√£o obrigadas a usar caixas eletr√¥nicas on-line que transmitem dados via Internet ao servi√ßo de impostos.  Para adquirir esse aparato, voc√™ ter√° que comprar uma caixa e uma unidade fiscal, assinar um contrato e pagar pelos servi√ßos de um operador de dados fiscais, registrar-se em dois escrit√≥rios pessoais do Servi√ßo Fiscal Federal e OFD, dirigir os detalhes para a caixa e receber um relat√≥rio de registro em papel.  Bem, voc√™ tamb√©m precisar√° de uma assinatura digital eletr√¥nica, caso contr√°rio, precisar√° comparecer ao Servi√ßo de Impostos Federais e ficar pessoalmente na fila. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3a9/fb3/9b6/3a9fb39b680344c3f892804eb41b1a11.png"><br><br>  Decidimos salvar nossos clientes de todo esse horror criando um servi√ßo que registra tudo automaticamente quase com um clique.  Vamos falar sobre isso agora. <br><a name="habracut"></a><br><h2>  Por que precisamos disso </h2><br>  Voc√™ j√° percebeu que registrar uma bilheteria √© uma tarefa tediosa em v√°rias etapas, mas esse n√£o √© o √∫nico problema.  Em cada etapa, o zool√≥gico aguarda as interfaces, cujos formul√°rios dever√£o ser preenchidos manualmente com dados de registro para cada bilheteria, al√©m de um conjunto completo de bugs relevantes (cumprimentos separados aos requisitos fiscais para o uso de navegadores IE, Yandex.Browser ou Sputnik).  Centenas de oportunidades para cometer um erro, estragar o procedimento e come√ßar de novo.  E se voc√™ definir de 5 a 10 caixas registradoras, a chance de um erro ao inserir os mesmos detalhes aumenta √†s vezes.  Sem mencionar o desperd√≠cio improdutivo de tempo e descobrir por que o departamento tribut√°rio pessoal se recusa a aceitar o token, que foi perfeitamente "engolido" ontem. <br><br><img src="https://habrastorage.org/webt/cz/bk/qn/czbkqnhvog24qqgwodhckwfyhew.png"><br><br>  E quando sentimos o peso da trag√©dia acima, decidimos retomar o desenvolvimento. <br><br><h2>  Etapas de registro </h2><br>  V√°rias partes est√£o envolvidas no registro de uma caixa registradora de uma s√≥ vez.  Este √© o servi√ßo fiscal (STF), OFD - o operador de dados fiscais atrav√©s do qual as caixas registradoras interagem com a autoridade tribut√°ria, um centro de certifica√ß√£o que emite assinaturas eletr√¥nicas e, via de regra, um pequeno empres√°rio perplexo perdido em dist√∫rbios burocr√°ticos.  Quer√≠amos intervir no relacionamento deles, tanto que levamos todas as dificuldades para n√≥s mesmos. <br><br>  Condicionalmente, o procedimento √© dividido em duas etapas: <br><br>  Registro de caixa - os dados de um dispositivo espec√≠fico s√£o enviados ao Servi√ßo de Impostos Federais e o n√∫mero de registro √© fornecido. <br><br>  Fiscaliza√ß√£o - ativa√ß√£o do caixa usando o n√∫mero de registro do ve√≠culo atribu√≠do pelo Servi√ßo Fiscal Federal. <br><br>  Primeiro, fomos aos nossos parceiros para trabalhar a primeira etapa com eles. <br><br><h2>  API para o Servi√ßo Fiscal Federal </h2><br>  N√£o fomos os primeiros a pensar em automa√ß√£o de registro.  Muitos disseram que estavam fazendo algo nesta √°rea, que o desenvolvimento estava em andamento, mas ningu√©m tinha uma interface externa pronta.  Um dos operadores de dados fiscais foi fornecido pela API - quase pronto para interagir com o imposto. <br><br>  Naquela √©poca, apenas cerca de 80 aplicativos de teste foram enviados usando o protocolo.  Acredit√°vamos que em breve a interface funcionaria com capacidade total e come√ßamos a implementa√ß√£o e teste nos ‚Äústubs‚Äù. <br><br>  Indo para o prod, percebemos que nossos testes e a aplica√ß√£o real s√£o diferentes, como dia e noite.  Os ‚Äústubs‚Äù que recebemos do OFD inclu√≠am apenas simula√ß√£o de sucesso e reproduziam um script de sucesso.  De fato, alcan√ßar esse "sucesso" n√£o foi f√°cil. <br><br>  Os resultados inclu√≠ram: aplicativos do lado de parceiros que n√£o foram processados ‚Äã‚Äãpor v√°rios dias, falta de feedback do Servi√ßo Fiscal Federal e OFD, erros de assinatura e nosso "erro desconhecido" favorito.  O protocolo do STF acabou por ser pouco documentado e, muitas vezes, respondeu com falhas n√£o especificadas, para as quais n√£o est√° claro o que os causou.  Uma especifica√ß√£o clara ainda n√£o existe.  Ent√£o, na primeira vez em que testamos o protocolo, e, juntamente com o OFD, tomamos decis√µes sobre como responder a certas respostas do Servi√ßo Tribut√°rio Federal em casos espec√≠ficos. <br><br><h2>  API do Caixa </h2><br>  Enquanto parte da equipe estudou o comportamento dos sistemas do Servi√ßo Fiscal Federal na pr√°tica, o trabalho n√£o parou.  Paralelamente, organizamos negocia√ß√µes com os fabricantes de caixas registradoras, convidando-os a trocar dados nossos para sua plataforma, da plataforma para a caixa registradora e na ordem inversa para configurar a fiscaliza√ß√£o autom√°tica das caixas registradoras. <br><br>  Selecionamos um par de solu√ß√µes √∫nicas universais.  As mesas de dinheiro Evotor com telas sens√≠veis ao toque e DreamCas destinam-se aos clientes que est√£o acostumados com os bons e velhos bot√µes e consideram a funcionalidade adicional redundante.  Os modelos s√£o diferentes: com e sem um scanner. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ro/r7/dc/ror7dcretvhsilz3yiw12judrxi.png"></div><br>  Se o OFD tinha sua pr√≥pria API pronta, ent√£o para os prestadores de servi√ßos da caixa registradora, ela precisava ser desenvolvida do zero.  Caso contr√°rio, √© imposs√≠vel fazer com que todos os dados de registro cheguem √† caixa registradora automaticamente, sem entrada manual. <br><br>  Os colegas conseguiram estabelecer a intera√ß√£o por meio de sua plataforma e logo estavam prontos: uma API para abrir a conta pessoal de um cliente e um protocolo propriet√°rio para gerenciar uma caixa registradora. <br><br><img src="https://habrastorage.org/webt/wy/5h/hr/wy5hhrv-agl7qmya0x9pnpbppde.png"><br><br>  Nossos fornecedores foram os primeiros a configurar o envio autom√°tico de informa√ß√µes de registro para a bilheteria.  E em breve a API facilitar√° o cancelamento do registro e o registro das caixas registradoras. <br><br>  Agora, quando estamos negociando com outros fornecedores de dinheiro, √© precisamente o suporte dessa interface que se torna um dos principais requisitos. <br><br><h2>  Anatomia do registro autom√°tico </h2><br>  Depois que aprendemos a trabalhar com o Servi√ßo Fiscal Federal e implementamos APIs com fornecedores para transferir dados de registro para o caixa, era hora de conectar tudo isso em um √∫nico sistema e estabelecer um procedimento de registro. <br><br>  Essa √© a tarefa de escolher a arquitetura correta, o que permitiria controlar o registro ass√≠ncrono das caixas registradoras no OFD, tanto com o Servi√ßo Fiscal Federal como com o fornecedor.  Como eles respondem √†s solicita√ß√µes com atraso, o processo √© demorado e possui um grande n√∫mero de integra√ß√µes com sistemas externos.  Por causa disso, tivemos que escrever dois aplicativos em Java. <br><br>  O servi√ßo de trabalho se comunica diretamente com a CRF e os sistemas dos fabricantes de caixas registradoras.  Por exemplo, enviamos dados do cliente ao OFD e esperamos receber um n√∫mero de registro em resposta. <br><br>  O servi√ßo de trabalho pesquisa o status do trabalho em intervalos espec√≠ficos.  Ele pergunta novamente e pergunta novamente at√© que o resultado volte.  O n√∫mero de registro √© salvo, o Job transfere o aplicativo para o pr√≥ximo est√°gio e a fiscaliza√ß√£o come√ßa. <br><br>  Se inicialmente monitoramos cuidadosamente a passagem de aplicativos e estudamos manualmente cada erro que o sistema deu, agora o processo √© automatizado. <br><br>  Determinamos imediatamente a causa do erro.  E, no caso de grandes problemas, foram criados sistemas de monitoramento que registram anomalias que indicam falhas importantes no Servi√ßo Fiscal Federal ou no OFD.  O cliente, no entanto, descobre os problemas no √∫nico caso: se, em resposta a uma solicita√ß√£o, recebermos um redirecionamento espec√≠fico, uma recusa fundamentada de registro. <br><br>  O segundo aplicativo, CashReg, √© um sistema de processamento no qual um modelo de status √© mantido, apresentado de forma relacional. <br><br>  Foi desenvolvido com base nas APIs fornecidas pelos fornecedores e no CRF, e incluiu todas as transi√ß√µes poss√≠veis para cada classe que participava do processo de registro.  O modelo de status evita erros internos e elimina desvios do algoritmo de processamento de aplicativos padr√£o. <br><br>  Portanto, se o aplicativo estiver no mesmo status por muito tempo, por exemplo, ele n√£o receber√° o n√∫mero de registro por v√°rias horas ou o CRF responder√° com um est√°gio ou status incorreto do aplicativo, o CashReg relatar√° um erro. <br><br>  Obviamente, era necess√°rio um administrador para gerenciar o procedimento.  Um grupo de suporte √† decis√£o de negocia√ß√£o trabalha com ele, atendendo e acompanhando as caixas registradoras durante o registro.  Agora, apenas dois funcion√°rios est√£o envolvidos nisso, mas sua interface de trabalho n√£o √© complicada e o processo de prepara√ß√£o do caixa, gra√ßas √† rejei√ß√£o da entrada manual de dados, √© simples.  Assim, podemos dimensionar r√°pida e facilmente o departamento. <br><br>  Todos os tr√™s componentes do sistema de registro n√£o implicam altas cargas, porque s√£o implantados em ambientes virtuais. <br><br><h2>  Como √© o processamento do aplicativo </h2><br>  Tudo isso foi necess√°rio para que o cliente, deixando um pedido em sua conta pessoal, alguns dias depois colocasse a caixa do caixa ativada pronta para trabalhar atr√°s do balc√£o. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f14/777/abe/f14777abe2e59529a31a321dcfbe01ca.png"></div><br>  Do ponto de vista da cozinha dom√©stica, a m√°gica do registro autom√°tico parece um pouco mais complicada.  Deixando o aplicativo em sua conta pessoal, o cliente nos d√° o consentimento legal para emitir uma assinatura eletr√¥nica e passar por todo o procedimento em seu nome. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/36e/5ef/ccb/36e5efccba0427be9fef8324a50323c3.png"></div><br>  Informa√ß√µes sobre a empresa, dados de registro para uma loja espec√≠fica e signat√°rio (por exemplo, para o diretor geral) s√£o extra√≠dos das bases banc√°rias.  Eles s√£o atualizados no SPARK, passam pela pontua√ß√£o e entram no sistema principal nas bilheterias. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ae4/749/b78/ae4749b7824fe74ebc8ddefb2d952955.png"></div><br>  Em seguida, um aplicativo √© formado no CASHREG.  √â exibida como uma nova tarefa no painel de administra√ß√£o de um funcion√°rio do grupo de suporte de solu√ß√µes de negocia√ß√£o.  Ele v√™ de qual caixa cont√°bil e fiscal o cliente precisa.  O funcion√°rio encontra o dispositivo necess√°rio no armaz√©m, seleciona a unidade fiscal, codifica com c√≥digo de barras seus n√∫meros de s√©rie e confirma o aplicativo.  Portanto, dispositivos espec√≠ficos s√£o anexados a ele, que ser√£o entregues ao cliente.  Nesse momento, o OFD recebe uma solicita√ß√£o: "Formul√°rio de inscri√ß√£o para o registro de tal e tal caixa, para tal e qual empresa". <br><br>  O arquivo enviado pelo OFD em resposta √© autenticado por assinatura eletr√¥nica e, usando a API OFD, √© enviado √†s autoridades fiscais.  L√°, o checkout recebe um n√∫mero de registro. <br><br>  Agora, o pacote completo de documentos no caixa chega ao fabricante da caixa registradora (sim, eles tamb√©m est√£o envolvidos aqui).  Ao mesmo tempo, uma tarefa aparece no painel do administrador - para fiscalizar o mesmo caixa.  Isso significa que o funcion√°rio simplesmente inclui o caixa.  O sistema do fornecedor "v√™" que o dispositivo est√° em contato e carrega todos os dados de registro necess√°rios em sua mem√≥ria automaticamente.  Os erros com entrada manual s√£o exclu√≠dos, os mesmos detalhes v√£o para o Servi√ßo Fiscal Federal e o caixa. <br><br>  O caixa imprime um relat√≥rio de registro - algo para o qual tudo foi iniciado.  Os dados fiscais do relat√≥rio: data de impress√£o, assinatura, sinal fiscal servem como confirma√ß√£o de que o caixa est√° pronto para o trabalho.  Esses detalhes s√£o novamente enviados ao OFD. <br><br>  Imediatamente ap√≥s o OFD gerar um relat√≥rio de registro, assinamos para o cliente e a bilheteria sai com o correio. <br><br><img src="https://habrastorage.org/webt/dc/cs/et/dccsetgp8qnjvcijl84ra3n6vu0.png"><br><br>  O OFD ainda n√£o preparou um cart√£o de registro, mas voc√™ n√£o pode esperar.  Ele estar√° dispon√≠vel em formato eletr√¥nico na conta pessoal do cliente em dois a tr√™s dias. <br><br><h2>  Conclus√£o </h2><br>  Para implementar este projeto, cerca de vinte funcion√°rios de todo o banco e muitos outros especialistas de nossos parceiros, DFD e vendedores de caixa foram distra√≠dos de suas tarefas habituais, mas seus esfor√ßos n√£o foram em v√£o. <br><br>  O tempo m√©dio para obter um n√∫mero de registro, com exce√ß√£o dos casos mais negativos, √© de tr√™s horas.  Em geral, todo o procedimento leva de 5 a 6 horas.  90% dos registros s√£o bem-sucedidos.  No momento, cerca de 1000 aplicativos j√° foram processados. <br><br>  Em geral, como voc√™ entende, em nossa empresa adoramos esses casos, o que pode simplificar bastante a vida de um grande n√∫mero de pessoas.  Resolvendo esses problemas, voc√™ sente que est√° fazendo algo realmente √∫til. <br><br>  PS Se voc√™ estiver interessado, pode ler como n√≥s mesmos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">lavamos nosso caixa eletr√¥nico</a> .  Al√©m disso, juntamente com protocolos de troca de dados. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt420033/">https://habr.com/ru/post/pt420033/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt420021/index.html">Por que voc√™ precisa do Splunk? Internet das Coisas e Dados Industriais</a></li>
<li><a href="../pt420023/index.html">Salvando estados em aplicativos Android</a></li>
<li><a href="../pt420025/index.html">Fazenda inteligente. Como ela ser√°?</a></li>
<li><a href="../pt420029/index.html">Como n√≥s da 1C: Enterprise resolvemos sistemas de equa√ß√µes alg√©bricas</a></li>
<li><a href="../pt420031/index.html">Desenho com destinos de renderiza√ß√£o no Unreal Engine</a></li>
<li><a href="../pt420035/index.html">GUI Golang: GTK + 3</a></li>
<li><a href="../pt420037/index.html">Transmita com v√°rias c√¢meras a partir de materiais improvisados</a></li>
<li><a href="../pt420039/index.html">Pensamento funcional. Parte 2</a></li>
<li><a href="../pt420041/index.html">Guerra TypeScript ou Enum Conquest</a></li>
<li><a href="../pt420045/index.html">Dep√≥sito para a data: como me foi permitido andar pelo data center RUVDS no territ√≥rio da usina espacial</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>