<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìí üç¢ üßõ Dem Dickicht der Tests entkommen: Erstellen einer Verkn√ºpfung von einem Ger√§t zu einer Behauptung üê´ üïñ üì≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel m√∂chte ich eine Alternative zum traditionellen Testdesignstil mit funktionalen Programmierkonzepten in Scala vorschlagen. Dieser Ans...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dem Dickicht der Tests entkommen: Erstellen einer Verkn√ºpfung von einem Ger√§t zu einer Behauptung</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/465211/"><p><img src="https://habrastorage.org/webt/mu/ll/ar/mullaroquhqtdb05ygvb82nmghu.jpeg"></p><br><p>  In diesem Artikel m√∂chte ich eine Alternative zum traditionellen Testdesignstil mit funktionalen Programmierkonzepten in Scala vorschlagen.  Dieser Ansatz wurde durch viele Monate voller Schmerzen inspiriert, die durch die Aufrechterhaltung von Dutzenden fehlgeschlagener Tests und den brennenden Wunsch entstanden waren, sie einfacher und verst√§ndlicher zu machen. </p><br><p>  Obwohl sich der Code in Scala befindet, sind die vorgeschlagenen Ideen f√ºr Entwickler und QS-Ingenieure geeignet, die Sprachen verwenden, die die funktionale Programmierung unterst√ºtzen.  Einen Github-Link mit der vollst√§ndigen L√∂sung und ein Beispiel finden Sie am Ende des Artikels. </p><a name="habracut"></a><br><h2 id="the-problem">  Das Problem </h2><br><p>  Wenn Sie sich jemals mit Tests befassen mussten (egal welche: Unit-Tests, integrativ oder funktional), wurden sie h√∂chstwahrscheinlich als sequentielle Anweisungen geschrieben.  Zum Beispiel: </p><br><pre><code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// The following tests describe a simple internet store. // Depending on their role, bonus amount and the order's // subtotal, users may receive a discount of some size. "If user's role is 'customer'" - { import TestHelper._ "And if subtotal &lt; 250 after bonuses - no discount" in { val db: Database = Database.forURL(TestConfig.generateNewUrl()) migrateDb(db) insertUser(db, id = 1, name = "test", role = "customer") insertPackage(db, id = 1, name = "test", userId = 1, status = "new") insertPackageItems(db, id = 1, packageId = 1, name = "test", price = 30) insertPackageItems(db, id = 2, packageId = 1, name = "test", price = 20) insertPackageItems(db, id = 3, packageId = 1, name = "test", price = 40) val svc = new SomeProductionLogic(db) val result = svc.calculatePrice(packageId = 1) result shouldBe 90 } "And if subtotal &gt;= 250 after bonuses - 10% off" in { val db: Database = Database.forURL(TestConfig.generateNewUrl()) migrateDb(db) insertUser(db, id = 1, name = "test", role = "customer") insertPackage(db, id = 1, name = "test", userId = 1, status = "new") insertPackageItems(db, id = 1, packageId = 1, name = "test", price = 100) insertPackageItems(db, id = 2, packageId = 1, name = "test", price = 120) insertPackageItems(db, id = 3, packageId = 1, name = "test", price = 130) insertBonus(db, id = 1, packageId = 1, bonusAmount = 40) val svc = new SomeProductionLogic(db) val result = svc.calculatePrice(packageId = 1) result shouldBe 279 } } "If user's role is 'vip'" - {/*...*/}</span></span></code> </pre> <br><p>  Nach meiner Erfahrung wird diese Art des Schreibens von Tests von den meisten Entwicklern bevorzugt.  Unser Projekt hat ungef√§hr tausend Tests auf verschiedenen Isolationsstufen, und alle wurden bis vor kurzem in diesem Stil geschrieben.  Als das Projekt wuchs, bemerkten wir schwerwiegende Probleme und Verlangsamungen bei der Aufrechterhaltung solcher Tests: Die Behebung dieser Tests w√ºrde mindestens genauso lange dauern wie das Schreiben von Produktionscode. </p><br><p>  Beim Schreiben neuer Tests mussten wir immer Wege finden, um Daten von Grund auf neu vorzubereiten, normalerweise durch Kopieren und Einf√ºgen von Schritten aus benachbarten Tests.  Wenn sich das Datenmodell der Anwendung √§ndern w√ºrde, w√ºrde das Kartenhaus zusammenbrechen, und wir m√ºssten jeden fehlgeschlagenen Test reparieren: im schlimmsten Fall - indem wir tief in jeden Test eintauchen und ihn neu schreiben. </p><br><p>  Wenn ein Test ‚Äûehrlich‚Äú fehlschlagen w√ºrde - d. H. Aufgrund eines tats√§chlichen Fehlers in der Gesch√§ftslogik - war es unm√∂glich zu verstehen, was ohne Debugging schief gelaufen ist.  Da die Tests so schwer zu verstehen waren, hatte niemand immer das volle Wissen zur Hand, wie sich das System verhalten soll. </p><br><p>  All dieser Schmerz ist meiner Meinung nach ein Symptom f√ºr die zwei tieferen Probleme eines solchen Testdesigns: </p><br><ol><li>  Es gibt keine klare und praktische Struktur f√ºr Tests.  Jeder Test ist eine einzigartige Schneeflocke.  Mangelnde Struktur f√ºhrt zu Ausf√ºhrlichkeit, die viel Zeit in Anspruch nimmt und demotiviert.  Unbedeutende Details lenken von dem ab, was am wichtigsten ist - der Anforderung, die der Test best√§tigt.  Das Kopieren und Einf√ºgen wird zum prim√§ren Ansatz beim Schreiben neuer Testf√§lle. </li><li>  Tests helfen Entwicklern nicht bei der Lokalisierung von Fehlern.  Sie signalisieren nur, dass es ein Problem gibt.  Um zu verstehen, in welchem ‚Äã‚ÄãZustand der Test ausgef√ºhrt wird, m√ºssen Sie ihn in Ihrem Kopf darstellen oder einen Debugger verwenden. </li></ol><br><h2 id="modeling">  Modellierung </h2><br><p>  K√∂nnen wir es besser machen?  (Spoiler-Alarm: Wir k√∂nnen.) Lassen Sie uns √ºberlegen, welche Art von Struktur dieser Test haben kann. </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> db: <span class="hljs-type"><span class="hljs-type">Database</span></span> = <span class="hljs-type"><span class="hljs-type">Database</span></span>.forURL(<span class="hljs-type"><span class="hljs-type">TestConfig</span></span>.generateNewUrl()) migrateDb(db) insertUser(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, role = <span class="hljs-string"><span class="hljs-string">"customer"</span></span>) insertPackage(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, userId = <span class="hljs-number"><span class="hljs-number">1</span></span>, status = <span class="hljs-string"><span class="hljs-string">"new"</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">30</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">2</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">20</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">3</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">40</span></span>)</code> </pre> <br><p>  Als Faustregel erwartet der zu testende Code einige explizite Parameter (Bezeichner, Gr√∂√üen, Mengen, Filter, um nur einige zu nennen) sowie einige externe Daten (aus einer Datenbank, einer Warteschlange oder einem anderen realen Dienst).  Damit unser Test zuverl√§ssig ausgef√ºhrt werden kann, ist ein <em>Ger√§t</em> erforderlich - ein Status, in den das System, die Datenanbieter oder beides versetzt werden. </p><br><p>  Mit diesem Ger√§t bereiten wir eine <em>Abh√§ngigkeit vor</em> , um den zu testenden Code zu initialisieren - f√ºllen Sie eine Datenbank, erstellen Sie eine Warteschlange eines bestimmten Typs usw. </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> svc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">SomeProductionLogic</span></span>(db) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = svc.calculatePrice(packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  Nachdem wir den zu testenden Code f√ºr einige Eingabeparameter ausgef√ºhrt haben, erhalten wir eine <em>Ausgabe</em> - sowohl explizit (vom zu testenden Code zur√ºckgegeben) als auch implizit (die √Ñnderungen des Status). </p><br><pre> <code class="scala hljs">result shouldBe <span class="hljs-number"><span class="hljs-number">90</span></span></code> </pre> <br><p>  Schlie√ülich √ºberpr√ºfen wir, ob die Ausgabe wie erwartet ist, und beenden den Test mit einer oder mehreren <em>Aussagen</em> . </p><br><p><img src="https://habrastorage.org/webt/em/aa/rb/emaarb5ltmnme4-wpda0ebakueq.jpeg"></p><br><p>  Man kann daraus schlie√üen, dass Tests im Allgemeinen aus denselben Phasen bestehen: Eingabevorbereitung, Codeausf√ºhrung und Ergebnisbest√§tigung.  Wir k√∂nnen diese Tatsache nutzen, um <strong>das erste Problem unserer Tests</strong> , d. H. Eine √ºberm√§√üig liberale Form, zu <strong>beseitigen</strong> , indem <strong>wir</strong> den K√∂rper eines Tests explizit in Stufen aufteilen.  Eine solche Idee ist nicht neu, wie aus BDD-Tests ( <em>verhaltensgesteuerte Entwicklung</em> ) hervorgeht. </p><br><p>  Was ist mit Erweiterbarkeit?  Jeder Schritt des Testprozesses kann wiederum eine beliebige Menge von Zwischenschritten enthalten.  Zum Beispiel k√∂nnten wir einen gro√üen und komplizierten Schritt machen, wie das Bauen eines Scheinwerfers, und es in mehrere Teile teilen, die nacheinander verkettet sind.  Auf diese Weise kann der Testprozess unendlich erweiterbar sein, besteht aber letztendlich immer aus denselben wenigen allgemeinen Schritten. </p><br><p><img src="https://habrastorage.org/webt/55/qf/zl/55qfzlhkl99txyyhizbvzg48yhs.jpeg"></p><br><h2 id="running-tests">  Ausf√ºhren von Tests </h2><br><p>  Versuchen wir, die Idee der Aufteilung des Tests in Stufen umzusetzen, aber zuerst sollten wir bestimmen, welche Art von Ergebnis wir sehen m√∂chten. </p><br><p>  Insgesamt m√∂chten wir, dass das Schreiben und Verwalten von Tests weniger arbeitsintensiv und angenehmer wird.  Je weniger explizite, nicht eindeutige Anweisungen ein Test enth√§lt, desto weniger √Ñnderungen m√ºssten nach Vertrags√§nderung oder Umgestaltung vorgenommen werden und desto weniger Zeit w√ºrde das Lesen des Tests dauern.  Das Design des Tests sollte die Wiederverwendung g√§ngiger Codefragmente f√∂rdern und das sinnlose Kopieren und Einf√ºgen verhindern.  Es w√§re auch sch√∂n, wenn die Tests eine einheitliche Form h√§tten.  Die Vorhersagbarkeit verbessert die Lesbarkeit und spart Zeit.  Stellen Sie sich zum Beispiel vor, wie viel Zeit angehende Wissenschaftler ben√∂tigen w√ºrden, um alle Formeln zu lernen, wenn sie in Lehrb√ºchern im Gegensatz zu Mathematik frei in einer gemeinsamen Sprache geschrieben w√ºrden. </p><br><p>  Unser Ziel ist es daher, alles Ablenkende und Unn√∂tige zu verbergen und nur das zu belassen, was f√ºr das Verst√§ndnis von entscheidender Bedeutung ist: Was wird getestet, was sind die erwarteten Ein- und Ausg√§nge. </p><br><p>  Kehren wir zu unserem Modell der Teststruktur zur√ºck. </p><br><p><img src="https://habrastorage.org/webt/em/aa/rb/emaarb5ltmnme4-wpda0ebakueq.jpeg"></p><br><p>  Technisch kann jeder Schritt durch einen Datentyp und jeder √úbergang durch eine Funktion dargestellt werden.  Um vom urspr√ºnglichen zum endg√ºltigen Datentyp zu gelangen, k√∂nnen Sie jede Funktion auf das Ergebnis des vorherigen anwenden.  Mit anderen Worten, durch Verwendung der Funktionszusammensetzung der Datenvorbereitung (nennen wir es <code>prepare</code> ), der Codeausf√ºhrung ( <code>execute</code> ) und der √úberpr√ºfung des erwarteten Ergebnisses ( <code>check</code> ).  Die Eingabe f√ºr diese Komposition w√§re der allererste Schritt - das Ger√§t.  Nennen wir die resultierende Funktion h√∂herer Ordnung die <strong>Testlebenszyklusfunktion</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">Testen Sie die Lebenszyklusfunktion</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runTestCycle</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">FX</span></span>, <span class="hljs-type"><span class="hljs-type">DEP</span></span>, <span class="hljs-type"><span class="hljs-type">OUT</span></span>, <span class="hljs-type"><span class="hljs-type">F</span></span>[_]]( fixture: <span class="hljs-type"><span class="hljs-type">FX</span></span>, prepare: <span class="hljs-type"><span class="hljs-type">FX</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">DEP</span></span>, execute: <span class="hljs-type"><span class="hljs-type">DEP</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">OUT</span></span>, check: <span class="hljs-type"><span class="hljs-type">OUT</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">Assertion</span></span>] ): <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">Assertion</span></span>] = <span class="hljs-comment"><span class="hljs-comment">// In Scala instead of writing check(execute(prepare(fixture))) // one can use a more readable version using the andThen function: (prepare andThen execute andThen check) (fixture)</span></span></code> </pre> </div></div><br><p>  Es stellt sich die Frage, woher diese bestimmten Funktionen kommen.  Nun, was die Datenaufbereitung betrifft, gibt es nur eine begrenzte Anzahl von M√∂glichkeiten, dies zu tun - eine Datenbank f√ºllen, verspotten usw.  Daher ist es praktisch, spezielle Varianten der <code>prepare</code> zu schreiben, die f√ºr alle Tests gemeinsam genutzt werden.  Infolgedessen w√§re es einfacher, f√ºr jeden Fall spezielle Testlebenszyklusfunktionen zu erstellen, die konkrete Implementierungen der Datenaufbereitung verbergen w√ºrden.  Da die Codeausf√ºhrung und Zusicherungen f√ºr jeden Test (oder jede Gruppe von Tests) mehr oder weniger eindeutig sind, m√ºssen <code>execute</code> und <code>check</code> jedes Mal explizit geschrieben werden. </p><br><div class="spoiler">  <b class="spoiler_title">Testlebenszyklusfunktion f√ºr Integrationstests in einer Datenbank angepasst</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// Sets up the fixture ‚Äî implemented separately def prepareDatabase[DB](db: Database): DbFixture =&gt; DB def testInDb[DB, OUT]( fixture: DbFixture, execute: DB =&gt; OUT, check: OUT =&gt; Future[Assertion], db: Database = getDatabaseHandleFromSomewhere(), ): Future[Assertion] = runTestCycle(fixture, prepareDatabase(db), execute, check)</span></span></code> </pre> </div></div><br><p>  Durch die Delegierung aller administrativen Nuancen an die Testlebenszyklusfunktion erhalten wir die M√∂glichkeit, den Testprozess zu erweitern, ohne einen bestimmten Test zu ber√ºhren.  Durch die Verwendung der Funktionszusammensetzung k√∂nnen wir in jedem Schritt des Prozesses eingreifen und Daten extrahieren oder hinzuf√ºgen. </p><br><p>  Um die M√∂glichkeiten eines solchen Ansatzes besser zu veranschaulichen, l√∂sen wir <strong>das zweite Problem unseres ersten Tests</strong> - das Fehlen zus√§tzlicher Informationen zur Ermittlung von Problemen.  F√ºgen wir die Protokollierung der zur√ºckgegebenen Codeausf√ºhrung hinzu.  Unsere Protokollierung √§ndert den Datentyp nicht.  Es entsteht nur <em>ein Nebeneffekt</em> - die Ausgabe einer Nachricht an die Konsole.  Nach dem Nebeneffekt geben wir es so zur√ºck, wie es ist. </p><br><div class="spoiler">  <b class="spoiler_title">Testen Sie die Lebenszyklusfunktion mit der Protokollierung</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logged</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> loggedT: <span class="hljs-type"><span class="hljs-type">Logged</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]): <span class="hljs-type"><span class="hljs-type">T</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">T</span></span> = (that: <span class="hljs-type"><span class="hljs-type">T</span></span>) =&gt; { <span class="hljs-comment"><span class="hljs-comment">// By passing an instance of the Logged typeclass for T as an argument, // we get an ability to ‚Äúadd‚Äù behavior log() to the abstract ‚Äúthat‚Äù member. // More on typeclasses later on. loggedT.log(that) // We could even do: that.log() that // The object gets returned unaltered } def runTestCycle[FX, DEP, OUT, F[_]]( fixture: FX, prepare: FX =&gt; DEP, execute: DEP =&gt; OUT, check: OUT =&gt; F[Assertion] )(implicit loggedOut: Logged[OUT]): F[Assertion] = // Insert logged right after receiving the result - after execute() (prepare andThen execute andThen logged andThen check) (fixture)</span></span></code> </pre> </div></div><br><p>  Mit dieser einfachen √Ñnderung haben wir die Protokollierung der Ausgabe des ausgef√ºhrten Codes <strong>in jedem Test</strong> hinzugef√ºgt.  Der Vorteil derart kleiner Funktionen besteht darin, dass sie leicht zu verstehen, zu komponieren und bei Bedarf zu entfernen sind. </p><br><p><img src="https://habrastorage.org/webt/ti/2t/l9/ti2tl9pk8wkd4hp8pqevf74hdn4.jpeg"></p><br><p>  Daher sieht unser Test jetzt folgenderma√üen aus: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> fixture: <span class="hljs-type"><span class="hljs-type">SomeMagicalFixture</span></span> = ??? <span class="hljs-comment"><span class="hljs-comment">// Comes from somewhere else def runProductionCode(id: Int): Database =&gt; Double = (db: Database) =&gt; new SomeProductionLogic(db).calculatePrice(id) def checkResult(expected: Double): Double =&gt; Future[Assertion] = (result: Double) =&gt; result shouldBe expected // The creation and filling of Database is hidden in testInDb "If user's role is 'customer'" in testInDb( state = fixture, execute = runProductionCode(id = 1), check = checkResult(90) )</span></span></code> </pre> <br><p>  Der Testk√∂rper wurde pr√§zise, ‚Äã‚Äãdas Ger√§t und die Pr√ºfungen k√∂nnen in anderen Tests wiederverwendet werden, und wir bereiten die Datenbank nirgendwo mehr manuell vor.  Es bleibt nur ein kleines Problem ... </p><br><h2 id="fixture-preparation">  Ger√§tevorbereitung </h2><br><p>  Im obigen Code haben wir unter der Annahme gearbeitet, dass das Ger√§t von irgendwoher an uns √ºbergeben wird.  Da Daten der entscheidende Bestandteil wartbarer und unkomplizierter Tests sind, m√ºssen wir uns damit befassen, wie sie einfach erstellt werden k√∂nnen. </p><br><p>  Angenommen, unser zu testendes Gesch√§ft verf√ºgt √ºber eine typische mittelgro√üe relationale Datenbank (der Einfachheit halber enth√§lt es in diesem Beispiel nur 4 Tabellen, in Wirklichkeit k√∂nnen es jedoch Hunderte sein).  Einige Tabellen enthalten referenzielle Daten, andere Gesch√§ftsdaten, und all dies kann logisch in eine oder mehrere komplexe Entit√§ten gruppiert werden.  Beziehungen werden mit <em>Fremdschl√ºsseln</em> verkn√ºpft. Um einen <code>Bonus</code> zu erstellen, ist ein <code>Package</code> erforderlich, f√ºr das wiederum ein <code>User</code> erforderlich ist, und so weiter. </p><br><p><img src="https://habrastorage.org/webt/3z/of/sy/3zofsyjoygierusjtmlu_okrmh0.png"></p><br><p>  Problemumgehungen und Hacks f√ºhren nur zu Dateninkonsistenzen und damit zu stundenlangem Debuggen.  Aus diesem Grund nehmen wir in keiner Weise √Ñnderungen am Schema vor. </p><br><p>  Wir k√∂nnten einige Produktionsmethoden verwenden, um es zu f√ºllen, aber selbst bei geringer Kontrolle wirft dies viele schwierige Fragen auf.  Was bereitet Daten in Tests f√ºr diesen Produktionscode vor?  M√ºssten wir die Tests neu schreiben, wenn sich der Vertrag dieses Codes √§ndert?  Was ist, wenn die Daten vollst√§ndig von einem anderen Ort stammen und es keine zu verwendenden Methoden gibt?  Wie viele Anforderungen w√ºrde es erfordern, eine Entit√§t zu erstellen, die von vielen anderen abh√§ngt? </p><br><div class="spoiler">  <b class="spoiler_title">Ausf√ºllen der Datenbank im ersten Test</b> <div class="spoiler_text"><pre> <code class="scala hljs">insertUser(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, role = <span class="hljs-string"><span class="hljs-string">"customer"</span></span>) insertPackage(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, userId = <span class="hljs-number"><span class="hljs-number">1</span></span>, status = <span class="hljs-string"><span class="hljs-string">"new"</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">30</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">2</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">20</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">3</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">40</span></span>)</code> </pre> </div></div><br><p>  Verstreute Hilfsmethoden, wie in unserem ersten Beispiel, sind unter einem anderen Deckmantel dasselbe Problem.  Sie tragen die Verantwortung f√ºr das Management von Abh√§ngigkeiten von uns selbst, die wir vermeiden wollen. </p><br><p>  Idealerweise m√∂chten wir eine Datenstruktur, die den Status des gesamten Systems auf einen Blick darstellt.  Ein richtiger Kandidat w√§re eine Tabelle (oder ein <em>Datensatz</em> wie in PHP oder Python), die nur zus√§tzliche Felder enth√§lt, die f√ºr die Gesch√§ftslogik kritisch sind.  Wenn sich dies √§ndert, ist die Pflege der Tests einfach: Wir √§ndern lediglich die Felder im Datensatz.  Beispiel: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">DataRow</span></span>] = <span class="hljs-type"><span class="hljs-type">Table</span></span>( (<span class="hljs-string"><span class="hljs-string">"Package ID"</span></span>, <span class="hljs-string"><span class="hljs-string">"Customer's role"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item prices"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bonus value"</span></span>, <span class="hljs-string"><span class="hljs-string">"Expected final price"</span></span>) , (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">90.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">225.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) , <span class="hljs-number"><span class="hljs-number">210.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) , <span class="hljs-number"><span class="hljs-number">279.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"vip"</span></span> , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">252.0</span></span>) )</code> </pre> <br><p><img src="https://habrastorage.org/webt/5j/dt/2p/5jdt2pdn7hdzhepaut_bhukkcgm.jpeg"></p><br><p>  Aus unserer Tabelle erstellen wir <em>Schl√ºssel</em> - Entit√§tsverkn√ºpfungen nach ID.  Wenn eine Entit√§t von einer anderen abh√§ngt, wird auch ein Schl√ºssel f√ºr diese andere Entit√§t erstellt.  Es kann vorkommen, dass zwei verschiedene Entit√§ten eine Abh√§ngigkeit mit derselben ID erstellen, was zu <em>einer Verletzung des Prim√§rschl√ºssels</em> f√ºhren kann.  Zu diesem Zeitpunkt ist es jedoch unglaublich billig, Schl√ºssel zu deduplizieren. Da sie nur IDs enthalten, k√∂nnen wir sie in eine Sammlung aufnehmen, die f√ºr uns eine Deduplizierung durchf√ºhrt, z. B. ein <code>Set</code> .  Wenn sich dies als unzureichend herausstellt, k√∂nnen wir die intelligentere Deduplizierung immer als separate Funktion implementieren und in die Testlebenszyklusfunktion integrieren. </p><br><div class="spoiler">  <b class="spoiler_title">Schl√ºssel (Beispiel)</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, userId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageItemKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BonusKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span></span></code> </pre> </div></div><br><p>  Das Generieren gef√§lschter Daten f√ºr Felder (z. B. Namen) wird an eine separate Klasse delegiert.  Anschlie√üend erhalten wir mithilfe dieser Klassen- und Konvertierungsregeln f√ºr Schl√ºssel die Zeilenobjekte, die zum Einf√ºgen in die Datenbank vorgesehen sind. </p><br><div class="spoiler">  <b class="spoiler_title">Zeilen (Beispiel)</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleData</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"test name"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">role</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"customer"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">price</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> = <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bonusAmount</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">status</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"new"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, userId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, status: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageItemRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, price: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, role: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BonusRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, bonusAmount: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span></span></code> </pre> </div></div><br><p>  Die gef√§lschten Daten reichen normalerweise nicht aus, daher ben√∂tigen wir eine M√∂glichkeit, bestimmte Felder zu √ºberschreiben.  Gl√ºcklicherweise sind <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Objektive</a> genau das, was wir brauchen - wir k√∂nnen sie verwenden, um alle erstellten Zeilen zu durchlaufen und nur die Felder zu √§ndern, die wir ben√∂tigen.  Da Objektive Funktionen in Verkleidung sind, k√∂nnen wir sie wie gewohnt zusammenstellen, was ihre gr√∂√üte St√§rke ist. </p><br><div class="spoiler">  <b class="spoiler_title">Linse (Beispiel)</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeUserRole</span></span></span></span>(userId: <span class="hljs-type"><span class="hljs-type">Int</span></span>, newRole: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>] =&gt; <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>] = (rows: <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>]) =&gt; rows.modifyAll(_.each.when[<span class="hljs-type"><span class="hljs-type">UserRow</span></span>]) .using(r =&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.id == userId) r.modify(_.role).setTo(newRole) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> r)</code> </pre> </div></div><br><p>  Dank der Komposition k√∂nnen wir verschiedene Optimierungen und Verbesserungen innerhalb des Prozesses anwenden: Beispielsweise k√∂nnten wir Zeilen nach Tabelle gruppieren, um sie mit einem einzigen <code>INSERT</code> einzuf√ºgen, um die Testausf√ºhrungszeit zu verk√ºrzen oder den gesamten Status der Datenbank zu protokollieren. </p><br><div class="spoiler">  <b class="spoiler_title">Vorrichtungsvorbereitungsfunktion</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeFixture</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">STATE</span></span>, <span class="hljs-type"><span class="hljs-type">FX</span></span>, <span class="hljs-type"><span class="hljs-type">ROW</span></span>, <span class="hljs-type"><span class="hljs-type">F</span></span>[_]]( state: <span class="hljs-type"><span class="hljs-type">STATE</span></span>, applyOverrides: <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">ROW</span></span>] =&gt; <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">ROW</span></span>] = x =&gt; x ): <span class="hljs-type"><span class="hljs-type">FX</span></span> = (extractKeys andThen deduplicateKeys andThen enrichWithSampleData andThen applyOverrides andThen logged andThen buildFixture) (state)</code> </pre> </div></div><br><p>  Schlie√ülich bietet uns das Ganze eine Einrichtung.  Im Test selbst wird au√üer dem urspr√ºnglichen Datensatz nichts Zus√§tzliches angezeigt - alle Details werden durch die Funktionszusammensetzung ausgeblendet. </p><br><p><img src="https://habrastorage.org/webt/b3/wz/cq/b3wzcqmqj3gomn-s-zycrakuegy.jpeg"></p><br><p>  Unsere Testsuite sieht jetzt so aus: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">DataRow</span></span>] = <span class="hljs-type"><span class="hljs-type">Table</span></span>( (<span class="hljs-string"><span class="hljs-string">"Package ID"</span></span>, <span class="hljs-string"><span class="hljs-string">"Customer's role"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item prices"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bonus value"</span></span>, <span class="hljs-string"><span class="hljs-string">"Expected final price"</span></span>) , (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">90.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">225.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) , <span class="hljs-number"><span class="hljs-number">210.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) , <span class="hljs-number"><span class="hljs-number">279.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"vip"</span></span> , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">252.0</span></span>) ) <span class="hljs-string"><span class="hljs-string">"If the buyer's role is"</span></span> - { <span class="hljs-string"><span class="hljs-string">"a customer"</span></span> - { <span class="hljs-string"><span class="hljs-string">"And the total price of items"</span></span> - { <span class="hljs-string"><span class="hljs-string">"&lt; 250 after applying bonuses - no discount"</span></span> - { <span class="hljs-string"><span class="hljs-string">"(case: no bonuses)"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"(case: has bonuses)"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">3</span></span>) } <span class="hljs-string"><span class="hljs-string">"&gt;= 250 after applying bonuses"</span></span> - { <span class="hljs-string"><span class="hljs-string">"If there are no bonuses - 10% off on the subtotal"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"If there are bonuses - 10% off on the subtotal after applying bonuses"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">4</span></span>) } } } <span class="hljs-string"><span class="hljs-string">"a vip - then they get a 20% off before applying bonuses and then all the other rules apply"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">5</span></span>) }</code> </pre> <br><p>  Und der Hilfecode: </p><br><div class="spoiler">  <b class="spoiler_title">Hilfecode</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// Reusable test's body def calculatePriceFor(table: Seq[DataRow], idx: Int) = testInDb( state = makeState(table.row(idx)), execute = runProductionCode(table.row(idx)._1), check = checkResult(table.row(idx)._5) ) def makeState(row: DataRow): Logger =&gt; DbFixture = { val items: Map[Int, Int] = ((1 to row._3.length) zip row._3).toMap val bonuses: Map[Int, Int] = ((1 to row._4.length) zip row._4).toMap MyFixtures.makeFixture( state = PackageRelationships .minimal(id = row._1, userId = 1) .withItems(items.keys) .withBonuses(bonuses.keys), overrides = changeRole(userId = 1, newRole = row._2) andThen items.map { case (id, newPrice) =&gt; changePrice(id, newPrice) }.foldPls andThen bonuses.map { case (id, newBonus) =&gt; changeBonus(id, newBonus) }.foldPls ) } def runProductionCode(id: Int): Database =&gt; Double = (db: Database) =&gt; new SomeProductionLogic(db).calculatePrice(id) def checkResult(expected: Double): Double =&gt; Future[Assertion] = (result: Double) =&gt; result shouldBe expected</span></span></code> </pre></div></div><br><p>  Das Hinzuf√ºgen neuer Testf√§lle zur Tabelle ist eine triviale Aufgabe, mit der wir uns darauf konzentrieren k√∂nnen <strong>, mehr Randf√§lle abzudecken</strong> und nicht auf das Schreiben von Boilerplate-Code. </p><br><h2 id="reusing-fixture-preparation-on-different-projects">  Wiederverwendung der Ger√§tevorbereitung f√ºr verschiedene Projekte </h2><br><p>  Okay, wir haben eine Menge Code geschrieben, um Fixtures in einem bestimmten Projekt vorzubereiten, und dabei einige Zeit damit verbracht.  Was ist, wenn wir mehrere Projekte haben?  Sind wir dazu verdammt, das Ganze jedes Mal neu zu erfinden? </p><br><p>  Wir k√∂nnen die Fixture-Vorbereitung √ºber ein konkretes Dom√§nenmodell abstrahieren.  In der Welt der funktionalen Programmierung gibt es ein Konzept von <em>Typklassen</em> .  Ohne auf Details einzugehen, sind sie nicht wie Klassen in OOP, sondern eher wie Schnittstellen, da sie ein bestimmtes Verhalten einer Gruppe von Typen definieren.  Der grundlegende Unterschied besteht darin, dass sie nicht vererbt, sondern wie Variablen instanziiert werden.  √Ñhnlich wie bei der Vererbung erfolgt die Aufl√∂sung von Typklasseninstanzen jedoch <em>zur Kompilierungszeit</em> .  In diesem Sinne k√∂nnen Typklassen wie <em>Erweiterungsmethoden</em> von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kotlin</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">C #</a> erfasst werden. </p><br><p>  Um ein Objekt zu protokollieren, m√ºssen wir nicht wissen, was sich darin befindet, welche Felder und Methoden es hat.  Wir k√ºmmern uns nur um ein Verhaltensprotokoll <code>log()</code> mit einer bestimmten Signatur.  Das Erweitern jeder einzelnen Klasse mit einer <code>Logged</code> Schnittstelle w√§re √§u√üerst m√ºhsam und selbst dann in vielen F√§llen nicht m√∂glich - beispielsweise f√ºr Bibliotheken oder Standardklassen.  Mit Typklassen ist dies viel einfacher.  Wir k√∂nnen eine Instanz einer Typklasse namens "Protokolliert" erstellen, z. B. f√ºr ein Ger√§t, um sie in einem f√ºr Menschen lesbaren Format zu protokollieren.  F√ºr alles andere, das keine Instanz von <code>Logged</code> , k√∂nnen wir einen Fallback bereitstellen: eine Instanz f√ºr den Typ <code>Any</code> , der eine Standardmethode <code>toString()</code> , um jedes Objekt in seiner internen Darstellung kostenlos zu protokollieren. </p><br><div class="spoiler">  <b class="spoiler_title">Ein Beispiel f√ºr die protokollierte Typklasse und ihre Instanzen</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Logged</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span></span>(a: <span class="hljs-type"><span class="hljs-type">A</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> logger: <span class="hljs-type"><span class="hljs-type">Logger</span></span>): <span class="hljs-type"><span class="hljs-type">A</span></span> } <span class="hljs-comment"><span class="hljs-comment">// For all Futures implicit def futureLogged[T]: Logged[Future[T]] = new Logged[Future[T]] { override def log(futureT: Future[T])(implicit logger: Logger): Future[T] = { futureT.map { t =&gt; // map on a Future lets us modify its result after it finishes logger.info(t.toString()) t } } } // Fallback in case there are no suitable implicits in scope implicit def anyNoLogged[T]: Logged[T] = new Logged[T] { override def log(t: T)(implicit logger: Logger): T = { logger.info(t.toString()) t } }</span></span></code> </pre> </div></div><br><p>  Neben der Protokollierung k√∂nnen wir diesen Ansatz w√§hrend des gesamten Prozesses der Herstellung von Vorrichtungen verwenden.  Unsere L√∂sung schl√§gt eine abstrakte Methode vor, um Datenbank-Fixtures und eine Reihe von dazugeh√∂rigen Typklassen zu erstellen.  Es ist das Projekt, das die Verantwortung der L√∂sung nutzt, um die Instanzen dieser Typklassen zu implementieren, damit das Ganze funktioniert. </p><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// Fixture preparation function def makeFixture[STATE, FX, ROW, F[_]]( state: STATE, applyOverrides: F[ROW] =&gt; F[ROW] = x =&gt; x ): FX = (extractKeys andThen deduplicateKeys andThen enrichWithSampleData andThen applyOverrides andThen logged andThen buildFixture) (state) override def extractKeys(implicit toKeys: ToKeys[DbState]): DbState =&gt; Set[Key] = (db: DbState) =&gt; db.toKeys() override def enrichWithSampleData(implicit enrich: Enrich[Key]): Key =&gt; Set[Row] = (key: Key) =&gt; key.enrich() override def buildFixture(implicit insert: Insertable[Set[Row]]): Set[Row] =&gt; DbFixture = (rows: Set[Row]) =&gt; rows.insert() // Behavior of splitting something (eg a dataset) into keys trait ToKeys[A] { def toKeys(a: A): Set[Key] // Something =&gt; Set[Key] } // ...converting keys into rows trait Enrich[A] { def enrich(a: A): Set[Row] // Set[Key] =&gt; Set[Row] } // ...and inserting rows into the database trait Insertable[A] { def insert(a: A): DbFixture // Set[Row] =&gt; DbFixture } // To be implemented in our project (see the example at the end of the article) implicit val toKeys: ToKeys[DbState] = ??? implicit val enrich: Enrich[Key] = ??? implicit val insert: Insertable[Set[Row]] = ???</span></span></code> </pre> <br><p>  Bei der Entwicklung dieses Werkzeugs zur Vorbereitung von Vorrichtungen habe ich die <em>SOLID-Prinzipien</em> als Kompass verwendet, um sicherzustellen, dass es wartbar und erweiterbar ist: </p><br><ul><li>  <em>Das Prinzip der Einzelverantwortung</em> : Jede Typklasse beschreibt ein und nur ein Verhalten eines Typs. </li><li>  <em>Das Open / Closed-Prinzip</em> : Wir modifizieren keine der Produktionsklassen.  Stattdessen erweitern wir sie um Instanzen von Typklassen. </li><li>  <em>Das Liskov-Substitutionsprinzip</em> gilt hier nicht, da wir keine Vererbung verwenden. </li><li>  <em>Das Prinzip der Schnittstellentrennung</em> : Wir verwenden viele spezialisierte Typklassen im Gegensatz zu einer globalen. </li><li>  <em>Das Prinzip</em> der <em>Abh√§ngigkeitsinversion</em> : Die Funktion zur Vorbereitung von Vorrichtungen h√§ngt nicht von konkreten Typen ab, sondern von abstrakten Typklassen. </li></ul><br><p>  Nachdem wir sichergestellt haben, dass alle Prinzipien erf√ºllt sind, k√∂nnen wir davon ausgehen, dass unsere L√∂sung wartbar und erweiterbar genug ist, um in verschiedenen Projekten verwendet zu werden. </p><br><p>  Nachdem wir die Testlebenszyklusfunktion und die L√∂sung f√ºr die Ger√§tevorbereitung geschrieben haben, die auch unabh√§ngig von einem konkreten Dom√§nenmodell f√ºr eine bestimmte Anwendung ist, sind wir alle bereit, alle verbleibenden Tests zu verbessern. </p><br><h2 id="bottom-line">  Fazit </h2><br><p>  Wir haben vom traditionellen (schrittweisen) Testdesignstil auf funktional umgestellt.  Der Schritt-f√ºr-Schritt-Stil ist fr√ºhzeitig und in kleineren Projekten n√ºtzlich, da er Entwickler nicht einschr√§nkt und keine speziellen Kenntnisse erfordert.  Wenn jedoch die Anzahl der Tests zu gro√ü wird, f√§llt ein solcher Stil tendenziell ab.  Das Schreiben von Tests im funktionalen Stil wird wahrscheinlich nicht alle Ihre Testprobleme l√∂sen, aber es k√∂nnte die Skalierung und Pflege von Tests in Projekten, in denen es Hunderte oder Tausende von Tests gibt, erheblich verbessern.  Tests, die im funktionalen Stil geschrieben sind, erweisen sich als pr√§gnanter und konzentrieren sich auf die wesentlichen Dinge (wie Daten, zu testender Code und das erwartete Ergebnis) und nicht auf die Zwischenschritte. </p><br><p>  Dar√ºber hinaus haben wir untersucht, wie leistungsf√§hig Funktionskompositionen und Typklassen in der funktionalen Programmierung sein k√∂nnen.  Mit ihrer Hilfe ist es ganz einfach, L√∂sungen mit Blick auf Erweiterbarkeit und Wiederverwendbarkeit zu entwerfen. </p><br><p>  Seit wir den Stil vor einigen Monaten √ºbernommen haben, musste unser Team einige Anstrengungen unternehmen, um sich anzupassen, aber am Ende haben wir das Ergebnis genossen.  Neue Tests werden schneller geschrieben, Protokolle machen das Leben viel komfortabler und Datens√§tze k√∂nnen praktisch √ºberpr√ºft werden, wenn Fragen zu den Feinheiten einiger Logik auftreten.  Unser Team ist bestrebt, alle Tests schrittweise auf diesen neuen Stil umzustellen. </p><br><hr><br><p>  Einen Link zur L√∂sung und ein vollst√§ndiges Beispiel finden Sie hier: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github</a> .  Viel Spa√ü beim Testen! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de465211/">https://habr.com/ru/post/de465211/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de465189/index.html">Workflow One Sprint-Entwicklungsteam</a></li>
<li><a href="../de465191/index.html">Schulung Cisco 200-125 CCNA v3.0. Tag 25. Eingehende Untersuchung von IPv6</a></li>
<li><a href="../de465193/index.html">Erstellen eines Android-Projekts in einem Docker-Container</a></li>
<li><a href="../de465203/index.html">Firmenelefant</a></li>
<li><a href="../de465209/index.html">Wir lernen die Passdaten einer Person mit Namen (wenn es eine Sicherheit gibt)</a></li>
<li><a href="../de465215/index.html">Was Sie lesen sollten Teamleiter und Tankstelle: Eine Auswahl von 50 B√ºchern mit Noten und mehr</a></li>
<li><a href="../de465217/index.html">Acronis True Image 2020: Neue Replikationsschemata und verbesserter Schutz</a></li>
<li><a href="../de465221/index.html">Wie Register in 1C in Gegenwart von OOP aussehen k√∂nnten</a></li>
<li><a href="../de465223/index.html">Wie Sie die Papiersicherheit in der Praxis nutzen k√∂nnen oder warum 152-–§–ó- und PCI-DSS in einer Cloud eingehalten werden m√ºssen</a></li>
<li><a href="../de465227/index.html">Augmented Reality im Online-Handel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>