<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¥ üë©üèæ‚Äçü§ù‚Äçüë©üèΩ üëá Un tigre accroupi se cache dans SQLAlchemy. Les bases üö∏ üïäÔ∏è üßïüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonne journ√©e 


 Aujourd'hui, je veux parler de ORM SQLAlchemy. Parlons de ce que sont ses capacit√©s et sa flexibilit√©, et consid√©rons √©galement les ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Un tigre accroupi se cache dans SQLAlchemy. Les bases</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/470285/"><p><img src="https://habrastorage.org/webt/3o/ji/ei/3ojiei46dcl8pihke7rjjojlgn4.jpeg"></p><br><p>  Bonne journ√©e </p><br><p>  Aujourd'hui, je veux parler de ORM SQLAlchemy.  Parlons de ce que sont ses capacit√©s et sa flexibilit√©, et consid√©rons √©galement les cas qui ne sont pas toujours clairement d√©crits. </p><br><p>  Cet ORM a un seuil d'entr√©e sup√©rieur √† la moyenne, je vais donc essayer de tout expliquer dans un langage simple et avec des exemples.  Cet article sera utile √† ceux qui travaillent d√©j√† avec sqlalchemy et souhaitent am√©liorer leurs comp√©tences ou tout simplement se familiariser avec cette biblioth√®que. </p><a name="habracut"></a><br><p>  Le langage de programmation utilis√© est python 3.6. <br>  DB - PostgreSQL. <br>  Lien Github </p><br><p>  Alors, qu'est-ce que l'ORM? </p><br><p>  ORM (Object-Relational Mapping) est une technologie qui vous permet de mapper des mod√®les dont les types sont incompatibles.  Par exemple: une table de base de donn√©es et un objet de langage de programmation. </p><br><p> En d'autres termes, vous pouvez acc√©der aux objets de classe pour g√©rer les donn√©es dans les tables de base de donn√©es.  Vous pouvez √©galement cr√©er, modifier, supprimer, filtrer et, surtout, h√©riter des objets de classe mapp√©s aux tables de base de donn√©es, ce qui r√©duit consid√©rablement le contenu de la base de code. </p><br><p>  Pour utiliser SQLAlchemy, vous devez comprendre comment cela fonctionne. </p><br><p>  Les d√©veloppeurs qui utilisent Django-ORM devront reconstruire un peu leur √©tat d'esprit pour cr√©er des requ√™tes ORM.  √Ä mon avis, SQLAlchemy est un monstre fonctionnel dont vous pouvez et devez utiliser les capacit√©s, mais vous devez comprendre que les ORM ne sont pas toujours parfaits.  Par cons√©quent, nous discuterons des moments o√π l'utilisation de cette technologie est appropri√©e. </p><br><p>  SQLAlchemy a le concept de d√©finitions de mod√®le d√©claratives et non d√©claratives. </p><br><p>  Les d√©finitions non d√©claratives impliquent l'utilisation de mapper (), qui d√©crit le mappage de chaque colonne de base de donn√©es et classe de mod√®le. </p><br><p>  Cet article utilise une d√©finition d√©clarative des mod√®les. </p><br><p>  Plus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> </p><br><h3 id="struktura-bd">  Structure DB </h3><br><p>  Pour une coh√©rence compl√®te des donn√©es, cr√©ons les tableaux suivants. </p><br><p>  Le mod√®le de base est utilis√© pour d√©terminer les colonnes de base dans la base de donn√©es. </p><br><pre><code class="plaintext hljs">class BaseModel(Base): __abstract__ = True id = Column(Integer, nullable=False, unique=True, primary_key=True, autoincrement=True) created_at = Column(TIMESTAMP, nullable=False) updated_at = Column(TIMESTAMP, nullable=False) def __repr__(self): return "&lt;{0.__class__.__name__}(id={0.id!r})&gt;".format(self)</code> </pre> <br><p>  Employ√© - un tableau d√©crivant l'employ√© qui travaille au bureau </p><br><pre> <code class="plaintext hljs">class Employee(BaseModel): __tablename__ = 'employees' first_name = Column(VARCHAR(255), nullable=False) last_name = Column(VARCHAR(255), nullable=False) phone = Column(VARCHAR(255), unique=True, nullable=True) description = Column(VARCHAR(255), nullable=True)</code> </pre> <br><p>  EmployeeWithSkills n'est pas une table.  La classe h√©rit√©e de Employee.  Une excellente occasion de s√©parer la logique et d'utiliser la classe comme s'il s'agissait d'une table distincte. </p><br><pre> <code class="plaintext hljs">class EmployeeWithSkills(Employee): skills = relation(Skill, secondary=EmployeesSkills.__tablename__, lazy='joined')</code> </pre> <br><p>  D√©partement - le d√©partement dans lequel cet employ√© travaille.  Une personne peut comprendre plusieurs d√©partements. </p><br><pre> <code class="plaintext hljs">class Department(BaseModel): __tablename__ = 'departments' name = Column(VARCHAR(255), nullable=False) description = Column(VARCHAR(255), nullable=False)</code> </pre> <br><p>  La table de correspondance de l'employ√© et les unit√©s dont il fait partie. </p><br><pre> <code class="plaintext hljs">class EmployeeDepartments(BaseModel): __tablename__ = 'employee_departments' employee_id = Column(Integer, ForeignKey('employees.id', ondelete='CASCADE'), nullable=False, index=True) department_id = Column(Integer, ForeignKey('departments.id', ondelete='CASCADE'), nullable=False, index=True)</code> </pre> <br><p>  Tableau de correspondance des salari√©s et de leurs comp√©tences. </p><br><pre> <code class="plaintext hljs">class EmployeesSkills(BaseModel): __tablename__ = 'employees_skills' employee_id = Column(ForeignKey('employee.id', ondelete='CASCADE'), nullable=False, index=True) skill_id = Column(ForeignKey('skills.id', ondelete='CASCADE'), nullable=False, index=True)</code> </pre> <br><p>  Nous cr√©ons des migrations en utilisant le paquet alembic, qui vous permet de les g√©n√©rer automatiquement.  Dans cette le√ßon, la g√©n√©ration automatique de migrations est parfaitement acceptable. </p><br><p>  La derni√®re migration contient des donn√©es de test qui rempliront la base de donn√©es. <br>  Comment configurer alambic peut √™tre lu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> <br>  Nous effectuons une pr√©cieuse mise √† niveau d'alambic pour effectuer la migration. </p><br><h3 id="zaprosy-i-relations">  Demandes et relations </h3><br><p>  Faisons la premi√®re demande et obtenons des informations sur l'employ√© par son identifiant. <br>  La demande ressemblera √† ceci: </p><br><p>  le√ßon 1: </p><br><pre> <code class="plaintext hljs">employee = session.query(Employee).filter(Employee.id == eid).one() output: ID: 2, Tony Stark</code> </pre> <br><p>  <code>.one()</code> √† la fin signifie que nous avons l'intention d'obtenir une seule entr√©e.  S'il y a plusieurs entr√©es, une exception appropri√©e sera lev√©e. </p><br><p>  Si nous voulons obtenir tous les d√©partements disponibles, nous pouvons utiliser la requ√™te suivante en utilisant <code>.all()</code> </p><br><p>  le√ßon 2: </p><br><pre> <code class="plaintext hljs">emmployee = session.query(Department).all() output: ID: 2, name: Guards ID: 4, name: Legions</code> </pre> <br><p>  Envisagez de travailler avec des fonctions d'agr√©gation. </p><br><p>  Nous pouvons obtenir le nombre de services disponibles en utilisant la fonction int√©gr√©e. <br>  <code>.count()</code> ou utilisez <code>func.count()</code> .  √Ä l'aide de la deuxi√®me m√©thode, vous pouvez acc√©der √† toutes les fonctions SQL √† l'aide de la <code>select</code> ou du calcul des r√©sultats interm√©diaires. </p><br><p>  le√ßon 3: </p><br><pre> <code class="plaintext hljs">def get_departments_count(session: DBSession) -&gt; int: count = session.query(Department).count() return count def get_departments_func_count(session: DBSession) -&gt; int: count = session.query(func.count(Department.id)).scalar() return count</code> </pre> <br><p>  De nombreux d√©veloppeurs utilisent la fonction <code>count()</code> pour v√©rifier les donn√©es dans une demande.  Ce n'est pas une bonne pratique, ce qui entra√Æne l'utilisation de ressources de base de donn√©es suppl√©mentaires et augmente le temps d'ex√©cution des requ√™tes.  Une bonne solution serait d'utiliser la fonction <code>exists()</code> qui retourne une valeur scalaire: <br>  le√ßon 3: </p><br><pre> <code class="plaintext hljs">def check_department_exists(session: DBSession, department_name: str) -&gt; bool: is_exists = session.query(exists().where(Department.name == department_name)).scalar() return is_exists</code> </pre> <br><p>  En continuant, nous compliquons la t√¢che et nous familiarisons avec la <code>relation</code> entit√© ou la <code>relationship</code> .  Le fait est que dans <code>SQLAlchemy</code> en plus d'utiliser Foreign_key <br>  au niveau de la base de donn√©es, les relations entre les objets sont √©galement utilis√©es. </p><br><p>  Ainsi, nous pouvons obtenir la ligne de base de donn√©es en fonction de la cl√© √©trang√®re dans l'objet. <br>  Ces objets sont une projection sur les tables de la base de donn√©es, interconnect√©es. </p><br><p>  <code>Relations</code> dans <code>SQLAlchemy</code> ont une configuration flexible, vous permettant d'obtenir des donn√©es de la base de donn√©es de diff√©rentes mani√®res √† diff√©rents moments en utilisant l'argument nomm√© <code>lazy</code> . </p><br><p>  Les principaux degr√©s de "paresse": </p><br><ul><li>  <code>select</code> est la valeur par d√©faut.  ORM fait une demande uniquement lors de l'acc√®s aux donn√©es.  Il est effectu√© dans une demande distincte. </li><li>  <code>dynamic</code> - vous permet d'obtenir un objet de demande, qui peut √™tre modifi√© √† votre guise.  Il re√ßoit des donn√©es de la base de donn√©es uniquement apr√®s avoir appel√© all () ou one () ou toute autre m√©thode disponible. </li><li>  <code>joined</code> - est ajout√©e √† la requ√™te principale √† l'aide de LEFT JOIN.  Elle est r√©alis√©e imm√©diatement. </li><li>  <code>subquery</code> - <code>subquery</code> - similaire √† select, mais ex√©cut√©e en tant que sous-requ√™te. </li></ul><br><p>  La valeur par d√©faut est <code>select</code> . </p><br><p>  Le filtrage dans les requ√™tes peut √™tre statique et dynamique.  Le filtrage dynamique permet de remplir la demande avec des filtres, qui peuvent varier en fonction de l'avancement de la fonction. </p><br><p>  le√ßon 4: </p><br><pre> <code class="plaintext hljs">def dynamic_filter(session: DBSession, filter: DFilter = None): query = session.query(Employee) if filter is not None: query = query.filter(*filter.conds) employees = query.all() return employees</code> </pre> <br><p>  La classe de filtre DFilter d√©finit des filtres bas√©s sur n'importe quelle entr√©e.  Si la classe de filtre est d√©finie, mais plus loin dans les conditions de demande s'appliquent. </p><br><p>  La fonction .filter () accepte accepte les conditions binaires SQLAlchemy, donc elle peut √™tre repr√©sent√©e en utilisant * </p><br><p>  L'utilisation de filtres dynamiques n'est limit√©e que par l'imagination.  Le r√©sultat de la requ√™te montre quels h√©ros sont actuellement inactifs. </p><br><pre> <code class="plaintext hljs">output: Inactive_heros: Name: Tony Stark Name: Scott Lang Name: Peter Parker</code> </pre> <br><p>  Je sugg√®re de travailler avec la relation plusieurs-√†-plusieurs. </p><br><p>  Nous avons une table des employ√©s dans laquelle il y a une relation avec la table de correspondance des employ√©s.  Il contient foreign_key sur la table des employ√©s et foreign_key <br>  √† la table des comp√©tences. </p><br><p>  le√ßon 5: </p><br><pre> <code class="plaintext hljs">def get_employee_with_skills(session: DBSession, eid: int): employee = session.query(EmployeeWithSkills).filter(EmployeeWithSkills.id == eid).one() return employee output: Employee Tony Stark has skills: Skill: Fly, Desc: I belive I can Fly. I belive I can touch the sky Skill: Light Shield, Desc: Light protect. Perfect for everything</code> </pre> <br><p>  En utilisant la classe EmployeeWithSkills dans la requ√™te ci-dessus, nous l'appelons une table de base de donn√©es, mais en r√©alit√© une telle table n'existe pas.  Cette classe est diff√©rente de l'employ√© ayant une relation, qui a une relation plusieurs-√†-plusieurs.  Nous pouvons donc diff√©rencier la logique des classes en la remplissant d'un ensemble de relations diff√©rent.  √Ä la suite de la demande, nous verrons les comp√©tences de l'un des employ√©s. </p><br><p>  √âtant donn√© que l'employ√© peut √™tre dans plusieurs d√©partements, cr√©ez une relation qui vous permet d'obtenir ces informations. </p><br><p>  Cr√©ez une classe EmployeeWithDepartments h√©rit√©e de Employee et ajoutez ce qui suit: </p><br><pre> <code class="plaintext hljs">class EmployeeWithDepartments(Employee): departments = relation( Department, # primaryjoin=EmployeeDepartments.employee_id == Employee.id, secondary=EmployeeDepartments.__tablename__, # secondaryjoin=EmployeeDepartments.department_id == Department.id, )</code> </pre> <br><p>  La classe cr√©√©e n'est pas une nouvelle table de base de donn√©es.  Il s'agit toujours de la m√™me table Employee, uniquement d√©velopp√©e √† l'aide de <code>relation</code> .  De cette fa√ßon, vous pouvez acc√©der √† la table <code>Employee</code> ou <code>EmployeeWithDepartments</code> dans les requ√™tes.  La diff√©rence ne sera qu'en absence / pr√©sence de <code>relation</code> . </p><br><p>  Le premier argument indique √† quelle table nous allons cr√©er la <code>relation</code> . <br>  <code>primaryjoin</code> est la condition par laquelle la deuxi√®me table sera connect√©e avant d'√™tre attach√©e √† l'objet. <br>  <code>secondary</code> est le nom de la table contenant les cl√©s √©trang√®res pour la correspondance.  Utilis√© dans le cas de plusieurs √† plusieurs. <br>  <code>secondaryjoin</code> - conditions pour faire correspondre la table interm√©diaire avec la derni√®re. </p><br><p>  <code>primaryjoin</code> et le <code>primaryjoin</code> <code>secondaryjoin</code> servent √† indiquer explicitement les correspondances dans des situations complexes. </p><br><p>  Parfois, des situations surviennent lorsqu'il est n√©cessaire de cr√©er des filtres dont les champs sont d√©clar√©s dans les relations, et les relations, √† leur tour, sont des relations de la classe d'origine. </p><br><pre> <code class="plaintext hljs">EmployeeWithCadreMovements -&gt; relation(CadreMovement) -&gt; field</code> </pre> <br><p>  Si la relation affiche une liste de valeurs, alors .any () doit √™tre utilis√©, si une seule valeur est fournie, alors .has () doit √™tre utilis√© </p><br><p>  Pour une meilleure compr√©hension, cette construction sera interpr√©t√©e dans le langage SQL dans la construction exist (). </p><br><p>  Nous appelons la fonction get avec le param√®tre de param√®tre reason, par exemple, <code>simple</code> . </p><br><p>  le√ßon 6 </p><br><pre> <code class="plaintext hljs">def has_in_relations(session: DBSession, reason: str): employees = session.query(EmployeeWithCadreMovements).filter(EmployeeWithCadreMovements.cadre_movements.any(CadreMovement.reason == reason)).all() return employees output: [Steve Rogers, Tony Stark]</code> </pre> <br><p>  lession7 </p><br><p>  Consid√©rez la possibilit√© d'obtenir une relation en utilisant la fonction d'agr√©gation.  Par exemple, nous obtenons le dernier mouvement de personnel d'un utilisateur sp√©cifique. <br>  primaryjoin est une condition pour joindre des tables (si lazy = 'join' est utilis√©).  Rappelons que select est utilis√© par d√©faut. <br>  Dans ce cas, une demande distincte est g√©n√©r√©e lors de l'acc√®s √† l'attribut de classe.  C'est pour cette demande que l'on peut sp√©cifier les conditions de filtrage. <br>  Comme vous le savez, vous ne pouvez pas utiliser les fonctions d'agr√©gation sous une forme ¬´pure¬ª dans une condition WHERE, nous pouvons donc impl√©menter cette fonctionnalit√© en sp√©cifiant la relation <br>  avec les param√®tres suivants: </p><br><pre> <code class="plaintext hljs">last_cadre_movement = relation( CadreMovement, primaryjoin=and_( CadreMovement.employee == Employee.id, uselist=False, CadreMovement.id == select([func.max(CadreMovement.id)]).where(CadreMovement.employee == Employee.id) ) )</code> </pre> <br><p>  Une fois ex√©cut√©e, la demande se compile comme suit: </p><br><pre> <code class="plaintext hljs">SELECT cadre_movements.id AS cadre_movements_id, cadre_movements.created_at AS cadre_movements_created_at, cadre_movements.updated_at AS cadre_movements_updated_at, cadre_movements.employee AS cadre_movements_employee, cadre_movements.old_department AS cadre_movements_old_department, cadre_movements.new_department AS cadre_movements_new_department, cadre_movements.reason AS cadre_movements_reason FROM cadre_movements WHERE cadre_movements.employee = %(param_1)s AND cadre_movements.id = ( SELECT max(cadre_movements.id) AS max_1 FROM cadre_movements WHERE cadre_movements.employee = %(param_1)s )</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien Github</a> </p><br><h3 id="itog">  R√©sum√© </h3><br><p>  SQLAlchemy est un puissant outil de cr√©ation de requ√™tes qui r√©duit le temps de d√©veloppement en prenant en charge l'h√©ritage. </p><br><p>  Mais vous devez garder une fine ligne entre l'utilisation d'ORM et l'√©criture de requ√™tes complexes.  Dans certains cas, ORM peut d√©router le d√©veloppeur ou rendre le code lourd et illisible. <br>  Bonne chance </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr470285/">https://habr.com/ru/post/fr470285/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr470275/index.html">F # 8: Syndicats discrimin√©s</a></li>
<li><a href="../fr470277/index.html">Comment le r√©seau mondial de la F√©d√©ration de Russie est-il organis√© et organis√©?</a></li>
<li><a href="../fr470279/index.html">AI, apprentissage automatique, Big Data, reconnaissance vocale et autres mots qui ne vous aideront PAS √† apprendre l'anglais</a></li>
<li><a href="../fr470281/index.html">Le visage du logiciel russe. Ou quelques statistiques du registre unifi√© des programmes informatiques et des bases de donn√©es russes</a></li>
<li><a href="../fr470283/index.html">Le moteur de recherche est une femme</a></li>
<li><a href="../fr470287/index.html">Migrant</a></li>
<li><a href="../fr470289/index.html">Le langage de programmation de mes r√™ves</a></li>
<li><a href="../fr470293/index.html">Comment la vuln√©rabilit√© dans Yandex.Stations m'a inspir√© pour le projet: transfert de donn√©es musicales</a></li>
<li><a href="../fr470295/index.html">Cryptage SQlite DB simple</a></li>
<li><a href="../fr470299/index.html">Gestion efficace de la connexion SignalR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>