<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîÖ üéæ ‚ö∞Ô∏è Seekor ular di kotak surat dan apa F # ü§∂ üë©üèø‚Äçüè´ üçè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tentang apa semua ini? 


 Ini semua tentang ular. Semua orang ingat apa itu ular: ular bergerak di bidang persegi panjang. Menemukan makanan - tumbuh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Seekor ular di kotak surat dan apa F #</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424861/"><h4 id="o-chem-eto-vse">  Tentang apa semua ini? </h4><br><p>  Ini semua tentang ular.  Semua orang ingat apa itu ular: ular bergerak di bidang persegi panjang.  Menemukan makanan - tumbuh panjang, menemukan dirinya atau ujung lapangan - mati.  Dan pengguna hanya dapat mengirim perintah: kiri, kanan, atas, bawah. <br>  Saya memutuskan untuk menambahkan beberapa tindakan di sini dan membuat ular melarikan diri dari pacman.  Dan semua ini pada aktor! </p><br><p> Oleh karena itu, hari ini saya akan menggunakan contoh ular untuk berbicara tentang bagaimana membangun model aktor menggunakan <code>MailboxProcessor</code> dari perpustakaan standar, poin apa yang harus dicari, dan perangkap apa yang dapat Anda harapkan. </p><br><p>  Kode yang ditulis di sini tidak sempurna, mungkin melanggar beberapa prinsip, dan mungkin lebih baik ditulis.  Tetapi jika Anda seorang pemula dan ingin berurusan dengan kotak surat - Saya harap artikel ini membantu Anda. <br>  Jika Anda tahu segalanya tentang kotak surat tanpa saya, Anda mungkin bosan di sini. </p><br><h4 id="pochemu-aktory">  Mengapa aktor? </h4><br><p>  Demi latihan.  Saya membaca tentang model aktor, menonton video, saya menyukai segalanya, tetapi saya tidak mencobanya sendiri.  Sekarang saya mencobanya. <br>  Terlepas dari kenyataan bahwa sebenarnya saya memilih teknologi demi teknologi, konsep ini sangat berhasil jatuh pada tugas ini. </p><br><h4 id="pochemu-mailboxprocessor-a-ne-naprimer-akkanet">  Mengapa MailboxProcessor, dan bukan, misalnya, Akka.net? </h4><br><p>  Untuk tugas saya, <code>MailboxProcessor</code> dari stasiun orbital oleh burung pipit, <code>MailboxProcessor</code> jauh lebih sederhana, dan itu adalah bagian dari perpustakaan standar, jadi Anda tidak perlu menghubungkan paket apa pun. </p><a name="habracut"></a><br><h4 id="o-meylboks-processorah-i-soputsvuyuschem-boylerpleyte">  Tentang prosesor kotak surat dan boilerplate terkait </h4><br><p>  Intinya sederhana.  Kotak surat di dalamnya memiliki loop pesan dan beberapa status.  Perulangan pesan Anda akan memperbarui status ini sesuai dengan pesan baru yang tiba. </p><br><pre> <code class="hljs kotlin">let actor = MailboxProcessor.Start(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> inbox -&gt; // ,    //   . inbox --    MailboxProcessor let rec messageLoop oldState = async { //   let! msg = inbox.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">//    let newState = updateState oldState msg //      return! messageLoop newState } //       .    --     messageLoop (0,0) )</span></span></code> </pre> <br><p>  Harap dicatat <code>messageLoop</code> rekursif, dan pada akhirnya harus dipanggil lagi, jika tidak hanya satu pesan yang akan diproses, setelah itu aktor ini akan mati.  <code>messageLoop</code> juga asinkron, dan setiap iterasi berikutnya dilakukan ketika pesan baru diterima: <code>let! msg = inbox.Receive()</code>  <code>let! msg = inbox.Receive()</code> . <br>  Dengan demikian, seluruh muatan logis masuk ke fungsi <code>updateState</code> , yang berarti bahwa untuk membuat kotak surat prosesor, kita bisa membuat fungsi konstruktor yang menerima fungsi pembaruan status dan keadaan nol: </p><br><pre> <code class="hljs haskell">//   applyMessage       //      (fun inbox -&gt; ...) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> buildActor applyMessage zeroState = <span class="hljs-type"><span class="hljs-type">MailboxProcessor</span></span>.<span class="hljs-type"><span class="hljs-type">Start</span></span>(fun inbox -&gt; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rec</span></span> loop state = async{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span>! msg = inbox.<span class="hljs-type"><span class="hljs-type">Receive</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> newState = applyMessage state msg return! loop newState } loop zeroState )</code> </pre><br><p>  Keren!  Sekarang kita tidak perlu terus-menerus memonitor agar tidak lupa <code>return! loop newState</code>  <code>return! loop newState</code> .  Seperti yang Anda tahu, seorang aktor menyimpan negara, tetapi sekarang sama sekali tidak jelas bagaimana cara mendapatkan keadaan ini dari luar.  Kotak surat prosesor memiliki metode <code>PostAndReply</code> , yang menggunakan <code>AsyncReplyChannel&lt;'Reply&gt; -&gt; 'Msg</code> fungsi Pesan Pesan sebagai input.  Pada awalnya itu membuat saya pingsan - benar-benar tidak jelas dari mana mendapatkan fungsi ini.  Tetapi pada kenyataannya, semuanya ternyata lebih sederhana: semua pesan harus dibungkus dengan pembungkus DU, karena kita sekarang mendapatkan 2 operasi pada aktor kita: mengirim pesan itu sendiri dan meminta keadaan saat ini.  Begini tampilannya: </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/     . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Mail&lt;_,_&gt;   ,  Post &amp; Get --  . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ F#       , /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   compare &amp; equals . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/         --   . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   [&lt;Struct&gt;] .       type Mail&lt;'msg, 'state&gt; = | Post of 'msg | Get of AsyncReplyChannel&lt;'state&gt;</span></span></code> </pre> <br><p>  Fungsi konstruktor kami sekarang terlihat seperti ini: </p><br><pre> <code class="hljs erlang-repl">let buildActor applyMessage zeroState = MailboxProcessor.Start(fun inbox -&gt; let rec loop state = async{ let! msg = inbox.Receive() //    ,     // .    -- ,     //     . //     --      //    .      ! match msg with | Post msg -&gt; let newState = applyMessage state msg return! loop newState | Get channel -&gt; channel.Reply state return! loop state } loop zeroState )</code> </pre><br><p>  Sekarang, untuk bekerja dengan kotak surat, kita perlu membungkus semua pesan kita di <code>Mail.Post</code> ini.  Agar tidak menulis ini setiap waktu, lebih baik membungkusnya dalam aplikasi kecil: </p><br><pre> <code class="hljs coffeescript"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span> Mailbox = let buildAgent applyMessage zeroState = MailboxProcessor.Start(fun inbox -&gt; let rec <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> state = async{ let! msg = inbox.Receive() match msg with | Post msg -&gt; let newState = applyMessage state msg <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> newState | Get channel -&gt; channel.Reply state <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> state } <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> zeroState ) let post (agent: MailboxProcessor&lt;_&gt;) msg = Post msg |&gt; agent.Post let getState (agent: MailboxProcessor&lt;_&gt;) = agent.PostAndReply Get let getStateAsync (agent: MailboxProcessor&lt;_&gt;) = agent.PostAndAsyncReply Get <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   Single Case Discriminated Union. <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> MailboxProcessor   API.      , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  -  ,  ,      <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   .       ,     <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>        . type MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'msg, '</span></span>state&gt; = MailAgent <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> address:string * mailbox:MailboxProcessor&lt;Mail&lt;<span class="hljs-string"><span class="hljs-string">'msg, '</span></span>state&gt;&gt; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     API with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Post msg = <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>            let (MailAgent (address,<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Mailbox.post <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> msg member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetState() = let (MailAgent (address,<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Mailbox.getState <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetStateAsync() = let (MailAgent (address,<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Mailbox.getStateAsync <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Address = let (MailAgent (address, _)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> address member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = let (MailAgent (_, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> (this:&gt;IDisposable).Dispose() interface IDisposable with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose()</code> </pre> <br><p>  Saya akan memberi tahu Anda <code>address:string</code> sedikit lebih lambat, tetapi untuk saat ini boilerplate kami sudah siap. </p><br><h4 id="sobstvenno-zmeyka">  Sebenarnya, ular itu </h4><br><p>  Dalam ular ada ular, pengguna dengan perintahnya, bidang dan transisi reguler ke bingkai berikutnya. <br>  Ini semua bersama-sama dan perlu diwarnai oleh aktor kita. <br>  Layout awal saya adalah sebagai berikut: </p><br><ul><li>  Aktor dengan penghitung waktu.  Menerima pesan mulai / hentikan / jeda.  Setiap n milidetik, mengirim pesan <code>Flush</code> ke aktor <code>Flush</code> .  Menyimpan <code>System.Timers.Timer</code> sebagai kondisi </li><li>  Tim aktor  Menerima pesan dari pengguna <code>Move Up/Down/Left/Right</code> , <code>AddPerk Speed/Attack</code> (ya, ular saya dapat dengan cepat merangkak dan menyerang penjahat) dan <code>Flush</code> dari timer.  Ini menyimpan daftar perintah sebagai keadaan, dan dengan flush daftar ini di-reset. </li><li>  Aktor itu adalah ular.  Ini menyimpan keadaan ular - tunjangan, panjang, arah, tikungan dan koordinat. <br>  Ia menerima daftar pesan dari aktor perintah, pesan <code>Tick</code> (untuk menggerakkan ular 1 sel ke depan), dan pesan <code>GrowUp</code> dari aktor lapangan ketika menemukan makanan. </li><li>  Aktor lapangan.  Ini menyimpan peta sel, mengambil keadaan ular dalam pesan dan menggambar koordinat pada gambar yang ada.  Ini juga mengirim <code>GrowUp</code> aktor ular dan perintah <code>Stop</code> ke timer jika permainan berakhir. </li></ul><br><p>  Seperti yang Anda lihat, bahkan dengan sejumlah kecil entitas, peta pesan sudah non-sepele.  Dan sudah pada tahap ini kesulitan muncul: faktanya adalah bahwa secara default F # tidak memungkinkan dependensi siklik.  Pada baris kode saat ini, Anda hanya dapat menggunakan kode yang ditulis di atas, dan hal yang sama berlaku untuk file dalam proyek.  Ini bukan bug, tapi fitur, dan saya sangat menyukainya, karena membantu menjaga kode tetap bersih, tetapi apa yang harus dilakukan ketika tautan siklik diperlukan oleh desain?  Tentu saja, Anda dapat menggunakan <code>rec namespace</code> - dan kemudian di dalam satu file Anda dapat merujuk semua yang ada di file ini, yang saya gunakan. <br>  Kode ini diperkirakan akan berantakan, tetapi sepertinya itu satu-satunya pilihan.  Dan itu berhasil. </p><br><h4 id="problema-vneshnego-mira">  Masalah dunia luar </h4><br><p>  Semuanya bekerja selama seluruh sistem aktor diisolasi dari dunia luar, dan saya hanya merusak dan menampilkan garis-garis di konsol.  Ketika tiba saatnya untuk mengimplementasikan dependensi dalam bentuk fungsi <code>updateUI</code> , yang seharusnya <code>updateUI</code> ulang untuk setiap centang, saya tidak bisa menyelesaikan masalah ini dalam implementasi saat ini.  Tidak jelek atau cantik - tidak mungkin.  Dan kemudian saya ingat akku - setelah semua, di sana Anda dapat menghasilkan aktor di sepanjang jalan, dan saya memiliki semua aktor saya dijelaskan pada tahap kompilasi. <br>  Solusinya jelas - gunakan akku!  Tidak, tentu saja, Akka masih berlebihan, tetapi saya memutuskan untuk menjilat poin-poin tertentu dari sana - yaitu, untuk menciptakan sistem aktor di mana Anda dapat secara dinamis menambahkan aktor baru dan permintaan aktor yang ada di alamat. <br>  Karena aktor sekarang ditambahkan dan dihapus dalam runtime, tetapi diperoleh dengan alamat daripada tautan langsung, Anda harus memberikan skenario di mana alamat terlihat di mana-mana dan aktor tidak ada di sana.  Mengikuti contoh acca yang sama, saya menambahkan sebuah kotak untuk surat mati, dan saya mendesainnya melalui DU favorit saya: </p><br><pre> <code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Agent&lt;_,_&gt; --  ,   ,     <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     ,      . <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      ,    --    Box (mailagent), <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,       ,   ,   , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       Deadbox.      MailAgent,  . <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>           . <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    --    . type Agent&lt;<span class="hljs-string"><span class="hljs-string">'message,'</span></span>state&gt; = | Box <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'message,'</span></span>state&gt; | DeadBox <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> string * MailAgent&lt;string * obj, Map&lt;string,obj list&gt;&gt; with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Post msg = match <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> with | Box box -&gt; box.Post msg | DeadBox (address, deadbox) -&gt; (address, box msg) |&gt; deadbox.Post interface IDisposable with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = match <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> with | Box agent -&gt; agent.Dispose() | DeadBox (_,agent) -&gt; agent.Dispose()</code> </pre> <br><p>  Dan sistem itu sendiri terlihat seperti ini: </p><br><pre> <code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    .     --    . type MailboxNetwork() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> = <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      .   ! [&lt;DefaultValue&gt;] val mutable agentRegister: ConcurrentDictionary&lt;string, obj&gt; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister &lt;- ConcurrentDictionary&lt;string, obj&gt;() <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    Map --     let deadLettersFn deadLetters (address:string, msg:obj) = printfn <span class="hljs-string"><span class="hljs-string">"Deadletter: %s-%A"</span></span> address msg match Map.tryFind address deadLetters with <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   | None -&gt; Map.add address [msg] deadLetters <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   --   | Some letters -&gt; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  --      Map.remove address deadLetters |&gt; Map.add address (msg::letters) let deadLettersAgent() = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"deadLetters"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Map.empty |&gt; Mailbox.buildAgent deadLettersFn)</span></span></span><span class="hljs-function"> |&gt; MailAgent member this.DeadLetters = deadLettersAgent</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> // -     ,      member this.Box&lt;'message,'state&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address)</span></span></span><span class="hljs-function"> = match this.agentRegister.TryGetValue address with | </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span><span class="hljs-function"><span class="hljs-params">, agent)</span></span></span><span class="hljs-function"> when </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(agent :? MailAgent&lt;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'message,'</span></span></span></span><span class="hljs-function"><span class="hljs-params">state&gt;)</span></span></span><span class="hljs-function"> -&gt;</span></span> <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,       ,   let agent = agent :?&gt; MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'message, '</span></span>state&gt; Box agent | _ -&gt; DeadBox (address, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DeadLetters) <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  --    member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.KillBox address = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister.TryRemove(address) |&gt; ignore member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.RespawnBox (agent: MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'a,'</span></span>b&gt;) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.KillBox agent.Address <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister.TryAdd (agent.Address, agent) |&gt; ignore interface IDisposable with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> agent <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister.Values <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> match agent with | :? IDisposable <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> agent -&gt; agent.Dispose() | _ -&gt; ()</code> </pre> <br><p>  Di sinilah <code>address:string</code> sama <code>address:string</code> , yang saya tulis di atas, berguna.  Dan lagi itu berhasil, ketergantungan eksternal sekarang mudah untuk mendapatkan di mana Anda perlu.  Fungsi konstruktor aktor sekarang menerima sistem aktor sebagai argumen dan mendapatkan alamat yang diperlukan dari sana: </p><br><pre> <code class="hljs haskell"> //    - (  )   - <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Command</span></span> list, <span class="hljs-type"><span class="hljs-type">GameState</span></span>&gt;(gameAddress) //    message loop           <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) commands msg = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent = gameAgent mailboxNetwork match msg with | <span class="hljs-type"><span class="hljs-type">Cmd</span></span> cmd -&gt; cmd::commands | <span class="hljs-type"><span class="hljs-type">Flush</span></span> -&gt; commands |&gt; gameAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> []</code> </pre><br><h4 id="medlenno">  Perlahan </h4><br><p>  Untuk alasan yang jelas, selama debugging, saya menyetel game ke kecepatan rendah: penundaan antara kutu lebih dari 500 milidetik.  Jika Anda mengurangi penundaan menjadi 200, maka pesan mulai datang terlambat, dan tim dari pengguna bekerja dengan penundaan, yang merusak seluruh permainan.  Lalat tambahan di salep adalah fakta bahwa timer menerima perintah berhenti jika kehilangan beberapa kali.  Untuk pengguna, ini tidak muncul dengan cara apa pun, tetapi bagaimanapun, ada beberapa jenis bug. <br>  Kebenaran yang tidak menyenangkan adalah bahwa para aktor, tentu saja, hebat, tetapi panggilan metode langsung jauh lebih cepat.  Oleh karena itu, terlepas dari kenyataan bahwa menyimpan ular itu sendiri di aktor yang terpisah terasa nyaman dari sudut pandang pengorganisasian kode, saya harus meninggalkan ide ini atas nama kecepatan, karena untuk 1 jam permainan pengiriman pesannya terlalu intens: </p><br><ol><li>  Pengguna mengirimkan sejumlah perintah langsung ke aktor perintah. </li><li>  Timer mengirimkan tanda centang ke aktor tim dan, dalam implementasi awal, juga ke aktor ular sehingga ia memindahkan ular ke sel berikutnya </li><li>  Aktor perintah mengirim daftar perintah untuk ular ketika pesan terkait berasal dari timer. </li><li>  Aktor ular, setelah memperbarui kondisinya sesuai dengan 2 pesan teratas, mengirim negara ke aktor lapangan. </li><li>  Aktor lapangan menggambar semuanya.  Jika ular menemukan makanan, maka ia mengirim pesan <code>GrowUp</code> ke aktor ular, setelah itu ia mengirim negara baru kembali ke aktor lapangan. </li></ol><br><p>  Dan untuk semua ini ada 1 siklus jam, yang tidak cukup, dengan mempertimbangkan sinkronisasi akun di bagian dalam <code>MailboxProcessor</code> .  Selain itu, dalam implementasi saat ini, timer mengirim pesan berikutnya setiap n milidetik, terlepas dari apa pun, jadi jika kita tidak masuk ke pengukuran 1 kali, pesan mulai menumpuk, dan situasinya memburuk.  Akan jauh lebih baik untuk "meregangkan" ukuran khusus ini, memproses semua yang telah menumpuk, dan melanjutkan. </p><br><h4 id="finalnaya-versiya">  Versi final </h4><br><p>  Jelas, skema pesan perlu disederhanakan, sementara sangat diinginkan untuk meninggalkan kode sesederhana dan dapat diakses mungkin - relatif berbicara, saya tidak ingin mendorong semuanya menjadi 1 aktor dewa, dan kemudian tidak ada banyak akal di aktor. <br>  Oleh karena itu, melihat daftar aktor saya, saya menyadari bahwa yang terbaik adalah mengorbankan aktor ular terlebih dahulu.  Pengatur waktu diperlukan, buffer perintah pengguna juga diperlukan untuk mengakumulasikannya secara real time, tetapi tuangkan hanya sekali per ketukan, dan tidak ada kebutuhan obyektif untuk menyimpan ular di aktor yang terpisah, ini dilakukan hanya untuk kenyamanan.  Selain itu, dengan memegangnya dengan aktor lapangan akan dimungkinkan untuk memproses skrip <code>GrowUp</code> tanpa penundaan.  <code>Tick</code> pesan untuk ular juga tidak masuk akal, karena ketika kita mendapatkan pesan dari aktor tim, itu berarti ketukan baru telah terjadi.  Menambahkan ini peregangan beat jika terjadi penundaan, kami memiliki perubahan berikut: </p><br><ol><li>  Kami menghapus pesan <code>Tick</code> &amp; <code>GrowUp</code> . </li><li>  Kami memegang aktor ular ke aktor lapangan - dia sekarang akan menyimpan "tapla" dari negara-negara ini. </li><li>  Kami menghapus <code>System.Timers.Timer</code> dari aktor penghitung waktu.  Alih-alih, skema kerjanya adalah sebagai berikut: ketika ia menerima perintah <code>Start</code> , ia mengirimkan <code>Flush</code> aktor tim.  Dia mengirim daftar perintah ke bidang + aktor ular, aktor terakhir memproses semua ini dan mengirim pesan <code>Next</code> ke timer, sehingga meminta centang baru darinya.  Timer, setelah menerima <code>Next</code> menunggu <code>Thread.Sleep(delay)</code> dan memulai seluruh lingkaran lagi.  Semuanya sederhana. </li></ol><br><p>  Untuk meringkas. </p><br><ul><li>  Dalam implementasi sebelumnya, 500 ms adalah penundaan minimum yang diijinkan.  Dalam penundaan saat ini, Anda dapat menghapusnya sama sekali - aktor lapangan akan membutuhkan ketukan baru saat siap.  Mengumpulkan pesan mentah dari tindakan sebelumnya tidak lagi memungkinkan. </li><li>  Peta olahpesan sangat disederhanakan - alih-alih grafik yang kompleks, kami memiliki loop paling sederhana. </li><li>  Penyederhanaan ini menyelesaikan bug ketika penghitung waktu <code>Stop</code> beberapa kali jika hilang. </li><li>  Daftar pesan telah dikurangi.  Lebih sedikit kode - lebih sedikit kejahatan! </li></ul><br><p>  Ini terlihat seperti ini: </p><br><pre> <code class="hljs haskell"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> [&lt;<span class="hljs-type"><span class="hljs-type">Literal</span></span>&gt;] commandAddress = <span class="hljs-string"><span class="hljs-string">"command"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> [&lt;<span class="hljs-type"><span class="hljs-type">Literal</span></span>&gt;] timerAddress = <span class="hljs-string"><span class="hljs-string">"timer"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> [&lt;<span class="hljs-type"><span class="hljs-type">Literal</span></span>&gt;] gameAddress = <span class="hljs-string"><span class="hljs-string">"game"</span></span> // -     <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">CommandMessage</span></span>, <span class="hljs-type"><span class="hljs-type">Command</span></span> list&gt;(commandAddress) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> timerAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">TimerCommand</span></span>, <span class="hljs-type"><span class="hljs-type">TimerState</span></span>&gt;(timerAddress) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Command</span></span> list, <span class="hljs-type"><span class="hljs-type">GameState</span></span>&gt;(gameAddress) // message loop   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) updateUi gameState cmd = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> timerAgent = timerAgent mailboxNetwork //    match gameState.gameFrame with //     | <span class="hljs-type"><span class="hljs-type">Frame</span></span> field -&gt; //       <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameState = <span class="hljs-type"><span class="hljs-type">Game</span></span>.updateGameState gameState cmd timerAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Next</span></span> //    updateUi gameState //     gameState // ! | <span class="hljs-type"><span class="hljs-type">End</span></span> (<span class="hljs-type"><span class="hljs-type">Win</span></span> _) -&gt; timerAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">PauseOrResume</span></span> <span class="hljs-type"><span class="hljs-type">Game</span></span>.updateGameState gameState cmd //        | _ -&gt; timerAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Stop</span></span> //     gameState // message loop   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) commands msg = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent = gameAgent mailboxNetwork match msg with | <span class="hljs-type"><span class="hljs-type">Cmd</span></span> cmd -&gt; cmd::commands //       | <span class="hljs-type"><span class="hljs-type">Flush</span></span> -&gt; commands |&gt; gameAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> //     [] // message loop   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> timerAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) (state: <span class="hljs-type"><span class="hljs-type">TimerState</span></span>) cmd = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgent = commandAgent mailboxNetwork match cmd with | <span class="hljs-type"><span class="hljs-type">Start</span></span> -&gt; commandAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Flush</span></span>; {state with active = true} | <span class="hljs-type"><span class="hljs-type">Next</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> state.active <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> //    ,     <span class="hljs-type"><span class="hljs-type">Threading</span></span>.<span class="hljs-type"><span class="hljs-type">Thread</span></span>.<span class="hljs-type"><span class="hljs-type">Sleep</span></span>(state.delay) commandAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Flush</span></span>; state | <span class="hljs-type"><span class="hljs-type">Stop</span></span> -&gt; printfn <span class="hljs-string"><span class="hljs-string">"Stop received"</span></span>; { state with active = false } | <span class="hljs-type"><span class="hljs-type">PauseOrResume</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> not state.active <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> //     <span class="hljs-comment"><span class="hljs-comment">--   commandAgent.Post Flush { state with active = not state.active } | SetDelay delay -&gt; Threading.Thread.Sleep(delay) if state.active then commandAgent.Post Flush {state with delay = delay}</span></span></code> </pre> <br><h4 id="ssylki">  Referensi </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Pengantar Kotak Surat</a> </li><li>  <a href="">Sumber kotak surat untuk yang paling penasaran</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kode sumber untuk model aktor</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id424861/">https://habr.com/ru/post/id424861/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id424851/index.html">Apa yang salah dengan mempekerjakan IT?</a></li>
<li><a href="../id424853/index.html">Kisah one view controller yang ingin pamer dengan baik</a></li>
<li><a href="../id424855/index.html">Machine Learning: Berebutlah dengan Kamar Gajah</a></li>
<li><a href="../id424857/index.html">CloudFlare Mengimplementasikan Dukungan SNI Terenkripsi</a></li>
<li><a href="../id424859/index.html">Gim Arduino yang paling sederhana dengan layar 1602 - Bagian # 1</a></li>
<li><a href="../id424865/index.html">Partikel Desain Dasar Ditemukan</a></li>
<li><a href="../id424867/index.html">Pengembangan hexapod dari awal (bagian 1) - desain</a></li>
<li><a href="../id424869/index.html">Bagaimana fitur iOS 12 yang baru mengingatkan saya bahwa sudah waktunya untuk sembuh</a></li>
<li><a href="../id424871/index.html">Elon Musk dan Tesla menyelesaikan litigasi dengan Komisi Sekuritas dan Bursa AS</a></li>
<li><a href="../id424873/index.html">Perangkap HttpClient di .NET</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>