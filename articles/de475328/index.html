<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úãüèª üíÖüèª üôèüèΩ Operation TA505, vierter Teil. Zwillinge üî° üëêüèø üë©üèª‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wir sprechen weiterhin √ºber die Aktivit√§ten der Hacker-Gruppe TA505. Der bekannte Satz ‚ÄûDas Neue ist das Vergessene Alte‚Äú eignet sich am besten als In...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Operation TA505, vierter Teil. Zwillinge</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/475328/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/79/gv/mv/79gvmv2kznpjzybycyw7scp5zus.jpeg"></a> <br><br>  Wir sprechen weiterhin √ºber die Aktivit√§ten der Hacker-Gruppe TA505.  Der bekannte Satz ‚ÄûDas Neue ist das Vergessene Alte‚Äú eignet sich am besten als Inschrift f√ºr das n√§chste Kapitel der Geschichte √ºber die Gruppe TA505.  Diesmal ist das "Alte" zwar nicht so sehr "vergessen", sondern es wurde √ºberarbeitet und verbessert. <br><br>  Anfang September entdeckten wir mehrere b√∂swillige Downloader, die mit dem speziellen PE-Packer der Gruppe gepackt waren, √ºber die wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zuvor geschrieben haben</a> .  Auf den ersten Blick sahen sie aus wie die bekannten Backdoor-Stager von FlawedAmmyy.  Eine tiefere Analyse ergab jedoch, dass dies nicht der Fall ist.  Nicht die fortschrittlichsten Techniken zum Schreiben von Code haben uns zu radikal entgegengesetzten Nutzlasten in Bezug auf die Ausf√ºhrungsqualit√§t gef√ºhrt. <br><br>  In diesem Artikel werden wir uns die gefundenen Werkzeuge genauer ansehen und Parallelen zu dem zeichnen, was bereits bekannt ist. <a name="habracut"></a><br><br><h2>  Bootloader Twein </h2><br>  Zuallererst ist Folgendes merkw√ºrdig: Von den Bootloader-Beispielen, die wir gesammelt haben, hat nur eines eine digitale Signatur: <br><br><img src="https://habrastorage.org/webt/im/iu/-a/imiu-af4otgk3nhalsj7mhe3hwy.jpeg"><br><br>  <i>Abb.</i>  <i>1. Digitale Signatur des Bootloaders</i> <br><br>  Zertifikat ausgestellt auf den Namen von PEAR SOLUTIONS LTD.  √úbrigens ist es nicht das erste Mal, dass eine Gruppe ihre Tools signiert und sie als legitime Software fiktiver Organisationen weitergibt.  Im Folgenden sind einige andere Namen aufgef√ºhrt, die den TA505 f√ºr andere Malware-Familien verwendet haben: <br><br><ul><li>  ET HOMES LTD, </li><li>  FIT UND FLEX LIMITED, </li><li>  MISHA LONDON LTD, </li><li>  SATOJI KAIDA MB, </li><li>  SEHR TELE BEGRENZT. </li></ul><br>  Da sich die erkannten Bootloader nicht voneinander unterscheiden, w√§hlen wir den oben genannten signierten aus und gehen n√§her darauf ein. <br><br>  W√§hrend der Arbeit mit Malware wird fast jede Aktion durch Schreiben in die Protokolldatei und Debug-Ausgabe von allem, was passiert, begleitet: <br><br><img src="https://habrastorage.org/webt/dm/7f/1j/dm7f1jjwkhlfkj8k987uvp8ixjw.jpeg"><br><br>  <i>Abb.</i>  <i>2. Debuggen Sie die Ausgabe und Protokollierung</i> <br><br>  Eine solche Nachverfolgung vereinfacht nicht nur die statische Analyse der Datei, sondern hilft auch dabei, herauszufinden, was in dynamischen Analysesystemen falsch ist: <br><br><img src="https://habrastorage.org/webt/d4/g1/kg/d4g1kgeiovdgo-ecz3ytg5ki26c.jpeg"><br><br>  <i>Abb.</i>  <i>3. Debuggen Sie die Ausgabe im ANY.RUN Online Analyzer</i> <br><br>  Troyan √ºberpr√ºft das Sprachlayout der Tastatur - und funktioniert in Russland und den Nachbarl√§ndern nicht: <br><br><img src="https://habrastorage.org/webt/bz/hr/my/bzhrmynjo9dlc50xi_nucjdpuf4.jpeg"><br><br>  <i>Abb.</i>  <i>4. √úberpr√ºfen Sie das Sprachlayout der Tastatur</i> <br>  Anschlie√üend wird der Mutex <code>Global\system32_mutant_service</code> und die Internetverf√ºgbarkeit mithilfe einer HTTP-GET-Anforderung an google.com √ºberpr√ºft.  Danach bestimmt es die Art des Zugriffs auf das Netzwerk (eine dedizierte Adresse oder <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">NAT</a> ), indem es die externe IP-Adresse durch die Dienste myexternalip.com, ipecho.net und ifconfig.me ermittelt und den empfangenen Wert mit den in den Netzwerkparametern des Systems angegebenen Werten vergleicht: <br><br><img src="https://habrastorage.org/webt/ld/80/7w/ld807wry4cgdc1qzj3mwjogabf8.jpeg"><br><br>  <i>Abb.</i>  <i>5. Vergleich von internen und externen IP-Adressen</i> <br><br>  Anschlie√üend ermittelt die Malware die Version der Bibliothek <code>%SystemRoot%\system32\crypt32.dll</code> . Wenn die Build-Nummer und die Versionsnummer kleiner als <code>7601</code> bzw. <code>18741</code> wird das Update <code>KB3033929</code> entsprechend der Betriebssystemversion heruntergeladen und installiert: <br><br><img src="https://habrastorage.org/webt/su/zu/ig/suzuighncp_psgtfbtnbvcdbb1y.jpeg"><br><br>  <i>Abb.</i>  <i>6. Laden Sie Systemupdates herunter und installieren Sie sie</i> <br><br>  TA505-Angreifer k√ºmmern sich um das Opfer und patchen das System nach Bedarf?  Gar nicht.  Die Installation des Updates ist mit der Beendigung der Unterst√ºtzung f√ºr Codesicherheitszertifikate, die mit SHA-1 signiert wurden, und der Aufgabe des Updates zugunsten des SHA-2-Algorithmus verbunden.  Wahrscheinlich hatten Hacker bereits Schwierigkeiten, signierte Payloads auf nicht aktualisierten Systemen auszuf√ºhren.  Interessanterweise sendet der Trojaner nach der Installation des Updates das generierte Aktionsprotokoll an den Verwaltungsserver, beendet seine Arbeit und l√∂scht sich selbst, wobei die verbleibenden Spuren gel√∂scht werden. <br><br><img src="https://habrastorage.org/webt/k6/jk/-y/k6jk-yijoanmpjtwath42fioh10.jpeg"><br><br>  <i>Abb.</i>  <i>7. Fahren Sie das System nach der Installation eines Systemupdates herunter</i> <br><br>  Wenn die Update-Installation nicht erforderlich ist, erfasst der Bootloader die folgenden Informationen und sendet sie an den Verwaltungsserver: <br><br><ul><li>  Systeminformationen </li><li>  Informationen zu installierter Software, </li><li>  Informationen zu signierter Software in den Verzeichnissen% ProgramFiles% und% ProgramFiles (x86)% (falls vorhanden), </li><li>  Informationen zu signierten Treibern im Verzeichnis% SystemRoot% \ drivers. </li></ul><br>  Beachten Sie, dass ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">legitimer Code</a> verwendet wurde, um Informationen zu Signaturen abzurufen. <br><br><img src="https://habrastorage.org/webt/z4/1o/p_/z41op_q3q8pzlli3zlapjreaxd0.jpeg"><br><br>  <i>Abb.</i>  <i>8. Abrufen von Zertifikatinformationen</i> <br><br>  Danach erstellt der Bootloader das Verzeichnis <code>C:\Windows\Logs\diag</code> und startet einen Thread, in dem er √Ñnderungen im Verzeichnis <code>C:\Windows\Logs\diag</code> und Benachrichtigungen an den Verwaltungsserver sendet: <br><br><img src="https://habrastorage.org/webt/ra/rh/-g/rarh-gd4x8yafwiipdft7r9duiq.jpeg"><br><br>  <i>Abb.</i>  <i>9. Verzeichnis√§nderungen √ºberwachen</i> <br><br>  Anschlie√üend werden vorhandene und fehlende Informationen zum System (Benutzername, Systemversion, Dom√§ne, IP-Adresse, Grafikkarteninformationen, Netzwerkverbindung - NAT oder nicht NAT) aufbereitet und eine JSON-Datei dieses Typs generiert: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"adm"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bid"</span></span>: <span class="hljs-string"><span class="hljs-string">"M3xwwhqLH/AUOhmU2+W55A=="</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bit"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bnet"</span></span>: <span class="hljs-string"><span class="hljs-string">"ldr"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cam"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cis"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dmn"</span></span>: <span class="hljs-string"><span class="hljs-string">"WORKGROUP"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hash_r"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lip"</span></span>: <span class="hljs-string"><span class="hljs-string">"192.168.100.153"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lvl"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nat"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"osb"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"osv"</span></span>: <span class="hljs-string"><span class="hljs-string">"Windows 7 Professional"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pc"</span></span>: <span class="hljs-string"><span class="hljs-string">"USER-PC"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proc_c"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proc_n"</span></span>: <span class="hljs-string"><span class="hljs-string">"cpu"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"rep"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmt"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ver"</span></span>: <span class="hljs-string"><span class="hljs-string">"163"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"video"</span></span>: <span class="hljs-string"><span class="hljs-string">"Standard VGA Graphics Adapter,"</span></span> }</code> </pre> <br>  Diese Daten werden sp√§ter mit RC4 verschl√ºsselt (der Verschl√ºsselungsschl√ºssel <code>gJypA9RWUlYpnBbzujVqE6fDcEAk0zoz</code> wird im <code>gJypA9RWUlYpnBbzujVqE6fDcEAk0zoz</code> des Trojaners verschl√ºsselt), mit Base64 verschl√ºsselt und durch eine HTTP-POST-Anforderung an den Verwaltungsserver gesendet: <br><br><img src="https://habrastorage.org/webt/wu/4p/x8/wu4px8dxpkvy5mshywjkrskevlm.jpeg"><br><br>  <i>Abb.</i>  <i>10. HTTP-POST-Anforderung an den Verwaltungsserver</i> <br><br><img src="https://habrastorage.org/webt/uv/lw/bg/uvlwbgwcx0ejyfndmzdybhtqrsy.jpeg"><br><br>  <i>Abb.</i>  <i>11. Die Liste der Steuerungsserver im Bootloader</i> <br><br>  Die Antwort vom Server wird von RC4 entschl√ºsselt (der Verschl√ºsselungsschl√ºssel ist der gleiche wie der zum Senden der Daten verwendete) und √ºberpr√ºft: Die ersten beiden Bytes m√ºssen der MZ-Zeile entsprechen, die ein Zeichen der PE-Datei ist.  Wir haben diese Sequenz bereits fr√ºher getroffen, als wir einen anderen Group Loader analysierten, der FlawedAmmyy RAT lieferte: <br><br><img src="https://habrastorage.org/webt/pb/oe/hi/pboehibfeoivvna7bl6xkumibuo.jpeg"><br><br>  <i>Abb.</i>  <i>12. Ein √§hnlicher Code zum Entschl√ºsseln und √úberpr√ºfen der heruntergeladenen Datei f√ºr den betreffenden Bootloader (links) und den FlawedAmmyy RAT-Bootloader (rechts)</i> <br><br>  Das Laden von Nutzdaten erfolgt nicht nur im Haupt-Thread, sondern auch in einem separat erstellten.  Mit anderen Worten, es gibt zwei Nutzlasten.  In einem Fall wird der Mutex "Global \ system32_host_service" vorab √ºberpr√ºft, und wenn er nicht vorhanden ist, wird die Komponente geladen, die in den Debuginformationen als Nutzdaten oder Bot bezeichnet wird.  Interessanterweise wird die PE-Datei nach dem Empfang einer Antwort vom Server in keiner Weise gestartet.  Stattdessen wird sein K√∂rper in die Registrierung im Abschnitt <code>HKEY_LOCAL_MACHINE\SYSTEM</code> im Schl√ºssel <code>0x228028</code> .  Anschlie√üend deaktiviert der Bootloader die Umleitung des WoW64-Dateisystems f√ºr 32-Bit-Anwendungen mithilfe von <code>Wow64DisableWow64FsRedirection</code> und startet den Prozess <code>%SystemRoot%\System32\services.exe</code> mit dem Parameter -ww.  Die Verwendung dieses Parameters ist nicht sinnvoll, schlie√üt jedoch die Installationskette der resultierenden Nutzdaten ab. <br><br><img src="https://habrastorage.org/webt/bn/eb/w1/bnebw1pcir-t8io211poejmlzbe.jpeg"><br><br>  <i>Abb.</i>  <i>13. Einstellen der Nutzlast</i> <br><br>  Wir werden sp√§ter √ºber die zweite Nutzlast sprechen. <br><br><h2>  Twein Plugins </h2><br>  Bei der Untersuchung des oben beschriebenen Trojaners haben wir eine Funktion festgestellt, mit der zwei Dateien aus dem Verzeichnis <code>%SystemRoot%</code> - <code>twein_32.dll</code> und <code>twein_64.dll</code> : <br><br><img src="https://habrastorage.org/webt/hk/v2/ht/hkv2ht9lipkhgz-ydz622exxzds.jpeg"><br><br>  <i>Abb.</i>  <i>14. Entfernen der Dateien twein_32.dll und twein_64.dll</i> <br><br>  Diese Dateien werden nirgendwo anders gefunden und erscheinen nicht in der Logik des Bootloaders.  Die Namen der Bibliotheken erinnerten uns jedoch an eine andere Gruppe von Malware, die wir nun betrachten werden. <br>  Zwei Monate zuvor haben wir einen TA505-Trojaner entdeckt, der ungef√§hr 9 MB gro√ü ist.  Die Datei wird von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">UPX gepackt</a> .  Der Trojaner wird als <code>WMDICToss</code> Dienst im System installiert.  Die Ressourcen enthalten drei Dateien: <code>systemdiron.bat</code> , <code>twein__32.dll</code> und <code>twein__64.dll</code> , die mit linearem XOR verschl√ºsselt sind. <br><br><img src="https://habrastorage.org/webt/tj/op/xh/tjopxhpvsrbmlstkvm2fidukk7w.jpeg"><br><br>  <i>Abb.</i>  <i>15. Entschl√ºsselung einer der Ressourcen der Pipette</i> <br><br>  Beachten Sie, dass die Namen der beiden Dateien fast mit denen √ºbereinstimmen, die bereits erw√§hnt wurden: Der Unterschied besteht nur in der Anzahl der Unterstriche. <br><br>  Bei einer der entschl√ºsselten Ressourcen mit dem Namen <code>systemdiron.bat</code> voraussichtlich um ein Befehlsskript, mit dem abh√§ngig von der Systemkapazit√§t andere Komponenten gestartet werden k√∂nnen: <br><br><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> defined PROCESSOR_ARCHITEW6432 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==IA64 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==AMD64 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==x86 (goto LABEL_X86) goto LABEL_NON :LABEL_X64 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: x64 copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__64.dll,Install copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__32.dll,Install del c:\temp\tmp.log del c:\i.txt shutdown.exe -r -t 00 goto LABEL_END :LABEL_X86 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: x86 copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__32.dll,Install del c:\temp\tmp.log del c:\i.txt shutdown.exe -r -t 00 goto LABEL_END :LABEL_NON <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: undefined goto LABEL_END :LABEL_END pause</code> </pre> <br>  Beide Zwillingsbibliotheken verhalten sich √§hnlich.  Verpackt mit dem charakteristischen Packer der Gruppe TA505.  Urspr√ºngliche Bibliotheksnamen: <code>av_block.dll</code> .  Die Analyse wird durch die Verwendung eines Verschleierungsmittels erheblich erschwert, und der Anteil des verschleierten Codes betr√§gt etwa 80%.  Infolgedessen ist die Programmausf√ºhrung mit zahlreichen √úberg√§ngen, dem Decodieren der n√§chsten Codeschritte und nichtlinearen Funktionsaufrufen ges√§ttigt. <br><br>  Bibliotheken enthalten eine beeindruckende Liste von Base64-√§hnlichen Zeichenfolgen, die wie folgt entschl√ºsselt werden: <br><br>  1. Die Eingabezeichenfolge ist in 4-Byte-Bl√∂cke unterteilt. <br>  2. Jeder Block wird mit dem Ersetzungs- und Verschiebungsalgorithmus decodiert: <br><br><pre> <code class="bash hljs">import binascii def block_decode(input_str, len_of_block): alphabet = <span class="hljs-string"><span class="hljs-string">'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3E\x00\x00\x00\x3F\x34\x35\x36\x37\x38\x39\x3A\x3B\x3C\x3D\x00\x00\x00\x00\x00\x00\x00\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x00\x00\x00\x00\x00\x00\x1A\x1B\x1C\x1D\x1E\x1F\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2A\x2B\x2C\x2D\x2E\x2F\x30\x31\x32\x33\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'</span></span> int_result = 0 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len_of_block): alph = ord(alphabet[ord(input_str[i])]) alph &lt;&lt;= 0x6 * i int_result += alph str_result = hex(int_result)[2:] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(str_result) % 2 != 0: str_result = <span class="hljs-string"><span class="hljs-string">'0'</span></span> + str_result <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> binascii.unhexlify(str_result).decode(<span class="hljs-string"><span class="hljs-string">'latin1'</span></span>)[::-1]</code> </pre> <br><br>  3) Bl√∂cke werden in einer einzigen Zeile gesammelt; <br>  4) Das Ergebnis wird vom <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eexec-</a> Algorithmus mit einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Doppelbyte</a> -Schl√ºssel entschl√ºsselt, der als Parameter √ºbergeben wird: <br><br><img src="https://habrastorage.org/webt/qs/mj/ah/qsmjah4gzyqwizgrothw1hlbkdc.jpeg"><br><br>  <i>Abb.</i>  <i>16. Implementierung des eexec-Algorithmus</i> <br><br>  Bei den meisten Zeilen handelt es sich um die Namen und Pfade der Dateien von Antivirenprodukten. Einige geh√∂ren jedoch √ºberhaupt nicht zu den Sicherheitstools: MS Exchange Server, MySQL Server, SAP, Apache, PostgreSQL, Elasticsearch usw. Es gab sogar solche eindeutigen Pfade: <br><br><ul><li>  C: \ Benutzer \ tislam \ Desktop \ salik app \ Aye_salik_data \ Aye_salik_data \ bin \ Debug \ Aye_salik_data.exe </li><li>  C: \ oem13c \ agent13c \ agent_13.2.0.0.0 \ perl \ bin \ perl.exe </li><li>  C: \ Users \ adadmin \ Ubiquiti UniFi \ bin \ mongod.exe </li><li>  C: \ Benutzer \ sakella \ AppData \ Local \ Microsoft \ OneDrive \ OneDrive.exe </li><li>  D: \ Add-ons \ IMI_CREDIT_POLICY Test v 02.01 \ IMI_CREDIT_POLICY.exe </li></ul><br>  Wenn in der Liste Software im System gefunden wird, werden Dateien und Verzeichnisse gel√∂scht. <br><br>  Um sich im System abzusichern, legen die Bibliotheken sich selbst als SPI-Schnittstelle ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Windows Sockets</a> Service Provider) fest, die als Intel und IntelFiltr bezeichnet wird.  Dar√ºber hinaus √§ndern sie die Reihenfolge der Handler in der Protokollkette, um das erste SPI zu sein, das die Clientanforderung verarbeitet. <br><br>  Im Jahr 2015 haben unsere FireEye-Kollegen die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">LatentBot-</a> Bot- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Analyse eingef√ºhrt</a> .  Es ist merkw√ºrdig, dass der String-Verschl√ºsselungsalgorithmus in LatentBot und den untersuchten Twein-Bibliotheken v√∂llig identisch ist.  Dar√ºber hinaus verwendet LatentBot ein Sicherheitsmodul als eines der Plug-Ins, das anhand der angegebenen Pfade und Produktnamen nach Sicherheitstools im System sucht, wobei jedoch nur die Verf√ºgbarkeit √ºberpr√ºft wird. <br><br><h2>  Rootkit-Twein </h2><br>  Zur√ºck zum Bootloader, n√§mlich der zweiten Payload.  Aus den Debug-Zeilen von try to open rootkit ... und Driver% S k√∂nnen Sie leicht das Format der n√§chsten Payload erraten.  Nach dem erfolgreichen Laden wird der Treiber in das Verzeichnis <code>%SystemRoot%\System32\drivers</code> geschrieben, wobei der Name pseudozuf√§llig aus den Namen anderer legitimer Dateien gebildet wird.  Dann wird der Dienst erstellt und gestartet: <br><br><img src="https://habrastorage.org/webt/hw/dp/vi/hwdpvipfgx2-rra5iqecj2o5t8w.jpeg"><br><br>  <i>Abb.</i>  <i>17. Installieren und Starten des Dienstes</i> <br><br>  In der letzten Phase seiner Arbeit konfiguriert der Loader den Treiber so, dass er in Registrierungsschl√ºsseln auf die schwarze Liste gesetzt wird: Die Namen der Antiviren-Prozesse, Analysetools und Schutzanbieter in digitalen Dateisignaturen werden in die angegebenen numerischen Werte der Schl√ºssel des Zweigs <code>HKEY_LOCAL_MACHINE\SYSTEM</code> eingegeben: <br><br><img src="https://habrastorage.org/webt/u2/fw/zj/u2fwzjlb_hjgmabjwa4filz9fn4.jpeg"><br><br>  <i>Abb.</i>  <i>18. Treiberkonfiguration auf der schwarzen Liste</i> <br><br>  Bei der Untersuchung des Bootloaders konnte kein Treiberbeispiel vom Verwaltungsserver abgerufen werden.  Wir fanden jedoch <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Erw√§hnung eines Rootkits</a> , das von einem anderen √§hnlichen Bootloader gepumpt wurde. <br><br>  Der Fahrer ist im Namen von <code>Lizas Limited</code> mit der E-Mail- <code>Lizas Limited</code> <code>administrator@lizaslimited.site</code> digital signiert: <br><br><img src="https://habrastorage.org/webt/o_/tm/yy/o_tmyyrx3dayywf-jnfkoijecvm.jpeg"><br><br>  <i>Abb.</i>  <i>19. Digital signierter Treiber</i> <br><br>  W√§hrend der Recherche haben wir viele <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gemeinsamkeiten</a> mit dem bekannten Rootkit des Necurs-Botnetzes festgestellt, das von der TA505-Gruppe aktiv zum Versenden von Spam und zur Verbreitung von Malware verwendet wurde.  Lassen Sie uns die interessantesten Merkmale seiner Arbeit genauer betrachten. <br><br>  Der Treiber registriert Ereignishandler zum Starten von Prozessen und Laden von PE-Images mithilfe von <code>PsSetCreateProcessNotifyRoutine</code> und <code>PsSetLoadImageNotifyRoutine</code> .  Mit anderen Worten, dies erm√∂glicht es dem Fahrer, den Start aller neuen Prozesse und Dienste zu steuern.  Unter Verwendung der zuvor erw√§hnten Blacklists beendet das Rootkit unerw√ºnschte Prozesse mit ZwTerminateProcess und verhindert, dass andere potenziell gef√§hrliche Treiber geladen werden. Dabei wird der Einstiegspunktwert in den Anweisungen √ºberschrieben: <br><br><pre> <code class="bash hljs">mov eax, 0C0000001 retn 8</code> </pre> <br>  Infolgedessen wird der Dienst mit dem Fehler <code>STATUS_UNSUCCESSFULL</code> entladen. <br><br><img src="https://habrastorage.org/webt/td/l7/ea/tdl7ea03jvxszqftk9rks9wqgqc.jpeg"><br><br>  <i>Abb.</i>  <i>20. Prozessabschluss</i> <br><br><img src="https://habrastorage.org/webt/va/6k/bb/va6kbbjuepdp1x99ktenowebmc0.jpeg"><br><br>  <i>Abb.</i>  <i>21. Treiber-Einstiegspunkte √ºberschreiben</i> <br><br>  Mit CmRegisterCallback f√§ngt der Treiber Zugriffsereignisse auf die Systemregistrierung ab.  Insbesondere wird seine weitere Arbeit durch die numerischen Werte der Tasten parametrisiert, auf die bei abgefangenen Ereignissen zugegriffen wird. <br><br><img src="https://habrastorage.org/webt/af/ka/b6/afkab6erynqiphtoyzztal2wjq8.jpeg"><br><br>  <i>Abb.</i>  <i>22. Rootkit-Verwaltung von Registrierungsschl√ºsselzugriffen</i> <br><br>  Interessanterweise wurden in einigen Versionen des Necurs-Rootkits dieselben numerischen Werte wie bei ioctl-Anforderungscodes verwendet. <br><br><img src="https://habrastorage.org/webt/nn/vx/rh/nnvxrhxmoftlziclt9dgak73ydk.jpeg"><br><br>  <i>Abb.</i>  <i>23. Verwalten eines Necurs-Rootkits mit ioctl-Abfragen</i> <br><br>  Dieser Trick kann als ein Schritt in Richtung gr√∂√üerer Geheimhaltung angesehen werden: Der Zugriff auf die Registrierung verursacht weniger Verdacht als ioctl-Anforderungen an DeviceObject. <br><br>  Der Hauptteil des Rootkits enth√§lt eine mit Single-Byte-XOR verschl√ºsselte DLL-Hilfsbibliothek.  Beim Erstellen eines neuen Prozesses f√ºgt der Treiber die Bibliothek zusammen mit einer anderen PE-Datei ein, die aus der Registrierung extrahiert und erneut mit einem Einzelbyte-XOR entschl√ºsselt wird. <br><br><img src="https://habrastorage.org/webt/nu/ze/03/nuze03jkif4-7sl9mux_j8_roz8.jpeg"><br><br>  <i>Abb.</i>  <i>24. Entschl√ºsselung und Einf√ºgung der Hilfsbibliothek in den erstellten Prozess</i> <br><br>  Bei der Hilfskomponente handelt es sich um einen benutzerdefinierten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Reflective Loader</a> , der die zweite PE-Datei korrekt im Speicher ablegt, der als Nutzlast fungiert, und die Steuerung darauf √ºbertr√§gt.  Jetzt wird klar, wie genau die Payload funktioniert, die vom Bootloader aus dem ersten Teil des Artikels in die Registrierung geschrieben wurde. <br><br><img src="https://habrastorage.org/webt/wa/zr/c3/wazrc3yxq9pul3vzf3jjbgsdeyg.jpeg"><br><br>  <i>Abb.</i>  <i>25. F√ºllen der Importtabelle mit einer Hilfsbibliothek</i> <br><br><h2>  Fazit </h2><br>  In dem Artikel haben wir die Merkmale der Arbeit vieler Zwillingstrojaner kennengelernt.  Warum Zwillinge?  Der b√∂swillige Bootloader, mit dem wir unsere Forschungen begonnen haben, ist dem bekannten FlawedAmmyy-Backdoor-Bootloader in Bezug auf die Qualit√§t der Code-Schreib- und Implementierungsnuancen sehr √§hnlich.  Die beiden Bibliotheken, die er aus dem System zu entfernen versucht, sind h√∂chstwahrscheinlich die, die wir als n√§chstes betrachten.  Bibliotheken sind dem LatentBot-Sicherheits-Plugin sehr √§hnlich.  Eine der Bootloader-Nutzdaten ist ein Treiber, der vom beliebten Necurs-Rootkit abgeleitet ist. <br><br>  Einige Malware-Familien sind √ºber 5 Jahre alt. Angreifer aktualisieren und verbessern sie jedoch weiterhin, unter Ber√ºcksichtigung der Entwicklung von Betriebssystemen und Sicherheitstools. <br><br>  <b>Autoren</b> : Alexey Vishnyakov und Daniil Koloskov, Positive Technologies <br><br><div class="spoiler">  <b class="spoiler_title">IOCs</b> <div class="spoiler_text">  a28a54abc30805cc6ea2ce0732989287 - Twein-Bootloader <br>  f6b6526b8d494dce14568e3703368432 - Twein Plugin Dropper <br>  983dd279722154a12093410067fe070e - Rootkit Twein <br></div></div><br><h2>  Vorherige Artikel in der Reihe: </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Operation TA505: Wie wir die neuen Tools der Entwickler des Trojaners Dridex, der Ransomware Locky und des Neutrino-Botnets analysiert haben.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Operation TA505: Lernen der ServHelper-Backdoor mit NetSupport RAT.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 2</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Operation TA505: Gruppieren der Netzwerkinfrastruktur.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 3</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de475328/">https://habr.com/ru/post/de475328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de475308/index.html">Wie man sich als guter Programmierer ausgibt</a></li>
<li><a href="../de475314/index.html">√ñko-Fantasie zum Schutz des Planeten</a></li>
<li><a href="../de475320/index.html">Microsoft-Empfehlungen zum Deaktivieren des Kennwortablaufs: Konsequenzen und Schlussfolgerungen</a></li>
<li><a href="../de475322/index.html">Bone Sound der n√§chsten Stufe - Aftershokz Aeropex Review</a></li>
<li><a href="../de475324/index.html">Funktionale Programmierung aus Sicht von EcmaScript. Zusammensetzung, Currying, Teilanwendung</a></li>
<li><a href="../de475330/index.html">Miro Platform Plugin-Wettbewerb mit einem Preispool von 21.000 US-Dollar</a></li>
<li><a href="../de475332/index.html">3. Enterprise Network Design auf Extreme Switches</a></li>
<li><a href="../de475336/index.html">So beenden Sie richtig (Anleitung)</a></li>
<li><a href="../de475340/index.html">AMD stellte Threadripper-Prozessoren vor - die schnellsten Desktop-CPUs</a></li>
<li><a href="../de475342/index.html">Andrey Sebrant (Yandex): Business im Zeitalter der k√ºnstlichen Intelligenz</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>