<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÉüèª üë©üèø‚Äçüéì ü§úüèæ Samba DC como segundo controlador en el dominio AD de Windows 2012R2 y carpetas m√≥viles para clientes en Windows y Linux üë¥üèø üàöÔ∏è üëäüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La constataci√≥n de que estaba en la mezcla de importaci√≥n no lleg√≥ de inmediato. Solo cuando los nuevos suministros de una PC comenzaron a llegar de m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Samba DC como segundo controlador en el dominio AD de Windows 2012R2 y carpetas m√≥viles para clientes en Windows y Linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450572/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/q7/qz/gi/q7qzgibifknfegmdk3ffls-fik0.jpeg" alt="imagen"></div><br>  La constataci√≥n de que estaba en la mezcla de importaci√≥n no lleg√≥ de inmediato.  Solo cuando los nuevos suministros de una PC comenzaron a llegar de manera estable desde la organizaci√≥n matriz con la distribuci√≥n Alt Linux a bordo, sospech√© que algo andaba mal. <br><br>  Sin embargo, en el proceso de pasar por las etapas de aceptar lo inevitable, me involucr√© e incluso comenc√© a disfrutar un poco del proceso.  Y en alg√∫n momento pens√© que, a ese ritmo, tarde o temprano tendr√≠a que renunciar a la decisi√≥n de organizar el servicio de directorio de Microsoft y avanzar hacia algo m√°s ex√≥tico.  Por lo tanto, para prepararse de antemano para lo inevitable y, si es posible, para atrapar m√°s dificultades, se decidi√≥ implementar un banco de pruebas, que incluye: <br><br><ul><li>  DC1 - Windows Server 2012R2 </li><li>  DC2 - Servidor Alt 8.2 </li><li>  Servidor de archivos - Windows Server 2012R2 </li><li>  PC1 - Windows 7 </li><li>  PC2 - Alt Workstation 8.2 </li></ul><a name="habracut"></a><br><h4>  Tareas del stand: </h4><br><ol><li> Implemente un dominio basado en w2k12r2.  Cree un conjunto m√≠nimo de pol√≠ticas grupales (similares a las utilizadas en la infraestructura de trabajo), incluida una pol√≠tica para transferir carpetas de trabajo de usuarios (Descargas / Documentos / Escritorio).  Al final, quiero que cuando un usuario cambie su lugar de trabajo de Windows a Linux y viceversa, tenga un acceso c√≥modo a sus documentos de trabajo. </li><li>  Entrando a Samba DC por el segundo controlador.  Comprobaci√≥n del servicio de directorio y la replicaci√≥n de DNS </li><li>  Configuraci√≥n de clientes Linux con carpetas m√≥viles </li></ol><br><h4>  Implementaci√≥n </h4><br><ol><li>  <b>Instalar e ingresar un nuevo controlador</b> <br><br>  Con la instalaci√≥n de MS Windows 2012R2, todo es simple y menos claro.  En Internet hay un manual 1001 para implementar un dominio en Windows utilizando la GUI y Powershell, por lo que no lo repetir√© nuevamente, solo dejar√© un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlace</a> desactivado.  documentaci√≥n para los curiosos y aquellos que desean refrescar su memoria. <br><br>  Sin embargo, hay un punto importante en este p√°rrafo.  Hasta la fecha, Samba no puede trabajar con esquemas de cat√°logo superiores a 2008R2. <br><br><div class="spoiler">  <b class="spoiler_title">Encabezado de spoiler</b> <div class="spoiler_text">  Por el contrario, los desarrolladores de este soporte se declaran como experimentales.  Pero en la pr√°ctica, un intento de ingresar a samba como un segundo DC en un dominio de Windows existente con el esquema 69 se encontrar√° con el siguiente error <br><blockquote>  DsAddEntry fall√≥ con el estado WERR_ACCESS_DENIED info (8567, 'WERR_DS_INCOMPATIBLE_VERSION') </blockquote><br></div></div><br>  El problema es que Windows 2012 y 2012R2 usan herramientas WMI para trabajar con dominios y bosques, cuyo soporte estable se anuncia solo para Samba versi√≥n 4.11, que se lanzar√° antes de finales de este a√±o. <br>  Se deduce que la √∫nica opci√≥n para introducir samba al dominio AD implementado en un servidor 2012R2 es reducir el esquema de 69 a 47. Por supuesto, esto no es necesario en la infraestructura de trabajo sin una buena raz√≥n, pero tenemos un banco de pruebas aqu√≠, entonces ¬øpor qu√©? En realidad no. <br><br>  Ponemos Alt Server 8.2.  Durante la instalaci√≥n, seleccione el perfil "Servidor Samba-DC (Controlador AD)".  En el servidor implementado, realizamos una actualizaci√≥n completa del sistema e instalamos el paquete task-samba-dc, que extraer√° todo lo que necesita <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get install task-samba-dc</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Si task-samba-dc de repente, contrario a las garant√≠as de la documentaci√≥n, Alta se niega a instalar todo lo necesario.</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get install python-module-samba-DC samba-DC-common samba-DC-winbind-clients samba-DC-winbind samba-DC-common-libs libpytalloc-devel</span></span></code> </pre> <br></div></div><br>  A continuaci√≥n, proceda a configurar Kerberos y reciba un ticket.  Abra el archivo krb5.conf, vaya a la secci√≥n [libdefaults] y ll√©velo al siguiente formulario: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vim /etc/krb5.conf</span></span></code> </pre> <br><pre> <code class="bash hljs"> dns_lookup_kdc = <span class="hljs-literal"><span class="hljs-literal">true</span></span> dns_lookup_realm = <span class="hljs-literal"><span class="hljs-literal">true</span></span> default_realm = TEST.LOCAL</code> </pre> <br>  Solicitar un boleto <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># kinit administrator Password for administrator@TEST.LOCAL:</span></span></code> </pre> <br>  Verificaci√≥n de la lista de tickets Kerberos recibidos <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># klist Ticket cache: KEYRING:persistent:0:0 Default principal: administrator@TEST.LOCAL Valid starting Expires Service principal 16.05.2019 11:51:38 16.05.2019 21:51:38 krbtgt/TEST.LOCAL@TEST.LOCAL renew until 23.05.2019 11:51:35</span></span></code> </pre> <br>  Ahora elimine o cambie el nombre de la configuraci√≥n de samba existente. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mv smb.conf smb.conf.bak1</span></span></code> </pre> <br>  Finalmente, ingresamos el segundo controlador en el dominio AD: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># samba-tool domain join test.local DC -U"TEST\administrator"</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">La entrada exitosa ser√° seguida por el siguiente registro</b> <div class="spoiler_text"><pre> <code class="bash hljs">Finding a writeable DC <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> domain <span class="hljs-string"><span class="hljs-string">'test.local'</span></span> Found DC DC1.TEST.LOCAL Password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> [TEST\administrator]: Reconnecting to naming master e31d7da6-8f56-4420-8473-80f2b3a31338._msdcs.TEST. LOCAL DNS name of new naming master is DC1.TEST.LOCAL workgroup is TEST realm is TEST.LOCAL Adding CN=DC2,OU=Domain Controllers,DC=TEST,DC=LOCAL Adding CN=DC2,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC =TEST,DC=LOCAL Adding CN=NTDS Settings,CN=DC2,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN =Configuration,DC=TEST,DC=LOCAL Adding SPNs to CN=DC2,OU=Domain Controllers,DC=TEST,DC=LOCAL Setting account password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> DC2$ Enabling account Calling bare provision Looking up IPv4 addresses Looking up IPv6 addresses No IPv6 address will be assigned Setting up share.ldb Setting up secrets.ldb Setting up the registry Setting up the privileges database Setting up idmap db Setting up SAM db Setting up sam.ldb partitions and settings Setting up sam.ldb rootDSE Pre-loading the Samba 4 and AD schema A Kerberos configuration suitable <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Samba AD has been generated at /var/lib/sa mba/private/krb5.conf Provision OK <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> domain DN DC=TEST,DC=LOCAL Starting replication Schema-DN[CN=Schema,CN=Configuration,DC=TEST,DC=LOCAL] objects[402/1426] linked _values[0/0] Schema-DN[CN=Schema,CN=Configuration,DC=TEST,DC=LOCAL] objects[804/1426] linked _values[0/0] Schema-DN[CN=Schema,CN=Configuration,DC=TEST,DC=LOCAL] objects[1206/1426] linke d_values[0/0] Schema-DN[CN=Schema,CN=Configuration,DC=TEST,DC=LOCAL] objects[1608/1426] linke d_values[0/0] Schema-DN[CN=Schema,CN=Configuration,DC=TEST,DC=LOCAL] objects[1743/1426] linke d_values[0/0] Analyze and apply schema objects Partition[CN=Configuration,DC=TEST,DC=LOCAL] objects[402/2240] linked_values[0/ 24] Partition[CN=Configuration,DC=TEST,DC=LOCAL] objects[804/2240] linked_values[0/ 24] Partition[CN=Configuration,DC=TEST,DC=LOCAL] objects[1206/2240] linked_values[0 /24] Partition[CN=Configuration,DC=TEST,DC=LOCAL] objects[1608/2240] linked_values[0 /24] Partition[CN=Configuration,DC=TEST,DC=LOCAL] objects[1772/2240] linked_values[2 4/24] Replicating critical objects from the base DN of the domain Partition[DC=TEST,DC=LOCAL] objects[109/110] linked_values[26/29] Partition[DC=TEST,DC=LOCAL] objects[394/5008] linked_values[29/29] Done with always replicated NC (base, config, schema) Replicating DC=DomainDnsZones,DC=TEST,DC=LOCAL Partition[DC=DomainDnsZones,DC=TEST,DC=LOCAL] objects[42/42] linked_values[0/0] Replicating DC=ForestDnsZones,DC=TEST,DC=LOCAL Partition[DC=ForestDnsZones,DC=TEST,DC=LOCAL] objects[20/20] linked_values[0/0] Exop on[CN=RID Manager$,CN=System,DC=TEST,DC=LOCAL] objects[3] linked_values[0] Committing SAM database Adding 1 remote DNS records <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> DC2.TEST.LOCAL Adding DNS A record DC2.TEST.LOCAL <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> IPv4 IP: 192.168.90.201 Adding DNS CNAME record 6ff1df40-cbb5-41f0-b7b3-53a27dde8edf._msdcs.TEST.LOCAL <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> DC2.TEST.LOCAL All other DNS records (like _ldap SRV records) will be created samba_dnsupdate on first startup Replicating new DNS records <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DC=DomainDnsZones,DC=TEST,DC=LOCAL Partition[DC=DomainDnsZones,DC=TEST,DC=LOCAL] objects[1/42] linked_values[0/0] Replicating new DNS records <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DC=ForestDnsZones,DC=TEST,DC=LOCAL Partition[DC=ForestDnsZones,DC=TEST,DC=LOCAL] objects[1/20] linked_values[0/0] Sending DsReplicaUpdateRefs <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> all the replicated partitions Setting isSynchronized and dsServiceName Setting up secrets database Joined domain TEST (SID S-1-5-21-3959064270-1572045903-2556826204) as a DC</code> </pre> <br></div></div><br>  Deber√≠a aparecer un registro sobre el nuevo DC en el dominio TEST.LOCAL en el complemento ADUC, y deber√≠a aparecer un nuevo registro A correspondiente a DC2 en el administrador de DNS. </li><li>  <b>Replicaci√≥n entre controladores</b> <br><br>  Para comenzar, consulte el Servicio de replicaci√≥n de directorios (DRS) <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># samba-tool drs showrepl</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Todos los intentos de replicaci√≥n en la salida deben ser exitosos.</b>  <b class="spoiler_title">En la lista de objetos KCC, dentro de los 15 minutos posteriores a la entrada, deber√≠a aparecer nuestro DC1 en Windows</b> <div class="spoiler_text"><pre> <code class="bash hljs">Default-First-Site-Name\DC2 DSA Options: 0x00000001 DSA object GUID: 0e9f5bce-ff59-401e-bdbd-fc69df3fc6bf DSA invocationId: 017997b5-d718-41d7-a3f3-e57ab5151b5c ==== INBOUND NEIGHBORS ==== DC=ForestDnsZones,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Mon May 27 12:56:31 2019 MSK was successful 0 consecutive failure(s). Last success @ Mon May 27 12:56:31 2019 MSK DC=DomainDnsZones,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Mon May 27 12:56:32 2019 MSK was successful 0 consecutive failure(s). Last success @ Mon May 27 12:56:32 2019 MSK CN=Schema,CN=Configuration,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Mon May 27 12:56:32 2019 MSK was successful 0 consecutive failure(s). Last success @ Mon May 27 12:56:32 2019 MSK DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Mon May 27 12:56:32 2019 MSK was successful 0 consecutive failure(s). Last success @ Mon May 27 12:56:32 2019 MSK CN=Configuration,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Mon May 27 12:56:33 2019 MSK was successful 0 consecutive failure(s). Last success @ Mon May 27 12:56:33 2019 MSK ==== OUTBOUND NEIGHBORS ==== DC=ForestDnsZones,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Thu May 23 16:40:03 2019 MSK was successful 0 consecutive failure(s). Last success @ Thu May 23 16:40:03 2019 MSK DC=DomainDnsZones,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Thu May 23 16:40:03 2019 MSK was successful 0 consecutive failure(s). Last success @ Thu May 23 16:40:03 2019 MSK CN=Schema,CN=Configuration,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Thu May 23 16:40:08 2019 MSK was successful 0 consecutive failure(s). Last success @ Thu May 23 16:40:08 2019 MSK DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Thu May 23 16:40:08 2019 MSK was successful 0 consecutive failure(s). Last success @ Thu May 23 16:40:08 2019 MSK CN=Configuration,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Mon May 27 12:12:17 2019 MSK was successful 0 consecutive failure(s). Last success @ Mon May 27 12:12:17 2019 MSK ==== KCC CONNECTION OBJECTS ==== Connection -- Connection name: 6d2652b3-e723-4af7-a19f-1ee48915753c Enabled : TRUE Server DNS name : DC1.test.local Server DN name : CN=NTDS Settings,CN=DC1,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> TransportType: RPC options: 0x00000001 Warning: No NC replicated <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Connection!</code> </pre> <br></div></div><br>  Advertencia <i>"¬°No hay NC replicado para Connection!"</i>  Puede ser ignorado con seguridad.  Parece debido al hecho de que al registrar un nuevo DC, samba establece incorrectamente algunos indicadores de replicaci√≥n. <br><br>  Verificar la replicaci√≥n LDAP tambi√©n es una buena idea. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># samba-tool ldapcmp ldap://dc1.test.local ldap://dc2.test.local -Uadministrator</span></span></code> </pre> <br>  El comando anterior comparar√° los valores de los atributos de los objetos de todo el directorio en DC1 y DC2. <br><br><div class="spoiler">  <b class="spoiler_title">Ejemplo de replicaci√≥n exitosa</b> <div class="spoiler_text"><pre> <code class="bash hljs">* Comparing [DOMAIN] context... * Objects to be compared: 249 * Result <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> [DOMAIN]: SUCCESS * Comparing [CONFIGURATION] context... * Objects to be compared: 1750 * Result <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> [CONFIGURATION]: SUCCESS * Comparing [SCHEMA] context... * Objects to be compared: 1739 * Result <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> [SCHEMA]: SUCCESS * Comparing [DNSDOMAIN] context... * Objects to be compared: 42 * Result <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> [DNSDOMAIN]: SUCCESS * Comparing [DNSFOREST] context... * Objects to be compared: 20 * Result <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> [DNSFOREST]: SUCCESS</code> </pre> </div></div><br>  En algunos casos, los atributos de los objetos en diferentes controladores pueden diferir, y la salida del comando le informar√° al respecto.  Pero no en todos los casos, esto ser√° un signo de un problema de replicaci√≥n. <br><br>  El siguiente paso es configurar manualmente la replicaci√≥n estable del directorio SysVol. <br>  Sin embargo, el hecho es que samba a√∫n no es compatible con DFS-R, ya que no era compatible con el FRS anterior.  Por lo tanto, para la replicaci√≥n entre DC Samba y Windows, la √∫nica soluci√≥n que funciona hoy en d√≠a es la replicaci√≥n unidireccional utilizando la utilidad <i>Robocopy</i> de las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">herramientas del Kit de recursos de Windows Server 2003</a> . <br><br>  Los desarrolladores de Samba, para evitar problemas de compatibilidad, recomiendan instalar primero el kit de utilidad en una estaci√≥n de trabajo normal y luego copiar Robocopy al controlador en la carpeta "C: \ Archivos de programa (x86) \ Windows Resource Kits \ Tools \" <br><br>  Despu√©s de la instalaci√≥n, en el programador de tareas en el controlador de Windows, creamos una tarea para replicar con los siguientes par√°metros: <br><br>  - Realizar para todos los usuarios <br>  - Disparador para ejecutar diariamente cada 5 minutos durante el d√≠a <br>  - En las acciones que prescribimos la ruta a la utilidad robocopy, indicamos como argumentos: <br><br><pre> <code class="xml hljs">\\DC1\SYSVOL\test.local\ \\DC2\SYSVOL\test.local\ /mir /sec</code> </pre> <br>  En un caso espec√≠fico, copie el contenido del directorio SysVol de DC1 a DC2. <br></li><li>  <b>Carpetas de usuario port√°tiles que utilizan la configuraci√≥n pam_mount</b> <br><br>  Emp√≠ricamente, encontr√© dos opciones viables para resolver este problema con su ayuda. <br><br><ol><li>  Montaje completo de la carpeta de perfil de la red a la secci√≥n / home <br><br>  Una opci√≥n simple  Funciona bien si los nombres de carpeta Mis documentos, Descargas y Escritorio son los mismos en ambos sistemas operativos.  Se entiende que ya se ha ingresado una PC con Linux en el dominio y los usuarios inician sesi√≥n en sus cuentas de dominio utilizando sssd como mecanismo de autenticaci√≥n y autorizaci√≥n. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vim /etc/security/pam_mount.conf.xml</span></span></code> </pre> <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">volume</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100000000-2000000000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fstype</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cifs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">server</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dfs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Profile_Users/%(USER)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mountpoint</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"~"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">options</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sec=krb5,cruid=%(USERUID),nounix,uid=%(USERUID),gid=%(USERGID),file_mode=0664,dir_mode=0775"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  donde: <br><br><ul><li>  <b>uid = "100000000-2000000000"</b> - el rango de UID asignado a los usuarios del dominio desde SSSD </li><li>  <b>server = "dfs"</b> - nombre del servidor de archivos </li><li>  <b>ruta = "Usuarios_perfil /% (USUARIO)"</b> - un recurso en el servidor de archivos con el perfil de usuario alojado </li><li>  <b>mountpoint = "~"</b> - ruta de montaje a la carpeta de inicio del usuario </li></ul><br>  El inicio de sesi√≥n del usuario se pasa a la variable macro "% (USER)" utilizada por pam_mount para conectar nuestro recurso de red, en la forma en que se ingresa en el administrador de visualizaci√≥n.  Por lo tanto, es importante que el inicio de sesi√≥n DM se ingrese sin una indicaci√≥n expl√≠cita del nombre de dominio. <br><br>  En sssd.conf, esto se resuelve comentando o configurando el valor False en la opci√≥n <b>use_fully_qualified_names</b> , que activa el modo de nombre completo (incluido el dominio) para usuarios y grupos. <br></li><li>  El segundo m√©todo es menos directo y torpe, y en mi opini√≥n es m√°s conveniente y preferido.  La diferencia con el primero solo en la configuraci√≥n de pam_mount <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vim /etc/security/pam_mount.conf.xml</span></span></code> </pre> <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">volume</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100000000-2000200000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fstype</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cifs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">server</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dfs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Profile_Users/%(USER)/ "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mountpoint</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"~/ "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">options</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sec=krb5,cruid=%(USERUID),nounix,uid=%(USERUID),gid=%(USERGID),file_mode=0664,dir_mode=0775"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">volume</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100000000-2000200000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fstype</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cifs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">server</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dfs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Profile_Users/%(USER)/Downloads"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mountpoint</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"~/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">options</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sec=krb5,cruid=%(USERUID),nounix,uid=%(USERUID),gid=%(USERGID),file_mode=0664,dir_mode=0775"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">volume</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100000000-2000200000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fstype</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cifs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">server</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dfs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Profile_Users/%(USER)/ "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mountpoint</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"~/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">options</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sec=krb5,cruid=%(USERUID),nounix,uid=%(USERUID),gid=%(USERGID),file_mode=0664,dir_mode=0775"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br>  Es decir, simplemente montamos cada una de nuestras carpetas por separado en el directorio correspondiente </li></ol></li></ol><br>  <b>Conclusiones</b> <br><br>  Durante medio mes de trabajo en un banco de pruebas, este paquete sobrevivi√≥ con √©xito a varios apagones alternos a largo y corto plazo de ambos controladores, sin pr√°cticamente consecuencias para los clientes (una vez que un cliente en Windows 7 perdi√≥ la confianza). <br><br>  En general, tuve una impresi√≥n bastante agradable de trabajar con este producto, incluso a pesar de todos los matices que tuve que enfrentar tanto en el art√≠culo como detr√°s de escena. <br><br>  Hay dificultades, hay muchas, y en el curso del trabajo con samba, deber√°n capturarse en grandes cantidades.  Sin embargo, hasta la fecha, no hay otras soluciones que le permitan organizar un entorno h√≠brido utilizando servicios de directorio y sin utilizar Windows. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/450572/">https://habr.com/ru/post/450572/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450554/index.html">Romper el patr√≥n de dise√±o - Singleton en PHP</a></li>
<li><a href="../450556/index.html">√çndice de v√°lvulas: revisi√≥n del nuevo conjunto VR</a></li>
<li><a href="../450564/index.html">Brillo y pobreza: c√≥mo la revoluci√≥n digital empobreci√≥ a los m√∫sicos</a></li>
<li><a href="../450566/index.html">OutOfMemory y el uso de im√°genes vectoriales en Android Studio</a></li>
<li><a href="../450568/index.html">Cada veneno tiene su propio ant√≠doto. C√≥mo guardar o al menos intentar (upd: sobre ant√≠dotos para envenenamiento dom√©stico)</a></li>
<li><a href="../450574/index.html">Crea un juego web multijugador .io</a></li>
<li><a href="../450576/index.html">Nuevas reglas para el anonimato del mensajero</a></li>
<li><a href="../450578/index.html">¬øQu√© se escucha en el aire? Recibimos y decodificamos las se√±ales m√°s interesantes. Parte 2, VHF</a></li>
<li><a href="../450582/index.html">Principios de PIM</a></li>
<li><a href="../450586/index.html">Fish Redux - Nueva Biblioteca Redux para Flutter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>