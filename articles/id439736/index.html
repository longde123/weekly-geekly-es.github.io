<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçå ‚òëÔ∏è üï£ Koneksi IPSec VPN antara MikroTik dan Kerio Control üåô üîñ üåΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Parameter awal: 



1. Kantor pusat perusahaan dengan dua proxy perbatasan, Kerio Control v.9.2.9 build 3171 (di belakang Kerio ada switch Cisco 3550 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Koneksi IPSec VPN antara MikroTik dan Kerio Control</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439736/"><img src="https://habrastorage.org/webt/zg/b9/cd/zgb9cd1ivkh83waulyxllysswwe.png"><br><br>  Parameter awal: <br><br><ol><li>  Kantor pusat perusahaan dengan dua proxy perbatasan, Kerio Control v.9.2.9 build 3171 (di belakang Kerio ada switch Cisco 3550 yang menentukan konfigurasi jaringan lokal kantor). </li><li>  Setiap Kerio memiliki dua saluran dengan load balancing hingga ISP (dalam diagram - ISP # 1 dan ISP # 2) dengan IP putih statis. </li><li>  Dari sisi kantor jarak jauh, MikroTik 951G-2HnD (OS v.6.43.11) telah diinstal. </li><li>  Dua ISP datang ke MikroTik (dalam diagram adalah ISP # 3 dan ISP # 4). </li></ol><br>  Pada saat penulisan, baik di kantor pusat dan di kantor jarak jauh, koneksi dengan penyedia twisted pair. <br><br><h3>  Daftar tugas: </h3><br><ol><li>  Membangun koneksi IPSec VPN antara MikroTik dan Kerio Control, di mana MikroTik akan menjadi inisiator. </li><li> Pastikan toleransi kesalahan dari koneksi VPN, mis.  Selain fakta bahwa MikroTik harus memantau kinerja ISP-nya (artikel di <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a></b> ), MikroTik juga harus memantau ketersediaan setiap server Kerio dan menentukan akses melalui saluran mana (melalui mana ISP dari Kerio) koneksi akan dibuat. </li><li>  Memberikan kemampuan untuk mengubah alamat jaringan yang terhubung MikroTik ke Kerio.  Ini disebabkan oleh fakta bahwa Kerio, dan bukan router, berada di markas "perbatasan". </li></ol><a name="habracut"></a><br><br><h3>  Apa yang kita dapatkan di output? </h3><br><ol><li>  Ketika MikroTik (scheduleStartup) diluncurkan, saluran ke jaringan perusahaan akan diatur (saluran tersebut akan diinisiasi oleh MikroTik), yang memungkinkan pengguna jarak jauh untuk bekerja dengan sumber daya perusahaan tanpa memulai Kerio Client dan tanpa mengatur koneksi VPN tambahan menggunakan sistem operasi; </li><li>  MikroTik akan mengimplementasikan Failover, yang secara otomatis beralih ke ISP langsung; </li><li>  Anda dapat menetapkan prioritas untuk titik koneksi ke jaringan perusahaan dengan mengubah afiliasi dari rekan yang dikonfigurasi untuk terhubung ke Kerio Control ke satu atau Grup Template Kebijakan lain di MikroTik; </li><li>  MikroTik akan dapat secara otomatis memantau kinerja server Kontrol Kerio, dan jika koneksi dengan titik prioritas terputus, beralihlah ke saluran langsung secara independen; </li><li>  Jika server Kerio Control Anda diterbitkan pada server DNS eksternal, MikroTik akan dapat melacak perubahan dalam alamat IP mereka (misalnya, jika penyedia Anda berubah) dan secara mandiri membuat perubahan pada konfigurasinya (scriptSetIPSecSADstAddrFromDNS). </li></ol><br><br>  Saya harus segera mengatakan bahwa artikel ini bukan tutorial (pada prinsipnya, saya berkenalan dengan router dan khususnya dengan MikroTik hanya dua bulan (akhir 2017) sebelum konfigurasi dibuat) dan tidak membahas pertanyaan "mengapa?", Itu akan ada di sini Deskripsi konfigurasi kerja MikroTik, yang digunakan dalam perusahaan nyata, diberikan. <br><br>  <b>Catatan:</b> <br><ol><li>  Untuk menyimpan komentar berbahasa Rusia saat mentransfer kode skrip ke MikroTik, sebelum menyalin teks ke buffer dan sebelum memasukkan dari buffer, pastikan bahwa tata letak keyboard Rusia dihidupkan; </li><li>  Jika Anda menemukan bahwa skrip logging tidak perlu, Anda dapat mengomentari atau menghapus baris dengan "log log" dan "log error"; </li><li>  Anda juga dapat melihat komentar "peringatan log" dan "kesalahan log" dalam kode, ini merupakan upaya untuk menambahkan kemampuan untuk menggunakan logging dalam bahasa Inggris ... </li></ol><br><br>  Jadi mari kita mulai: <br><br>  <b>Parameter dasar:</b> <br><br><ol><li>  Jaringan organisasi induk (di belakang Kerio) adalah 192.168.77.0/24 (di sini kami menggunakan alamat jaringan tempat Kerio berada di jaringan perusahaan) </li><li>  Jaringan cabang (di belakang MikroTik) - 192.168.11.0/24 </li><li>  Jaringan yang akan dipetakan oleh jaringan cabang saat tersambung ke Kerio Control # 1 - 192.168.22.0/24 </li><li>  Jaringan yang akan dipetakan oleh jaringan cabang saat tersambung ke Kerio Control # 2 - 192.168.33.0/24 </li><li>  Alamat IP dari kumpulan ISP # 1 (Kerio # 1) - 11.11.11.111 </li><li>  Alamat IP dari kumpulan ISP # 2 (Kerio # 1) - 22.22.22.111 </li><li>  Alamat IP dari kumpulan ISP # 1 (Kerio # 2) - 11.11.11.222 </li><li>  Alamat IP dari kumpulan ISP # 2 (Kerio # 2) adalah 22.22.22.222 </li><li>  Alamat IP dari kumpulan ISP # 3 (MikroTik) - 33.33.33.111 </li><li>  Alamat IP dari kumpulan ISP # 4 (MikroTik) - 44.44.44.111 </li></ol><br>  Hal pertama yang harus dilakukan adalah mengaktifkan DDNS di MikroTik: <br><br><pre><code class="plaintext hljs">/ip cloud set ddns-enabled=yes</code> </pre> <br>  Karena fakta bahwa MikroTik tidak akan memiliki alamat IP putih statis, pekerjaan lebih lanjut dari konfigurasi dan skrip didasarkan pada penggunaan DDNS. <br><br>  Juga IP ---&gt; Cloud digunakan untuk menentukan alamat IP eksternal MikroTik, dari mana ia terlihat di Internet. <br><br>  Sekarang mari kita mengkonfigurasi Kerio Control # 1, sehingga nanti kita tidak kembali ke sana: <br>  Kami pergi ke bagian "Antarmuka" dan menambahkan antarmuka "terowongan VPN" baru ... <br><br><div class="spoiler">  <b class="spoiler_title">Konfigurasi terowongan di Kontrol Kerio</b> <div class="spoiler_text">  1. Di bidang nama, tetapkan nama ke antarmuka; <br>  2. Letakkan sakelar di posisi "Pasif - hanya menerima koneksi masuk"; <br>  3. Ketik cuti "IPSec"; <br>  4. Tab "Otentikasi": <br><br><ul><li>  4.1 Di bidang "Kunci standar:" masukkan frasa kunci yang akan digunakan untuk menghubungkan; </li><li>  <b>Catatan:</b> <br><br>  Saya merekomendasikan pengaturan semua frasa kunci pada semua terowongan VPN yang dibuat pada satu server Kerio tertentu! <br><br>  Hal ini disebabkan oleh fakta bahwa Kerio memiliki bug mengambang, yang dinyatakan sebagai berikut. <br><br>  Bayangkan dalam konfigurasi Kerio, seperti dalam kasus saya, ada beberapa antarmuka terowongan VPN yang dikonfigurasi untuk terhubung ke MikroTik, yang berbeda satu sama lain hanya dalam pengaturan di bidang ID Lokal: (akan dibahas di bawah). <br><br>  Jadi, ketika membuat (saya akan menyebutnya) terowongan masuk, tidak peduli apa alamat IP eksternal Kerio akan menghubungi MikroTik, Kerio (untuk beberapa alasan) akan mengaktifkan antarmuka pertama yang datang, dan jika alamat IP ditentukan dalam pengaturan terowongan di sisi Kerio berbeda dari yang disebut MikroTik, terowongan tidak terorganisir. <br><br>  Dan dalam kasus ketika frase kunci yang berbeda diindikasikan untuk semua terowongan, masalah ini berhenti. </li><li>  4.2 Dalam bidang "ID Lokal:", masukkan alamat IP dari kumpulan alamat ISP # 1 (dalam contoh 11.11.11.111) yang ditugaskan ke antarmuka WAN Kontrol Kerio # 1, yang akan diakses MikroTik; </li><li>  4.3 Pada bidang "Remote ID:", masukkan FQDN, yang diperoleh oleh MikroTik kami dari DDNS (IP ---&gt; Cloud ---&gt; Nama DNS).  Pengaturan ini memungkinkan kita untuk tidak peduli tentang bagaimana ISP MikroTik mengakses Kerio; </li><li>  4.4 Di bidang "Fase 1 sandi (IKE):" pilih aes128-sha1-modp2048 dari daftar; </li><li>  4.5 Di bidang "Fase 2 cipher (ESP):" pilih 3des-sha1-modp2048 dari daftar; </li><li>  <b>Catatan:</b> <br>  Mengedit pengaturan default yang digunakan melalui tombol "Ubah ..."; <br>  Kedua cipher dipilih menggunakan "metode poking ilmiah". </li></ul><br>  5. Tab "Jaringan Jarak Jauh": <br><br>  Di sini kita memasukkan alamat IP dari jaringan lokal yang akan digunakan MikroTik ketika menghubungkan ke server Kontrol Kerio spesifik ini (dalam contoh - 192.168.22.0/24). <br>  Penting!  Dalam semua sisanya (dalam kasus saya ditentukan oleh jumlah ISP dari Kerio) terowongan di MikroTik, pada server Kerio ini, alamat IP yang sama harus ditunjukkan! <br><br>  Biarkan saya mengingatkan Anda bahwa ini karena kebutuhan untuk mengkonfigurasi rute ke jaringan ini dari jaringan kantor pusat. <br><br>  6. Tab "Jaringan Area Lokal": <br><br><ul><li>  6.1 Hapus centang pada kotak ‚ÄúGunakan jaringan lokal yang terdeteksi secara otomatis‚Äù; </li><li>  6.2 Setel "Gunakan jaringan khusus:", dan tambahkan alamat jaringan "yang meliputi" seluruh rentang alamat yang digunakan dalam jaringan lokal di belakang Kerio Control ke daftar jaringan (dalam contoh - 192.168.0.0/16). </li></ul><br>  Kami ulangi semua langkah di atas untuk terowongan kedua di server Kerio yang sama. <br><br>  Konfigurasi terowongan kedua hanya akan berbeda dengan menggunakan frasa sandi yang berbeda (klausul 4.1) dan alamat IP eksternal yang berbeda dari kumpulan alamat ISP # 2 (klausul 4.2) (dalam contoh, 22.22.22.111). <br><br>  Pengaturan Kerio Control # 2 identik dengan yang dijelaskan di atas, kecuali untuk alamat jaringan yang ditunjukkan pada tab Remote Networks (hal. 5) (dalam contoh, 192.168.33.0/24) dan, karenanya, alamat IP dalam bidang ID Lokal: bidang ( Bagian 4.2), yang harus dipilih dari alamat IP yang ditetapkan untuk antarmuka WAN Kerio Control # 2 (dalam contoh, 11.11.11.222 dan 22.22.22.222). <br></div></div><br>  Selanjutnya, kami membuat aturan perbolehkan untuk melakukan ping Kerio dari MikroTik ... <br><br><div class="spoiler">  <b class="spoiler_title">Ping Rule dalam Kontrol Kerio</b> <div class="spoiler_text">  Kami pergi ke bagian "Aturan lalu lintas" dan membuat aturan baru dengan parameter berikut: <br><br><ul><li>  source - menunjukkan FQDN yang diterima oleh MikroTik kami dari DDNS; </li><li>  Tujuan - Firewall </li><li>  layanan - Ping; </li><li>  Anda juga dapat menentukan versi IP (IPv4), tetapi ini tidak perlu. </li></ul><br>  Kami menyimpan aturan dengan nama yang dapat dimengerti oleh Anda dan menyeretnya ke bagian paling atas dari daftar aturan. <br><br>  Kami ulangi prosedur yang sama pada server Kerio kedua. <br></div></div><br>  Jangan lupa untuk mendaftarkan rute pada jaringan di belakang MikroTik di sakelar atau router di samping kantor pusat sehingga jaringan kantor pusat tahu ke mana harus mengarahkan lalu lintas (dalam kasus saya, ini adalah dua rute statis pada jaringan 192.168.22.0/24 dan 192.168.33.0/24). <br><br>  Dari kantor pusat, kami melakukan segalanya, sekarang kami pindah ke MikroTik. <br><br>  Mari kita mulai dengan membuat objek konfigurasi dasar untuk mengatur dan menguji terowongan VPN. <br><br>  Langkah pertama adalah membuat daftar alamat subnet lokal.  Kami akan menggunakannya dalam aturan Firewall. <br><br><pre> <code class="plaintext hljs">/ip firewall address-list #      MikroTik, # IP-      DHCP add address=192.168.11.0/24 list="Local subnet" #  ,        MikroTik #   VPN-  Kerio Control #1 # (     VPN-  Kerio Control #1, #   " ") add address=192.168.22.0/24 list="Local subnet" #  ,        MikroTik #   VPN-  Kerio Control #2 # (     VPN-  Kerio Control #2, #   " ") add address=192.168.33.0/24 list="Local subnet"</code> </pre> <br>  Selanjutnya, buat aturan izin untuk lalu lintas IKE dan letakkan di bagian paling atas daftar aturan. <br><br><pre> <code class="plaintext hljs">add action=accept chain=input comment="VPN Allow IKE" dst-port=500 protocol=udp</code> </pre> <br>  Kemudian tambahkan dua aturan ke Filter Firewall untuk bekerja dengan lalu lintas VPN ... <br><br><pre> <code class="plaintext hljs">/ip firewall filter add action=accept chain=forward comment="VPN In IpSec" dst-address-list=\ "Local subnet" ipsec-policy=in,ipsec src-address=192.168.0.0/16 \ src-address-list="!Local subnet" add action=accept chain=forward comment="VPN Out" dst-address=192.168.0.0/16 \ dst-address-list="!Local subnet" src-address-list="Local subnet"</code> </pre> <br>  ... dan pindahkan mereka ke posisi tepat di <b>atas aturan drop</b> , yang melarang lalu lintas masuk dari luar LAN.  Dalam konfigurasi default saya, itu dengan komentar "defconf: jatuhkan semua tidak datang dari LAN" <br><br>  Buka Firewall Mangle dan buat aturan berikut: <br><br><pre> <code class="plaintext hljs">/ip firewall mangle #      , #  ... add action=mark-connection chain=prerouting comment="VPN In" \ new-connection-mark=VPN_conn_in passthrough=no src-address=192.168.0.0/16 \ src-address-list="!Local subnet" # ...   add action=mark-routing chain=output comment="VPN In" connection-mark=\ VPN_conn_in new-routing-mark=VPN_route_in passthrough=yes #     MikroTik      . #     NAT. add action=mark-connection chain=postrouting comment="VPN Out" dst-address=\ 192.168.0.0/16 dst-address-list="!Local subnet" new-connection-mark=\ VPN_conn_out passthrough=no</code> </pre> <br>  Berikutnya, kami perhatikan di Firewall NAT: <br><br><pre> <code class="plaintext hljs">/ip firewall nat #     MikroTik     #      , #    Kerio- (:  Kerio Control #1 - 192.168.22.0/24,  Kerio Control #2 - 192.168.33.0/24) # ! # comment=KerioVpnNatOut   ! add action=netmap chain=srcnat comment=KerioVpnNatOut connection-mark=\ VPN_conn_out to-addresses=192.168.22.0/24 #     MikroTik     #          MikroTik add action=netmap chain=dstnat comment=KerioVpnNatIn connection-mark=\ VPN_conn_in to-addresses=192.168.11.0/24 #  MikroTik  Kerio- add action=accept chain=srcnat comment=KerioVpnNatPing out-interface-list=WAN protocol=icmp</code> </pre> <br>  <b>Penting!</b>  Aturan-aturan ini harus ditempatkan di atas aturan yang menyamar. <br><br>  Sekarang kita masuk ke bagian IP ---&gt; IPSec, di mana kita perlu membuat kebijakan, peer, kelompok template kebijakan (saya akan membahas tujuan mereka nanti) dan proposal untuk menyiapkan cipher fase 2. <br><br><div class="spoiler">  <b class="spoiler_title">proposal IP IPSec</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec proposal add enc-algorithms=3des name=KerioVPNProposal#01 pfs-group=modp2048</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">grup kebijakan ip ipsec</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec policy group add name=1 add name=2 add name=3 add name=4</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">ip ipsec peer</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec peer add address=11.11.11.111/32 comment=vs01-i01-01.domain.ru exchange-mode=\ main-l2tp local-address=33.33.33.111 my-id=\ fqdn:mikrotik.sn.mynetname.net policy-template-group=1 profile=\ profile_4 secret=pass1111</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">kebijakan ip ipsec</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec policy add comment=KerioVPNPolicy dst-address=192.168.77.0/24 proposal=KerioVPNProposal#01 \ sa-dst-address=11.11.11.111 sa-src-address=33.33.33.111 src-address=\ 192.168.22.0/24 tunnel=yes</code> </pre> <br></div></div><br>  Komentar: <br><br>  1. / ip ipsec proposal - masukkan parameter enkripsi yang sama yang kami tentukan saat mengkonfigurasi Kontrol Kerio di bidang "Enkripsi Tahap 2 (ESP):". <br><br>  <b>Catatan:</b> <br><br>  Perhatikan parameter "name = KerioVPNProposal # 01". <br><br>  Tidak perlu menggunakan nama ini secara khusus, tetapi jika Anda memutuskan untuk menggunakan yang lain, maka setelah mengubahnya Anda perlu memeriksa dan, jika perlu, mengubah pengaturan kebijakan IPSec terkait, serta mengubah nilai yang ditetapkan dari variabel DefKerioPropName dalam skrip scriptCheckActiveVpnServer, yang akan dibahas bicara lebih jauh. <br><br>  (Sebenarnya, sebagian besar nama dan komentar objek dalam konfigurasi yang dijelaskan digunakan dalam skrip, jadi mengubah nama mereka dapat menyebabkan Anda merasa tidak nyaman karena perlu membuat perubahan pada kode skrip. Saya akan mencoba membuat catatan yang sesuai dalam teks untuk memudahkan pencarian objek tersebut.) <br><br>  2. / ip grup kebijakan ipsec <br><br>  Pembuatan grup disebabkan oleh fakta bahwa di masa depan kami akan memproses nama mereka (1, 2, ... n) dalam skrip dan menggunakannya untuk memprioritaskan alamat IP dari server Kerio yang akan kami akses. <br><br>  Saya membuat empat grup sekaligus karena  Saya memiliki dua ISP, dengan dua IP eksternal pada masing-masing dari Kerio.  Pada tahap ini, kami hanya menggunakan satu grup sejauh ini. <br><br>  3. / ip ipsec peer <br><br>  Di rekan, tentukan: <br><br><ul><li>  Alamat - Alamat-IP Kerio, yang akan dihubungi dengan MikroTik.  Alamat yang sama yang kita masukkan di / ip ipsec policy sa-dst-address harus ditentukan, hanya dengan mask "/ 32"; </li><li>  Alamat Lokal - Alamat IP MikroTik, dari mana Kerio akan diakses.  Alamat yang sama yang kita masukkan di / ip ipsec policy sa-src-address harus ditentukan; </li><li>  Auth.  Metode - pilih "kunci pra-berbagi" dari daftar; </li><li>  Exchange Mode - pilih main-l2tp dari daftar; </li><li>  Jika diatur, hapus centang pada kotak "Pasif"; </li><li>  Rahasia - masukkan frasa sandi yang kami masukkan ketika kami mengkonfigurasi antarmuka VPN pada Kerio, pada tab "Otentikasi", di bidang "Kunci yang ditentukan sebelumnya:"; </li><li>  Grup Template Kebijakan - pilih dari daftar grup yang kami buat sebelumnya dengan nama "1"; </li><li>  Hapus centang NAT Traversal; </li><li>  My ID Type - pilih nilai "fqdn" dari daftar; </li><li>  ID saya - masukkan FQDN yang diberikan oleh MikroTik di DDNS; </li><li>  Pada tab "Enkripsi", pilih parameter enkripsi yang kami masukkan ketika kami mengkonfigurasi antarmuka VPN di Kerio, pada tab "Otentikasi", di bidang "Fase 1 (IKE) Cipher:"; </li><li>  Komentar ( <b>Peringatan! Digunakan dalam skrip!</b> ). </li></ul><br>  Dalam komentar, saya menunjukkan FQDN teknis lengkap dari server saya, yang diterbitkan pada server DNS yang melayani zona luar saya. <br><br>  Selain menggunakan konfigurasi ini, ini memungkinkan saya untuk menjaga informasi terkini tentang alamat IP eksternal dari server Kerio yang digunakan (Saya hanya perlu mengubah alamat IP pada server DNS eksternal dan secara otomatis akan diubah menjadi MikroTik (artikel di <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a></b> )). <br><br>  Bagi mereka yang terlalu malas untuk mengerti, saya kutip kode kerjanya: <br><br><pre> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptSetIPSecSADstAddrFromDNS owner=\ admin policy=read,write</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Script listing scriptSetIPSecSADstAddrFromDNS</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">:if ([:len [/system script job find script=SetIPSecSADstAddrFromDNS]]&gt;1) do={ :error } :local DnsNameFromComment :local ResolvedIpFromComment :local ResolvedIpWithMaskFromComment :local IpPeerAddr :foreach IpSecPeerCount in=[/ip ipsec peer find] do={ :set DnsNameFromComment [/ip ipsec peer get $IpSecPeerCount comment] :if ($DnsNameFromComment!="") do={ :do { :set ResolvedIpFromComment [:resolve $DnsNameFromComment] :set ResolvedIpWithMaskFromComment ($ResolvedIpFromComment . "/32") :set IpPeerAddr [/ip ipsec peer get $IpSecPeerCount address] :if ($ResolvedIpWithMaskFromComment!=$IpPeerAddr) do={ :log warning ("[SetIPSecSADstAddrFromDNS]     " . DnsNameFromComment . "  IP-  " . $IpPeerAddr . "  " . $ResolvedIpFromComment) #:log warning ("[SetIPSecSADstAddrFromDNS] In the peer to the server " . DnsNameFromComment . " changed IP address from " . $IpPeerAddr . " on " . $ResolvedIpFromComment) /ip ipsec peer set $IpSecPeerCount address=$ResolvedIpWithMaskFromComment } } on-error={ :set ResolvedIpFromComment "unknown" :log error ("[SetIPSecSADstAddrFromDNS]     " . $DnsNameFromComment) #:log error ("[SetIPSecSADstAddrFromDNS] Cant resolve name " . $DnsNameFromComment) } } } :log warning ("[SetIPSecSADstAddrFromDNS]  IP- VPN- ") #:log warning ("[SetIPSecSADstAddrFromDNS] The IP-addresses of the VPN-servers are checked")</code> </pre><br></div></div><br>  <b>Aturan dasar yang berlaku untuk komentar di rekan</b> adalah bahwa nama harus dimulai dengan huruf dan / atau angka apa pun, tanpa spasi, diikuti oleh <b>tanda hubung WAJIB</b> ("-"), diikuti oleh sejumlah karakter sewenang-wenang. <br><br>  Saya menggunakan format berikut: <br><br>  vsNN-pNN-NN.domain.ru <br><br>  Dimana: <br><br>  vsNN - vpn-server #NN (Bagian dari komentar ini diproses dalam skrip dan digunakan dalam IP ---&gt; Firewall ---&gt; Daftar Alamat (lihat di bawah)); <br>  pNN - ISP #NN; <br>  NN - nomor seri dari alamat IP eksternal dalam kumpulan alamat yang dikeluarkan kepada saya oleh penyedia di Kerio; <br><br>  4. / ip kebijakan IPSec <br><br>  Dalam politik, kami mendefinisikan: <br><br><ul><li>  Dst.  Alamat - alamat jaringan di belakang Kerio (alamat-dst); </li><li>  Src.  Alamat - alamat jaringan yang akan ditutup oleh MikroTik (lihat pengaturan IP ---&gt; Firewall ---&gt; NAT di bawah) jaringan lokalnya (src-address).  Alamat jaringan ini akan terlihat dari sisi Kerio (kami tentukan ketika kami mengkonfigurasi antarmuka VPN pada Kerio, pada tab Remote Networks); </li><li>  Protokol - 255 (semua); </li><li>  Aksi - mengenkripsi; </li><li>  Level - membutuhkan; </li><li>  Protokol IPSec - esp; </li><li>  atur parameter tunnel = yes; </li><li>  SA Src.  Address - Alamat IP eksternal MikroTik, dari mana Kerio akan diakses (sa-src-address); </li><li>  SA Dst.  Alamat - alamat IP Kerio, di mana MikroTik akan dihubungi (sa-dst-address); </li><li>  Proposal - Masukkan nilai yang ditetapkan ke parameter nama di bagian / ip proposal ipsec (dalam konfigurasi ini - KerioVPNProposal # 01); </li><li>  Komentar ( <b>Peringatan! Digunakan dalam skrip!</b> ) - KerioVPNPolicy. </li></ul><br>  Jika semuanya dilakukan dengan benar, maka setelah menyimpan kebijakan, nilai "didirikan" akan muncul di bidang "PH2 State", yang menunjukkan pemasangan saluran VPN antara MikroTik dan Kerio. <br>  Anda dapat memverifikasi ini dengan memeriksa status antarmuka VPN di Kerio Control.  Di sana, di bidang "Informasi", di seberang antarmuka tempat koneksi dibuat, tulisan "Koneksi ke IP_your_MikroTik dibuat" akan muncul. <br><br>  Kami melanjutkan ... <br><br>  Sekarang kita akan membuat rekan-rekan untuk semua alamat IP yang tersisa dari Kerio-server (dalam konfigurasi saya perlu membuat tiga rekan lainnya). <br><br>  Untuk melakukan ini, kita perlu mengulangi semua langkah yang ditunjukkan dalam ayat 3 (/ ip ipsec peer), tetapi perhatikan perubahan berikut: <br><br><ul><li>  Alamat - ubah alamat IP Kerio; </li><li>  Rahasia - masukkan frasa sandi yang terkait dengan koneksi yang sedang dibuat (pass2222, pass3333, ... passNNNN); </li><li>  Grup Template Kebijakan - pilih grup berikutnya dalam daftar dari daftar (2, 3, ... n). </li></ul><br>  <b>Catatan:</b> <br><br>  Kemudian Anda dapat mengubah prioritas server Anda kapan saja dengan mengubah grup di pengaturan rekan. <br><br><ul><li>  Komentar - dalam kasus saya ini berubah ke FQDN server Kerio lain. </li></ul><br>  Semua parameter lain dimasukkan sama seperti di pesta pertama.  Yang perlu diubah diproses oleh skrip dan Anda dapat menyalinnya tidak berubah untuk saat ini. <br><br>  Langkah terakhir mengkonfigurasi sebelum menghubungkan skrip ke pekerjaan adalah membuat MikroTik berfungsi sebagai repositori konstanta, yang akan kita gunakan dalam skrip ... <br>  Tambahkan dua daftar ke Daftar Alamat Firewall ( <b>Peringatan! Digunakan dalam skrip!</b> ): <br><br><pre> <code class="plaintext hljs">/ip firewall address-list add address=192.168.22.0/24 list=vs01 add address=192.168.33.0/24 list=vs02</code> </pre> <br>  di dalamnya kami menunjukkan alamat jaringan dengan mengacu pada awalan nama server Kerio, di mana kami akan memetakan lalu lintas VPN keluar. <br><br>  Nah, untuk mengotomatiskan pekerjaan semua aib ini, kami menambahkan dua skrip dan tiga jadwal <b>(jika Anda memutuskan untuk mengganti nama skrip, jangan lupa untuk membuat perubahan yang sesuai pada kode)</b> . <br><br><pre> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptFunctionsList owner=admin policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Daftar Script scriptFunctionsList</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">#   IP --&gt; Cloud   DNS- #  : # # $start (true/false); # #  ""  "updated" :global subUpdateCloudDns do={ put ($start); :if ($start=false) do={ set $CloudDnsStatus; #     set $m 1; log warning ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt;  "); #log warning ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; CHECK STARTED"); do { log warning ("[subUpdateCloudDns] ---&gt; DDNS ,  ---&gt; " . $m); [/ip cloud force-update]; delay 30000ms; set $CloudDnsStatus ([/ip cloud get status]); set $m ($m+1); :if ($CloudDnsStatus="updated") do={ log warning ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt; " . $CloudDnsStatus); #log warning ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; " . $CloudDnsStatus); } else={ log error ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt; " . $CloudDnsStatus); #log error ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; " . $CloudDnsStatus); } } while=(($CloudDnsStatus!="updated") and ($m&lt;10)); return ($CloudDnsStatus); } } #    IP --&gt; Cloud #   : # # 0 - ; # 1 - ,   ; # 2 -    :global subCheckCloudDDNS do={ set $CloudDnsActive ([/ip cloud get ddns-enabled]); #  - ( $m=0 ) set $m 0; :if ($CloudDnsActive=yes) do { #  IP---&gt;Cloud  ( $m=1 ) set $m ($m+1); set $CloudDnsStatus ([/ip cloud get status]); #    IP- (  IP---&gt;Cloud    DNS) set $CloudDnsIP ([/ip cloud get public-address]); set $CheckIpAddr ([resolve [/ip cloud get dns-name]]); :if ($CloudDnsIP!=$CheckIpAddr) do={ #  IP  (  MikroTik  )... set $CloudDnsStatus "updating..."; } :if ($CloudDnsStatus="updated") do { #  IP---&gt;Cloud    ( $m=2 ) set $m ($m+1); } } return ($m); } #       #  : # # $ScriptName ( ) :global subRepeatScript do={ put ($ScriptName); :if ($ScriptName!="") do { [/system script run $ScriptName]; } } #     VPN-   # #   IP- VPN-     :global subGetVpnServers do={ #    IP- VPN-        :foreach IpSecPeerId in=[/ip ipsec peer find passive!=yes] do={ set $CheckIpAddr [/ip ipsec peer get $IpSecPeerId address]; :if ($CheckIpAddr!="") do={ set $MaskPos [find $CheckIpAddr "/"]; set $GroupFromPeer ([/ip ipsec peer get $IpSecPeerId policy-template-group]); set $IpFromPeer ([pick $CheckIpAddr 0 $MaskPos]); set $VpnServersList ($VpnServersList, {{$GroupFromPeer; $IpFromPeer}}); } } return ($VpnServersList); } #        # #    ID   :global subDisableIpSecPeers do={ # ...  ,  (passive=false) ... :foreach IpSecPeerId in=[/ip ipsec peer find passive!=yes] do={ log warning ("[IP IPSec Peer] ---&gt;    ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment]); #log warning ("[IP IPSec Peer] ---&gt; processed peer on ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment]); #  address   ... set $CheckIpAddr [/ip ipsec peer get $IpSecPeerId address]; :if ($CheckIpAddr!="") do={ #  address  ,  IP-  ... set $MaskPos ([find $CheckIpAddr "/"]); set $CheckIpAddr ([pick $CheckIpAddr 0 $MaskPos]); # ...   IPSec- :foreach IpSecPolicyId in=[/ip ipsec policy find sa-dst-address=$CheckIpAddr] do={ :if ($IpSecPolicyId!="") do={ :if ([/ip ipsec policy get $IpSecPolicyId disabled]!=yes) do={ [/ip ipsec policy disable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  " . [/ip ipsec policy get $IpSecPolicyId comment] . " "); #log warning ("[IP IPSec Policy] ---&gt; policy " . [/ip ipsec policy get $IpSecPolicyId comment] . " deactivated"); } #    ID     set $IdList ($IdList, $IpSecPolicyId); } } } # :     ,      :if ([/ip ipsec peer get $IpSecPeerId disabled]!=yes) do={ [/ip ipsec peer disable $IpSecPeerId]; log warning ("[IP IPSec Peer] ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment] . " ---&gt; "); #log warning ("[IP IPSec Peer] ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment] . " ---&gt; deactivated"); } } return ($IdList); } #        #  : # # $PeerID (ID   VPN-); # $PolIdList ( ID  $subDisableIpSecPeers); # $CloudIP (IP MikroTik  DDNS); # $SrcIP (src-address    VPN-) :global subEnableIpSecPeers do={ put ($PeerID); put ($PolIdList); put ($CloudIP); :if (($PeerID!="")&amp;&amp;($PeerID!=nil)&amp;&amp;($PolIdList!="")&amp;&amp;($PolIdList!=nil)&amp;&amp;($CloudIP!="")&amp;&amp;($CloudIP!=nil)) do={ #   VPN- set $ActiveVPN [/ip ipsec peer get $PeerID address]; :if ($ActiveVPN!="") do={ #  ,  IP-   set $MaskPos [find $ActiveVPN "/"]; set $ActiveVPN ([pick $ActiveVPN 0 $MaskPos]); } #   ,      :if ([/ip ipsec peer get $PeerID disabled]=yes) do={ delay 5000ms; [/ip ipsec peer enable $PeerID]; log warning ("[IP IPSec Peer] ---&gt;  peer  ---&gt; " . [/ip ipsec peer get $PeerID address]); #log warning ("[IP IPSec Peer] ---&gt; activated peer on ---&gt; " . [/ip ipsec peer get $PeerID address]); } #    ID   PolIdList, ,    Src. Address, SA Src. Address  SA Dst. Address,   :foreach IpSecPolicyId in=$PolIdList do={ :if ($IpSecPolicyId!="") do={ :if ([/ip ipsec policy get $IpSecPolicyId src-address]!=$SrcIP) do={ [/ip ipsec policy set $IpSecPolicyId src-address=$SrcIP]; log warning ("[IP IPSec Policy] ---&gt;  src-address"); #log warning ("[IP IPSec Policy] ---&gt; src-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId sa-src-address]!=$CloudIP) do={ [/ip ipsec policy set $IpSecPolicyId sa-src-address=$CloudIP]; log warning ("[IP IPSec Policy] ---&gt;  sa-src-address"); #log warning ("[IP IPSec Policy] ---&gt; sa-src-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId sa-dst-address]!=$ActiveVPN) do={ [/ip ipsec policy set $IpSecPolicyId sa-dst-address=$ActiveVPN]; log warning ("[IP IPSec Policy] ---&gt;  sa-dst-address"); #log warning ("[IP IPSec Policy] ---&gt; sa-dst-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId disabled]=yes) do={ delay 3000ms; [/ip ipsec policy enable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy activated"); #  DNS- [/ip dns cache flush] } } } } } #      ID  #  : # # $PeerIP (IP    ); # $CloudIP (IP MikroTik  DDNS); # $action (enable/disable/skip) # #    ID,   ,  :global subGetPoliciesByPeer do={ put ($PeerIP); put ($CloudIP); put ($action); :if (($action="")||($action=nil)) do={ set $action "skip"; } :foreach IpSecPolicyId in=[/ip ipsec policy find sa-dst-address=$PeerIP] do={ :if ($IpSecPolicyId!="") do={ #     $action=disable,   :if (([/ip ipsec policy get $IpSecPolicyId disabled]!=yes)&amp;&amp;($action="disable")) do={ [/ip ipsec policy disable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy deactivated"); } #     $CloudIP  sa-src-address!=$CloudIP ( ISP),     sa-src-address :if (($CloudIP!="")&amp;&amp;($CloudIP!=nil)&amp;&amp;([/ip ipsec policy get $IpSecPolicyId sa-src-address]!=$CloudIP)) do={ [/ip ipsec policy disable $IpSecPolicyId]; [/ip ipsec policy set $IpSecPolicyId sa-src-address=$CloudIP]; log warning ("[IP IPSec Policy] ---&gt;   ---&gt;  sa-src-address ---&gt; " . $CloudIP); #log warning ("[IP IPSec Policy] ---&gt; policy deactivated ---&gt; new sa-src-address ---&gt; " . $CloudIP); #   ,  Kerio   delay 30000ms; } #     $action=enable,   :if (([/ip ipsec policy get $IpSecPolicyId disabled]=yes)&amp;&amp;($action="enable")) do={ [/ip ipsec policy enable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy activated"); #  DNS- [/ip dns cache flush] } #    ID     set $IdList ($IdList, $IpSecPolicyId); } } return ($IdList); } #   local-address  #  : # # $PeerID (ID   VPN-); # $CloudIP (IP MikroTik  DDNS) :global subCheckPeerLocalIp do={ put ($PeerID); put ($CloudIP); :if (($PeerID!="")&amp;&amp;($PeerID!=nil)&amp;&amp;($CloudIP!="")&amp;&amp;($CloudIP!=nil)) do={ #   DDNS-IP :if ([/ip ipsec peer get $PeerID local-address]!=$CloudIP) do={ [/ip ipsec peer set $PeerID local-address=$CloudIP]; log warning ("[IP IPSec Peer] ---&gt;  local-address"); #log warning ("[IP IPSec Peer] ---&gt; local-address changed"); } } }</code> </pre> <br></div></div><br><pre> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptCheckActiveVpnServer owner=admin policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon</code> </pre><br><div class="spoiler"> <b class="spoiler_title">  scriptCheckActiveVpnServer</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">:if ([:len [/system script job find script=scriptCheckActiveVpnServer]]&gt;1) do={ :error } #      scheduleStartup #   ,       :global subCheckCloudDDNS :global subCheckPeerLocalIp :global subDisableIpSecPeers :global subEnableIpSecPeers :global subGetPoliciesByPeer :global subGetVpnServers :global subUpdateCloudDns :local CheckIP :local CheckPeer #     DDNS ( ) :local CloudDnsStatus ([:put [$subCheckCloudDDNS]]) :local Exit false :local DefMikroTikSrcNet 192.168.11.0/24 :local DefKerioDstNet 192.168.77.0/24 :local DefKerioPropName KerioVPNProposal#01 :local DefKerioPolName KerioVPNPolicy :local IpSecPolicyId :local KerioName :local KerioVpnNatRuleName KerioVpnNatOut :local m :local n 1 :local PeerCount 0 :local PeerDisabled :local PingCount 3 :local PingResult :local PoliciesList :local PublicIp :local VpnServersList #   DDNS ,  ,    IP- MikroTik :if ($CloudDnsStatus=0) do={ #  Cloud DDNS  ,         :log error ("[schedule CheckActiveVpnServer] ---&gt;    VPN-   Cloud DDNS! (IP -&gt; Cloud)") # :log error ("[schedule CheckActiveVpnServer] ---&gt; to connect to the VPN server, you need to activate Cloud DDNS! (IP -&gt; Cloud)") :error } :if ($CloudDnsStatus=1) do={ #  Cloud DDNS ,   ,   ( ) :set CloudDnsStatus [:put [$subUpdateCloudDns start=false]] :if ($CloudDnsStatus="updated") do={ :set CloudDnsStatus 2 } } :if ($CloudDnsStatus=2) do { #  Cloud DDNS    ... #  IP  DDNS :set PublicIp [/ip cloud get public-address] #   VPN-  ,    ( ) :set VpnServersList ([:put [$subGetVpnServers]]) #     :foreach VpnIpId in=$VpnServersList do={ :set PeerCount ($PeerCount+1) } #   VPN-    DDNS-IP ( ,   VPN-    ) :while (($Exit!=true)&amp;&amp;$n&lt;=$PeerCount) do={ :foreach VpnIpId in=$VpnServersList do={ #  IP- VPN-    :if (($VpnIpId-&gt;0)=$n) do={ :set CheckIP ($VpnIpId-&gt;1) :if ($CheckIP!="") do={ #    IP :set PingResult ([:put [/ping address=$CheckIP count=$PingCount src-address=$PublicIp]]) :if ($PingResult=$PingCount) do={ :log warning ("[schedule CheckActiveVpnServer] ---&gt; DDNS-IP ---&gt; " . $PublicIp . " ---&gt; VPN-IP ---&gt; " . $CheckIP . " ---&gt; Ping Result ---&gt; " . $PingResult) #  IP ,     IP- :set CheckPeer (:put [/ip ipsec peer find address=($CheckIP . "/32")]) :if ($CheckPeer!="") do={ #   ,     src- (IP ---&gt; Firewall ---&gt; Address Lists),     Kerio #    Kerio    :set KerioName [/ip ipsec peer get $CheckPeer comment] #    (  ,  FQDN  Kerio   KerioName-Parameter1-...-Parameter_n :if ($KerioName!="") do={ #    :set m ([find $KerioName "-"]) #  KerioName    :set KerioName ([pick $KerioName 0 $m]) #    Firewall -&gt; Address List (       : # Name ---&gt; KerioName (eg srv1) # Address ---&gt; DefMikroTikSrcNet (eg 192.168.99.0/24)) :set m [/ip firewall address-list find list=$KerioName] :set DefMikroTikSrcNet ([/ip firewall address-list get $m address]) } # ...          Kerio :set IpSecPolicyId (:put [/ip ipsec policy find comment="$DefKerioPolName"]) #      ,       # (    )         :if ($IpSecPolicyId="") do={ [/ip ipsec policy add disabled=yes dst-address=$DefKerioDstNet proposal=$DefKerioPropName sa-dst-address=$CheckIP sa-src-address=$PublicIp src-address=$DefMikroTikSrcNet tunnel=yes comment=$DefKerioPolName place-before=0] :log warning ("[schedule CheckActiveVpnServer] ---&gt;   " . $DefKerioPolName . " ---&gt;    ") #:log warning ("[schedule CheckActiveVpnServer] ---&gt; created policy " . $DefKerioPolName . " ---&gt; default parameters used") } else={ #   ,     src-address,   . :if ($DefMikroTikSrcNet!=[/ip ipsec policy get $IpSecPolicyId src-address]) do={ [/ip ipsec policy set $IpSecPolicyId src-address=$DefMikroTikSrcNet]; :log warning ("[schedule CheckActiveVpnServer] ---&gt;  " . $DefKerioPolName . "  ---&gt; src-address   ---&gt; " . $DefMikroTikSrcNet) #:log warning ("[schedule CheckActiveVpnServer] ---&gt; policy " . $DefKerioPolName . " changed ---&gt; src-address changed to ---&gt; " . $DefMikroTikSrcNet) } } #   :set m #  NAT-      Kerio  :set m [/ip firewall nat find comment=$KerioVpnNatRuleName] :if ($m!="") do={ #   src-address   ipsec,       Kerio  :if ([/ip firewall nat get $m to-addresses]!=$DefMikroTikSrcNet) do={ [/ip firewall nat set $m to-addresses $DefMikroTikSrcNet] :log warning ("[IP Firewall NAT] ---&gt;    ---&gt; " . $KerioVpnNatRuleName) #:log warning ("[IP Firewall NAT] ---&gt; netmap rule changed ---&gt; " . $KerioVpnNatRuleName) } } # ... local-address      IP MikroTik,    ( ) :put [$subCheckPeerLocalIp PeerID=$CheckPeer CloudIP=$PublicIp] # ...    :set PeerDisabled ([/ip ipsec peer get $CheckPeer disabled]) :if ($PeerDisabled=true) do={ #   ... #       ( ) :set PoliciesList ([:put [$subDisableIpSecPeers]]) #     VPN-   ( ) :put [$subEnableIpSecPeers PeerID=$CheckPeer PolIdList=$PoliciesList CloudIP=$PublicIp SrcIP=$DefMikroTikSrcNet] } else={ #   ... #      ,    ( ) :set PoliciesList ([:put [$subGetPoliciesByPeer PeerIP=$CheckIP CloudIP=$PublicIp SrcIP=$DefMikroTikSrcNet action="enable"]]) } :set Exit true } } else={ :log error ("[schedule CheckActiveVpnServer] ---&gt; DDNS-IP ---&gt; " . $PublicIp . " ---&gt; VPN-IP ---&gt; " . $CheckIP . " ---&gt; Ping Result ---&gt; " . $PingResult) } } } } :set n ($n+1) } }</code> </pre><br></div></div><br><pre> <code class="plaintext hljs">/system scheduler add interval=1h name=scheduleCheckIPSecSADstAddrFromDNS on-event=\ "/system script run scriptSetIPSecSADstAddrFromDNS" policy=read,write \ start-date=oct/30/2017 start-time=00:10:00 add name=scheduleStartup on-event=":global StartupScript true :global RepeatRun false /system script run scriptFunctionsList" policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon \ start-time=startup add interval=5m name=scheduleCheckActiveVpnServer on-event=\ "/system script run scriptCheckActiveVpnServer" policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon \ start-date=nov/29/2017 start-time=00:00:00</code> </pre><br><div class="spoiler"> <b class="spoiler_title">  scheduleStartup</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">:global StartupScript true :global RepeatRun false /system script run scriptFunctionsList</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">  scheduleCheckIPSecSADstAddrFromDNS</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/system script run scriptSetIPSecSADstAddrFromDNS</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">  scheduleCheckActiveVpnServer</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/system script run scriptCheckActiveVpnServer</code> </pre><br></div></div><br><br> <b> :</b> <br>    MikroTik  DNS- ,   Kerio Control,         MikroTik,   IP ---&gt; DNS ---&gt; Static‚Ä¶ <br><br>   - ! <br><br> ,       ‚Ä¶ <br><br>  Terima kasih atas perhatian anda! <br><br>  ps <br> <b>   :</b> <br><ol><li>   ¬´   ?:¬ª; </li><li>       ; </li><li>  IP- ,   ISP,    ; </li><li>   ¬´ :¬ª; </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id439736/">https://habr.com/ru/post/id439736/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id439726/index.html">Lock-in: benar atau fiksi?</a></li>
<li><a href="../id439728/index.html">Konfigurasikan cadangan dan pemulihan Zimbra OSE yang lengkap dan terpisah tanpa menggunakan Zextras</a></li>
<li><a href="../id439730/index.html">Organisasi peredam melalui kelas standar</a></li>
<li><a href="../id439732/index.html">Lazarus - animasi sederhana menggunakan komponen TImageFragment</a></li>
<li><a href="../id439734/index.html">Menyebarkan Kubernetes di desktop dalam hitungan menit dengan MicroK8s</a></li>
<li><a href="../id439738/index.html">Mencari tombol "Lakukan dengan baik". Zyxel dalam jaringan bisnis kecil dan menengah</a></li>
<li><a href="../id439742/index.html">Masuk ke program Master JetBrains di Universitas ITMO</a></li>
<li><a href="../id439744/index.html">Para peneliti dari MIT merancang "rectenna" yang mengubah sinyal Wi-Fi menjadi listrik</a></li>
<li><a href="../id439746/index.html">Memahami Janji JavaScript</a></li>
<li><a href="../id439748/index.html">Intisari materi menarik untuk pengembang ponsel # 285 (pada 4 - 10 Februari)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>