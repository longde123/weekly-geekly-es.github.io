<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëßüèª üôé üíÜüèø VVVVVV ??? VVVVVV !!! :) üíÖüèΩ üë©üèª‚Äçüè´ üç£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Jika Anda membaca teks ini, Anda mungkin berpikir ada sesuatu yang salah dengan tajuk utama atau Anda telah melihat nama permainan komputer yang akrab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>VVVVVV ??? VVVVVV !!! :)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/484388/">  Jika Anda membaca teks ini, Anda mungkin berpikir ada sesuatu yang salah dengan tajuk utama atau Anda telah melihat nama permainan komputer yang akrab.  VVVVVV adalah game platformer indie yang telah mencuri hati banyak pemain dengan kesederhanaan eksternal yang menyenangkan dan kompleksitas internal yang tidak kalah menyenangkan.  Beberapa hari yang lalu, VVVVVV berusia 10 tahun, dan penulis permainan - Terry Cavanagh - merayakan liburan ini dengan menerbitkan kode sumbernya.  Hal-hal menakjubkan apa yang disembunyikannya?  Baca jawabannya di artikel ini. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0c8/fdf/72a/0c8fdf72ab45ed2077f8ea957e6b7ea5.png" alt="Gambar 1"></div><a name="habracut"></a><br><h2>  Pendahuluan </h2><br>  Oh, VVVVVVV ... Saya ingat pernah melihatnya sesaat setelah dirilis dan menjadi penggemar game retro pixel, saya sangat bersemangat untuk menginstalnya di komputer saya.  Saya ingat kesan pertama saya: "Itu saja?  Hanya berlari di sekitar ruang-ruang persegi? ‚ÄùPikirku setelah beberapa menit bermain.  Saya tidak tahu apa yang menunggu saya saat itu.  Segera setelah saya keluar dari lokasi awal, saya menemukan diri saya di dunia dua dimensi yang kecil tapi membingungkan dan penuh dengan pemandangan yang tidak biasa dan artefak pixel yang tidak saya ketahui. <br><br>  Saya terbawa oleh permainan.  Akhirnya, saya benar-benar mengalahkan permainan meskipun ada beberapa tantangan, seperti kompleksitas tinggi dengan kontrol permainan yang diterapkan dengan terampil, misalnya - karakter utama tidak dapat melompat, tetapi mampu membalikkan arah vektor gravitasi pada dirinya sendiri.  Saya tidak tahu berapa kali karakter saya mati, tetapi saya yakin jumlah kematian diukur dalam puluhan ratusan.  Lagipula, setiap game memiliki semangat uniknya sendiri :) <br><br>  Pokoknya, mari kita kembali ke kode sumber, diposting <a href="http://distractionware.com/blog/2020/01/vvvvvv-is-now-open-source/">untuk menghormati ulang tahun permainan</a> . <br><br>  Saat ini, saya adalah pengembang PVS-Studio, yang merupakan penganalisa kode statis untuk C, C ++, C #, dan Java.  Selain mengembangkan langsung, kami juga terlibat dalam promosi produk kami.  Bagi kami, salah satu cara terbaik untuk melakukan ini adalah menulis artikel tentang memeriksa proyek sumber terbuka.  Pembaca kami mendapatkan artikel menarik tentang topik pemrograman, dan kami mendapat kesempatan untuk menunjukkan kemampuan PVS-Studio.  Jadi ketika saya mendengar tentang pembukaan kode sumber VVVVVV, saya tidak bisa melewatinya. <br><br>  Pada artikel ini, kita akan melihat beberapa kesalahan menarik yang ditemukan oleh alat analisa PVS-Studio dalam kode VVVVVV, dan melihat detail kesalahan ini.  Arahkan vektor gravitasi ke bawah dan buat diri Anda nyaman - kami baru akan memulai! <br><br><h2>  Ikhtisar Peringatan Analyzer </h2><br><h3>  Peringatan 1 </h3><br>  <a href="https://www.viva64.com/en/w/v512/">V512</a> Panggilan fungsi 'sprintf' akan menyebabkan meluapnya buffer 'fileSearch'.  FileSystemUtils.cpp 307 <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_PATH 260 .... void PLATFORM_migrateSaveData(char *output) { char oldLocation[MAX_PATH]; char newLocation[MAX_PATH]; char oldDirectory[MAX_PATH]; char fileSearch[MAX_PATH]; .... </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Same place, different layout. */</span></span></span><span class="hljs-meta"> strcpy(oldDirectory, output); sprintf(fileSearch, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s\\*.vvvvvv"</span></span></span><span class="hljs-meta">, oldDirectory); .... }</span></span></code> </pre> <br>  Seperti yang Anda lihat, string <i>fileSearch</i> dan <i>oldDirectory</i> berukuran sama: 260 karakter.  Setelah menulis konten string <i>oldDirectory</i> dalam string format (argumen <i>sprintf</i> ketiga), akan terlihat seperti: <br><pre> <code class="cpp hljs">&lt;i&gt;contents_oldDirectory\*.vvvvvv&lt;/i&gt;</code> </pre> <br>  Baris ini lebih panjang 9 karakter dari nilai asli <i>oldDirectory</i> .  Urutan karakter inilah yang akan ditulis dalam <i>fileSearch</i> .  Apa yang terjadi jika panjang string <i>oldDirectory</i> lebih dari 251?  String yang dihasilkan akan lebih panjang dari yang bisa ditemukan oleh <i>fileSearch</i> , yang akan menyebabkan pelanggaran batas array.  Data apa dalam RAM yang dapat rusak dan apa akibatnya adalah masalah retoris :) <br><br><h3>  Peringatan 2 </h3><br>  <a href="https://www.viva64.com/en/w/v519/">V519 Variabel</a> 'latar belakang' diberi nilai dua kali berturut-turut.  Mungkin ini sebuah kesalahan.  Periksa baris: 1367, 1373. Map.cpp 1373 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> mapclass::loadlevel(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-comment"><span class="hljs-comment">//The Warpzone tmap = warplevel.loadlevel(rx, ry, game, obj); fillcontent(tmap); roomname = warplevel.roomname; tileset = 1; background = 3; // &lt;= dwgfx.rcol = warplevel.rcol; dwgfx.backgrounddrawn = false; warpx = warplevel.warpx; warpy = warplevel.warpy; background = 5; // &lt;= if (warpy) background = 4; if (warpx) background = 3; if (warpx &amp;&amp; warpy) background = 5; break; .... }</span></span></code> </pre> <br>  Variabel yang sama diberikan nilai dua kali berturut-turut.  Namun, variabel ini tidak digunakan di antara penugasan.  Yang aneh ... Urutan ini mungkin tidak melanggar logika program, tetapi penugasan itu sendiri menunjukkan beberapa kebingungan saat menulis kode.  Apakah ini kesalahan sebenarnya - hanya penulis yang bisa mengatakannya dengan pasti.  Meskipun ada contoh yang lebih jelas dari kesalahan ini dalam kode: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Game::loadquick(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"frames"</span></span>) { frames = atoi(pText); frames = <span class="hljs-number"><span class="hljs-number">0</span></span>; } .... }</code> </pre> <br>  Dalam kasus ini, jelas bahwa kesalahan bersembunyi di suatu tempat baik dalam logika atau dalam tugas yang berlebihan.  Mungkin, baris kedua ditulis sementara untuk debugging, dan kemudian dibiarkan terlupakan.  Secara total, PVS-Studio mengeluarkan 8 peringatan tentang kasus tersebut. <br><br><h3>  Peringatan 3 </h3><br>  Objek 'pKey' V808 dari tipe 'basic_string' telah dibuat tetapi tidak digunakan.  editor.cpp 1866 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> editorclass::load(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp;_path) { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pElem-&gt;Value())</span></span></span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"edEntities"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (TiXmlElement *edEntityEl = pElem-&gt;FirstChildElement(); edEntityEl; edEntityEl = edEntityEl-&gt;NextSiblingElement()) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(edEntityEl-&gt;Value())</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= //const char* pText = edEntityEl-&gt;GetText() ; if (edEntityEl-&gt;GetText() != NULL) { edentity[i].scriptname = std::string(edEntityEl-&gt;GetText()); } edEntityEl-&gt;QueryIntAttribute("x", &amp;edentity[i].x); edEntityEl-&gt;QueryIntAttribute("y", &amp;edentity[i].y); edEntityEl-&gt;QueryIntAttribute("t", &amp;edentity[i].t); edEntityEl-&gt;QueryIntAttribute("p1", &amp;edentity[i].p1); edEntityEl-&gt;QueryIntAttribute("p2", &amp;edentity[i].p2); edEntityEl-&gt;QueryIntAttribute("p3", &amp;edentity[i].p3); edEntityEl-&gt;QueryIntAttribute("p4", &amp;edentity[i].p4); edEntityEl-&gt;QueryIntAttribute("p5", &amp;edentity[i].p5); edEntityEl-&gt;QueryIntAttribute("p6", &amp;edentity[i].p6); i++; } EditorData::GetInstance().numedentities = i; } .... }</span></span></code> </pre> <br>  Kode ini sangat aneh.  Penganalisa memperingatkan tentang variabel <i>pKey yang</i> dibuat tetapi tidak digunakan, tetapi pada kenyataannya, masalahnya lebih menarik.  Saya sengaja menyoroti garis yang memicu peringatan dengan panah, karena fungsi ini berisi lebih dari satu definisi string dengan nama <i>pKey</i> .  Itu benar, variabel lain seperti itu dinyatakan di dalam <i>for</i> loop.  Ini tumpang tindih dengan yang dinyatakan di luar loop. <br><br>  Jadi, jika Anda merujuk pada nilai string <i>pKey di</i> luar <i>for</i> loop, Anda akan mendapatkan nilai yang sama dengan <i>pElem-&gt; Value ()</i> , tetapi ketika melakukan hal yang sama di dalam loop, Anda akan mendapatkan nilai yang sama dengan <i>edEntityEl -&gt; Nilai ()</i> .  Nama yang tumpang tindih adalah kesalahan yang agak kasar, yang mungkin sangat sulit ditemukan sendiri saat Anda meninjau kode. <br><br><h3>  Peringatan 4 </h3><br>  <a href="https://www.viva64.com/en/w/v805/">V805</a> Menurunkan Kinerja.  Tidak efisien untuk mengidentifikasi string kosong dengan menggunakan konstruksi 'strlen (str)&gt; 0'.  Cara yang lebih efisien adalah dengan memeriksa: str [0]! = '\ 0'.  physfs.c 1604 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *prefDir = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PHYSFS_getPrefDir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *org, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *app)</span></span></span><span class="hljs-function"> </span></span>{ .... assert(<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(prefDir) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prefDir; } <span class="hljs-comment"><span class="hljs-comment">/* PHYSFS_getPrefDir */</span></span></code> </pre> <br>  Penganalisa menemukan sebuah fragmen untuk optimasi mikro potensial.  Ini menggunakan fungsi <i>strlen</i> untuk memeriksa apakah string kosong.  Fungsi ini melintasi semua elemen string dan memeriksa masing-masingnya untuk null-terminator ('\ 0').  Jika kita mendapatkan string panjang, masing-masing karakter akan dibandingkan dengan null-terminator. <br><br>  Tapi kita hanya perlu memeriksa bahwa string kosong!  Yang perlu Anda lakukan adalah mencari tahu apakah karakter string pertama adalah null terminal.  Oleh karena itu, untuk mengoptimalkan pemeriksaan ini di dalam pernyataan, ada baiknya menulis: <br><br><pre> <code class="cpp hljs">str[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'\0'</span></span></code> </pre> <br>  Itulah rekomendasi yang diberikan oleh analis.  Tentu, panggilan fungsi strlen dalam kondisi makro yang <i>tegas</i> , oleh karena itu hanya akan dijalankan dalam versi debugging, di mana kecepatannya tidak begitu penting.  Dalam versi rilis, panggilan fungsi dan kode akan dieksekusi dengan cepat.  Meskipun demikian, saya ingin menunjukkan apa yang dapat disarankan oleh analis kami dalam hal optimasi mikro. <br><br><h3>  Peringatan 5 </h3><br>  Untuk menunjukkan inti dari kesalahan lain, saya harus mengutip dua fragmen kode di sini: deklarasi kelas <i>entclass</i> dan konstruktornya.  Mari kita mulai dengan deklarasi: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">entclass</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: entclass(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clear</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">outside</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-comment"><span class="hljs-comment">//Fundamentals bool active, invis; int type, size, tile, rule; int state, statedelay; int behave, animate; float para; int life, colour; //Position and velocity int oldxp, oldyp; float ax, ay, vx, vy; int cx, cy, w, h; float newxp, newyp; bool isplatform; int x1, y1, x2, y2; //Collision Rules int onentity; bool harmful; int onwall, onxwall, onywall; //Platforming specific bool jumping; bool gravity; int onground, onroof; int jumpframe; //Animation int framedelay, drawframe, walkingframe, dir, actionframe; int yp; int xp; };</span></span></code> </pre> <br>  Konstruktor kelas ini terlihat sebagai berikut: <br><br><pre> <code class="cpp hljs">entclass::entclass() { clear(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> entclass::clear() { <span class="hljs-comment"><span class="hljs-comment">// Set all values to a default, // required for creating a new entity active = false; invis = false; type = 0; size = 0; tile = 0; rule = 0; state = 0; statedelay = 0; life = 0; colour = 0; para = 0; behave = 0; animate = 0; xp = 0; yp = 0; ax = 0; ay = 0; vx = 0; vy = 0; w = 16; h = 16; cx = 0; cy = 0; newxp = 0; newyp = 0; x1 = 0; y1 = 0; x2 = 320; y2 = 240; jumping = false; gravity = false; onground = 0; onroof = 0; jumpframe = 0; onentity = 0; harmful = false; onwall = 0; onxwall = 0; onywall = 0; isplatform = false; framedelay = 0; drawframe = 0; walkingframe = 0; dir = 0; actionframe = 0; }</span></span></code> </pre> <br>  Cukup banyak bidang, bukan begitu?  Tidak heran, PVS-Studio mengeluarkan peringatan untuk bug, bersembunyi di sini: <br><br>  <a href="https://www.viva64.com/en/w/v730/">V730</a> Ada kemungkinan bahwa tidak semua anggota kelas diinisialisasi di dalam konstruktor.  Pertimbangkan untuk memeriksa: oldxp, oldyp.  Ent.cpp 3 <br><br>  Seperti yang Anda lihat, inisialisasi dua bidang kelas hilang dalam daftar yang begitu panjang.  Akibatnya, nilai-nilai mereka tetap tidak terdefinisi, sehingga nilai-nilai tersebut dapat dibaca dan digunakan secara salah di tempat lain dalam program.  Sangat sulit untuk mendeteksi kesalahan seperti itu hanya dengan meninjau. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/983/5f3/1be/9835f31be343f47654d9dd80fc159472.png" alt="Gambar 4"></div><br><br><h3>  Peringatan 6 </h3><br>  Lihatlah kode ini: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> mapclass::loadlevel(....) { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; tmap; .... tmap = otherlevel.loadlevel(rx, ry, game, obj); fillcontent(tmap); .... <span class="hljs-comment"><span class="hljs-comment">// The tmap vector gets changed again many times. }</span></span></code> </pre> <br>  Peringatan PVS-Studio: <a href="https://www.viva64.com/en/w/v688/">V688</a> Variabel lokal 'tmap' memiliki nama yang sama dengan salah satu anggota kelas, yang dapat mengakibatkan kebingungan.  Map.cpp 1192 <br><br>  Memang, melihat ke dalam kelas <i>mapclass</i> , Anda dapat menemukan vektor yang sama dengan nama yang sama di sana: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mapclass</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; roomdeaths; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; roomdeathsfinal; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; areamap; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; contents; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; explored; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; vmult; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; tmap; <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... };</span></span></code> </pre> <br>  Sayangnya, deklarasi vektor nama yang sama di dalam fungsi membuat vektor yang dinyatakan dalam kelas tidak terlihat.  Ternyata vektor <i>tmap</i> hanya diubah di dalam fungsi <i>loadlevel</i> .  Vektor yang dideklarasikan di kelas tetap sama! <br><br>  Menariknya, PVS-Studio telah menemukan 20 fragmen kode seperti itu!  Sebagian besar, mereka berhubungan dengan variabel sementara yang telah dinyatakan "untuk kenyamanan" sebagai anggota kelas.  Penulis game (dan satu-satunya pengembangnya) menulis tentang dirinya sendiri yang dulunya memiliki kebiasaan buruk ini.  Anda dapat membacanya di pos - tautan diberikan di awal artikel. <br><br>  Dia juga mencatat bahwa nama-nama tersebut menyebabkan bug berbahaya yang sulit dideteksi.  Yah, kesalahan seperti itu mungkin sangat merusak, tetapi menangkapnya menjadi lebih sulit jika Anda menggunakan analisis statis :) <br><br><h3>  Peringatan 7 </h3><br>  <a href="https://www.viva64.com/en/w/v601/">V601</a> Tipe integer secara implisit dilemparkan ke tipe char.  Game.cpp 4997 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Game::loadquick(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"totalflips"</span></span>) { totalflips = atoi(pText); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"hardestroom"</span></span>) { hardestroom = atoi(pText); <span class="hljs-comment"><span class="hljs-comment">// &lt;= } else if (pKey == "hardestroomdeaths") { hardestroomdeaths = atoi(pText); } .... }</span></span></code> </pre> <br>  Untuk memahami apa yang terjadi, mari kita lihat definisi variabel dari bagian kode yang diberikan: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//Some stats: int totalflips; std::string hardestroom; int hardestroomdeaths;</span></span></code> </pre> <br>  variabel <i>totalflips</i> dan <i>hardestroomdeath</i> adalah integer, jadi sangat normal untuk menetapkannya sebagai hasil dari fungsi <i>atoi</i> .  Tetapi apa yang terjadi jika Anda menetapkan nilai integer ke <i>std :: string</i> ?  Penugasan semacam itu ternyata valid dari perspektif bahasa.  Akibatnya, nilai yang tidak jelas akan ditulis dalam variabel <i>hardestroom</i> ! <br><br><h3>  Peringatan 8 </h3><br>  <a href="https://www.viva64.com/en/w/v1004/">V1004 Pointer</a> 'pElem' digunakan dengan tidak aman setelah diverifikasi terhadap nullptr.  Periksa baris: 1739, 1744. editor.cpp 1744 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> editorclass::load(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp;_path) { .... <span class="hljs-function"><span class="hljs-function">TiXmlHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hDoc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;doc)</span></span></span></span>; TiXmlElement *pElem; <span class="hljs-function"><span class="hljs-function">TiXmlHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; version = <span class="hljs-number"><span class="hljs-number">0</span></span>; { pElem = hDoc.FirstChildElement().Element(); <span class="hljs-comment"><span class="hljs-comment">// should always have a valid root // but handle gracefully if it does if (!pElem) { printf("No valid root! Corrupt level file?\n"); } pElem-&gt;QueryIntAttribute("version", &amp;version); // &lt;= // save this for later hRoot = TiXmlHandle(pElem); } .... }</span></span></code> </pre> <br>  Penganalisa memperingatkan bahwa pointer <i>pElem</i> tidak aman digunakan tepat setelah memeriksa <i>nullptr</i> .  Untuk memastikan penganalisisnya benar, mari kita periksa definisi fungsi <i>Element ()</i> yang mengembalikan nilai yang, pada gilirannya, menginisialisasi <i>poer</i> pElem: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** @deprecated use ToElement. Return the handle as a TiXmlElement. This may return null. */</span></span> <span class="hljs-function"><span class="hljs-function">TiXmlElement *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Element</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ToElement(); }</code> </pre> <br>  Seperti yang dapat kita lihat dari komentar, fungsi ini mungkin mengembalikan <i>nol</i> . <br><br>  Sekarang bayangkan itu benar-benar terjadi.  Apa yang akan terjadi dalam kasus ini?  Faktanya adalah bahwa situasi ini tidak akan ditangani dengan cara apa pun.  Ya, akan ada pesan bahwa ada yang tidak beres, tetapi penunjuk yang salah akan disangkal hanya satu baris di bawah ini.  Dereferencing seperti itu akan mengakibatkan crash program atau perilaku yang tidak terdefinisi.  Ini adalah kesalahan yang cukup serius. <br><br><h3>  Peringatan 9 </h3><br>  Fragmen kode ini memicu empat peringatan penganalisa PVS-Studio: <br><br><ul><li>  <a href="https://www.viva64.com/en/w/v560/">V560</a> Bagian dari ekspresi kondisional selalu benar: x&gt; = 0. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/en/w/v560/">V560</a> Bagian dari ekspresi kondisional selalu benar: y&gt; = 0. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/en/w/v560/">V560</a> Bagian dari ekspresi kondisional selalu benar: x &lt;40. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/en/w/v560/">V560</a> Bagian dari ekspresi kondisional selalu benar: y &lt;30. editor.cpp 1137 </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> editorclass::at( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(<span class="hljs-number"><span class="hljs-number">0</span></span>,y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(y&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(x,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&gt;=<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(<span class="hljs-number"><span class="hljs-number">39</span></span>,y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(y&gt;=<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(x,<span class="hljs-number"><span class="hljs-number">29</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; y&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; x&lt;<span class="hljs-number"><span class="hljs-number">40</span></span> &amp;&amp; y&lt;<span class="hljs-number"><span class="hljs-number">30</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> contents[x+(levx*<span class="hljs-number"><span class="hljs-number">40</span></span>)+vmult[y+(levy*<span class="hljs-number"><span class="hljs-number">30</span></span>)]]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Semua peringatan terkait dengan pernyataan <i>if</i> terakhir.  Masalahnya adalah bahwa keempat pemeriksaan, dilakukan di dalamnya, akan selalu kembali <i>benar</i> .  Saya tidak akan mengatakan itu adalah kesalahan serius, tapi itu cukup lucu.  Penulis memutuskan untuk mengambil fungsi ini dengan serius dan untuk berjaga-jaga memeriksa setiap variabel lagi :) <br><br>  Dia bisa saja menghapus cek ini, karena alur eksekusi tidak akan sampai ke ekspresi " <i>return 0;</i> "  Itu tidak akan mengubah logika program, tetapi akan membantu untuk menyingkirkan cek yang berlebihan dan kode mati. <br><br><h3>  Peringatan 10 </h3><br>  Dalam artikelnya tentang ulang tahun permainan, Terry dengan ironisnya mencatat bahwa salah satu elemen yang mengendalikan logika permainan adalah pergantian besar dari fungsi <i>Game :: updatestate ()</i> , yang bertanggung jawab atas sejumlah besar kondisi permainan yang berbeda pada saat yang sama. .  Dan sangat diharapkan bahwa saya akan menemukan peringatan berikut: <br><br>  <a href="https://www.viva64.com/en/w/v2008/">V2008</a> Kompleksitas siklus: 548. Pertimbangkan untuk melakukan refactoring pada fungsi 'Game :: updatestate'.  Game.cpp 612 <br><br>  Ya, Anda benar: PVS-Studio memberi fungsi peringkat kompleksitas berikut - 548. Lima ratus empat puluh delapan !!!  Ini adalah bagaimana "kode rapi" terlihat.  Dan ini terlepas dari kenyataan bahwa, kecuali untuk pernyataan switch hampir tidak ada yang lain dalam fungsi.  Di sakelar itu sendiri, saya menghitung lebih dari 300 ekspresi huruf. <br><br>  Anda tahu, di perusahaan kami, kami memiliki persaingan kecil untuk artikel terpanjang.  Saya ingin membawa seluruh kode fungsi (3.450 baris) ke sini, tetapi kemenangan seperti itu tidak adil, jadi saya hanya akan membatasi diri pada <a href="">tautan</a> ke sakelar raksasa.  Saya sarankan Anda mengikuti tautan dan lihat sendiri panjangnya!  Untuk masalah itu, selain <i>Game :: updatestate ()</i> , PVS-Studio juga menemukan 44 fungsi dengan kompleksitas siklomatik yang meningkat, 10 di antaranya memiliki jumlah kompleksitas lebih dari 200. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ddb/a63/bac/ddba63bac1b88d806adea03d73b70888.png" alt="Gambar 5"></div><br><br><h2>  Kesimpulan </h2><br>  Saya pikir kesalahan di atas sudah cukup untuk artikel ini.  Ya, ada banyak kesalahan dalam proyek, tetapi ini semacam fitur.  Dengan membuka kodenya, Terry Cavanagh menunjukkan bahwa Anda tidak harus menjadi programmer yang sempurna untuk menulis gim yang hebat.  Sekarang, 10 tahun kemudian, Terry mengenang masa-masa itu dengan ironi.  Penting untuk belajar dari kesalahan Anda, dan berlatih adalah cara terbaik untuk melakukannya.  Dan jika latihan Anda dapat memunculkan game seperti VVVVVV, itu luar biasa!  Yah ... Ini saatnya untuk memainkannya sekali lagi :) <br><br>  Ini tidak semua kesalahan ditemukan dalam kode permainan.  Jika Anda ingin melihat sendiri apa lagi yang bisa ditemukan - Saya sarankan Anda <a href="https://www.viva64.com/en/pvs-studio-download/">mengunduh dan mencoba PVS-Studio</a> !  Juga, jangan lupa bahwa kami <a href="https://www.viva64.com/en/b/0614/">menyediakan</a> proyek sumber terbuka dengan lisensi gratis. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id484388/">https://habr.com/ru/post/id484388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id484376/index.html">Samsung Moscow Center for Artificial Intelligence dalam cerita karyawan</a></li>
<li><a href="../id484378/index.html">SwayWM - UnixPorn Yourself</a></li>
<li><a href="../id484380/index.html">Pindah - abad terakhir! Alternatif untuk std :: pindah di ‚ÄúC ++ of the Future‚Äù</a></li>
<li><a href="../id484382/index.html">Algoritma Bellman-Ford</a></li>
<li><a href="../id484386/index.html">Pertemuan AWS_Ru di Raiffeisenbank</a></li>
<li><a href="../id484390/index.html">Glean Insights Tentang 18 Kerangka Kerja Java Terbaik Untuk Digunakan pada tahun 2020</a></li>
<li><a href="../id484392/index.html">Kejang</a></li>
<li><a href="../id484394/index.html">Tujuh misi luar angkasa paling menarik di tahun mendatang</a></li>
<li><a href="../id484396/index.html">Membuat Windows Server Lebih Aman</a></li>
<li><a href="../id484402/index.html">Kode Bersih untuk TypeScript - Bagian 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>