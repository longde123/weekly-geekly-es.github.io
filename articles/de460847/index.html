<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüè´ ü§öüèª üìã 12,3 Millionen gleichzeitige WebSockets üßî ü§öüèº ü§∞üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Eine Sache bei WebSockets ist, dass Sie viele Ressourcen auf der Clientseite ben√∂tigen, um eine ausreichend hohe Last zu generieren, damit der Server ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>12,3 Millionen gleichzeitige WebSockets</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460847/"><p>  Eine Sache bei WebSockets ist, dass Sie viele Ressourcen auf der Clientseite ben√∂tigen, um eine ausreichend hohe Last zu generieren, damit der Server tats√§chlich alle CPU-Ressourcen verbraucht. </p><br><p>  Es gibt mehrere Herausforderungen, die Sie bew√§ltigen m√ºssen, da das WebSockets-Protokoll auf Clientseite mehr CPU-Anforderungen stellt als auf Serverseite.  Gleichzeitig ben√∂tigen Sie viel RAM, um Informationen √ºber offene Verbindungen zu speichern, wenn Sie √ºber Millionen davon verf√ºgen. </p><br><p>  Ich hatte das Gl√ºck, f√ºr einen begrenzten Zeitraum ein paar neue Server f√ºr die Hardware-Burnout-Tests zur Verf√ºgung zu haben.  Deshalb habe ich mich entschlossen, meinen Lua Application Server - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">LAppS</a> f√ºr beide Aufgaben zu verwenden: Testen Sie die Hardware und f√ºhren Sie die LAppS-Hochlasttests durch. </p><br><p><a name="habracut"></a>  Lassen Sie uns die Details sehen </p><br><h1 id="challenges">  Herausforderungen </h1><br><p>  Zun√§chst ben√∂tigen WebSockets auf der Client-Seite ein ziemlich schnelles RNG f√ºr die Verkehrsmaskierung, es sei denn, Sie m√∂chten es f√§lschen.  Ich wollte, dass die Tests realistisch sind, also verwarf ich die Idee, das RNG zu f√§lschen, indem ich es durch eine Konstante ersetzte.  Dies l√§sst die einzige Option - viel CPU-Leistung.  Wie gesagt, ich habe zwei Server: einen mit zwei Intel Gold 6148-CPUs (insgesamt 40 Kerne) mit 256 GB RAM (DDR4-2666) und einen mit vier Intel Platinum 8180-CPUs (insgesamt 112 Kerne) mit 384 GB RAM (DDR4-2666) .  Ich werde sie im Folgenden als Server A und Server B bezeichnen. </p><br><p>  Die zweite Herausforderung: Es gibt keine Bibliotheken oder Testsuiten f√ºr WebSockets, die schnell genug sind.  Aus diesem Grund musste ich ein WebSockets-Clientmodul f√ºr LAppS ( <strong>cws</strong> ) entwickeln. </p><br><h1 id="the-tests-setup">  Der Testaufbau </h1><br><p>  Beide Server verf√ºgen √ºber 10-GbE-Karten mit zwei Ports.  Port 1 jeder Karte ist zu einer Verbindungsschnittstelle zusammengefasst, und diese Ports auf beiden Karten sind im RR-Modus miteinander verbunden.  Port 2 jeder Karte wird in einem Active-Backup-Modus, der √ºber einen Ethernet-Switch verbunden ist, zu einer Verbindungsschnittstelle zusammengefasst.  Auf jedem Hardwareserver wurde RHEL 7.6 ausgef√ºhrt.  Ich musste gcc-8.3 von den Quellen installieren, um einen modernen Compiler anstelle des Standard-gcc-4.8.5 zu haben.  Nicht das beste Setup f√ºr die Leistungstests, aber Bettler k√∂nnen keine Wahl sein. </p><br><p>  CPUs auf Server A (2xGold 6148) haben eine h√∂here Frequenz als auf Server B (4xPlatinum 8180).  Gleichzeitig hat Server B mehr Kerne, daher habe ich beschlossen, einen Echoserver auf Server A und die Echoclients auf Server B auszuf√ºhren. </p><br><p>  Ich wollte sehen, wie sich LAppS unter hoher Last mit Millionen von Verbindungen verh√§lt und welche maximale Anzahl von Echoanforderungen pro Sekunde es bedienen kann.  Dies sind eigentlich zwei verschiedene Testreihen, da Server und Clients mit dem Wachstum der Verbindungen immer komplexer werden. </p><br><p>  Vorher habe ich alle Tests auf meinem Heim-PC durchgef√ºhrt, die ich f√ºr die Entwicklung verwende.  Die Ergebnisse dieser Tests werden zum Vergleich herangezogen.  Mein Heim-PC verf√ºgt √ºber eine Intel Core i7-7700-CPU mit 3,6 GHz (4,0 GHz Turbo), 4 Kernen und 32 GB DDR4-2400-RAM.  Auf diesem PC l√§uft Gentoo mit dem Kernel 4.14.72. </p><br><div class="spoiler">  <b class="spoiler_title">Spectre- und Meltdown-Patch-Levels</b> <div class="spoiler_text"><ul><li>  Home PC <br><pre><code class="plaintext hljs">/sys/devices/system/cpu/vulnerabilities/l1tf:Mitigation: PTE Inversion; VMX: conditional cache flushes, SMT vulnerable /sys/devices/system/cpu/vulnerabilities/meltdown:Mitigation: PTI /sys/devices/system/cpu/vulnerabilities/spec_store_bypass:Mitigation: Speculative Store Bypass disabled via prctl and seccomp /sys/devices/system/cpu/vulnerabilities/spectre_v1:Mitigation: __user pointer sanitization /sys/devices/system/cpu/vulnerabilities/spectre_v2:Vulnerable: Minimal generic ASM retpoline, IBPB, IBRS_FW</code> </pre> </li><li>  Server A und B. <br><pre> <code class="plaintext hljs">/sys/kernel/debug/x86/ibpb_enabled : 1 /sys/kernel/debug/x86/pti_enabled : 1 /sys/kernel/debug/x86/ssbd_enabled : 1 /sys/kernel/debug/x86/ibrs_enabled : 1 /sys/kernel/debug/x86/retp_enabled : 3</code> </pre> </li></ul><br><p>  Ich werde mit den Ergebnissen der Tests der Server A und B eine zus√§tzliche Notiz machen, ob diese Patches aktiviert sind oder nicht. </p><br><p>  Auf meinem Heim-PC wird der Patch-Level nie ge√§ndert. </p></div></div><br><h2 id="installing-lapps-081">  Installieren von LAppS 0.8.1 </h2><br><div class="spoiler">  <b class="spoiler_title">Installationsvoraussetzungen und LAppS</b> <div class="spoiler_text"><p>  LAppS h√§ngt von den Bibliotheken luajit-2.0.5 oder h√∂her, libcrypto ++ 8.2 und wolfSSL-3.15.7 ab und muss aus Quellen in RHEL 7.6 und wahrscheinlich in jeder anderen Linux-Distribution installiert werden. </p><br><p>  Das Pr√§fix f√ºr die Installation lautet / usr / local.  Hier ist der ziemlich selbsterkl√§rende Dockerfile-Teil f√ºr die wolfSSL-Installation </p><br><pre> <code class="plaintext hljs">ADD https://github.com/wolfSSL/wolfssl/archive/v3.15.7-stable.tar.gz ${WORKSPACE} RUN tar xzvf v3.15.7-stable.tar.gz WORKDIR ${WORKSPACE}/wolfssl-3.15.7-stable RUN ./autogen.sh RUN ./configure CFLAGS="-pipe -O2 -march=native -mtune=native -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops -DTFM_TIMING_RESISTANT -DECC_TIMING_RESISTANT -DWC_RSA_BLINDING" --prefix=/usr/local --enable-tls13 --enable-openssh --enable-aesni --enable-intelasm --enable-keygen --enable-certgen --enable-certreq --enable-curve25519 --enable-ed25519 --enable-intelasm --enable-harden RUN make -j40 all RUN make install</code> </pre><br><p>  Und hier ist der Teil f√ºr die Installation von libcrypto ++ </p><br><pre> <code class="plaintext hljs">ADD https://github.com/weidai11/cryptopp/archive/CRYPTOPP_8_2_0.tar.gz ${WORKSPACE} RUN rm -rf ${WORKSPACE}/cryptopp-CRYPTOPP_8_2_0 RUN tar xzvf ${WORKSPACE}/CRYPTOPP_8_2_0.tar.gz WORKDIR ${WORKSPACE}/cryptopp-CRYPTOPP_8_2_0 RUN make CFLAGS="-pipe -O2 -march=native -mtune=native -fPIC -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops" CXXFLAGS="-pipe -O2 -march=native -mtune=native -fPIC -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops" -j40 libcryptopp.a libcryptopp.so RUN make install</code> </pre><br><p>  Und der Luajit </p><br><pre> <code class="plaintext hljs">ADD http://luajit.org/download/LuaJIT-2.0.5.tar.gz ${WORKSPACE} WORKDIR ${WORKSPACE} RUN tar xzvf LuaJIT-2.0.5.tar.gz WORKDIR ${WORKSPACE}/LuaJIT-2.0.5 RUN env CFLAGS="-pipe -Wall -pthread -O2 -fPIC -march=native -mtune=native -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops -fstack-check -fstack-protector-strong -fno-omit-frame-pointer" make -j40 all RUN make install</code> </pre> <br><p>  Eine optionale Abh√§ngigkeit von LAppS, die m√∂glicherweise ignoriert wird, ist die neue Bibliothek von Microsoft <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">mimalloc</a> .  Diese Bibliothek verbessert die Leistung erheblich (ca. 1%), erfordert jedoch cmake-3.4 oder h√∂her.  Angesichts der begrenzten Zeit f√ºr die Tests habe ich beschlossen, die erw√§hnte Leistungsverbesserung zu opfern. </p><br><p>  Auf meinem Heim-PC werde ich <em>mimalloc</em> w√§hrend der Tests nicht deaktivieren. </p><br><p>  Erm√∂glicht das Auschecken von LAppS aus dem Repository: </p><br><pre> <code class="plaintext hljs">WORKDIR ${WORKSPACE} RUN rm -rf ITCLib ITCFramework lar utils LAppS RUN git clone https://github.com/ITpC/ITCLib.git RUN git clone https://github.com/ITpC/utils.git RUN git clone https://github.com/ITpC/ITCFramework.git RUN git clone https://github.com/ITpC/LAppS.git RUN git clone https://github.com/ITpC/lar.git WORKDIR ${WORKSPACE}/LAppS</code> </pre> <br><p>  Jetzt m√ºssen wir "-lmimalloc" aus allen Makefiles im Unterverzeichnis <strong>nbproject entfernen</strong> , damit wir LAppS erstellen k√∂nnen (vorausgesetzt, unser aktuelles Verzeichnis ist $ {WORKSPACE} / LAppS). </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># find ./nbproject -type f -name "*.mk" -exec sed -i.bak -e 's/-lmimalloc//g' {} \; # find ./nbproject -type f -name "*.bak" -exec rm {} \;</span></span></code> </pre> <br><p>  Und jetzt k√∂nnen wir LAppS bauen.  LAppS bietet verschiedene Build-Konfigurationen, die einige Funktionen auf der Serverseite ausschlie√üen k√∂nnen oder nicht: </p><br><ul><li>  mit SSL-Unterst√ºtzung und mit Unterst√ºtzung beim Sammeln von Statistiken </li><li>  mit SSL und ohne Statistiksammlung (obwohl die minimale Statistiksammlung fortgesetzt wird, da sie f√ºr die dynamische LAppS-Optimierung zur Laufzeit verwendet wird) </li><li>  ohne SSL und ohne statistische Erfassung. </li></ul><br><p>  Stellen Sie vor dem n√§chsten Schritt sicher, dass Sie der Eigent√ºmer des Verzeichnisses / opt / lapps sind (oder f√ºhren Sie make installs mit sudo aus). </p><br><p>  Lassen Sie uns zwei Arten von Bin√§rdateien mit und ohne SSL-Unterst√ºtzung und Statistikerfassung erstellen (vorausgesetzt, wir befinden uns im Verzeichnis $ {WORKSPACE} / LAppS): </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># make clean # make CONF=Release.AVX2 install # make CONF=Release.AVX2.NO_STATS.NO_TLS install</span></span></code> </pre> <br><p>  Die resultierenden Bin√§rdateien sind: </p><br><ul><li>  dist / Release.AVX2 / GNU-Linux / lapps.avx2 </li><li>  dist / Release.AVX2.NO_STATS.NO_TLS / GNU-Linux / lapps.avx2.nostats.notls </li></ul><br><p>  Sie werden in / opt / lapps / bin installiert. </p><br><p>  Bitte beachten Sie, dass das WebSockets-Clientmodul f√ºr Lua immer mit SSL-Unterst√ºtzung erstellt wird.  Ob es aktiviert ist oder nicht, h√§ngt von der URI ab, die Sie zur Laufzeit f√ºr die Verbindung (ws: // oder wss: //) verwenden. </p></div></div><br><h2 id="test-1-top-performance-on-home-pc-configuration-for-baseline">  Test 1. Spitzenleistung auf dem Heim-PC.  Konfiguration f√ºr die Basislinie. </h2><br><p>  Ich habe bereits festgestellt, dass ich die beste Leistung erhalte, wenn ich vier Benchmark-Dienstinstanzen mit jeweils 100 Verbindungen konfiguriere.  Gleichzeitig ben√∂tige ich nur drei IOWorker und vier Echo-Service-Instanzen, um die beste Leistung zu erzielen.  Erinnerst du dich?  Ich habe hier nur 4 Kerne. </p><br><p>  Der Zweck dieses Tests besteht lediglich darin, eine Basislinie f√ºr den weiteren Vergleich festzulegen.  Hier ist wirklich nichts Aufregendes. </p><br><p>  Nachfolgend sind die Schritte aufgef√ºhrt, die zum Konfigurieren von LAppS f√ºr die Tests erforderlich sind. </p><br><h3 id="self-signed-certificates">  Selbstsignierte Zertifikate </h3><br><div class="spoiler">  <b class="spoiler_title">certgen.sh-Skript</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash openssl genrsa -out example.org.key 2048 openssl req -new -key example.org.key -out example.org.csr openssl genrsa -out ca.key 2048 openssl req -new -x509 -key ca.key -out ca.crt openssl x509 -req -in example.org.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out example.org.crt cat example.org.crt ca.crt &gt; example.org.bundle.crt</span></span></code> </pre> </div></div><br><p>  Wenn Sie dieses Skript im Verzeichnis / opt / lapps / conf / ssl ausf√ºhren, werden alle erforderlichen Dateien erstellt.  Hier ist die Ausgabe des Skripts und was ich eingegeben habe: </p><br><div class="spoiler">  <b class="spoiler_title">Ausgabe von certgen.sh</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># certgen.sh Generating RSA private key, 2048 bit long modulus .................................................................................................................................................................+++++ .....................................+++++ e is 65537 (0x010001) You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]:KZ State or Province Name (full name) [Some-State]:none Locality Name (eg, city) []:Almaty Organization Name (eg, company) [Internet Widgits Pty Ltd]:NOORG.DO.NOT.FORGET.TO.REMOVE.FROM.BROWSER Organizational Unit Name (eg, section) []: Common Name (eg server FQDN or YOUR name) []: Email Address []: Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []: Generating RSA private key, 2048 bit long modulus ...+++++ ............................................................................+++++ e is 65537 (0x010001) You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]:KZ State or Province Name (full name) [Some-State]:none Locality Name (eg, city) []:Almaty Organization Name (eg, company) [Internet Widgits Pty Ltd]:none Organizational Unit Name (eg, section) []: Common Name (eg server FQDN or YOUR name) []:*.example.org Email Address []: Signature ok subject=C = KZ, ST = none, L = Almaty, O = NOORG.DO.NOT.FORGET.TO.REMOVE.FROM.BROWSER Getting CA Private Key</code> </pre> </div></div><br><h3 id="lapps-configuration">  LAppS-Konfiguration </h3><br><p>  Hier ist die WebSockets-Konfigurationsdatei, die f√ºr TLS 1.3 festgelegt ist, die oben generierten Zertifikate enth√§lt und mit 3 IOWorkern konfiguriert ist (siehe detaillierte Beschreibung der Variablen im LAppS-Wiki). </p><br><div class="spoiler">  <b class="spoiler_title">/opt/lapps/etc/conf/ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5083</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">40000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><p>  Konfigurieren von Diensten: Der Echoserver und der Echoclient (Benchmark) mit jeweils vier Instanzen. </p><br><div class="spoiler">  <b class="spoiler_title">/opt/lapps/etc/conf/lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"echo"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbound_message_size"</span></span>: <span class="hljs-number"><span class="hljs-number">16777216</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"raw"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"request_target"</span></span>: <span class="hljs-string"><span class="hljs-string">"/echo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] } }, <span class="hljs-attr"><span class="hljs-attr">"benchmark"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"depends"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"echo"</span></span> ] } } }</code> </pre> </div></div><br><p>  Der Echo-Service ist ziemlich trivial: </p><br><div class="spoiler">  <b class="spoiler_title">Echo-Service-Quellcode</b> <div class="spoiler_text"><pre> <code class="lua hljs">echo = {} echo.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span> = echo; echo.onStart=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::onStart"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onDisconnect=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onShutdown=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::onShutdown()"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onMessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,opcode, message)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errmsg=ws:send(handler,opcode,message); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::OnMessage(): "</span></span>..errmsg); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> echo</code> </pre> </div></div><br><p>  Der Benchmark-Service erstellt so viele wie <strong>Benchmark.max_connections</strong> zu <strong>Benchmark.Target</strong> und wird dann nur ausgef√ºhrt, bis Sie das LAppS stoppen.  Es gibt keine Pause beim Aufbau der Verbindungen oder beim Bombardement mit Echoanfragen.  Die <strong>cws-</strong> Modul-API √§hnelt der Web-API f√ºr WebSockets.  Sobald alle <strong>Benchmark.max_connections</strong> eingerichtet sind, gibt der Benchmark die Anzahl der verbundenen Sockets aus.  Sobald die Verbindung hergestellt ist, sendet der Benchmark eine <strong>Benchmark-Nachricht</strong> an den Server.  Nachdem der Server <strong>geantwortet hat</strong> , wird die anonyme <strong>onmessage-</strong> Methode des <strong>cws-</strong> Objekts aufgerufen, die nur dieselbe Nachricht an den Server <strong>zur√ºcksendet</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">Benchmark-Service-Quellcode</b> <div class="spoiler_text"><pre> <code class="lua hljs">benchmark={} benchmark.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span>=benchmark benchmark.init=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); benchmark.max_connections=<span class="hljs-number"><span class="hljs-number">100</span></span>; benchmark.target=<span class="hljs-string"><span class="hljs-string">"wss://127.0.0.1:5083/echo"</span></span>; benchmark.message=<span class="hljs-string"><span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span>; benchmark.meter=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> benchmark.messages_counter=benchmark.messages_counter+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> slice=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now() - benchmark.start_time; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( slice &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(benchmark.messages_counter..<span class="hljs-string"><span class="hljs-string">" messages received per "</span></span>..slice..<span class="hljs-string"><span class="hljs-string">"ms"</span></span>) benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.run=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> n=nap:new(); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> counter=<span class="hljs-number"><span class="hljs-number">1</span></span>; n:sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> array={}; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> start=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(#array &lt; benchmark.max_connections) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> must_stop()) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> sock, err_msg=cws:new(benchmark.target, { onopen=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errstr=cws:send(handler,benchmark.message,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Error on websocket send at handler "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">": "</span></span>..errstr); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onmessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,message,opcode)</span></span></span></span> benchmark.meter(); cws:send(handler,message,opcode); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onerror=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler, message)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Client WebSocket connection is failed for socketfd "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">". Error: "</span></span>..message); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onclose=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Connection is closed for socketfd "</span></span>..handler); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sock ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>(array,sock); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(err_msg); err_msg=<span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">collectgarbage</span></span>(<span class="hljs-string"><span class="hljs-string">"collect"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment">-- poll events once per 10 outgoing connections -- this will improve the connection establishment speed if counter == 10 then cws:eventLoop(); counter=1 else counter = counter + 1; end end print("Sockets connected: "..#array); benchmark.start_time=time.now(); while not must_stop() do cws:eventLoop(); end for i=1,#array do array[i]:close(); cws:eventLoop(); end end return benchmark;</span></span></code> </pre> </div></div><br><h3 id="services-installation">  Installation der Dienste </h3><br><p>  Jetzt m√ºssen wir die Service-Skripte in /opt/lapps/apps//.lua platzieren: <br></p><ul><li>  /opt/lapps/apps/benchmark/benchmark.lua </li><li>  /opt/lapps/apps/echo/echo.lua </li></ul><br><p>  Wir sind jetzt bereit, unseren Benchmark durchzuf√ºhren.  F√ºhren Sie einfach <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2 &gt; log</code> : <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2 &gt; log</code>  <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2 &gt; log</code> aus dem LAppS-Verzeichnis aus und warten Sie 5 Minuten. Dr√ºcken Sie dann einmal Strg-C, um das LAppS zu stoppen (es wird nicht sofort gestoppt, es werden zuerst die Verbindungen beendet) oder zweimal (dies unterbricht die Abschaltsequenz). </p><br><p>  Ok, wir haben eine Textdatei mit so etwas: </p><br><div class="spoiler">  <b class="spoiler_title">Benchmark-Ausgabe</b> <div class="spoiler_text"><p>  echo :: onStart <br>  echo :: onStart <br>  echo :: onStart <br>  echo :: onStart <br>  Laufen <br>  1 empfangene Nachrichten pro 3196 ms <br>  1 empfangene Nachrichten pro 3299 ms <br>  1 empfangene Nachrichten pro 3299 ms <br>  1 empfangene Nachrichten pro 3305 ms <br>  Anschl√ºsse angeschlossen: 100 <br>  Anschl√ºsse angeschlossen: 100 <br>  Anschl√ºsse angeschlossen: 100 <br>  Anschl√ºsse angeschlossen: 100 <br>  Pro 1000 ms empfangene 134597 Nachrichten <br>  139774 pro 1000 ms empfangene Nachrichten <br>  Pro 1000 ms empfangene 138521 Nachrichten <br>  139404 pro 1000 ms empfangene Nachrichten <br>  140162 empfangene Nachrichten pro 1000 ms <br>  139337 Nachrichten pro 1000 ms empfangen <br>  Pro 1000 ms empfangene 140088 Nachrichten <br>  139946 empfangene Nachrichten pro 1000 ms <br>  141204 pro 1000 ms empfangene Nachrichten <br>  Pro 1000 ms empfangene 137988 Nachrichten <br>  141805 Nachrichten pro 1000 ms empfangen <br>  Pro 1000 ms empfangene 134733 Nachrichten <br>  ... </p></div></div><br><p>  Lassen Sie uns diese Protokolldatei wie folgt bereinigen: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">':%s/ms/^V^M/g\n:%g/^$/d\nGdd1G4/Sockets\n4\ndggZZ'</span></span> | vi <span class="hljs-variable"><span class="hljs-variable">$i</span></span></code> </pre> <br><p>  '^ V ^ M' ist eine sichtbare Darstellung der folgenden Schl√ºsseltreffer: Strg-V Strg-V Strg-V Strg-M, daher ist es ziemlich nutzlos, nur diese Bash-Zeile zu kopieren und einzuf√ºgen.  Kurze Erkl√§rung: </p><br><ul><li>  Wir m√ºssen 'ms'-Symbole durch das Zeilenende ersetzen, da wir sie nicht ben√∂tigen. Sie werden die Berechnungen sp√§ter durcheinander bringen und 4 parallel arbeitende Benchmarks k√∂nnen ihre Ergebnisse in einer Zeile ausdrucken. </li><li>  wir m√ºssen danach alle leeren Zeilen entfernen </li><li>  Wir entfernen auch die letzte Zeile, weil wir den Server stoppen </li><li>  In der <strong>Protokolldatei</strong> gibt es nur vordere Zeilen, die aus <em>verbundenen Sockets</em> bestehen <em>: 100</em> (weil wir nur vier Benchmark-Dienste ausf√ºhren).  Wir √ºberspringen also 4 Zeilen nach der letzten und entfernen dann alles oben in der Datei. </li><li>  Speichern der Datei. </li></ul><br><p>  Die Datei wird gespeichert und Sie befinden sich wieder in der Shell. Die Protokolldatei ist f√ºr den n√§chsten Schritt bereit: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># awk -v avg=0 '{rps=($1/$5);avg+=rps;}END{print ((avg*1000)/NR)*4}' log</span></span></code> </pre> <br><p>  Dieser awk-Einzeiler berechnet die Menge der Echoantworten pro ms und akkumuliert das Ergebnis in einer <em>durchschnittlichen</em> Variablen.  Nachdem alle Zeilen in der Protokolldatei verarbeitet wurden, wird der <em>Durchschnitt</em> mit 1000 multipliziert, um die Gesamtmenge der Echoantworten pro Sekunde zu erhalten, wobei die Anzahl der Zeilen dividiert und die Anzahl der Benchmark-Dienste multipliziert wird.  Dies gibt uns die durchschnittliche Anzahl von Echoantworten pro Sekunde f√ºr diesen Testlauf. </p><br><p>  Auf meinem PC lautet diese Nummer (ERps): <strong>563854</strong> </p><br><p>  Machen wir dasselbe ohne SSL-Unterst√ºtzung und sehen den Unterschied: </p><br><ul><li>  √Ñndern Sie den Wert der Variablen tls in ws.json in false </li><li>  √§ndere <strong>Benchmark.Target</strong> in Benchmark.Lua von wss: // in ws: // </li><li>  F√ºhren Sie <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2.nostats.notls &gt; log</code>  <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2.nostats.notls &gt; log</code> aus dem LAppS-Verzeichnis aus und wiederholen Sie die obigen Schritte. </li></ul><br><p>  Ich habe: <strong>721236</strong> Antworten pro Sekunde </p><br><p>  Der Leistungsunterschied mit SSL und ohne SSL betr√§gt ca. 22%.  Denken wir an diese Zahlen, um sp√§ter darauf zur√ºckgreifen zu k√∂nnen. </p><br><p>  Mit dem gleichen Setup auf Server A habe ich: <strong>421905</strong> ERpS mit SSL und <strong>443145</strong> ERpS ohne SSL.  Die Patches f√ºr Spectre und Meltdown wurden deaktiviert. <br>  Auf dem Server B habe ich <strong>270996</strong> ERpS mit SSL und <strong>318522</strong> ERpS ohne SSL mit aktivierten Patches.  <strong>385726</strong> und <strong>372126</strong> ohne und mit SSL.  Die Patches f√ºr Spectre und Meltdown wurden ebenfalls deaktiviert. </p><br><p>  Die Ergebnisse sind bei gleichem Setup schlechter, da die CPUs auf diesen Servern weniger h√§ufig sind. </p><br><p>  Bitte beachten Sie, dass die Clients stark von der Datenverf√ºgbarkeit in / dev / urandom abh√§ngig sind.  Es kann eine Weile dauern, bis die Clients tats√§chlich ausgef√ºhrt werden, wenn Sie sie bereits einmal ausgef√ºhrt haben.  Warten Sie also, bis sie anfangen zu arbeiten, dann sind sie ziemlich schnell bei dem, was sie tun.  √úberwachen Sie einfach mit <em>top,</em> ob die LAppS-Instanzen √ºberhaupt einen Job ausf√ºhren.  Wenn / dev / urandom ersch√∂pft ist, verbraucht das LAppS Ihre CPUs erst, wenn einige Daten verf√ºgbar sind. </p><br><h1 id="preparing-for-big-tests">  Vorbereitung auf gro√üe Tests </h1><br><p>  Zun√§chst m√ºssen wir einige √Ñnderungen an den Kernel-Parametern vornehmen und das ulimit f√ºr nr der ge√∂ffneten Dateien nicht vergessen.  Ich habe fast das gleiche Setup wie in diesem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel verwendet</a> . </p><br><p>  Erstellen Sie eine Datei mit dem folgenden Inhalt </p><br><pre> <code class="bash hljs">: sysctl -w fs.file-max=14000000 sysctl -w fs.nr_open=14000000 <span class="hljs-built_in"><span class="hljs-built_in">ulimit</span></span> -n 14000000 sysctl -w net.ipv4.tcp_mem=<span class="hljs-string"><span class="hljs-string">"100000000 100000000 100000000"</span></span> sysctl -w net.core.somaxconn=20000 sysctl -w net.ipv4.tcp_max_syn_backlog=20000 sysctl -w net.ipv4.ip_local_port_range=<span class="hljs-string"><span class="hljs-string">"1025 65535"</span></span></code> </pre> <br><p>  Verwenden <em>Sie dann</em> auf beiden Servern die <em>Quelle ./Dateiname</em> , um die Kernelparameter und das Ulimit zu √§ndern. </p><br><p>  Dieses Mal m√∂chte ich mehrere Millionen Clients auf einem Server erstellen und mit dem zweiten verbinden. </p><br><p>  Server A dient als Server-Seite f√ºr den WebSockets-Echo-Service. <br>  Server B dient als Client-Seite f√ºr den WebSockets-Echo-Service. </p><br><p>  Es gibt eine von LuaJIT auferlegte Einschr√§nkung in LAppS.  Sie k√∂nnen nur 2 GB RAM pro LuaJIT-VM verwenden.  Dies ist die RAM-Grenze, die Sie innerhalb einer einzelnen LAppS-Instanz f√ºr alle Dienste verwenden k√∂nnen, da die Dienste die Threads sind, die mit einer Libluajit-Instanz verkn√ºpft sind.  Wenn einer Ihrer Dienste, der unter der einzelnen LAppS-Instanz ausgef√ºhrt wird, diese Grenze √ºberschreitet, haben alle Dienste nicht gen√ºgend Speicher. </p><br><p>  Ich habe herausgefunden, dass Sie pro einzelner LAppS-Instanz nicht mehr als 2 464 000 Client-WebSockets mit einer Nachrichtengr√∂√üe von 64 Byte einrichten k√∂nnen.  Die Nachrichtengr√∂√üe kann diese Grenze geringf√ºgig √§ndern, da LAppS die Nachricht an den <em>cws-</em> Dienst <em>weiterleitet</em> , indem der Speicherplatz f√ºr diese Nachricht im LuaJIT zugewiesen wird. </p><br><p>  Dies bedeutet, dass ich mehrere LAppS-Instanzen mit derselben Konfiguration auf Server B starten muss, um mehr als 2,4 Millionen WebSockets einzurichten.  Der Server A (der Echoserver) verwendet auf LuaJIT-Seite nicht so viel Speicher, sodass die eine Instanz des LAppS problemlos 12,3 Millionen WebSockets verwaltet. </p><br><p>  Bereiten wir zwei verschiedene Konfigurationen f√ºr die Server A und B vor. </p><br><div class="spoiler">  <b class="spoiler_title">Server A ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">224</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5084</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">2000000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Server A lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"echo"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span>: <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbound_message_size"</span></span>: <span class="hljs-number"><span class="hljs-number">16777216</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"raw"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"request_target"</span></span>: <span class="hljs-string"><span class="hljs-string">"/echo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] } } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Server B ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5083</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"deny"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><p>  Server A verf√ºgt √ºber zwei Schnittstellen: </p><br><ul><li>  bond0 - xx203.37 </li><li>  bond1 - xx23.10 </li></ul><br><p>  Einer ist schneller, ein anderer ist langsamer, aber das spielt keine Rolle.  Der Server wird sowieso stark ausgelastet sein. </p><br><p>  Bereiten wir eine Vorlage aus unserer Datei /opt/lapps/benchmark/benchmark.lua vor </p><br><div class="spoiler">  <b class="spoiler_title">Benchmark.lua</b> <div class="spoiler_text"><pre> <code class="lua hljs">benchmark={} benchmark.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span>=benchmark benchmark.init=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); benchmark.max_connections=<span class="hljs-number"><span class="hljs-number">10000</span></span>; benchmark.target_port=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.target_prefix=<span class="hljs-string"><span class="hljs-string">"wss://IPADDR:"</span></span>; benchmark.target_postfix=<span class="hljs-string"><span class="hljs-string">"/echo"</span></span>; benchmark.message=<span class="hljs-string"><span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span>; benchmark.meter=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> benchmark.messages_counter=benchmark.messages_counter+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> slice=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now() - benchmark.start_time; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( slice &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(benchmark.messages_counter..<span class="hljs-string"><span class="hljs-string">" messages received per "</span></span>..slice..<span class="hljs-string"><span class="hljs-string">"ms"</span></span>) benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.run=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> n=nap:new(); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> counter=<span class="hljs-number"><span class="hljs-number">1</span></span>; n:sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> array={}; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> start=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(#array &lt; benchmark.max_connections) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> must_stop()) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> benchmark.target_port=<span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">random</span></span>(<span class="hljs-number"><span class="hljs-number">5084</span></span>,<span class="hljs-number"><span class="hljs-number">5307</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> sock, err_msg=cws:new(benchmark.target_prefix..benchmark.target_port..benchmark.target_postfix, { onopen=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errstr=cws:send(handler,benchmark.message,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Error on websocket send at handler "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">": "</span></span>..errstr); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onmessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,message,opcode)</span></span></span></span> benchmark.meter(); cws:send(handler,message,opcode); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onerror=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler, message)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Client WebSocket connection is failed for socketfd "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">". Error: "</span></span>..message); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onclose=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Connection is closed for socketfd "</span></span>..handler); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sock ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>(array,sock); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(err_msg); err_msg=<span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">collectgarbage</span></span>(<span class="hljs-string"><span class="hljs-string">"collect"</span></span>); <span class="hljs-comment"><span class="hljs-comment">-- force garbage collection on connection failure. end -- poll events once per 10 outgoing connections -- this will improve the connection establishment speed if counter == 10 then cws:eventLoop(); counter=1 else counter = counter + 1; end end print("Sockets connected: "..#array); benchmark.start_time=time.now(); while not must_stop() do cws:eventLoop(); end for i=1,#array do array[i]:close(); cws:eventLoop(); end end return benchmark;</span></span></code> </pre> </div></div><br><p>  Speichern wir die IP-Adressen von Server A in den Dateien IP1 bzw. IP2 und dann: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1 2 <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> mkdir -p /opt/lapps/apps/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span> sed -e <span class="hljs-string"><span class="hljs-string">"s/IPADDR/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(cat IP1)</span></span></span><span class="hljs-string">/g"</span></span> /opt/lapps/apps/benchmark/benchmark.lua &gt; /opt/lapps/apps/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>.lua <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p>  Jetzt √§ndern wir /opt/lapps/etc/conf/lapps.json auf Server B, um diese beiden Benchmark-Dienste zu verwenden: </p><br><div class="spoiler">  <b class="spoiler_title">Server B lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"benchmark1"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ] }, <span class="hljs-attr"><span class="hljs-attr">"benchmark2"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ] } } }</code> </pre> </div></div><br><p>  Sind wir bereit  Nein, sind wir nicht.  Da wir beabsichtigen, 2 240 000 ausgehende Sockets an nur zwei Adressen zu generieren, ben√∂tigen wir mehr Ports auf der Serverseite.  Es ist unm√∂glich, mehr als 64.000 Verbindungen zu demselben IP: Port-Paar herzustellen (tats√§chlich etwas weniger als 64.000). </p><br><p>  Auf dem Server A in der Datei LAppS / include / wsServer.h befindet sich eine Funktion void startListeners ().  In dieser Funktion ersetzen wir Zeile 126 </p><br><pre> <code class="plaintext hljs">LAppSConfig::getInstance()-&gt;getWSConfig()["port"],</code> </pre> <br><p>  damit: </p><br><pre> <code class="plaintext hljs">static_cast&lt;int&gt;(LAppSConfig::getInstance()-&gt;getWSConfig()["port"])+i,</code> </pre> <br><p>  LAppS neu erstellen: </p><br><pre> <code class="bash hljs">make CONF=Release.AVX2 install</code> </pre> <br><h1 id="running-the-tests-for-2-240-000-client-websockets">  Ausf√ºhren der Tests f√ºr 2 240 000 Client-WebSockets. </h1><br><p>  Starten Sie das LAppS auf Server B, starten Sie dann das LAppS auf Server B und leiten Sie die Ausgabe in eine Datei wie die folgende um: </p><br><pre> <code class="bash hljs">/opt/lapps/bin/lapps.avx2 &gt; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br><p>  Bearbeiten, NB: </p><br><pre> <code class="plaintext hljs">if you want to run several LAppS instances, then create separate directory for each instnace (like run1,run2, etc) and run each instance from within these directories. This is required for lapps.log file and of course for resulting standard output, for not to be overlapped/overwritten by concurrent LAppS instances.</code> </pre> <br><p>  Dies kann eine Weile dauern, bis alle Verbindungen hergestellt sind.  Lassen Sie uns den Fortschritt √ºberwachen. </p><br><p>  Verwenden Sie netstat nicht, um hergestellte Verbindungen zu √ºberwachen. Es ist sinnlos, wenn es nach etwa 150.000 Verbindungen, die in einigen Sekunden hergestellt werden, auf unbestimmte Zeit ausgef√ºhrt wird.  Sehen Sie sich das lapps.log auf Server A in dem Verzeichnis an, in dem Sie sich beim Starten von LAppS befanden.  Sie k√∂nnen den folgenden Einzeiler verwenden, um zu sehen, wie die Verbindungen hergestellt und wie sie unter IOWorkern verteilt werden: </p><br><pre> <code class="bash hljs">date;awk <span class="hljs-string"><span class="hljs-string">'/ will be added to connection pool of worker/{a[$22]++}END{for(i in a){ print i, a[i]; sum+=a[i]} print sum}'</span></span> lapps.log | sort -n;date</code> </pre> <br><p>  Hier ist eine Idee, wie schnell diese Verbindungen hergestellt werden: </p><br><pre> <code class="plaintext hljs">375874 Sun Jul 21 20:33:07 +06 2019 650874 Sun Jul 21 20:34:42 +06 2019 2894 connections per second 1001874 Sun Jul 21 20:36:45 +06 2019 2974 connections per second 1182874 Sun Jul 21 20:37:50 +06 2019 2784 connections per second 1843874 Sun Jul 21 20:41:44 +06 2019 2824 connections per second 2207874 Sun Jul 21 20:45:43 +06 2019 3058 connections per second</code> </pre><br><p>  Auf dem Server B k√∂nnen wir √ºberpr√ºfen, wie viele Benchmarks ihre Verbindungen hergestellt haben: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># grep Sockets log | wc -l 224</span></span></code> </pre> <br><p>  Nachdem Sie gesehen haben, dass die Nummer 224 ist, lassen Sie die Server eine Weile arbeiten, √ºberwachen Sie die CPU- und Speichernutzung mit top.  M√∂glicherweise sehen Sie so etwas (Server B links und Server A rechts): </p><br><p><img src="https://habrastorage.org/webt/e0/vy/sv/e0vysvislttrfhwpn_vexnwseli.png" alt="Bild"></p><br><p>  Oder so (Server B links und Server A rechts): </p><br><p><img src="https://habrastorage.org/webt/p1/cj/qk/p1cjqk6fxmthbnnexc2ikco9d6a.png"></p><br><p>  Es ist klar, dass der Server B, auf dem die Benchmark-Clientdienste ausgef√ºhrt werden, stark ausgelastet ist.  Der Server A ist ebenfalls stark ausgelastet, jedoch nicht immer.  Manchmal k√ºhlt es ab, w√§hrend der Server B mit der Anzahl der zu erledigenden Aufgaben zu k√§mpfen hat.  Die Verkehrsverschl√ºsselung auf TLS ist sehr CPU-intensiv. </p><br><p>  Stoppen wir die Server (dr√ºcken Sie mehrmals Strg-C) und √§ndern Sie das Protokoll wie zuvor, jedoch in Bezug auf die ge√§nderte Anzahl von Benchmark-Diensten (224): </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">':%s/ms/^V^M/g\n:%g/^$/d\nGdd1G224/Sockets\n224\ndggZZ'</span></span> | vi <span class="hljs-variable"><span class="hljs-variable">$i</span></span> awk -v avg=0 <span class="hljs-string"><span class="hljs-string">'{rps=($1/$5);avg+=rps;}END{print ((avg*1000)/NR)*224}'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br><p>  M√∂glicherweise m√∂chten Sie auch mehrere letzte Zeilen l√∂schen, um zu ber√ºcksichtigen, dass Ausdrucke das Beenden von Benchmark-Diensten verhindern.  Sie haben bereits eine Idee, wie das geht.  Also werde ich die Ergebnisse f√ºr verschiedene Testszenarien ver√∂ffentlichen und mit Problemen fortfahren, mit denen ich konfrontiert bin. </p><br><h1 id="results-for-all-the-other-tests-49-million-and-beyond">  Ergebnisse f√ºr alle anderen Tests (4,9 Millionen und mehr) </h1><br><p><img src="https://habrastorage.org/webt/az/4a/at/az4aatexickfttbrom2gg3yrymu.png"></p><br><div class="spoiler">  <b class="spoiler_title">Test # 4 laden</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ra/ka/_f/raka_fia7i2vnqhwh2p-5lnulc8.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Test # 5 laden</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ln/z5/ml/lnz5mlaoz7aclxuyvjwjpwj25jm.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Test Nr. 5 f√ºr gleiche CPU-Freigabe ausgeglichen</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/vi/cy/fe/vicyfenhzk7uvcjsiohq950c9fa.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Test Nr. 6</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/7h/bg/ez/7hbgezb4zxuv3ijuemjmkilf110.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Test Nr. 8</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/gq/5_/uj/gq5_uje-nnkfhlqmilb7xnbu5tc.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Test Nr. 12</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/xa/tr/m9/xatrm9dbbaha13w9wjxzmecvxjm.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Test Nr. 13</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/-w/9t/i8/-w9ti8atzczna-9dvepihihlyqu.png"></p></div></div><br><h1 id="problems">  Probleme. </h1><br><p>  In der obigen Tabelle rot markiert. </p><br><p>  Das Ausf√ºhren von mehr als 224 Benchmark-Instanzen auf Server B erwies sich als schlechte Idee, da der Server auf der Clientseite nicht in der Lage war, die CPU-Zeit gleichm√§√üig auf Prozesse / Threads zu verteilen.  Die ersten 224 Benchmark-Instanzen, die alle Verbindungen hergestellt haben, beanspruchten den gr√∂√üten Teil der CPU-Ressourcen, und die √ºbrigen Benchmark-Instanzen bleiben zur√ºck.  Selbst die Verwendung von renice -20 hilft nicht viel (448 Benchmark-Instanzen, 2 LAppS-Instanzen): </p><br><div class="spoiler">  <b class="spoiler_title">448 Benchmark-Instanzen</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/a2/ms/bg/a2msbgjgzuwvzzdl332linmmq98.png"><br>  Der Server B (linke Seite) ist sehr stark ausgelastet und der Server A verf√ºgt weiterhin √ºber freie CPU-Ressourcen. </p></div></div><br><p>  Also habe ich die <strong>Benchmark.max_connections</strong> verdoppelt, anstatt mehr separate LAppS-Instanzen zu starten. </p><br><p>  Damit 12,3 Millionen WebSockets ausgef√ºhrt werden k√∂nnen, habe ich die f√ºnfte LAppS-Instanz (Test 5 und 6) gestartet, ohne vier bereits ausgef√ºhrte zu stoppen.  Und spielte die Rolle von CFQ, indem priorisierte Prozesse mit <em>kill -STOP / -CONT</em> oder / manuell angehalten und neu <em>gestartet wurden</em> und deren Priorit√§ten neu festgelegt wurden.  Sie k√∂nnen hierf√ºr das folgende Vorlagenskript verwenden: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> [ 1 ]; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -STOP &lt;4 fast-processes pids&gt; sleep 10 <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -CONT &lt;4 fast-processes pids&gt; sleep 5 <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p>  Willkommen zu 2019 RHEL 7.6!  Ehrlich gesagt habe ich den Befehl renice zum ersten Mal seit 2009 verwendet. Was am schlimmsten ist - ich habe ihn diesmal fast erfolglos verwendet. </p><br><p>  Ich hatte ein Problem mit der Scatter-Gather-Engine der NICs.  Deshalb habe ich es f√ºr einige Tests deaktiviert und dieses Ereignis nicht in der Tabelle markiert. </p><br><p>  Ich hatte teilweise Verbindungsunterbrechungen unter hoher Last und den NIC-Treiberfehler, daher musste ich verwandte Testergebnisse verwerfen. </p><br><h1 id="end-of-story">  Ende der Geschichte </h1><br><p>  Ehrlich gesagt verliefen die Tests viel reibungsloser als ich erwartet hatte. </p><br><p>  Ich bin √ºberzeugt, dass es mir nicht gelungen ist, LAppS auf Server A in vollem Umfang (ohne SSL) zu laden, da ich nicht gen√ºgend CPU-Ressourcen f√ºr die Clientseite hatte.  Obwohl TLS 1.3 aktiviert war, nutzte das LAppS auf Server A fast alle verf√ºgbaren CPU-Ressourcen. </p><br><p>  Ich bin immer noch davon √ºberzeugt, dass LAppS der skalierbarste und schnellste WebSockets-Open-Source-Server auf dem <strong>Markt</strong> ist und das <strong>cws-</strong> WebSockets-Clientmodul das einzige seiner Art ist, das den Rahmen f√ºr Hochlasttests bietet. </p><br><p>  Bitte √ºberpr√ºfen Sie die Ergebnisse auf Ihrer eigenen Hardware. </p><br><p>  Hinweis: Verwenden Sie niemals Nginx oder Apache als Load Balancer oder als Proxy-Pass f√ºr WebSockets, da sonst die Leistung in der Gr√∂√üenordnung sinkt.  Sie sind nicht f√ºr WebSockets erstellt. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de460847/">https://habr.com/ru/post/de460847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de460837/index.html">Podcast-Handbuch f√ºr Anf√§nger</a></li>
<li><a href="../de460839/index.html">Starten Sie Predator - Precompiled Data Repositories</a></li>
<li><a href="../de460841/index.html">TOP-23 Sprachlern-Apps</a></li>
<li><a href="../de460843/index.html">Einf√ºhrung in den neuen 3CX Call Flow Designer und den 3CX CRM Template Generator</a></li>
<li><a href="../de460845/index.html">Fernando Corbato, der Vater Ihres Computers (und Passworts), starb im Alter von 93 Jahren</a></li>
<li><a href="../de460849/index.html">Teil 4. Ein Diagrammmodell zur Berechnung logischer Funktionen f√ºr asynchrone parallele Prozesse</a></li>
<li><a href="../de460851/index.html">SamsPcbGuide, Teil 10: Technologie - L√∂ten bleifreier Komponenten</a></li>
<li><a href="../de460855/index.html">Wie verwende ich PHP zur Implementierung von Microservices?</a></li>
<li><a href="../de460857/index.html">Wie Namecoin Blockchain Research RTM-Cyber-Angriffe vorhersagte</a></li>
<li><a href="../de460859/index.html">IThink # 3 Konferenz in Kharkov - basierend auf WWDC 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>