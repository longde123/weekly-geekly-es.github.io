<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÜüèΩ üïì üë∏üèæ VVVVVV ??? VVVVVV !!! :) ü§Ø üë®üèª‚Äç‚öïÔ∏è üõÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si vous lisez ce texte, cela signifie que vous avez pens√© que quelque chose n'allait pas avec le titre de l'article, ou que vous y avez vu le nom d'un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>VVVVVV ??? VVVVVV !!! :)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/484166/">  Si vous lisez ce texte, cela signifie que vous avez pens√© que quelque chose n'allait pas avec le titre de l'article, ou que vous y avez vu le nom d'un jeu informatique familier.  VVVVVV est un jeu de plateforme ind√©pendant qui a conquis le c≈ìur de nombreux joueurs avec sa simplicit√© externe agr√©able et sa complexit√© interne tout aussi agr√©able.  Il y a quelques jours, VVVVVV a eu 10 ans, et l'auteur du jeu - Terry Cavanagh - a c√©l√©br√© cette f√™te avec la publication de son code source.  Qu'est-ce qui est ¬´savoureux¬ª?  Lisez la r√©ponse dans cet article. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/i1/ij/g8/i1ijg8lekultgdxwi426mbnaers.png" alt="Figure 1"></div><br><a name="habracut"></a><br><h2>  Pr√©sentation </h2><br>  Oh, VVVVVV ... Je me souviens comment je l'ai rencontr√© peu de temps apr√®s la sortie, et, √©tant un grand fan de jeux r√©tro pixel, je l'ai heureusement install√© sur mon ordinateur.  Je me souviens de mes premi√®res impressions: ¬´Et alors, c'est tout?  Il suffit de courir dans les pi√®ces carr√©es? ¬ªJ'ai pens√© apr√®s quelques minutes de jeu.  Je ne savais pas encore ce qui m'attendait.  D√®s que j'ai quitt√© le lieu de d√©part, je me suis retrouv√© dans un monde bidimensionnel petit mais confus et orn√©, plein de paysages inhabituels et d'artefacts de pixels inconnus de moi. <br><br>  Ce jeu m'a entra√Æn√©.  Malgr√© la grande complexit√©, habilement battue par le contr√¥le inhabituel de l'√©poque (le personnage principal ne sait pas sauter, mais est capable d'inverser la direction du vecteur de gravit√© pour moi), je l'ai compl√®tement d√©pass√©.  Je ne sais pas combien de fois mon personnage est mort √† ce moment-l√†, mais je suis s√ªr que le nombre de morts se mesure en dizaines de centaines.  Pourtant, il y a un charme unique dans ce jeu :) <br><br>  Revenons au code source <a href="https://habr.com/ru/post/483518/">pr√©sent√© en l'honneur de l'anniversaire du jeu</a> . <br><br>  En ce moment, je suis C ++ - le d√©veloppeur de l'√©quipe PVS-Studio - un analyseur de code statique pour C, C ++, C # et Java.  En plus du d√©veloppement lui-m√™me, nous sommes √©galement engag√©s dans la promotion de notre produit.  Pour nous, l'une des meilleures fa√ßons de le faire est d'√©crire des articles sur la v√©rification des projets open source.  Nos lecteurs re√ßoivent des articles int√©ressants sur des sujets de programmation, et nous avons l'occasion de d√©montrer clairement les capacit√©s de PVS-Studio.  Par cons√©quent, lorsque j'ai appris l'ouverture du code source VVVVVV, je ne pouvais tout simplement pas passer. <br><br>  Dans cet article, nous examinerons quelques erreurs int√©ressantes trouv√©es par l'analyseur PVS-Studio dans le code VVVVVV, ainsi qu'une analyse d√©taill√©e de ces erreurs.  Remettez le vecteur de gravit√© en position ¬´basse¬ª et asseyez-vous: nous commen√ßons! <br><br><h2>  Aper√ßu des alertes √©mises par l'analyseur </h2><br><h3>  Avertissement 1 </h3><br>  <a href="https://www.viva64.com/ru/w/v512/">V512</a> Un appel de la fonction 'sprintf' entra√Ænera un d√©bordement de la m√©moire tampon 'fileSearch'.  FileSystemUtils.cpp 307 <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_PATH 260 .... void PLATFORM_migrateSaveData(char *output) { char oldLocation[MAX_PATH]; char newLocation[MAX_PATH]; char oldDirectory[MAX_PATH]; char fileSearch[MAX_PATH]; .... </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Same place, different layout. */</span></span></span><span class="hljs-meta"> strcpy(oldDirectory, output); sprintf(fileSearch, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s\\*.vvvvvv"</span></span></span><span class="hljs-meta">, oldDirectory); .... }</span></span></code> </pre> <br>  Comme vous pouvez le voir, les <i>lignes</i> <i>fileSearch</i> et <i>oldDirectory</i> ont la m√™me taille: 260 caract√®res.  La cha√Æne de formatage (le troisi√®me argument de <i>sprintf</i> ) apr√®s avoir remplac√© le contenu de la cha√Æne <i>oldDirectory</i> en elle ressemblera √† ceci: <br><br><pre> <code class="cpp hljs">&lt;i&gt;_oldDirectory\*.vvvvvv&lt;/i&gt;</code> </pre> <br>  Cette cha√Æne fait 9 caract√®res de plus que l'ancien <i>r√©pertoire d'</i> origine.  C'est cette s√©quence de caract√®res qui sera ensuite √©crite dans <i>fileSearch</i> .  Que se passe-t-il si la cha√Æne <i>oldDirectory</i> d√©passe 251?  La cha√Æne r√©sultante sera plus longue que <i>fileSearch</i> ne peut accepter, ce qui entra√Ænera l'√©criture en dehors du tableau.  Quel type de donn√©es dans la RAM peut √™tre endommag√© et quel r√©sultat cela conduira √† une question rh√©torique :) <br><br><h3>  Avertissement 2 </h3><br>  <a href="https://www.viva64.com/ru/w/v519/">V519</a> La variable 'background' re√ßoit des valeurs successives deux fois.  C'est peut-√™tre une erreur.  V√©rifier les lignes: 1367, 1373. Map.cpp 1373 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> mapclass::loadlevel(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-comment"><span class="hljs-comment">//The Warpzone tmap = warplevel.loadlevel(rx, ry, game, obj); fillcontent(tmap); roomname = warplevel.roomname; tileset = 1; background = 3; // &lt;= dwgfx.rcol = warplevel.rcol; dwgfx.backgrounddrawn = false; warpx = warplevel.warpx; warpy = warplevel.warpy; background = 5; // &lt;= if (warpy) background = 4; if (warpx) background = 3; if (warpx &amp;&amp; warpy) background = 5; break; .... }</span></span></code> </pre> <br>  Une m√™me variable se voit attribuer une valeur deux fois de suite.  De plus, entre les affectations, cette variable n'est utilis√©e nulle part.  √âtrange ... Peut-√™tre que cette s√©quence ne viole pas la logique du programme, mais de telles affectations en elles-m√™mes parlent d'une certaine confusion lors de l'√©criture de code.  Que ce soit r√©ellement une erreur ne peut √™tre dit que par l'auteur.  Bien qu'il existe des exemples plus brillants de cette erreur dans le code: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Game::loadquick(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"frames"</span></span>) { frames = atoi(pText); frames = <span class="hljs-number"><span class="hljs-number">0</span></span>; } .... }</code> </pre> <br>  Il est d√©j√† clair ici que quelque part ici se trouve soit une erreur de logique, soit au moins une affectation inutile.  Peut-√™tre que la deuxi√®me ligne a √©t√© √©crite temporairement pour le d√©bogage, puis ils ont oubli√© de la supprimer.  Au total, PVS-Studio a √©mis 8 avertissements concernant de telles situations. <br><br><h3>  Avertissement 3 </h3><br>  <a href="https://www.viva64.com/ru/w/v808/">V808</a> L'objet 'pKey' de type 'basic_string' a √©t√© cr√©√© mais n'a pas √©t√© utilis√©.  editor.cpp 1866 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> editorclass::load(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp;_path) { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pElem-&gt;Value())</span></span></span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"edEntities"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (TiXmlElement *edEntityEl = pElem-&gt;FirstChildElement(); edEntityEl; edEntityEl = edEntityEl-&gt;NextSiblingElement()) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(edEntityEl-&gt;Value())</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= //const char* pText = edEntityEl-&gt;GetText() ; if (edEntityEl-&gt;GetText() != NULL) { edentity[i].scriptname = std::string(edEntityEl-&gt;GetText()); } edEntityEl-&gt;QueryIntAttribute("x", &amp;edentity[i].x); edEntityEl-&gt;QueryIntAttribute("y", &amp;edentity[i].y); edEntityEl-&gt;QueryIntAttribute("t", &amp;edentity[i].t); edEntityEl-&gt;QueryIntAttribute("p1", &amp;edentity[i].p1); edEntityEl-&gt;QueryIntAttribute("p2", &amp;edentity[i].p2); edEntityEl-&gt;QueryIntAttribute("p3", &amp;edentity[i].p3); edEntityEl-&gt;QueryIntAttribute("p4", &amp;edentity[i].p4); edEntityEl-&gt;QueryIntAttribute("p5", &amp;edentity[i].p5); edEntityEl-&gt;QueryIntAttribute("p6", &amp;edentity[i].p6); i++; } EditorData::GetInstance().numedentities = i; } .... }</span></span></code> </pre> <br>  Code tr√®s bizarre.  L'analyseur met en garde contre la variable <i>pKey</i> cr√©√©e mais non utilis√©e, mais en fait, le probl√®me s'est av√©r√© plus int√©ressant.  J'ai sp√©cifiquement marqu√© d'une fl√®che la ligne sur laquelle l'avertissement a √©t√© √©mis, car cette fonction contient plusieurs d√©finitions de ligne avec le nom <i>pKey</i> .  Oui, une autre variable de ce type est d√©clar√©e √† l'int√©rieur de la boucle <i>for</i> et, par son nom, elle chevauche celle d√©clar√©e √† l'ext√©rieur de la boucle. <br><br>  Ainsi, si vous acc√©dez √† la valeur de la cha√Æne <i>pKey en</i> dehors de la boucle <i>for</i> , vous obtiendrez une valeur √©gale √† <i>pElem-&gt; Value ()</i> , mais si vous faites de m√™me √† l'int√©rieur de la boucle, vous obtiendrez une valeur √©gale √† <i>edEntityEl-&gt; Value ()</i> .  Le chevauchement des noms est une erreur plut√¥t grossi√®re, qui peut √™tre tr√®s difficile √† trouver par vous-m√™me lors de la r√©vision du code. <br><br><h3>  Avertissement 4 </h3><br>  Performances <a href="https://www.viva64.com/ru/w/v805/">r√©duites du V805</a> .  Il est inefficace d'identifier une cha√Æne vide en utilisant la construction 'strlen (str)&gt; 0'.  Un moyen plus efficace consiste √† v√©rifier: str [0]! = '\ 0'.  physfs.c 1604 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *prefDir = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PHYSFS_getPrefDir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *org, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *app)</span></span></span><span class="hljs-function"> </span></span>{ .... assert(<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(prefDir) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prefDir; } <span class="hljs-comment"><span class="hljs-comment">/* PHYSFS_getPrefDir */</span></span></code> </pre> <br>  L'analyseur a trouv√© une place pour une microoptimisation potentielle.  Il utilise la fonction <i>strlen</i> pour v√©rifier une cha√Æne de style C pour void.  Cette fonction "parcourt" tous les √©l√©ments de la cha√Æne et v√©rifie chacun pour leur √©galit√© au terminal z√©ro ('\ 0').  Si une grande cha√Æne est entr√©e, chacun de ses caract√®res sera toujours compar√© √† une cha√Æne z√©ro. <br><br>  Mais il suffit de v√©rifier que la cha√Æne n'est pas vide!  Pour ce faire, d√©couvrez simplement si le premier caract√®re de la cha√Æne est un z√©ro terminal.  Par cons√©quent, pour optimiser cette v√©rification √† l'int√©rieur de l'assertion, vous devez √©crire: <br><br><pre> <code class="cpp hljs">str[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'\0'</span></span></code> </pre> <br>  C'est la recommandation que l'analyseur nous donne.  Bien s√ªr, l'appel de la fonction strlen est dans la condition de macro <i>assert</i> , il ne sera donc ex√©cut√© que dans la version de d√©bogage, o√π la vitesse n'est pas si importante.  Dans la version finale, l'appel de fonction dispara√Ætra et le code fonctionnera rapidement.  N√©anmoins, j'ai voulu d√©montrer les capacit√©s de l'analyseur √† proposer des microoptimisations. <br><br><h3>  Avertissement 5 </h3><br>  Pour afficher l'erreur suivante, j'ai besoin de joindre deux <i>morceaux</i> de code ici: la d√©claration de la classe <i>entclass</i> et son constructeur.  Commen√ßons par l'annonce: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">entclass</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: entclass(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clear</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">outside</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-comment"><span class="hljs-comment">//Fundamentals bool active, invis; int type, size, tile, rule; int state, statedelay; int behave, animate; float para; int life, colour; //Position and velocity int oldxp, oldyp; float ax, ay, vx, vy; int cx, cy, w, h; float newxp, newyp; bool isplatform; int x1, y1, x2, y2; //Collision Rules int onentity; bool harmful; int onwall, onxwall, onywall; //Platforming specific bool jumping; bool gravity; int onground, onroof; int jumpframe; //Animation int framedelay, drawframe, walkingframe, dir, actionframe; int yp; int xp; };</span></span></code> </pre> <br>  Le constructeur de cette classe ressemble √† ceci: <br><br><pre> <code class="cpp hljs">entclass::entclass() { clear(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> entclass::clear() { <span class="hljs-comment"><span class="hljs-comment">// Set all values to a default, // required for creating a new entity active = false; invis = false; type = 0; size = 0; tile = 0; rule = 0; state = 0; statedelay = 0; life = 0; colour = 0; para = 0; behave = 0; animate = 0; xp = 0; yp = 0; ax = 0; ay = 0; vx = 0; vy = 0; w = 16; h = 16; cx = 0; cy = 0; newxp = 0; newyp = 0; x1 = 0; y1 = 0; x2 = 320; y2 = 240; jumping = false; gravity = false; onground = 0; onroof = 0; jumpframe = 0; onentity = 0; harmful = false; onwall = 0; onxwall = 0; onywall = 0; isplatform = false; framedelay = 0; drawframe = 0; walkingframe = 0; dir = 0; actionframe = 0; }</span></span></code> </pre> <br>  Assez de champs, non?  Il n'est pas surprenant qu'une erreur se cache ici, √† laquelle PVS-Studio a √©mis un avertissement: <br><br>  <a href="https://www.viva64.com/ru/w/v730/">V730</a> Il est possible que tous les membres d'une classe ne soient pas initialis√©s √† l'int√©rieur du constructeur.  Pensez √† inspecter: oldxp, oldyp.  Ent.cpp 3 <br><br>  Comme vous pouvez le voir, dans une liste si grande, l'initialisation de deux champs de la classe a √©t√© perdue.  Ainsi, leurs valeurs sont rest√©es ind√©finies, √† cause de quoi, ailleurs dans le programme, une valeur inconnue peut √™tre lue et utilis√©e √† partir d'eux.  Il est tr√®s difficile de d√©tecter une telle erreur √† travers les yeux. <br><br><p><img src="https://habrastorage.org/webt/mi/8n/du/mi8nduqzzi75r1jhntbsqwarlns.png" alt="Figure 2"></p><br><br><h3>  Avertissement 6 </h3><br>  Consid√©rez le code: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> mapclass::loadlevel(....) { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; tmap; .... tmap = otherlevel.loadlevel(rx, ry, game, obj); fillcontent(tmap); .... <span class="hljs-comment"><span class="hljs-comment">//  tmap    . }</span></span></code> </pre> <br>  Avertissement PVS-studio: V688 La variable locale 'tmap' poss√®de le m√™me nom que l'un des membres de la classe, ce qui peut entra√Æner une confusion.  Map.cpp 1192 <br><br>  En effet, si vous regardez √† l'int√©rieur de la classe <i>mapclass</i> , vous pouvez y trouver le m√™me vecteur avec le m√™me nom: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mapclass</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; roomdeaths; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; roomdeathsfinal; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; areamap; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; contents; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; explored; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; vmult; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; tmap; <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... };</span></span></code> </pre> <br>  Malheureusement, d√©clarer un vecteur du m√™me nom dans une fonction rend le vecteur d√©clar√© dans la classe invisible.  Il s'av√®re que dans toute la fonction de niveau de <i>charge, le</i> vecteur <i>tmap</i> ne change qu'√† l'int√©rieur de la fonction.  Le vecteur d√©clar√© dans la classe reste inchang√©! <br><br>  Fait int√©ressant, PVS-Studio a d√©couvert jusqu'√† 20 fragments de code de ce type!  Pour la plupart, ils sont associ√©s √† des variables temporaires, qui, par commodit√©, ont √©t√© d√©clar√©es membres de la classe.  L'auteur du jeu (et son seul d√©veloppeur) a lui-m√™me √©crit qu'il avait cette mauvaise habitude.  Vous pouvez lire √† ce sujet dans un article auquel j'ai li√© au d√©but de cet article. <br><br>  Il note √©galement qu'une telle d√©nomination a conduit √† des bogues nuisibles et difficiles √† attraper.  Eh bien, de tels bugs peuvent vraiment √™tre dangereux, mais utiliser une analyse statique pour les d√©tecter ne sera pas difficile :) <br><br><h3>  Avertissement 7 </h3><br>  <a href="https://www.viva64.com/ru/w/v601/">V601</a> Le type entier est implicitement <a href="https://www.viva64.com/ru/w/v601/">converti en</a> type char.  Game.cpp 4997 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Game::loadquick(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"totalflips"</span></span>) { totalflips = atoi(pText); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"hardestroom"</span></span>) { hardestroom = atoi(pText); <span class="hljs-comment"><span class="hljs-comment">// &lt;= } else if (pKey == "hardestroomdeaths") { hardestroomdeaths = atoi(pText); } .... }</span></span></code> </pre> <br>  Pour comprendre quel est le probl√®me, regardons les d√©finitions des variables de la section de code donn√©e: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//Some stats: int totalflips; std::string hardestroom; int hardestroomdeaths;</span></span></code> </pre> <br>  Les variables <i>totalflips</i> et <i>hardestroomdeaths</i> sont de type entier, et donc leur attribuer le r√©sultat √† la fonction <i>atoi</i> est tout √† fait normal.  Mais que se passe-t-il si vous affectez une valeur enti√®re √† <i>std :: string</i> ?  Il s'av√®re que du point de vue de la langue, une telle mission est tout √† fait valable.  En cons√©quence, une valeur incompr√©hensible sera √©crite dans la variable <i>hardestroom</i> ! <br><br><h3>  Avertissement 8 </h3><br>  <a href="https://www.viva64.com/ru/w/v1004/">V1004</a> Le pointeur 'pElem' a √©t√© utilis√© de mani√®re non s√©curis√©e apr√®s avoir √©t√© v√©rifi√© par rapport √† nullptr.  V√©rifiez les lignes: 1739, 1744. editor.cpp 1744 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> editorclass::load(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp;_path) { .... <span class="hljs-function"><span class="hljs-function">TiXmlHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hDoc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;doc)</span></span></span></span>; TiXmlElement *pElem; <span class="hljs-function"><span class="hljs-function">TiXmlHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; version = <span class="hljs-number"><span class="hljs-number">0</span></span>; { pElem = hDoc.FirstChildElement().Element(); <span class="hljs-comment"><span class="hljs-comment">// should always have a valid root // but handle gracefully if it does if (!pElem) { printf("No valid root! Corrupt level file?\n"); } pElem-&gt;QueryIntAttribute("version", &amp;version); // &lt;= // save this for later hRoot = TiXmlHandle(pElem); } .... }</span></span></code> </pre> <br>  L'analyseur avertit que le pointeur <i>pElem est</i> utilis√© de mani√®re non s√©curis√©e imm√©diatement apr√®s avoir √©t√© v√©rifi√© pour <i>nullptr</i> .  Pour vous assurer que l'analyseur a raison, jetez un ≈ìil √† la d√©finition de la fonction <i>Element ()</i> , dont la valeur de retour initialise le pointeur <i>pElem</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** @deprecated use ToElement. Return the handle as a TiXmlElement. This may return null. */</span></span> <span class="hljs-function"><span class="hljs-function">TiXmlElement *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Element</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ToElement(); }</code> </pre> <br>  Comme vous pouvez le voir dans le commentaire, cette fonction peut retourner <i>null</i> . <br><br>  Imaginez maintenant que cela s'est vraiment produit.  Que se passera-t-il dans ce cas?  Le fait est qu'une telle situation ne sera en aucun cas g√©r√©e.  Oui, un message s'affiche indiquant que quelque chose s'est mal pass√©, mais litt√©ralement une ligne sous le pointeur incorrect sera d√©r√©f√©renc√©e.  Un tel d√©r√©f√©rencement, √† son tour, entra√Ænera soit un plantage du programme, soit un comportement ind√©fini.  C'est une erreur assez grave. <br><br><h3>  Avertissement 9 </h3><br>  Dans la section suivante du code, PVS-Studio a √©mis quatre avertissements: <ul><li>  <a href="https://www.viva64.com/ru/w/v560/">V560</a> Une partie de l'expression conditionnelle est toujours vraie: x&gt; = 0. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/ru/w/v560/">V560</a> Une partie de l'expression conditionnelle est toujours vraie: y&gt; = 0. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/ru/w/v560/">V560</a> Une partie de l'expression conditionnelle est toujours vraie: x &lt;40. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/ru/w/v560/">V560</a> Une partie de l'expression conditionnelle est toujours vraie: y &lt;30. editor.cpp 1137 </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> editorclass::at( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(<span class="hljs-number"><span class="hljs-number">0</span></span>,y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(y&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(x,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&gt;=<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(<span class="hljs-number"><span class="hljs-number">39</span></span>,y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(y&gt;=<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(x,<span class="hljs-number"><span class="hljs-number">29</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; y&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; x&lt;<span class="hljs-number"><span class="hljs-number">40</span></span> &amp;&amp; y&lt;<span class="hljs-number"><span class="hljs-number">30</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> contents[x+(levx*<span class="hljs-number"><span class="hljs-number">40</span></span>)+vmult[y+(levy*<span class="hljs-number"><span class="hljs-number">30</span></span>)]]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Tous les avertissements s'appliquent √† la derni√®re instruction <i>if</i> .  Le probl√®me est que les quatre v√©rifications qui y sont effectu√©es renverront toujours <i>true</i> .  Je ne dirais pas que c'est une grave erreur, mais cela s'est av√©r√© assez dr√¥le.  L'auteur a d√©cid√© de prendre cette fonction au s√©rieux et, au cas o√π, a de nouveau v√©rifi√© chaque variable :) <br><br>  Cette v√©rification peut √™tre supprim√©e, car  le thread d'ex√©cution n'atteindra jamais l'expression " <i>return 0;</i> " de toute fa√ßon.  Bien que cela ne change pas la logique du programme, cela le lib√©rera des contr√¥les inutiles et du code mort. <br><br><h3>  Avertissement 10 </h3><br>  Dans son article sur l'anniversaire du jeu, Terry dit avec ironie que l'un des √©l√©ments qui contr√¥lent la logique du jeu √©tait un √©norme changement de la fonction <i>Game :: updatestate ()</i> , qui est imm√©diatement responsable d'un grand nombre d'√©tats de jeu diff√©rents.  Et il √©tait assez attendu que je trouve l'avertissement suivant: <br><br>  <a href="https://www.viva64.com/ru/w/v2008/">V2008</a> Complexit√© cyclomatique: 548. Envisagez de refactoriser la fonction 'Game :: updatestate'.  Game.cpp 612 <br><br>  Oui, vous avez bien compris: PVS-Studio a estim√© la complexit√© cyclomatique d'une fonction √† 548 unit√©s.  Cinq cent quarante huit !!!  Je comprends cela - "code soign√©".  Et cela malgr√© le fait qu'en fait, il n'y a rien de plus qu'une expression de commutateur dans une fonction.  Dans le commutateur lui-m√™me, j'ai compt√© plus de 300 expressions de cas. <br><br>  Dans notre bureau, il y a une petite comp√©tition entre les auteurs pour l'article le plus long.  J'apporterais volontiers tout le code de fonction ici (3450 lignes), mais une telle victoire serait malhonn√™te, donc je me limiterai √† me <a href="">r√©f√©rer</a> simplement √† l'√©norme commutateur.  Je recommande de le suivre et d'√©valuer toute l'√©chelle vous-m√™me!  Soit dit en passant, en plus de <i>Game :: updatestate ()</i> , PVS-Studio a trouv√© jusqu'√† 44 fonctions avec une complexit√© cyclomatique excessive, dont 10 ont une complexit√© de plus de 200. <br><br><p><img src="https://habrastorage.org/webt/pu/s9/a2/pus9a2tqqeyzmdkg90auf5r2d0q.png" alt="Figure 3"></p><br><br><h2>  Conclusion </h2><br>  Je pense que les erreurs √©crites suffisent pour l'article.  Oui, il y a eu beaucoup d'erreurs dans le projet, mais c'est exactement l'astuce: apr√®s avoir pr√©sent√© son code, Terry Cavanagh a montr√© qu'il n'√©tait pas n√©cessaire d'√™tre un bon programmeur pour faire un bon jeu.  Maintenant, apr√®s 10 ans, Terry se souvient de ces moments avec ironie.  Il est important d'apprendre de vos erreurs et la pratique est la meilleure fa√ßon de le faire.  Et si votre pratique peut encore donner naissance √† un jeu comme VVVVVVV, alors c'est g√©n√©ralement magnifique!  Ehh ... je vais y aller et je vais probablement y jouer √† nouveau :) <br><br>  Ce ne sont pas toutes les erreurs trouv√©es dans le code du jeu.  Si vous voulez voir par vous-m√™me ce que vous pouvez trouver d'autre, je vous sugg√®re de <a href="https://www.viva64.com/ru/pvs-studio-download/">t√©l√©charger et d'essayer PVS-Studio</a> !  N'oubliez pas non plus que pour les projets open source, nous <a href="https://www.viva64.com/ru/b/0614/">fournissons une</a> licence gratuite. <br><br><p> <a href="https://habr.com/en/company/pvs-studio/blog/484388/"><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png" align="left"></a> </p><br><br>  Si vous souhaitez partager cet article avec un public anglophone, veuillez utiliser le lien vers la traduction: George Gribkov.  <a href="https://habr.com/en/company/pvs-studio/blog/484388/">VVVVVV ???</a>  <a href="https://habr.com/en/company/pvs-studio/blog/484388/">VVVVVV !!!</a>  <a href="https://habr.com/en/company/pvs-studio/blog/484388/">:)</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr484166/">https://habr.com/ru/post/fr484166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr484150/index.html">5 nouveaux outils pour cr√©er du contenu amusant</a></li>
<li><a href="../fr484152/index.html">Contr√¥leur PAC haute vitesse WISE-5580</a></li>
<li><a href="../fr484154/index.html">M√©thode de r√©solution du syst√®me d'√©quations diophantiennes</a></li>
<li><a href="../fr484160/index.html">Talent insaisissable: la Russie perd les meilleurs professionnels de l'informatique</a></li>
<li><a href="../fr484164/index.html">L'histoire du livre et l'avenir des biblioth√®ques</a></li>
<li><a href="../fr484168/index.html">Nous √©crivons notre strat√©gie de d√©filement virtuel depuis Angular CDK</a></li>
<li><a href="../fr484170/index.html">Mettre √† jour Check Point de R77.30 √† 80.20</a></li>
<li><a href="../fr484172/index.html">Int√©gration continue dans Unity: comment r√©duire le temps d'assemblage et √©conomiser des ressources + ligne de paiement en cadeau</a></li>
<li><a href="../fr484174/index.html">Castle buvant dans des conditions "extr√™mes" ou comment nous avons particip√© au spectacle "DOZOR"</a></li>
<li><a href="../fr484176/index.html">Impl√©mentation du mod√®le de statut dans Unity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>