<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüíª üõ≥Ô∏è üíë Controlador de bricolaje de panel LED en CPLD con modulaci√≥n BAM ü¶é üåç ‚õ±Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace alg√∫n tiempo, particip√≥ en una discusi√≥n sobre el proyecto de bricolaje de un reloj LED de matriz. 
 Y lo que me sorprendi√≥: la antigua matriz mo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Controlador de bricolaje de panel LED en CPLD con modulaci√≥n BAM</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/409743/">  Hace alg√∫n tiempo, particip√≥ en una discusi√≥n sobre el proyecto de bricolaje de un reloj LED de matriz. <br>  Y lo que me sorprendi√≥: la antigua matriz monocrom√°tica de LED 8x8 con un paso de 5 mil√≠metros se us√≥ como dispositivo de visualizaci√≥n.  Adem√°s, se crearon placas de circuito impreso complejas para ellos, se realiz√≥ una indicaci√≥n din√°mica suave.  Y esto es en un momento en que los paneles LED 64x32 a todo color ya listos con un paso de 3 mm han estado disponibles durante mucho tiempo a un precio de $ 10-20.  Y la variedad general de estos paneles es muy grande y tiene un paso de p√≠xeles de 2 a 10 mm y casi cualquier tama√±o. <br><a name="habracut"></a><br>  Al mismo tiempo, el uso de tales paneles en dise√±os de bricolaje es bastante dif√≠cil: los controladores prefabricados cuestan bastante dinero y no tienen una API normal.  Es bastante dif√≠cil hacer un escaneo bastante r√°pido del panel en microcontroladores com√∫nmente utilizados en bricolaje.  Adem√°s, los intervalos de tiempo deben mantenerse con alta precisi√≥n; de lo contrario, comienza un notable desnivel del brillo. <br><br>  Hay buenas soluciones en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Adafruit</a> , pero todas son bastante caras y complejas. <br><br>  Despu√©s de pensarlo un poco, surgi√≥ el pensamiento: ¬øpor qu√© no hacer una placa extremadamente econ√≥mica que ser√° un puente entre una penique com√∫n como un arduino y un panel LED?  Despu√©s de un par de meses de alboroto, naci√≥ algo que funciona. <br><br>  Este art√≠culo describe la segunda versi√≥n mejorada del controlador. <br><cut><br><h2>  Desaf√≠o </h2><br>  Como tarea b√°sica, quer√≠a poder controlar un panel con un tama√±o total de al menos 64x64, mientras ten√≠a la capacidad de trabajar al menos en Highcolor (RGB565) mientras manten√≠a una frecuencia de actualizaci√≥n de pantalla aceptable (al menos 50Hz).  En la primera versi√≥n del controlador, la tarea b√°sica se implement√≥ por completo, pero surgi√≥ la idea de implementar la tarea por otro m√©todo muy prometedor, del cual naci√≥ la segunda versi√≥n. <br><br><h2>  Explicaci√≥n b√°sica del dise√±o de un panel LED t√≠pico. </h2><br>  Interfaz de entrada HUB75: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2d/yn/gt/2dyngtqqelfmxsb9iseipe2c29u.jpeg"></div><br>  En cada entrada de color hay una cadena de registros del tipo HC595 (pero versiones especiales de 16 canales para LED).  Hay tantos registros que son suficientes para el ancho del panel.  Los permisos de trituraci√≥n, arranque paralelo y salida son comunes a todos los registros.  Las entradas ABCDE, esta es la elecci√≥n de una serie, van a un decodificador convencional. <br><br>  Principio de funcionamiento: <br><br><ul><li>  configure los datos en entradas RGB, haga clic en el bot√≥n CLK.  Repite hasta que carguemos la l√≠nea completa </li><li>  apague las salidas OE = 1 (para que no haya interferencia) </li><li>  dar al decodificador el n√∫mero de la fila cargada </li><li>  haga clic en carga paralela LAT: los datos de l√≠nea se transfieren a los registros de salida <br>  habilitar salidas OE = 0 </li><li>  repetir para la siguiente fila </li></ul><br>  Esa es una indicaci√≥n din√°mica cl√°sica.  Est√° claro que con este m√©todo en uno de esos ciclos solo podemos encender / apagar cada LED espec√≠fico. <br><br>  Para obtener gradaciones de brillo con PWM cl√°sico, dicho ciclo debe repetirse N-1 veces, donde N es el n√∫mero de gradaciones de brillo (256 para RGB888).  Y dado que al mismo tiempo todav√≠a parpadea, todo esto debe hacerse muy, muy r√°pido. <br><br>  Hay una soluci√≥n alternativa: Modulaci√≥n de √°ngulo de bit (BAM).  En este caso, el tiempo de brillo en cada ciclo es proporcional al peso del bit mostrado.  Es decir, para RGB888 solo necesita 8 ciclos de visualizaci√≥n.  Un poco m√°s detallado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br>  La primera versi√≥n del controlador us√≥ PWM cl√°sico, que impuso un l√≠mite estricto en el n√∫mero de ciclos de escaneo.  En la segunda versi√≥n, se implementa BAM, que dio una gran ganancia en velocidad. <br><br><h2>  Implementaci√≥n </h2><br>  Era bastante obvio que un microcontrolador convencional tira solo de paneles peque√±os, los grandes simplemente no tienen suficiente velocidad.  Por lo tanto, CPLD o FPGA son indispensables aqu√≠: es f√≠sicamente imposible producir decenas de MB / s en microcontroladores de bajo costo. <br><br>  Como memoria, fui recomendado en el foro IXBT por la muy interesante memoria FIFO Averlogic AL422B, que tiene aproximadamente 400kbytes de memoria y puede operar a frecuencias de hasta 50MHz. <br><br>  Teniendo en cuenta que mi requisito principal era el bajo costo m√°ximo de los componentes, para que la bufanda terminada fuera accesible para los fabricantes caseros, se eligi√≥ el Altera EPM3064 - CPLD con 64 macroc√©lulas.  Al mismo tiempo, un n√∫mero tan peque√±o de macroc√©lulas no permite hacer una placa configurable din√°micamente; la configuraci√≥n debe compilarse directamente en CPLD. <br><br>  ‚Üí El circuito resultante se encuentra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> <br><br>  Detalles: <br><br><ul><li>  CPLD EPM3064ATC44-10: el precio de Ali es de aproximadamente $ 13-15 por una docena </li><li>  FIFO RAM AL422B: el precio de Ali es de aproximadamente $ 15 por docena </li><li>  Oscilador de cristal de 50MHz.  La placa permite la instalaci√≥n en cajas DIP14 / DIP8 / 7050.  El precio de Ali es de aproximadamente $ 6-7 por docena </li><li>  Estabilizador de 3.3V en el paquete SOT223.  Precio en Chip and Dip - 40r cada uno </li><li>  Conector IDC-10MS.  Precio en Chip &amp; Dip - 3 p / pieza </li><li>  Conector IDC-16MS.  Precio en Chip &amp; Dip - 8 r / pieza </li><li>  Conector IDC-14MS.  Precio en Chip &amp; Dip - 7 r / pieza </li><li>  Condensadores 1 microfaradio 0805 - 8 piezas de aproximadamente 1 r / pieza </li><li>  Condensador 0.1uF 0805 - aproximadamente 1 r / pieza </li><li>  Resistencia 10k 0805 - un centavo </li></ul><br>  El total en detalle se obtiene 1.5 + 1.5 + 0.7 = $ 3.7 y 40 + 3 + 8 + 7 + 8 * 1 + 1 = 67 p.  Todos juntos dentro de $ 5 - un centavo. <br><br>  ‚Üí La imagen original del tablero est√° <a href="">aqu√≠</a> <br><br>  ‚Üí <a href="">Archivos</a> gerber preparados <a href="">para ordenar</a> <br><br>  La placa est√° preparada para la primera versi√≥n, en la que no hubo control de RE.  Para usarlo con la segunda versi√≥n, debe cortar el puente entre los terminales 23 y 24 de AL422B y tirar los cables desde el terminal 28 de EPM3064 (se lleva al bloque de terminales) al terminal 24 de AL422B. <br><br>  Al soldar la placa, no olvide soldar los puentes de alimentaci√≥n en la parte posterior de la placa. <br><br><img src="https://habrastorage.org/webt/y6/hy/i6/y6hyi6obrqqyyybfvractvmtuqy.jpeg"><br><br><img src="https://habrastorage.org/webt/u1/n1/jr/u1n1jr2zzs7sqfwpzxji2xpg2pg.jpeg"><br><br><h2>  C√°lculos </h2><br>  Los c√°lculos de los par√°metros requeridos son bastante complicados. <br><br>  El hecho es que en el controlador se realizan dos procesos en paralelo: cargar los datos de la siguiente l√≠nea / indicar una l√≠nea ya cargada. <br><br>  Los procesos comienzan simult√°neamente, pero terminan en diferentes momentos, por lo que un proceso m√°s r√°pido espera la finalizaci√≥n de un proceso m√°s largo. <br><br>  ‚Üí Se hizo una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tableta Excel</a> para el c√°lculo <br><br>  Datos de origen: <br><br><ul><li>  CRYSTAL_FRQ (MHz) - frecuencia del generador (50 MHz) </li><li>  PIXEL_COUNT: la cantidad de p√≠xeles en la barra de descarga.  M√°s detalles en la secci√≥n de cambio. </li><li>  RGB_INPUTS: el n√∫mero de entradas RGB utilizadas en la interfaz HUB75E del panel utilizado.  1 o 2 </li><li>  BYTES_PER_PIXEL: bytes por p√≠xel.  En nuestro caso, siempre 3 - RGB888 </li><li>  SCAN_LINES: n√∫mero de l√≠neas de escaneo en el panel utilizado.  16/08/32 </li></ul><br>  Par√°metros seleccionados: <br><br><ul><li>  PRE_DELAY - retraso de la se√±al LAT hasta que se enciende el OE, configurado en ticks </li><li>  PRESCALER - preescaler para el contador principal.  Es decir, si la lista de precios es 8 y el peso del bit actual es 4, entonces OE se activar√° durante 8 * 4 = 32 ciclos </li><li>  POST_DELAY: retraso m√≠nimo desde el apagado del OE a la siguiente se√±al LAT, configurada en ticks </li></ul><br>  Por ejemplo, tenemos un panel de 32x32 que tiene 8 l√≠neas de escaneo y 2 entradas RGB.  Dicho panel tiene dos conectores HUB75E, es decir, f√≠sicamente estos son dos paneles de 32x16.  Conectamos estos paneles en serie, es decir, l√≥gicamente este panel se ver√° como 64x16. <br><br>  PRE_DELAY y POST_DELAY son intervalos de supresi√≥n antes y despu√©s de la habilitaci√≥n de salida (OE) para que los multiplexores puedan cambiar las salidas y las teclas abrir / cerrar.  Sin ellos, habr√° "trucos" desde la grabaci√≥n de p√≠xeles hasta las l√≠neas adyacentes.  Los valores se seleccionan experimentalmente para un panel particular.  Por lo general, 15 medidas son suficientes (establecidas en medidas). <br><br>  Esto plantea la cuesti√≥n de elegir el preescalador: c√≥mo elegirlo. <br><br>  Un valor bajo de preescalador proporciona un tiempo de visualizaci√≥n de fotogramas corto, pero reduce el brillo general.  El alto valor del preescalador aumenta el tiempo de visualizaci√≥n del cuadro, es decir, cuando enumera, parpadea la pantalla. <br><br>  Probemos PRESCALER = 1 <br><br>  Obtenemos: <br><br>  OE_EFFICIENCY: 8.3%, es decir, el panel solo funcionar√° 8.3% del brillo m√°ximo posible <br>  FRAMES_PER_SECOND - 2034 fps, pero la frecuencia de actualizaci√≥n de la imagen ser√° enorme: m√°s de 2000 fps. <br><br>  La p√©rdida de brillo ya es muy grande. <br><br>  Probemos PRESCALER = 16 <br><br>  Obtenemos: <br><br>  OE_EFFICIENCY: es decir, el 72,9%, el panel funcionar√° al 72,9% del brillo m√°ximo posible <br>  FRAMES_PER_SECOND - 1117 - y la frecuencia de actualizaci√≥n de la imagen es muy buena: m√°s de 1000 fps. <br>  Bueno, es bastante normal: una eficiencia de m√°s del 50% es bastante normal y la velocidad de fotogramas es muy buena. <br><br>  La regla general es que PRESCALER es aproximadamente 8 veces m√°s peque√±o que el producto PIXEL_COUNT * RGB_INPUTS <br><br>  Bueno, sigue contando y comprobando. <br><br><h2>  Cambiar paneles LED </h2><br>  Todos los paneles est√°n conectados en serie.  Diagrama de conexi√≥n: primero de derecha a izquierda, luego de abajo hacia arriba.  Es decir, primero conectamos las horizontales en serie, luego la salida de la fila inferior a la entrada de la segunda fila desde la parte inferior, etc.  a la fila superior. <br><br>  El controlador se aferra al panel inferior derecho. <br><br>  Hay paneles que tienen dos conectores de entrada y dos de salida.  Tales paneles son esencialmente solo un conjunto mec√°nico de dos paneles verticalmente.  Conmutado como dos paneles independientes. <br><br>  Despu√©s del ensamblaje, necesitamos calcular la longitud total de la cadena en p√≠xeles, para esto vemos cu√°ntos paneles totales hab√≠a en la cadena y multiplicar este n√∫mero por el ancho del panel en p√≠xeles.  Luego, este n√∫mero deber√° introducirse en el valor PIXEL_COUNT durante la configuraci√≥n de CPLD y en la calculadora de temporizaci√≥n. <br><br><h2>  Firmware FPGA </h2><br>  Todos los archivos necesarios est√°n en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github</a> .  Necesita descargar directamente con la carpeta. <br><br>  Despu√©s del registro, debe descargar e instalar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Quartus II 13.0sp1</a> desde el sitio web de Altera.  Necesita descargar EXACTAMENTE ESTA versi√≥n: las versiones m√°s nuevas ya no son compatibles con la serie MAX3000.  No es necesario romperlo: la versi√≥n web (gratuita) es suficiente.  Al descargar, aseg√∫rese de marcar las casillas para MAX3000 y soporte para programadores.  Por si acaso, te advierto: el paquete es grande, aproximadamente dos conciertos.  Tambi√©n necesitar√° Altera USB Blaster: el precio habitual de Ali es de aproximadamente $ 3. <br><br>  Abra el proyecto al422_bam.qpf.  A la izquierda, abra la pesta√±a del archivo y abra el archivo al422_bam.v: este es el archivo principal del proyecto.  En √©l necesitas configurar los par√°metros: <br><br>  Cu√°ntas entradas RGB en un panel: en los paneles con una entrada HUB75 puede haber 1 o 2 entradas RGB.  Para saber exactamente cu√°ntas entradas son posibles de esta manera, tomamos la cantidad de p√≠xeles en el panel verticalmente.  Div√≠dalo por el n√∫mero de l√≠neas de exploraci√≥n (indicadas en la designaci√≥n del panel como 8S, por ejemplo).  Dividir por el n√∫mero de conectores de entrada (1 o 2).  Por ejemplo, tengo un panel de 32x32, escaneo 8S y dos conectores de entrada - 32/8/2 = 2 - lo que significa dos entradas RGB. <br><br><pre><code class="hljs powershell">`define RGB_outs <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  Cu√°ntas l√≠neas de escaneo en el panel, dado que el est√°ndar HUB75E es compatible, puede ser de hasta 32x.  El n√∫mero de l√≠neas de escaneo generalmente est√° en el nombre del panel en forma de 8S / 16S / 32S, respectivamente. <br><br>  Solo una l√≠nea debe ser descomentada: <br><br><pre> <code class="hljs powershell">`define SCAN_x8 <span class="hljs-number"><span class="hljs-number">1</span></span> //`define SCAN_x16 <span class="hljs-number"><span class="hljs-number">1</span></span> //`define SCAN_x32 <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  El n√∫mero total de p√≠xeles horizontales en la cadena.  Los p√≠xeles se consideran en toda la cadena de paneles; consulte la secci√≥n anterior "Cambio de paneles LED" <br><br><pre> <code class="hljs powershell">`define PIXEL_COUNT <span class="hljs-number"><span class="hljs-number">64</span></span></code> </pre><br>  Las fases de las se√±ales de salida.  La configuraci√≥n m√°s t√≠pica es la siguiente: OE est√° activo en un nivel bajo (comentarios eliminados), CLK se est√° ejecutando en el frente (los comentarios est√°n activados), LAT est√° activo en un nivel alto (los comentarios est√°n activados).  Todo tipo de opciones extra√±as son posibles.  Averig√ºe cu√°l tiene solo experimentalmente o quitando el circuito y buscando hojas de datos para los chips usados). <br><br><pre> <code class="hljs powershell">//`define LED_LAT_ACTIVE_LOW <span class="hljs-number"><span class="hljs-number">1</span></span> `define LED_OE_ACTIVE_LOW <span class="hljs-number"><span class="hljs-number">1</span></span> //`define LED_CLK_ON_FALL <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Retraso previo y posterior de la se√±al OE en relaci√≥n con LAT y preescalador para el contador principal.  Ver arriba <br><br><pre> <code class="hljs powershell">`define OE_PRESCALER <span class="hljs-number"><span class="hljs-number">16</span></span> `define OE_PREDELAY <span class="hljs-number"><span class="hljs-number">31</span></span> `define OE_POSTDELAY <span class="hljs-number"><span class="hljs-number">31</span></span></code> </pre><br>  Todos, presione ctrl-L: el proyecto se compila.  Si no lo arruinaste en ninguna parte, habr√° varias advertencias, pero no deber√≠a haber errores.  A continuaci√≥n, conectamos la placa soldada al USB Blaster, aplicamos energ√≠a a la placa.  En Quartus, vaya a herramientas - programador.  Seleccione USB-blaster en la configuraci√≥n de hardware, haga clic en Inicio.  Eso es todo, CPLD est√° programado. <br><br><h2>  Pieza de microcontrolador </h2><br>  La salida de datos al controlador, en general, es extremadamente simple: restablecemos la direcci√≥n de escritura y luego emitimos secuencialmente bytes de datos, acarici√°ndolos con la se√±al WCLK.  Y parece que incluso un arduinka banal es suficiente para el trabajo.  Pero hay dos problemas: <br><br>  a) Se necesita mucha memoria.  Incluso un peque√±o panel de 32x32 en modo RGB888 requiere 3kBytes de memoria para un b√∫fer de pantalla.  El Atmega328 ordinario basado en Arduino contiene solo 2kbytes de RAM.  Por supuesto, puede usar una placa Mega basada en Atmega2560, que contiene hasta 8 kB de RAM, pero incluso esto no es suficiente para paneles de tama√±o normal: un panel de 128x64 en modo RGB565 requiere 16kB de memoria. <br><br>  b) En el proceso de trabajar con AL422B, surgi√≥ un problema t√©cnico que no se document√≥ en ninguna parte: al escribir datos a una velocidad de menos de 2 MB / s, el contador de direcciones no funciona correctamente y escribe datos "no all√≠".  Quiz√°s este sea un fallo de mi fiesta.  Quiz√°s no.  Pero esta falla tiene que ser evitada.  Dado que el AVR8 funciona a 16 MHz, es casi imposible obtener datos a las velocidades deseadas. <br><br>  La soluci√≥n propuesta es buscar bufandas baratas basadas en el controlador STM32F103C8T6 de 32 bits.  Tal bufanda le cuesta a Ali alrededor de $ 2.5 por pieza, o alrededor de $ 1.7 al comprar una docena, es decir, incluso m√°s barato que un Arduino Nano.  Al mismo tiempo, tenemos un microcontrolador completo de 32 bits que funciona a 72 MHz y tiene 20 kB de RAM y 64 kB de flash (comp√°relo con el Atmega328 de 2kB / 8kB, que est√° en Nano). <br><br>  Al mismo tiempo, estas placas se programan con bastante √©xito en el entorno Arduino.  Sobre esto hay un buen art√≠culo sobre el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">reloj</a> , por lo que no lo duplicar√©.  En general, haga todo como se describe en el art√≠culo. <br><br>  En un entorno arduino, elija la placa gen√©rica STM32F103C, variante STM32F103C8.  Los datos pasan por DMA, por lo que puede usar cualquier opci√≥n de optimizaci√≥n. <br><br>  El cambio ocurre de la siguiente manera: <br><br>  Firmemente clavado en la biblioteca: <br>  A0..A7 ‚Üí DI0..DI7 AL422B <br>  B0 ‚Üí WCLK AL422B <br>  B1 ‚Üí WRST AL422B <br><br>  Asignado en un boceto al controlador: <br>  B10 ‚Üí NOSOTROS AL422B <br><br>  Cable com√∫n: <br>  G ‚Üí GND <br><br>  Bueno, no olvide suministrar energ√≠a de 5V / GND desde el panel a los pines del controlador correspondientes. <br><br>  Retira el pinout del conector del controlador del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">circuito</a> . <br><br><img src="https://habrastorage.org/webt/nh/p7/_y/nhp7_ygm9hqmkawess06ypt1oy4.jpeg"><br><br><h2>  Parte de software </h2><br>  Dado que la tarea era hacer que todo fuera lo m√°s simple y asequible posible, todo el software se cre√≥ para el entorno Arduino y se dise√±√≥ como una biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">LED_PANEL</a> . <br><br>  La biblioteca LED-PANEL utiliza activamente la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Adafruit GFX</a> , por lo que debe instalarse. <br><br>  Recomiendo no poner la biblioteca LED_PANEL en el directorio de bibliotecas, sino dejarla en la carpeta de bocetos.  El hecho es que hay muchos par√°metros vinculados al hierro, y si desea transferir el trabajo a un microcontrolador m√°s "gordo", tendr√° que cambiar muchas cosas en el c√≥digo mismo. <br><br>  La inicializaci√≥n es aproximadamente de la siguiente forma: <br><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"LED_PANEL.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> width 32 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> height 32 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> bpp 3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> scan_lines 8 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RGB_inputs 2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> we_out_pin PB10 LED_PANEL led_panel = LED_PANEL(width, height, bpp, scan_lines, RGB_inputs, we_out_pin);</span></span></code> </pre><br>  es decir, creamos una instancia de la clase LED_PANEL, para la cual especificamos los par√°metros: <br><br>  ancho: el ancho total del panel en p√≠xeles (total) <br>  altura: la altura total del panel en p√≠xeles (total) <br>  bpp: byte por p√≠xel, 3 para RGB888.  La versi√≥n BAM solo funciona en RGB888 <br>  scan_lines: el n√∫mero de l√≠neas de exploraci√≥n es 8/16/32.  Debe corresponder al modo flasheado en el controlador. <br>  Entradas_ RGB: el n√∫mero de entradas RGB en el conector HUB75 es 1/2.  Debe corresponder al modo flasheado en el controlador. <br>  we_out_pin - pin al que se conecta la salida WE <br><br>  Tenga en cuenta que durante la inicializaci√≥n, solo se especifica el pin WE.  Todos los dem√°s pines se registran r√≠gidamente en el c√≥digo, ya que est√°n vinculados al temporizador utilizado y los canales DMA y su cambio conllevar√° cambios significativos en el c√≥digo. <br><br>  Inicio y borrado de la pantalla en la secci√≥n de configuraci√≥n: <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">led_panel</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.begin</span></span>(); <span class="hljs-selector-tag"><span class="hljs-selector-tag">led_panel</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.clear</span></span>();</code> </pre><br>  comenzar inicializa los pines necesarios a la salida, conecta un temporizador y DMA <br>  clear limpia el b√∫fer <br><br>  Para dibujar, puede utilizar todos los procedimientos est√°ndar de la biblioteca Adafruit GFX, desde el drawPixel m√°s simple hasta la salida de texto.  Para dar salida a los procedimientos dibujados al b√∫fer se utilizan: <br><br><pre> <code class="hljs pgsql">led_panel.<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>();</code> </pre><br>  De esta forma, show inicia la transferencia de datos al controlador a trav√©s de DMA e inmediatamente devuelve el control.  Averig√ºe si la transferencia ha finalizado con la ayuda de la funci√≥n led_panel.OutIsFree (): si dice verdadero, la transferencia ha finalizado.  Hay una funci√≥n: si llama a show cuando la transferencia a√∫n no se ha completado, simplemente se ignorar√°. <br><br><pre> <code class="hljs pgsql">led_panel.<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);</code> </pre><br>  an√°logo de show (), pero si llama a show (false) y la transferencia a√∫n no se ha completado, el procedimiento esperar√° a que se complete la transferencia, luego comience una nueva transferencia y regrese el control: <br><br><pre> <code class="hljs pgsql">led_panel.<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>);</code> </pre><br>  an√°logo de show (falso), pero si llama a show (true), luego del inicio de una nueva transferencia, el procedimiento no devolver√° el control hasta que se complete la transferencia. <br><br>  En general, eso es todo. <br><br><img src="https://habrastorage.org/webt/pn/-a/of/pn-aofhwnhuuzszuk_mcf9upqje.jpeg"><br><br>  Algunas notas sobre el software: <br><br>  a) La correcci√≥n gamma se introduce al recalcular el color de RGB565 (que la biblioteca usa) con la funci√≥n ExpandirColor.  En todos los dem√°s casos, se utiliza una funci√≥n de transferencia lineal, es decir, el brillo es directamente proporcional al valor. <br>  b) El software le permite conectar m√∫ltiples controladores LED a una placa de microcontrolador.  Para hacer esto, env√≠e el bus de datos, las l√≠neas RST y CLK a los controladores en paralelo.  El controlador deseado se selecciona a trav√©s de la l√≠nea WE.  En el software, debe crear una instancia separada de la clase LED_PANEL para cada controlador, y cada instancia debe tener diferentes l√≠neas WE (el √∫ltimo par√°metro) durante la inicializaci√≥n. <br><br><h2>  Hacer </h2><br>  - Tratar con la "recogida" de flores en las filas vecinas.  Parece un mal cableado del panel en s√≠ (las teclas est√°n ensuciando), pero debe verificarlo.  Acabo de llegar un nuevo panel, lo comprobar√©; <br>  - Haga una nueva versi√≥n de la placa, con RE ya divorciada y la adici√≥n de convertidores de nivel de salida en 5V; <br>  - Haga la clase META_LED_PANEL, que permitir√° combinar varios LED_PANEL en una pantalla virtual; esto permitir√° crear pantallas muy grandes con varios controladores; <br>  - En el futuro, vaya a una serie CPLD m√°s poderosa, por ejemplo CycloneIV.  Esto ampliar√≠a significativamente las capacidades mientras se mantiene un bajo costo (EP4CE6E22 cuesta alrededor de $ 5 para los chinos, mientras que hay 100 veces m√°s macroc√©lulas y aproximadamente 32 kB de memoria interna).  Pero lo har√© alg√∫n d√≠a m√°s tarde.  Si yo quiero  Dado que tales desarrollos toman demasiado tiempo. </cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es409743/">https://habr.com/ru/post/es409743/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es409731/index.html">Revisi√≥n de rentabilidad de Hashflare. Mi experiencia en 6 meses</a></li>
<li><a href="../es409733/index.html">¬øNecesita datos m√°s r√°pidos y un planeta m√°s limpio? Comienza a desarrollar asteroides</a></li>
<li><a href="../es409735/index.html">Ilusi√≥n de nivel de consenso</a></li>
<li><a href="../es409739/index.html">Bloomberg: Telegram planea ganar m√°s de $ 1 mil millones durante el ICO</a></li>
<li><a href="../es409741/index.html">La Casa Blanca est√° interesada en lanzar Falcon Heavy</a></li>
<li><a href="../es409745/index.html">El especialista en IA afirma que logr√≥ entender en qu√© idioma est√° escrito el manuscrito Voynich</a></li>
<li><a href="../es409747/index.html">La red neuronal AttnGAN dibuja objetos en partes, utilizando el espacio vectorial de no solo oraciones, sino tambi√©n palabras</a></li>
<li><a href="../es409749/index.html">Caldera de pir√≥lisis en el hogar, o cuando el precio del gas no importa</a></li>
<li><a href="../es409751/index.html">Letra de AudioFilkina: m√∫sica blue tooth, no para exagerar, sino para bien</a></li>
<li><a href="../es409753/index.html">La ONU puede completar un experimento aleatorio a gran escala para reducir el calentamiento global</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>