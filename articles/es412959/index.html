<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>吼 そ  A la pregunta de AVR y r茅cords mundiales   </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hazlo bien, saldr谩 mal 
 La raz贸n de la publicaci贸n fue reciente (cuando comenc茅 a escribir esta publicaci贸n, era realmente reciente, pero algo sucedi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>A la pregunta de AVR y r茅cords mundiales</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412959/"><h3>  Hazlo bien, saldr谩 mal </h3><br>  La raz贸n de la publicaci贸n fue reciente (cuando comenc茅 a escribir esta publicaci贸n, era realmente reciente, pero algo sucedi贸 durante mucho tiempo en la carpeta Unfinished) en Habr茅 sobre aspectos de la implementaci贸n del software UART en el MK de AVR.  Las preguntas planteadas por ellos mismos no carecen de inter茅s, pero se dan respuestas tan extra帽as que consideraron que era su deber hacer las explicaciones necesarias.  El tema est谩 marcado, aquellos que quieran leer sobre "reyes, repollo y zapatos", es decir, los requisitos de los est谩ndares, leer la documentaci贸n t茅cnica (correcta) y los registros en la programaci贸n en lenguaje ensamblador para AVR, pueden hacer clic en el bot贸n a continuaci贸n. <br><a name="habracut"></a><br>  Esbocemos la pregunta con m谩s detalle: 驴es posible implementar IRPS (el nombre habitual de la interfaz, en nombre de UART), en un AVR tipo MK (espec铆ficamente, fue Tiny13) cuando se trabaja desde un generador interno.  El hecho es que este generador no tiene muy buenos indicadores de la precisi贸n de retenci贸n de frecuencia, por lo que surge esta pregunta.  Debo hacer una reserva de inmediato que no importa si consideramos una implementaci贸n de software (como se sugiere en la publicaci贸n original) o si usamos bloques de hardware MK.  Los resultados de un m茅todo (en t茅rminos de par谩metros de precisi贸n en el tiempo) se traducen casi por completo a otro. <br><br>  La pregunta fundamental es si el generador interno puede proporcionar la precisi贸n de operaci贸n requerida, ya que en el caso de una respuesta negativa a esta pregunta, los estudios adicionales no tienen sentido.  Para comparar las dos cantidades independientes, necesitamos conocer ambas, por lo que comenzaremos por determinar la precisi贸n requerida del confinamiento de frecuencia y las capacidades proporcionadas por este MK en particular en esta parte.  Una observaci贸n importante a la oraci贸n anterior: esto no significa una instancia espec铆fica, "dada a nosotros en sensaciones", sino un tipo espec铆fico de MK, que se presenta por su descripci贸n t茅cnica. <br><br>  Para empezar, encontraremos algo que es m谩s f谩cil de encontrar (bueno, pens茅 que s铆): requisitos para la precisi贸n de los par谩metros de tiempo de la interfaz.  Abriremos el est谩ndar para RS232 y veremos todo lo que necesita de inmediato.  Result贸 que "no puedes tomarlo y ..." porque el est谩ndar est谩 pagado y todas las copias en la Web son ilegales.  De acuerdo, llevamos la versi贸n dom茅stica de GOST a la articulaci贸n C2 y no encontramos ning煤n par谩metro de tiempo all铆, a excepci贸n de la duraci贸n del frente y el corte del pulso.  Al principio, esto caus贸 una ligera r谩faga, como podr铆a ser, pero luego se dio cuenta de que la junta C2 describe solo la parte de la interfaz del IRPS y los requisitos deber铆an estar en la 煤ltima.  En principio, todo es l贸gico, no est谩 claro solo por qu茅 esto no se describe expl铆citamente en GOST, sino que, al final, a veces puedes pensar por ti mismo, aunque todav铆a "de alguna manera no est谩 bien obtenido". <br><br>  Por supuesto, conociendo el protocolo de transmisi贸n, es posible, por consideraciones generales, encontrar el desajuste m谩ximo permitido entre las velocidades del transmisor y el receptor (0.5 / 9.5 = 5.2%), pero esto ser谩 una investigaci贸n del caballo esf茅rico que sabe d贸nde, porque: <br><br><ol><li>  los requisitos de la norma pueden y deben ser m谩s estrictos que un c谩lculo te贸rico similar del desajuste m谩ximo permitido; </li><li>  conocer la cifra final de desajuste de ninguna manera nos dar谩 el presupuesto del transmisor y el receptor. </li></ol><br>  Vagar por Internet condujo a la AppNote de Atmel (bueno, ya que todav铆a usamos el MK de esta compa帽铆a), que habla expl铆citamente de un desajuste permisible del 2% con un presupuesto igual, lo que lleva al requisito de precisi贸n de mantener la frecuencia del transmisor del 1%.  Confiaremos en una empresa de buena reputaci贸n y supondremos que tienen acceso a materiales clasificados y esta cifra es correcta, especialmente porque parece plausible.  Entiendo la vulnerabilidad de tal posici贸n, pero para ser honesto, estoy cansado de buscar la respuesta exacta a una pregunta tan simple, y no puedo esperar para pasar a la siguiente parte. <br><br>  La siguiente mitad de la respuesta se encuentra dentro del MK y est谩 determinada por la documentaci贸n t茅cnica correspondiente.  Primero, un poco sobre el dispositivo del generador interno, especialmente porque est谩 m谩s o menos descrito.  El generador utiliza una cadena RC como elemento de temporizaci贸n y, dado que la tarea de formar un condensador integrado de un condensador exacto y una resistencia exacta, es muy no trivial, la frecuencia final de una instancia a otra del MC variar谩 significativamente.  Para hacer que este par谩metro sea m谩s predecible, los fabricantes agregaron un nodo de hardware controlado a trav茅s de un byte de calibraci贸n.  Esta unidad le permite cambiar la frecuencia del generador en un amplio rango y, en consecuencia, obtener el valor deseado con mucha mayor precisi贸n. <br><br>  Ser铆a interesante saber exactamente c贸mo se implementa el control en el hardware, veo una opci贸n ya sea con controlar el voltaje de carga del condensador a trav茅s del DAC o controlar el voltaje de comparaci贸n en el comparador.  Sin embargo, ambas opciones conducen a una no linealidad significativa de las caracter铆sticas de control, aunque son simples de implementar.  Pero establecer la implementaci贸n interna del generador no es parte de nuestra tarea, estamos interesados en sus par谩metros externos. <br><br>  As铆 que abrimos la documentaci贸n (puede abrir el archivo en el visor, pero tengo una versi贸n tipogr谩fica de la descripci贸n impresa por el propio fabricante, s铆, sol铆a ser) y buscamos la secci贸n correspondiente.  Los par谩metros que nos interesan est谩n en la secci贸n "Oscilador RC interno calibrado", luego siga los enlaces si es necesario.  Y aqu铆 nosotros (por supuesto, no estoy seguro de ti) est谩bamos esperando la primera decepci贸n: he estado trabajando con productos Atmel durante mucho tiempo (unos 15 a帽os) y siempre he cre铆do que tienen buena documentaci贸n para MK.  Seg煤n los psiquiatras, "no hay personas sanas, no hay personas inexploradas" y un estudio cuidadoso de la secci贸n relevante confirm贸 esta verdad, ya que no pude notar tales fallas en la documentaci贸n antes.  En mi defensa, solo puedo decir que: <br><br><ol><li>  Nunca utilic茅 un generador interno en los datos de MK, por lo que no lo estudi茅 con especial cuidado; </li><li>  cuando comenc茅 a trabajar con estos MK (hace mucho m谩s de 10 a帽os) era joven (bueno, definitivamente m谩s joven que ahora) y est煤pido y no entend铆a completamente la necesidad de una buena documentaci贸n (comprensible, exhaustiva y sin ambig眉edades); </li><li>  Estoy listo para perdonarme mucho, simplemente porque me perdono mucho a m铆 mismo, y todas mis deficiencias no son fatales (el 煤ltimo argumento es especialmente convincente, 驴no?). </li></ol><br>  Entonces, despu茅s de terminar de sacudirme la cabeza con cenizas, comenzar茅 a presentar mis reclamos a la documentaci贸n y no puede haber excusas para el fabricante.  Abrimos la secci贸n anterior y comenzamos a estudiarla detenidamente, yendo a las p谩ginas necesarias si es necesario (a煤n hace clic en los enlaces).  Juntos buscaremos los siguientes par谩metros que caracterizan las caracter铆sticas de tiempo del generador: precisi贸n nominal, influencia del voltaje de alimentaci贸n, influencia de la temperatura y par谩metros de envejecimiento: este es el conjunto m铆nimo necesario para evaluar los par谩metros de precisi贸n de cualquier generador. <br><br>  La primera parte del ballet Marleson es la precisi贸n nominal. <br><br>  Inmediatamente encontramos el par谩metro deseado: la tabla de precisi贸n de sintonizaci贸n del generador, en la que vemos dos l铆neas "Calibrado de f谩brica" con el valor especificado 卤 10% y "Calibraci贸n manual" con el mismo par谩metro 卤 2%. <br><br>  Con respecto a estos datos, surgen inmediatamente una serie de preguntas: qu茅 significan y c贸mo son las mediciones de este par谩metro.  Para la primera fila, la tabla indica la temperatura (del entorno o de la propia MK, no est谩 claro, pero esto es un capricho de mi parte) y el voltaje de suministro, adem谩s, la nota dice (en mi opini贸n, es innecesario) que esta medici贸n se lleva a cabo en un punto espec铆fico en el espacio condiciones externas  Uno puede adivinar que en este caso deber铆amos usar el factor de calibraci贸n registrado en el fabricante, aunque ser铆a mejor indicarlo expl铆citamente en la nota.  Todo est谩 m谩s o menos claro y se interpreta de manera casi inequ铆voca (aunque en el contexto del estudio de la documentaci贸n t茅cnica se debe decir que todo es confuso y permite variaciones en las interpretaciones, y esto es inaceptable, pero si lo hacemos, el tema de discusi贸n adicional simplemente desaparece (y lo que sigue) escribir, no est谩 claro, por lo tanto, mostrar indulgencia). <br><br>  Pero con la segunda l铆nea del caso, es peor: se dan los l铆mites de los cambios en la temperatura y el voltaje de suministro y se argumenta que al usar alg煤n tipo de procedimiento de calibraci贸n m谩gica puede lograr significativamente mejor que el resultado de f谩brica en todo el rango.  Mi pregunta surge de inmediato: si esto se puede lograr en todas partes (en cualquier punto de la temperatura y la fuente de alimentaci贸n) y el fabricante sabe c贸mo hacerlo, entonces 驴por qu茅 no lo hizo ella misma en la calibraci贸n de f谩brica en un punto espec铆fico de las condiciones?  Pasamos a la descripci贸n del byte de calibraci贸n y vemos que toma 128 valores y esto cubre el rango del 50% al 200% del valor nominal, que corresponde a 150/128 ~ 1.17% del cambio de frecuencia por valor de calibraci贸n de la unidad, lo que deber铆a dar la precisi贸n esperada mejor que en 1%  Pero entonces deber铆amos tener en cuenta que la caracter铆stica de ajuste claramente no es lineal y en la regi贸n de valores de calibraci贸n grandes tenemos 60% / 32 ~ 2% del paso (datos tomados del gr谩fico, he expresado repetidamente mi actitud hacia un m茅todo similar de representaci贸n de par谩metros t茅cnicos, pero repito: esto es inaceptable el m茅todo, aunque, por supuesto, es mejor que nada), que proporciona una precisi贸n del 1% y si tenemos en cuenta la monotonicidad de la caracter铆stica de ajuste (s铆, eso es lo que dice la documentaci贸n, no est谩 dibujada en el gr谩fico, pero est谩 claramente indicada en el texto. Me niego categ贸ricamente a entender a  a, y lo m谩s importante por qu茅, la compa帽铆a quer铆a que sea una ley de ajuste, pero logr贸), que queda bien claro en las directrices, es necesario tener en cuenta la precisi贸n del 2% es muy f谩cil de lograr.  Realmente no me gusta que haya tenido que mirar el gr谩fico, pero esto no es necesario y los datos tabulares son suficientes.  En esta parte, la documentaci贸n debe considerarse completamente comprensible y consistente, el criterio de correcci贸n se encuentra fuera del alcance de nuestra competencia. <br><br>  La segunda parte del ballet Marlezon.  - La influencia de las condiciones externas. <br><br>  Y luego comienza "basura, humos y sodom铆a".  En lugar de tablas de valores, estamos invitados a mirar im谩genes (por alguna raz贸n se llaman gr谩ficos de valores t铆picos en la documentaci贸n) y, como saben, "la principal ventaja de la representaci贸n gr谩fica de la informaci贸n es su visibilidad, y no tiene otras ventajas".  Ser铆a posible utilizar incluso dicha informaci贸n y eliminar los valores l铆mite del gr谩fico ("aunque esto sea ofensivo para el equipo") si este gr谩fico no se proporcionara en la secci贸n "Caracter铆sticas t铆picas".  No s茅 c贸mo alguien, personalmente, estoy profundamente convencido de que indicar significados t铆picos (o t铆picos, no s茅 c贸mo ser m谩s correctos, en una pel铆cula dec铆an "apariencia t铆pica"), al menos en forma de gr谩fico, incluso en la tabla, simplemente no indica nada.  No pueden guiarse en el dise帽o, porque estos par谩metros no tienen claro qu茅 significan y cualquier desviaci贸n de los valores t铆picos es aceptable, en contraste con los valores m铆nimos y m谩ximos, cuya transici贸n indica un mal funcionamiento del dispositivo. <br><br>  Bueno, hemos pasado, trataremos de extraer al menos algo de informaci贸n y veremos que cuando la temperatura cambia de -40 a + 80 掳 , la frecuencia del generador cambia en un 卤 4%.  Una imagen similar con el voltaje de suministro: solo gr谩ficos t铆picos y el error resultante en -6 + 2% de 3.3 a 5.5.  Los datos sobre el envejecimiento del generador simplemente no se dan, lo que, en general, es l贸gico, ya que en el contexto de los par谩metros ya dados, la precisi贸n del uno por ciento durante 5 a帽os (un valor caracter铆stico para el silicio) no molesta a nadie. <br><br>  Ahora tenemos todos los datos para responder a nuestra pregunta inicial: durante la calibraci贸n de f谩brica, el generador no cumple con los requisitos de precisi贸n de la interfaz, cuando se calibra para condiciones de aplicaci贸n espec铆ficas, cumple con los requisitos de l铆mite, pero no cumple con el est谩ndar.  Tambi茅n se debe tener en cuenta que si se puede calibrar el voltaje de suministro y un MK espec铆fico en la fabricaci贸n del dispositivo y esperar que no cambien a tiempo, entonces la temperatura solo se puede tener en cuenta sobre la marcha y requiere un est谩ndar de tiempo externo de precisi贸n adecuada.  Dado que el desarrollo de dispositivos debe guiarse por la regla "creemos en Dios, todo lo dem谩s requiere pruebas", y no hemos demostrado la posibilidad de cumplir con los requisitos, la respuesta correcta es que es imposible garantizar la implementaci贸n de IRPS que cumpla con los requisitos de la norma en este MC con un generador interno.  Tenga en cuenta que llegamos a la conclusi贸n anterior al analizar la documentaci贸n y la formulamos de tal manera que enfaticemos que en una instancia espec铆fica de MK todo puede y resultar谩 si las estrellas se elevan con 茅xito.  Es decir, nuestra conclusi贸n contradice la publicaci贸n mencionada anteriormente, 驴c贸mo podr铆a suceder esto, porque todo funciona muy bien para una persona? Vamos a resolverlo. <br><br>  Ahora comenzar谩 la cr铆tica de la publicaci贸n anterior.  Primero, pensemos en c贸mo podemos asegurarnos de que se verifique que el dispositivo cumpla con los requisitos de una interfaz en particular.  Puedo sugerir las siguientes formas: <br><br><ol><li>  Una buena manera es medir los par谩metros cr铆ticos de la interfaz del dispositivo y compararlos con los requisitos del est谩ndar; esto se puede hacer utilizando instrumentos universales (en nuestro caso, el osciloscopio y la longitud del intervalo de bits o la transmisi贸n completa), o utilizando un dispositivo especializado certificado para probar esta interfaz. </li><li>  Modo regular: para organizar la interacci贸n con otro dispositivo que implementa la parte de respuesta de la interfaz y est谩 probada (cumple con los requisitos del est谩ndar).  Por supuesto, tal verificaci贸n es completamente insuficiente, y m谩s bien, se puede aplicar m谩s para confirmar el mal funcionamiento del dispositivo bajo prueba, pero al menos hace algo. </li><li>  La mala manera es implementar independientemente la parte de respuesta de la interfaz (en el mismo dispositivo o en otro) e interactuar con ella.  Dado que ambos dispositivos obviamente no est谩n probados, la utilidad de tal verificaci贸n es muy, muy dudosa.  Un buen ejemplo de este enfoque es el "eco" en un canal serie, que no prueba nada e informa poco m谩s que nada sobre la velocidad del dispositivo, en principio, no est谩 roto y es capaz de transmitir algo de alguna manera. </li><li>  Una forma terrible es tomar como probador un dispositivo que no cumple con los requisitos del est谩ndar (o m谩s bien, que los contradice) y funcionar como en el p谩rrafo anterior. </li></ol><br>  Es el 煤ltimo m茅todo que se utiliz贸 en la publicaci贸n que se est谩 considerando: se implementa un receptor de software de canal en serie que, contrariamente a los requisitos del est谩ndar, cambia su frecuencia para adaptarse a la se帽al de entrada (espec铆ficamente, la longitud del bit de inicio), lo que permite una recepci贸n estable de una se帽al de baja calidad en t茅rminos de par谩metros de tiempo.  Esto no quiere decir que esto nunca deba hacerse, adem谩s, en los m贸dems anal贸gicos, se adopt贸 el ajuste para la velocidad entrante, que se implement贸 de manera similar, pero fue precisamente cambiar la frecuencia al cambiar el divisor, y claramente este no es nuestro caso.  Y es en esta versi贸n que todo se obtiene perfectamente y la informaci贸n se transmite de manera estable bajo cualquier condici贸n externa.  Por lo tanto, si hablamos de la posibilidad de transmitir informaci贸n entre dos MC que funcionan desde generadores internos utilizando una interfaz que recuerda remotamente a IRPS, entonces la respuesta es s铆.  Si hablamos de interactuar con dispositivos externos que cumplen con los requisitos del est谩ndar y nada m谩s, entonces esperaremos muchas sorpresas desagradables. <br><br>  La conclusi贸n general de lo anterior: <br><br><ol><li>  al dise帽ar dispositivos, debe centrarse en la documentaci贸n (RTFM), </li><li>  necesita estudiar la documentaci贸n e interpretar correctamente lo que lee (RTFMF), </li><li>  tenga en cuenta que en nuestro tiempo la documentaci贸n puede ser malentendidos, imprecisiones (e incluso errores), por lo tanto </li><li>  verificar la informaci贸n recibida para obtener consistencia y credibilidad, y </li><li>  use la informaci贸n obtenida experimentalmente solo para confirmar las conclusiones obtenidas del an谩lisis de la documentaci贸n, mientras </li><li>  elija cuidadosamente los m茅todos de experimentos para probar equipos para obtener un resultado confiable. </li></ol><br>  Bueno, en conclusi贸n, como se prometi贸, un peque帽o ensamblador.  Me permit铆 reescribir el fragmento de c贸digo citado por el autor en forma normal, porque el ensamblador integrado en GCC no es m谩s que una burla del programador, puedo nombrarlo.  No, por supuesto, entiendo que los desarrolladores del compilador se guiaron por buenas razones, pero el resultado se parece mucho a la frase "bueno, funciona". <br><br><pre><code class="hljs vhdl">.equ delay=<span class="hljs-number"><span class="hljs-number">15</span></span> TX_Byte: cli ; ld r18,Z+ ; cp r18,r1 ; breq Exit_Transmit ; dec r1 cbi <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>, TX_line Delay_TX: ldi r16,delay Do_Delay_TX: nop dec r16 brne Do_Delay_TX TX_Bit: sbrc r18,<span class="hljs-number"><span class="hljs-number">0</span></span> sbi <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>,TX_line sbrs r18,<span class="hljs-number"><span class="hljs-number">0</span></span> cbi <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>,TX_line lsr r18 lsr r17 brcs Delay_TX sbi <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>, TX_line ldi r16,delay Stop_Bit_TX: nop dec r16 brne Stop_Bit_TX Sei</code> </pre> <br>  E inmediatamente un error en el programa llama la atenci贸n: en la l铆nea 3 (comentada) el valor del registro 1 debe ser cero, pero la asignaci贸n no est谩 expl铆citamente escrita en la funci贸n.  Despu茅s de completar un ciclo de transferencia de un solo byte, este valor est谩 garantizado por la l铆nea 12, pero no en la primera pasada.  Por lo tanto, se debe agregar la inicializaci贸n, lo que requerir谩 un aumento en el tama帽o del c贸digo. <br><br>  El segundo inconveniente es la formaci贸n real del nivel en las l铆neas 4-7, ya que el m茅todo adoptado por el autor para emitir el siguiente bit conducir谩 a fluctuaciones frontales durante 2 ciclos de reloj en diferentes transiciones (0-1 y 1-0), lo que implicar谩 un aumento en los requisitos para la precisi贸n de mantener la frecuencia.  No es que esto tenga una influencia muy fuerte, pero si puede corregir una falla sin extender el programa, entonces, 驴por qu茅 no? Vea el ep铆grafe.  La versi贸n original tom贸 4 palabras y se realiz贸 en 4 medidas, la nueva tom贸 4 palabras y se realiz贸 en las mismas 4 medidas.  S铆, la versi贸n corregida requiere un estudio m谩s profundo de la arquitectura MK, pero qui茅n dijo que ser铆a f谩cil.  Por otro lado, en la primera versi贸n, la modificaci贸n del puerto es at贸mica, y en la segunda no lo es, en este caso no importa (prohibimos expl铆citamente las interrupciones), pero el sedimento permanece.  Si el MK en cuesti贸n ten铆a un procesador de bits real, como en la arquitectura 51, entonces podr铆amos escribir un fragmento ideal que combine todas las ventajas de ambos enfoques (e incluso ser un poco m谩s corto), pero 驴qu茅 podemos so帽ar con un sue帽o imposible? <br><br>  El tercer inconveniente es la cuesti贸n de m谩s estilo.  Repetidamente he expresado mi actitud hacia las constantes m谩gicas que vemos en el pre谩mbulo de este programa.  Destaco una vez m谩s: por el hecho de que el autor establece una constante en el pre谩mbulo del programa y no directamente en el operador, la "magia callejera ordinaria" no va a ninguna parte.  El hecho es que debemos presentar expl铆citamente al lector el m茅todo de formar un valor espec铆fico, y no crear un sin贸nimo del valor obtenido de una manera desconocida.  Por supuesto, puede escribir un comentario en una l铆nea con un valor para especificar la f贸rmula de c谩lculo, pero es mejor usar expl铆citamente la f贸rmula de c谩lculo para formar la constante y luego simplemente no necesita un comentario (por supuesto, con los nombres de las constantes aplicadas).  Esto se hace en el texto a continuaci贸n, y tenga en cuenta que convertimos a un n煤mero entero solo en el 煤ltimo momento y redondeamos correctamente, lo que nos permite no perder la precisi贸n del resultado. <br><br>  Hay otro error: la longitud del bit de inicio es algo diferente del intervalo de bits para los datos.  Aunque la desviaci贸n no es demasiado significativa (3 ciclos de reloj), sin embargo, a altas velocidades de bits, donde el intervalo de bits dura aproximadamente 90 ciclos de reloj, esto ya es un peque帽o porcentaje de error, lo cual es inaceptable.  Este error puede corregirse f谩cilmente agregando comandos para generar un retraso adicional, pero esto aumentar谩 la duraci贸n del programa, por lo que solo corregiremos su presencia y luego nos aseguraremos de que la arquitectura correcta del programa (es decir, incluso este corto plazo se aplique) se elimina autom谩ticamente. <br><br>  Bueno, ahora que hemos solucionado los errores (excepto el 煤ltimo), intentaremos mejorar el programa en el sentido del criterio principal (para lograr un registro, en este caso particular): la longitud del c贸digo.  Lo primero que llama la atenci贸n es la presencia de dos retrasos, lo cual es malo porque viola el principio DRY (requisito general) y aumenta el tama帽o del c贸digo (requisito espec铆fico).  Ser铆a posible organizar este fragmento en forma de una subrutina y a煤n as铆 ganar铆amos en longitud, ya que agregamos 3 palabras de c贸digo (1 para cada llamada en dos lugares y 1 para la devoluci贸n), y guardamos 4, pero hay una manera mucho m谩s hermosa: ordenada La organizaci贸n del ciclo de transmisi贸n de bytes, que se puede ver en el siguiente texto. <br><br><pre> <code class="hljs vhdl">.equ delay=<span class="hljs-number"><span class="hljs-number">15</span></span> TX_Byte: cli sec ;   - clt ;  - TransBit: ;    <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> r17,<span class="hljs-keyword"><span class="hljs-keyword">port</span></span> bld r17,Tx_line <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>,r17 Delay_TX: ;     ldi r17,delay Do_Delay_TX: nop dec r17 brne Do_Delay_TX TX_Bit: bst r16,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ror</span></span> r16 clc brne TransBit ;    brcs TransBit ;  - Exit_Transmit: Sei</code> </pre><br>  Observe c贸mo usamos el byte transmitido junto con el bit de acarreo como un contador de bits, una soluci贸n hermosa, pero tiene un inconveniente: la duraci贸n del 煤ltimo bit de datos ser谩 varios (2 ciclos) m谩s larga que el resto, debido al retraso de la transici贸n.  Si estuvi茅ramos hablando de un bit de parada, entonces "no nos importa un comino y olvidamos", ya que no se nos ha dado el intervalo m铆nimo entre transferencias, pero este es un bit significativo, y acabamos de criticar el programa original por tal comportamiento.  No seremos comparados con el car谩cter b铆blico de la par谩bola de la mota a los ojos de los dem谩s y tomaremos medidas para eliminarlo.  Este fen贸meno podr铆a compensarse f谩cilmente mediante la introducci贸n de un retraso de 2 medidas, pero la longitud del c贸digo aumentar谩, y este es un par谩metro clave.  Por lo tanto, sigamos el camino cl谩sico y cambiemos el tiempo de la memoria: utilizamos un registro separado para organizar el contador de bits transmitidos, y obtenemos exactamente los mismos intervalos de bits con el mismo tama帽o de c贸digo. <br><br>  La siguiente mejora est谩 asociada con la formaci贸n de la duraci贸n del intervalo de bits, que en el programa original se realiza en un ciclo de 4 ciclos.  Si hacemos 3 horas (la m谩s peque帽a posible en este MK), podemos guardar un byte de c贸digo y potencialmente podemos mejorar los par谩metros de precisi贸n, ya que la discreci贸n de la demora ser谩 menor (la desviaci贸n no excede la mitad del tama帽o del discreto con el redondeo adecuado).  Pero debe tenerse en cuenta que, en un caso particular, podemos perder precisi贸n, todo depende de los datos de origen.  Otra circunstancia que podr铆a afectar la elecci贸n de tal duraci贸n de ciclo: el tama帽o m谩ximo de retraso para un contador de bytes es de 256 valores; para la opci贸n disponible, puede usar velocidades de 9600 baudios y m谩s, pero con un retraso de 3 ciclos esto no es posible.  Ser铆a muy agradable reflejar esta circunstancia (la velocidad de puerto m铆nima permitida) en los comentarios al programa y al mismo tiempo mostrar un mensaje de advertencia en caso de incumplimiento de este requisito.  Bueno, haga las modificaciones apropiadas a las macros de formaci贸n de par谩metros para formar un retraso, sin olvidar usar nombres "parlantes" para indicar variables. <br><br><pre> <code class="hljs dos">.<span class="hljs-keyword"><span class="hljs-keyword">equ</span></span> Freq = <span class="hljs-number"><span class="hljs-number">8000000</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">equ</span></span> BaudRate = <span class="hljs-number"><span class="hljs-number">115200</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">equ</span></span> PayLoad = <span class="hljs-number"><span class="hljs-number">9</span></span> ;     .<span class="hljs-keyword"><span class="hljs-keyword">equ</span></span> CycleTime = <span class="hljs-number"><span class="hljs-number">3</span></span> ;    .<span class="hljs-keyword"><span class="hljs-keyword">equ</span></span> delay=((Freq*<span class="hljs-number"><span class="hljs-number">2</span></span>/BaudRate - PayLoad*<span class="hljs-number"><span class="hljs-number">2</span></span>)+CycleTime)/(CycleTime*<span class="hljs-number"><span class="hljs-number">2</span></span>) TX_Byte: cli ldi r18,<span class="hljs-number"><span class="hljs-number">10</span></span> sec ;   - clt ;  - TransBit: <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> r17,port bld r17,Tx_line out port,r17 Delay_TX: ldi r17,delay Do_Delay_TX: dec r17 brne Do_Delay_TX TX_Bit: bst r16,<span class="hljs-number"><span class="hljs-number">0</span></span> ror r16 dec r18 brne TransBit Exit_Transmit: sei</code> </pre><br>  Ahora veamos el resultado: el tama帽o del c贸digo disminuy贸 de 20 a 16 palabras (si tomamos en cuenta solo la transmisi贸n en s铆, entonces a煤n m谩s sorprendente: de 18 a 14, desapareci贸 la fluctuaci贸n de los frentes (por supuesto, solo el componente de fluctuaci贸n de fase, que es causado por las caracter铆sticas del programa, en el componente de hardware, nosotros no estamos infringiendo), la precisi贸n del mantenimiento de los intervalos de tiempo ha mejorado, el programa se ha vuelto m谩s visible y m谩s f谩cil de entender (debido a los comentarios, ya que incluso un programa ensamblador bien escrito generalmente no est谩 auto documentado). <br><br>  La conclusi贸n de la 煤ltima parte es que si vamos a establecer r茅cords mundiales en la programaci贸n en lenguaje ensamblador, entonces debemos estudiar la arquitectura de un MK particular muy profundamente y aplicar el conocimiento obtenido para obtener el resultado ideal, prestando atenci贸n a todas las sutilezas. <br><br>  Bueno y, en conclusi贸n, la tarea de escribir c贸digo del tama帽o m铆nimo hoy en d铆a parece algo artificial, pero, de manera inesperada, recibe la confirmaci贸n de su vitalidad.  A finales del a帽o pasado (2016, este es el tiempo que esta publicaci贸n ha estado esperando su turno), se anunci贸 un nuevo MK de la familia MSP430, que junto con el precio excepcionalmente bajo (26 centavos, estamos esperando la aparici贸n de dispositivos chinos basados en 茅l) tambi茅n tiene un tama帽o de memoria de programa excepcionalmente peque帽o: 512 byte (no, no me equivoqu茅, la letra "k" inmediatamente despu茅s del n煤mero no lo es).  Por lo tanto, el tama帽o del c贸digo puede resultar cr铆tico cuando se usa este dispositivo, y en general escribir programas tan extremos requiere un estudio en profundidad de MK, y "el trabajo en s铆 mismo es una bendici贸n". </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es412959/">https://habr.com/ru/post/es412959/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es412949/index.html">Los astr贸logos anuncian la semana de desarrollo de iOS en Avito</a></li>
<li><a href="../es412951/index.html">DotVVM - Comunicaci贸n entre cliente y servidor</a></li>
<li><a href="../es412953/index.html">Calibraci贸n de c谩mara Intel RealSense d435 con OpenCV2 y ROS</a></li>
<li><a href="../es412955/index.html">Pruebas de IU en Xcode con Embassy y Succulent</a></li>
<li><a href="../es412957/index.html">Mi Band 4 y Mi Band 5: el futuro de las pulseras inteligentes de Xiaomi</a></li>
<li><a href="../es412961/index.html">Compartir econom铆a en telecomunicaciones</a></li>
<li><a href="../es412963/index.html">Nuevo Fallout: 驴Qu茅 se sabe sobre Vault 76?</a></li>
<li><a href="../es412967/index.html">Hacer un buen widget de ajuste de brillo</a></li>
<li><a href="../es412969/index.html">Los sistemas de reconocimiento facial aparecen en las escuelas de EE. UU., Pero su efectividad est谩 en duda</a></li>
<li><a href="../es412971/index.html">Crear una aplicaci贸n para colorear en Unity3D</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>