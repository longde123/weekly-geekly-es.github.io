<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>âœ–ï¸ ğŸ¤¶ğŸ¼ ãŠ™ï¸ Kembali ke layanan microser dengan Istio. Bagian 1 ğŸ‘¨ğŸ½â€ğŸ’» ğŸƒ ğŸ™ğŸ¿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Catatan perev. : Sambungan layanan jelas menjadi solusi yang relevan dalam infrastruktur modern untuk aplikasi yang mengikuti arsitektur layanan mikro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kembali ke layanan microser dengan Istio. Bagian 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/438426/"><img src="https://habrastorage.org/webt/bj/j4/oy/bjj4oyjxqshrbjf5eks9sgsvbeg.png"><br><br>  <i><b>Catatan</b></i>  <i><b>perev.</b></i>  <i>: Sambungan layanan jelas menjadi solusi yang relevan dalam infrastruktur modern untuk aplikasi yang mengikuti arsitektur layanan mikro.</i>  <i>Meskipun Istio mungkin didengar oleh banyak insinyur DevOps, itu adalah produk yang cukup baru, yang, karena komprehensif dalam hal fitur yang disediakan, mungkin memerlukan waktu yang cukup lama untuk saling mengenal satu sama lain.</i>  <i>Insinyur Jerman Rinor Maloku, yang bertanggung jawab untuk komputasi awan untuk pelanggan besar di perusahaan telekomunikasi Orange Networks, telah menulis serangkaian materi yang luar biasa yang memungkinkan Anda untuk dengan cepat dan mendalam menyelami Istio.</i>  <i>Dia memulai ceritanya dengan apa yang bisa dilakukan Istio dan bagaimana Anda bisa dengan cepat melihatnya dengan mata kepala sendiri.</i> <br><br>  <b>Istio</b> adalah proyek Open Source yang dikembangkan bersama dengan tim dari Google, IBM dan Lyft.  Ini memecahkan kesulitan yang muncul dalam aplikasi berbasis pada layanan microser, misalnya, seperti: <a name="habracut"></a><br><br><ul><li>  <b>Manajemen lalu lintas</b> : timeout, retries, load balancing; </li><li>  <b>Keamanan</b> : otentikasi dan otorisasi pengguna akhir; </li><li>  <b>Observabilitas</b> : jejak, pemantauan, penebangan. </li></ul><br>  Semuanya dapat diselesaikan pada tingkat aplikasi, tetapi setelah itu layanan Anda akan berhenti menjadi "mikro".  Semua upaya tambahan untuk memecahkan masalah ini adalah pemborosan sumber daya perusahaan yang dapat digunakan secara langsung untuk nilai-nilai bisnis.  Pertimbangkan sebuah contoh: <br><blockquote> Manajer Proyek: Berapa lama untuk menambahkan umpan balik? <br>  Pengembang: Dua sprint. <br><br>  MP: Apa? .. Itu hanya CRUD! <br>  R: Membuat CRUD adalah bagian sederhana dari tugas, tetapi kita masih perlu mengautentikasi dan mengotorisasi pengguna dan layanan.  Karena jaringan tidak dapat diandalkan, Anda perlu menerapkan permintaan berulang, serta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pola pemutus sirkuit</a> di klien.  Namun, untuk memastikan bahwa keseluruhan sistem tidak jatuh, Anda akan membutuhkan batas waktu dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bulkhead</a> <i>(untuk rincian lebih lanjut tentang kedua pola yang disebutkan, lihat lebih lanjut dalam artikel - kira-kira. Terjemahan)</i> , Dan untuk mendeteksi masalah, pemantauan, pelacakan, [...] <br><br>  MP: Oh, kalau begitu mari kita masukkan fitur ini ke dalam Layanan produk. </blockquote>  Saya pikir idenya jelas: volume langkah dan upaya yang diperlukan untuk menambahkan satu layanan sangat besar.  Pada artikel ini, kita akan melihat bagaimana Istio menghilangkan semua kesulitan yang disebutkan di atas (yang tidak ditargetkan untuk logika bisnis) dari layanan. <br><br><img src="https://habrastorage.org/webt/l4/js/7o/l4js7omne2rslxitn0zr_lgusee.png"><br><br>  <b>Catatan</b> : Artikel ini mengasumsikan bahwa Anda memiliki pengetahuan praktis tentang Kubernet.  Kalau tidak, saya sarankan membaca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pengantar saya untuk Kubernetes</a> dan hanya setelah itu lanjutkan membaca materi ini. <br><br><h2>  Ide Istio </h2><br>  Di dunia tanpa Istio, satu layanan membuat permintaan langsung ke yang lain, dan jika terjadi kegagalan, layanan harus memprosesnya sendiri: membuat upaya baru, memberikan batas waktu, membuka pemutus sirkuit, dll. <br><br><img src="https://habrastorage.org/webt/ov/uv/g5/ovuvg5sepxqvj7wduhnl3uiixyi.png"><br>  <i>Lalu Lintas Jaringan di Kubernetes</i> <br><br>  Istio juga menawarkan solusi khusus, sepenuhnya terpisah dari layanan dan berfungsi dengan mengganggu interaksi jaringan.  Dan itu mengimplementasikan: <br><br><ul><li>  <b>Toleransi kesalahan</b> : Berdasarkan kode status dalam respons, ia memahami apakah permintaan gagal, dan menjalankannya lagi. </li><li>  <b>Peluncuran Canary</b> : pengalihan ke versi baru dari layanan hanya persentase tetap dari jumlah permintaan. </li><li>  <b>Pemantauan dan metrik</b> : berapa lama layanan merespons? </li><li>  <b>Penelusuran dan Pengamatan</b> : Menambahkan tajuk khusus untuk setiap permintaan dan melacaknya di gugus. </li><li>  <b>Keamanan</b> : mengekstrak token JWT, mengautentikasi, dan mengotorisasi pengguna. </li></ul><br>  Ini hanya beberapa kemungkinan (benar-benar hanya beberapa!) Untuk membuat Anda penasaran.  Sekarang mari selami rincian teknisnya! <br><br><h2>  Arsitektur Istio </h2><br>  Istio memotong semua lalu lintas jaringan dan menerapkan seperangkat aturan untuk itu, memasukkan proxy cerdas ke setiap pod dalam bentuk wadah sespan.  Proxy yang mengaktifkan semua fitur membentuk <b>Data Plane</b> , dan mereka dapat dikonfigurasi secara dinamis menggunakan <b>Control Plane</b> . <br><br><h2>  Pesawat data </h2><br>  Proxy yang dimasukkan ke dalam pod memungkinkan Istio dengan mudah memenuhi persyaratan yang kami butuhkan.  Misalnya, periksa fungsi coba lagi dan pemutus sirkuit. <br><br><img src="https://habrastorage.org/webt/8t/7x/xn/8t7xxntkiuakkk5sbn41b4rualg.gif"><br>  <i>Bagaimana retries dan circuit break diimplementasikan dalam Utusan</i> <br><br>  Untuk meringkas: <br><br><ol><li>  Utusan <i>(berbicara tentang proxy dalam wadah sespan yang didistribusikan sebagai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">produk terpisah</a> - kira-kira. Terjemahan).</i> Mengirim permintaan ke instance pertama layanan B dan terjadi kegagalan. </li><li>  Utusan Sidecar <i>mencoba lagi</i> .  <i>(1)</i> </li><li>  Permintaan yang gagal dikembalikan ke proksi yang memanggilnya. </li><li>  Ini membuka Circuit Breaker dan memanggil layanan berikutnya untuk permintaan berikutnya.  <i>(2)</i> </li></ol><br>  Ini berarti bahwa Anda tidak perlu menggunakan pustaka Coba lagi berikutnya, Anda tidak harus melakukan implementasi Circuit Breaking dan Service Discovery Anda sendiri dalam bahasa pemrograman X, Y atau Z. Semua ini dan banyak lagi tersedia di luar kotak di Istio dan tidak memerlukan perubahan pada kode. <br><br>  Hebat!  Sekarang Anda mungkin ingin melakukan perjalanan dengan Istio, tetapi masih ada beberapa keraguan, pertanyaan terbuka.  Jika ini adalah solusi universal untuk semua kesempatan dalam hidup, maka Anda memiliki kecurigaan yang sah: setelah semua, semua keputusan seperti itu pada kenyataannya ternyata tidak cocok untuk setiap kesempatan. <br><br>  Dan akhirnya, Anda bertanya: "Apakah bisa disesuaikan?" <br><br>  Sekarang Anda siap untuk pelayaran laut - dan mari kita berkenalan dengan Control Plane. <br><br><h2>  Kontrol pesawat </h2><br>  Ini terdiri dari tiga komponen: <b>Pilot</b> , <b>Mixer,</b> dan <b>Citadel</b> , yang bekerja bersama untuk mengkonfigurasi Utusan untuk merutekan lalu lintas, menerapkan kebijakan, dan mengumpulkan data telemetri.  Secara skematis, semuanya terlihat seperti ini: <br><br><img src="https://habrastorage.org/webt/dw/p6/hh/dwp6hh6y5g41oinfxccixuutkyo.png"><br>  <i>Kontrol Interaksi Pesawat dengan Pesawat Data</i> <br><br>  Utusan (yaitu pesawat data) dikonfigurasikan menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kubernetes CRD</a> (Custom Resource Definition) yang didefinisikan oleh Istio dan dirancang khusus untuk tujuan ini.  Bagi Anda, ini berarti bahwa mereka tampaknya menjadi sumber daya berikutnya di Kubernetes dengan sintaksis yang akrab.  Setelah dibuat, sumber ini akan diambil oleh pesawat kontrol dan diterapkan ke Utusan. <br><br><h2>  Rasio layanan untuk Istio </h2><br>  Kami menggambarkan sikap Istio terhadap layanan, tetapi tidak sebaliknya: bagaimana hubungan layanan dengan Istio? <br><br>  Jujur, Istio tahu tentang keberadaan layanan serta ikan - tentang air, ketika mereka bertanya pada diri sendiri: "Apa itu air pada umumnya?". <br><br><img src="https://habrastorage.org/webt/re/oi/ff/reoiffespub6tknffwssilkgu7c.jpeg"><br>  <i>Ilustrasi oleh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Victoria Dimitrakopoulos</a> : - Bagaimana Anda menyukai air?</i>  <i>- Apa itu air pada umumnya?</i> <br><br>  Dengan demikian, Anda dapat mengambil cluster kerja dan setelah penyebaran komponen Istio, layanan yang berada di dalamnya akan terus bekerja, dan setelah penghapusan komponen ini, semuanya akan baik-baik saja.  Jelas bahwa dengan melakukan itu Anda akan kehilangan peluang yang disediakan oleh Istio. <br><br>  Teori yang cukup - mari kita praktikkan ini! <br><br><h2>  Istio dalam latihan </h2><br>  Istio membutuhkan kluster Kubernetes di mana setidaknya 4 vCPU dan 8 GB RAM tersedia.  Untuk meningkatkan cluster dengan cepat dan mengikuti instruksi dari artikel, saya sarankan menggunakan Google Cloud Platform, yang menawarkan pengguna baru <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">gratis $ 300</a> . <br><br>  Setelah Anda membuat sebuah cluster dan mengkonfigurasi akses ke Kubernetes melalui utilitas konsol, Anda dapat menginstal Istio melalui manajer paket Helm. <br><br><h2>  Pemasangan Helm </h2><br>  Instal klien Helm di komputer Anda, seperti yang mereka katakan dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi resmi</a> .  Kami akan menggunakannya untuk membuat templat untuk menginstal Istio di bagian selanjutnya. <br><br><h2>  Instal Istio </h2><br>  Unduh sumber daya Istio dari <a href="">rilis terbaru</a> <i>(tautan penulis asli ke versi 1.0.5 diubah ke yang sekarang, yaitu 1.0.6 - kira-kira diterjemahkan.)</i> , Ekstrak konten ke dalam satu direktori, yang akan saya panggil di masa depan <code>[istio-resources]</code> . <br><br>  Untuk memudahkan mengidentifikasi sumber daya Istio, buat namespace <code>istio-system</code> -istio di kluster K8s: <br><br><pre> <code class="bash hljs">$ kubectl create namespace istio-system</code> </pre> <br>  Selesaikan penginstalan dengan masuk ke <code>[istio-resources]</code> dan jalankan perintah: <br><br><pre> <code class="bash hljs">$ helm template install/kubernetes/helm/istio \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> global.mtls.enabled=<span class="hljs-literal"><span class="hljs-literal">false</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tracing.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> kiali.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> grafana.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --namespace istio-system &gt; istio.yaml</code> </pre> <br>  Perintah ini akan menampilkan komponen utama Istio ke file <code>istio.yaml</code> .  Kami mengubah templat standar untuk diri kami sendiri, menetapkan parameter berikut: <br><br><ul><li>  <code>global.mtls.enabled</code> disetel ke <code>false</code> <i>(mis. otentikasi mTLS dinonaktifkan - sekitar terjemahan)</i> untuk menyederhanakan proses kencan kami; </li><li>  <code>tracing.enabled</code> memungkinkan penelusuran kueri menggunakan Jaeger; </li><li>  <code>kiali.enabled</code> menginstal Kiali di cluster untuk memvisualisasikan layanan dan lalu lintas; </li><li>  <code>grafana.enabled</code> mengatur Grafana untuk memvisualisasikan metrik yang dikumpulkan. </li></ul><br>  Kami menerapkan sumber daya yang dihasilkan dengan perintah: <br><br><pre> <code class="bash hljs">$ kubectl apply -f istio.yaml</code> </pre> <br>  Menginstal Istio di cluster sudah selesai!  Tunggu hingga semua pod di namespace <code>istio-system</code> <code>Running</code> atau <code>Completed</code> dengan menjalankan perintah di bawah ini: <br><br><pre> <code class="bash hljs">$ kubectl get pods -n istio-system</code> </pre> <br>  Sekarang kita siap untuk melanjutkan di bagian selanjutnya, di mana kita akan meningkatkan dan meluncurkan aplikasi. <br><br><h2>  Arsitektur Aplikasi Sentimen Analisis </h2><br>  Mari kita ambil contoh aplikasi microservice Sentiment Analysis yang digunakan dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel pengantar yang</a> telah disebutkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">di Kubernetes</a> .  Itu cukup canggih untuk menunjukkan kemampuan Istio dalam praktek. <br><br>  Aplikasi ini terdiri dari empat layanan microser: <br><br><ol><li>  Service <b>SA-Frontend</b> , yang melayani aplikasi front-end di Reactjs; </li><li>  Layanan <b>SA-WebApp</b> yang melayani permintaan Analisis Sentimen; </li><li>  Layanan <b>SA-Logika</b> , yang melakukan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">analisis sentimental</a> ; </li><li>  Layanan <b>SA-Umpan Balik</b> , yang menerima umpan balik dari pengguna tentang keakuratan analisis. </li></ol><br><img src="https://habrastorage.org/webt/hi/jv/oc/hijvoc4y7ercttsbopo4jzbo4w4.png"><br><br>  Dalam diagram ini, selain layanan, kami juga melihat Ingress Controller, yang di Kubernetes merutekan permintaan masuk ke layanan yang sesuai.  Istio menggunakan konsep serupa di dalam Gateway Ingress, yang detailnya akan mengikuti. <br><br><h2>  Meluncurkan aplikasi dengan proxy dari Istio </h2><br>  Untuk operasi lebih lanjut yang disebutkan dalam artikel, kloning repositori <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">istio-mastery</a> .  Ini berisi aplikasi dan manifes untuk Kubernetes dan Istio. <br><br><h3>  Masukkan sespan </h3><br>  Penyisipan dapat dilakukan <b>secara otomatis</b> atau <b>manual</b> .  Untuk secara otomatis memasukkan wadah sespan, Anda perlu mengatur <code>istio-injection=enabled</code> ke <code>istio-injection=enabled</code> , yang dilakukan dengan perintah berikut: <br><br><pre> <code class="bash hljs">$ kubectl label namespace default istio-injection=enabled namespace/default labeled</code> </pre> <br>  Sekarang setiap pod yang akan digunakan dalam namespace default akan menerima wadah sespannya.  Untuk memverifikasi ini, mari kita instal aplikasi uji dengan pergi ke direktori root dari <code>[istio-mastery]</code> dan menjalankan perintah berikut: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/kube persistentvolumeclaim/sqlite-pvc created deployment.extensions/sa-feedback created service/sa-feedback created deployment.extensions/sa-frontend created service/sa-frontend created deployment.extensions/sa-logic created service/sa-logic created deployment.extensions/sa-web-app created service/sa-web-app created</code> </pre> <br>  Setelah memperluas layanan, kami akan memverifikasi bahwa pod memiliki dua kontainer (dengan layanan itu sendiri dan sespannya), dengan mengeksekusi perintah <code>kubectl get pods</code> dan memastikan bahwa nilai <code>2/2</code> ditunjukkan di bawah kolom <code>READY</code> , melambangkan bahwa kedua kontainer berjalan: <br><br><pre> <code class="bash hljs">$ kubectl get pods NAME READY STATUS RESTARTS AGE sa-feedback-55f5dc4d9c-c9wfv 2/2 Running 0 12m sa-frontend-558f8986-hhkj9 2/2 Running 0 12m sa-logic-568498cb4d-2sjwj 2/2 Running 0 12m sa-logic-568498cb4d-p4f8c 2/2 Running 0 12m sa-web-app-599cf47c7c-s7cvd 2/2 Running 0 12m</code> </pre> <br>  Secara visual terlihat seperti ini: <br><br><img src="https://habrastorage.org/webt/x9/kt/lu/x9ktluxxjopen7rn9tchuyvvioi.png"><br>  <i>Utusan proksi di salah satu pod</i> <br><br>  Sekarang aplikasi sudah berjalan dan berjalan, kita perlu mengizinkan lalu lintas masuk ke aplikasi. <br><br><h2>  Ingress gateway </h2><br>  Praktik terbaik untuk mencapai ini (untuk memungkinkan lalu lintas di cluster) adalah melalui <b>Ingress Gateway</b> di Istio, yang terletak di "perbatasan" cluster dan memungkinkan Anda untuk mengaktifkan fitur Istio seperti perutean, penyeimbangan beban, keamanan, dan pemantauan untuk lalu lintas yang masuk. <br><br>  Komponen Gateway Ingress dan layanan yang meneruskannya di luar diinstal ke dalam cluster selama instalasi Istio.  Untuk mengetahui alamat IP eksternal suatu layanan, lakukan: <br><br><pre> <code class="bash hljs">$ kubectl get svc -n istio-system -l istio=ingressgateway NAME TYPE CLUSTER-IP EXTERNAL-IP istio-ingressgateway LoadBalancer 10.0.132.127 13.93.30.120</code> </pre> <br>  Kami akan terus mengakses aplikasi melalui IP ini (saya akan menyebutnya sebagai EKSTERNAL-IP), jadi untuk kenyamanan kami akan menulis nilai ke dalam variabel: <br><br><pre> <code class="bash hljs">$ EXTERNAL_IP=$(kubectl get svc -n istio-system \ -l app=istio-ingressgateway \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].status.loadBalancer.ingress[0].ip}'</span></span>)</code> </pre> <br>  Jika Anda mencoba mengakses IP ini melalui browser sekarang, Anda akan menerima kesalahan Layanan Tidak Tersedia, karena  <b>Secara default, Istio memblokir semua lalu lintas masuk</b> sampai Gateway ditentukan. <br><br><h2>  Sumber Daya Gateway </h2><br>  Gateway adalah CRD (Custom Resource Definition) di Kubernetes, didefinisikan setelah menginstal Istio dalam sebuah cluster dan mengaktifkan kemampuan untuk menentukan port, protokol, dan host yang kami inginkan untuk mengizinkan lalu lintas masuk. <br><br>  Dalam kasus kami, kami ingin mengizinkan lalu lintas HTTP ke port 80 untuk semua host.  Tugas diimplementasikan oleh definisi berikut <i>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://gist.github.com/rinormaloku/577d0e23590f7a8dfbe56fe2a1f853d7&amp;usg=ALkJrhilDCQcLK1W7TqlkaWcbbj1bjcLKQ#file-">http-gateway.yaml</a> )</i> : <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: http-gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - "*"</code> </pre> <br>  Konfigurasi ini tidak memerlukan penjelasan kecuali untuk <code>istio: ingressgateway</code> .  Dengan pemilih ini, kami dapat menunjukkan ke Ingress Gateway mana konfigurasi diterapkan.  Dalam kasus kami, ini adalah pengontrol Ingress Gateway, yang diinstal secara default di Istio. <br><br>  Konfigurasi diterapkan dengan memanggil perintah berikut: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/http-gateway.yaml gateway.networking.istio.io/http-gateway created</code> </pre> <br>  Sekarang gateway memungkinkan akses ke port 80, tetapi tidak tahu ke mana harus merutekan permintaan.  Ini akan membutuhkan <b>Layanan Virtual</b> . <br><br><h2>  Sumber Daya Layanan Virtual </h2><br>  VirtualService memberi tahu Ingress Gateway cara merutekan permintaan yang diizinkan di dalam kluster. <br><br>  Permintaan ke aplikasi kami yang datang melalui http-gateway harus dikirim ke layanan sa-frontend, sa-web-app dan sa-umpan balik: <br><br><img src="https://habrastorage.org/webt/zi/il/7_/ziil7_-9gfy5ejkhkzzn1wpxkxe.png"><br>  <i>Rute untuk Mengkonfigurasi dengan VirtualServices</i> <br><br>  Pertimbangkan permintaan yang harus dikirim ke SA-Frontend: <br><br><ul><li>  Pencocokan persis pada jalur <code>/</code> harus dikirim ke SA-Frontend untuk mendapatkan index.html; </li><li>  Path yang diawali dengan <code>/static/*</code> harus dikirim ke SA-Frontend untuk menerima file statis yang digunakan di frontend, seperti CSS dan JavaScript; </li><li>  Jalur yang termasuk dalam ekspresi reguler <code>'^.*\.(ico|png|jpg)$'</code> harus dikirim ke SA-Frontend, karena  Ini adalah gambar yang ditampilkan pada halaman. </li></ul><br>  Implementasi dicapai dengan konfigurasi berikut <i>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sa-virtualservice-external.yaml</a> ):</i> <br><br><pre> <code class="plaintext hljs">kind: VirtualService metadata: name: sa-external-services spec: hosts: - "*" gateways: - http-gateway # 1 http: - match: - uri: exact: / - uri: exact: /callback - uri: prefix: /static - uri: regex: '^.*\.(ico|png|jpg)$' route: - destination: host: sa-frontend # 2 port: number: 80</code> </pre> <br>  Poin-poin penting: <br><br><ol><li>  Layanan Virtual ini mengacu pada permintaan yang datang melalui <b>http-gateway</b> ; </li><li>  <code>destination</code> menentukan layanan tempat permintaan dikirimkan. </li></ol><br>  <b>Catatan</b> : Konfigurasi di atas disimpan dalam file <code>sa-virtualservice-external.yaml</code> , yang juga berisi pengaturan untuk perutean di SA-WebApp dan SA-Umpan Balik, tetapi disingkat di sini dalam artikel untuk singkatnya. <br><br>  Terapkan VirtualService dengan menelepon: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/sa-virtualservice-external.yaml virtualservice.networking.istio.io/sa-external-services created</code> </pre> <br>  <b>Catatan</b> : Saat kami menggunakan sumber daya Istio, Server API Kubernetes memunculkan peristiwa yang menerima Pesawat Kontrol Istio, dan setelah itu konfigurasi baru diterapkan ke proksi Utusan masing-masing pod.  Dan kontroler Gateway Ingress tampaknya Utusan berikutnya yang dikonfigurasi di Control Plane.  Semua ini pada diagram terlihat seperti ini: <br><br><img src="https://habrastorage.org/webt/dz/nz/4b/dznz4bh_wpzcv7tx8jkykkiad9q.png"><br>  <i>Konfigurasi Istio-IngressGateway untuk perutean kueri</i> <br><br>  Analisis Sentimen telah tersedia di <code>http://{EXTERNAL-IP}/</code> .  Jangan khawatir jika Anda mendapatkan status Tidak Ditemukan: <i>kadang-kadang butuh sedikit lebih lama untuk konfigurasi untuk berlaku dan Utusan cache untuk diperbarui</i> . <br><br>  Sebelum melanjutkan, bekerjalah sedikit dengan aplikasi untuk menghasilkan lalu lintas <i>(keberadaannya diperlukan untuk kejelasan dalam langkah selanjutnya - kira-kira. Terjemahan.)</i> . <br><br><h2>  Kiali: Observabilitas </h2><br>  Untuk sampai ke antarmuka administrasi Kiali, jalankan perintah berikut: <br><br><pre> <code class="bash hljs">$ kubectl port-forward \ $(kubectl get pod -n istio-system -l app=kiali \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].metadata.name}'</span></span>) \ -n istio-system 20001</code> </pre> <br>  ... dan buka <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">http: // localhost: 20001 /</a> , masuk sebagai admin / admin.  Di sini Anda akan menemukan banyak fitur yang berguna, misalnya, untuk memeriksa konfigurasi komponen Istio, memvisualisasikan layanan berdasarkan informasi yang dikumpulkan saat mencegat permintaan jaringan, menerima jawaban atas pertanyaan "Siapa yang menghubungi siapa?", "Versi layanan mana yang lumpuh?"  dll.  Secara umum, jelajahi kemungkinan Kiali sebelum beralih ke memvisualisasikan metrik dengan Grafana. <br><br><img src="https://habrastorage.org/webt/ix/pd/wr/ixpdwrppiekv0dbk3xcbceasft8.png"><br><br><h2>  Grafana: visualisasi metrik </h2><br>  Metrik yang dikumpulkan di Istio masuk ke Prometheus dan divisualisasikan dengan Grafana.  Untuk masuk ke antarmuka admin Grafana, jalankan perintah di bawah ini, lalu buka <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">http: // localhost: 3000 /</a> : <br><br><pre> <code class="bash hljs">$ kubectl -n istio-system port-forward \ $(kubectl -n istio-system get pod -l app=grafana \ -o jsonpath={.items[0].metadata.name}) 3000</code> </pre> <br>  Dengan mengklik menu <b>Beranda</b> di kiri atas dan memilih <b>Dasbor Layanan Istio</b> di sudut kiri atas, mulailah dengan <b>layanan aplikasi-sa-web</b> untuk melihat metrik yang dikumpulkan: <br><br><img src="https://habrastorage.org/webt/wb/vz/4t/wbvz4tkgi3qgoitxhhwhppk9pu8.png"><br><br>  Di sini kami menunggu kinerja yang kosong dan benar-benar membosankan - manajemen tidak akan pernah menyetujui ini.  Mari kita membuat beban kecil dengan perintah berikut: <br><br><pre> <code class="bash hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ curl -i http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/sentiment \ -H <span class="hljs-string"><span class="hljs-string">"Content-type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"sentence": "I love yogobella"}'</span></span>; \ sleep .8; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br>  Sekarang kami memiliki grafik yang jauh lebih bagus, dan selain itu, alat Prometheus yang luar biasa untuk pemantauan dan Grafana untuk memvisualisasikan metrik, yang akan memungkinkan kami untuk belajar tentang kinerja, status kesehatan, peningkatan / penurunan layanan dari waktu ke waktu. <br><br>  Akhirnya, mari kita lihat jejak permintaan dalam layanan. <br><br><h2>  Jaeger: jejak </h2><br>  Kita perlu melacak, karena semakin banyak layanan yang kita miliki, semakin sulit untuk sampai pada penyebab kegagalan.  Mari kita lihat contoh sederhana dari gambar di bawah ini: <br><br><img src="https://habrastorage.org/webt/dv/8w/iv/dv8wivmvfn20fvmaebzk8wl6h68.png"><br>  <i>Contoh khas permintaan gagal acak</i> <br><br>  Permintaan datang, jatuh - <i>apa alasannya?</i>  <i>Layanan pertama?</i>  <i>Atau yang kedua?</i>  Ada pengecualian di keduanya - mari kita lihat log masing-masing.  Seberapa sering Anda menemukan diri Anda melakukan ini?  Pekerjaan kami lebih seperti detektif perangkat lunak daripada pengembang ... <br><br>  Ini adalah masalah yang tersebar luas di layanan microser dan diselesaikan dengan sistem jejak terdistribusi di mana layanan saling melewati header yang unik, setelah itu informasi ini dialihkan ke sistem jejak, di mana ia dipetakan ke data permintaan.  Berikut ini ilustrasi: <br><br><img src="https://habrastorage.org/webt/an/_h/tz/an_htzqnc3b4xxhgkzdqi5my-ki.png"><br>  <i>TraceId digunakan untuk mengidentifikasi permintaan.</i> <br><br>  Istio menggunakan Jaeger Tracer, yang mengimplementasikan kerangka kerja OpenTracing API yang independen-vendor.  Anda dapat mengakses antarmuka pengguna Jaeger dengan perintah berikut: <br><br><pre> <code class="bash hljs">$ kubectl port-forward -n istio-system \ $(kubectl get pod -n istio-system -l app=jaeger \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].metadata.name}'</span></span>) 16686</code> </pre> <br>  Sekarang buka <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">http: // localhost: 16686 /</a> dan pilih layanan <b>sa-web-app</b> .  Jika layanan tidak ditampilkan dalam menu tarik-turun, tampilkan / hasilkan aktivitas pada halaman dan perbarui antarmuka.  Setelah itu, klik tombol <b>Cari Jejak</b> , yang akan menampilkan jejak terbaru - pilih apa saja - informasi terperinci tentang semua jejak akan muncul: <br><br><img src="https://habrastorage.org/webt/r8/zx/1q/r8zx1qjxc2a316-4a803l4vmzv4.png"><br><br>  Jejak ini menunjukkan: <br><br><ol><li>  Permintaan datang ke <b>istio-ingressgateway</b> (ini adalah interaksi pertama dengan salah satu layanan, dan ID Jejak dihasilkan untuk permintaan), setelah itu gateway mengirimkan permintaan ke <b>layanan aplikasi-sa-web</b> . </li><li>  Dalam layanan <b>sa-web-app,</b> permintaan dijemput oleh sespan Utusan, "anak" dibuat dalam rentang (oleh karena itu kita melihatnya di jejak) dan dialihkan ke wadah <b>sa-web-app</b> .  <i>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Rentang</a> adalah unit kerja logis di Jaeger yang memiliki nama, waktu operasi dimulai dan durasinya. Rentang dapat disarangkan dan dipesan. Grafik asiklik yang diarahkan dari bentang membentuk jejak. - sekitar Terjemahan.)</i> </li><li>  Di sini, permintaan diproses oleh metode <b>sentimentAnalysis</b> .  Jejak-jejak ini sudah dihasilkan oleh aplikasi, mis.  mereka membutuhkan perubahan pada kode. </li><li>  Dari saat ini, permintaan POST untuk <b>s-logika</b> dimulai.  Trace ID harus diteruskan dari <b>sa-web-app</b> . </li><li>  ... </li></ol><br>  <b>Catatan</b> : Pada langkah 4, aplikasi akan melihat header yang dihasilkan oleh Istio dan meneruskannya ke permintaan berikutnya, seperti yang ditunjukkan pada gambar di bawah ini: <br><br><img src="https://habrastorage.org/webt/qg/a9/ai/qga9aibwkynfogbcxfo2cnwqxfm.png"><br>  <i>(A) Istio bertanggung jawab untuk meneruskan header;</i>  <i><b>(B) Layanan bertanggung jawab atas tajuk.</b></i> <br><br>  Istio melakukan sebagian besar pekerjaan, seperti  menghasilkan tajuk untuk permintaan masuk, membuat bentang baru di setiap sespan dan meneruskannya.  Namun, tanpa bekerja dengan header di dalam layanan, jalur jejak penuh permintaan akan hilang. <br><br>  Judul berikut harus dipertimbangkan (diteruskan): <br><br><pre> <code class="plaintext hljs">x-request-id x-b3-traceid x-b3-spanid x-b3-parentspanid x-b3-sampled x-b3-flags x-ot-span-context</code> </pre> <br>  Ini adalah tugas sederhana, namun, untuk menyederhanakan implementasinya, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">banyak perpustakaan</a> sudah ada - misalnya, dalam layanan sa-web-app, klien RestTemplate meneruskan tajuk ini jika Anda hanya menambahkan pustaka Jaeger dan OpenTracing tergantung <a href="">padanya</a> . <br><br>  <i>Perhatikan bahwa aplikasi Analisis Sentimen menunjukkan implementasi pada Flask, Spring, dan ASP.NET Core.</i> <br><br>  Sekarang sudah menjadi jelas apa yang kita dapatkan di luar kotak (atau hampir "di luar kotak"), pertimbangkan masalah perutean yang diatur secara halus, manajemen lalu lintas jaringan, keamanan, dll! <br><br>  <i><b>Catatan</b></i>  <i><b>perev.</b></i>  <i>: Baca tentang ini dalam angsuran Rinor Maloku Istio berikutnya, yang akan tersedia di blog kami dalam waktu dekat.</i>  <i><b>PEMBARUAN</b> (14 Maret): <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian kedua</a> telah diterbitkan.</i> <br><br><h2>  PS dari penerjemah </h2><br>  Baca juga di blog kami: <br><br><ul><li>  â€œKembali ke layanan microser dengan Istioâ€: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bagian 2 (perutean, kontrol lalu lintas)</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bagian 3 (otentikasi dan otorisasi)</a> ; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Conduit - mesh layanan ringan untuk Kubernetes</a> "; </li><li>  â€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Apa itu service mesh dan mengapa saya membutuhkannya [untuk aplikasi cloud dengan layanan microser]?</a>  "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Sebuah Panduan Ilustrasi untuk Jaringan di Kubernetes."</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 1 dan 2</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagaimana wadah sespan ini sampai di sini [di Kubernetes]?"</a>  ". </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id438426/">https://habr.com/ru/post/id438426/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id438412/index.html">Analisis 112.654 tugas tes dan tren di pasar tenaga kerja programmer pada tahun 2019</a></li>
<li><a href="../id438414/index.html">Peradaban Musim Semi, 3/5</a></li>
<li><a href="../id438416/index.html">Tentang hormon</a></li>
<li><a href="../id438420/index.html">AI pada 2019: keadaan saat ini</a></li>
<li><a href="../id438422/index.html">Program cedera elektif (bagian dua): Longride pada pertolongan pertama dan resusitasi</a></li>
<li><a href="../id438428/index.html">Instansi pemerintah menemukan cara untuk menyabotase perangkat lunak domestik</a></li>
<li><a href="../id438430/index.html">Saya terjebak! Atau cara mengatasi efek dataran tinggi dalam belajar bahasa Inggris</a></li>
<li><a href="../id438434/index.html">Lab Peretas: P1. Libssh auth bypass</a></li>
<li><a href="../id438436/index.html">Gagasan tentang bagaimana memberi karyawan akses sementara ke sumber daya pelanggan tanpa menyinari kembali kata sandi</a></li>
<li><a href="../id438438/index.html">Makanan untuk Bitrix Parrots. Kami menguji kinerja, pilih besi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>