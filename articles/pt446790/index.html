<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßóüèø üò≥ üï¥üèª Como descobri um ovo de p√°scoa na seguran√ßa do Android e n√£o consegui um emprego no Google üîö üéÜ üî°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O Google adora ovos de p√°scoa. Na verdade, ele os ama tanto que voc√™ pode encontr√°-los em praticamente todos os produtos deles. A tradi√ß√£o dos ovos de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como descobri um ovo de p√°scoa na seguran√ßa do Android e n√£o consegui um emprego no Google</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446790/"><img src="https://habrastorage.org/webt/cx/0o/3t/cx0o3tqoavfz_opnsomw9-65h_i.jpeg" align="left">  O Google adora ovos de p√°scoa.  Na verdade, ele os ama tanto que voc√™ pode encontr√°-los em praticamente todos os produtos deles.  A tradi√ß√£o dos ovos de p√°scoa para Android come√ßou nas vers√µes mais antigas do sistema operacional (acho que todos sabem o que acontece quando voc√™ acessa as configura√ß√µes gerais e toca no n√∫mero da vers√£o algumas vezes). <br><br>  Mas √†s vezes voc√™ pode encontrar um ovo de p√°scoa nos lugares mais improv√°veis.  Existe at√© uma lenda urbana que, um dia, um programador pesquisou no Google o "bloqueio mutex", mas, em vez dos resultados da pesquisa, chegou ao foo.bar, resolveu todas as tarefas e conseguiu um emprego no Google. <br><br><div class="spoiler">  <b class="spoiler_title">Reconstru√ß√£o</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/157/242/ffc/157242ffcbf299f7a67641f9df1e551e.jpg" alt="imagem"><br></div></div><br>  A mesma coisa (exceto sem o final feliz) aconteceu comigo.  Mensagens ocultas onde definitivamente n√£o poderia haver nenhuma, revertendo o c√≥digo Java e suas bibliotecas nativas, uma VM secreta, uma entrevista no Google - tudo isso abaixo. <br><a name="habracut"></a><br><h3>  Droidguard </h3><br>  Uma noite chata, redefinii o telefone de f√°brica e comecei a configur√°-lo novamente.  Para come√ßar, uma nova instala√ß√£o do Android me pediu para acessar a Conta do Google.  E me perguntei: como funciona o processo de logon no Android?  E a noite de repente se tornou menos chata. <br><br>  Eu uso o Burp Suite do PortSwigger para interceptar e analisar o tr√°fego de rede.  A vers√£o comunit√°ria gratuita √© suficiente para nossos prop√≥sitos.  Para ver as solicita√ß√µes https, primeiro precisamos instalar o certificado do PortSwigger no dispositivo.  Como dispositivo de teste, escolhi um Samsung Galaxy S de 8 anos com Android 4.4.  Qualquer coisa mais recente que isso e voc√™ pode ter problemas com a fixa√ß√£o de certificados e outras coisas. <br><br>  Com toda a honestidade, n√£o h√° nada de especial nas solicita√ß√µes da API do Google.  O dispositivo envia informa√ß√µes sobre si mesmo e recebe tokens em resposta ... O √∫nico passo curioso √© uma solicita√ß√£o POST ao servi√ßo antiabuso. <br><br><img src="https://habrastorage.org/webt/nv/4c/7n/nv4c7njt_zecyvp0vquekhnoxbm.png"><br><br>  Ap√≥s a solicita√ß√£o, entre v√°rios par√¢metros muito normais, aparece um interessante, chamado <b>droidguard_result</b> .  √â uma string Base64 muito longa: <br><br><img src="https://habrastorage.org/webt/kp/h3/i-/kph3i-1n7tw9dv-ckitddw4rxdm.png"><br><br>  O DroidGuard √© o mecanismo do Google para detectar bots e emuladores entre dispositivos reais.  O SafetyNet, por exemplo, tamb√©m usa os dados do DroidGuard.  O Google tamb√©m tem algo parecido com os navegadores - o Botguard. <br><br>  Mas o que s√£o esses dados?  Vamos descobrir. <br><br><h3>  Buffers de protocolo </h3><br>  O que gera esse link ( <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">www.googleapis.com/androidantiabuse/v1/x/create?alt=PROTO&amp;key=AIzaSyBofcZsgLSS7BOnBjZPEkk4rYwzOIz-lTI</a></i> ) e o que dentro do Android faz essa solicita√ß√£o?  Ap√≥s uma breve investiga√ß√£o, verificou-se que o link, nesta forma exata, est√° localizado dentro de uma das classes ofuscadas do Google Play Services: <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bdd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context var1, bdh var2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>(var1, <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/androidantiabuse/v1/x/create?alt=PROTO&amp;key=AIzaSyBofcZsgLSS7BOnBjZPEkk4rYwzOIz-lTI"</span></span>, var2); }</code> </pre> <br>  Como j√° vimos em Burp, as solicita√ß√µes POST neste link t√™m o <b>Tipo de conte√∫do</b> - <b>application / x-protobuf</b> (Google Protocol Buffers, protocolo do Google para serializa√ß√£o bin√°ria).  Por√©m, n√£o √© json - √© dif√≠cil descobrir exatamente o que est√° sendo enviado. <br><br>  Buffers de protocolo funcionam assim: <br><br><ul><li>  Primeiro, descrevemos a estrutura da mensagem em um formato especial e a salvamos em um arquivo .proto; </li><li>  Em seguida, compilamos os arquivos .proto e o compilador protoc gera o c√≥digo-fonte em um idioma escolhido (no caso do Android, √© Java); </li><li>  Finalmente, usamos as classes geradas em nosso projeto. </li></ul><br>  Temos duas maneiras de decodificar mensagens protobuf.  O primeiro √© usar um analisador de protobuf e tentar recriar a descri√ß√£o original dos arquivos .proto.  O segundo √© retirar as classes geradas por protocolo do Google Play Services, que foi o que eu decidi fazer. <br><br>  Tomamos o arquivo .apk do Google Play Services da mesma vers√£o que est√° instalada no dispositivo (ou, se o dispositivo estiver enraizado, basta pegar o arquivo diretamente a partir da√≠).  Usando dex2jar, convertemos o arquivo .dex novamente em .jar e abrimos em um descompilador de sua escolha.  Pessoalmente, gosto do Fernflower da JetBrains.  Ele funciona como um plug-in para o IntelliJ IDEA (ou Android Studio); portanto, basta iniciar o Android Studio e abrir o arquivo com o link que estamos tentando analisar.  Se o programa n√£o estiver se esfor√ßando muito, o c√≥digo Java descompilado para a cria√ß√£o de mensagens protobuf poder√° ser copiado e colado em seu projeto. <br><br>  Observando o c√≥digo descompilado, vemos que Build. * Constantes est√£o sendo enviadas dentro da mensagem protobuf.  (ok, isso n√£o foi muito dif√≠cil de adivinhar). <br><br><pre> <code class="java hljs">... var3.a(<span class="hljs-string"><span class="hljs-string">"4.0.33 (910055-30)"</span></span>); a(var3, <span class="hljs-string"><span class="hljs-string">"BOARD"</span></span>, Build.BOARD); a(var3, <span class="hljs-string"><span class="hljs-string">"BOOTLOADER"</span></span>, Build.BOOTLOADER); a(var3, <span class="hljs-string"><span class="hljs-string">"BRAND"</span></span>, Build.BRAND); a(var3, <span class="hljs-string"><span class="hljs-string">"CPU_ABI"</span></span>, Build.CPU_ABI); a(var3, <span class="hljs-string"><span class="hljs-string">"CPU_ABI2"</span></span>, Build.CPU_ABI2); a(var3, <span class="hljs-string"><span class="hljs-string">"DEVICE"</span></span>, Build.DEVICE); ...</code> </pre><br>  Infelizmente, por√©m, na resposta do servidor, todos os campos de protobuf se transformaram em sopa de letrinhas ap√≥s a ofusca√ß√£o.  Mas podemos descobrir o que est√° l√° usando um manipulador de erros.  Veja como os dados provenientes do servidor s√£o verificados: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.d()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"byteCode"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.f()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"vmUrl"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.h()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"vmChecksum"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.j()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"expiryTimeSecs"</span></span>); }</code> </pre><br>  Aparentemente, foi assim que os campos foram chamados antes da ofusca√ß√£o: <b>byteCode</b> , <b>vmUrl</b> , <b>vmChecksum</b> e <b>expiryTimeSecs</b> .  Esse esquema de nomenclatura j√° nos d√° algumas id√©ias. <br><br>  Combinamos todas as classes descompiladas do Google Play Services em um projeto de teste, renomeie-as, gere comandos de teste Build Build. * E inicie (imitando qualquer dispositivo que desejarmos).  Se algu√©m quiser fazer isso sozinho, aqui est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o link para o meu GitHub</a> . <br><br>  Se a solicita√ß√£o estiver correta, o servidor retornar√° isso: <br><blockquote>  00: 06: 26.761 [principal] INFO daresponse.AntiabuseResponse - byteCode size: 34446 <br>  00: 06: 26.761 [principal] INFO daresponse.AntiabuseResponse - vmChecksum: C15E93CCFD9EF178293A2334A1C9F9B08F115993 <br>  00: 06: 26.761 [principal] INFO daresponse.AntiabuseResponse - vmUrl: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">www.gstatic.com/droidguard/C15E93CCFD9EF178293A2334A1C9F9B08F115993</a> <br>  00: 06: 26.761 [principal] INFO daresponse.AntiabuseResponse - expiryTimeSecs: 10 </blockquote><br>  Etapa 1 conclu√≠da.  Agora vamos ver o que est√° oculto por tr√°s do link <b>vmUrl</b> . <br><br><h3>  Segredo APK </h3><br>  O link nos leva diretamente a um arquivo .apk, nomeado ap√≥s seu pr√≥prio hash SHA-1.  √â bastante pequeno - apenas 150 KB.  E isso √© justificado: se ele √© baixado por cada um dos 2 bilh√µes de dispositivos Android, isso representa 270 TB de tr√°fego nos servi√ßos do Google. <br><br><img src="https://habrastorage.org/webt/-s/di/nj/-sdinjinilpprsvgslvs3e6gsdk.png"><br><br>  <code>DroidGuardService</code> classe <code>DroidGuardService</code> , como parte do Google Play Services, baixa o arquivo no dispositivo, descompacta, extrai .dex e usa a classe <code>com.google.ccc.abuse.droidguard.DroidGuard</code> por meio de reflex√£o.  Se houver um erro, o <code>DroidGuardService</code> alterna do DroidGuard para o Droidguasso.  Mas isso √© outra hist√≥ria inteiramente. <br><br>  Essencialmente, a classe <code>DroidGuard</code> √© um wrapper JNI simples em torno da biblioteca .so nativa.  A ABI da biblioteca nativa corresponde ao que enviamos no campo <code>CPU_ABI</code> na solicita√ß√£o protobuf: podemos solicitar armeabi, x86 ou mesmo MIPS. <br><br>  O servi√ßo <code>DroidGuardService</code> si n√£o cont√©m nenhuma l√≥gica interessante para trabalhar com a classe <code>DroidGuard</code> .  Ele simplesmente cria uma nova inst√¢ncia do <code>DroidGuard</code> , envia o <b>byteCode a</b> partir da mensagem protobuf, chama um m√©todo p√∫blico, que retorna uma matriz de bytes.  Essa matriz √© ent√£o enviada ao servidor dentro do par√¢metro <b>droidguard_result</b> . <br><br>  Para ter uma id√©ia aproximada do que est√° acontecendo no <code>DroidGuard</code> , podemos repetir a l√≥gica do <code>DroidGuardService</code> (mas sem fazer o download do .apk, pois j√° temos a biblioteca nativa).  Podemos pegar um arquivo .dex do APK secreto, convert√™-lo em .jar e depois us√°-lo em nosso projeto.  O √∫nico problema √© como a classe <code>DroidGuard</code> carrega a biblioteca nativa.  O bloco de inicializa√ß√£o est√°tica chama o m√©todo <code>loadDroidGuardLibrary()</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { loadDroidGuardLibrary(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(ex); } }</code> </pre><br>  Em seguida, o m√©todo <code>loadDroidGuardLibrary()</code> l√™ library.txt (localizado na raiz do arquivo .apk) e carrega a biblioteca com esse nome pela chamada <code>System.load(String filename)</code> .  N√£o √© muito conveniente para n√≥s, pois precisar√≠amos criar o .apk de uma maneira muito espec√≠fica para colocar library.txt e o arquivo .so em sua raiz.  Seria muito mais conveniente manter o arquivo .so na pasta lib e carreg√°-lo atrav√©s de <code>System.loadLibrary(String libname)</code> . <br><br>  N√£o √© dif√≠cil de fazer.  Usaremos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">smali / baksmali</a> - assembler / disassembler para arquivos .dex.  Depois de us√°-lo, o classes.dex se transforma em v√°rios arquivos .smali.  A classe <code>com.google.ccc.abuse.droidguard.DroidGuard</code> deve ser modificada, para que o bloco de inicializa√ß√£o est√°tica chame o m√©todo <code>System.loadLibrary("droidguard")</code> vez de <code>loadDroidGuardLibrary()</code> .  A sintaxe do Smali √© bastante simples, o novo bloco de inicializa√ß√£o √© assim: <br><br><pre> <code class="plaintext hljs">.method static constructor &lt;clinit&gt;()V .locals 1 const-string v0, "droidguard" invoke-static {v0}, Ljava/lang/System;-&gt;loadLibrary(Ljava/lang/String;)V return-void .end method</code> </pre><br>  Em seguida, usamos backsmali para compilar tudo de volta em .dex e depois convertemos em .jar.  No final, obtemos um arquivo .jar que podemos usar em nosso projeto - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui est√°</a> , a prop√≥sito. <br><br>  A se√ß√£o inteira relacionada ao DroidGuard tem algumas seq√º√™ncias de caracteres.  A parte mais importante √© fazer o download da matriz de bytes que obtivemos na etapa anterior ap√≥s endere√ßar o servi√ßo antiabuso e entreg√°-lo ao construtor <code>DroidGuard</code> : <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runDroidguard</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> byteCode: ByteArray? = loadBytecode(<span class="hljs-string"><span class="hljs-string">"bytecode.base64"</span></span>); byteCode?.let { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> droidguard = DroidGuard(applicationContext, <span class="hljs-string"><span class="hljs-string">"addAccount"</span></span>, it) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> params = mapOf(<span class="hljs-string"><span class="hljs-string">"dg_email"</span></span> to <span class="hljs-string"><span class="hljs-string">"test@gmail.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"dg_gmsCoreVersion"</span></span> to <span class="hljs-string"><span class="hljs-string">"910055-30"</span></span>, <span class="hljs-string"><span class="hljs-string">"dg_package"</span></span> to <span class="hljs-string"><span class="hljs-string">"com.google.android.gms"</span></span>, <span class="hljs-string"><span class="hljs-string">"dg_androidId"</span></span> to UUID.randomUUID().toString()) droidguard.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = droidguard.ss(params) droidguard.close() } }</code> </pre><br>  Agora podemos usar o criador de perfil do Android Studio e ver o que acontece durante o trabalho do DroidGuard: <br><br><img src="https://habrastorage.org/webt/c-/9w/pz/c-9wpzbrrpibjyflhyrunq3azu0.png"><br><br>  O m√©todo nativo initNative () coleta dados sobre o dispositivo e chama os m√©todos Java <code>hasSystemFeature(), getMemoryInfo(), getPackageInfo()</code> ... isso √© algo, mas ainda n√£o vejo nenhuma l√≥gica s√≥lida.  Bem, tudo o que resta √© desmontar o arquivo .so. <br><br><h3>  libdroidguard.so </h3><br>  Felizmente, analisar a biblioteca nativa n√£o √© mais dif√≠cil do que faz√™-lo com arquivos .dex e .jar.  Precis√°vamos de um aplicativo semelhante ao Hex-Rays IDA e algum conhecimento do c√≥digo montador x86 ou ARM.  Eu escolhi o ARM, j√° que eu tinha um dispositivo enraizado para depura√ß√£o.  Se voc√™ n√£o tiver uma, poder√° pegar uma biblioteca x86 e depurar usando um emulador. <br><br>  Um aplicativo semelhante ao Hex-Rays IDA decompila o bin√°rio em algo semelhante ao c√≥digo C.  Se abrirmos o m√©todo <code>Java_com_google_ccc_abuse_droidguard_DroidGuard_ssNative</code> , veremos algo assim: <br><br><pre> <code class="cpp hljs">__int64 __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_google_ccc_abuse_droidguard_DroidGuard_initNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a3, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a4, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a5, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a6, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a7, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a8, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a9)</span></span></span><span class="hljs-function"> ... v14 </span></span>= (*(_DWORD *)v9 + <span class="hljs-number"><span class="hljs-number">684</span></span>))(v9, a5); v15 = (*(_DWORD *)v9 + <span class="hljs-number"><span class="hljs-number">736</span></span>))(v9, a5, <span class="hljs-number"><span class="hljs-number">0</span></span>); ...</code> </pre><br>  N√£o parece muito promissor.  Primeiro, precisamos fazer algumas etapas preliminares para transformar isso em algo mais √∫til.  O descompilador n√£o sabe nada sobre JNI, por isso instalamos o Android NDK e importamos o arquivo jni.h.  Como sabemos, os dois primeiros par√¢metros de um m√©todo JNI s√£o <code>JNIEnv*</code> e <code>jobject (this)</code> .  Podemos descobrir os tipos de outros par√¢metros no c√≥digo Java do DroidGuard.  Ap√≥s atribuir os tipos corretos, as compensa√ß√µes sem sentido se transformam em chamadas de m√©todo JNI: <br><br><pre> <code class="cpp hljs">__int64 __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_google_ccc_abuse_droidguard_DroidGuard_initNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_JNIEnv *env, jobject thiz, jobject context, jstring flow, jbyteArray byteCode, jobject runtimeApi, jobject extras, jint loggingFd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> runningInAppSide)</span></span></span><span class="hljs-function"> </span></span>{ ... programLength = _env-&gt;functions-&gt;GetArrayLength)(_env, byteCode); programBytes = (jbyte *)_env-&gt;functions-&gt;GetByteArrayElements)(_env, byteCode, <span class="hljs-number"><span class="hljs-number">0</span></span>); ...</code> </pre><br>  Se tivermos paci√™ncia suficiente para rastrear a matriz de bytes recebida do servidor antiabuso, ficaremos ... desapontados.  Infelizmente, n√£o h√° uma resposta simples para "o que est√° acontecendo aqui?".  √â um c√≥digo de bytes puro e destilado, e a biblioteca nativa √© uma m√°quina virtual.  Alguma criptografia AES espalhada na parte superior e, em seguida, a VM l√™ o c√≥digo de byte, byte a byte e executa comandos.  Cada byte √© um comando seguido por operandos.  N√£o existem muitos comandos, apenas cerca de 70: read int, read byte, read string, chame o m√©todo Java, multiplique dois n√∫meros, if-goto etc. <br><br><h3>  Acorde neo </h3><br>  Decidi ir ainda mais longe e descobrir a estrutura do c√≥digo de bytes para esta VM.  H√° outro problema com as chamadas: algumas vezes (uma vez a cada duas semanas), h√° uma nova vers√£o da biblioteca nativa na qual os pares de comandos de bytes s√£o misturados.  Isso n√£o me impediu e decidi recriar a VM usando Java. <br><br>  O que o c√≥digo de byte faz √© todo o trabalho de rotina na coleta de informa√ß√µes sobre o dispositivo.  Por exemplo, ele carrega uma string com o nome de um m√©todo, obt√©m seu endere√ßo atrav√©s do dlsym e √© executado.  Na minha vers√£o Java da VM, recriei apenas mais ou menos cinco m√©todos e aprendi a interpretar os 25 primeiros comandos do c√≥digo de bytes do servi√ßo antiabuso.  No 26¬∫ comando, a VM leu outra sequ√™ncia criptografada do c√≥digo de byte.  De repente, descobriu-se que n√£o √© o nome de outro m√©todo.  Longe disso. <br><blockquote>  Comando da m√°quina virtual n¬∫ 26 <br>  Chamada de m√©todo vm-&gt; vm_method_table [2 * 0x77] <br>  M√©todo vmMethod_readString <br>  o √≠ndice √© 0x9d <br>  o comprimento da string √© 0x0066 <br>  (nova chave √© gerada) <br>  bytes de cadeia codificados s√£o EB 4E E6 DC 34 13 35 4A DD 55 B3 91 33 05 61 04 C0 54 FD 95 2F 18 72 04 C1 55 E1 92 28 11 66 04 DD 4F B3 94 33 04 35 0A C1 4E B2 DB 12 17 79 4F 92 55 FC DB 33 05 35 45 C6 01 F7 89 29 1F 71 43 C7 40 E1 9F 6B 1E 70 48 DE 4E B8 CD 75 44 23 14 85 14 A7 C2 7F 40 26 42 84 17 A2 BB 21 19 7 43 DE 44 BD 98 29 1B <br>  bytes de cadeia decodificados s√£o 59 6F 75 27 72 65 20 6E 6F 74 20 6A 75 73 74 20 72 75 6E 6E 69 6E 67 20 73 74 72 69 6E 67 73 20 6F 6E 20 6F 75 72 20 2E 73 6F 21 20 54 61 6C 6B 20 74 6F 20 75 73 20 61 74 20 64 72 6F 69 64 67 75 61 72 64 2D 68 65 6C 6C 6F 2B 36 33 32 36 30 37 35 34 39 39 36 33 66 36 36 31 40 67 6F 6F 67 6C 65 2E 63 6F 6D <br>  o valor da string decodificada √© ( <b>voc√™ n√£o est√° apenas executando strings no nosso .so! Fale conosco pelo e-mail droidguard@google.com</b> ) </blockquote>  Isso √© estranho.  Uma m√°quina virtual nunca falou comigo antes.  Eu pensei que se voc√™ come√ßar a ver mensagens secretas direcionadas a voc√™, estar√° ficando louco.  Apenas para ter certeza de que ainda estava em s√£ consci√™ncia, executei algumas centenas de respostas diferentes do servi√ßo anti-abuso por meio da minha VM.  Literalmente, a cada 25 a 30 comandos, havia uma mensagem oculta no c√≥digo de bytes.  Eles costumam repetir, mas abaixo est√£o alguns exclusivos.  No entanto, editei os endere√ßos de email: cada mensagem tinha um endere√ßo diferente, algo como "droidguard+tag@google.com", com a tag exclusiva para cada uma. <br><blockquote>  droidguard@google.com: n√£o seja um estranho! <br>  Voc√™ entrou!  Fale conosco em droidguard@google.com <br>  Sauda√ß√µes de droidguard@google.com intr√©pido viajante!  Diga oi! <br>  Foi f√°cil encontrar isso?  droidguard@google.com gostaria de saber <br>  O pessoal do droidguard@google.com gostaria de receber sua opini√£o! <br>  O que √© todo esse gobbledygook?  Pergunte a droidguard@google.com ... eles saberiam! <br>  Ei!  Gostaria de v√™-lo aqui.  Voc√™ j√° falou com droidguard@google.com? <br>  Voc√™ n√£o est√° apenas executando strings no nosso .so!  Fale conosco em droidguard@google.com <br></blockquote>  Eu sou o escolhido?  Eu pensei que era hora de parar de mexer com o DroidGuard e conversar com o Google, pois eles me pediram. <br><br><h3>  Sua liga√ß√£o √© muito importante para n√≥s </h3><br>  Eu contei minhas descobertas no e-mail que encontrei.  Para tornar os resultados um pouco mais impressionantes, automatizei um pouco o processo de an√°lise.  O problema √© que cadeias de caracteres e matrizes de bytes s√£o armazenadas no c√≥digo de bytes criptografado.  A VM os decodifica usando constantes alinhadas pelo compilador.  Usando um aplicativo semelhante ao Hex-Rays IDA, voc√™ pode extra√≠-los facilmente.  Por√©m, a cada nova vers√£o, as constantes s√£o alteradas e √© bastante inconveniente extra√≠-las sempre manualmente. <br><br>  Mas a an√°lise de Java da biblioteca nativa mostrou-se surpreendentemente simples.  Usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">jelf</a> (uma biblioteca para analisar arquivos ELF), encontramos o deslocamento do m√©todo <code>Java_com_google_ccc_abuse_droidguard_DroidGuard_initNative</code> no bin√°rio e, em seguida, usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Capstone</a> (uma estrutura de desmontagem com liga√ß√µes para v√°rios idiomas, incluindo Java), obtemos o c√≥digo do assembler e procuramos carregar constantes em registros. <br><br>  No final, recebi um aplicativo que emulava todo o processo do DroidGuard: faz uma solicita√ß√£o ao servi√ßo antiabuso, baixa o arquivo .apk, descompacta, analisa a biblioteca nativa, extrai as constantes necess√°rias, seleciona o mapeamento dos comandos da VM e interpreta o c√≥digo de bytes.  Compilei tudo e enviei para o Google.  Enquanto estava no assunto, comecei a me preparar para uma mudan√ßa e procurei no Glassdoor um sal√°rio m√©dio no Google.  Decidi n√£o concordar com nada menos que seis d√≠gitos. <br><br>  A resposta n√£o demorou muito.  Um email de um membro da equipe DroidGuard dizia simplesmente: "Por que voc√™ est√° fazendo isso?" <br><br><img src="https://habrastorage.org/webt/go/ql/kf/goqlkffwq02w6daa9-e22xxgdiq.jpeg"><br><br>  "Porque eu posso" - respondi.  Um funcion√°rio do Google me explicou que o DroidGuard deveria proteger o Android de hackers (voc√™ n√£o diz!) E seria prudente manter o c√≥digo fonte da minha VM do DroidGuard para mim.  Nossa conversa terminou a√≠. <br><br><h3>  Entrevista </h3><br>  Um m√™s depois, recebi outro email.  A equipe DroidGuard em Zurique precisava de um novo funcion√°rio.  Eu estava interessado em participar?  Claro! <br><br>  N√£o h√° atalhos para entrar no Google.  Tudo o que meu contato p√¥de fazer foi encaminhar meu curr√≠culo para o departamento de RH.  Depois disso, tive que passar pela habitual burocracia e uma s√©rie de entrevistas. <br><br>  H√° muitas hist√≥rias por a√≠ sobre entrevistas no Google.  Algoritmos, tarefas das Olimp√≠adas e programa√ß√£o do Google Docs n√£o s√£o o meu estilo, ent√£o comecei meus preparativos.  Li o curso de Algoritmos do Coursera dezenas de vezes, resolvi centenas de tarefas no Hackerrank e aprendi a percorrer um gr√°fico em ambas as dimens√µes com os olhos fechados. <br><br>  Dois meses se passaram.  Dizer que me senti preparado seria um eufemismo.  O Google Docs se tornou meu IDE favorito.  Eu senti que sabia tudo o que h√° para saber sobre algoritmos.  √â claro que eu conhecia minhas fraquezas e percebi que provavelmente n√£o passaria na s√©rie de cinco entrevistas em Zurique, mas ir √† Disneyland do programador de gra√ßa era uma recompensa por si s√≥.  O primeiro passo foi uma entrevista por telefone para eliminar os candidatos mais fracos e n√£o perder tempo dos desenvolvedores de Zurique em reuni√µes pessoais.  O dia estava marcado, o telefone tocou ... <br><br><img src="https://habrastorage.org/webt/5c/nk/uh/5cnkuh5btyvoaz0pyz-zma3flzs.png"><br><br>  ... e eu imediatamente falhei no meu primeiro teste.  Eu tive sorte - eles fizeram uma pergunta que eu j√° vi na internet e j√° resolvi.  Tratava-se de serializar uma matriz de strings.  Ofereci-me para codificar cadeias de caracteres no Base64 e salv√°-las atrav√©s de um divisor.  O entrevistador me pediu para desenvolver um algoritmo Base64.  Depois disso, a entrevista se transformou em uma esp√©cie de mon√≥logo, onde os entrevistados me explicaram como o Base64 funciona e tentei lembrar de opera√ß√µes de bits em Java. <br><br><div class="spoiler">  <b class="spoiler_title">Se algu√©m do Google estiver lendo isso</b> <div class="spoiler_text">  Gente, voc√™s s√£o g√™nios se chegarem l√°!  S√©rio.  N√£o consigo imaginar como √© poss√≠vel eliminar todos os obst√°culos que eles colocam diante de voc√™. <br></div></div><br>  Tr√™s dias ap√≥s a liga√ß√£o, recebi um e-mail dizendo que eles n√£o querem mais me entrevistar.  E foi assim que minha comunica√ß√£o com o Google terminou. <br><br>  Por que h√° mensagens no DroidGuard pedindo para conversar, eu ainda n√£o fa√ßo ideia.  Provavelmente apenas para estat√≠sticas.  O cara para quem eu escrevi me disse que as pessoas realmente escrevem l√°, mas a frequ√™ncia varia: √†s vezes eles recebem tr√™s respostas em uma semana, √†s vezes uma por ano. <br><br>  Acredito que existem maneiras mais f√°ceis de obter uma entrevista no Google.  Afinal, voc√™ pode perguntar a qualquer um dos 100.000 funcion√°rios (embora nem todos sejam desenvolvedores, √© certo).  Mas foi uma experi√™ncia divertida, no entanto. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt446790/">https://habr.com/ru/post/pt446790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt446776/index.html">Prova de Trabalho Eficaz</a></li>
<li><a href="../pt446780/index.html">Como criar um tema sombrio e n√£o prejudicar. Experi√™ncia em equipe do Yandex.Mail</a></li>
<li><a href="../pt446782/index.html">Yo-ho-ho e uma garrafa de rum</a></li>
<li><a href="../pt446786/index.html">Por que eu recusei o Disqus e voc√™ deveria ir tamb√©m</a></li>
<li><a href="../pt446788/index.html">Dicas e truques do Kubernetes: sobre desenvolvimento local e telepresen√ßa</a></li>
<li><a href="../pt446794/index.html">Trabalhamos com o Wordstat corretamente. Guia completo</a></li>
<li><a href="../pt446796/index.html">Circuitos n√£o padronizados: indicador de sete segmentos no ATtiny13</a></li>
<li><a href="../pt446798/index.html">A sa√≠da de um engenheiro eletr√¥nico da Apple causou alvoro√ßo entre os especuladores de a√ß√µes. Como se tornar como ele?</a></li>
<li><a href="../pt446802/index.html">Cartuchos de recarga - √â interessante</a></li>
<li><a href="../pt446806/index.html">Antecedentes: "Runet Aut√¥nomo" - o que √© e quem precisa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>