<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòπ ‚ò¢Ô∏è üóùÔ∏è Minha implementa√ß√£o do sistema de automa√ß√£o residencial üì™ üíÖüèª üë¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Durante muito tempo, li artigos sobre Habr√© sobre sistemas de automa√ß√£o residencial, queria descrever o que trabalho h√° mais de 2 anos. Para uma melho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Minha implementa√ß√£o do sistema de automa√ß√£o residencial</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/386457/"><img src="https://habrastorage.org/files/ea9/62e/a6d/ea962ea6d63c4af99f2a68e426d88fa5.jpg" align="right"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Durante muito tempo, li artigos sobre Habr√© sobre sistemas de automa√ß√£o residencial, queria descrever o que trabalho h√° mais de 2 anos. Para uma melhor compreens√£o da minha situa√ß√£o, voc√™ precisa fazer uma pequena introdu√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° tr√™s anos, minha fam√≠lia e eu nos mudamos para um novo apartamento de tr√™s quartos (67,5 m¬≤), embora tecnicamente o apartamento seja obviamente antigo - Stalin, uma casa constru√≠da em 1946. Fia√ß√£o de dois fios de alum√≠nio com peda√ßos de cabo de cobre de 1 metro quadrado em alguns lugares. A revis√£o estava √† frente, eu decidi fazer tudo sozinho e comecei com uma substitui√ß√£o completa da fia√ß√£o. Foram comprados 700m de cabo de alimenta√ß√£o para ilumina√ß√£o e soquetes de 1,5 e 2,5 m¬≤, compartimento de par tran√ßado, um pouco coaxial para antenas de televis√£o (apenas no caso). Por que tanto e o que aconteceu - pe√ßo um gato.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidi fazer a fia√ß√£o imediatamente, a saber: sem caixas de distribui√ß√£o, de cada ponto o cabo vai para a blindagem (com exce√ß√£o das tomadas, que podem estar em um grupo de 2-3 pontos, o cabo vai para a blindagem ao extremo, o restante √© conectado por um loop) - t. e de cada comutador, seu pr√≥prio cabo para a blindagem, de cada ponto de ilumina√ß√£o, seu pr√≥prio cabo para a blindagem, pr√≥ximo a soquetes ao longo de um par de pontos rj-45, por precau√ß√£o. Claro, existem muitos cabos. Em algum lugar, √© colocado no ch√£o, em conformidade com todas as regras da PUE, como, por exemplo, no ber√ß√°rio: </font></font><br>
<br>
<img src="https://habrastorage.org/files/09e/071/732/09e0717328cb46a0b0df95701ac88122.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em algum lugar - no teto, por exemplo, vista da porta do quarto:</font></font><br>
<br>
<img src="https://habrastorage.org/files/f0f/f50/510/f0ff505103224720825920b62b9da86c.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtemos todos os cabos no corredor em um local onde a blindagem estar√° localizada, e eles podem ser trocados entre si conforme desejado. Mesmo se voc√™ precisar alterar o esquema de conex√£o no futuro, n√£o demorar√° muito tempo e n√£o precisar√° estragar o reparo. E, √© claro, muitas tomadas foram feitas para todas as ocasi√µes - no total, cerca de 90 pontos para todo o apartamento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Era assim que o "escudo" tempor√°rio era durante as experi√™ncias: uma </font></font><br>
<br>
<img src="https://habrastorage.org/files/1e4/0bd/131/1e40bd1311d2412686170c0ae8619274.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
vis√£o terr√≠vel, mas tudo funcionou e, dessa forma, esse monstro viveu por v√°rios meses. Um belo dia, as estrelas foram formadas com sucesso e o escudo foi refeito por decis√£o deliberada. Demorou 3 dias em uma escada prec√°ria sob o teto (e os tetos no stalin 3m), mas valeu a pena. Aqui est√° a apar√™ncia do visor depois disso: </font></font><br>
<br>
<img src="https://habrastorage.org/files/34b/2e4/1e9/34b2e41e94a54217bad80ce53d2e0e45.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E a vis√£o geral:</font></font><br>
<br>
<img src="https://habrastorage.org/files/054/e15/85e/054e1585eeb74b7ebe62e3fcd946e1a3.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso est√° longe da forma final da blindagem, ainda n√£o h√° RCD suficiente, h√° 3 vezes menos disjuntores do que o necess√°rio, n√£o h√° rel√©s de pulso - mas h√° linhas sem desconex√£o, todos os cabos est√£o conectados aos terminais, h√° pelo menos algum tipo de seletividade de disjuntor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora que voc√™ tem uma id√©ia aproximada do que exatamente eu tinha para trabalhar, voc√™ pode come√ßar a descrever os "c√©rebros" do sistema. Sem mais delongas, tomei o arduino como base, principalmente porque j√° tinha duas placas freeduino, duas blindagens ethernet e uma blindagem de motor que comprei muito antes disso. Tamb√©m encomendados aos chineses v√°rios m√≥dulos de rel√© de 4 pe√ßas cada. E tamb√©m descobri, por recomenda√ß√£o de um dos artigos sobre Habr√© em Ob, interruptores nos quais podiam ser inseridas molas especiais e elas se transformaram em interruptores sem fixa√ß√£o. √â hora de escrever c√≥digo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, estou intimamente conectado com computadores na vida. Ele terminou o tapete de peles, no qual simplesmente n√£o escreveu - pascal, c #, c ++, 1c, php, javascript - voc√™ ainda pode listar muito. Na √∫ltima vez em que trabalho na √°rea de desenvolvimento web, tamb√©m trato de telefonia IP. Portanto, criar um algoritmo √© simples, mas com a eletr√¥nica "para voc√™", eu sei e sei coisas simples, e quando se trata de algo mais complicado - microcontroladores, fus√≠veis, rejei√ß√£o por contato - √© mais dif√≠cil. Mas n√£o s√£o os deuses que queimam as panelas, os olhos t√™m medo, mas as m√£os o fazem. Eu decidi simplificar tudo. Alimento a terra do arduino √† entrada do switch, conecto as sa√≠das do switch aos pinos anal√≥gicos no arduino (embora seja poss√≠vel digital, isso n√£o √© importante). Eu conecto os pinos do arduino com os pinos do m√≥dulo de rel√©. Tecnicamente, tudo est√° pronto, quando voc√™ pressiona o interruptor, o arduino v√™ o valor LOW no pino desejado e define o LOW no pino conectado ao m√≥dulo de rel√©.Dado que todos os cabos dos pontos do apartamento chegam aos terminais - a conex√£o n√£o demorou muito tempo.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para combater a rejei√ß√£o de contatos, depois de estudar o t√≥pico na Internet, a biblioteca Bounce2 foi selecionada. Em geral, inicialmente eu queria escrever um c√≥digo universal para que pudesse ser usado com pelo menos 2 switches, pelo menos 22. Foi essa tarefa que formou a base de todo o algoritmo. Bem, agora das palavras ao c√≥digo. N√£o carregarei completamente todo o c√≥digo; os links para o github estar√£o no final do artigo. Mostrarei apenas momentos importantes, do meu ponto de vista. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, declarando bibliotecas e vari√°veis:</font></font><br>
<br>
<pre><code class="hljs apache"><span class="hljs-comment">#include &lt;Bounce2.h&gt;</span>
<span class="hljs-comment">#include &lt;EEPROM.h&gt;</span><font></font>
<font></font>
<span class="hljs-attribute">const</span> byte cnt = <span class="hljs-number">8</span>;
<span class="hljs-attribute">const</span> byte pin_cnt = <span class="hljs-number">19</span>;<font></font>
<font></font>
<span class="hljs-attribute">int</span> pins[] = {<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,<span class="hljs-number">13</span>,<span class="hljs-number">13</span>,<span class="hljs-number">14</span>,<span class="hljs-number">15</span>,<span class="hljs-number">16</span>,<span class="hljs-number">17</span>};
<span class="hljs-attribute">int</span> leds[] = {<span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>};<font></font>
<font></font>
<span class="hljs-attribute">byte</span> init_leds[cnt] ;
<span class="hljs-attribute">byte</span> init_buttons[cnt];
<span class="hljs-attribute">int</span> button_states[cnt];
<span class="hljs-attribute">Bounce</span> debouncers[cnt];
<span class="hljs-attribute">unsigned</span> long buttonPressTimeStamps[cnt];
<span class="hljs-attribute">boolean</span> changed[cnt];
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ponto √©: basta aumentar a constante com o n√∫mero de l√¢mpadas / interruptores e registrar novas associa√ß√µes nas matrizes - e isso √© tudo, uma nova l√¢mpada ou comutador ser√° adicionado. </font><font style="vertical-align: inherit;">Ao mesmo tempo, a estrutura de c√≥digo permite que um switch controle v√°rios equipamentos ao mesmo tempo. </font><font style="vertical-align: inherit;">Ou v√°rios interruptores para controlar imediatamente uma l√¢mpada. </font><font style="vertical-align: inherit;">Al√©m disso, para cada op√ß√£o, sua pr√≥pria inst√¢ncia do objeto Bounce √© criada para anti-bounce. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na fun√ß√£o de configura√ß√£o, todas as matrizes s√£o inicializadas, enquanto o estado das lumin√°rias √© armazenado na mem√≥ria n√£o vol√°til, de modo que, quando ocorre uma falha de energia ou reinicializa√ß√£o, tudo gira da mesma forma que antes da falha.</font></font><br>
<br>
<pre><code class="hljs matlab">  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>) {<font></font>
    EEPROM.write(pins[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>) {<font></font>
    button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">0</span>;<font></font>
    <font></font>
    byte value = EEPROM.read(leds[<span class="hljs-built_in">i</span>]);
    <span class="hljs-keyword">if</span>(value==<span class="hljs-number">11</span>) {<font></font>
      init_leds[<span class="hljs-built_in">i</span>] = LOW ;<font></font>
    }<span class="hljs-keyword">else</span>{<font></font>
      init_leds[<span class="hljs-built_in">i</span>] = HIGH ;<font></font>
    }<font></font>
    init_buttons[<span class="hljs-built_in">i</span>] = HIGH;<font></font>
    buttonPressTimeStamps[<span class="hljs-built_in">i</span>] = <span class="hljs-number">0</span>;<font></font>
    changed[<span class="hljs-built_in">i</span>] = <span class="hljs-built_in">false</span>;<font></font>
<font></font>
    debouncers[<span class="hljs-built_in">i</span>] = Bounce();<font></font>
<font></font>
    pinMode(pins[<span class="hljs-built_in">i</span>], INPUT);<font></font>
    pinMode(leds[<span class="hljs-built_in">i</span>], OUTPUT);<font></font>
    <font></font>
    digitalWrite(pins[<span class="hljs-built_in">i</span>], init_buttons[<span class="hljs-built_in">i</span>]);<font></font>
    digitalWrite(leds[<span class="hljs-built_in">i</span>], init_leds[<span class="hljs-built_in">i</span>]);<font></font>
    <font></font>
    debouncers[<span class="hljs-built_in">i</span>].attach( pins[<span class="hljs-built_in">i</span>] );<font></font>
    debouncers[<span class="hljs-built_in">i</span>].interval(<span class="hljs-number">5</span>);<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o vou dizer nada sobre o primeiro ciclo, voltaremos a ele um pouco mais tarde. </font><font style="vertical-align: inherit;">E o mais interessante come√ßa no corpo do ciclo principal.</font></font><br>
<br>
<pre><code class="hljs matlab">void loop(){
  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>){<font></font>
    byte dvalue = EEPROM.read(pins[<span class="hljs-built_in">i</span>]);
    <span class="hljs-keyword">if</span>(dvalue!=<span class="hljs-number">11</span>) {<font></font>
      changed[<span class="hljs-built_in">i</span>] = debouncers[<span class="hljs-built_in">i</span>].update();<font></font>
      <font></font>
      <span class="hljs-keyword">if</span> ( changed[<span class="hljs-built_in">i</span>] ) {<font></font>
        int value = debouncers[<span class="hljs-built_in">i</span>].read();
        <span class="hljs-keyword">if</span> ( value == HIGH) {<font></font>
         button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">0</span>;   <font></font>
        } <span class="hljs-keyword">else</span> {
           <span class="hljs-keyword">if</span> (<span class="hljs-built_in">i</span> &gt; <span class="hljs-number">0</span> and pins[<span class="hljs-built_in">i</span>] == pins[<span class="hljs-built_in">i</span><span class="hljs-number">-1</span>]) {<font></font>
             byte prev_value = EEPROM.read(leds[<span class="hljs-built_in">i</span><span class="hljs-number">-1</span>]);<font></font>
                            <font></font>
             <span class="hljs-keyword">if</span>(prev_value == <span class="hljs-number">11</span>) {<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], LOW );<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">11</span>);<font></font>
             }<span class="hljs-keyword">else</span>{<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], HIGH);<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
             }<font></font>
           } <span class="hljs-keyword">else</span> {               <font></font>
             byte value = EEPROM.read(leds[<span class="hljs-built_in">i</span>]);
             <span class="hljs-keyword">if</span>(value==<span class="hljs-number">11</span>) {<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], HIGH );<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
             }<span class="hljs-keyword">else</span>{<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], LOW);<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">11</span>);<font></font>
             }<font></font>
           }<font></font>
                 <font></font>
           button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">1</span>;<font></font>
           buttonPressTimeStamps[<span class="hljs-built_in">i</span>] = millis();     <font></font>
        }<font></font>
      }<font></font>
   <font></font>
      <span class="hljs-keyword">if</span> ( button_states[<span class="hljs-built_in">i</span>] == <span class="hljs-number">1</span> ) {
        <span class="hljs-keyword">if</span> ( millis() - buttonPressTimeStamps[<span class="hljs-built_in">i</span>] &gt;= <span class="hljs-number">200</span> ) {<font></font>
            button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">2</span>;<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
<font></font>
  delay( <span class="hljs-number">10</span> );<font></font>
} <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante os testes das primeiras vers√µes do algoritmo, observou-se que as crian√ßas (e eu tenho tr√™s delas, meninos) realmente gostavam de clicar nos comutadores. </font><font style="vertical-align: inherit;">Portanto, era necess√°rio poder desligar alguns comutadores para que o controlador n√£o respondesse a eles. </font><font style="vertical-align: inherit;">A op√ß√£o mais √≥bvia √© simplesmente remover os pinos necess√°rios da placa, mas isso √© errado e desinteressante. </font><font style="vertical-align: inherit;">Portanto, os sinalizadores tamb√©m s√£o gravados na mem√≥ria n√£o vol√°til, indicando se o comutador est√° aberto ou n√£o. </font><font style="vertical-align: inherit;">Isso √© inicializado com este loop:</font></font><br>
<br>
<pre><code class="hljs matlab">  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>) {<font></font>
    EEPROM.write(pins[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
  }<font></font>
<font></font>
  ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E verificado aqui:</font></font><br>
<br>
<pre><code class="hljs lisp">  for(<span class="hljs-name">byte</span> i=0<span class="hljs-comment">; i&lt;cnt; i=i+1){</span>
    byte dvalue = EEPROM.read(<span class="hljs-name">pins</span>[i])<span class="hljs-comment">;</span>
    if(<span class="hljs-name">dvalue!=11</span>) {<font></font>
    ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J√° nesta fase, interruptores locais nas paredes come√ßaram a funcionar. Mas uma casa inteligente n√£o seria inteligente sem uma interface. Como estou lidando com desenvolvimento web, foi decidido fazer uma interface web. √â aqui que os escudos ethernet foram √∫teis. Infelizmente, n√£o consegui encontrar as fontes das primeiras vers√µes dos programas que usam blindagens ethernet para controle remoto. Vou tentar procurar em backups, talvez eles estejam l√°. Mas o significado era primitivo para a desgra√ßa. Cada controlador possui seu pr√≥prio endere√ßo IP. Um servidor web estava subindo no arduino, que analisava solicita√ß√µes GET e ligava ou desligava a l√¢mpada correspondente, dependendo do n√∫mero da porta. Existem muitos exemplos desse tipo na Internet. Para a interface da web, um servidor foi constru√≠do na placa-m√£e com o Intel Atom embutido, o Ubuntu Server 14.02 foi instalado, o conjunto LAMP padr√£o foi instalado,uma interface simples √© escrita l√°. Todas as fontes tamb√©m estar√£o no final do artigo. No momento, fica assim:</font></font><br>
<br>
<img src="https://habrastorage.org/files/7ba/5b2/d4c/7ba5b2d4c95c48f0ac3873cef3c76b23.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver, uma l√¢mpada da cozinha est√° acesa e o interruptor respons√°vel por ela est√° bloqueado. O gerenciamento √© mega-simples - basta clicar no item desejado e seu estado muda.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E tudo seria √≥timo, se n√£o fosse um "mas". Escudos Ethernet constantemente pendurados. N√£o, o controle local dos switches sempre funcionava como um rel√≥gio. Mas o controle remoto da interface da Web caiu constantemente. Se a ger√™ncia trabalhou por um dia, foi excelente. Por√©m, mais frequentemente, o escudo pendia apenas algumas horas ap√≥s a reinicializa√ß√£o. O que eu simplesmente n√£o fiz foi tentar lidar com o c√£o de guarda, mas minhas pranchas n√£o o apoiaram. Encomendei na China e substitu√≠ os escudos por outros - na en28j60 - ficou melhor, mas ainda assim eles desligavam periodicamente. Adicionei um m√≥dulo de rel√© ao controlador, trouxe a energia para as placas do arduino atrav√©s de contatos normalmente fechados, e uma das placas do arduino puxou o rel√© com uma certa frequ√™ncia e a energia foi cortada e depois restaurada - no entanto, isso nem sempre funcionou e piscou no momento da reinicializa√ß√£o luzes ligadas,mesmo por alguns segundos, mas mesmo assim. Aqui est√° a apar√™ncia do controlador neste momento:</font></font><br>
<br>
<img src="https://habrastorage.org/files/ab0/71d/eb3/ab071deb30a94677a261c5378a809124.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E ent√£o foi decidido abandonar completamente os escudos ethernet. Comecei a procurar outros recursos de gerenciamento remoto. Tentei conectar arduins diretamente ao servidor e enviar comandos via Serial.read () / Serial.print () - funcionava todas as vezes, a estabilidade n√£o era alcan√ßada porque a placa era reiniciada toda vez que era acessada a partir de um script no servidor. Eu li muito sobre esses erros, acabei de perceber que estava conectado com o DTR, em algum lugar eles escreveram que voc√™ pode inicializar a porta com outros sinalizadores, deu exemplos que n√£o funcionaram para mim. Depois de um tempo, deparei-me com um artigo sobre como fazer um adaptador USB-I2C a partir de um programador USBAsp. Eu decidi - por que n√£o? Encomendei alguns desses programadores aos chineses - e esperei.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E uma semana atr√°s, meu pacote chegou. </font><font style="vertical-align: inherit;">Um programador recebeu um flash com o min√∫sculo firmware usb i2c e novamente me sentei para reescrever o c√≥digo. </font><font style="vertical-align: inherit;">Aqui os recursos do protocolo come√ßaram a aparecer. </font><font style="vertical-align: inherit;">Obviamente, o servidor era o mestre e todas as placas do Arduino eram escravas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo deve resolver as seguintes tarefas: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - relatar o status da porta solicitada; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - mudar o status da porta solicitada; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - desligue ou ligue todas as luzes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E eu tive um problema. </font><font style="vertical-align: inherit;">Eu posso usar os comandos padr√£o do conjunto i2c-tools para me comunicar com as placas do arduino. </font><font style="vertical-align: inherit;">Esta √© uma equipe</font></font><br>
<br>
<pre><code class="bash hljs">i2cget -y &lt; &gt; &lt;&gt;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e</font></font><br>
<br>
<pre><code class="bash hljs">i2cset -y &lt; &gt; &lt;&gt; 0x00 &lt;byte &gt;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que, a julgar pelos homens, voc√™ poderia passar a palavra valor, mas n√£o funcionou para mim, ou eu estava enganado em algum lugar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema √© que, primeiro, se eu precisar mudar o estado de uma determinada porta, primeiro devo passar o n√∫mero do comando respons√°vel por esta opera√ß√£o e, em seguida, o n√∫mero da porta. </font><font style="vertical-align: inherit;">Eu at√© tentei fazer isso, envie 2 comandos e no c√≥digo para colet√°-los por sua vez - mas era feio e irracional. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Problema n√∫mero dois - o Arduino n√£o pode responder algo no momento em que recebe os dados. </font><font style="vertical-align: inherit;">Existem dois m√©todos da biblioteca Wire - onReceive () quando dados s√£o recebidos do mestre e onRequest () quando dados s√£o solicitados pelo mestre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o eu fiz isso: o servidor web tem 6 comandos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comando "1" - obt√©m o status de todas as luzes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comando "2" - obt√©m o estado de bloqueio de todos os comutadores</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comando "5" - liga o mundo inteiro</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comando "6" - desligue o mundo inteiro</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
um comando formado da seguinte forma: um n√∫mero decimal da seguinte forma &lt;centenas (1 ou 2) - alternar a l√¢mpada ou a trava de comuta√ß√£o&gt; &lt;n√∫mero da porta (de 0 a 99)&gt;; </font><font style="vertical-align: inherit;">por exemplo, porta 105 de 5 comutadores, bloqueio de porta 213 - 13. </font><font style="vertical-align: inherit;">Este comando √© traduzido em hexadecimal e passado para o arduino, que executa as transforma√ß√µes inversas e entende o que precisa ser feito. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° o que parece no lado do servidor:</font></font><br>
<br>
<pre><code class="php hljs">  ...
  <span class="hljs-keyword">if</span> ($action == <span class="hljs-number">3</span>)<font></font>
     $val_hex = dechex(intval($port) + <span class="hljs-number">100</span>);
  <span class="hljs-keyword">else</span>
     $val_hex = dechex(intval($port) + <span class="hljs-number">200</span>);<font></font>
  <font></font>
  exec(<span class="hljs-string">"sudo i2cset -y 7 $addr 0x00 0x$val_hex"</span>, $output);<font></font>
  ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E do lado do arduino:</font></font><br>
<br>
<pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">receiveEvent</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> howMany</span>)</span> {
  <span class="hljs-keyword">byte</span> bytes = Wire.available();
  <span class="hljs-keyword">int</span> x = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">byte</span> i=<span class="hljs-number">1</span>; i &lt;= bytes; i=i+<span class="hljs-number">1</span>) {<font></font>
    x = Wire.read();<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (x == <span class="hljs-number">1</span> or x == <span class="hljs-number">2</span> or x == <span class="hljs-number">5</span> or x == <span class="hljs-number">6</span>) {<font></font>
    do_action(x, <span class="hljs-number">0</span>);<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> ( x &gt; <span class="hljs-number">200</span>) {<font></font>
      do_action (<span class="hljs-number">4</span>, x - <span class="hljs-number">200</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      do_action (<span class="hljs-number">3</span>, x - <span class="hljs-number">100</span>);<font></font>
    }<font></font>
  }  <font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece bastante primitivo, mas funciona. </font><font style="vertical-align: inherit;">O segundo problema √© resolvido da seguinte maneira. </font><font style="vertical-align: inherit;">Aqui est√° a fun√ß√£o do_action:</font></font><br>
<br>
<pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">do_action</span>(<span class="hljs-params"><span class="hljs-keyword">byte</span> command, <span class="hljs-keyword">byte</span> port</span>)</span> {
  <span class="hljs-keyword">byte</span> <span class="hljs-keyword">value</span> = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">byte</span> dvalue = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">switch</span> (command) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<font></font>
      start_request = <span class="hljs-literal">true</span>;<font></font>
      request_type = <span class="hljs-number">1</span>;<font></font>
      current_port = <span class="hljs-number">0</span>;<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<font></font>
      start_request = <span class="hljs-literal">true</span>;<font></font>
      request_type = <span class="hljs-number">2</span>;<font></font>
      current_port = <span class="hljs-number">0</span>;<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
      <span class="hljs-keyword">value</span> = EEPROM.read(port);
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">value</span>==<span class="hljs-number">11</span>) {<font></font>
        digitalWrite(port, HIGH);<font></font>
        EEPROM.write(port, <span class="hljs-number">10</span>);<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
        digitalWrite(port, LOW);<font></font>
        EEPROM.write(port, <span class="hljs-number">11</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<font></font>
      dvalue = EEPROM.read(port);<font></font>
      <span class="hljs-keyword">if</span>(dvalue==<span class="hljs-number">11</span>) {<font></font>
        EEPROM.write(port, <span class="hljs-number">10</span>);<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
        EEPROM.write(port, <span class="hljs-number">11</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">byte</span> i=<span class="hljs-number">0</span>; i&lt;cnt; i = i + <span class="hljs-number">1</span>) {<font></font>
        digitalWrite(leds[i], LOW);<font></font>
        EEPROM.write(leds[i], <span class="hljs-number">11</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">byte</span> i=<span class="hljs-number">0</span>; i&lt;cnt; i = i + <span class="hljs-number">1</span>) {<font></font>
        digitalWrite(leds[i], HIGH);<font></font>
        EEPROM.write(leds[i], <span class="hljs-number">10</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:<font></font>
      <font></font>
    <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nas equipes de 3 a 6, tudo fica claro, mas as equipes 1 ou 2 podem ser descritas em mais detalhes. </font><font style="vertical-align: inherit;">O servidor envia primeiro o comando desejado e, quando o arduino recebe o comando 1 ou 2, os sinalizadores s√£o inicializados:</font></font><br>
<br>
<pre><code class="hljs nginx">  <span class="hljs-attribute">start_request</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attribute">request_type</span> = <span class="hljs-number">1</span>;
  <span class="hljs-attribute">current_port</span> = <span class="hljs-number">0</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E ent√£o o servidor come√ßa a enviar solicita√ß√µes ao arduino quantas vezes as portas que deseja pesquisar. </font><font style="vertical-align: inherit;">No lado do servidor:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_data</span>(<span class="hljs-params">$address, $action, $cnt</span>) </span>{<font></font>
	exec(<span class="hljs-string">"sudo i2cset -y 7 $address 0x00 0x0$action"</span>, $output);<font></font>
	$tmp = @$output[<span class="hljs-number">0</span>];
	<span class="hljs-keyword">while</span> (strpos($tmp,<span class="hljs-string">"rror"</span>)!==<span class="hljs-literal">false</span>) {<font></font>
		exec(<span class="hljs-string">"sudo i2cset -y 7 $address 0x00 0x0$action"</span>, $output);<font></font>
		$tmp = @$output[<span class="hljs-number">0</span>];<font></font>
	}<font></font>
	$str = <span class="hljs-string">""</span>;
	<span class="hljs-keyword">for</span> ($i = <span class="hljs-number">1</span>; $i &lt;= $cnt; $i++) {<font></font>
		exec(<span class="hljs-string">"sudo i2cget -y 7 $address"</span>, $output);<font></font>
		$tmp = @$output[<span class="hljs-number">0</span>];
		<span class="hljs-keyword">while</span> (strpos($tmp,<span class="hljs-string">"rror"</span>)!==<span class="hljs-literal">false</span>) {<font></font>
			exec(<span class="hljs-string">"sudo i2cget -y 7 $address"</span>, $output);<font></font>
			$tmp = @$output[<span class="hljs-number">0</span>];<font></font>
		}<font></font>
		<span class="hljs-keyword">if</span> ($tmp) {
			<span class="hljs-keyword">if</span> (strpos($tmp,<span class="hljs-string">"1"</span>)!==<span class="hljs-literal">false</span>)<font></font>
				$str .= <span class="hljs-string">"1"</span>;
			<span class="hljs-keyword">else</span>
				$str .= <span class="hljs-string">"0"</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">unset</span>($output);
		<span class="hljs-keyword">unset</span>($tmp);<font></font>
	}<font></font>
			<font></font>
	<span class="hljs-keyword">return</span> $str;<font></font>
}<font></font>
<font></font>
$str = <span class="hljs-keyword">array</span>();<font></font>
$c = <span class="hljs-number">1</span>;
<span class="hljs-keyword">while</span> ($c &lt;= $tryes) {<font></font>
	$tmp = get_data($addr, $action, $cnt);<font></font>
	<font></font>
	<span class="hljs-keyword">if</span> (strlen($tmp) == $cnt)<font></font>
		$str[] = $tmp;<font></font>
	<font></font>
	$c++;<font></font>
}<font></font>
<font></font>
$new_array = array_count_values($str);<font></font>
<font></font>
asort($new_array);<font></font>
<font></font>
$res = <span class="hljs-string">""</span>;<font></font>
$max = <span class="hljs-number">0</span>;
<span class="hljs-keyword">foreach</span> ($new_array <span class="hljs-keyword">AS</span> $key=&gt;$val) {
	<span class="hljs-keyword">if</span> ($val &gt;= $max) {<font></font>
		$res = $key;<font></font>
		$max = $val;<font></font>
	}<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">return</span> preg_split(<span class="hljs-string">'//'</span>, $res, <span class="hljs-number">-1</span>, PREG_SPLIT_NO_EMPTY);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em poucas palavras - fazemos v√°rias tentativas ($ tryes&gt; 3) para interrogar o arduino, obtemos uma linha composta de 0 ou 1. Em qualquer lugar com qualquer comando, procuramos a resposta, se houver a palavra Erro - significa que houve erros durante a transfer√™ncia e voc√™ precisa repetir a transfer√™ncia . </font><font style="vertical-align: inherit;">V√°rias tentativas foram feitas para garantir a corre√ß√£o da string transmitida; a matriz √© recolhida por string usando o m√©todo array_count_values ‚Äã‚Äã($ str); </font><font style="vertical-align: inherit;">e no final obtemos uma matriz com o n√∫mero de ocorr√™ncias das mesmas linhas, fornecemos a linha que recebemos principalmente do arduino. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do lado do arduino, tudo √© mais simples:</font></font><br>
<br>
<pre><code class="hljs pgsql"><span class="hljs-type">void</span> requestEvent() {
  <span class="hljs-keyword">if</span> (request_type == <span class="hljs-number">1</span>) {<font></font>
    byte <span class="hljs-keyword">value</span> = EEPROM.<span class="hljs-keyword">read</span>(leds[current_port]);
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">value</span>==<span class="hljs-number">11</span>) {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">1</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">0</span>);<font></font>
    }<font></font>
    <font></font>
    current_port = current_port + <span class="hljs-number">1</span>;<font></font>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (request_type == <span class="hljs-number">2</span>) {<font></font>
    byte dvalue = EEPROM.<span class="hljs-keyword">read</span>(pins[current_port]);
    <span class="hljs-keyword">if</span>(dvalue==<span class="hljs-number">11</span>) {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">1</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">0</span>);<font></font>
    }<font></font>
<font></font>
    current_port = current_port + <span class="hljs-number">1</span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo da p√°gina da web cont√©m os controles:</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp living_room"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d3"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 3);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp kitchen"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d4"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 4);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp children_main"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d5"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 5);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp children_second"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d6"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 6);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp sleeproom_main"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x423"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x42'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x42',this.id, 3);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp sleeproom_lyuda"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x424"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x42'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x42',this.id, 4);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp sleeproom_anton"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x425"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x42'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x42',this.id, 5);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><font></font>
<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_living_room"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d15"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 15);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_kitchen"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d14"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 14);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_children_main"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d16"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 16);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_children_second"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d17"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 17);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_door1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4212"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 12);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_door2"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4213"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 13);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_lyuda1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4214"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 14);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_lyuda2"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4215"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 15);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_anton1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4216"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 16);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_anton2"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4217"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 17);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, indico explicitamente o endere√ßo da placa que preciso acessar e o n√∫mero da porta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ah, sim, o controlador se parece com isso agora:</font></font><br>
<br>
<img src="https://habrastorage.org/files/05d/20e/6f0/05d20e6f0e8747bc940f202e2606fd2a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois que tudo foi instalado, tudo foi iniciado pela primeira vez. E no dia seguinte, surgiu um efeito incompreens√≠vel - se voc√™ acender todas as luzes do quarto, toda a luz do quarto come√ßa a piscar a cada 2-3 segundos. Passei a noite inteira escolhendo o c√≥digo; n√£o havia um batente na bancada de testes; portanto, o problema n√£o est√° no c√≥digo. Vasculhei v√°rios f√≥runs, em uma toga em um deles encontrei uma descri√ß√£o de um sintoma semelhante, verifiquei meu palpite - e o problema desapareceu. E o fato √© que eu alimentei todos os tr√™s arduins de uma fonte de alimenta√ß√£o de computador, 12V, e o velho freeduino comeu silenciosamente e n√£o tocou, e o arduino uno v3 n√£o p√¥de, e quando todos os rel√©s foram ligados, o regulador de energia foi aquecido para que Era imposs√≠vel tocar. Reduziu a tens√£o de alimenta√ß√£o para 5V 2A - e funcionou como deveria.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem muitos planos, precisamos terminar o reparo no apartamento, o corredor e o banheiro com o vaso sanit√°rio est√£o alinhados, nos meus sonhos eu quero controlar o aquecedor de √°gua e cada tomada, j√° que agora posso pendurar qualquer quantidade de arduin no √¥nibus I2C e cada um far√° sua pr√≥pria coisa. </font><font style="vertical-align: inherit;">Tamb√©m est√° planejado adicionar rel√©s de pulso ao trilho din, para que os m√≥dulos de rel√© controlem apenas esses rel√©s de pulso, e j√° toda a carga passa pelo √∫ltimo. </font><font style="vertical-align: inherit;">Porque existem s√©rias d√∫vidas sobre a confiabilidade dos m√≥dulos de rel√©s chineses. </font><font style="vertical-align: inherit;">Mas isso √© tudo no futuro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conforme prometido, links para o github: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interface da web </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esbo√ßada para arduino</font></font></a></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt386457/">https://habr.com/ru/post/pt386457/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt386443/index.html">A tecnologia moderna elimina o ronco: o sistema Nora n√£o invasivo</a></li>
<li><a href="../pt386447/index.html">O servi√ßo Location Magic rastrear√° a posi√ß√£o do seu dispositivo sem GPS</a></li>
<li><a href="../pt386449/index.html">US $ 29 para obter instru√ß√µes sobre a constru√ß√£o de uma mesa de transformadores</a></li>
<li><a href="../pt386451/index.html">Intera√ß√£o ideal com rel√≥gios inteligentes: cinta SHIFT</a></li>
<li><a href="../pt386455/index.html">Um crit√©rio computacional para determinar o planeta √© proposto.</a></li>
<li><a href="../pt386459/index.html">Um velho amigo √© melhor que dois novos. Gerador de paisagem. Parte 1</a></li>
<li><a href="../pt386461/index.html">O sat√©lite Mars Phobos est√° gradualmente entrando em colapso sob a influ√™ncia de for√ßas das mar√©s</a></li>
<li><a href="../pt386463/index.html">Sa√≠da das sombras: como surgem novas trocas</a></li>
<li><a href="../pt386465/index.html">Digitaliza√ß√£o e impress√£o 3D em paleontologia. Continua√ß√£o</a></li>
<li><a href="../pt386467/index.html">Blizzard processa desenvolvedores de bot por viola√ß√£o de direitos autorais</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>