<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîã üèä üåî Escalado autom√°tico de bricolaje con AWX, Ansible, haproxy y CROC Cloud üíû üë©üèΩ‚Äçü§ù‚Äçüë®üèæ ‚úä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace alg√∫n tiempo, realizamos un monitoreo sin agente y alarmas para ello. Este es un an√°logo de CloudWatch en AWS con una API compatible. Ahora estam...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escalado autom√°tico de bricolaje con AWX, Ansible, haproxy y CROC Cloud</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/croccloudteam/blog/456826/"><p><img src="https://habrastorage.org/webt/6f/nt/tj/6fnttjgdk8vat9bbsahsnck_rfa.jpeg" alt="imagen"></p><br><p>  Hace alg√∫n tiempo, realizamos un monitoreo sin agente y alarmas para ello.  Este es un an√°logo de CloudWatch en AWS con una API compatible.  Ahora estamos trabajando en equilibradores y escalado autom√°tico.  Pero aunque no proporcionamos dicho servicio, ofrecemos a nuestros clientes que lo hagan ellos mismos, utilizando nuestro monitoreo y etiquetas (API de etiquetado de recursos de AWS) como un descubrimiento de servicio simple como fuente de datos.  Mostraremos c√≥mo hacer esto en esta publicaci√≥n. </p><a name="habracut"></a><br><p>  Un ejemplo de una infraestructura m√≠nima de un servicio web simple: DNS -&gt; 2 balanceadores -&gt; 2 backend.  Esta infraestructura puede considerarse el m√≠nimo necesario para la operaci√≥n y mantenimiento tolerante a fallas.  Por esta raz√≥n, no "comprimiremos" esta infraestructura a√∫n m√°s, dejando, por ejemplo, solo un back-end.  Pero me gustar√≠a aumentar el n√∫mero de servidores de fondo y reducirlo a dos.  Esta ser√° nuestra tarea.  Todos los ejemplos est√°n disponibles en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">repositorio</a> . </p><br><h3 id="bazovaya-infrastruktura">  Infraestructura b√°sica </h3><br><p>  No nos detendremos en detalle en la configuraci√≥n de la infraestructura anterior, solo mostraremos c√≥mo crearla.  Preferimos implementar infraestructura usando Terraform.  Ayuda a crear r√°pidamente todo lo que necesita (VPC, subred, grupo de seguridad, m√°quinas virtuales) y repetir este procedimiento una y otra vez. </p><br><p>  Gui√≥n para elevar la infraestructura b√°sica: </p><br><div class="spoiler">  <b class="spoiler_title">main.tf</b> <div class="spoiler_text"><pre><code class="bash hljs">variable <span class="hljs-string"><span class="hljs-string">"ec2_url"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"access_key"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"secret_key"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"region"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"vpc_cidr_block"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"instance_type"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"big_instance_type"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"az"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"ami"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"client_ip"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"material"</span></span> {} provider <span class="hljs-string"><span class="hljs-string">"aws"</span></span> { endpoints { ec2 = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.ec2_url}</span></span></span><span class="hljs-string">"</span></span> } skip_credentials_validation = <span class="hljs-literal"><span class="hljs-literal">true</span></span> skip_requesting_account_id = <span class="hljs-literal"><span class="hljs-literal">true</span></span> skip_region_validation = <span class="hljs-literal"><span class="hljs-literal">true</span></span> access_key = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.access_key}</span></span></span><span class="hljs-string">"</span></span> secret_key = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.secret_key}</span></span></span><span class="hljs-string">"</span></span> region = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.region}</span></span></span><span class="hljs-string">"</span></span> } resource <span class="hljs-string"><span class="hljs-string">"aws_vpc"</span></span> <span class="hljs-string"><span class="hljs-string">"vpc"</span></span> { cidr_block = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.vpc_cidr_block}</span></span></span><span class="hljs-string">"</span></span> } resource <span class="hljs-string"><span class="hljs-string">"aws_subnet"</span></span> <span class="hljs-string"><span class="hljs-string">"subnet"</span></span> { availability_zone = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.az}</span></span></span><span class="hljs-string">"</span></span> vpc_id = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_vpc.vpc.id}</span></span></span><span class="hljs-string">"</span></span> cidr_block = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${cidrsubnet(aws_vpc.vpc.cidr_block, 8, 0)}</span></span></span><span class="hljs-string">"</span></span> } resource <span class="hljs-string"><span class="hljs-string">"aws_security_group"</span></span> <span class="hljs-string"><span class="hljs-string">"sg"</span></span> { name = <span class="hljs-string"><span class="hljs-string">"auto-scaling"</span></span> vpc_id = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_vpc.vpc.id}</span></span></span><span class="hljs-string">"</span></span> ingress { from_port = 22 to_port = 22 protocol = <span class="hljs-string"><span class="hljs-string">"tcp"</span></span> cidr_blocks = [<span class="hljs-string"><span class="hljs-string">"0.0.0.0/0"</span></span>] } ingress { from_port = 80 to_port = 80 protocol = <span class="hljs-string"><span class="hljs-string">"tcp"</span></span> cidr_blocks = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${cidrsubnet(aws_vpc.vpc.cidr_block, 8, 0)}</span></span></span><span class="hljs-string">"</span></span>] } ingress { from_port = 8080 to_port = 8080 protocol = <span class="hljs-string"><span class="hljs-string">"tcp"</span></span> cidr_blocks = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${cidrsubnet(aws_vpc.vpc.cidr_block, 8, 0)}</span></span></span><span class="hljs-string">"</span></span>] } egress { from_port = 0 to_port = 0 protocol = <span class="hljs-string"><span class="hljs-string">"-1"</span></span> cidr_blocks = [<span class="hljs-string"><span class="hljs-string">"0.0.0.0/0"</span></span>] } } resource <span class="hljs-string"><span class="hljs-string">"aws_key_pair"</span></span> <span class="hljs-string"><span class="hljs-string">"key"</span></span> { key_name = <span class="hljs-string"><span class="hljs-string">"auto-scaling-new"</span></span> public_key = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.material}</span></span></span><span class="hljs-string">"</span></span> } resource <span class="hljs-string"><span class="hljs-string">"aws_instance"</span></span> <span class="hljs-string"><span class="hljs-string">"compute"</span></span> { count = 5 ami = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.ami}</span></span></span><span class="hljs-string">"</span></span> instance_type = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${count.index == 0 ? var.big_instance_type : var.instance_type}</span></span></span><span class="hljs-string">"</span></span> key_name = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_key_pair.key.key_name}</span></span></span><span class="hljs-string">"</span></span> subnet_id = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_subnet.subnet.id}</span></span></span><span class="hljs-string">"</span></span> availability_zone = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.az}</span></span></span><span class="hljs-string">"</span></span> security_groups = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_security_group.sg.id}</span></span></span><span class="hljs-string">"</span></span>] } resource <span class="hljs-string"><span class="hljs-string">"aws_eip"</span></span> <span class="hljs-string"><span class="hljs-string">"pub_ip"</span></span> { instance = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_instance.compute.0.id}</span></span></span><span class="hljs-string">"</span></span> vpc = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } output <span class="hljs-string"><span class="hljs-string">"awx"</span></span> { value = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_eip.pub_ip.public_ip}</span></span></span><span class="hljs-string">"</span></span> } output <span class="hljs-string"><span class="hljs-string">"haproxy_id"</span></span> { value = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${slice(aws_instance.compute.*.id, 1, 3)}</span></span></span><span class="hljs-string">"</span></span>] } output <span class="hljs-string"><span class="hljs-string">"awx_id"</span></span> { value = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_instance.compute.0.id}</span></span></span><span class="hljs-string">"</span></span> } output <span class="hljs-string"><span class="hljs-string">"backend_id"</span></span> { value = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${slice(aws_instance.compute.*.id, 3, 5)}</span></span></span><span class="hljs-string">"</span></span>] }</code> </pre> </div></div><br><p>  Parece que todas las entidades descritas en esta configuraci√≥n deber√≠an ser entendidas por el usuario promedio de las nubes modernas.  Las variables espec√≠ficas de nuestra nube y para una tarea espec√≠fica se mueven a un archivo separado: terraform.tfvars: </p><br><div class="spoiler">  <b class="spoiler_title">terraform.tfvars</b> <div class="spoiler_text"><pre> <code class="bash hljs">ec2_url = <span class="hljs-string"><span class="hljs-string">"https://api.cloud.croc.ru"</span></span> access_key = <span class="hljs-string"><span class="hljs-string">"project:user@customer"</span></span> secret_key = <span class="hljs-string"><span class="hljs-string">"secret-key"</span></span> region = <span class="hljs-string"><span class="hljs-string">"croc"</span></span> az = <span class="hljs-string"><span class="hljs-string">"ru-msk-vol51"</span></span> instance_type = <span class="hljs-string"><span class="hljs-string">"m1.2small"</span></span> big_instance_type = <span class="hljs-string"><span class="hljs-string">"m1.large"</span></span> vpc_cidr_block = <span class="hljs-string"><span class="hljs-string">"10.10.0.0/16"</span></span> ami = <span class="hljs-string"><span class="hljs-string">"cmi-3F5B011E"</span></span></code> </pre> </div></div><br><p>  Lanzar Terraform: </p><br><div class="spoiler">  <b class="spoiler_title">aplicar terraform</b> <div class="spoiler_text"><pre> <code class="bash hljs">yes yes | terraform apply -var client_ip=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(curl -s ipinfo.io/ip)</span></span></span><span class="hljs-string">/32"</span></span> -var material=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(cat &lt;ssh_publick_key_path&gt;)</span></span></span><span class="hljs-string">"</span></span></code> </pre> </div></div><br><h3 id="nastroyka-monitoringa">  Configuraci√≥n de monitoreo </h3><br><p>  Las m√°quinas virtuales lanzadas anteriormente son monitoreadas autom√°ticamente por nuestra nube.  Estos datos de monitoreo ser√°n la fuente de informaci√≥n para futuras escalas autom√°ticas.  Confiando en ciertas m√©tricas podemos aumentar o disminuir la potencia. </p><br><p>  El monitoreo en nuestra nube le permite configurar alarmas de acuerdo con diferentes condiciones para diferentes m√©tricas.  Es muy conveniente.  No necesitamos analizar las m√©tricas en ning√∫n intervalo y tomar una decisi√≥n; esto se har√° mediante monitoreo en la nube.  En este ejemplo, utilizaremos alarmas para las m√©tricas de la CPU, pero en nuestro monitoreo tambi√©n se pueden configurar para m√©tricas tales como: utilizaci√≥n de la red (velocidad / pps), utilizaci√≥n del disco (velocidad / iops). </p><br><div class="spoiler">  <b class="spoiler_title">alarma de vigilancia de nubes</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> CLOUDWATCH_URL=https://monitoring.cloud.croc.ru <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> instance_id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;backend_instance_ids&gt;; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$CLOUDWATCH_URL</span></span> \ cloudwatch put-metric-alarm \ --alarm-name <span class="hljs-string"><span class="hljs-string">"scaling-low_</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$instance_id</span></span></span><span class="hljs-string">"</span></span> \ --dimensions Name=InstanceId,Value=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$instance_id</span></span></span><span class="hljs-string">"</span></span> \ --namespace <span class="hljs-string"><span class="hljs-string">"AWS/EC2"</span></span> --metric-name CPUUtilization --statistic Average \ --period 60 --evaluation-periods 3 --threshold 15 --comparison-operator LessThanOrEqualToThreshold; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> instance_id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;backend_instance_ids&gt;; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$CLOUDWATCH_URL</span></span> \ cloudwatch put-metric-alarm\ --alarm-name <span class="hljs-string"><span class="hljs-string">"scaling-high_</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$instance_id</span></span></span><span class="hljs-string">"</span></span> \ --dimensions Name=InstanceId,Value=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$instance_id</span></span></span><span class="hljs-string">"</span></span> \ --namespace <span class="hljs-string"><span class="hljs-string">"AWS/EC2"</span></span> --metric-name CPUUtilization --statistic Average\ --period 60 --evaluation-periods 3 --threshold 80 --comparison-operator GreaterThanOrEqualToThreshold; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p>  Descripci√≥n de algunos par√°metros que pueden ser incomprensibles: </p><br><p>  --profile - perfil de configuraci√≥n aws-cli, descrito en ~ / .aws / config.  Por lo general, se establecen diferentes claves de acceso en diferentes perfiles. </p><br><p>  --dimensiones: el par√°metro determina para qu√© recurso se crear√° la alarma, en el ejemplo anterior, para la instancia con el identificador de la variable $ instance_id. </p><br><p>  --namespace - espacio de nombres desde el cual se seleccionar√° la m√©trica de monitoreo. </p><br><p>  --metric-name: el nombre de la m√©trica de supervisi√≥n. </p><br><p>  --statistic: el nombre del m√©todo de agregaci√≥n de valores de m√©trica. </p><br><p>  --period: intervalo de tiempo entre la supervisi√≥n de eventos de recopilaci√≥n de valores </p><br><p>  - per√≠odos de evaluaci√≥n: el n√∫mero de intervalos necesarios para activar una alarma. </p><br><p>  - umbral - valor umbral m√©trico para evaluar el estado de la alarma. </p><br><p>  - operador de comparaci√≥n - un m√©todo que se utiliza para evaluar el valor de una m√©trica en relaci√≥n con un valor umbral. </p></div></div><br><p>  En el ejemplo anterior, se crean dos alarmas para cada instancia de back-end.  Scaling-low- &lt;instance-id&gt; entrar√° en estado de alarma cuando la CPU cargue menos del 15% durante 3 minutos.  Scaling-high- &lt;instance-id&gt; entrar√° en estado de alarma cuando la CPU cargue m√°s del 80% durante 3 minutos. </p><br><h3 id="nastroyka-tegov">  Personalizaci√≥n de etiqueta </h3><br><p>  Despu√©s de configurar la supervisi√≥n, nos enfrentamos a la siguiente tarea: el descubrimiento de instancias y sus nombres (descubrimiento de servicio).  Necesitamos entender de alguna manera cu√°ntas instancias de back-end hemos lanzado ahora, y tambi√©n necesitamos saber sus nombres.  En un mundo fuera de la nube, por ejemplo, la plantilla de c√≥nsul y c√≥nsul ser√≠a una buena opci√≥n para generar una configuraci√≥n de equilibrador.  Pero hay etiquetas en nuestra nube.  Las etiquetas nos ayudar√°n a clasificar los recursos.  Al solicitar informaci√≥n para una etiqueta espec√≠fica (describe-tags), podemos entender cu√°ntas instancias tenemos actualmente en el grupo y qu√© identificaci√≥n tienen.  De manera predeterminada, se usa una identificaci√≥n de instancia √∫nica como nombre de host.  Gracias al DNS interno que funciona dentro de la VPC, estos ID / nombres de host se resuelven en las instancias de IP internas. </p><br><p>  Establecemos etiquetas para instancias de backend y balanceadores: </p><br><div class="spoiler">  <b class="spoiler_title">etiquetas de creaci√≥n ec2</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> EC2_URL=<span class="hljs-string"><span class="hljs-string">"https://api.cloud.croc.ru"</span></span> aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$EC2_URL</span></span> \ ec2 create-tags --resources <span class="hljs-string"><span class="hljs-string">"&lt;awx_instance_id&gt;"</span></span> \ --tags Key=env,Value=auto-scaling Key=role,Value=awx <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;backend_instance_ids&gt;; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$EC2_URL</span></span> \ ec2 create-tags --resources <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">"</span></span> \ --tags Key=env,Value=auto-scaling Key=role,Value=backend ; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;haproxy_instance_ids&gt;; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$EC2_URL</span></span> \ ec2 create-tags --resources <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">"</span></span> \ --tags Key=env,Value=auto-scaling Key=role,Value=haproxy; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>;</code> </pre> <br><p>  Donde: </p><br><p>  --resources - una lista de identificadores de recursos para los que se establecer√°n etiquetas. </p><br><p>  --tags es una lista de pares clave-valor. </p></div></div><br><p>  Un ejemplo de etiquetas de descripci√≥n est√° disponible en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n de</a> CROC Cloud. </p><br><h3 id="nastroyka-avtoskeylinga">  Configuraci√≥n de autoescalado </h3><br><p>  Ahora que la nube est√° monitoreando, y sabemos c√≥mo trabajar con etiquetas, solo podemos sondear el estado de las alarmas configuradas para su activaci√≥n.  Aqu√≠ necesitamos una entidad que se dedique a tareas de monitoreo y monitoreo de monitoreo peri√≥dico para crear / eliminar instancias.  Aqu√≠ se pueden aplicar varias herramientas de automatizaci√≥n.  Usaremos AWX.  AWX es una versi√≥n de c√≥digo abierto de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">torre</a> comercial <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ansible</a> , un producto para administrar centralmente la infraestructura de Ansible.  La tarea principal es lanzar peri√≥dicamente nuestro libro de jugadas ansible. </p><br><p>  Un ejemplo de una implementaci√≥n de AWX est√° disponible en la p√°gina <a href="">wiki</a> en el repositorio oficial.  La configuraci√≥n de AWX tambi√©n se describe en la documentaci√≥n de Ansible Tower.  Para que AWX comience a ejecutar libros de jugadas personalizados, debe configurarlo creando las siguientes entidades: </p><br><ul><li>  redentials de tres tipos: <br>  <em>- Credenciales de AWS: para autorizar operaciones relacionadas con CROC Cloud.</em> <em><br></em>  - Credenciales de la m√°quina: claves ssh para acceder a instancias reci√©n creadas. <br>  - Credenciales SCM: para autorizaci√≥n en el sistema de control de versiones. </li><li>  Project es una entidad que empujar√° el repositorio git del libro de jugadas. </li><li>  Scripts: script de inventario din√°mico para ansible. </li><li>  Inventory es una entidad que invocar√° el script de inventario din√°mico antes de lanzar el libro de jugadas. </li><li>  Plantilla: la configuraci√≥n de una llamada espec√≠fica de libro de jugadas, consiste en un conjunto de Credenciales, Inventario y libro de jugadas de Project. </li><li>  Flujo de trabajo: una secuencia de llamadas a libros de jugadas. </li></ul><br><p>  El proceso de autoescalado se puede dividir en dos partes: </p><br><ul><li>  scale_up: crea una instancia cuando se activa al menos una alarma alta; </li><li>  scale_down - terminaci√≥n de una instancia si una alarma baja ha funcionado para ella. </li></ul><br><p>  Como parte de la parte scale_up, necesitar√°: </p><br><ul><li>  Interrogar al servicio de monitoreo en la nube sobre la presencia de alarmas altas en el estado "Alarma"; </li><li>  Detenga scale_up antes de lo programado si todas las alarmas altas est√°n en el estado "OK"; </li><li>  crear una nueva instancia con los atributos necesarios (etiqueta, subred, grupo_seguridad, etc.); </li><li>  crear alarmas altas y bajas para una instancia en ejecuci√≥n; </li><li>  configurar nuestra aplicaci√≥n dentro de una nueva instancia (en nuestro caso ser√° solo nginx con una p√°gina de prueba); </li><li>  actualice la configuraci√≥n de haproxy, realice una recarga para que las solicitudes comiencen a ir a la nueva instancia. </li></ul><br><div class="spoiler">  <b class="spoiler_title">create-instance.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">--- - name: get alarm statuses describe_alarms: region: "croc" alarm_name_prefix: "scaling-high" alarm_state: "alarm" register: describe_alarms_query - name: stop if no alarms fired fail: msg: zero high alarms in alarm state when: describe_alarms_query.meta | length == 0 - name: create instance ec2: region: "croc" wait: yes state: present count: 1 key_name: "{{ hostvars[groups['tag_role_backend'][0]].ec2_key_name }}" instance_type: "{{ hostvars[groups['tag_role_backend'][0]].ec2_instance_type }}" image: "{{ hostvars[groups['tag_role_backend'][0]].ec2_image_id }}" group_id: "{{ hostvars[groups['tag_role_backend'][0]].ec2_security_group_ids }}" vpc_subnet_id: "{{ hostvars[groups['tag_role_backend'][0]].ec2_subnet_id }}" user_data: | #!/bin/sh sudo yum install epel-release -y sudo yum install nginx -y cat &lt;&lt;EOF &gt; /etc/nginx/conf.d/dummy.conf server { listen 8080; location / { return 200 '{"message": "$HOSTNAME is up"}'; } } EOF sudo systemctl restart nginx loop: "{{ hostvars[groups['tag_role_backend'][0]] }}" register: new - name: create tag entry ec2_tag: ec2_url: "https://api.cloud.croc.ru" region: croc state: present resource: "{{ item.id }}" tags: role: backend loop: "{{ new.instances }}" - name: create low alarms ec2_metric_alarm: state: present region: croc name: "scaling-low_{ item.id }}" metric: "CPUUtilization" namespace: "AWS/EC2" statistic: Average comparison: "&lt;=" threshold: 15 period: 300 evaluation_periods: 3 unit: "Percent" dimensions: {'InstanceId':"{{ item.id }}"} loop: "{{ new.instances }}" - name: create high alarms ec2_metric_alarm: state: present region: croc name: "scaling-high_{{ item.id }}" metric: "CPUUtilization" namespace: "AWS/EC2" statistic: Average comparison: "&gt;=" threshold: 80.0 period: 300 evaluation_periods: 3 unit: "Percent" dimensions: {'InstanceId':"{{ item.id }}"} loop: "{{ new.instances }}"</code> </pre> </div></div><br><p>  En create-instance.yaml, lo que sucede es: crear una instancia con los par√°metros correctos, etiquetar esta instancia y crear las alarmas necesarias.  El script de instalaci√≥n y configuraci√≥n de nginx tambi√©n se pasa a trav√©s de los datos del usuario.  Los datos de usuario son procesados ‚Äã‚Äãpor el servicio de inicio en la nube, que permite una configuraci√≥n flexible de la instancia durante el inicio sin recurrir a otras herramientas de automatizaci√≥n. </p><br><p>  En update-lb.yaml, el archivo /etc/haproxy/haproxy.cfg se recrea en la instancia de haproxy y el servicio de recarga haproxy: </p><br><div class="spoiler">  <b class="spoiler_title">update-lb.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">- name: update haproxy configs template: src: haproxy.cfg.j2 dest: /etc/haproxy/haproxy.cfg - name: add new backend host to haproxy systemd: name: haproxy state: restarted</code> </pre> </div></div><br><p>  Donde haproxy.cfg.j2 es la plantilla del archivo de configuraci√≥n del servicio haproxy: </p><br><div class="spoiler">  <b class="spoiler_title">haproxy.cfg.j2</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># {{ ansible_managed }} global log /dev/log local0 log /dev/log local1 notice chroot /var/lib/haproxy stats timeout 30s user haproxy group haproxy daemon defaults log global mode http option httplog option dontlognull timeout connect 5000 timeout client 50000 timeout server 50000 frontend loadbalancing bind *:80 mode http default_backend backendnodes backend backendnodes balance roundrobin option httpchk HEAD / {% for host in groups['tag_role_backend'] %} server {{hostvars[host]['ec2_id']}} {{hostvars[host]['ec2_private_ip_address']}}:8080 check {% endfor %}</code> </pre> </div></div><br><p>  Dado que la opci√≥n httpchk opci√≥n se define en la secci√≥n de back-end de haproxy, el servicio de haproxy sondear√° autom√°ticamente los estados de las instancias de back-end y solo equilibrar√° el tr√°fico entre las comprobaciones de estado anteriores. </p><br><p>  En la parte scale_down necesitas: </p><br><ul><li>  comprobar estado alarma baja; </li><li>  termina prematuramente la reproducci√≥n si no hay alarmas bajas en el estado "Alarma"; </li><li>  terminar todas las instancias para las cuales la alarma baja est√° en la clase Alarma; </li><li>  prohibir la terminaci√≥n del √∫ltimo par de instancias, incluso si sus alarmas est√°n en estado de alarma; </li><li>  eliminar las instancias que eliminamos de la configuraci√≥n del equilibrador de carga. </li></ul><br><div class="spoiler">  <b class="spoiler_title">destroy-instance.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">- name: look for alarm status describe_alarms: region: "croc" alarm_name_prefix: "scaling-low" alarm_state: "alarm" register: describe_alarms_query - name: count alarmed instances set_fact: alarmed_count: "{{ describe_alarms_query.meta | length }}" alarmed_ids: "{{ describe_alarms_query.meta }}" - name: stop if no alarms fail: msg: no alarms fired when: alarmed_count | int == 0 - name: count all described instances set_fact: all_count: "{{ groups['tag_role_backend'] | length }}" - name: fail if last two instance remaining fail: msg: cant destroy last two instances when: all_count | int == 2 - name: destroy tags for marked instances ec2_tag: ec2_url: "https://api.cloud.croc.ru" region: croc resource: "{{ alarmed_ids[0].split('_')[1] }}" state: absent tags: role: backend - name: destroy instances ec2: region: croc state: absent instance_ids: "{{ alarmed_ids[0].split('_')[1] }}" - name: destroy low alarms ec2_metric_alarm: state: absent region: croc name: "scaling-low_{{ alarmed_ids[0].split('_')[1] }}" - name: destroy high alarms ec2_metric_alarm: state: absent region: croc name: "scaling-high_{{ alarmed_ids[0].split('_')[1] }}"</code> </pre> </div></div><br><p>  En destroy-instance.yaml, las alarmas se eliminan, la instancia y su etiqueta se finalizan, y se verifican las condiciones que proh√≠ben la finalizaci√≥n de instancias recientes. </p><br><p>  Eliminamos expl√≠citamente las etiquetas despu√©s de eliminar instancias debido al hecho de que despu√©s de eliminar una instancia, las etiquetas asociadas con ella se eliminan pospuestas y est√°n disponibles por otro minuto. <br>  AWX </p><br><h3 id="nastroyka-zadach-shablonov">  Establecer tareas, plantillas </h3><br><p>  El siguiente conjunto de tareas crear√° las entidades necesarias en AWX: </p><br><div class="spoiler">  <b class="spoiler_title">awx-configure.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">--- - name: Create tower organization tower_organization: name: "scaling-org" description: "scaling-org organization" state: present - name: Add tower cloud credential tower_credential: name: cloud description: croc cloud api creds organization: scaling-org kind: aws state: present username: "{{ croc_user }}" password: "{{ croc_password }}" - name: Add tower github credential tower_credential: name: ghe organization: scaling-org kind: scm state: present username: "{{ ghe_user }}" password: "{{ ghe_password }}" - name: Add tower ssh credential tower_credential: name: ssh description: ssh creds organization: scaling-org kind: ssh state: present username: "ec2-user" ssh_key_data: "{{ lookup('file', 'private.key') }}" - name: Add tower project tower_project: name: "auto-scaling" scm_type: git scm_credential: ghe scm_url: &lt;repo-name&gt; organization: "scaling-org" scm_branch: master state: present - name: create inventory tower_inventory: name: dynamic-inventory organization: "scaling-org" state: present - name: copy inventory script to awx copy: src: "{{ role_path }}/files/ec2.py" dest: /root/ec2.py - name: create inventory source shell: | export SCRIPT=$(tower-cli inventory_script create -n "ec2-script" --organization "scaling-org" --script @/root/ec2.py | grep ec2 | awk '{print $1}') tower-cli inventory_source create --update-on-launch True --credential cloud --source custom --inventory dynamic-inventory -n "ec2-source" --source-script $SCRIPT --source-vars '{"EC2_URL":"api.cloud.croc.ru","AWS_REGION": "croc"}' --overwrite True - name: Create create-instance template tower_job_template: name: "create-instance" job_type: "run" inventory: "dynamic-inventory" credential: "cloud" project: "auto-scaling" playbook: "create-instance.yaml" state: "present" register: create_instance - name: Create update-lb template tower_job_template: name: "update-lb" job_type: "run" inventory: "dynamic-inventory" credential: "ssh" project: "auto-scaling" playbook: "update-lb.yaml" credential: "ssh" state: "present" register: update_lb - name: Create destroy-instance template tower_job_template: name: "destroy-instance" job_type: "run" inventory: "dynamic-inventory" project: "auto-scaling" credential: "cloud" playbook: "destroy-instance.yaml" credential: "ssh" state: "present" register: destroy_instance - name: create workflow tower_workflow_template: name: auto_scaling organization: scaling-org schema: "{{ lookup('template', 'schema.j2')}}" - name: set scheduling shell: | tower-cli schedule create -n "3min" --workflow "auto_scaling" --rrule "DTSTART:$(date +%Y%m%dT%H%M%SZ) RRULE:FREQ=MINUTELY;INTERVAL=3"</code> </pre> </div></div><br><p>  El fragmento anterior crear√° una plantilla para cada uno de los libros de jugadas ansibles utilizados.  Cada plantilla configura el lanzamiento de un libro de jugadas con un conjunto de credenciales e inventario definidos. </p><br><p>  Crear una tuber√≠a para llamadas a libros de jugadas permitir√° la plantilla de flujo de trabajo.  La configuraci√≥n del flujo de trabajo para el escalado autom√°tico se presenta a continuaci√≥n: </p><br><div class="spoiler">  <b class="spoiler_title">schema.j2</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">- failure_nodes: - id: 101 job_template: {{ destroy_instance.id }} success_nodes: - id: 102 job_template: {{ update_lb.id }} id: 103 job_template: {{ create_instance.id }} success_nodes: - id: 104 job_template: {{ update_lb.id }}</code> </pre> </div></div><br><p>  La plantilla anterior muestra el diagrama de flujo de trabajo, es decir  secuencia de ejecuci√≥n de plantilla.  En este flujo de trabajo, cada paso siguiente (success_nodes) se realizar√° solo si el anterior se completa con √©xito.  En la imagen se muestra una representaci√≥n gr√°fica del flujo de trabajo: <br><img src="https://habrastorage.org/webt/po/l-/vb/pol-vbfpulv4hoimk99mvbtig-u.png" alt="flujo de trabajo"></p><br><p>  Como resultado, se cre√≥ un flujo de trabajo generalizado que ejecuta el libro de jugadas create-instace y, dependiendo del estado de ejecuci√≥n, destruye los libros de jugadas de instancia y / o actualizaci√≥n-lb.  El flujo de trabajo integrado es conveniente para ejecutarse en un horario determinado.  El proceso de autoescalado comenzar√° cada tres minutos, iniciando y finalizando instancias dependiendo del estado de la alarma. </p><br><h3 id="testirovanie-raboty">  Prueba de trabajo </h3><br><p>  Ahora verifique el funcionamiento del sistema configurado.  Primero, instale la utilidad wrk para la evaluaci√≥n comparativa http. </p><br><div class="spoiler">  <b class="spoiler_title">instalaci√≥n incorrecta</b> <div class="spoiler_text"><pre> <code class="bash hljs">ssh -A ec2-user@&lt;aws_instance_ip&gt; sudo su - <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt yum groupinstall <span class="hljs-string"><span class="hljs-string">'Development Tools'</span></span> yum install -y openssl-devel git git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/wg/wrk.git wrk <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> wrk make install wrk /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> </div></div><br><p>  Utilizaremos el monitoreo en la nube para monitorear el uso de los recursos de la instancia durante la carga: </p><br><div class="spoiler">  <b class="spoiler_title">monitoreo</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">function CPUUtilizationMonitoring() { local AWS_CLI_PROFILE="&lt;aws_cli_profile&gt;" local CLOUDWATCH_URL="https://monitoring.cloud.croc.ru" local API_URL="https://api.cloud.croc.ru" local STATS="" local ALARM_STATUS="" local IDS=$(aws --profile $AWS_CLI_PROFILE --endpoint-url $API_URL ec2 describe-instances --filter Name=tag:role,Values=backend | grep -i instanceid | grep -oE 'i-[a-zA-Z0-9]*' | tr '\n' ' ') for instance_id in $IDS; do STATS="$STATS$(aws --profile $AWS_CLI_PROFILE --endpoint-url $CLOUDWATCH_URL cloudwatch get-metric-statistics --dimensions Name=InstanceId,Value=$instance_id --namespace "AWS/EC2" --metric CPUUtilization --end-time $(date --iso-8601=minutes) --start-time $(date -d "$(date --iso-8601=minutes) - 1 min" --iso-8601=minutes) --period 60 --statistics Average | grep -i average)"; ALARMS_STATUS="$ALARMS_STATUS$(aws --profile $AWS_CLI_PROFILE --endpoint-url $CLOUDWATCH_URL cloudwatch describe-alarms --alarm-names scaling-high-$instance_id | grep -i statevalue)" done echo $STATS | column -s ',' -o '|' -N $(echo $IDS | tr ' ' ',') -t echo $ALARMS_STATUS | column -s ',' -o '|' -N $(echo $IDS | tr ' ' ',') -t } export -f CPUUtilizationMonitoring watch -n 60 bash -c CPUUtilizationMonitoring</code> </pre> </div></div><br><p>  El script anterior una vez cada 60 segundos toma informaci√≥n sobre el valor promedio de la m√©trica de CPUUtilization para el √∫ltimo minuto y sondea el estado de las alarmas para instancias de back-end. </p><br><p>  Ahora puede ejecutar wrk y observar la utilizaci√≥n de los recursos de las instancias de backend bajo carga: </p><br><div class="spoiler">  <b class="spoiler_title">Wrk Run</b> <div class="spoiler_text"><pre> <code class="bash hljs">ssh -A ec2-user@&lt;awx_instance_ip&gt; wrk -t12 -c100 -d500s http://&lt;haproxy_instance_id&gt; <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> </div></div><br><p>  El √∫ltimo comando lanzar√° el punto de referencia durante 500 segundos, utilizando 12 hilos y abriendo 100 conexiones http. </p><br><p>  Con el tiempo, el script de monitoreo debe mostrar que durante el punto de referencia el valor estad√≠stico de la m√©trica de CPUUtilization aumenta hasta alcanzar el 300%.  180 segundos despu√©s del inicio del punto de referencia, el indicador StateValue deber√≠a cambiar al estado de alarma.  Una vez cada dos minutos, comienza el flujo de trabajo de autoescalado.  Por defecto, la ejecuci√≥n paralela del mismo flujo de trabajo est√° prohibida.  Es decir, cada dos minutos, se agregar√° una tarea para ejecutar un flujo de trabajo a la cola y se iniciar√° solo despu√©s de que se complete el anterior.  Por lo tanto, durante el trabajo de wrk, habr√° un aumento constante de recursos hasta que las alarmas altas de todas las instancias de back-end entren en estado OK.  Al finalizar, el flujo de trabajo de wrk scale_down finaliza todas las instancias del backend excepto dos. </p><br><p>  Ejemplo de salida de un script de supervisi√≥n: </p><br><div class="spoiler">  <b class="spoiler_title">seguimiento de resultados</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># start test i-43477460 |i-AC5D9EE0 "Average": 0.0 | "Average": 0.0 i-43477460 |i-AC5D9EE0 "StateValue": "ok"| "StateValue": "ok" # start http load i-43477460 |i-AC5D9EE0 "Average": 267.0 | "Average": 111.0 i-43477460 |i-AC5D9EE0 "StateValue": "ok"| "StateValue": "ok" # alarm state i-43477460 |i-AC5D9EE0 "Average": 267.0 | "Average": 282.0 i-43477460 |i-AC5D9EE0 "StateValue": "alarm"| "StateValue": "alarm" # two new instances created i-1E399860 |i-F307FB00 |i-43477460 |i-AC5D9EE0 "Average": 185.0 | "Average": 215.0 | "Average": 245.0 | i-1E399860 |i-F307FB00 |i-43477460 |i-AC5D9EE0 "StateValue": "insufficient_data"| "StateValue": "insufficient_data"| "StateValue": "alarm"| "StateValue": "alarm" # only two instances left after load has been stopped i-935BAB40 |i-AC5D9EE0 "Average": 0.0 | "Average": 0.0 i-935BAB40 |i-AC5D9EE0 "StateValue": "ok"| "StateValue": "ok"</code> </pre> </div></div><br><p>  Tambi√©n en CROC Cloud, puede ver los gr√°ficos utilizados en la publicaci√≥n de monitoreo en la p√°gina de instancia en la pesta√±a correspondiente. </p><br><p>  Ver alarmas est√° disponible en la p√°gina de monitoreo en la pesta√±a de alarmas. </p><br><h3 id="zaklyuchenie">  Conclusi√≥n </h3><br><p>  El escalado autom√°tico es un escenario bastante popular, pero, desafortunadamente, todav√≠a no est√° en nuestra nube (pero solo por ahora).  Sin embargo, tenemos muchas API potentes para hacer cosas similares y muchas otras, utilizando herramientas populares, casi est√°ndar, como Terraform, ansible, aws-cli y otras. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/456826/">https://habr.com/ru/post/456826/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../456812/index.html">Qu√© hay en la Universidad ITMO: festivales de TI, hackatones, conferencias y seminarios abiertos</a></li>
<li><a href="../456814/index.html">Aprenda programaci√≥n funcional en Python en 10 minutos</a></li>
<li><a href="../456818/index.html">El administrador del sistema en una empresa inaccesible. ¬øLa insoportable carga del ser?</a></li>
<li><a href="../456820/index.html">Arcilla ‚Üí Ladrillo ‚Üí Estufa</a></li>
<li><a href="../456824/index.html">¬øQu√© es la probabilidad y c√≥mo calcularla?</a></li>
<li><a href="../456828/index.html">Vias de sintonizaci√≥n para placas de circuito impreso</a></li>
<li><a href="../456830/index.html">Vivaldi 2.6 - Diversi√≥n de verano</a></li>
<li><a href="../456836/index.html">Selecci√≥n: 5 herramientas obvias de an√°lisis competitivo que quiz√°s no conoces</a></li>
<li><a href="../456838/index.html">Introducci√≥n a la puntuaci√≥n ICE para la priorizaci√≥n de caracter√≠sticas del producto</a></li>
<li><a href="../456840/index.html">SDL 2 Lecciones: Lecci√≥n 6 - Primitivas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>