<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕗 🎅🏼 ⛈️ Alimentation par batterie pour les appareils MySensors 🚵🏻 ⛄️ 💓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cette musique durera pour toujours si je remplace les piles (C) 





 Cet opus est dédié à mes recherches sur la puissance des appareils sans fil aut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Alimentation par batterie pour les appareils MySensors</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465393/"><p>  <em>Cette musique durera pour toujours si je remplace les piles (C)</em> </p><br><p><img src="https://habrastorage.org/webt/ut/-j/xu/ut-jxulgxugkbo3hrs8ax8metkg.jpeg"></p><br><p>  Cet opus est dédié à mes recherches sur la puissance des appareils sans fil autonomes qui font partie du système de maison intelligente MySensors. </p><br><h2 id="sperva-byl-litiy">  Il y avait d'abord le lithium ... </h2><br><p>  Plutôt, des batteries lithium-ion et lithium-polymère. </p><br><p> Pendant longtemps, ces batteries de vieux gadgets se sont accumulées dans une boîte.  Je pensais - le voici, une alimentation universelle pour tous les microcontrôleurs de petite taille.  De plus, la tension de 3,3-4,2 V est excellente pour l'AVR, ainsi que pour toutes sortes d'ESP et de STM.  Pour plus de fiabilité, vous pouvez mettre un stabilisateur LDO de la puissance requise et obtenir un 3,3 stable pour MK et toute la périphérie. </p><a name="habracut"></a><br><p><img src="https://habrastorage.org/webt/sl/by/e1/slbye1sktidu-9qymebtsw7gwzy.jpeg"></p><br><p>  Mais il s'est avéré que tout n'est pas si bon. </p><br><ol><li>  Les batteries devaient être chargées.  Pour ce faire, il était nécessaire de les rendre amovibles ou d'ajouter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un module de charge</a> à votre appareil, ce qui, à son tour, a donné un coût supplémentaire, des dimensions et des trous de charge dans le boîtier.  Et ce n'est pas toujours pratique de charger des appareils, par exemple un capteur météo à l'extérieur de la fenêtre. </li><li>  Les batteries au lithium (comme la plupart des alimentations en général) ne conviennent pas à une utilisation à basse température.  Dans un capteur météo fixé à la fenêtre, en hiver, la batterie a coulé immédiatement sous le gel. </li><li>  Pendant le fonctionnement à long terme, si la tension de la batterie n'est pas surveillée à temps, vous pouvez la décharger "à zéro", c'est-à-dire en dessous de la valeur admissible, qui est garantie de la tuer.  Vous avez donc besoin d'une protection contre les décharges excessives. </li><li>  Une variété de tailles et de capacités de batterie a considérablement limité la répétabilité des appareils dans des boîtiers identiques.  Et les réserves de vieilles piles ont rapidement pris fin - il a donc fallu acheter un nouvel endroit.  Et, comme il s'est avéré, le coût de ces sources d'énergie s'est avéré être un sou et a ajouté au moins 2 $ au coût de chaque appareil (et en tenant compte de la carte de charge et plus encore).  De plus, la recharge n'était pas rentable, car la plupart des contrôleurs autonomes consommaient très peu d'énergie et pouvaient fonctionner pendant plusieurs mois sans recharge. </li></ol><br><p>  NiMH et autres piles AA / AAA étaient encore pires.  Ils devaient être chargés dans un chargeur spécial, ils avaient un «effet mémoire» et une tension initialement basse (1,2-1,3 V), et lorsqu'ils sont connectés en série en raison de la différence de résistance interne, l'une des batteries peut être déchargée plus que d'autres, ce qui conduit à nouveau à son détérioration. </p><br><h2 id="i-vnov-litiy-">  Et encore une fois, le lithium ... </h2><br><p>  Il y a maintenant des piles rondes au lithium 3.0V de petite taille, en faveur desquelles j'ai décidé d'abandonner les piles capricieuses et chères. </p><br><p>  Les piles CR2032 sont utilisées dans un grand nombre d'ordinateurs BIOS, de compteurs électriques et d'autres appareils avec RTC, montres, calculatrices et jouets divers.  Avec de petites dimensions et un prix bas, ils ont une tension de 3.0V, ce qui est tout à fait suffisant pour MK et une capacité décente de 200-250mA / h pour leurs dimensions. </p><br><p><img src="https://habrastorage.org/webt/-x/4l/rx/-x4lrx1wg7c5gxmliml_lufiuyi.jpeg"></p><br><p>  Mais encore une fois, des problèmes.  Le fait de l'affaire.  que le courant continu d'une telle batterie n'est que de 0,4 mA.  Si vous le chargez avec un courant plus élevé, la tension de la batterie chutera, bien qu'elle puisse alors récupérer partiellement ou complètement.  Un mode de veille Mysensor typique consomme plusieurs microampères.  Mais dans le mode de transfert - déjà environ 15-20mA.  Dans le même temps, les nouvelles versions de la bibliothèque MySensors forcent les appareils à envoyer de nombreux paquets - ping, salutation, présentations, recherche d'une passerelle ou d'un routeur, ce qui entraîne une longue, parfois plusieurs secondes, de fonctionnement du module radio.  À une tension d'environ 2 V, les NRF24L01 chinois bon marché commencent à échouer, et parfois il n'est même pas possible de les mettre en mode veille () à partir de MySensors. </p><br><p>  En conséquence, tout fonctionne d'une manière ou d'une autre sur une batterie neuve, mais à mesure que la batterie se décharge, les problèmes de communication augmentent, le module radio commence à inonder davantage l'air, ce qui augmente la décharge de la batterie.  En fin de compte, la tension chute au point que l'ensemble de l'appareil cesse de s'endormir, puis un redémarrage cyclique se produit jusqu'à ce que la batterie s'épuise complètement. </p><br><p>  Selon le fabricant et la «fraîcheur» de la batterie, l'appareil peut fonctionner de quelques jours à un mois.  Si vous achetez des piles bon marché sur aliexpress, il y a une loterie.  La transition vers les CR2450 et CR2477 plus volumineux permet d'économiser un peu, mais ils ne savent pas donner un courant de plus de 0,5 mA depuis longtemps. </p><br><p>  Pendant un certain temps, j'ai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">expérimenté avec des convertisseurs boost</a> qui permettaient à la batterie de maintenir une tension de fonctionnement normale pour le MK jusqu'aux dernières miettes d'énergie, mais ils avaient un courant de repos faible mais non nul, ce qui réduisait la durée de vie globale. </p><br><h2 id="palchiki---mizinchiki">  Petits doigts - petits doigts </h2><br><p><img src="https://habrastorage.org/webt/ym/3r/sp/ym3rsphakzuewavswscm7ot7vvi.jpeg"></p><br><p>  Il est temps de se calmer et d'adopter l'expérience chinoise "avancée", pour alimenter tous vos appareils à partir de trois AAA (les piles ne sont pas incluses).  Mais il a décidé de chercher une solution avec au moins deux piles 1,5 volts. </p><br><p>  Je me suis arrêté à un tel schéma avec un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">stabilisateur NCP1400 croissant</a> : </p><br><p><img src="https://habrastorage.org/webt/zy/bv/ii/zybviid6dds-ng2kwivuenh9gli.jpeg"></p><br><p>  Deux piles alcalines AAA connectées en série fournissent initialement 2,7-3,1 V à la fin de la période de production, réduisant la tension à 1-2 V </p><br><p>  Lorsque le NCP1400 est éteint (niveau bas à l'entrée de commande), la batterie passe immédiatement au MC via la bobine L1 et la diode Schottky d1 avec une chute de tension minimale d'environ 0,1 V.  Si un niveau élevé est appliqué à l'entrée de commande, le stabilisateur NCP1400 démarre et fournit une tension de 3,3 V au MK avec une tension de batterie totale de 0,8 V à 3,1 V. </p><br><h4 id="algoritm-raboty-takoy">  L'algorithme de fonctionnement est le suivant: </h4><br><ol><li>  La principale fois que le contrôleur est en PowerDownMode, tous les périphériques, y compris le NRF24, sont désactivés ou également en mode basse consommation. </li><li>  Le MC quitte le mode veille par interruption de la minuterie ou par une interruption externe (par exemple, dans les commutateurs par interruption du bouton), la tension d'alimentation VCC (fonction intégrée des contrôleurs AVR) est mesurée. </li><li>  Si la tension d'alimentation est supérieure à 3 V (ou à une autre tension suffisante pour un fonctionnement périphérique stable), le NCP1400 ne démarre pas et tout le traitement est effectué à cette tension d'alimentation jusqu'au prochain cycle de veille. </li><li>  Si la tension est inférieure à 3 V, le stabilisateur NCP1400 démarre, la tension d'alimentation est réglée sur 3,3 V, tout le traitement régulier de l'appareil est effectué, y compris l'envoi de données via NRF24 </li><li>  De plus, si la tension est supérieure à 1,7 V (tension suffisante pour sortir le MC du mode veille), le NCP1400 est éteint jusqu'au prochain cycle de réveil. </li><li>  Si la tension est inférieure à 1,7 (la tension minimale du MK), le NCP1400 ne s'éteint pas jusqu'à ce que le contrôleur redémarre ou jusqu'à ce que la tension d'alimentation tombe en dessous de 0,8 V (tension du NCP1400) </li></ol><br><div class="spoiler">  <b class="spoiler_title">Croquis de cet algorithme</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_RF24_CE_PIN 9 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_RF24_CS_PIN 10 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_RF24_POWER_PIN 8 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_RADIO_NRF24 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;MySensors.h&gt; #define PIN_NCP1400 2 #define CHILD_ID_VCC 0 MyMessage msgVcc(CHILD_ID_VCC, V_VOLTAGE); bool low_power = false; int readVcc(); // void before(){ pinMode(PIN_NCP1400,OUTPUT); digitalWrite(PIN_NCP1400,HIGH); } void presentation(){ sendSketchInfo("NCP1400 test", "1.0"); present(CHILD_ID_VCC, S_MULTIMETER,"mV"); } // void loop(){ int vcc = 1000; if( low_power == false ){ vcc = readVcc(); digitalWrite(PIN_NCP1400,HIGH); //  NRF1400 } if( vcc &lt; 1700 )low_power = true; //      NRF1400 send(msgVcc.set(vcc)); //  VCC if( low_power == false )digitalWrite(PIN_NCP1400,LOW); //  NRF1400 sleep( 300000 ); //      5  } /** *     VCC  */ int readVcc() { long result; // Read 1.1V reference against AVcc ADMUX = _BV(REFS0) | _BV(MUX3) | _BV(MUX2) | _BV(MUX1); delay(2); // Wait for Vref to settle ADCSRA |= _BV(ADSC); // Convert while (bit_is_set(ADCSRA,ADSC)); result = ADCL; result |= ADCH&lt;&lt;8; result = (1100L * 1023)/result; return((int)result); }</span></span></span></span></code> </pre> </div></div><br><h2 id="testirovanie">  Test </h2><br><p>  Et comment gérer la consommation actuelle dans la pratique?  Je connecte mon circuit au LBP et prends des mesures de la consommation de courant et de la tension de sortie. </p><br><p><img src="https://habrastorage.org/webt/ti/ss/_z/tiss_zsvv77ac2gpbmcmkigrwge.jpeg"></p><br><p>  Le courant de ralenti avec le NCP1400 éteint et une tension d'entrée de 1 à 3 V était de 0,3 μA.  Même inférieur à la valeur déclarée par la fiche technique de 0,5 mkA (ou peut-être que sur cette gamme, mes appareils donnent une grosse erreur).  Mais avec le stabilisateur allumé sans charge, le courant s'est avéré être étonnamment important - plus de 0,3 mA.  Il s'est avéré que la résistance de rappel R1 provoquait une grande consommation.  Remplaçant la cote R1 de 10K à 150K, j'ai obtenu 30 μA à une tension d'entrée de 3,0 V et 44 μA à 1,0 V. </p><br><p>  Si vous retirez complètement la résistance R1, le stabilisateur en l'absence de connexion de cette entrée au MC sera constamment en train de consommer avec un 2V entrant d'environ 11 μA. <br>  Maintenant, je connecte le microcontrôleur avec NRF24L01 et le capteur HUD21, en travaillant selon l'algorithme décrit ci-dessus: </p><br><ul><li>  Tension d'entrée 3.0V - mode actif (NCP1400 activé) 32mA, mode veille (NCP1400 désactivé) 9mkA </li><li>  Tension d'entrée 2,0 V - mode actif (NCP1400 activé) 51 mA, mode veille (NCP1400 désactivé) 6 mA </li><li>  Tension d'entrée 1,7 V - mode actif (NCP1400 activé) 63 mA, mode veille (NCP1400 désactivé) 5,6 mA </li><li>  Tension d'entrée 1.0V - NCP1400 est constamment allumé - mode veille 197mkA </li><li>  Tension d'entrée 0,5 V - NCP1400 est constamment allumé - Mode veille 397 μA </li></ul><br><p>  La consommation active de la batterie augmente lorsque la puissance est réduite.  La tension de 1,7 V a été choisie expérimentalement.  En dessous de cette valeur, le microcontrôleur peut déjà ne pas fonctionner de manière stable.  Lorsque la tension de la batterie tombe en dessous de ce seuil, le stabilisateur NCP1400 ne s'éteint plus et la consommation en mode veille est assez élevée.  Dans ce mode, les piles ne dureront pas longtemps, mais il y aura suffisamment de temps pour les remplacer. </p><br><h2 id="voploschenie-v-zheleze">  Incarnation dans la glande </h2><br><p>  Conçu des cartes d'alimentation universelles pour mes appareils domestiques intelligents </p><br><p><img src="https://habrastorage.org/webt/q5/gv/io/q5gviogxu9mb_biahhyvvdv0bpo.jpeg"></p><br><p><img src="https://habrastorage.org/webt/eg/da/sc/egdasc6nwhiv_frbsr_glatlqsy.jpeg"></p><br><p>  Et bien que les appareils finis ne soient pas aussi compacts qu'avec des piles au lithium, le résultat était assez bien pour moi.  compte tenu notamment du coût des piles alcalines dans les magasins de Galomart, Kastorama, Leroyle, etc. </p><br><p><img src="https://habrastorage.org/webt/zp/vw/sm/zpvwsmw1ocdc7plhi0pupkqhmww.jpeg"></p><br><p>  Actuellement, j'utilise à la maison plus d'une douzaine d'appareils différents pour surveiller la température, l'humidité du sol, etc. dans le système MuSensors / MajorDoMo. </p><br><p>  En savoir plus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur mon blog</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr465393/">https://habr.com/ru/post/fr465393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr465373/index.html">Pas un examen du ASUS ZenBook Pro 15 UX580GE - presque un an avec presque le top</a></li>
<li><a href="../fr465375/index.html">Vente de serveurs dédiés aux Pays-Bas et à Moscou</a></li>
<li><a href="../fr465377/index.html">Faites-le vous-même Skype</a></li>
<li><a href="../fr465379/index.html">Commande autonome sans fil autonome de pompe à insuline</a></li>
<li><a href="../fr465391/index.html">Sur les traces du mouvement russe Scala. Partie 1</a></li>
<li><a href="../fr465395/index.html">Quelle est la principale différence entre l'injection de dépendance et le localisateur de service?</a></li>
<li><a href="../fr465397/index.html">Comment le traducteur Nitro est-il apparu, qui aide les développeurs dans la localisation et le support technique</a></li>
<li><a href="../fr465399/index.html">Déployez le stockage distribué CEPH et connectez-le à Kubernetes</a></li>
<li><a href="../fr465401/index.html">5 activités pour accélérer la résolution de problèmes dans n'importe quelle équipe informatique</a></li>
<li><a href="../fr465403/index.html">Achtung! Nouvelles caméras sur la route ou informations à jour sur les radars et détecteurs de radar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>