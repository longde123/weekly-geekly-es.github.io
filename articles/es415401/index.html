<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>游눗 游눚 游뱍 Resolvemos el problema de un mill칩n de pesta침as abiertas o "ayudamos al hardware a sobrevivir" 游꼝 游놀游 游돖游</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Intentaremos descubrir c칩mo reducir la carga en el hardware del servidor, mientras aseguramos el m치ximo rendimiento de la aplicaci칩n web. 


 En el de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Resolvemos el problema de un mill칩n de pesta침as abiertas o "ayudamos al hardware a sobrevivir"</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415401/"><p><img src="https://habrastorage.org/webt/pn/_3/7n/pn_37n_daf8ssnbb8s3qbcrnjv0.jpeg"></p><br><p>  Intentaremos descubrir c칩mo reducir la carga en el hardware del servidor, mientras aseguramos el m치ximo rendimiento de la aplicaci칩n web. </p><br><p>  En el desarrollo de proyectos grandes y de alta carga con gran en l칤nea, a menudo tiene que pensar en c칩mo reducir la carga en el servidor, especialmente cuando trabaja en webSockets y cambia din치micamente las interfaces.  <em>100500</em> usuarios vienen a nosotros y tenemos <em>100500</em> conexiones de socket abierto.  Y si cada uno de ellos abre 2 pesta침as, esto es * 201,000 conexiones.  <strong>쯏 si son cinco?</strong> </p><a name="habracut"></a><br><p>  Considere un ejemplo trivial.  Tenemos, por ejemplo, <del>  Twitch.tv </del> , que para cada usuario genera una conexi칩n WS.  Tal proyecto es enorme en l칤nea, por lo que cada detalle es importante.  No podemos permitirnos abrir una nueva conexi칩n WS en cada pesta침a, admitiendo la anterior, porque la gl치ndula no debe estar medida para esto. </p><br><p>  La idea nace: 쯤u칠 pasa si las conexiones WS se levantan en una sola pesta침a y siempre se mantienen abiertas, y en las nuevas no se inicializa la conexi칩n, sino que se escucha desde la pesta침a vecina?  Se trata de la implementaci칩n de esta idea que quiero contar. </p><br><h4 id="logicheskoe-povedenie-vkladok-v-brauzere">  Comportamiento l칩gico del navegador </h4><br><ol><li>  Abra la primera pesta침a, m치rquela como Primaria </li><li>  Ejecute la prueba: si la pesta침a es_primaria, levante la conexi칩n WS </li><li>  Estamos trabajando ... </li><li>  Abra la segunda pesta침a (duplique la ventana, ingrese la direcci칩n manualmente, 치brala en una nueva pesta침a, no importa) </li><li>  Desde la nueva pesta침a, vea si hay en alg칰n lugar una pesta침a Principal.  En caso afirmativo, marque el Secundario actual y espere lo que suceder치. </li><li>  Abre 10 pesta침as m치s.  Y todos est치n esperando. </li><li>  En alg칰n momento, la pesta침a Principal se cierra.  Antes de su muerte, ella grita a todos acerca de su muerte.  Todo est치 en shock. </li><li>  Y luego todas las pesta침as est치n tratando de convertirse instant치neamente en Primarias.  La reacci칩n de todos es diferente (al azar) y quien tenga tiempo, eso y zapatillas.  Tan pronto como una de las pesta침as logr칩 convertirse en primaria, grita a todos que el lugar est치 ocupado.  Despu칠s de eso, la conexi칩n WS vuelve a entrar.  Estamos trabajando  El resto est치 esperando. </li><li>  Etc.  Los carro침eros esperan que la muerte de la pesta침a Primaria caiga en su lugar. </li></ol><br><h4 id="tehnicheskaya-storona-voprosa">  El aspecto t칠cnico del problema. </h4><br><p>  Para comunicarnos entre las pesta침as, utilizaremos lo que las conecta dentro del mismo dominio: localStorage.  Las llamadas no son caras para los recursos de hierro del usuario y la respuesta de ellos es muy r치pida.  A su alrededor, se est치 construyendo toda la idea. </p><br><p>  Hay una <a href="">biblioteca</a> que no ha sido compatible con el creador durante mucho tiempo, pero puede convertirla en una bifurcaci칩n local, como lo hice yo.  De all칤 obtenemos el archivo: </p><br><p><code>/intercom.js</code> </p> <br><p>  La esencia de la biblioteca es que permite que los <em>eventos de emisi칩n / encendido se</em> comuniquen entre pesta침as usando localStorage para esto. </p><br><p>  Despu칠s de eso, necesitamos una herramienta que nos permita <em>bloquear</em> ( <em>bloquear cambios</em> ) una determinada clave en localStorage, sin permitir que nadie la cambie sin los derechos necesarios.  Para esto, se escribi칩 una peque침a biblioteca <strong>llamada</strong> " <strong>locableStorage</strong> ", cuya esencia est치 contenida en la funci칩n <em>trySyncLock ()</em> </p><br><div class="spoiler">  <b class="spoiler_title">C칩digo de biblioteca LocableStorage</b> <div class="spoiler_text"><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">now</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">someNumber</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * <span class="hljs-number"><span class="hljs-number">1000000000</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> myId = now() + <span class="hljs-string"><span class="hljs-string">":"</span></span> + someNumber(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">lskey</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> value = localStorage[lskey]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> splitted = value.split(<span class="hljs-regexp"><span class="hljs-regexp">/\|/</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(splitted[<span class="hljs-number"><span class="hljs-number">1</span></span>]) &lt; now()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> splitted[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_mutexTransaction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, callback, synchronous</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> xKey = key + <span class="hljs-string"><span class="hljs-string">"__MUTEX_x"</span></span>, yKey = key + <span class="hljs-string"><span class="hljs-string">"__MUTEX_y"</span></span>, getY = getter(yKey); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">criticalSection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { callback(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { localStorage.removeItem(yKey); } } localStorage[xKey] = myId; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getY()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!synchronous) setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ _mutexTransaction(key, callback); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } localStorage[yKey] = myId + <span class="hljs-string"><span class="hljs-string">"|"</span></span> + (now() + <span class="hljs-number"><span class="hljs-number">40</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (localStorage[xKey] !== myId) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!synchronous) { setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getY() !== myId) { setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ _mutexTransaction(key, callback); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { criticalSection(); } }, <span class="hljs-number"><span class="hljs-number">50</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { criticalSection(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lockImpl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, callback, maxDuration, synchronous</span></span></span><span class="hljs-function">) </span></span>{ maxDuration = maxDuration || <span class="hljs-number"><span class="hljs-number">5000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> mutexKey = key + <span class="hljs-string"><span class="hljs-string">"__MUTEX"</span></span>, getMutex = getter(mutexKey), mutexValue = myId + <span class="hljs-string"><span class="hljs-string">":"</span></span> + someNumber() + <span class="hljs-string"><span class="hljs-string">"|"</span></span> + (now() + maxDuration); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restart</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ lockImpl(key, callback, maxDuration); }, <span class="hljs-number"><span class="hljs-number">10</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getMutex()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!synchronous) restart(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> aquiredSynchronously = _mutexTransaction(key, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getMutex()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!synchronous) restart(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } localStorage[mutexKey] = mutexValue; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!synchronous) setTimeout(mutexAquired, <span class="hljs-number"><span class="hljs-number">0</span></span>) }, synchronous); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (synchronous &amp;&amp; aquiredSynchronously) { mutexAquired(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mutexAquired</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { callback(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _mutexTransaction(key, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (localStorage[mutexKey] !== mutexValue) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> key + <span class="hljs-string"><span class="hljs-string">" was locked by a different process while I held the lock"</span></span> localStorage.removeItem(mutexKey); }); } } } <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.LockableStorage = { <span class="hljs-attr"><span class="hljs-attr">lock</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, callback, maxDuration</span></span></span><span class="hljs-function">) </span></span>{ lockImpl(key, callback, maxDuration, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) }, <span class="hljs-attr"><span class="hljs-attr">trySyncLock</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, callback, maxDuration</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lockImpl(key, callback, maxDuration, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) } }; })();</code> </pre> </div></div><br><p>  Ahora es necesario combinar todo en un solo mecanismo, lo que nos permitir치 implementar nuestros planes. </p><br><div class="spoiler">  <b class="spoiler_title">C칩digo de implementaci칩n</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Intercom.supported) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> intercom = Intercom.getInstance(), <span class="hljs-comment"><span class="hljs-comment">//Intercom singleton period_heart_bit = 1, //LocalStorage update frequency wsId = someNumber() + Date.now(), //Current tab ID primaryStatus = false, //Primary window tab status refreshIntervalId, count = 0, //Counter. Delete this intFast; //Timer window.webSocketInit = webSocketInit; window.semiCloseTab = semiCloseTab; intercom.on('incoming', data =&gt; { document.getElementById('counter').innerHTML = data.data; document.getElementById('socketStatus').innerHTML = primaryStatus.toString(); return false; }); /** * Random number * @returns {number} - number */ function someNumber() { return Math.random() * 1000000000 | 0; } /** * Try do something */ function webSocketInit() { // Check for crash or loss network let forceOpen = false, wsLU = localStorage.wsLU; if (wsLU) { let diff = Date.now() - parseInt(wsLU); forceOpen = diff &gt; period_heart_bit * 5 * 1000; } //Double checked locking if (!localStorage.wsOpen || localStorage.wsOpen !== "true" || forceOpen) { LockableStorage.trySyncLock("wsOpen", function () { if (!localStorage.wsOpen || localStorage.wsOpen !== "true" || forceOpen) { localStorage.wsOpen = true; localStorage.wsId = wsId; localStorage.wsLU = Date.now(); //TODO this app logic that must be SingleTab ---------------------------- primaryStatus = true; intFast = setInterval(() =&gt; { intercom.emit('incoming', {data: count}); count++ }, 1000); //TODO ------------------------------------------------------------------ startHeartBitInterval(); } }); } } /** * Show singleTab app status */ setInterval(() =&gt; { document.getElementById('wsopen').innerHTML = localStorage.wsOpen; }, 200); /** * Update localStorage info */ function startHeartBitInterval() { refreshIntervalId = setInterval(function () { localStorage.wsLU = Date.now(); }, period_heart_bit * 1000); } /** * Close tab action */ intercom.on('TAB_CLOSED', function (data) { if (localStorage.wsId !== wsId) { count = data.count; setTimeout(() =&gt; { webSocketInit() }, parseInt(getRandomArbitary(1, 1000), 10)); //Init after random time. Important! } }); function getRandomArbitary(min, max) { return Math.random() * (max - min) + min; } /** * Action after some tab closed */ window.onbeforeunload = function () { if (primaryStatus) { localStorage.setItem('wsOpen', false); clearInterval(refreshIntervalId); intercom.emit('TAB_CLOSED', {count: count}); } }; /** * Emulate close window */ function semiCloseTab() { if (primaryStatus) { localStorage.setItem('wsOpen', false); clearInterval(refreshIntervalId); clearInterval(intFast); intercom.emit('TAB_CLOSED', {count: count}); } } webSocketInit() //Try do something } else { alert('intercom.js is not supported by your browser.'); }</span></span></code> </pre> </div></div><br><p>  Ahora con los dedos explicar칠 lo que est치 sucediendo aqu칤. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Proyecto de demostraci칩n de GitHub</a> </p><br><h4 id="shag-1-otkrytie-pervoy-vkladki">  Paso 1. Abrir la primera pesta침a </h4><br><p>  Este ejemplo implementa un temporizador que funciona en varias contribuciones, pero cuyo c치lculo se produce solo en una.  El c칩digo del temporizador se puede reemplazar con cualquier cosa, por ejemplo, inicializando la conexi칩n WS.  cuando se inicia, <strong>webSocketInit ()</strong> se ejecuta inmediatamente, lo que en la primera pesta침a nos llevar치 a iniciar el contador ( <em>abrir el socket</em> ), as칤 como a iniciar el temporizador <strong>startHeartBitInterval () para</strong> actualizar el valor clave " <em>wsLU</em> " en localStorage.  Esta clave es responsable de la creaci칩n y el mantenimiento de la pesta침a Principal.  Este es un elemento clave de toda la estructura.  Al mismo tiempo, se <em>crea la</em> clave <em>wsOpen</em> , que es responsable del estado del contador (o de abrir una conexi칩n WS) y la variable <em>primaryStatus</em> , que hace que la pesta침a actual sea principal, se convierte en verdadera.  Intercom emitir치 la recepci칩n de cualquier evento del contador (conexi칩n WS) con el dise침o: </p><br><pre> <code class="javascript hljs">intercom.emit(<span class="hljs-string"><span class="hljs-string">'incoming'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">data</span></span>: count});</code> </pre> <br><h4 id="shag-2-otkrytie-vtoroy-vkladki">  Paso 2. Abrir la segunda pesta침a </h4><br><p>  Abrir la segunda, tercera y cualquier otra pesta침a har치 que <strong>webSocketInit ()</strong> , despu칠s de lo cual la tecla " <em>wsLU</em> " y " <em>forceOpen</em> " entren en batalla.  Si el c칩digo: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wsLU) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> diff = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now() - <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(wsLU); forceOpen = diff &gt; period_heart_bit * <span class="hljs-number"><span class="hljs-number">5</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>; }</code> </pre> <br><p>  ... har치 que <em>forceOpen se</em> vuelva <em>verdadero</em> , luego el contador se detendr치 y comenzar치 de nuevo, pero esto no suceder치, porque  <em>diff</em> no ser치 mayor que el valor especificado, porque la clave <em>wsLU es</em> compatible con la pesta침a principal actual.  Todas las pesta침as secundarias escuchar치n los eventos que la pesta침a Primaria les brinda a trav칠s de Intercom, con el dise침o: </p><br><pre> <code class="javascript hljs">intercom.on(<span class="hljs-string"><span class="hljs-string">'incoming'</span></span>, data =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'counter'</span></span>).innerHTML = data.data; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'socketStatus'</span></span>).innerHTML = primaryStatus.toString(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; });</code> </pre> <br><h4 id="shag-3-zakrytie-vkladki">  Paso 3. Cerrar la pesta침a </h4><br><p>  Cerrar pesta침as activa el evento <strong>onbeforeunload</strong> en los navegadores modernos.  Lo procesamos de la siguiente manera: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.onbeforeunload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (primaryStatus) { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'wsOpen'</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); clearInterval(refreshIntervalId); intercom.emit(<span class="hljs-string"><span class="hljs-string">'TAB_CLOSED'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">count</span></span>: count}); } };</code> </pre> <br><p>  Cabe se침alar que todos los m칠todos se invocar치n solo en la pesta침a Principal.  Cuando cierre cualquier pesta침a secundaria, no pasar치 nada al contador.  Solo necesita eliminar las escuchas telef칩nicas de los eventos para liberar memoria.  Pero si <em>cerramos</em> la pesta침a Principal, <em>establecemos wsOpen</em> en <em>falso</em> y activamos el evento TAB_CLOSED.  Todas las pesta침as abiertas responder치n de inmediato: </p><br><pre> <code class="javascript hljs">intercom.on(<span class="hljs-string"><span class="hljs-string">'TAB_CLOSED'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (localStorage.wsId !== wsId) { count = data.count; setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { webSocketInit() }, <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(getRandomArbitary(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>)); <span class="hljs-comment"><span class="hljs-comment">//Init after random time. Important! } });</span></span></code> </pre> <br><p>  Aqu칤 es donde comienza la magia.  Funci칩n ... </p><br><div class="spoiler">  <b class="spoiler_title">getRandomArbitary (1, 1000)</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRandomArbitary</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">min, max</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * (max - min) + min; }</code> </pre> </div></div><br><p>  ... le permite llamar a la inicializaci칩n del socket (en nuestro caso, el contador) a diferentes intervalos, lo que hace posible que una de las pesta침as secundarias se convierta en primaria y escriba la informaci칩n al respecto en localStorage.  Habiendo chamanizado en n칰meros <em>(1, 1000),</em> puede lograr la respuesta m치s r치pida de las pesta침as.  Las pesta침as secundarias restantes permanecen para escuchar los eventos y responder a ellos, esperando que la primaria muera. </p><br><h4 id="itog">  Resumen </h4><br><p>  Tenemos un dise침o que le permite mantener solo una conexi칩n webSocket para toda la aplicaci칩n, sin importar cu치ntas pesta침as tenga, lo que reducir치 significativamente la carga en el hardware de nuestros servidores y, como resultado, le permitir치 mantener m치s en l칤nea. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es415401/">https://habr.com/ru/post/es415401/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es415391/index.html">Comienza la certificaci칩n del dispositivo WPA3: las contrase침as d칠biles se vuelven m치s seguras</a></li>
<li><a href="../es415393/index.html">Kubernetes: la vida de un hogar</a></li>
<li><a href="../es415395/index.html">Televisores ondulados</a></li>
<li><a href="../es415397/index.html">PICASO 3D en Top 3D Expo 2018: nueva impresora 3D, nuevos materiales</a></li>
<li><a href="../es415399/index.html">쯇or qu칠 los precios de DVD gratuitos de Fortnite suben a $ 450?</a></li>
<li><a href="../es415403/index.html">Epoll y Windows IO Completion Ports: la diferencia pr치ctica</a></li>
<li><a href="../es415405/index.html">Revisi칩n y prueba del servidor Fujitsu PRIMERGY RX2540 M4</a></li>
<li><a href="../es415407/index.html">Godville - excepto bromas</a></li>
<li><a href="../es415409/index.html">Revisi칩n de la impresora 3D 3Dtool Raise3D PRO2</a></li>
<li><a href="../es415411/index.html">Desde levitar discos hasta sonido desde una caja de cart칩n: 6 interesantes gadgets para vinilo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>