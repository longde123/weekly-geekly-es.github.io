<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💕 💘 🤢 Resolvemos el problema de un millón de pestañas abiertas o "ayudamos al hardware a sobrevivir" 🍎 👩🏾 🕴🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Intentaremos descubrir cómo reducir la carga en el hardware del servidor, mientras aseguramos el máximo rendimiento de la aplicación web. 


 En el de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Resolvemos el problema de un millón de pestañas abiertas o "ayudamos al hardware a sobrevivir"</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415401/"><p><img src="https://habrastorage.org/webt/pn/_3/7n/pn_37n_daf8ssnbb8s3qbcrnjv0.jpeg"></p><br><p>  Intentaremos descubrir cómo reducir la carga en el hardware del servidor, mientras aseguramos el máximo rendimiento de la aplicación web. </p><br><p>  En el desarrollo de proyectos grandes y de alta carga con gran en línea, a menudo tiene que pensar en cómo reducir la carga en el servidor, especialmente cuando trabaja en webSockets y cambia dinámicamente las interfaces.  <em>100500</em> usuarios vienen a nosotros y tenemos <em>100500</em> conexiones de socket abierto.  Y si cada uno de ellos abre 2 pestañas, esto es * 201,000 conexiones.  <strong>¿Y si son cinco?</strong> </p><a name="habracut"></a><br><p>  Considere un ejemplo trivial.  Tenemos, por ejemplo, <del>  Twitch.tv </del> , que para cada usuario genera una conexión WS.  Tal proyecto es enorme en línea, por lo que cada detalle es importante.  No podemos permitirnos abrir una nueva conexión WS en cada pestaña, admitiendo la anterior, porque la glándula no debe estar medida para esto. </p><br><p>  La idea nace: ¿qué pasa si las conexiones WS se levantan en una sola pestaña y siempre se mantienen abiertas, y en las nuevas no se inicializa la conexión, sino que se escucha desde la pestaña vecina?  Se trata de la implementación de esta idea que quiero contar. </p><br><h4 id="logicheskoe-povedenie-vkladok-v-brauzere">  Comportamiento lógico del navegador </h4><br><ol><li>  Abra la primera pestaña, márquela como Primaria </li><li>  Ejecute la prueba: si la pestaña es_primaria, levante la conexión WS </li><li>  Estamos trabajando ... </li><li>  Abra la segunda pestaña (duplique la ventana, ingrese la dirección manualmente, ábrala en una nueva pestaña, no importa) </li><li>  Desde la nueva pestaña, vea si hay en algún lugar una pestaña Principal.  En caso afirmativo, marque el Secundario actual y espere lo que sucederá. </li><li>  Abre 10 pestañas más.  Y todos están esperando. </li><li>  En algún momento, la pestaña Principal se cierra.  Antes de su muerte, ella grita a todos acerca de su muerte.  Todo está en shock. </li><li>  Y luego todas las pestañas están tratando de convertirse instantáneamente en Primarias.  La reacción de todos es diferente (al azar) y quien tenga tiempo, eso y zapatillas.  Tan pronto como una de las pestañas logró convertirse en primaria, grita a todos que el lugar está ocupado.  Después de eso, la conexión WS vuelve a entrar.  Estamos trabajando  El resto está esperando. </li><li>  Etc.  Los carroñeros esperan que la muerte de la pestaña Primaria caiga en su lugar. </li></ol><br><h4 id="tehnicheskaya-storona-voprosa">  El aspecto técnico del problema. </h4><br><p>  Para comunicarnos entre las pestañas, utilizaremos lo que las conecta dentro del mismo dominio: localStorage.  Las llamadas no son caras para los recursos de hierro del usuario y la respuesta de ellos es muy rápida.  A su alrededor, se está construyendo toda la idea. </p><br><p>  Hay una <a href="">biblioteca</a> que no ha sido compatible con el creador durante mucho tiempo, pero puede convertirla en una bifurcación local, como lo hice yo.  De allí obtenemos el archivo: </p><br><p><code>/intercom.js</code> </p> <br><p>  La esencia de la biblioteca es que permite que los <em>eventos de emisión / encendido se</em> comuniquen entre pestañas usando localStorage para esto. </p><br><p>  Después de eso, necesitamos una herramienta que nos permita <em>bloquear</em> ( <em>bloquear cambios</em> ) una determinada clave en localStorage, sin permitir que nadie la cambie sin los derechos necesarios.  Para esto, se escribió una pequeña biblioteca <strong>llamada</strong> " <strong>locableStorage</strong> ", cuya esencia está contenida en la función <em>trySyncLock ()</em> </p><br><div class="spoiler">  <b class="spoiler_title">Código de biblioteca LocableStorage</b> <div class="spoiler_text"><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">now</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">someNumber</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * <span class="hljs-number"><span class="hljs-number">1000000000</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> myId = now() + <span class="hljs-string"><span class="hljs-string">":"</span></span> + someNumber(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">lskey</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> value = localStorage[lskey]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> splitted = value.split(<span class="hljs-regexp"><span class="hljs-regexp">/\|/</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(splitted[<span class="hljs-number"><span class="hljs-number">1</span></span>]) &lt; now()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> splitted[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_mutexTransaction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, callback, synchronous</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> xKey = key + <span class="hljs-string"><span class="hljs-string">"__MUTEX_x"</span></span>, yKey = key + <span class="hljs-string"><span class="hljs-string">"__MUTEX_y"</span></span>, getY = getter(yKey); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">criticalSection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { callback(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { localStorage.removeItem(yKey); } } localStorage[xKey] = myId; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getY()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!synchronous) setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ _mutexTransaction(key, callback); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } localStorage[yKey] = myId + <span class="hljs-string"><span class="hljs-string">"|"</span></span> + (now() + <span class="hljs-number"><span class="hljs-number">40</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (localStorage[xKey] !== myId) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!synchronous) { setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getY() !== myId) { setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ _mutexTransaction(key, callback); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { criticalSection(); } }, <span class="hljs-number"><span class="hljs-number">50</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { criticalSection(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lockImpl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, callback, maxDuration, synchronous</span></span></span><span class="hljs-function">) </span></span>{ maxDuration = maxDuration || <span class="hljs-number"><span class="hljs-number">5000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> mutexKey = key + <span class="hljs-string"><span class="hljs-string">"__MUTEX"</span></span>, getMutex = getter(mutexKey), mutexValue = myId + <span class="hljs-string"><span class="hljs-string">":"</span></span> + someNumber() + <span class="hljs-string"><span class="hljs-string">"|"</span></span> + (now() + maxDuration); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restart</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ lockImpl(key, callback, maxDuration); }, <span class="hljs-number"><span class="hljs-number">10</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getMutex()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!synchronous) restart(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> aquiredSynchronously = _mutexTransaction(key, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getMutex()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!synchronous) restart(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } localStorage[mutexKey] = mutexValue; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!synchronous) setTimeout(mutexAquired, <span class="hljs-number"><span class="hljs-number">0</span></span>) }, synchronous); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (synchronous &amp;&amp; aquiredSynchronously) { mutexAquired(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mutexAquired</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { callback(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _mutexTransaction(key, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (localStorage[mutexKey] !== mutexValue) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> key + <span class="hljs-string"><span class="hljs-string">" was locked by a different process while I held the lock"</span></span> localStorage.removeItem(mutexKey); }); } } } <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.LockableStorage = { <span class="hljs-attr"><span class="hljs-attr">lock</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, callback, maxDuration</span></span></span><span class="hljs-function">) </span></span>{ lockImpl(key, callback, maxDuration, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) }, <span class="hljs-attr"><span class="hljs-attr">trySyncLock</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, callback, maxDuration</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lockImpl(key, callback, maxDuration, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) } }; })();</code> </pre> </div></div><br><p>  Ahora es necesario combinar todo en un solo mecanismo, lo que nos permitirá implementar nuestros planes. </p><br><div class="spoiler">  <b class="spoiler_title">Código de implementación</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Intercom.supported) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> intercom = Intercom.getInstance(), <span class="hljs-comment"><span class="hljs-comment">//Intercom singleton period_heart_bit = 1, //LocalStorage update frequency wsId = someNumber() + Date.now(), //Current tab ID primaryStatus = false, //Primary window tab status refreshIntervalId, count = 0, //Counter. Delete this intFast; //Timer window.webSocketInit = webSocketInit; window.semiCloseTab = semiCloseTab; intercom.on('incoming', data =&gt; { document.getElementById('counter').innerHTML = data.data; document.getElementById('socketStatus').innerHTML = primaryStatus.toString(); return false; }); /** * Random number * @returns {number} - number */ function someNumber() { return Math.random() * 1000000000 | 0; } /** * Try do something */ function webSocketInit() { // Check for crash or loss network let forceOpen = false, wsLU = localStorage.wsLU; if (wsLU) { let diff = Date.now() - parseInt(wsLU); forceOpen = diff &gt; period_heart_bit * 5 * 1000; } //Double checked locking if (!localStorage.wsOpen || localStorage.wsOpen !== "true" || forceOpen) { LockableStorage.trySyncLock("wsOpen", function () { if (!localStorage.wsOpen || localStorage.wsOpen !== "true" || forceOpen) { localStorage.wsOpen = true; localStorage.wsId = wsId; localStorage.wsLU = Date.now(); //TODO this app logic that must be SingleTab ---------------------------- primaryStatus = true; intFast = setInterval(() =&gt; { intercom.emit('incoming', {data: count}); count++ }, 1000); //TODO ------------------------------------------------------------------ startHeartBitInterval(); } }); } } /** * Show singleTab app status */ setInterval(() =&gt; { document.getElementById('wsopen').innerHTML = localStorage.wsOpen; }, 200); /** * Update localStorage info */ function startHeartBitInterval() { refreshIntervalId = setInterval(function () { localStorage.wsLU = Date.now(); }, period_heart_bit * 1000); } /** * Close tab action */ intercom.on('TAB_CLOSED', function (data) { if (localStorage.wsId !== wsId) { count = data.count; setTimeout(() =&gt; { webSocketInit() }, parseInt(getRandomArbitary(1, 1000), 10)); //Init after random time. Important! } }); function getRandomArbitary(min, max) { return Math.random() * (max - min) + min; } /** * Action after some tab closed */ window.onbeforeunload = function () { if (primaryStatus) { localStorage.setItem('wsOpen', false); clearInterval(refreshIntervalId); intercom.emit('TAB_CLOSED', {count: count}); } }; /** * Emulate close window */ function semiCloseTab() { if (primaryStatus) { localStorage.setItem('wsOpen', false); clearInterval(refreshIntervalId); clearInterval(intFast); intercom.emit('TAB_CLOSED', {count: count}); } } webSocketInit() //Try do something } else { alert('intercom.js is not supported by your browser.'); }</span></span></code> </pre> </div></div><br><p>  Ahora con los dedos explicaré lo que está sucediendo aquí. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Proyecto de demostración de GitHub</a> </p><br><h4 id="shag-1-otkrytie-pervoy-vkladki">  Paso 1. Abrir la primera pestaña </h4><br><p>  Este ejemplo implementa un temporizador que funciona en varias contribuciones, pero cuyo cálculo se produce solo en una.  El código del temporizador se puede reemplazar con cualquier cosa, por ejemplo, inicializando la conexión WS.  cuando se inicia, <strong>webSocketInit ()</strong> se ejecuta inmediatamente, lo que en la primera pestaña nos llevará a iniciar el contador ( <em>abrir el socket</em> ), así como a iniciar el temporizador <strong>startHeartBitInterval () para</strong> actualizar el valor clave " <em>wsLU</em> " en localStorage.  Esta clave es responsable de la creación y el mantenimiento de la pestaña Principal.  Este es un elemento clave de toda la estructura.  Al mismo tiempo, se <em>crea la</em> clave <em>wsOpen</em> , que es responsable del estado del contador (o de abrir una conexión WS) y la variable <em>primaryStatus</em> , que hace que la pestaña actual sea principal, se convierte en verdadera.  Intercom emitirá la recepción de cualquier evento del contador (conexión WS) con el diseño: </p><br><pre> <code class="javascript hljs">intercom.emit(<span class="hljs-string"><span class="hljs-string">'incoming'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">data</span></span>: count});</code> </pre> <br><h4 id="shag-2-otkrytie-vtoroy-vkladki">  Paso 2. Abrir la segunda pestaña </h4><br><p>  Abrir la segunda, tercera y cualquier otra pestaña hará que <strong>webSocketInit ()</strong> , después de lo cual la tecla " <em>wsLU</em> " y " <em>forceOpen</em> " entren en batalla.  Si el código: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wsLU) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> diff = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now() - <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(wsLU); forceOpen = diff &gt; period_heart_bit * <span class="hljs-number"><span class="hljs-number">5</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>; }</code> </pre> <br><p>  ... hará que <em>forceOpen se</em> vuelva <em>verdadero</em> , luego el contador se detendrá y comenzará de nuevo, pero esto no sucederá, porque  <em>diff</em> no será mayor que el valor especificado, porque la clave <em>wsLU es</em> compatible con la pestaña principal actual.  Todas las pestañas secundarias escucharán los eventos que la pestaña Primaria les brinda a través de Intercom, con el diseño: </p><br><pre> <code class="javascript hljs">intercom.on(<span class="hljs-string"><span class="hljs-string">'incoming'</span></span>, data =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'counter'</span></span>).innerHTML = data.data; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'socketStatus'</span></span>).innerHTML = primaryStatus.toString(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; });</code> </pre> <br><h4 id="shag-3-zakrytie-vkladki">  Paso 3. Cerrar la pestaña </h4><br><p>  Cerrar pestañas activa el evento <strong>onbeforeunload</strong> en los navegadores modernos.  Lo procesamos de la siguiente manera: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.onbeforeunload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (primaryStatus) { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'wsOpen'</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); clearInterval(refreshIntervalId); intercom.emit(<span class="hljs-string"><span class="hljs-string">'TAB_CLOSED'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">count</span></span>: count}); } };</code> </pre> <br><p>  Cabe señalar que todos los métodos se invocarán solo en la pestaña Principal.  Cuando cierre cualquier pestaña secundaria, no pasará nada al contador.  Solo necesita eliminar las escuchas telefónicas de los eventos para liberar memoria.  Pero si <em>cerramos</em> la pestaña Principal, <em>establecemos wsOpen</em> en <em>falso</em> y activamos el evento TAB_CLOSED.  Todas las pestañas abiertas responderán de inmediato: </p><br><pre> <code class="javascript hljs">intercom.on(<span class="hljs-string"><span class="hljs-string">'TAB_CLOSED'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (localStorage.wsId !== wsId) { count = data.count; setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { webSocketInit() }, <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(getRandomArbitary(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>)); <span class="hljs-comment"><span class="hljs-comment">//Init after random time. Important! } });</span></span></code> </pre> <br><p>  Aquí es donde comienza la magia.  Función ... </p><br><div class="spoiler">  <b class="spoiler_title">getRandomArbitary (1, 1000)</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRandomArbitary</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">min, max</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * (max - min) + min; }</code> </pre> </div></div><br><p>  ... le permite llamar a la inicialización del socket (en nuestro caso, el contador) a diferentes intervalos, lo que hace posible que una de las pestañas secundarias se convierta en primaria y escriba la información al respecto en localStorage.  Habiendo chamanizado en números <em>(1, 1000),</em> puede lograr la respuesta más rápida de las pestañas.  Las pestañas secundarias restantes permanecen para escuchar los eventos y responder a ellos, esperando que la primaria muera. </p><br><h4 id="itog">  Resumen </h4><br><p>  Tenemos un diseño que le permite mantener solo una conexión webSocket para toda la aplicación, sin importar cuántas pestañas tenga, lo que reducirá significativamente la carga en el hardware de nuestros servidores y, como resultado, le permitirá mantener más en línea. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es415401/">https://habr.com/ru/post/es415401/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es415391/index.html">Comienza la certificación del dispositivo WPA3: las contraseñas débiles se vuelven más seguras</a></li>
<li><a href="../es415393/index.html">Kubernetes: la vida de un hogar</a></li>
<li><a href="../es415395/index.html">Televisores ondulados</a></li>
<li><a href="../es415397/index.html">PICASO 3D en Top 3D Expo 2018: nueva impresora 3D, nuevos materiales</a></li>
<li><a href="../es415399/index.html">¿Por qué los precios de DVD gratuitos de Fortnite suben a $ 450?</a></li>
<li><a href="../es415403/index.html">Epoll y Windows IO Completion Ports: la diferencia práctica</a></li>
<li><a href="../es415405/index.html">Revisión y prueba del servidor Fujitsu PRIMERGY RX2540 M4</a></li>
<li><a href="../es415407/index.html">Godville - excepto bromas</a></li>
<li><a href="../es415409/index.html">Revisión de la impresora 3D 3Dtool Raise3D PRO2</a></li>
<li><a href="../es415411/index.html">Desde levitar discos hasta sonido desde una caja de cartón: 6 interesantes gadgets para vinilo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>