<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äçüîß ‚ù£Ô∏è üëèüèæ Servidor de teste para a equipe de desenvolvimento üöâ üèåÔ∏è üöµüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! Neste artigo, quero compartilhar a experi√™ncia de implantar um servidor de teste para a equipe de desenvolvimento. Resumidamente, a ess√™ncia...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Servidor de teste para a equipe de desenvolvimento</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426319/">  Ol√° Habr!  Neste artigo, quero compartilhar a experi√™ncia de implantar um servidor de teste para a equipe de desenvolvimento.  Resumidamente, a ess√™ncia do problema - h√° uma equipe de desenvolvimento e v√°rios projetos em php.  Enquanto √©ramos poucos e o projeto era essencialmente um, usamos um servidor de teste e, para mostrar a tarefa ao cliente, o desenvolvedor ‚Äúcolocou em coluna‚Äù o servidor por um certo tempo.  Se n√£o houvesse "janelas" a tempo, ter√≠amos que esperar.  Com o tempo, a equipe e a complexidade das tarefas aumentaram, respectivamente, o tempo de verifica√ß√£o e a ocupa√ß√£o do servidor de teste, o que afetou negativamente o lead time e o b√¥nus.  Portanto, eu tive que procurar uma solu√ß√£o e est√° sob o corte. <br><a name="habracut"></a><br><h3>  Introdut√≥rio </h3><br>  O que foi: <br><br><ol><li>  Um servidor de teste </li><li>  Gitlab e redmine em outro servidor </li><li>  Desejo de resolver um problema </li></ol><br>  Todos os servidores est√£o em nossa rede local, o servidor de teste √© inacess√≠vel do lado de fora. <br><br>  O que foi necess√°rio: <br><br><ol><li>  Capacidade de testar v√°rios projetos / filiais ao mesmo tempo </li><li>  O desenvolvedor pode ir ao servidor, configur√°-lo e n√£o quebrar nada dos outros </li><li>  Tudo deve ser o mais conveniente poss√≠vel e feito em 1 bot√£o, de prefer√™ncia no gitlab (CI / CD). </li></ol><br><h3>  Op√ß√µes de decis√£o </h3><br><h4>  1. Um servidor, muitos hosts </h4><br>  A op√ß√£o mais f√°cil.  Utilizamos o mesmo servidor de teste, apenas o desenvolvedor precisa criar um host para cada filial / projeto e adicion√°-lo √† configura√ß√£o nginx / apache2. <br><br>  Pr√≥s: <br><br><ol><li>  Rapidamente e todos entendem </li><li>  Pode automatizar </li></ol><br>  Contras: <br><br><ol><li>  A cl√°usula 2 dos requisitos n√£o foi atendida - o desenvolvedor pode come√ßar a atualizar o banco de dados e, em algumas circunst√¢ncias, colocar tudo em (Oi Andrey!) </li><li>  Automa√ß√£o bastante complexa com v√°rios arquivos de configura√ß√£o </li></ol><br><h4>  2. Para cada desenvolvedor no servidor! </h4><br>  Aloque para cada servidor e o desenvolvedor √© respons√°vel por sua economia. <br><br>  Pr√≥s: <br><br><ol><li>  O desenvolvedor pode personalizar completamente o servidor para seu projeto </li></ol><br>  Contras: <br><br><ol><li>  A cl√°usula 2 dos requisitos n√£o √© cumprida </li><li>  Caros e recursos podem simplesmente ficar ociosos enquanto o desenvolvimento est√° em andamento, n√£o testando </li><li>  A automa√ß√£o √© ainda mais complicada do que no ponto 1 devido a diferentes servidores </li></ol><br><h4>  3. Containeriza√ß√£o - janela de encaixe, kubernetes </h4><br>  Essa tecnologia est√° cada vez mais penetrando em nossas vidas.  Em casa, uso o docker para meus projetos h√° muito tempo. <br><blockquote>  O Docker √© um software para automatizar a implanta√ß√£o e o gerenciamento de aplicativos em um ambiente de virtualiza√ß√£o no n√≠vel do sistema operacional.  Permite que voc√™ "empacote" o aplicativo com todos os seus arredores e depend√™ncias em um cont√™iner que possa ser portado para qualquer sistema Linux com suporte a cgroups no kernel e tamb√©m forne√ßa um ambiente de gerenciamento de cont√™iner. </blockquote>  Pr√≥s: <br><br><ol><li>  Um servidor √© usado </li><li>  Todos os requisitos s√£o atendidos. </li></ol><br>  Contras: <br><br><ol><li>  √Äs vezes, imagens e cont√™ineres ocupam muito espa√ßo; √© necess√°rio limpar as coroas que j√° est√£o desatualizadas para liberar espa√ßo. </li></ol><br><h3>  Implementa√ß√£o do Docker </h3><br>  Ao usar o gitlab, o AutoDevOps, as configura√ß√µes do kubernetes frequentemente chamavam minha aten√ß√£o.  Al√©m disso, caras barbudos em v√°rios encontros contam o qu√£o legal eles trabalham com os kubernetes.  Portanto, foi decidido tentar implantar o cluster em suas instala√ß√µes, o servidor foi solicitado (e voc√™ n√£o pode tocar no teste, as pessoas est√£o testando l√°) e come√ßou! <br><br>  Como tenho experi√™ncia com o kubernetes 0, tudo foi feito de acordo com o manual, com a tentativa de entender como todos esses clusters funcionam.  Depois de algum tempo, consegui aumentar o cluster, mas houve problemas com certificados, chaves e, de fato, com a dificuldade de implanta√ß√£o.  Eu precisava de uma solu√ß√£o mais simples para ensinar meus colegas a trabalhar com isso (por exemplo, n√£o quero passar as mesmas f√©rias sentado no Skype e ajudando na configura√ß√£o).  Portanto, o kubernetes foi deixado sozinho.  O pr√≥prio Docker permaneceu e foi necess√°rio encontrar uma solu√ß√£o para o roteamento de cont√™ineres.  Como eles podem ser detectados em portas diferentes, o mesmo nginx pode ser usado para redirecionamento interno.  Isso √© chamado de servidor proxy reverso. <br><blockquote>  Um servidor proxy reverso √© um tipo de servidor proxy que retransmite solicita√ß√µes de clientes de uma rede externa para um ou mais servidores localizados logicamente na rede interna.  Ao mesmo tempo, parece ao cliente como se os recursos solicitados estivessem localizados diretamente no servidor proxy. </blockquote><h4>  Proxy reverso </h4><br>  Para n√£o reinventar a roda, comecei a procurar solu√ß√µes prontas.  E foi encontrado - isto √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">traefik</a> . <br><br>  O Tr√¶fik √© um moderno proxy reverso HTTP e balanceador de carga que simplifica a implanta√ß√£o de microsservi√ßos.  O Tr√¶fik se integra aos componentes de infraestrutura existentes (Docker, modo Swarm, Kubernetes, Maratona, Consul, Etcd, Rancher, Amazon ECS, ...) e √© configurado automaticamente e dinamicamente.  Para trabalhar com a janela de encaixe, basta especificar seu soquete e pronto, ent√£o o pr√≥prio Tr√¶fik encontra todos os cont√™ineres e encaminhamento para eles (para obter mais detalhes, consulte ‚ÄúEmpacotando aplicativos na janela de encaixe‚Äù). <br><br><div class="spoiler">  <b class="spoiler_title">Configura√ß√£o de cont√™iner da Tr√¶fik</b> <div class="spoiler_text">  Eu inicio atrav√©s do docker-compose.yml <br><br><pre><code class="hljs delphi">version: <span class="hljs-string"><span class="hljs-string">'3'</span></span> services: traefik: image: traefik:latest # The official Traefik docker image command: --api --docker # Enables the web UI <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> tells Tr√¶fik <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> listen <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> docker ports: - <span class="hljs-number"><span class="hljs-number">443</span></span>:<span class="hljs-number"><span class="hljs-number">443</span></span> - <span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> # The HTTP port - <span class="hljs-number"><span class="hljs-number">8080</span></span>:<span class="hljs-number"><span class="hljs-number">8080</span></span> # The Web UI (enabled by --api) volumes: - /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/run/docker.sock:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/run/docker.sock # So that Traefik can listen <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the Docker events - /opt/traefik/traefik.toml:/traefik.toml - /opt/traefik/certs/:/certs/ networks: - proxy container_name: traefik restart: always networks: proxy: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span>: true</code> </pre> <br></div></div><br>  Aqui, informamos ao proxy que precisamos ouvir as portas 80.443 e 8080 (a face da Web do proxy), monte o soquete do docker, o arquivo de configura√ß√£o e a pasta do certificado.  Para a conveni√™ncia de nomear sites de teste, decidimos criar uma zona de dom√≠nio local * .test.  Ao acessar qualquer site, o usu√°rio acessa nosso servidor de teste.  Portanto, os certificados na pasta traefik s√£o autoassinados, mas s√£o compat√≠veis com o Let's Encrypt. <br><br>  Gera√ß√£o de certificado <br><br><pre> <code class="bash hljs">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout domain.key -out domain.crt</code> </pre> <br>  Antes de iniciar, voc√™ precisa criar uma rede proxy na janela de encaixe (voc√™ pode nomear como sua). <br><br><pre> <code class="bash hljs">docker network create proxy</code> </pre> <br>  Essa ser√° a rede para conectar o traefik com cont√™ineres de sites php.  Portanto, n√≥s o especificamos no par√¢metro de redes do servi√ßo e nas redes de todo o arquivo, especificando no par√¢metro external: true. <br><br><div class="spoiler">  <b class="spoiler_title">Arquivo Traefik.toml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> logLevel = "DEBUG" defaultEntryPoints = ["https","http"] #  insecureSkipVerify = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> #   [entryPoints] [entryPoints.http] address = ":80" [entryPoints.https] address = ":443" [entryPoints.https.tls] [docker] endpoint = "unix:///var/run/docker.sock" <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> = "docker.localhost" watch = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> exposedbydefault = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span></code> </pre> <br></div></div><br>  Tudo √© bem simples aqui - especificamos os pontos de entrada do tr√°fego http e https, n√£o se esque√ßa de definir insecureSkipVerify = true se os certificados forem locais.  Na se√ß√£o entryPoints.https.tls, voc√™ n√£o pode especificar certificados; o traefik substituir√° seu certificado. <br><br>  Voc√™ pode iniciar o servi√ßo <br><br><pre> <code class="bash hljs">docker-compose up -d</code> </pre> <br>  Se voc√™ for ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">site.test</a> , receber√° um erro 404, pois esse dom√≠nio n√£o est√° vinculado a nenhum cont√™iner. <br><br><h4>  Empacotamos aplicativos no docker </h4><br>  Agora voc√™ precisa configurar o cont√™iner com o aplicativo, a saber: <br><br>  1. especifique uma rede proxy nas redes <br>  2. adicione etiquetas com configura√ß√£o traefik <br><br>  Abaixo est√° a configura√ß√£o de um dos aplicativos <br><br><div class="spoiler">  <b class="spoiler_title">aplicativos docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs kotlin">version: <span class="hljs-string"><span class="hljs-string">'3'</span></span> services: app: build: <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/docker/php #   restart: always working_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/html/<span class="hljs-keyword"><span class="hljs-keyword">public</span></span> volumes: - ./:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/html #    - /home/develop/site-files/f:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/html/<span class="hljs-keyword"><span class="hljs-keyword">public</span></span>/f #       links: - mailcatcher - memcached - mysql labels: - traefik.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> - traefik.frontend.rule=Host:TEST_DOMAIN,crm.TEST_DOMAIN,bonus.TEST_DOMAIN - traefik.docker.network=proxy - traefik.port=<span class="hljs-number"><span class="hljs-number">443</span></span> - traefik.protocol=https networks: - proxy - <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> mailcatcher: image: schickling/mailcatcher:latest restart: always memcached: image: memcached restart: always mysql: image: mysql:<span class="hljs-number"><span class="hljs-number">5.7</span></span> restart: always command: --max_allowed_packet=<span class="hljs-number"><span class="hljs-number">902505856</span></span> --sql-mode=<span class="hljs-string"><span class="hljs-string">""</span></span> environment: MYSQL_ROOT_PASSWORD: <span class="hljs-number"><span class="hljs-number">12345</span></span> MYSQL_DATABASE: site volumes: - ./<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/cache/mysql-db:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/mysql #      phpmyadmin: image: phpmyadmin/phpmyadmin restart: always links: - mysql environment: MYSQL_USERNAME: root MYSQL_ROOT_PASSWORD: <span class="hljs-number"><span class="hljs-number">12345</span></span> PMA_ARBITRARY: <span class="hljs-number"><span class="hljs-number">1</span></span> PMA_HOST: mysql_1 labels: - traefik.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> - traefik.frontend.rule=Host:pma.TEST_DOMAIN - traefik.docker.network=proxy - traefik.port=<span class="hljs-number"><span class="hljs-number">80</span></span> - traefik.<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.protocol=http networks: - proxy - <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> networks: proxy: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre><br></div></div><br>  No servi√ßo de aplicativo, na se√ß√£o de rede, √© necess√°rio especificar proxy e padr√£o, isso significa que ele estar√° dispon√≠vel em duas redes, como pode ser visto na configura√ß√£o, n√£o encaminhar portas para fora, tudo passa na rede. <br><br>  Em seguida, configure etiquetas <br><br><pre> <code class="hljs 1c"> - traefik.enabled=true <span class="hljs-meta"><span class="hljs-meta"># traefik </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   - traefik.frontend.rule=Host:TEST_DOMAIN,crm.TEST_DOMAIN,bonus.TEST_DOMAIN #  </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  traefik     - traefik.docker.network=proxy # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  - traefik.port=443 #, </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">    ssl   80   http - traefik.protocol=https #  #  phpmyadmin   http </span></span></code> </pre><br>  Na se√ß√£o de redes gerais, especifique external: true <br><br>  A constante TEST_DOMAIN deve ser substitu√≠da por um dom√≠nio, por exemplo, site.test <br><br>  Inicie o aplicativo <br><br><pre> <code class="bash hljs">docker-compose up -d</code> </pre> <br>  Agora, se voc√™ acessar os dom√≠nios site.test, crm.site.test, bonus.site.test, poder√° ver o site em funcionamento.  E no dom√≠nio pma.site.test, haver√° phpmyadmin para um trabalho conveniente com o banco de dados. <br><br><h4>  Configurar o GitLab </h4><br>  Criamos um manipulador de tarefas, para isso corremos <br><br><pre> <code class="bash hljs">gitlab-runner register</code> </pre> <br>  N√≥s especificamos o URL do gitlab, o token e atrav√©s do qual a tarefa ser√° executada (executores).  Como meu teste e gitlab est√£o em servidores diferentes, seleciono o ssh executor.  Voc√™ precisar√° especificar o endere√ßo do servidor e o login / senha para conectar via ssh. <br><br>  O corredor pode ser anexado a um ou mais projetos.  Como minha l√≥gica de trabalho √© a mesma em todos os lugares, um corredor compartilhado foi criado (comum para todos os projetos). <br>  E o toque final √© criar um arquivo de configura√ß√£o de IC <br><br><div class="spoiler">  <b class="spoiler_title">.gitlab-ci.yml</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">stages: - build - clear #  develop build_develop: stage: build #   build tags: #     - ssh-develop environment: # ,       -   name: review/<span class="hljs-string"><span class="hljs-string">$C</span></span>I_BUILD_REF_NAME #  url: https://site<span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID.test <span class="hljs-symbol"><span class="hljs-symbol">#url</span></span>     on_stop: clear when: manual script: - cd ../ &amp;&amp; cp -r <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PROJECT_NAME <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID &amp;&amp; cd <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID #     - cp -r /home/develop/site-files/.ssh data/docker/php/.ssh #  ssh - sed -i -e <span class="hljs-comment"><span class="hljs-comment">"s/TEST_DOMAIN/site$CI_PIPELINE_ID.test/g"</span></span> docker-compose.yml #   - docker-compose down #   - docker-compose up -d --build #  - script -q -c <span class="hljs-comment"><span class="hljs-comment">"docker exec -it ${CI_PIPELINE_ID}_app_1 bash -c \"</span></span>cd ../ &amp;&amp; php composer.phar install --prefer-dist \<span class="hljs-comment"><span class="hljs-comment">""</span></span> #   - script -q -c <span class="hljs-comment"><span class="hljs-comment">"docker exec -it ${CI_PIPELINE_ID}_app_1 bash -c \"</span></span>cd ../ &amp;&amp; php composer.phar first-install <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID\<span class="hljs-comment"><span class="hljs-comment">""</span></span> #     #  production build_prod: stage: build tags: - ssh-develop environment: name: review/<span class="hljs-string"><span class="hljs-string">$C</span></span>I_BUILD_REF_NAME url: https://site<span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID.test on_stop: clear when: manual script: - cd ../ &amp;&amp; cp -r <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PROJECT_NAME <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID &amp;&amp; cd <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID - cp -r /home/develop/site-files/.ssh data/docker/php/.ssh #  ssh - docker-compose down - docker-compose up -d --build - script -q -c <span class="hljs-comment"><span class="hljs-comment">"docker exec -it ${CI_PIPELINE_ID}_app_1 bash -c \"</span></span>cd ../ &amp;&amp; php composer.phar install --prefer-dist --no-dev\<span class="hljs-comment"><span class="hljs-comment">""</span></span> - script -q -c <span class="hljs-comment"><span class="hljs-comment">"docker exec -it ${CI_PIPELINE_ID}_app_1 bash -c \"</span></span>cd ../ &amp;&amp; php composer.phar first-install <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID\<span class="hljs-comment"><span class="hljs-comment">""</span></span> clear: stage: clear tags: - ssh-develop environment: name: review/<span class="hljs-string"><span class="hljs-string">$C</span></span>I_BUILD_REF_NAME action: stop script: - cd ../ &amp;&amp; cd <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID &amp;&amp; docker-compose down &amp;&amp; cd ../ &amp;&amp; echo password | sudo -<span class="hljs-type"><span class="hljs-type">S</span></span> rm -rf <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID #       when: manual</code> </pre><br></div></div><br>  Nesta configura√ß√£o, s√£o descritos 2 est√°gios - compilar e limpar.  A fase de constru√ß√£o possui 2 op√ß√µes - build_develop e build_prod <br><br><img src="https://habrastorage.org/webt/yz/ut/dy/yzutdyyknwjgwbcg4-kj2ssv-f8.png"><br><br>  O Gitlab cria um diagrama de fluxo de processo compreens√≠vel.  No meu exemplo, todos os processos iniciam manualmente (quando: par√¢metro manual).  Isso √© feito para que o desenvolvedor, depois de implantar o site de teste, possa inserir suas edi√ß√µes no cont√™iner sem reconstruir o cont√™iner inteiro.  Outro motivo √© o nome do dom√≠nio - site $ CI_PIPELINE_ID.test, em que CI_PIPELINE_ID √© o n√∫mero do processo que iniciou a montagem.  Ou seja, eles enviaram o site com o dom√≠nio site123.test para verifica√ß√£o e, para fazer edi√ß√µes quentes, as altera√ß√µes s√£o imediatamente lan√ßadas no cont√™iner pelo desenvolvedor. <br><br>  Um pequeno recurso do executor ssh.  Quando conectado ao servidor, uma pasta do formul√°rio √© criada. <br><br><pre> <code class="bash hljs">/home//builds/_runner/0/_/_</code> </pre> <br>  Portanto, uma linha foi adicionada <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ &amp;&amp; cp -r <span class="hljs-variable"><span class="hljs-variable">$CI_PROJECT_NAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$CI_PIPELINE_ID</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$CI_PIPELINE_ID</span></span></code> </pre> <br>  Nele, subimos para a pasta acima e copiamos o projeto para a pasta com o n√∫mero do processo.  Assim, voc√™ pode implantar v√°rias ramifica√ß√µes de um projeto.  Mas nas configura√ß√µes do manipulador, √© necess√°rio marcar Bloquear nos projetos atuais, para que o manipulador n√£o tente expandir v√°rias ramifica√ß√µes ao mesmo tempo. <br><br>  O est√°gio de limpeza para os cont√™ineres e exclui a pasta; talvez voc√™ precise de privil√©gios de root, por isso usamos a senha de eco |  sudo -S rm em que senha √© sua senha. <br><br><h4>  Coleta de lixo </h4><br>  De tempos em tempos, voc√™ precisa remover os cont√™ineres n√£o utilizados para n√£o ocupar espa√ßo; para isso, um script com esse conte√∫do fica pendurado na coroa <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   : docker ps --filter status=dead --filter status=exited -aq | xargs -r docker rm -v #   : yes | docker container prune #    : yes | docker image prune #    : yes | docker volume prune</span></span></code> </pre> <br>  realizada uma vez ao dia. <br><br><h3>  Conclus√£o </h3><br>  Essa solu√ß√£o nos ajudou a otimizar significativamente os testes e o lan√ßamento de novos recursos.  Pronto para responder a perguntas, cr√≠ticas construtivas s√£o aceitas. <br><br><h3>  B√¥nus </h3><br>  Para n√£o coletar imagens do Dockerfile de cada vez, voc√™ pode armazen√°-las no registro da janela de encaixe local. <br><br><div class="spoiler">  <b class="spoiler_title">Arquivo docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs powershell">registry: restart: always image: registry:<span class="hljs-number"><span class="hljs-number">2</span></span> ports: - <span class="hljs-number"><span class="hljs-number">5000</span></span>:<span class="hljs-number"><span class="hljs-number">5000</span></span> volumes: - /opt/docker<span class="hljs-literal"><span class="hljs-literal">-registry</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>:/var/lib/registry <span class="hljs-comment"><span class="hljs-comment">#    </span></span></code> </pre><br></div></div><br>  Esta op√ß√£o n√£o usa autentica√ß√£o, n√£o √© uma maneira segura (!!!), mas √© adequada para armazenar imagens n√£o cr√≠ticas. <br><br>  Voc√™ pode configurar o gitlab para visualizar <br><br><pre> <code class="bash hljs"> gitlab_rails[<span class="hljs-string"><span class="hljs-string">'registry_enabled'</span></span>] = <span class="hljs-literal"><span class="hljs-literal">true</span></span> gitlab_rails[<span class="hljs-string"><span class="hljs-string">'registry_host'</span></span>] = <span class="hljs-string"><span class="hljs-string">"registry.test"</span></span> gitlab_rails[<span class="hljs-string"><span class="hljs-string">'registry_port'</span></span>] = <span class="hljs-string"><span class="hljs-string">"5000"</span></span></code> </pre><br>  Depois disso, uma lista de imagens aparece no gitlab <br><br><img src="https://habrastorage.org/webt/lu/hn/8i/luhn8ilow44doqm5btrtafgv-hq.png"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt426319/">https://habr.com/ru/post/pt426319/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt426305/index.html">Trabalhe com status de personagem. Experi√™ncias Unity</a></li>
<li><a href="../pt426311/index.html">Confer√™ncia BLACK HAT USA. Botnet de um milh√£o de navegadores. Parte 2</a></li>
<li><a href="../pt426313/index.html">Novo Microsoft Learn</a></li>
<li><a href="../pt426315/index.html">Como fazer amigos python com a Internet invis√≠vel? O b√°sico do desenvolvimento de aplicativos I2P em Python e ass√≠ncrono</a></li>
<li><a href="../pt426317/index.html">1155 vs 2011. Alguns idosos entram em batalha</a></li>
<li><a href="../pt426323/index.html">Uma tentativa de criar uma caixa de rob√¥ com um or√ßamento limitado. Esteira de vidro e cola Epoxy</a></li>
<li><a href="../pt426325/index.html">Curso MIT "Seguran√ßa de sistemas de computadores". Palestra 12: Seguran√ßa de Rede, Parte 1</a></li>
<li><a href="../pt426327/index.html">Novidades da atualiza√ß√£o do Windows 10 de outubro de 2018</a></li>
<li><a href="../pt426331/index.html">Vulnerabilidade no PlayStation 4 - o conjunto de caracteres na mensagem para o usu√°rio transforma remotamente o console em quase um "tijolo"</a></li>
<li><a href="../pt426333/index.html">A Microsoft lan√ßou o c√≥digo MS-DOS 1.25 e 2.0 sob a licen√ßa MIT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>