<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👵🏼 🔺 👨‍🎓 Die ganze Wahrheit über RTOS. Artikel 21. Postfächer: Einführung und Basisdienste 🧛🏾 👨🏾‍🔧 😜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Postfächer wurden in einem der vorherigen Artikel (Nr. 5) erwähnt. Sie sind die zweitleichteste von Nucleus SE unterstützte Signal-zu-Signal-Inter-Tas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Die ganze Wahrheit über RTOS. Artikel 21. Postfächer: Einführung und Basisdienste</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430856/"><img src="https://habrastorage.org/webt/pj/yd/r0/pjydr0sj2zrtqop5hhxum0q2vki.jpeg"><br><br>  Postfächer wurden in einem der vorherigen Artikel (Nr. 5) erwähnt.  Sie sind die zweitleichteste von Nucleus SE unterstützte Signal-zu-Signal-Inter-Tasking-Kommunikationsmethode und bieten eine kostengünstige und flexible Möglichkeit, einfache Nachrichten zwischen Aufgaben zu übertragen. <br><a name="habracut"></a><br>  Frühere Artikel in der Reihe: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel Nr. 20.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Semaphoren: Nebendienstleistungen und Datenstrukturen</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel Nr. 19.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Semaphoren: Einführung und Grundversorgung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel Nr. 18.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ereignisflag-Gruppen: Hilfsdienste und Datenstrukturen</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel Nr. 17.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ereignisflag-Gruppen: Einführung und Basisdienste</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 16.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Signale</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel Nr. 15.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Speicherpartitionen: Dienste und Datenstrukturen</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel # 14.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Speicherbereiche: Einführung und Grundversorgung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel Nr. 13.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aufgabendatenstrukturen und nicht unterstützte API-Aufrufe</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 12.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dienstleistungen für die Arbeit mit Aufgaben</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 11.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aufgaben: Konfiguration und Einführung in die API</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 10.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Scheduler: Erweiterte Funktionen und Kontexterhaltung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 9.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Scheduler: Implementierung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 8.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nucleus SE: Internes Design und Bereitstellung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 7.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nucleus SE: Einführung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 6.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Andere RTOS-Dienste</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 5.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aufgabeninteraktion und Synchronisation</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 4.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aufgaben, Kontextwechsel und Interrupts</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 3.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aufgaben und Planung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RTOS: Struktur und Echtzeitmodus</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><br></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RTOS: Einführung.</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><br></a> <br><h2>  Verwenden von Postfächern </h2><br>  In Nucleus SE werden Postfächer während der Erstellungsphase definiert.  Eine Anwendung kann bis zu 16 Postfächer haben.  Wenn die Anwendung keine Postfächer hat, werden der mit den Postfächern verknüpfte Serviceanrufcode und die Datenstrukturen nicht in die Anwendung aufgenommen. <br><br>  Ein Postfach ist nur ein Ort zum Speichern von Daten, deren Größe ausreicht, um eine Variable vom Typ <b>ADDR</b> zu speichern, und deren sicherer Zugriff so gesteuert wird, dass mehrere Aufgaben sie verwenden können.  Eine Aufgabe kann Daten an eine Mailbox senden.  Infolgedessen wird das Postfach voll, und keine Aufgabe kann Daten an das Postfach senden, bis eine Aufgabe den Vorgang des Lesens des Postfachs ausführt oder bis das Postfach leer ist.  Der Versuch, Daten an ein vollständiges Postfach zu senden oder ein leeres Postfach zu lesen, führt je nach den ausgewählten API-Aufrufeinstellungen und der Nucleus SE-Konfiguration zu einem Fehler oder einer Aufgabenpause. <br><br><h2>  Postfächer und Warteschlangen </h2><br>  In einigen Implementierungen des Betriebssystems werden Postfächer nicht implementiert. Alternativ wird vorgeschlagen, eine Warteschlange zu verwenden.  Dies klingt logisch, da eine solche Warteschlange dieselbe Funktionalität wie ein Postfach bietet.  Die Warteschlange ist jedoch eine komplexere Datenstruktur und enthält viel mehr Hilfsdaten, Code und eine längere Servicezeit. <br><br>  In Nucleus SE können Sie wie in Nucleus RTOS jeden dieser Objekttypen auswählen. <br>  Wenn Ihre Anwendung mehrere Warteschlangen und ein Postfach hat, ist es sinnvoll, das Postfach durch eine Warteschlange zu ersetzen.  Dadurch wird der Overhead geringfügig erhöht, der gesamte mit Postfächern verknüpfte API-Code wird jedoch entfernt.  Alternativ können Sie die Anwendung mit beiden Methoden konfigurieren und die Datenmenge und Leistung vergleichen. <br><br>  Warteschlangen werden in zukünftigen Artikeln behandelt. <br><br><h2>  Postfächer konfigurieren </h2><br><h3>  Anzahl der Postfächer </h3><br>  Wie bei den meisten Nucleus SE-Objekten wird die Postfachkonfiguration hauptsächlich durch die Direktiven <b>#define</b> in der Datei <b>nuse_config.h definiert</b> .  Der Hauptparameter ist <b>NUSE_MAILBOX_NUMBER</b> , der die Anzahl der Postfächer in der Anwendung bestimmt.  Der Standardwert ist Null ( <b>dh</b> es gibt keine Postfächer) und kann Werte bis zu 16 annehmen. Ein falscher Wert führt zu einem Fehler beim Kompilieren, der durch Einchecken von <b>nuse_config_check.h</b> generiert wird (er ist in der Datei <b>nuse_config.c enthalten</b> und wird damit kompiliert ), wodurch die Direktive <b>#error ausgelöst wird</b> . <br><br>  Die Auswahl eines Werts ungleich Null ist der Hauptaktivator für Postfächer.  Dieser Parameter wird beim Definieren von Datenstrukturen verwendet und ihre Größe hängt von ihrem Wert ab (mehr dazu im nächsten Artikel).  Darüber hinaus aktiviert ein Wert ungleich Null die API-Einstellungen. <br><br><h3>  API-Aufrufe aktivieren </h3><br>  Jede API-Funktion (Dienstprogrammaufruf) in Nucleus SE wird durch die Direktive <b>#define</b> in der Datei <b>nuse_config.h</b> aktiviert.  Für Postfächer sind diese Anweisungen: <br><br><pre><code class="plaintext hljs">NUSE_MAILBOX_SEND NUSE_MAILBOX_RECEIVE NUSE_MAILBOX_RESET NUSE_MAILBOX_INFORMATION NUSE_MAILBOX_COUNT</code> </pre> <br>  Standardmäßig sind sie auf <b>FALSE gesetzt</b> , wodurch alle Serviceaufrufe deaktiviert und die Aufnahme von Code blockiert werden, der sie implementiert.  Um Postfächer in der Anwendung zu konfigurieren, müssen Sie die erforderlichen API-Aufrufe auswählen und auf <b>TRUE setzen</b> . <br><br>  Das Folgende ist ein Codeabschnitt aus der Datei <b>nuse_config.h</b> . <br><br><pre> <code class="plaintext hljs">/* Number of mailboxes in the system - 0-16 */ #define NUSE_MAILBOX_NUMBER 0 /* Service call enablers: */ #define NUSE_MAILBOX_SEND FALSE #define NUSE_MAILBOX_RECEIVE FALSE #define NUSE_MAILBOX_RESET FALSE #define NUSE_MAILBOX_INFORMATION FALSE #define NUSE_MAILBOX_COUNT FALSE</code> </pre><br>  Wenn die Postfach-API-Funktion aktiviert ist und die Anwendung keine Postfächer enthält (mit Ausnahme von <b>NUSE_Mailbox_Count ()</b> , das immer aktiviert ist), tritt ein Kompilierungsfehler auf.  Wenn Ihr Code einen API-Aufruf verwendet, der nicht aktiviert wurde, tritt ein Layoutfehler auf, da der Implementierungscode nicht in der Anwendung enthalten war. <br><br><h2>  Postfachdienstanrufe </h2><br>  Nucleus RTOS unterstützt neun Serviceanrufe, die Postfächern zugeordnet sind und die folgenden Funktionen bieten: <br><br><ul><li>  Senden von Nachrichten an die Mailbox.  Nucleus SE ist in der Funktion <b>NUSE_Mailbox_Send ()</b> implementiert. </li><li>  Lesen einer Nachricht aus einer Mailbox.  Nucleus SE implementiert die Funktion <b>NUSE_Mailbox_Receive ()</b> . </li><li>  Wiederherstellen eines nicht verwendeten Postfachs mit der Freigabe aller angehaltenen Aufgaben (Zurücksetzen).  In Nucleus SE, implementiert in <b>NUSE_Mailbox_Reset ()</b> . </li><li>  Bereitstellung von Informationen zu einem bestimmten Postfach.  Nucleus SE ist in <b>NUSE_Mailbox_Information ()</b> implementiert. </li><li>  Gibt die Anzahl der aktuell in der Anwendung konfigurierten Postfächer zurück.  In Nucleus SE, implementiert in <b>NUSE_Mailbox_Count ()</b> . </li><li>  Hinzufügen eines neuen Postfachs (Erstellung).  Nucleus SE ist nicht implementiert. </li><li>  Löschen Sie eine Mailbox.  Nucleus SE ist nicht implementiert. </li><li>  Geben Sie Zeiger auf alle Postfächer in der Anwendung zurück.  Nucleus SE ist nicht implementiert. </li><li>  Senden einer Nachricht an alle Aufgaben, die in der Mailbox angehalten sind (Broadcast).  Nucleus SE ist nicht implementiert. </li></ul><br>  Betrachten Sie detailliert die Implementierung jedes Serviceabrufs. <br><br><h2>  Mailbox Read and Write Service Calls </h2><br>  Die grundlegenden Vorgänge, die für Postfächer ausgeführt werden können, sind das Schreiben und Lesen von Daten (Senden und Empfangen).  Nucleus RTOS und Nucleus SE bieten zwei grundlegende API-Aufrufe für diese Operationen, die nachfolgend beschrieben werden. <br><br><h3>  In Mailbox schreiben </h3><br>  Das Aufrufen der Nucleus RTOS-API zum Schreiben in das Postfach ist sehr flexibel, sodass Sie die Aufgabe implizit oder mit einer Zeitüberschreitung anhalten können, wenn der Vorgang nicht sofort abgeschlossen werden kann (z. B. wenn Sie versuchen, in ein vollständiges Postfach zu schreiben).  Nucleus SE bietet einen ähnlichen Serviceabruf, nur die Taskpause ist optional und das Timeout ist nicht implementiert. <br><br>  Nucleus RTOS bietet auch einen Serviceabruf zum Senden von Daten an eine Mailbox an. Dieser Aufruf wird in Nucleus SE nicht unterstützt und wird im nächsten Artikel im Abschnitt „Nicht realisierte API-Aufrufe“ beschrieben. <br><br>  <b><i>Rufen Sie an, um in Nucleus RTOS in eine Mailbox zu schreiben</i></b> <br>  Prototyp eines Serviceabrufs: <br>  <b>STATUS NU_Send_To_Mailbox (NU_MAILBOX * Mailbox, VOID * Nachricht, UNSIGNED Suspend);</b> <br><br>  Parameter: <br>  <b>Mailbox</b> - Zeiger auf die Mailbox; <br>  <b>Nachricht</b> - ein Zeiger auf die zu sendende Nachricht, bestehend aus vier Elementen vom Typ <b>ohne Vorzeichen</b> ; <br>  <b>suspend</b> - Die Angabe der Suspendierung der Aufgabe kann die Werte <b>NU_NO_SUSPEND</b> , <b>NU_SUSPEND</b> oder Timeout-Wert <b>annehmen</b> . <br><br>  Rückgabewert: <br>  <b>NU_SUCCESS</b> - Der Anruf wurde erfolgreich abgeschlossen. <br>  <b>NU_INVALID_MAILBOX</b> - ungültiger Postfachzeiger; <br>  <b>NU_INVALID_POINTER</b> - Nullzeiger auf eine Nachricht ( <b>NULL</b> ); <br>  <b>NU_INVALID_SUSPEND</b> - Versuch, einen nicht aufgabenbezogenen Thread auszusetzen; <br>  <b>NU_MAILBOX_FULL</b> - Das Postfach ist voll, aber die Art der Aussetzung ist nicht angegeben. <br>  <b>NU_TIMEOUT</b> - Das Postfach ist auch nach dem Aussetzen für den angegebenen Zeitraum noch voll. <br>  <b>NU_MAILBOX_DELETED</b> - Das Postfach wurde gelöscht, während die Aufgabe angehalten wurde. <br>  <b>NU_MAILBOX_WAS_RESET</b> - Das Postfach wurde zurückgesetzt, während die Aufgabe angehalten wurde. <br><br>  <b><i>Rufen Sie an, um in eine Mailbox in Nucleus SE zu schreiben</i></b> <br>  Dieser API-Aufruf unterstützt die Kernfunktionalität der Nucleus RTOS-API. <br><br>  Prototyp eines Serviceabrufs: <br>  <b>STATUS NUSE_Mailbox_Send (Postfach NUSE_MAILBOX, ADDR * -Nachricht, U8-Suspend);</b> <br><br>  Parameter: <br>  <b>Postfach</b> - <b>Postfachindex</b> (ID); <br>  <b>message</b> - ein Zeiger auf die zu sendende Nachricht, es ist eine Variable vom Typ <b>ADDR</b> ; <br>  <b>suspend</b> - Die Angabe der Suspendierung der Aufgabe kann die Werte <b>NUSE_NO_SUSPEND</b> oder <b>NUSE_SUSPEND annehmen</b> . <br><br>  Rückgabewert: <br>  <b>NUSE_SUCCESS</b> - Der Anruf wurde erfolgreich abgeschlossen. <br>  <b>NUSE_INVALID_MAILBOX</b> - ungültiger Postfachindex; <br>  <b>NUSE_INVALID_POINTER</b> - Nullzeiger auf eine Nachricht ( <b>NULL</b> ); <br>  <b>NUSE_INVALID_SUSPEND</b> - ein Versuch, einen nicht verwandten Thread auszusetzen oder wenn die Funktion zum Blockieren von API-Aufrufen deaktiviert ist; <br>  <b>NUSE_MAILBOX_FULL</b> - Das Postfach ist voll, aber die Art der Aussetzung ist nicht angegeben. <br>  <b>NUSE_MAILBOX_WAS_RESET</b> - Das Postfach wurde zurückgesetzt, während die Aufgabe angehalten wurde. <br><br>  <b><i>Implementieren von Postfacheinträgen in Nucleus SE</i></b> <br>  Die Version des API-Funktionscodes <b>NUSE_Mailbox_Send ()</b> (nach Überprüfung der Parameter) wird mithilfe der bedingten Kompilierung ausgewählt, je nachdem, ob die Unterstützung für API-Aufrufe zum Blockieren (Anhalten von Aufgaben) aktiviert ist oder nicht.  Betrachten Sie beide Optionen. <br><br>  Wenn die Task-Sperre deaktiviert ist, ist die Logik für diesen API-Aufruf ziemlich einfach und der Code bedarf keiner Erklärung: <br><br><pre> <code class="plaintext hljs">if (NUSE_Mailbox_Status[mailbox]) /* mailbox full */ { return_value = NUSE_MAILBOX_FULL; } else /* mailbox empty */ { NUSE_Mailbox_Data[mailbox] = *message; NUSE_Mailbox_Status[mailbox] = TRUE; return_value = NUSE_SUCCESS; }</code> </pre><br>  Die Nachricht wird im entsprechenden Element <b>NUSE_Mailbox_Data []</b> gespeichert und das Postfach als verwendet markiert. <br><br>  Wenn die Task-Sperre aktiviert ist, wird der Code komplexer: <br><br><pre> <code class="plaintext hljs">do { if (!NUSE_Mailbox_Status[mailbox]) /* mailbox empty */ { NUSE_Mailbox_Data[mailbox] = *message; NUSE_Mailbox_Status[mailbox] = TRUE; if (NUSE_Mailbox_Blocking_Count[mailbox] != 0) { U8 index; /* check whether a task is blocked */ /* on this mailbox */ NUSE_Mailbox_Blocking_Count[mailbox]--; for (index=0; index&lt;NUSE_TASK_NUMBER; index++) { if ((LONIB(NUSE_Task_Status[index]) == NUSE_MAILBOX_SUSPEND) &amp;&amp; (HINIB(NUSE_Task_Status[index]) == mailbox)) { NUSE_Task_Blocking_Return[index] = NUSE_SUCCESS; NUSE_Wake_Task(index); break; } } } return_value = NUSE_SUCCESS; suspend = NUSE_NO_SUSPEND; } else /* mailbox full */ { if (suspend == NUSE_NO_SUSPEND) { return_value = NUSE_MAILBOX_FULL; } else { /* block task */ NUSE_Mailbox_Blocking_Count[mailbox]++; NUSE_Suspend_Task(NUSE_Task_Active, (mailbox &lt;&lt; 4) | NUSE_MAILBOX_SUSPEND); return_value = NUSE_Task_Blocking_Return[NUSE_Task_Active]; if (return_value != NUSE_SUCCESS) { suspend = NUSE_NO_SUSPEND; } } } } while (suspend == NUSE_SUSPEND);</code> </pre><br>  Einige Erklärungen können hilfreich sein. <br><br>  Der Code ist in einer <b>do ... while-Schleife eingeschlossen</b> , die ausgeführt wird, während der <b>suspend-</b> Parameter <b>NUSE_SUSPEND lautet</b> . <br><br>  Wenn das Postfach leer ist, wird die Nachricht aufgezeichnet und der Status des Postfachs ändert sich, um anzuzeigen, dass es voll ist.  Überprüft dieses Postfach auf angehaltene Aufgaben (die darauf warten, gelesen zu werden).  Wenn es solche Aufgaben gibt, wird die erste von ihnen fortgesetzt.  Die Suspend-Variable wird auf <b>NUSE_NO_SUSPEND gesetzt</b> , und der API-Aufruf wird beendet und gibt <b>NUSE_SUCCESS zurück</b> . <br><br>  Wenn das Postfach voll ist und suspend <b>NUSE_NO_SUSPEND ist</b> , gibt der API-Aufruf <b>NUSE_MAILBOX_FULL zurück</b> .  Wenn suspend <b>NUSE_SUSPEND ist</b> , wird die Aufgabe <b>angehalten</b> .  Wenn die Funktion nach Beendigung der Funktion (z. B. wenn die Aufgabe <b>fortgesetzt</b> wird) <b>NUSE_SUCCESS lautet</b> (was darauf hinweist, dass die Aufgabe fortgesetzt wurde, weil die Nachricht gelesen wurde und nicht, dass das Postfach zurückgesetzt wurde), beginnt der Zyklus von <b>vorne</b> . <br><br><h3>  Mailbox lesen </h3><br>  Der Nucleus RTOS API-Dienstprogrammaufruf zum Lesen eines Postfachs ist sehr flexibel und ermöglicht es Ihnen, Aufgaben implizit oder mit einer Zeitüberschreitung anzuhalten, wenn der Vorgang nicht sofort abgeschlossen werden kann (z. B. beim Lesen aus einem leeren Postfach).  Nucleus SE bietet einen ähnlichen Service, nur die Unterbrechung von Aufgaben ist optional und eine Zeitüberschreitung ist nicht implementiert. <br><br>  <b><i>Rufen Sie an, um eine Mailbox in Nucleus RTOS zu lesen</i></b> <br>  Prototyp eines Serviceabrufs: <br>  <b>STATUS NU_Receive_From_Mailbox (NU_MAILBOX * Mailbox, VOID * Nachricht, UNSIGNED Suspend);</b> <br><br>  Parameter: <br>  <b>Postfach</b> - ein Zeiger auf die vom Benutzer bereitgestellte Postfachsteuereinheit; <br>  <b>Nachricht</b> - ein Zeiger auf den Speicher für die empfangene Nachricht, dessen Größe vier Variablen vom Typ <b>ohne Vorzeichen entspricht</b> ; <br>  <b>suspend</b> - Task-Suspendierungsspezifikation, kann die Werte <b>NUSE_NO_SUSPEND</b> , <b>NUSE_SUSPEND</b> oder Timeout-Wert <b>annehmen</b> . <br><br>  Rückgabewert: <br>  <b>NU_SUCCESS</b> - Der Anruf wurde erfolgreich abgeschlossen. <br>  <b>NU_INVALID_MAILBOX</b> - ungültiger Postfachzeiger; <br>  <b>NU_INVALID_POINTER</b> - Nullzeiger auf eine Nachricht ( <b>NULL</b> ); <br>  <b>NU_INVALID_SUSPEND</b> - Versuch, an einem falschen Stream <b>anzuhalten</b> (nicht mit der Aufgabe des Streams verknüpft); <br>  <b>NU_MAILBOX_EMPTY</b> - Das Postfach ist leer und die Art der Aussetzung wurde nicht angegeben. <br>  <b>NU_TIMEOUT</b> - Das Postfach ist auch nach dem <b>Anhalten</b> der Aufgabe für den angegebenen Zeitlimitwert noch leer. <br>  <b>NU_MAILBOX_DELETED</b> - Das Postfach wurde gelöscht, während die Aufgabe angehalten wurde. <br>  <b>NU_MAILBOX_WAS_RESET</b> - Das Postfach wurde zurückgesetzt, während die Aufgabe angehalten wurde. <br><br>  <b><i>Rufen Sie an, um eine Mailbox in Nucleus SE zu lesen</i></b> <br>  Dieser API-Aufruf unterstützt die Kernfunktionalität der Nucleus RTOS-API. <br><br>  Prototyp eines Serviceabrufs: <br>  <b>STATUS NUSE_Mailbox_Receive (Postfach NUSE_MAILBOX, ADDR * -Nachricht, U8-Suspend);</b> <br><br>  Parameter: <br>  <b>Postfach</b> - <b>Postfachindex</b> (ID); <br>  <b>Nachricht</b> - Ein Zeiger auf die Speicherung der empfangenen Nachricht ist eine Variable vom Typ <b>ADDR</b> . <br>  <b>suspend</b> - Die Angabe der Suspendierung der Aufgabe kann die Werte <b>NUSE_NO_SUSPEND</b> oder <b>NUSE_SUSPEND annehmen</b> . <br><br>  Rückgabewert: <br>  <b>NUSE_SUCCESS</b> - Der Anruf wurde erfolgreich abgeschlossen. <br>  <b>NUSE_INVALID_MAILBOX</b> - ungültiger Postfachindex; <br>  <b>NUSE_INDALID_POINTER</b> - Nullzeiger auf eine Nachricht ( <b>NULL</b> ); <br>  <b>NUSE_INVALID_SUSPEND</b> - ein Versuch, einen falschen Stream auszusetzen oder wenn API-Aufrufe deaktiviert sind, um Aufgaben zu blockieren; <br>  <b>NUSE_MAILBOX_EMPTY</b> - Das Postfach ist leer und die Art der <b>Taskunterbrechung</b> ist nicht angegeben. <br>  <b>NUSE_MAILBOX_WAS_RESET</b> - Das Postfach wurde zurückgesetzt, während die Aufgabe angehalten wurde. <br><br>  <b><i>Implementieren des Mailbox Readers in Nucleus SE</i></b> <br>  Die Version des API-Funktionscodes <b>NUSE_Mailbox_Receive ()</b> (nach Überprüfung der Parameter) wird mithilfe der bedingten Kompilierung ausgewählt, je nachdem, ob die API-Aufrufe zum Blockieren (Anhalten von Aufgaben) aktiviert sind oder nicht.  Wir werden beide Optionen prüfen. <br><br>  Wenn die Task-Sperre deaktiviert ist, ist die Logik für diesen API-Aufruf ziemlich einfach und der Code bedarf keiner Erklärung: <br><br><pre> <code class="plaintext hljs">if (!NUSE_Mailbox_Status[mailbox]) /* mailbox empty */ { return_value = NUSE_MAILBOX_EMPTY; } else { /* mailbox full */ *message = NUSE_Mailbox_Data[mailbox]; NUSE_Mailbox_Status[mailbox] = FALSE; return_value = NUSE_SUCCESS; }</code> </pre><br>  Die Nachricht wird aus dem entsprechenden Element <b>NUSE_Mailbox_Data []</b> gelesen und das Postfach als leer markiert. <br><br>  Wenn die Task-Sperre aktiviert ist, wird der Code komplexer: <br><br><pre> <code class="plaintext hljs">do { if (NUSE_Mailbox_Status[mailbox]) /* mailbox full */ { *message = NUSE_Mailbox_Data[mailbox]; NUSE_Mailbox_Status[mailbox] = FALSE; if (NUSE_Mailbox_Blocking_Count[mailbox] != 0) { U8 index; /* check whether a task is blocked */ /* on this mailbox */ NUSE_Mailbox_Blocking_Count[mailbox]--; for (index=0; index&lt;NUSE_TASK_NUMBER; index++) { if ((LONIB(NUSE_Task_Status[index]) == NUSE_MAILBOX_SUSPEND) &amp;&amp; (HINIB(NUSE_Task_Status[index]) == mailbox)) { NUSE_Task_Blocking_Return[index] = NUSE_SUCCESS; NUSE_Wake_Task(index); break; } } } return_value = NUSE_SUCCESS; suspend = NUSE_NO_SUSPEND; } else /* mailbox empty */ { if (suspend == NUSE_NO_SUSPEND) { return_value = NUSE_MAILBOX_EMPTY; } else { /* block task */ NUSE_Mailbox_Blocking_Count[mailbox]++; NUSE_Suspend_Task(NUSE_Task_Active, (mailbox &lt;&lt; 4) | NUSE_MAILBOX_SUSPEND); return_value = NUSE_Task_Blocking_Return[NUSE_Task_Active]; if (return_value != NUSE_SUCCESS) { suspend = NUSE_NO_SUSPEND; } } } } while (suspend == NUSE_SUSPEND);</code> </pre><br>  Einige Erläuterungen können hilfreich sein. <br><br>  Der Code ist in einer <b>do ... while-Schleife eingeschlossen</b> , die ausgeführt wird, während der <b>suspend-</b> Parameter <b>NUSE_SUSPEND lautet</b> . <br><br>  Wenn das Postfach voll ist, wird die gespeicherte Nachricht zurückgegeben und der Status des Postfachs ändert sich, um anzuzeigen, dass es leer ist.  Überprüft dieses Postfach auf angehaltene Aufgaben (die auf die Aufzeichnung warten).  Wenn es solche Aufgaben gibt, wird die erste von ihnen fortgesetzt.  Die Suspend-Variable wird auf <b>NUSE_NO_SUSPEND gesetzt</b> , und der API-Aufruf wird beendet und gibt <b>NUSE_SUCCESS zurück</b> . <br><br>  Wenn das Postfach leer ist und der <b>Suspend-</b> Parameter <b>NUSE_NO_SUSPEND lautet</b> , gibt der API-Aufruf <b>NUSE_MAILBOX_EMPTY zurück</b> .  Wenn suspend <b>NUSE_SUSPEND ist</b> , wird die Aufgabe <b>angehalten</b> .  Wenn am Ende des Aufrufs der Rückgabewert <b>NUSE_SUCCESS lautet</b> , was darauf hinweist, dass die Aufgabe fortgesetzt wurde, weil die Nachricht gesendet wurde (und nicht, dass das Postfach zurückgesetzt wurde), beginnt der Zyklus von <b>vorne</b> . <br><br>  Im folgenden Artikel werden zusätzliche API-Aufrufe für Postfächer sowie die entsprechenden Datenstrukturen untersucht. <br><br>  <b>Über den Autor:</b> Colin Walls ist seit über dreißig Jahren in der Elektronikindustrie tätig und widmet sich die meiste Zeit der Firmware.  Heute ist er Firmware-Ingenieur bei Mentor Embedded (einer Abteilung von Mentor Graphics).  Colin Walls spricht häufig auf Konferenzen und Seminaren, Autor zahlreicher technischer Artikel und zweier Bücher über Firmware.  Lebt in Großbritannien.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Colins</a> professioneller <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Blog</a> , E-Mail: colin_walls@mentor.com. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de430856/">https://habr.com/ru/post/de430856/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de430844/index.html">So wählen Sie eine Batterie für die USV</a></li>
<li><a href="../de430846/index.html">Was ist neu: Details zur Implementierung der neuen Zen 2-Architektur wurden bekannt</a></li>
<li><a href="../de430850/index.html">Apple Metal bei MAPS.ME</a></li>
<li><a href="../de430852/index.html">Konsistenz- und ACID-Garantien in verteilten Speichersystemen</a></li>
<li><a href="../de430854/index.html">„JS wird reifer“: ein Interview mit dem Moskauer Programmkomitee HolyJS 2018</a></li>
<li><a href="../de430860/index.html">Laden Sie PDF in Swift herunter, speichern Sie es und zeigen Sie es an</a></li>
<li><a href="../de430862/index.html">"Monster in Spielen - wie man einen Spieler dazu bringt, dich zu hassen"</a></li>
<li><a href="../de430864/index.html">Streichhölzer sind kein Spielzeug?</a></li>
<li><a href="../de430866/index.html">Peking wird 2020 ein soziales Rating für Einwohner einführen</a></li>
<li><a href="../de430868/index.html">Was ist beim Kauf von NGFW zu beachten? Checkliste</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>