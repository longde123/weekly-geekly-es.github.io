<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🔬 🏎️ 🤟 Génération de séquences de dates PostgreSQL et generate_series #⃣ 🧒🏿 💷</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Avertissement de vélo 

 Cet article peut s'avérer être un exemple sphérique de construction de vélos. Si vous connaissez une solution standard ou plu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Génération de séquences de dates PostgreSQL et generate_series</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421969/"><div class="spoiler">  <b class="spoiler_title">Avertissement de vélo</b> <div class="spoiler_text"><p>  <em>Cet article peut s'avérer être un exemple sphérique de construction de vélos.</em>  <em>Si vous connaissez une solution standard ou plus élégante au problème, je serai heureux de la voir dans les commentaires.</em> </p></div></div><br><p>  Une fois à l'un des projets, nous devions établir un rapport sur les transactions financières de la période avec un groupe de sous-totaux à la fin du mois. </p><br><p>  La tâche est généralement simple, déterminer les périodes requises dans un grand intervalle, lier chaque opération à une période appropriée, grouper et additionner la somme. </p><br><p>  Pour générer des périodes dans l'intervalle, je prenais habituellement la fonction generate_series, que j'utilise souvent pour générer des séquences numériques.  J'ai vérifié la documentation sur la possibilité de générer une séquence de dates, j'ai considéré un exemple, j'ai écrit une requête et j'ai été perplexe. </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> gs::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series(<span class="hljs-string"><span class="hljs-string">'2018-01-31'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-05-31'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 month'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs;</code> </pre> <br><table><thead><tr><th>  gs </th></tr></thead><tbody><tr><td>  31/01/2018 </td></tr><tr><td>  28/02/2018 </td></tr><tr><td>  28/03/2018 </td></tr><tr><td>  28/04/2018 </td></tr><tr><td>  28/05/2018 </td></tr></tbody></table><a name="habracut"></a><br><p>  Le résultat était aussi inattendu que logique.  La fonction generate_series a honnêtement généré de manière itérative une séquence de dates basée sur le principe de l'ajout séquentiel d'un décalage à la valeur précédente.  En même temps, à chaque étape, l'exactitude et l'édition de la date reçue ont été vérifiées.  Le 31 février ne se produit pas, donc la date a été changée au 28 février et l'ajout supplémentaire du mois a ramené toute la séquence au 28. </p><br><p>  <em>UPD</em>  <em>Explications après les questions dans les commentaires.</em>  <em>En général, la tâche initiale est plus large - regrouper les données sur des jours arbitraires du mois.</em>  <em>Par exemple, regroupez le 20e jour de chaque mois, le 15e jour, mais il n'y a aucun problème avec ces dates lors de la génération.</em>  <em>Le mécanisme que nous recherchons devrait tout aussi bien construire une séquence de 10 numéros de chaque mois, 21 numéros et bien calculer les fins de mois.</em> </p><br><p>  Je me demande comment l'opération d'addition se déroulera avec plusieurs mois à la fois?  Que se passera-t-il si nous ajoutons l'intervalle non de manière itérative, mais "en vrac"? </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-31'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> +<span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 mons'</span></span> <span class="hljs-number"><span class="hljs-number">28.02</span></span><span class="hljs-number"><span class="hljs-number">.2018</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-31'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> +<span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-string"><span class="hljs-string">'2 mons'</span></span> <span class="hljs-number"><span class="hljs-number">31.03</span></span><span class="hljs-number"><span class="hljs-number">.2018</span></span></code> </pre> <br><p>  Dans ce cas, l'ajout est fait honnêtement. <br>  Comment générer les dates nécessaires en utilisant cette approche? </p><br><p>  Si le nombre de mois est connu, alors c'est très simple: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-31'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> +make_interval(<span class="hljs-number"><span class="hljs-number">0</span></span>, i) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> i</code> </pre> <br><table><thead><tr><th>  gs </th></tr></thead><tbody><tr><td>  31/01/2018 </td></tr><tr><td>  28/02/2018 </td></tr><tr><td>  31/03/2018 </td></tr><tr><td>  30/04/2018 </td></tr><tr><td>  31/05/2018 </td></tr></tbody></table><br><p>  Que faire si seules la date de début et la date de fin sont connues? <br>  Ce problème peut être tout simplement résolu en écrivant une fonction stockée et un simple cycle dedans, cependant, nous sommes intéressés par une option d'implémentation lorsqu'il n'y a aucune possibilité ou désir de boucher la structure de la base de données avec des objets inutiles. <br>  Essayons de réduire la tâche à la précédente. </p><br><p>  <em>Le code suivant est dans une certaine mesure une maquette et ne prétend pas être élégant; nous écrivons les premières options de requête dans l'entreprise en mettant l'accent sur la flexibilité et l'interchangeabilité des blocs</em> </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/*  -  ,         ,      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> dates <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-31'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt1, <span class="hljs-string"><span class="hljs-string">'2018-05-31'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt2 ), <span class="hljs-comment"><span class="hljs-comment">/*      ""  */</span></span> g_age <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> age( (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt2 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates), (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt1 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates)) ), <span class="hljs-comment"><span class="hljs-comment">/*       (*12 + )   +1       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">months</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">extract</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">year</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> g_age))*<span class="hljs-number"><span class="hljs-number">12</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">extract</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">month</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> g_age))+<span class="hljs-number"><span class="hljs-number">1</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> ), <span class="hljs-comment"><span class="hljs-comment">/*  ,           -   ,       */</span></span> seq <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt1 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates) + make_interval(<span class="hljs-number"><span class="hljs-number">0</span></span>, gs)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series ( <span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">months</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt1 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates) + make_interval(<span class="hljs-number"><span class="hljs-number">0</span></span>, gs)) &lt;= (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt2 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates) ) <span class="hljs-comment"><span class="hljs-comment">/*         */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> seq</code> </pre> <br><table><thead><tr><th>  gs </th></tr></thead><tbody><tr><td>  31/01/2018 </td></tr><tr><td>  28/02/2018 </td></tr><tr><td>  31/03/2018 </td></tr><tr><td>  30/04/2018 </td></tr><tr><td>  31/05/2018 </td></tr></tbody></table><br><p>  La solution s'est avérée assez lourde, mais fonctionnante et il est assez simple de l'intégrer dans d'autres requêtes via le mécanisme with. <br>  Nous avons mis en œuvre le rapport, mais l'idée que cette demande est non seulement lourde, mais également limitée dans son utilisation uniquement par étapes sur des mois entiers, n'a pas donné de répit. </p><br><p>  <strong>Option 2</strong> <br>  Après un certain temps, j'ai réalisé que la génération de date séquentielle est essentiellement une procédure récursive.  Seulement pas dans sa forme pure, car dans notre cas, le calcul de la prochaine date à partir de la précédente conduit au problème d'origine.  Mais à chaque étape, nous pouvons augmenter l'intervalle ajouté au début de notre période: </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/*    -,     timestamp */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">recursive</span></span> dates <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-31'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt1, <span class="hljs-string"><span class="hljs-string">'2018-05-31'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt2, <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 month'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> ), <span class="hljs-comment"><span class="hljs-comment">/*           ,          ,   .  ,        */</span></span> pr <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> i, (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt1 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> i+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> i, ( (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt1 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates) + ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates)*i)::<span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pr <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ( ((<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt1 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates) + (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates)*i)::<span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span>) &lt;=(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt2 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates) ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pr;</code> </pre> <br><table><thead><tr><th>  gs </th></tr></thead><tbody><tr><td>  31/01/2018 </td></tr><tr><td>  28/02/2018 </td></tr><tr><td>  31/03/2018 </td></tr><tr><td>  30/04/2018 </td></tr><tr><td>  31/05/2018 </td></tr></tbody></table><br><p>  Cette requête fonctionne correctement avec toutes les périodes et intervalles d'entrée. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr421969/">https://habr.com/ru/post/fr421969/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr421959/index.html">Que faire lorsque «ceci» perd le lien de contexte</a></li>
<li><a href="../fr421961/index.html">Création d'une démo pour un ancien téléphone - AONDEMO</a></li>
<li><a href="../fr421963/index.html">Tenue de livres et comptable: leur rôle dans l'organisation</a></li>
<li><a href="../fr421965/index.html">«En plus de travailler, je travaille toujours» - 10 questions pour le programmeur, troisième édition</a></li>
<li><a href="../fr421967/index.html">Jouet pour enfants sur les éléments logiques</a></li>
<li><a href="../fr421971/index.html">Le russe natif de Xorg chez rdesktop est une bagatelle, mais agréable</a></li>
<li><a href="../fr421975/index.html">Nouvelles fonctionnalités de FLProg - ESP8266 en tant que contrôleur, pas en tant que modem</a></li>
<li><a href="../fr421977/index.html">GPS sous-marin sur deux émetteurs-récepteurs</a></li>
<li><a href="../fr421979/index.html">Thème Dracula - un thème universel pour presque tout</a></li>
<li><a href="../fr421983/index.html">L'apprentissage automatique aidera à réduire la population de glossines afin de réduire l'incidence de la maladie du sommeil</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>