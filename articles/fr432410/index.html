<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😘 👨‍👨‍👧 👩🏿‍💼 Entités de style DDD avec Entity Framework Core 🖲️ 🐨 ⤴️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article explique comment appliquer les principes DDD (Domain-Driven Design) aux classes que le Entity Framework Core (EF Core) mappe à la base de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Entités de style DDD avec Entity Framework Core</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432410/">  Cet article explique comment appliquer les principes DDD (Domain-Driven Design) aux classes que le Entity Framework Core (EF Core) mappe à la base de données, et pourquoi cela peut être utile. <br><br><h3>  TLDR </h3><br>  L'approche DDD présente de nombreux avantages, mais l'essentiel est que DDD transfère le code des opérations de création / modification à l'intérieur de la classe d'entité.  Cela réduit considérablement les chances d'un développeur de mal comprendre / interpréter les règles de création, d'initialisation et d'utilisation des instances de classe. <br><a name="habracut"></a><br><ol><li>  Le livre d'Eric Evans et ses discours n'ont pas beaucoup d'informations à ce sujet: </li><li>  Fournir au client un modèle simple pour obtenir des objets persistants (classes) et gérer son cycle de vie. </li><li>  Vos classes d'entités doivent indiquer explicitement si elles peuvent être modifiées, comment et par quelles règles. </li><li> Dans DDD, il y a le concept d'agrégat.  L'agrégat est un arbre d'entités liées.  Selon les règles DDD, le travail avec les agrégats doit être effectué via la «racine d'agrégation» (l'essence racine de l'arbre). </li></ol><br>  Eric mentionne les référentiels dans ses discours.  Je ne recommande pas d'implémenter un référentiel avec EF Core, car EF implémente déjà le référentiel et l'unité de travail en soi.  Je vais vous en dire plus à ce sujet dans un article séparé, " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cela vaut-il la peine d'utiliser un référentiel avec EF Core</a> ?" <br><br><h3>  Entités de style DDD </h3><br>  Je vais commencer par montrer le code d'entité dans le style DDD, puis le comparer avec la façon dont les entités avec EF Core sont généralement créées (note du traducteur. L'auteur appelle le mot «généralement» un modèle anémique.) Pour cet exemple, j'utiliserai la base de données Internet librairie (une version très simplifiée d'Amazon. »La structure de la base de données est illustrée dans l'image ci-dessous. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7e3/03d/4be/7e303d4bea08c1f34afa0d9848a2ff72.png" alt="image"><br><br>  Les quatre premiers tableaux représentent tout sur les livres: les livres eux-mêmes, leurs auteurs, les critiques.  Les deux tableaux ci-dessous sont utilisés dans le code logique métier.  Cette rubrique est décrite en détail dans un article séparé. <br><blockquote>  Tout le code de cet article a été téléchargé dans le référentiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GenericBizRunner sur GitHub</a> .  En plus du code de bibliothèque GenericBizRunner, il existe un autre exemple d'application ASP.NET Core qui utilise GenericBizRunner pour travailler avec la logique métier.  Pour en savoir plus, consultez l'article « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bibliothèque pour travailler avec la logique métier et Entity Framework Core</a> ». </blockquote>  Et voici le code d'entité correspondant à la structure de la base de données. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Book</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PromotionalTextLength = <span class="hljs-number"><span class="hljs-number">200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BookId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//… all other properties have a private set //These are the DDD aggregate propties: Reviews and AuthorLinks public IEnumerable&lt;Review&gt; Reviews =&gt; _reviews?.ToList(); public IEnumerable&lt;BookAuthor&gt; AuthorsLink =&gt; _authorsLink?.ToList(); //private, parameterless constructor used by EF Core private Book() { } //public constructor available to developer to create a new book public Book(string title, string description, DateTime publishedOn, string publisher, decimal price, string imageUrl, ICollection&lt;Author&gt; authors) { //code left out } //now the methods to update the book's properties public void UpdatePublishedOn(DateTime newDate)… public IGenericErrorHandler AddPromotion(decimal newPrice, string promotionalText)… public void RemovePromotion()… //now the methods to update the book's aggregates public void AddReview(int numStars, string comment, string voterName, DbContext context)… public void RemoveReview(Review review)… }</span></span></code> </pre> <br>  Que rechercher: <br><br><ol><li>  Ligne 5: définissez l'accès à toutes les propriétés d'entité déclarées privées.  Cela signifie que les données peuvent être modifiées à l'aide du constructeur ou à l'aide des méthodes publiques décrites plus loin dans cet article. </li><li>  Lignes 9 et 10. Les collections associées (les mêmes agrégats de DDD) fournissent un accès public à IEnumerable &lt;T&gt;, pas à ICollection &lt;T&gt;.  Cela signifie que vous ne pouvez pas ajouter ou supprimer directement des éléments de la collection.  Vous devrez utiliser des méthodes spécialisées de la classe Livre. </li><li>  Ligne 13. EF Core nécessite un constructeur sans paramètre, mais il peut avoir un accès privé.  Cela signifie que d'autres codes d'application ne pourront pas contourner l'initialisation et créer des instances de classes à l'aide d'un constructeur non paramétrique (commentaire d'un traducteur. À moins bien sûr que vous ne créiez des entités en utilisant uniquement la réflexion) </li><li>  Lignes 16-20: La seule façon de créer une instance de la classe Book est d'utiliser le constructeur public.  Ce constructeur contient toutes les informations nécessaires pour initialiser l'objet.  Ainsi, l'objet est garanti d'être dans un état valide. </li><li>  Lignes 23-25: ces lignes contiennent des méthodes pour changer l'état d'un livre. </li><li>  Lignes 28-29: ces méthodes vous permettent de modifier les entités liées (agrégats) </li></ol><br>  Pour les méthodes des lignes 23 à 39, je continuerai d'appeler les «méthodes qui fournissent l'accès».  Ces méthodes sont le seul moyen de modifier les propriétés et les relations au sein d'une entité.  L'essentiel est que la classe Book est "fermée".  Il est créé par un constructeur spécial et ne peut être modifié que partiellement par des méthodes spéciales avec des noms appropriés.  Cette approche crée un contraste frappant avec l'approche standard de création / modification d'entités dans EF Core, dans laquelle toutes les entités contiennent un constructeur par défaut vide et toutes les propriétés sont déclarées publiques.  La question suivante est: pourquoi la première approche est-elle meilleure? <br><br><h3>  Comparaison de la création d'entités </h3><br>  Comparons le code pour obtenir des données sur plusieurs livres de json et créer des instances des classes Book sur leur base. <br><br><h3>  a.  Approche standard </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> price = (<span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span>) (bookInfoJson.saleInfoListPriceAmount ?? DefaultBookPrice) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book { Title = bookInfoJson.title, Description = bookInfoJson.description, PublishedOn = DecodePubishDate(bookInfoJson.publishedDate), Publisher = bookInfoJson.publisher, OrgPrice = price, ActualPrice = price, ImageUrl = bookInfoJson.imageLinksThumbnail }; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; book.AuthorsLink = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;BookAuthor&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> author <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bookInfoJson.authors) { book.AuthorsLink.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BookAuthor { Book = book, Author = authorDict[author], Order = i++ }); }</code> </pre><br><h3>  b.  Style DDD </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authors = bookInfoJson.authors.Select(x =&gt; authorDict[x]).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book(bookInfoJson.title, bookInfoJson.description, DecodePubishDate(bookInfoJson.publishedDate), bookInfoJson.publisher, ((<span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span>?)bookInfoJson.saleInfoListPriceAmount) ?? DefaultBookPrice, bookInfoJson.imageLinksThumbnail, authors);</code> </pre><br>  Code constructeur de classe de livre <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Book</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> title, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> description, DateTime publishedOn, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> publisher, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">decimal</span></span></span></span><span class="hljs-function"><span class="hljs-params"> price, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> imageUrl, ICollection&lt;Author&gt; authors</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(title)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(title)); Title = title; Description = description; PublishedOn = publishedOn; Publisher = publisher; ActualPrice = price; OrgPrice = price; ImageUrl = imageUrl; _reviews = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;Review&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (authors == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || !authors.Any()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException( <span class="hljs-string"><span class="hljs-string">"You must have at least one Author for a book"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(authors)); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> order = <span class="hljs-number"><span class="hljs-number">0</span></span>; _authorsLink = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;BookAuthor&gt;( authors.Select(a =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BookAuthor(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, a, order++))); }</code> </pre><br>  Que rechercher: <br><br><ol><li>  Lignes 1-2: le constructeur vous oblige à passer toutes les données nécessaires à une bonne initialisation. </li><li>  Lignes 5, 6 et 17-9: le code contient plusieurs vérifications des règles métier.  Dans ce cas particulier, une violation des règles est considérée comme une erreur dans le code, par conséquent, en cas de violation, une exception sera levée.  Si l'utilisateur pouvait corriger ces erreurs, j'utiliserais peut-être une fabrique statique qui renvoie Status &lt;T&gt; (traducteur de commentaires. J'utiliserais Option &lt;T&gt; ou Result &lt;T&gt;, comme nom plus courant).  Le statut est un type qui renvoie une liste d'erreurs. </li><li>  Lignes 21-23: la liaison BookAuthor est créée dans le constructeur.  Le constructeur BookAuthor peut être déclaré avec le niveau d'accès interne.  De cette façon, nous pouvons empêcher la création de relations en dehors du DAL. </li></ol><br>  Comme vous l'avez peut-être remarqué, la quantité de code pour créer une entité est approximativement la même dans les deux cas.  Alors, pourquoi le style DDD est-il meilleur?  Le style DDD est meilleur en ce sens: <br><br><ol><li>  Contrôle l'accès.  Le changement accidentel de propriété est exclu.  Tout changement se produit via le constructeur ou la méthode publique avec le nom correspondant.  Évidemment ce qui se passe. </li><li>  Correspond à SEC (ne vous répétez pas).  Vous devrez peut-être créer des instances Book à plusieurs endroits.  Le code d'affectation est dans le constructeur et vous n'avez pas à le répéter à plusieurs endroits. </li><li>  Cache la complexité.  La classe Book a deux propriétés: ActualPrice et OrgPrice.  Ces deux valeurs doivent être égales lors de la création d'un nouveau livre.  Dans une approche standard, chaque développeur doit en être conscient.  Dans l'approche DDD, il suffit que le développeur de la classe Book en soit informé.  Les autres apprendront cette règle car elle est explicitement écrite dans le constructeur. </li><li>  Masque la création d'agrégats.  Dans une approche standard, le développeur doit créer manuellement une instance de BookAuthor.  Dans le style DDD, cette complexité est encapsulée pour le code appelant. </li><li>  Permet aux propriétés d'avoir un accès en écriture privé </li><li>  L'une des raisons d'utiliser DDD est de verrouiller l'entité, c'est-à-dire  Ne donnez pas la possibilité de modifier directement les propriétés.  Comparons l'opération de modification avec et sans DDD. </li></ol><br><h3>  Comparaison des changements de propriété </h3><br>  Eric Evans appelle l'un des principaux avantages des entités de style DDD: «Elles communiquent les décisions de conception concernant l'accès aux objets». <br><blockquote>  Remarque  traducteur.  La phrase originale est difficile à traduire en russe.  Dans ce cas, les décisions de conception sont des décisions prises sur le fonctionnement du logiciel.  Cela signifie que les décisions ont été discutées et confirmées.  Le code avec des constructeurs qui initialisent correctement des entités et des méthodes avec des noms corrects qui reflètent la signification des opérations indique explicitement au développeur que les affectations de certaines valeurs ont été faites avec intention, et non par erreur, et ne sont pas le caprice d'un autre développeur ou les détails de mise en œuvre. </blockquote>  Je comprends cette phrase comme suit. <br><br><ol><li>  Indiquez clairement comment modifier les données au sein d'une entité et quelles données doivent changer ensemble. </li><li>  Indiquez clairement quand vous ne devez pas modifier certaines données dans l'entité. </li></ol>  Comparons les deux approches.  Le premier exemple est simple et le second est plus compliqué. <br><br><h3>  1. Changement de date de publication </h3><br>  Supposons que nous voulons d'abord travailler avec un brouillon d'un livre et ensuite seulement le publier.  Au moment de la rédaction de l'ébauche, une date de publication estimée est fixée, qui sera très probablement modifiée au cours du processus d'édition.  Pour stocker la date de publication, nous utiliserons la propriété PublishedOn. <br><br><h3>  a.  Entité avec des propriétés publiques </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = context.Find&lt;Book&gt;(dto.BookId); book.PublishedOn = dto.PublishedOn; context.SaveChanges();</code> </pre><br><h3>  b.  Entité de style DDD </h3><br>  Dans le style DDD, le setter de la propriété est déclaré privé, nous allons donc utiliser une méthode d'accès spécialisée. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = context.Find&lt;Book&gt;(dto.BookId); book.UpdatePublishedOn( dto.PublishedOn); context.SaveChanges();</code> </pre><br>  Ces deux cas sont presque les mêmes.  La version DDD est encore un peu plus longue.  Mais il y a encore une différence.  Dans le style DDD, vous savez avec certitude que la date de publication peut être modifiée car il existe une méthode avec un nom évident.  Vous savez également que vous ne pouvez pas modifier l'éditeur car la propriété Publisher n'a pas de méthode appropriée à modifier.  Ces informations seront utiles à tout programmeur travaillant avec une classe de livres. <br><br><h3>  2. Gérez la remise pour le livre </h3><br>  Une autre exigence est que nous devons être en mesure de gérer les remises.  La remise consiste en un nouveau prix et un commentaire, par exemple, "50% avant la fin de cette semaine!" <br><br>  La mise en œuvre de cette règle est simple, mais pas trop évidente. <br><br><ol><li>  La propriété OrgPrice est le prix sans remise. </li><li>  Prix ​​réel - Prix actuel auquel le livre est vendu.  Si la remise est valide, le prix actuel sera différent de OrgPrice par la taille de la remise.  Sinon, la valeur des propriétés sera égale. </li><li>  La propriété PromotionText doit contenir le texte de remise si la remise est appliquée ou null si la remise n'est pas actuellement appliquée. </li></ol><br>  Les règles sont assez évidentes pour la personne qui les a mises en œuvre.  Cependant, pour un autre développeur, par exemple, développer une interface utilisateur pour ajouter une remise.  L'ajout des méthodes AddPromotion et RemovePromotion à la classe d'entité masque les détails d'implémentation.  Maintenant, un autre développeur a des méthodes publiques avec les noms correspondants.  La sémantique de l'utilisation des méthodes est évidente. <br><br>  Jetez un œil à l'implémentation des méthodes AddPromotion et RemovePromotion. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IGenericErrorHandler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPromotion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">decimal</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newPrice, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> promotionalText</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> status = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericErrorHandler(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(promotionalText)) { status.AddError( <span class="hljs-string"><span class="hljs-string">"You must provide some text to go with the promotion."</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(PromotionalText)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status; } ActualPrice = newPrice; PromotionalText = promotionalText; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status; }</code> </pre><br>  Que rechercher: <br><br><ol><li>  Lignes 4-10: l'ajout d'un commentaire PromotionalText est requis.  La méthode vérifie que le texte n'est pas vide.  Parce que  L'utilisateur peut corriger cette erreur. La méthode renvoie une liste d'erreurs à corriger. </li><li>  Lignes 12, 13: la méthode fixe les valeurs des propriétés en fonction de l'implémentation que le développeur a choisie.  L'utilisateur de la méthode AddPromotion n'a pas besoin de les connaître.  Pour ajouter une remise, écrivez simplement: </li></ol><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = context.Find&lt;Book&gt;(dto.BookId); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> status = book.AddPromotion(newPrice, promotionText); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!status.HasErrors) context.SaveChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status;</code> </pre><br>  La méthode RemovePromotion est beaucoup plus simple: elle n'implique pas de gestion des erreurs.  Par conséquent, la valeur de retour est simplement nulle. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemovePromotion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ActualPrice = OrgPrice; PromotionalText = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre><br>  Ces deux exemples sont très différents l'un de l'autre.  Dans le premier exemple, la modification de la propriété PublishOn est si simple que l'implémentation standard est correcte.  Dans le deuxième exemple, les détails de l'implémentation ne sont pas évidents pour quelqu'un qui n'a pas travaillé avec la classe Book.  Dans le second cas, le style DDD avec des méthodes d'accès spécialisées masque les détails de mise en œuvre et facilite la vie des autres développeurs.  En outre, dans le deuxième exemple, le code contient une logique métier.  Bien que la quantité de logique soit petite, nous pouvons la stocker directement dans les méthodes d'accès et renvoyer une liste d'erreurs si la méthode n'est pas utilisée correctement. <br><br><h3>  3. Travailler avec l'agrégat - Revues de la collection de propriétés </h3><br>  DDD propose de travailler avec l'unité uniquement via la racine.  Dans notre cas, la propriété Reviews crée des problèmes.  Même si setter est déclaré privé, le développeur peut toujours ajouter ou supprimer des objets à l'aide des méthodes add et remove, ou même appeler la méthode clear pour effacer la collection entière.  Ici, la nouvelle fonctionnalité EF Core, les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">champs de support,</a> nous aidera. <br><br>  Le champ de support permet au développeur d'encapsuler la collection réelle et de fournir un accès public au lien d'interface IEnumerable &lt;T&gt;.  L'interface IEnumerable &lt;T&gt; ne fournit pas de méthodes d'ajout, de suppression ou d'effacement.  Dans le code ci-dessous est un exemple d'utilisation des champs de sauvegarde. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Book</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> HashSet&lt;Review&gt; _reviews; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IEnumerable&lt;Review&gt; Reviews =&gt; _reviews?.ToList(); <span class="hljs-comment"><span class="hljs-comment">//… rest of code not shown }</span></span></code> </pre><br>  Pour que cela fonctionne, vous devez indiquer à EF Core que lors de la lecture à partir de la base de données, vous devez écrire dans un champ privé, pas une propriété publique.  Le code de configuration est illustré ci-dessous. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnModelCreating</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ModelBuilder modelBuilder</span></span></span><span class="hljs-function">)</span></span> { modelBuilder.Entity&lt;Book&gt;() .FindNavigation(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Book.Reviews)) .SetPropertyAccessMode(PropertyAccessMode.Field); <span class="hljs-comment"><span class="hljs-comment">//… other non-review configurations left out }</span></span></code> </pre><br>  Pour travailler avec des revues, j'ai ajouté deux méthodes: AddReview et RemoveReview à la classe de livres.  La méthode AddReview est plus intéressante.  Voici son code: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddReview</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> numStars, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> comment, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> voterName, DbContext context = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_reviews != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _reviews.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Review(numStars, comment, voterName)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(context), <span class="hljs-string"><span class="hljs-string">"You must provide a context if the Reviews collection isn't valid."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context.Entry(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).IsKeySet) { context.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Review(numStars, comment, voterName, BookId)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Could not add a new review."</span></span>); } }</code> </pre><br>  Que rechercher: <br><br><ol><li>  Lignes 4-7: Je n'initialise pas intentionnellement le champ _reviews dans un constructeur privé sans paramètre qu'EF Core utilise lors du chargement d'entités à partir de la base de données.  Cela permet à mon code de déterminer si la collection a été chargée à l'aide de la méthode .Include (p =&gt; p.Reviews).  Dans le constructeur public, j'initialise le champ, donc NRE ne se produira pas lorsque vous travaillerez avec l'entité créée. </li><li>  Lignes 8-12: si la collection Reviews n'a pas été chargée, le code doit utiliser DbContext pour s'initialiser. </li><li>  Lignes 13-16: Si le livre a été créé avec succès et contient un ID, j'utilise une autre technique pour ajouter une révision: j'installe simplement la clé étrangère dans une instance de la classe Review et l'écris dans la base de données.  Ceci est décrit plus en détail dans la section 3.4.5 de mon livre. </li><li>  Ligne 19: Si nous sommes ici, il y a une sorte de problème avec la logique du code.  Je lève donc une exception. </li></ol><br>  J'ai conçu toutes mes méthodes d'accès pour les cas inversés où seule l'entité racine est chargée.  La mise à jour de l'unité est à la discrétion des méthodes.  Vous devrez peut-être charger des entités supplémentaires. <br><br><h3>  Conclusion </h3><br>  Pour créer des entités dans le style DDD avec EF Core, vous devez respecter les règles suivantes: <br><br><ol><li>  Créez des constructeurs publics pour créer des instances de classe correctement initialisées.  Si des erreurs peuvent se produire pendant le processus de création que l'utilisateur peut corriger, créez l'objet non pas à l'aide du constructeur public, mais à l'aide de la méthode d'usine qui renvoie Status &lt;T&gt;, où T est le type d'entité en cours de création </li><li>  Toutes les propriétés sont des créateurs de biens.  C'est-à-dire  toutes les propriétés sont en lecture seule en dehors de la classe. </li><li>  Pour les propriétés de navigation de collection, déclarez les champs de sauvegarde et le type de propriété publique déclarez IEnumerable &lt;T&gt;.  Cela empêchera les autres développeurs de modifier les collections de manière incontrôlable. </li><li>  Au lieu de setters publics, créez des méthodes publiques pour toutes les opérations de changement d'objet autorisées.  Ces méthodes doivent retourner null si l'opération ne peut pas échouer avec une erreur que l'utilisateur peut corriger ou Status &lt;T&gt; si c'est le cas. </li><li>  L'étendue de la responsabilité de l'entité est importante.  Je pense qu'il est préférable de limiter les entités à changer la classe elle-même et d'autres classes à l'intérieur de l'agrégat, mais pas à l'extérieur.  Les règles de validation devraient se limiter à vérifier l'exactitude de la création et du changement d'état des entités.  C'est-à-dire  Je ne vérifie pas les règles commerciales telles que les soldes de stock.  Il existe un code logique métier spécial pour cela. </li><li>  Les méthodes de changement d'état doivent supposer que seule la racine d'agrégation est chargée.  Si une méthode doit charger d'autres données, elle doit s'en occuper seule. </li><li>  Les méthodes de changement d'état doivent supposer que seule la racine d'agrégation est chargée.  Si une méthode doit charger d'autres données, elle doit s'en occuper seule.  Cette approche simplifie l'utilisation des entités par d'autres développeurs. </li></ol><br><h3>  Avantages et inconvénients des entités DDD lorsque vous travaillez avec EF Core </h3><br>  J'aime l'approche critique de n'importe quel modèle ou architecture.  Voici ce que je pense de l'utilisation des entités DDD. <br><br><h3>  Avantages </h3><br><ol><li>  L'utilisation de méthodes spécialisées pour changer d'état est une approche plus propre.  C'est certainement une bonne solution, tout simplement parce que les méthodes correctement nommées révèlent bien mieux les intentions du code et rendent évident ce qui peut et ne peut pas être changé.  De plus, les méthodes peuvent renvoyer une liste d'erreurs si l'utilisateur peut les corriger. </li><li>  La modification des agrégats uniquement via la racine fonctionne également bien </li><li>  Les détails de la relation un-à-plusieurs entre les classes Book et Review sont désormais masqués pour l'utilisateur.  L'encapsulation est un principe de base de la POO. </li><li>  L'utilisation de constructeurs spécialisés vous permet de vous assurer que les entités sont créées et garanties d'être correctement initialisées. </li><li>  Déplacer le code d'initialisation vers le constructeur réduit considérablement la probabilité que le développeur n'interprète pas correctement la façon dont la classe doit être initialisée. </li></ol><br><h3>  Inconvénients </h3><br><ol><li>  Mon approche contient des dépendances sur l'implémentation d'EF Core. </li><li>  Certaines personnes l'appellent même un anti-modèle.  Le problème est que maintenant les entités du modèle sujet dépendent du code d'accès à la base de données.  En termes de DDD, c'est mauvais.  J'ai réalisé que si je ne l'avais pas fait, j'aurais dû compter sur l'appelant pour savoir ce qui devait être chargé.  Cette approche rompt le principe de la séparation des préoccupations. </li><li>  DDD vous oblige à écrire plus de code. </li></ol><br>  Cela vaut-il vraiment la peine dans des cas simples, comme la mise à jour de la date de publication d'un livre? <br>  Comme vous pouvez le voir, j'aime l'approche DDD.  Cependant, il m'a fallu un certain temps pour le structurer correctement, mais pour le moment l'approche est déjà réglée et je l'applique dans les projets sur lesquels je travaille.  J'ai déjà réussi à essayer ce style dans les petits projets et je suis satisfait, mais tous les avantages et les inconvénients restent à découvrir lorsque je l'utilise dans les grands projets. <br><br>  Ma décision d'autoriser l'utilisation de code spécifique à EFCore dans les arguments des méthodes d'entité du modèle d'entité n'a pas été simple.  J'ai essayé d'empêcher cela, mais à la fin je suis arrivé à la conclusion que le code appelant devait charger beaucoup de propriétés de navigation.  Et si cela n'est pas fait, le changement ne sera tout simplement pas appliqué sans erreur (en particulier dans une relation un-à-un).  Ce n'était pas acceptable pour moi, j'ai donc autorisé l'utilisation d'EF Core dans certaines méthodes (mais pas les constructeurs). <br><br>  Un autre inconvénient est que DDD vous oblige à écrire beaucoup plus de code pour les opérations CRUD.  Je ne sais toujours pas s'il faut continuer à manger un cactus et écrire des méthodes distinctes pour toutes les propriétés, ou dans certains cas, cela vaut la peine de s'éloigner d'un puritanisme si radical.  Je sais qu'il n'y a qu'un chariot et un petit camion de CRUD ennuyeux, ce qui est plus facile à écrire directement.  Seul le travail sur de vrais projets montrera lequel est le meilleur. <br><br><h3>  Autres aspects DDD non traités dans cet article </h3><br>  L'article s'est avéré trop long, je vais donc terminer ici.  Mais cela signifie qu'il y a encore beaucoup de documents non divulgués.  J'ai déjà écrit quelque chose, quelque chose que j'écrirai dans un avenir proche.  Voici ce qui reste à la mer: <br><br><ol><li>  <b>Logique métier et DDD.</b>  J'utilise les concepts DDD dans le code logique métier depuis plusieurs années et, en utilisant les nouvelles fonctionnalités d'EF Core, je m'attends à pouvoir transférer une partie de la logique au code entité.  Lire l'article «Encore une fois sur l'architecture de la couche logique métier avec Entity Framework (Core et v6)» </li><li>  <b>DDD et le modèle de référentiel.</b>  Eric Evans recommande d'utiliser un référentiel afin d'abstraire l'accès aux données.    ,    «»   EF Core –  .  Pourquoi?   -  . </li><li> <b> DBContext' /   (bounded contexts).</b>          DbContext'. ,   BookContext      Book        OrderContext,   . ,  « »  ,      .         ,         . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout le code de cet article est disponible dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le référentiel GenericBizRunner sur GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ce référentiel contient un exemple d'application ASP.NET Core avec des méthodes d'accès spécialisées pour modifier la classe Book. </font><font style="vertical-align: inherit;">Vous pouvez cloner le référentiel et exécuter l'application localement. </font><font style="vertical-align: inherit;">Il utilise Sqlite en mémoire comme base de données, il doit donc fonctionner sur n'importe quelle infrastructure. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bon développement!</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr432410/">https://habr.com/ru/post/fr432410/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es436938/index.html">Guix es el sistema operativo más avanzado.</a></li>
<li><a href="../fr432400/index.html">CS: GO est maintenant gratuit</a></li>
<li><a href="../fr432402/index.html">Hé HR, où est mon souvenir?</a></li>
<li><a href="../fr432404/index.html">La sauvegarde pour Linux n'écrit pas de lettres</a></li>
<li><a href="../fr432408/index.html">Fintech digest: préparation pour déconnecter les petites banques de Visa et Mastercard, un calculateur de pension et pas seulement</a></li>
<li><a href="../fr432412/index.html">Highload ++: Comment aider le système ERP à faire face à 500 000 requêtes par seconde</a></li>
<li><a href="../fr432414/index.html">De vieux secrets au débogage rapide: animation du code source</a></li>
<li><a href="../fr432416/index.html">Types dépendants - L'avenir des langages de programmation</a></li>
<li><a href="../fr432418/index.html">Analyser des expressions lambda en Java</a></li>
<li><a href="../fr432420/index.html">Introduction à Git Merge et Git Rebase: pourquoi et quand les utiliser</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>