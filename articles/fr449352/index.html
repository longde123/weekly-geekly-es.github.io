<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶Ñ üö≥ üëè Comment nous avons construit la surveillance sur Prometheus, Clickhouse et ELK ü§® üë©üèΩ‚Äçüè´ ü¶ë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je m'appelle Anton Baderin. Je travaille au Center for High Technologies et je suis engag√© dans l'administration syst√®me. Il y a un mois, notre conf√©r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons construit la surveillance sur Prometheus, Clickhouse et ELK</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449352/"><p>  Je m'appelle Anton Baderin.  Je travaille au Center for High Technologies et je suis engag√© dans l'administration syst√®me.  Il y a un mois, notre conf√©rence d'entreprise s'est termin√©e, o√π nous avons partag√© notre exp√©rience avec la communaut√© informatique de notre ville.  J'ai parl√© de la surveillance des applications Web.  Le mat√©riel √©tait destin√© au niveau junior ou interm√©diaire, qui n'a pas construit ce processus √† partir de z√©ro. </p><br><p><img src="https://habrastorage.org/webt/uj/x8/ej/ujx8ej4lg5vvhtvxczpnxnq4xkm.jpeg" alt="image"></p><br><p>  La pierre angulaire de tout syst√®me de surveillance est la solution aux probl√®mes commerciaux.  La surveillance √† des fins de surveillance n'a d'int√©r√™t pour personne.  Que veut l'entreprise?  Pour que tout fonctionne rapidement et sans erreur.  Les entreprises veulent de la proactivit√©, afin que nous puissions nous-m√™mes identifier les probl√®mes du service et les √©liminer le plus rapidement possible.  C'est en effet la t√¢che que j'ai r√©solue toute l'ann√©e derni√®re sur le projet d'un de nos clients. </p><a name="habracut"></a><br><h2 id="o-proekte">  √Ä propos du projet </h2><br><p>  Le projet est l'un des plus importants programmes de fid√©lisation du pays.  Nous aidons les d√©taillants √† augmenter leur fr√©quence de vente gr√¢ce √† divers outils marketing tels que les cartes bonus.  Au total, le projet comprend 14 applications qui s'ex√©cutent sur dix serveurs. </p><br><p>  Au cours des entretiens, j'ai remarqu√© √† plusieurs reprises que les administrateurs ne sont pas toujours les bons pour surveiller les applications Web: jusqu'√† pr√©sent, beaucoup s'attardent sur les m√©triques du syst√®me d'exploitation et surveillent parfois les services. </p><br><p>  Dans mon cas, Icinga √©tait la base du syst√®me de suivi des clients auparavant.  Elle n'a pas r√©solu les probl√®mes ci-dessus.  Souvent, le client lui-m√™me nous a inform√©s des probl√®mes et au moins nous n'avions tout simplement pas assez de donn√©es pour aller au fond de la raison. </p><br><p>  En outre, on comprenait clairement la futilit√© de son d√©veloppement ult√©rieur.  Je pense que ceux qui connaissent Icinga me comprendront.  Nous avons donc d√©cid√© de repenser compl√®tement le syst√®me de surveillance des applications Web du projet. </p><br><h2 id="prometheus">  Prom√©th√©e </h2><br><p>  Nous avons choisi Prometheus en fonction de trois indicateurs cl√©s: </p><br><ol><li>  Un grand nombre de m√©triques disponibles.  Dans notre cas, il y en a 60 000.  Bien s√ªr, il convient de noter que la grande majorit√© d'entre eux que nous n'utilisons pas (probablement environ 95%).  En revanche, ils sont tous relativement bon march√©.  Pour nous, c'est un autre extr√™me par rapport √† Icinga pr√©c√©demment utilis√©.  Dans ce document, l'ajout de m√©triques √©tait une douleur particuli√®re: celles disponibles √©taient co√ªteuses (il suffit de regarder le code source de tout plugin).  Tout plug-in √©tait un script Bash ou Python, dont le lancement n'est pas bon march√© en termes de ressources consomm√©es. </li><li>  Ce syst√®me consomme une quantit√© relativement faible de ressources.  Toutes nos mesures ont 600 Mo de RAM, 15% d'un c≈ìur et quelques dizaines d'IOPS.  Bien s√ªr, vous devez ex√©cuter des exportateurs de m√©triques, mais elles sont toutes √©crites en Go et ne diff√®rent pas non plus en gloutonnerie.  Je ne pense pas que dans les r√©alit√©s modernes, ce soit un probl√®me. </li><li>  Il permet de passer √† Kubernetes.  Compte tenu des plans du client, le choix est √©vident. </li></ol><br><h2 id="elk">  ELK </h2><br><p>  Auparavant, nous ne collections ni ne traitions les journaux.  Les d√©fauts sont clairs pour tout le monde.  Nous avons choisi ELK, car nous avions d√©j√† de l'exp√©rience avec ce syst√®me.  Nous n'y stockons que des journaux d'application.  Les principaux crit√®res de s√©lection √©taient la recherche en texte int√©gral et sa rapidit√©. </p><br><h2 id="slickhouse">  Clickhouse </h2><br><p>  Au d√©part, le choix s'est port√© sur InfluxDB.  Nous avons reconnu la n√©cessit√© de collecter les journaux Nginx, les statistiques de pg_stat_statements et de stocker les donn√©es historiques de Prometheus.  Nous n'aimions pas Influx, car il commen√ßait p√©riodiquement √† consommer une grande quantit√© de m√©moire et se bloquait.  De plus, je voulais regrouper les demandes par remote_addr, et regrouper dans ce SGBD uniquement par balises.  Tags de la route (m√©moire), leur nombre est conditionnellement limit√©. </p><br><p>  Nous avons recommenc√© la recherche.  Nous avions besoin d'une base analytique avec une consommation de ressources minimale, de pr√©f√©rence avec une compression des donn√©es sur disque. </p><br><p>  Clickhouse r√©pond √† tous ces crit√®res et nous n'avons jamais regrett√© ce choix.  Nous n'y √©crivons aucune quantit√© de donn√©es en suspens (le nombre d'insertions n'est que d'environ cinq mille par minute). </p><br><h2 id="newrelic">  NewRelic </h2><br><p>  NewRelic a toujours √©t√© avec nous depuis que c'√©tait le choix du client.  Nous l'utilisons comme APM. </p><br><h2 id="zabbix">  Zabbix </h2><br><p>  Nous utilisons Zabbix exclusivement pour surveiller la Black Box de diverses API. </p><br><h2 id="opredelenie-podhoda-k-monitoringu">  D√©finir une approche de suivi </h2><br><p>  Nous voulions d√©composer la t√¢che et ainsi syst√©matiser l'approche de suivi. </p><br><p>  Pour ce faire, j'ai divis√© notre syst√®me selon les niveaux suivants: </p><br><ul><li>  Mat√©riel et VMS; </li><li>  syst√®me d'exploitation </li><li>  services syst√®me, pile logicielle; </li><li>  application </li><li>  logique m√©tier. </li></ul><br><p>  Ce qui rend cette approche pratique: </p><br><ul><li>  nous savons qui est responsable du travail de chacun des niveaux et, sur cette base, nous pouvons envoyer des alertes; </li><li>  nous pouvons utiliser la structure lors de la suppression d'alertes - il serait √©trange d'envoyer une alerte sur l'inaccessibilit√© de la base de donn√©es lorsque la machine virtuelle est g√©n√©ralement inaccessible. </li></ul><br><p>  √âtant donn√© que notre t√¢che consiste √† identifier les irr√©gularit√©s dans le syst√®me, nous devons √† chaque niveau s√©lectionner un certain ensemble de param√®tres auxquels vous devez pr√™ter attention lors de la r√©daction des r√®gles de l'alerte.  Ensuite, nous passerons par les niveaux de ¬´VMS¬ª, ¬´Syst√®me d'exploitation¬ª et ¬´Services syst√®me, pile logicielle¬ª. </p><br><h2 id="virtualnye-mashiny">  Machines virtuelles </h2><br><p>  L'h√©bergement nous donne un processeur, un disque, une m√©moire et un r√©seau.  Et avec les deux premiers, nous avons eu des probl√®mes.  Donc, les m√©triques: </p><br><p>  Temps vol√© du processeur - lorsque vous achetez une machine virtuelle sur Amazon (t2.micro, par exemple), vous devez comprendre que vous ne disposez pas d'un c≈ìur de processeur complet, mais uniquement d'un quota de son temps.  Et lorsque vous l'√©puiserez, le processeur vous sera retir√©. </p><br><p>  Cette m√©trique vous permet de suivre ces moments et de prendre des d√©cisions.  Par exemple, est-il n√©cessaire de prendre un tarif plus gros ou de r√©partir le traitement des t√¢ches et requ√™tes en arri√®re-plan dans l'API sur diff√©rents serveurs. </p><br><p>  IOPS + CPU iowait time - pour une raison quelconque, de nombreuses soci√©t√©s d'h√©bergement cloud p√®chent en ne fournissant pas IOPS.  De plus, un programme avec un faible IOPS n'est pas un argument pour eux.  Par cons√©quent, il vaut la peine de collecter le processeur iowait.  Avec cette paire de graphiques - avec des IOPS faibles et des attentes d'E / S √©lev√©es - vous pouvez d√©j√† parler √† l'h√©bergement et r√©soudre le probl√®me. </p><br><h2 id="operacionnaya-sistema">  Syst√®me d'exploitation </h2><br><p>  Mesures du syst√®me d'exploitation: </p><br><ul><li>  quantit√© de m√©moire disponible en%; </li><li>  activit√© utilisant swap: vmstat swapin, swapout; </li><li>  le nombre d'inodes disponibles et d'espace libre sur le syst√®me de fichiers en% </li><li>  charge moyenne; </li><li>  nombre de connexions dans deux √©tats; </li><li>  pl√©nitude de la table conntrack; </li><li>  la qualit√© du r√©seau peut √™tre surveill√©e √† l'aide de l'utilitaire ss, package iproute2 - recevez de sa sortie un indicateur des connexions RTT et regroupez par dest-port. </li></ul><br><p>  Toujours au niveau du syst√®me d'exploitation, nous avons une entit√© telle que les processus.  Il est important de mettre en √©vidence dans le syst√®me un ensemble de processus qui jouent un r√¥le important dans son travail.  Si, par exemple, vous avez plusieurs pgpool, vous devez collecter des informations pour chacun d'eux. </p><br><p>  L'ensemble des m√©triques est le suivant: </p><br><ul><li>  CPU </li><li>  la m√©moire est principalement r√©sidente; </li><li>  IO - de pr√©f√©rence dans IOPS; </li><li>  FileFd - ouvrir et limiter; </li><li>  √©checs de pages importants - afin que vous puissiez comprendre quel processus est en train de permuter. </li></ul><br><p>  Toute la surveillance est d√©ploy√©e dans Docker, nous utilisons advisor pour collecter des donn√©es m√©triques.  Sur d'autres machines, nous utilisons un exportateur de processus. </p><br><h2 id="sistemnye-servisy-stek-po">  Services syst√®me, pile de logiciels </h2><br><p>  Chaque application a ses propres sp√©cificit√©s et il est difficile de distinguer un ensemble de m√©triques. </p><br><p>  L'ensemble universel sont: </p><br><ul><li>  taux de demande; </li><li>  nombre d'erreurs; </li><li>  latence </li><li>  saturation. </li></ul><br><p>  Les exemples les plus frappants de surveillance √† ce niveau sont Nginx et PostgreSQL. </p><br><p>  Le service le plus charg√© de notre syst√®me est la base de donn√©es.  Nous avions souvent des probl√®mes pour comprendre ce que fait la base de donn√©es. </p><br><p>  Nous avons vu une charge √©lev√©e sur les disques, mais les slogans ne montraient vraiment rien.  Nous avons r√©solu ce probl√®me avec pg_stat_statements, une vue qui collecte des statistiques sur les demandes. </p><br><p>  C'est tout ce dont l'administrateur a besoin. </p><br><p>  Nous tra√ßons l'activit√© des requ√™tes de lecture et d'√©criture: </p><br><img src="https://habrastorage.org/webt/6r/fm/rp/6rfmrp9k711d0azcv7thr3bfapu.jpeg"><br><img src="https://habrastorage.org/webt/j7/dn/ki/j7dnki6of_-n3l33xe5mz9xapkk.jpeg"><br><p>  Tout est simple et clair, chaque demande a sa propre couleur. </p><br><p>  Un exemple tout aussi frappant est celui des journaux Nginx.  Sans surprise, peu les analyse ou les mentionne dans la liste des requis.  Le format standard n'est pas tr√®s informatif et doit √™tre √©tendu. </p><br><p>  Personnellement, j'ai ajout√© request_time, upstream_response_time, body_bytes_sent, request_length, request_id. Nous tra√ßons le temps de r√©ponse et le nombre d'erreurs: </p><br><img src="https://habrastorage.org/webt/3l/wp/cw/3lwpcwwdctrsk7mgnexjmxstsxq.jpeg"><br><img src="https://habrastorage.org/webt/zk/w9/ak/zkw9akpuwajs85xktgcm6wtar1m.jpeg"><br><p>  Nous tra√ßons le temps de r√©ponse et le nombre d'erreurs.  Tu te souviens?  Ai-je parl√© des objectifs commerciaux?  Pour rapidement et sans erreurs?  Nous avons d√©j√† r√©solu ces probl√®mes avec deux graphiques.  Et sur eux, vous pouvez d√©j√† appeler les administrateurs de garde. </p><br><p>  Mais un autre probl√®me subsistait: assurer l'√©limination rapide des causes de l'incident. </p><br><h2 id="ustranenie-incidentov">  Gestion des incidents </h2><br><p>  L'ensemble du processus, de l'identification √† la r√©solution d'un probl√®me, peut √™tre divis√© en plusieurs √©tapes: </p><br><ul><li>  identification des probl√®mes; </li><li>  notification de l'administrateur en service; </li><li>  r√©action √† l'incident; </li><li>  √©limination des causes. </li></ul><br><p>  Il est important que nous le fassions le plus rapidement possible.  Et si nous ne pouvons pas gagner beaucoup de temps aux √©tapes de l'identification d'un probl√®me et de l'envoi d'une notification - ils partiront en tout cas pendant deux minutes, alors les prochains ne sont qu'un champ vierge pour des am√©liorations. </p><br><p>  Imaginons simplement que le t√©l√©phone sonne en service.  Que va-t-il faire?  Recherchez les r√©ponses aux questions - qu'est-ce qui est cass√©, o√π est-il cass√©, comment r√©agir?  Voici comment nous r√©pondons √† ces questions: </p><br><img src="https://habrastorage.org/webt/p_/kj/wj/p_kjwjrqkewlj50zmcy1hz9cuju.jpeg"><br><p>  Nous incluons simplement toutes ces informations dans le texte de notification, nous lui donnons un lien vers une page wiki qui d√©crit comment r√©pondre √† ce probl√®me, comment le r√©soudre et escalader. </p><br><p>  Je n'ai toujours rien dit sur la couche application et la logique m√©tier.  Malheureusement, la collecte de m√©triques n'a pas encore √©t√© impl√©ment√©e dans nos applications.  La seule source d'au moins certaines informations de ces niveaux est les journaux. </p><br><p>  Quelques points. </p><br><p>  Tout d'abord, √©crivez des journaux structur√©s.  Pas besoin d'inclure le contexte dans le corps du message.  Il est donc difficile de les regrouper et de les analyser.  Logstash prend beaucoup de temps pour normaliser tout cela. </p><br><p>  Deuxi√®mement, utilisez correctement les niveaux de gravit√©.  Chaque langue a sa propre norme.  Personnellement, je distingue quatre niveaux: </p><br><ol><li>  aucune erreur; </li><li>  erreur c√¥t√© client; </li><li>  une erreur est de notre c√¥t√©, nous ne perdons pas d'argent, nous ne supportons pas de risques; </li><li>  l'erreur est de notre c√¥t√©, nous perdons de l'argent. </li></ol><br><p>  Je r√©sume.  Il est n√©cessaire d'essayer de construire une surveillance pr√©cis√©ment √† partir de la logique m√©tier.  Essayez de surveiller l'application elle-m√™me et de fonctionner avec des mesures telles que le nombre de ventes, le nombre d'inscriptions de nouveaux utilisateurs, le nombre d'utilisateurs actuellement actifs, etc. </p><br><p>  Si l'ensemble de votre entreprise est un seul bouton dans votre navigateur, vous devez v√©rifier s'il est compress√© et fonctionne correctement.  Tout le reste n'est pas important. </p><br><p>  Si vous ne l'avez pas, vous pouvez essayer de le rattraper dans les journaux d'application, les journaux Nginx, etc., comme nous l'avons fait.  Vous devez √™tre aussi proche que possible de l'application. </p><br><p>  Les m√©triques du syst√®me d'exploitation sont bien s√ªr importantes, mais elles ne sont pas int√©ressantes pour les entreprises, nous ne sommes pas pay√©s pour elles. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr449352/">https://habr.com/ru/post/fr449352/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr449342/index.html">Oracle al√©atoire bas√© sur la signature num√©rique de la blockchain</a></li>
<li><a href="../fr449344/index.html">Kodim - pizza</a></li>
<li><a href="../fr449346/index.html">MODX Digest # 4 (8-22 avril 2019)</a></li>
<li><a href="../fr449348/index.html">Buildroot - partie 2. Cr√©ation de la configuration de votre carte; application d'arborescence externe, superposition de rootfs, scripts post-build</a></li>
<li><a href="../fr449350/index.html">Keybase et vrai TOFU</a></li>
<li><a href="../fr449356/index.html">Processus d'entreprise. Extraction du mod√®le BPMN √† partir du document. Partie 1</a></li>
<li><a href="../fr449358/index.html">De nouvelles fronti√®res en physique</a></li>
<li><a href="../fr449360/index.html">Microsoft a adapt√© la r√©alit√© virtuelle pour les malvoyants</a></li>
<li><a href="../fr449362/index.html">UPS de soins de sant√©: Delta Electronics Health Experience</a></li>
<li><a href="../fr449364/index.html">Contexte: qu'est-ce que la livraison continue</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>