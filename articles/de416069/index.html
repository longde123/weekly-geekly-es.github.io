<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∏üèº üìá ü§öüèª Verlustfreie ElasticSearch-Datenmigration üëå üë∂ ‚õàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Das akademische Design des Data Warehouse empfiehlt, alles in einer normalisierten Form mit Verbindungen zwischen ihnen zu halten. Das Rollback von √Ñn...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Verlustfreie ElasticSearch-Datenmigration</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416069/"><p><img src="https://habrastorage.org/webt/1e/oc/om/1eocom45kcqgz65q-wneyoqopdg.jpeg"></p><br><p>  Das akademische Design des Data Warehouse empfiehlt, alles in einer normalisierten Form mit Verbindungen zwischen ihnen zu halten.  Das Rollback von √Ñnderungen in der relationalen Mathematik bietet dann ein zuverl√§ssiges Repository mit Transaktionsunterst√ºtzung.  Atomizit√§t, Konsistenz, Isolation, Haltbarkeit - das ist alles.  Mit anderen Worten, das Repository wurde speziell entwickelt, um Daten sicher zu aktualisieren.  Es ist jedoch √ºberhaupt nicht optimal f√ºr die Suche, insbesondere mit einer breiten Geste √ºber Tabellen und Felder hinweg.  Ben√∂tigen Sie Indizes, viele Indizes.  Das Volumen w√§chst, die Aufnahme verlangsamt sich.  SQL LIKE ist nicht indiziert und JOIN GROUP BY sendet es zur Meditation an den Abfrageplaner. </p><a name="habracut"></a><br><p>  Die zunehmende Belastung einer Maschine zwingt sie dazu, sich entweder vertikal in die Decke oder horizontal auszudehnen und ein paar weitere Knoten zu kaufen.  Durch Failover-Anforderungen werden Daten auf mehrere Knoten verteilt.  Das Erfordernis einer sofortigen Wiederherstellung nach einem Fehler ohne Denial-of-Service zwingt Sie dazu, den Maschinencluster so zu konfigurieren, dass jeder von ihnen jederzeit sowohl schreiben als auch lesen kann.  Das hei√üt, bereits ein Meister zu sein oder ihn automatisch und sofort zu werden. </p><br><p>  Das Problem der schnellen Suche wurde gel√∂st, indem ein zweites Repository installiert wurde, das f√ºr die Indizierung in der N√§he optimiert ist.  Volltextsuche, facettiert, mit Stemming <del>  und Blackjack </del>  .  Der zweite Speicher akzeptiert Eintr√§ge aus den Tabellen des ersten als Eingabe, analysiert und erstellt den Index.  Daher wurde der Datenspeichercluster f√ºr die Suche durch einen anderen Cluster erg√§nzt.  Mit einer √§hnlichen Masterkonfiguration, die dem gesamten <em>SLA entspricht</em> .  Alles ist in Ordnung, das Gesch√§ft l√§uft gut, Administratoren schlafen nachts ... bis mehr als drei Maschinen im Master-Master-Cluster sind. </p><br><h2 id="elastic">  Elastisch </h2><br><p>  Die <em>NoSQL-</em> Bewegung hat den Skalenhorizont sowohl f√ºr kleine als auch f√ºr gro√üe Daten erheblich erweitert.  Die NoSQL-Knoten des Clusters k√∂nnen Daten untereinander verteilen, sodass der Ausfall eines oder mehrerer von ihnen nicht zu einem Denial-of-Service f√ºr den gesamten Cluster f√ºhrt.  Die Zahlung f√ºr die hohe Verf√ºgbarkeit verteilter Daten war die Unf√§higkeit, ihre vollst√§ndige Konsistenz f√ºr die Aufzeichnung zu einem bestimmten Zeitpunkt sicherzustellen.  Stattdessen spricht NoSQL von einer <em>m√∂glichen Konsistenz</em> .  Das hei√üt, es wird angenommen, dass eines Tages alle Daten auf die Knoten des Clusters verteilt werden und auf lange Sicht konsistent werden. </p><br><p>  Das relationale Modell wurde also durch das nicht relationale Modell erg√§nzt und brachte viele Datenbank-Engines hervor, die die Probleme des <em>CAP-</em> Dreiecks mit einigem Erfolg l√∂sen.  Die Entwickler haben modische Werkzeuge in die Hand genommen, um ihre eigene ideale <em>Persistenzschicht</em> aufzubauen - f√ºr jeden Geschmack, jedes Budget und jedes Lastprofil. </p><br><p>  ElasticSearch ist ein Vertreter von NoSQL, das mit einer RESTful JSON-API auf der Lucene-Engine, Open Source in Java, geclustert ist und nicht nur einen Suchindex erstellen, sondern auch das Originaldokument speichern kann.  Eine solche Finte hilft dabei, die Rolle eines separaten DBMS zum Speichern von Originalen zu √ºberdenken oder sogar aufzugeben.  Das Ende der Einf√ºhrung. </p><br><h2 id="mapping">  Zuordnung </h2><br><p>  Die Zuordnung in ElasticSearch ist so etwas wie ein Schema (Tabellenstruktur in Bezug auf SQL), das Ihnen genau sagt, wie eingehende Dokumente (Datens√§tze in Bezug auf SQL) indiziert werden.  Die Zuordnung kann statisch, dynamisch oder nicht vorhanden sein.  Die statische Zuordnung l√§sst sich nicht √§ndern.  Mit Dynamic k√∂nnen Sie neue Felder hinzuf√ºgen.  Wenn keine Zuordnung angegeben ist, f√ºhrt ElasticSearch dies selbst durch, nachdem das erste Dokument zum Schreiben erhalten wurde.  Es wird die Struktur der Felder analysieren, einige Annahmen √ºber die darin enthaltenen Datentypen treffen, die Standardeinstellungen √ºberspringen und aufschreiben.  Ein solches schaltungsloses Verhalten erscheint auf den ersten Blick sehr praktisch.  Tats√§chlich eignet es sich jedoch eher zum Experimentieren als f√ºr √úberraschungen in der Produktion. </p><br><p>  Die Daten werden also indiziert, und dies ist ein Einwegprozess.  Einmal erstellt, kann die Zuordnung in SQL nicht dynamisch als ALTER TABLE ge√§ndert werden.  Weil die SQL-Tabelle das Originaldokument speichert, an das Sie den Suchindex binden k√∂nnen.  Bei ElasticSearch ist das Gegenteil der Fall.  Er selbst ist der Suchindex, an dem Sie das Originaldokument befestigen k√∂nnen.  Aus diesem Grund ist das Indexschema statisch.  Theoretisch k√∂nnte man entweder ein Feld in der Zuordnung erstellen oder es l√∂schen.  In der Praxis k√∂nnen Sie mit ElasticSearch nur Felder hinzuf√ºgen.  Ein Versuch, ein Feld zu l√∂schen, f√ºhrt zu nichts. </p><br><h2 id="alias">  Alias </h2><br><p>  Alias ‚Äã‚Äã- Dies ist ein zus√§tzlicher Name f√ºr den ElasticSearch-Index.  Es k√∂nnen mehrere Aliase f√ºr einen Index vorhanden sein.  Oder ein Alias ‚Äã‚Äãf√ºr mehrere Indizes.  Dann werden die Indizes wie von au√üen logisch kombiniert und sehen aus wie einer.  Alias ‚Äã‚Äãist sehr praktisch f√ºr Dienste, die w√§hrend ihres gesamten Lebens mit dem Index kommunizieren.  Beispielsweise k√∂nnen die Alias-Produkte sowohl <em>products_v2</em> als auch <em>products_v25</em> ausblenden, ohne die Namen im Service √§ndern zu m√ºssen.  Alias ‚Äã‚Äãist f√ºr die Datenmigration unverzichtbar, wenn sie bereits vom alten zum neuen Schema √ºbertragen wurden und Sie die Anwendung wechseln m√ºssen, um mit dem neuen Index zu arbeiten.  Das Umschalten eines Alias ‚Äã‚Äãvon Index zu Index ist eine atomare Operation.  Das hei√üt, es wird in einem Schritt ohne Verlust ausgef√ºhrt. </p><br><h2 id="reindex-api">  API neu indizieren </h2><br><p>  Das Datenlayout und die Zuordnung √§ndern sich von Zeit zu Zeit.  Neue Felder werden hinzugef√ºgt, unn√∂tige werden gel√∂scht.  Wenn ElasticSearch die Rolle des einzigen Repositorys spielt, ben√∂tigen Sie ein Tool, mit dem Sie die Zuordnung im laufenden Betrieb √§ndern k√∂nnen.  Zu diesem <em>Zweck</em> gibt es einen speziellen Befehl zum √úbertragen von Daten von einem Index zu einem anderen, die sogenannte <em>_reindex-API</em> .  Es funktioniert mit einer vorgefertigten oder leeren Zuordnung des Empf√§ngerindex auf der Serverseite und einer schnellen Indizierung in Stapeln von jeweils 1000 Dokumenten. </p><br><p>  Durch die Neuindizierung kann eine einfache Feldtypkonvertierung durchgef√ºhrt werden.  Zum Beispiel <em>lang</em> in <em>Text</em> und zur√ºck in <em>lang</em> oder <em>boolesch</em> in <em>Text</em> und zur√ºck in <em>boolesch</em> .  Aber <em>-9,99</em> in <em>Booleschen</em> wissen nicht mehr wie, <del>  Es ist nicht PHP f√ºr Sie </del>  .  Andererseits ist die Typkonvertierung nicht sicher.  Ein Dienst, der in einer Sprache mit dynamischer Typisierung geschrieben ist, kann f√ºr eine solche S√ºnde vergeben werden.  Wenn die Neuindizierung den Typ jedoch nicht konvertieren kann, wird das Dokument einfach nicht geschrieben.  Im Allgemeinen sollte die Datenmigration in drei Schritten erfolgen: Hinzuf√ºgen eines neuen Felds, Freigeben eines Dienstes damit, Bereinigen des alten. </p><br><p>  Ein Feld wird wie folgt hinzugef√ºgt.  Das Quellindexschema wird √ºbernommen, eine neue Eigenschaft eingegeben, ein leerer Index erstellt.  Dann beginnt die Neuindizierung: </p><br><pre><code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"test"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"dest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"test_clone"</span></span> } }</code> </pre> <br><p>  Das Feld wird auf √§hnliche Weise gel√∂scht.  Das Quellindexschema wird √ºbernommen, das Feld wird entfernt, ein leerer Index wird erstellt.  Anschlie√üend wird die Neuindizierung mit einer Liste der zu kopierenden Felder gestartet: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"test"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"_source"</span></span>: [<span class="hljs-string"><span class="hljs-string">"field1"</span></span>, <span class="hljs-string"><span class="hljs-string">"field3"</span></span>] }, <span class="hljs-attr"><span class="hljs-attr">"dest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"test_clone"</span></span> } }</code> </pre> <br><p>  Der Einfachheit halber werden beide F√§lle in Kaizen, einem Desktop-Client f√ºr ElasticSearch, zu einer Klonfunktion zusammengefasst.  Das Klonen kann an die Zuordnung des Zielindex angepasst werden.  Das folgende Beispiel zeigt, wie ein Teilklon aus einem Index mit drei Sammlungen (Typen in Bezug auf ElasticSearch) erstellt wird: <em>act</em> , <em>line</em> , <em>scene</em> .  Es bleibt nur eine <em>Zeile</em> mit zwei Feldern √ºbrig, die statische Zuordnung ist aktiviert und das Feld <em>language_number</em> aus <em>Text</em> wird <em>lang</em> . </p><br><p><img src="https://habrastorage.org/webt/rt/ju/dq/rtjudqsh1s-tevki7azjyxctsuy.gif"></p><br><h2 id="migraciya">  Die Migration </h2><br><p>  Die Reindex-API hat eine unangenehme Funktion: Sie kann √Ñnderungen im Quellindex nicht √ºberwachen.  Wenn sich dort nach Beginn der Neuindizierung etwas √§ndert, werden die √Ñnderungen nicht im Empf√§ngerindex wiedergegeben.  Um dieses Problem zu l√∂sen, wurde das ElasticSearch FollowUp Plugin entwickelt, das Protokollierungsbefehle hinzuf√ºgt.  Das Plugin kann den Index √ºberwachen und die f√ºr Dokumente ausgef√ºhrten Aktionen im JSON-Format in chronologischer Reihenfolge zur√ºckgeben.  Der Index, der Typ, die Dokumentkennung und die Operation darauf - INDEX oder DELETE - werden gespeichert.  Das FollowUp Plugin wird auf GitHub ver√∂ffentlicht und f√ºr fast alle Versionen von ElasticSearch kompiliert. </p><br><p>  F√ºr eine verlustfreie Datenmigration muss FollowUp auf dem Knoten installiert sein, auf dem die Neuindizierung beginnt.  Es wird davon ausgegangen, dass der Index bereits √ºber einen Alias ‚Äã‚Äãverf√ºgt und von allen Anwendungen verarbeitet wird.  Kurz vor der Neuindizierung wird das Plugin aktiviert.  Wenn die Neuindizierung abgeschlossen ist, wird das Plugin heruntergefahren und der Alias ‚Äã‚Äãwird auf den neuen Index gespiegelt.  Dann werden die aufgezeichneten Aktionen im Empf√§ngerindex reproduziert und holen seinen Status ein.  Trotz der hohen Geschwindigkeit der Neuindizierung k√∂nnen w√§hrend der Wiedergabe zwei Arten von Kollisionen auftreten: </p><br><ul><li>  Es gibt kein Dokument mehr mit einer solchen <em>_id</em> im neuen Index.  Sie konnten das Dokument l√∂schen, nachdem der Alias ‚Äã‚Äãauf den neuen Index umgestellt wurde. </li><li>  Im neuen Index gibt es ein Dokument mit einer solchen <em>_id</em> , jedoch mit einer h√∂heren Versionsnummer als im <em>Quellindex</em> .  Sie konnten das Dokument aktualisieren, nachdem der Alias ‚Äã‚Äãauf den neuen Index umgestellt wurde. </li></ul><br><p>  In diesen F√§llen sollte die Aktion nicht im Zielindex reproduziert werden.  Andere √Ñnderungen werden reproduziert. </p><br><p>  Viel Spa√ü beim Codieren! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de416069/">https://habr.com/ru/post/de416069/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de416055/index.html">Zuweisung und Unterst√ºtzung des FQDN des 3QX-Servers</a></li>
<li><a href="../de416059/index.html">Mobio spricht mit Daniil Shuleiko (Yandex.Taxi) √ºber die Fusion mit Uber, den Taximarkt und den Wettbewerb</a></li>
<li><a href="../de416061/index.html">So lala sehe ich alles</a></li>
<li><a href="../de416063/index.html">Verhandlungen √ºber Russen sind nirgends zu verzeichnen</a></li>
<li><a href="../de416067/index.html">√úbersicht √ºber die Sicherheitsanf√§lligkeit in Mikrotik Winbox. Oder eine gro√üe Datei</a></li>
<li><a href="../de416071/index.html">Neuronale Netze, grundlegende Funktionsprinzipien, Vielfalt und Topologie</a></li>
<li><a href="../de416073/index.html">Ein einfacher Kryptow√§hrungs-Handelsbot</a></li>
<li><a href="../de416075/index.html">Der FSB m√∂chte die Verantwortung f√ºr die versteckte Verwendung von Diktierger√§ten und Kameras in Smartphones √ºbernehmen [und nicht nur]</a></li>
<li><a href="../de416077/index.html">PlantUML - Alles, was Business Analysten zum Erstellen von Diagrammen in der Softwaredokumentation ben√∂tigen</a></li>
<li><a href="../de416079/index.html">Corona Native f√ºr Android - Verwenden von benutzerdefiniertem Java-Code in einem in Corona geschriebenen Spiel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>