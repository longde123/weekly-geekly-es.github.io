<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßúüèø üë©‚Äçüëß‚Äçüë¶ ‚öóÔ∏è Envolvemos todo el tr√°fico LAN en vpn sin l√≠mite de velocidad üöù ü¶é üì∂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En un art√≠culo anterior, vimos c√≥mo anonimizar todo el tr√°fico de Internet desde un √∫nico host. Ahora aumentemos el nivel de seguridad envolviendo tod...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Envolvemos todo el tr√°fico LAN en vpn sin l√≠mite de velocidad</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postuf/blog/475068/"><img src="https://habrastorage.org/webt/ln/tp/ju/lntpju4673cqk0xqk-l2d2glpsy.png"><br>  En un art√≠culo anterior, vimos c√≥mo anonimizar todo el tr√°fico de Internet desde un √∫nico host.  Ahora aumentemos el nivel de seguridad envolviendo toda la red de √°rea local con una VPN.  Al mismo tiempo, eliminaremos el peligro de acceder a Internet desde un dispositivo a√∫n no configurado y asociaremos la direcci√≥n de nuestro proveedor con este dispositivo. <br><br>  Para este prop√≥sito, simplemente puede configurar el cliente VPN en la puerta de enlace, si el enrutador lo permite.  Pero tal soluci√≥n est√° cargada de consecuencias en forma de una disminuci√≥n en la velocidad de Internet, una mayor carga en el enrutador, adem√°s, algunos clientes env√≠an todo el tr√°fico a trav√©s de la conexi√≥n principal de inmediato si se desconectan de la VPN.  No olvide que incluso los principales proveedores de VPN no pueden proporcionar un tiempo de actividad del 100% para sus servidores. <br><br>  ¬øCu√°les son nuestros objetivos? <br><br><ul><li>  pasar todo el tr√°fico saliente a trav√©s de VPN </li><li>  hazlo lo m√°s r√°pido posible </li><li>  no depende de problemas temporales del proveedor de VPN </li><li>  M√°ximo anonimato en Internet </li></ul><a name="habracut"></a><br><h1>  Preparaci√≥n </h1><br>  Necesitamos un enrutador potente que pueda cifrar el tr√°fico a alta velocidad.  Actuar√° como una puerta de enlace VPN.  Encontramos maravillosas mini PC en AliExpress con esta tarea: Intel Celeron de cuatro n√∫cleos, soporte nativo para AES-CBC, AES-XTS, AES-GCM, AES-ICM y hasta cuatro puertos RJ-45.  Y por defecto, pfSense estaba instalado en ellos.  Trabajaremos con ella. <br><br>  Si su ISP requiere una configuraci√≥n de conexi√≥n especial, puede tomar dos enrutadores m√°s y compartir el acceso a Internet y la red local, y poner una puerta de enlace VPN entre ellos.  En otro caso, puede conectar directamente el cable del proveedor a la puerta de enlace VPN y, detr√°s, colocar el enrutador dom√©stico con una red local.  La configuraci√≥n inicial de una conexi√≥n a Internet en pfSense est√° m√°s all√° del alcance de este art√≠culo. <br><br><h1>  Personalizaci√≥n </h1><br>  El art√≠culo asume que Internet est√° conectado al primer puerto, su PC o red dom√©stica al segundo, y que antes de configurar la VPN, pudo acceder a Internet. <br><br>  Para evitar m√°s problemas, iniciemos sesi√≥n en su proveedor de VPN favorito y busquemos instrucciones para configurar pfSense.  Si su proveedor no proporciona instrucciones para la configuraci√≥n manual en pfSense, puede usar esta de mi proveedor favorito: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.expressvpn.com/support/vpn-setup/pfsense-with-expressvpn-openvpn</a> : el punto principal no cambiar√°.  El art√≠culo anterior con im√°genes describe c√≥mo configurar completamente un enrutador reci√©n comprado con pfSense. <br><br>  Aqu√≠ hay una breve lista de verificaci√≥n para configurar una nueva VPN: <br><br><ul><li>  Sistema - Cert.  Gerente - CAs.  Agregar un certificado de VPN CA </li><li>  Sistema - Cert.  Gerente - Certificados.  Agregar un certificado de servidor VPN </li><li>  VPN - OpenVPN - Clientes.  Creamos un nuevo cliente de acuerdo con las instrucciones del proveedor de VPN </li><li>  Interfaces - Asignaci√≥n.  Agregar clientes como interfaces </li><li>  Sistema - Enrutamiento.  Comprueba que ha aparecido la puerta de enlace. </li><li>  Cortafuegos - NAT.  Agregar reglas NAT para cada cliente </li><li>  Cortafuegos - Reglas - LAN.  Agregue la redirecci√≥n de todo el tr√°fico de la red a trav√©s de Gateway </li><li>  Sistema - Enrutamiento.  Para una VPN-a activa, en la configuraci√≥n de la puerta de enlace, especifique Monitor IP, haga ping en el que se comprobar√° la VPN-a </li></ul><br>  Las VPN se reinician en Estado - OpenVPN.  Ver registros en Estado - Registros de paquetes - OpenVPN. <br><br>  En esta etapa, nos detenemos y verificamos que haya acceso a Internet a trav√©s de VPN, y que cuando se desconecta de la VPN, el acceso desaparece por completo.  Si no hay Internet, hemos cometido un error en alguna parte, miramos los registros de VPN, verificamos la configuraci√≥n nuevamente.  Si despu√©s de desconectar el tr√°fico VPN comienza a pasar por la puerta de enlace principal, entonces se equivocaron en el cortafuegos - Reglas - LAN. <br><br>  Ahora para la parte interesante.  Si su proveedor emite 20 Mbit por segundo, y luego por la noche, en esta etapa ya ha recibido una red de √°rea local, completamente cerrada por una VPN, que funciona a la velocidad m√°s alta posible.  Pero, ¬øy si tu canal es m√°s ancho? <br><br><h1>  Escalable </h1><br>  Configuramos un par de clientes VPN m√°s para diferentes servidores de acuerdo con las instrucciones anteriores.  No es necesario agregar certificados de CA y de servidor, seleccionamos los que ya se agregaron.  Adem√°s, no realizamos el paso con Firewall - Reglas - LAN, lo haremos m√°s adelante.  El n√∫mero requerido de clientes se establece emp√≠ricamente por los resultados de las mediciones de velocidad a trav√©s de cada servidor separado. <br><br>  Una vez completado, deber√≠amos tener la siguiente imagen: <br><br>  - En VPN - OpenVPN - Clientes creados y clientes activados <br><br><img src="https://habrastorage.org/webt/du/mq/jb/dumqjbjk-nlnypzt7zgp7eupe_e.png" alt="VPN - OpenVPN - Clientes"><br><br>  - Interfaces - Asignaci√≥n de interfaces creadas y activadas para cada cliente <br><br><img src="https://habrastorage.org/webt/xq/_h/hs/xq_hhsew-s8lmaqjhc19usecbrw.png" alt="Interfaces - Asignaci√≥n"><br><br>  - En estado - OpenVPN, todos los clientes est√°n en estado "activo" <br><br><img src="https://habrastorage.org/webt/h7/05/h1/h705h1a6q8rzuwptjuvf4qf2kdw.png" alt="Estado: OpenVPN"><br><br>  - Las puertas de enlace aparecieron en el sistema - Enrutamiento, y las direcciones IP de ping se indican para ellos. <br>  (Si no puede averiguar a qui√©n hacer ping, abra shodan.io y encuentre todas las direcciones IP de Google) <br><br><img src="https://habrastorage.org/webt/86/zk/6r/86zk6r-1ktp7rf4b-ndtfq-xxw0.png" alt="Sistema - Enrutamiento"><br><br>  Ahora vamos a Sistema - Enrutamiento - Grupos de puerta de enlace.  Haz clic en Agregar.  Ingrese un nombre memorable en el nombre del grupo. <br><br><img src="https://habrastorage.org/webt/el/f-/zs/elf-zss6x4cssjpthizwalp7hxw.png" alt="Sistema - Enrutamiento - Grupos de puerta de enlace"><br><br>  Ahora preste atenci√≥n a la tabla Prioridad de puerta de enlace.  Los grupos de puerta de enlace funcionan de la siguiente manera: conmutaci√≥n por error por nivel, equilibrio dentro de un nivel.  La columna Nivel indica a qu√© nivel se utilizar√° esta puerta de enlace.  La opci√≥n m√°s simple es especificar todas las puertas de enlace VPN activas en el primer nivel.  Una opci√≥n para un Internet lento es crear dos clientes y colocarlos en el primer y segundo nivel, pero en este caso solo habr√° tolerancia a fallas. <br><br>  Encuentra el nivel de activaci√≥n a continuaci√≥n.  Esta es la condici√≥n bajo la cual ocurre una exclusi√≥n temporal de la puerta de enlace del grupo.  Las opciones distintas de Member Down le permiten dejar de enviar paquetes a la puerta de enlace un poco antes de que se caiga por completo, al exceder el umbral de p√©rdida de paquetes y / o por un ping alto.  Los umbrales de p√©rdida y ping se establecen para cada puerta de enlace individualmente en el Sistema - Enrutamiento - Puerta de enlace. <br><br>  Una vez que haya elegido una opci√≥n conveniente para organizar las puertas de enlace en niveles, haga clic en Guardar. <br><br>  Es hora de reenviar el tr√°fico a un nuevo grupo de puertas de enlace.  Vamos al Firewall - Reglas - LAN, abrimos la regla de redireccionamiento creada anteriormente, bajamos a la lista con puertas de enlace y vemos el grupo que creamos en esta lista.  Lo seleccionamos, guardamos la regla y aplicamos los cambios.  Eso es todo, ahora cada nueva conexi√≥n pasar√° por un nuevo cliente VPN en el grupo. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tiempo de</a> prueba: abra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">api.ipify.me</a> , desactive el cach√© y keep-alive y vuelva a cargar la p√°gina.  Si usted es el √∫nico usuario en la red, para cada actualizaci√≥n de la p√°gina deber√≠a ver una nueva direcci√≥n IP que sea diferente de la de su hogar.  Si ve la misma direcci√≥n, actualice completamente la p√°gina con Ctrl + F5 (Comando + May√∫s + R en las amapolas) o abra una nueva pesta√±a privada.  Si no ayuda, significa que en alg√∫n lugar cometieron un error en la configuraci√≥n del grupo o no cambiaron la puerta de enlace en las reglas del firewall. <br><br>  Ahora sobre lo malo.  Desafortunadamente, esta soluci√≥n tiene un peque√±o error elusivo si lo usa frente al enrutador de la red local (y no al conmutador).  Tarde o temprano, uno de los clientes de VPN se cae, lo expulsa del grupo y todo est√° bien hasta que la VPN se recupere.  Dado que todos los usuarios est√°n detr√°s de NAT, y el enrutador VPN solo ve una direcci√≥n IP y 65 mil puertos, con el tiempo asocia todos los puertos con esos clientes VPN que nunca cayeron.  En consecuencia, tan pronto como se eleva el cliente VPN, no pasa tr√°fico.  El cliente est√° completamente vivo, los pings y una cantidad estable de tr√°fico de servicio lo atraviesan, pero el tr√°fico del cliente no lo atraviesa.  En teor√≠a, esto se resolver√≠a reiniciando la tabla de conexi√≥n, y para esto incluso hay una marca de verificaci√≥n en la configuraci√≥n de pfSense, pero en mi investigaci√≥n esta marca de verificaci√≥n bloque√≥ por completo todo el acceso al enrutador, ya que los clientes comenzaron a caer en ciclos, mientras que ca√≠an las conexiones reci√©n establecidas de la web interfaz, lo que dificultaba mucho la soluci√≥n del problema.  Sin esta marca de verificaci√≥n, si hay m√°s de dos VPN, se equilibraron, de modo que el acceso a trav√©s de al menos uno siempre estuvo ah√≠.  Al final, configur√© la condici√≥n de monitoreo "si cinco minutos en la interfaz ten√≠an menos de 1000 bytes de tr√°fico por segundo, d√≠game", y en casos especialmente avanzados, reinicio manualmente el cliente VPN zombie para restablecer la tabla de conexi√≥n. <br><br>  Entonces, tenemos una red que pasa completamente a trav√©s de varias VPN distribuidas.  Debido a la combinaci√≥n de varios servidores VPN diferentes, no dependemos de la disponibilidad de cada uno de ellos individualmente, y la velocidad de la red est√° limitada solo por su canal menos el cifrado.  Si de repente un enrutador no es suficiente para usted, tambi√©n se pueden escalar, pero este es un tema para un art√≠culo separado. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/475068/">https://habr.com/ru/post/475068/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../475054/index.html">SAP en Microsoft Azure Tour en Mosc√∫</a></li>
<li><a href="../475058/index.html">La ciudad se duerme, los residentes de Habrovsk se despiertan</a></li>
<li><a href="../475060/index.html">Crear un servicio de seguimiento de llamadas simple, parte 2</a></li>
<li><a href="../475064/index.html">.NET Core 3 para escritorio de Windows</a></li>
<li><a href="../475066/index.html">Las cr√≥nicas del hambre de libros</a></li>
<li><a href="../475072/index.html">Pasantes a trav√©s de los ojos de la empresa</a></li>
<li><a href="../475074/index.html">Introducci√≥n a ECMAScript 2017 (ES8)</a></li>
<li><a href="../475076/index.html">Superh√©roes sovi√©ticos, mocos checos y clon australiano</a></li>
<li><a href="../475078/index.html">Comprender los envoltorios de propiedades en SwiftUI</a></li>
<li><a href="../475086/index.html">Tipo de API REST para desarrolladores frontend</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>