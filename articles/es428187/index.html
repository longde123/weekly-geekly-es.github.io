<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∂üèª üêé ‚úåüèª C√≥mo escribir una extensi√≥n para GNOME Shell: modo No molestar üö£ ü§µüèª üí•</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Todo comenz√≥ con el cambio a una nueva versi√≥n de una distribuci√≥n de Linux, y all√≠, el infame Shell de GNOME (GH para abreviar), en Javascript. Bueno...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo escribir una extensi√≥n para GNOME Shell: modo No molestar</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428187/"><p>  Todo comenz√≥ con el cambio a una nueva versi√≥n de una distribuci√≥n de Linux, y all√≠, el <em>infame</em> Shell de GNOME (GH para abreviar), en Javascript.  Bueno, est√° bien, en JS, as√≠ que en JS, funciona, y est√° bien. </p><br><p> Al mismo tiempo, el ritmo de mi trabajo siempre ha exigido encontrar un anuncio publicitario normal, en lugar de las toneladas de megabytes de la pesta√±a <code>outlook.office.com</code> en el navegador.  Y ahora descubr√≠ que, en nuestro tiempo, hay varios candidatos casi excelentes, un problema: el remitente comenz√≥ a recibirme notificaciones de nuevas letras, sonido e inscripciones emergentes. </p><br><p>  Que hacer  La decisi√≥n de escribir la extensi√≥n No molestar no vino de inmediato, realmente no quer√≠a escribir una bicicleta y / o quedarme atrapado en el desarrollo / c√≥digo / toneladas de errores, pero decid√≠, y ahora quiero compartir mi experiencia con Habr.  <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">1</a></sup> </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/737/175/2b5/7371752b5fb33b8858bff75857fbfa83.jpg"></p><a name="habracut"></a><br><h2 id="tehnicheskie-trebovaniya">  Requisitos t√©cnicos </h2><br><p>  Quiero tener <del>  uno grande </del>  bot√≥n para desactivar las notificaciones y los sonidos durante el tiempo que elija: 20 minutos, 40 minutos, 1 hora, 2 horas, 4, 8 y 24 horas.  <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">2</a></sup> S√≠, el tiempo como en Slack. </p><br><p>  En las extensiones de extensiones.gnome.org hab√≠a una extensi√≥n "No molestar bot√≥n", que sirvi√≥ como modelo para escribir su extensi√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">No molestar tiempo</a> . </p><br><h2 id="konechnyy-rezultat-do-not-disturb-timehttpsextensionsgnomeorgextension1484do-not-disturb-time">  Resultado final: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">No molestar tiempo</a> </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/104/41d/479/10441d479062c7540a2743c6fb0b852d.png" alt="No molestar el tiempo"></p><br><p>  Instalar desde <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">extensiones.gnome.org</a> . <br>  Fuentes en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github</a> : poner estrellas, tenedor, ofrecer mejoras. </p><br><h3 id="kak-ustanovit-rasshirenie-gh-instrukciya">  C√≥mo instalar la extensi√≥n GH: instrucciones </h3><br><ol><li>  Instale el paquete <em>chrome-gnome-shell</em> , un conector de navegador, usando Ubuntu como ejemplo: <br> <code>sudo apt install chrome-gnome-shell</code> </li> <li>  Usando el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlace,</a> instale la extensi√≥n del navegador: <br><ul><li>  siga el enlace <em>Haga clic aqu√≠ para instalar la extensi√≥n del navegador</em> </li><li>  en Ubuntu 18.04, funcion√≥ para m√≠ en el navegador Chrome / Chromium, en Fedora 28/29, tanto en Firefox como en Chromium </li></ul></li><li>  Estamos buscando la extensi√≥n deseada en la lista <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://extensions.gnome.org</a> : habilitar, deshabilitar, cambiar la configuraci√≥n de la extensi√≥n. </li><li>  BENEFICIOS! </li></ol><br><h2 id="nachalo">  Inicio </h2><br><p>  Crea una extensi√≥n desde cero: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> gnome<span class="hljs-literal"><span class="hljs-literal">-shell</span></span><span class="hljs-literal"><span class="hljs-literal">-extension</span></span><span class="hljs-literal"><span class="hljs-literal">-tool</span></span> -<span class="hljs-literal"><span class="hljs-literal">-create</span></span><span class="hljs-literal"><span class="hljs-literal">-extension</span></span> Name: <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> Not Disturb Time Description: Disables notifications and sound <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a period Uuid: dnd@catbo.net Created extension <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">'~/.local/share/gnome-shell/extensions/dnd@catbo.net'</span></span> <span class="hljs-comment"><span class="hljs-comment">#  gnome-shell Alt+F2, r, Enter #    https://extensions.gnome.org/local/      #   Gnome Shell - , gnome-shell   systemd,   journalctl -f /usr/bin/gnome-shell #    ,       gnome-shell journalctl -f /usr/bin/gnome-shell | grep -E 'dnd|$'</span></span></code> </pre> <br><p>  El archivo <code>extension.js</code> en el directorio correspondiente es el punto de entrada en nuestra aplicaci√≥n, en una versi√≥n m√≠nima se ve as√≠: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{} <span class="hljs-comment"><span class="hljs-comment">//   ;    function disable() {} // --||-- ;     enable()</span></span></code> </pre> <br><h3 id="pervyy-kod">  Primer c√≥digo </h3><br><p>  Primero, queremos agregar un bot√≥n al <code>Status Menu</code> esquina superior derecha, como en la captura de pantalla anterior. </p><br><p>  Entonces, ¬øpor d√≥nde empezar?  Oh, comencemos con la documentaci√≥n.  Tenemos documentaci√≥n oficial, todas las cosas.  Pero no, la documentaci√≥n oficial es muy peque√±a y fragmentada, pero gracias a <code>julio641742</code> y su documentaci√≥n no oficial, obtenemos lo que necesitamos: </p><br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">// 1 -    (1 - , 0 - , 0.5 -  ) // true,     let dndButton = new PanelMenu.Button(1, "DoNotDisturb", false); // `right` -      (left/center/right) Main.panel.addToStatusArea("DoNotDisturbRole", dndButton, 0, "right"); let box = new St.BoxLayout(); dndButton.actor.add_child(box); let icon = new St.Icon({ style_class: "system-status-icon" }); icon.set_gicon(Gio.icon_new_for_string("/tmp/bell_normal.svg")); box.add(icon);</span></span></code> </pre> <br><p>  Este c√≥digo crea el objeto clave <code>dndButton</code> de la clase <code>dndButton</code> : este es un bot√≥n especialmente dise√±ado para el panel del men√∫ de estado.  Y lo insertamos en este panel usando la funci√≥n Main.panel.addToStatusArea ().  <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">3</a></sup> </p><br><p>  Inserte elementos de men√∫ con controladores atornillados a ellos, por ejemplo: </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> menuItem = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PopupMenu.PopupMenuItem(<span class="hljs-string"><span class="hljs-string">"hello, world!"</span></span>); menuItem.connect(<span class="hljs-string"><span class="hljs-string">"activate"</span></span>, (menuItem, event) =&gt; { log(<span class="hljs-string"><span class="hljs-string">"hello, world!"</span></span>); }); dndButton.menu.addMenuItem(menuItem);</code> </pre> <br><p>  ¬°Gracias, julio641742, por la documentaci√≥n!  Enlace: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/julio641742/gnome-shell-extension-reference</a> </p><br><p>  El c√≥digo de trabajo final est√° <a href="">aqu√≠</a> . </p><br><h2 id="osobennosti-raboty-gnome-shell-i-javascript">  Funciones de GNOME Shell y Javascript </h2><br><p>  Afuera est√° a finales de 2018, y Node.js / V8 es la herramienta principal para ejecutar c√≥digo Javascript.  Todo el desarrollo web moderno se basa en un "nodo". </p><br><p>  Pero GNOME Shell y toda la infraestructura a su alrededor utilizan un motor Javascript diferente, Mozilla's SpiderMonkey, y esto trae muchas diferencias importantes en el rendimiento. </p><br><h3 id="import-moduley">  Importar m√≥dulos </h3><br><p>  A diferencia de Node.js, no hay require () aqu√≠, y tampoco hay importaci√≥n de ES6 elegante.  En cambio, hay un objeto especial de importaci√≥n, el acceso a los atributos de los cuales conduce a la carga del m√≥dulo: </p><br><pre> <code class="hljs julia"> //<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PanelMenu = require(<span class="hljs-string"><span class="hljs-string">"ui/panelMenu"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PanelMenu = imports.ui.panelMenu;</code> </pre> <br><p>  En este caso, descargamos el m√≥dulo js / ui / panelMenu.js de la biblioteca del paquete GNOME Shell, que implementa la funcionalidad de un bot√≥n con un men√∫ emergente. </p><br><p>  S√≠, todos los botones en el panel de un escritorio moderno de Linux que usa GNOME est√°n basados ‚Äã‚Äãen panelMenu.js.  Incluyendo: el mismo bot√≥n derecho con indicadores de bater√≠a, Wi-Fi, volumen de sonido;  cambio de idioma de entrada en-ru. </p><br><p>  A continuaci√≥n, hay un atributo especial <code>imports.searchPath</code> : esta es una lista de rutas (l√≠neas) donde se buscar√°n nuestros m√≥dulos JS.  Por ejemplo, asignamos una funci√≥n de temporizador a un m√≥dulo timeUtils.js separado y lo colocamos cerca del punto de entrada de nuestra extensi√≥n, extension.js.  Importe timeUtils.js de la siguiente manera: </p><br><pre> <code class="hljs pgsql">//     , -  ~/.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/gnome-shell/extensions/&lt;your-<span class="hljs-keyword"><span class="hljs-keyword">extension</span></span>&gt;/ const Me = imports.misc.extensionUtils.getCurrentExtension(); //       imports.searchPath.unshift(Me.path); //   const timeUtils = imports.timeUtils;</code> </pre> <br><h3 id="logirovanie-otladka-javascript">  Registro, depuraci√≥n de Javascript </h3><br><p>  Bueno, como no tenemos Node.js, tenemos nuestro propio registro.  En lugar de console.log (), hay varias funciones de registro disponibles en el c√≥digo, consulte gjs /../ global.cpp, static_funcs: </p><br><ul><li>  "log" = g_message ("JS LOG:" + mensaje) - inicio de sesi√≥n en stderr, ejemplo: </li></ul><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cat helloWorld.js log(<span class="hljs-string"><span class="hljs-string">"hello, world"</span></span>); <span class="hljs-variable"><span class="hljs-variable">$</span></span> gjs helloWorld.js Gjs<span class="hljs-literal"><span class="hljs-literal">-Message</span></span>: <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">21.048</span></span>: JS LOG: hello, world</code> </pre> <br><ul><li>  "logError": registra la pila de excepciones: <br><ul><li>  el primer argumento requerido es una excepci√≥n, luego una coma separa lo que quieres </li><li>  ejemplo, si necesita imprimir la pila en el lugar correcto: </li></ul></li></ul><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'bum!'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) { logError(e, <span class="hljs-string"><span class="hljs-string">"what a fuck"</span></span>); }</code> </pre> <br><p>  y esto dibujar√° en estilo stderr: </p><br><pre> <code class="hljs powershell">(gjs:<span class="hljs-number"><span class="hljs-number">28674</span></span>): Gjs<span class="hljs-literal"><span class="hljs-literal">-WARNING</span></span> **: <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">46.951</span></span>: JS ERROR: what a fuck: Error: bum! ggg<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>./gtk.js:<span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> ddd<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>./gtk.js:<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>./gtk.js:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><ul><li>  "print" = g_print ("% s \ n", txt);  - solo texto + "\ n" en stdout, sin prefijos y colores, a diferencia de log () </li><li>  "printerr" = g_printerr ("% s \ n", txt): la diferencia con respecto a la impresi√≥n es que en stderr </li></ul><br><p>  Pero no hay un depurador para SpiderMonkey listo para usar (no fue en vano que escrib√≠ minuciosamente sobre todas las herramientas disponibles para iniciar sesi√≥n, ¬°√∫selas!).  Si lo desea, puede probar JSRDbg: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">uno</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dos</a> . </p><br><h2 id="a-est-li-zhizn-dlya-js-koda-vne-gnome-shell">  ¬øHay vida para el c√≥digo JS fuera de GNOME Shell? </h2><br><p>  Hay  ¬°Las aplicaciones con todas las funciones, incluida una interfaz gr√°fica de usuario (GUI), se pueden escribir en Javascript!  Debe ejecutarlos utilizando el binar gjs, el iniciador de c√≥digo JS-GTK, un ejemplo de creaci√≥n de una ventana GUI: </p><br><pre> <code class="hljs vala">$ which gjs /usr/bin/gjs $ dpkg --search /usr/bin/gjs gjs: /usr/bin/gjs $ cat gtk.js <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span> = imports.gi.<span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.init(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); let win = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.Window(); win.connect(<span class="hljs-string"><span class="hljs-string">"delete-event"</span></span>, () =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.main_quit(); }); win.show_all(); <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.main(); $ gjs gtk.js</code> </pre> <br><p>  Arriba, mencion√© dividir el c√≥digo en m√≥dulos y cargarlos desde Javascript.  Surge la pregunta, pero ¬øc√≥mo determinar en el propio m√≥dulo si se inicia como m√≥dulo "principal" o si se carga desde otro m√≥dulo? </p><br><p>  Python tiene una construcci√≥n aut√©ntica: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">"__main__"</span></span>: main()</code> </pre> <br><p>  En Node.js, de manera similar: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.main === <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>) { main(); }</code> </pre> <br><p>  No encontr√© una respuesta oficial a esta pregunta para Gjs / GH, pero se me ocurri√≥ una t√©cnica que me apresuro a compartir con el lector (¬øpor qu√© alguien ley√≥ "dosyudova"? ¬°Respeto!). </p><br><p>  Entonces, el truco complicado se basa en el an√°lisis de la pila de llamadas actual, si consta de 2 o m√°s l√≠neas, entonces no estamos en el m√≥dulo main (): </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>().stack.split(<span class="hljs-regexp"><span class="hljs-regexp">/\r\n|\r|\n/g</span></span>).filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">line</span></span></span><span class="hljs-function"> =&gt;</span></span> line.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) .length == <span class="hljs-number"><span class="hljs-number">1</span></span> ) { main(); }</code> </pre> <br><h2 id="uborka-za-soboy">  Limpieza </h2><br><p>  Cada extensi√≥n de GNOME Shell tiene acceso a todos los objetos en todo el GNOME Shell.  Por ejemplo, para mostrar el n√∫mero de notificaciones a√∫n no le√≠das, llegamos al contenedor con ellas en el <code>Notification Area</code> , ubicada en el centro arriba, n√∫mero 4 en la imagen (haga clic en la inscripci√≥n con la hora actual, se puede hacer clic en la vida real, no aqu√≠): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/91e/eec/acc/91eeecaccdc67202335ce4d51d8d90d3.png" alt="No molestar el tiempo"></p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> unseenlist = Main.panel.statusArea.dateMenu._messageList._notificationSection._list;</code> </pre> <br><p>  Puede averiguar cu√°ntas notificaciones no le√≠das se suscriben a eventos de agregar y eliminar notificaciones: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> number = unseenlist.get_n_children(); unseenlist.connect(<span class="hljs-string"><span class="hljs-string">"actor-added"</span></span>, () =&gt; { log(<span class="hljs-string"><span class="hljs-string">"added!"</span></span>); }); unseenlist.connect(<span class="hljs-string"><span class="hljs-string">"actor-removed"</span></span>, () =&gt; { log(<span class="hljs-string"><span class="hljs-string">"removed!"</span></span>); });</code> </pre> <br><p>  Esto est√° bien, pero el usuario a veces puede decidir que ya no necesita la extensi√≥n X y hace clic en el bot√≥n para deshabilitar la extensi√≥n.  Para una extensi√≥n, esto es equivalente a llamar a la funci√≥n disable (), y se debe hacer todo lo posible para que la extensi√≥n desactivada no rompa el GH en funcionamiento: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ dndButton.destroy(); }</code> </pre> <br><p>  En este caso, adem√°s de eliminar el bot√≥n en s√≠, debe darse de baja de los eventos "actor agregado" / "actor eliminado", por ejemplo: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> signal = unseenlist.connect(<span class="hljs-string"><span class="hljs-string">"actor-added"</span></span>, () =&gt; { log(<span class="hljs-string"><span class="hljs-string">"added!"</span></span>); }); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ dndButton.destroy(); unseenlist.disconnect(signal); }</code> </pre> <br><p>  Si esto no se hace, se continuar√° llamando al c√≥digo de los controladores en el evento correspondiente, intente actualizar el estado del bot√≥n de men√∫ que a√∫n no existe y ... GNOME Shell comenzar√° a fallar.  Bueno, s√≠, lo haremos, los usuarios jurar√°n, las piedras volar√°n hacia los desarrolladores de GNOME Shell y GNOME en general.  La imagen real, Th. </p><br><p>  Entonces GNOME Shell / Gjs es una simbiosis de dos sistemas, Glib / GTK y Javascript, y tienen un enfoque diferente para la gesti√≥n de recursos.  Glib / GTK requiere la liberaci√≥n expl√≠cita de sus recursos (botones, temporizadores, etc.).  Si el objeto fue creado por el motor Javascript, entonces actuamos como de costumbre (no publiques nada). </p><br><p>  Como resultado, tan pronto como nuestra extensi√≥n est√© lista y no "fluya", puede publicarla con seguridad en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://extensions.gnome.org</a> . </p><br><h2 id="rezhim-gnomesessionpresencestatusbusy-i-dbus">  GnomeSession.PresenceStatus.BUSY y modo DBus. </h2><br><p>  Si no lo ha olvidado, estamos haciendo la extensi√≥n "No molestar", que desactiva la visualizaci√≥n de notificaciones al usuario. </p><br><p>  GNOME ya tiene una bandera responsable de este estado.  Despu√©s del inicio de sesi√≥n del usuario, se crea el proceso gnome-session, en el que se encuentra este indicador: este es el atributo GsmPresencePrivate.status, consulte las fuentes de gnome-session, gnome-session / gsm -ence.c.  Tenemos acceso a este indicador a trav√©s de la interfaz DBus (como la comunicaci√≥n entre procesos). </p><br><p>  No solo nosotros, sino que GH necesita informaci√≥n sobre esta bandera para no mostrar notificaciones.  Esto es bastante f√°cil de encontrar en la fuente de GH: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._presence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GnomeSession.Presence(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">proxy, error</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._onStatusChanged(proxy.status); }); ... this._presence.connectSignal(<span class="hljs-string"><span class="hljs-string">'StatusChanged'</span></span>, (proxy, senderName, [status]) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._onStatusChanged(status); });</code> </pre> <br><p>  En este caso, el m√©todo _onStatusChanged es un controlador que responde a un cambio de estado.  Copiamos este c√≥digo a nosotros mismos, lo adaptamos: descubrimos <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">4</a></sup> notificaciones, hubo un sonido. </p><br><h2 id="vyklyuchenievklyuchenie-zvuka">  Silenciar / activar </h2><br><p>  La mayor√≠a de los escritorios modernos de Linux est√°n controlados por PulseAudio, <del>  trabajo notorio </del>  autor√≠a del programa del famoso poeta Lennart.  Hasta ahora, no hab√≠a llegado a escribir el c√≥digo de PulseAudio, y me alegr√© de tener la oportunidad de comprender PulseAudio en alg√∫n nivel. </p><br><p>  Como resultado, result√≥ que para mute / unmute, una utilidad <code>pactl</code> es <code>pactl</code> , o m√°s bien tres comandos basados ‚Äã‚Äãen ella: </p><br><ul><li>  "informaci√≥n de pactl": descubra el <code>default sink</code> : qu√© salida de sonido, si hay varias, es el sonido predeterminado </li><li>  "sumideros de la lista de pactl": descubra el estado de silencio / silencio del dispositivo correspondiente </li><li>  "pactl set-sink-mute% (defaultSink) s% (isMute) s": para silenciar / activar el silencio </li></ul><br><p>  Por lo tanto, nuestra tarea es ejecutar comandos / procesos, leer su salida est√°ndar y buscar los valores deseados de forma regular.  En resumen, una tarea est√°ndar. </p><br><p>  En GNOME, la biblioteca central de glib es responsable de crear procesos, y hay una excelente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> al respecto.  Y, por supuesto, ella est√° en C. Y tenemos a JS.  Se sabe que el paquete Gjs cre√≥ una capa inteligente e "intuitiva" entre el C-API y Javascript.  Pero a√∫n comprende que necesita ejemplos y que no puede hacerlo sin buscar en Google. </p><br><p>  Como resultado, gracias a la excelente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">esencia,</a> obtenemos un c√≥digo de trabajo: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> resList = GLib.spawn_command_line_sync(cmd); <span class="hljs-comment"><span class="hljs-comment">// res = true/false, /   // status = int,    // out/err = ,  stdout/stderr  let [res, out, err, status] = resList; if (res != true || status != 0) { print("not ok!"); } else { // do something useful }</span></span></code> </pre> <br><h2 id="sohranenie-nastroek-v-reestre">  Guardar ajustes <del>  en el registro </del></h2><br><p>  No, por supuesto, no hay registro en Linux.  Aqu√≠ no eres Windows.  Hay uno mejor, llamado GSettings (esta es la API), varias opciones de implementaci√≥n est√°n ocultas detr√°s, por defecto GNOME usa Dconf.  As√≠ es como se ve el marco de la GUI: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/0fe/03c/eca/0fe03ceca6c7fc9338377fc5d0909024.png" alt="dconf-editor"></p><br><p>  - ¬øQu√© es mejor que almacenar configuraciones en archivos de texto sin formato?  - Pregunte a los viejos y barbudos usuarios de Linux.  La caracter√≠stica principal de GSettings es que puede suscribirse f√°cilmente a los cambios en la configuraci√≥n, por ejemplo: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Gio = imports.gi.Gio; settings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gio.Settings({ <span class="hljs-attr"><span class="hljs-attr">settings_schema</span></span>: schemaObj }); settings.connect(<span class="hljs-string"><span class="hljs-string">"changed::mute-audio"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ log(<span class="hljs-string"><span class="hljs-string">"I see, you changed it!"</span></span>); });</code> </pre> <br><p>  La √∫nica configuraci√≥n hasta ahora en nuestro "No molestar" es la opci√≥n "silenciar audio", que permite al usuario apagar el sonido o no durante la "hora de silencio" a petici√≥n del usuario. </p><br><h2 id="i-nemnogo-klassiki-gui-na-gtk">  Y un poco de cl√°sico, GTK GUI </h2><br><p>  Con el fin de mostrar bellamente al usuario la configuraci√≥n de nuestra extensi√≥n (y no ingresar al registro con patas sucias), GH nos ofrece escribir un c√≥digo GUI y ponerlo en la funci√≥n buildPrefsWidget () del archivo prefs.js.  En este caso, frente a nuestra extensi√≥n en la lista de "Extensiones instaladas", <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> veremos un bot√≥n adicional "Configurar esta extensi√≥n", haciendo clic en el que aparecer√° nuestra belleza. </p><br><p>  Creemos una pesta√±a Acerca de separada, porque se sabe que sin Ebout, lo siento, el programa no est√° completo. </p><br><p>  En t√©rminos generales, para construir una interfaz gr√°fica cl√°sica, GTK tiene una amplia gama de bloques de construcci√≥n, <code></code> , de los cuales puede verificar la cantidad y calidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . </p><br><p>  Utilizaremos solo algunos de ellos: </p><br><ul><li>  Gtk.Notebook es una pesta√±a, como en un navegador </li><li>  Gtk.VBox es un contenedor para estructurar verticalmente una lista de widgets </li><li>  Gtk.Label es un elemento b√°sico, una inscripci√≥n, con la capacidad de formatear HTML </li></ul><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildPrefsWidget</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    Gtk.Notebook    GUI let notebook = new Gtk.Notebook(); ... //  About,    VBox c   10 , //   margin/padding   let aboutBox = new Gtk.VBox({ border_width: 10 }); //     About notebook.append_page( aboutBox, new Gtk.Label({label: "About"}), ); //        , //      ,    (expand) aboutBox.pack_start( new Gtk.Label({ label: "&lt;b&gt;Do Not Disturb Time&lt;/b&gt;", use_markup: true, }), true, // expand true, // fill 0, ); ... notebook.show_all(); return notebook; }</span></span></code> </pre> <br><p>  Captura de pantalla final: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f87/554/787/f8755478763d159cbb9dfc1518881e60.png"></p><br><h2 id="dopolnitelno">  Opcional </h2><br><div class="spoiler">  <b class="spoiler_title">1. Modos de operaci√≥n: soporte y operaci√≥n</b> <div class="spoiler_text"><p>  El trabajo del programador implica 2 modos en mi caso: <br>  1) en modo de soporte, cuando necesita responder r√°pidamente a eventos: correo, Slack, Skype y m√°s <br>  2) en el modo operativo, cuando es vital reducir las notificaciones durante al menos 20 minutos, de lo contrario se pierde el foco y la productividad laboral final es insignificante.  Para esto, el modo No molestar es √∫til. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">2. C√≥mo apagar el sonido</b> <div class="spoiler_text"><p>  Puede parecer que un silencio total, silencio, es demasiado.  De hecho, de hecho, idealmente, le gustar√≠a que las llamadas de Slack / Skype se escuchen en el modo No molestar, pero el resto de sonidos (notificaciones reales) no lo son.  Pero para esto necesitan ser distinguidos de alguna manera.  Por supuesto, puede crear una API s√≥lida espec√≠ficamente para notificaciones (y esto ya existe), solo que siempre hay un programa / programador que no utiliza dicha funcionalidad.  Un ejemplo es el correo de Mailspring: simplemente reproduce sonidos a trav√©s de la etiqueta de <code>audio</code> , y no se pueden distinguir de ninguna manera, por ejemplo, del habla en una llamada de Slack. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">3. PanelMenu.Button</b> <div class="spoiler_text"><p>  PanelMenu.Button: este es el bot√≥n real en el panel + men√∫ emergente, y puede resolverlo usted mismo y crearlo desde cero, ¬°ambos ser√°n apreciados por los <em>chicos de la herida</em> !  Estaba buscando un resultado r√°pido y, por lo tanto, copi√© el c√≥digo de la documentaci√≥n no oficial. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">4. SetStatusRemote ()</b> <div class="spoiler_text"><p>  Realmente inicie un cambio de modo usando SetStatusRemote (). </p></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es428187/">https://habr.com/ru/post/es428187/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es428175/index.html">Implementaci√≥n de Cunning Prefix Tree C</a></li>
<li><a href="../es428177/index.html">Entonces, ¬øqu√© hay de malo en la b√∫squeda de empleo / trabajadores en TI?</a></li>
<li><a href="../es428179/index.html">En una subasta japonesa, un prototipo de controlador Wii, desarrollado para GameCube</a></li>
<li><a href="../es428181/index.html">M√°quina Moral: ¬ødespiadada o sin sentido?</a></li>
<li><a href="../es428183/index.html">Implementaci√≥n del algoritmo Levenberg-Marquardt para optimizar redes neuronales en TensorFlow</a></li>
<li><a href="../es428189/index.html">¬øQui√©n es un palad√≠n?</a></li>
<li><a href="../es428191/index.html">¬øQu√© debemos organizar para un hackathon o c√≥mo realizamos un hackathon interno?</a></li>
<li><a href="../es428193/index.html">Sobre ir de gira</a></li>
<li><a href="../es428197/index.html">Finanzas personales efectivas. Nivel 1</a></li>
<li><a href="../es428201/index.html">Agujeros moleculares en JavaScript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>