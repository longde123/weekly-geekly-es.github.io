<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåæ ‚òùüèª ‚§¥Ô∏è Th√©orie et pratique des sauvegardes avec Borg üëáüèø üë®üèø‚Äçüíº ‚úçüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√Ä notre grande surprise, il n'y avait pas un seul √©l√©ment sur le merveilleux outil Open Source pour la sauvegarde de donn√©es - Borg (√† ne pas confondr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Th√©orie et pratique des sauvegardes avec Borg</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/420055/"><img src="https://habrastorage.org/webt/xx/7w/tn/xx7wtnr5mv7mjndz-uzowsql58o.png"><br><br>  √Ä notre grande surprise, il n'y avait pas un seul √©l√©ment sur le merveilleux outil Open Source pour la sauvegarde de donn√©es - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Borg</a> <i>(√† ne pas confondre avec le prog√©niteur √©ponyme Kubernetes!)</i> .  Depuis que nous l'utilisons en production depuis plus d'un an, je partagerai dans cet article les ¬´impressions¬ª que nous avons acquises sur Borg. <a name="habracut"></a><br><br><h2>  Contexte: Exp√©rience avec Bacula et Bareos </h2><br>  En 2017, nous en avions assez de Bacula et Bareos, que nous utilisions depuis le tout d√©but de notre activit√© (soit environ 9 ans de production √† l'√©poque).  Pourquoi?  Pendant le fonctionnement, nous avons accumul√© beaucoup de m√©contentement: <br><br><ul><li>  SD (Storage Daemon) se bloque.  Si vous avez configur√© le parall√©lisme, la maintenance SD devient plus compliqu√©e et son gel bloquera les sauvegardes suppl√©mentaires dans les d√©lais et la possibilit√© de r√©cup√©ration. </li><li>  Il est n√©cessaire de g√©n√©rer des configurations pour le client et le directeur.  M√™me si nous automatisons cela (dans notre cas, Chef, Ansible et notre propre d√©veloppement ont √©t√© utilis√©s √† des moments diff√©rents), nous devons surveiller que le r√©alisateur, apr√®s son <i>rechargement, a</i> effectivement r√©cup√©r√© la configuration.  Ceci est seulement suivi dans la sortie de la commande de <i>rechargement</i> et dans l'appel de <i>messages</i> apr√®s (pour obtenir le texte d'erreur lui-m√™me). </li><li>  Planifiez des sauvegardes.  Les d√©veloppeurs de Bacula ont d√©cid√© de suivre leur propre chemin et ont √©crit leur propre format de calendrier, que vous ne pouvez pas simplement analyser ou convertir en un autre.  Voici des exemples de planifications de sauvegarde standard dans nos anciennes installations: <ul><li>  Sauvegarde compl√®te quotidienne le mercredi et incr√©mentielle les autres jours: <br> <code>Run = Level=Full Pool="Foobar-low7" wed at 18:00 <br> Run = Level=Incremental Pool="Foobar-low7" at 18:00</code> </li> <li>  Sauvegarde compl√®te des fichiers wal 2 fois par mois et incr√©mentation toutes les heures: <br> <code>Run = Level=Full FullPool=CustomerWALPool 1st fri at 01:45 <br> Run = Level=Full FullPool=CustomerWALPool 3rd fri at 01:45 <br> Run = Level=Incremental FullPool=CustomerWALPool IncrementalPool=CustomerWALPool on hourly</code> </li> <li>  Le <code>schedule</code> g√©n√©r√© pour toutes les occasions (√† diff√©rents jours de la semaine toutes les 2 heures), nous avons obtenu environ 1665 ... √† cause de ce que Bacula / Bareos devenait p√©riodiquement fou. </li></ul></li><li>  Bacula-fd (et bareos-fd) ont des r√©pertoires avec beaucoup de donn√©es (disons 40 To, dont 35 To contiennent des fichiers volumineux [100+ Mo] et les 5 To restants contiennent de petits fichiers [1 Ko √† 100 Mo ]) une lente fuite de m√©moire commence, ce qui est une situation tr√®s d√©sagr√©able en production. <br><br><img src="https://habrastorage.org/webt/eu/33/ao/eu33aocunyesaxcwtlyzzim_eha.png"></li><li>  Sur les sauvegardes avec un grand nombre de fichiers, Bacula et Bareos sont tr√®s d√©pendants des performances du SGBD utilis√©.  De quels disques dispose-t-il?  Dans quelle mesure savez-vous comment l'adapter √† ces besoins sp√©cifiques?  Et dans la base de donn√©es, au fait, une (!) Table non partitionnable est cr√©√©e avec une liste de tous les fichiers dans toutes les sauvegardes et la seconde - avec une liste de tous les chemins dans toutes les sauvegardes.  Si vous n'√™tes pas pr√™t √† allouer au moins 8 Go de RAM pour la base + 40 Go de SSD pour votre serveur de sauvegarde - pr√©parez-vous imm√©diatement pour les freins. </li><li>  La d√©pendance √† la base de donn√©es m√©rite un point de plus.  Bacula / Bareos pour chaque fichier demande au r√©alisateur s'il existait d√©j√† un tel fichier.  Le directeur, bien s√ªr, rampe dans la base de donn√©es, dans ces tables tr√®s √©normes ... Il s'av√®re que la sauvegarde peut √™tre bloqu√©e simplement par le fait que plusieurs sauvegardes lourdes ont d√©marr√© en m√™me temps - m√™me si le diff y est de plusieurs m√©gaoctets. </li></ul><br><img src="https://habrastorage.org/webt/nh/iw/dz/nhiwdzn69dvunjisjzcwcy1fyna.png"><br><br>  Il serait injuste de dire qu‚Äôaucun probl√®me n‚Äôa √©t√© r√©solu, mais nous en sommes arriv√©s au point o√π nous √©tions vraiment fatigu√©s de diverses solutions de contournement et voulions une solution fiable ¬´ici et maintenant¬ª. <br><br>  Bacula / Bareos fonctionnent tr√®s bien avec un petit nombre (10-30) d'emplois uniformes.  Une petite chose s'est-elle cass√©e une fois par semaine?  Ce n'est pas grave: ils ont confi√© la t√¢che √† l'officier de service (ou √† un autre ing√©nieur) - ils l'ont r√©par√©e.  Cependant, nous avons des projets dans lesquels le nombre d'emplois est de plusieurs centaines et le nombre de fichiers qu'ils contiennent est de centaines de milliers.  En cons√©quence, 5 minutes par semaine pour corriger la sauvegarde (sans compter plusieurs heures de param√®tres avant cela) ont commenc√© √† se multiplier.  Tout cela a conduit au fait que 2 heures par jour, il √©tait n√©cessaire de r√©parer les sauvegardes dans tous les projets, car litt√©ralement partout quelque chose √©tait insignifiant ou s√©rieusement cass√©. <br><br>  Ensuite, quelqu'un pourrait penser qu'un ing√©nieur d√©di√© d√©di√© √† cela devrait faire des sauvegardes.  Certes, il sera aussi barbu et s√©v√®re que possible, et de son regard, les sauvegardes sont r√©par√©es instantan√©ment, pendant qu'il sirote calmement du caf√©.  Et cette id√©e peut √™tre vraie en quelque sorte ... Mais il y a toujours un mais.  Tout le monde ne peut pas se permettre de r√©parer et de surveiller les sauvegardes 24 heures sur 24, et plus encore - un ing√©nieur affect√© √† ces fins.  Nous sommes juste s√ªrs qu'il vaut mieux passer ces 2 heures par jour sur quelque chose de plus productif et utile.  Par cons√©quent, nous sommes pass√©s √† la recherche de solutions alternatives qui ¬´fonctionnent tout simplement¬ª. <br><br><h2>  Borg comme une nouvelle fa√ßon </h2><br>  La recherche d'autres options Open Source s'est √©tal√©e dans le temps, il est donc difficile d'estimer le co√ªt total, mais √† un moment donn√© (l'ann√©e derni√®re), notre attention s'est tourn√©e vers le ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">h√©ros de l'</a> occasion¬ª - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BorgBackup</a> (ou simplement Borg).  Cela a √©t√© en partie facilit√© par l'exp√©rience r√©elle de son utilisation par l'un de nos ing√©nieurs (sur le lieu de travail pr√©c√©dent). <br><br>  Borg est √©crit en Python (la version&gt; = 3.4.0 est requise) et le code exigeant en termes de performances (compression, chiffrement, etc.) est impl√©ment√© en C / Cython.  Distribu√© sous une licence BSD gratuite (3 clauses).  Il prend en charge de nombreuses plates-formes, y compris Linux, * BSD, macOS, ainsi qu'au niveau exp√©rimental Cygwin et sous-syst√®me Linux de Windows 10. Pour installer BorgBackup, des packages sont disponibles pour les distributions Linux populaires et d'autres syst√®mes d'exploitation, ainsi que des codes source, qui peuvent √©galement √™tre install√©s via pip, - des informations plus d√©taill√©es √† ce sujet peuvent √™tre trouv√©es dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projet</a> . <br><br>  Pourquoi Borg nous a-t-il tant corrompu?  Voici ses principaux avantages: <br><br><ul><li>  <b>D√©duplication</b> : r√©elle et tr√®s efficace (exemples ci-dessous).  Les fichiers d'un m√™me r√©f√©rentiel Borg (c'est-√†-dire un r√©pertoire sp√©cial dans un format sp√©cifique √† Borg) sont divis√©s en blocs de n m√©gaoctets et les blocs Borg r√©p√©t√©s sont d√©dupliqu√©s.  La d√©duplication se produit pr√©cis√©ment avant la compression. </li><li>  <b>Compression</b> : apr√®s d√©duplication, les donn√©es sont √©galement compress√©es.  Diff√©rents algorithmes de compression sont disponibles: lz4, lzma, zlib, zstd.  La fonctionnalit√© standard de toute sauvegarde, mais ce n'est pas moins utile. </li><li>  <b>Travail sur SSH</b> : sauvegardes Borg sur un serveur distant via SSH.  C√¥t√© serveur, il suffit d'installer Borg et c'est tout!  √Ä partir d'ici, des avantages tels que la s√©curit√© et le chiffrement suivent imm√©diatement.  Vous ne pouvez configurer l'acc√®s que par des cl√©s et, de plus, l'ex√©cution par Borg d'une seule de ses commandes lors de son entr√©e sur le serveur.  Par exemple, comme ceci: <br><br><pre> <code class="bash hljs">$ cat .ssh/authorized_keys <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-string"><span class="hljs-string">"/usr/bin/borg serve"</span></span> ssh-rsa AAAAB3NzaC1yc‚Ä¶</code> </pre> </li><li>  Il est livr√© √† la fois en PPA (nous utilisons principalement Ubuntu) et en <b>binaire statique</b> .  Borg sous la forme d'un binaire statique permet de l'ex√©cuter presque partout o√π il y a au moins une glibc minimalement moderne.  (Mais pas partout - par exemple, il n'a pas √©t√© possible de d√©marrer sur CentOS 5.) </li><li>  <b>Nettoyage</b> flexible <b>des anciennes sauvegardes</b> .  Vous pouvez d√©finir le stockage des n derni√®res sauvegardes et 2 sauvegardes par heure / jour / semaine.  Dans ce dernier cas, la derni√®re sauvegarde en fin de semaine sera laiss√©e.  Les conditions peuvent √™tre combin√©es en stockant 7 sauvegardes quotidiennes pour les 7 derniers jours et 4 sauvegardes hebdomadaires. </li></ul><br>  La transition vers Borg a commenc√© lentement sur de petits projets.  Au d√©but, il s'agissait de simples scripts cron qui faisaient leur travail tous les jours.  Cela a dur√© environ six mois.  Pendant ce temps, nous avons d√ª obtenir des sauvegardes plusieurs fois ... et il s'est av√©r√© que Borg n'avait pas du tout besoin d'√™tre r√©par√© litt√©ralement!  Pourquoi?  Parce que le principe simple fonctionne ici: "Plus le m√©canisme est simple, moins il y aura de cassures." <br><br><h2>  Pratique: comment sauvegarder avec Borg? </h2><br>  Prenons un exemple simple de cr√©ation d'une sauvegarde: <br><br><ol><li>  T√©l√©chargez la derni√®re version binaire sur le serveur de sauvegarde et la machine que nous allons sauvegarder √† partir du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rentiel officiel</a> : <br><br><pre> <code class="bash hljs">sudo wget https://github.com/borgbackup/borg/releases/download/1.1.6/borg-linux64 -O /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/borg sudo chmod +x /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/borg</code> </pre> <br>  <i><b>Remarque</b> : Si vous utilisez une machine locale pour le test √† la fois en tant que source et en tant que r√©cepteur, alors toute la diff√©rence ne sera que dans l'URI, que nous transmettrons, mais nous nous souvenons que la sauvegarde doit √™tre stock√©e s√©par√©ment, et non sur la m√™me machine.</i> </li><li>  Sur le serveur de sauvegarde, cr√©ez l'utilisateur <code>borg</code> : <br><br><pre> <code class="bash hljs">sudo useradd -m borg</code> </pre> <br>  Simple: sans groupes et avec un shell standard, mais toujours avec un r√©pertoire personnel. </li><li>  Une cl√© SSH est g√©n√©r√©e sur le client: <br><br><pre> <code class="bash hljs">ssh-keygen</code> </pre> </li><li>  Sur le serveur, ajoutez la cl√© g√©n√©r√©e √† l'utilisateur <code>borg</code> : <br><br><pre> <code class="bash hljs">mkdir ~borg/.ssh <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'command="/usr/local/bin/borg serve" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf/XmSVWfF7PfjGlbKW00MJ63zal/E/mxm+vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU/JNU0jITLx+vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk/QmteOOclzx684t9d6BhMvFE9w9r+c76aVBIdbEyrkloiYd+vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44/Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam+9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y+IQM7fbDR'</span></span> &gt; ~borg/.ssh/authorized_keys chown -R borg:borg ~borg/.ssh</code> bin local / / borg servir" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf / XmSVWfF7PfjGlbKW00MJ63zal / E / MXM + vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU / JNU0jITLx + vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk / QmteOOclzx684t9d6BhMvFE9w9r + c76aVBIdbEyrkloiYd + vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44 / Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam + 9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y + IQM7fbDR'&gt; ~ borg / .ssh <code class="bash hljs">mkdir ~borg/.ssh <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'command="/usr/local/bin/borg serve" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf/XmSVWfF7PfjGlbKW00MJ63zal/E/mxm+vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU/JNU0jITLx+vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk/QmteOOclzx684t9d6BhMvFE9w9r+c76aVBIdbEyrkloiYd+vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44/Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam+9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y+IQM7fbDR'</span></span> &gt; ~borg/.ssh/authorized_keys chown -R borg:borg ~borg/.ssh</code> </pre> </li><li>  Nous initialisons le <i>d√©p√¥t borg</i> sur le serveur √† partir du client: <br><br><pre> <code class="bash hljs">ssh borg@172.17.0.3 hostname <span class="hljs-comment"><span class="hljs-comment">#     borg init -e none borg@172.17.0.3:MyBorgRepo</span></span></code> </pre> <br>  Le commutateur <code>-e</code> est utilis√© pour s√©lectionner la m√©thode de chiffrement pour le r√©f√©rentiel (oui, vous pouvez √©galement chiffrer chaque r√©f√©rentiel avec votre mot de passe!).  Dans ce cas, car  ceci est un exemple, nous n'utilisons pas de cryptage.  <code>MyBorgRepo</code> est le nom du r√©pertoire dans lequel le <i>d√©p√¥t de borg</i> sera (vous n'avez pas besoin de le cr√©er √† l'avance - Borg fera tout lui-m√™me). </li><li>  Lancez la premi√®re sauvegarde √† l'aide de Borg: <br><br><pre> <code class="bash hljs">borg create --stats --list borg@172.17.0.3:MyBorgRepo::<span class="hljs-string"><span class="hljs-string">"MyFirstBackup-{now:%Y-%m-%d_%H:%M:%S}"</span></span> /etc /root</code> </pre> <br>  √Ä propos des cl√©s: <br><ul><li>  <code>--stats</code> et <code>--list</code> nous donnent des statistiques sur la sauvegarde et les fichiers qui y sont entr√©s; </li><li>  <code>borg@172.17.0.3:MyBorgRepo</code> - tout est clair ici, c'est notre serveur et notre r√©pertoire.  Et quelle est la prochaine √©tape pour la magie? .. </li><li>  <code>::"MyFirstBackup-{now:%Y-%m-%d_%H:%M:%S}"</code> est le nom de l'archive √† l'int√©rieur du r√©f√©rentiel.  C'est arbitraire, mais nous adh√©rons au format <code>_-timestamp</code> (horodatage au format Python). </li></ul></li></ol><br>  Et ensuite?  Bien s√ªr, voyez ce qui est entr√© dans notre sauvegarde!  Liste des archives √† l'int√©rieur du r√©f√©rentiel: <br><br><pre> <code class="bash hljs">borg@b3e51b9ed2c2:~$ borg list MyBorgRepo/ Warning: Attempting to access a previously unknown unencrypted repository! Do you want to <span class="hljs-built_in"><span class="hljs-built_in">continue</span></span>? [yN] y MyFirstBackup-2018-08-04_16:55:53 Sat, 2018-08-04 16:55:54 [89f7b5bccfb1ed2d72c8b84b1baf477a8220955c72e7fcf0ecc6cd5a9943d78d]</code> </pre> <br>  Nous voyons une sauvegarde avec un horodatage et comment Borg nous demande si nous voulons vraiment acc√©der √† un r√©f√©rentiel non crypt√© auquel nous n'avons jamais √©t√© auparavant. <br><br>  Nous regardons la liste des fichiers: <br><br><pre> <code class="bash hljs">borg list MyBorgRepo::MyFirstBackup-2018-08-04_16:55:53</code> </pre> <br>  Nous obtenons le fichier de la sauvegarde (vous pouvez aussi tout le r√©pertoire): <br><br><pre> <code class="bash hljs">borg@b3e51b9ed2c2:~$ borg extract MyBorgRepo::MyFirstBackup-2018-08-04_16:55:53 etc/hostname borg@b3e51b9ed2c2:~$ ll etc/hostname -rw-r--r-- 1 borg borg 13 Aug 4 16:27 etc/hostname</code> </pre> <br>  F√©licitations, votre premi√®re sauvegarde Borg est pr√™te! <br><br><h2>  Pratique: automatisez ceci [avec GitLab]! </h2><br>  Apr√®s avoir envelopp√© tout cela dans des scripts, nous avons configur√© manuellement les sauvegardes de mani√®re similaire sur environ 40 h√¥tes.  R√©alisant que Borg fonctionne vraiment, ils ont commenc√© √† y transf√©rer de plus en plus de projets ... <br><br>  Et ici, nous sommes confront√©s √† ce qui se trouve √† Bareos, mais pas √† Borg!  √Ä savoir: WebUI ou une sorte de lieu centralis√© pour configurer les sauvegardes.  Et nous esp√©rons vraiment qu'il s'agit d'un ph√©nom√®ne temporaire, mais jusqu'√† pr√©sent, nous avons d√ª r√©soudre quelque chose.  Googler les outils finis et se r√©unir dans une vid√©oconf√©rence, nous nous sommes mis au travail.  C'√©tait une excellente id√©e d'int√©grer Borg √† nos services internes, comme nous l'avons fait auparavant avec Bacula (Bacula lui-m√™me a retir√© la liste des t√¢ches de notre API centralis√©e, √† laquelle nous avions notre propre interface int√©gr√©e avec d'autres param√®tres de projet).  Nous avons r√©fl√©chi √† la fa√ßon de le faire, d√©crit un plan de comment et o√π le construire, mais ... Des sauvegardes normales sont n√©cessaires maintenant, mais il n'y a aucun endroit pour prendre des plans de temps grandioses.  Que faire <br><br>  Les questions et les exigences √©taient approximativement les suivantes: <br><br><ul><li>  Que faut-il utiliser comme gestion de sauvegarde centralis√©e? </li><li>  Que peut faire n'importe quel administrateur Linux? </li><li>  Que peut m√™me un gestionnaire qui montre un calendrier de sauvegarde aux clients peut comprendre et configurer? </li><li>  Que fait quotidiennement une t√¢che planifi√©e sur votre syst√®me? </li><li>  Qu'est-ce qui ne sera pas difficile √† configurer et ne cassera pas? .. </li></ul><br>  La r√©ponse √©tait √©vidente: c'est le bon vieux crond, qui accomplit h√©ro√Øquement son devoir tous les jours.  C'est simple.  Il ne g√®le pas.  M√™me le gestionnaire qui est d'Unix √† ¬´vous¬ª peut y rem√©dier. <br><br>  Alors crontab, mais o√π gardez-vous tout cela?  Est-ce √† chaque fois d'aller sur la machine du projet et d'√©diter le fichier avec vos mains?  Bien s√ªr que non.  Nous pouvons mettre notre planning dans le r√©f√©rentiel Git et configurer GitLab Runner, qui par commit le mettra √† jour sur l'h√¥te. <br><br>  <i><b>Remarque</b> : C'est GitLab qui a √©t√© choisi comme outil d'automatisation, car il est pratique pour la t√¢che et dans notre cas, il est presque partout.</i>  <i>Mais je dois dire qu'il n'est nullement une n√©cessit√©.</i> <br><br>  Vous pouvez √©tendre crontab pour les sauvegardes √† l'aide d'un outil d'automatisation familier ou g√©n√©ralement manuellement (sur de petits projets ou des installations domestiques). <br><br>  Voici donc ce dont vous avez besoin pour une automatisation simple: <br><br>  1. <b>GitLab et un r√©f√©rentiel</b> , dans lequel pour commencer il y aura deux fichiers: <br><br><ul><li>  <code>schedule</code> - calendrier de sauvegarde </li><li>  <code>borg_backup_files.sh</code> - un script simple pour sauvegarder des fichiers (comme dans l'exemple ci-dessus). </li></ul><br>  Exemple d' <code>schedule</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># WARNING! CRONTAB MANAGED FROM GITLAB CI RUNNER IN ${CI_PROJECT_URL} # CI_COMMIT_SHA: ${CI_COMMIT_SHA} # Branch/tag: ${CI_COMMIT_REF_NAME} # Timestamp: ${TIMESTAMP} PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin # MyRemoteHost 0 0 * * * ${CI_PROJECT_DIR}/borg_backup_files.sh 'SYSTEM /etc,/opt'</span></span></code> </pre> <br>  Les variables CI sont utilis√©es pour v√©rifier que la mise √† jour de crontab a r√©ussi et <code>CI_PROJECT_DIR</code> est le r√©pertoire dans lequel le r√©f√©rentiel se trouvera apr√®s le clonage du runner.  La derni√®re ligne indique que la sauvegarde est effectu√©e tous les jours √† minuit. <br><br>  Exemple <code>borg_backup_files.sh</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash BORG_SERVER="borg@10.100.1.1" NAMEOFBACKUP=${1} DIRS=${2} REPOSITORY="${BORG_SERVER}:$(hostname)-${NAMEOFBACKUP}" borg create --list -v --stats \ $REPOSITORY::"files-{now:%Y-%m-%d_%H:%M:%S}" \ $(echo $DIRS | tr ',' ' ') || \ echo "borg create failed"</span></span></code> </pre> <br>  <i>Le premier</i> argument ici est le nom de la sauvegarde, et le <i>second</i> est la liste des r√©pertoires de la sauvegarde, s√©par√©s par des virgules.  √Ä strictement parler, une liste peut √©galement √™tre un ensemble de fichiers distincts. <br><br>  2. <b>GitLab Runner</b> , fonctionnant sur la machine √† sauvegarder et bloqu√© uniquement pour les travaux de ce r√©f√©rentiel. <br><br>  3. <b>Le script CI lui</b> - <b>m√™me</b> , impl√©ment√© par le <code>.gitlab-ci.yml</code> : <br><br><pre> <code class="hljs pgsql">stages: - deploy Deploy: stage: deploy script: - export <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>=$(<span class="hljs-type"><span class="hljs-type">date</span></span> <span class="hljs-string"><span class="hljs-string">'+%Y.%m.%d %H:%M:%S'</span></span>) - cat schedule | envsubst | crontab - tags: - borg-backup</code> </pre> <br>  4. La <b>cl√© SSH</b> pour l'utilisateur <code>gitlab-runner</code> ayant acc√®s au serveur de <code>gitlab-runner</code> (dans l'exemple, il s'agit de 10.100.1.1).  Par d√©faut, il doit se trouver dans le <code>.ssh/id_rsa</code> ( <code>gitlab-runner</code> ). <br><br>  5. <b>L'utilisateur <code>borg</code></b> sur le m√™me 10.100.1.1 avec acc√®s uniquement √† la commande <code>borg serve</code> : <br><br><pre> <code class="bash hljs">$ cat .ssh/authorized_keys <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-string"><span class="hljs-string">"/usr/bin/borg serve"</span></span> ssh-rsa AAAAB3NzaC1yc2EAA...</code> </pre> <br>  Maintenant, lorsque vous vous engagez dans le r√©f√©rentiel Runner, il remplira le contenu de crontab.  Et lorsque le temps de r√©ponse du cron arrive, une sauvegarde des r√©pertoires <code>/etc</code> et <code>/opt</code> sera effectu√©e, qui sera sur le serveur de sauvegarde dans le <code>MyHostname-SYSTEM</code> du serveur 10.100.1.1. <br><br><img src="https://habrastorage.org/webt/ud/n7/wb/udn7wbd4vqknfq6cguw5wmi7tcq.png"><br><br><h2>  Au lieu d'une conclusion: que pouvez-vous faire d'autre? </h2><br>  Bien entendu, l'utilisation de Borg √† cet √©gard ne s'arr√™te pas l√†.  Voici quelques id√©es pour une mise en ≈ìuvre ult√©rieure, dont certaines que nous avons d√©j√† mises en ≈ìuvre √† la maison: <br><br><ul><li>  <b>Ajoutez des scripts universels</b> pour diff√©rentes sauvegardes qui, √† la fin de l'ex√©cution, ex√©cutent <code>borg_backup_files.sh</code> , visant le r√©pertoire avec le r√©sultat de leur travail.  Par exemple, vous pouvez sauvegarder PostgreSQL (pg_basebackup), MySQL (innobackupex), GitLab (travail de r√¢teau int√©gr√©, cr√©ation d'une archive). </li><li>  <b>H√¥te central avec <i>calendrier</i> de sauvegarde</b> .  Ne pas configurer sur chaque h√¥te GitLab Runner?  Laissez-le √™tre seul sur le serveur de sauvegarde et crontab au d√©marrage transf√®re le script de sauvegarde sur la machine et l'ex√©cute l√†-bas.  Pour cela, bien s√ªr, vous aurez besoin de l'utilisateur <code>borg</code> sur la machine client et <code>ssh-agent</code> , afin de ne pas disposer la cl√© du serveur de sauvegarde sur chaque machine. </li><li>  <b>Suivi</b>  O√π sans lui!  Les alertes concernant une sauvegarde incorrecte doivent √™tre. </li><li>  <b>Suppression du d√©p√¥t borg des anciennes archives.</b>  Malgr√© une bonne d√©duplication, les anciennes sauvegardes doivent encore √™tre nettoy√©es.  Pour ce faire, vous pouvez appeler <code>borg prune</code> √† la fin du script de sauvegarde. </li><li>  <b>Interface Web</b> au planning.  Cela vous sera utile si l'√©dition de crontab √† la main ou dans l'interface Web ne vous semble pas solide / inconfortable. </li><li>  <b>Diagrammes √† secteurs</b> .  Quelques graphiques pour une repr√©sentation visuelle du pourcentage de sauvegardes r√©ussies, de leur temps d'ex√©cution, de la largeur du canal "mang√©".  Pas √©tonnant que j'aie √©crit qu'il n'y a pas assez de WebUI, comme dans Bareos ... </li><li>  <b>Actions simples</b> que je souhaiterais recevoir par un bouton: lancement d'une sauvegarde √† la demande, restauration sur une machine, etc. </li></ul><br>  Et √† la toute fin, je voudrais ajouter un exemple de l'efficacit√© de la d√©duplication sur une v√©ritable sauvegarde de travail des fichiers PostgreSQL WAL dans un environnement de production: <br><br><pre> <code class="bash hljs">borg@backup ~ $ borg info PROJECT-PG-WAL Repository ID: 177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 Location: /mnt/borg/PROJECT-PG-WAL Encrypted: No Cache: /mnt/borg/.cache/borg/177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 Security dir: /mnt/borg/.config/borg/security/177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 ------------------------------------------------------------------------------ Original size Compressed size Deduplicated size All archives: 6.68 TB 6.70 TB 19.74 GB Unique chunks Total chunks Chunk index: 11708 3230099</code> </pre> <br>  Ce sont 65 jours de sauvegarde des fichiers WAL qui sont effectu√©s toutes les heures.  Lors de l'utilisation de Bacula / Bareos, c'est-√†-dire  sans d√©duplication, nous obtiendrions 6,7 To de donn√©es.  Pensez-y: nous pouvons nous permettre de stocker pr√®s de 7 t√©raoctets de donn√©es transmises via PostgreSQL, seulement 20 Go d'espace r√©ellement occup√©. <br><br><h2>  PS </h2><br>  Lisez aussi dans notre blog: <br><br><ul><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Th√©orie et pratique des mises √† niveau sans assistance dans Ubuntu</a> ¬ª; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Junior, qui le premier jour de travail a supprim√© la base de donn√©es de la production</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Acc√©l√©rer l'amor√ßage de grandes bases de donn√©es avec Kubernetes</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr420055/">https://habr.com/ru/post/fr420055/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr420041/index.html">TypeScript War ou Enum Conquest</a></li>
<li><a href="../fr420045/index.html">Bunker pour la date: comment j'ai √©t√© autoris√© √† me promener dans le centre de donn√©es RUVDS sur le territoire de l'usine spatiale</a></li>
<li><a href="../fr420049/index.html">Le livre "L'homme parle. √âvolution et langage</a></li>
<li><a href="../fr420051/index.html">[DotNetBook] √âtendue, m√©moire et ReadOnlyMemory</a></li>
<li><a href="../fr420053/index.html">Veeam Academy for C # Developers: Nouvelle saison</a></li>
<li><a href="../fr420057/index.html">8 r√®gles pour un pigiste r√©ussi</a></li>
<li><a href="../fr420059/index.html">Maintenant, je suis chef d'√©quipe, mais pourquoi suis-je si malade? Conseils pratiques</a></li>
<li><a href="../fr420061/index.html">Nous √©valuons les processus dans l'√©quipe de d√©veloppement sur la base de donn√©es objectives</a></li>
<li><a href="../fr420063/index.html">"Saint" Timlid et ses disciples</a></li>
<li><a href="../fr420065/index.html">La communication comme zone de performance du travail d'√©quipe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>