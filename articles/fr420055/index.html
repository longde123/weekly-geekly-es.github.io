<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌾 ☝🏻 ⤴️ Théorie et pratique des sauvegardes avec Borg 👇🏿 👨🏿‍💼 ✍🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="À notre grande surprise, il n'y avait pas un seul élément sur le merveilleux outil Open Source pour la sauvegarde de données - Borg (à ne pas confondr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Théorie et pratique des sauvegardes avec Borg</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/420055/"><img src="https://habrastorage.org/webt/xx/7w/tn/xx7wtnr5mv7mjndz-uzowsql58o.png"><br><br>  À notre grande surprise, il n'y avait pas un seul élément sur le merveilleux outil Open Source pour la sauvegarde de données - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Borg</a> <i>(à ne pas confondre avec le progéniteur éponyme Kubernetes!)</i> .  Depuis que nous l'utilisons en production depuis plus d'un an, je partagerai dans cet article les «impressions» que nous avons acquises sur Borg. <a name="habracut"></a><br><br><h2>  Contexte: Expérience avec Bacula et Bareos </h2><br>  En 2017, nous en avions assez de Bacula et Bareos, que nous utilisions depuis le tout début de notre activité (soit environ 9 ans de production à l'époque).  Pourquoi?  Pendant le fonctionnement, nous avons accumulé beaucoup de mécontentement: <br><br><ul><li>  SD (Storage Daemon) se bloque.  Si vous avez configuré le parallélisme, la maintenance SD devient plus compliquée et son gel bloquera les sauvegardes supplémentaires dans les délais et la possibilité de récupération. </li><li>  Il est nécessaire de générer des configurations pour le client et le directeur.  Même si nous automatisons cela (dans notre cas, Chef, Ansible et notre propre développement ont été utilisés à des moments différents), nous devons surveiller que le réalisateur, après son <i>rechargement, a</i> effectivement récupéré la configuration.  Ceci est seulement suivi dans la sortie de la commande de <i>rechargement</i> et dans l'appel de <i>messages</i> après (pour obtenir le texte d'erreur lui-même). </li><li>  Planifiez des sauvegardes.  Les développeurs de Bacula ont décidé de suivre leur propre chemin et ont écrit leur propre format de calendrier, que vous ne pouvez pas simplement analyser ou convertir en un autre.  Voici des exemples de planifications de sauvegarde standard dans nos anciennes installations: <ul><li>  Sauvegarde complète quotidienne le mercredi et incrémentielle les autres jours: <br> <code>Run = Level=Full Pool="Foobar-low7" wed at 18:00 <br> Run = Level=Incremental Pool="Foobar-low7" at 18:00</code> </li> <li>  Sauvegarde complète des fichiers wal 2 fois par mois et incrémentation toutes les heures: <br> <code>Run = Level=Full FullPool=CustomerWALPool 1st fri at 01:45 <br> Run = Level=Full FullPool=CustomerWALPool 3rd fri at 01:45 <br> Run = Level=Incremental FullPool=CustomerWALPool IncrementalPool=CustomerWALPool on hourly</code> </li> <li>  Le <code>schedule</code> généré pour toutes les occasions (à différents jours de la semaine toutes les 2 heures), nous avons obtenu environ 1665 ... à cause de ce que Bacula / Bareos devenait périodiquement fou. </li></ul></li><li>  Bacula-fd (et bareos-fd) ont des répertoires avec beaucoup de données (disons 40 To, dont 35 To contiennent des fichiers volumineux [100+ Mo] et les 5 To restants contiennent de petits fichiers [1 Ko à 100 Mo ]) une lente fuite de mémoire commence, ce qui est une situation très désagréable en production. <br><br><img src="https://habrastorage.org/webt/eu/33/ao/eu33aocunyesaxcwtlyzzim_eha.png"></li><li>  Sur les sauvegardes avec un grand nombre de fichiers, Bacula et Bareos sont très dépendants des performances du SGBD utilisé.  De quels disques dispose-t-il?  Dans quelle mesure savez-vous comment l'adapter à ces besoins spécifiques?  Et dans la base de données, au fait, une (!) Table non partitionnable est créée avec une liste de tous les fichiers dans toutes les sauvegardes et la seconde - avec une liste de tous les chemins dans toutes les sauvegardes.  Si vous n'êtes pas prêt à allouer au moins 8 Go de RAM pour la base + 40 Go de SSD pour votre serveur de sauvegarde - préparez-vous immédiatement pour les freins. </li><li>  La dépendance à la base de données mérite un point de plus.  Bacula / Bareos pour chaque fichier demande au réalisateur s'il existait déjà un tel fichier.  Le directeur, bien sûr, rampe dans la base de données, dans ces tables très énormes ... Il s'avère que la sauvegarde peut être bloquée simplement par le fait que plusieurs sauvegardes lourdes ont démarré en même temps - même si le diff y est de plusieurs mégaoctets. </li></ul><br><img src="https://habrastorage.org/webt/nh/iw/dz/nhiwdzn69dvunjisjzcwcy1fyna.png"><br><br>  Il serait injuste de dire qu’aucun problème n’a été résolu, mais nous en sommes arrivés au point où nous étions vraiment fatigués de diverses solutions de contournement et voulions une solution fiable «ici et maintenant». <br><br>  Bacula / Bareos fonctionnent très bien avec un petit nombre (10-30) d'emplois uniformes.  Une petite chose s'est-elle cassée une fois par semaine?  Ce n'est pas grave: ils ont confié la tâche à l'officier de service (ou à un autre ingénieur) - ils l'ont réparée.  Cependant, nous avons des projets dans lesquels le nombre d'emplois est de plusieurs centaines et le nombre de fichiers qu'ils contiennent est de centaines de milliers.  En conséquence, 5 minutes par semaine pour corriger la sauvegarde (sans compter plusieurs heures de paramètres avant cela) ont commencé à se multiplier.  Tout cela a conduit au fait que 2 heures par jour, il était nécessaire de réparer les sauvegardes dans tous les projets, car littéralement partout quelque chose était insignifiant ou sérieusement cassé. <br><br>  Ensuite, quelqu'un pourrait penser qu'un ingénieur dédié dédié à cela devrait faire des sauvegardes.  Certes, il sera aussi barbu et sévère que possible, et de son regard, les sauvegardes sont réparées instantanément, pendant qu'il sirote calmement du café.  Et cette idée peut être vraie en quelque sorte ... Mais il y a toujours un mais.  Tout le monde ne peut pas se permettre de réparer et de surveiller les sauvegardes 24 heures sur 24, et plus encore - un ingénieur affecté à ces fins.  Nous sommes juste sûrs qu'il vaut mieux passer ces 2 heures par jour sur quelque chose de plus productif et utile.  Par conséquent, nous sommes passés à la recherche de solutions alternatives qui «fonctionnent tout simplement». <br><br><h2>  Borg comme une nouvelle façon </h2><br>  La recherche d'autres options Open Source s'est étalée dans le temps, il est donc difficile d'estimer le coût total, mais à un moment donné (l'année dernière), notre attention s'est tournée vers le « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">héros de l'</a> occasion» - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BorgBackup</a> (ou simplement Borg).  Cela a été en partie facilité par l'expérience réelle de son utilisation par l'un de nos ingénieurs (sur le lieu de travail précédent). <br><br>  Borg est écrit en Python (la version&gt; = 3.4.0 est requise) et le code exigeant en termes de performances (compression, chiffrement, etc.) est implémenté en C / Cython.  Distribué sous une licence BSD gratuite (3 clauses).  Il prend en charge de nombreuses plates-formes, y compris Linux, * BSD, macOS, ainsi qu'au niveau expérimental Cygwin et sous-système Linux de Windows 10. Pour installer BorgBackup, des packages sont disponibles pour les distributions Linux populaires et d'autres systèmes d'exploitation, ainsi que des codes source, qui peuvent également être installés via pip, - des informations plus détaillées à ce sujet peuvent être trouvées dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projet</a> . <br><br>  Pourquoi Borg nous a-t-il tant corrompu?  Voici ses principaux avantages: <br><br><ul><li>  <b>Déduplication</b> : réelle et très efficace (exemples ci-dessous).  Les fichiers d'un même référentiel Borg (c'est-à-dire un répertoire spécial dans un format spécifique à Borg) sont divisés en blocs de n mégaoctets et les blocs Borg répétés sont dédupliqués.  La déduplication se produit précisément avant la compression. </li><li>  <b>Compression</b> : après déduplication, les données sont également compressées.  Différents algorithmes de compression sont disponibles: lz4, lzma, zlib, zstd.  La fonctionnalité standard de toute sauvegarde, mais ce n'est pas moins utile. </li><li>  <b>Travail sur SSH</b> : sauvegardes Borg sur un serveur distant via SSH.  Côté serveur, il suffit d'installer Borg et c'est tout!  À partir d'ici, des avantages tels que la sécurité et le chiffrement suivent immédiatement.  Vous ne pouvez configurer l'accès que par des clés et, de plus, l'exécution par Borg d'une seule de ses commandes lors de son entrée sur le serveur.  Par exemple, comme ceci: <br><br><pre> <code class="bash hljs">$ cat .ssh/authorized_keys <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-string"><span class="hljs-string">"/usr/bin/borg serve"</span></span> ssh-rsa AAAAB3NzaC1yc…</code> </pre> </li><li>  Il est livré à la fois en PPA (nous utilisons principalement Ubuntu) et en <b>binaire statique</b> .  Borg sous la forme d'un binaire statique permet de l'exécuter presque partout où il y a au moins une glibc minimalement moderne.  (Mais pas partout - par exemple, il n'a pas été possible de démarrer sur CentOS 5.) </li><li>  <b>Nettoyage</b> flexible <b>des anciennes sauvegardes</b> .  Vous pouvez définir le stockage des n dernières sauvegardes et 2 sauvegardes par heure / jour / semaine.  Dans ce dernier cas, la dernière sauvegarde en fin de semaine sera laissée.  Les conditions peuvent être combinées en stockant 7 sauvegardes quotidiennes pour les 7 derniers jours et 4 sauvegardes hebdomadaires. </li></ul><br>  La transition vers Borg a commencé lentement sur de petits projets.  Au début, il s'agissait de simples scripts cron qui faisaient leur travail tous les jours.  Cela a duré environ six mois.  Pendant ce temps, nous avons dû obtenir des sauvegardes plusieurs fois ... et il s'est avéré que Borg n'avait pas du tout besoin d'être réparé littéralement!  Pourquoi?  Parce que le principe simple fonctionne ici: "Plus le mécanisme est simple, moins il y aura de cassures." <br><br><h2>  Pratique: comment sauvegarder avec Borg? </h2><br>  Prenons un exemple simple de création d'une sauvegarde: <br><br><ol><li>  Téléchargez la dernière version binaire sur le serveur de sauvegarde et la machine que nous allons sauvegarder à partir du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">référentiel officiel</a> : <br><br><pre> <code class="bash hljs">sudo wget https://github.com/borgbackup/borg/releases/download/1.1.6/borg-linux64 -O /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/borg sudo chmod +x /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/borg</code> </pre> <br>  <i><b>Remarque</b> : Si vous utilisez une machine locale pour le test à la fois en tant que source et en tant que récepteur, alors toute la différence ne sera que dans l'URI, que nous transmettrons, mais nous nous souvenons que la sauvegarde doit être stockée séparément, et non sur la même machine.</i> </li><li>  Sur le serveur de sauvegarde, créez l'utilisateur <code>borg</code> : <br><br><pre> <code class="bash hljs">sudo useradd -m borg</code> </pre> <br>  Simple: sans groupes et avec un shell standard, mais toujours avec un répertoire personnel. </li><li>  Une clé SSH est générée sur le client: <br><br><pre> <code class="bash hljs">ssh-keygen</code> </pre> </li><li>  Sur le serveur, ajoutez la clé générée à l'utilisateur <code>borg</code> : <br><br><pre> <code class="bash hljs">mkdir ~borg/.ssh <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'command="/usr/local/bin/borg serve" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf/XmSVWfF7PfjGlbKW00MJ63zal/E/mxm+vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU/JNU0jITLx+vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk/QmteOOclzx684t9d6BhMvFE9w9r+c76aVBIdbEyrkloiYd+vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44/Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam+9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y+IQM7fbDR'</span></span> &gt; ~borg/.ssh/authorized_keys chown -R borg:borg ~borg/.ssh</code> bin local / / borg servir" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf / XmSVWfF7PfjGlbKW00MJ63zal / E / MXM + vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU / JNU0jITLx + vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk / QmteOOclzx684t9d6BhMvFE9w9r + c76aVBIdbEyrkloiYd + vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44 / Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam + 9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y + IQM7fbDR'&gt; ~ borg / .ssh <code class="bash hljs">mkdir ~borg/.ssh <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'command="/usr/local/bin/borg serve" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf/XmSVWfF7PfjGlbKW00MJ63zal/E/mxm+vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU/JNU0jITLx+vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk/QmteOOclzx684t9d6BhMvFE9w9r+c76aVBIdbEyrkloiYd+vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44/Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam+9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y+IQM7fbDR'</span></span> &gt; ~borg/.ssh/authorized_keys chown -R borg:borg ~borg/.ssh</code> </pre> </li><li>  Nous initialisons le <i>dépôt borg</i> sur le serveur à partir du client: <br><br><pre> <code class="bash hljs">ssh borg@172.17.0.3 hostname <span class="hljs-comment"><span class="hljs-comment">#     borg init -e none borg@172.17.0.3:MyBorgRepo</span></span></code> </pre> <br>  Le commutateur <code>-e</code> est utilisé pour sélectionner la méthode de chiffrement pour le référentiel (oui, vous pouvez également chiffrer chaque référentiel avec votre mot de passe!).  Dans ce cas, car  ceci est un exemple, nous n'utilisons pas de cryptage.  <code>MyBorgRepo</code> est le nom du répertoire dans lequel le <i>dépôt de borg</i> sera (vous n'avez pas besoin de le créer à l'avance - Borg fera tout lui-même). </li><li>  Lancez la première sauvegarde à l'aide de Borg: <br><br><pre> <code class="bash hljs">borg create --stats --list borg@172.17.0.3:MyBorgRepo::<span class="hljs-string"><span class="hljs-string">"MyFirstBackup-{now:%Y-%m-%d_%H:%M:%S}"</span></span> /etc /root</code> </pre> <br>  À propos des clés: <br><ul><li>  <code>--stats</code> et <code>--list</code> nous donnent des statistiques sur la sauvegarde et les fichiers qui y sont entrés; </li><li>  <code>borg@172.17.0.3:MyBorgRepo</code> - tout est clair ici, c'est notre serveur et notre répertoire.  Et quelle est la prochaine étape pour la magie? .. </li><li>  <code>::"MyFirstBackup-{now:%Y-%m-%d_%H:%M:%S}"</code> est le nom de l'archive à l'intérieur du référentiel.  C'est arbitraire, mais nous adhérons au format <code>_-timestamp</code> (horodatage au format Python). </li></ul></li></ol><br>  Et ensuite?  Bien sûr, voyez ce qui est entré dans notre sauvegarde!  Liste des archives à l'intérieur du référentiel: <br><br><pre> <code class="bash hljs">borg@b3e51b9ed2c2:~$ borg list MyBorgRepo/ Warning: Attempting to access a previously unknown unencrypted repository! Do you want to <span class="hljs-built_in"><span class="hljs-built_in">continue</span></span>? [yN] y MyFirstBackup-2018-08-04_16:55:53 Sat, 2018-08-04 16:55:54 [89f7b5bccfb1ed2d72c8b84b1baf477a8220955c72e7fcf0ecc6cd5a9943d78d]</code> </pre> <br>  Nous voyons une sauvegarde avec un horodatage et comment Borg nous demande si nous voulons vraiment accéder à un référentiel non crypté auquel nous n'avons jamais été auparavant. <br><br>  Nous regardons la liste des fichiers: <br><br><pre> <code class="bash hljs">borg list MyBorgRepo::MyFirstBackup-2018-08-04_16:55:53</code> </pre> <br>  Nous obtenons le fichier de la sauvegarde (vous pouvez aussi tout le répertoire): <br><br><pre> <code class="bash hljs">borg@b3e51b9ed2c2:~$ borg extract MyBorgRepo::MyFirstBackup-2018-08-04_16:55:53 etc/hostname borg@b3e51b9ed2c2:~$ ll etc/hostname -rw-r--r-- 1 borg borg 13 Aug 4 16:27 etc/hostname</code> </pre> <br>  Félicitations, votre première sauvegarde Borg est prête! <br><br><h2>  Pratique: automatisez ceci [avec GitLab]! </h2><br>  Après avoir enveloppé tout cela dans des scripts, nous avons configuré manuellement les sauvegardes de manière similaire sur environ 40 hôtes.  Réalisant que Borg fonctionne vraiment, ils ont commencé à y transférer de plus en plus de projets ... <br><br>  Et ici, nous sommes confrontés à ce qui se trouve à Bareos, mais pas à Borg!  À savoir: WebUI ou une sorte de lieu centralisé pour configurer les sauvegardes.  Et nous espérons vraiment qu'il s'agit d'un phénomène temporaire, mais jusqu'à présent, nous avons dû résoudre quelque chose.  Googler les outils finis et se réunir dans une vidéoconférence, nous nous sommes mis au travail.  C'était une excellente idée d'intégrer Borg à nos services internes, comme nous l'avons fait auparavant avec Bacula (Bacula lui-même a retiré la liste des tâches de notre API centralisée, à laquelle nous avions notre propre interface intégrée avec d'autres paramètres de projet).  Nous avons réfléchi à la façon de le faire, décrit un plan de comment et où le construire, mais ... Des sauvegardes normales sont nécessaires maintenant, mais il n'y a aucun endroit pour prendre des plans de temps grandioses.  Que faire <br><br>  Les questions et les exigences étaient approximativement les suivantes: <br><br><ul><li>  Que faut-il utiliser comme gestion de sauvegarde centralisée? </li><li>  Que peut faire n'importe quel administrateur Linux? </li><li>  Que peut même un gestionnaire qui montre un calendrier de sauvegarde aux clients peut comprendre et configurer? </li><li>  Que fait quotidiennement une tâche planifiée sur votre système? </li><li>  Qu'est-ce qui ne sera pas difficile à configurer et ne cassera pas? .. </li></ul><br>  La réponse était évidente: c'est le bon vieux crond, qui accomplit héroïquement son devoir tous les jours.  C'est simple.  Il ne gèle pas.  Même le gestionnaire qui est d'Unix à «vous» peut y remédier. <br><br>  Alors crontab, mais où gardez-vous tout cela?  Est-ce à chaque fois d'aller sur la machine du projet et d'éditer le fichier avec vos mains?  Bien sûr que non.  Nous pouvons mettre notre planning dans le référentiel Git et configurer GitLab Runner, qui par commit le mettra à jour sur l'hôte. <br><br>  <i><b>Remarque</b> : C'est GitLab qui a été choisi comme outil d'automatisation, car il est pratique pour la tâche et dans notre cas, il est presque partout.</i>  <i>Mais je dois dire qu'il n'est nullement une nécessité.</i> <br><br>  Vous pouvez étendre crontab pour les sauvegardes à l'aide d'un outil d'automatisation familier ou généralement manuellement (sur de petits projets ou des installations domestiques). <br><br>  Voici donc ce dont vous avez besoin pour une automatisation simple: <br><br>  1. <b>GitLab et un référentiel</b> , dans lequel pour commencer il y aura deux fichiers: <br><br><ul><li>  <code>schedule</code> - calendrier de sauvegarde </li><li>  <code>borg_backup_files.sh</code> - un script simple pour sauvegarder des fichiers (comme dans l'exemple ci-dessus). </li></ul><br>  Exemple d' <code>schedule</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># WARNING! CRONTAB MANAGED FROM GITLAB CI RUNNER IN ${CI_PROJECT_URL} # CI_COMMIT_SHA: ${CI_COMMIT_SHA} # Branch/tag: ${CI_COMMIT_REF_NAME} # Timestamp: ${TIMESTAMP} PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin # MyRemoteHost 0 0 * * * ${CI_PROJECT_DIR}/borg_backup_files.sh 'SYSTEM /etc,/opt'</span></span></code> </pre> <br>  Les variables CI sont utilisées pour vérifier que la mise à jour de crontab a réussi et <code>CI_PROJECT_DIR</code> est le répertoire dans lequel le référentiel se trouvera après le clonage du runner.  La dernière ligne indique que la sauvegarde est effectuée tous les jours à minuit. <br><br>  Exemple <code>borg_backup_files.sh</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash BORG_SERVER="borg@10.100.1.1" NAMEOFBACKUP=${1} DIRS=${2} REPOSITORY="${BORG_SERVER}:$(hostname)-${NAMEOFBACKUP}" borg create --list -v --stats \ $REPOSITORY::"files-{now:%Y-%m-%d_%H:%M:%S}" \ $(echo $DIRS | tr ',' ' ') || \ echo "borg create failed"</span></span></code> </pre> <br>  <i>Le premier</i> argument ici est le nom de la sauvegarde, et le <i>second</i> est la liste des répertoires de la sauvegarde, séparés par des virgules.  À strictement parler, une liste peut également être un ensemble de fichiers distincts. <br><br>  2. <b>GitLab Runner</b> , fonctionnant sur la machine à sauvegarder et bloqué uniquement pour les travaux de ce référentiel. <br><br>  3. <b>Le script CI lui</b> - <b>même</b> , implémenté par le <code>.gitlab-ci.yml</code> : <br><br><pre> <code class="hljs pgsql">stages: - deploy Deploy: stage: deploy script: - export <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>=$(<span class="hljs-type"><span class="hljs-type">date</span></span> <span class="hljs-string"><span class="hljs-string">'+%Y.%m.%d %H:%M:%S'</span></span>) - cat schedule | envsubst | crontab - tags: - borg-backup</code> </pre> <br>  4. La <b>clé SSH</b> pour l'utilisateur <code>gitlab-runner</code> ayant accès au serveur de <code>gitlab-runner</code> (dans l'exemple, il s'agit de 10.100.1.1).  Par défaut, il doit se trouver dans le <code>.ssh/id_rsa</code> ( <code>gitlab-runner</code> ). <br><br>  5. <b>L'utilisateur <code>borg</code></b> sur le même 10.100.1.1 avec accès uniquement à la commande <code>borg serve</code> : <br><br><pre> <code class="bash hljs">$ cat .ssh/authorized_keys <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-string"><span class="hljs-string">"/usr/bin/borg serve"</span></span> ssh-rsa AAAAB3NzaC1yc2EAA...</code> </pre> <br>  Maintenant, lorsque vous vous engagez dans le référentiel Runner, il remplira le contenu de crontab.  Et lorsque le temps de réponse du cron arrive, une sauvegarde des répertoires <code>/etc</code> et <code>/opt</code> sera effectuée, qui sera sur le serveur de sauvegarde dans le <code>MyHostname-SYSTEM</code> du serveur 10.100.1.1. <br><br><img src="https://habrastorage.org/webt/ud/n7/wb/udn7wbd4vqknfq6cguw5wmi7tcq.png"><br><br><h2>  Au lieu d'une conclusion: que pouvez-vous faire d'autre? </h2><br>  Bien entendu, l'utilisation de Borg à cet égard ne s'arrête pas là.  Voici quelques idées pour une mise en œuvre ultérieure, dont certaines que nous avons déjà mises en œuvre à la maison: <br><br><ul><li>  <b>Ajoutez des scripts universels</b> pour différentes sauvegardes qui, à la fin de l'exécution, exécutent <code>borg_backup_files.sh</code> , visant le répertoire avec le résultat de leur travail.  Par exemple, vous pouvez sauvegarder PostgreSQL (pg_basebackup), MySQL (innobackupex), GitLab (travail de râteau intégré, création d'une archive). </li><li>  <b>Hôte central avec <i>calendrier</i> de sauvegarde</b> .  Ne pas configurer sur chaque hôte GitLab Runner?  Laissez-le être seul sur le serveur de sauvegarde et crontab au démarrage transfère le script de sauvegarde sur la machine et l'exécute là-bas.  Pour cela, bien sûr, vous aurez besoin de l'utilisateur <code>borg</code> sur la machine client et <code>ssh-agent</code> , afin de ne pas disposer la clé du serveur de sauvegarde sur chaque machine. </li><li>  <b>Suivi</b>  Où sans lui!  Les alertes concernant une sauvegarde incorrecte doivent être. </li><li>  <b>Suppression du dépôt borg des anciennes archives.</b>  Malgré une bonne déduplication, les anciennes sauvegardes doivent encore être nettoyées.  Pour ce faire, vous pouvez appeler <code>borg prune</code> à la fin du script de sauvegarde. </li><li>  <b>Interface Web</b> au planning.  Cela vous sera utile si l'édition de crontab à la main ou dans l'interface Web ne vous semble pas solide / inconfortable. </li><li>  <b>Diagrammes à secteurs</b> .  Quelques graphiques pour une représentation visuelle du pourcentage de sauvegardes réussies, de leur temps d'exécution, de la largeur du canal "mangé".  Pas étonnant que j'aie écrit qu'il n'y a pas assez de WebUI, comme dans Bareos ... </li><li>  <b>Actions simples</b> que je souhaiterais recevoir par un bouton: lancement d'une sauvegarde à la demande, restauration sur une machine, etc. </li></ul><br>  Et à la toute fin, je voudrais ajouter un exemple de l'efficacité de la déduplication sur une véritable sauvegarde de travail des fichiers PostgreSQL WAL dans un environnement de production: <br><br><pre> <code class="bash hljs">borg@backup ~ $ borg info PROJECT-PG-WAL Repository ID: 177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 Location: /mnt/borg/PROJECT-PG-WAL Encrypted: No Cache: /mnt/borg/.cache/borg/177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 Security dir: /mnt/borg/.config/borg/security/177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 ------------------------------------------------------------------------------ Original size Compressed size Deduplicated size All archives: 6.68 TB 6.70 TB 19.74 GB Unique chunks Total chunks Chunk index: 11708 3230099</code> </pre> <br>  Ce sont 65 jours de sauvegarde des fichiers WAL qui sont effectués toutes les heures.  Lors de l'utilisation de Bacula / Bareos, c'est-à-dire  sans déduplication, nous obtiendrions 6,7 To de données.  Pensez-y: nous pouvons nous permettre de stocker près de 7 téraoctets de données transmises via PostgreSQL, seulement 20 Go d'espace réellement occupé. <br><br><h2>  PS </h2><br>  Lisez aussi dans notre blog: <br><br><ul><li>  « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Théorie et pratique des mises à niveau sans assistance dans Ubuntu</a> »; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Junior, qui le premier jour de travail a supprimé la base de données de la production</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Accélérer l'amorçage de grandes bases de données avec Kubernetes</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr420055/">https://habr.com/ru/post/fr420055/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr420041/index.html">TypeScript War ou Enum Conquest</a></li>
<li><a href="../fr420045/index.html">Bunker pour la date: comment j'ai été autorisé à me promener dans le centre de données RUVDS sur le territoire de l'usine spatiale</a></li>
<li><a href="../fr420049/index.html">Le livre "L'homme parle. Évolution et langage</a></li>
<li><a href="../fr420051/index.html">[DotNetBook] Étendue, mémoire et ReadOnlyMemory</a></li>
<li><a href="../fr420053/index.html">Veeam Academy for C # Developers: Nouvelle saison</a></li>
<li><a href="../fr420057/index.html">8 règles pour un pigiste réussi</a></li>
<li><a href="../fr420059/index.html">Maintenant, je suis chef d'équipe, mais pourquoi suis-je si malade? Conseils pratiques</a></li>
<li><a href="../fr420061/index.html">Nous évaluons les processus dans l'équipe de développement sur la base de données objectives</a></li>
<li><a href="../fr420063/index.html">"Saint" Timlid et ses disciples</a></li>
<li><a href="../fr420065/index.html">La communication comme zone de performance du travail d'équipe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>