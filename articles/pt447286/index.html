<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçê üëÉ üöπ Por que e como ocultamos placas de carros nos an√∫ncios Avito ü§≥üèø üî° ü§∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi No final do ano passado, come√ßamos a ocultar automaticamente os n√∫meros das placas nas fotografias dos cart√µes de an√∫ncio Avito. Sobre por que fize...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Por que e como ocultamos placas de carros nos an√∫ncios Avito</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/447286/">  Oi  No final do ano passado, come√ßamos a ocultar automaticamente os n√∫meros das placas nas fotografias dos cart√µes de an√∫ncio Avito.  Sobre por que fizemos isso e quais s√£o as maneiras de resolver esses problemas, leia o artigo. <br><br><img src="https://habrastorage.org/webt/fr/0p/vx/fr0pvxzrkfbjqpvdeeu3-hfp4z8.png" alt="Esconda meu prato!"><br><a name="habracut"></a><br><h4>  Desafio </h4><br>  No Avito, em 2018, foram vendidos 2,5 milh√µes de carros.  Isso √© quase 7000 por dia.  Todos os an√∫ncios √† venda precisam de uma ilustra√ß√£o - foto de um carro.  Mas pelo n√∫mero do estado, voc√™ pode encontrar muitas informa√ß√µes adicionais sobre o carro.  E alguns de nossos usu√°rios tentam fechar a matr√≠cula por conta pr√≥pria. <br><table><tbody><tr><td><img src="https://habrastorage.org/webt/ti/u9/yl/tiu9ylusazwgoyouuhvbd3iephi.png" alt="imagem"></td><td><img src="https://habrastorage.org/webt/tf/8x/6l/tf8x6lq0j4cnyytbzn4pbwalky8.png" alt="imagem"></td></tr><tr><td><img src="https://habrastorage.org/webt/t-/mz/ig/t-mzigkjjc00g-w_b2vx4sz0vy8.png" alt="imagem"></td><td><img src="https://habrastorage.org/webt/rq/gu/31/rqgu31h8n1j4n08z2wu6oqfzwlo.png" alt="imagem"></td></tr><tr><td colspan="2"><img src="https://habrastorage.org/webt/55/9b/rb/559brbhsq8xldsnln_umbwjqldw.png" alt="prot√≥tipo para ilustra√ß√£o no in√≠cio do artigo"></td></tr></tbody></table><br>  Os motivos pelos quais os usu√°rios desejam ocultar o n√∫mero da placa podem ser diferentes.  De nossa parte, queremos ajud√°-los a proteger seus dados.  E tentamos melhorar os processos de venda e compra para os usu√°rios.  Por exemplo, um servi√ßo de n√∫mero an√¥nimo trabalha conosco h√° muito tempo: quando voc√™ vende um carro, um n√∫mero de celular tempor√°rio √© criado para voc√™.  Bem, para proteger os dados das placas, anonimizamos as fotos. <br><br><img src="https://habrastorage.org/webt/ol/-o/ii/ol-oiivyox1f2cogwd2pzf1jz9y.png" alt="imagem"><br><br><h4>  Vis√£o geral da solu√ß√£o </h4><br>  Para automatizar o processo de prote√ß√£o de fotos do usu√°rio, voc√™ pode usar redes neurais convolucionais para detectar um pol√≠gono com uma placa de carro. <br>  Agora, para a detec√ß√£o de objetos, s√£o usadas arquiteturas de dois grupos: redes de dois est√°gios, por exemplo, Faster RCNN e Mask RCNN;  est√°gio √∫nico (single shot) - SSD, YOLO, RetinaNet.  Detectar um objeto √© a deriva√ß√£o das quatro coordenadas do ret√¢ngulo nas quais o objeto de interesse est√° inscrito. <br><br><img src="https://habrastorage.org/webt/-g/bz/p4/-gbzp4vk0cj2uwknc1qeavh8roy.png" alt="imagem"><br><br>  As redes mencionadas acima s√£o capazes de encontrar muitos objetos de classes diferentes nas fotos, o que j√° √© redundante para solucionar o problema de busca de placas, porque geralmente temos apenas um carro nas fotos (h√° exce√ß√µes quando as pessoas tiram fotos do carro vendido e do vizinho aleat√≥rio). , mas isso acontece muito raramente, portanto, isso pode ser negligenciado). <br><br>  Outra caracter√≠stica dessas redes √© que, por padr√£o, elas produzem uma caixa delimitadora com lados paralelos aos eixos de coordenadas.  Isso acontece porque um conjunto de tipos predefinidos de quadros retangulares chamados caixas √¢ncora √© usado para detec√ß√£o.  Mais precisamente, primeiro usando uma rede convolucional (por exemplo, resnet34), uma matriz de atributos √© obtida a partir da figura.  Ent√£o, para cada subconjunto de atributos obtidos usando a janela deslizante, ocorre uma classifica√ß√£o: existe um objeto para a caixa √¢ncora k ou n√£o e uma regress√£o √© realizada nas quatro coordenadas do quadro, que ajustam sua posi√ß√£o. <br>  Leia mais sobre isso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><img src="https://habrastorage.org/webt/ew/er/dq/ewerdqloqogwqhsp8kauzmwzwtq.png" alt="imagem"><br><br>  Depois disso, existem mais duas cabe√ßas: <br><br><img src="https://habrastorage.org/webt/be/9j/ib/be9jibquo3xic6fi-3dof-ivyq4.png" alt="n√£o √© uma imagem mais original da arquitetura"><br><br>  um para classificar o objeto (c√£o / gato / planta etc.), <br>  o segundo (regressor bbox) - para regress√£o das coordenadas do quadro obtidas na etapa anterior, a fim de aumentar a propor√ß√£o da √°rea do objeto para a √°rea do quadro. <br><br>  Para prever o quadro de boxe girado, voc√™ precisa alterar o regressor bbox para obter tamb√©m o √¢ngulo de rota√ß√£o do quadro.  Se isso n√£o for feito, ser√° de alguma forma. <br><br><img src="https://habrastorage.org/webt/c0/4p/5d/c04p5dcpnl02xrgbvapzycdtboe.png" alt="imagem"><br><br>  Al√©m do R-CNN mais r√°pido de dois est√°gios, existem detectores de um est√°gio, como o RetinaNet.  Difere da arquitetura anterior, pois prediz imediatamente a classe e o quadro, sem o est√°gio preliminar de propor se√ß√µes da imagem que podem conter objetos.  Para prever m√°scaras rotacionadas, voc√™ tamb√©m deve alterar o cabe√ßalho da sub-rede da caixa. <br><br><img src="https://habrastorage.org/webt/uu/_w/qx/uu_wqxel27ctxz39s_trbw4be88.png" alt="imagem"><br><br>  Um exemplo de arquiteturas existentes para prever caixas delimitadoras giradas √© o DRBOX.  Essa rede n√£o usa o est√°gio preliminar da proposta da regi√£o, como no RCNN mais r√°pido; portanto, √© uma modifica√ß√£o dos m√©todos de um est√°gio.  Para treinar essa rede, K √© rotacionado em certos √¢ngulos da caixa delimitadora (rbox).  A rede prev√™ as probabilidades de cada K rbox conter o objeto de destino, coordenadas, tamanho da bbox e √¢ngulo de rota√ß√£o. <br><br><img src="https://habrastorage.org/webt/oq/a4/yo/oqa4yonbchbbmkcu9mjsj7nmmfm.png" alt="imagem"><br><br>  Modificar a arquitetura e treinar novamente uma das redes consideradas em dados com caixas delimitadoras giradas √© uma tarefa realiz√°vel.  Mas nosso objetivo pode ser alcan√ßado com mais facilidade, porque o escopo da rede que temos √© muito mais restrito - apenas para ocultar placas. <br>  Portanto, decidimos come√ßar com uma rede simples para prever os quatro pontos do n√∫mero e, posteriormente, ser√° poss√≠vel complicar a arquitetura. <br><br><h4>  Dados </h4><br>  A montagem do conjunto de dados √© dividida em duas etapas: para coletar fotos de carros e marcar a √°rea com uma placa.  A primeira tarefa j√° foi resolvida em nossa infraestrutura: armazenamos cuidadosamente todos os an√∫ncios que j√° foram colocados no Avito.  Para resolver o segundo problema, usamos Toloka.  No <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">toloka.yandex.ru/requester,</a> criamos uma tarefa: <br><blockquote>  A tarefa deu uma fotografia do carro.  √â necess√°rio destacar a placa do carro usando um quadril√°tero.  Nesse caso, o n√∫mero do estado deve ser alocado com a maior precis√£o poss√≠vel. </blockquote><img src="https://habrastorage.org/webt/mk/vl/j4/mkvlj4d7k8bsg_xkke1gkcsrxuy.png" alt="imagem"><br><br>  Usando o Toloka, voc√™ pode criar tarefas para marcar dados.  Por exemplo, avalie a qualidade dos resultados da pesquisa, marque diferentes classes de objetos (textos e imagens), marque v√≠deos, etc.  Eles ser√£o executados pelos usu√°rios da Toloka, pela taxa que voc√™ cobrar.  Por exemplo, no nosso caso, os tolokers devem destacar o aterro com o n√∫mero da placa do carro na foto.  Em geral, √© muito conveniente marcar um grande conjunto de dados, mas obter alta qualidade √© bastante dif√≠cil.  H√° muitos bots na multid√£o, cuja tarefa √© obter dinheiro de voc√™, dando respostas aleatoriamente ou usando algum tipo de estrat√©gia.  Para combater esses bots, existe um sistema de regras e verifica√ß√µes.  A verifica√ß√£o principal √© a mistura de perguntas de controle: voc√™ marca manualmente parte das tarefas usando a interface Toloki e depois as mistura na tarefa principal.  Se a marca√ß√£o √© frequentemente confundida com perguntas de controle, voc√™ a bloqueia e n√£o leva em considera√ß√£o a marca√ß√£o. <br><br>  Para a tarefa de classifica√ß√£o, √© muito simples determinar se a marca√ß√£o est√° errada ou n√£o e, para o problema de destacar uma regi√£o, n√£o √© t√£o simples.  A maneira cl√°ssica √© contar IoU. <br><br><img src="https://habrastorage.org/webt/fw/r2/ye/fwr2yeqbrlk1-skjy2udjx04y2e.png" alt="imagem"><br><br>  Se essa propor√ß√£o for menor que um determinado limite para v√°rias tarefas, esse usu√°rio ser√° bloqueado.  No entanto, para dois quadr√¢ngulos arbitr√°rios, o c√°lculo da IoU n√£o √© t√£o simples, especialmente porque no Tolok √© necess√°rio implement√°-lo em JavaScript.  Fizemos um pequeno hack e acreditamos que o usu√°rio n√£o se enganou se, para cada ponto do pol√≠gono de origem em um pequeno bairro, houvesse um ponto marcado com um escriba.  Tamb√©m existe uma regra de resposta r√°pida para bloquear os usu√°rios que responderem com muita rapidez, captcha, discrep√¢ncia com a opini√£o da maioria etc.  Depois de definir essas regras, voc√™ pode esperar uma marca√ß√£o muito boa, mas se realmente precisa de alta qualidade e marca√ß√£o complexa, precisa contratar especificamente freelancers-escritores.  Como resultado, nosso conjunto de dados chegou a 4 mil imagens marcadas e custou US $ 28 na Tolok. <br><br><h4>  Modelo </h4><br>  Agora vamos criar uma rede para prever os quatro pontos da √°rea.  Obteremos os sinais usando resnet18 (11,7 milh√µes de par√¢metros versus 21,8 milh√µes de par√¢metros para resnet34), depois faremos uma regress√£o para quatro pontos (oito coordenadas) e uma classifica√ß√£o para saber se h√° uma placa na foto ou n√£o.  A segunda cabe√ßa √© necess√°ria, porque em an√∫ncios de venda de carros, nem todas as fotos com carros.  A foto pode ser um detalhe do carro. <br><br><img src="https://habrastorage.org/webt/wz/qc/5s/wzqc5spmzueaqptlw6hiknobayo.png" alt="imagem"><br><br>  Semelhante a n√≥s, √© claro, n√£o √© necess√°rio detectar. <br><br>  Realizamos o treinamento de dois objetivos ao mesmo tempo, adicionando ao conjunto de dados uma foto sem placa com uma caixa delimitadora (0,0,0,0,0,0,0,0,0) alvo e um valor para o classificador ‚Äúimagem com / sem placa‚Äù - (0, 1) <br><br>  Em seguida, voc√™ pode criar uma √∫nica fun√ß√£o de perda para ambos os objetivos como a soma das seguintes perdas.  Para regress√£o √†s coordenadas do pol√≠gono da placa, usamos uma perda suave de L1. <br><br><img src="https://habrastorage.org/webt/6s/v7/yu/6sv7yus_w9o4d1xmqfhbnsenotc.png" alt="imagem"><br><br>  Pode ser interpretado como uma combina√ß√£o de L1 e L2, que se comporta como L1 quando o valor absoluto do argumento √© grande e como L2 quando o valor do argumento √© pr√≥ximo de zero.  Para classifica√ß√£o, usamos perda softmax e crossentropy.  O extrator de recursos √© resnet18, usamos pesos pr√©-treinados no ImageNet, depois treinamos o extrator e lideramos nosso conjunto de dados.  Nesse problema, usamos a estrutura mxnet, pois √© a principal para vis√£o computacional no Avito.  Em geral, a arquitetura de microsservi√ßo permite que voc√™ n√£o esteja vinculado a uma estrutura espec√≠fica, mas quando voc√™ tem uma grande base de c√≥digo, √© melhor us√°-la e n√£o escrever o mesmo c√≥digo novamente. <br><br>  Tendo recebido uma qualidade aceit√°vel em nosso conjunto de dados, procuramos os designers para obter uma placa com o logotipo Avito.  No come√ßo, tentamos fazer isso sozinhos, √© claro, mas n√£o parecia muito bonito.  Em seguida, voc√™ precisa alterar o brilho da placa do Avito para o brilho da √°rea original com a placa e pode sobrepor o logotipo na imagem. <br><br><img src="https://habrastorage.org/webt/3j/gr/bz/3jgrbzhv3y9sldjmbm5hlfmhlo8.png" alt="imagem"><br><br><h4>  Lan√ßamento em prod </h4><br>  O problema da reprodutibilidade dos resultados, suporte e desenvolvimento de projetos, resolvido com algum erro no mundo do desenvolvimento de back-end e front-end, permanece aberto onde √© necess√°rio o uso de modelos de aprendizado de m√°quina.  Voc√™ provavelmente precisou entender o modelo de c√≥digo legado.  √â bom que o leia-me tenha links para artigos ou reposit√≥rios de c√≥digo aberto nos quais a solu√ß√£o foi baseada.  O script para iniciar a reciclagem pode falhar com erros, por exemplo, a vers√£o cudnn foi alterada e essa vers√£o do tensorflow n√£o funciona mais com esta vers√£o do cudnn, e o cudnn n√£o funciona com esta vers√£o dos drivers da nvidia.  Talvez para o treinamento tenhamos usado um iterador de acordo com os dados e para testes na produ√ß√£o outro.  Isso pode continuar por algum tempo.  Em geral, existem problemas de reprodutibilidade. <br><br>  Tentamos remov√™-los usando o ambiente nvidia-docker para modelos de treinamento, ele possui todas as depend√™ncias necess√°rias para cuda e tamb√©m instalamos depend√™ncias para python l√°.  A vers√£o da biblioteca com um iterador de acordo com modelos de dados, aprimoramentos e infer√™ncia √© comum para o est√°gio de treinamento / experimenta√ß√£o e para produ√ß√£o.  Portanto, para treinar o modelo em novos dados, voc√™ precisa bombear o reposit√≥rio para o servidor, executar o script de shell que coletar√° o ambiente do docker, dentro do qual o notebook jupyter aumentar√°.  No interior, voc√™ ter√° todos os notebooks para treinamento e teste, o que certamente n√£o falhar√° com um erro devido ao ambiente.  √â melhor, √© claro, ter um arquivo train.py, mas a pr√°tica mostra que voc√™ sempre precisa olhar com aten√ß√£o o que o modelo oferece e mudar alguma coisa no processo de aprendizado; assim, no final, voc√™ ainda executar√° o jupyter. <br><br>  Os pesos do modelo s√£o armazenados no git lfs - esta √© uma tecnologia especial para armazenar arquivos grandes em um git. Antes disso, usamos artefatos, mas usar o git lfs √© mais conveniente, pois ao fazer o download do reposit√≥rio com o servi√ßo, voc√™ obt√©m imediatamente a vers√£o atual das balan√ßas, como na produ√ß√£o.  Os autotestes s√£o escritos para infer√™ncia de modelo, para que voc√™ n√£o possa implementar um servi√ßo com pesos que n√£o os passam.  O servi√ßo em si √© iniciado na janela de encaixe dentro da infraestrutura de microsservi√ßo no cluster kubernetes.  Para monitorar o desempenho, usamos grafana.  Ap√≥s a rolagem, aumentamos gradualmente a carga nas inst√¢ncias de servi√ßo com um novo modelo.  Ao lan√ßar um novo recurso, criamos testes a / b e emitimos um veredicto sobre o destino futuro do recurso, com base em testes estat√≠sticos. <br><br>  Como resultado: lan√ßamos o encobrimento de n√∫meros em an√∫ncios na categoria autom√°tica para negociantes privados, o percentil 95 do tempo de processamento de uma imagem para ocultar o n√∫mero √© de 250 ms. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt447286/">https://habr.com/ru/post/pt447286/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt447276/index.html">O que √© a biblioteca ITIL e por que sua empresa precisa</a></li>
<li><a href="../pt447278/index.html">A Est√¥nia est√° tentando usar a IA na justi√ßa</a></li>
<li><a href="../pt447280/index.html">Nivelando contas de jogos na China: um neg√≥cio s√©rio e uma dor de cabe√ßa para desenvolvedores</a></li>
<li><a href="../pt447282/index.html">Erros de programadores de sistema e aplicativos capturados no frontend (artigo exclu√≠do)</a></li>
<li><a href="../pt447284/index.html">Atualizar ferramentas da Web e do Azure no Visual Studio 2019</a></li>
<li><a href="../pt447288/index.html">Top 5 stablecoins. Tudo o que voc√™ precisa saber</a></li>
<li><a href="../pt447290/index.html">Passeios de m√©dico, passeios</a></li>
<li><a href="../pt447292/index.html">14 novos produtos no Visual Studio 2019</a></li>
<li><a href="../pt447294/index.html">Live Share agora inclu√≠do no Visual Studio 2019</a></li>
<li><a href="../pt447298/index.html">Gest√£o do conhecimento atrav√©s de modelos de compet√™ncia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>