<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÖ±Ô∏è üë©üèæ‚Äçüè≠ üôÜüèø Implanta√ß√£o invis√≠vel de um aplicativo monol√≠tico em produ√ß√£o na AWS. Experi√™ncia pessoal ‚òπÔ∏è ü§∏üèº üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sou Engenheiro L√≠der de DevOps no Miro (ex-RealtimeBoard). Compartilharei como nossa equipe de DevOps resolveu o problema de lan√ßamentos di√°rios de se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Implanta√ß√£o invis√≠vel de um aplicativo monol√≠tico em produ√ß√£o na AWS. Experi√™ncia pessoal</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/miro/blog/436444/">  Sou Engenheiro L√≠der de DevOps no Miro (ex-RealtimeBoard).  Compartilharei como nossa equipe de DevOps resolveu o problema de lan√ßamentos di√°rios de servidores de um aplicativo com estado monol√≠tico e os tornou autom√°ticos, invis√≠veis para os usu√°rios e convenientes para seus pr√≥prios desenvolvedores. <br><br><h2>  Nossa infraestrutura </h2><br>  Nossa equipe de desenvolvimento √© composta por 60 pessoas, divididas em equipes Scrum, entre as quais tamb√©m h√° a equipe DevOps.  A maioria dos comandos do Scrum suporta a funcionalidade atual do produto e apresenta novos recursos.  A tarefa do DevOps √© criar e manter uma infraestrutura que ajude o aplicativo a trabalhar de maneira r√°pida e confi√°vel e permita que as equipes entreguem rapidamente novas funcionalidades aos usu√°rios. <br><img src="https://habrastorage.org/webt/sh/f-/qy/shf-qy6dzbfvuzonf4h5yf5iupk.png"><br><a name="habracut"></a><br><br>  Nossa aplica√ß√£o √© uma placa on-line sem fim.  Consiste em tr√™s camadas: um site, um cliente e um servidor em Java, que √© um aplicativo com estado monol√≠tico.  O aplicativo mant√©m uma conex√£o constante de soquete da Web com os clientes, e cada servidor mant√©m na mem√≥ria um cache de placas abertas. <br><br>  Toda a infraestrutura - mais de 70 servidores - est√° localizada na Amazon: mais de 30 servidores com nosso aplicativo Java, servidores Web, servidores de banco de dados, corretores e muito mais.  Com o crescimento da funcionalidade, tudo isso deve ser atualizado regularmente, sem interromper o trabalho dos usu√°rios. <br>  A atualiza√ß√£o do site e do cliente √© simples: substitu√≠mos a vers√£o antiga por uma nova e, na pr√≥xima vez em que o usu√°rio acessar um novo site e um novo cliente.  Mas se fizermos isso quando o servidor for lan√ßado, obteremos tempo de inatividade.  Para n√≥s, isso √© inaceit√°vel, porque o principal valor do nosso produto √© o trabalho conjunto dos usu√°rios em tempo real. <br><br><h2>  Como √© o nosso processo de CI / CD </h2><br>  O processo de CI / CD conosco √© git commit, git push e, em seguida, montagem autom√°tica, auto-teste, implanta√ß√£o, libera√ß√£o e monitoramento. <br><br><img src="https://habrastorage.org/webt/ok/se/rv/okservy5e1ai7rboli8mvgvrvh4.png"><br><br>  Para integra√ß√£o cont√≠nua, usamos Bamboo e Bitbucket.  Para teste autom√°tico - Java e Python e Allure - para exibir os resultados do teste autom√°tico.  Para entrega cont√≠nua - Packer, Ansible e Python.  Todo o monitoramento √© feito usando o ELK Stack, Prometheus e Sentry. <br><br>  Os desenvolvedores escrevem c√≥digo e o adicionam ao reposit√≥rio, ap√≥s o qual a montagem e o teste autom√°ticos s√£o iniciados.  Ao mesmo tempo, a equipe se re√∫ne de outros desenvolvedores e conduz a Revis√£o de C√≥digo.  Quando todos os processos necess√°rios, incluindo os autotestes, foram conclu√≠dos, a equipe mant√©m a compila√ß√£o no ramo principal e o processo come√ßa e √© enviado para teste autom√°tico.  Todo o processo √© depurado e executado pela equipe por conta pr√≥pria. <br><br><h2>  Imagem AMI </h2><br>  Paralelamente √† compila√ß√£o e teste de compila√ß√£o, √© iniciada a compila√ß√£o da imagem AMI para Amazon.  Para fazer isso, usamos o Packer da HashiCorp, uma √≥tima ferramenta de c√≥digo-fonte aberto que permite criar uma imagem de uma m√°quina virtual.  Todos os par√¢metros s√£o passados ‚Äã‚Äãpara JSON com um conjunto de chaves de configura√ß√£o.  O par√¢metro principal √© construtores, que indica para qual provedor estamos criando a imagem (no nosso caso, para a Amazon). <br><br><pre><code class="plaintext hljs">"builders": [{ "type": "amazon-ebs", "access_key": "{{user `aws_access_key`}}", "secret_key": "{{user `aws_secret_key`}}", "region": "{{user `aws_region`}}", "vpc_id": "{{user `aws_vpc`}}", "subnet_id": "{{user `aws_subnet`}}", "tags": { "releaseVersion": "{{user `release_version`}}" }, "instance_type": "t2.micro", "ssh_username": "ubuntu", "ami_name": "packer-board-ami_{{isotime \"2006-01-02_15-04\"}}" }],</code> </pre> <br>  √â importante n√£o apenas criar uma imagem de uma m√°quina virtual, mas configur√°-la com anteced√™ncia usando o Ansible: instale os pacotes necess√°rios e fa√ßa as defini√ß√µes de configura√ß√£o para executar um aplicativo Java. <br><br><pre> <code class="plaintext hljs"> "provisioners": [{ "type": "ansible", "playbook_file": "./playbook.yml", "user": "ubuntu", "host_alias": "default", "extra_arguments": ["--extra_vars=vars"], "ansible_env_vars": ["ANSIBLE_HOST_KEY_CHECKING=False", "ANSIBLE_NOCOLOR=True"] }]</code> </pre><br><h2>  Pap√©is poss√≠veis </h2><br>  Costum√°vamos usar o manual normal do Ansible, mas isso levou a muitos c√≥digos repetitivos, que se tornaram dif√≠ceis de manter atualizados.  Mudamos algo em um manual, esquecemos de fazer em outro e, como resultado, tivemos problemas.  Ent√£o come√ßamos a usar pap√©is Ansible.  N√≥s os tornamos o mais vers√°til poss√≠vel, para podermos reutiliz√°-los em diferentes partes do projeto e n√£o sobrecarregar o c√≥digo em grandes partes repetidas.  Por exemplo, usamos a fun√ß√£o Monitoramento para todos os tipos de servidores. <br><br><pre> <code class="plaintext hljs">- name: Install all board dependencies hosts: all user: ubuntu become: yes roles: - java - nginx - board-application - ssl-certificates - monitoring</code> </pre><br>  Do lado das equipes Scrum, esse processo parece o mais simples poss√≠vel: a equipe recebe no Slack notifica√ß√µes de que a compila√ß√£o e a imagem AMI est√£o montadas. <br><br><h2>  Pr√©-lan√ßamentos </h2><br>  Introduzimos pr√©-lan√ßamentos para fornecer altera√ß√µes de produtos aos usu√°rios o mais r√°pido poss√≠vel.  De fato, s√£o vers√µes can√°rias que permitem testar com seguran√ßa novas funcionalidades em uma pequena porcentagem de usu√°rios. <br><br>  Por que os lan√ßamentos s√£o chamados canary?  Anteriormente, os mineiros, quando desciam na mina, levavam um can√°rio com eles.  Se havia g√°s na mina, o can√°rio morria e os mineiros rapidamente subiam √† superf√≠cie.  O mesmo acontece conosco: se algo der errado com o servidor, o lan√ßamento n√£o est√° pronto e podemos reverter rapidamente e a maioria dos usu√°rios n√£o notar√° nada. <br><br>  <strong>Como come√ßa a libera√ß√£o do can√°rio:</strong> <br><ol><li>  A equipe de desenvolvimento da Bamboo clica em um bot√£o -&gt; √© chamado um aplicativo Python que inicia o pr√©-lan√ßamento. </li><li>  Ele cria uma nova inst√¢ncia no Amazon a partir de uma imagem AMI pr√©-preparada com uma nova vers√£o do aplicativo. </li><li>  A inst√¢ncia √© adicionada aos grupos-alvo e balanceadores de carga necess√°rios. </li><li>  Com o Ansible, uma configura√ß√£o individual √© configurada para cada inst√¢ncia. </li><li>  Os usu√°rios est√£o trabalhando com a nova vers√£o do aplicativo Java. </li></ol><br>  No lado dos comandos do Scrum, o processo de lan√ßamento de pr√©-lan√ßamento parece mais simples poss√≠vel: a equipe recebe no Slack notifica√ß√µes de que o processo foi iniciado e, ap√≥s 7 minutos, o novo servidor j√° est√° em opera√ß√£o.  Al√©m disso, o aplicativo envia ao Slack todo o registro de altera√ß√µes das altera√ß√µes na vers√£o. <br><br>  Para que essa barreira de verifica√ß√£o de prote√ß√£o e confiabilidade funcione, as equipes do Scrum monitoram novos erros no Sentry.  Este √© um aplicativo de rastreamento de erros de c√≥digo aberto em tempo real.  O Sentry se integra perfeitamente ao Java e possui conectores com logback e log2j.  Quando o aplicativo √© iniciado, transferimos para o Sentry a vers√£o em que est√° sendo executado e, quando ocorre um erro, vemos em qual vers√£o do aplicativo ocorreu.  Isso ajuda as equipes do Scrum a responder rapidamente aos erros e corrigi-los rapidamente. <br><br>  O pr√©-lan√ßamento deve funcionar por pelo menos 4 horas.  Durante esse per√≠odo, a equipe monitora seu trabalho e decide se deve liberar a vers√£o para todos os usu√°rios. <br><br>  <strong>V√°rias equipes podem lan√ßar simultaneamente seus lan√ßamentos</strong> .  Para fazer isso, eles concordam entre si o que entra no pr√©-lan√ßamento e quem √© o respons√°vel pelo lan√ßamento final.  Depois disso, as equipes combinam todas as altera√ß√µes em um pr√©-lan√ßamento ou lan√ßam v√°rios pr√©-lan√ßamentos ao mesmo tempo.  Se todos os pr√©-lan√ßamentos estiverem corretos, eles ser√£o lan√ßados como um lan√ßamento no dia seguinte. <br><br><h2>  Lan√ßamentos </h2><br>  Fazemos um lan√ßamento di√°rio: <br><br><ol><li>  Introduzimos novos servidores para funcionar. </li><li>  Monitoramos a atividade do usu√°rio em novos servidores usando o Prometheus. </li><li>  Feche o acesso de novos usu√°rios a servidores antigos. </li><li>  Transferimos usu√°rios de servidores antigos para novos. </li><li>  Desligue o servidor antigo. </li></ol><br>  Tudo √© constru√≠do usando os aplicativos Bamboo e Python.  O aplicativo verifica o n√∫mero de servidores em execu√ß√£o e se prepara para iniciar o mesmo n√∫mero de novos.  Se n√£o houver servidores suficientes, eles ser√£o criados a partir da imagem AMI.  Uma nova vers√£o √© implementada neles, um aplicativo Java √© iniciado e os servidores s√£o colocados em opera√ß√£o. <br><br>  Ao monitorar, o aplicativo Python usando a API do Prometheus verifica o n√∫mero de placas abertas em novos servidores.  Quando entende que tudo est√° funcionando corretamente, fecha o acesso aos servidores antigos e transfere os usu√°rios para os novos. <br><br><pre> <code class="plaintext hljs">import requests PROMETHEUS_URL = 'https://prometheus' def get_spaces_count(): boards = {} try: params = { 'query': 'rtb_spaces_count{instance=~"board.*"}' } response = requests.get(PROMETHEUS_URL, params=params) for metric in response.json()['data']['result']: boards[metric['metric']['instance']] = metric['value'][1] except requests.exceptions.RequestException as e: print('requests.exceptions.RequestException: {}'.format(e)) finally: return boards</code> </pre><br>  O processo de transfer√™ncia de usu√°rios entre servidores √© exibido no Grafana.  Na metade esquerda do gr√°fico, os servidores em execu√ß√£o na vers√£o antiga s√£o exibidos, √† direita - na nova.  A interse√ß√£o de gr√°ficos √© o momento da transfer√™ncia do usu√°rio. <br><br><img src="https://habrastorage.org/webt/zt/8l/df/zt8ldf8hmk39a7tzho9a_dt0gnq.png"><br><br>  A equipe supervisiona o lan√ßamento do Slack.  Ap√≥s o lan√ßamento, todo o registro de altera√ß√µes √© publicado em um canal separado no Slack, e no Jira todas as tarefas associadas a este lan√ßamento s√£o fechadas automaticamente. <br><br><h3>  O que √© migra√ß√£o de usu√°rios </h3><br>  Armazenamos o estado do quadro branco no qual os usu√°rios trabalham, na mem√≥ria do aplicativo e salvamos constantemente todas as altera√ß√µes no banco de dados.  Para transferir a placa no n√≠vel de intera√ß√£o do cluster, n√≥s a carregamos na mem√≥ria no novo servidor e enviamos ao cliente um comando para reconectar.  Nesse ponto, o cliente se desconecta do servidor antigo e se conecta ao novo.  Ap√≥s alguns segundos, os usu√°rios veem a inscri√ß√£o - Conex√£o restaurada.  No entanto, eles continuam a trabalhar e n√£o percebem nenhum inconveniente. <br><br><img src="https://habrastorage.org/webt/8m/ie/ae/8mieaew94xjibv9emwf0gkrq1l8.png"><br><br><h2>  O que aprendemos ao tornar a implanta√ß√£o invis√≠vel </h2><br>  A que chegamos depois de uma d√∫zia de itera√ß√µes: <br><br><ul><li>  A equipe scrum verifica seu pr√≥prio c√≥digo. </li><li>  A equipe scrum decide quando iniciar o pr√©-lan√ßamento e trazer algumas das mudan√ßas para novos usu√°rios. </li><li>  A equipe Scrum decide se seu lan√ßamento est√° pronto para ser usado por todos os usu√°rios. </li><li>  Os usu√°rios continuam trabalhando e n√£o percebem nada. </li></ul><br>  Isso n√£o foi poss√≠vel imediatamente, pisamos no mesmo rake v√°rias vezes e enchemos muitos cones.  Quero compartilhar as li√ß√µes que recebemos. <br><br>  <strong>Primeiro, o processo manual, e somente ent√£o sua automa√ß√£o.</strong>  Os primeiros passos n√£o precisam se aprofundar na automa√ß√£o, porque voc√™ pode automatizar o que no final n√£o √© √∫til. <br><br>  <strong>Ansible √© bom, mas os pap√©is Ansible s√£o melhores.</strong>  Tornamos nossos pap√©is o mais universal poss√≠vel: nos livramos do c√≥digo repetitivo, de modo que eles carregam apenas a funcionalidade que deveriam.  Isso permite que voc√™ economize tempo reutilizando fun√ß√µes, que j√° temos mais de 50. <br><br>  <strong>Reutilize o c√≥digo no Python e divida-o em bibliotecas e m√≥dulos separados.</strong>  Isso ajuda voc√™ a navegar em projetos complexos e a mergulhar rapidamente novas pessoas neles. <br><br><h2>  Pr√≥ximas etapas </h2><br>  O processo de implanta√ß√£o invis√≠vel ainda n√£o acabou.  Aqui est√£o algumas das seguintes etapas: <br><br><ol><li>  Permita que as equipes concluam n√£o apenas os pr√©-lan√ßamentos, mas todos os lan√ßamentos. </li><li>  Fa√ßa revers√µes autom√°ticas em caso de erros.  Por exemplo, um pr√©-lan√ßamento deve reverter automaticamente se erros cr√≠ticos forem detectados no Sentry. </li><li>  Automatize totalmente a vers√£o na aus√™ncia de erros.  Se n√£o houver erros no pr√©-lan√ßamento, isso significa que ele pode ser implementado automaticamente. </li><li>  Adicione verifica√ß√£o autom√°tica de c√≥digo para poss√≠veis erros de seguran√ßa. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt436444/">https://habr.com/ru/post/pt436444/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt436434/index.html">PVS-Studio para Java</a></li>
<li><a href="../pt436436/index.html">O CERN planeja construir um novo acelerador com um comprimento de t√∫nel de 100 km</a></li>
<li><a href="../pt436438/index.html">Roscosmos chamou as poss√≠veis raz√µes para a perda de comunica√ß√£o com o observat√≥rio orbital Spektr-R</a></li>
<li><a href="../pt436440/index.html">Preciso ir r√°pido: Criando velocidade no iOS. Parte 2</a></li>
<li><a href="../pt436442/index.html">Uma cabe√ßa √© boa e outra √© melhor, ou emparelha a programa√ß√£o em a√ß√£o</a></li>
<li><a href="../pt436448/index.html">Analise o monitor IPS de 27 ‚ÄùAcer HA270bid: para auto-aperfei√ßoamento</a></li>
<li><a href="../pt436450/index.html">Controle remoto, liberdade e governo. Conversa com Staply</a></li>
<li><a href="../pt436452/index.html">7 √°reas de desenvolvimento Linux em 2019</a></li>
<li><a href="../pt436454/index.html">Perguntas e respostas sobre JavaScript</a></li>
<li><a href="../pt436456/index.html">Crie um efeito de distribui√ß√£o de cores no Unity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>