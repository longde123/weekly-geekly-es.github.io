<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧝🏽 👩‍🏭 ♒️ 网站统计信息和您的小型存储库 ⚰️ ♀️ 👩🏽‍🤝‍👨🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Webalizer实用程序和Google Analytics（分析）工具已经帮助我多年了解网站上正在发生的事情。 现在，我知道它们提供的有用信息很少。 可以访问您的access.log文件，处理统计信息非常简单，并且可以实现相当基本的工具，例如sqlite，html，sql和任何脚本编程语言。 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>网站统计信息和您的小型存储库</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462337/"> Webalizer实用程序和Google Analytics（分析）工具已经帮助我多年了解网站上正在发生的事情。 现在，我知道它们提供的有用信息很少。 可以访问您的access.log文件，处理统计信息非常简单，并且可以实现相当基本的工具，例如sqlite，html，sql和任何脚本编程语言。 <br><br>  Webalizer的数据源是服务器access.log文件。 这是它的列和数字的外观，其中只有总流量是明确的： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n1/br/xb/n1brxbufrqnd4t0j6nzlbv1jkzq.png" alt="图片"></div><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/u1/fe/mk/u1femkuxt4sompxtu4dhyr75ito.png" alt="图片"></div><br> 诸如Google Analytics（分析）之类的工具会自行从加载的页面收集数据。 它们向我们展示了一些图表和线条，在这些图表和线条的基础上通常很难得出正确的结论。 也许需要更多的努力？ 我不知道 <br><br> 那么，我想在网站访问统计信息中看到什么？ <br><br><h4> 用户和机器人流量 </h4><br> 通常，网站流量会受到限制，您需要查看使用了多少有用流量。 例如，像这样： <br><br><img src="https://habrastorage.org/webt/zx/ns/in/zxnsin0lv74jmiaupcbtmwbuaca.png" alt="图片"><br><br><div class="spoiler">  <b class="spoiler_title">SQL报告请求</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'StackedArea: Traffic generated by Users and Bots'</span></span>, strftime(<span class="hljs-string"><span class="hljs-string">'%d.%m'</span></span>, datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> USG.AGENT_BOT!=<span class="hljs-string"><span class="hljs-string">'na'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.BYTES <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>)/<span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Bots, KB'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> USG.AGENT_BOT=<span class="hljs-string"><span class="hljs-string">'na'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.BYTES <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>)/<span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Users, KB'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> FCT_ACCESS_USER_AGENT_DD FCT, DIM_USER_AGENT USG <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> FCT.DIM_USER_AGENT_ID=USG.DIM_USER_AGENT_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>) &gt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'-14 day'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> strftime(<span class="hljs-string"><span class="hljs-string">'%d.%m'</span></span>, datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> FCT.EVENT_DT</code> </pre> <br></div></div><br> 从图中可以看到机器人的持续活动。 详细研究最活跃的代表将很有趣。 <br><br><h4> 烦人的机器人 </h4><br> 我们根据用户代理信息对漫游器进行分类。 有关每日流量，成功和失败请求数量的其他统计信息，可以很好地了解机器人的活动。 <br><br><img src="https://habrastorage.org/webt/ly/ue/2g/lyue2grwohunkb13gxwqrrsmrz4.png" alt="图片"><br><br><div class="spoiler">  <b class="spoiler_title">SQL报告请求</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Table: Annoying Bots'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(USG.AGENT_BOT) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Bot'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.BYTES)/<span class="hljs-number"><span class="hljs-number">1000</span></span> / <span class="hljs-number"><span class="hljs-number">14.0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'KB per Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.IP_CNT) / <span class="hljs-number"><span class="hljs-number">14.0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'IPs per Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> STS.STATUS_GROUP <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'Client Error'</span></span>, <span class="hljs-string"><span class="hljs-string">'Server Error'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.REQUEST_CNT / <span class="hljs-number"><span class="hljs-number">14.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Error Requests per Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> STS.STATUS_GROUP <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'Successful'</span></span>, <span class="hljs-string"><span class="hljs-string">'Redirection'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.REQUEST_CNT / <span class="hljs-number"><span class="hljs-number">14.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Success Requests per Day'</span></span>, USG.USER_AGENT_NK <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Agent'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> FCT_ACCESS_USER_AGENT_DD FCT, DIM_USER_AGENT USG, DIM_HTTP_STATUS STS <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> FCT.DIM_USER_AGENT_ID = USG.DIM_USER_AGENT_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> FCT.DIM_HTTP_STATUS_ID = STS.DIM_HTTP_STATUS_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> USG.AGENT_BOT != <span class="hljs-string"><span class="hljs-string">'na'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>) &gt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'-14 day'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> USG.USER_AGENT_NK <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br></div></div><br> 在这种情况下，分析决定通过向文件中添加robots.txt来限制对网站的访问 <br><br> <code>User-agent: AhrefsBot <br> Disallow: / <br> User-agent: dotbot <br> Disallow: / <br> User-agent: bingbot <br> Crawl-delay: 5</code> <br> 前两个机器人从桌子上消失了，MS机器人从第一行下移了下来。 <br><br><h4> 最活跃的日期和时间 </h4><br> 交通显示。 为了详细研究它们，有必要确定它们的发生时间，而不必显示所有时间测量的小时和天数。 因此，如果您需要详细的分析，则在日志文件中查找单个查询将更加容易。 <br><br><img src="https://habrastorage.org/webt/0d/az/jb/0dazjba9u6qctbppnqmvmlbfapo.png" alt="图片"><br><br><div class="spoiler">  <b class="spoiler_title">SQL报告请求</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Line: Day and Hour of Hits from Users and Bots'</span></span>, strftime(<span class="hljs-string"><span class="hljs-string">'%d.%m-%H'</span></span>, datetime(EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Date Time'</span></span>, HIB <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Bots, Hits'</span></span>, HIU <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Users, Hits'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> EVENT_DT, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> AGENT_BOT!=<span class="hljs-string"><span class="hljs-string">'na'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LINE_CNT <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> HIB, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> AGENT_BOT=<span class="hljs-string"><span class="hljs-string">'na'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LINE_CNT <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> HIU <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> FCT_ACCESS_REQUEST_REF_HH <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> datetime(EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>) &gt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'-14 day'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> EVENT_DT <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(LINE_CNT) <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> EVENT_DT</code> </pre> <br></div></div><br> 我们会在图表上观察第一天的最活跃时段11、14和20。 但是第二天13点，这些机器人开始活动了。 <br><br><h4> 每周平均每日用户活动 </h4><br> 随着活动和交通有点想通了。 下一个问题是用户本身的活动。 对于此类统计，需要大量的汇总时间，例如一周。 <br><br><img src="https://habrastorage.org/webt/2j/cq/-a/2jcq-aaudo2zn21ewcr8ukr3mrq.png" alt="图片"><br><br><div class="spoiler">  <b class="spoiler_title">SQL报告请求</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'Line: Average Daily User Activity by Week'</span></span>, strftime(<span class="hljs-string"><span class="hljs-string">'%W week'</span></span>, datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Week'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-number"><span class="hljs-number">1.0</span></span>*<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.PAGE_CNT)/<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.IP_CNT),<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Pages per IP per Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-number"><span class="hljs-number">1.0</span></span>*<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.FILE_CNT)/<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.IP_CNT),<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Files per IP per Day'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> FCT_ACCESS_USER_AGENT_DD FCT, DIM_USER_AGENT USG, DIM_HTTP_STATUS HST <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> FCT.DIM_USER_AGENT_ID=USG.DIM_USER_AGENT_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> FCT.DIM_HTTP_STATUS_ID = HST.DIM_HTTP_STATUS_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> USG.AGENT_BOT=<span class="hljs-string"><span class="hljs-string">'na'</span></span> <span class="hljs-comment"><span class="hljs-comment">/* users only */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> HST.STATUS_GROUP <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'Successful'</span></span>) <span class="hljs-comment"><span class="hljs-comment">/* good pages */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>) &gt; <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'-3 month'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> strftime(<span class="hljs-string"><span class="hljs-string">'%W week'</span></span>, datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> FCT.EVENT_DT</code> </pre> <br></div></div><br> 一周的统计数据显示，平均每个用户每天打开1.6页。 在这种情况下，每个用户请求的文件数取决于将新文件添加到站点。 <br><br><h4> 所有请求及其状态 </h4><br>  Webalizer总是显示特定的页面代码，并且总是希望仅查看成功请求和错误的数量。 <br><br><img src="https://habrastorage.org/webt/-0/tl/l_/-0tll_vfgjgf2yzzofonmztakke.png" alt="图片"><br><br><div class="spoiler">  <b class="spoiler_title">SQL报告请求</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'Line: All Requests by Status'</span></span>, strftime(<span class="hljs-string"><span class="hljs-string">'%d.%m'</span></span>, datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> STS.STATUS_GROUP=<span class="hljs-string"><span class="hljs-string">'Successful'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.REQUEST_CNT <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Success'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> STS.STATUS_GROUP=<span class="hljs-string"><span class="hljs-string">'Redirection'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.REQUEST_CNT <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Redirect'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> STS.STATUS_GROUP=<span class="hljs-string"><span class="hljs-string">'Client Error'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.REQUEST_CNT <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Customer Error'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> STS.STATUS_GROUP=<span class="hljs-string"><span class="hljs-string">'Server Error'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> FCT.REQUEST_CNT <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Server Error'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> FCT_ACCESS_USER_AGENT_DD FCT, DIM_HTTP_STATUS STS <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> FCT.DIM_HTTP_STATUS_ID=STS.DIM_HTTP_STATUS_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>) &gt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'-14 day'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> strftime(<span class="hljs-string"><span class="hljs-string">'%d.%m'</span></span>, datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> FCT.EVENT_DT</code> </pre> <br></div></div><br> 该报告显示请求而不是点击（点击），这与LINE_CNT不同，REQUEST_CNT指标被视为COUNT（DISTINCT STG.REQUEST_NK）。 目标是显示有效事件，例如，MS僵尸程序每天数百次轮询robots.txt文件，在这种情况下，此类轮询将被计数一次。 这使您可以平滑图表上的跳跃。 <br><br> 从图中可以看到许多错误-这些是不存在的页面。 分析的结果是添加了来自远程页面的重定向。 <br><br><h4> 错误的要求 </h4><br> 要详细查看请求，可以显示详细的统计信息。 <br><br><img src="https://habrastorage.org/webt/sv/67/o4/sv67o47nnbg41zchmmaioaguv1e.png" alt="图片"><br><br><div class="spoiler">  <b class="spoiler_title">SQL报告请求</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Table: Top Error Requests'</span></span>, REQ.REQUEST_NK <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Request'</span></span>, <span class="hljs-string"><span class="hljs-string">'Error'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Request Status'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.LINE_CNT) / <span class="hljs-number"><span class="hljs-number">14.0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Hits per Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.IP_CNT) / <span class="hljs-number"><span class="hljs-number">14.0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'IPs per Day'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(FCT.BYTES)/<span class="hljs-number"><span class="hljs-number">1000</span></span> / <span class="hljs-number"><span class="hljs-number">14.0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'KB per Day'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> FCT_ACCESS_REQUEST_REF_HH FCT, DIM_REQUEST_V_ACT REQ <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> FCT.DIM_REQUEST_ID = REQ.DIM_REQUEST_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> FCT.STATUS_GROUP <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'Client Error'</span></span>, <span class="hljs-string"><span class="hljs-string">'Server Error'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> datetime(FCT.EVENT_DT, <span class="hljs-string"><span class="hljs-string">'unixepoch'</span></span>) &gt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'-14 day'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> REQ.REQUEST_NK <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span></code> </pre> <br></div></div><br> 该列表将包含所有拨号程序，例如对/wp-login.php的请求。通过调整服务器重写请求的规则，您可以调整服务器对此类请求的响应，并将其发送到起始页。 <br><br> 因此，一些基于服务器日志文件的简单报告可以相当完整地了解站点上正在发生的事情。 <br><br><h4> 如何获得信息？ </h4><br>  sqlite数据库已经足够了。 让我们创建表：辅助记录ETL进程。 <br><br><img src="https://habrastorage.org/webt/zw/nr/4i/zwnr4iijmghgjtw9kytl2h5ohha.png" alt="图片"><br><br> 阶段表，我们将在其中使用PHP编写日志文件。 两个汇总表。 创建包含用户代理和请求状态统计信息的每日表格。 每小时提供有关请求，状态组和代理的统计信息。 四张相关测量表。 <br><br> 结果是以下关系模型： <br><br><div class="spoiler">  <b class="spoiler_title">资料模型</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ge/no/8t/geno8thwxmohdagflkzzurien-u.png" alt="图片"><br></div></div><br> 在sqlite数据库中创建对象的脚本： <br><br><div class="spoiler">  <b class="spoiler_title">DDL对象创建</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> DIM_USER_AGENT; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> DIM_USER_AGENT ( DIM_USER_AGENT_ID <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> AUTOINCREMENT, USER_AGENT_NK <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'na'</span></span>, AGENT_OS <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'na'</span></span>, AGENT_ENGINE <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'na'</span></span>, AGENT_DEVICE <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'na'</span></span>, AGENT_BOT <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'na'</span></span>, UPDATE_DT <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (USER_AGENT_NK) ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> DIM_USER_AGENT (DIM_USER_AGENT_ID) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">-1</span></span>);</code> </pre> </div></div><br><h4> 舞台 </h4><br> 对于access.log文件，您需要读取，解析并将所有请求写入数据库。 可以直接使用脚本语言或使用sqlite完成此操作。 <br><br> 日志文件格式： <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//67.221.59.195 - - [28/Dec/2012:01:47:47 +0100] "GET /files/default.css HTTP/1.1" 200 1512 "https://project.edu/" "Mozilla/4.0" //host ident auth time method request_nk protocol status bytes ref browser $log_pattern = '/^([^ ]+) ([^ ]+) ([^ ]+) (\[[^\]]+\]) "(.*) (.*) (.*)" ([0-9\-]+) ([0-9\-]+) "(.*)" "(.*)"$/';</span></span></code> </pre><br><h4> 重点宣传 </h4><br> 当原始数据位于数据库中时，您需要记录度量表中不存在的键。 这样就可以为测量建立参考。 例如，在DIM_REFERRER表中，键是三个字段的组合。 <br><br><div class="spoiler">  <b class="spoiler_title">SQL密钥传播查询</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/* Propagate the referrer from access log */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> DIM_REFERRER (HOST_NK, PATH_NK, QUERY_NK, UPDATE_DT) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> CLS.HOST_NK, CLS.PATH_NK, CLS.QUERY_NK, STRFTIME(<span class="hljs-string"><span class="hljs-string">'%s'</span></span>,<span class="hljs-string"><span class="hljs-string">'now'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> UPDATE_DT <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> REFERRER_HOST <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> HOST_NK, REFERRER_PATH <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> PATH_NK, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSTR</span></span>(REFERRER_QUERY,<span class="hljs-string"><span class="hljs-string">'&amp;sid'</span></span>)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUBSTR</span></span>(REFERRER_QUERY, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">INSTR</span></span>(REFERRER_QUERY,<span class="hljs-string"><span class="hljs-string">'&amp;sid'</span></span>)<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-comment"><span class="hljs-comment">/*  sid -   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> REFERRER_QUERY <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> QUERY_NK <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> STG_ACCESS_LOG ) CLS <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> DIM_REFERRER TRG <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (CLS.HOST_NK = TRG.HOST_NK <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> CLS.PATH_NK = TRG.PATH_NK <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> CLS.QUERY_NK = TRG.QUERY_NK) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> TRG.DIM_REFERRER_ID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span></code> </pre> </div></div><br> 传播到用户代理表可能包含漫游器逻辑，例如sql摘录： <br><br><pre> <code class="sql hljs">CASE WHEN INSTR(LOWER(CLS.BROWSER),'yandex.com')&gt;0 THEN 'yandex' WHEN INSTR(LOWER(CLS.BROWSER),'googlebot')&gt;0 THEN 'google' WHEN INSTR(LOWER(CLS.BROWSER),'bingbot')&gt;0 THEN 'microsoft' WHEN INSTR(LOWER(CLS.BROWSER),'ahrefsbot')&gt;0 THEN 'ahrefs' WHEN INSTR(LOWER(CLS.BROWSER),'mj12bot')&gt;0 THEN 'majestic-12' WHEN INSTR(LOWER(CLS.BROWSER),'compatible')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'http')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'libwww')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'spider')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'java')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'python')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'robot')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'curl')&gt;0 OR INSTR(LOWER(CLS.BROWSER),'wget')&gt;0 THEN 'other' ELSE 'na' <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AGENT_BOT</code> </pre> <br><h4> 单位表 </h4><br> 最后，我们将加载汇总表，例如，可以按以下方式加载每日表： <br><br><div class="spoiler">  <b class="spoiler_title">SQL聚合加载请求</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/* Load fact from access log */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> FCT_ACCESS_USER_AGENT_DD (EVENT_DT, DIM_USER_AGENT_ID, DIM_HTTP_STATUS_ID, PAGE_CNT, FILE_CNT, REQUEST_CNT, LINE_CNT, IP_CNT, <span class="hljs-keyword"><span class="hljs-keyword">BYTES</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> STG <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> STRFTIME( <span class="hljs-string"><span class="hljs-string">'%s'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUBSTR</span></span>(TIME_NK,<span class="hljs-number"><span class="hljs-number">9</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>) || <span class="hljs-string"><span class="hljs-string">'-'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUBSTR</span></span>(TIME_NK,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Jan'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'01'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Feb'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'02'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Mar'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'03'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Apr'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'04'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'May'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'05'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Jun'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'06'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Jul'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'07'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Aug'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'08'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Sep'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'09'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Oct'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'10'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-string"><span class="hljs-string">'Nov'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'11'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'12'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> || <span class="hljs-string"><span class="hljs-string">'-'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">SUBSTR</span></span>(TIME_NK,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) || <span class="hljs-string"><span class="hljs-string">' 00:00:00'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> EVENT_DT, BROWSER <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> USER_AGENT_NK, REQUEST_NK, IP_NR, <span class="hljs-keyword"><span class="hljs-keyword">STATUS</span></span>, LINE_NK, <span class="hljs-keyword"><span class="hljs-keyword">BYTES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> STG_ACCESS_LOG ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(STG.EVENT_DT <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> EVENT_DT, USG.DIM_USER_AGENT_ID, HST.DIM_HTTP_STATUS_ID, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSTR</span></span>(STG.REQUEST_NK,<span class="hljs-string"><span class="hljs-string">'.'</span></span>)=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> STG.REQUEST_NK <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> PAGE_CNT, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSTR</span></span>(STG.REQUEST_NK,<span class="hljs-string"><span class="hljs-string">'.'</span></span>)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> STG.REQUEST_NK <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> FILE_CNT, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> STG.REQUEST_NK) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> REQUEST_CNT, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> STG.LINE_NK) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> LINE_CNT, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> STG.IP_NR) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> IP_CNT, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">BYTES</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BYTES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> STG, DIM_HTTP_STATUS HST, DIM_USER_AGENT USG <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> STG.STATUS = HST.STATUS_NK <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> STG.USER_AGENT_NK = USG.USER_AGENT_NK <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(STG.EVENT_DT <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>) &gt; $param_epoch_from <span class="hljs-comment"><span class="hljs-comment">/* load epoch date */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(STG.EVENT_DT <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>) &lt; strftime(<span class="hljs-string"><span class="hljs-string">'%s'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">'now'</span></span>, <span class="hljs-string"><span class="hljs-string">'start of day'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> STG.EVENT_DT, HST.DIM_HTTP_STATUS_ID, USG.DIM_USER_AGENT_ID</code> </pre> </div></div><br>  sqlite数据库允许您编写复杂的查询。  WITH包含数据和密钥的准备。 主要查询收集对尺寸的所有引用。 <br><br> 该条件不允许再次加载故事：CAST（STG.EVENT_DT AS INTEGER）&gt; $ param_epoch_from，其中参数是请求的结果 <br>  '从FCT_ACCESS_USER_AGENT_DD作为LAST_EVENT_EPOCH的SELECT COALESCE（MAX（EVENT_DT），\'3600 \'） <br><br> 该条件将仅加载一整天：CAST（STG.EVENT_DT AS INTEGER）&lt;strftime（“％s”，日期（“ now”，“ day of day”）） <br><br> 通过搜索点以原始方式对页面或文件进行计数。 <br><br><h4> 报告书 </h4><br> 在复杂的可视化系统中，可以基于数据库对象创建元模型，动态管理过滤器和聚合规则。 最终，所有不错的工具都会生成一个SQL查询。 <br><br> 在此示例中，我们将创建现成的SQL查询并将其保存为数据库中的视图-这些是报告。 <br><br><h4> 可视化 </h4><br> 虚张声势：JavaScript中的漂亮图形被用作可视化工具。 <br><br> 为此，必须使用PHP遍历所有报告并生成带有表的html文件。 <br><br><pre> <code class="php hljs">$sqls = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_USER_VS_BOT'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_ANNOYING_BOT'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_TOP_HOUR_HIT'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_USER_ACTIVE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_REQUEST_STATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_TOP_REQUEST_PAGE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_TOP_REQUEST_REFERRER'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_NEW_REQUEST'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_TOP_REQUEST_SUCCESS'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM RPT_ACCESS_TOP_REQUEST_ERROR'</span></span> );</code> </pre> <br> 该工具仅可视化结果表。 <br><br><h4> 结论 </h4><br> 本文以网络分析为例，介绍了构建数据仓库所需的机制。 从结果可以看出，最简单的工具足以进行深入分析和数据可视化。 <br><br> 将来，我们将以这种存储为例，尝试实现诸如<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">缓慢变化的测量</a> ，主数据，聚合级别以及来自不同来源的数据集成之类的结构。 <br><br> 另外，我们将仔细研究基于单个表的最简单的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ETL流程管理工具</a> 。 <br><br> 让我们回到测量数据质量并自动执行此过程的主题。 <br><br> 我们将研究技术环境和数据仓库维护方面的问题，为此，我们以最少的资源（例如基于Raspberry Pi）实现了存储服务器。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN462337/">https://habr.com/ru/post/zh-CN462337/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN462327/index.html">吱吱作响的癌症：NUST“ MISiS”的科学家已经开发出激光超声来诊断癌症</a></li>
<li><a href="../zh-CN462329/index.html">将电源移动到机箱正面</a></li>
<li><a href="../zh-CN462331/index.html">控制面板上的GAZ-66玩具。 第二部分</a></li>
<li><a href="../zh-CN462333/index.html">在python中创建一个简单的对话聊天机器人</a></li>
<li><a href="../zh-CN462335/index.html">不阅读，重新阅读</a></li>
<li><a href="../zh-CN462339/index.html">手持培训与亚马逊的内部标准有何关系，对亚马逊的世界观有何影响？</a></li>
<li><a href="../zh-CN462347/index.html">从猫头鹰到早鸟的前十天：睡眠，饮食，饮食和运动</a></li>
<li><a href="../zh-CN462349/index.html">RESTinio是一个异步HTTP服务器。 实践中的一个简单示例：作为响应返回大量数据</a></li>
<li><a href="../zh-CN462353/index.html">LoRaWAN协议安全性常见问题解答</a></li>
<li><a href="../zh-CN462355/index.html">异步JavaScript编程（回调，Promise，RxJs）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>