<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚋 👇🏼 👭 Kerangka waktu yang menipis (cryptocurrency, forex, exchange) 🤱🏿 🍀 👨🏻‍🚀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Beberapa waktu lalu, saya ditugasi menulis prosedur yang melakukan penipisan kutipan pasar Forex (lebih tepatnya, data kerangka waktu). 

 Pernyataan ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kerangka waktu yang menipis (cryptocurrency, forex, exchange)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418757/">  Beberapa waktu lalu, saya ditugasi menulis prosedur yang melakukan penipisan kutipan pasar Forex (lebih tepatnya, data kerangka waktu). <br><br>  Pernyataan masalah: data dimasukkan pada selang waktu 1 detik dalam format ini: <br><br><ul><li>  Nama instrumen (kode pasangan USDEUR, dll.), </li><li>  Tanggal dan waktu dalam format waktu unix, </li><li>  Nilai terbuka (harga transaksi pertama dalam interval), </li><li>  Nilai tinggi (harga maksimum), </li><li>  Nilai rendah </li><li>  Nilai tutup (harga kesepakatan terakhir), </li><li> Volume (volume, atau volume transaksi). </li></ul><br>  Hal ini diperlukan untuk memastikan perhitungan ulang dan sinkronisasi data dalam tabel: 5 detik, 15 detik, 1 menit, 5 menit, 15 menit, dll. <br><br>  Format penyimpanan data yang dijelaskan disebut OHLC, atau OHLCV (Terbuka, Tinggi, Rendah, Tutup, Volume).  Sering digunakan, Anda dapat langsung membangun grafik "lilin Jepang" di atasnya. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/by/ws/8u/byws8uaklvxydw8d2wqkqhpb1ni.png" alt="gambar"></div><br>  Di bawah potongan, saya menggambarkan semua opsi yang bisa saya buat, bagaimana cara menipiskan (memperbesar) data yang diterima, untuk analisis, misalnya, lompatan musim dingin dalam harga bitcoin, dan menurut data yang diterima, Anda akan segera membangun bagan "Lilin Jepang" (dalam MS Excel ada juga bagan seperti itu) )  Pada gambar di atas, bagan ini dibuat untuk kerangka waktu “1 bulan”, untuk alat “bitstampUSD”.  Tubuh putih lilin menunjukkan kenaikan harga dalam interval, hitam - penurunan harga, sumbu atas dan bawah menunjukkan harga maksimum dan minimum yang dicapai dalam interval.  Latar belakang - volume transaksi.  Jelas terlihat bahwa pada bulan Desember 2017 harga mendekati tanda 20K. <br><br>  Solusi akan diberikan untuk dua mesin basis data, untuk Oracle dan MS SQL, yang, dalam beberapa cara, akan memungkinkan untuk membandingkannya untuk tugas khusus ini (kami tidak akan menggeneralisasi perbandingan dengan tugas lain). <br><a name="habracut"></a><br>  Kemudian saya memecahkan masalah dengan cara sepele: menghitung penipisan yang benar dalam tabel sementara dan menyinkronkan dengan tabel target - menghapus baris yang ada di tabel target tetapi tidak ada di tabel sementara dan menambahkan baris yang ada di tabel sementara tetapi tidak ada di target.  Saat itu, pelanggan puas solusinya, dan saya menutup tugas. <br><br>  Tetapi sekarang saya memutuskan untuk mempertimbangkan semua opsi, karena solusi di atas mengandung satu fitur - sulit untuk mengoptimalkan dua kasus sekaligus: <br><br><ul><li>  ketika tabel target kosong dan Anda perlu menambahkan banyak data, </li><li>  dan ketika tabel target besar, dan Anda perlu menambahkan data dalam potongan kecil. </li></ul><br>  Ini disebabkan oleh fakta bahwa dalam prosedur Anda harus menghubungkan tabel target dan tabel sementara, dan Anda harus melampirkan tabel yang lebih besar, dan bukan sebaliknya.  Dalam dua kasus di atas, yang lebih besar / lebih kecil dipertukarkan.  Pengoptimal akan memutuskan urutan koneksi berdasarkan statistik, dan statistik mungkin kedaluwarsa, dan keputusan mungkin dibuat secara tidak benar, yang akan menyebabkan penurunan kinerja yang signifikan. <br><br>  Pada artikel ini, saya akan menjelaskan metode penipisan satu kali yang mungkin berguna bagi pembaca untuk analisis, misalnya, lompatan musim dingin dalam harga bitcoin. <br><br>  Prosedur penipisan daring dapat diunduh dari github di tautan di bagian bawah artikel. <br><br>  Pada intinya ... Tugas saya menipis dari kerangka waktu "1 detik" ke yang berikutnya, tetapi di sini saya sedang mempertimbangkan penipisan dari tingkat transaksi (dalam tabel sumber, bidang STOCK_NAME, UT, ID, APRICE, AVOLUME).  Karena data tersebut dikeluarkan oleh bitcoincharts.com. <br>  Sebenarnya, penipisan dari tingkat transaksi ke tingkat "1 detik" dilakukan oleh perintah seperti itu (operator mudah diterjemahkan ke dalam penipisan dari tingkat "1 detik" ke tingkat atas): <br><br>  <b>Di Oracle:</b> <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  Fungsi <i>avg () keep (dense_rank urutan pertama oleh UT, ID)</i> berfungsi seperti ini: karena permintaannya adalah GROUP BY, setiap grup dihitung secara independen dari yang lain.  Di dalam setiap grup, string diurutkan berdasarkan UT dan ID, diberi nomor oleh <i>dense_rank</i> .  Karena fungsi pertama mengikuti, baris dipilih di mana <i>dense_rank</i> mengembalikan 1 (dengan kata lain, minimum dipilih) - transaksi pertama dalam interval dipilih.  Untuk UT minimum ini, ID, jika ada beberapa baris, rata-rata akan dipertimbangkan.  Tetapi dalam kasus kami akan dijamin satu baris (karena keunikan ID), sehingga nilai yang dihasilkan segera dikembalikan sebagai AOPEN.  Sangat mudah untuk memperhatikan bahwa fungsi <i>pertama</i> menggantikan dua yang agregat. <br><br>  <b>Pada MS SQL</b> <br><br>  Tidak ada fungsi <i>pertama / terakhir</i> (ada <i>first_value / last_value</i> , tetapi bukan itu).  Karena itu, Anda harus menghubungkan tabel itu sendiri. <br><br>  Saya tidak akan memberikan permintaan secara terpisah, tetapi Anda dapat melihatnya di bawah di <i>dbo.THINNING_HABR_CALC</i> prosedur.  Tentu saja, tanpa yang <i>pertama / terakhir</i> itu tidak begitu elegan, tetapi itu akan berhasil. <br><br>  Bagaimana masalah ini dapat diselesaikan oleh satu operator?  (Di sini, istilah "satu operator" tidak berarti bahwa operator akan menjadi satu, tetapi bahwa tidak akan ada siklus yang "menarik" data pada satu baris.) <br><br>  Saya akan mencantumkan semua opsi yang saya tahu untuk menyelesaikan masalah ini: <br><br><ol><li>  SIMP (sederhana, sederhana, produk Cartesian), </li><li>  CALC (menghitung, penipisan berulang dari tingkat atas), </li><li>  CHIN (cara china, permintaan besar untuk semua level sekaligus), </li><li>  UDAF (fungsi agregat yang ditentukan pengguna), </li><li>  PPTF (fungsi tabel pipelined dan paralel, solusi prosedural, tetapi dengan hanya dua kursor, pada kenyataannya, dua pernyataan SQL), </li><li>  MODE (model, frase MODEL), </li><li>  dan IDEA (ideal, solusi ideal yang mungkin tidak berfungsi sekarang). </li></ol><br>  Ke depan, saya akan mengatakan bahwa ini adalah kasus yang jarang terjadi ketika solusi PPTF prosedural adalah yang paling efektif di Oracle. <br><br>  Unduh file transaksi dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">http://api.bitcoincharts.com/v1/csv</a> <br>  Saya sarankan memilih file kraken *.  File-file localbtc * sangat berisik - mengandung baris-baris yang mengganggu dengan harga yang tidak realistis.  Semua kraken * berisi sekitar 31 juta transaksi, saya sarankan tidak termasuk krakenEUR dari sana, maka transaksi menjadi 11 juta.  Ini adalah volume paling nyaman untuk pengujian. <br><br>  Jalankan skrip di Powershell untuk menghasilkan file kontrol untuk SQLLDR untuk Oracle dan untuk menghasilkan permintaan impor untuk MSSQL. <br><br><pre> <code class="hljs mel"> # MODIFY PARAMETERS THERE $OracleConnectString = <span class="hljs-string"><span class="hljs-string">"THINNING/aaa@P-ORA11/ORCL"</span></span> # For Oracle $PathToCSV = <span class="hljs-string"><span class="hljs-string">"Z:\10"</span></span> # without trailing slash $filenames = Get-ChildItem -name *.csv Remove-Item *.ctl -ErrorAction SilentlyContinue Remove-Item *.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> -ErrorAction SilentlyContinue Remove-Item *.bad -ErrorAction SilentlyContinue Remove-Item *.dsc -ErrorAction SilentlyContinue Remove-Item LoadData-Oracle.bat -ErrorAction SilentlyContinue Remove-Item LoadData-MSSQL.sql -ErrorAction SilentlyContinue ForEach ($FilenameExt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $Filenames) { Write-Host <span class="hljs-string"><span class="hljs-string">"Processing file: "</span></span>$FilenameExt $StockName = $FilenameExt.<span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>, $FilenameExt.Length<span class="hljs-number"><span class="hljs-number">-5</span></span>) $FilenameCtl = <span class="hljs-string"><span class="hljs-string">'.'</span></span>+$Stockname+<span class="hljs-string"><span class="hljs-string">'.ctl'</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"OPTIONS (DIRECT=TRUE, PARALLEL=FALSE, ROWS=1000000, SKIP_INDEX_MAINTENANCE=Y)"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"UNRECOVERABLE"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"LOAD DATA"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"INFILE '.$StockName.csv'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"BADFILE '.$StockName.bad'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"DISCARDFILE '.$StockName.dsc'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"INTO TABLE TRANSACTIONS_RAW"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"APPEND"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"FIELDS TERMINATED BY ','"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"(ID SEQUENCE (0), STOCK_NAME constant '$StockName', UT, APRICE, AVOLUME)"</span></span> Add-Content -Path LoadData-Oracle.bat -Value <span class="hljs-string"><span class="hljs-string">"sqlldr $OracleConnectString control=$FilenameCtl"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"insert into TRANSACTIONS_RAW (STOCK_NAME, UT, APRICE, AVOLUME)"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"select '$StockName' as STOCK_NAME, UT, APRICE, AVOLUME"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"from openrowset (bulk '$PathToCSV\$FilenameExt', formatfile = '$PathToCSV\format_mssql.bcp') as T1;"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">""</span></span> }</code> </pre><br>  Mari kita buat tabel transaksi pada Oracle. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> TRANSACTIONS_RAW ( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME varchar2 (<span class="hljs-number"><span class="hljs-number">32</span></span>) , UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , APRICE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) pctfree <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parallel</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> nologging;</code> </pre><br>  Di Oracle, jalankan file <i>LoadData-Oracle.bat</i> , setelah sebelumnya <i>memperbaiki</i> parameter koneksi di awal skrip Powershell. <br><br>  Saya bekerja di mesin virtual.  Mengunduh semua file transaksi 11M dalam file 8 kraken * (saya melewatkan file EUR) membutuhkan waktu sekitar 1 menit. <br><br>  Dan membuat fungsi yang akan memotong tanggal ke batas interval: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> TRUNC_UT (p_UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, p_StripeTypeId <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">deterministic</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> p_StripeTypeId <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">10</span></span>) * <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">600</span></span>) * <span class="hljs-number"><span class="hljs-number">600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">3600</span></span>) * <span class="hljs-number"><span class="hljs-number">3600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / ( <span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>)) * ( <span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / (<span class="hljs-number"><span class="hljs-number">24</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>)) * (<span class="hljs-number"><span class="hljs-number">24</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc ((trunc (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'Month'</span></span>) - <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span>) * <span class="hljs-number"><span class="hljs-number">86400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc ((trunc (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'year'</span></span>) - <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span>) * <span class="hljs-number"><span class="hljs-number">86400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> UT2DATESTR (p_UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> varchar2 <span class="hljs-keyword"><span class="hljs-keyword">deterministic</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> to_char (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'YYYY.MM.DD HH24:MI:SS'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  Pertimbangkan opsinya.  Pertama, kode semua opsi diberikan, lalu skrip untuk peluncuran dan pengujian.  Pertama, tugas dijelaskan untuk Oracle, kemudian untuk MS SQL <br><br><h4>  Opsi 1 - SIMP (Sepele) </h4><br>  Seluruh rangkaian transaksi dikalikan dengan produk Cartesian dengan satu set 10 garis dengan angka dari 1 hingga 10. Ini diperlukan untuk mendapatkan 10 garis dari satu garis transaksi dengan tanggal yang dipotong pada batas 10 interval. <br><br>  Setelah itu, garis dikelompokkan berdasarkan nomor interval dan tanggal terpotong, dan permintaan di atas dijalankan. <br><br>  Buat LIHAT: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_SIMP_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW , (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rownum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID);</code> </pre><br><h4>  Opsi 2 - CALC (dihitung secara iteratif) </h4><br>  Dalam opsi ini, kami melakukan iteratif dari transaksi ke level 1, dari level 1 ke level 2, dan seterusnya. <br><br>  Buat tabel: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> QUOTES_CALC ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME varchar2 (<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) <span class="hljs-comment"><span class="hljs-comment">/*partition by list (STRIPE_ID) ( partition P01 values (1) , partition P02 values (2) , partition P03 values (3) , partition P04 values (4) , partition P05 values (5) , partition P06 values (6) , partition P07 values (7) , partition P08 values (8) , partition P09 values (9) , partition P10 values (10) )*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parallel</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> pctfree <span class="hljs-number"><span class="hljs-number">0</span></span> nologging;</code> </pre><br>  Anda dapat membuat indeks menggunakan bidang STRIPE_ID, tetapi telah ditetapkan secara eksperimental bahwa itu lebih menguntungkan untuk 11 juta transaksi tanpa indeks.  Untuk jumlah yang lebih besar, situasinya dapat berubah.  Atau Anda bisa mempartisi tabel dengan membatalkan komentar blok dalam kueri. <br><br>  Buat prosedur: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> THINNING_HABR_CALC_T <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rollback</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">immediate</span></span> <span class="hljs-string"><span class="hljs-string">'truncate table QUOTES_CALC'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-comment"><span class="hljs-comment">--+ append into QUOTES_CALC select 1 as STRIPE_ID , STOCK_NAME , UT , avg (APRICE) keep (dense_rank first order by ID) , max (APRICE) , min (APRICE) , avg (APRICE) keep (dense_rank last order by ID) , sum (AVOLUME) , sum (APRICE * AVOLUME) , count (*) from TRANSACTIONS_RAW a group by STOCK_NAME, UT; commit; for i in 1..9 loop insert --+ append into QUOTES_CALC select --+ parallel(4) STRIPE_ID + 1 , STOCK_NAME , TRUNC_UT (UT, i + 1) , avg (AOPEN) keep (dense_rank first order by UT) , max (AHIGH) , min (ALOW) , avg (ACLOSE) keep (dense_rank last order by UT) , sum (AVOLUME) , sum (AAMOUNT) , sum (ACOUNT) from QUOTES_CALC a where STRIPE_ID = i group by STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, i + 1); commit; end loop; end; /</span></span></code> </pre><br>  Untuk simetri, buat VIEW sederhana: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_CALC_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> QUOTES_CALC;</code> </pre><br><h4>  Opsi 3 - CHIN (Kode Cina) </h4><br>  Metodenya berbeda langsung dari pendekatan brutal, dan merupakan penolakan terhadap prinsip "Jangan ulangi diri Anda sendiri."  Dalam hal ini, penolakan siklus. <br><br>  Opsi ini disediakan di sini hanya untuk kelengkapan. <br><br>  Ke depan, saya akan mengatakan bahwa dalam hal kinerja pada tugas khusus ini dibutuhkan tempat kedua. <br><br><div class="spoiler">  <b class="spoiler_title">Permintaan besar</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_CHIN_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T01 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT) , T02 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T01 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T03 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T02 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T04 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T03 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T05 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T04 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T06 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T05 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T07 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T06 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T08 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T07 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T09 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T08 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T10 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T09 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T01 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T02 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T03 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T04 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T05 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T06 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T07 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T08 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T09 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T10;</code> </pre><br></div></div><br><h4>  Opsi 4 - UDAF </h4><br>  Opsi dengan Fungsi Gabungan yang Ditentukan Pengguna tidak akan diberikan di sini, tetapi dapat dilihat di github. <br><br><h4>  Opsi 5 - PPTF (Fungsi tabel dan Paralel) </h4><br>  Buat fungsi (dalam paket): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> THINNING_PPTF_P <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> TRANSACTION_RECORD_T <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-built_in"><span class="hljs-built_in">record</span></span> (STOCK_NAME varchar2(<span class="hljs-number"><span class="hljs-number">128</span></span>), UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, SEQ_NUM <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, APRICE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>); type CUR_RECORD_T is ref cursor return TRANSACTION_RECORD_T; type QUOTE_T is record (STRIPE_ID number, STOCK_NAME varchar2(128), UT number , AOPEN number, AHIGH number, ALOW number, ACLOSE number, AVOLUME number , AAMOUNT number, ACOUNT number); type QUOTE_LIST_T is table of QUOTE_T; function F (p_cursor CUR_RECORD_T) return QUOTE_LIST_T pipelined order p_cursor by (STOCK_NAME, UT, SEQ_NUM) parallel_enable (partition p_cursor by hash (STOCK_NAME)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; / <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> THINNING_PPTF_P <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> F (p_cursor CUR_RECORD_T) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QUOTE_LIST_T <span class="hljs-keyword"><span class="hljs-keyword">pipelined</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> p_cursor <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> (STOCK_NAME, UT, SEQ_NUM) <span class="hljs-keyword"><span class="hljs-keyword">parallel_enable</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> p_cursor <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">hash</span></span> (STOCK_NAME)) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> QuoteTail QUOTE_LIST_T := QUOTE_LIST_T() ; rec TRANSACTION_RECORD_T; rec_prev TRANSACTION_RECORD_T; type ut_T is table of number index by pls_integer; ut number; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> QuoteTail.extend(<span class="hljs-number"><span class="hljs-number">10</span></span>); loop fetch p_cursor into rec; exit when p_cursor%notfound; if rec_prev.STOCK_NAME = rec.STOCK_NAME then if (rec.STOCK_NAME = rec_prev.STOCK_NAME and rec.UT &lt; rec_prev.UT) or (rec.STOCK_NAME = rec_prev.STOCK_NAME and rec.UT = rec_prev.UT and rec.SEQ_NUM &lt; rec_prev.SEQ_NUM) then raise_application_error (-20010, 'Rowset must be ordered, ('||rec_prev.STOCK_NAME||','||rec_prev.UT||','||rec_prev.SEQ_NUM||') &gt; ('||rec.STOCK_NAME||','||rec.UT||','||rec.SEQ_NUM||')'); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.STOCK_NAME &lt;&gt; rec_prev.STOCK_NAME or rec_prev.STOCK_NAME is null then for j in 1 .. 10 loop if QuoteTail(j).UT is not null then pipe row (QuoteTail(j)); QuoteTail(j) := null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; for i in reverse 1..10 loop ut := TRUNC_UT (rec.UT, i); if QuoteTail(i).UT &lt;&gt; ut then for j in 1..i loop pipe row (QuoteTail(j)); QuoteTail(j) := null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if QuoteTail(i).UT is null then QuoteTail(i).STRIPE_ID := i; QuoteTail(i).STOCK_NAME := rec.STOCK_NAME; QuoteTail(i).UT := ut; QuoteTail(i).AOPEN := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.APRICE &lt; QuoteTail(i).ALOW or QuoteTail(i).ALOW is null then QuoteTail(i).ALOW := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.APRICE &gt; QuoteTail(i).AHIGH or QuoteTail(i).AHIGH is null then QuoteTail(i).AHIGH := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; QuoteTail(i).AVOLUME := nvl (QuoteTail(i).AVOLUME, 0) + rec.AVOLUME; QuoteTail(i).AAMOUNT := nvl (QuoteTail(i).AAMOUNT, 0) + rec.AVOLUME * rec.APRICE; QuoteTail(i).ACOUNT := nvl (QuoteTail(i).ACOUNT, 0) + 1; QuoteTail(i).ACLOSE := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; rec_prev := rec; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; for j in 1 .. 10 loop if QuoteTail(j).UT is not null then pipe row (QuoteTail(j)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; exception when no_data_needed then null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; /</code> </pre><br>  Buat LIHAT: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_PPTF_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> (THINNING_PPTF_P.F (<span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, APRICE, AVOLUME <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW)));</code> </pre><br><h4>  Opsi 6 - MODE (model clause) </h4><br>  Opsi iteratif menghitung penipisan untuk semua 10 level menggunakan frase klausa <i>MODEL</i> dengan frasa <i>ITERATE</i> . <br><br>  Opsi ini juga tidak praktis karena lambat.  Di lingkungan saya, 1000 transaksi untuk 8 instrumen dihitung dalam 1 menit.  Sebagian besar waktu dihabiskan untuk menghitung frase <i>MODEL</i> . <br><br>  Di sini saya memberikan opsi ini hanya demi kelengkapan dan sebagai konfirmasi atas fakta bahwa pada Oracle hampir semua perhitungan kompleks yang sewenang-wenang dapat dilakukan dengan satu permintaan, tanpa menggunakan PL / SQL. <br><br>  Salah satu alasan rendahnya kinerja frase <i>MODEL</i> dalam permintaan ini adalah bahwa pencarian di sebelah kanan dilakukan untuk <i>setiap</i> aturan yang kita miliki 6. Dua aturan pertama dihitung cukup cepat, karena ada pengalamatan eksplisit langsung, tanpa pelawak.  Dalam empat aturan sisanya ada kata <i>any</i> - ada perhitungan lebih lambat. <br><br>  Kesulitan kedua adalah Anda harus menghitung model referensi.  Ini diperlukan karena daftar dimensi harus diketahui <b>sebelum</b> menghitung frase <i>MODEL</i> , kami tidak dapat menghitung dimensi baru di dalam frasa ini.  Mungkin ini dapat dielakkan dengan bantuan dua frase MODEL, tetapi saya tidak melakukan ini karena kinerja yang rendah dari sejumlah besar aturan. <br><br>  Saya menambahkan bahwa dimungkinkan untuk tidak menghitung <i>UT_OPEN</i> dan <i>UT_CLOSE</i> dalam model referensi, tetapi untuk menggunakan fungsi yang sama <i>avg () tetap (dense_rank urutan pertama / terakhir oleh)</i> langsung dalam frase <i>MODEL</i> .  Tetapi itu akan terjadi bahkan lebih lambat. <br>  Karena keterbatasan kinerja, saya tidak akan memasukkan opsi ini dalam prosedur pengujian. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-comment"><span class="hljs-comment">--       SOURCETRANS (STRIPE_ID, STOCK_NAME, PARENT_UT, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) as (select 1, STOCK_NAME, TRUNC_UT (UT, 2), UT , avg (APRICE) keep (dense_rank first order by ID) , max (APRICE) , min (APRICE) , avg (APRICE) keep (dense_rank last order by ID) , sum (AVOLUME) , sum (AVOLUME * APRICE) , count (*) from TRANSACTIONS_RAW where ID &lt;= 1000 --       group by STOCK_NAME, UT) --   PARENT_UT, UT  2...10    UT_OPEN, UT_CLOSE --    , REFMOD (STRIPE_ID, STOCK_NAME, PARENT_UT, UT, UT_OPEN, UT_CLOSE) as (select b.STRIPE_ID , a.STOCK_NAME , TRUNC_UT (UT, b.STRIPE_ID + 1) , TRUNC_UT (UT, b.STRIPE_ID) , min (TRUNC_UT (UT, b.STRIPE_ID - 1)) , max (TRUNC_UT (UT, b.STRIPE_ID - 1)) from SOURCETRANS a , (select rownum + 1 as STRIPE_ID from dual connect by level &lt;= 9) b group by b.STRIPE_ID , a.STOCK_NAME , TRUNC_UT (UT, b.STRIPE_ID + 1) , TRUNC_UT (UT, b.STRIPE_ID)) --        , MAINTAB as ( select STRIPE_ID, STOCK_NAME, PARENT_UT, UT, AOPEN , AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT, null, null from SOURCETRANS union all select STRIPE_ID, STOCK_NAME, PARENT_UT, UT, null , null, null, null, null, null, null, UT_OPEN, UT_CLOSE from REFMOD) select STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT from MAINTAB model return all rows --      2...10 reference RM on (select * from REFMOD) dimension by (STRIPE_ID, STOCK_NAME, UT) measures (UT_OPEN, UT_CLOSE) main MM partition by (STOCK_NAME) dimension by (STRIPE_ID, PARENT_UT, UT) measures (AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) rules iterate (9) ( AOPEN [iteration_number + 2, any, any] = AOPEN [cv (STRIPE_ID) - 1, cv (UT) , rm.UT_OPEN [cv (STRIPE_ID), cv (STOCK_NAME), cv (UT)]] , ACLOSE [iteration_number + 2, any, any] = ACLOSE [cv (STRIPE_ID) - 1, cv (UT) , rm.UT_CLOSE[cv (STRIPE_ID), cv (STOCK_NAME), cv (UT)]] , AHIGH [iteration_number + 2, any, any] = max (AHIGH)[cv (STRIPE_ID) - 1, cv (UT), any] , ALOW [iteration_number + 2, any, any] = min (ALOW)[cv (STRIPE_ID) - 1, cv (UT), any] , AVOLUME [iteration_number + 2, any, any] = sum (AVOLUME)[cv (STRIPE_ID) - 1, cv (UT), any] , AAMOUNT [iteration_number + 2, any, any] = sum (AAMOUNT)[cv (STRIPE_ID) - 1, cv (UT), any] , ACOUNT [iteration_number + 2, any, any] = sum (ACOUNT)[cv (STRIPE_ID) - 1, cv (UT), any] ) order by 1, 2, 3, 4;</span></span></code> </pre><br><h4>  Opsi 6 - IDEA (ideal, ideal, tetapi tidak beroperasi) </h4><br>  Permintaan yang dijelaskan di bawah ini berpotensi menjadi yang paling efisien dan mengonsumsi jumlah sumber daya yang sama dengan minimum teoretis. <br><br>  Tetapi baik Oracle maupun MS SQL tidak memungkinkan Anda untuk menulis kueri dalam formulir ini.  Saya percaya ini ditentukan oleh standar. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> QUOTES_S1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-comment"><span class="hljs-comment">-- where rownum &lt;= 100 group by STOCK_NAME, TRUNC_UT (UT, 1)) , T1 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) as (select 1, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT from QUOTES_S1 union all select STRIPE_ID + 1 , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + 1) , avg (AOPEN) keep (dense_rank first order by UT) , max (AHIGH) , min (ALOW) , avg (ACLOSE) keep (dense_rank last order by UT) , sum (AVOLUME) , sum (AAMOUNT) , sum (ACOUNT) from T1 where STRIPE_ID &lt; 10 group by STRIPE_ID + 1, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + 1) ) select * from T1</span></span></code> </pre><br>  Kueri ini terkait dengan bagian berikut dari dokumentasi Oracle: <br><br>  <i>Jika sebuah subquery_factoring_clause merujuk pada nama_pertanyaannya sendiri dalam subquery yang mendefinisikannya, maka subquery_factoring_clause dikatakan rekursif.</i>  <i>Subquery_factoring_clause rekursif harus berisi dua blok permintaan: yang pertama adalah anggota anchor dan yang kedua adalah anggota rekursif.</i>  <i>Anggota anchor harus muncul sebelum anggota rekursif, dan tidak dapat mereferensikan query_name.</i>  <i>Anggota anchor dapat terdiri dari satu atau lebih blok permintaan yang digabungkan oleh operator yang ditetapkan: UNION ALL, UNION, INTERSECT atau MINUS.</i>  <i>Anggota rekursif harus mengikuti anggota anchor dan harus mereferensikan query_name tepat sekali.</i>  <i>Anda harus menggabungkan anggota rekursif dengan anggota jangkar menggunakan operator set UNION ALL.</i> <br><br>  Tetapi itu bertentangan dengan paragraf dokumentasi berikut: <br><br>  <i>Anggota rekursif tidak dapat mengandung elemen-elemen berikut:</i> <i><br></i>  <i>Kata kunci DISTINCT atau klausa GROUP BY</i> <i><br></i>  <i>Fungsi agregat.</i>  <i>Namun, fungsi analitik diizinkan dalam daftar pilih.</i> <br><br>  Dengan demikian, dalam anggota rekursif, agregat dan pengelompokan tidak diperbolehkan. <br><br><h3>  Pengujian </h3><br><br>  Mari kita lakukan dulu untuk <b>Oracle</b> . <br><br>  Lakukan prosedur perhitungan untuk metode CALC dan catat waktu pelaksanaannya: <br><br><pre> <code class="sql hljs">exec THINNING_HABR_CALC_T</code> </pre> <br>  Hasil perhitungan untuk keempat metode tersebut dalam empat tampilan: <br><br><ul><li>  THINNING_HABR_SIMP_V (akan melakukan perhitungan, menyebabkan SELECT yang kompleks, sehingga akan memakan waktu lama), </li><li>  THINNING_HABR_CALC_V (akan menampilkan data dari tabel QUOTES_CALC, sehingga akan dieksekusi dengan cepat) </li><li>  THINNING_HABR_CHIN_V (juga akan melakukan perhitungan, menyebabkan SELECT yang kompleks, sehingga akan memakan waktu lama), </li><li>  THINNING_HABR_PPTF_V (akan menjalankan fungsi THINNING_HABR_PPTF). </li></ul><br>  Waktu tunggu untuk semua metode sudah diukur oleh saya dan diberikan dalam tabel di akhir artikel. <br><br>  Untuk sisa LIHAT, kami mengeksekusi permintaan dan menulis waktu eksekusi: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_XXXX_V</code> </pre><br>  di mana XXXX adalah SIMP, CHIN, PPTF. <br><br>  PANDANGAN INI menghitung intisari perekrutan.  Untuk menghitung intisari, Anda harus mengambil semua garis, dan menggunakan intisari Anda dapat membandingkan set dengan satu sama lain. <br><br>  Anda juga dapat membandingkan set menggunakan paket dbms_sqlhash, tetapi ini jauh lebih lambat karena Anda perlu mengurutkan set asli, dan perhitungan hash tidak cepat. <br>  Juga dalam 12c ada paket DBMS_COMPARISON. <br><br>  Anda dapat memeriksa kebenaran semua algoritma pada saat yang sama.  Kami menganggap intisari sebagai permintaan (dengan 11M entri di mesin virtual, ini akan relatif lama, sekitar 15 menit): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'SIMP'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALG_NAME, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_SIMP_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CALC'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CALC_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CHIN'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CHIN_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'PPTF'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_PPTF_V a) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ALG_NAME , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> ALG_NAME;</code> </pre><br>  Kami melihat bahwa pencernaannya sama, jadi semua algoritma memberikan hasil yang sama. <br><br>  Sekarang kita akan mereproduksi semua sama di <b>MS SQL</b> .  Saya menguji pada versi 2016. <br><br>  Pertama buat database DBTEST, lalu buat tabel transaksi di dalamnya: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> TRANSACTIONS_RAW ( STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span> (<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">identity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> );</code> </pre><br>  Unduh data yang diunduh. <br><br>  Di MSSQL, buat file format_mssql.bcp: <br><br><pre> <code class="sql hljs">12.0 3 1 SQLCHAR 0 0 "," 3 UT "" 2 SQLCHAR 0 0 "," 4 APRICE "" 3 SQLCHAR 0 0 "\n" 5 AVOLUME ""</code> </pre><br>  Dan jalankan skrip LoadData-MSSQL.sql di SSMS (skrip ini dihasilkan oleh skrip powershell yang disediakan di bagian artikel ini untuk Oracle). <br><br>  Mari kita membuat dua fungsi: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> TRUNC_UT (@p_UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>, @p_StripeTypeId <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> @p_StripeTypeId <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">600</span></span> * <span class="hljs-number"><span class="hljs-number">600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">3600</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">14400</span></span> * <span class="hljs-number"><span class="hljs-number">14400</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span> * <span class="hljs-number"><span class="hljs-number">86400</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime), <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(m, <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (m, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime))), <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime), <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(yy, <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (yy, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime))), <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> UT2DATESTR (@p_UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(s, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kami terus menerapkan opsi: </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Opsi 1 - SIMP </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jalankan: </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.THINNING_HABR_SIMP_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> STRIPE_ID &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) , T2 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID , STOCK_NAME , dbo.TRUNC_UT (UT, STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (<span class="hljs-number"><span class="hljs-number">1000000</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_UT , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (<span class="hljs-number"><span class="hljs-number">1000000</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW, T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, dbo.TRUNC_UT (UT, STRIPE_ID)) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.STRIPE_ID, t.STOCK_NAME, t.UT, t_op.APRICE <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN, t.AHIGH , t.ALOW, t_cl.APRICE <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T2 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT / <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_op.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT % <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_op.ID) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT / <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_cl.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT % <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_cl.ID);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pertama / terakhir yang</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hilang </font><font style="vertical-align: inherit;">diimplementasikan oleh penggandaan tabel ganda secara mandiri.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Opsi 2 - CALC </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Buat tabel, prosedur, dan tampilan: </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> dbo.QUOTES_CALC ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ); go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> dbo.THINNING_HABR_CALC <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">truncate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> QUOTES_CALC; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @StripeId <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME , UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_ID , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_ID , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT) <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, t.STOCK_NAME, t.UT, t_op.APRICE, t.AHIGH, t.ALOW, t_cl.APRICE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.UT = t_op.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_ID = t_op.ID) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.UT = t_cl.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_ID = t_cl.ID); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @StripeId = <span class="hljs-number"><span class="hljs-number">1</span></span>; while (@StripeId &lt;= 9) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME , dbo.TRUNC_UT (UT, @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_UT , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> QUOTES_CALC <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> STRIPE_ID = @StripeId <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, dbo.TRUNC_UT (UT, @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>, t.STOCK_NAME, t.UT, t_op.AOPEN, t.AHIGH, t.ALOW, t_cl.ACLOSE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> QUOTES_CALC t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT = t_op.UT) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> QUOTES_CALC t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT = t_cl.UT) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> t_op.STRIPE_ID = @StripeId <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t_cl.STRIPE_ID = @StripeId; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @StripeId = @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.THINNING_HABR_CALC_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.QUOTES_CALC; go</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Saya tidak menerapkan opsi 3 (CHIN) dan 4 (UDAF) pada MS SQL. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Opsi 5 - PPTF </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buat fungsi dan tampilan tabel. </font><font style="vertical-align: inherit;">Fungsi ini hanyalah fungsi tabel, bukan fungsi tabel pipelined paralel, hanya opsi yang mempertahankan nama historisnya dari Oracle:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> dbo.THINNING_HABR_PPTF () <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> @rettab <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @i tinyint; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @tut <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @QuoteTail <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> clustered , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> fast_forward <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, APRICE, AVOLUME <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>; <span class="hljs-comment"><span class="hljs-comment">-- THIS ORDERING (STOCK_NAME, UT, ID) IS MANDATORY open c; fetch next from c into @trans_STOCK_NAME, @trans_UT, @trans_ID, @trans_APRICE, @trans_AVOLUME; while @@fetch_status = 0 begin if @trans_STOCK_NAME &lt;&gt; @trans_prev_STOCK_NAME or @trans_prev_STOCK_NAME is null begin insert into @rettab select * from @QuoteTail; delete @QuoteTail; end; set @i = 10; while @i &gt;= 1 begin set @tut = dbo.TRUNC_UT (@trans_UT, @i); if @tut &lt;&gt; (select UT from @QuoteTail where STRIPE_ID = @i) begin insert into @rettab select * from @QuoteTail where STRIPE_ID &lt;= @i; delete @QuoteTail where STRIPE_ID &lt;= @i; end; if (select count (*) from @QuoteTail where STRIPE_ID = @i) = 0 begin insert into @QuoteTail (STRIPE_ID, STOCK_NAME, UT, AOPEN, AVOLUME, AAMOUNT, ACOUNT) values (@i, @trans_STOCK_NAME, @tut, @trans_APRICE, 0, 0, 0); end; update @QuoteTail set AHIGH = case when AHIGH &lt; @trans_APRICE or AHIGH is null then @trans_APRICE else AHIGH end , ALOW = case when ALOW &gt; @trans_APRICE or ALOW is null then @trans_APRICE else ALOW end , ACLOSE = @trans_APRICE, AVOLUME = AVOLUME + @trans_AVOLUME , AAMOUNT = AAMOUNT + @trans_APRICE * @trans_AVOLUME , ACOUNT = ACOUNT + 1 where STRIPE_ID = @i; set @i = @i - 1; end; set @trans_prev_STOCK_NAME = @trans_STOCK_NAME; set @trans_prev_UT = @trans_UT; set @trans_prev_ID = @trans_ID; set @trans_prev_APRICE = @trans_APRICE; set @trans_prev_AVOLUME = @trans_AVOLUME; fetch next from c into @trans_STOCK_NAME, @trans_UT, @trans_ID, @trans_APRICE, @trans_AVOLUME; end; close c; deallocate c; insert into @rettab select * from @QuoteTail; return; end go create or alter view dbo.THINNING_HABR_PPTF_V as select * from dbo.THINNING_HABR_PPTF ();</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mari kita hitung tabel QUOTES_CALC untuk metode CALC dan tulis waktu eksekusi: </font></font><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> exec dbo.THINNING_HABR_CALC</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hasil perhitungan untuk ketiga metode tersebut dalam tiga tampilan: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> THINNING_HABR_SIMP_V (akan melakukan perhitungan, menyebabkan SELECT yang kompleks, sehingga akan memakan waktu lama), </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> THINNING_HABR_CALC_V (akan menampilkan data dari tabel QUOTES_CALC, sehingga akan dieksekusi dengan cepat) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> THINNING_HABR_PPTF_V (akan menjalankan fungsi THINNING_HABR_PPTF). </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Selama dua LIHAT, kami mengeksekusi permintaan dan menulis waktu eksekusi: </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_XXXX_V</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di mana XXXX adalah SIMP, PPTF. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sekarang Anda dapat membandingkan hasil perhitungan untuk tiga metode untuk MS SQL. </font><font style="vertical-align: inherit;">Ini dapat dilakukan dalam satu permintaan. </font><font style="vertical-align: inherit;">Jalankan:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'SIMP'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALG_NAME, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_SIMP_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CALC'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CALC_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'PPTF'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_PPTF_V a) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ALG_NAME , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (STRIPE_ID <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> ALG_NAME;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika tiga garis bertepatan di semua bidang, hasil perhitungan menggunakan tiga metode adalah identik. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya sangat menyarankan Anda untuk menggunakan pilihan kecil pada tahap pengujian, karena kinerja tugas ini di MS SQL rendah. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika Anda hanya memiliki mesin MS SQL dan ingin menghitung jumlah data yang lebih besar, maka Anda dapat mencoba metode pengoptimalan berikut: Anda dapat membuat indeks:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> TRANSACTIONS_RAW_I1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> TRANSACTIONS_RAW (STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> QUOTES_CALC_I1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hasil pengukuran kinerja pada mesin virtual saya adalah sebagai berikut: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ss/4s/7x/ss4s7xhwteedzj1qgsjmb20hvvw.png" alt="gambar"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skrip dapat diunduh dari </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Oracle, skema THINNING - skrip artikel ini, skema THINNING_LIVE - </font><font style="vertical-align: inherit;">data </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unduhan online</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dari bitcoincharts.com dan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">penjarangan online</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (tetapi situs ini hanya </font><font style="vertical-align: inherit;">mengirim </font><font style="vertical-align: inherit;">data selama 5 hari terakhir dalam mode online), dan skrip untuk MS SQL juga ada di artikel ini. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan:</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tugas ini diselesaikan lebih cepat pada Oracle daripada pada MS SQL. Dengan meningkatnya jumlah transaksi, kesenjangan menjadi lebih signifikan. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di Oracle, PPTF adalah pilihan terbaik. Di sini pendekatan prosedural ternyata lebih menguntungkan, ini jarang terjadi. Metode lain juga menunjukkan hasil yang dapat diterima - Saya bahkan menguji volume transaksi 367M di mesin virtual (metode PPTF dihitung menipis dalam satu setengah jam).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pada MS SQL, metode perhitungan berulang (CALC) ternyata yang paling produktif. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengapa metode PPTF pada Oracle berubah menjadi pemimpin? </font><font style="vertical-align: inherit;">Karena konkurensi dan arsitektur, fungsi yang dibuat sebagai fungsi tabel pipelined paralel tertanam di tengah rencana kueri:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/za/ss/nl/zassnleqabvacrdkxnumjhd5mky.png" alt="gambar"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id418757/">https://habr.com/ru/post/id418757/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id418741/index.html">Tambahkan enkripsi dan dorong ke SIP biasa</a></li>
<li><a href="../id418743/index.html">Kisah Tempat Pertama di ML Boot Camp VI</a></li>
<li><a href="../id418751/index.html">Dex mata-mata Cina kurang ajar</a></li>
<li><a href="../id418753/index.html">vSAN di VMware Cloud</a></li>
<li><a href="../id418755/index.html">Bagaimana e-commerce bertahan dalam promosi skala besar. Bersiap-siap untuk beban puncak di web [Bagian 1]</a></li>
<li><a href="../id418759/index.html">Berapa biaya bagi siswa untuk mengeluarkan chip?</a></li>
<li><a href="../id418761/index.html">Buku “Pure Python. Seluk-beluk pemrograman untuk pro »</a></li>
<li><a href="../id418763/index.html">Menengah / senior: bagaimana cara keluar dari rawa?</a></li>
<li><a href="../id418765/index.html">Tips Dadata membantu mengisi formulir input apa pun. Sekarang sembuh</a></li>
<li><a href="../id418767/index.html">Warisan game yang sangat besar dari Adobe Flash dan upaya saya untuk menyimpannya</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>