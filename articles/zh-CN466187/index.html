<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍🏫 👨🏿‍⚕️ ⭐️ Unity3d的可视逻辑编辑器。 第二部分 🍘 🔹 👩🏿‍🤝‍👨🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="引言 
 尊敬的读者您好，在今天的文章中，我想重点介绍Unity3d的可视逻辑编辑器内核的体系结构主题。 这是本系列的第二部分。 您可以在这里阅读上一篇。 那么我们要谈什么呢？ 可视编辑器基于核心内核，该内核使您可以运行，加载和存储逻辑数据。 反过来，如上一篇文章中所述，内核使用Scriptable...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Unity3d的可视逻辑编辑器。 第二部分</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466187/"><h2> 引言 </h2><br> 尊敬的读者您好，在今天的文章中，我想重点介绍<b>Unity3d</b>的可视逻辑编辑器内核的体系结构主题。 这是本系列的第二部分。 您可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a>阅读上一篇。 那么我们要谈什么呢？ 可视编辑器基于核心内核，该内核使您可以运行，加载和存储逻辑数据。 反过来，如上一篇文章中所述，内核使用<b>ScriptableObject</b>作为使用逻辑组件的基类。 让我们更详细地考虑所有这些方面。 <br><br> 该系列文章： <br><br>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Unity3d的可视逻辑编辑器。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第一部分</a> <br><a name="habracut"></a><br><h2> 为什么是ScriptableObject？ </h2><br> 在开始开发之前，我考虑了很长时间来构建系统。 在第一种形式中-它是<b>MonoBehaviour</b> ，但是我不得不放弃这个想法，因为这些脚本应该作为组件挂在<b>GameObject上</b> 。 下一步是使用您自己的类的想法，该类不是<b>UnityEngine.Object</b>的后代。 但是此选项虽然起作用，但并未扎根，但它一直拖延着编写其序列化程序，检查器，垃圾收集器等。结果，唯一合理的方法是使用<b>ScriptableObject</b> ，如果创建，其生命周期类似于<b>MonoBehaviour</b> 。 <b>在</b>应用程序通过<b>ScriptableObject.CreateInstance</b>运行时发生。 此外，使用<b>JsonUtility</b> （尽管现在不再是问题）和<b>Unity</b>检查器可以自动解决此问题。 <br><br><h2> 建筑学 </h2><br> 下面是<b>uViLEd</b>核心<b>组成的</b>一般示意图。 <br><br><img src="https://habrastorage.org/webt/xd/o-/kp/xdo-kp-skmrrvbfw0jy33l3r02o.png" alt="图片"><br><br> 让我们更详细地考虑每个元素。 <br><br><h3> 控制者 </h3><br> 控制器是内核的主要元素，它是<b>MonoBehavior</b>脚本（整个系统中唯一的脚本）。 控制器类是单例，并且逻辑的所有组件均可访问。 此类的作用： <br><br><ol><li> 存储<b>Unity</b>对象链接 </li><li> 在场景开始时开始逻辑 </li><li> 表示对从外部源运行逻辑的方法的访问 </li><li> 提供组件中<b>Mono</b>方法的工作 </li></ol><br><div class="spoiler">  <b class="spoiler_title">控制器类基本代码</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">uViLEd.Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogicController</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> LogicController _instance; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> LogicController Instance { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { _instance = _instance ?? FindObjectOfType&lt;LogicController&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _instance; } } [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SceneLogicData</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TextAsset BinaryData =&gt; _data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Id =&gt; _id; [SerializeField] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _id; [SerializeField] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TextAsset _data; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SceneLogicData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name, TextAsset binaryData</span></span></span><span class="hljs-function">)</span></span> { _id = id; _data = binaryData; Name = name; } } [HideInInspector] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;SceneLogicData&gt; SceneLogicList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;SceneLogicData&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Awake</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _instance = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sceneLogic <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> SceneLogicList) { RunLogicInternal(LogicStorage.Load(sceneLogic.BinaryData)); } } } }</code> </pre> <br></div></div><br>  <b>注意</b> ：每个场景都有自己的控制器和逻辑集。 <br>  <b>注意</b> ：有关加载逻辑数据及其启动的更多详细信息，将另行讨论。 <br><br><h3>  uViLEd内核的核心元素 </h3><br><h4> 组成部分 </h4><br> 在第一部分中，我已经说过该组件是<b>ScriptableObject</b> 。 所有组件都是<b>LogicComponent</b>类的后代，而<b>LogicComponent</b>类<b>又很</b>简单。 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">uViLEd.Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogicComponent</span></span> : <span class="hljs-title"><span class="hljs-title">ScriptableObject</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> MonoBehaviour coroutineHost =&gt; _logicHost; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MonoBehaviour _logicHost; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Constructor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } } }</code> </pre><br> 在这里， <b>coroutineHost</b>是到逻辑控制器的链接，仅为方便起见而引入，顾名思义，它用于与协程一起工作。 为了将组件与<b>Unity</b>项目中存在的其他代码分开，必须使用这种抽象。 <br><br><h4> 变数 </h4><br> 如上一篇文章中所述，变量是用于存储数据的专用组件，其代码如下所示。 <br><br><div class="spoiler">  <b class="spoiler_title">可变执行代码</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">uViLEd.Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Variable</span></span> : <span class="hljs-title"><span class="hljs-title">LogicComponent</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Variable</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">Variable</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Changed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Set</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T newValue</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Changed OnChanged; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Set OnSet; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _value; }<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> changed = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_value == <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span> || (_value != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; !_value.Equals(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>))) { changed = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } _value = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changed) { OnChanged?.Invoke(); } OnSet?.Invoke(_value); } } [SerializeField] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> T _value; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnDestroy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(OnSet != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> eventHandler <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> OnSet.GetInvocationList()) { OnSet -= (Set)eventHandler; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(OnChanged != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> eventHandler <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> OnChanged.GetInvocationList()) { OnChanged -= (Changed)eventHandler; } } } } }</code> </pre><br></div></div><br> 这里， <b>变量</b>是所有变量的基本抽象类，必须将它们与普通组件分开。 主类是<b>通用</b>类，它存储数据本身并提供用于设置值和更改值的事件。 <br><br><h4> 通讯技术 </h4><br> 我在上一篇文章中告诉过什么关系。 简而言之，它是一个虚拟实体，它允许组件使用彼此的方法，并且还引用逻辑变量。 对于程序员而言，此连接是软连接，并且在代码中不可见。 所有通信都是在初始化过程中形成的（请在下面阅读）。 考虑允许您形成关系的类。 <br><br><div class="spoiler">  <b class="spoiler_title">入口点</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">uViLEd.Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">INPUT_POINT</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Action&lt;T&gt; Handler; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">INPUT_POINT</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Action Handler; } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">出口点</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">uViLEd.Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OUTPUT_POINT</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Action&lt;T&gt;&gt; _linkedInputPoints = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Action&lt;T&gt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T param</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> handler <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _linkedInputPoints) { handler(param); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OUTPUT_POINT</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Action&gt; _linkedInputPoints = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Action&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> handler <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _linkedInputPoints) { handler(); } } } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">可变参考</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">uViLEd.Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">VARIABLE_LINK</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> =&gt; _variable.Value; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> =&gt; _variable.Value = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Variable&lt;T&gt; _variableProperty { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> =&gt; _variable; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _variable = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; VariableWasSet = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; InitializeEventHandlers(); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> VariableWasSet { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Variable&lt;T&gt; _variable; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Variable&lt;T&gt;.Set _automaticSetHandler; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Variable&lt;T&gt;.Changed _automaticChangedHandler; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddSetEventHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Variable&lt;T&gt;.Set handler</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (VariableWasSet) { _variable.OnSet += handler; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _automaticSetHandler = handler; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveSetEventHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Variable&lt;T&gt;.Set handler</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (VariableWasSet) { _variable.OnSet -= handler; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddChangedEventHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Variable&lt;T&gt;.Changed handler</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (VariableWasSet) { _variable.OnChanged += handler; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _automaticChangedHandler = handler; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveChangedEventHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Variable&lt;T&gt;.Changed handler</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (VariableWasSet) { _variable.OnChanged -= handler; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeEventHandlers</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_automaticSetHandler != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _variable.OnSet += _automaticSetHandler; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_automaticChangedHandler != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _variable.OnChanged += _automaticChangedHandler; } } } }</code> </pre><br></div></div><br>  <b>注意</b> ：这里有一点需要说明，用于设置事件和更改变量值的自动处理程序仅在<b>Constructor</b>方法中设置后才使用，因为那时尚未设置对变量的引用。 <br><br><h3> 使用逻辑 </h3><br><h4> 贮藏 </h4><br> 在关于可视逻辑编辑器的第一篇文章中，提到了逻辑是一组变量，组件以及它们之间的关系： <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">uViLEd.Core</span></span> { [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogicStorage</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Id = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SceneName = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ComponentsStorage Components = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ComponentsStorage(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> LinksStorage Links = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinksStorage(); } }</code> </pre><br> 该类显然是可序列化的，但是<b>Unity的</b> <b>JsonUtility</b>不用于序列化。 而是使用二进制选项，其结果保存为带有<b>字节</b>扩展名的文件。 为什么要这样做？ 通常，主要原因是安全性，也就是说，可以选择从外部源加载逻辑，从而可以加密数据，并且通常，反序列化字节数组比打开<b>json</b>困难。 <br><br> 让我们仔细<b>看一下</b> <b>ComponentsStrorage</b>和<b>LinksStorage类</b> 。 系统使用<b>GUID</b>进行全局数据识别。 下面是类代码，它是数据容器的基础。 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">uViLEd.Core</span></span> { [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Identifier</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Identifier</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(Id)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; Id = System.Guid.NewGuid().ToString(); } } }</code> </pre><br> 现在考虑<b>ComponentsStorage</b>类的代码，顾名思义，该代码存储有关逻辑组件的数据： <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">uViLEd.Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogicStorage</span></span> { [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ComponentsStorage</span></span> { [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ComponentData</span></span> : <span class="hljs-title"><span class="hljs-title">Identifier</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Type = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Assembly = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> JsonData = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsActive = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;ComponentData&gt; Items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ComponentData&gt;(); } }</code> </pre><br> 该类非常简单。 为每个组件存储以下信息： <br><br><ol><li> 在<b>标识符中</b>找到的唯一标识符（ <b>GUID</b>字符串） </li><li> 类型名称 </li><li> 零部件类型所在的装配体的名称 </li><li> 带有序列化数据的Json字符串（ <b>JsonUtility.ToJson的</b>结果） </li><li> 组件活动（状态）标志 </li></ol><br> 现在让我们看一下<b>LinksStorage</b>类。 此类存储有关组件之间的关系以及有关变量的引用的信息。 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">uViLEd.Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogicStorage</span></span> { [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LinksStorage</span></span> { [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LinkData</span></span> : <span class="hljs-title"><span class="hljs-title">Identifier</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsVariable; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsActive = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SourceComponent = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TargetComponent = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> OutputPoint = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> InputPoint = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> VariableName = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CallOrder = <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;LinkData&gt; Items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;LinkData&gt;(); } }</code> </pre><br> 原则上，此类也不复杂。 每个链接包含以下信息： <br><br><ol><li> 指示此链接是对变量的引用的标志 </li><li> 链接活动标志 </li><li> 具有输出点的组件的标识符（ <b>GUID</b>字符串） </li><li> 入口点组件的标识符（ <b>GUID</b>字符串） </li><li> 通信源组件的输出点名称 </li><li> 目标通信组件的输入点名称 </li><li> 用于设置变量引用的类字段名称 </li><li> 通讯通话单 </li></ol><br><h4> 从存储库运行 </h4><br> 在深入研究代码之前，我首先要详细介绍控制器如何启动逻辑的顺序： <br><br><ol><li> 初始化从控制器的Awake方法开始 </li><li> 场景逻辑列表从二进制文件（ <b>TextAsset</b> ）加载和反序列化逻辑数据 </li><li> 对于每种逻辑发生： <br><ul><li> 组件创建 </li><li> 按<b>CallOrder</b>排序链接 </li><li> 设置链接和变量引用 </li><li> 按<b>ExecuteOrder</b>对<b>Mono</b> Component <b>方法</b>排序 </li></ul><br></li></ol><br> 让我们更详细地考虑该链的各个方面。 <br><br><div class="spoiler">  <b class="spoiler_title">二进制序列化和反序列化</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">uViLEd</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Serialization</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Serialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fileName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> binaryFormatter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BinaryFormatter(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Directory.Exists(path)) { Directory.CreateDirectory(path); } <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileStream(Path.Combine(path, fileName), FileMode.OpenOrCreate)) { binaryFormatter.Serialize(fs, data); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Deserialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TextAsset textAsset</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> binaryFormatter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BinaryFormatter(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> memoryStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream(textAsset.bytes)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> binaryFormatter.Deserialize(memoryStream); } } } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">从文本资产（二进制文件）加载逻辑数据</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">uViLEd.Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogicStorage</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> LogicStorage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TextAsset textAsset</span></span></span><span class="hljs-function">)</span></span> =&gt; Serialization.Deserialize(textAsset) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LogicStorage; } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">逻辑启动</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunLogicInternal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LogicStorage logicStorage</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instances = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, LogicComponent&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> componentData <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> logicStorage.Components.Items) { CreateComponent(componentData, instances); } logicStorage.Links.Items.Sort(SortingLinks); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> linkData <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> logicStorage.Links.Items) { CreateLink(linkData, instances); } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> monoMethods <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _monoBehaviourMethods.Values) { monoMethods.Sort(SortingMonoMethods); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">组件创建</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateComponent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LogicStorage.ComponentsStorage.ComponentData componentData, IDictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, LogicComponent&gt; instances, IList&lt;IDisposable&gt; disposableInstance, IDictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, List&lt;MonoMethodData&gt;&gt; monoMethods</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!componentData.IsActive) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> componentType = AssemblyHelper.GetAssemblyType(componentData.Assembly, componentData.Type); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> componentInstance = ScriptableObject.CreateInstance(componentType) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LogicComponent; JsonUtility.FromJsonOverwrite(componentData.JsonData, componentInstance); componentInstance.name = componentData.InstanceName; componentType.GetFieldRecursive(_LOGIC_HOST_STR).SetValue(componentInstance, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> MonoBehaviour); componentInstance.Constructor(); instances.Add(componentData.Id, componentInstance); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(componentInstance <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> IDisposable) { disposableInstance.Add((IDisposable)componentInstance); } SearchMonoBehaviourMethod(componentInstance, monoMethods); }</code> </pre><br> 那么此函数会发生什么： <br><br><ol><li> 检查组件活动标志 </li><li> 从装配体中获取零部件的类型 </li><li> 组件实例是按类型创建的 </li><li>  <b>JSON的</b>组件参数反序列化 </li><li> 链接在<b>coroutineHost中</b>设置 </li><li>  <b>构造</b>方法称为 </li><li> 临时副本将保存到组件实例 </li><li> 如果组件实现了IDisposable接口，则指向它的链接存储在相应的列表中 </li><li> 在组件中搜索<b>Mono</b>方法 </li></ol><br></div></div><br><div class="spoiler">  <b class="spoiler_title">建立连结</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateLink</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LogicStorage.LinksStorage.LinkData linkData, Dictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, LogicComponent&gt; instances</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!linkData.IsActive) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sourceComponent = instances.ContainsKey(linkData.SourceComponent) ? instances[linkData.SourceComponent] : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sourceComponent == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetComponent = instances.ContainsKey(linkData.TargetComponent) ? instances[linkData.TargetComponent] : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (targetComponent == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (linkData.IsVariable) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> variableLinkFieldInfo = sourceComponent.GetType().GetField(linkData.variableName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (variableLinkFieldInfo != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> variableLinkFieldValue = variableLinkFieldInfo.GetValue(sourceComponent); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> variableLinkVariablePropertyInfo = variableLinkFieldInfo.FieldType.GetProperty(_VARIABLE_PROPERTY_STR, BindingFlags.NonPublic | BindingFlags.Instance); variableLinkVariablePropertyInfo.SetValue(variableLinkFieldValue, targetComponent, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> handlerValue; MethodInfo methodListAdd; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> linkedInputPointsFieldValue; Type outputPointType; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> outputPoint; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> outputPointParse = sourceComponent <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IOutputPointParse; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inputPointParse = targetComponent <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IInputPointParse; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outputPointParse != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> outputPoints = outputPointParse.GetOutputPoints(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outputPoints.ContainsKey(linkData.OutputPoint)) { outputPoint = outputPoints[linkData.OutputPoint]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outputPoint <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> FieldInfo) { outputPoint = sourceComponent.GetType().GetField(linkData.OutputPoint).GetValue(sourceComponent); } outputPointType = outputPoint.GetType(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> linkedInputPointsFieldInfo = outputPointType.GetField(_LINKED_INPUT_POINTS_STR, BindingFlags.NonPublic | BindingFlags.Instance); linkedInputPointsFieldValue = linkedInputPointsFieldInfo.GetValue(outputPoint); methodListAdd = linkedInputPointsFieldInfo.FieldType.GetMethod(_ADD_STR); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> outputPointFieldInfo = sourceComponent.GetType().GetField(linkData.OutputPoint); outputPoint = outputPointFieldInfo.GetValue(sourceComponent); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outputPoint != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { outputPointType = outputPoint.GetType(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> linkedInputPointsFieldInfo = outputPointFieldInfo.FieldType.GetField(_LINKED_INPUT_POINTS_STR, BindingFlags.NonPublic | BindingFlags.Instance); linkedInputPointsFieldValue = linkedInputPointsFieldInfo.GetValue(outputPoint); methodListAdd = linkedInputPointsFieldInfo.FieldType.GetMethod(_ADD_STR); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inputPointParse != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inputPoints = inputPointParse.GetInputPoints(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inputPoints.ContainsKey(linkData.InputPoint)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inputPoint = inputPoints[linkData.InputPoint]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inputPoint <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> FieldInfo) { inputPoint = targetComponent.GetType().GetField(linkData.InputPoint).GetValue(targetComponent); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inputPointType = inputPoint.GetType(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inputPointHandlerFieldInfo = inputPointType.GetField(_HANDLER_STR); handlerValue = inputPointHandlerFieldInfo.GetValue(inputPoint); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inputPointFieldInfo = targetComponent.GetType().GetField(linkData.InputPoint); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inputPointFieldValue = inputPointFieldInfo.GetValue(targetComponent); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inputPointFieldValue != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inputPointHandlerFieldInfo = inputPointFieldInfo.FieldType.GetField(_HANDLER_STR); handlerValue = inputPointHandlerFieldInfo.GetValue(inputPointFieldValue); } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> handlerParsedAction = GetParsedHandler(handlerValue, outputPoint); methodListAdd.Invoke(linkedInputPointsFieldValue, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] { handlerParsedAction }); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetParsedHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> handlerValue, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> outputPoint</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inputPointType = handlerValue.GetType(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> outputPointType = outputPoint.GetType(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inputPointType.IsGenericType) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> paramType = inputPointType.GetGenericArguments()[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (paramType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>) &amp;&amp; outputPointType.IsGenericType) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parsingActionMethod = outputPointType.GetMethod(_PARSING_ACTION_OBJECT_STR, BindingFlags.NonPublic | BindingFlags.Instance); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parsingActionMethod.Invoke(outputPoint, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] { handlerValue }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> handlerValue; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outputPointType.IsGenericType) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parsingActionMethod = outputPointType.GetMethod(_PARSING_ACTION_EMPTY_STR, BindingFlags.NonPublic | BindingFlags.Instance); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parsingActionMethod.Invoke(outputPoint, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] { handlerValue }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> handlerValue; } } }</code> </pre> <br> 创建连接是整个系统内在最困难的时刻之一，我们将考虑每个阶段： <br><br><ol><li> 检查通讯活动标志 </li><li> 在创建的组件的临时列表中搜索连接的源组件和目标组件 </li><li> 检查连接类型： <br><ul><li> 如果连接类型是对变量的引用，则使用反射设置必要的值 </li><li> 如果连接正常，则还可以使用反射来设置输出点和输入点方法的必要值 </li></ul><br></li><li> 对于正常通信，请首先检查组件是否继承<b>IInputPointParse</b>和<b>IOutputPointParse接口</b> 。 </li><li> 根据上一段的结果，通过反射获得源组件中的<b>LinkedInputPoints</b>字段和目标组件中的handler方法。 </li><li> 通过将绕过<b>MethodInfo.Invoke</b>的方法调用转换为简单的<code>Action&lt;T&gt;</code>调用，可以<b>获取</b>方法处理程序。 但是，通过反射获得这样的链接太复杂了，因此，在<code>OUTPUT_POINT&lt;T&gt;</code>类中<code>OUTPUT_POINT&lt;T&gt;</code>了允许这样做的特殊方法。 对于此类的非<b>通用</b>版本，无需执行此类操作。 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Action&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParsingActionEmpty</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action action</span></span></span><span class="hljs-function">)</span></span> { Action&lt;T&gt; parsedAction = (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) =&gt; action(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parsedAction; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Action&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParsingActionObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; action</span></span></span><span class="hljs-function">)</span></span> { Action&lt;T&gt; parsedAction = (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) =&gt; action(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parsedAction; } }</code> </pre> <br> 当输入点不接受任何参数时，使用第一种方法。 第二种方法分别为带有参数的输入点。 <br><br></li><li> 通过反射，将到<b>Action</b>处理程序的链接添加到<b>LinkedInputPoints</b>字段（如上所示，它是一个列表） </li></ol><br></div></div><br><div class="spoiler">  <b class="spoiler_title">使用Mono方法</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SearchMonoBehaviourMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LogicComponent component, IDictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, List&lt;MonoMethodData&gt;&gt; monoBehaviourMethods</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> type = component.GetType(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> methods = type.GetMethods(BindingFlags.Public | BindingFlags.Static | BindingFlags.NonPublic | BindingFlags.Instance); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> method <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> methods) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_monoMethods.Keys.Contains(method.Name)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> priorityAttributes = method.GetCustomAttributes(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ExecuteOrderAttribute), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> priority = (priorityAttributes.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) ? ((ExecuteOrderAttribute)priorityAttributes[<span class="hljs-number"><span class="hljs-number">0</span></span>]).Order : <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.MaxValue; monoBehaviourMethods[method.Name].Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MonoMethodData(method, component, priority, _monoMethods[method.Name])); } } }</code> </pre> <br> 每个方法都通过指向特殊类的链接存储在字典中，通过该类可以进行调用。 此类自动将方法转换为对<b>Action</b>的引用。 因此，与通常的<b>MethodInfo.Invoke</b>相比，对<b>Mono</b>方法的调用有了明显的加速。 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MonoMethodData</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Order { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Action _monoMethodWrapper; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Action&lt;<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt; _monoMethodParamWrapper; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MonoMethodData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodInfo method, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> target, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> order, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> withParam</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!withParam) { _monoMethodWrapper = (Action)Delegate.CreateDelegate(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Action), target, method.Name); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _monoMethodParamWrapper = (Action&lt;<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;)Delegate.CreateDelegate(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Action&lt;<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;), target, method.Name); } Order = order; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Call</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt;_monoMethodWrapper(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Call</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> param</span></span></span><span class="hljs-function">)</span></span> =&gt; _monoMethodParamWrapper(param); }</code> </pre> <br>  <b>注意</b> ：用<b>bool</b>参数重载<b>Call</b>方法用于<b>Mono</b>方法，例如<b>ApplicationPause</b>等。 <br></div></div><br><h4> 外部触发逻辑 </h4><br> 逻辑的外部启动是在应用程序运行期间启动的逻辑，此类逻辑未在场景中设置，并且没有链接。 可以从捆绑软件或资源中下载。 通常，从外部开始与从场景开始处并没有什么不同，除了使用<b>Mono</b>方法。 <br><br><div class="spoiler">  <b class="spoiler_title">外部（延迟）逻辑执行的方法代码</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunLogicExternal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LogicStorage logicStorage</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instances = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, LogicComponent&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> runMonoMethods = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;MonoMethodData&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> monoMethodName <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _monoMethods.Keys) { runMonoMethods.Add(monoMethodName, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;MonoMethodData&gt;()); } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> componentData <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> logicStorage.Components.Items) { CreateComponent(componentData, instances, _disposableInstances, runMonoMethods); } logicStorage.Links.Items.Sort(SortingLinks); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> linkData <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> logicStorage.Links.Items) { CreateLink(linkData, instances); } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> monoMethods <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> runMonoMethods.Values) { monoMethods.Sort(SortingMonoMethods); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (runMonoMethods.ContainsKey(_START_STR)) { CallMonoBehaviourMethod(_START_STR, runMonoMethods, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> monoMethodName <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> runMonoMethods.Keys) { _monoBehaviourMethods[monoMethodName].AddRange(runMonoMethods[monoMethodName]); } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> monoMethods <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _monoBehaviourMethods.Values) { monoMethods.Sort(SortingMonoMethods); } }</code> </pre> <br></div></div><br> 如您所见，对<b>Mono</b>方法的所有引用都保存在本地字典中，然后启动Start方法，然后将所有其他方法添加到通用字典中。 <br><br><h4> 作为实例运行逻辑 </h4><br> 在应用程序运行期间，可能有必要在一定时间内运行某种逻辑，或者直到它执行其任务为止。 不允许使用以前的逻辑触发选项来执行此操作，因为在场景的整个生命周期中都会触发逻辑。 <br><br> 为了将逻辑作为实例运行，将保存到组件等所有实例的链接，在工作完成后可以将其删除，从而清除内存。 <br><br> 逻辑实例数据仓库类代码： <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">InstanceLogicData</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IList&lt;LogicComponent&gt; ComponentInstances = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;LogicComponent&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;MonoMethodData&gt;&gt; MonoBehaviourMethods = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;MonoMethodData&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IList&lt;IDisposable&gt; DisposableInstances = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;IDisposable&gt;(); }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">逻辑启动本身类似于前面描述的外部启动。</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunLogicInstance</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LogicStorage logicStorage, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = Guid.NewGuid().ToString(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> logicInstanceData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InstanceLogicData(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instances = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, LogicComponent&gt;(); _logicInstances.Add(id, logicInstanceData); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> componentData <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> logicStorage.Components.Items) { CreateComponent(componentData, instances, logicInstanceData.DisposableInstances, logicInstanceData.MonoBehaviourMethods); } logicStorage.Links.Items.Sort(SortingLinks); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> linkData <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> logicStorage.Links.Items) { CreateLink(linkData, instances); } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> monoMethods <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> logicInstanceData.MonoBehaviourMethods.Values) { monoMethods.Sort(SortingMonoMethods); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; }</code> </pre> <br></div></div><br> 从代码中可以看出，在创建逻辑之后，有关逻辑的数据存储在专门类的实例中，并且在启动后，将返回逻辑实例的唯一标识符。 <br><br><div class="spoiler">  <b class="spoiler_title">需要此标识符才能调用停止和清除内存功能。</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StopLogicInstance</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> instanceId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_logicInstances.ContainsKey(instanceId)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> logicInstance = _logicInstances[instanceId]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> disposableInstance <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> logicInstance.DisposableInstances) { disposableInstance.Dispose(); } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> componentInstance <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> logicInstance.ComponentInstances) { Destroy(componentInstance); } logicInstance.ComponentInstances.Clear(); logicInstance.DisposableInstances.Clear(); logicInstance.MonoBehaviourMethods.Clear(); _logicInstances.Remove(instanceId); }</code> </pre> <br></div></div><br><h4> 关闭场景并清除内存 </h4><br> 通过<b>ScriptableObject.CreateInstance</b>在运行的场景中创建<b>ScriptableObject时</b> ，实例的行为与<b>MonoBehaviour</b>相同，即，从场景中卸载时，将为每个实例调用<b>OnDestroy</b>并将其从内存中删除。 但是，如前一篇文章所述，组件可以继承<b>IDisposable</b> ，因此我使用<b>OnDisable</b>方法对其进行了<b>清理</b> ： <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnDisable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> disposable <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _disposableInstances) { disposable.Dispose(); } _disposableInstances.Clear(); _monoBehaviourMethods.Clear(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> logicInstance <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _logicInstances.Values) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> disposableInstance <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> logicInstance.DisposableInstances) { disposableInstance.Dispose(); } logicInstance.DisposableInstances.Clear(); logicInstance.ComponentInstances.Clear(); logicInstance.MonoBehaviourMethods.Clear(); } _logicInstances.Clear(); _instance = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre> <br>  <b>注意</b> ：如您所见，如果在卸载场景时存在逻辑实例，则将在其中进行清理。 <br><br><h3>  Unity对象的问题和解决方案 </h3><br> 在有关可视化编辑器的文章的第一部分中，我提到了维护与场景对象的链接的问题，这与无法还原序列化数据有关。 这是由于以下事实：每次启动场景时，场景对象的唯一标识符都不同。 解决该问题的方法是唯一的选择-这是转移场景中链接的存储。 为此，在逻辑控制器中添加了专门的存储库和包装器类，逻辑组件可通过该类来接收对<b>Unity</b>对象的引用，包括资源，预制件和其他资产。 <br><br><div class="spoiler">  <b class="spoiler_title">存储代码</b> <div class="spoiler_text"><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ObjectLinkData</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Id =&gt; _id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> UnityEngine.Object Obj =&gt; _obj; [SerializeField] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _id = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; [SerializeField] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UnityEngine.Object _obj; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ObjectLinkData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, UnityEngine.Object obj</span></span></span><span class="hljs-function">)</span></span> { _id = id; _obj = obj; } } [SerializeField] [HideInInspector] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ObjectLinkData&gt; _objectLinks = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ObjectLinkData&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> UnityEngine.<span class="hljs-function"><span class="hljs-function">Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> linkData = _objectLinks.Find(link =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(link.Id, id, StringComparison.Ordinal) == <span class="hljs-number"><span class="hljs-number">0</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> linkData?.Obj; }</code> </pre><br> : <br><br><ol><li> <b>Id</b> –       </li><li> <b>Obj</b> –       </li></ol><br></div></div><br>    ,  . <br><br><div class="spoiler"> <b class="spoiler_title">  -   Unity</b> <div class="spoiler_text"><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">VLObject</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Id =&gt; _id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> UnityEngine.Object Obj { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_obj == <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; !_objNotFound) { _obj = Core.LogicController.Instance.GetObject(Id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_obj == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _objNotFound = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _obj; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UnityEngine.Object _obj; [SerializeField] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _objNotFound; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VLObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VLObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">UnityEngine.Object obj</span></span></span><span class="hljs-function">)</span></span> { _obj = obj; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Get&lt;T&gt;() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : UnityEngine.Object { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Obj <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> T; } }</code> </pre><br> <b></b> :  <b>_objNotFound</b> ,        ,     . <br></div></div><br><h2>  </h2><br> ,  ,       .       ,   ,           , ..       <b>Unity</b> .   <b>Update</b>  <b>MonoBehaviour</b>   <b>uViLEd</b>      - ,     ,      1000   .    —    ,          ,    (  <b>Android</b>  <b>iOS</b> )  .    70    150  (   )   : <br><br><ol><li> <b>Android</b> (  MediaTek 8-) <br> —    — ~750 <br> —      ~250 <br></li><li> <b>iOS</b> (iPhone 5s) <br> —    — ~100 <br> —      ~50 <br></li></ol><br><h2> 结论 </h2><br>    <b>uViLEd</b> -   ,        ,   ,  -   -  .            ,       .        ,    . <br><br> PS:    ,    .        ,     Unity 3d,    (   )   . <br><br> → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">    Unity3d.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第一部分</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN466187/">https://habr.com/ru/post/zh-CN466187/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN466169/index.html">JetBrains在职学生的特别优惠</a></li>
<li><a href="../zh-CN466171/index.html">选择JUG.EKB的五个理由</a></li>
<li><a href="../zh-CN466179/index.html">fform：React＆JSONSchema-最大的灵活性</a></li>
<li><a href="../zh-CN466181/index.html">C语言的Python（C API）</a></li>
<li><a href="../zh-CN466183/index.html">ClickHouse中的智能字符串处理算法</a></li>
<li><a href="../zh-CN466191/index.html">美国网络中立之战的主要内容是事件的时间顺序和当前的事务状态</a></li>
<li><a href="../zh-CN466193/index.html">从RSS提要自定义MailChimp自动提要</a></li>
<li><a href="../zh-CN466195/index.html">PVS-Studio 7.04</a></li>
<li><a href="../zh-CN466197/index.html">PVS-Studio 7.04</a></li>
<li><a href="../zh-CN466199/index.html">PostgreSQL中的锁：4.内存中的锁</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>