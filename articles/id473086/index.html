<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏻‍🎨 👨🏻‍🎤 🥂 Bagaimana malware menghindar dari kotak pasir dengan Visual Basic 👨🏾‍🍳 🔃 🤶🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Setiap hari di JSOC CERT kami menjumpai acara dari kotak pasir berbeda yang berfungsi sebagai bagian dari solusi AntiAPT pelanggan kami dan membiarkan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana malware menghindar dari kotak pasir dengan Visual Basic</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/solarsecurity/blog/473086/">  Setiap hari di JSOC CERT kami menjumpai acara dari kotak pasir berbeda yang berfungsi sebagai bagian dari solusi AntiAPT pelanggan kami dan membiarkan ribuan file dari web dan lalu lintas email melewatinya.  Perlu dicatat bahwa sistem Sandbox modern dalam pengembangannya berjalan lebih jauh dari sekadar mencegat panggilan sistem dalam Mode Kernel dan fungsi API dalam Mode Pengguna.  Semakin banyak, mereka menggunakan hypervisor mereka sendiri, sebuah sistem untuk meniru aktivitas pengguna, instrumentasi dinamis, hashing dan pengelompokan bagian kode, analisis cakupan kode, dll.  Berbagai macam teknologi menciptakan ilusi bahwa jika file tidak bekerja di kotak pasir dan tidak menunjukkan "wajah aslinya", maka ini mungkin APT atau teknologi inovatif untuk mendeteksi lingkungan virtual, yang belum disadari oleh komunitas IB.  Tapi ... <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sc/cl/os/scclosmhrxygm1sxytg94as3z_i.jpeg"></div><a name="habracut"></a><br>  Karena kita tidak tahu fitur internal dari pekerjaan kotak pasir komersial, dalam beberapa kasus kita melakukan pemeriksaan ulang - secara manual menganalisis sampel yang lulus tes.  Baru-baru ini, kami telah menemukan beberapa kali bahwa beberapa kotak pasir komersial (untuk alasan obyektif, kami tidak bisa mengatakan yang mana) tidak mendeteksi file berbahaya tertentu selama analisis dinamis, dan jika penganalisa statis juga diam, file itu dilewati sama sekali. <br><br>  Pemindaian kotak pasir berhasil mem-bypass keluarga malware terkenal seperti Pony, Loki dan Hawkeye.  Hanya satu hal yang menyatukan mereka - mereka dilindungi oleh paket yang ditulis dalam Visual Basic. <br><br>  Mengingat bahwa keluarga HPE ini telah lama bukan hal yang baru, vonis kotak pasir “positif” sangat menyedihkan.  Oleh karena itu, kami memutuskan untuk menjelaskan prinsip umum pengoperasian pengepak ini dan pengamatan yang kami lakukan selama beberapa waktu. <br>  Skema umum pekerjaan pengepak secara kondisional dibagi menjadi 4 tahap dan ditunjukkan dalam diagram di bawah ini. <br><br><img src="https://habrastorage.org/webt/fk/c9/of/fkc9of6pras7-cd55luw1l1mpai.jpeg"><br><br>  Titik masuk file jahat terlihat khas dari aplikasi Visual Basic: <br><br><img src="https://habrastorage.org/webt/vj/ia/he/vjiaheueiyapa2swzf8_cqrwzka.jpeg"><br><br>  Kami menemukan berbagai opsi untuk paket ini, dan kode Wrapper VB sering berubah, tetapi tugas yang dilakukan tetap sama: mentransfer kontrol ke kode Tahap 1. Dalam sampel sebelumnya, kontrol ditransfer menggunakan fungsi API kelas Enum * (misalnya, EnumWindows, EnumCalendarInfo, dll.). e) dimana alamat Tahap 1 dari kode ditunjukkan sebagai parameter.  Baru-baru ini, kami mengamati bahwa kontrol ditransfer secara langsung. <br><br><h2>  Tahap 1 </h2><br>  Manajemen menerima kode Tahap 1. Kode ini tidak dienkripsi, tetapi dikaburkan.  Metode kebingungan bervariasi dari sampel ke sampel, tetapi algoritma operasi umum tidak berubah: <br><br><ol><li>  Siklus dengan banyak (termasuk sampah) instruksi yang menghasilkan kunci yang diperlukan untuk mendekode kode Tahap 2.  Keunikan potongan kode ini adalah tidak ada fungsi Tidur, tetapi karena banyaknya iterasi, pelaksanaannya memakan waktu rata-rata 1-2 menit. </li><li>  Dekripsi (XOR reguler) dan transfer kontrol ke kode Tahap 2. </li></ol><br>  Tangkapan layar di bawah ini menunjukkan contoh metode kebingungan yang digunakan: <br><br><img src="https://habrastorage.org/webt/--/p-/xl/--p-xlue_skm9loofz_wj3tmeic.jpeg"><br><br><h2>  2 tahap </h2><br>  Tugas utama kode pada Tahap 2 adalah untuk memeriksa lingkungan dan menerapkan metode anti-debugging.  Beberapa bagian kode dienkripsi (didekripsi sebelum eksekusi, dan setelah itu, dienkripsi kembali dengan algoritma XOR yang sama) untuk membuatnya sulit dideteksi dengan tanda tangan.  Setelah dekripsi, fitur-fitur karakteristik terlihat, yang menurutnya kode Tahap 2 dapat dikenali dengan analisis manual. <br><br><img src="https://habrastorage.org/webt/eb/n8/oq/ebn8oqw9vqcysrl-c98pdfdrdjq.jpeg"><br><br>  Daftar cek cukup besar dan berbeda dalam versi berbeda dari pengemas, jadi kami akan memberikan beberapa metode yang ditemukan di semua versi, dengan tangkapan layar, dan pada akhirnya kami mencantumkan seluruh daftar di tabel. <br><br><h4>  1) GetTickCount + Tidur </h4><br>  Stempel waktu saat ini diambil, Tidur dipanggil selama 2 detik, setelah itu stempel waktu lain segera diambil. <br><br>  Setelah itu, perbedaan antara tanda diperiksa (apakah 2 detik benar-benar berlalu). <br><br><img src="https://habrastorage.org/webt/mp/ip/pj/mpippjhsogyg_uvk0eikkuehm_w.jpeg"><br><br><h4>  2) SetErrorMode </h4><br>  Memeriksa operasi yang benar dari panggilan API SetErrorMode.  Fungsi dipanggil dua kali berturut-turut dengan parameter 0x800 dan 0x0, setelah itu hasil panggilan kedua diperiksa: itu harus sama dengan 0x800. <br><br><img src="https://habrastorage.org/webt/gp/kr/vx/gpkrvxff7l4irukw4oqifs6ai4a.jpeg"><br><br><h4>  3) SetLastError </h4><br>  Pertama, SetLastError disebut dengan parameter 0x5, setelah itu diperiksa bahwa nilai kode kesalahan terakhir dalam TEB diatur dengan benar (yaitu, itu adalah 0x5). <br><br><img src="https://habrastorage.org/webt/3k/am/vh/3kamvhsb_z6nw8tlchtlcuhxa0q.jpeg"><br><br><h4>  4) Memeriksa pergerakan kursor </h4><br>  Kode memasuki loop tanpa akhir menunggu mouse bergerak. <br><br><img src="https://habrastorage.org/webt/aq/1w/wo/aq1wwopzjhbmihs8mxnmmkcxoma.jpeg"><br><br><h4>  5) DbgBreakPoint dan DbgUiRemoteBreakin </h4><br>  Fungsi-fungsi ini dimodifikasi untuk mencegah debugger terhubung ke proses. <br><br><img src="https://habrastorage.org/webt/aw/we/qd/awweqdnasj4ztgfjk1bdv-lcfw4.jpeg"><br><table border="1"><tbody><tr><td><p>  Teknik <br></p><br></td><td><p>  Komentar <br></p><br></td></tr><tr><td><p>  GetTickCount + Sleep <br></p><br></td><td><p>  Memeriksa Cap waktu <br></p><br></td></tr><tr><td><p>  SetErrorMode <br></p><br></td><td><p>  Memeriksa fungsi yang benar <br></p><br></td></tr><tr><td><p>  SetLastError <br></p><br></td><td><p>  Memeriksa fungsi berfungsi dengan benar <br></p><br></td></tr><tr><td><p>  GetCursorPos <br></p><br></td><td><p>  Periksa pergerakan kursor <br></p><br></td></tr><tr><td><p>  Dbgbreakpoint <br></p><br></td><td><p>  Modifikasi fungsi untuk mencegah lampiran debugger <br></p><br></td></tr><tr><td><p>  DbgUiRemoteBreakin <br></p><br></td><td><p>  Modifikasi fungsi untuk mencegah lampiran debugger <br></p><br></td></tr><tr><td><p>  Penghapusan kait <br></p><br></td><td><p>  5 byte pertama dari fungsi dipulihkan di ntdll.dll jika ada kait <br></p><br></td></tr><tr><td><p>  NtSetInformationThread <br></p><br></td><td><p>  Parameter 0x11 (ThreadHideFromDebugger) <br></p><br></td></tr><tr><td><p>  GetThreadContext + periksa DR <br></p><br></td><td><p>  Register debugger DR0-DR3, DR6, DR7 diperiksa. <br></p><br></td></tr><tr><td><p>  Periksa breakpoints <br></p><br></td><td><p>  Instruksi INT3 (0xCC), int 3 (0xCD 0x03) dan ud2 (0x0F 0x0B) di awal beberapa fungsi diperiksa <br></p><br></td></tr><tr><td><p>  cpuid (EAX = 0x0) <br></p><br></td><td><p>  Register EAX, ECX, EDX diperiksa <br></p><br></td></tr><tr><td><p>  cpuid (EAX = 0x40000000) <br></p><br></td><td><p>  Register EAX, ECX, EDX diperiksa <br></p><br></td></tr><tr><td><p>  cpuid (EAX = 0x1) <br></p><br></td><td><p>  ECX 31 bit dicentang <br></p><br></td></tr><tr><td><p>  PEB (BeingDebugged) <br></p><br></td><td><p>  Nilai cek 0x1 <br></p><br></td></tr><tr><td><p>  PEB (NtGlobalFlag) <br></p><br></td><td><p>  Nilai yang diperiksa 0x70 <br></p><br></td></tr><tr><td><p>  NtQueryInformationProcess <br></p><br></td><td><p>  Dipanggil dengan flag ProcessDebugPort (0x7), ProcessDebugFlags (0x1F), ProcessDebugObjectHandle (0x1E) <br></p><br></td></tr><tr><td><p>  Periksa nama proses <br></p><br></td><td><p>  String "sample", "sandbox", "virus", "malware", "self." Diperiksa <br></p><br></td></tr></tbody></table><br>  Jika semua teknik tahap 2 selesai, baris perintah diperiksa untuk kesesuaian dengan format khusus.  Jika pemeriksaan gagal, maka tindakan berikut dilakukan: <br><br>  1) Fungsi CreateProcess dipanggil dengan flag CREATE_SUSPENDED untuk memulai kembali proses saat ini.  Dalam hal ini, baris perintah memiliki format yang diperlukan. <br>  2) Menggunakan fungsi GetContextThread dan SetContextThread, titik masuk diubah ke yang baru, yang terletak di kode Tahap 1. <br>  3) Ulangi langkah 1 dan 2 (termasuk siklus panjang dan semua pemeriksaan).  Kali ini, pemeriksaan baris perintah berhasil dan proses berlanjut ke langkah berikutnya. <br><br><h2>  3 tahap </h2><br>  Pada tahap ini, tubuh virus utama didekripsi dan teknik Proses Pengosongan dilakukan pada proses saat ini, setelah itu kontrol ditransfer ke titik masuknya virus utama. <br><br><h2>  Pelajaran yang dipetik </h2><br>  Kami tidak dapat mengatakan dengan tepat apa yang menyebabkan kotak pasir ini atau itu dalam kasus ini, tetapi saya ingin percaya bahwa kemungkinan menggunakan teknik yang dijelaskan dalam artikel oleh malware telah disediakan oleh vendor untuk waktu yang lama, dan masalahnya hanya terletak pada penundaan waktu yang lama pada tahap pertama pekerjaan pengepak paket. . <br><br>  Terlepas dari kenyataan bahwa kotak pasir modern sebagian besar diposisikan sebagai bagian dari sistem perlindungan terhadap serangan APT, pengamatan kami menunjukkan bahwa keluarga jahat yang dikenal masyarakat pun menembus infrastruktur dengan keteguhan yang patut ditiru.  Karena tidak ada jaminan bahwa sampel yang melewati kotak pasir tidak akan memiliki beberapa teknik antivirus dalam arsenalnya, Anda tidak dapat mengandalkan banyak solusi perlindungan ini saja.  Dalam kasus seperti itu, proses pemantauan yang dibangun dengan benar, termasuk peristiwa keamanan informasi dari host akhir, dapat memastikan respon tepat waktu dan meminimalkan potensi kerusakan. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id473086/">https://habr.com/ru/post/id473086/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id473072/index.html">Bagaimana Gazpromneft menciptakan jalur digital untuk klien korporat</a></li>
<li><a href="../id473074/index.html">Apa itu APS dan mengapa itu tidak "membuat rencana produksi seperti yang kita inginkan ..."</a></li>
<li><a href="../id473078/index.html">Mudah mengelola konfigurasi layanan-mikro dengan microconfig.io</a></li>
<li><a href="../id473082/index.html">Bagaimana kami menulis layanan microser dan mengapa kami tidak melakukannya dengan cepat</a></li>
<li><a href="../id473084/index.html">"Ivan" adalah profesi bot obrolan. Atau eksperimen kreatif dengan asisten virtual</a></li>
<li><a href="../id473090/index.html">Ulasan PocketBook 632 dan 632 Aqua - pembaca 6-inci andalan dengan E Ink</a></li>
<li><a href="../id473092/index.html">AMA dengan Habr, # 13: berita penting bagi pengguna dan perusahaan</a></li>
<li><a href="../id473094/index.html">Kisah pengembang yang luar biasa, bagian 5: Rahasia Semesta</a></li>
<li><a href="../id473096/index.html">Struktur data lanjutan. Bagian Satu: Grafik Acyclic Directional</a></li>
<li><a href="../id473098/index.html">Mengkompilasi FFmpeg ke WebAssembly (= ffmpeg.js): Bagian 1 - Memasak</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>