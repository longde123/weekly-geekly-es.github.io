<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçº üç™ üéã Mikrotik. IPSEC vpn untuk NAT sebagai klien üìõ ü§¥üèæ ‚öìÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hari baik untuk semua! 

 Kebetulan di perusahaan kami selama dua tahun terakhir, kami perlahan-lahan pindah ke microtics. Node utama dibangun pada CC...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mikrotik. IPSEC vpn untuk NAT sebagai klien</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448052/"> Hari baik untuk semua! <br><br>  Kebetulan di perusahaan kami selama dua tahun terakhir, kami perlahan-lahan pindah ke microtics.  Node utama dibangun pada CCR1072, dan titik koneksi lokal untuk komputer pada perangkat lebih sederhana.  Tentu saja, ada penyatuan jaringan melalui terowongan IPSEC, dalam hal ini, konfigurasi cukup sederhana dan tidak menyebabkan kesulitan, karena ada banyak bahan di jaringan.  Tetapi ada kesulitan tertentu dengan koneksi seluler klien, wiki produsen memberi tahu Anda cara menggunakan klien VPN lunak Shrew (semuanya tampak jelas dengan pengaturan ini) dan klien khusus ini menggunakan 99% pengguna akses jarak jauh, dan 1% adalah saya, saya hanya menjadi malas setiap cukup masukkan nama pengguna dan kata sandi ke klien dan saya ingin pengaturan malas di sofa dan koneksi yang nyaman ke jaringan kerja.  Instruksi untuk mengkonfigurasi Mikrotik untuk situasi ketika tidak bahkan di belakang alamat abu-abu, tetapi benar-benar di belakang yang hitam dan mungkin bahkan beberapa NAT di jaringan, saya tidak menemukan.  Karena saya harus berimprovisasi, dan karena itu saya mengusulkan untuk melihat hasilnya. <br><br>  Ada: <br><br><ol><li>  CCR1072 sebagai perangkat utama.  versi 6.44.1 </li><li>  CAP ac sebagai titik koneksi rumah.  versi 6.44.1 </li></ol><br>  Fitur utama pengaturan adalah bahwa PC dan Mikrotik harus berada di jaringan yang sama dengan pengalamatan yang sama, yang dikeluarkan oleh 1072 utama. <br><a name="habracut"></a><br>  Buka pengaturan: <br><br>  1. Tentu saja, aktifkan Fasttrack, tetapi karena fasttrack tidak kompatibel dengan VPN, Anda harus memotong lalu lintasnya. <br><br><pre><code class="plaintext hljs">/ip firewall mangle add action=mark-connection chain=forward comment="ipsec in" ipsec-policy=\ in,ipsec new-connection-mark=ipsec passthrough=yes add action=mark-connection chain=forward comment="ipsec out" ipsec-policy=\ out,ipsec new-connection-mark=ipsec passthrough=yes /ip firewall filter add action=fasttrack-connection chain=forward connection-mark=!ipsec</code> </pre> <br>  2. Tambahkan penerusan jaringan dari / ke rumah dan kantor <br><br><pre> <code class="plaintext hljs">/ip firewall raw add action=accept chain=prerouting dst-address=192.168.33.0/24 src-address=\ 10.7.76.0/24 add action=accept chain=prerouting dst-address=192.168.33.0/24 src-address=\ 10.7.98.0/24 add action=accept chain=prerouting dst-address=10.7.76.0/24 src-address=\ 192.168.33.0/24 add action=accept chain=prerouting dst-address=10.7.77.0/24 src-address=\ 192.168.33.0/24 add action=accept chain=prerouting dst-address=10.7.98.0/24 src-address=\ 192.168.33.0/24 add action=accept chain=prerouting dst-address=192.168.33.0/24 src-address=\ 10.7.77.0/24</code> </pre><br>  3. Buat deskripsi koneksi pengguna <br><br><pre> <code class="plaintext hljs">/ip ipsec identity add auth-method=pre-shared-key-xauth notrack-chain=prerouting peer=CO secret=\   xauth-login=username xauth-password=password</code> </pre><br>  4. Buat Proposal IPSEC <br><br><pre> <code class="plaintext hljs">/ip ipsec proposal add enc-algorithms=3des lifetime=5m name="prop1" pfs-group=none</code> </pre><br>  5. Buat Kebijakan IPSEC <br><br><pre> <code class="plaintext hljs">/ip ipsec policy add dst-address=10.7.76.0/24 level=unique proposal="prop1" \ sa-dst-address=&lt;white IP 1072&gt; sa-src-address=0.0.0.0 src-address=\ 192.168.33.0/24 tunnel=yes add dst-address=10.7.77.0/24 level=unique proposal="prop1" \ sa-dst-address=&lt;white IP 1072&gt; sa-src-address=0.0.0.0 src-address=\ 192.168.33.0/24 tunnel=yes</code> </pre><br>  6. Buat profil IPSEC <br><br><pre> <code class="plaintext hljs">/ip ipsec profile set [ find default=yes ] dpd-interval=disable-dpd enc-algorithm=\ aes-192,aes-128,3des nat-traversal=no add dh-group=modp1024 enc-algorithm=aes-192,aes-128,3des name=profile_1 add name=profile_88 add dh-group=modp1024 lifetime=4h name=profile246</code> </pre><br>  7. Buat rekan IPSEC <br><br><pre> <code class="plaintext hljs">/ip ipsec peer add address=&lt;white IP 1072&gt;/32 local-address=&lt;  &gt; name=CO profile=\ profile_88</code> </pre><br>  Dan sekarang sedikit sihir sederhana.  Karena saya tidak benar-benar ingin mengubah pengaturan pada semua perangkat di jaringan rumah, saya harus menutup DHCP pada jaringan yang sama, tetapi masuk akal bahwa Mikrotik tidak mengizinkan menggantung lebih dari satu kumpulan alamat pada satu jembatan, jadi saya menemukan solusi, yaitu Saya hanya membuat DHCP Lease untuk laptop dengan parameter manual, dan karena netmask, gateway &amp; dns juga memiliki nomor opsi di DHCP, mereka juga ditentukan secara manual. <br><br>  1. Opsi DHCP <br><br><pre> <code class="plaintext hljs">/ip dhcp-server option add code=3 name=option3-gateway value="'192.168.33.1'" add code=1 name=option1-netmask value="'255.255.255.0'" add code=6 name=option6-dns value="'8.8.8.8'"</code> </pre><br>  2. Sewa DHCP <br><br><pre> <code class="plaintext hljs">/ip dhcp-server lease add address=192.168.33.4 dhcp-option=\ option1-netmask,option3-gateway,option6-dns mac-address=&lt;MAC  &gt;</code> </pre><br>  Pada saat yang sama, pengaturan 1072 hampir dasar, hanya ketika mengeluarkan alamat IP ke klien, pengaturan menunjukkan bahwa itu harus diberikan alamat IP yang dimasukkan secara manual, dan bukan dari kumpulan.  Untuk klien biasa yang menggunakan komputer pribadi, subnetnya sama seperti pada konfigurasi dengan Wiki 192.168.55.0/24. <br><br>  Dan saya akan menambahkan sedikit, pada server koneksi utama 1072, Anda juga perlu menambahkan aturan untuk penerusan jaringan simetris ke IP-Firewall-RAW.  Saat menambahkan penerusan jaringan baru, perlu menambahkan aturan ke IPSEC-Policy pada klien, server, serta pada server IP-Firewall-RAW dan daftar stek NAT. <br><br>  Pengaturan ini memungkinkan Anda untuk tidak terhubung ke PC melalui perangkat lunak pihak ketiga, dan terowongan itu sendiri naik ke router sesuai kebutuhan.  Beban ac CAP klien hampir minimal, 8-11% pada kecepatan 9-10MB / s di terowongan. <br><br>  Semua pengaturan dilakukan melalui Winbox, meskipun dengan keberhasilan yang sama dapat dilakukan melalui konsol. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id448052/">https://habr.com/ru/post/id448052/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id448040/index.html">Intisari materi menarik untuk pengembang ponsel # 294 (pada 8-14 April)</a></li>
<li><a href="../id448044/index.html">Beberapa aspek pemantauan MS SQL Server. Rekomendasi untuk mengatur tanda jejak</a></li>
<li><a href="../id448046/index.html">Radio Day: paten Marconi dan Popov</a></li>
<li><a href="../id448048/index.html">Memahami Angular Ivy: DOM tambahan dan DOM Virtual</a></li>
<li><a href="../id448050/index.html">Amatir holografi - bahan perak halida</a></li>
<li><a href="../id448054/index.html">SciPy, optimisasi dengan kondisi</a></li>
<li><a href="../id448056/index.html">Apa itu kontrak pintar?</a></li>
<li><a href="../id448058/index.html">Mengembangkan hexapod dari awal (bagian 5) - elektronik</a></li>
<li><a href="../id448060/index.html">Menulis Klien NTP Sederhana</a></li>
<li><a href="../id448068/index.html">Ilmuwan Amerika telah mengajarkan robot untuk menggunakan alat bantu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>