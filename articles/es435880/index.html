<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíè üîÜ üßëüèΩ‚Äçü§ù‚ÄçüßëüèΩ Cambiar el esquema de tablas PostgreSQL sin bloqueos largos. Conferencia de Yandex ‚§¥Ô∏è üëÅÔ∏è üõéÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si al mismo tiempo se realizan muchas operaciones para cambiar el esquema de la base de datos, el servicio no puede funcionar correctamente en la grab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cambiar el esquema de tablas PostgreSQL sin bloqueos largos. Conferencia de Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/435880/">  Si al mismo tiempo se realizan muchas operaciones para cambiar el esquema de la base de datos, el servicio no puede funcionar correctamente en la grabaci√≥n.  El desarrollador Vladimir Kolyasinsky explic√≥ qu√© operaciones en PostgreSQL requieren bloqueos a largo plazo y c√≥mo el equipo Yandex.Connect proporciona casi el 100% de acceso de escritura al servicio durante tales operaciones.  Adem√°s, aprender√° acerca de la biblioteca para Django, que est√° dise√±ada para automatizar parte de los procesos descritos. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/P3ctIoICkOc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><blockquote>  Tenemos cargas pesadas, miles de RPS y el tiempo de inactividad en unos minutos, sin mencionar m√°s tiempo, es inaceptable.  Es necesario que las migraciones pasen desapercibidas para el usuario.  Y con tales cargas no ser√° posible levantarse a las cuatro de la ma√±ana, rodar algo cuando no hay carga y volver a la cama, porque la carga va las 24 horas. </blockquote><br><a name="habracut"></a>  - Buenas tardes a todos!  Mi nombre es Vladimir, llevo cinco a√±os trabajando en Yandex.  Los √∫ltimos dos a√±os he estado desarrollando servicios internos y servicios para organizaciones. <br><br>  Un poco sobre cu√°les son estos servicios para las organizaciones.  Hemos estado utilizando una gran cantidad de servicios internos durante mucho tiempo: un wiki para almacenar e intercambiar datos, un mensajero para una comunicaci√≥n r√°pida con colegas, un rastreador para organizar el proceso de trabajo, formularios para realizar encuestas por dentro y por fuera, as√≠ como muchos otros servicios. <br><br>  Hace alg√∫n tiempo, decidimos que nuestros servicios son geniales y que pueden ser √∫tiles no solo dentro de Yandex, sino tambi√©n a personas externas.  Comenzamos a llevarlos a una plataforma unificada Yandex.Connect, agregando servicios externos existentes all√≠, como Correo para un dominio. <br><br><img src="https://habrastorage.org/webt/k-/sd/cz/k-sdczg1lnedmrhjfyujg6dkiyu.jpeg"><br><br>  Actualmente estoy desarrollando el Dise√±ador de formularios y Wiki.  La pila utilizada es principalmente servicios escritos en Python de la segunda y tercera versi√≥n;  Django 1.9-1.11.  Como base de datos, la mayor parte es PostgreSQL.  Tambi√©n es Apio con MongoDB y SQS como intermediarios.  Todo esto funciona en Docker. <br><br>  Pasemos al problema que enfrentamos.  Los servicios son populares, son utilizados por cientos de miles de personas todos los d√≠as, los datos se acumulan, las tablas se vuelven cada vez m√°s y, con el tiempo, muchas operaciones de cambio de esquemas de bases de datos, que los usuarios realizaron desapercibidas ayer, comienzan a impedir el funcionamiento normal de los servicios. <br><br>  Hoy hablaremos sobre c√≥mo hacemos frente a tales situaciones y c√≥mo logramos una alta disponibilidad de servicios de lectura y escritura. <br><br>  Primero, consideremos qu√© operaciones con PostgreSQL requieren bloqueos largos en la tabla.  Por bloqueo, me refiero a cualquier tipo de bloqueo que impide el funcionamiento normal de la tabla, ya sea acceso exclusivo, que impide la escritura y la lectura, o niveles de bloqueo m√°s d√©biles que impiden solo la escritura. <br><br>  A continuaci√≥n, veremos c√≥mo evitar bloqueos durante tales operaciones.  Luego hablaremos sobre qu√© operaciones con PostgreSQL son inicialmente r√°pidas y no requieren bloqueos largos.  Y al final, hablemos de nuestra biblioteca zero_downtime_migrations, que usamos para automatizar algunas de las t√©cnicas descritas anteriormente para evitar bloqueos largos. <br><br>  Operaciones que requieren un bloqueo largo: <br><br><img src="https://habrastorage.org/webt/zp/wv/xa/zpwvxagaus_ajxsaqixpwe-w7sw.jpeg"><br><br>  Creando un √≠ndice.  De forma predeterminada, no bloquea las operaciones de lectura en la tabla, pero todas las operaciones de escritura se bloquear√°n durante todo el tiempo que se cree el √≠ndice; en consecuencia, el servicio ser√° de solo lectura. <br><br>  Adem√°s, tales operaciones incluyen agregar una nueva columna con un valor predeterminado, ya que debajo del cap√≥ PostgreSQL sobrescribir√° toda la tabla, y por este tiempo estar√° bloqueado tanto para leer como para escribir.  Adem√°s, se sobrescribir√°n todos sus √≠ndices. <br><br>  Acerca de cambiar el tipo de columna: suceder√° algo similar, la placa tambi√©n se sobrescribir√° nuevamente.  Cabe se√±alar que esto no solo lleva mucho tiempo en tablas grandes, sino que tambi√©n por un corto tiempo requiere hasta el doble de la cantidad de memoria libre ocupada por la tabla. <br><br>  Adem√°s, la operaci√≥n VACUUM FULL requiere el mismo nivel de bloqueo que las operaciones anteriores; esto es acceso exclusivo.  VACUUM FULL tambi√©n bloquear√° todas las operaciones de lectura y escritura en la tabla. <br><br>  Las dos √∫ltimas operaciones son agregar propiedades √∫nicas a la columna y, en general, agregar CONSTRAINT.  Tambi√©n requieren bloqueo durante la verificaci√≥n de datos, aunque tardan mucho menos tiempo que los considerados anteriormente, ya que no sobrescriben las tablas debajo del cap√≥. <br><br><img src="https://habrastorage.org/webt/hl/7j/ui/hl7juizqgpqqzpnhr_byptzs_xw.jpeg"><br><br><img src="https://habrastorage.org/webt/ji/w4/lt/jiw4lt2-5fcmeyd9qfururhscs4.jpeg"><br><br>  Creando un √≠ndice.  Aqu√≠ es bastante simple, se puede crear usando la palabra clave CONCURRENTEMENTE.  Cual es la diferencia  Esta operaci√≥n llevar√° m√°s tiempo, ya que no se realizar√°n una, sino varias pasadas a trav√©s de la tabla, y tambi√©n esperar√° la finalizaci√≥n de todas las operaciones actuales que potencialmente pueden cambiar el √≠ndice.  Y tambi√©n puede fallar, por ejemplo, si se viola un √≠ndice √∫nico al crear un √≠ndice √∫nico.  Luego, el √≠ndice se marcar√° como no v√°lido y deber√° ser eliminado y recreado.  No se recomienda el comando REINDEX, ya que funciona igual que el CREATE INDEX normal, es decir, bloquear√° la tabla para escribir. <br><br>  Con respecto a la eliminaci√≥n del √≠ndice, a partir de la versi√≥n 9.3, tambi√©n puede eliminar el √≠ndice CONCURRENTEMENTE para evitar el bloqueo durante su eliminaci√≥n, aunque en general es una operaci√≥n tan r√°pida. <br><br><img src="https://habrastorage.org/webt/vy/yi/w8/vyyiw8m8oz-dn5gmy7-v9q8m32i.jpeg"><br><br>  Veamos c√≥mo agregar una nueva columna con un valor predeterminado.  Aqu√≠ hay una operaci√≥n est√°ndar que se realiza cuando queremos ejecutar dicho comando, incluso Django realiza dicha operaci√≥n. <br><br>  ¬øC√≥mo puedo reescribirlo para evitar sobrescribir la tabla?  Primero, en una transacci√≥n, agregue una nueva columna sin un valor predeterminado y agregue un valor predeterminado en una solicitud separada.  ¬øCu√°l es la diferencia aqu√≠?  Cuando agregamos un valor predeterminado a una columna existente, esto no cambia los datos existentes en la tabla.  Solo los metadatos cambian.  Es decir, para todas las l√≠neas nuevas, este valor predeterminado ya estar√° garantizado.  Nos queda por actualizar todas las filas existentes que estaban en la tabla en el momento en que se ejecut√≥ este comando.  Lo que haremos en lotes de varios miles de copias para no bloquear durante mucho tiempo una gran cantidad de datos. <br><br>  Despu√©s de actualizar todos los datos, solo queda ejecutar SET NOT NULL si creamos una columna NOT NULL.  Si no creamos, entonces no.  De esta forma, puede evitar sobrescribir la tabla al hacer este tipo de cambio. <br><br>  Dicha secuencia de comandos lleva m√°s tiempo que la ejecuci√≥n de un comando regular, ya que depende del tama√±o de la tabla y del n√∫mero de √≠ndices que contiene, y el comando habitual simplemente bloquea todas las operaciones y sobrescribe la tabla independientemente de la carga, ya que no hay carga en este momento.  Pero esto no importa tanto, porque durante la operaci√≥n la tabla est√° disponible para leer y escribir.  Lleva mucho tiempo, solo necesitas seguir esto y eso es todo. <br><br><img src="https://habrastorage.org/webt/e-/yp/gj/e-ypgjv5j7u5skjfmixtw_ie9oq.jpeg"><br><br>  Acerca de cambiar el tipo de columna.  El enfoque es similar a agregar una columna con un valor predeterminado.  Primero agregamos una columna separada del tipo que necesitamos, luego agregamos disparadores para cambiar los datos en la columna original para escribir en ambas columnas a la vez, a una nueva con el tipo de datos que necesitamos.  Para todas las entradas nuevas, ir√°n inmediatamente a ambas columnas.  Necesitamos actualizar todos los existentes.  Lo que hacemos en porciones, como en la diapositiva anterior, fue similar. <br><br>  Despu√©s de eso, permanece en una transacci√≥n para eliminar el activador, eliminar la columna anterior y cambiar el nombre de la columna anterior a una nueva.  Por lo tanto, logramos el mismo resultado: cambiamos el tipo de columna, mientras que el bloqueo de la tabla no fue largo. <br><br><img src="https://habrastorage.org/webt/3n/n3/ge/3nn3geu-vzcexvckvzsoomxx1ns.jpeg"><br><br>  Acerca de agregar una columna √∫nica.  Se toma una cerradura en el momento de la creaci√≥n.  Se puede evitar si sabe que la unicidad en PostgreSQL est√° garantizada mediante la creaci√≥n de un √≠ndice √∫nico.  Nosotros mismos podemos construir el √≠ndice √∫nico requerido usando CONCURRENTEMENTE.  Y despu√©s de construir este √≠ndice, cree CONSTRAINT usando este √≠ndice.  Despu√©s de esto, la definici√≥n del √≠ndice inicial de la tabla desaparecer√°, y el resultado que la definici√≥n de la tabla nos mostrar√° no ser√° diferente despu√©s de realizar estas dos operaciones. <br><br><img src="https://habrastorage.org/webt/o4/uz/lt/o4uzltwdxqnag3c0uwvvo9hw7uw.jpeg"><br><br>  Y en general, al agregar CONSTRAINT.  Puede usar esta t√©cnica para evitar el bloqueo mientras verifica los datos.  Primero agregamos CONSTRAINT con la palabra clave NOT VALID.  Esto significa que no se garantiza que esta CONSTRAINT se ejecute para todas las filas de la tabla.  Pero al mismo tiempo, para todas las l√≠neas nuevas, esta CONSTRAINT ya se aplicar√°, y se lanzar√°n las excepciones correspondientes si no se ejecuta. <br><br>  Solo podemos validar todos los valores existentes, lo que se puede hacer con un comando VALIDATE CONSTRAINT separado, y al mismo tiempo este comando ya no interfiere con la lectura o la escritura en la tabla.  Una mesa para este tiempo estar√° disponible. <br><br>  Operaciones que inicialmente funcionan r√°pidamente en PostgreSQL y no requieren bloqueos largos: <br><br><img src="https://habrastorage.org/webt/l1/z1/tq/l1z1tq5nwf1l9jhoushtujix-t8.jpeg"><br><br>  Una de estas operaciones es agregar una columna sin valores predeterminados y sin restricciones.  Como no se realizan cambios en la tabla en s√≠, solo cambian sus metadatos.  Y todos los valores NULL que vemos como resultado de SELECT se mezclan simplemente en la salida. <br><br>  Adem√°s, agregar valores predeterminados a una etiqueta existente es una operaci√≥n r√°pida porque solo cambian los metadatos.  La tabla y el bloqueo se toman literalmente durante los pocos milisegundos necesarios para ingresar esta informaci√≥n. <br><br>  Adem√°s, la operaci√≥n r√°pida de establecer SET NOT NULL, aqu√≠ lleva un poco m√°s de tiempo que lo descrito anteriormente, unos pocos segundos por tabla de 30 millones de registros.  Este tiempo tambi√©n se puede evitar si es importante. <br><br>  Cambiar el nombre de una columna, cambiar la longitud de una columna tampoco conduce a sobrescribir una columna.  Eliminar una columna y, en general, muchas entidades en PostgreSQL tambi√©n es una operaci√≥n r√°pida. <br><br><img src="https://habrastorage.org/webt/fq/rq/0z/fqrq0zlgqqbszyo7aajzsmzrtjy.jpeg"><br><br>  En cuanto a la adici√≥n de una columna NOT NULL.  Para evitar el bloqueo durante la validaci√≥n, puede realizar el m√©todo mencionado anteriormente: agregue CONSTRAINT correspondiente a CHECK (la columna NO ES NULO) NO ES V√ÅLIDO y valide con un comando por separado. <br><br>  La diferencia en general es que esta restricci√≥n existir√° a nivel de tabla, y no a nivel de columna en la definici√≥n de la tabla.  Otra diferencia es que puede afectar el rendimiento, aproximadamente el uno por ciento.  En este caso, no habr√° bloqueo, si el servicio est√° muy cargado, incluso unos pocos segundos de bloqueo pueden generar una enorme cola de transacciones y habr√° un problema en el servicio. <br><br><img src="https://habrastorage.org/webt/qj/oy/sb/qjoysbcnasbr3xz0komagdri2oe.jpeg"><br><br>  La eliminaci√≥n de datos en PostgreSQL generalmente es una operaci√≥n r√°pida, ya que los datos no se eliminan de inmediato, solo la columna est√° marcada como obsoleta en los atributos de la tabla, y los datos se eliminar√°n solo despu√©s del inicio del pr√≥ximo vac√≠o. <br><br><img src="https://habrastorage.org/webt/v3/75/n5/v375n5xmrwzhinew6obppnsdgeq.jpeg"><br><br>  Hablemos de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">biblioteca</a> .  Estoy hablando de Django, migraci√≥n.  En general, Django es una biblioteca para Python, un marco web, originalmente fue creado para crear r√°pidamente sitios web como noticias, desde entonces se ha actualizado significativamente.  Hay un sistema ORM que le permite comunicarse con registros en la base de datos, con tablas, como si fueran objetos o clases de Python.  Es decir, cada tabla tiene su propia clase en Python.  Y cuando hacemos cambios en nuestro c√≥digo de Python, es decir, agregamos nuevos atributos como columnas a la tabla, Django durante el proceso de creaci√≥n de la migraci√≥n notifica estos cambios y crea los archivos de migraci√≥n para hacer cambios espejo en la base de datos para que no diverjan. <br><br>  La biblioteca fue escrita para automatizar algunas de las t√©cnicas discutidas anteriormente para evitar bloqueos largos en la mesa durante tales migraciones.  Ha estado trabajando con Django desde la versi√≥n 1.8 a 2.1 inclusive, y Python desde 2.7 a 3.7 inclusive. <br><br>  Con respecto a las caracter√≠sticas actuales de la biblioteca, esto est√° agregando una columna con un valor predeterminado sin bloqueos, anulables o no, esto est√° creando un √≠ndice CONCURRENTEMENTE, as√≠ como la capacidad de reiniciarse cuando se bloquea.  En la implementaci√≥n est√°ndar de Django, si agregamos una columna con un valor predeterminado, la tabla est√° bloqueada, y si es grande, podr√≠a ser 40 minutos de bloqueo en mi experiencia.  La tabla est√° bloqueada, y eso es todo, espere hasta que los cambios se copien y se realicen.  Pasaron 30 minutos: detectaron el error de conexi√≥n a la base de datos, la migraci√≥n se cae, los cambios no se confirman y hay que comenzar de nuevo, esperar 40 minutos nuevamente y volver a bloquear la tabla esta vez. <br><br><img src="https://habrastorage.org/webt/vg/xy/lz/vgxylzlxerxosettf26nbtrqo9u.jpeg"><br><h5>  <sup><sub><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Enlace GitHub</a></sub></sup> </h5><br>  La biblioteca le permite reanudar la migraci√≥n desde el lugar donde fue interrumpida.  Cuando se bloquea y reinicia, se muestra un cuadro de di√°logo donde hay varias opciones de acci√≥n, es decir, puede decir que contin√∫e actualizando los datos.  Esta suele ser una actualizaci√≥n de datos porque es el proceso m√°s largo.  La migraci√≥n simplemente continuar√° desde donde se qued√≥.  Tal operaci√≥n tambi√©n lleva m√°s tiempo que una operaci√≥n est√°ndar con bloqueo de mesa, pero al mismo tiempo, el servicio permanece operativo en este momento. <br><br><img src="https://habrastorage.org/webt/kp/d2/bp/kpd2bpbqlehlnxps9ozwj3iuv4g.jpeg"><br><br>  Sobre la conexi√≥n en su conjunto.  Hay documentaci√≥n;  en resumen, debe reemplazar el motor en la configuraci√≥n de la base de datos de Django con el motor de la biblioteca.  Tambi√©n hay varios mixins si usa sus motores para conectarse. <br><br><img src="https://habrastorage.org/webt/x1/fc/gh/x1fcghzaqinnjq-hela3v1aarie.jpeg"><br><br>  Un ejemplo de trabajo consiste en agregar una columna con un valor predeterminado.  Aqu√≠ agregamos columnas con un valor booleano, True por defecto.  ¬øQu√© operaciones realiza el SchemaEditor est√°ndar?  Las operaciones que puede ver si ejecuta SQL migrate.  Esto es bastante √∫til, por el mismo tipo de migraci√≥n, no siempre est√° claro qu√© puede cambiar Django all√≠.  Y es √∫til comenzar y ver si las operaciones esperadas por nosotros se han completado y si algo superfluo e innecesario ha llegado all√≠. <br><br>  ¬øQu√© comandos ejecuta SchemaEditor?  Primero, se agrega una nueva columna a una transacci√≥n, se agrega el valor predeterminado.  Luego, hasta que dicha actualizaci√≥n regrese que haya actualizado cero, los datos se actualizar√°n. <br><br>  Luego, SET NOT NULL se establece en la columna, y el valor predeterminado se eliminar√°, repitiendo el comportamiento de Django, que almacena el valor predeterminado no en la base de datos, sino en su propio nivel l√≥gico en el c√≥digo. <br><br>  Aqu√≠, en general, tambi√©n hay espacio para crecer.  Por ejemplo, puede crear un √≠ndice auxiliar para encontrar r√°pidamente esas filas con un valor NULL a medida que se acerca a actualizar toda la tabla. <br><br><img src="https://habrastorage.org/webt/je/a8/h3/jea8h37vcuylfp-eut209sdpsse.jpeg"><br><br>  Tambi√©n puede corregir la identificaci√≥n m√°xima para el tiempo de actualizaci√≥n cuando comenzamos la migraci√≥n, de modo que por identificaci√≥n pueda encontrar r√°pidamente valores que a√∫n no hemos actualizado. <br><br>  En general, la biblioteca se est√° desarrollando, aceptamos solicitudes de grupo.  A qui√©n le importa, √∫nete. <br><br>  Vale la pena prestar atenci√≥n a que con el crecimiento de las bases de datos, las migraciones tienen una propiedad inevitable para frenar.  Debe realizar un seguimiento de los bloqueos que toma la tabla, ejecutar migraciones de SQL para ver qu√© operaciones se aplican.  Por nuestra parte, en Yandex.Connect usamos esta biblioteca donde sus capacidades lo permiten.  Y donde no lo permiten, nosotros mismos, con nuestras propias manos, migraciones falsas de Django, ejecutamos nuestras consultas SQL. <br><br>  Por lo tanto, logramos alta disponibilidad de servicios de lectura y escritura.  Tenemos cargas pesadas, miles de RPS y el tiempo de inactividad en unos minutos, sin mencionar m√°s tiempo, es inaceptable.  Es necesario que las migraciones pasen desapercibidas para el usuario.  Y con tales cargas, no ser√° posible levantarse a las cuatro de la ma√±ana, rodar algo cuando no hay carga y volver a la cama, porque la carga va las 24 horas. <br><br>  Vale la pena se√±alar que incluso las operaciones r√°pidas en PostgreSQL pueden causar una desaceleraci√≥n del servicio y errores debido a la forma en que funciona la cola de bloqueo en PostgreSQL. <br><br>  Imagine que se lanza una operaci√≥n que, incluso por unos pocos milisegundos, requiere acceso exclusivo.  Un ejemplo de tal operaci√≥n es agregar una columna sin un valor predeterminado.  Imagine que en el momento de su lanzamiento en otra transacci√≥n, hay otra operaci√≥n larga, por ejemplo, SELECCIONAR con agregaci√≥n.  En este caso, nuestra operaci√≥n har√° cola para ella.  Esto suceder√° porque el acceso exclusivo entra en conflicto con todos los dem√°s tipos de bloqueos. <br><br>  Mientras nuestra operaci√≥n de agregar una columna est√° esperando un bloqueo, todos los dem√°s lo pondr√°n en cola y no se ejecutar√°n hasta que se complete.  Al mismo tiempo, la operaci√≥n que se est√° realizando (SELECCIONAR con agregaci√≥n) puede no entrar en conflicto con las dem√°s, y si no fuera por nuestra creaci√≥n de la columna, no se habr√≠an puesto en la cola, sino que se habr√≠an ejecutado en paralelo. <br><br>  Esta situaci√≥n puede crear grandes problemas en el servicio.  Por lo tanto, antes de iniciar ALTER TABLE o cualquier otra operaci√≥n que requiera bloqueo exclusivo de acceso, debe buscar para que las consultas largas no vayan a la base de datos en este momento.  O simplemente puede insertar un tiempo de espera de registro muy peque√±o.  Entonces, si no fuera posible tomar r√°pidamente la cerradura, la operaci√≥n se caer√≠a.  Podr√≠amos reiniciarlo y no bloquear la tabla durante mucho tiempo, mientras que la operaci√≥n esperar√° la concesi√≥n de una concesi√≥n para los bloqueos.  Eso es todo, gracias. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es435880/">https://habr.com/ru/post/es435880/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es435868/index.html">Slush 2018. D√≠a de vista previa</a></li>
<li><a href="../es435870/index.html">Orquesta Cibern√©tica. Docker Container Orchestration con aplicaciones .NET Core en la nube</a></li>
<li><a href="../es435872/index.html">Lenguaje de programaci√≥n Zig</a></li>
<li><a href="../es435876/index.html">Configuraci√≥n detallada del navegador Firefox</a></li>
<li><a href="../es435878/index.html">Amateur en c√≥digo abierto - lecciones aprendidas en 3 a√±os</a></li>
<li><a href="../es435882/index.html">Revisi√≥n de Xiaomi Mi Box S y una peque√±a comparaci√≥n con Mi Box 3</a></li>
<li><a href="../es435884/index.html">B√∫squeda de metales y ... red neuronal</a></li>
<li><a href="../es435886/index.html">SpaceX mostr√≥ el prototipo de nave espacial y reducir√° el 10% del personal</a></li>
<li><a href="../es435890/index.html">Los lados oscuros de una persona activa.</a></li>
<li><a href="../es435892/index.html">El resumen de materiales interesantes para el desarrollador m√≥vil # 281 (del 7 al 13 de enero)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>