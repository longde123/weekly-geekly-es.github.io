<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úäüèª üßíüèø üë©üèΩ‚Äçüî¨ O PubSub √© quase gratuito: NOTIFY apresenta no PostgreSQL üêÇ üë©‚Äçüè´ üñêÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Se seus microsservi√ßos j√° usam um banco de dados PostgreSQL comum para armazenar dados, ou se v√°rias inst√¢ncias do mesmo servi√ßo os usam em servidores...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>O PubSub √© quase gratuito: NOTIFY apresenta no PostgreSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484978/">  Se seus microsservi√ßos <u>j√° usam um banco de dados PostgreSQL comum</u> para armazenar dados, ou se v√°rias inst√¢ncias do mesmo servi√ßo os usam em servidores diferentes, √© poss√≠vel <b>receber mensagens "</b> PubSub <b>"</b> entre eles de maneira relativamente barata, sem integra√ß√£o √† arquitetura Redis, cluster RabbitMQ ou incorpora√ß√£o no c√≥digo aplicativos de <a href="https://habr.com/ru/post/326880/">outro sistema MQ</a> . <br><br>  Para fazer isso, <b>n√£o escreveremos</b> <a href="https://habr.com/ru/post/483014/">mensagens nas tabelas do banco de dados</a> , pois isso causa muita sobrecarga, primeiro ao <a href="https://habr.com/ru/company/postgrespro/blog/459250/">gravar o transmitido</a> e depois tamb√©m √† <a href="https://habr.com/post/481866/">limpeza do que j√° foi lido</a> . <br><br>  Transmitiremos e receberemos dados usando o mecanismo <a href="https://postgrespro.ru/docs/postgresql/12/sql-notify">NOTIFY</a> / <a href="https://postgrespro.ru/docs/postgresql/12/sql-listen">LISTEN</a> e coletaremos uma implementa√ß√£o de modelo para o Node.js. <br><br><img src="https://habrastorage.org/webt/er/e_/dv/ere_dvhj_y3sjkypbqeezzg_xn4.png"><br><br>  Mas, dessa maneira, h√° um ancinho que deve ser cuidadosamente contornado. <br><a name="habracut"></a><br><h2>  Recursos de protocolo </h2><br><h4>  Ou√ßa </h4><br><pre><code class="sql hljs">LISTEN </code> </pre> <blockquote>  Um aplicativo que usa a biblioteca libpq executa o comando LISTEN como um comando SQL regular e, em seguida, deve chamar periodicamente a fun√ß√£o PQnotifies para verificar novas notifica√ß√µes. </blockquote>  Se voc√™ n√£o est√° escrevendo uma biblioteca para trabalhar com o PG, mas j√° √© um aplicativo espec√≠fico, na maioria dos casos, n√£o ter√° acesso √† chamada para esta fun√ß√£o. <br><br>  Mas se essa biblioteca j√° tiver sido gravada para voc√™ de acordo com as recomenda√ß√µes para o processamento de <a href="https://postgrespro.ru/docs/postgresql/12/libpq-async">solicita√ß√µes</a> e <a href="https://postgrespro.ru/docs/postgresql/12/libpq-notify">notifica√ß√µes</a> <a href="https://postgrespro.ru/docs/postgresql/12/libpq-async">ass√≠ncronas</a> , voc√™ receber√° automaticamente uma mensagem no c√≥digo do aplicativo.  Caso contr√°rio, voc√™ pode simplesmente <b>executar periodicamente o <code>SELECT 1</code></b> na conex√£o e, em seguida, uma notifica√ß√£o ser√° exibida com o resultado da consulta: <blockquote>  Em vers√µes muito antigas da libpq, havia apenas uma maneira de garantir o recebimento oportuno de mensagens do comando NOTIFY - enviar constantemente comandos, mesmo vazios, e depois verificar PQnotifies ap√≥s cada chamada PQexec.  Embora esse m√©todo ainda funcione, √© considerado obsoleto devido ao uso ineficiente do processador. </blockquote>  Em termos de, por exemplo, <a href="https://postgrespro.ru/docs/postgresql/12/app-psql">psql,</a> fica assim: <br><br><pre> <code class="plaintext hljs">_tmp=# LISTEN test; LISTEN _tmp=# SELECT 1; ?column? ---------- 1 (1 row) Asynchronous notification "test" with payload "abc123" received from server process with PID 63991.</code> </pre><br>  Se para uma tarefa aplicada, podemos concordar com um atraso m√°ximo na entrega de uma mensagem dentro de 1 segundo, com esse intervalo, executamos a solicita√ß√£o.  Ao mesmo tempo, esse m√©todo ajuda a <b>monitorar a "vitalidade" da conex√£o</b> , garantindo que ningu√©m a corte acidentalmente do lado do servidor via <code>pg_terminate_backend</code> , ou se n√£o houve uma "falha" repentina do PG sem nenhuma notifica√ß√£o aos clientes. <br><br><h4>  NOTIFICAR </h4><br><pre> <code class="sql hljs">NOTIFY  [ ,  ]</code> </pre> <br><blockquote>  O comando NOTIFY envia um evento de notifica√ß√£o junto com uma linha de "mensagem" adicional para todos os aplicativos clientes que executaram anteriormente um canal com o nome de canal especificado no banco de dados LISTEN atual. <br>  ... <br>  A linha de "mensagem" que ser√° transmitida junto com a notifica√ß√£o ... deve ser uma <a href="https://postgrespro.ru/docs/postgresql/12/sql-syntax-lexical">constante de texto simples</a> .  Em uma configura√ß√£o padr√£o, seu <b>comprimento deve ser menor que 8000 bytes</b> . </blockquote>  Ou seja, se nossa ‚Äúmensagem‚Äù repentinamente contiver algo muito diferente do ASCII, teremos <u>que examin√°-lo</u> e, se exceder 8.000 bytes (n√£o caracteres!), <u>Corte-o em blocos e cole-o</u> .  Ao mesmo tempo, devemos economizar a largura de banda do canal e os recursos do servidor para processar a transfer√™ncia de tais blocos - ou seja, adicionar o m√≠nimo poss√≠vel de "liga√ß√£o" ao conte√∫do √∫til poss√≠vel, mas tamb√©m n√£o "estrangular" o aplicativo cliente, for√ßando-o a empacotar com <code>gzip -9</code> . <br><br>  Das vantagens adicionais do mecanismo, tamb√©m √© poss√≠vel observar a liga√ß√£o √† "fonte" da mensagem ... <br><blockquote>  ... trabalho adicional pode ser evitado verificando se o <b>PID do processo de sinaliza√ß√£o</b> (indicado nos dados do evento) corresponde ao PID da pr√≥pria sess√£o (voc√™ pode encontr√°-lo entrando em contato com libpq).  Se eles corresponderem, a sess√£o receber√° uma notifica√ß√£o de suas pr√≥prias a√ß√µes, para que possa ser ignorada. </blockquote>  ... e ordem de entrega garantida: <br><blockquote>  Al√©m de filtrar inst√¢ncias subsequentes de notifica√ß√µes duplicadas, o NOTIFY garante que as notifica√ß√µes de uma √∫nica transa√ß√£o sempre cheguem na mesma ordem em que foram enviadas.  Tamb√©m √© garantido que as <b>mensagens de transa√ß√µes diferentes cheguem na ordem em que essas transa√ß√µes s√£o confirmadas</b> . </blockquote>  N√£o combinaremos nada especificamente; portanto, cada uma de nossas solicita√ß√µes corresponder√° apenas a uma transa√ß√£o separada. <br><br>  Mas lembre-se de que, se houver tamb√©m atividade de aplicativo na conex√£o usada para a troca, nosso NOTIFY pode n√£o estar dentro da transa√ß√£o por vontade pr√≥pria, portanto <u>, podem ocorrer efeitos colaterais</u> : <br><blockquote>  As transa√ß√µes t√™m um impacto significativo no NOTIFY.  Primeiro, se o NOTIFY for executado dentro de uma transa√ß√£o, as notifica√ß√µes ser√£o entregues aos destinat√°rios ap√≥s a transa√ß√£o ser confirmada e somente neste caso.  Isso √© razo√°vel, pois, <b>no caso de uma transa√ß√£o ser interrompida, a a√ß√£o de todos os comandos nela √© cancelada, incluindo NOTIFY</b> . </blockquote>  Portanto, √© melhor usar uma conex√£o onde obviamente n√£o h√° transa√ß√µes ou consultas longas. <br><br><h4>  AccessExclusiveLock no objeto 0 da classe 1262 do banco de dados 0 </h4><br>  Se, de repente, o seu NOTIFY come√ßou a diminuir e registrar a expectativa de uma fechadura assim, voc√™ ainda "ficou sem cal√ßas" e √© hora de pensar no MQ "adulto". <br><br>  Afinal, a fila de notifica√ß√µes, embora bastante grande (8 GB em compila√ß√µes padr√£o), ainda √© finita.  De acordo com <a href="">a resposta de Tom Lane</a> : <br><blockquote>  <i>Esse bloqueio √© mantido ao inserir as mensagens de notifica√ß√£o da transa√ß√£o, ap√≥s as quais a transa√ß√£o confirma e libera o bloqueio.</i> </blockquote>  Ou seja, n√£o h√° muitas op√ß√µes para contornar: <br><br><ul><li>  <b>envie com menos frequ√™ncia</b> <br>  Ou seja, para agregar os indicadores enviados, se houver alguns contadores, por um intervalo maior. </li><li>  <b>envie menos</b> <br>  Por exemplo, para remover "padr√£o" do ponto de vista dos valores da chave do aplicativo do JSON transmitido. </li><li>  <b>envie apenas sinal</b> , nenhum conte√∫do <br>  Como op√ß√£o - para iniciar v√°rios canais, o nome de cada um j√° ter√° em si algum sentido aplicado. </li><li>  ainda <b>fa√ßa uma remessa do banco de dados</b> </li></ul><br><h2>  Enviando mensagens complexas </h2><br><h4>  Codifica√ß√£o do corpo </h4><br>  No caso geral, podemos querer transmitir n√£o apenas caracteres permitidos na mensagem, mas tamb√©m letras russas e ‚Äúquaisquer bin√°rios‚Äù - portanto, seria conveniente usar a <u>convers√£o em representa√ß√£o hexadecimal</u> para formar a sequ√™ncia transmitida.  E sim, este m√©todo funciona muito bem: <br><br><pre> <code class="sql hljs">NOTIFY test, E'\x20\x21'</code> </pre> <br><pre> <code class="plaintext hljs">Asynchronous notification "test" with payload " !" received from server process with PID 63991.</code> </pre> <br>  Mas vamos voltar √† documenta√ß√£o novamente: <br><blockquote>  Voc√™ deve garantir que as seq√º√™ncias de bytes criadas dessa maneira, especialmente nas nota√ß√µes octal e hexadecimal, formem <b>caracteres codificados no servidor v√°lidos</b> .  Quando o servidor opera com codifica√ß√£o UTF-8, em vez de uma grava√ß√£o de byte, use sequ√™ncias especiais Unicode ou a sintaxe Unicode alternativa descrita na Se√ß√£o 4.1.2.3.  (Caso contr√°rio, voc√™ precisar√° codificar caracteres UTF-8 manualmente e grav√°-los por bytes, o que √© muito inconveniente.) </blockquote>  Portanto, mesmo com o s√≠mbolo comum da pata de aspas de win1251, tomamos o p√£o de luto: <br><br><pre> <code class="sql hljs">NOTIFY test, E'\x98' <span class="hljs-comment"><span class="hljs-comment">-- ERROR: invalid byte sequence for encoding "UTF8": 0x98</span></span></code> </pre> <br>  Como n√£o queremos " <i>codificar caracteres UTF-8 manualmente e escrev√™-los por bytes</i> ", concordamos imediatamente em enviar o corpo da mensagem <b>compactado em base64</b> se ele contiver caracteres fora do intervalo <code>\x20-\x7E</code> ou, se necess√°rio, segmenta√ß√£o.  Por um lado, esse m√©todo de empacotamento n√£o aumenta muito a redund√¢ncia (coeficiente 4: 3); por outro lado, √© implementado no n√≠vel das bibliotecas do sistema em qualquer idioma e fornecer√° carga adicional m√≠nima. <br><br>  Mas mesmo se n√£o tivermos caracteres "estranhos" e a mensagem se encaixar em um segmento, ainda h√° um recurso: <b>escapar do ap√≥strofo</b> : <br><blockquote>  Para incluir um ap√≥strofo em uma linha, escreva <u>dois ap√≥strofos pr√≥ximos a ela</u> , por exemplo: 'Joana d'Arc'.  Observe que isso n√£o √© o mesmo que aspas duplas ("). </blockquote><br><h4>  Identifica√ß√£o do segmento </h4><br>  A pr√≥xima tarefa √© "cortar" corretamente a mensagem em <b>blocos</b> permitidos para transmiss√£o <b>de 7999 bytes</b> , se seu tamanho exceder esse valor repentinamente.  E para que o destinat√°rio possa colet√°-lo sem quebrar a ordem ou cair na cadeia de segmentos "alien√≠genas".  Para isso, cada um deles precisa ser identificado de alguma forma. <br><br>  Na verdade, j√° conhecemos as duas "coordenadas" - este √© o <u>PID do processo de envio</u> e o <u>nome do canal</u> que aparece em cada notifica√ß√£o.  E a ordem de chegada dos segmentos nos √© garantida pelo pr√≥prio protocolo. <br><br><div class="spoiler">  <b class="spoiler_title">Escrever vizinhos</b> <div class="spoiler_text">  N√£o consideraremos o caso em que <i>v√°rios gravadores no mesmo canal</i> est√£o ativos ao mesmo tempo em que se <i>conectam ao banco de dados</i> (ou seja, obviamente dentro do mesmo processo de aplica√ß√£o).  Tecnicamente, isso pode ser suportado passando um identificador adicional no cabe√ßalho do segmento - mas √© melhor ‚Äúcompartilhar‚Äù um √∫nico objeto PubSub dentro do seu aplicativo. <br></div></div><br><h4>  Limite do cont√™iner </h4><br>  Para montar um cont√™iner integral de v√°rios segmentos, precisamos saber o momento de sua conclus√£o.  Existem duas maneiras t√≠picas para isso: <br><br><ul><li>  transfer√™ncia do tamanho do destino (em bytes ou segmentos) no primeiro deles </li><li>  transmiss√£o do sinal [n√£o] do √∫ltimo segmento em cada um deles </li></ul><br>  Como escrevemos o PubSub, afinal, a maioria das nossas mensagens ser√° curta e n√£o √© rent√°vel reservar muitos bytes para a transfer√™ncia de tamanho.  Portanto, usaremos o segundo m√©todo, tendo reservado o <u>primeiro caractere dos dados do segmento</u> como sinalizador de continua√ß√£o / final do cont√™iner. <br><br><h4>  Transfer√™ncia de Objetos </h4><br>  Para transmitir as strings de texto sem formata√ß√£o e os objetos JSON como uma "mensagem", adicionamos <u>mais um sinal de s√≠mbolo</u> para a transforma√ß√£o inversa no lado do destinat√°rio. <br><br>  Como decidimos codificar "n√£o-formato" em base64, para sinalizadores, podemos usar qualquer caractere permitido que n√£o esteja nesse conjunto. <br><br>  No total, temos as seguintes op√ß√µes para os segmentos transmitidos: <br><br><pre> <code class="plaintext hljs">-- ""   !simple string -- "  "  @{"a":1} --    base64 #&lt;segment&gt; --    base64 $&lt;segment&gt;</code> </pre><br>  Como voc√™ pode ver, basta analisar ao receber um segmento apenas o primeiro caractere para entender o que precisa ser feito com ele. <br><br><h2>  Escrevendo uma implementa√ß√£o do PubSub </h2><br>  Nossa aplica√ß√£o estar√° no Node.js, portanto, usaremos o <a href="https://www.npmjs.com/package/pg">m√≥dulo node-postgres</a> para trabalhar com o PostgreSQL. <br><br><div class="spoiler">  <b class="spoiler_title">N√≥s escrevemos o quadro inicial</b> <div class="spoiler_text">  Para come√ßar, vamos criar o PubSub como herdeiro do <a href="https://nodejs.org/dist/latest-v12.x/docs/api/events.html">EventEmitter</a> , para poder gerar eventos para aqueles que se inscreveram em canais espec√≠ficos: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> util = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'util'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> EventEmitter = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'events'</span></span>).EventEmitter; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PubSub = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">connection, interval, skipSelf</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     this.connection = connection; //        this.connection.on('notification', p._onmessage.bind(this)); //         this.skipSelf = skipSelf; //  "" setInterval(() =&gt; { this.connection.query('SELECT 1'); }, interval); //     ""  this.slices = {}; }; util.inherits(PubSub, EventEmitter); const p = PubSub.prototype;</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Trabalhamos com canais</b> <div class="spoiler_text">  Como LISTEN / UNLISTEN n√£o jura de forma alguma ao reinscrever-se em um canal ou cancelar a inscri√ß√£o em que n√£o fomos inscritos, n√£o complicaremos nada. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     - "",      //     -        const quot = str =&gt; /^[_a-z][0-9a-z_\$]*$/.test(str) ? str : `"${str}"`; p.subscribe = function(channel) { this.connection.query(`LISTEN ${quot(channel)}`); return this; }; p.unsubscribe = function(channel) { this.connection.query(`UNLISTEN ${quot(channel)}`); return this; };</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Enviando e recebendo mensagens</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PAYLOAD_LIMIT = <span class="hljs-number"><span class="hljs-number">8000</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PAYLOAD_FL_STR = <span class="hljs-string"><span class="hljs-string">'!'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PAYLOAD_FL_OBJ = <span class="hljs-string"><span class="hljs-string">'@'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PAYLOAD_FL_SEQ = <span class="hljs-string"><span class="hljs-string">'#'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PAYLOAD_FL_FIN = <span class="hljs-string"><span class="hljs-string">'$'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PAYLOAD_SZ_HEAD = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PAYLOAD_SZ_DATA = PAYLOAD_LIMIT - PAYLOAD_SZ_HEAD; <span class="hljs-comment"><span class="hljs-comment">//  ""  const reASCII = /^[\x20-\x7E]*$/; //  p.publish = function(channel, payload) { let query = `NOTIFY ${quot(channel)}`; if (payload !== null &amp;&amp; payload !== undefined) { //    -    let str = typeof payload == 'string' ? PAYLOAD_FL_STR + payload : PAYLOAD_FL_OBJ + JSON.stringify(payload); if (str.length &gt; PAYLOAD_LIMIT || !reASCII.test(str)) { //   base64- const b64 = Buffer.from(str).toString('base64'); for (let pos = 0, len = b64.length; pos &lt; len; pos += PAYLOAD_SZ_DATA) { let fin = pos + PAYLOAD_SZ_DATA; let seg = fin &gt;= len ? PAYLOAD_FL_FIN + b64.slice(pos) : PAYLOAD_FL_SEQ + b64.slice(pos, fin); this.connection.query(`${query}, '${seg}'`); } } else { //        ? //     str = str.replace(/'/g, "''"); this.connection.query(`${query}, '${str}'`); } } else { //       this.connection.query(query); } return this; }; //    p._onmessage = function(msg) { const {processId, channel, payload} = msg; //  "" if (processId == this.connection.processID &amp;&amp; this.skipSelf) { return; } // ""  const id = `${processId}:${channel}`; let rv; //   let fl = payload.charAt(0); if (fl == PAYLOAD_FL_SEQ || fl == PAYLOAD_FL_FIN) { // base64 const str = payload.slice(PAYLOAD_SZ_HEAD); const slices = this.slices; let b64; if (fl == PAYLOAD_FL_FIN) { //   if (slices[id]) { slices[id].push(str); b64 = slices[id].join(''); delete slices[id]; } else { b64 = str; } } else { //     if (slices[id]) { slices[id].push(str); } else { slices[id] = [str]; } } if (b64) { rv = Buffer.from(b64, 'base64').toString(); fl = rv.charAt(0); } } else { //  / rv = payload; } if (rv !== undefined) { //   '' let res = { processId , channel }; if (rv) { //       let data = rv.slice(1); res.payload = fl == PAYLOAD_FL_OBJ ? JSON.parse(data) : data; } this.emit(channel, res); } };</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Alguns testes</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pg = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'pg'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pgsql = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> pg.Client({ <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">'example-db'</span></span> , <span class="hljs-attr"><span class="hljs-attr">port</span></span> : <span class="hljs-number"><span class="hljs-number">5432</span></span> , <span class="hljs-attr"><span class="hljs-attr">user</span></span> : <span class="hljs-string"><span class="hljs-string">'postgres'</span></span> , <span class="hljs-attr"><span class="hljs-attr">password</span></span> : <span class="hljs-string"><span class="hljs-string">'postgres'</span></span> , <span class="hljs-attr"><span class="hljs-attr">database</span></span> : <span class="hljs-string"><span class="hljs-string">'_tmp'</span></span> }); pgsql.connect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> psA = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PubSub(pgsql, <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> psB = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PubSub(pgsql, <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> chA = <span class="hljs-string"><span class="hljs-string">'channel:A'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> chB = <span class="hljs-string"><span class="hljs-string">'channel:B'</span></span>; psA.subscribe(chA); psB.subscribe(chB); psA.on(chA, (msg) =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'A:rcv'</span></span>, msg); }); psB.on(chB, (msg) =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'B:rcv'</span></span>, msg); }); psB.publish(chA); psB.publish(chA, <span class="hljs-string"><span class="hljs-string">'simple string'</span></span>); psB.publish(chA, <span class="hljs-string"><span class="hljs-string">'  '</span></span>); psB.publish(chA, {<span class="hljs-attr"><span class="hljs-attr">a</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>}); psA.publish(chB, <span class="hljs-string"><span class="hljs-string">'   100  '</span></span>.repeat(<span class="hljs-number"><span class="hljs-number">100</span></span>)); });</code> </pre></div></div><br>  Tudo √© bastante simples, ent√£o voc√™ pode implement√°-lo facilmente em qualquer outro PL usado em seu projeto, tomando como exemplo a base para trabalhar com notifica√ß√µes ass√≠ncronas: <br><br><ul><li>  <a href="http://initd.org/psycopg/docs/advanced.html">Python</a> </li><li>  <a href="https://tapoueh.org/blog/2018/07/postgresql-listen-notify/">Go</a> </li><li>  <a href="https://omniti.com/seeds/stop-collaborate-and-listen-notify.html">Perl</a> </li><li>  <a href="https://blog.lelonek.me/listen-and-notify-postgresql-commands-in-elixir-187c49597851">Elixir</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt484978/">https://habr.com/ru/post/pt484978/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt484964/index.html">Configurando o balanceamento de carga no InfoWatch Traffic Monitor</a></li>
<li><a href="../pt484966/index.html">Modelo pronto para teste usando o Spring</a></li>
<li><a href="../pt484968/index.html">WPF DataGrid. Lutar por modelo</a></li>
<li><a href="../pt484972/index.html">Lan√ßamento do Wine 5.0</a></li>
<li><a href="../pt484974/index.html">Telhas Wang para simula√ß√£o de m√°quina de Turing</a></li>
<li><a href="../pt484982/index.html">√â f√°cil organizar seus neg√≥cios para um especialista em TI</a></li>
<li><a href="../pt484984/index.html">Desenvolvedor de jogos Unity. Novo curso da OTUS</a></li>
<li><a href="../pt484990/index.html">Luxoft TechTalks - podcasts em v√≠deo de gurus globais de TI e muito mais</a></li>
<li><a href="../pt484992/index.html">Mais bonito em grandes projetos: gaste 20 minutos em configura√ß√£o, esque√ßa a formata√ß√£o para sempre</a></li>
<li><a href="../pt484996/index.html">Virtual PBX Beeline. O que o gerente n√£o lhe dir√°</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>