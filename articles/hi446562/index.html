<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯЪо ЁЯУ╝ ЁЯСЯ рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдореЗрдВ рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ ЁЯПе ЁЯд┤ЁЯП╗ тЪая╕П</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдЕрддреНрдпрдзрд┐рдХ рд▓реЛрдб рд╡рд╛рд▓реЗ рдорд▓реНрдЯреАрдереНрд░реЗрдб рдпрд╛ рд╡рд┐рддрд░рд┐рдд рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд╡рд┐рдХрд╛рд╕ рдХреЗ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ, рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдХреНрд╕рд░ рдЪрд░реНрдЪрд╛ рд╣реЛрддреА рд╣реИред рдЖрдЬ рд╣рдо рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдореЗрдВ рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/446562/"><p>  рдЕрддреНрдпрдзрд┐рдХ рд▓реЛрдб рд╡рд╛рд▓реЗ рдорд▓реНрдЯреАрдереНрд░реЗрдб рдпрд╛ рд╡рд┐рддрд░рд┐рдд рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд╡рд┐рдХрд╛рд╕ рдХреЗ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ, рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдХреНрд╕рд░ рдЪрд░реНрдЪрд╛ рд╣реЛрддреА рд╣реИред  рдЖрдЬ рд╣рдо рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ рдореЗрдВ рдбреБрдмрдХреА рд▓реЗрдВрдЧреЗ рдФрд░ рдЕрдзреНрдпрдпрди рдХрд░реЗрдВрдЧреЗ рдХрд┐ рдпрд╣ рдХрдм рд╣реЛрддрд╛ рд╣реИ, рдпрд╣ рдЙрд╕ рдХреЛрдб рдФрд░ рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рднрд╛рд╖рд╛ рдХреЛ рдХреИрд╕реЗ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдХрд╛ рд╣рдо рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред  рд╣рдо рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛рдПрдВрдЧреЗ рдХрд┐ рд╡рд╛рдпрджрд╛ рдФрд░ рд╡рд╛рджреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреНрдпреЛрдВ рд╣реИ, рдФрд░ рдХреЛрд░рдЯрд╛рдЗрди рдФрд░ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рд╕реНрдкрд░реНрд╢ рдХрд░реЗрдВред  рдпрд╣ рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рд╡рд┐рдХрд╛рд╕ рдХреЗ рджреМрд░рд╛рди рдЙрддреНрдкрдиреНрди рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рд╡реНрдпрд╛рдкрд╛рд░ рдХреЛ рдФрд░ рдЕрдзрд┐рдХ рд╕реНрдкрд╖реНрдЯ рдХрд░ рджреЗрдЧрд╛ред </p><br><p>  рдпрд╣ рд╕рд╛рдордЧреНрд░реА рдпреИрдВрдбреЗрдХреНрд╕ рдбреЗрдЯрд╛ рдПрдирд╛рд▓рд┐рд╕рд┐рд╕ рд╕реНрдХреВрд▓ рдХреЗ рд╢рд┐рдХреНрд╖рдХ рдЗрд╡рд╛рди рдкреБрдЬреЗрд░реЗрд╡рд╕реНрдХреА рдХреА рдПрдХ рд░рд┐рдкреЛрд░реНрдЯ рдХреЗ рдЯреНрд░рд╛рдВрд╕рдХреНрд░рд┐рдкреНрдЯ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИред </p><br><p><img src="https://habrastorage.org/webt/zl/f-/6v/zlf-6v_wphtcesgmq7cvpvfctbk.png"></p><a name="habracut"></a><br><h1 id="videozapis">  рд╡реАрдбрд┐рдпреЛ рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ </h1><br><iframe width="560" height="315" src="https://www.youtube.com/embed/g7dno0SupKY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="section1"></a><br><h1 id="1-soderzhanie">  1. рд╕рд╛рдордЧреНрд░реА </h1><br><div class="spoiler">  <b class="spoiler_title">рдЫрд┐рдкрд╛ рд╣реБрдЖ рдкрд╛рда</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">1. рд╕рд╛рдордЧреНрд░реА</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">2. рдкрд░рд┐рдЪрдп</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">3. рдореВрд▓ рдЕрд╡рдзрд╛рд░рдгрд╛</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">3.1ред</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдирд┐рд╖реНрдкрд╛рджрди рдХрд╛ рдзрд╛рдЧрд╛</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">3.2ред</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдорд▓реНрдЯреАрдЯрд╛рд╕реНрдХрд┐рдВрдЧ рдФрд░ рдХрдВрд╕рд░реНрдЯ</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">4. рдЕрд╡рд░реБрджреНрдз рдФрд░ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░рдирд╛</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">4.1ред</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЧреИрд░-рдЕрд╡рд░реБрджреНрдз рдкреНрд░рддреАрдХреНрд╖рд╛</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">5. рд╡рд╛рдпрджрд╛ / рд╡рд╛рджрд╛</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">5.1ред</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рднрд╡рд┐рд╖реНрдп рдФрд░ рд╡рд╛рджрд╛ рдЗрдВрдЯрд░рдлрд╝реЗрд╕</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">5.2ред</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд░рдЪрдирд╛ рдХрдореНрдкреНрдпреВрдЯрд┐рдВрдЧ</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">5.3ред</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЙрджрд╛рд╣рд░рдг</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">5.4ред</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдХреЛрдИ-рд╕реНрдХреАрдорд░</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">5.5ред</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕рднреА рд╕реНрдХреАрдорд░</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">5.6ред</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдХреЙрд▓рдмреИрдХ рдЕрдиреБрдХреВрд▓рди</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">6. рдХреЛрд░рдЯрд╛рдЗрди рдХреЗ рд╕рд╛рде рдХреЛрдб рдХреЛ рдкрдардиреАрдп рдХреИрд╕реЗ рдмрдирд╛рдпрд╛ рдЬрд╛рдП</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">6.1ред</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">Korutiny</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">6.2ред</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдбреНрд░рд╛рдлрд╝реНрдЯ рд╡рдлрд╝рд░ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">6.3ред</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдпреЛрдЬрдирд╛ рдЪрдХреНрд░ рдХреИрд╕рд╛ рд╣реИ?</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">6.4ред</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">Coroutine TS</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">7. рдЖрдкрдХреЛ рдХреНрдпрд╛ рдорд┐рд▓рд╛?</a> </li></ul></div></div><br><a name="section2"></a><br><h1 id="2-vvedenie">  2. рдкрд░рд┐рдЪрдп </h1><br><p> рд╕рднреА рдХреЛ рдирдорд╕реНрдХрд╛рд░, рдореЗрд░рд╛ рдирд╛рдо рдЗрд╡рд╛рди рдкреБрдЬреЗрд░реЗрд╡рд╕реНрдХреА рд╣реИ, рдореИрдВ рдпреИрдВрдбреЗрдХреНрд╕ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░рддрд╛ рд╣реВрдВред  рдкрд┐рдЫрд▓реЗ рдЫрд╣ рд╡рд░реНрд╖реЛрдВ рд╕реЗ рдореИрдВ рдбреЗрдЯрд╛ рднрдВрдбрд╛рд░рдг рдФрд░ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рдмреБрдирд┐рдпрд╛рджреА рдврд╛рдВрдЪреЗ рдореЗрдВ рд▓рдЧрд╛ рд╣реБрдЖ рд╣реВрдВ, рдЕрдм рдореИрдВрдиреЗ рдпрд╛рддреНрд░рд╛, рд╣реЛрдЯрд▓ рдФрд░ рдЯрд┐рдХрдЯ рдХреА рддрд▓рд╛рд╢ рдореЗрдВ рдЙрддреНрдкрд╛рдж рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░ рджрд┐рдпрд╛ рд╣реИред  рдЪреВрдВрдХрд┐ рдореИрдВрдиреЗ рдмреБрдирд┐рдпрд╛рджреА рдврд╛рдВрдЪреЗ рдореЗрдВ рд▓рдВрдмреЗ рд╕рдордп рддрдХ рдХрд╛рдо рдХрд┐рдпрд╛, рдЗрд╕рд▓рд┐рдП рдореБрдЭреЗ рдЕрд▓рдЧ-рдЕрд▓рдЧ рд▓реЛрдб рдХрд┐рдП рдЧрдП рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд▓рд┐рдЦрдиреЗ рдХрд╛ рдЕрдиреБрднрд╡ рдкреНрд░рд╛рдкреНрдд рд╣реБрдЖ рд╣реИред  рд╣рдорд╛рд░рд╛ рдЗрдВрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рд╣рдЬрд╛рд░реЛрдВ рдорд╢реАрдиреЛрдВ рдкрд░ рд▓рдЧрд╛рддрд╛рд░ <code>24*7*365</code> рдкреНрд░рддрд┐рджрд┐рди рдмрд┐рдирд╛ рд░реБрдХреЗ рдЪрд▓ рд░рд╣рд╛ рд╣реИред  рд╕реНрд╡рд╛рднрд╛рд╡рд┐рдХ рд░реВрдк рд╕реЗ, рдЖрдкрдХреЛ рдХреЛрдб рд▓рд┐рдЦрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ рдордЬрд╝рдмреВрддреА рд╕реЗ рдФрд░ рдХреБрд╢рд▓рддрд╛ рд╕реЗ рдХрд╛рдо рдХрд░реЗ рдФрд░ рдХрдВрдкрдиреА рджреНрд╡рд╛рд░рд╛ рдХрд┐рдП рдЧрдП рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рд╣рд▓ рдХрд░ рд╕рдХреЗред </p><br><p>  рдЖрдЬ рд╣рдо рдПрд╕рд┐рдВрдХреНрд░реЛрдирд╕ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░реЗрдВрдЧреЗред  рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ рдХреНрдпрд╛ рд╣реИ?  рдпрд╣ рд╕рдордп рдХреЗ рд╕рд╛рде рдХрд┐рд╕реА рдЪреАрдЬ рдХрд╛ рдмреЗрдореЗрд▓ рд╣реЛрдирд╛ рд╣реИред  рдЗрд╕ рд╡рд┐рд╡рд░рдг рд╕реЗ рдпрд╣ рд╕реНрдкрд╖реНрдЯ рдирд╣реАрдВ рд╣реИ рдХрд┐ рдореИрдВ рдЖрдЬ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреНрдпрд╛ рдмрд╛рдд рдХрд░рддрд╛ рд╣реВрдВред  рдХрд┐рд╕реА рддрд░рд╣ рдЗрд╕ рдореБрджреНрджреЗ рдХреЛ рд╕реНрдкрд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдореБрдЭреЗ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ "рд▓рд╛ рд╣реИрд▓реЛ, рджреБрдирд┐рдпрд╛!"ред  рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ рдЖрдорддреМрд░ рдкрд░ рдиреЗрдЯрд╡рд░реНрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд▓рд┐рдЦрдиреЗ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдореЗрд░реЗ рдкрд╛рд╕ "рд╣реИрд▓реЛ, рд╡рд░реНрд▓реНрдб" рдХрд╛ рдиреЗрдЯрд╡рд░реНрдХ рдПрдирд╛рд▓реЙрдЧ рд╣реЛрдЧрд╛ред  рдпрд╣ рдПрдХ рдкрд┐рдВрдЧ-рдкреЛрдВрдЧ рдРрдк рд╣реИред  рдХреЛрдб рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ: </p><br><pre> <code class="cpp hljs">socket s; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> x; x = read_from_socket(s, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == <span class="hljs-string"><span class="hljs-string">"ping"</span></span>) { write_to_socket(s, <span class="hljs-string"><span class="hljs-string">"pong"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  рдореИрдВ рдПрдХ рд╕реЙрдХреЗрдЯ рдмрдирд╛рддрд╛ рд╣реВрдВ, рд╡рд╣рд╛рдВ рд╕реЗ рдПрдХ рдкрдВрдХреНрддрд┐ рдкрдврд╝рддрд╛ рд╣реВрдВ, рдФрд░ рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ рдкрд┐рдВрдЧ рд╣реИ, рддреЛ рдореИрдВ рдЬрд╡рд╛рдм рдореЗрдВ рдкреЛрдВрдЧ рд▓рд┐рдЦрддрд╛ рд╣реВрдВред  рдмрд╣реБрдд рд╣реА рд╕рд░рд▓ рдФрд░ рд╕реНрдкрд╖реНрдЯред  рдЬрдм рдЖрдк рдЕрдкрдиреЗ рдХрдВрдкреНрдпреВрдЯрд░ рд╕реНрдХреНрд░реАрди рдкрд░ рдРрд╕рд╛ рдХреЛрдб рджреЗрдЦрддреЗ рд╣реИрдВ рддреЛ рдХреНрдпрд╛ рд╣реЛрддрд╛ рд╣реИ?  рд╣рдо рдЗрд╕ рдХреЛрдб рдХреЛ рдЗрди рдЪрд░рдгреЛрдВ рдХреЗ рдЕрдиреБрдХреНрд░рдо рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдордЭрддреЗ рд╣реИрдВ: </p><br><p><img src="https://habrastorage.org/webt/va/3e/dk/va3edk8_ja838w9qo7apppwyy50.png"></p><br><p>  рд╡рд╛рд╕реНрддрд╡рд┐рдХ рднреМрддрд┐рдХ рд╕рдордп рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ, рд╕рдм рдХреБрдЫ рдереЛрдбрд╝рд╛ рд╕рд╛ рдкрдХреНрд╖рдкрд╛рддреА рд╣реИред </p><br><p><img src="https://habrastorage.org/webt/od/wo/4g/odwo4gzguqz7nr_odgsksityvda.png"></p><br><p>  рдЬрд┐рди рд▓реЛрдЧреЛрдВ рдиреЗ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдРрд╕рд╛ рдХреЛрдб рд▓рд┐рдЦрд╛ рдФрд░ рдЪрд▓рд╛рдпрд╛, рд╡реЗ рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдкрдврд╝реЗ рдЧрдП рдХрджрдо рдХреЗ рдмрд╛рдж рдФрд░ рдХрджрдо рдХреЗ рдмрд╛рдж <br>  рдЬрдм рд╣рдорд╛рд░рд╛ рдХрд╛рд░реНрдпрдХреНрд░рдо рд╣рдорд╛рд░реЗ рдХреЛрдб рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ рдХреБрдЫ рднреА рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реЛ, рддреЛ рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рд▓реЗрдЦрди рдПрдХ рдХрд╛рдлреА рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рд╕рдордп рдЕрдВрддрд░рд╛рд▓ рд╣реИ, рд▓реЗрдХрд┐рди рд╣реБрдб рдХреЗ рддрд╣рдд рдорд╢реАрдирд░реА рд╕рдВрдЪрд╛рд▓рд┐рдд рд╣реЛрддреА рд╣реИ, рдЬрд┐рд╕реЗ рд╣рдо "рдЗрдирдкреБрдЯ-рдЖрдЙрдЯрдкреБрдЯ" рдХрд╣рддреЗ рд╣реИрдВред </p><br><p><img src="https://habrastorage.org/webt/ye/jl/67/yejl67r3goweaiupb1wjieg5i2a.png"><br>  I / O рдХреЗ рджреМрд░рд╛рди, рдкреИрдХреЗрдЯ рдХрд╛ рдиреЗрдЯрд╡рд░реНрдХ рдФрд░ рд╕рднреА рдкрд░рд┐рдЪрд░ рднрд╛рд░реА, рдирд┐рдореНрди-рд╕реНрддрд░реАрдп рдХрд╛рд░реНрдпреЛрдВ рдореЗрдВ рдЖрджрд╛рди-рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдЖрдЗрдП рдПрдХ рд╡рд┐рдЪрд╛рд░ рдкреНрд░рдпреЛрдЧ рдХрд░реЗрдВ: рдЗрд╕ рддрд░рд╣ рдХреЗ рдПрдХ рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреЛ рд▓реЗрдВ, рдЗрд╕реЗ рдПрдХ рднреМрддрд┐рдХ рдкреНрд░реЛрд╕реЗрд╕рд░ рдкрд░ рдЪрд▓рд╛рдПрдВ рдФрд░ рдмрд╣рд╛рдирд╛ рдХрд░реЗрдВ рдХрд┐ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдХреЛрдИ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдирд╣реАрдВ рд╣реИ, рддреЛ рдХреНрдпрд╛ рд╣реЛрдЧрд╛?  рдкреНрд░реЛрд╕реЗрд╕рд░ рдмрдВрдж рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдпрд╣ рдмрд┐рдирд╛ рдХрд┐рд╕реА рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЗ рдкрд╛рд▓рди рдХреЗ рдЙрдкрд╛рдп рдХрд░рдирд╛ рдЬрд╛рд░реА рд░рдЦрддрд╛ рд╣реИ, рдмрд╕ рд╡реНрдпрд░реНрде рдореЗрдВ рдКрд░реНрдЬрд╛ рдмрд░реНрдмрд╛рдж рдХрд░ рд░рд╣рд╛ рд╣реИред </p><br><p><img src="https://habrastorage.org/webt/pg/lu/xp/pgluxpmbkl8ho9w-2docuab2iqg.png"></p><br><p>  рдкреНрд░рд╢реНрди рдЙрдарддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рд╣рдо рдЗрд╕ рдЕрд╡рдзрд┐ рдХреЗ рджреМрд░рд╛рди рдХреБрдЫ рднреА рдЙрдкрдпреЛрдЧреА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдпрд╣ рдПрдХ рдмрд╣реБрдд рд╣реА рд╕реНрд╡рд╛рднрд╛рд╡рд┐рдХ рдкреНрд░рд╢реНрди рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдЙрддреНрддрд░ рд╣рдореЗрдВ рдкреНрд░реЛрд╕реЗрд╕рд░ рд╢рдХреНрддрд┐ рдХреЛ рдмрдЪрд╛рдиреЗ рдФрд░ рдХреБрдЫ рдЙрдкрдпреЛрдЧреА рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬрдмрдХрд┐ рд╣рдорд╛рд░рд╛ рдЖрд╡реЗрджрди рдХреБрдЫ рднреА рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реИред </p><br><a name="section3"></a><br><h1 id="3-osnovnye-ponyatiya">  3. рдореВрд▓ рдЕрд╡рдзрд╛рд░рдгрд╛ </h1><br><a name="section3-1"></a><br><h2 id="31-potok-vypolneniya">  3.1ред  рдирд┐рд╖реНрдкрд╛рджрди рдХрд╛ рдзрд╛рдЧрд╛ </h2><br><p>  рд╣рдо рдЗрд╕ рдХрд╛рд░реНрдп рдХреЛ рдХреИрд╕реЗ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ?  рдЖрдЗрдП рдЕрд╡рдзрд╛рд░рдгрд╛рдУрдВ рдХреЛ рд╕рдореЗрдЯрддреЗ рд╣реИрдВред  рдореИрдВ рдкреНрд░рд╛рдердорд┐рдХ рд╕рдВрдЪрд╛рд▓рди рдпрд╛ рдЪрд░рдгреЛрдВ рдХреЗ рдХреБрдЫ рд╕рд╛рд░реНрдердХ рдЕрдиреБрдХреНрд░рдо рдХрд╛ рдЬрд┐рдХреНрд░ рдХрд░рддреЗ рд╣реБрдП "рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рдкреНрд░рд╡рд╛рд╣" рдХреЛ рдХрд╣реВрдВрдЧрд╛ред  рдЕрд░реНрдердкреВрд░реНрдгрддрд╛ рдЙрд╕ рд╕рдВрджрд░реНрдн рд╕реЗ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХреА рдЬрд╛рдПрдЧреА рдЬрд┐рд╕рдореЗрдВ рдореИрдВ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рдкреНрд░рд╡рд╛рд╣ рдХреА рдмрд╛рдд рдХрд░рддрд╛ рд╣реВрдВред  рдпрд╣реА рд╣реИ, рдЕрдЧрд░ рд╣рдо рдПрдХрд▓-рдереНрд░реЗрдбреЗрдб рдПрд▓реНрдЧреЛрд░рд┐рдереНрдо (рдЕрд╣реЛ-рдХреЛрд░рд╕рд┐рдХ, рдЧреНрд░рд╛рдлрд╝ рдЦреЛрдЬ) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдПрд▓реНрдЧреЛрд░рд┐рдереНрдо рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдирд┐рд╖реНрдкрд╛рджрди рдХрд╛ рдПрдХ рдзрд╛рдЧрд╛ рд╣реИред  рд╡рд╣ рд╕рдорд╕реНрдпрд╛ рдХреЗ рд╕рдорд╛рдзрд╛рди рдХреЗ рд▓рд┐рдП рдХреБрдЫ рдХрджрдо рдЙрдард╛рддрд╛ рд╣реИред </p><br><p>  рдЕрдЧрд░ рдореИрдВ рдПрдХ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░ рд░рд╣рд╛ рд╣реВрдВ, рддреЛ рдПрдХ рдЖрдиреЗ рд╡рд╛рд▓реЗ рдЕрдиреБрд░реЛрдз рдХреА рд╕реЗрд╡рд╛ рдХреЗ рд▓рд┐рдП рдирд┐рд╖реНрдкрд╛рджрди рдХрд╛ рдПрдХ рдзрд╛рдЧрд╛ рдбреЗрдЯрд╛рдмреЗрд╕ рджреНрд╡рд╛рд░рд╛ рдХрд┐рдП рдЧрдП рдХрд╛рд░реНрдпреЛрдВ рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред  рд╡рд╣реА рд╡реЗрдм рд╕рд░реНрд╡рд░ рдХреЗ рд▓рд┐рдП рдЬрд╛рддрд╛ рд╣реИред  рдпрджрд┐ рдореИрдВ рдХрд┐рд╕реА рдкреНрд░рдХрд╛рд░ рдХрд╛ рдореЛрдмрд╛рдЗрд▓ рдпрд╛ рд╡реЗрдм рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд▓рд┐рдЦ рд░рд╣рд╛ рд╣реВрдВ, рддреЛ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдСрдкрд░реЗрд╢рди рдХреЛ рд╕реЗрд╡рд╛ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рдирд╛, рдиреЗрдЯрд╡рд░реНрдХ рдЗрдВрдЯрд░реИрдХреНрд╢рди, рд╕реНрдерд╛рдиреАрдп рднрдВрдбрд╛рд░рдг рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд, рдФрд░ рдЗрд╕реА рддрд░рд╣ред  рдореЗрд░реЗ рдореЛрдмрд╛рдЗрд▓ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ рдЗрди рдХрд╛рд░реНрдпреЛрдВ рдХрд╛ рдЕрдиреБрдХреНрд░рдо рдирд┐рд╖реНрдкрд╛рджрди рдХрд╛ рдПрдХ рдЕрд▓рдЧ рд╕рд╛рд░реНрдердХ рдкреНрд░рд╡рд╛рд╣ рднреА рд╣реЛрдЧрд╛ред  рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ, рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдпрд╛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдзрд╛рдЧрд╛ рднреА рдирд┐рд╖реНрдкрд╛рджрди рдХрд╛ рдПрдХ рд╕рд╛рд░реНрдердХ рдзрд╛рдЧрд╛ рд╣реИред </p><br><a name="section3-2"></a><br><h2 id="32-mnogozadachnost-i-parallelizm">  3.2ред  рдорд▓реНрдЯреАрдЯрд╛рд╕реНрдХрд┐рдВрдЧ рдФрд░ рдХрдВрд╕рд░реНрдЯ </h2><br><p>  рдЙрддреНрдкрд╛рджрдХрддрд╛ рдХреА рдЖрдзрд╛рд░рд╢рд┐рд▓рд╛ рдЗрд╕ рддрд░рд╣ рдХреА рдЪрд╛рд▓ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реИ: рдЬрдм рдореЗрд░реЗ рдкрд╛рд╕ рдирд┐рд╖реНрдкрд╛рджрди рдХрд╛ рдПрдХ рдзрд╛рдЧрд╛ рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдЗрд╕рдХреЗ рднреМрддрд┐рдХ рд╕рдордп рд╕реНрдХреИрди рдореЗрдВ voids рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдЗрди voids рдХреЛ рдХреБрдЫ рдЙрдкрдпреЛрдЧреА рдХреЗ рд╕рд╛рде рднрд░реЗрдВ - рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рдЕрдиреНрдп рдереНрд░реЗрдбреНрд╕ рдХреЗ рдЪрд░рдгреЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВред </p><br><p><img src="https://habrastorage.org/webt/vw/x1/si/vwx1sijti5ahggnjozkymza2hna.png"></p><br><p>  рдбреЗрдЯрд╛рдмреЗрд╕ рдЖрдорддреМрд░ рдкрд░ рдПрдХ рд╣реА рд╕рдордп рдореЗрдВ рдХрдИ рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреА рд╕реЗрд╡рд╛ рдХрд░рддреЗ рд╣реИрдВред  рдпрджрд┐ рд╣рдо рдЙрдЪреНрдЪ рд╕реНрддрд░ рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рдПрдХ рдзрд╛рдЧреЗ рдХреЗ рдврд╛рдВрдЪреЗ рдХреЗ рднреАрддрд░ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рдХрдИ рдереНрд░реЗрдбреНрд╕ рдкрд░ рдХрд╛рдо рдХреЛ рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЗрд╕реЗ рдорд▓реНрдЯреАрдЯрд╛рд╕реНрдХрд┐рдВрдЧ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред  рдпрд╣реА рд╣реИ, рдорд▓реНрдЯреАрдЯрд╛рд╕реНрдХрд┐рдВрдЧ рд╣реИ рдЬрдм рдореИрдВ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рдПрдХ рдмрдбрд╝реЗ рдкреНрд░рд╡рд╛рд╣ рдХреЗ рдврд╛рдВрдЪреЗ рдХреЗ рднреАрддрд░ рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реВрдВ рдЬреЛ рдЫреЛрдЯреЗ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд╕рдорд╛рдзрд╛рди рдХреЗ рдЕрдзреАрдирд╕реНрде рд╣реИрдВред </p><br><p>  рдпрд╣ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХрд┐ рд╕рдорд╛рдирддрд╛ рдХреЗ рд╕рд╛рде рдорд▓реНрдЯреАрдЯрд╛рд╕реНрдХрд┐рдВрдЧ рдХреА рдЕрд╡рдзрд╛рд░рдгрд╛ рдХреЛ рднреНрд░рдорд┐рдд рди рдХрд░реЗрдВред  рдХрдВрдЬреЗрдВрд╕реА <br>  рдпреЗ рд░рдирдЯрд╛рдЗрдо рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рдЧреБрдг рд╣реИрдВ, рдЬреЛ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд╡рд┐рднрд┐рдиреНрди рдереНрд░реЗрдбреНрд╕ рдореЗрдВ рдкреНрд░рдЧрддрд┐ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдПрдХ рдЪрд░рдг рдореЗрдВ рдПрдХ рд╕рдордп рдореЗрдВ рд╕рдВрднрд╡ рдмрдирд╛рддрд╛ рд╣реИред  рдЕрдЧрд░ рдореЗрд░реЗ рдкрд╛рд╕ рджреЛ рднреМрддрд┐рдХ рдкреНрд░реЛрд╕реЗрд╕рд░ рд╣реИрдВ, рддреЛ рдПрдХ рдШрдбрд╝реА рдЪрдХреНрд░ рдореЗрдВ рд╡реЗ рджреЛ рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдпрджрд┐ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдПрдХ рдкреНрд░реЛрд╕реЗрд╕рд░ рдкрд░ рдЪрд▓ рд░рд╣рд╛ рд╣реИ, рддреЛ рдпрд╣ рджреЛ рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рджреЛ рдШрдбрд╝реА рдЪрдХреНрд░ рд▓реЗрдЧрд╛ред </p><br><p><img src="https://habrastorage.org/webt/nq/n5/yf/nqn5yf1pee8kwgi3rw1lxmnyomi.png"></p><br><p>  рдпрд╣ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХрд┐ рдЗрди рдЕрд╡рдзрд╛рд░рдгрд╛рдУрдВ рдХреЛ рднреНрд░рдорд┐рдд рди рдХрд░реЗрдВ, рдХреНрдпреЛрдВрдХрд┐ рд╡реЗ рд╡рд┐рднрд┐рдиреНрди рд╢реНрд░реЗрдгрд┐рдпреЛрдВ рдореЗрдВ рдЖрддреЗ рд╣реИрдВред  рдорд▓реНрдЯреАрдЯрд╛рд╕реНрдХрд┐рдВрдЧ рдЖрдкрдХреЗ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреА рдПрдХ рд╡рд┐рд╢реЗрд╖рддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдЖрдВрддрд░рд┐рдХ рд░реВрдк рд╕реЗ рд╡рд┐рднрд┐рдиреНрди рдХрд╛рд░реНрдпреЛрдВ рдкрд░ рдПрдХ рдЪрд░ рдХрд╛рдо рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдВрд░рдЪрд┐рдд рд╣реИред  Concurrency рд░рдирдЯрд╛рдЗрдо рд╡рд╛рддрд╛рд╡рд░рдг рдХреА рдПрдХ рд╕рдВрдкрддреНрддрд┐ рд╣реИ рдЬреЛ рдЖрдкрдХреЛ рдПрдХ рдШрдбрд╝реА рдЪрдХреНрд░ рдореЗрдВ рдХрдИ рдХрд╛рд░реНрдпреЛрдВ рдкрд░ рдХрд╛рдо рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдмрдирд╛рддреА рд╣реИред </p><br><p>  рдХрдИ рдорд╛рдпрдиреЛрдВ рдореЗрдВ, рдПрд╕рд┐рдВрдХреНрд░реЛрдирд╕ рдХреЛрдб рдФрд░ рдПрд╕рд┐рдВрдХреНрд░реЛрдирд╕ рдХреЛрдб рд▓рд┐рдЦрдирд╛ рдорд▓реНрдЯреАрдЯрд╛рд╕реНрдХрд┐рдВрдЧ рдХреЛрдб рд▓рд┐рдЦ рд░рд╣рд╛ рд╣реИред  рдореБрдЦреНрдп рдХрдард┐рдирд╛рдИ рдпрд╣ рд╣реИ рдХрд┐ рдореИрдВ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдХреИрд╕реЗ рд▓рд╛рдЧреВ рдХрд░реВрдВ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдХреИрд╕реЗ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░реВрдВред  рдЗрд╕рд▓рд┐рдП, рдЖрдЬ рд╣рдо рдЗрд╕ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░реЗрдВрдЧреЗ - рдорд▓реНрдЯреАрдЯрд╛рд╕реНрдХрд┐рдВрдЧ рдХреЛрдб рд▓рд┐рдЦрдирд╛ред </p><br><a name="section4"></a><br><h1 id="4-blokirovanie-i-ozhidanie">  4. рдЕрд╡рд░реБрджреНрдз рдФрд░ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░рдирд╛ </h1><br><p><img src="https://habrastorage.org/getpro/habr/post_images/da7/042/897/da7042897d750697821baf6381db92ea.png"></p><br><p>  рдЖрдЗрдП рдХреБрдЫ рд╕рд░рд▓ рдЙрджрд╛рд╣рд░рдг рд╕реЗ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВред  рд╡рд╛рдкрд╕ рдкрд┐рдВрдЧ-рдкреЛрдВрдЧ: </p><br><pre> <code class="cpp hljs">socket s; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> x; x = read_from_socket(s, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == <span class="hljs-string"><span class="hljs-string">"ping"</span></span>) { write_to_socket(s, <span class="hljs-string"><span class="hljs-string">"pong"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  рдЬреИрд╕рд╛ рдХрд┐ рд╣рдордиреЗ рдкрд╣рд▓реЗ рд╣реА рдЪрд░реНрдЪрд╛ рдХреА рд╣реИ, рдкрдврд╝рдиреЗ рдФрд░ рд╕рдлреЗрдж рд▓рд╛рдЗрдиреЛрдВ рдХреЗ рдмрд╛рдж рдирд┐рд╖реНрдкрд╛рджрди рдХрд╛ рдзрд╛рдЧрд╛ рд╕реЛ рдЬрд╛рддрд╛ рд╣реИ, рдпрд╣ рдЕрд╡рд░реБрджреНрдз рд╣реИред  рдЖрдорддреМрд░ рдкрд░ рд╣рдо рдХрд╣рддреЗ рд╣реИрдВ, "рдкреНрд░рд╡рд╛рд╣ рдЕрд╡рд░реБрджреНрдз рд╣реИред" </p><br><pre> <code class="cpp hljs">socket s; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> x; x = read_from_socket(s, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* thread is blocked here */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == <span class="hljs-string"><span class="hljs-string">"ping"</span></span>) { write_to_socket(s, <span class="hljs-string"><span class="hljs-string">"pong"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* thread is blocked here */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдирд┐рд╖реНрдкрд╛рджрди рдХрд╛ рдкреНрд░рд╡рд╛рд╣ рдПрдХ рдРрд╕реЗ рдмрд┐рдВрджреБ рдкрд░ рдкрд╣реБрдВрдЪ рдЧрдпрд╛ рд╣реИ рдЬрд╣рд╛рдВ рдХрд┐рд╕реА рднреА рдШрдЯрдирд╛ рдХреЛ рдЬрд╛рд░реА рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИред  рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рд╣рдорд╛рд░реЗ рдиреЗрдЯрд╡рд░реНрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдпрд╣ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдХрд┐ рдбреЗрдЯрд╛ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдкрд╣реБрдВрдЪреЗ рдпрд╛ рдЗрд╕рдХреЗ рд╡рд┐рдкрд░реАрдд, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдбреЗрдЯрд╛ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдирд┐рд╢реБрд▓реНрдХ рдмрдлрд░ рд╣реИред  рдШрдЯрдирд╛рдПрдБ рдЕрд▓рдЧ рд╣реЛ рд╕рдХрддреА рд╣реИрдВред  рдпрджрд┐ рд╣рдо рд╕рдордп рдХреЗ рдкрд╣рд▓реБрдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рд╣рдо рдЯрд╛рдЗрдорд░ рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рдпрд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдкреВрд░рд╛ рд╣реЛрдиреЗ рдХрд╛ рдЗрдВрддрдЬрд╛рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдпрд╣рд╛рдВ рдХреА рдШрдЯрдирд╛рдПрдВ рдПрдХ рдкреНрд░рдХрд╛рд░ рдХреА рдЕрдореВрд░реНрдд рдЪреАрдЬ рд╣реИрдВ, рдЙрдирдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдпрд╣ рд╕рдордЭрдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХрд┐ рдЙрдирд╕реЗ рдЙрдореНрдореАрдж рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c91/02f/7ca/c9102f7ca66291666b9df9c05ce7f46e.png"></p><br><p>  рдЬрдм рд╣рдо рд╕рд░рд▓ рдХреЛрдб рд▓рд┐рдЦрддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдПрдХ рдЙрдЪреНрдЪ рд╕реНрддрд░ рдкрд░ рдШрдЯрдирд╛ рдХреА рдЕрдкреЗрдХреНрд╖рд╛ рдХрд╛ рдирд┐рдпрдВрддреНрд░рдг рджреЗрддреЗ рд╣реИрдВред  рд╣рдорд╛рд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдоред  рд╡рд╣, рдПрдХ рдЙрдЪреНрдЪ рд╕реНрддрд░ рдХреА рдЗрдХрд╛рдИ рдХреЗ рд░реВрдк рдореЗрдВ, рдпрд╣ рдЪреБрдирдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд╝рд┐рдореНрдореЗрджрд╛рд░ рд╣реИ рдХрд┐ рдЖрдЧреЗ рдХреМрди рд╕рд╛ рдХрд╛рд░реНрдп рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдФрд░ рд╡рд╣ рдШрдЯрдирд╛рдУрдВ рдХреА рдШрдЯрдирд╛ рдХреЛ рдЯреНрд░реИрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рднреА рдЬрд╝рд┐рдореНрдореЗрджрд╛рд░ рд╣реИред </p><br><p>  рд╣рдорд╛рд░рд╛ рдХреЛрдб, рдЬрд┐рд╕реЗ рд╣рдо рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЗ рд░реВрдк рдореЗрдВ рд▓рд┐рдЦрддреЗ рд╣реИрдВ, рдПрдХ рд╣реА рд╕рдордп рдореЗрдВ рдПрдХ рдХрд╛рд░реНрдп рдкрд░ рдХрд╛рдо рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕рдВрд░рдЪрд┐рдд рд╣реИред  рдЙрджрд╛рд╣рд░рдг рд╕реЗ рдХреЛрдб рд╕реНрдирд┐рдкреЗрдЯ рдПрдХ рдХрдиреЗрдХреНрд╢рди рдХреЛ рд╕рдВрднрд╛рд▓рддрд╛ рд╣реИ: рдпрд╣ рдПрдХ рдХрдиреЗрдХреНрд╢рди рд╕реЗ рдкрд┐рдВрдЧ рдкрдврд╝рддрд╛ рд╣реИ рдФрд░ рдПрдХ рдХрдиреЗрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдкреЛрдВрдЧ рд▓рд┐рдЦрддрд╛ рд╣реИред </p><br><p>  рдХреЛрдб рд╕реНрдкрд╖реНрдЯ рд╣реИред  рдЖрдк рдЗрд╕реЗ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕рдордЭ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдпрд╣ рдХреНрдпрд╛ рдХрд░рддрд╛ рд╣реИ, рдпрд╣ рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рдпрд╣ рдХрд┐рд╕ рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рдХреЗ рдкрд╛рд╕ рдХреНрдпрд╛ рд╣реИ, рдФрд░ рдЗрд╕рдХреЗ рд▓рд┐рдП рдХреНрдпрд╛ рд╣реИ  рдЙрд╕реА рд╕рдордп, рд╣рдо рдЗрд╕ рддрд░рд╣ рдХреЗ рдореЙрдбрд▓ рдореЗрдВ рдХрд╛рд░реНрдп рдпреЛрдЬрдирд╛ рдХрд╛ рдмрд╣реБрдд рдЦрд░рд╛рдм рдкреНрд░рдмрдВрдзрди рдХрд░рддреЗ рд╣реИрдВред  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдкреНрд░рд╛рдердорд┐рдХрддрд╛рдУрдВ рдХреА рдЕрд╡рдзрд╛рд░рдгрд╛рдПрдВ рд╣реЛрддреА рд╣реИрдВ, рд▓реЗрдХрд┐рди рдпрджрд┐ рдЖрдкрдиреЗ рд╕реЙрдлреНрдЯ рд░рд┐рдпрд▓-рдЯрд╛рдЗрдо рд╕рд┐рд╕реНрдЯрдо рд▓рд┐рдЦрд╛ рд╣реИ, рддреЛ рдЖрдк рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рд▓рд┐рдирдХреНрд╕ рдореЗрдВ рдЙрдкрд▓рдмреНрдз рдЙрдкрдХрд░рдг рдкрд░реНрдпрд╛рдкреНрдд рд╕рдордЭрджрд╛рд░ рд░рд┐рдпрд▓-рдЯрд╛рдЗрдо рд╕рд┐рд╕реНрдЯрдо рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рдирд╣реАрдВ рд╣реИрдВред </p><br><p>  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдПрдХ рдЬрдЯрд┐рд▓ рдЪреАрдЬ рд╣реИ, рдФрд░ рдХрд░реНрдиреЗрд▓ рдХреЗ рд▓рд┐рдП рд╣рдорд╛рд░реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕реЗ рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рд╕рдВрджрд░реНрдн рдореЗрдВ рдХреБрдЫ рдорд╛рдЗрдХреНрд░реЛрд╕реЗрдХрдВрдб рдЦрд░реНрдЪ рд╣реЛрддреЗ рд╣реИрдВ, рдЬреЛ рдХреБрдЫ рд╕рд░рд▓ рдЧрдгрдирд╛рдУрдВ рдХреЗ рд╕рд╛рде, рд╣рдореЗрдВ рдкреНрд░рддрд┐ рд╕реЗрдХрдВрдб рд▓рдЧрднрдЧ 20-100 рд╣рдЬрд╛рд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХрд╛ рдЕрдиреБрдорд╛рди рджреЗрддрд╛ рд╣реИред  рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЕрдЧрд░ рд╣рдо рдПрдХ рд╡реЗрдм рд╕рд░реНрд╡рд░ рд▓рд┐рдЦрддреЗ рд╣реИрдВ, рддреЛ рдПрдХ рд╕реЗрдХрдВрдб рдореЗрдВ рд╣рдо рд▓рдЧрднрдЧ 20 рд╣рдЬрд╛рд░ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдпрд╣ рдорд╛рдирддреЗ рд╣реБрдП рдХрд┐ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдЕрдиреБрд░реЛрдз рд╕рд┐рд╕реНрдЯрдо рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рджрд╕ рдЧреБрдирд╛ рдЕрдзрд┐рдХ рдорд╣рдВрдЧрд╛ рд╣реИред </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c12/68f/503/c1268f5037154f9f0f5ac5bc82dfc531.png"></p><br><a name="section4-1"></a><br><h2 id="41-neblokiruyuschee-ozhidanie">  4.1ред  рдЧреИрд░-рдЕрд╡рд░реБрджреНрдз рдкреНрд░рддреАрдХреНрд╖рд╛ </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ffe/97f/c42/ffe97fc42eca8beb2dae841358b31b8e.png"></p><br><p>  рдпрджрд┐ рдЖрдк рдРрд╕реА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдЖрддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреЛ рдиреЗрдЯрд╡рд░реНрдХ рдХреЗ рд╕рд╛рде рдЕрдзрд┐рдХ рдХреБрд╢рд▓рддрд╛ рд╕реЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рддреЛ рдЖрдк рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рдорджрдж рдХреА рддрд▓рд╛рд╢ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдЪреБрдирд┐рдВрджрд╛ / рдПрдкреЛрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрддреЗ рд╣реИрдВред  рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рд▓рд┐рдЦрд╛ рд╣реИ рдХрд┐ рдпрджрд┐ рдЖрдк рдПрдХ рд╣реА рд╕рдордп рдореЗрдВ рд╣рдЬрд╛рд░реЛрдВ рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХреА рд╕реЗрд╡рд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ рдПрдкреЛрд▓ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдПрдХ рдЕрдЪреНрдЫрд╛ рддрдВрддреНрд░ рд╣реИ рдФрд░ рдЗрд╕реА рддрд░рд╣ред  рдЖрдк рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдЦреЛрд▓рддреЗ рд╣реИрдВ рдФрд░ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рджреЗрдЦрддреЗ рд╣реИрдВ: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">select</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nfds, fd_set* readfds, fd_set* writefds, fd_set* exceptfds, struct timeval* timeout)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_CLR</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">  </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_ISSET</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_SET</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_ZERO</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">epoll_ctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> epfd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> op, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, struct epoll_event* event)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">epoll_wait</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> epfd, struct epoll_event* events, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maxevents, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout)</span></span></span></span>;</code> </pre> <br><p>  рдРрд╕реЗ рдХрд╛рд░реНрдп рдЬрд┐рдирдореЗрдВ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдореЗрдВ рдмрд╣реБрдд рд╕рд╛рд░реЗ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рд╣реЛрддреЗ рд╣реИрдВ, рдЬрд┐рдирдХреЗ рд╕рд╛рде рдЖрдк рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ (рдЪрдпрди рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ), рдпрд╛ рдмрд╣реБрдд рд╕рд╛рд░реА рдШрдЯрдирд╛рдУрдВ рдХреЛ рдкрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ <br>  рдЖрдкрдХреЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреА рд╕реАрдорд╛рдУрдВ рдХреЗ рдкрд╛рд░, рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рдХрд░реНрдиреЗрд▓ рдЬрд┐рд╕реЗ рдЖрдкрдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ (рдПрдкреЛрд▓ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ)ред </p><br><p>  рдпрд╣ рдЬреЛрдбрд╝рдиреЗ рдпреЛрдЧреНрдп рднреА рд╣реИ рдХрд┐ рдЖрдк рдЪрдпрди рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ / рдПрдкреЛрд▓ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдПрдХ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдЬреИрд╕реЗ рдХрд┐ рд▓рд┐рдмрд╡реВ, рдЬрд┐рд╕рдореЗрдВ рдПрдкреАрдЖрдИ рдореЗрдВ рдХреЛрдИ рдШрдЯрдирд╛ рдирд╣реАрдВ рд╣реЛрдЧреА, рд▓реЗрдХрд┐рди рдХрдИ рдХреЙрд▓рдмреИрдХ рд╣реЛрдВрдЧреЗред  рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХрд╣реЗрдЧрд╛: "рдкреНрд░рд┐рдп рдорд┐рддреНрд░, рд╕реЙрдХреЗрдЯ рдХреЛ рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдХреЙрд▓рдмреИрдХ рдкреНрд░рджрд╛рди рдХрд░реЗрдВ, рдЬрд┐рд╕реЗ рдореИрдВ рдбреЗрдЯрд╛ рджрд┐рдЦрд╛рдИ рджреЗрдиреЗ рдкрд░ рдХреЙрд▓ рдХрд░реВрдВрдЧрд╛ред" </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_timer_start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_timer_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* handle, uv_timer_cb cb, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> repeat)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*uv_timer_cb)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_timer_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* handle)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_read_start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* stream, uv_alloc_cb alloc_cb, uv_read_cb read_cb)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_read_stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">*)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*uv_read_cb)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* stream, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ssize_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nread, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_buf_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* buf)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_write_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* handle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_buf_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bufs[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nbufs, uv_write_cb cb)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*uv_write_cb)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_write_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> status)</span></span></span></span>;</code> </pre> <br><p>  рдкрд┐рдЫрд▓реЗ рдЕрдзреНрдпрд╛рдп рдореЗрдВ рд╣рдорд╛рд░реЗ рддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ рдХреЛрдб рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдХреНрдпрд╛ рдмрджрд▓рд╛рд╡ рдЖрдпрд╛ рд╣реИ?  рдХреЛрдб рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ рд╣реЛ рдЧрдпрд╛ рд╣реИред  рдЗрд╕рдХрд╛ рдорддрд▓рдм рдпрд╣ рд╣реИ рдХрд┐ рд╣рдордиреЗ рдШрдЯрдирд╛рдУрдВ рдХреЛ рдореЙрдирд┐рдЯрд░ рдХрд░рдиреЗ рдХреЗ рд╕рдордп рдореЗрдВ рдмрд┐рдВрджреБ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рддрд░реНрдХ рдХреЛ рдЖрд╡реЗрджрди рдореЗрдВ рд▓рд┐рдпрд╛ред  рд╕реНрдкрд╖реНрдЯ рдЪрдпрди / рдПрдкреЛрд▓ рдХреЙрд▓ рдРрд╕реЗ рдмрд┐рдВрджреБ рд╣реИрдВ рдЬрд╣рд╛рдВ рд╣рдо рдЙрди рдШрдЯрдирд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рд╕реЗ рдкреВрдЫрддреЗ рд╣реИрдВред  рд╣рдордиреЗ рдЕрдкрдиреЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛрдб рдореЗрдВ рдпрд╣ рднреА рдЪреБрдирд╛ рдХрд┐ рдХрд┐рд╕ рдХрд╛рд░реНрдп рдХреЛ рдЕрдЧрд▓реЗ рдкрд░ рдХрд╛рдо рдХрд░рдирд╛ рд╣реИред </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/458/28b/5f2/45828b5f2463ec94abf292e8a5db86bf.png"></p><br><p>  рдЗрдВрдЯрд░рдлреЗрд╕ рдХреЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рд╕реЗ, рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдорд▓реНрдЯреАрдЯрд╛рд╕реНрдХрд┐рдВрдЧ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдореВрд▓ рд░реВрдк рд╕реЗ рджреЛ рддрдВрддреНрд░ рд╣реИрдВред  рдПрдХ рдкреНрд░рдХрд╛рд░ рдХрд╛ "рдкреБрд▓" рдЬрдм рд╣рдо <br>  рд╣рдо рдЙрди рдХрдИ рдШрдЯрдирд╛рдУрдВ рдХреЛ рдмрд╛рд╣рд░ рдирд┐рдХрд╛рд▓рддреЗ рд╣реИрдВ, рдЬрд┐рдирдХреА рд╣рдо рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рдФрд░ рдлрд┐рд░ рд╣рдо рдХрд┐рд╕реА рддрд░рд╣ рдЙрди рдкрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХрд░рддреЗ рд╣реИрдВред  рдЗрд╕ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдореЗрдВ, рдУрд╡рд░рд╣реЗрдб рдХреЛ рдПрдХ рдХрд░рдХреЗ рдкрд░рд┐рд╢реЛрдзрди рдХрд░рдирд╛ рдЖрд╕рд╛рди рд╣реИ <br>  рдПрдХ рдШрдЯрдирд╛ рдФрд░ рдЗрд╕рд▓рд┐рдП рд╣реЛрдиреЗ рд╡рд╛рд▓реА рдШрдЯрдирд╛рдУрдВ рдХреЗ рд╕реЗрдЯ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕рдВрдЪрд╛рд░ рдореЗрдВ рдЙрдЪреНрдЪ рдереНрд░реВрдкреБрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВред  рдЖрдорддреМрд░ рдкрд░, рд╕рднреА рдиреЗрдЯрд╡рд░реНрдХ рддрддреНрд╡ рдЬреИрд╕реЗ рдХрд┐ рдХрд░реНрдиреЗрд▓ рдХрд╛ рдиреЗрдЯрд╡рд░реНрдХ рдХрд╛рд░реНрдб рдХреЗ рд╕рд╛рде рд╕рдВрдкрд░реНрдХ рдпрд╛ рдЖрдкрдХреЗ рдФрд░ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рд╕рдВрдкрд░реНрдХ рдЪреБрдирд╛рд╡ рддрдВрддреНрд░ рдкрд░ рдирд┐рд░реНрдорд┐рдд рд╣реЛрддрд╛ рд╣реИред </p><br><p>  рджреВрд╕рд░рд╛ рддрд░реАрдХрд╛ рдПрдХ "рдзрдХреНрдХрд╛" рддрдВрддреНрд░ рд╣реИ, рдЬрдм рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рдмрд╛рд╣рд░реА рдЗрдХрд╛рдИ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдЖрддреА рд╣реИ, рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рдкреНрд░рд╡рд╛рд╣ рдХреЛ рдмрд╛рдзрд┐рдд рдХрд░рддреА рд╣реИ рдФрд░ рдХрд╣рддреА рд╣реИ: "рдЕрдм, рдХреГрдкрдпрд╛ рдЙрд╕ рдШрдЯрдирд╛ рдХреЛ рд╕рдВрднрд╛рд▓ рд▓реЗрдВ рдЬреЛ рдЕрднреА рдЖрдпрд╛ рд╣реИред"  рдпрд╣ рдХреЙрд▓рдмреИрдХ рдХреЗ рд╕рд╛рде рдПрдХ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╣реИ, рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЗ рд╕реНрддрд░ рдкрд░ рд░реБрдХрд╛рд╡рдЯреЛрдВ рдХреЗ рд╕рд╛рде, рдпреВрдирд┐рдХреНрд╕ рд╕рдВрдХреЗрддреЛрдВ рдХреЗ рд╕рд╛рде, рдЬрдм рдХреЛрдИ рдмрд╛рд╣рд░реА рдЗрдХрд╛рдИ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдЖрдкрдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рдзрд╛рдЧреЗ рдкрд░ рд╣рдорд▓рд╛ рдХрд░рддреА рд╣реИ рдФрд░ рдХрд╣рддреА рд╣реИ: "рдЕрдм, рдХреГрдкрдпрд╛, рд╣рдо рдЗрд╕ рдШрдЯрдирд╛ рдкрд░ рдХрд╛рдо рдХрд░ рд░рд╣реЗ рд╣реИрдВред"  рдХрд┐рд╕реА рдШрдЯрдирд╛ рдХреА рдШрдЯрдирд╛ рдФрд░ рдЙрд╕ рдкрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЗ рдмреАрдЪ рджреЗрд░реА рдХреЛ рдХрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдкреНрд░рдХрдЯ рд╣реБрдЖ рд╣реИред </p><br><p>  рд╣рдо C ++ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЛ рдХреНрдпреЛрдВ рд▓рд┐рдЦрддреЗ рд╣реИрдВ рдЬреЛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рд▓рд┐рдЦрддреЗ рд╣реИрдВ рдФрд░ рд╣рд▓ рдХрд░рддреЗ рд╣реИрдВ, рд╡реЗ рд╢рд╛рдпрдж рд╣рдорд╛рд░реЗ рдХреЛрдб рдореЗрдВ рдПрдХ рдЗрд╡реЗрдВрдЯ рдореЙрдбрд▓ рдХреЛ рдЦреАрдВрдЪрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?  рдпрджрд┐ рд╣рдо рдЕрдкрдиреЗ рдХреЛрдб рдореЗрдВ рдХрдИ рдХрд╛рд░реНрдпреЛрдВ рдкрд░ рдХрд╛рдо рдХреЛ рдЦреАрдВрдЪрддреЗ рдФрд░ рдЫреЛрдбрд╝рддреЗ рд╣реИрдВ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдХрд░реНрдиреЗрд▓ рдФрд░ рдЗрд╕рдХреЗ рд╡рд┐рдкрд░реАрдд рд╕рдВрдХреНрд░рдордг рдХреА рдХрдореА рдХреЗ рдХрд╛рд░рдг, рд╣рдо рдереЛрдбрд╝реА рддреЗрдЬреА рд╕реЗ рдХрд╛рдо рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕рдордп рдХреА рдкреНрд░рддрд┐ рдпреВрдирд┐рдЯ рдЕрдзрд┐рдХ рдЙрдкрдпреЛрдЧреА рдХреНрд░рд┐рдпрд╛рдПрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </p><br><p>  рд╣рдорд╛рд░реЗ рджреНрд╡рд╛рд░рд╛ рд▓рд┐рдЦреЗ рдЧрдП рдХреЛрдб рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рдпрд╣ рдХреНрдпрд╛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ?  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдЙрдЪреНрдЪ-рдкреНрд░рджрд░реНрд╢рди HTTP рд╕рд░реНрд╡рд░, nginx рдХреЛ рд▓реЗрдВред  рдпрджрд┐ рдЖрдк рдЗрд╕рдХрд╛ рдХреЛрдб рдкрдврд╝рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдПрдХ рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ рдореЙрдбрд▓ рдкрд░ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред  рдХреЛрдб рдХреЛ рдкрдврд╝рдирд╛ рдмрд╣реБрдд рдХрдард┐рди рд╣реИред  рдЬрдм рдЖрдк рдЕрдкрдиреЗ рдЖрдк рд╕реЗ рдкреВрдЫрддреЗ рд╣реИрдВ рдХрд┐ рдПрдХ рд╣реА HTTP рдЕрдиреБрд░реЛрдз рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рддреЗ рд╕рдордп рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдХреНрдпрд╛ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдкрддрд╛ рдЪрд▓рддрд╛ рд╣реИ рдХрд┐ рдХреЛрдб рдореЗрдВ рдмрд╣реБрдд рд╕рд╛рд░реЗ рдЯреБрдХрдбрд╝реЗ рд╣реИрдВ, рдЕрд▓рдЧ-рдЕрд▓рдЧ рдлрд╛рдЗрд▓реЛрдВ рдореЗрдВ, рдХреЛрдб рдЖрдзрд╛рд░ рдХреЗ рд╡рд┐рднрд┐рдиреНрди рдХреЛрдгреЛрдВ рдкрд░ред  рдкреНрд░рддреНрдпреЗрдХ рдЯреБрдХрдбрд╝рд╛ рд╕рдВрдкреВрд░реНрдг HTTP рдЕрдиреБрд░реЛрдз рдХреА рд╕реЗрд╡рд╛ рдХреЗ рд╣рд┐рд╕реНрд╕реЗ рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХ рдЫреЛрдЯрд╛ рд╕рд╛ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ngx_http_request_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ngx_event_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ev)</span></span></span><span class="hljs-function"> </span></span>{ тАж <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c-&gt;close) { ngx_http_terminate_request(r, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ev-&gt;write) { r-&gt;write_event_handler(r); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { r-&gt;read_event_handler(r); } ... } <span class="hljs-comment"><span class="hljs-comment">/* where the handler... */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*ngx_http_event_handler_pt)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ngx_http_request_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *r)</span></span></span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ngx_http_request_s</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> ngx_http_event_handler_pt read_event_handler; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/* ...is set when switching to the next processing stage */</span></span> r-&gt;read_event_handler = ngx_http_request_empty_handler; r-&gt;read_event_handler = ngx_http_block_reading; r-&gt;read_event_handler = ngx_http_test_reading; r-&gt;read_event_handler = ngx_http_discarded_request_body_handler; r-&gt;read_event_handler = ngx_http_read_client_request_body_handler; r-&gt;read_event_handler = ngx_http_upstream_rd_check_broken_connection; r-&gt;read_event_handler = ngx_http_upstream_read_request_handler;</code> </pre> <br><p>  рдПрдХ рдЕрдиреБрд░реЛрдз рд╕рдВрд░рдЪрдирд╛ рд╣реИ, рдЬрд┐рд╕реЗ рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рдХреЗ рд▓рд┐рдП рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрдм рд╕реЙрдХреЗрдЯ рд╕рд┐рдЧреНрдирд▓ рдкрдврд╝рддрд╛ рд╣реИ рдпрд╛ рдкрд╣реБрдВрдЪ рд▓рд┐рдЦрддрд╛ рд╣реИред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрд╣ рд╣реИрдВрдбрд▓рд░ рд▓рдЧрд╛рддрд╛рд░ рдЕрдиреБрд░реЛрдз рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдХреА рд╕реНрдерд┐рддрд┐ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреЗ рдкрд╛рдареНрдпрдХреНрд░рдо рдореЗрдВ рд╕реНрд╡рд┐рдЪ рдХрд░рддрд╛ рд╣реИред  рдпрд╛ рддреЛ рд╣рдо рд╣реЗрдбрд░ рдкрдврд╝рддреЗ рд╣реИрдВ, рдпрд╛ рд╣рдо рдЕрдиреБрд░реЛрдз рдХреЗ рд╢рд░реАрд░ рдХреЛ рдкрдврд╝рддреЗ рд╣реИрдВ, рдпрд╛ рд╣рдо рдбреЗрдЯрд╛ рдХреЗ рд▓рд┐рдП рдКрдкрд░ рдХреА рдУрд░ рдкреВрдЫрддреЗ рд╣реИрдВ - рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдХрдИ рдЕрд▓рдЧ-рдЕрд▓рдЧ рд░рд╛рдЬреНрдп рд╣реИрдВред </p><br><p>  рдЗрд╕ рддрд░рд╣ рдХреЗ рдХреЛрдб рдХреЛ рдкрдврд╝рдирд╛ рдореБрд╢реНрдХрд┐рд▓ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣, рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ, рдШрдЯрдирд╛рдУрдВ рдХреА рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рд╡рд░реНрдгрд┐рдд рд╣реИред  рд╣рдо рдРрд╕реА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рд╣реИрдВ рдФрд░ рдЖрдиреЗ рд╡рд╛рд▓реА рдШрдЯрдирд╛рдУрдВ рдкрд░ рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рддрд░реАрдХреЗ рд╕реЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХрд░рддреЗ рд╣реИрдВред  HTTP рдЕрдиреБрд░реЛрдз рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рдХреА рд╕рдВрдкреВрд░реНрдг рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рд╕рдордЧреНрд░ рддрд╕реНрд╡реАрд░ рдХрд╛ рдЕрднрд╛рд╡ рд╣реИред </p><br><p>  рдПрдХ рдЕрдиреНрдп рд╡рд┐рдХрд▓реНрдк, рдЬрд┐рд╕реЗ рдЕрдХреНрд╕рд░ рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдХреЙрд▓рдмреИрдХ-рдЖрдзрд╛рд░рд┐рдд рдХреЛрдб рдХрд╛ рдирд┐рд░реНрдорд╛рдг рдХрд░рдирд╛ рд╣реИ рдЬрдм рд╣рдо рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЙрд▓ рдкрд░ рдЕрдкрдиреЗ рдХреЙрд▓рдмреИрдХ рдХреЛ рдЖрдЧреЗ рдмрдврд╝рд╛рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдореЗрдВ рдПрдХ рдШрдЯрдирд╛ рдХреЗ рд▓рд┐рдП рдЖрдорддреМрд░ рдкрд░ рдХреБрдЫ рдЕрдиреНрдп рдиреЗрд╕реНрдЯреЗрдб рдХреЙрд▓рдмреИрдХ рд╣реЛрддреЗ рд╣реИрдВ, рдФрд░ рдЗрд╕реА рддрд░рд╣ред </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LibuvStreamWrap::ReadStart() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> uv_read_start(stream(), [](<span class="hljs-keyword"><span class="hljs-keyword">uv_handle_t</span></span>* handle, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> suggested_size, <span class="hljs-keyword"><span class="hljs-keyword">uv_buf_t</span></span>* buf) { <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;LibuvStreamWrap*&gt;(handle-&gt;data)-&gt;OnUvAlloc(suggested_size, buf); }, [](<span class="hljs-keyword"><span class="hljs-keyword">uv_stream_t</span></span>* stream, <span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span> nread, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uv_buf_t</span></span>* buf) { <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;LibuvStreamWrap*&gt;(stream-&gt;data)-&gt;OnUvRead(nread, buf); }); } <span class="hljs-comment"><span class="hljs-comment">/* ...for example, parsing http... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (p=data; p != data + len; p++) { ch = *p; reexecute: <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (CURRENT_STATE()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_start_req_or_res: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_or_resp_H: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_HT: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_HTT: <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_HTTP: <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_http_major: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_http_dot: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span></code> </pre> <br><p>  рдХреЛрдб рдлрд┐рд░ рд╕реЗ рдмрд╣реБрдд рд╣реА рд╡рд┐рдЦрдВрдбрд┐рдд рд╣реИ, рдЕрдиреБрд░реЛрдз рдкрд░ рд╣рдо рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ, рдЗрд╕рдХреА рд╡рд░реНрддрдорд╛рди рд╕реНрдерд┐рддрд┐ рдХреА рдХреЛрдИ рд╕рдордЭ рдирд╣реАрдВ рд╣реИред  рдмрд╣реБрдд рд╕рд╛рд░реА рдЬрд╛рдирдХрд╛рд░реА рдХреНрд▓реЛрдЬрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░реЗрд╖рд┐рдд рдХреА рдЬрд╛рддреА рд╣реИ, рдФрд░ рдЖрдкрдХреЛ рдПрдХрд▓ рдЕрдиреБрд░реЛрдз рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рддрд░реНрдХ рдХреЛ рдлрд┐рд░ рд╕реЗ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдорд╛рдирд╕рд┐рдХ рдкреНрд░рдпрд╛рд╕ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред </p><br><p>  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рд╣рдорд╛рд░реЗ рдХреЛрдб рдореЗрдВ рдорд▓реНрдЯреАрдЯрд╛рд╕реНрдХрд┐рдВрдЧ (рдХрд╛рд░реНрдп рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдЪреБрдирдиреЗ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдмрд╣реБрд╕рдВрдХреЗрддрди рдХрд░рдиреЗ рдХрд╛ рддрд░реНрдХ) рдХрд╛ рдкрд░рд┐рдЪрдп рджреЗрддреЗ рд╣реБрдП, рд╣рдореЗрдВ рдкреНрд░рднрд╛рд╡реА рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рдорд┐рд▓рддреА рд╣реИ рдФрд░ рдХрд╛рд░реНрдп рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рдкрд░ рдирд┐рдпрдВрддреНрд░рдг рд╣реЛрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд╣рдо рдкрдардиреАрдпрддрд╛ рдореЗрдВ рдЙрдирдореЗрдВ рд╕реЗ рдмрд╣реБрдд рдХреБрдЫ рдЦреЛ рджреЗрддреЗ рд╣реИрдВред  рдЗрд╕ рдХреЛрдб рдХреЛ рдкрдврд╝рдирд╛ рдореБрд╢реНрдХрд┐рд▓ рд╣реИ рдФрд░ рдЗрд╕реЗ рдмрдирд╛рдП рд░рдЦрдирд╛ рдореБрд╢реНрдХрд┐рд▓ рд╣реИред </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/da5/a8a/151/da5a8a1517fb18945a330ae4c2b6d722.png"></p><br><p>  рдХреНрдпреЛрдВ?  рдорд╛рди рд▓реАрдЬрд┐рдП рдореЗрд░реЗ рдкрд╛рд╕ рдПрдХ рд╕рд╛рдзрд╛рд░рдг рдорд╛рдорд▓рд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдкрдврд╝реА рдФрд░ рдЗрд╕реЗ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░ рджрд┐рдпрд╛ред  рдПрдХ рдЧреИрд░-рдЕрд╡рд░реБрджреНрдз рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ, рдпрд╣ рдорд╛рдорд▓рд╛ рдЗрд╕ рддрд░рд╣ рдХреЗ рдПрдХ рд░реИрдЦрд┐рдХ рд░рд╛рдЬреНрдп рдорд╢реАрди рдХреЗ рдЕрдиреБрд░реВрдк рд╣реЛрдЧрд╛: </p><br><ul><li>  рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдЕрд╡рд╕реНрдерд╛ </li><li>  рдлрд╝рд╛рдЗрд▓ рдкрдврд╝рдирд╛ рдкреНрд░рд╛рд░рдВрдн рдХрд░реЗрдВ, </li><li>  рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рд╕реЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░ рд░рд╣рд╛ рд╣реИ, </li><li>  рд╕реЙрдХреЗрдЯ рдореЗрдВ рдлрд╝рд╛рдЗрд▓ рд▓рд┐рдЦрдирд╛, </li><li>  рдЕрдВрддрд┐рдо рд╕реНрдерд┐рддрд┐ред </li></ul><br><p>  рдЕрдм, рдорд╛рди рд▓реАрдЬрд┐рдП рдХрд┐ рдореИрдВ рдЗрд╕ рдлрд╛рдЗрд▓ рдореЗрдВ рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдЬрд╛рдирдХрд╛рд░реА рдЬреЛрдбрд╝рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВред  рдПрдХ рд╕рд░рд▓ рд╡рд┐рдХрд▓реНрдк: </p><br><ul><li>  рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдЕрд╡рд╕реНрдерд╛ </li><li>  рдПрдХ рдлрд╝рд╛рдЗрд▓ рдкрдврд╝рдирд╛ </li><li>  рдлрд╝рд╛рдЗрд▓ рдкрдврд╝реЗрдВ </li><li>  рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдкрдврд╝рдирд╛ </li><li>  рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдкрдврд╝реЗрдВ, </li><li>  рдореИрдВ рдПрдХ рд╕реЙрдХреЗрдЯ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддрд╛ рд╣реВрдВ </li><li>  рд╕реЙрдХреЗрдЯ рдХреЗ рд▓рд┐рдП рд▓рд┐рдЦрд╛ рд╣реИред </li></ul><br><p>  рдпрд╣ рдПрдХ рд░реИрдЦрд┐рдХ рдХреЛрдб рдХреА рддрд░рд╣ рд▓рдЧрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд░рд╛рдЬреНрдпреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рд╡реГрджреНрдзрд┐ рд╣реБрдИ рд╣реИред </p><br><p>  рдлрд┐рд░ рдЖрдк рдпрд╣ рд╕реЛрдЪрдирд╛ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рджреЛ рдЪрд░рдгреЛрдВ рдХреЛ рд╕рдорд╛рдирд╛рдВрддрд░ рдХрд░рдирд╛ рдЕрдЪреНрдЫрд╛ рд╣реЛрдЧрд╛ - рдПрдХ рдлрд╝рд╛рдЗрд▓ рд╕реЗ рдФрд░ рдПрдХ рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдкрдврд╝рдирд╛ред  рдХреЙрдореНрдмрд┐рдиреЗрдЯрд░рд┐рдХреНрд╕ рдХреЗ рдЪрдорддреНрдХрд╛рд░ рд╢реБрд░реВ рд╣реЛрддреЗ рд╣реИрдВ: рдЖрдк рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдЕрд╡рд╕реНрдерд╛ рдореЗрдВ рд╣реИрдВ, рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдлрд╝рд╛рдЗрд▓ рдФрд░ рдбреЗрдЯрд╛ рдкрдврд╝рдиреЗ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рддреЗ рд╣реИрдВред  рдлрд┐рд░ рдЖрдк рдпрд╛ рддреЛ рдРрд╕реА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдЖ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд╣рд╛рдВ рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдбреЗрдЯрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдХреЛрдИ рдлрд╝рд╛рдЗрд▓ рдирд╣реАрдВ рд╣реИ, рдпрд╛ рдЗрд╕рдХреЗ рд╡рд┐рдкрд░реАрдд - рдлрд╝рд╛рдЗрд▓ рд╕реЗ рдбреЗрдЯрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдирд╣реАрдВред  рдЕрдЧрд▓рд╛, рдЖрдкрдХреЛ рдПрдХ рдРрд╕реА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдЬрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рдЖрдкрдХреЗ рдкрд╛рд╕ рджреЛ рдЪреАрдЬреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИред  рдлрд┐рд░, рдпреЗ рджреЛ рд░рд╛рдЬреНрдп рд╣реИрдВред  рдлрд┐рд░ рдЖрдкрдХреЛ рдЙрд╕ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдЬрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рдЖрдкрдХреЗ рдкрд╛рд╕ рджреЛрдиреЛрдВ рд╕рд╛рдордЧреНрд░реА рд╣реИрдВред  рдлрд┐рд░ рдЙрдиреНрд╣реЗрдВ рд╕реЙрдХреЗрдЯ рдЖрджрд┐ рдкрд░ рд▓рд┐рдЦреЗрдВред </p><br><p>  рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рдЕрдиреБрдкреНрд░рдпреЛрдЧ, рдЕрдзрд┐рдХ рд░рд╛рдЬреНрдп, рдЕрдзрд┐рдХ рдХреЛрдб рдХреЗ рдЯреБрдХрдбрд╝реЗ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдкрдХреЗ рд╕рд┐рд░ рдореЗрдВ рд╕рдВрдпреЛрдЬрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдЕрд╕рд╣рдЬред  рдпрд╛ рдЖрдк рдХреЙрд▓рдмреИрдХ рдиреВрдбрд▓реНрд╕ рд▓рд┐рдЦ рд░рд╣реЗ рд╣реИрдВ, рдЬрд┐рд╕реЗ рдкрдврд╝рдирд╛ рдЕрд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╣реИред  рдпрджрд┐ рдПрдХ рдмреНрд░рд╛рдВрдЪрд┐рдВрдЧ рдкреНрд░рдгрд╛рд▓реА рд▓рд┐рдЦреА рдЬрд╛рддреА рд╣реИ, рддреЛ рдПрдХ рджрд┐рди рдРрд╕рд╛ рд╕рдордп рдЖрддрд╛ рд╣реИ рдЬрдм рдЖрдк рдЗрд╕реЗ рдмрд░реНрджрд╛рд╢реНрдд рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред </p><br><a name="section5"></a><br><h1 id="5-futurespromises">  5. рд╡рд╛рдпрджрд╛ / рд╡рд╛рджрд╛ </h1><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f93/0ea/b0a/f930eab0a9a5556b0db5d21f23d98190.png"></p><br><p>  рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рд╕реНрдерд┐рддрд┐ рдХреЛ рдЖрд╕рд╛рди рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </p><br><p><img src="https://habrastorage.org/webt/-v/6e/gb/-v6egbslm8_jjhwcsevjffbe35s.png"></p><br><p>  рдПрдХ рдХрд╛рд░реНрдпрдХреНрд░рдо рд╣реИ, рдЗрд╕рдореЗрдВ рдХрд╛рд▓реЗ рдФрд░ рд▓рд╛рд▓ рдШреЗрд░реЗ рд╣реИрдВред  рдирд┐рд╖реНрдкрд╛рджрди рдХрд╛ рд╣рдорд╛рд░рд╛ рдкреНрд░рд╡рд╛рд╣ рдХрд╛рд▓реЗ рдШреЗрд░реЗ рд╣реИрдВ;  рдХрднреА-рдХрднреА рд╡реЗ рд▓рд╛рд▓ рд░рдВрдЧ рдХреЗ рд╕рд╛рде рд╡реИрдХрд▓реНрдкрд┐рдХ рд╣реЛрддреЗ рд╣реИрдВ рдЬрдм рдзрд╛рд░рд╛ рдЕрдкрдирд╛ рдХрд╛рдо рдЬрд╛рд░реА рдирд╣реАрдВ рд░рдЦ рд╕рдХрддреАред  рд╕рдорд╕реНрдпрд╛ рдпрд╣ рд╣реИ рдХрд┐ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд╣рдорд╛рд░реЗ рдХрд╛рд▓реЗ рдзрд╛рдЧреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдЕрдЧрд▓реЗ рдХрд╛рд▓реЗ рдШреЗрд░реЗ рдореЗрдВ рдЬрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдЬреЛ рдХрдм рдкрддрд╛ рдирд╣реАрдВ рдЪрд▓реЗрдЧрд╛ред </p><br><p>  рд╕рдорд╕реНрдпрд╛ рдпрд╣ рд╣реИ рдХрд┐ рдЬрдм рд╣рдо рдПрдХ рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рднрд╛рд╖рд╛ рдореЗрдВ рдХреЛрдб рд▓рд┐рдЦрддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рдХрдВрдкреНрдпреВрдЯрд░ рдХреЛ рд╕рдордЭрд╛рддреЗ рд╣реИрдВ рдХрд┐ рдЕрднреА рдХреНрдпрд╛ рдХрд░рдирд╛ рд╣реИред  рдПрдХ рдХрдВрдкреНрдпреВрдЯрд░ рдПрдХ рдЕрдкреЗрдХреНрд╖рд╛рдХреГрдд рд╕рд░рд▓ рдЪреАрдЬ рд╣реИ рдЬреЛ рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреА рдЕрдкреЗрдХреНрд╖рд╛ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рд╣рдо рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рднрд╛рд╖рд╛ рдореЗрдВ рд▓рд┐рдЦрддреЗ рд╣реИрдВред  рд╡рд╣ рдЕрдЧрд▓реЗ рд╕рд░реНрдХрд▓ рдкрд░ рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХрд╛ рдЗрдВрддрдЬрд╛рд░ рдХрд░ рд░рд╣реА рд╣реИ, рдФрд░ рд╣рдорд╛рд░реА рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рднрд╛рд╖рд╛ рдореЗрдВ рдпрд╣ рдХрд╣рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рдкреИрд╕рд╛ рдирд╣реАрдВ рд╣реИ: "рднрд╡рд┐рд╖реНрдп рдореЗрдВ, рдХреГрдкрдпрд╛, рдЬрдм рдХреБрдЫ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдХреБрдЫ рдХрд░реЗрдВред" </p><br><p><img src="https://habrastorage.org/webt/vp/8f/mx/vp8fmxhtnkukhqym-baw3g4mzyg.png"></p><br><p>  рдПрдХ рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рднрд╛рд╖рд╛ рдореЗрдВ, рд╣рдо рд╕рдордЭрдиреЗ рдпреЛрдЧреНрдп рдХреНрд╖рдгрд┐рдХ рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ: рдПрдХ рдлрд╝рдВрдХреНрд╢рди, рдЕрдВрдХрдЧрдгрд┐рддреАрдп рд╕рдВрдЪрд╛рд▓рди рдЖрджрд┐ред  рд╡реЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЕрдЧрд▓реЗ рдЪрд░рдг рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддреЗ рд╣реИрдВред  рдЙрд╕реА рд╕рдордп, рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд▓реЙрдЬрд┐рдХ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЕрдЧрд▓реЗ рднреМрддрд┐рдХ рдХрджрдо рдХрд╛ рд╡рд░реНрдгрди рдирд╣реАрдВ рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ, рд▓реЗрдХрд┐рди рдЕрдЧрд▓рд╛ рддрд╛рд░реНрдХрд┐рдХ рдХрджрдо: рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдбреЗрдЯрд╛ рдкреНрд░рдХрдЯ рд╣реЛрдиреЗ рдкрд░ рд╣рдореЗрдВ рдХреНрдпрд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдПред </p><br><p><img src="https://habrastorage.org/webt/6m/by/ma/6mbyma_pagz74dx-j2ch1ixpxpg.png"></p><br><p>  рдЗрд╕рд▓рд┐рдП, рд╣рдореЗрдВ рдХреБрдЫ рддрдВрддреНрд░реЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ рдЗрди рдЯреБрдХрдбрд╝реЛрдВ рдХреЛ рдХреИрд╕реЗ рд╕рдВрдпреЛрдЬрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПред  рдорд╛рдорд▓реЗ рдореЗрдВ рдЬрдм рд╣рдордиреЗ рд╕рд┐рдВрдХреНрд░реЛрдирд╕ рдХреЛрдб рд▓рд┐рдЦрд╛ рдерд╛, рддреЛ рд╣рдордиреЗ рдкреНрд░рд╢реНрди рдХреЛ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╣реБрдб рдХреЗ рдиреАрдЪреЗ рдЫрд┐рдкрд╛ рджрд┐рдпрд╛ рдФрд░ рдХрд╣рд╛ рдХрд┐ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдЗрд╕рд╕реЗ рдирд┐рдкрдЯреЗрдЧрд╛, рдЗрд╕рдиреЗ рд╣рдорд╛рд░реЗ рдереНрд░реЗрдбреНрд╕ рдХреЛ рдмрд╛рдзрд┐рдд рдФрд░ рдкреБрдирд░реНрдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреАред </p><br><p>  рд╕реНрддрд░ 1 рдореЗрдВ, рд╣рдордиреЗ рдЗрд╕ рдкреЗрдВрдбреЛрд░рд╛ рдХреЗ рдмреЙрдХреНрд╕ рдХреЛ рдЦреЛрд▓рд╛, рдФрд░ рдпрд╣ рдХреЛрдб рдореЗрдВ рдмрд╣реБрдд рд╕рд╛рд░реЗ рд╕реНрд╡рд┐рдЪ, рдХреЗрд╕, рд╢рд░реНрддреЛрдВ, рд╢рд╛рдЦрд╛рдУрдВ, рд░рд╛рдЬреНрдпреЛрдВ рдХреЛ рд▓рд╛рдпрд╛ред  рдореИрдВ рдХреБрдЫ рд╕рдордЭреМрддрд╛ рдХрд░рдирд╛ рдЪрд╛рд╣реВрдВрдЧрд╛ рддрд╛рдХрд┐ рдХреЛрдб рдЕрдкреЗрдХреНрд╖рд╛рдХреГрдд рдкрдардиреАрдп рд╣реЛ, рд▓реЗрдХрд┐рди рд╕реНрддрд░ 1 рдХреЗ рд╕рднреА рдлрд╛рдпрджреЗ рдмрд░рдХрд░рд╛рд░ рд░рд╣реЗред </p><br><p>  рд╕реМрднрд╛рдЧреНрдп рд╕реЗ рд╣рдорд╛рд░реЗ рд▓рд┐рдП, 1988 рдореЗрдВ рд╡рд┐рддрд░рд┐рдд рдкреНрд░рдгрд╛рд▓рд┐рдпреЛрдВ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд▓реЛрдЧ, рдмрд╛рд░рдмрд░рд╛ рд▓рд┐рд╕реНрдХреЙрд╡ рдФрд░ рд▓реБрдмрд╛ рд╢рд┐рд░рд┐рд░, рдиреЗ рд╕рдорд╕реНрдпрд╛ рдХрд╛ рдПрд╣рд╕рд╛рд╕ рдХрд┐рдпрд╛, рдФрд░ рднрд╛рд╖рд╛рдИ рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЗ рд▓рд┐рдП рдЖрдПред  рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рднрд╛рд╖рд╛ рдореЗрдВ рдирд┐рд░реНрдорд╛рдгреЛрдВ рдХреЛ рдЬреЛрдбрд╝рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдЬреЛ рдШрдЯрдирд╛рдУрдВ рдХреЗ рдмреАрдЪ рдЕрд╕реНрдерд╛рдпреА рд╕рдВрдмрдВрдзреЛрдВ рдХреЛ рд╡реНрдпрдХреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ - рд╡рд░реНрддрдорд╛рди рд╕рдордп рдореЗрдВ рдФрд░ рднрд╡рд┐рд╖реНрдп рдореЗрдВ рдЕрдирд┐рд╢реНрдЪрд┐рдд рдХреНрд╖рдг рдореЗрдВред </p><br><p>  рдЗрдиреНрд╣реЗрдВ рдкреНрд░реЙрдорд┐рд╕ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред  рдЕрд╡рдзрд╛рд░рдгрд╛ рд╢рд╛рдВрдд рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдмреАрд╕ рд╕рд╛рд▓ рд╕реЗ рдПрдХ рд╢реЗрд▓реНрдл рдкрд░ рдзреВрд▓ рдЗрдХрдЯреНрдард╛ рдХрд░ рд░рд╣рд╛ рд╣реИред       тАФ  ,   Twitter,      Ruby on Rails  Scala,     ,  ,      ,      future  .     Your Server as a Function.   ,        . </p><br><p>   Scala,    , ++ ? </p><br><p>    ,   Future.      T c  :       ,  -    . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class"> &lt;T&gt;</span></span></code> </pre> <br><p>         ,    ,  ,     .   ,   ┬л┬╗,  ,      .     Future     ┬л┬╗,  Promise тАФ  ┬л┬╗.        ;  ,  JavaScript, Promise тАФ      ,   Java тАУ   Future. </p><br><p>   ,     .     ,       ,     boost::future ( std::future) тАФ      ,     . </p><br><a name="section5-1"></a><br><h2 id="51-interfeys-future--promise">  5.1ред  Future &amp; Promise </h2><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> T&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">T* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::function&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp;)&gt; cb)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Then</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">:</span></span>:function&lt;R(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Then</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">:</span></span>:function&lt;Future&lt;R&gt;(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f); }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MakeFuture</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">);</span></span></code> </pre> <br><p>  , ,  - ,      .  , ,      ,   . ,      ,       тАФ   ,   ,   .       Then,      . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Promise</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp; value)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TrySet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp; value)</span></span></span></span>; Future&lt;T&gt; ToFuture() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Promise</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NewPromise</span></span></span><span class="hljs-class">();</span></span></code> </pre> <br><p>   .      ,       .    ┬л, , ,      ┬╗. </p><br><a name="section5-2"></a><br><h2 id="52-kompoziciya-vychisleniy">  5.2ред   </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/676/e68/6b7/676e686b75c6875ba0a914567bc46839.png"></p><br><p>    ?  ,         .  Then тАФ  ,      . </p><br><p> ,      тАФ future --,     -  t тАФ       .    , ,   ,        f,  -     r. </p><br><p>          t     f.        ,  ,      r. </p><br><p>   :    t,      ,   r      .       : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">template</span></span></span><span class="hljs-class"> &lt;class R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt;:</span></span>:Then(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::function&lt;R(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;R&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> r = f(t); promise.Set(r); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); }</code> </pre> <br><p>  : </p><br><ul><li>  <code>Promise</code>  <code>R</code> , </li><li>    <code>Future&lt;T&gt;</code>    <code>t</code> , </li><li>   ,    <code>r = f(t)</code> , </li><li>  <code>r</code>   <code>Promise</code> , </li><li>      <code>Promise</code> . </li></ul><br><p>      <code>f</code> ,     <code>R</code> ,  <code>Future&lt;R&gt;</code> ,         <code>R</code> .  : </p><br><ul><li>          <code>T</code> , </li><li>  ,     <code>T</code> ,  ,      <code>R</code> , </li><li>     ,      <code>R</code> ,    ,        . </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">template</span></span></span><span class="hljs-class"> &lt;class R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt;:</span></span>:Then(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::function&lt;Future&lt;R&gt;(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;R&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> that = f(t); that.Subscribe([promise] (R r) { promise.Set(r); }); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); }</code> </pre> <br><p>        ,   -    t.        f,        r,    .    ,       ,   . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3c6/92f/064/3c692f06489d41c745a0d1b51085b278.png"></p><br><p>    ,    Then   : </p><br><ul><li>   <code>Promise</code> , </li><li>  <code>Subscribe</code>   -, </li><li>  <code>Promise</code> ,   <code>Future</code> . </li></ul><br><p>      ,       .    ,       ,    ,            . </p><br><p>     ,   ,          ,     -.   ,  ,   -,   Subscribe.       ,    ,   ,  -  .   ,    . </p><br><a name="section5-3"></a><br><h2 id="53-primery">  5.3ред  рдЙрджрд╛рд╣рд░рдг </h2><br><p>       AsyncComputeValue,      GPU,        .   Then,    ,        (2v+1) <sup>2</sup> . </p><br><pre> <code class="cpp hljs">Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; value = AsyncComputeValue(); <span class="hljs-comment"><span class="hljs-comment">//    value.Subscribe([] (int v) { std::cerr &lt;&lt; "Value is: " &lt;&lt; v &lt;&lt; std::endl; });</span></span></code> </pre> <br><p>      .  ,    :   (2v+1) <sup>2</sup>       .       ,            . </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//  (2v+1)^2 Future&lt;int&gt; anotherValue = value .Then([] (int v) { return 2 * v; }) .Then([] (int u) { return u + 1; }) .Then([] (int w) { return w * w; });</span></span></code> </pre> <br><p>     ,     ,       .       . </p><br><p>  .   :   ,       ;       ;       . </p><br><pre> <code class="cpp hljs">Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; GetDbKey(); Future&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; LoadDbValue(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> key); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; SendToMars(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> message); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; ExploreOuterSpace() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetDbKey() <span class="hljs-comment"><span class="hljs-comment">// Future&lt;int&gt; .Then(&amp;LoadDbValue) // Future&lt;string&gt; .Then(&amp;SendToMars); // Future&lt;void&gt; } ExploreOuterSpace().Subscribe( [] () { std::cout &lt;&lt; "Mission Complete!" &lt;&lt; std::endl; });</span></span></code> </pre> <br><p>         тАФ ExploreOuterSpace.           Then;    тАФ    тАФ    ,     .         ( ) .      . </p><br><a name="section5-4"></a><br><h2 id="54-any-kombinator">  5.4ред Any- </h2><br><p>  :     <code>Future</code>    ,       ,      . ,  ,          : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Any</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f2</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;T&gt;(); f1.Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { promise.TrySet(t); }); f2.Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { promise.TrySet(t); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); } <span class="hljs-comment"><span class="hljs-comment">//    </span></span></code> </pre> <br><p>   ,      Any-,      Future  :   ,   .      ,    ,  . </p><br><p>   ,  ,       ,     ,  ,    .      ┬л   DB1,    DB2,        тАФ  - ┬╗. </p><br><a name="section5-5"></a><br><h2 id="55-all-kombinator">  5.5ред All- </h2><br><p>    .                  ,       ,  ,     ( T1  T2),    T1  T2   ,        ,   . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T2</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;std::tuple&lt;T1, T2&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">All</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T1&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T2&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f2</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;T1, T2&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;T1, T2&gt; &gt;(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> counter = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::atomic&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; &gt;(<span class="hljs-number"><span class="hljs-number">2</span></span>); f1.Subscribe([promise, result, counter] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T1&amp; t1) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::get&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>&gt;(*result) = t1; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (--(*counter) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { promise.Set(*result)); } }); f2.Subscribe([promise, result, counter] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T2&amp; t2) { <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); } <span class="hljs-comment"><span class="hljs-comment">//    </span></span></code> </pre> <br><p>    nginx.   ,      ,        .     nginx    ┬л ┬╗, ┬л  ┬╗, ┬л    ┬╗   .  All-         ,     .      . </p><br><a name="section5-6"></a><br><h2 id="56-adaptaciya-obratnogo-vyzova"> 5.6.    </h2><br><p>   Future  Promises тАФ     legacy-,   .     callback-    ,     ,   :   Future,     ,   callback-  Future. </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   cb     void LegacyAsyncComputeStuff(std::function&lt;void(int)&gt; cb); //      Future Future&lt;int&gt; ModernAsyncComputeStuff() { auto promise = NewPromise&lt;int&gt;(); LegacyAsyncComputeStuff( [promise] (int value) { promise.Set(value); }); return promise.ToFuture(); }</span></span></code> </pre> <br><p> :      ,              Future  . </p><br><a name="section6"></a><br><h1 id="6-kak-sdelat-kod-chitaemee-s-pomoschyu-korutin"> 6.        </h1><br><p><img src="https://habrastorage.org/getpro/habr/post_images/19a/093/212/19a093212125673ff89cc4196c59583a.png"></p><br><p>   ,     ,     .  . </p><br><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-comment"><span class="hljs-comment">// req  2 :  QueryBackend   Reply GetRequest().Subscribe( [] (Request req) { auto rsp = QueryBackend(req) .Then(&amp;HandlePayload) .Then(Bind(&amp;Reply, req)); });</span></span></code> </pre> <br><p>      .    Request,   -   .  ,     .  ,   ,        ,    .  ,   -      . </p><br><p>  ,  ,     .  ?   тАФ  ,    request  payload,     тАФ  ,      . </p><br><p> ,   Java   Netty. ,      ,        .  ,        ,    . </p><br><p>      ,    GetRequest, QueryBackend, HandlePayload   Reply   ,     Future. </p><br><p>     ,   ,   Future   T тАФ   WaitFor. <br></p><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-comment"><span class="hljs-comment">// req  2 :  QueryBackend   Reply GetRequest().Subscribe( [] (Request req) { auto rsp = QueryBackend(req) .Then(&amp;HandlePayload) .Then(Bind(&amp;Reply, req)); });</span></span></code> </pre> <br><p>      : </p><br><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> req = WaitFor(GetRequest()); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pld = WaitFor(QueryBackend(req)); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> rsp = WaitFor(HandlePayload(pld)); WaitFor(Reply(req, rsp));</code> </pre> <br><p>   :    Future,    .    .         ,    .      . </p><br><p>     .                    .     -  0,     ,  , mutex+cvar  future.        .          ,     . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/99d/f77/3e4/99df773e4d1922427ab7dc98fde28b8f.png"></p><br><a name="section6-1"></a><br><h2 id="61-korutiny">  6.1ред  </h2><br><p>  ,        .        ,  ,     ,   ,    - ,   .     ,    <i>-</i> . </p><br><p>       тАФ ┬л┬╗      ,  ,    .       .     .  : boost::asio  boost::fiber. </p><br><p>         ,                .  рдпрд╣ рдХреИрд╕реЗ рдХрд░рдирд╛ рд╣реИ? </p><br><a name="section6-2"></a><br><h2 id="62-chernovik-realizacii-waitfor">  6.2ред   WaitFor </h2><br><p>   , , boost::context,        :  ,   ;  ,              .    x86/64       ,       ,         . </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      class MachineContext; //     from,    to void SwitchContext(MachineContext* from, MachineContext* to); //      тАУ boost::context //    // * x86_64-ASM (push...-movq(rsp,eip)-pop...-jmpq) // * makecontext/swapcontext // * setjmp/longjmp</span></span></code> </pre> <br><p>      ,       goto:    ,     ,        ,   . </p><br><p>      ,  -   .     Fiber тАФ   .       +Future.  ,      ,         Future,    . </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fiber</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> MachineContext context_; Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; future_; };</code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Scheduler</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Future&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; future)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; MachineContext loop_context_; Fiber* current_fiber_; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">deque</span></span>&lt;Fiber*&gt; run_queue_; };</code> </pre> <br><p>  Future   ,     ,    ,     .    :   Loop,      ,    ,   ,        ,    . </p><br><p>     WaitFor? </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">thread_local</span></span> Scheduler* ThisScheduler; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">) {</span></span> ThisScheduler-&gt;WaitFor(future.As&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt;()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> future.Get(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Scheduler::WaitFor(Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; future) { current_fiber_-&gt;future_ = future; SwitchContext(┬дt_fiber_-&gt;context_, &amp;loop_context_); }</code> </pre> <br><p>   :  ,   -   ,      ,      Future  void,        .           . </p><br><p>  <code>Future&lt;void&gt;</code>   ,     ,    -  . </p><br><p>   WaitFor    :   : ┬л     Fiber   Future┬╗,        ( )       . </p><br><p>  ,        : <br> <code>ThisScheduler-&gt;WaitFor</code>  <code>return future.Get()</code> ,         . </p><br><p>      ?  ,       Future,      . </p><br><a name="section6-3"></a><br><h2 id="63-kak-ustroen-cikl-planirovaniya">  6.3ред     </h2><br><p>   -  , ,    ,     -     ,    .    SwitchContext   ,    2 тАФ       . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Scheduler::Loop() { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// (1)     (= !) current_fiber_ = run_queue_.front(); run_queue_.pop_front(); SwitchContext(&amp;loop_context_, ┬дt_fiber_-&gt;context_); // (2) ,      //тАж</span></span></code> </pre> <br><p>   ?   ,   ,    ,     Future,       Future, ,     ,           . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Scheduler::Loop() { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// (1)     тАж // (2) ,      if (current_fiber_-&gt;future_) { current_fiber_-&gt;future_.Subscribe( [this, fiber = current_fiber_] { fiber-&gt;future_ = nullptr; run_queue_.push_back(fiber); }); } //тАж</span></span></code> </pre> <br><p>   ,      .       : </p><br><p>     WaitFor тАФ   . </p><br><p><img src="https://habrastorage.org/webt/_4/m8/ao/_4m8aoag2egfc2mzczah2xf6a9i.png"></p><br><p>    Switch-    . </p><br><p><img src="https://habrastorage.org/webt/sa/hg/kz/sahgkzqleux5-htiqo-58lb0gua.png"></p><br><p>     Future    (  ),   ,         .   -               Fiber. </p><br><p><img src="https://habrastorage.org/webt/hg/cm/gc/hgcmgclv5raicu_tlfywmw0yrpi.png"></p><br><p>   WaitFor     Future ,     - , Future  .     : </p><br><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> req = WaitFor( GetRequest()); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pld = WaitFor( QueryBackend(req)); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> rsp = WaitFor( HandlePayload(pld)); WaitFor( Reply(req, rsp));</code> </pre> <br><p>    ,    ,      ,   .         ,    ,    . </p><br><a name="section6-4"></a><br><h2 id="64-coroutine-ts">  6.4ред Coroutine TS </h2><br><p>    ?   тАФ .   Coroutine TS,        ,  WaitFor  CoroutineWait,    CoroutineTS тАФ  -  .     ,         - . ,    Waiter  Co,     ,    . </p><br><a name="section7"></a><br><h1 id="7-chto-poluchili"> 7.  ? </h1><br><p>   .           ,   ,    ,    .     ,       ,     ,    . </p><br><p>     тАФ  .    ,                  .       .     ,     . ,         ,        ,         ,      . </p><br><p>       -    ,        ,               .    ,  .      ,                ,          . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e02/3b7/924/e023b79240490a7b561152aa0972b3ac.png"></p><br><p>         ,   ?    ,     . </p><br><p>   .       ,     ,   ,  ,      .       .       ,     ,     ,    ,    . </p><br><p>    nginx,  ,  ,  ,       ,    .        ,     ,  ,    future  promises. </p><br><p>     ,       ,    ,     ,       ,      ,      ,      . </p><br><p>       futures, promises  actors.    .             ,    . </p><br><p> :      , ,   ,     .               ,    , ,      ,   .     ? ,   . </p><br><blockquote>  рд╡рд┐рдЬреНрдЮрд╛рдкрди рдХрд╛ рдорд┐рдирдЯред 19-20      C++ Russia 2019.      , , Grimm Rainer    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">┬лConcurrency and parallelism in C++17 and C++20/23┬╗</a> ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">   C++</a> .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="> </a> ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="> </a> .  ,         ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">-</a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi446562/">https://habr.com/ru/post/hi446562/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi446548/index.html">рд╡рд┐рдЬреНрдЮрд╛рдкрди рдЕрднрд┐рдпрд╛рдиреЛрдВ рдХреЗ рдЖрдВрдХрдбрд╝реЛрдВ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг - рдбреЗрдЯрд╛рдлрд╝реНрд░реЗрдо (рдЕрдЬрдЧрд░) рдореЗрдВ рдПрдХ рдирдИ рдореАрдЯреНрд░рд┐рдХ рдмрдирд╛рдПрдБ</a></li>
<li><a href="../hi446550/index.html">рд╕рдордиреНрд╡рдпрдХ рдкреИрдЯрд░реНрди рд╕рдорд╕реНрдпрд╛рдУрдВ рдФрд░ рдХреНрдпрд╛ рдХрд░рддрд╛ рд╣реИред рдЗрд╕рдХреЗ рд╕рд╛рде рдХреНрдпрд╛ рдХрд░рдирд╛ рд╣реИ</a></li>
<li><a href="../hi446554/index.html">рдпрд╛рдВрдбреЗрдХреНрд╕ рдирд┐рд╡рд╛рд╕реА рдХрд╛рд░реНрдпрдХреНрд░рдо, рдпрд╛ рдПрдХ рдЕрдиреБрднрд╡реА рдмреИрдХ-рдПрдВрдб рдХреИрд╕реЗ рдПрдордПрд▓-рдЗрдВрдЬреАрдирд┐рдпрд░ рдмрди рдЬрд╛рддрд╛ рд╣реИ</a></li>
<li><a href="../hi446558/index.html">рд╡рд┐рджреЗрд╢реА рдбреЗрдЯрд╛ рд╕рдВрд░рдЪрдирд╛рдПрдВ: рд╕рдВрд╢реЛрдзрд┐рдд рдорд░реНрдХрд▓ рдкреЗрдЯреНрд░реАрд╕рд┐рдпрд╛ рдЯреНрд░рд╛рдЗ</a></li>
<li><a href="../hi446560/index.html">"рд╕реМрдЬрдиреНрдп рдПрдХреНрд╕рдЪреЗрдВрдЬ": рджреЛ рд╕рдмрд╕реЗ рдкреНрд░рд╕рд┐рджреНрдз рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХрдВрдкрдирд┐рдпреЛрдВ рдХреЗ рдмреАрдЪ рд╕рдВрдШрд░реНрд╖ рдХрд╛ рд╕рд╛рд░</a></li>
<li><a href="../hi446566/index.html">рдкрд░рд┐рдпреЛрдЬрдирд╛ рд╢реВрдиреНрдпред рдЕрдореЗрдЬрди рдлреЗрдХ рд╕реЗ рдХреИрд╕реЗ рдирд┐рдкрдЯрдирд╛ рдЪрд╛рд╣рддреА рд╣реИ</a></li>
<li><a href="../hi446568/index.html">Umbraco 8 рдмрдбрд╝реЗ рдкреИрдорд╛рдиреЗ рдкрд░ CMS рдЕрдкрдбреЗрдЯ: рдирдпрд╛ рдХреНрдпрд╛ рд╣реИ</a></li>
<li><a href="../hi446570/index.html">рдкрд╣рд▓реЗ GPU рдХреА рдХрд╣рд╛рдиреА: рд░реЗрдВрдбрд░рд┐рд╢рди рд╡реЗрд░рд┐рдЯрд╛ 1000</a></li>
<li><a href="../hi446572/index.html">Editor.js рдПрдХ рдЙрддреНрдХреГрд╖реНрдЯ рд╕рдВрдкрд╛рджрдХ рд╣реИ рдЬреЛ JSON рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рд╕реНрд░реЛрдд рдХреЛрдб рдмрдЪрд╛рддрд╛ рд╣реИ</a></li>
<li><a href="../hi446576/index.html">рдЖрдпрд╛рдд рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрди, рдпрд╛ рдХреИрд╕реЗ рд░реВрд╕реА рд╣реЗрд▓рд┐рдХреЙрдкреНрдЯрд░реЛрдВ рдиреЗ рдХреБрдЫ рдЧрд▓рдд рдХрд┐рдпрд╛</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>