<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëßüèª ‚ÜïÔ∏è üõ∞Ô∏è Automatische Generierung und Bef√ºllung von Netzwerkger√§tekonfigurationselementen mit Nornir üë©üèø‚Äçü§ù‚Äçüë©üèæ üßìüèΩ üåº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo habr 


 K√ºrzlich ist hier ein Artikel von Mikrotik und Linux erschienen. Routine und Automatisierung, bei der ein √§hnliches Problem mit fossile...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Automatische Generierung und Bef√ºllung von Netzwerkger√§tekonfigurationselementen mit Nornir</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482194/"><p><img src="https://habrastorage.org/webt/7z/bp/zt/7zbpztvjkn5yfvxwcxudhj7hrja.png"></p><br><p>  Hallo habr </p><br><p>  K√ºrzlich ist hier ein Artikel von <a href="https//habr.com/en/post/480404/" rel="nofollow">Mikrotik und Linux erschienen.</a>  <a href="https//habr.com/en/post/480404/" rel="nofollow">Routine und Automatisierung,</a> bei der ein √§hnliches Problem mit fossilen Mitteln gel√∂st wurde.  Und obwohl die Aufgabe ganz typisch ist, gibt es bei Habr√© nichts Vergleichbares.  Ich wage es, mein Fahrrad der angesehenen IT-Community anzubieten. </p><a name="habracut"></a><br><p>  Dies ist nicht das erste Fahrrad f√ºr diese Aufgabe.  Die erste Option wurde vor einigen Jahren in Version 1.x.x implementiert.  Das Fahrrad wurde selten benutzt und daher st√§ndig verrostet.  In dem Sinne, dass die Aufgabe selbst nicht so h√§ufig auftritt wie aktualisierte Versionen von <em>Ansible</em> .  Und jedes Mal, wenn Sie gehen m√ºssen, wird die Kette fallen, das Rad wird herunterfallen.  Der erste Teil, die Generierung von Configs, funktioniert jedoch immer sehr √ºbersichtlich, da die Engine f√ºr <em>jinja2</em> schon lange etabliert <em>ist</em> .  Aber der zweite Teil - Configs rollen, brachte in der Regel √úberraschungen.  Und da ich die Konfiguration aus der Ferne auf Hunderte von Ger√§ten ausrollen muss, von denen einige Tausende von Kilometern entfernt sind, war es ein bisschen √§rgerlich, dieses Tool zu verwenden. </p><br><p>  Hier muss ich zugeben, dass meine Unsicherheit eher in der mangelnden Vertrautheit mit mir als in seinen M√§ngeln liegt.  Und das ist √ºbrigens ein wichtiger Punkt.  <em>ansible</em> ist eine v√∂llig eigenst√§ndige Wissensdom√§ne mit eigener DSL (Domain Specific Language), die auf einem verl√§sslichen Niveau gehalten werden muss.  Nun, der Moment, in dem sich <em>Ansible</em> recht schnell und ohne besondere R√ºcksicht auf die Abw√§rtskompatibilit√§t entwickelt, schafft kein zus√§tzliches Vertrauen. </p><br><p>  Daher wurde vor nicht allzu langer Zeit die zweite Version des Fahrrads implementiert.  Diesmal in <em>Python</em> oder besser gesagt in einem Framework, das in <em>Python</em> geschrieben wurde, und f√ºr <em>Python</em> namens <a href="https://nornir.readthedocs.io/" rel="nofollow">Nornir</a> </p><br><p>  Also - <em>Nornir</em> ist ein in <em>Python</em> und f√ºr <em>Python</em> geschriebenes Mikroframework, das f√ºr die Automatisierung vorgesehen ist.  Wie im Fall von <em>Ansible</em> ist hier zur L√∂sung von Problemen eine kompetente Datenaufbereitung erforderlich, d.h.  Inventar der Hosts und ihrer Parameter, aber die Skripte sind nicht auf einem separaten DSL geschrieben, sondern alle auf dem gleichen, nicht sehr alten, aber sehr guten Ton [und | ah]. </p><br><p>  Schauen wir uns das folgende Beispiel an. </p><br><p>  Ich habe ein Filialnetz mit mehreren Dutzend Niederlassungen im ganzen Land.  In jedem B√ºro gibt es einen WAN-Router, der mehrere Kommunikationskan√§le von verschiedenen Betreibern terminiert.  Das Routing-Protokoll ist BGP.  Es gibt zwei Arten von WAN-Routern: Cisco ISG oder Juniper SRX. </p><br><p>  Nun die Aufgabe: Es ist notwendig, ein dediziertes Subnetz f√ºr die Video√ºberwachung in einem separaten Port auf allen WAN-Routern des Filialnetzes zu konfigurieren - dieses Subnetz in BGP ank√ºndigen - die Geschwindigkeitsbegrenzung f√ºr den dedizierten Port konfigurieren. </p><br><p>  Zun√§chst m√ºssen wir einige Vorlagen vorbereiten, auf deren Grundlage Konfigurationen f√ºr Cisco und Juniper separat generiert werden.  Und es ist auch notwendig, Daten f√ºr jeden Punkt und Verbindungsparameter vorzubereiten, d.h.  dieses Inventar zu sammeln </p><br><p>  Fertigvorlage f√ºr Cisco: </p><br><pre><code class="bash hljs">$ cat templates/ios/base.j2 class-map match-all VIDEO_SURV match access-group 111 policy-map VIDEO_SURV class VIDEO_SURV police 1500000 conform-action transmit exceed-action drop interface {{ host.task_data.ifname }} description VIDEOSURV ip address 10.10.{{ host.task_data.ipsuffix }}.254 255.255.255.0 service-policy input VIDEO_SURV router bgp {{ host.task_data.asn }} network 10.40.{{ host.task_data.ipsuffix }}.0 mask 255.255.255.0 access-list 11 permit 10.10.{{ host.task_data.ipsuffix }}.0 0.0.0.255 access-list 111 permit ip 10.10.{{ host.task_data.ipsuffix }}.0 0.0.0.255 any</code> </pre> <br><p>  Vorlage f√ºr Juniper: </p><br><pre> <code class="bash hljs">$ cat templates/junos/base.j2 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces {{ host.task_data.ifname }} unit 0 description <span class="hljs-string"><span class="hljs-string">"Video surveillance"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces {{ host.task_data.ifname }} unit 0 family inet filter input <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>-in <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces {{ host.task_data.ifname }} unit 0 family inet address 10.10.{{ host.task_data.ipsuffix }}.254/24 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> policy-options policy-statement export2bgp term 1 from route-filter 10.10.{{ host.task_data.ipsuffix }}.0/24 exact <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security zones security-zone WAN interfaces {{ host.task_data.ifname }} <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1m <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding bandwidth-limit 1m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1m <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding burst-size-limit 187k <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1m <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> discard <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1.5m <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding bandwidth-limit 1500000 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1.5m <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding burst-size-limit 280k <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1.5m <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> discard <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall filter <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>-in term 1 <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> policer policer-1.5m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall filter <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>-in term 1 <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> count limiter</code> </pre> <br><p>  Vorlagen werden nat√ºrlich nicht von der Decke genommen.  Dies ist im Wesentlichen der Unterschied zwischen den Arbeitskonfigurationen - er wurde nach der L√∂sung der Aufgabe auf zwei spezifischen Routern verschiedener Modelle. </p><br><p>  Aus unseren Vorlagen geht hervor, dass zur L√∂sung des Problems zwei Parameter f√ºr Juniper und drei Parameter f√ºr Cisco ausreichen.  hier sind sie: </p><br><ul><li>  ifname </li><li>  ipsuffix </li><li>  asn </li></ul><br><p>  Jetzt m√ºssen wir diese Parameter f√ºr jedes Ger√§t einstellen, d.h.  mache das gleiche <em>Inventar</em> . </p><br><p>  F√ºr die <em>Inventarisierung</em> folgen wir eindeutig der Dokumentation zu <a href="https://nornir.readthedocs.io/en/latest/tutorials/intro/initializing_nornir.html" rel="nofollow">Initializing Nornir.</a> </p><br><p>  d.h. dasselbe Dateiskelett erstellen: </p><br><pre> <code class="bash hljs">. ‚îú‚îÄ‚îÄ config.yaml ‚îú‚îÄ‚îÄ inventory ‚îÇ ‚îú‚îÄ‚îÄ defaults.yaml ‚îÇ ‚îú‚îÄ‚îÄ groups.yaml ‚îÇ ‚îî‚îÄ‚îÄ hosts.yaml</code> </pre> <br><p>  Config.yaml-Datei - Standard-Konfigurationsdatei </p><br><pre> <code class="plaintext hljs">$ cat config.yaml --- core: num_workers: 10 inventory: plugin: nornir.plugins.inventory.simple.SimpleInventory options: host_file: "inventory/hosts.yaml" group_file: "inventory/groups.yaml" defaults_file: "inventory/defaults.yaml"</code> </pre> <br><p>  Wir werden die Hauptparameter in der Datei <em>hosts.yaml</em> , group (in meinem Fall usernames / passwords) in <em>groups.yaml angeben</em> , und wir werden in <em>defaults.yaml</em> nichts angeben, aber es m√ºssen drei Minuspunkte vorhanden sein, um anzuzeigen, dass dies eine <em>yaml-</em> Datei ist wenn auch leer. </p><br><p>  So sieht hosts.yaml aus: </p><br><pre> <code class="plaintext hljs">--- srx-test: hostname: srx-test groups: - juniper data: task_data: ifname: fe-0/0/2 ipsuffix: 111 cisco-test: hostname: cisco-test groups: - cisco data: task_data: ifname: GigabitEthernet0/1/1 ipsuffix: 222 asn: 65111</code> </pre> <br><p>  Und hier ist groups.yaml: </p><br><pre> <code class="plaintext hljs">--- cisco: platform: ios username: admin1 password: cisco1 juniper: platform: junos username: admin2 password: juniper2</code> </pre> <br><p>  Hier ist das <em>Inventar</em> f√ºr unsere Aufgabe.  W√§hrend der Initialisierung werden Parameter aus den Inventardateien dem <strong>InventoryElement-</strong> Objektmodell zugeordnet. </p><br><div class="spoiler">  <b class="spoiler_title">Unter dem Spoiler das InventoryElement-Modelldiagramm</b> <div class="spoiler_text"><pre> <code class="json hljs">print(json.dumps(InventoryElement.schema(), indent=<span class="hljs-number"><span class="hljs-number">4</span></span>)) { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"InventoryElement"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"hostname"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Hostname"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Port"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"integer"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Username"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Password"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"platform"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Platform"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"groups"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Groups"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"array"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"items"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Data"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default"</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"connection_options"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Connection_Options"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default"</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"additionalProperties"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"$ref"</span></span>: <span class="hljs-string"><span class="hljs-string">"#/definitions/ConnectionOptions"</span></span> } } }, <span class="hljs-attr"><span class="hljs-attr">"definitions"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"ConnectionOptions"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"ConnectionOptions"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"hostname"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Hostname"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Port"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"integer"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Username"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Password"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"platform"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Platform"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"extras"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Extras"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span> } } } } }</code> </pre> </div></div><br><p>  Dieses Modell sieht vor allem auf den ersten Blick etwas verwirrend aus.  Der interaktive Modus in <strong>ipython</strong> hilft sehr dabei, dies herauszufinden. </p><br><pre> <code class="bash hljs"> $ ipython3 Python 3.6.9 (default, Nov 7 2019, 10:44:02) Type <span class="hljs-string"><span class="hljs-string">'copyright'</span></span>, <span class="hljs-string"><span class="hljs-string">'credits'</span></span> or <span class="hljs-string"><span class="hljs-string">'license'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> more information IPython 7.1.1 -- An enhanced Interactive Python. Type <span class="hljs-string"><span class="hljs-string">'?'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>. In [1]: from nornir import InitNornir In [2]: nr = InitNornir(config_file=<span class="hljs-string"><span class="hljs-string">"config.yaml"</span></span>, dry_run=True) In [3]: nr.inventory.hosts Out[3]: {<span class="hljs-string"><span class="hljs-string">'srx-test'</span></span>: Host: srx-test, <span class="hljs-string"><span class="hljs-string">'cisco-test'</span></span>: Host: cisco-test} In [4]: nr.inventory.hosts[<span class="hljs-string"><span class="hljs-string">'srx-test'</span></span>].data Out[4]: {<span class="hljs-string"><span class="hljs-string">'task_data'</span></span>: {<span class="hljs-string"><span class="hljs-string">'ifname'</span></span>: <span class="hljs-string"><span class="hljs-string">'fe-0/0/2'</span></span>, <span class="hljs-string"><span class="hljs-string">'ipsuffix'</span></span>: 111}} In [5]: nr.inventory.hosts[<span class="hljs-string"><span class="hljs-string">'srx-test'</span></span>][<span class="hljs-string"><span class="hljs-string">'task_data'</span></span>] Out[5]: {<span class="hljs-string"><span class="hljs-string">'ifname'</span></span>: <span class="hljs-string"><span class="hljs-string">'fe-0/0/2'</span></span>, <span class="hljs-string"><span class="hljs-string">'ipsuffix'</span></span>: 111} In [6]: nr.inventory.hosts[<span class="hljs-string"><span class="hljs-string">'srx-test'</span></span>].platform Out[6]: <span class="hljs-string"><span class="hljs-string">'junos'</span></span></code> </pre><br><p>  Nun, lasst uns endlich zum Skript selbst √ºbergehen.  Es gibt nichts Besonderes f√ºr mich, auf das ich stolz sein kann.  Ich habe gerade das fertige Beispiel aus dem <a href="https://nornir.readthedocs.io/en/latest/tutorials/intro/grouping_tasks.html" rel="nofollow">Tutorial genommen</a> und es fast unver√§ndert verwendet.  So sieht das fertige Arbeitsskript aus: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> nornir <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> InitNornir <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> nornir.plugins.tasks <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> networking, text <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> nornir.plugins.functions.text <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> print_title, print_result <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">config_and_deploy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(task)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Transform inventory data to configuration via a template file r = task.run(task=text.template_file, name="Base Configuration", template="base.j2", path=f"templates/{task.host.platform}") # Save the compiled configuration into a host variable task.host["config"] = r.result # Save the compiled configuration into a file with open(f"configs/{task.host.hostname}", "w") as f: f.write(r.result) # Deploy that configuration to the device using NAPALM task.run(task=networking.napalm_configure, name="Loading Configuration on the device", replace=False, configuration=task.host["config"]) nr = InitNornir(config_file="config.yaml", dry_run=True) # set dry_run=False, cross your fingers and run again # run tasks result = nr.run(task=config_and_deploy) print_result(result)</span></span></code> </pre> <br><p>  Beachten Sie den Parameter <em>dry_run = True</em> in der Initialisierungszeile des Objekts <strong>nr</strong> . <br>  Hier wird genau wie in <em>Ansible</em> ein Testlauf durchgef√ºhrt, bei dem die Verbindung zum Router hergestellt wird, eine neue ge√§nderte Konfiguration vorbereitet wird, die dann vom Ger√§t validiert wird (dies ist jedoch nicht genau; es h√§ngt von der Unterst√ºtzung des Ger√§ts und der Treiberimplementierung in NAPALM ab), die neue Konfiguration wird jedoch nicht direkt angewendet .  F√ºr den Kampf m√ºssen Sie den Parameter <em>dry_run</em> entfernen oder seinen Wert in <em>False</em> √§ndern. </p><br><p>  Wenn das Skript ausgef√ºhrt wird, zeigt Nornir der Konsole detaillierte Protokolle an. </p><br><div class="spoiler">  <b class="spoiler_title">Unter dem Spoiler l√§uft der Abschluss des Kampfes auf zwei Testroutern:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">config_and_deploy*************************************************************** * cisco-test ** changed : True ******************************************* vvvv config_and_deploy ** changed : True vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv INFO ---- Base Configuration ** changed : True ------------------------------------- INFO class-map match-all VIDEO_SURV match access-group 111 policy-map VIDEO_SURV class VIDEO_SURV police 1500000 conform-action transmit exceed-action drop interface GigabitEthernet0/1/1 description VIDEOSURV ip address 10.10.222.254 255.255.255.0 service-policy input VIDEO_SURV router bgp 65001 network 10.10.222.0 mask 255.255.255.0 access-list 11 permit 10.10.222.0 0.0.0.255 access-list 111 permit ip 10.10.222.0 0.0.0.255 any ---- Loading Configuration on the device ** changed : True --------------------- INFO +class-map match-all VIDEO_SURV + match access-group 111 +policy-map VIDEO_SURV + class VIDEO_SURV +interface GigabitEthernet0/1/1 + description VIDEOSURV + ip address 10.10.222.254 255.255.255.0 + service-policy input VIDEO_SURV +router bgp 65001 + network 10.10.222.0 mask 255.255.255.0 +access-list 11 permit 10.10.222.0 0.0.0.255 +access-list 111 permit ip 10.10.222.0 0.0.0.255 any ^^^^ END config_and_deploy ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ * srx-test ** changed : True ******************************************* vvvv config_and_deploy ** changed : True vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv INFO ---- Base Configuration ** changed : True ------------------------------------- INFO set interfaces fe-0/0/2 unit 0 description "Video surveillance" set interfaces fe-0/0/2 unit 0 family inet filter input limit-in set interfaces fe-0/0/2 unit 0 family inet address 10.10.111.254/24 set policy-options policy-statement export2bgp term 1 from route-filter 10.10.111.0/24 exact set security zones security-zone WAN interfaces fe-0/0/2 set firewall policer policer-1m if-exceeding bandwidth-limit 1m set firewall policer policer-1m if-exceeding burst-size-limit 187k set firewall policer policer-1m then discard set firewall policer policer-1.5m if-exceeding bandwidth-limit 1500000 set firewall policer policer-1.5m if-exceeding burst-size-limit 280k set firewall policer policer-1.5m then discard set firewall filter limit-in term 1 then policer policer-1.5m set firewall filter limit-in term 1 then count limiter ---- Loading Configuration on the device ** changed : True --------------------- INFO [edit interfaces] + fe-0/0/2 { + unit 0 { + description "Video surveillance"; + family inet { + filter { + input limit-in; + } + address 10.10.111.254/24; + } + } + } [edit] + policy-options { + policy-statement export2bgp { + term 1 { + from { + route-filter 10.10.111.0/24 exact; + } + } + } + } [edit security zones] security-zone test-vpn { ... } + security-zone WAN { + interfaces { + fe-0/0/2.0; + } + } [edit] + firewall { + policer policer-1m { + if-exceeding { + bandwidth-limit 1m; + burst-size-limit 187k; + } + then discard; + } + policer policer-1.5m { + if-exceeding { + bandwidth-limit 1500000; + burst-size-limit 280k; + } + then discard; + } + filter limit-in { + term 1 { + then { + policer policer-1.5m; + count limiter; + } + } + } + } ^^^^ END config_and_deploy ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</code> </pre> </div></div><br><h3 id="pryachem-paroli-v-ansible_vault">  Passw√∂rter in ansible_vault verstecken </h3><br><p>  Am Anfang des Artikels bin <em>ich ein bisschen</em> auf <em>Ansible gesto√üen</em> , aber dort ist nicht alles so schlimm.  Ich mag ihren <strong>Tresor</strong> , der sensible Informationen versteckt.  Und wahrscheinlich ist vielen aufgefallen, dass wir alle Benutzernamen / Passw√∂rter f√ºr alle <em>Kampfrouter</em> in der Datei <em>groups.yaml</em> in offener Form <em>haben</em> .  Es ist nat√ºrlich h√§sslich.  Lassen Sie uns diese Daten mit <strong>Tresor</strong> sch√ºtzen. </p><br><p>  Wir √ºbertragen die Parameter von groups.yaml nach creds.yaml und verschl√ºsseln sie mit AES256 mit einem 20-stelligen Passwort: </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> inventory $ cat creds.yaml --- cisco: username: admin1 password: cisco1 juniper: username: admin2 password: juniper2 $ pwgen 20 -N 1 &gt; vault.passwd ansible-vault encrypt creds.yaml --vault-password-file vault.passwd Encryption successful $ cat creds.yaml <span class="hljs-variable"><span class="hljs-variable">$ANSIBLE_VAULT</span></span>;1.1;AES256 39656463353437333337356361633737383464383231366233386636333965306662323534626131 3964396534396333363939373539393662623164373539620a346565373439646436356438653965 39643266333639356564663961303535353364383163633232366138643132313530346661316533 6236306435613132610a656163653065633866626639613537326233653765353661613337393839 62376662303061353963383330323164633162386336643832376263343634356230613562643533 30363436343465306638653932366166306562393061323636636163373164613630643965636361 34343936323066393763323633336366366566393236613737326530346234393735306261363239 35663430623934323632616161636330353134393435396632663530373932383532316161353963 31393434653165613432326636616636383665316465623036376631313162646435</code> </pre> <br><p>  So einfach.  Es bleibt unserem <em>Nornir-</em> Skript beizubringen, diese Daten zu erhalten und zu verwenden. <br>  <em>F√ºgen</em> Sie dazu in unserem Skript nach der Initialisierungszeile <em>nr = InitNornir (config_file = ...</em> den folgenden Code hinzu: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">... </span></span>nr = InitNornir(config_file=<span class="hljs-string"><span class="hljs-string">"config.yaml"</span></span>, dry_run=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-comment"><span class="hljs-comment"># set dry_run=False, cross your fingers and run again # enrich Inventory with the encrypted vault data from ansible_vault import Vault vault_password_file="inventory/vault.passwd" vault_file="inventory/creds.yaml" with open(vault_password_file, "r") as fp: password = fp.readline().strip() vault = Vault(password) vaultdata = vault.load(open(vault_file).read()) for a in nr.inventory.hosts.keys(): item = nr.inventory.hosts[a] item.username = vaultdata[item.groups[0]]['username'] item.password = vaultdata[item.groups[0]]['password'] #print("hostname={}, username={}, password={}\n".format(item.hostname, item.username, item.password)) # run tasks ...</span></span></code> </pre> <br><p>  Nat√ºrlich sollte vault.passwd nicht wie in meinem Beispiel neben creds.yaml liegen.  Aber es zu spielen wird gen√ºgen. </p><br><p>  Das ist alles f√ºr jetzt.  Ein paar Artikel √ºber Cisco + Zabbix sind in Vorbereitung, aber hier geht es nicht um Automatisierung.  Und in naher Zukunft werde ich in Cisco √ºber RESTCONF schreiben. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de482194/">https://habr.com/ru/post/de482194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de482178/index.html">Die Geschichte eines koreanischen Studenten, der vom Ministerium einen Preis f√ºr ein Warteschlangen√ºberwachungssystem erhalten hat</a></li>
<li><a href="../de482182/index.html">Welche Probleme h√§tte ich, wenn ich mich in der IT f√ºr ein ausgewogenes Verh√§ltnis der Geschlechter einsetzen w√ºrde?</a></li>
<li><a href="../de482186/index.html">Leben und IT oder das Jahr, in dem ich meinen letzten Job gek√ºndigt habe</a></li>
<li><a href="../de482188/index.html">Freitag Umfrage √ºber Updates</a></li>
<li><a href="../de482190/index.html">Wie sehen Durex-Inhalte in sozialen Netzwerken in China aus?</a></li>
<li><a href="../de482196/index.html">Was ist Produktionsmodellierung und warum wird sie ben√∂tigt?</a></li>
<li><a href="../de482198/index.html">So erstellen Sie Ihren Autoscaler f√ºr einen Cluster</a></li>
<li><a href="../de482200/index.html">Blockchain f√ºr Cybersicherheit: Erwartungen und Realit√§t</a></li>
<li><a href="../de482202/index.html">Methoden zum Aktualisieren der Kryptografie auf Check Point-Ger√§ten auf GOST 2012</a></li>
<li><a href="../de482206/index.html">Wie man die 3D-Produktion von Flugzeugteilen wirtschaftlicher macht</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>