<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§µüèΩ üïñ üë©üèº‚Äçü§ù‚Äçüë®üèæ Centrifugo v2 - die Zukunft des Echtzeit-Messaging-Servers und der Bibliothek f√ºr Go üçΩÔ∏è üë©‚Äç‚ù§Ô∏è‚Äçüë® üîü</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Einige Leser haben vielleicht schon einmal von Centrifugo geh√∂rt . Dieser Artikel konzentriert sich auf die Entwicklung der zweiten Version des Server...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Centrifugo v2 - die Zukunft des Echtzeit-Messaging-Servers und der Bibliothek f√ºr Go</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/416915/"><p>  Einige Leser haben vielleicht schon einmal von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Centrifugo geh√∂rt</a> .  Dieser Artikel konzentriert sich auf die Entwicklung der zweiten Version des Servers und der neuen Echtzeitbibliothek f√ºr die zugrunde liegende Go-Sprache. </p><br><p>  Ich hei√üe Alexander Emelin.  Letzten Sommer bin ich dem Avito-Team beigetreten, wo ich jetzt bei der Entwicklung des Avito Messenger-Backends helfe.  Die neue Arbeit, die in direktem Zusammenhang mit der schnellen Zustellung von Nachrichten an Benutzer steht, und die neuen Kollegen haben mich dazu inspiriert, weiter am Open-Source-Projekt Centrifugo zu arbeiten. </p><br><p><img src="https://habrastorage.org/webt/cl/mo/yt/clmoytonrzc4exvj6eeky8j-zw4.jpeg"></p><a name="habracut"></a><br><p>  Kurz gesagt - dies ist ein Server, der die Aufgabe √ºbernimmt, konstante Verbindungen von Benutzern Ihrer Anwendung aufrechtzuerhalten.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Websocket-</a> oder SockJS- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Polyfill wird</a> als Transport verwendet. Wenn keine Websocket-Verbindung hergestellt werden kann, k√∂nnen Eventsource-, XHR-Streaming-, Long-Polling- und andere HTTP-basierte Transporte ausgef√ºhrt werden.  Clients abonnieren Kan√§le, f√ºr die das Backend √ºber die Centrifuge-API neue Nachrichten ver√∂ffentlicht, sobald sie entstehen. Anschlie√üend werden die Nachrichten an Benutzer √ºbermittelt, die den Kanal abonniert haben.  Mit anderen Worten, es ist ein PUB / SUB-Server. </p><br><p><img src="https://habrastorage.org/webt/-c/ws/k-/-cwsk-n9eulxk4cd7v9berdltzy.png"></p><br><p> Derzeit wird der Server in einer relativ gro√üen Anzahl von Projekten verwendet.  Darunter befinden sich beispielsweise einige Mail.Ru-Projekte (Intranet, Technopark / Technosphere-Schulungsplattformen, Zertifizierungszentrum usw.) mit Centrifugo, einem sch√∂nen Dashboard an der Rezeption im B√ºro von Badoo Moskau, und 350.000 Benutzer sind gleichzeitig mit dem spot.im-Dienst verbunden zur Zentrifuge. </p><br><p>  Einige Links zu fr√ºheren Artikeln √ºber den Server und seine Anwendung f√ºr diejenigen, die zuerst von dem Projekt erfahren: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Tauchen Sie ein in Centrifugo</a> , </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zentrifuge - 3,5 Millionen U / min</a> , </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sowie ein Artikel in englischer Sprache, der √ºber die Geschichte des Projekts und die Motivation f√ºr sein Erscheinen berichtet</a> . </li></ul><br><p>  Ich habe im Dezember letzten Jahres mit der Arbeit an der zweiten Version begonnen und mache bis heute weiter.  Mal sehen, was passiert.  Ich schreibe diesen Artikel nicht nur, um das Projekt irgendwie bekannt zu machen, sondern auch, um vor der Ver√∂ffentlichung von Centrifugo v2 ein etwas konstruktiveres Feedback zu erhalten - jetzt gibt es Raum f√ºr Man√∂ver und r√ºckw√§rts inkompatible √Ñnderungen. </p><br><h1 id="real-time-biblioteka-dlya-go">  Echtzeitbibliothek f√ºr Go </h1><br><p>  In der Go-Community stellt sich von Zeit zu Zeit die Frage: Gibt es Alternativen zu socket.io on Go?  Manchmal bemerkte ich, wie Entwicklern als Reaktion darauf geraten wird, sich auf Centrifugo zu konzentrieren.  Centrifugo ist jedoch ein selbst gehosteter Server, keine Bibliothek - der Vergleich ist nicht fair.  Ich wurde auch mehrmals gefragt, ob Centrifugo-Code zum Schreiben von Echtzeitanwendungen in Go wiederverwendet werden kann.  Und die Antwort war: theoretisch m√∂glich, aber ich konnte die Abw√§rtskompatibilit√§t der API interner Pakete nicht auf eigenes Risiko garantieren.  Es ist klar, dass es f√ºr niemanden einen Grund gibt, dies zu riskieren, und Gabeln ist auch eine Option.  Au√üerdem w√ºrde ich nicht sagen, dass die API f√ºr interne Pakete im Allgemeinen f√ºr eine solche Verwendung vorbereitet wurde. </p><br><p>  Daher bestand eine der ehrgeizigen Aufgaben, die ich bei der Arbeit an der zweiten Version des Servers l√∂sen wollte, darin, den Serverkern in Go in eine separate Bibliothek zu unterteilen.  Ich halte dies f√ºr sinnvoll, wenn man bedenkt, wie viele Funktionen die Zentrifuge hat, um an die Produktion angepasst zu werden.  Es sind sofort viele Funktionen verf√ºgbar, mit denen skalierbare Echtzeitanwendungen erstellt werden k√∂nnen, sodass Entwickler keine eigenen L√∂sungen mehr schreiben m√ºssen.  Ich habe bereits fr√ºher √ºber diese Funktionen geschrieben und werde im Folgenden auch einige davon skizzieren. </p><br><p>  Ich werde versuchen, ein weiteres Plus der Existenz einer solchen Bibliothek zu rechtfertigen.  Die meisten Centrifugo-Benutzer sind Entwickler, die Backends in Sprachen / Frameworks mit schlechter Parallelit√§tsunterst√ºtzung schreiben (z. B. Django / Flask / Laravel / ...): Arbeiten Sie nach M√∂glichkeit mit vielen dauerhaften Verbindungen auf nicht offensichtliche oder ineffiziente Weise.  Dementsprechend k√∂nnen nicht alle Benutzer bei der Entwicklung eines in Go geschriebenen Servers helfen (kitschig wegen mangelnder Sprachkenntnisse).  Daher kann auch eine sehr kleine Community von Go-Entwicklern in der Bibliothek bei der Entwicklung des Centrifugo-Servers helfen. </p><br><p>  Das Ergebnis ist eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zentrifugenbibliothek</a> .  Dies ist immer noch WIP, aber absolut alle Funktionen, die in der Beschreibung auf Github angegeben sind, sind implementiert und funktionieren.  Da die Bibliothek eine ziemlich umfangreiche API bietet, bevor ich die Abw√§rtskompatibilit√§t garantiere, w√ºrde ich gerne einige erfolgreiche Beispiele f√ºr die Verwendung in realen Projekten auf Go h√∂ren.  Es gibt noch keine.  Sowie erfolglos :).  Es gibt keine. </p><br><p>  Ich verstehe, dass ich durch die Benennung der Bibliothek auf die gleiche Weise wie der Server f√ºr immer mit Verwirrung umgehen werde.  Ich denke jedoch, dass dies die richtige Wahl ist, da Clients (wie z. B. centrifuge-js, centrifuge-go) sowohl mit der Centrifuge-Bibliothek als auch mit dem Centrifugo-Server arbeiten.  Au√üerdem ist der Name in den K√∂pfen der Benutzer bereits fest verankert, und ich m√∂chte diese Assoziationen nicht verlieren.  Und doch werde ich zur besseren √úbersicht noch einmal klarstellen: </p><br><ul><li>  Zentrifuge - eine Bibliothek f√ºr die Go-Sprache, </li><li>  Centrifugo ist eine schl√ºsselfertige L√∂sung, ein separater Service, der in Version 2 auf der Centrifuge-Bibliothek basiert. </li></ul><br><p>  Aufgrund seines Designs geht Centrifugo (ein eigenst√§ndiger Dienst, der nichts √ºber Ihr Backend wei√ü) davon aus, dass der Nachrichtenfluss √ºber den Echtzeittransport vom Server zum Client erfolgt.  Was meinst du  Wenn der Benutzer beispielsweise eine Nachricht in den Chat schreibt, muss diese Nachricht zuerst an das Anwendungs-Backend (z. B. AJAX im Browser) gesendet, auf der Backend-Seite validiert, bei Bedarf in der Datenbank gespeichert und dann an die Centrifuge-API gesendet werden.  Die Bibliothek hebt diese Einschr√§nkung auf, sodass Sie den bidirektionalen Austausch asynchroner Nachrichten zwischen dem Server und dem Client sowie RPC-Aufrufe organisieren k√∂nnen. </p><br><p><img src="https://habrastorage.org/webt/jf/_d/er/jf_dervpzmkl2fuprcse34ayoke.png"></p><br><p>  Schauen wir uns ein einfaches Beispiel an: Wir implementieren einen kleinen Server auf Go mithilfe der Centrifuge-Bibliothek.  Der Server empf√§ngt Nachrichten von Browser-Clients √ºber Websocket, der Client verf√ºgt √ºber ein Textfeld, in das Sie eine Nachricht eingeben k√∂nnen, dr√ºcken Sie die Eingabetaste - und die Nachricht wird an alle Benutzer gesendet, die den Kanal abonniert haben.  Das hei√üt, die einfachste Version des Chats.  Es schien mir am bequemsten, dies in Form eines <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kerns zu platzieren</a> . </p><br><p>  Sie k√∂nnen wie gewohnt laufen: </p><br><pre><code class="go hljs">git clone https:<span class="hljs-comment"><span class="hljs-comment">//gist.github.com/2f1a38ae2dcb21e2c5937328253c29bf.git cd 2f1a38ae2dcb21e2c5937328253c29bf go get -u github.com/centrifugal/centrifuge go run main.go</span></span></code> </pre> <br><p>  Gehen Sie dann zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">http: // localhost: 8000</a> und √∂ffnen Sie mehrere Browser-Registerkarten. </p><br><p>  Wie Sie sehen k√∂nnen, tritt der Einstiegspunkt in die Gesch√§ftslogik der Anwendung auf, wenn die R√ºckruffunktionen <code>On().Connect()</code> h√§ngen bleiben: </p><br><pre> <code class="go hljs">node.On().Connect(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, client *centrifuge.Client, e centrifuge.ConnectEvent)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">centrifuge</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConnectReply</span></span></span></span> { client.On().Disconnect(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e centrifuge.DisconnectEvent)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">centrifuge</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DisconnectReply</span></span></span></span> { log.Printf(<span class="hljs-string"><span class="hljs-string">"client disconnected"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> centrifuge.DisconnectReply{} }) log.Printf(<span class="hljs-string"><span class="hljs-string">"client connected via %s"</span></span>, client.Transport().Name()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> centrifuge.ConnectReply{} })</code> </pre> <br><p>  Der auf R√ºckrufen basierende Ansatz schien mir f√ºr die Interaktion mit der Bibliothek am bequemsten zu sein.  Au√üerdem wird bei der Implementierung des <a href="">Socket-io-Servers auf Go</a> ein √§hnlicher, nur schwach typisierter Ansatz verwendet.  Wenn Sie pl√∂tzlich dar√ºber nachdenken, wie die API idiomatischer gemacht werden k√∂nnte, w√ºrde ich mich freuen zu h√∂ren. </p><br><p>  Dies ist ein sehr einfaches Beispiel, das nicht alle Funktionen der Bibliothek demonstriert.  Jemand kann bemerken, dass es f√ºr solche Zwecke einfacher ist, eine Bibliothek f√ºr die Arbeit mit Websocket zu verwenden.  Zum Beispiel Gorilla Websocket.  Das ist eigentlich so.  Selbst in diesem Fall m√ºssen Sie jedoch einen anst√§ndigen Teil des Servercodes aus dem Beispiel im Gorilla Websocket-Repository kopieren.  Was ist, wenn: </p><br><ul><li>  Sie m√ºssen die Anwendung auf mehrere Computer skalieren. </li><li>  oder Sie ben√∂tigen nicht einen gemeinsamen Kanal, sondern mehrere - und Benutzer k√∂nnen diese dynamisch abonnieren und abbestellen, w√§hrend Sie in Ihrer Anwendung navigieren. </li><li>  oder Sie m√ºssen arbeiten, wenn die Websocket-Verbindung nicht hergestellt werden konnte (es gibt keine Unterst√ºtzung im Client-Browser, es gibt eine Browser-Erweiterung, eine Art Proxy auf dem Weg zwischen dem Client und dem Server unterbricht die Verbindung). </li><li>  oder Sie m√ºssen Nachrichten wiederherstellen, die der Client w√§hrend kurzer Unterbrechungen der Internetverbindung verpasst hat, ohne die Hauptdatenbank zu laden. </li><li>  oder Sie ben√∂tigen die Kontrolle √ºber die Benutzerautorisierung im Kanal, </li><li>  oder Sie m√ºssen die permanente Verbindung von Benutzern trennen, die in der Anwendung deaktiviert sind. </li><li>  oder Sie ben√∂tigen Informationen dar√ºber, wer sich gerade auf dem Kanal befindet oder welche Ereignisse jemand vom Kanal abonniert / abgemeldet hat. </li><li>  oder ben√∂tigen Sie Metriken und √úberwachung? </li></ul><br><p>  Die Centrifuge-Bibliothek kann Ihnen dabei helfen - tats√§chlich hat sie alle grundlegenden Funktionen geerbt, die zuvor in Centrifugo verf√ºgbar waren.  Weitere Beispiele f√ºr die oben genannten Punkte finden Sie auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github</a> . </p><br><p>  Das starke Erbe von Centrifugo kann ein Minus sein, da die Bibliothek alle Servermechaniken √ºbernommen hat, die recht originell sind und m√∂glicherweise f√ºr jemanden nicht offensichtlich oder mit unn√∂tigen Funktionen √ºberladen erscheinen.  Ich habe versucht, den Code so zu organisieren, dass nicht verwendete Funktionen die Gesamtleistung nicht beeintr√§chtigen. </p><br><p>  Es gibt einige Optimierungen in der Bibliothek, die eine effizientere Nutzung der Ressourcen erm√∂glichen.  Dies kombiniert mehrere Nachrichten in einem Websocket-Frame, um beim Schreiben von Systemaufrufen zu speichern, oder verwendet beispielsweise Gogoprotobuf, um Protobuf-Nachrichten und andere zu serialisieren.  Apropos Protobuf. </p><br><h1 id="binarnyy-protobuf-protokol">  Bin√§res Protobuf-Protokoll </h1><br><p>  Ich wollte wirklich, dass Centrifugo mit Bin√§rdaten arbeitet ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">und nicht nur mit mir</a> ), daher wollte ich in der neuen Version zus√§tzlich zu dem auf JSON basierenden ein Bin√§rprotokoll hinzuf√ºgen.  Nun wird das gesamte Protokoll als <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Protobuf-Schema beschrieben</a> .  Dies erm√∂glichte es uns, es strukturierter zu gestalten und einige nicht offensichtliche Entscheidungen im Protokoll der ersten Version zu √ºberdenken. </p><br><p>  Ich denke, Sie m√ºssen nicht lange sagen, was die Vorteile von Protobuf gegen√ºber JSON sind - Kompaktheit, Serialisierungsgeschwindigkeit, strenges Schema.  Es gibt einen Nachteil in Form von Unleserlichkeit, aber jetzt haben Benutzer die M√∂glichkeit zu entscheiden, was f√ºr sie in einer bestimmten Situation wichtiger ist. </p><br><p>  Im Allgemeinen sollte der vom Centrifugo-Protokoll bei Verwendung von Protobuf anstelle von JSON erzeugte Datenverkehr um das ~ 2-fache abnehmen (ohne Anwendungsdaten).  Der CPU-Verbrauch in meinen synthetischen Lasttests verringerte sich im Vergleich zu JSON um das ~ 2-fache.  Diese Zahlen sprechen eigentlich wenig dar√ºber, was in der Praxis alles vom Lastprofil einer bestimmten Anwendung abh√§ngt. </p><br><p>  Aus Gr√ºnden des Interesses habe ich einen Computer mit Debian 9.4 und 32 Intel¬Æ Xeon¬Æ Platinum 8168 CPU bei 2,70 GHz vCPU-Benchmark gestartet, mit dem wir die Bandbreite der Client-Server-Interaktion bei Verwendung des JSON-Protokolls und des Protobuf-Protokolls vergleichen konnten.  Es gab 1000 Abonnenten f√ºr 1 Kanal.  In diesem Kanal wurden Nachrichten in 4 Streams ver√∂ffentlicht und an alle Abonnenten √ºbermittelt.  Die Gr√∂√üe jeder Nachricht betrug 128 Bytes. </p><br><p>  Ergebnisse f√ºr JSON: </p><br><pre> <code class="go hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run main.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -s ws:<span class="hljs-comment"><span class="hljs-comment">//localhost:8000/connection/websocket -n 1000 -ns 1000 -np 4 channel Starting benchmark [msgs=1000, msgsize=128, pubs=4, subs=1000] Centrifuge Pub/Sub stats: 265,900 msgs/sec ~ 32.46 MB/sec Pub stats: 278 msgs/sec ~ 34.85 KB/sec [1] 73 msgs/sec ~ 9.22 KB/sec (250 msgs) [2] 71 msgs/sec ~ 9.00 KB/sec (250 msgs) [3] 71 msgs/sec ~ 8.90 KB/sec (250 msgs) [4] 69 msgs/sec ~ 8.71 KB/sec (250 msgs) min 69 | avg 71 | max 73 | stddev 1 msgs Sub stats: 265,635 msgs/sec ~ 32.43 MB/sec [1] 273 msgs/sec ~ 34.16 KB/sec (1000 msgs) ... [1000] 277 msgs/sec ~ 34.67 KB/sec (1000 msgs) min 265 | avg 275 | max 278 | stddev 2 msgs</span></span></code> </pre> <br><p>  Ergebnisse f√ºr den Fall Protobuf: </p><br><pre> <code class="go hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run main.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -s ws:<span class="hljs-comment"><span class="hljs-comment">//localhost:8000/connection/websocket?format=protobuf -n 100000 -ns 1000 -np 4 channel Starting benchmark [msgs=100000, msgsize=128, pubs=4, subs=1000] Centrifuge Pub/Sub stats: 681,212 msgs/sec ~ 83.16 MB/sec Pub stats: 685 msgs/sec ~ 85.69 KB/sec [1] 172 msgs/sec ~ 21.57 KB/sec (25000 msgs) [2] 171 msgs/sec ~ 21.47 KB/sec (25000 msgs) [3] 171 msgs/sec ~ 21.42 KB/sec (25000 msgs) [4] 171 msgs/sec ~ 21.42 KB/sec (25000 msgs) min 171 | avg 171 | max 172 | stddev 0 msgs Sub stats: 680,531 msgs/sec ~ 83.07 MB/sec [1] 681 msgs/sec ~ 85.14 KB/sec (100000 msgs) ... [1000] 681 msgs/sec ~ 85.13 KB/sec (100000 msgs) min 680 | avg 680 | max 685 | stddev 1 msgs</span></span></code> </pre><br><p>  M√∂glicherweise stellen Sie fest, dass der Durchsatz einer solchen Installation bei Protobuf mehr als doppelt so hoch ist.  Das Client-Skript finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> - dies ist das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nats-Benchmark-Skript, das an die Realit√§t von Centrifuge angepasst ist</a> . </p><br><p>  Es ist auch erw√§hnenswert, dass die Leistung der JSON-Serialisierung auf dem Server mit demselben Ansatz wie bei gogoprotobuf - Pufferpool und Codegenerierung - "hochgepumpt" werden kann. Derzeit wird JSON durch ein Paket aus der auf Reflect basierenden Go-Standardbibliothek serialisiert.  In Centrifugo wird beispielsweise die erste Version von JSON mithilfe einer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bibliothek</a> , die <a href="">einen Pufferpool</a> bereitstellt, manuell serialisiert.  √Ñhnliches kann in Zukunft im Rahmen der zweiten Version getan werden. </p><br><p>  Hervorzuheben ist, dass Protobuf auch bei der Kommunikation mit dem Server √ºber einen Browser verwendet werden kann.  Der Javascript-Client verwendet hierf√ºr die Bibliothek protobuf.js.  Da die protobufjs-Bibliothek sehr umfangreich ist und die Anzahl der Benutzer im Bin√§rformat mithilfe des Webpacks und seines Tree-Shaking-Algorithmus gering ist, generieren wir zwei Versionen des Clients - eine nur mit JSON-Protokollunterst√ºtzung und die andere mit JSON- und Protobuf-Unterst√ºtzung.  In anderen Umgebungen, in denen die Gr√∂√üe der Ressourcen keine so wichtige Rolle spielt, k√∂nnen sich Kunden keine Sorgen um diese Trennung machen. </p><br><h1 id="json-web-token-jwt">  JSON Web Token (JWT) </h1><br><p>  Eines der Probleme bei der Verwendung eines eigenst√§ndigen Servers wie Centrifugo besteht darin, dass er nichts √ºber Ihre Benutzer und deren Authentifizierungsmethode sowie √ºber die Art des Sitzungsmechanismus wei√ü, den Ihr Backend verwendet.  Und Sie m√ºssen die Verbindung irgendwie authentifizieren. </p><br><p>  Zu diesem Zweck wurde in der ersten Version von Centrifuge beim Verbinden die SHA-256-HMAC-Signatur verwendet, die auf einem geheimen Schl√ºssel basiert, der nur dem Backend und der Centrifuge bekannt ist.  Dadurch wurde sichergestellt, dass die vom Kunden √ºbermittelte Benutzer-ID wirklich ihm geh√∂rt. </p><br><p>  Vielleicht war die korrekte √úbertragung von Verbindungsparametern und die Erzeugung eines Tokens eine der Hauptschwierigkeiten bei der Integration von Centrifugo in das Projekt. </p><br><p>  Als die Zentrifuge erschien, war <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">der JWT-Standard</a> noch nicht so beliebt.  Jetzt, einige Jahre sp√§ter, stehen Bibliotheken f√ºr die JWT-Generation f√ºr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die beliebtesten Sprachen zur Verf√ºgung</a> .  Die Hauptidee von JWT ist genau das, was die Zentrifuge ben√∂tigt: Best√§tigung der Authentizit√§t der √ºbertragenen Daten.  In der zweiten Version von HMAC wurde die Verwendung von JWT durch eine manuell generierte Signatur ersetzt.  Dies erm√∂glichte es, die Notwendigkeit der Unterst√ºtzung von Hilfsfunktionen f√ºr die korrekte Generierung von Token in Bibliotheken f√ºr verschiedene Sprachen zu beseitigen. </p><br><p>  In Python kann beispielsweise ein Token f√ºr die Verbindung mit Centrifugo wie folgt generiert werden: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> jwt <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time token = jwt.encode({<span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"42"</span></span>, <span class="hljs-string"><span class="hljs-string">"exp"</span></span>: int(time.time()) + <span class="hljs-number"><span class="hljs-number">10</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>}, <span class="hljs-string"><span class="hljs-string">"secret"</span></span>).decode() print(token)</code> </pre> <br><p>  Es ist wichtig zu beachten, dass Sie den Benutzer bei Verwendung der Centrifuge-Bibliothek mithilfe der nativen Go-Methode authentifizieren k√∂nnen - innerhalb der Middleware.  Beispiele befinden sich im Repository. </p><br><h1 id="grpc">  GRPC </h1><br><p>  W√§hrend der Entwicklung habe ich versucht, bidirektionales GRPC-Streaming als Transportmittel f√ºr die Kommunikation zwischen Client und Server zu verwenden (zus√§tzlich zu Websocket- und HTTP-basierten SockJS-Fallbacks).  Was kann ich sagen  Er hat gearbeitet.  Ich habe jedoch kein einziges Szenario gefunden, in dem bidirektionales GRPC-Streaming besser w√§re als Websocket.  Ich habe mich haupts√§chlich mit Servermetriken befasst: Datenverkehr, der √ºber die Netzwerkschnittstelle generiert wird, CPU-Verbrauch durch den Server mit einer gro√üen Anzahl eingehender Verbindungen, Speicherverbrauch pro Verbindung. </p><br><p>  GRPC hat in jeder Hinsicht gegen Websocket verloren: </p><br><ul><li>  GRPC generiert in √§hnlichen Szenarien 20% mehr Verkehr. </li><li>  GRPC verbraucht 2-3 mal mehr CPU (abh√§ngig von der Konfiguration der Verbindungen - alle haben unterschiedliche Kan√§le oder alle einen Kanal abonniert). </li><li>  GRPC verbraucht viermal so viel RAM pro Verbindung.  Bei 10.000 Verbindungen verbrauchte der Websocket-Server beispielsweise 500 MB Speicher und GRPC-2 GB. </li></ul><br><p>  Die Ergebnisse waren ziemlich ... erwartet.  Im Allgemeinen sah ich in GRPC als Client-Transport nicht viel Sinn - und l√∂schte den Code mit gutem Gewissen bis vielleicht zu besseren Zeiten. </p><br><p>  GRPC ist jedoch gut darin, wof√ºr es haupts√§chlich erstellt wurde - Code zu generieren, mit dem Sie RPC-Aufrufe zwischen Diensten mithilfe eines vorgegebenen Schemas t√§tigen k√∂nnen.  Daher bietet die Zentrifuge neben der HTTP-API jetzt auch GRPC-basierte API-Unterst√ºtzung, um beispielsweise neue Nachrichten auf dem Kanal und andere verf√ºgbare Server-API-Methoden zu ver√∂ffentlichen. </p><br><h1 id="slozhnosti-s-klientami">  Schwierigkeiten mit Kunden </h1><br><p>  Durch die in der zweiten Version vorgenommenen √Ñnderungen wurde die obligatorische Unterst√ºtzung von Bibliotheken f√ºr die Server-API entfernt - die Integration auf der Serverseite wurde einfacher, das Client-Protokoll im Projekt wurde jedoch ge√§ndert und verf√ºgt √ºber eine ausreichende Anzahl von Funktionen.  Dies macht die Implementierung von Kunden ziemlich schwierig.  F√ºr die zweite Version haben wir jetzt einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Client f√ºr Javascript</a> , der in Browsern funktioniert und mit NodeJS und React-Native funktionieren sollte.  Es gibt einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Client auf Go,</a> der auf seiner Basis und auf der Basis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">der Gomobile-Projektordner</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">f√ºr iOS und Android erstellt wurde</a> . </p><br><p>  F√ºr vollkommenes Gl√ºck gibt es nicht gen√ºgend native Bibliotheken f√ºr iOS und Android.  F√ºr die erste Version von Centrifugo wurden sie von Leuten aus der Open-Source-Community gekauft.  Ich m√∂chte glauben, dass so etwas jetzt passieren wird. </p><br><p>  Ich habe k√ºrzlich mein Gl√ºck versucht, indem ich einen Antrag auf ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">MOSS-Stipendium von Mozilla</a> gesendet habe, um in die Kundenentwicklung zu investieren, wurde aber abgelehnt.  Der Grund ist die unzureichend aktive Community auf Github.  Leider stimmt das, aber wie Sie sehen, unternehme ich einige Schritte, um die Situation zu verbessern. </p><br><p><img src="https://habrastorage.org/webt/y4/3q/kc/y43qkcl_yp7fjdgalrqvuzw5hl0.jpeg"></p><br><h1 id="zaklyuchenie">  Fazit </h1><br><p>  Ich habe nicht alle Funktionen angek√ºndigt, die in Centrifugo v2 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">verf√ºgbar sein werden</a> . Weitere Informationen finden Sie in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ausgabe zu Github</a> .  Die Serverfreigabe hat noch nicht stattgefunden, wird aber bald erfolgen.  Es gibt noch unvollendete Momente, einschlie√ülich der Notwendigkeit, die Dokumentation zu vervollst√§ndigen.  Der Prototyp der Dokumentation kann hier eingesehen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">werden</a> .  Wenn Sie ein Centrifugo-Benutzer sind, ist jetzt der richtige Zeitpunkt, um die zweite Version des Servers zu beeinflussen.  Eine Zeit, in der es nicht so be√§ngstigend ist, etwas zu zerbrechen, um es sp√§ter besser zu machen.  F√ºr Interessierte: Die Entwicklung konzentriert sich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">auf den c2-Zweig</a> . </p><br><p>  Es f√§llt mir schwer zu beurteilen, wie stark die Nachfrage nach der Centrifuge-Bibliothek, die Centrifugo v2 zugrunde liegt, gefragt sein wird.  Im Moment freue ich mich, dass ich es auf den aktuellen Stand bringen konnte.  Der wichtigste Indikator f√ºr mich ist jetzt die Antwort auf die Frage "W√ºrde ich diese Bibliothek selbst in meinem pers√∂nlichen Projekt verwenden?"  Meine Antwort lautet ja.  Bei der Arbeit?  Ja  Daher glaube ich, dass andere Entwickler es zu sch√§tzen wissen. </p><br><p>  PS Ich m√∂chte mich bei den Leuten bedanken, die bei der Arbeit und beim Rat geholfen haben - Dmitry Korolkov, Artemy Ryabinkov, Oleg Kuzmin.  Ohne dich w√§re es eng. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de416915/">https://habr.com/ru/post/de416915/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de416905/index.html">Boston Dynamics SpotMini Pr√§sentation</a></li>
<li><a href="../de416907/index.html">Theorie des Gl√ºcks. Das Gesetz der Zebra- und Alien-Warteschlange</a></li>
<li><a href="../de416909/index.html">PostgreSQL-Sitzungsverlauf - neue pgsentinel-Erweiterung</a></li>
<li><a href="../de416911/index.html">Chatbots sollten der n√§chste Durchbruch sein: Was ist schief gelaufen?</a></li>
<li><a href="../de416913/index.html">Was sollte der Administrator beim Wechsel in die Cloud vergessen - und was muss er lernen?</a></li>
<li><a href="../de416917/index.html">Siebte Traurigkeit</a></li>
<li><a href="../de416919/index.html">Burger King und verdeckte Bildschirmaufnahme Ihres Telefons</a></li>
<li><a href="../de416921/index.html">Wie Hunderttausende von Antennen in einem Teleskop zusammenkommen</a></li>
<li><a href="../de416925/index.html">Was wir √ºber Ant Design wissen</a></li>
<li><a href="../de416927/index.html">Schuh-Startups - und warum Silicon Valley sie so liebt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>