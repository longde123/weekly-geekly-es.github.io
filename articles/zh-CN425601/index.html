<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🈷️ 🕴️ 🧤 修复Shockwave 2000游戏中的错误 ⏏️ 👅 👨‍🌾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="单字节替换历史 
  卡通卡通避暑胜地 
 那是2000年的夏天。 我六岁了，刚读完一年级，假期开始了。 这意味着我可以在街上玩很长时间，看动画片，并用Windows 98打开父亲的电脑，在一个崭新的，未知的地区，称为Internet上搜索游戏。 我最喜欢的网站之一是卡通网络网站。 在它上面，我发现...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>修复Shockwave 2000游戏中的错误</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425601/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3be/21d/f61/3be21df619c031d81d9fedadf77ac563.png" alt="图片"></div><br><h2> 单字节替换历史 </h2><br>
<h2> 卡通卡通避暑胜地 </h2><br> 那是2000年的夏天。 我六岁了，刚读完一年级，假期开始了。 这意味着我可以在街上玩很长时间，看动画片，并用Windows 98打开父亲的电脑，在一个崭新的，未知的地区，称为Internet上搜索游戏。 我最喜欢的网站之一是卡通网络网站。 在它上面，我发现了许多基于电视动画片的引人入胜的Flash游戏。 那个夏天，他们发布了一系列名为“卡通卡通避暑胜地”的游戏。 <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/JcEcJpV6Rvs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i>卡通卡通避暑胜地第一集的游戏玩法</i> <br><br> 该游戏是二维RPG /冒险游戏，从侧面俯视，包括四集。 玩家在度假时与其他卡通人物一起控制了一个卡通人物。 在每个情节中，度假村中都会出现一个需要解决的问题。 玩家必须通过与角色互动并找到对象或交换它们来解决它。 <br><a name="habracut"></a><br><h2> 追溯到18年 </h2><br> 在最近一次怀旧攻击中，我想起了这款游戏，意识到自己会再次玩。 她快两岁了，所以很难找到工作联系。 <br><br> 此外，除了Internet Explorer，没有任何现代浏览器会启动古老而脆弱的Shockwave播放器。 我可能是第一个在2018年找到合理理由使用Internet Explorer的人。 <br><br> 玩了一点之后，我注意到了一些不容忽视的时刻。 例如，单调的背景音乐不断循环播放，并且对碰撞的识别不佳。 <br><br><h2> 相同的错误 </h2><br> 一段时间后，我在游戏中发现了一个错误： <br><br>  <strong>在不应该发生任何事情的区域中移动时，有时会出现一个对话框。</strong> <br><br> 从动画中可以看出，在游戏中您可以租用一条船在水上移动。 当您尝试租用另一艘船时，会出现消息“今天不再有租用的船！”。 如果您向北航行并沿着岛的右边缘行走，但是会打开同样的文本，该文本应该出现在船码头上。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/422/4f9/96b/4224f996ba06dd22ee7761eff7bb195a.gif"></div><br> 在这个阶段，任何尊重自己的时间和精力的理智的人都会认为该错误是一个小麻烦，提醒自己这是二十年前创建的面向儿童的中等水平的网络游戏，并且会继续玩。 但不是我。 <br><br> 我已经拥有了我所有的编程知识，并且看着游戏，所以我觉得这个bug非常吸引人。 在我看来，我已经出土了一座古墓，并在墓中发现了一个原本可以消失的，没有被任何人解决的谜题。 对我而言，此错误是学习和发现新事物的机会。 有趣的是，正是这些机会才<em>使游戏过程</em>给了我童年。 如果您从不同的角度看待某件事，那么无意间会给新挑战带来些许诗意。 <br><br><h2> 解构游戏 </h2><br> 要修复该错误，我需要了解游戏的内部工作原理。 检查问题后，我发现该游戏是在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Director</a>应用程序的Shockwave上创建的。 使用Director时，项目将另存为<code>.dir</code> （导演）文件。 该文件类似于Photoshop的PSD文件。 就像PSD文件包含有关图层和文本的非破坏性信息一样， <code>.dir</code>项目会保存所有资源，原始源代码以及其他有助于开发过程的信息。 导演使用专有的脚本语言<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Lingo</a>对场景进行动画处理。 <br><br> 如果将游戏保存在<code>.dir</code>文件中，则可以在Director中打开它并轻松了解游戏的工作原理。 但是，游戏发布为<code>.dcr</code>文件。  <code>.dcr</code>文件是Director项目的编译版本。 也就是说，所有源代码都被编译为在Shockwave平台上运行的字节码。 此过程类似于简化PSD文件并变成PNG图像的过程。  PNG图像（在我们的示例中为DCR文件）较小，但不包含有关图层和编辑的信息，仅用于分发。 <br><br> 这意味着我持有一个500 KB的二进制对象而没有其结构的文档。 即使我想出了如何找到低级字节码，似乎也没有人对Lingo字节码进行逆向工程，也没有记载Shockwave平台的原理。 所有这些信息均为专有信息，归Adobe所有，没有理由发布。 了解游戏的机会似乎很惨淡。 <br><br><h2> 减压 </h2><br> 因为我很可能无法消除此错误而感到失败，所以我决定确定是否可以从游戏中提取资源。 我认为很可能会找到一段压缩数据或类似内容。 搜索之后，我找到了两个名为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="noopener">offzip和packzip</a>的程序。 这些工具可以在任意二进制文件中搜索zlib数据，显示偏移量并将其提取到单独的文件中。 <br><br> 我用DCR文件下载了压缩文件，令我惊讶的是，它确实找到了档案！  249件，更精确地说。 <br><br> <code>$ ./offzip.exe -a 1.dcr <br> <br> - open input file: 1.dcr <br> - zip data to check: 32 bytes <br> - zip windowBits: 15 <br> - seek offset: 0x00000000 (0) <br> +------------+-----+----------------------------+----------------------+ <br> | hex_offset | ... | zip -&gt; unzip size / offset | spaces before | info | <br> +------------+-----+----------------------------+----------------------+ <br> 0x00000026 . 164 -&gt; 214 / 0x000000ca _ 38 8:7:26:0:1:7b6349f6 <br> 0x000000d3 .. 3932 -&gt; 9169 / 0x0000102f _ 9 8:7:26:0:1:c1079d84 <br> ... <br> 0x00080490 . 265 -&gt; 472 / 0x00080599 _ 0 8:7:26:0:1:04d6b43f <br> 0x00080599 . 209 -&gt; 366 / 0x0008066a _ 0 8:7:26:0:1:7da3ba08 <br> <br> - 249 valid compressed streams found <br> - 0x0004040d -&gt; 0x001565c8 bytes covering the 50% of the file</code> <br> <br> 我将所有这些文件提取到一个文件夹中，然后开始研究结果。 有206个<code>.dat</code>文件，38个<code>.fff</code>文件，4个<code>.atn</code>和一个<code>.ini</code>文件。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5dd/18f/739/5dd18f73916632576f0f9987b38f0878.png"></div><br><h2> 发现 </h2><br> 我从INI文件开始，但是没有用。 这是Windows和Mac之间Directory 7.0中的一个简单字体转换表。 然后我转到DAT文件。 它们大多数都是1KB，所以我从一个巨大的144KB开始。 我用十六进制编辑器将其打开并进行了研究。 大多数情况下，这是难以辨认的数据。 但是，随着时间的流逝，我发现其中有些单词似乎是Lingo标识符。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/293/37e/662/29337e6629e52d5bb775d44bcb0cbdab.png"></div><br> 对大型DAT文件的分析为我提供了一些线索，它们保留了一些有趣的信息。 我发现Photoshop 3.0最有可能用于图形。 我还了解到该游戏有一个内部地图编辑工具，称为<code>Map-O-Matic v1</code> 。 我想看看它的外观和创建方式。 <br><br> 我还找到了开发游戏的公司名称： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="noopener">Funny Garbage</a> 。 文件中也包含首席开发人员的姓名，但我不会命名。 很高兴发现这个游戏的作者，我在将近20年后顽固地试图修复它，并终于看到了成为这个痛苦的可能原因的人的面孔。 所有这些碎屑的信息固然很有趣，但是并没有太大帮助。 <br><br><h2> 突破 </h2><br> 然后，我开始在十六进制编辑器中研究<code>.fff</code>文件。 令我惊讶的是，这些文件中的所有数据都是可读的，看起来像地图数据： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c21/4e5/163/c214e5163bf2fbebc498207dd583a4de.png"></div><br> 我手动提取了其中一些数据，并在文本编辑器中对其进行了清理。 我所做的非常像一个JSON数组： <br><br> <code>[ <br> #member: "block.104", <br> #type: #FLOR, <br> #location: [16, 9], <br> #width: 64, <br> #WSHIFT: 0, <br> #height: 32, <br> #HSHIFT: 0, <br> #data: [ <br> #item: [ <br> #name: "", <br> #type: #WALL, <br> #visi: [ <br> #visiObj: "", <br> #visiAct: "", <br> #inviObj: "", <br> #inviAct: "" <br> ], <br> #COND: [[#hasObj: "", #hasAct: "", #giveObj: "sunscreen", #giveAct: "gotscreen"], #none, #none, #none] <br> ], <br> #move: [#U: 0, #d: 0, #L: 0, #R: 0, #COND: 1, #TIMEA: 0, #TIMEB: 0], <br> #message: [ <br> [#text: "You bought the sun screen.", #plrObj: "", #plrAct: ""], <br> [#text: "No more sunscreen today!", #plrObj: "", #plrAct: "gotscreen"] <br> ] <br> ] <br> ]</code> <br> <br> 这非常重要，因为我设法学到了很多有关游戏运作方式的知识。 <br><br><ol><li> 游戏期望地图，文本和事件数据位于类似JSON的Lingo对象中 </li><li> 每个<code>#member</code>条目都是一个<code>#member</code>图块，块或字符。 </li><li> 坐标和尺寸<code>#member</code>可以编辑。 </li></ol><br> 知道游戏的对话框已保存到这些文件后，我写了一条短线，仅将一个对话框导出到文件中： <br><br> <code>grep -a -o '#text: "[^"]*' Uncompressed/*.fff | awk '{print $0,"\r"}' &gt; Dialogue.txt</code> <br> <br> 使用此文件，我可以快速找到错误的文本并查看其中的文件： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c52/223/723/c5222372338b5a772974bc6cdbeef45c.png"></div><br> 错误的文本是在<code>0004eda0.fff</code>或<code>0004f396.fff</code> 。 在我们的例子中，错误文本出现在第一个文件中。 我们知道这一点，因为紧随其后的是与Og交互时收到的消息，Og与带有错误的图块在同一地图上的角色。 <br><br><h2> 错误修复 </h2><br> 现在，我可以打开<code>0004eda0.fff</code>并在十六进制编辑器中找到有关船的行。 找到它之后，我能够找到与它关联的<code>#member</code>对象。 然后更改其属性并保存文件。 然后，我再次对其进行压缩，并使用<code>packzip</code>将其修补到DCR游戏源文件中。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3be/21d/f61/3be21df619c031d81d9fedadf77ac563.png"></div><br> <code>$ ./packzip -o 0x0004EDA0 Uncompressed/0004eda0.fff test.dcr</code> <br> <br> 当我将块类型从<code>block.11</code>为<code>block.13</code>并对游戏进行补丁时，我可以清楚地看到错误<code>block.13</code>贴的轮廓： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3ff/284/5bc/3ff2845bc1c7e5909568922f5e0d8966.png"></div><br>  <i>通过更改图块ID，您可以看到问题区域的边界</i> <br><br> 错误修复本身非常简单。 我要做的就是将此错误<code>#fessage</code> <code>#message</code>的标识符<code>#message</code>更改为<code>#fessage</code> ： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/89e/01d/222/89e01d2223a00f8ca352b28d22ed210b.gif"></div><br> 现在，如果我们修补更改并返回此区域，则消息将不再出现！ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cf9/8fb/18b/cf98fb18bf28b734a992e0e1b307e35a.gif"></div><br>  <i>修复了游戏中的错误，实际上改变了1个字节</i> <br><br><h2> 为什么可以解决该错误？ </h2><br> 我只能假设游戏引擎可能会在玩家移动时检查其站立的磁贴。 如果满足某些条件，则它将显示<code>#message</code>数组中与此图块相对应的消息。 将<code>#message</code>更改为<code>#fessage</code>不再找到代码正在寻找的<code>#message</code>数组<code>#fessage</code>链接。 他认为这是一个空（或未定义？）对象，并且不显示任何内容。 <br><br> 考虑一下JS上的示例： <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bar</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bar[<span class="hljs-string"><span class="hljs-string">"message"</span></span>] !== <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// display the message } }</span></span></code> </pre> <br> 假设我们不能更改函数<code>foo()</code> ，但是我们需要更改结果。 我们可以访问传输给她的数据。 您可以重命名所传递对象的<code>message</code>属性，该函数将认为它不存在。 <br><br><h2> 该错误如何出现？ </h2><br> 我想是因为懒惰。 开发人员使用地图编辑器来创建该区域。 他们很可能将过去制作的卡片复制到新区域，然后进行更改。 这比从头开始创建所有内容容易。 但是由于事件和文本数据混合在一起，因此它们很可能在某些地方被忽略了，却忘记了删除或替换它们。 这看起来是最合乎逻辑的，因为错误的对话通常来自正确使用了该卡片的相邻卡片。 <br><br><h2> 为什么要在微不足道的事情上花费大量的工作？ </h2><br> 我不知道 也许是由于怀旧？ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN425601/">https://habr.com/ru/post/zh-CN425601/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN425591/index.html">我们使用免费的SSL证书来保护Azure网站</a></li>
<li><a href="../zh-CN425593/index.html">Windows 1809的最终版本被召回</a></li>
<li><a href="../zh-CN425595/index.html">Blaue Karte，近IT专家或我如何去德国</a></li>
<li><a href="../zh-CN425597/index.html">直到20世纪的“技术”乐器：磁性大键琴和机电钢琴</a></li>
<li><a href="../zh-CN425599/index.html">61年来对太空的看法如何</a></li>
<li><a href="../zh-CN425603/index.html">职业寻路</a></li>
<li><a href="../zh-CN425605/index.html">接受不带信用卡的付款。 Yandex.Money上的面孔</a></li>
<li><a href="../zh-CN425607/index.html">使用Enron数据集识别欺诈。 第2部分，找到最佳模型</a></li>
<li><a href="../zh-CN425609/index.html">博弈论：科特林的事例决策</a></li>
<li><a href="../zh-CN425611/index.html">高层前端架构。 Yandex讲座</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>