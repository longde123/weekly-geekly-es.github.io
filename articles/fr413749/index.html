<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌜 🏰 👩🏼‍🔬 Arbre B + dans un vrai projet 🐗 👨‍👩‍👦‍👦 🥥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, nous examinerons en détail comment l'arborescence B + est créée dans une base de données Apache Ignite distribuée. 




 Il y a déjà...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Arbre B + dans un vrai projet</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sberbank/blog/413749/"><p>  Dans cet article, nous examinerons en détail comment l'arborescence B + est créée dans une base de données <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Apache Ignite</a> distribuée. <br></p><br><img src="https://habrastorage.org/webt/mv/_t/zg/mv_tzg1o-c96a2ib19cf9umv67u.jpeg"><a name="habracut"></a><br><p>  Il y a déjà quelques articles sur les arbres H sur les arbres B ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">deux</a> ), mais ils sont plus probablement théoriques et même s'ils contiennent une implémentation, ils ne sont pas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">prêts pour la production</a> .  De cela, il y a un intérêt à regarder la mise en œuvre qui est utilisée dans la vie. </p><br><p>  Avant de lire l'article plus loin, je vous conseille de regarder une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">conférence de Maxim Babenko</a> , si vous ne savez toujours pas ce qu'est l'arbre B en théorie.  Mais je n'ai pas besoin de connaître Java en profondeur ou le projet Apache Ignite - j'écrirai les détails explicitement ou le cacherai sous les spoilers. </p><br><p>  Lors de la lecture des sources Ignite, je vous conseille de sauter les arguments des méthodes dans votre esprit, dont la signification n'est pas très claire et de lire les noms des fonctions - il est beaucoup plus facile de lire le corps de la fonction si vous savez à l'avance ce qu'elle fait. </p><br><p>  Veuillez noter que je ne suis pas le développeur principal d'Apache Ignite et que j'ai peut-être mal compris quelque chose du code.  J'ai donc mis la phrase «pour autant que je comprends», qui devrait être ajoutée mentalement avant chaque phrase affirmative. </p><br><h1 id="zachem-b-derevo-v-apache-ignite">  Pourquoi l'arbre B + dans Apache Ignite </h1><br><p> Apache Ignite est une base de données en mémoire, mais depuis la version 2.1, elle possède un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">magasin de données persistantes</a> - une fonction pour enregistrer les données sur le disque <em>(n'a rien à voir avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la structure des données persistantes</a> )</em> .  Par conséquent, il est clair pourquoi une structure est nécessaire pour la mémoire externe, il reste à comprendre pourquoi ils n'en ont pas choisi une autre. </p><br><p>  Pour commencer, l'arbre B + est une optimisation de l'arbre B, où les valeurs sont stockées uniquement dans les feuilles.  Dans cette optimisation, davantage de clés tiennent dans un nœud, ce qui augmente le degré de ramification.  Par conséquent, il n'y a pas beaucoup de raisons d'utiliser l'arbre B classique. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">B *</a> et B + * - sont plus denses sur le disque, mais leurs performances sont moins bonnes, car  nous stockons les données de la RAM, les performances sont plus importantes pour nous. </p><br><p>  À en juger par les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">repères, un</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">arbre LSM est</a> plus rapide à écrire, mais plus lent à lire.  De plus, la perte en lecture est supérieure au gain en écriture, donc pour un cas général hypothétique, je prendrais aussi l'arbre B +. </p><br><p>  Il existe également d'étranges <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">arbres fractals</a> , cependant, apparemment, ils sont brevetés et mis en œuvre uniquement dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TokuDB</a> . </p><br><p>  Personnellement, je suis plus intéressé par la raison pour laquelle il était impossible de prendre un backend de disque prêt à l'emploi, comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LevelDB</a> ?  Une réponse partielle est que PDS prend en charge le stockage tiers. </p><br><h1 id="realizaciya-v-krupnuyu-kletku">  Mise en œuvre de grandes cellules </h1><br><p> Au départ, GridGain a développé Apache Ignite, mais avant de partir pour l'open source, il portait le nom de la société, donc certains noms de composants commencent par <code>Grid</code> et d'autres par <code>Ignite</code> .  Par conséquent <code>GridCursor</code> , mais <code>IgniteTree</code> .  Il n'y a pas d'autre logique ici. </p><br><p>  Le code Apache Ignite est écrit dans les modèles de meilleures pratiques Java, et chaque classe hérite d'une interface, sinon une.  Depuis l'interface <code>IgniteTree</code> et lancez la danse.  Je donne le code sans javadoc, pour faire court. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IgniteTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T val)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key, Object x, InvokeClosure&lt;T&gt; c)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findOne</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GridCursor&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L lower, L upper)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GridCursor&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L lower, L upper, Object x)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findFirst</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findLast</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvokeClosure</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable T row)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newRow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">OperationType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operationType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> OperationType { NOOP, REMOVE, PUT } }</code> </pre> <br><p>  L'interface <code>IgniteTree</code> décrit un ensemble standard d'opérations.  Veuillez noter qu'avoir une recherche de gamme vous oblige à tricoter des feuilles dans une liste.  Le bonus prend en charge une opération d'enregistrement arbitraire - <code>invoke</code> . </p><br><p>  L'opération <code>put</code> ne prend qu'un seul argument de type <code>T</code> sans clé.  Vous ne trouverez pas d'explication à cela dans <code>IgniteTree</code> , mais la réponse est masquée dans l'en-tête <code>BPlusTree</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BPlusTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataStructure</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IgniteTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre> <br><p>  Comme vous pouvez le voir, la valeur hérite de la clé, par conséquent, dans l'opération put, la clé est calculée à partir de la valeur.  Cela ne limite pas la fonctionnalité de l'arborescence.  Mon hypothèse est qu'il est plus compact de stocker des ensembles. </p><br><p>  Habituellement, ils font un ensemble de carte en attachant une constante de mémoire à la valeur.  Cependant, dans l'arborescence B +, <em>seules les clés sont</em> stockées dans les nœuds; si la valeur stocke également la clé, dans les feuilles, il suffit de stocker <em>uniquement les valeurs</em> .  Et si l'arbre est un ensemble, il se trouve automatiquement que dans les feuilles, il n'y aura que des clés sans valeurs de déchets. </p><br><p><img src="https://habrastorage.org/webt/gk/5a/mj/gk5amjeohtkej5assnsgyy791p4.png"></p><br><p>  Examinons maintenant le code de recherche d'élément. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> g Get. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> IgniteCheckedException If failed. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doFind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Get g)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { <span class="hljs-comment"><span class="hljs-comment">// Go down with retries. g.init(); switch (findDown(g, g.rootId, 0L, g.rootLvl)) { case RETRY: case RETRY_ROOT: checkInterrupted(); continue; default: return; } } } /** * @param g Get. * @param pageId Page ID. * @param fwdId Expected forward page ID. * @param lvl Level. * @return Result code. * @throws IgniteCheckedException If failed. */ private Result findDown(final Get g, final long pageId, final long fwdId, final int lvl) throws IgniteCheckedException { long page = acquirePage(pageId); try { for (;;) { // Init args. g.pageId = pageId; g.fwdId = fwdId; Result res = read(pageId, page, search, g, lvl, RETRY); switch (res) { case GO_DOWN: case GO_DOWN_X: assert g.pageId != pageId; assert g.fwdId != fwdId || fwdId == 0; // Go down recursively. res = findDown(g, g.pageId, g.fwdId, lvl - 1); switch (res) { case RETRY: checkInterrupted(); continue; // The child page got split, need to reread our page. default: return res; } case NOT_FOUND: assert lvl == 0 : lvl; g.row = null; // Mark not found result. return res; default: return res; } } } finally { if (g.canRelease(pageId, lvl)) releasePage(pageId, page); } }</span></span></code> </pre> <br><p>  La base de l'algorithme de traversée de l'arbre B est restée inchangée: ils descendent l'arbre récursivement jusqu'à la feuille souhaitée: si la valeur est présente, alors ils retournent le résultat, et sinon, alors <code>null</code> .  La récursivité a apparemment été laissée pour plus de commodité, de toute façon, les arbres B ne sont pas profonds. </p><br><p><img src="https://habrastorage.org/webt/tc/g3/0t/tcg30to_z-6fcrfegjfulubh0gq.jpeg"></p><br><p>  J'ai été surpris car il y avait une installation claire dans ma tête: la récursivité est toujours supprimée dans un projet réel ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">il n'y a pas d'optimisation de récursivité de queue en Java</a> , la récursivité est acceptable dans les projets dans d'autres langages).  Mais vraiment, la hauteur de l'arbre B est mesurée en unités, car la taille du bloc de commande <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>10</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.039ex" height="2.419ex" viewBox="0 -935.7 1308.3 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-31"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-30" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>10</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-1"> 2 ^ {10} </script>  , et le nombre de données de la commande <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>40</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.039ex" height="2.419ex" viewBox="0 -935.7 1308.3 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-34"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-30" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>40</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-2"> 2 ^ {40} </script>  et la hauteur sera <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>40</mn></mrow></msup><mo stretchy=&quot;false&quot;>)</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>10</mn></mrow></msup><mo stretchy=&quot;false&quot;>)</mo></mrow><mo>=</mo><mn>4</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="24.975ex" height="2.901ex" viewBox="0 -935.7 10753.2 1249" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMATHI-66" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMATHI-72" x="800" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMATHI-61" x="1252" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMATHI-63" x="1781" y="0"></use><g transform="translate(2215,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMATHI-6C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMATHI-6F" x="298" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMATHI-67" x="784" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-28" x="1264" y="0"></use><g transform="translate(1654,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-34"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-30" x="500" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-29" x="2962" y="0"></use></g><g transform="translate(5566,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMATHI-6C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMATHI-6F" x="298" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMATHI-67" x="784" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-28" x="1264" y="0"></use><g transform="translate(1654,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-31"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-30" x="500" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-29" x="2962" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-3D" x="9196" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhip8LYs-A7UqqVea5bF2rvP3y80zg#MJMAIN-34" x="10252" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>40</mn></mrow></msup><mo stretchy="false">)</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>10</mn></mrow></msup><mo stretchy="false">)</mo></mrow><mo>=</mo><mn>4</mn></math></span></span><script type="math/tex" id="MathJax-Element-3"> \ frac {log (2 ^ {40})} {log (2 ^ {10})} = 4 </script>  . </p><br><p>  Apache Ignite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aime la simultanéité</a> .  Par conséquent, l'arborescence prend en charge la modification compétitive.  Au moment de l'opération, une page est bloquée, mais un autre thread peut modifier le reste de l'arborescence afin qu'une deuxième lecture soit nécessaire.  Et donc la procédure peut atteindre la racine. </p><br><p>  Au début, je ne comprenais pas la signification d'une telle fonctionnalité, car le disque est lent et un thread traitera calmement toutes les opérations d'E / S.  Il est clair que la recherche dans le nœud chargé à partir du disque coûte un peu et pendant ce temps, vous pouvez charger le disque avec une autre opération, mais des tentatives répétées grugeront le gain.  Cependant, il m'est apparu que dans cette implémentation, les nœuds n'étaient pas immédiatement vidés sur le disque après la modification, mais ils étaient suspendus dans la mémoire pendant un certain temps, afin d'appliquer ensuite de nombreuses modifications à la fois.  Aucune donnée n'est perdue grâce à Write Ahead Log.  Plus d'informations à ce sujet à la fin de l'article. </p><br><p>  Voyons maintenant le code pour ajouter un élément. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doPut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T row, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> needOld)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ checkDestroyed(); Put p = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Put(row, needOld); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { <span class="hljs-comment"><span class="hljs-comment">// Go down with retries. p.init(); Result res = putDown(p, p.rootId, 0L, p.rootLvl); switch (res) { case RETRY: case RETRY_ROOT: checkInterrupted(); continue; case FOUND: // We may need to insert split key into upper level here. if (!p.isFinished()) { // It must be impossible to have an insert higher than the current root, // because we are making decision about creating new root while keeping // write lock on current root, so it can't concurrently change. assert p.btmLvl &lt;= getRootLevel(); checkInterrupted(); continue; } return p.oldRow; default: throw new IllegalStateException("Result: " + res); } } } catch (IgniteCheckedException e) { throw new IgniteCheckedException("Runtime failure on row: " + row, e); } catch (RuntimeException e) { throw new IgniteException("Runtime failure on row: " + row, e); } catch (AssertionError e) { throw new AssertionError("Assertion error on row: " + row, e); } finally { checkDestroyed(); } } /** * @param p Put. * @param pageId Page ID. * @param fwdId Expected forward page ID. * @param lvl Level. * @return Result code. * @throws IgniteCheckedException If failed. */ private Result putDown(final Put p, final long pageId, final long fwdId, final int lvl) throws IgniteCheckedException { assert lvl &gt;= 0 : lvl; final long page = acquirePage(pageId); try { for (;;) { // Init args. p.pageId = pageId; p.fwdId = fwdId; Result res = read(pageId, page, search, p, lvl, RETRY); switch (res) { case GO_DOWN: case GO_DOWN_X: assert lvl &gt; 0 : lvl; assert p.pageId != pageId; assert p.fwdId != fwdId || fwdId == 0; res = p.tryReplaceInner(pageId, page, fwdId, lvl); if (res != RETRY) // Go down recursively. res = putDown(p, p.pageId, p.fwdId, lvl - 1); if (res == RETRY_ROOT || p.isFinished()) return res; if (res == RETRY) checkInterrupted(); continue; // We have to insert split row to this level or it is a retry. case FOUND: // Do replace. assert lvl == 0 : "This replace can happen only at the bottom level."; return p.tryReplace(pageId, page, fwdId, lvl); case NOT_FOUND: // Do insert. assert lvl == p.btmLvl : "must insert at the bottom level"; assert p.needReplaceInner == FALSE : p.needReplaceInner + " " + lvl; return p.tryInsert(pageId, page, fwdId, lvl); default: return res; } } } finally { if (p.canRelease(pageId, lvl)) releasePage(pageId, page); } }</span></span></code> </pre> <br><p>  La seule différence est qu'après la détection de la position, le code se transforme en <code>replace</code> et <code>insert</code> .  Vous ne pouvez plus regarder le code de <code>remove</code> .  Le mécanisme de base est celui des tentatives répétées de parcourir récursivement l'arborescence avec un objet spécial en fonction de l'opération: <code>Get</code> , <code>Put</code> ou <code>Remove</code> . </p><br><p>  <code>Invoke</code> fonctionne de la même manière, seule l'opération a lieu avec une copie de l'enregistrement, puis son type est déterminé: <code>NOOP</code> pour la lecture, <code>REMOVE</code> pour la suppression et <code>PUT</code> pour la mise à jour ou l'ajout, puis l'objet <code>Put</code> ou <code>Remove</code> correspondant est généré, qui est appliqué à l'enregistrement dans l'arborescence. </p><br><h1 id="ispolzovanie">  Utiliser </h1><br><p>  Ci-dessous, j'examinerai de plus près deux <code>BPlusTree</code> <code>CacheDataTree</code> : <code>CacheDataTree</code> et <code>PendingEntriesTree</code> .  Overboard est la mise en œuvre d'index - c'est un sujet pour une discussion séparée, pour lequel je ne suis pas encore prêt. </p><br><p>  Avant de poursuivre, je précise que la carte distribuée locale a une fonctionnalité <code>IgniteCache</code> et s'appelle <code>IgniteCache</code> - ci-après simplement un cache. </p><br><h2 id="cachedatatree"> <code>CacheDataTree</code> </h2> <br><p>  <code>CacheDataTree</code> est un mappage de plusieurs <code>IgniteCache</code> sur le disque.  Le tri est à plusieurs niveaux: triez d'abord par identifiant de cache pour regrouper les clés dans un cache, puis par hachage. </p><br><p>  <code>CacheDataTree</code> pas sur la plage, car les index sont implémentés dans les héritiers de <code>H2Tree extends BPlusTree</code> , donc le type spécifique de tri n'est pas important: tout est suffisant pour les opérations <code>put</code> et <code>get</code> .  La comparaison des hachages est plus rapide que les objets.  Mais plus important encore, un hachage uniforme remplira l'arbre plus densément. </p><br><p>  Les arbres s'équilibrent pour ne pas dégénérer en liste.  Mais si vous ajoutez des clés uniformément réparties à l'arborescence de recherche, elle sera automatiquement équilibrée.  Étant donné que les arbres B commencent à s'équilibrer lorsque des problèmes surviennent et que les hachages mélangent les clés de manière égale, le tri par hachage réduit la fréquence de l'équilibrage. </p><br><p>  L'utilisation de hachages dans l'arbre de recherche n'est pas une idée aussi étrange qu'il y paraît, son développement logique conduira à un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tri mappé de tableau Hash</a> . </p><br><h2 id="pendingentriestree"> <code>PendingEntriesTree</code> </h2> <br><p>  <code>PendingEntriesTree</code> stocke les clés des données au fil du temps et est utilisé comme défini.  Le tri est à plusieurs niveaux: d'abord trié par identifiant de cache pour regrouper les clés dans un cache, puis par durée de vie.  Vient ensuite un autre tour de comparaison - apparemment purement technique, pour distinguer les éléments.  À partir du tri, il est facile de deviner que cette classe est utilisée pour rechercher des plages.  Cette arborescence duplique les clés d'entrée du cache pour la préemption. </p><br><p>  Comprenez comment fonctionne cette aventure séparée. </p><br><div class="spoiler">  <b class="spoiler_title">Aventure</b> <div class="spoiler_text"><p>  Dans <code>IgniteCacheOffheapManagerImpl.expire()</code> prenez le curseur et supprimez les entrées de <code>PendingEntriesTree</code> .  Les entrées dans <code>CacheDataTree</code> sont supprimées dans la fermeture <code>c</code> , qui est passée dans les paramètres. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expire</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( GridCacheContext cctx, IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt; c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount )</span></span></span></span></code> </pre> <br><p>  Apache Ignite a récemment cessé de prendre en charge Java 7, la fermeture est donc créée via une classe anonyme. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt; expireC = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyx</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GridCacheEntryEx entry, GridCacheVersion obsoleteVer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> touch = !entry.isNear(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (log.isTraceEnabled()) log.trace(<span class="hljs-string"><span class="hljs-string">"Trying to remove expired entry from cache: "</span></span> + entry); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entry.onTtlExpired(obsoleteVer)) touch = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (GridCacheEntryRemovedException ignore) { entry = entry.context().cache().entryEx(entry.key()); touch = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (touch) entry.context().evicts().touch(entry, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } };</code> </pre><br><p>  Ce que nous recherchons est dans la méthode <code>GridCacheMapEntry.onTtlExpired()</code> , où la ligne précieuse se trouve dans le bloc <code>finally</code> . </p><br><pre> <code class="java hljs">cctx.cache().removeEntry(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre> </div></div><br><h1 id="detali-realizacii">  Détails d'implémentation </h1><br><h2 id="rabota-so-stranicami-v-offheap">  Travailler avec des pages dans Offheap </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Offheap</a> est une technique pour optimiser la gestion manuelle de la mémoire dans une langue avec un garbage collector. </p><br><p>  C'est un mythe qu'en raison du ramasse-miettes tout ralentit, les collecteurs coûtent généralement un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pourcentage misérable de performances</a> .  Même les gros tas en eux-mêmes ne sont pas un problème, car  les collecteurs fonctionnent de manière compétitive (par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CMS et G1</a> en Java), et les serveurs ont des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dizaines de cœurs</a> .  Bien sûr, le collecteur ajoute des pauses imprévisibles à l'application, ce qui est important pour les jeux, mais tolérable pour la base de données. </p><br><p>  Mais ce qui sera vraiment le problème, c'est une violation de l'hypothèse générationnelle sur un grand tas. </p><br><div class="spoiler">  <b class="spoiler_title">Hypothèses de génération</b> <div class="spoiler_text"><p>  Les optimisations GC utilisent l'hypothèse générationnelle.  Cette hypothèse existe en deux versions: forte et faible. </p><br><p>  <strong>Hypothèse générationnelle faible: la</strong> plupart des objets meurent jeunes. </p><br><p>  <strong>Une hypothèse forte sur les générations:</strong> plus l'objet est âgé, plus il vivra longtemps. </p><br><p>  Une hypothèse forte implique une faiblesse, mais pas l'inverse.  Idéalement, le GC devrait se contenter de remplir l'hypothèse faible, mais en pratique ce n'est pas le cas. </p><br><p>  Consultez la présentation d'Alexey Shipilev sur le nouveau GC en Java, si vous voulez mieux comprendre le sujet: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">deux</a> . </p></div></div><br><p>  Et ici, c'est une chose telle qu'avant l'avènement de PDS, Apache Ignite était positionné principalement comme un cache entre les services et une base de données de disques (par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hadoop</a> ).  Par conséquent, les cartes dans Ignite sont appelées <code>IgniteCache</code> et ont la fonctionnalité d'extrusion correspondante.  Et les caches violent simplement l'hypothèse générationnelle - en eux, la probabilité qu'un objet soit supprimé augmente avec le temps.  Par conséquent, dans ce cas, Offheap pour le stockage des données utilisateur améliore les performances. </p><br><p>  Plus de bonus: </p><br><ul><li>  Offheap facilite l'implémentation de structures contenant plus de éléments <code>Integer.MAX_VALUE</code> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Si vous conservez un groupe de moins de 32 Go, les liens pèseront 4 octets</a> , ce qui économise quelques gigaoctets. </li><li>  Puisque le collecteur construit un graphe d'objets, il consomme de la mémoire proportionnellement à leur nombre.  Et le nombre d'objets est proportionnel au tas.  Le collecteur consomme également un processeur, qui est mieux dépensé pour la compression de données, par exemple. </li><li>  Sur de très grands tas, même si l'hypothèse générationnelle n'est pas violée dans son ensemble, il y aura encore pas mal d'objets anciens en valeur absolue qui la violeront. </li></ul><br><p>  Étant donné que les données sont ensuite envoyées sur le disque, les objets sont sérialisés en mémoire directement via <code>unsafe</code> , puis cette zone de mémoire est utilisée pour le tampon d'E / S. </p><br><h2 id="write-ahead-log">  Écrire le journal à l'avance </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Write Ahead Log</a> est un journal des opérations avec une structure linéaire, ce qui lui coûte une constante, contrairement à un arbre.  L'arborescence est mise à jour moins fréquemment et si des données sont perdues en raison d'une chute, elles sont restaurées à partir du journal en appliquant des opérations à partir du dernier état enregistré.  Le résultat est une amélioration des performances sans compromettre la fiabilité.  Je vous conseille de jeter un œil à l'interface <code>IgniteWriteAheadLogManager</code> - il y a une documentation détaillée. </p><br><h2 id="obhod-uzla">  Contournement de noeud </h2><br><p>  Comme les nœuds dans les arbres B ne sont pas petits, ils sont contournés par la recherche binaire.  Pour cela, les descendants de la classe <code>BPlusTree.GetPageHandler</code> sont <code>BPlusTree.GetPageHandler</code> , et pour différentes opérations ils sont différents. </p><br><div class="spoiler">  <b class="spoiler_title">Implémentation de la recherche binaire</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findInsertionPoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lvl, BPlusIO&lt;L&gt; io, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> low, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cnt, L row, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> shift)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> row != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> high = cnt - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (low &lt;= high) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mid = (low + high) &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cmp = compare(lvl, io, buf, mid, row); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp == <span class="hljs-number"><span class="hljs-number">0</span></span>) cmp = -shift; <span class="hljs-comment"><span class="hljs-comment">// We need to fix the case when search row matches multiple data rows. //noinspection Duplicates if (cmp &lt; 0) low = mid + 1; else if (cmp &gt; 0) high = mid - 1; else return mid; // Found. } return -(low + 1); // Not found. }</span></span></code> </pre> <br><p>  La méthode de <code>compare</code> est différente pour différents descendants de <code>BPlusTree</code> .  Un indice négatif code l'absence d'un élément avec la position où il pourrait être.  <code>Collections.binarySearch</code> de la bibliothèque standard fait de même. </p><br><p>  Faites attention aux lignes suivantes. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp == <span class="hljs-number"><span class="hljs-number">0</span></span>) cmp = -shift;</code> </pre> <br><p>  Pour l'opération <code>findOne</code> , ce code ne fait rien, car  <code>shift</code> est mis à zéro, c'est-à-dire  si les mêmes clés se trouvent dans l'arborescence, elles en trouveront une arbitraire. </p><br><p>  Cependant, si vous recherchez la plage de cette manière, les éléments seront perdus, donc le <code>shift</code> est défini sur <code>1</code> .  Par conséquent, la recherche <em>ne trouve pas l'élément même s'il est présent</em> , mais il n'est pas important de rechercher la plage. </p></div></div><br><h2 id="spisok-listov">  Liste des fiches </h2><br><p>  Pour contourner efficacement la gamme, les feuilles sont liées à une liste.  <code>BPlusTree.ForwardCursor</code> , qui va de feuille en feuille, est renvoyé comme résultat de recherche.  Apparemment, le passage du curseur n'est pas isolé des autres opérations de l'arborescence, car  lors du passage, le verrou n'est pris que sur une seule page.  Je n'ai pas trouvé de mécanisme de synchronisation qui protège l'accès aux méthodes de curseur. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Étant donné que l'arborescence B + dans Apache Ignite est jeune par rapport à d'autres bases de données relationnelles, nous obtenons l'ensemble nécessaire pour une arborescence B + prête pour la production: </p><br><ul><li>  <strong>WAL</strong> offre une sécurité bon marché, en conséquence, l'arborescence se met rarement à jour sur le disque. </li><li>  <strong>Offheap</strong> avec des données sous forme sérialisée. </li><li>  <strong>Concurrence</strong> - pour des parties de l'arborescence chargées en mémoire. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr413749/">https://habr.com/ru/post/fr413749/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr413739/index.html">Comment nous avons scanné tout Internet et ce que nous avons appris</a></li>
<li><a href="../fr413741/index.html">Qu'est-ce que c'était et comment: impressions de l'équipe WWDC Redmadrobot</a></li>
<li><a href="../fr413743/index.html">Lancez LAMP et des centaines d'autres applications Web en quelques clics</a></li>
<li><a href="../fr413745/index.html">Un système d'alimentation sans fil a été développé pour tous les appareils électroniques du corps humain à la fois</a></li>
<li><a href="../fr413747/index.html">Passer par NULL</a></li>
<li><a href="../fr413751/index.html">Ruslan Cheremin et Maxim Gramin - travailler avec l'environnement sur jug.msk.ru</a></li>
<li><a href="../fr413753/index.html">Eye in the Sky: drone de patrouille avec reconnaissance de la violence dans les foules et les lieux publics</a></li>
<li><a href="../fr413757/index.html">Base de données dans un projet commercial: que faire?</a></li>
<li><a href="../fr413759/index.html">La curiosité a découvert des matières organiques sur Mars, ce qui fait des milliards d'années</a></li>
<li><a href="../fr413761/index.html">Comment empêcher Windows 10 de redémarrer après les mises à jour</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>