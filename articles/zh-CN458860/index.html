<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ» ğŸ« ğŸ¤›ğŸ¾ è°ƒæ•´Linuxå†…æ ¸å‚æ•°ä»¥ä¼˜åŒ–PostgreSQL ğŸ‘¨ğŸ¿â€ğŸŒ¾ ğŸ¤§ ğŸ”²</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PostgreSQLçš„æœ€ä½³æ€§èƒ½å–å†³äºæ­£ç¡®å®šä¹‰çš„æ“ä½œç³»ç»Ÿå‚æ•°ã€‚ æ“ä½œç³»ç»Ÿå†…æ ¸å‚æ•°è°ƒæ•´ä¸å½“ä¼šé™ä½æ•°æ®åº“æœåŠ¡å™¨çš„æ€§èƒ½ã€‚ å› æ­¤ï¼Œå¿…é¡»æ ¹æ®æ•°æ®åº“æœåŠ¡å™¨åŠå…¶å·¥ä½œè´Ÿè½½æ¥é…ç½®è¿™äº›å‚æ•°ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºä¸€äº›é‡è¦çš„Linuxå†…æ ¸å‚æ•°ï¼Œè¿™äº›å‚æ•°å¯èƒ½ä¼šå½±å“æ•°æ®åº“æœåŠ¡å™¨çš„æ€§èƒ½ä»¥åŠå¦‚ä½•å¯¹å…¶è¿›è¡Œè°ƒä¼˜ã€‚ 

 SHMMAX ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>è°ƒæ•´Linuxå†…æ ¸å‚æ•°ä»¥ä¼˜åŒ–PostgreSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458860/"><img width="30%" align="left" src="https://habrastorage.org/webt/dy/qf/mh/dyqfmhq5wntmbisfsdahfiwc_-y.jpeg">  PostgreSQLçš„æœ€ä½³æ€§èƒ½å–å†³äºæ­£ç¡®å®šä¹‰çš„æ“ä½œç³»ç»Ÿå‚æ•°ã€‚ æ“ä½œç³»ç»Ÿå†…æ ¸å‚æ•°è°ƒæ•´ä¸å½“ä¼šé™ä½æ•°æ®åº“æœåŠ¡å™¨çš„æ€§èƒ½ã€‚ å› æ­¤ï¼Œå¿…é¡»æ ¹æ®æ•°æ®åº“æœåŠ¡å™¨åŠå…¶å·¥ä½œè´Ÿè½½æ¥é…ç½®è¿™äº›å‚æ•°ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºä¸€äº›é‡è¦çš„Linuxå†…æ ¸å‚æ•°ï¼Œè¿™äº›å‚æ•°å¯èƒ½ä¼šå½±å“æ•°æ®åº“æœåŠ¡å™¨çš„æ€§èƒ½ä»¥åŠå¦‚ä½•å¯¹å…¶è¿›è¡Œè°ƒä¼˜ã€‚ <br><br><h2>  SHMMAX / SHMALL </h2><br>  <b>SHMMAX</b>æ˜¯ä¸€ä¸ªå†…æ ¸å‚æ•°ï¼Œç”¨äºç¡®å®šLinuxè¿›ç¨‹å¯ä»¥åˆ†é…çš„å•ä¸ªå…±äº«å†…å­˜æ®µçš„æœ€å¤§å¤§å°ã€‚ åœ¨9.2ç‰ˆä¹‹å‰ï¼ŒPostgreSQLä½¿ç”¨System Vï¼ˆSysVï¼‰ï¼Œå®ƒéœ€è¦SHMMAXé…ç½®ã€‚  9.2ä¹‹åï¼ŒPostgreSQLåˆ‡æ¢åˆ°POSIXå…±äº«å†…å­˜ã€‚ å› æ­¤ï¼Œç°åœ¨éœ€è¦æ›´å°‘çš„System Vå…±äº«å†…å­˜å­—èŠ‚ã€‚ <br><br> åœ¨9.3ç‰ˆä¹‹å‰ï¼ŒSHMMAXæ˜¯æœ€é‡è¦çš„å†…æ ¸å‚æ•°ã€‚  SHMMAXå€¼ä»¥å­—èŠ‚ä¸ºå•ä½æŒ‡å®šã€‚ <br><a name="habracut"></a><br> åŒæ ·ï¼Œ <b>SHMALL</b>æ˜¯å¦ä¸€ä¸ªç”¨äºç¡®å®š <br> ç³»ç»ŸèŒƒå›´çš„å…±äº«å†…å­˜é¡µé¢ã€‚ ä½¿ç”¨<i>ipcs</i>å‘½ä»¤æŸ¥çœ‹å½“å‰çš„SHMMAXï¼ŒSHMALLæˆ–SHMMIN <i>å€¼</i> ã€‚ <br><br>  <sup><b>SHM *è¯¦ç»†ä¿¡æ¯-Linux</b></sup> <br><br><pre><code class="bash hljs">$ ipcs -lm ------ Shared Memory Limits -------- max number of segments = 4096 max seg size (kbytes) = 1073741824 max total shared memory (kbytes) = 17179869184 min seg size (bytes) = 1</code> </pre> <br>  <sup><b>SHM *è¯¦ç»†ä¿¡æ¯-MacOS X</b></sup> <br><br><pre> <code class="bash hljs">$ ipcs -M IPC status from as of Thu Aug 16 22:20:35 PKT 2018 shminfo: shmmax: 16777216 (max shared memory segment size) shmmin: 1 (min shared memory segment size) shmmni: 32 (max number of shared memory identifiers) shmseg: 8 (max shared memory segments per process) shmall: 1024 (max amount of shared memory <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pages)</code> </pre><br>  PostgreSQLä½¿ç”¨<b>System V IPC</b>åˆ†é…å…±äº«å†…å­˜ã€‚ æ­¤å‚æ•°æ˜¯æœ€é‡è¦çš„å†…æ ¸å‚æ•°ä¹‹ä¸€ã€‚ æ¯å½“æ‚¨æ”¶åˆ°ä»¥ä¸‹é”™è¯¯æ¶ˆæ¯æ—¶ï¼Œå°±æ„å‘³ç€æ‚¨å…·æœ‰è¾ƒä½ç‰ˆæœ¬çš„PostgreSQLï¼Œå¹¶ä¸”SHMMAXå€¼éå¸¸ä½ã€‚ æœŸæœ›ç”¨æˆ·å°†æ ¹æ®ä»–ä»¬å°†è¦ä½¿ç”¨çš„å…±äº«å†…å­˜æ¥è°ƒæ•´å’Œå¢åŠ è¯¥å€¼ã€‚ <br><br><h3> å¯èƒ½çš„é…ç½®é”™è¯¯ </h3><br> å¦‚æœæœªæ­£ç¡®é…ç½®SHMMAXï¼Œåˆ™å°è¯•ä½¿ç”¨<i>initdb</i>å‘½ä»¤åˆå§‹åŒ–PostgreSQLé›†ç¾¤æ—¶å¯èƒ½ä¼šæ”¶åˆ°é”™è¯¯æ¶ˆæ¯ã€‚ <br><br>  <sup><b>initdbå¤±è´¥</b></sup> <br> <code>DETAIL: Failed system call was shmget(key=1, size=2072576, 03600). <br> <br> HINT: This error usually means that PostgreSQL's request for a shared memory segment exceeded your kernel's SHMMAX parameter. <br> You can either reduce the request size or reconfigure the kernel with larger SHMMAX. To reduce the request size (currently 2072576 bytes), <br> reduce PostgreSQL's shared memory usage, perhaps by reducing shared_buffers or max_connections. <br> <br> If the request size is already small, it's possible that it is less than your kernel's SHMMIN parameter, <br> in which case raising the request size or reconfiguring SHMMIN is called for. <br> <br> The PostgreSQL documentation contains more information about shared memory configuration. child process exited with exit code 1</code> <br> <br> åŒæ ·ï¼Œä½¿ç”¨<i>pg_ctl</i>å‘½ä»¤å¯åŠ¨PostgreSQLæœåŠ¡å™¨æ—¶ï¼Œæ‚¨å¯èƒ½ä¼šæ”¶åˆ°é”™è¯¯æ¶ˆæ¯ã€‚ <br><br>  <sup><b>pg_ctlæ•…éšœ</b></sup> <br> <code>DETAIL: Failed system call was shmget(key=5432001, size=14385152, 03600). <br> <br> HINT: This error usually means that PostgreSQL's request for a shared memory segment exceeded your kernel's SHMMAX parameter. <br> <br> You can either reduce the request size or reconfigure the kernel with larger SHMMAX.; To reduce the request size (currently 14385152 bytes), reduce PostgreSQL's shared memory usage, perhaps by reducing shared_buffers or max_connections. <br> <br> If the request size is already small, it's possible that it is less than your kernel's SHMMIN parameter, <br> in which case raising the request size or reconfiguring SHMMIN is called for. <br> <br> The PostgreSQL documentation contains more information about shared memory configuration.</code> <br> <br><h3> äº†è§£å®šä¹‰ä¸Šçš„å·®å¼‚ </h3><br> åœ¨Linuxå’ŒMacOS Xä¸Šï¼ŒSHMMAX / SHMALLå‚æ•°çš„å®šä¹‰ç•¥æœ‰ä¸åŒï¼š <br><br><ul><li>  Linuxï¼škernel.shmmaxï¼Œkernel.shmall </li><li>  MacOS Xï¼škern.sysv.shmmaxï¼Œkern.sysv.shmall </li></ul><br>  <i>sysctl</i>å‘½ä»¤å¯ç”¨äºä¸´æ—¶æ›´æ”¹å€¼ã€‚ è¦è®¾ç½®å¸¸é‡å€¼ï¼Œè¯·åœ¨<i>/etc/sysctl.confä¸­</i>æ·»åŠ ä¸€ä¸ªæ¡ç›®ã€‚ ç»†èŠ‚åœ¨ä¸‹é¢ç»™å‡ºã€‚ <br><br>  <sup><b>åœ¨MacOS Xä¸Šæ›´æ”¹å†…æ ¸è®¾ç½®</b></sup> <br><br><pre> <code class="plaintext hljs"># Get the value of SHMMAX sudo sysctl kern.sysv.shmmax kern.sysv.shmmax: 4096 # Get the value of SHMALL sudo sysctl kern.sysv.shmall kern.sysv.shmall: 4096 # Set the value of SHMMAX sudo sysctl -w kern.sysv.shmmax=16777216 kern.sysv.shmmax: 4096 -&gt; 16777216 # Set the value of SHMALL sudo sysctl -w kern.sysv.shmall=16777216 kern.sysv.shmall: 4096 -&gt; 16777216</code> </pre> <br>  <sup><b>æ›´æ”¹Linuxå†…æ ¸å‚æ•°</b></sup> <br><br><pre> <code class="plaintext hljs"># Get the value of SHMMAX sudo sysctl kernel.shmmax kernel.shmmax: 4096 # Get the value of SHMALL sudo sysctl kernel.shmall kernel.shmall: 4096 # Set the value of SHMMAX sudo sysctl -w kernel.shmmax=16777216 kernel.shmmax: 4096 -&gt; 16777216 # Set the value of SHMALL sudo sysctl -w kernel.shmall=16777216 kernel.shmall: 4096 -&gt; 16777216</code> </pre> <br>  <sub><b>è®°ä½</b> ï¼šè¦ä½¿æ›´æ”¹æ°¸ä¹…<font color="blue">ç”Ÿæ•ˆ</font> ï¼Œè¯·å°†è¿™äº›å€¼æ·»åŠ åˆ°<font color="blue">/etc/sysctl.confä¸­</font></sub> <br><br><h2> å¤§é¡µé¢ï¼ˆå¤§é¡µé¢ï¼‰ </h2><br>  Linuxé»˜è®¤ä¸º4Ké¡µé¢ï¼ŒBSDä½¿ç”¨<i>Super Pages</i> ï¼ŒWindowsä½¿ç”¨<i>Large Pages</i> ã€‚ é¡µé¢æ˜¯åˆ†é…ç»™è¿›ç¨‹çš„ä¸€å—RAMã€‚ ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å‡ é¡µï¼Œå…·ä½“å–å†³äºå†…å­˜è¦æ±‚ã€‚ ä¸€ä¸ªè¿›ç¨‹éœ€è¦çš„å†…å­˜è¶Šå¤šï¼Œåˆ†é…ç»™å®ƒçš„é¡µé¢å°±è¶Šå¤šã€‚ æ“ä½œç³»ç»Ÿæ”¯æŒè¿›ç¨‹çš„é¡µé¢åˆ†é…è¡¨ã€‚ é¡µé¢å¤§å°è¶Šå°ï¼Œè¡¨è¶Šå¤§ï¼Œåˆ™åœ¨æ­¤é¡µé¢è¡¨ä¸­æŸ¥æ‰¾é¡µé¢æ‰€èŠ±è´¹çš„æ—¶é—´è¶Šé•¿ã€‚ å› æ­¤ï¼Œå¤§é¡µé¢ä½¿æ‚¨å¯ä»¥å‡å°‘å¼€é”€æ¥ä½¿ç”¨å¤§é‡å†…å­˜ã€‚ æ›´å°‘çš„é¡µé¢æµè§ˆé‡ï¼Œæ›´å°‘çš„é¡µé¢é”™è¯¯ï¼Œé€šè¿‡å¤§å‹ç¼“å†²åŒºçš„æ›´å¿«çš„è¯»/å†™æ“ä½œã€‚ ç»“æœæ˜¯æé«˜äº†æ€§èƒ½ã€‚ <br><br>  PostgreSQLåœ¨Linuxä¸Šä»…æ”¯æŒå¤§é¡µé¢ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒLinuxä½¿ç”¨4 KBçš„å†…å­˜é¡µé¢ï¼Œå› æ­¤ï¼Œå¦‚æœæ‚¨æ‰§è¡Œäº†å¤ªå¤šçš„å†…å­˜æ“ä½œï¼Œåˆ™å¿…é¡»å®‰è£…æ›´å¤§çš„é¡µé¢ã€‚ ä½¿ç”¨2 MBå’Œæœ€å¤§1 GBçš„å¤§é¡µé¢æ—¶ï¼Œæ€§èƒ½ä¼šæœ‰æ‰€æé«˜ã€‚ å¯ä»¥åœ¨å¯åŠ¨æ—¶è®¾ç½®è¾ƒå¤§çš„é¡µé¢å¤§å°ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨<i>cat / proc / meminfo |</i>å‘½ä»¤è½»æ¾æ£€æŸ¥å¤§é¡µé¢çš„å‚æ•°åŠå…¶åœ¨Linuxè®¡ç®—æœºä¸Šçš„ä½¿ç”¨<i>ã€‚</i>  <i>grep -iå·¨å¤§</i> ã€‚ <br><br>  <sup><b>è·å–æœ‰å…³å¤§é¡µé¢çš„ä¿¡æ¯ï¼ˆä»…Linuxï¼‰</b></sup> <br><br><pre> <code class="bash hljs">Note: This is only <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Linux, <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> other OS this operation is ignored$ cat /proc/meminfo | grep -i huge AnonHugePages:        0 kB ShmemHugePages:       0 kB HugePages_Total:      0 HugePages_Free:       0 HugePages_Rsvd:       0 HugePages_Surp:       0 Hugepagesize:      2048 kB</code> </pre> <br> åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå°½ç®¡å¤§é¡µé¢å¤§å°è®¾ç½®ä¸º2048ï¼ˆ2 MBï¼‰ï¼Œä½†å¤§é¡µé¢æ€»æ•°ä¸º0ã€‚è¿™æ„å‘³ç€å¤§é¡µé¢è¢«ç¦ç”¨ã€‚ <br><br><h3> ç¡®å®šå¤§é¡µæ•°çš„è„šæœ¬ </h3><br> è¿™ä¸ªç®€å•çš„è„šæœ¬è¿”å›æ‰€éœ€çš„å¤§é¡µé¢æ•°ã€‚ å½“PostgreSQLè¿è¡Œæ—¶ï¼Œåœ¨LinuxæœåŠ¡å™¨ä¸Šè¿è¡Œè„šæœ¬ã€‚ éªŒè¯æ˜¯å¦ä¸º<i>$ PGDATA</i>ç¯å¢ƒå˜é‡è®¾ç½®äº†PostgreSQLæ•°æ®ç›®å½•ã€‚ <br><br>  <sup><b>è·å–æ‰€éœ€çš„å¤§é¡µé¢æ•°</b></sup> <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash pid=`head -1 $PGDATA/postmaster.pid` echo "Pid:           $pid" peak=`grep ^VmPeak /proc/$pid/status | awk '{ print $2 }'` echo "VmPeak:          $peak kB" hps=`grep ^Hugepagesize /proc/meminfo | awk '{ print $2 }'` echo "Hugepagesize:  $hps kB" hp=$((peak/hps)) echo Set Huge Pages:    $hp</span></span></code> </pre> <br> è„šæœ¬è¾“å‡ºå¦‚ä¸‹ï¼š <br><br>  <sup><b>è„šæœ¬è¾“å‡º</b></sup> <br><br><pre> <code class="bash hljs">Pid:           12737 VmPeak:        180932 kB Hugepagesize:  2048 kB Set Huge Pages: 88</code> </pre> <br> å¤§é¡µé¢çš„å»ºè®®å€¼ä¸º88ï¼Œå› æ­¤åº”å°†å…¶è®¾ç½®ä¸º88ã€‚ <br><br>  <sup><b>å®‰è£…å¤§é¡µé¢</b></sup> <br><br><pre> <code class="bash hljs">sysctl -w vm.nr_hugepages=88</code> </pre> <br> ç°åœ¨æ£€æŸ¥å¤§é¡µé¢ï¼Œæ‚¨ä¼šçœ‹åˆ°æœªä½¿ç”¨å¤§é¡µé¢ï¼ˆHugePages_Free = HugePages_Totalï¼‰ã€‚ <br><br>  <sup><b>å†æ¬¡å…³äºå¤§é¡µâ€‹â€‹é¢çš„ä¿¡æ¯ï¼ˆä»…Linuxï¼‰</b></sup> <br><br><pre> <code class="bash hljs">$ cat /proc/meminfo | grep -i huge AnonHugePages:        0 kB ShmemHugePages:       0 kB HugePages_Total:     88 HugePages_Free:      88 HugePages_Rsvd:       0 HugePages_Surp:       0 Hugepagesize:      2048 kB</code> </pre> <br> ç°åœ¨å°†huge_pagesè®¾ç½®ä¸º$ PGDATA / postgresql.confå¹¶é‡æ–°å¯åŠ¨æœåŠ¡å™¨ã€‚ <br><br>  <sup><b>åŒæ ·ï¼Œæœ‰å…³å¤§é¡µé¢çš„ä¿¡æ¯ï¼ˆä»…Linuxï¼‰</b></sup> <br><br><pre> <code class="bash hljs">$ cat /proc/meminfo | grep -i huge AnonHugePages:        0 kB ShmemHugePages:       0 kB HugePages_Total:     88 HugePages_Free:      81 HugePages_Rsvd:       64 HugePages_Surp:       0 Hugepagesize:      2048 kB</code> </pre> <br> ç°åœ¨æ‚¨å¯ä»¥çœ‹åˆ°å¾ˆå°‘ä½¿ç”¨å¤§é¡µé¢ã€‚ ç°åœ¨è®©æˆ‘ä»¬å°è¯•å‘æ•°æ®åº“ä¸­æ·»åŠ ä¸€äº›æ•°æ®ã€‚ <br><br>  <sup><b>ä¸€äº›ç”¨äºå›æ”¶å¤§é¡µé¢çš„æ•°æ®åº“æ“ä½œ</b></sup> <br><br><pre> <code class="sql hljs">postgres=<span class="hljs-comment"><span class="hljs-comment"># CREATE TABLE foo(a INTEGER); CREATE TABLE postgres=# INSERT INTO foo VALUES(generate_Series(1,10000000)); INSERT 0 10000000</span></span></code> </pre> <br> è®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬ç°åœ¨æ˜¯å¦ä½¿ç”¨æ¯”ä»¥å‰æ›´å¤§çš„é¡µé¢ã€‚ <br><br>  <sup><b>å†æ¬¡åœ¨å¤§é¡µé¢ä¸Šæ˜¾ç¤ºä¿¡æ¯ï¼ˆä»…Linuxï¼‰</b></sup> <br><br><pre> <code class="bash hljs">$ cat /proc/meminfo | grep -i huge AnonHugePages:        0 kB ShmemHugePages:       0 kB HugePages_Total:     88 HugePages_Free:      18 HugePages_Rsvd:       1 HugePages_Surp:       0 Hugepagesize:      2048 kB</code> </pre> <br> ç°åœ¨æ‚¨å¯ä»¥çœ‹åˆ°å¤§å¤šæ•°å¤§é¡µé¢éƒ½åœ¨ä½¿ç”¨ä¸­ã€‚ <br><br>  <sub>æ³¨æ„ï¼šæ­¤å¤„ä½¿ç”¨çš„HugePagesçš„è¿‘ä¼¼å€¼éå¸¸ä½ï¼Œå¯¹äºé£Ÿå“ç¯å¢ƒä¸­çš„æœºå™¨è€Œè¨€ï¼Œè¿™ä¸æ˜¯æ­£å¸¸å€¼ã€‚</sub>  <sub>è¯·è¯„ä¼°ç³»ç»Ÿæ‰€éœ€çš„é¡µé¢æ•°ï¼Œç„¶åæ ¹æ®è´Ÿè½½å’Œèµ„æºè¿›è¡Œç›¸åº”è®¾ç½®ã€‚</sub> <br><br><h3>  vm.swappiness </h3><br>  <b>vm.swappiness</b>æ˜¯å¦ä¸€ä¸ªå¯ä»¥å½±å“æ•°æ®åº“æ€§èƒ½çš„å†…æ ¸å‚æ•°ã€‚ æ­¤å‚æ•°ç”¨äºæ§åˆ¶Linuxä¸Šçš„äº¤æ¢è¡Œä¸ºï¼ˆåœ¨å†…å­˜ä¹‹é—´äº¤æ¢é¡µé¢ï¼‰ã€‚ å–å€¼èŒƒå›´æ˜¯0åˆ°100ã€‚å®ƒç¡®å®šè¦å¸è½½æˆ–å¸è½½å¤šå°‘å†…å­˜ã€‚ é›¶è¡¨ç¤ºç¦ç”¨äº¤æ¢ï¼Œè€Œ100è¡¨ç¤ºâ€‹â€‹ç§¯æäº¤æ¢ã€‚ <br><br> é€šè¿‡è®¾ç½®è¾ƒä½çš„å€¼å¯ä»¥è·å¾—è‰¯å¥½çš„æ€§èƒ½ã€‚ <br><br> åœ¨è¾ƒæ–°çš„å†…æ ¸ä¸­å°†è¯¥å€¼è®¾ç½®ä¸º0å¯èƒ½ä¼šå¯¼è‡´OOM Killerï¼ˆLinuxå†…å­˜æ¸…é™¤è¿›ç¨‹ï¼‰ç»ˆæ­¢è¯¥è¿›ç¨‹ã€‚ å› æ­¤ï¼Œå¦‚æœè¦æœ€å°åŒ–äº¤æ¢ï¼Œå¯ä»¥å®‰å…¨åœ°å°†å€¼è®¾ç½®ä¸º1ã€‚  Linuxä¸Šçš„é»˜è®¤å€¼ä¸º60ã€‚è¾ƒé«˜çš„å€¼ä¼šä½¿MMUï¼ˆå†…å­˜ç®¡ç†å•å…ƒï¼‰ä½¿ç”¨æ¯”RAMæ›´å¤šçš„åˆ†é¡µç©ºé—´ï¼Œè€Œè¾ƒä½çš„å€¼ä¼šå°†æ›´å¤šçš„æ•°æ®/ä»£ç ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚ <br><br> è¾ƒä½çš„å€¼å¯ä»¥æé«˜PostgreSQLçš„æ€§èƒ½ã€‚ <br><br><h3>  vm.overcommit_memory / vm.overcommit_ratio </h3><br> åº”ç”¨ç¨‹åºæ¥æ”¶å†…å­˜å¹¶åœ¨ä¸å†éœ€è¦æ—¶é‡Šæ”¾å®ƒã€‚ ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºè·å–çš„å†…å­˜è¿‡å¤šï¼Œæ— æ³•é‡Šæ”¾å®ƒã€‚ è¿™å¯èƒ½ä¼šå¯¼è‡´OOMæ€æ‰‹ã€‚ ä»¥ä¸‹æ˜¯<b>vm.overcommit_memory</b>å‚æ•°çš„å¯èƒ½å€¼ï¼Œå¹¶æä¾›äº†æ¯ä¸ªè¯´æ˜ï¼š <br><br><ol><li> å¯å‘å¼è¿‡é‡ä½¿ç”¨ï¼ˆé»˜è®¤ï¼‰ï¼› åŸºäºæ ¸å¿ƒçš„å¯å‘å¼ </li><li> ä»ç„¶å…è®¸è¿‡é‡ä½¿ç”¨ </li><li> ä¸è¦è¿‡åº¦ä½¿ç”¨ï¼Œä¸è¦è¶…è¿‡è¿‡é‡ä½¿ç”¨æ¯”ä¾‹ã€‚ </li></ol><br>  <i>é“¾æ¥ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https</a> ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">//www.kernel.org/doc/Documentation/vm/overcommit-accounting</a></i> <br><br>  <b>vm.overcommit_ratio-</b>å¯ç”¨äºè¿‡è½½çš„RAMç™¾åˆ†æ¯”ã€‚ åœ¨å…·æœ‰2 GB RAMçš„ç³»ç»Ÿä¸­ï¼Œå€¼ä¸º50ï¼…æœ€å¤šå¯ä»¥åˆ†é…3 GB RAMã€‚ <br><br>  vm.overcommit_memoryçš„å€¼ä¸º2å¯ä¸ºPostgreSQLæä¾›æ›´å¥½çš„æ€§èƒ½ã€‚ æ­¤å€¼å¯æœ€å¤§ç¨‹åº¦åœ°æé«˜æœåŠ¡å™¨è¿›ç¨‹çš„RAMä½¿ç”¨ç‡ï¼Œè€Œä¸ä¼šæœ‰è¢«OOMæ€æ‰‹è¿›ç¨‹æ€æ­»çš„ä»»ä½•é‡å¤§é£é™©ã€‚ è¯¥åº”ç”¨ç¨‹åºå°†èƒ½å¤Ÿé‡æ–°å¯åŠ¨ï¼Œä½†åªèƒ½åœ¨è¶…æ”¯èŒƒå›´å†…é‡æ–°å¯åŠ¨ï¼Œä»è€Œé™ä½äº†OOMæ€æ‰‹æ€æ­»è¿›ç¨‹çš„é£é™©ã€‚ å› æ­¤ï¼Œå€¼2çš„æ€§èƒ½æ¯”é»˜è®¤å€¼0æ›´å¥½ã€‚ä½†æ˜¯ï¼Œå¯ä»¥é€šè¿‡ç¡®ä¿ä¸ä¼šè¶…å‡ºå¯æ¥å—èŒƒå›´çš„å†…å­˜æ¥æé«˜å¯é æ€§ã€‚ è¿™æ¶ˆé™¤äº†è¯¥è¿‡ç¨‹å°†è¢«OOMæ€æ‰‹æ€æ­»çš„é£é™©ã€‚ <br><br> åœ¨éåˆ†é¡µç³»ç»Ÿä¸Šï¼Œvm.overcommit_memoryç­‰äº2å¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚ <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.postgresql.org/docs/current/static/kernel-resources.html#LINUX-MEMORY-OVERCOMMIT</a> <br><br><h3>  vm.dirty_background_ratio / vm.dirty_background_bytes </h3><br>  <b>vm.dirty_background_ratio</b>æ˜¯éœ€è¦å†™å…¥ç£ç›˜çš„è„é¡µæ‰€å å†…å­˜çš„ç™¾åˆ†æ¯”ã€‚ åœ¨åå°é‡ç½®ä¸ºç£ç›˜ã€‚ è¯¥å‚æ•°çš„å–å€¼èŒƒå›´æ˜¯0åˆ°100ã€‚ ä½†æ˜¯ï¼Œä½äº5çš„å€¼å¯èƒ½æ— æ•ˆï¼Œå¹¶ä¸”æŸäº›å†…æ ¸ä¸æ”¯æŒè¯¥å€¼ã€‚ åœ¨å¤§å¤šæ•°Linuxç³»ç»Ÿä¸Šï¼Œé»˜è®¤å€¼ä¸º10ã€‚ æ‚¨å¯ä»¥ä»¥è¾ƒä½çš„é€Ÿåº¦æé«˜å¯†é›†è®°å½•æ“ä½œçš„æ€§èƒ½ï¼Œè¿™æ„å‘³ç€Linuxå°†åœ¨åå°è½¬å‚¨è„é¡µã€‚ <br><br> æ‚¨éœ€è¦æ ¹æ®ç£ç›˜é€Ÿåº¦è®¾ç½®<b>vm.dirty_background_bytes</b>çš„å€¼ã€‚ <br><br> è¿™ä¸¤ä¸ªå‚æ•°æ²¡æœ‰â€œå¥½â€å€¼ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªå‚æ•°å‡å–å†³äºç¡¬ä»¶ã€‚ ä½†æ˜¯ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå°†vm.dirty_background_ratioè®¾ç½®ä¸º5å¹¶å°†vm.dirty_background_bytesè®¾ç½®ä¸ºç£ç›˜é€Ÿåº¦çš„25ï¼…ä¼šå°†æ€§èƒ½æé«˜åˆ°25ï¼…ã€‚ <br><br><h3>  vm.dirty_ratio /è„å­—èŠ‚ </h3><br> è¿™ä¸<b>vm.dirty_background_ratio / dirty_background_bytes</b>ç›¸åŒï¼Œé™¤äº†åœ¨å·¥ä½œä¼šè¯ä¸­æ‰§è¡Œé‡ç½®ä¼šé˜»æ­¢åº”ç”¨ç¨‹åºã€‚ å› æ­¤ï¼Œvm.dirty_ratioåº”è¯¥é«˜äº<b>vm.dirty_background_ratio</b> ã€‚ è¿™æ ·å¯ä»¥ç¡®ä¿åå°è¿›ç¨‹å°†å°½æ—©å¯åŠ¨ï¼Œä»è€Œé¿å…å°½å¯èƒ½å¤šåœ°é˜»å¡åº”ç”¨ç¨‹åºã€‚ æ‚¨å¯ä»¥æ ¹æ®ç£ç›˜I / Oè´Ÿè½½æ¥è°ƒæ•´è¿™ä¸¤ä¸ªæ¯”ç‡ä¹‹é—´çš„å·®å¼‚ã€‚ <br><br><h2> æ€»ç»“ </h2><br> æ‚¨å¯ä»¥é…ç½®å…¶ä»–å‚æ•°æ¥æé«˜ç”Ÿäº§ç‡ï¼Œä½†æ˜¯è¿™ç§æ”¹è¿›å°†æ˜¯å¾®ä¸è¶³é“çš„ï¼Œå¹¶ä¸”æ‚¨ä¸ä¼šè·å¾—å¤ªå¤šæ”¶ç›Šã€‚ æˆ‘ä»¬å¿…é¡»è®°ä½ï¼Œå¹¶éæ‰€æœ‰å‚æ•°éƒ½é€‚ç”¨äºæ‰€æœ‰ç±»å‹çš„åº”ç”¨ç¨‹åºã€‚ å½“æˆ‘ä»¬é…ç½®æŸäº›è®¾ç½®æ—¶ï¼ŒæŸäº›åº”ç”¨ç¨‹åºå¯ä»¥æ›´å¥½åœ°å·¥ä½œï¼Œè€Œæœ‰äº›åˆ™ä¸èƒ½ã€‚ æ‚¨å¿…é¡»åœ¨é¢„æœŸå·¥ä½œé‡å’Œåº”ç”¨ç¨‹åºç±»å‹çš„è¿™äº›å‚æ•°çš„é…ç½®ä¹‹é—´æ‰¾åˆ°é€‚å½“çš„å¹³è¡¡ï¼Œå¹¶ä¸”åœ¨é…ç½®æ—¶ï¼Œå¿…é¡»è€ƒè™‘æ“ä½œç³»ç»Ÿçš„è¡Œä¸ºã€‚ é…ç½®å†…æ ¸å‚æ•°å¹¶ä¸åƒè°ƒæ•´æ•°æ®åº“å‚æ•°é‚£æ ·å®¹æ˜“ï¼šåœ¨æ­¤å¤„ç»™å‡ºå»ºè®®æ›´åŠ å›°éš¾ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN458860/">https://habr.com/ru/post/zh-CN458860/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN458846/index.html">å¦‚ä½•ä½¿ç”¨Unityå¼€å‘å¦ä¸€ä¸ªå¹³å°æ¸¸æˆã€‚ å¦ä¸€ä¸ªæ•™ç¨‹</a></li>
<li><a href="../zh-CN458848/index.html">Rust 1.36.0ç‰ˆæœ¬ï¼šæœªæ¥ç‰¹æ€§ï¼Œåˆ†é…ç¨³å®šå’ŒMaybeUninit <T></a></li>
<li><a href="../zh-CN458850/index.html">å»‰ä»·è€Œé«˜æ•ˆåœ°å­¦ä¹ è‹±è¯­ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN458854/index.html">MotionLayoutï¼šåŠ¨ç”»æ•ˆæœæ›´å¥½ï¼Œä»£ç æ›´å°‘</a></li>
<li><a href="../zh-CN458856/index.html">ä¾¿å®œå’Œæ˜‚è´µçš„AAAç”µæ± </a></li>
<li><a href="../zh-CN458864/index.html">Botå¼€å‘äººå‘˜äº‰å¤ºTamTam</a></li>
<li><a href="../zh-CN458866/index.html">å›¢é˜Ÿå¹³è¡¡å™¨åœ¨ã€Šæˆ˜è½¦ä¸–ç•Œï¼šé—ªå‡»æˆ˜ã€‹ä¸­çš„è¿ä½œæ–¹å¼</a></li>
<li><a href="../zh-CN458868/index.html">å¤§æ•°æ®ä¸­çš„å™ªéŸ³ã€‚ ç†µåˆ†æ</a></li>
<li><a href="../zh-CN458870/index.html">æˆ‘ä»¬æ¯å¤©éƒ½é¢ä¸´çš„æœ€æµè¡Œçš„è®¡ç®—æœºé—®é¢˜</a></li>
<li><a href="../zh-CN458874/index.html">ASOæ¸…å•ï¼šæ–‡æœ¬ä¼˜åŒ–</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>