<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÖ üé§ üíÇ Iklan spanduk di aplikasi iOS üå† üë∏üèø üîû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hari ini kami membuka serangkaian artikel tentang apa yang biasanya tidak dibicarakan di konferensi teknis dan pertemuan. Posting ini dan selanjutnya ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Iklan spanduk di aplikasi iOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/426553/"><img src="https://habrastorage.org/webt/ce/j2/t9/cej2t9yugiyn0bnzyhfnwtckqmq.jpeg"><br><br>  Hari ini kami membuka serangkaian artikel tentang apa yang biasanya tidak dibicarakan di konferensi teknis dan pertemuan.  Posting ini dan selanjutnya akan memberi tahu Anda bagaimana mekanisme monetisasi bekerja di aplikasi hiburan iOS iFunny yang populer di AS, yang sedang kami kembangkan. <br><a name="habracut"></a><br>  Periklanan adalah salah satu cara utama untuk memonetisasi aplikasi gratis.  Tapi sekarang, opsi apa yang ada di 2011 ketika iFunny muncul?  Layanan ini awalnya dibangun sebagai bisnis yang kuat dan berkelanjutan, sehingga sejak hari pertama perusahaan memutuskan untuk tidak menggoda pengguna dan tidak terlibat dalam permainan dengan permodalan bersyarat. <br><br>  Pada saat itu, opsi utama untuk monetisasi adalah membuat versi layanan yang bebas, dan kemudian mencoba menjual fungsionalitas utama.  Konsumen masih muda, tidak berpengalaman dan tidak siap berpisah dengan jumlah yang lebih besar dari satu dolar. <br><br>  Matematika sederhana menunjukkan bahwa dengan konversi 10%, mendapatkan ARPU lebih dari 10 sen adalah tugas yang hampir mustahil. <br><br>  Kemudian saya harus memikirkan bagaimana cara lain Anda bisa memonetisasi produk.  Model periklanan telah bekerja dengan sangat baik di web, dan dapat diasumsikan bahwa ia akan segera mekar di ponsel juga. <br>  Secara umum, permulaan model monetisasi iklan seluler dapat dianggap sebagai penampilan AdWhirl - layanan yang memungkinkan Anda untuk mengintegrasikan SDK jaringan iklan dan memutarnya.  Penampilannya memungkinkan untuk meningkatkan FillRate ke rata-rata 50% di pasar dan menghasilkan pendapatan dari model periklanan setidaknya sebanding dengan penjualan satu dolar.  Prinsip pelaksanaan semua sumber permintaan yang mungkin dan organisasi persaingan di antara mereka telah menjadi pendorong utama pertumbuhan dalam industri periklanan dan terus dieksploitasi hingga hari ini. <br><br>  Tetapi semakin kompleks sistemnya, semakin tidak stabilnya, yang sama sekali tidak dapat diterima untuk layanan besar pada tingkat iFunny.  Mulai bergerak ke arah ini pada tahun 2011, perusahaan menciptakan salah satu mekanisme paling efektif untuk bekerja dengan spanduk seluler dan iklan asli dan meningkatkan pendapatan per pengguna sebanyak 40 kali, yang memungkinkan pengembangan tidak hanya proyek internal, tetapi juga berinvestasi di perusahaan lain. <br><br><h2>  MoPub dan perusahaan </h2><br>  Sejak 2012, kami telah pindah dari AdWhirl ke MoPub. <br><br>  MoPub adalah platform iklan seluler dengan kemampuan untuk menambahkan modulnya sendiri, yang mencakup beberapa alat hebat: <br><br><ul><li>  Pasar MoPub - pertukaran iklan sendiri; </li><li>  mediator jaringan periklanan untuk bekerja dengan jaringan eksternal; </li><li>  mekanisme pemesanan yang memungkinkan Anda untuk secara mandiri menempatkan spanduk di aplikasi Anda sendiri dan menyesuaikan tampilan mereka. </li></ul><br>  Keuntungan utama MoPub: <br><br><ul><li>  mampu bekerja dengan sebagian besar jaringan iklan; </li><li>  mekanisme yang jelas untuk menghubungkan jaringan pihak ketiga yang baru; </li><li>  open source </li><li>  sejumlah besar pengaturan dasar dan penargetan; </li><li>  sebuah komunitas besar di sekitar jaringan, bahkan ada konferensi sendiri. </li></ul><br>  MoPub juga memiliki kekurangan: <br><br><ul><li> permintaan kumpulan pada GitHub tidak diterima dan tidak ada reaksi sama sekali terhadap mereka; </li><li>  panel kontrolnya sangat kompleks, dan bagi pengembang, ketika melakukan debugging, dibutuhkan beberapa waktu untuk mempelajari strukturnya. </li></ul><br><h2>  Kekuatan kebenaran </h2><br>  Seperti pahlawan dari satu film Rusia berkata: "Kekuatan itu sebenarnya."  Pada bagian ini, saya akan berbicara tentang kesulitan yang kita, sebagai pengembang aplikasi, harus hadapi setelah jutaan unduhan pertama iFunny, pertumbuhan pemirsa dan lalu lintas iklan dari lebih dari 100 mitra. <br><br><h3>  Konten </h3><br>  Pasar periklanan adalah "kasta" perusahaan teknologi yang sangat tertutup, tetapi pada saat yang sama, agregator memiliki jaringan mitra yang besar: dari perusahaan besar yang bekerja dengan jutaan anggaran hingga perusahaan kecil yang dirancang untuk audiens target tertentu. <br><br>  Kedekatan dan fragmentasi mitra ini, terlepas dari spanduk pra-moderasi dan aturan yang cukup ketat pada konten iklan, tidak memungkinkan penjual iklan yang paling jujur ‚Äã‚Äãuntuk menerbitkan materi iklan yang dilarang atau merusak pengalaman pengguna dalam aplikasi. <br><br>  Ada beberapa kategori utama konten "cabul" dalam spanduk iklan: <br><br><ul><li>  konten porno.  Baru-baru ini, tampaknya semakin sedikit, tetapi bagaimanapun terjadi.  Kami tidak dapat menerbitkan konten ini di artikel, sehingga gambarnya tidak ada di sini </li><li>  peringatan sistem dalam spanduk, contohnya dapat dilihat di salah satu pengguna <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">twitter.com/IfunnyStates/status/1029393804749668352</a> </li><li>  konten dengan suara.  Suara tidak dilarang oleh jaringan iklan, maupun animasi, tetapi jika suara diputar tanpa berinteraksi dengan antarmuka, ini dianggap oleh pengguna sebagai bug aplikasi dan secara negatif memengaruhi pengalaman pengguna </li><li>  meraih perhatian.  Spanduk yang bagus harus menarik perhatian pengguna, tetapi ini tidak selalu terjadi dengan cara yang jujur: kadang-kadang video yang berkelip jatuh ke dalam spanduk.  Cara lain yang tidak jujur ‚Äã‚Äãuntuk membuat pengguna mengetuk spanduk adalah dengan mensimulasikan antarmuka aplikasi, misalnya seperti ini: <br><br><img src="https://habrastorage.org/webt/p5/3u/lk/p53ulkue4iz7ofr14t3i7xyrqpq.png"></li></ul><br>  Ngomong-ngomong, di Rusia, ketukan biasa pada spanduk ini dapat mengeluarkan langganan berbayar untuk beberapa operator seluler, dan Anda bahkan tidak akan mengetahuinya sampai Anda melihat detailnya.  Ini juga merupakan cara tidak jujur ‚Äã‚Äãuntuk bekerja dengan periklanan, tetapi operator di Amerika Serikat tidak memiliki kesempatan seperti itu. <br><br><h3>  Klik otomatis </h3><br>  Seperti yang ditunjukkan oleh pengalaman saya, ini adalah kasus yang sangat negatif bagi pengguna.  Dengan menggunakan kemampuan JavaScript, WKWebView atau UIWebView, serta lubang di dalam implementasi pustaka iklan, Anda dapat membuat iklan yang akan membuka konten spanduk itu sendiri dan mengarahkan pengguna keluar dari aplikasi. <br><br>  Untuk mengulangi masalah ini menggunakan contoh MoPub, cukup tambahkan kode javascript dari konten berikut ke spanduk: <br><br><pre><code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ifunny.co"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"testbutton"</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'testbutton'</span></span></span><span class="javascript">).click(); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Ini bekerja untuk waktu yang lama di banyak versi MoPub, hingga versi 4.13. <br><br>  Dengan menjelajahi implementasi MoPub, dimungkinkan untuk menghasilkan tautan yang lebih kompleks yang memungkinkan tidak hanya untuk membuka iklan di layar penuh, tetapi juga mengirim pengguna ke AppStore ke aplikasi tertentu dan bahkan tidak memperhitungkan tampilan spanduk. <br><br>  Ngomong-ngomong, dalam catatan rilis untuk versi 4.13.0 dari MoPub SDK untuk iOS tidak ada informasi tentang perbaikan ini, karena itu adalah lubang yang agak serius di SDK, dan mitra MoPub yang tidak jujur ‚Äã‚Äãmengeksploitasinya dengan cukup aktif.  Seperti yang ditunjukkan oleh log, yang akan saya bahas nanti, setiap hari saya harus memblokir hingga 2 juta upaya untuk membuka spanduk tanpa interaksi pengguna dengannya. <br><br>  Dalam kasus MoPub, ternyata mudah untuk menemukan dan mengulangi masalahnya, tetapi jaringan lain yang berfungsi dengan iFunny memiliki kode tertutup, dan Anda harus berurusan dengan klik-otomatis yang muncul dengan memblokir spanduk atau bahkan memutus jaringan untuk sementara waktu. <br>  iFunny bekerja erat dengan semua mitra periklanan dan memberi tahu mereka tentang spanduk tersebut.  Karena khalayak muda iFunny menarik bagi pengiklan, mitra bersedia untuk bertemu mereka dan menghapus iklan tersebut dari rotasi. <br><br><h3>  Kecelakaan </h3><br>  Kecelakaan selalu buruk.  Lebih buruk lagi, ketika mereka terjadi karena ketergantungan dengan sumber tertutup, dan Anda hanya dapat memengaruhi mereka secara tidak langsung.  Selama bertahun-tahun bekerja dengan periklanan di iFunnu, beberapa jenis kerusakan telah diidentifikasi untuk diri mereka sendiri, yang dapat dibagi menjadi beberapa kelompok. <br><br><ul><li>  Sistem </li></ul><br>  Ini termasuk pengecualian di perpustakaan jaringan, WKWebView (UIWebView), OpenGL. <br>  Sangat sulit untuk secara langsung mempengaruhi jenis crash ini, tetapi masih mungkin untuk mempengaruhi beberapa dari mereka, setelah sebelumnya mempelajari pengoperasian komponen WebView dengan WebGL. <br><br>  Beginilah tampilan dari crash seperti itu: <br><br> <code>1 libGPUSupportMercury.dylib gpus_ReturnNotPermittedKillClient + 12 <br> 2 AGXGLDriver gldUpdateDispatch + 7132 <br> 3 libGPUSupportMercury.dylib gpusSubmitDataBuffers + 172 <br> 4 AGXGLDriver gldUpdateDispatch + 12700 <br> 5 WebCore WebCore::GraphicsContext3D::reshape(int, int) + 524 <br> 6 WebCore WebCore::WebGLRenderingContextBase::initializeNewContext() + 712 <br> 7 WebCore WebCore::WebGLRenderingContextBase::WebGLRenderingContextBase(WebCore::HTMLCanvasElement*, WTF::RefPtr&lt;WebCore::GraphicsContext3D&gt;&amp;&amp;, WebCore::GraphicsContext3D::Attributes) + 512 <br> 8 WebCore WebCore::WebGLRenderingContext::WebGLRenderingContext(WebCore::HTMLCanvasElement*, WTF::PassRefPtr&lt;WebCore::GraphicsContext3D&gt;, WebCore::GraphicsContext3D::Attributes) + 36 <br> 9 WebCore WebCore::WebGLRenderingContextBase::create(WebCore::HTMLCanvasElement*, WebCore::WebGLContextAttributes*, WTF::String const&amp;) + 1272 <br> 10 WebCore WebCore::HTMLCanvasElement::getContext(WTF::String const&amp;, WebCore::CanvasContextAttributes*) + 520 <br> 11 WebCore WebCore::JSHTMLCanvasElement::getContext(JSC::ExecState&amp;) + 212 <br> 12 JavaScriptCore llint_entry + 27340 <br> 13 JavaScriptCore llint_entry + 24756 <br> 14 JavaScriptCore llint_entry + 24756 <br> 15 JavaScriptCore llint_entry + 24756 <br> 16 JavaScriptCore llint_entry + 25676 <br> 17 JavaScriptCore llint_entry + 24756 <br> 18 JavaScriptCore llint_entry + 24656 <br> 19 JavaScriptCore vmEntryToJavaScript + 260 <br> 20 JavaScriptCore JSC::JITCode::execute(JSC::VM*, JSC::ProtoCallFrame*) + 164 <br> 21 JavaScriptCore JSC::Interpreter::executeCall(JSC::ExecState*, JSC::JSObject*, JSC::CallType, JSC::CallData const&amp;, JSC::JSValue, JSC::ArgList const&amp;) + 348 <br> 22 JavaScriptCore JSC::profiledCall(JSC::ExecState*, JSC::ProfilingReason, JSC::JSValue, JSC::CallType, JSC::CallData const&amp;, JSC::JSValue, JSC::ArgList const&amp;, WTF::NakedPtr&lt;JSC::Exception&gt;&amp;) + 160 <br> 23 WebCore WebCore::JSEventListener::handleEvent(WebCore::ScriptExecutionContext*, WebCore::Event*) + 980 <br> 24 WebCore WebCore::EventTarget::fireEventListeners(WebCore::Event&amp;, WebCore::EventTargetData*, WTF::Vector&lt;WebCore::RegisteredEventListener, 1ul, WTF::CrashOnOverflow, 16ul&gt;&amp;) + 616 <br> 25 WebCore WebCore::EventTarget::fireEventListeners(WebCore::Event&amp;) + 324 <br> 26 WebCore WebCore::EventContext::handleLocalEvents(WebCore::Event&amp;) const + 108 <br> 27 WebCore WebCore::EventDispatcher::dispatchEvent(WebCore::Node*, WebCore::Event&amp;) + 876 <br> 28 WebCore non-virtual thunk to WebCore::HTMLScriptElement::dispatchLoadEvent() + 80 <br> 29 WebCore WebCore::ScriptElement::execute(WebCore::CachedScript*) + 360 <br> 30 WebCore WebCore::ScriptRunner::timerFired() + 456 <br> 31 WebCore WebCore::ThreadTimers::sharedTimerFiredInternal() + 144 <br> 32 WebCore WebCore::timerFired(__CFRunLoopTimer*, void*) + 24 <br> 33 CoreFoundation __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ + 24 <br> 34 CoreFoundation __CFRunLoopDoTimer + 868 <br> 35 CoreFoundation __CFRunLoopDoTimers + 240 <br> 36 CoreFoundation __CFRunLoopRun + 1568 <br> 37 CoreFoundation CFRunLoopRunSpecific + 440 <br> 38 WebCore RunWebThread(void*) + 452 <br> 39 libsystem_pthread.dylib _pthread_body + 236 <br> 40 libsystem_pthread.dylib _pthread_start + 280 <br> 41 libsystem_pthread.dylib thread_start + 0</code> <br> <br>  Selain itu, mereka terjadi secara eksklusif ketika meninggalkan latar belakang.  Ini disebabkan oleh fakta bahwa mesin OpenGL seharusnya tidak berfungsi ketika aplikasi berada di latar belakang. <br><br>  Perbaikan di sini ternyata cukup sederhana: <br><br>  Saat meninggalkan di latar belakang, Anda perlu mengambil tangkapan layar spanduk. <br><br>  Hapus Tampilan iklan dari layar sehingga komponen WebView berhenti menggunakan OpenGL. <br>  Saat Anda keluar dari latar belakang, kembalikan semuanya seperti semula. <br><br>  Dalam kode Objective-C, tampilannya seperti ini: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)onWillResignActive { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview) { <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsBeginImageContext</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.bounds.size); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.layer renderInContext:<span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetCurrentContext</span></span>()]; <span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *adViewScreenShot = <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetImageFromCurrentImageContext</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsEndImageContext</span></span>(); adViewThumbView = [[<span class="hljs-built_in"><span class="hljs-built_in">UIImageView</span></span> alloc] initWithImage:adViewScreenShot]; adViewThumbView.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> clearColor]; adViewThumbView.frame = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.frame; <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> adIndex = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview.subviews indexOfObject:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview insertSubview:adViewThumbView atIndex:adIndex]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView removeFromSuperview]; } } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)onDidBecomeActive { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView &amp;&amp; adViewThumbView) { <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> adIndex = [adViewThumbView.superview.subviews indexOfObject:adViewThumbView]; [adViewThumbView.superview insertSubview:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView atIndex:adIndex]; [adViewThumbView removeFromSuperview]; adViewThumbView = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; } }</code> </pre><br><ul><li>  Integrasi </li></ul><br>  Ini adalah masalah yang terjadi di persimpangan iFunny, Mopub dan penyedia iklan. <br>  Sebagai aturan, mereka muncul setelah memperbarui perpustakaan penyedia dan karena cara baru berinteraksi dengan mereka. <br><br>  Kasus terakhir adalah pada bulan Juni tahun ini, setelah pembaruan berikutnya dari salah satu perpustakaan yang digunakan.  Cara baru untuk menginisialisasi perpustakaan disarankan menggunakan singleton untuk mengonfigurasi pengaturan jaringan. <br><br>  Beralih ke itu dua kali, seperti yang terjadi dalam implementasi, secara berkala menyebabkan dekorasi dari utas utama, jadi saya harus membungkus inisialisasi dalam dispatch_once. <br><br>  Departemen QA iFunny dapat menguji perpustakaan periklanan dengan baik, sehingga masalah ini ditemukan selama pengujian pembaruan. <br><br><ul><li>  Tidak terduga </li></ul><br>  Jenis kerusakan ini tidak dapat dikontrol sama sekali, karena terjadi tanpa perubahan pada klien. <br><br>  Mereka dikaitkan dengan memperbarui backend mitra dan kurangnya kompatibilitas mundur.  Kerusakan seperti itu sering terjadi pada penyedia iklan besar, tetapi cepat diperbaiki, karena mereka memengaruhi sejumlah besar aplikasi pada saat yang bersamaan. <br><br>  Ada kasus-kasus ketika iFunny bebas macet per hari turun dari standar 99,8% menjadi 80%, dan jumlah komentar marah dalam cerita itu mencapai puluhan. <br><br><h4>  Performa </h4><br>  Iklan banner, sebagai suatu peraturan, menggunakan komponen WebView untuk menampilkan iklan, sehingga setiap banner yang ditampilkan adalah inisialisasi dari WebView baru dengan semua dependensinya. <br><br>  Selain itu, beberapa mitra juga menggunakan WebView untuk berkomunikasi dengan backend mereka sendiri, karena iklan banner di perangkat seluler adalah turunan dari iklan di web. <br><br>  Kebetulan setelah upgrade ada kebocoran memori di dalam perpustakaan baru.  Setelah kemunculan alat Memory Graph di Xcode, menjadi lebih mudah untuk menemukan kebocoran di perpustakaan pihak ketiga, jadi sekarang mitra dapat dengan cepat diberitahu tentang hal itu. <br><br>  Di bawah ini adalah GIF dari iFunny idle ketika tidak ada iklan untuk pengguna: <br><br><img src="https://habrastorage.org/webt/oq/eg/ul/oqegulmbyh7j3zejhcmf4g_oage.gif"><br><br><h2>  Solusi </h2><br>  Namun terlepas dari semua masalah yang dijelaskan di atas, iFunny stabil dan setiap hari menyebabkan senyum di antara jutaan penggunanya. <br><br>  Selama bertahun-tahun bekerja aktif dengan periklanan, tim pengembangan memiliki beberapa alat yang dapat dengan sukses memantau masalah periklanan dan menanggapinya tepat waktu. <br><br><h3>  Sistem pembalakan </h3><br>  Sekarang sistem logging pengecualian di iFunny telah menyebar ke seluruh aplikasi: untuk ini, kami menggunakan backend kami sendiri dengan basis di ClickHouse dan ditampilkan di Grafana. <br><br>  Tetapi tugas pertama untuk bekerja dengan log dalam aplikasi adalah tepatnya pencatatan situasi luar biasa dalam periklanan. <br><br>  Ada beberapa komponen terkait untuk menentukan apakah panggilan diteruskan ke iFunny.  Saya akan bercerita lebih banyak tentang mereka masing-masing. <br><br><h4>  IFAdView </h4><br>  Ini adalah turunan dari kelas MPAdView (bertanggung jawab untuk menampilkan iklan di MoPub). <br><br>  Metode hitTest: withEvent ditimpa di kelas ini: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *)hitTest:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)point withEvent:(<span class="hljs-built_in"><span class="hljs-built_in">UIEvent</span></span> *)event { <span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *hitView = [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> hitTest:point withEvent:event]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hitView) { [[IFAdsExceptionManager instance] triggerTouchView]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hitView; }</code> </pre> <br>  Dengan demikian, kami menetapkan pemicu pada fakta bahwa pengguna berinteraksi dengan iklan. <br><br><h4>  IFURLProtocol </h4><br>  Kami mewarisi dari NSURLProtocol dan menjelaskan metode ini: <br><br><pre> <code class="objectivec hljs">+ (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)canInitWithRequest:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLRequest</span></span> *)request { __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *wRequestURL = request.URL.absoluteString; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(dispatch_get_main_queue(), ^{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wRequestURL == <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itms-appss://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itms-apps://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itmss://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"http://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"https://itunes.apple.com"</span></span>]) { [[IFAdsExceptionManager instance] adsTriggerItunesURL:wRequestURL]; } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; }</code> </pre><br>  Ini adalah pemicu untuk membuka AppStore dari aplikasi, kami mencantumkan semua URL yang tersedia untuk ini. <br><br><h4>  IFAdsExceptionManager </h4><br>  Kelas yang mengumpulkan memicu dan menghasilkan catatan pengecualian di log. <br><br>  Untuk memperjelas apa pemicunya, saya akan menjelaskan setiap metode antarmuka kelas ini. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerTouchView;       . &lt;source lang=<span class="hljs-string"><span class="hljs-string">"objectivec"</span></span>&gt;- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerItunesURL:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)itunesURL;</code> </pre> <br>  Pemicu yang menentukan apakah pengalihan terjadi di iTunes. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerResignActive;</code> </pre> <br>  Pemicu untuk menentukan hilangnya aktivitas oleh aplikasi.  Ini membandingkan dua pemicu sebelumnya. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)resetTriggers;</code> </pre> <br>  Atur Ulang Pemicu.  Kami menelepon saat meninggalkan latar belakang atau saat kami membuka AppStore sendiri, misalnya, saat kami mengirim pengguna untuk memberi peringkat di versi iOS yang lebih lama. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastRequestedConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastLoadedConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastFailedConfiguration;</code> </pre> <br>  Properti untuk merekam iklan yang terakhir kali berhasil atau tidak berhasil diminta dan diunduh.  Diperlukan untuk membentuk pesan ke log. <br><br>  Dapat dilihat bahwa algoritma tersebut ternyata cukup sederhana, tetapi efektif.  Ini memungkinkan kami untuk melacak tidak hanya penemuan otomatis dari MoPub, tetapi juga dari jaringan lain. <br><br>  Baru-baru ini, iklan dengan buka-otomatis sering membuka SKStoreProductViewController, jadi sekarang kami sedang mengerjakan definisi buka-otomatis pengontrol ini.  Algoritma untuk mendefinisikan pengecualian ini akan sedikit lebih rumit, tetapi Objective-C Runtime akan membantu di sini. <br><br><h2>  Stand lokal </h2><br>  Berdasarkan sistem logging, iFunny juga mulai mengembangkan stand lokal untuk menerima dan men-debug iklan yang dilihat pengguna secara real time. <br><br>  Stand terdiri dari: <br><br><ul><li>  membangun agen </li><li>  perangkat </li><li>  suite tes untuk setiap penyedia </li></ul><br>  Salah satu solusi menarik yang digunakan di stand adalah IDFA dari keluhan pengguna untuk iklan nyata. <br><br>  Sejak sekitar 2016, kami berhenti menerima iklan nyata yang ditargetkan ke AS hanya menggunakan VPN, jadi kami harus mengganti perangkat IDFA dengan IDFA untuk pengguna nyata. <br><br>  Ini dilakukan dengan cukup mudah menggunakan Objective-C Runtime dan swizzling. <br>  Anda perlu mengganti metode advertisingIdentifier dari kelas ASIdentifierManager. <br><br>  Di sini kami melakukannya melalui kategori: <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASIdentifierManager</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDFARewrite</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASIdentifierManager</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDFARewrite</span></span></span><span class="hljs-class">) + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once_t</span></span> onceToken; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once</span></span>(&amp;onceToken, ^{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (AdsMonitorTests.customIDFA != <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> swizzleIDFA]; } }); } + (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)swizzleIDFA { Class <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]; SEL originalSelector = <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(advertisingIdentifier); SEL swizzledSelector = <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(swizzled_advertisingIdentifier); Method originalMethod = class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, originalSelector); Method swizzledMethod = class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, swizzledSelector); <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> didAddMethod = class_addMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (didAddMethod) { class_replaceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { method_exchangeImplementations(originalMethod, swizzledMethod); } } <span class="hljs-meta"><span class="hljs-meta">#pragma mark - Method Swizzling - (NSUUID *)swizzled_advertisingIdentifier { NSUUID *result = AdsMonitorTests.customIDFA; return result; } @end</span></span></code> </pre><br>  Metode yang dijelaskan dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel ini</a> digunakan untuk mentransfer IDFA pengguna ke build dari build agent. <br><br>  Sebagai kesimpulan, saya ingin mengatakan bahwa iklan banner bekerja sangat baik di Amerika Serikat, dan selama tujuh tahun penggunaan aktif sebagai metode utama monetisasi, iFunny telah belajar untuk bekerja dengan baik dengannya. <br><br>  Namun terlepas dari kenyataan bahwa spanduk membawa 75% dari pendapatan perusahaan, pekerjaan sedang dilakukan pada metode alternatif monetisasi dan beberapa pengalaman telah diperoleh dalam iklan asli dan penggunaan lelang iklan di pasar AS. <br><br>  Secara umum, ada sesuatu untuk diceritakan. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id426553/">https://habr.com/ru/post/id426553/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id426543/index.html">Cadangan stateful di Kubernetes</a></li>
<li><a href="../id426545/index.html">Joker 2018 bonus: streaming online gratis, pesta, pesta dan meja</a></li>
<li><a href="../id426547/index.html">Sebagai pencipta Android sedang mencoba untuk melepaskan "anti-smartphone" pertama</a></li>
<li><a href="../id426549/index.html">Jenis perangkat lunak baru untuk manajer produk</a></li>
<li><a href="../id426551/index.html">Trekz Air - bagaimana headphone konduksi tulang benar-benar terdengar</a></li>
<li><a href="../id426555/index.html">PC, tetapi bukan PC: Wawancara dengan Komite Program Joker</a></li>
<li><a href="../id426557/index.html">Keterampilan yang paling dicari dalam ilmu data</a></li>
<li><a href="../id426559/index.html">Jaringan saraf untuk pemrosesan gambar. Kata Alexander Savsunenko dari Skylum Software</a></li>
<li><a href="../id426561/index.html">Lima Besar: harus memiliki alat untuk mempercepat pembangunan</a></li>
<li><a href="../id426563/index.html">Buku alamat hierarki, perubahan email primer dan inovasi lainnya di Zimbra 8.8.10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>