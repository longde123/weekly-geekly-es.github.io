<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥢 👦🏽 🗡️ Windows Fehlertoleranter Druckserver 😞 👨🏻‍🔬 🚊</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ein echter Administrator kann nur dann ruhig schlafen, wenn alles gesichert, überwacht und dupliziert wird. Oder wenn er in einem guten Team arbeitet,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Windows Fehlertoleranter Druckserver</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414369/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/7x/lk/zl/7xlkzlpjw2oft9qotypwjalwdmy.png"></a> <br>  Ein echter Administrator kann nur dann ruhig schlafen, wenn alles gesichert, überwacht und dupliziert wird.  <s>Oder wenn er in einem guten Team arbeitet, in dem man immer anderen die Schuld geben kann.</s> <br>  Es kam vor, dass ich in meiner Arbeit hauptsächlich Microsoft-Produkte verwende, und ich kann sagen, dass das Unternehmen es ernst meint, seine Dienste zu sichern: Active Directory, Exchange DAG, SQL Always On, DFSR usw.  Wie überall gibt es sowohl sehr elegante und erfolgreiche Implementierungen als auch offensichtlich unbequeme und schwierige.  Es gibt auch eine Lösung für den Druckdienst, die jedoch Hyper-V-basiertes Clustering erfordert.  Und ich wollte eine einfache Lösung "out of the box", die keine zusätzliche Finanzierung erfordert.  Windows 2012 R2 wurde als Grundlage verwendet, aber höchstwahrscheinlich funktioniert das gleiche Schema problemlos auf allen Serverversionen ab Windows 2008 und sogar auf Client-Betriebssystemen ab Vista (Hallo an die Fans, die das Budget sparen!).  Wen kümmert es - ich bitte um eine Katze. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Haftungsausschluss</b> <div class="spoiler_text">  <s>Um die Arbeit der Indianer zu respektieren.</s> Da das Habr-Publikum hauptsächlich russischsprachig ist und Anfängern <s>die Arbeit</s> erleichtert, verwenden die Beispiele die russische Version der Windows-Oberfläche.  Links führen nach Möglichkeit auch zu russischsprachigen Ressourcen. <br></div></div><br><br><h2>  Ein bisschen Theorie </h2><br>  Wer Theorie nicht mag und mit Maus und Tastatur schneller klicken möchte, kann direkt zum nächsten Teil übergehen. <br>  Wie oben erwähnt, ist die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">offizielle Empfehlung</a> heute eine Lösung, die Hyper-V-Clustering und -Virtualisierung verwendet.  Außerdem hindert nichts daran, die Fehlertoleranz des Druckdienstes auf der Ebene des Virtualisierungssystems und nicht unbedingt von Hyper-V sicherzustellen, aber solche Lösungen kosten Geld. <br>  Ich wollte wirklich etwas Ähnliches wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DHCP-Failover</a> , aber für die Rolle eines Druckservers. <br>  Im Internet im Allgemeinen und im Habr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">im Besonderen wurde</a> nichts Passendes gefunden - und ich musste es selbst erfinden. <br><br>  <b>Das Wesentliche der Idee in einem Absatz</b> <br>  Die unten beschriebene Lösung basiert auf dem Dienstprogramm BrintBrm, das Teil der Standard-Windows- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Distribution ist und printmig ersetzt</a> . <br>  Der Standby-Server arbeitet im Standby-Modus und synchronisiert mit diesem Dienstprogramm die Einstellungen mit dem Hauptserver mit der angegebenen Frequenz.  Für Clients wurde in DNS ein CNAME mit einer kleinen TTL erstellt, der auf den Hauptserver verweist.  Bei einem Ausfall des Primärservers korrigiert der Administrator CNAME, indem er Clients auf den Sicherungsserver wechselt.  Das ist in der Tat alles. <br>  Wenn das Thema interessant ist und ich mich mit den bereits mit mir gefüllten Unebenheiten und den Möglichkeiten zur Umgehung des Rechens vertraut machen möchte, folgen Sie bitte als Nächstes. <br><br><h2>  Bevor Sie beginnen oder was Sie über PrintBrm wissen müssen </h2><br>  Also, was ist das, dieses PrintBrm-Dienstprogramm, dessen Hauptzweck darin besteht, den Druckserver zu bedienen? <br><ul><li>  Gut gepflegt.  Es verfügt über eine GUI-Implementierung namens <i>Print Migration</i> und kann über <i>das Print Management-</i> Snap-In gestartet werden.  Die GUI-Version ist weniger funktionsfähig und hat Probleme mit der Portportierung. </li><li>  Aufmerksam.  Standardmäßig werden die Drucker-ACLs des Druckservers verarbeitet.  Mit anderen Worten, wenn Sie das Drucken auf dem Drucker \\ Druckserver \ Drucker1 nur für Mitarbeiter zulassen, die Mitglieder der Gruppe <i>Accounting</i> AD sind, wird diese Einschränkung beim Import / Export berücksichtigt.  Oder nicht, wenn Sie den Schlüssel <i>-NOACL eingeben</i> .  Die ACL des Druckservers selbst wird jedoch unabhängig vom Schlüssel nicht verarbeitet. </li><li>  Stimmungsvoll.  Zum Zeitpunkt des Importierens von Parametern aus einer Datei muss der Zielserver über mindestens einen freigegebenen Drucker verfügen. Andernfalls wird eine Fehlermeldung angezeigt. </li><li>  Sanft.  Leerzeichen im Dateipfad verloren.  Beim Anblick der Anführungszeichen, die einen solchen Pfad umrahmen, ist er <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">verärgert</a> und gibt einen Fehler 0x8007007b aus. </li><li>  Bescheiden.  Wenn die angegebene Datei bereits vorhanden ist, während versucht wird, die Einstellungen zu exportieren, kann sie nicht überschrieben werden. Sie ist schüchtern zu fragen und endet mit einem Fehler. </li><li>  Geheimnisvoll.  Gibt immer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einen Exit-Code von 0 zurück</a> .  Es stellt sich heraus, das perfekte Programm. <br></li><li>  Neigt zum Nachdenken.  Es kann im Stadium von 100% Minuten für 5 und manchmal mehr einfrieren.  Aber dann überlegt er und beendet die Arbeit (es sei denn, Sie haben natürlich die Geduld, Strg + C nicht zu drücken). </li><li>  Plötzlich und widersprüchlich.  Kann <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">solche Überraschungen</a> arrangieren. </li><li>  Clever.  Kann Quellentreiber anderen zuweisen.  Mithilfe einer XML-Datei können Sie beispielsweise festlegen, dass alle HP Universal Printing PCL 5-Treiber in einer gespeicherten Datei auf dem Zielserver HP Universal Printing PCL 6 neu zugewiesen werden müssen. Ich habe sie in der Praxis nicht verwendet, sie kann jedoch für jemanden nützlich sein. </li><li>  Unberechenbar.  Ich konnte es nicht verwenden, um Einstellungen zwischen Domänen ohne Vertrauen zu übertragen, selbst mit dem Schalter -NOACL.  Entweder kann er es im Prinzip nicht oder meine Magie ist nicht stark genug. </li><li>  Sie können <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> besser kennenlernen, aber für diejenigen, die nicht zögern, direkt zu fragen, gibt es einen Schlüssel /? <br></li></ul><br><br>  Ich gebe zu, dass ich einige Funktionen zu Unrecht ignoriert habe.  Vielleicht hat sie sich in Windows 10/2016 anders verhalten.  Wenn es Informationen gibt, teilen Sie diese bitte mit. <br><br><h2>  Umweltvorbereitung </h2><br>  Es wird davon ausgegangen, dass Sie Active Directory bereits bereitgestellt haben und mindestens drei Möglichkeiten zum Deaktivieren kennen. Mindestens zwei davon wurden in der Praxis getestet. <br><br><div class="spoiler">  <b class="spoiler_title">Einige Texte</b> <div class="spoiler_text">  Wenn ich vom Thema des Artikels abweiche, stelle ich fest, dass mir die Bestellung gefällt, und ich bin dafür, dass jeder Netzwerkdrucker und MFP einen Aufkleber hat, der seinem Netzwerknamen entspricht.  Dies vereinfacht die Arbeit der IT-Mitarbeiter, wenn sie versuchen, vom Benutzer herauszufinden, auf welchem ​​bestimmten Katzenfotodrucker wichtige Analyseberichte in giftigen Säuretönen anstatt in empfindlichen Pistazientönen gedruckt sind.  <s>Es ist besser, solche Aufkleber auf die Unterseite des Druckers zu kleben, damit alle mehr Interesse haben und mehr Spaß haben.</s> <br>  Mir gefällt auch, wenn jeder Netzwerkdrucker in der internen DNS-Zone registriert ist.  Ein Windows-basierter DHCP-Server <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">kann dies problemlos tun</a> . <br>  Beispielsweise kann der Druckername das Format msk-prn001 oder sale-Drucker023 haben, und die Portnamen für diese Drucker auf dem Druckserver werden genau gleich benannt.  Aber das ist meine persönliche Präferenz, ich bin bereit, Einwände in den Kommentaren zu hören. <br></div></div><br>  Wir gehen davon aus, dass alle Drucker vernetzt sind und zum Drucken von den primären und Backup-Druckservern verfügbar sind.  Diese Server heißen <i>prn-srv01</i> bzw. <i>prn-srv02</i> . <br>  Domänenserver unter Windows Server, die nicht niedriger als 2008 sind, eignen sich als Druckserver. Grundsätzlich sind Client-Betriebssysteme, die mit Vista beginnen, auch geeignet, wenn Sie wirklich Geld sparen möchten.  Das Beispiel verwendet Windows 2012 R2.  Es wird dringend empfohlen, alle erforderlichen Updates des Betriebssystems zu installieren, bevor Sie sowohl die Server als auch die Client-Computer einrichten. <br><br>  Sie selbst verstehen das natürlich, aber die Obergrenze erfordert immer noch Aufmerksamkeit: Wenn die Druckserver virtuell sind, müssen sie auf verschiedene physische Server verteilt werden, da sonst unser Failover einfach zum Fehlschlagen wird. <br><br>  Auf <i>prn-srv01</i> und <i>prn-srv02</i> muss die Druckserverrolle hinzugefügt werden.  Für mich ist es bequemer, das PowerShell-Cmdlet zu verwenden: <br> <code>Install-WindowsFeature Print-Services</code> <br> <br>  Außerdem sollte auf den Druckservern eine Registrierungsoptimierung angewendet werden, die den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fehler 0 × 00000709 korrigiert,</a> wenn Clientcomputer über CNAME auf den Druckserver zugreifen.  Sie können dies mit dem Befehl aus dem Artikel unter dem obigen Link tun: <br> <code>reg add HKLM\SYSTEM\CurrentControlSet\Control\Print /v DnsOnWire /t REG_DWORD /d 1</code> <br>  Nach dem Anwenden des Befehls müssen Sie den <i>Print Manager-</i> Dienst neu starten. <br>  Ich empfehle, dass Sie den Druckservern eine separate Organisationseinheit zuweisen und diese Einstellung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">über GPP</a> verteilen. <br><br>  Wir starten das DNS-Snap-In auf dem Domänencontroller und aktivieren die erweiterte Anzeige: <br><div class="spoiler">  <b class="spoiler_title">Klicken Sie auf</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/t_/sg/w1/t_sgw1pf6fazbhihj-4yjxzivfc.png"><br></div></div><br>  Eine erweiterte Zuordnung ist erforderlich, um die TTL für erstellte Datensätze festlegen zu können. <br>  Erstellen Sie in DNS einen CNAME- <i>Druckdatensatz</i> , der auf <i>prn-srv01</i> mit einem 5-Minuten-TTL-Wert <i>verweist</i> : <br><div class="spoiler">  <b class="spoiler_title">Klicken Sie auf</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/bx/oe/0y/bxoe0yjyj5pmar4utycfqjfnnba.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Klicken Sie auf</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/w_/tz/dj/w_tzdj66enutsmeuw5wwajzmrww.png"><br></div></div><br>  Dieser Name sollte von Clientcomputern verwendet werden, um eine Verbindung zum Druckserver herzustellen.  Das heißt,  Der Client stellt eine Verbindung zu den Adressen \\ Drucken \ Drucker01, \\ Drucken \ Drucker02 usw. her. <br>  Je niedriger der TTL-Wert ist, desto häufiger aktualisieren Clients den Datensatz und „verstehen“ eher, dass sie zu einem anderen Druckserver wechseln müssen.  5 Minuten reichen mir. <br>  Wenn Sie den Wert zu niedrig einstellen, generieren Sie DNS-Verkehr in Ihrem Netzwerk, <s>und indem Sie ein oder zwei Stunden angeben, betonen Sie Ihre Stresstoleranz und Ihre starken Nerven</s> . <br>  Eine alternative Möglichkeit zum Hinzufügen eines CNAME-Datensatzes mit PowerShell: <br> <code>Import-Module DnsServer <br> Add-DnsServerResourceRecordCName -Name "print" -HostNameAlias "prn-srv01.lab.net" -ZoneName "lab.net" -TimeToLive 00:05:00 <br></code> <br>  (Natürlich ändern wir lab.net in Ihre contoso.local oder was auch immer es ist) <br><br>  Beachten Sie, dass das Aktualisieren von DNS-Einträgen an allen Standorten aufgrund der standortübergreifenden Replikation bei mehreren AD-Standorten länger dauert.  Sie können den Vorgang mit dem <i>Befehl repadmin / syncall erzwingen</i> . <br><br>  Mithilfe von Gruppenrichtlinien können normale Benutzer Treiber vom Druckserver installieren.  Wie das geht, wird <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> ausführlich beschrieben. <br><br>  Erstellen Sie ein Dienstkonto in AD (ich habe es svc -printsync genannt) mit einem unbegrenzten Kennwortablauf: <br><div class="spoiler">  <b class="spoiler_title">Klicken Sie auf</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/aw/b8/-i/awb8-irvpqwtgz7_hqh5zziclxu.png"><br></div></div><br>  Gemäß den Anforderungen von PrintBrm muss dieses Konto über die vollständigen Rechte auf dem Druckserver verfügen. Daher fügen wir es <s>der Administratordomäne hinzu, damit alles sicher funktioniert, und schreiben das Kennwort in das Beschreibungsfeld, um die</s> lokale <i>Administratorgruppe</i> auf <i>prn-srv01</i> und <i>prn-srv02</i> ( Verwenden Sie beispielsweise <i>das</i> Snap-In für <i>die Computerverwaltung</i> . <br><br><h2>  Konfigurieren Sie den ersten Server </h2><br>  Wenn bereits alle erforderlichen Drucker auf dem Hauptdrucker hinzugefügt wurden, können Sie sofort mit dem Abschnitt zum Konfigurieren des zweiten Servers fortfahren. <br><br>  Mithilfe <i>des Druckverwaltungs-</i> Snap-Ins fügen wir dem Server Treiber für die erforderlichen Drucker hinzu: <br><div class="spoiler">  <b class="spoiler_title">Klicken Sie auf</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/c0/_b/fl/c0_bflidme6egcqqpjsu8fmhkay.png"><br></div></div><br>  Der Treiberinstallationsassistent wird gestartet.  Es ist intuitiv, Sie können es selbst herausfinden.  Ich werde nur mit etwas Tiefe auf den Moment achten. <br>  Weil  Da Windows 2012R2 nur in der x64-Version verfügbar ist, müssen die Treiber auch x64 sein.  Wenn Clients mit x86-Versionen von Windows eine Verbindung zum Druckserver herstellen, vergessen Sie nicht, das entsprechende Kontrollkästchen zu aktivieren: <br><div class="spoiler">  <b class="spoiler_title">Klicken Sie auf</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/kk/1r/be/kk1rbe46et1lxpumhlwjt4dgqvu.png"><br></div></div><br>  Einige Treiberkits enthalten eine gemeinsame Inf-Datei für x86- und x64-Systeme, während andere getrennt sind. <br><br><div class="spoiler">  <b class="spoiler_title">Noch ein paar Texte</b> <div class="spoiler_text">  Viele Treiber werden in Form eines Installationsprogramms geliefert. Da diese Installationsprogramme jedoch viel Müll mit den Treibern zusammenfügen, versuche ich, dem Prinzip „notwendig und ausreichend“ zu folgen und Treiber manuell hinzuzufügen, wie oben beschrieben. <br>  Aus Gründen der Konsistenz bemühe ich mich außerdem, die Universal-Version der Treiber maximal zu verwenden (fast alle normalen Anbieter haben sie).  Aber manchmal kann es ein Problem sein.  Als ich also auf einen Fehler in einer der Versionen von HP Universal Printing PCL 6 stieß, wurde ein PDF-Dokument über EasyPrint in einer RDP-Sitzung von rechts nach rechts spiegelbildlich gedruckt. <br>  Sie können auch auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">v4-Treiber</a> schauen. <br></div></div><br><br>  Wenn alle erforderlichen Treiber hinzugefügt wurden, werden wir uns mit Ports und Druckern befassen.  Sie können sie manuell über dasselbe Snap-In hinzufügen. Ich empfehle jedoch, eine CSV-Datei in Excel zu erstellen und sie einem PowerShell-Skript zuzuführen.  Natürlich hindert nichts Excel daran, einen anderen Tabellenkalkulationseditor oder Notizblock im Allgemeinen zu verwenden.  Die Hauptsache ist, dass das im Skript angegebene Trennzeichen und die Codierung dem Trennzeichen und der Codierung in der CSV-Datei entsprechen. <br>  Beachten Sie außerdem, dass der Treibername in der CSV-Datei genau dem entsprechen muss, der im Snap-In für die Druckverwaltung angegeben ist. <br><div class="spoiler">  <b class="spoiler_title">Kopieren-Einfügen zur Rettung</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/lt/-u/k3/lt-uk31frw4ashg6sqfxptrx6us.png"><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Beispiel-CSV-Datei</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/f9/wp/cj/f9wpcjsmlydppavwxh9ed4bn51m.png"><br></div></div><br><br>  Obwohl ich oben geschrieben habe, dass es mir gefällt, wenn alle Drucker einheitliche Netzwerknamen haben, verwendet das Beispiel (Feld für die <i>Druckeradresse</i> ) eine Vinaigrette mit IP-Adressen und Namen, falls Sie etwas später <s>keine</s> Bestellung in Ihrem Netzwerk haben. <br><br>  Speichern Sie diese Tabelle im CSV-Format: <br><div class="spoiler">  <b class="spoiler_title">Klicken Sie auf</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/1e/qq/4i/1eqq4iw3hfbsjfge8mcetyerlfg.png"><br>  <i><b>Hinweis</b></i>  <i>Trotz der Tatsache, dass Kommas im Feld "Dateityp" als Trennzeichen angezeigt werden, hat Excel ein Semikolon als Trennzeichen gesetzt.</i>  <i>Wahrscheinlich, um interessanter zu sein und mehr Spaß zu haben.</i> <br></div></div><br>  Und hier ist das Drehbuch selbst: <br><div class="spoiler">  <b class="spoiler_title">CreatePrintersFromCsv.ps1</b> <div class="spoiler_text"><pre> <code class="hljs mel">#    $InputFile = <span class="hljs-string"><span class="hljs-string">'C:\Scripts\Printers.csv'</span></span> #      CSV- $Printers = (Import-Csv $InputFile -Delimiter <span class="hljs-string"><span class="hljs-string">";"</span></span> -Encoding Default) #          ForEach ($Printer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $Printers) { #       $PrinterName = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $ShareName = $Printer.<span class="hljs-string"><span class="hljs-string">'  '</span></span> $DriverName = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $PrinterAddr = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $Comment = $Printer.<span class="hljs-string"><span class="hljs-string">''</span></span> $Location = $Printer.<span class="hljs-string"><span class="hljs-string">''</span></span> #  Add-PrinterPort -Name $PrinterAddr -PrinterHostAddress $PrinterAddr -SNMP <span class="hljs-number"><span class="hljs-number">1</span></span> -SNMPCommunity <span class="hljs-string"><span class="hljs-string">'public'</span></span> #  Add-Printer -Name $PrinterName -DriverName $DriverName -PortName $PrinterAddr -Comment $Comment -Location $Location #   Set-Printer -Name $PrinterName -Shared $True -Published $False -ShareName $ShareName }</code> </pre><br></div></div><br>  Wenn das Tabulatorzeichen in Ihrer CSV als Trennzeichen verwendet wird, müssen Sie im Skript <i>-Delimiter "` t "setzen.</i> <br><br>  Beachten Sie, dass das Hinzufügen zum Drucker zum Druckserver länger dauert (2-3 Minuten statt einiger Sekunden), wenn ein Drucker während der Ausführung des Skripts nicht auf dem Server verfügbar ist. <br><br>  Das Ergebnis des Skripts: <br><div class="spoiler">  <b class="spoiler_title">Klicken Sie auf</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/fj/jd/-t/fjjd-tcfaowketxq9u7av7yzfzk.png"><br></div></div><br><br>  Um sicherzustellen, dass zu diesem Zeitpunkt alles funktioniert, fügen Sie einem der Clientcomputer vom Hauptdruckserver aus einen freigegebenen Drucker hinzu, indem Sie den zuvor erstellten CNAME verwenden (z. B. \\ print \ Drucker01), und versuchen Sie, etwas darauf zu drucken.  <s>Zu diesem Zweck eignet sich der Ausdruck „Preved, ich bin ein Stück Papier“, der in Fettdruck Arial mit einer Größe von 200 geschrieben ist, am besten für diesen Zweck.</s> <br><br><h2>  Konfigurieren Sie einen zweiten Server </h2><br><blockquote>  Un artista copia, un gran artista roba (Pablo Picasso) </blockquote><br>  Unser <i>prn-srv02</i> hat noch nicht das Niveau von gran artista erreicht, daher beschränken wir uns auf das Kopieren.  <s>Obwohl ... Sie können mit einem Handgriff ...</s> <br><br>  Wir erstellen und teilen mindestens einen Drucker, andernfalls gibt PrintBrm einen Fehler aus.  Sie können eine Fälschung machen, aber es ist wichtig, nicht den falschen Treiber oder Port zu wählen.  Beispielsweise kann ein Drucker mit einem Microsoft XPS Document Writer-Treiber oder einem FILE-Port nicht freigegeben werden. <br><br>  Wir erstellen ein einfaches Synchronisationsskript.  Ich bevorzuge PowerShell, aber niemand verbietet das Erstellen einer Warmrohr-Batch-Datei. <br><br><div class="spoiler">  <b class="spoiler_title">PrintSync.ps1</b> <div class="spoiler_text"><pre> <code class="hljs mel">#   PrintBrm $ProgramPath = <span class="hljs-string"><span class="hljs-string">'C:\Windows\System32\Spool\Tools\PrintBrm.exe'</span></span> #    $SourceServer = <span class="hljs-string"><span class="hljs-string">'prn-srv01'</span></span> $DestServer = <span class="hljs-string"><span class="hljs-string">'prn-srv02'</span></span> #,   .     , ..  PrintBrm       $ConfigFilePath = <span class="hljs-string"><span class="hljs-string">'C:\Scripts\prn-config.printerExport'</span></span> #    $Arguments = <span class="hljs-string"><span class="hljs-string">"-s $SourceServer -f $ConfigFilePath -b"</span></span> Start-process $ProgramPath -ArgumentList $Arguments -Wait -PassThru #    $Arguments = <span class="hljs-string"><span class="hljs-string">"-s $DestServer -f $ConfigFilePath -r -o force"</span></span> Start-process $ProgramPath -ArgumentList $Arguments -Wait -PassThru #   Del $ConfigFilePath</code> </pre><br></div></div><br><br>  Wir platzieren das Skript an einem abgelegenen Ort (im Beispiel <i>C: \ Scripts</i> ) und erstellen eine Aufgabe im Scheduler. <br>  Wir werden von dem zuvor erstellten SVC-Printsync-Konto mit den höchsten Berechtigungen ausgeführt: <br><div class="spoiler">  <b class="spoiler_title">Klicken Sie auf</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/sp/ax/9w/spax9w_u6llu5ekhxh6ezfq8zdi.png"><br></div></div><br>  Bestimmen Sie die Häufigkeit der Ausführung selbst.  Genug für mich einmal am Tag: <br><div class="spoiler">  <b class="spoiler_title">Klicken Sie auf</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/m8/a5/hm/m8a5hm3qm5dosyvvd8uivsrdeaq.png"><br></div></div><br>  Erstellen Sie auf der Registerkarte Aktionen eine neue PowerShell-Startaktion: <br> <code>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</code> <br>  Als Argumente setzen wir den Pfad zum Skript mit den folgenden Parametern: <br> <code>C:\Scripts\PrintSync.ps1 -NonInteractive -WindowStyle Hidden -ExecutionPolicy Bypass</code> <br> <div class="spoiler">  <b class="spoiler_title">Klicken Sie auf</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/c2/dw/zi/c2dwzipe2ifr6vstp2qgpvr-cc4.png"><br></div></div><br>  Die restlichen Aufgabenparameter belassen wir standardmäßig auf den Registerkarten <i>Bedingungen</i> und <i>Parameter</i> . <br>  Beim Speichern der Aufgabe wird ein Kennwort für das <i>Konto svc -printsync angefordert</i> .  Du hast ihn nicht vergessen?  Wenn Sie bereits vergessen haben (der Artikel ist lang), wurde <s>alles umsonst gemacht und das Leben war nicht erfolgreich.</s> Setzen Sie es mit dem ADUC-Snap-In oder auf eine andere bequeme Weise zurück <s>und geben Sie es bereits im Beschreibungsfeld an, um es ruhiger zu machen</s> . <br><br><div class="spoiler">  <b class="spoiler_title">Hinweis</b> <div class="spoiler_text">  Der Job muss nicht auf dem Sicherungsdruckserver ausgeführt werden.  Wenn Sie einen separaten Server zum Ausführen von Routinen haben, können Sie darauf eine Aufgabe erstellen.  In diesem Fall muss das <i>Konto svc-drucksync</i> das Recht haben, sich als <i>Stapeljob</i> auf diesem Server anzumelden.  Standardmäßig hat die lokale Gruppe <i>Sicherungsoperatoren</i> dieses Recht. Wenn dies in Ihrer Umgebung nicht geändert wird, fügen Sie einfach das Dienstkonto in die Gruppe der Archivierungsoperatoren des Servers ein, auf dem die Aufgabe ausgeführt wird. <br></div></div><br><br>  Zum ersten Mal starten wir die Aufgabe manuell und warten auf ihren Abschluss. <br>  In meinem Zoo, in dem es ungefähr 50 Drucker verschiedener Typen gibt, die sowohl gefährdet als auch kürzlich gezüchtet wurden, dauert der Synchronisierungsvorgang ungefähr 10 Minuten.  Die Datei wiegt gleichzeitig fast 1 GB. <br>  Um den Import- / Exportvorgang zu beschleunigen, können Sie den <i>Schalter -NOBIN verwenden</i> , der für das Kopieren von Treibern verantwortlich ist.  Es ist sinnvoll, wenn die Druckerflotte aus denselben Modellen besteht und die erforderlichen Treiber auf allen Servern installiert sind. <br><br>  Führen Sie nach Abschluss das <i>Ereignisanzeige-</i> Snap- <i>In aus</i> , gehen Sie zum Abschnitt <i>Anwendungs- und</i> Dienstprotokolle, öffnen Sie das <i>Protokoll</i> <i>Microsoft \ Microsoft \ PrintBRM \ Administrator</i> und analysieren Sie es auf Fehler und Warnungen.  <s>Und wenn es zu viele davon gibt, reinigen wir das Magazin eher, damit unsere Augen keinen Kallus bekommen.</s> <br><br>  Ich bin auf die Codes 20, 22, 80 und 81 gestoßen. Zum Beispiel <br><div class="spoiler">  <b class="spoiler_title">solche</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/be/sx/7u/besx7uy6lxapuzrxj3_mrsg9agc.png"><br></div></div><br>  Wie aus dem Text hervorgeht, gab es ein Problem beim Übertragen eines bestimmten Treibers.  Wenn wir das Protokoll durchsehen, erstellen wir eine Liste problematischer Treiber und legen sie mit unseren Händen auf den Sicherungsserver oder ersetzen sie durch andere, die dem Reisen nicht abgeneigt sind.  Ich hatte nur Probleme mit HP, Kyocera und Konica Minolta. Bei Treibern anderer Hersteller wurden keine Fehler festgestellt (möglicherweise, weil sie besser sind oder weil wir sie einfach nicht haben). <br>  Infolgedessen müssen Sie dieselbe Liste von Druckern auf dem Primär- und Sicherungsserver und das Fehlen von Fehlern und Warnungen in den Protokollen erstellen. <br><br><h2>  Zur Reserve wechseln </h2><br>  <s>Unter dem Klopfen von Äxten und dem Schleifen von Gabeln verbarrikadieren wir die Tür zu unserem Büro und schalten das Telefon aus.</s>  Führen Sie das DNS-Snap-In aus und bearbeiten Sie den CNAME-Eintrag so, dass er auf den Sicherungsserver verweist: <br><div class="spoiler">  <b class="spoiler_title">Klicken Sie auf</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/3n/kh/p5/3nkhp5g6apvxj1ejoheth9hlcfu.png"><br></div></div><br>  Nach einer Weile (was haben Sie dort in TTL eingegeben?) Lassen die <s>bedrohlichen Schreie nach, die</s> Client-Computer wechseln zu prn-srv02 <s>und die Tür mit dem Telefon kann entriegelt werden</s> . <br><br><h2>  Komm zurück </h2><br>  Wenn während der Wiederherstellung des Hauptservers in der Sicherung Konfigurationsänderungen vorgenommen wurden, die gespeichert werden müssen, starten wir die Synchronisierung in die entgegengesetzte Richtung.  Dazu <i>tauschen</i> wir im obigen <i>PrintSync.ps1-</i> Skript die Werte der Variablen <i>$ SourceServer</i> und <i>$ DestServer aus</i> .  Vergessen Sie nach dem Übertragen der Änderungen nicht, diese Werte zurückzugeben, da sonst alle Änderungen in der Druckerkonfiguration auf <i>prn-srv01</i> jede Nacht gnadenlos vom bösen Willen des Schicksals <i>weggefegt</i> werden. <br>  Setzen Sie im DNS-Snap-In <i>print</i> für den CNAME-Eintrag auf den Wert des Zielknotens prn-srv01 - und alles kehrt zum Quadrat eins zurück. <br><br><h2>  Was ist das Ergebnis? </h2><br>  Stürmischer Applaus von der Führung, der den Administrator in die Arme wirft, das Gehalt erhöht (der Autor des Artikels ist ehrlich 10% der Erhöhung) ... <br>  Nun, ein paar Gedanken in Richtung Führung von weiterer Schönheit. <br><br>  Leider gibt es nicht genug Wunder für alle, und diese Lösung ist kein vollwertiges Failover.  Wenn zum Zeitpunkt des Zusammenbruchs des Hauptdruckservers nicht leere Druckwarteschlangen vorhanden sind, verschwindet der Inhalt höchstwahrscheinlich in der Luft und jemand muss das Senden zum Drucken wiederholen. <br><br>  Für Benutzer ist es jedoch sehr praktisch, die routinemäßige Wartung von Druckservern transparent durchzuführen. <br><div class="spoiler">  <b class="spoiler_title">Sie folgen den Empfehlungen von Microsoft?</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/s9/dr/bm/s9drbmkdazxkxaswuw4flitnsoi.jpeg"><br></div></div><br><br>  Automatisierungsfans können noch weiter gehen und ein Skript erstellen, das Servernamen mit einem Synchronisationsintervall am Eingang empfängt und die restlichen Einstellungen selbst vornimmt: Erstellt bei Bedarf ein Dienstkonto, eine Aufgabe im Scheduler usw. <br><br>  Überwachungsgurus fügen die Überwachung der Synchronisierungsaufgabe und Fehler in den Protokollen hinzu. <br><br>  Liebhaber, die tiefer graben, können an eine bidirektionale Synchronisation im Sinne der AD-Replikation mit Änderungen der Zeiterfassung für jeden Drucker denken.  PrintBrm hilft hier nicht weiter, aber niemand hat PowerShell abgesagt! <br><br>  Die Kirsche auf dem Kuchen wird die automatische Installation von Druckern auf Client-Computern sein, die GPP verwenden und auf die AD-Gruppe abzielen.  Fügen Sie den Benutzer der Gruppe hinzu - und der gewünschte Drucker fliegt zu ihm.  Dies ist zwar eine andere Geschichte, die über den Rahmen des Artikels hinausgeht. <br><br>  Ich hoffe für jemanden, dass meine Veröffentlichung nützlich sein wird.  Ich wünsche allen weniger Pannen und freue mich auf Fragen und Vorschläge in den Kommentaren. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de414369/">https://habr.com/ru/post/de414369/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de414357/index.html">Wir verwenden die Web-Bluetooth-API, um den Herzfrequenzmesser zu verbinden und die Anwendung mit Vue.js zu entwickeln</a></li>
<li><a href="../de414359/index.html">Interaktion mit dem Server über die API in iOS unter Swift 3. Teil 1</a></li>
<li><a href="../de414361/index.html">Unity3D: Spielarchitektur, ScriptableObjects, Singletones</a></li>
<li><a href="../de414363/index.html">Die Verdauung von frischen Materialien aus der Welt des Frontends für die letzte Woche Nr. 319 (11. - 17. Juni 2018)</a></li>
<li><a href="../de414367/index.html">Galoppieren in drei Jahren: Was kann interessant sein, um es im HashFlare-Blog noch einmal zu lesen?</a></li>
<li><a href="../de414371/index.html">Schulklasse und eine kleine Skizze von Social Engineering</a></li>
<li><a href="../de414373/index.html">Asynchrones / wartendes JavaScript-Design: Stärken, Fallstricke und Verwendungsmuster</a></li>
<li><a href="../de414375/index.html">Befehle zum Arbeiten mit der JavaScript-Konsole in Browsern und zur Steigerung der Produktivität des Programmierers</a></li>
<li><a href="../de414377/index.html">Innovationen von Objektliteralen in JavaScript ES6</a></li>
<li><a href="../de414379/index.html">"Diejenigen, die bereit sind, Freiheit gegen Sicherheit auszutauschen, sind weder Freiheit noch Sicherheit wert" (Originalquelle)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>