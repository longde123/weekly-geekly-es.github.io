<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÖüèæ üë©‚Äçüî¨ üåÇ Solu√ß√µes arquitet√¥nicas para um jogo para celular. Parte 2: Comando e suas filas üßò üç∏ üßì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Na primeira parte do artigo, examinamos como o modelo deve ser organizado para facilitar o uso, mas a depura√ß√£o e a fixa√ß√£o das interfaces s√£o simples...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Solu√ß√µes arquitet√¥nicas para um jogo para celular. Parte 2: Comando e suas filas</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435704/"><img src="https://habrastorage.org/webt/1n/ji/xq/1njixqpyay22mmuyckufhgouye8.jpeg"><br><br>  Na primeira parte do artigo, examinamos como o modelo deve ser organizado para facilitar o uso, mas a depura√ß√£o e a fixa√ß√£o das interfaces s√£o simples.  Nesta parte, consideraremos o retorno de comandos para mudan√ßas no modelo, em toda a sua beleza e diversidade.  Como antes, a prioridade para n√≥s ser√° a conveni√™ncia da depura√ß√£o, minimizando os gestos que um programador precisa fazer para criar um novo recurso, bem como a legibilidade do c√≥digo para uma pessoa. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Solu√ß√µes arquitet√¥nicas para um jogo para celular.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 1: Modelo</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Solu√ß√µes arquitet√¥nicas para um jogo para celular.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 3: Vista sobre o impulso do jato</a> <br><a name="habracut"></a><br><h2>  Porqu√™ Comando </h2><br>  O padr√£o Command soa alto, mas, na verdade, √© apenas um objeto no qual tudo o necess√°rio para a opera√ß√£o solicitada √© adicionado e armazenado l√°.  Escolhemos essa abordagem, pelo menos porque nossas equipes ser√£o enviadas pela rede e at√© obteremos algumas c√≥pias do estado do jogo para uso oficial.  Portanto, quando o usu√°rio clica no bot√£o, uma inst√¢ncia da classe de comando √© criada e enviada ao destinat√°rio.  O significado da letra C na abrevia√ß√£o MVC √© um pouco diferente. <br><br><h2>  Previs√£o de resultado e verifica√ß√£o de comandos pela rede </h2><br>  Nesse caso, o c√≥digo espec√≠fico √© menos importante que a ideia.  E aqui est√° a ideia: <br><br>  Um jogo que se preze n√£o pode esperar por uma resposta do servidor antes de reagir ao bot√£o.  Obviamente, a Internet est√° melhorando e voc√™ pode ter v√°rios servidores em todo o mundo, e eu at√© conhe√ßo alguns jogos de sucesso aguardando uma resposta do servidor, um deles √© at√© Invocando Guerras, mas ainda assim voc√™ n√£o precisa fazer isso.  Como para defasagens na Internet m√≥vel de 5 a 15 segundos √© mais prov√°vel que seja a norma do que uma exce√ß√£o, em Moscou pelo menos o jogo deve ser realmente √≥timo para que os jogadores n√£o prestem aten√ß√£o a ele. <br><br>  Consequentemente, temos um estado de jogo que representa todas as informa√ß√µes necess√°rias para a interface, e os comandos s√£o aplicados a ela imediatamente e somente depois s√£o enviados ao servidor.  Geralmente, os programadores java trabalham sentados no servidor duplicando todas as novas funcionalidades uma a uma em outro idioma.  Em nosso projeto ‚Äúveado‚Äù, seu n√∫mero chegou a 3 pessoas, e os erros cometidos ao transportar eram uma fonte constante de alegria indescrit√≠vel.  Em vez disso, podemos fazer de maneira diferente.  Executamos no servidor .Net e no lado do servidor o mesmo c√≥digo de comando que no cliente. <br><br>  O modelo descrito no √∫ltimo artigo nos oferece uma nova oportunidade interessante de autoteste.  Depois de executar o comando no cliente, calcularemos o hash da altera√ß√£o ocorrida na √°rvore do GameState e aplic√°-lo-√° √† equipe.  Se o servidor executar o mesmo c√≥digo de comando e o hash das altera√ß√µes n√£o corresponder, algo deu errado. <br><br>  Primeiras vantagens: <br><br><ul><li>  Essa solu√ß√£o acelera bastante o desenvolvimento e minimiza o n√∫mero de programadores de servidores. </li><li>  Se o programador cometeu erros que levaram a um comportamento n√£o determin√≠stico, por exemplo, ele obteve o primeiro valor do Dictionary ou usou DateTime.now e, geralmente, usou alguns valores n√£o escritos nos campos de comando explicitamente; quando o heh for iniciado no servidor, eles n√£o corresponder√£o e n√≥s vamos descobrir sobre isso. </li><li>  Por enquanto, o desenvolvimento do cliente pode ser realizado sem um servidor.  Voc√™ pode at√© entrar em alfa amig√°vel sem ter um servidor.  Isso √© √∫til n√£o apenas para desenvolvedores independentes que perdem seu jogo dos sonhos √† noite.  Quando eu estava em Piksonik, houve um caso em que o programador do servidor perdeu todos os pol√≠meros e nosso jogo foi for√ßado a sofrer modera√ß√£o, tendo em vez do servidor um boneco defendendo estupidamente o estado inteiro do jogo de vez em quando. </li></ul><br>  Uma desvantagem que, por algum motivo, √© sistematicamente subestimada: <br><br><ul><li>  Se o programador cliente fez algo errado e √© invis√≠vel durante o teste, por exemplo, a probabilidade de mercadorias nas caixas misteriosas, n√£o h√° ningu√©m para escrever a mesma coisa uma segunda vez e encontrar um erro.  O c√≥digo autoport√°vel requer uma atitude muito mais respons√°vel em rela√ß√£o aos testes. </li></ul><br><h2>  Informa√ß√µes detalhadas sobre depura√ß√£o </h2><br>  Uma de nossas prioridades declaradas √© a conveni√™ncia da depura√ß√£o.  Se durante a execu√ß√£o da equipe capturamos a execu√ß√£o - tudo est√° claro, revertemos o estado do jogo, enviamos o estado completo para os logs e serializamos o comando que o soltou, tudo √© conveniente e bonito.  A situa√ß√£o √© mais complicada se tivermos uma dessincroniza√ß√£o com o servidor.  Como o cliente j√° concluiu v√°rios outros comandos desde ent√£o, verifica-se n√£o apenas descobrir em que estado o modelo estava antes de executar o comando que levou ao desastre, mas eu realmente quero.  A clonagem de um gamestate na frente de cada equipe √© muito complicada e cara.  Para resolver o problema, complicamos o esquema costurado sob o cap√¥ do motor. <br><br>  No cliente, n√£o teremos um estado de jogo, mas dois.  O primeiro serve como interface principal para renderiza√ß√£o, os comandos s√£o aplicados a ele imediatamente.  Depois disso, os comandos aplicados s√£o colocados na fila para envio ao servidor.  O servidor executa a mesma a√ß√£o de lado e confirma que est√° tudo bem e correto.  Ap√≥s receber a confirma√ß√£o, o cliente pega o mesmo comando e aplica-o ao segundo estado do jogo, levando-o ao estado que j√° foi confirmado pelo servidor como correto.  Ao mesmo tempo, tamb√©m temos a oportunidade de comparar o hash das altera√ß√µes feitas para garantir a seguran√ßa e tamb√©m podemos comparar o hash completo de toda a √°rvore no cliente, que podemos calcular depois que o comando √© executado, pesa pouco e √© considerado r√°pido o suficiente.  Se o servidor n√£o disser que est√° tudo bem, ele solicita ao cliente detalhes do que aconteceu, e o cliente pode enviar a ele um segundo estado de jogo serializado exatamente como antes de o comando ser executado com √™xito no cliente. <br>  A solu√ß√£o parece muito atraente, mas gera dois problemas que precisam ser resolvidos no n√≠vel do c√≥digo: <br><br><ul><li>  Entre os par√¢metros de comando, pode haver n√£o apenas tipos simples, mas tamb√©m links para modelos.  Em outro gamestate, exatamente no mesmo local, h√° outros objetos do modelo.  Resolvemos esse problema da seguinte maneira: Antes de o comando ser executado no cliente, serializamos todos os seus dados.  Entre eles, pode haver links para modelos, que escreveremos na forma de Caminho para o modelo a partir da raiz do estado do jogo.  Fazemos isso antes da equipe, pois ap√≥s sua execu√ß√£o os caminhos podem mudar.  Em seguida, enviamos esse caminho para o servidor, e o estado do servidor do servidor poder√° obter um link para seu modelo ao longo do caminho.  Da mesma forma, quando uma equipe √© aplicada ao segundo estado do jogo, o modelo pode ser obtido a partir do segundo estado do jogo. </li><li>  Al√©m de tipos e modelos elementares, uma equipe pode ter links para cole√ß√µes.  Dicion√°rio &lt;chave, modelo&gt;, dicion√°rio &lt;modelo, chave&gt;, lista &lt;modelo&gt;, lista &lt;valor&gt;.  Para todos eles, eles precisam escrever serializadores.  √â verdade que voc√™ n√£o pode se apressar nisso, em um projeto real, esses campos surgem surpreendentemente raramente. </li><li>  Enviar comandos para o servidor, um de cada vez, n√£o √© uma boa ideia, porque o usu√°rio pode produzi-los mais rapidamente do que a Internet pode arrast√°-los para frente e para tr√°s; na Internet ruim, o conjunto de comandos n√£o trabalhados pelo servidor aumentar√°.  Em vez de enviar comandos um de cada vez, n√≥s os enviaremos em lotes de v√°rias partes.  Nesse caso, ap√≥s ter recebido uma resposta do servidor de que algo deu errado, primeiro voc√™ dever√° aplicar ao segundo estado todos os comandos anteriores do mesmo pacote que foram confirmados pelo servidor e somente depois apagar e enviar o segundo estado de controle ao servidor. </li></ul><br><h2>  Conveni√™ncia e facilidade de escrever comandos </h2><br>  O c√≥digo de execu√ß√£o do comando √© o segundo maior e o primeiro c√≥digo mais respons√°vel do jogo.  Quanto mais simples e claro ele for, e quanto menos o programador precisar fazer o extra com as m√£os para escrev√™-lo, mais r√°pido o c√≥digo ser√° escrito, menos erros ser√£o cometidos e, inesperadamente, mais feliz o programador ser√°.  Coloco o c√≥digo de execu√ß√£o diretamente no pr√≥prio comando, al√©m das partes e fun√ß√µes gerais localizadas em classes de regras est√°ticas separadas, na maioria das vezes na forma de extens√µes das classes de modelo com as quais eles trabalham.  Vou mostrar alguns exemplos de comandos do meu projeto de estima√ß√£o, um muito simples e o outro um pouco mais complicado: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> HexKingdoms { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FCSetSideCostCommand</span></span></span><span class="hljs-class"> :</span></span> HexKingdomsCommand { <span class="hljs-comment"><span class="hljs-comment">//              protected override bool DetaliedLog { get { return true; } } public FCMatchModel match; public int newCost; protected override void HexApply(HexKingdomsRoot root) { match.sideCost = newCost; match.CalculateAssignments(); match.CalculateNextUnassignedPlayer(); } } }</span></span></code> </pre> <br>  E aqui est√° o log que esse comando deixa depois de si mesmo, se esse log n√£o estiver desativado. <br><br><pre> <code class="json hljs">[FCSetSideCostCommand id=<span class="hljs-number"><span class="hljs-number">1</span></span> match=FCMatchModel[<span class="hljs-number"><span class="hljs-number">0</span></span>] newCost=<span class="hljs-number"><span class="hljs-number">260</span></span>] Execute:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.0027546</span></span> Apply:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.0008689</span></span> { <span class="hljs-attr"><span class="hljs-attr">"LOCAL_PERSISTENTS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@changed"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"0"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"SIDE_COST"</span></span>:<span class="hljs-number"><span class="hljs-number">260</span></span>}, <span class="hljs-attr"><span class="hljs-attr">"1"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"POSSIBLE_COST"</span></span>:<span class="hljs-number"><span class="hljs-number">260</span></span>}, <span class="hljs-attr"><span class="hljs-attr">"2"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"POSSIBLE_COST"</span></span>:<span class="hljs-number"><span class="hljs-number">260</span></span>}}}}</code> </pre> <br>  A primeira vez indicada no log √© o tempo durante o qual todas as altera√ß√µes necess√°rias no modelo foram feitas e a segunda √© a hora em que todas as altera√ß√µes foram trabalhadas pelos controladores de interface.  Isso deve ser mostrado no log para n√£o fazer acidentalmente algo terrivelmente lento, ou para perceber se as opera√ß√µes come√ßam a levar muito tempo simplesmente por causa do tamanho do modelo em si. <br><br>  Al√©m das chamadas para objetos persistentes nos Id-shniks, que reduzem muito a legibilidade do log, que, ali√°s, poderia ter sido evitada aqui, o pr√≥prio c√≥digo de comando e o log que ele fez com o estado do jogo s√£o surpreendentemente claros.  Observe que no texto do comando o programador n√£o faz um √∫nico movimento extra.  Tudo o que voc√™ precisa √© feito pelo motor sob o cap√¥. <br><br>  Agora vamos ver um exemplo de uma equipe maior <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> HexKingdoms { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FCSetUnitForPlayerCommand</span></span></span><span class="hljs-class"> :</span></span> HexKingdomsCommand { <span class="hljs-comment"><span class="hljs-comment">//            protected override bool DetaliedLog { get { return true; } } public FCSelectArmyScreenModel screen; public string unit; public int count; protected override void HexApply(HexKingdomsRoot root) { if (count == 0 &amp;&amp; screen.player.units.ContainsKey(unit)) { screen.player.units.Remove(unit); screen.selectedUnits.Remove(unit); } else if (count != 0) { if (screen.player.units.ContainsKey(unit)) { screen.player.units[unit] = count; screen.selectedUnits[unit].count = count; } else { screen.player.units.Add(unit, count); screen.selectedUnits[unit] = new ReferenceUnitModel() { type = unit, count = count }; } } screen.SetSelectedReferenceUnits(); screen.player.CalculateUnitsCost(); var side = screen.match.sides[screen.side]; screen.match.CalculatePlayerAssignmentsAcceptablity(side); screen.match.CalculateNextUnassignedPlayer(screen.player); } } }</span></span></code> </pre> <br>  E aqui est√° o log deixado pela equipe: <br><br><pre> <code class="json hljs">[FCSetUnitForPlayerCommand id=<span class="hljs-number"><span class="hljs-number">3</span></span> screen=/UI_SCREENS[main] unit=militia count=<span class="hljs-number"><span class="hljs-number">1</span></span>] Execute:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.0065625</span></span> Apply:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.0004573</span></span> { <span class="hljs-attr"><span class="hljs-attr">"LOCAL_PERSISTENTS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@changed"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"2"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"UNITS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@set"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"militia"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>}}, <span class="hljs-attr"><span class="hljs-attr">"ASSIGNED"</span></span>:<span class="hljs-number"><span class="hljs-number">7</span></span>}}}, <span class="hljs-attr"><span class="hljs-attr">"UI_SCREENS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@changed"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"main"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"SELECTED_UNITS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@set"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"militia"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"@new"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"TYPE"</span></span>:<span class="hljs-string"><span class="hljs-string">"militia"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"REMARK"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"COUNT"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"SELECTED"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"DISABLED"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"HIGHLIGHT_GREEN"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"HIGHLIGHT_RED"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"BUTTON_ENABLED"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>}}}}}}}</code> </pre> <br>  Como se costuma dizer, √© muito mais claro.  Dispense tempo para equipar a equipe com um registro conveniente, compacto e informativo.  Essa √© a chave da sua felicidade.  O modelo deve funcionar muito rapidamente; portanto, usamos uma variedade de truques com m√©todos de armazenamento e acesso aos campos.  Os comandos s√£o executados na pior das hip√≥teses uma vez por quadro, na verdade, v√°rias vezes com menos frequ√™ncia; portanto, realizaremos serializa√ß√£o e desserializa√ß√£o dos campos de comando sem qualquer fantasia, apenas atrav√©s da reflex√£o.  Somente classificamos os campos pelos nomes, para que a ordem seja fixa. Bem, compilaremos a lista de campos uma vez durante a vida do comando e leremos escrever usando os m√©todos nativos C #. <br><br><h2>  Modelo de informa√ß√£o para a interface. </h2><br>  Vamos dar o pr√≥ximo passo para complicar nosso mecanismo, um passo que parece assustador, mas simplifica bastante a grava√ß√£o e a depura√ß√£o de interfaces.  Muitas vezes, especialmente no padr√£o MVP relacionado, o modelo cont√©m apenas l√≥gica de neg√≥cios controlada pelo servidor, e as informa√ß√µes sobre o estado da interface s√£o armazenadas no apresentador.  Por exemplo, voc√™ deseja solicitar cinco ingressos.  Voc√™ j√° selecionou o n√∫mero deles, mas ainda n√£o clicou no bot√£o "encomendar".  As informa√ß√µes sobre exatamente quantos tickets voc√™ escolheu no formul√°rio podem ser armazenadas em algum lugar nos cantos secretos da classe, que serve como uma junta entre o modelo e sua exibi√ß√£o.  Ou, por exemplo, o jogador muda de uma tela para outra, mas nada muda no modelo, e onde ele estava quando a trag√©dia aconteceu, o programador de depura√ß√£o conhece apenas as palavras de um testador extremamente disciplinado.  A abordagem √© simples, compreens√≠vel, quase sempre usada e um pouco maliciosa, na minha opini√£o.  Porque, se algo der errado, √© absolutamente imposs√≠vel descobrir o estado desse apresentador, que levou a um erro.  Especialmente se o erro ocorreu no servidor de batalha durante a opera√ß√£o por US $ 1000, e n√£o no testador em um ambiente controlado e reproduz√≠vel. <br><br>  Em vez dessa abordagem usual, proibimos que qualquer pessoa, exceto o modelo, contenha informa√ß√µes sobre o estado da interface.  Isso tem, como sempre, vantagens e desvantagens que precisam ser combatidas. <br><br><ul><li>  <b>(+1)</b> A vantagem mais importante, economizando meses de trabalho de programa√ß√£o - se algo der errado, o programador simplesmente carrega o estado do jogo antes do acidente e recebe exatamente o mesmo estado n√£o apenas do modelo de neg√≥cios, mas de toda a interface at√© o √∫ltimo bot√£o na tela. </li><li>  <b>(+2)</b> Se alguma equipe mudou alguma coisa na interface, o programador pode facilmente acessar o log e ver o que exatamente mudou de uma forma conveniente do json, como na se√ß√£o anterior. </li><li>  <b>(-1)</b> Muitas informa√ß√µes redundantes aparecem no modelo que n√£o s√£o necess√°rias para entender a l√≥gica de neg√≥cios do jogo e n√£o s√£o necess√°rias duas vezes pelo servidor. </li></ul><br>  Para resolver esse problema, marcaremos alguns campos como notServerVerified, √© assim, por exemplo, assim: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> EDictionary&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, UIStateModel&gt; uiScreens { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UI_SCREENS.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PDictionaryModel&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, UIStateModel&gt; UI_SCREENS = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PDictionaryModel&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, UIStateModel&gt;() { notServerVerified = <span class="hljs-literal"><span class="hljs-literal">true</span></span> };</code> </pre> <br>  Esta parte do modelo e tudo abaixo dele se relacionam exclusivamente com o cliente. <br><br>  Se voc√™ ainda se lembra, os sinalizadores do que voc√™ precisa exportar e o que n√£o s√£o assim: <br><br><pre> <code class="cpp hljs">[Flags] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ExportMode { all = <span class="hljs-number"><span class="hljs-number">0x0</span></span>, changes = <span class="hljs-number"><span class="hljs-number">0x1</span></span>, serverVerified = <span class="hljs-number"><span class="hljs-number">0x2</span></span> }</code> </pre> <br>  Assim, ao exportar ou computar um hash, voc√™ pode especificar se deseja exportar a √°rvore inteira ou apenas a parte dela que √© verificada pelo servidor. <br><br>  A primeira complica√ß√£o √≥bvia que surge a partir daqui √© a necessidade de criar comandos separados que precisam ser verificados pelo servidor e aqueles que n√£o s√£o necess√°rios, mas tamb√©m existem aqueles que precisam ser verificados n√£o inteiramente.  Para n√£o carregar o programador com opera√ß√µes desnecess√°rias para configurar o comando, tentaremos novamente fazer todo o necess√°rio com o cap√¥ do motor. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Command</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/** &lt;summary&gt;    ,      &lt;/summary&gt; */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelRoot root)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-comment"><span class="hljs-comment">/** &lt;summary&gt;         &lt;/summary&gt; */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplyClientSide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelRoot root)</span></span></span><span class="hljs-function"> </span></span>{} }</code> </pre> <br>  O programador que cria o comando pode substituir uma ou ambas as fun√ß√µes.  Tudo isso, √© claro, √© maravilhoso, mas como posso ter certeza de que o programador n√£o estragou nada e se ele estragou algo - como ele pode ajud√°-lo a corrigi-lo r√°pida e facilmente?  Existem duas maneiras.  Eu apliquei o primeiro, mas voc√™ pode gostar mais do segundo. <br><br><h3>  Primeira maneira </h3><br>  Usamos os recursos interessantes do nosso modelo: <br><br><ol><li>  O mecanismo chama a primeira fun√ß√£o, ap√≥s a qual recebe um hash de altera√ß√µes na parte verificada pelo servidor do estado do jogo.  Se n√£o houver altera√ß√µes, estamos lidando exclusivamente com a equipe do cliente. </li><li>  Obtemos o hash de altera√ß√µes do modelo em todo o modelo, n√£o apenas no verificado pelo servidor.  Se for diferente do hash anterior, o programador errou e alterou algo na parte do modelo que n√£o foi verificada pelo servidor.  Percorremos a √°rvore de estados e despejamos o programador como uma execu√ß√£o, uma lista completa dos campos notServerVerified = true e aqueles abaixo da √°rvore que ele alterou. </li><li>  Chamamos a segunda fun√ß√£o.  Obtemos do modelo um hash das altera√ß√µes que ocorreram na parte marcada.  Se n√£o coincidir com o hash ap√≥s a primeira chamada, na segunda fun√ß√£o o programador fez alguma coisa.  Se quisermos obter um log muito informativo nesse caso, reverteremos todo o modelo para seu estado original, serializ√°-lo em um arquivo, o programador ser√° √∫til para depura√ß√£o e depois o clonaremos inteiro (duas linhas - serializa√ß√£o-desserializa√ß√£o), e agora aplicamos primeiro a primeira , comprometemos as altera√ß√µes para que o modelo pare√ßa inalterado, ap√≥s o qual aplicamos a segunda fun√ß√£o.  E ent√£o exportamos todas as altera√ß√µes na parte verificada pelo servidor na forma de JSON e a inclu√≠mos na execu√ß√£o abusiva, para que o programador envergonhado possa ver imediatamente o que e onde ele mudou, o que n√£o deve ser alterado. </li></ol><br>  Parece, √© claro, assustador, mas na verdade s√£o 7 linhas, porque as fun√ß√µes que fazem isso s√£o todas (exceto atravessando a √°rvore a partir do segundo par√°grafo) que estamos prontos.  E, como se trata de recep√ß√£o, podemos nos permitir agir de maneira n√£o otimizada. <br><br><h3>  Segunda via </h3><br>  Um pouco mais brutal, agora no ModelRoot temos um campo de bloqueio, mas podemos dividi-lo em dois, um bloquear√° apenas os campos marcados no servidor e o outro apenas os campos marcados.  Nesse caso, o programador que fez algo errado obter√° uma explica√ß√£o sobre isso imediatamente, vinculando o local onde ele fez.  A √∫nica desvantagem dessa abordagem √© que, em nossa √°rvore, uma propriedade de modelo √© marcada como n√£o verific√°vel, tudo na √°rvore abaixo dela, referente ao c√°lculo de hashes e controle de altera√ß√µes, n√£o ser√° inspecionado, mesmo que cada campo n√£o tenha sido marcado.  Um bloqueio, √© claro, n√£o examinar√° a hierarquia, o que significa que todos os campos da parte n√£o verificada da √°rvore dever√£o ser marcados e n√£o funcionar√° em alguns lugares para usar as mesmas classes na interface do usu√°rio e na parte usual da √°rvore.  Como op√ß√£o, essa constru√ß√£o √© poss√≠vel (escreverei simplificada): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameState</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RootModelData data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RootModelLocal local; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RootModel</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> locked { get; } }</code> </pre> <br>  Acontece que cada sub√°rvore tem seu pr√≥prio bloqueio.  O GameState herda modelos, porque √© mais f√°cil do que apresentar uma implementa√ß√£o separada com a mesma funcionalidade. <br><br><h3>  Melhorias necess√°rias </h3><br>  Obviamente, o gerente respons√°vel pelo processamento das equipes precisar√° adicionar novas funcionalidades.  A ess√™ncia das altera√ß√µes ser√° que nem todos os comandos ser√£o enviados ao servidor, mas apenas aqueles que criam as altera√ß√µes verificadas.  O servidor do lado dele n√£o aumentar√° a √°rvore de estado do jogo inteiro, mas apenas a parte que est√° sendo verificada e, portanto, o hash coincidir√° apenas para a parte que est√° sendo verificada.  Quando um comando √© executado no servidor, apenas a primeira das duas fun√ß√µes do comando ser√° ativada e, ao resolver refer√™ncias a modelos no estado do jogo, se o caminho levar a uma parte n√£o verific√°vel da √°rvore, nulo ser√° colocado na vari√°vel de comando em vez do modelo.  Todas as equipes que n√£o enviaram permanecer√£o honestamente alinhadas com as usuais, mas ser√£o consideradas como j√° confirmadas.  Assim que chegarem √† fila e n√£o houver outros n√£o confirmados diante deles, ser√£o imediatamente aplicados ao segundo estado. <br><br>  N√£o h√° nada fundamentalmente complicado na implementa√ß√£o.  S√≥ que a propriedade de cada campo do modelo tem mais uma condi√ß√£o, uma travessia de √°rvore. <br><br>  Outro refinamento necess√°rio - voc√™ precisar√° do Factory for ParsistentModel separado nas partes verificadas e n√£o verificadas da √°rvore e o NextFreeId ser√° diferente. <br><br><h2>  Comandos iniciados pelo servidor </h2><br>  H√° algum problema se o servidor quiser enviar seu comando ao cliente, porque o estado do cliente em rela√ß√£o ao servidor j√° pode dar alguns passos adiante.  A id√©ia principal √© que, se o servidor precisar enviar seu comando, ele enviar√° a notifica√ß√£o do servidor ao cliente com a pr√≥xima resposta e gravar√° no campo para notifica√ß√µes enviadas a esse cliente.  O cliente recebe uma notifica√ß√£o, forma um comando e o coloca no final de sua fila, ap√≥s aqueles que foram conclu√≠dos no cliente, mas ainda n√£o chegaram ao servidor.  Ap√≥s algum tempo, o comando √© enviado ao servidor como parte do processo normal de trabalho com o modelo.  Ap√≥s receber este comando para processamento, o servidor lan√ßa a notifica√ß√£o para fora da fila de sa√≠da.  Se o cliente n√£o respondeu √† notifica√ß√£o dentro do tempo definido com o pr√≥ximo pacote, um comando de reinicializa√ß√£o √© enviado a ele.  Se o cliente que recebeu a notifica√ß√£o caiu, se conecta mais tarde ou, por algum motivo, carrega o jogo, o servidor transforma todas as notifica√ß√µes em comandos antes de atribuir o estado a ela, executa-as de lado e somente depois disso d√° ao novo cliente o novo estado.  Observe que um jogador pode ter um estado conflitante com recursos negativos quando conseguiu gastar o dinheiro exatamente no momento em que o servidor os retirou.  A coincid√™ncia √© improv√°vel, mas com um DAU grande, √© quase inevit√°vel.  Portanto, as regras da interface e do jogo n√£o devem cair at√© a morte em tal situa√ß√£o. <br><br><h2>  Comandos para executar, dos quais voc√™ precisa saber a resposta do servidor </h2><br>  Um erro t√≠pico √© pensar que um n√∫mero aleat√≥rio s√≥ pode ser obtido no servidor.  Nada impede que voc√™ tenha o mesmo gerador de n√∫meros pseudo-aleat√≥rios em execu√ß√£o simultaneamente a partir do cliente e do servidor, iniciando a partir de um sid comum.  Al√©m disso, a semente atual pode ser armazenada diretamente no estado do jogo.  Alguns podem achar dif√≠cil sincronizar a resposta desse gerador.  De fato, para isso basta ter mais um n√∫mero no mesmo artigo - exatamente quantos n√∫meros foram recebidos do gerador at√© o momento.  Se, por algum motivo, o seu gerador n√£o convergir, h√° um erro em algum lugar e o c√≥digo n√£o funciona deterministicamente.  E esse fato n√£o deve estar oculto sob o tapete, mas resolvido e procurar um erro.  Para a grande maioria dos casos, incluindo at√© as caixas misteriosas, essa abordagem √© suficiente. <br><br>  No entanto, h√° momentos em que essa op√ß√£o n√£o √© adequada.  Por exemplo, voc√™ est√° jogando um pr√™mio muito caro e n√£o quer que o camarada astuto descompile o jogo e escreva um bot que avise com anteced√™ncia o que sair√° da caixa de diamantes se voc√™ a abrir agora e se girar o tambor em outro lugar antes disso.  Voc√™ pode armazenar sementes para cada vari√°vel aleat√≥ria separadamente, isso proteger√° contra hackers frontais, mas n√£o ajudar√° em nada o bot que diz quantas caixas o produto que voc√™ precisa est√° atualmente.  Bem, o caso mais √≥bvio √© que voc√™ pode n√£o querer brilhar na configura√ß√£o do cliente com informa√ß√µes sobre a probabilidade de algum evento raro.  Em resumo, √†s vezes √© necess√°rio aguardar uma resposta do servidor. <br>  Tais situa√ß√µes devem ser resolvidas n√£o atrav√©s dos recursos adicionais do mecanismo, mas dividindo a equipe em duas - a primeira prepara a situa√ß√£o e coloca a interface em um estado de espera por notifica√ß√µes, a segunda, na verdade, notifica√ß√µes, com a resposta que voc√™ precisa.  Mesmo que voc√™ bloqueie firmemente a interface entre eles no cliente, outro comando poder√° passar - por exemplo, uma unidade de energia ser√° restaurada a tempo. <br><br>  √â importante entender que essas situa√ß√µes n√£o s√£o a regra, mas a exce√ß√£o.  De fato, a maioria dos jogos precisa apenas de um time esperando por uma resposta - GetInitialGameState.  Outro pacote desses comandos √© a intera√ß√£o entre jogadores em um meta-jogo, GetLeaderboard, por exemplo.  Todas as outras duzentas pe√ßas s√£o determin√≠sticas. <br><br><h2>  Armazenamento de dados do servidor e o t√≥pico enlameado da otimiza√ß√£o do servidor </h2><br>  Reconhe√ßo imediatamente que sou cliente e, √†s vezes, ouvi essas id√©ias e algoritmos de servidores familiares que eles nem sequer apareciam na minha cabe√ßa.  Ao me comunicar com meus colegas, desenvolvi de alguma forma uma imagem de como minha arquitetura deveria funcionar no lado do servidor, no caso ideal.  No entanto: existem contra-indica√ß√µes, √© necess√°rio consultar um servidor especializado. <br><br>  Primeiro sobre o armazenamento de dados.  √â o lado do servidor que pode ter restri√ß√µes adicionais.  Por exemplo, voc√™ pode ser proibido de usar campos est√°ticos.  Al√©m disso, o c√≥digo de comandos e modelos √© autoport√°vel, mas o c√≥digo de propriedade no cliente e no servidor n√£o precisa coincidir.  Tudo pode estar oculto l√°, at√© a inicializa√ß√£o lenta dos valores de campo do memcache, por exemplo.  Os campos de propriedade tamb√©m podem receber par√¢metros adicionais usados ‚Äã‚Äãpelo servidor, mas n√£o afetam o trabalho do cliente. <br><br>  A primeira diferen√ßa cardinal do servidor: onde os campos s√£o serializados e desserializados.  Uma solu√ß√£o razo√°vel √© que a maior parte da √°rvore de estados seja serializada em um enorme campo bin√°rio ou json.  Ao mesmo tempo, alguns campos s√£o obtidos de tabelas.  Isso √© necess√°rio porque os valores de alguns campos ser√£o constantemente necess√°rios para que os servi√ßos de intera√ß√£o entre os jogadores funcionem.  Por exemplo, o √≠cone e o n√≠vel est√£o constantemente se contraindo por v√°rias pessoas.  Eles s√£o mantidos em um banco de dados regular.  Um estado completo ou parcial, mas detalhado, de uma pessoa ser√° necess√°rio por algu√©m que n√£o seja ele muito raramente, quando algu√©m decide examinar seu territ√≥rio. <br><br>  Al√©m disso, puxar os campos da base, um de cada vez, √© inconveniente e pode arrastar tudo por um longo tempo.  Uma solu√ß√£o n√£o padronizada, dispon√≠vel apenas para nossa arquitetura, pode consistir no fato de o cliente, ao executar um comando, coletar informa√ß√µes sobre todos os campos armazenados separadamente em tabelas cujos getters conseguiram tocar, e adicionar essas informa√ß√µes ao comando para que o servidor possa aumentar esse grupo de campos uma solicita√ß√£o para o banco de dados.  Obviamente, com restri√ß√µes razo√°veis, para n√£o implorar pelo DDOS causado por programadores de m√£os curvadas que tocaram tudo de maneira desatenta. <br><br>  Com esse armazenamento separado, deve-se considerar os mecanismos de transacionalidade quando um jogador rastreia os dados de outro, por exemplo, rouba dinheiro dele.  Mas, no caso geral, fazemos isso por notifica√ß√£o.  Ou seja, o ladr√£o recebe seu dinheiro imediatamente e a pessoa assaltada recebe uma notifica√ß√£o com instru√ß√µes para anular o dinheiro quando se trata disso. <br><br><h2>  Como as equipes s√£o divididas entre servidores </h2><br>  Agora, o segundo momento importante para o servidor.  Existem duas abordagens.  No in√≠cio, para processar qualquer solicita√ß√£o (ou um pacote de solicita√ß√µes), todo o estado √© gerado do banco de dados ou cache para a mem√≥ria, processado e depois retornado ao banco de dados.  As opera√ß√µes s√£o executadas atomicamente em v√°rios servidores de execu√ß√£o diferentes, e eles s√≥ t√™m uma base comum e, mesmo assim, nem sempre.  Como cliente, elevar o estado inteiro para cada equipe √© chocante, mas vi como ele funciona e funciona de maneira muito confi√°vel e escal√°vel.  A segunda op√ß√£o √© que o estado suba na mem√≥ria e permane√ßa l√° at√© que o cliente caia, adicionando ocasionalmente seu estado atual ao banco de dados.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o sou competente para lhe dizer as vantagens e desvantagens deste ou daquele m√©todo. Seria bom se algu√©m nos coment√°rios me explicasse por que o primeiro tem direito √† vida em geral. A segunda op√ß√£o levanta quest√µes sobre como interagir entre jogadores que, por acaso, foram criados em diferentes servidores. Isso pode ser cr√≠tico, por exemplo, se v√°rios membros do cl√£ estiverem se preparando para lan√ßar um ataque conjunto. Voc√™ n√£o pode mostrar aos outros o estado do membro do seu grupo com um atraso de 10 salvamentos. Infelizmente, n√£o vou abri-lo aqui, a intera√ß√£o atrav√©s das notifica√ß√µes descritas acima, comandos de um servidor para outro - agora est√° fora de hora de salvar o estado atual do jogador criado l√°. Se os servidores tiverem o mesmo n√≠vel de disponibilidade de lugares diferentes,e voc√™ pode gerenciar o balanceador, pode tentar transferir silenciosamente o player de um servidor para outro. Se voc√™ conhece uma solu√ß√£o melhor - n√£o se esque√ßa de descrever nos coment√°rios.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dan√ßar com o tempo </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos come√ßar com a pergunta, que eu realmente gosto de derrubar as pessoas nas entrevistas: aqui voc√™ tem um cliente e um servidor, cada um com seu pr√≥prio rel√≥gio bastante preciso. </font><font style="vertical-align: inherit;">Como descobrir o quanto eles diferem. </font><font style="vertical-align: inherit;">Uma tentativa de resolver esse problema em uma cafeteria em um guardanapo revela as melhores e as piores qualidades de um programador. </font><font style="vertical-align: inherit;">O fato √© que o problema n√£o tem uma solu√ß√£o matematicamente correta formal. </font><font style="vertical-align: inherit;">Mas o entrevistado est√° ciente disso, em regra, dedique um minuto no quinto e somente ap√≥s perguntas importantes. </font><font style="vertical-align: inherit;">E a maneira como ele conhece essa percep√ß√£o e o que ele faz a seguir - diz muito sobre a coisa mais importante em seu personagem - o que essa pessoa far√° quando problemas reais come√ßarem no seu projeto.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A melhor solu√ß√£o que eu conhe√ßo me permite descobrir n√£o a diferen√ßa exata, mas esclarecer o intervalo em que ela se encaixa em muitas respostas a pedidos at√© o melhor pacote executado de cliente para servidor, al√©m do tempo do melhor pacote executado de servidor para cliente. No total, isso fornecer√° algumas dezenas de milissegundos de precis√£o. Isso √© muitas vezes melhor que o necess√°rio para o meta-jogo do jogo para celular; aqui n√£o temos multijogador de VR ou CS, mas ainda √© bom para o programador representar a escala e a natureza das dificuldades com a sincroniza√ß√£o do rel√≥gio. Provavelmente, ser√° suficiente que voc√™ conhe√ßa o atraso m√©dio tomado como um ping ao meio, por um longo tempo com um corte de desvios de mais de 30%.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A segunda situa√ß√£o interessante que voc√™ provavelmente encontrar√° √© realizar um jogo de deslize e transferir o rel√≥gio no seu telefone. Nos dois casos, o tempo no aplicativo ser√° alterado de forma dram√°tica e abrupta, e isso deve ser resolvido corretamente. Pelo menos, reinicie o jogo. Mas √© melhor n√£o reiniciar ap√≥s cada deslizamento, para que voc√™ n√£o possa usar o tempo que passou no aplicativo desde o lan√ßamento.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terceiro, a situa√ß√£o, por algum motivo, √© um problema para alguns programadores, embora exista uma solu√ß√£o correta: as opera√ß√µes absolutamente n√£o podem ser executadas no hor√°rio do servidor. Por exemplo, inicie a produ√ß√£o de mercadorias quando uma solicita√ß√£o de produ√ß√£o chegar ao servidor. Caso contr√°rio, d√™ adeus ao seu determinismo e pegue 35 mil dessincroniza√ß√µes por dia causadas por opini√µes diferentes do cliente e do servidor sobre se j√° √© poss√≠vel clicar no pr√™mio. A decis√£o correta √© que a equipe registre informa√ß√µes sobre o hor√°rio em que foi executada. O servidor, por sua vez, verifica se a diferen√ßa hor√°ria entre a hora atual do servidor e a hora no comando est√° dentro do intervalo permitido e, se o fizer, executa o comando da parte usando a hora declarada pelo cliente.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outra tarefa para a entrevista: Tempo limite ap√≥s o qual o cliente tentar√° reiniciar - 30 segundos. Quais s√£o os limites da diferen√ßa de hor√°rio aceit√°vel para o servidor? Dica 1: o intervalo n√£o √© sim√©trico. Dica 2: releia o primeiro par√°grafo desta se√ß√£o novamente, especifique como estender o intervalo para n√£o detectar 3000 erros por dia nos efeitos de borda. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para que isso funcione perfeitamente e corretamente, √© melhor adicionar um par√¢metro adicional aos par√¢metros de chamada de comando - o tempo de chamada.</font></font> Algo assim: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> interface Command { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelRoot root, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> time)</span></span></span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E o meu conselho para voc√™, a prop√≥sito, n√£o usa tipos nativos do Unity por um tempo no modelo - voc√™ vai sufocar. √â melhor armazenar o UnixTime no hor√°rio do servidor, sempre que voc√™ precisar de m√©todos de convers√£o √∫teis, e armazen√°-los no modelo em um campo PTime especial que difere de PValue &lt;long&gt; apenas porque, ao exportar para JSON, ele adiciona informa√ß√µes redundantes entre colchetes que n√£o podem ser lidas quando Importar: hora em um formato leg√≠vel por humanos. Voc√™ n√£o pode me obedecer. Eu te avisei.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quarta situa√ß√£o: No estado do jogo, h√° situa√ß√µes em que uma equipe deve ser iniciada sem a participa√ß√£o de um jogador, a tempo, por exemplo, recupera√ß√£o de energia. Uma situa√ß√£o muito comum, de fato. Eu quero ter um campo, √© convenientemente praticando. Por exemplo, PTimeOut, no qual ser√° poss√≠vel registrar um ponto no tempo ap√≥s o qual um comando deve ser criado e executado. No c√≥digo, pode ser assim:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PTimeOut RESTORE_ENERGY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PTimeOut() {command = (model, property) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestoreEnergyCommand() { model = model}} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> restoreEnergy { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RESTORE_ENERGY.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { RESTORE_ENERGY.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); }} }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obviamente, durante o carregamento inicial do player, o servidor deve primeiro provocar a cria√ß√£o e a execu√ß√£o de todos esses comandos, e somente depois fornecer o estado ao player. A armadilha aqui √© que tudo isso interfere nas notifica√ß√µes que o jogador pode receber durante esse per√≠odo. Portanto, ser√° necess√°rio primeiro desaparafusar o tempo antes da hora da primeira notifica√ß√£o, se voc√™ precisar puxar v√°rios comandos ao mesmo tempo, criar um comando a partir da pr√≥pria notifica√ß√£o, desaparafusar o tempo at√© a pr√≥xima notifica√ß√£o, depois trabalhar e assim por diante. Se todo esse feriado da vida n√£o couber no tempo limite do servidor, e isso √© poss√≠vel se o jogador ficou muito tempo com notifica√ß√µes, escrevemos o estado atual da mem√≥ria no banco de dados e respondemos com um comando para reconectar ao cliente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todos esses comandos devem, de alguma forma, aprender sobre o que eles precisam criar e executar. Minha solu√ß√£o um pouco atrevida, mas conveniente, √© que o modelo tem mais um desafio, que percorre toda a hierarquia do modelo, que se contrai ap√≥s cada comando ser executado e tamb√©m no temporizador. Obviamente, essa √© uma sobrecarga extra para percorrer a √°rvore quase em uma atualiza√ß√£o; em vez disso, voc√™ pode se inscrever ou cancelar a inscri√ß√£o no evento currentTime saindo do estado do jogo a cada altera√ß√£o neste campo:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCurrentTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> time)</span></span></span></span>; } vs <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RootModel</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> event Action&lt;<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>&gt; setCurrentTime; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso √© bom, mas o problema √© que os modelos que s√£o exclu√≠dos da √°rvore de modelos para sempre e que cont√™m esse campo permanecer√£o inscritos nesse evento e ter√£o que resolv√™-lo corretamente. </font><font style="vertical-align: inherit;">Antes de enviar um comando, verifique se eles ainda est√£o na √°rvore e t√™m um elo fraco para esse evento ou invers√£o de controle, para que, por isso, eles n√£o fiquem inacess√≠veis ao GC.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ap√™ndice 1, um caso t√≠pico retirado da vida real </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retiro dos coment√°rios para a primeira parte. Nos brinquedos, muitas vezes algumas a√ß√µes n√£o ocorrem imediatamente ap√≥s o comando do modelo, mas no final de algum tipo de anima√ß√£o. Em nossa pr√°tica, houve um caso em que as caixas misteriosas se abrem e, √© claro, o dinheiro deve mudar apenas quando a anima√ß√£o terminar at√© o fim. Um de nossos desenvolvedores decidiu simplificar sua vida e n√£o altera o valor no comando, mas informa ao servidor que ele mudou e, no final da anima√ß√£o, executa um retorno de chamada, que corrigir√° os valores no modelo para os desejados. Bem feito, em suma. Ele fez essas caixas misteriosas por duas semanas e depois outros tr√™s erros muito dif√≠ceis de serem descobertos como resultado de sua atividade surgiram e tivemos que passar mais tr√™s semanas para peg√°-las, apesar do fato de que o tempo para "reescrever normalmente" era, √© claro, ningu√©m poderia destacar. Da qual se segue vividamentePenso que a conclus√£o √© que era melhor fazer tudo desde o in√≠cio com reatividade normal.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ent√£o, minha decis√£o √© algo assim. Obviamente, o dinheiro n√£o est√° em um campo separado, mas √© um dos objetos no dicion√°rio de invent√°rio, mas isso n√£o √© t√£o importante no momento. O modelo possui uma parte que √© verificada pelo servidor e com base na qual a l√≥gica de neg√≥cios funciona, e a outra que existe apenas no cliente. O dinheiro no modelo principal √© acumulado imediatamente ap√≥s a decis√£o ser tomada e, na segunda parte da lista "exibi√ß√£o adiada", um elemento √© criado para a mesma quantia que inicia a anima√ß√£o pelo fato de sua apar√™ncia e, quando a anima√ß√£o termina, √© iniciado um comando que remove esse elemento. Uma observa√ß√£o t√£o puramente do cliente "ainda n√£o mostra esse valor". E em um campo real, n√£o apenas o valor do campo √© exibido, mas o valor do campo menos todos os adiamentos do cliente. A divis√£o em apenas duas equipes √© feita porquee se o cliente reiniciar ap√≥s o primeiro time, mas antes do segundo todo o dinheiro recebido pelo jogador estar√° em sua conta sem nenhuma marca e exce√ß√£o. No c√≥digo, ser√° algo como isto:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OpenMisterBox</span></span></span><span class="hljs-class"> :</span></span> Command { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> BoxItemModel item; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> slot; <span class="hljs-comment"><span class="hljs-comment">//        ,  . public override void Apply(GameState state) { state.inventory[item.revardKey] += item.revardCount; } //       . public override void Apply(GameState state) { var cause = state.NewPersistent&lt;WaitForCommand&gt;(); cause.key = item.key; cause.value = item.value; state.ui.delayedInventoryVisualization.Add(cause); state.ui.mysteryBoxScreen.animations.Add(new Animation() {cause = item, slot = slot})); } } public class MysteryBoxView : View { /* ... */ public override void ConnectModel(MysteryBoxScreenModel model, List&lt;Control&gt; c) { model.Get(c, MysteryBoxScreenModel.ANIMATIONS) .Control(c, onAdd = item =&gt; animationFactory(item, OnComleteOrAbort =&gt; { AsincQueue(new RemoveAnimation() {cause = item.cause, animation = item}) }), onRemove = item =&gt; {} ) } } public class InventoryView : View&lt;InventoryItem&gt; { public Text text; public override void ConnectModel(InventoryItem model, List&lt;Control&gt; c) { model.GameState.ui.Get(c, UIModel.DELAYED_INVENTORY_VISUALIZATION). .Where(c, item =&gt; item.key == model.key) .Expression(c, onChange = (IList&lt;InventoryItem&gt; list) =&gt; { int sum = 0; for (int i = 0; i &lt; list.Count; i++) sum += list[i].value; return sum; }, onAdd = null, onRemove = null ) //      .Join (c, model.GameState.Get(GameState.INVENTORY).ItemByKey(model.key)) .Expression(c, (delay, count) =&gt; count - delay) .SetText(c, text); //     ,      ,   ,  ,   ,       ,     : model.inventory.CreateVisibleInventoryItemCount(c, model.key).SetText(c, text); } } public class RemoveDelayedInventoryVisualization : Command { public DelayCauseModel cause; public override void Apply(GameState state) { state.ui.delayedInventoryVisualization.Remove(cause); } } public class RemoveAnimation : RemoveDelayedInventoryVisualization { public Animation animation public override void Apply(GameState state) { base.Apply(state); state.ui.mysteryBoxScreen.animations.Remove(animation); } }</span></span></code> </pre> <br>  O que temos no final?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Existem duas visualiza√ß√µes, em uma delas uma certa anima√ß√£o √© reproduzida, cujo final aguarda a exibi√ß√£o do dinheiro em uma visualiza√ß√£o completamente diferente, que n√£o faz id√©ia de quem e por que deseja mostrar um significado diferente. Tudo √© reativo. A qualquer momento, voc√™ pode carregar o estado completo do GameState no jogo e ele come√ßar√° a ser reproduzido exatamente de onde paramos, incluindo a anima√ß√£o inicial. A verdade come√ßar√° do come√ßo, porque n√£o apagamos o est√°gio de anima√ß√£o, mas se realmente precisamos, podemos apag√°-lo.</font></font><br><br><h2>  Total </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tornando a l√≥gica de neg√≥cios do jogo atrav√©s de modelos, equipes e arquivos est√°ticos com regras, envolvendo-os com belos logs detalhados e gerados automaticamente e incluindo execu√ß√µes informativas de muitos erros t√≠picos cometidos pelo programador que v√™ novos recursos, este, na minha opini√£o, √© o caminho certo para viver luz branca. E n√£o apenas porque voc√™ pode arquivar novas funcionalidades v√°rias vezes mais rapidamente. Isso ainda √© muito importante, porque, se for f√°cil para voc√™ baixar e depurar um novo recurso, o criador do jogo ter√° tempo para fazer v√°rias vezes mais experi√™ncias no design de jogos com os mesmos programadores. Com todo o respeito devido ao nosso trabalho, depende de n√≥s se o jogo falha ou n√£o, mas se dispara ou n√£o depende dos gamedismos, e eles precisam ter espa√ßo para experimentos.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E agora pe√ßo que voc√™ responda perguntas muito importantes para mim. </font><font style="vertical-align: inherit;">Se voc√™ tem id√©ias sobre como fazer o que fiz mal ou apenas quer comentar minhas respostas, estou esperando por voc√™ nos coment√°rios. </font><font style="vertical-align: inherit;">Uma proposta de coopera√ß√£o e instru√ß√µes sobre v√°rios erros de sintaxe, por favor, no PM.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt435704/">https://habr.com/ru/post/pt435704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt435692/index.html">Y Combinator: ‚ÄúNo come√ßo, algumas das maiores empresas de tecnologia parecem brinquedos‚Äù</a></li>
<li><a href="../pt435694/index.html">Como e por que otimizamos o algoritmo para limpar caches SLAB no kernel do Linux</a></li>
<li><a href="../pt435696/index.html">Antiguidades: 1997 Publicidade em computador</a></li>
<li><a href="../pt435700/index.html">8 Piores perguntas da entrevista no Vue.js.</a></li>
<li><a href="../pt435702/index.html">Trolls de patentes come√ßam e ganham: como eu fiquei sem jogo</a></li>
<li><a href="../pt435706/index.html">Usamos o rcm para implantar a configura√ß√£o em qualquer pasta</a></li>
<li><a href="../pt435708/index.html">Fayal: um ponto de encontro no Atl√¢ntico</a></li>
<li><a href="../pt435712/index.html">Procter & Gamble lan√ßa impressora anti-envelhecimento para pele</a></li>
<li><a href="../pt435714/index.html">Os desenvolvedores ucranianos tiveram acesso aos arquivos de todas as c√¢meras Ring do mundo</a></li>
<li><a href="../pt435718/index.html">Bombeamos NGSW angular usando l√≥gica personalizada no Service Worker</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>