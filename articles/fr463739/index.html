<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ùï üìØ üíΩ Syst√®me de gestion de la configuration r√©seau du filtre Qrator üç™ üë®üèº‚Äç‚úàÔ∏è üòô</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR : Description de l'architecture client-serveur de notre syst√®me de gestion de configuration de r√©seau interne, QControl. Il est bas√© sur un pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Syst√®me de gestion de la configuration r√©seau du filtre Qrator</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qrator/blog/463739/"><img src="https://habrastorage.org/webt/m2/ak/w7/m2akw7igwdnpnlkl-wtyczkznlc.jpeg"><br><br>  <b>TL; DR</b> : Description de l'architecture client-serveur de notre syst√®me de gestion de configuration de r√©seau interne, QControl.  Il est bas√© sur un protocole de transport √† deux niveaux qui fonctionne avec des messages compress√©s avec gzip sans d√©compression entre les points de terminaison.  Les routeurs et les points finaux distribu√©s re√ßoivent des mises √† jour de configuration, et le protocole lui-m√™me permet l'installation de relais interm√©diaires localis√©s.  Le syst√®me est construit sur le principe de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sauvegarde diff√©rentielle</a> (¬´r√©cent-stable¬ª, expliqu√© ci-dessous) et utilise le langage de requ√™te JMESpath avec le moteur de mod√®le Jinja pour rendre les fichiers de configuration. <br><br>  Qrator Labs g√®re un r√©seau d'att√©nuation des attaques distribu√© √† l'√©chelle mondiale.  Notre r√©seau fonctionne sur le principe de anycast, et les sous-r√©seaux sont annonc√©s via BGP.  En tant que r√©seau de diffusion BGP situ√© physiquement dans plusieurs r√©gions de la Terre, nous pouvons traiter et filtrer le trafic ill√©gitime plus pr√®s du c≈ìur de l'Internet - les op√©rateurs de niveau 1. <br><br>  D'un autre c√¥t√©, √™tre un r√©seau g√©ographiquement distribu√© n'est pas facile.  La communication entre les points de pr√©sence du r√©seau est essentielle pour un fournisseur de services de s√©curit√© afin d'avoir une configuration coh√©rente de tous les n≈ìuds du r√©seau, en les mettant √† jour en temps opportun.  Par cons√©quent, afin de fournir le plus haut niveau possible de services de base aux consommateurs, nous devions trouver un moyen de synchroniser de mani√®re fiable les donn√©es de configuration entre les continents. <br><blockquote>  Au commencement √©tait la Parole.  Il est rapidement devenu un protocole de communication n√©cessitant une mise √† jour. </blockquote><a name="habracut"></a><br>  La pierre angulaire de l'existence de QControl et en m√™me temps la principale raison de consacrer beaucoup de temps et de ressources √† la construction d'un tel protocole est la n√©cessit√© d'obtenir une source de configuration unique faisant autorit√© et, en fin de compte, de synchroniser nos points de pr√©sence avec lui.  Le r√©f√©rentiel lui-m√™me n'√©tait qu'une des nombreuses exigences lors du d√©veloppement de QControl.  En plus de cela, nous avions √©galement besoin d'une int√©gration avec les services existants et pr√©vus aux points de pr√©sence (TP), des m√©thodes intelligentes (et personnalisables) de validation des donn√©es, ainsi que le contr√¥le d'acc√®s.  En plus de cela, nous voulions √©galement g√©rer un tel syst√®me √† l'aide de commandes, plut√¥t que d'apporter des modifications aux fichiers.  Avant QControl, les donn√©es √©taient envoy√©es aux points de pr√©sence en mode presque manuel.  Si l'un des points de pr√©sence n'√©tait pas disponible et que nous avons oubli√© de le mettre √† jour plus tard, la configuration s'est r√©v√©l√©e d√©synchronis√©e - vous avez d√ª passer du temps √† le remettre en service. <br><br>  En cons√©quence, nous sommes arriv√©s avec le sch√©ma suivant: <br><img src="https://habrastorage.org/webt/_5/iy/zf/_5iyzfealoms5eprrxrmg-hhwui.png"><br>  Le serveur de configuration est responsable de la validation et du stockage des donn√©es, le routeur dispose de plusieurs points d'extr√©mit√© qui re√ßoivent et diffusent les mises √† jour de configuration des clients et des √©quipes d'assistance au serveur, et du serveur aux points de pr√©sence. <br><br>  La qualit√© de la connexion Internet est encore sensiblement diff√©rente dans diff√©rentes parties du monde - pour illustrer cette th√®se, regardons un simple MTR de Prague, de la R√©publique tch√®que √† Singapour et √† Hong Kong. <br><br> <a href=""><img src="https://habrastorage.org/webt/ob/pl/vc/obplvcdpqlc8as-nra_jnpv4hbc.png" alt="image"></a> <br>  MTR de Prague √† Singapour <br><br> <a href=""><img src="https://habrastorage.org/webt/4z/xo/7s/4zxo7sr_qqrg6cdlipwwvujohto.png" alt="image"></a> <br>  M√™me chose √† Hong Kong <br><br>  Des retards √©lev√©s signifient moins de vitesse.  De plus, il y a perte de paquets.  La largeur des canaux ne compense pas ce probl√®me, qui doit toujours √™tre pris en compte lors de la construction de syst√®mes d√©centralis√©s. <br><br>  Une configuration compl√®te de point de pr√©sence est une quantit√© importante de donn√©es qui doivent √™tre envoy√©es √† de nombreux destinataires via des connexions non fiables.  Heureusement, bien que la configuration change constamment, cela se produit par petites portions. <br><br><h3>  Conception r√©cente et stable </h3><br>  On peut dire que la construction d'un r√©seau distribu√© sur le principe des mises √† jour incr√©mentales est une solution assez √©vidente.  Mais il y a beaucoup de probl√®mes avec les diff√©rences.  Nous devons conserver tous les diff√©rences entre les points de contr√¥le, ainsi que pouvoir les envoyer au cas o√π quelqu'un manquerait certaines des donn√©es.  Chaque destination doit les appliquer dans une s√©quence strictement d√©finie.  En r√®gle g√©n√©rale, dans le cas de plusieurs destinations, une telle op√©ration peut prendre beaucoup de temps.  Le destinataire doit √©galement pouvoir demander les pi√®ces manquantes et, bien entendu, la partie centrale doit r√©pondre correctement √† une telle demande, en n'envoyant que les donn√©es manquantes. <br><br>  En cons√©quence, nous sommes arriv√©s √† une solution plut√¥t int√©ressante - nous n'avons qu'une seule couche de support, fixe, appelons-la stable, et une seule diff√©rence car elle est r√©cente.  Chaque r√©cent est bas√© sur la derni√®re stable form√©e et est suffisant pour reconstruire les donn√©es de configuration.  D√®s qu'un nouveau r√©cent arrive √† destination, l'ancien n'est plus n√©cessaire. <br><br>  Il ne reste que de temps en temps d'envoyer une nouvelle configuration stable, par exemple, du fait que la r√©cente est devenue trop volumineuse.  Il est √©galement important ici que nous envoyions toutes ces mises √† jour en mode diffusion / multidiffusion, sans se soucier des destinataires individuels et de leur capacit√© √† collecter des donn√©es ensemble.  D√®s que nous sommes convaincus que tout le monde a la bonne √©curie, nous n'envoyons que des nouveaux r√©cents.  Vaut-il la peine de pr√©ciser que cela fonctionne?  √áa marche.  Stable est mis en cache sur le serveur de configuration et les destinataires, r√©cent est cr√©√© au besoin. <br><br><h3>  Architecture de transport √† deux niveaux </h3><br>  Pourquoi avons-nous construit notre transport sur deux niveaux?  La r√©ponse est assez simple - nous voulions s√©parer le routage de la logique de haut niveau, en nous inspirant du mod√®le OSI avec sa couche transport et sa couche application.  Pour le r√¥le du protocole de transport, nous avons pris Thrift, et pour le format de message de contr√¥le de haut niveau, le format de s√©rialisation msgpack.  C'est pourquoi le routeur (ex√©cutant la multidiffusion / diffusion / relais) ne regarde pas √† l'int√©rieur de msgpack, ne d√©compresse pas et ne recompresse pas le contenu, et effectue uniquement le transfert de donn√©es. <br><br>  <i>Thrift (de l'anglais - "thrift", prononc√© [Œ∏rift]) est un langage de description d'interface qui est utilis√© pour d√©finir et cr√©er des services pour diff√©rents langages de programmation.</i>  <i>Il s'agit d'un cadre pour l'appel de proc√©dure distante (RPC).</i>  <i>Il combine un pipeline logiciel avec un moteur de g√©n√©ration de code pour d√©velopper des services qui, √† un degr√© ou √† un autre, fonctionnent efficacement et facilement entre les langues.</i> <br><br>  Nous avons adopt√© le framework Thrift en raison de RPC et de la prise en charge de nombreuses langues.  Comme d'habitude, le client et le serveur sont les parties faciles.  Cependant, le routeur s'est av√©r√© √™tre un √©crou dur, en partie √† cause du manque de solution pr√™te √† l'emploi lors de notre d√©veloppement. <br><br><img src="https://habrastorage.org/webt/l8/so/6v/l8so6vrzh0u_feb60p6ehjbubs0.png" alt="image" align="left">  Il existe d'autres options, telles que protobuf / gRPC, cependant, lorsque nous avons commenc√© notre projet, gRPC √©tait assez jeune et nous n'avons pas os√© le prendre en compte. <br><br>  Bien s√ªr, nous avons pu (et en fait, √ßa valait le coup) cr√©er notre propre v√©lo.  Il serait plus facile de cr√©er un protocole pour ce dont nous avons besoin, car l'architecture client-serveur est relativement simple √† mettre en ≈ìuvre par rapport √† la construction d'un routeur sur Thrift.  D'une mani√®re ou d'une autre, il existe une attitude traditionnelle de pr√©jug√©s √† l'√©gard des protocoles auto-√©crits et des impl√©mentations des biblioth√®ques populaires (pas en vain), de plus, la discussion soul√®ve toujours la question: ¬´Comment allons-nous le porter dans d'autres langues?¬ª  Par cons√©quent, nous avons imm√©diatement jet√© des id√©es sur le v√©lo. <br><br>  <i>Msgpack est un analogue de JSON, mais plus rapide et moins.</i>  <i>Il s'agit d'un format de s√©rialisation de donn√©es binaires qui permet l'√©change de donn√©es entre plusieurs langues.</i> <br><br>  Au premier niveau, nous avons Thrift avec le minimum d'informations n√©cessaires au routeur pour transmettre le message.  Au deuxi√®me niveau sont des structures msgpack packag√©es. <br><br>  Nous avons choisi msgpack car il est plus rapide et plus compact que JSON.  Mais plus important encore, il prend en charge les types de donn√©es personnalis√©s, ce qui nous permet d'utiliser des fonctionnalit√©s int√©ressantes telles que le transfert de fichiers binaires bruts ou d'objets sp√©ciaux indiquant le manque de donn√©es, ce qui √©tait important pour notre sch√©ma r√©cemment stable. <br><br>  <b>Jmespath</b> <br>  <i>JMESPath est un langage de requ√™te JSON.</i> <br>  C'est exactement √† quoi ressemble la description, que nous obtenons de la documentation officielle JMESPath, mais en fait, cela en donne beaucoup plus.  JMESPath vous permet de rechercher et de filtrer des sous-arbres dans une arborescence arbitraire, ainsi que d'appliquer des modifications aux donn√©es √† la vol√©e.  Il vous permet √©galement d'ajouter des filtres sp√©ciaux et des proc√©dures de conversion de donn√©es.  Bien s√ªr, cela n√©cessite une tension c√©r√©brale pour comprendre. <br><br>  <b>Jinja</b> <br>  Pour certains consommateurs, nous devons transformer la configuration en fichier - nous utilisons donc le moteur de mod√®le et Jinja est le choix √©vident.  Avec son aide, nous g√©n√©rons un fichier de configuration √† partir du mod√®le et des donn√©es re√ßues √† destination. <br><br>  Pour g√©n√©rer le fichier de configuration, nous avons besoin d'une demande JMESPath, d'un mod√®le pour l'emplacement du fichier dans le FS, d'un mod√®le pour la configuration elle-m√™me.  √Ä ce stade √©galement, il est agr√©able de clarifier les autorisations de fichier.  Tout cela s'est av√©r√© √™tre combin√© avec succ√®s dans un seul fichier - avant le d√©but du mod√®le de configuration, nous avons mis l'en-t√™te au format YAML, qui d√©crit le reste. <br><br>  Par exemple: <br><br> <code>--- <br> selector: "[@][?@.fft._meta.version == `42`] | items([0].fft_config || `{}`)" <br> destination_filename: "fft/{{ match[0] }}.json" <br> file_mode: 0644 <br> reload_daemons: [fft] <br> ... <br> {{ dict(match[1]) | json(indent=2, sort_keys=True) }} <br></code> <br><br>  Afin de cr√©er un fichier de configuration pour un nouveau service, nous ajoutons uniquement un nouveau fichier mod√®le.  Aucune modification du code source ou du logiciel aux points de pr√©sence n'est requise. <br><br>  Qu'est-ce qui a chang√© depuis l'introduction de QControl dans les op√©rations?  Le premier et le plus important est la livraison coh√©rente et fiable des mises √† jour de configuration sur tous les n≈ìuds du r√©seau.  La seconde consiste √† obtenir un puissant outil de v√©rification de la configuration et √† y apporter des modifications par notre √©quipe d'assistance, ainsi que par les consommateurs du service. <br><br>  Nous avons r√©ussi √† faire tout cela en utilisant le sch√©ma de mise √† jour stable r√©cent pour simplifier la communication entre le serveur de configuration et les destinataires de la configuration.  Utilisation d'un protocole √† deux couches pour prendre en charge une m√©thode de routage de donn√©es ind√©pendante du contenu.  Ayant int√©gr√© avec succ√®s le moteur de g√©n√©ration de configuration bas√© sur Jinja dans un r√©seau de filtrage distribu√©.  Ce syst√®me prend en charge un large √©ventail de m√©thodes de configuration pour nos p√©riph√©riques distribu√©s et vari√©s. <br><br>  Merci d'avoir √©crit du mat√©riel gr√¢ce √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">VolanDamrod</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">serenheit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">NoN</a> . <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Version anglaise de l'</a> article. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr463739/">https://habr.com/ru/post/fr463739/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr463727/index.html">Comment entrer dans le top Google dans l'UE / √âtats-Unis dans le cr√©neau du d√©veloppement et trouver des clients avec de gros budgets</a></li>
<li><a href="../fr463729/index.html">Rencontre avec le fondateur de NSTR Viktor Chernikov</a></li>
<li><a href="../fr463733/index.html">Mesh VS WiFi: que choisir pour le sans fil?</a></li>
<li><a href="../fr463735/index.html">Syst√®me de distribution de configuration de r√©seau de filtrage Qrator</a></li>
<li><a href="../fr463737/index.html">R√©solution de probl√®mes avec pwnable.kr 21 - horcuxes. Cha√Æne de programmation orient√©e retour et cha√Ænes ROP</a></li>
<li><a href="../fr463741/index.html">Firefox (d√©j√† corrig√©) et Chrome vous permettent d'utiliser l'en-t√™te Alt-Svc pour analyser les ports intranet</a></li>
<li><a href="../fr463745/index.html">La complication du C ++ est in√©vitable. Et pas seulement C ++</a></li>
<li><a href="../fr463747/index.html">Acc√©der aux propri√©t√©s √† l'int√©rieur du champ Jsonb pour Npgsql</a></li>
<li><a href="../fr463749/index.html">Scrum vs Kanban: Restez calme et choisissez ce qui vous convient le mieux</a></li>
<li><a href="../fr463751/index.html">iOS 13: ce dont vous avez besoin et ce que vous n'avez absolument pas besoin de faire lors du d√©veloppement d'un nouvel OS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>