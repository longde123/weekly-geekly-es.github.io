<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèê üë¥ üëéüèø MOXA Nport - Vis√£o interna üë©‚Äçüë©‚Äçüëß‚Äçüë¶ üë©üèΩ‚Äçüè´ ü§≤üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Atualmente, os servidores de coleta de dados de porta serial MOXA Nport e similares s√£o o padr√£o de fato no campo de sistemas de constru√ß√£o que transm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MOXA Nport - Vis√£o interna</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478642/">  Atualmente, os servidores de coleta de dados de porta serial MOXA Nport e similares s√£o o padr√£o de fato no campo de sistemas de constru√ß√£o que transmitem ou recebem dados via interfaces RS-232, RS-485 e RS-422. <br><br>  Medidores de eletricidade, v√°lvulas controladas e v√°lvulas de port√£o, medidores de vaz√£o, sensores de vibra√ß√£o, dispositivos de telemec√¢nica. <br><br>  Tudo o que pode gerar dados ou ser controlado remotamente e possui uma interface RS-232, RS-485 e RS-422 - funciona atrav√©s desses conversores. <br><br>  O objetivo geral de seu uso √© geralmente o seguinte: encaminhar as interfaces RS-232, RS-485 e RS-422 por meio de uma rede local existente, conectar um dispositivo ou dispositivo que possui uma das interfaces seriais a um PC (servidor, SCADA) via Ethernet, conectar-se ao dispositivo ter uma interface serial via Internet para controle remoto, etc. <br><br>  Os pre√ßos desses conversores n√£o s√£o muito altos; modelos mais jovens podem ser emprestados por US $ 100-200.  Por√©m, considerando que centenas ou at√© milhares podem ser instalados em qualquer produ√ß√£o automatizada de tais dispositivos, est√° surgindo um petisco para os ‚Äúsubstitutos de importa√ß√£o‚Äù dom√©sticos. <br><br>  Vou tentar ajud√°-los hoje. <br><br>  O que vamos fazer? <br><br>  Primeiramente, entenderemos a teoria de como ela √© organizada por dentro. <br><br>  Em segundo lugar, isolamos a funcionalidade m√≠nima para iniciar o trabalho no modo Real Com (ou seja, para encaminhar a porta COM virtual para o dispositivo via Ethernet). <br><br>  Em terceiro lugar, por uma quest√£o de interesse, analisaremos o protocolo para pesquisar e configurar o dispositivo atrav√©s do utilit√°rio NPort Administration Suite.  Obteremos um entendimento completo de como criar um an√°logo pin-to-pin de um peda√ßo de ferro que pode ser preso no lugar do MOXA Nport existente, enquanto recebemos suporte total do driver e software nativos. <br><br>  E, finalmente, vamos tentar calcular quantos √≠ndios escreveram o c√≥digo de firmware MOXA. <br><a name="habracut"></a><br><h4>  Parte 1. Introdut√≥ria </h4><br>  Portanto, temos um assunto de teste em nossa tabela (na verdade, havia v√°rios deles, portanto, n√£o se surpreenda se voc√™ vir identificadores de modelo diferentes e endere√ßos MAC diferentes no artigo) <br><br><img src="https://habrastorage.org/webt/zs/bu/co/zsbucoqb74oopd5ld_vkqkqipfc.jpeg"><br><br>  Possui uma porta Ethernet e duas portas RS-422 / RS-485 - isso √© fisicamente. <br>  E no plano do programa - no dispositivo est√£o abertos: <br>  Porta UDP 4800 - √© respons√°vel pela captura de pacotes de pesquisa de dispositivos e envia dados sobre o pr√≥prio dispositivo ao utilit√°rio de configura√ß√£o. <br><br>  Porta TCP 4900 - recebe comandos de configura√ß√£o do dispositivo.  A hora, o nome, o endere√ßo IP, o modo de opera√ß√£o, as configura√ß√µes de velocidade e porta do dispositivo e outros par√¢metros b√°sicos podem ser configurados por essa porta, que pode ser configurada pela interface principal do utilit√°rio NPort Administration Suite: <br><br><img src="https://habrastorage.org/webt/mh/me/79/mhme79fontjiywnsdxgq_wk2sau.png"><br><br>  Porta TCP 80 - √© respons√°vel pela opera√ß√£o da interface WEB <br>  As portas TCP 966, 967 (e 968, 969 para 4 dispositivos de porta) s√£o portas de controle de transmiss√£o.  Eles executam comandos para abrir / fechar a porta COM correspondente, definir a velocidade da porta, enviar dados, monitorar a plenitude do buffer de transmiss√£o / recep√ß√£o, etc.  A porta 966 √© respons√°vel pela opera√ß√£o da primeira porta, respectivamente. <br><br>  As portas TCP (por padr√£o) 950, 951 e (e 952, 953 para 4 dispositivos de porta) s√£o portas de transfer√™ncia direta de dados.  Ou seja, o que deve aparecer diretamente na porta RS-232/485/422 do dispositivo √© transmitido para a porta de dados.  Somente o controle de fluxo de dados nessa porta vai para 966, 967, 968, 969 portas, respectivamente. <br><br>  Espero que a imagem geral de entender o funcionamento do dispositivo na minha cabe√ßa tenha se desenvolvido.  Vamos para a pr√≥xima parte: <br><br><h4>  Parte 2. Emule o MOXA </h4><br>  Certamente j√° ficou claro para muitos que, para fingir ser o MOXA Nport na configura√ß√£o m√≠nima, √© necess√°rio criar um servidor TCP em seu pr√≥prio hardware em 2 portas: 966 para controle de transmiss√£o e 950 para transmiss√£o direta de dados.  Naturalmente, voc√™ precisar√° responder e processar corretamente as solicita√ß√µes de driver na porta 966, mas, como mostra a an√°lise do wireshark, n√£o h√° muitas solicita√ß√µes e elas s√£o as mais simples. <br><br>  Para n√£o sobrecarregar o texto do artigo com c√°lculos que descrevem as solicita√ß√µes e respostas, preparei e publiquei separadamente, na forma de um arquivo pdf, uma descri√ß√£o de todas as solicita√ß√µes, respostas e par√¢metros transmitidos analisados. <br><br>  <a href="http://multimake.ru/wp-content/uploads/2019/12/%25D0%259E%25D0%25BF%25D0%25B8%25D1%2581%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5-%25D1%2580%25D0%25B0%25D0%25B7%25D0%25B1%25D0%25BE%25D1%2580%25D0%25B0-%25D0%25BF%25D1%2580%25D0%25BE%25D1%2582%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25BB%25D0%25B0-MOXA.pdf">Download: Descri√ß√£o do protocolo de an√°lise do MOXA.pdf</a> <br>  Ou seja, esse conjunto de conhecimentos permite implementar um dispositivo que pode ser emparelhado com um driver nativo e transmitir dados como MOXA.  Metade do trabalho est√° conclu√≠da, mas h√° um ponto - como alterar a configura√ß√£o?  Seria √≥timo usar o utilit√°rio nativo do NPort Administration Suite para esses fins. <br><br><h4>  Parte 3. Pesquise e encontre </h4><br>  As duas primeiras partes descreveram o que precisa ser feito, mas n√£o havia uma palavra sobre como obter dados para a implementa√ß√£o dos protocolos. <br><br>  Nesta parte, nos aprofundamos um pouco e vemos como a an√°lise da troca foi realizada. <br>  Sabemos que a porta UDP 4800 est√° aberta no dispositivo, vamos conectar o dispositivo, executar o NPort Administration Suite, o Wireshark e ver o que acontece ao procurar dispositivos com o utilit√°rio nativo. <br><br><img src="https://habrastorage.org/webt/fk/b8/om/fkb8om_d1ieh_2wipyvvglmwzn8.png"><br><br>  N√≥s olhamos para os pacotes enviados: <br><br><img src="https://habrastorage.org/webt/av/j7/pg/avj7pgj8udm7ujvvnbs-26eip4i.png"><br><br>  Vemos que o NPort Administration Suite envia uma transmiss√£o para o endere√ßo 255.255.255.255, ou seja, espera que o pacote voe pela rede. <br><br>  O pacote de carga √∫til cont√©m dados: <br><br><pre><code class="plaintext hljs">01 00 00 08 00 00 00 00, : 01 00 ‚Äì   00 08 ‚Äì       Big Endian. 00 00 00 00 ‚Äì  </code> </pre> <br>  Esse pedido √© enviado v√°rias vezes, aparentemente na esperan√ßa de que pelo menos um deles atinja o objetivo. <br><br>  Todos os MOXs respondem a esta solicita√ß√£o. <br><br><img src="https://habrastorage.org/webt/v7/u3/zn/v7u3zn6pil6rw8ijo1mad4caea4.png"><br><br>  Especificamente, nossa resposta: <br><br><pre> <code class="plaintext hljs"> 81 00 00 18 00 00 00 00 12 03 00 80 32 03 00 90 e8 26 4a ab c0 a8 7f fe 81 00 ‚Äì   00 18 ‚Äì     (24) 00 00 00 00 ‚Äì   12 03 00 80 32 03 ‚Äì  MOXA Nport device,    NPort 5232.        MOXA Nport device.          NPort Administrator. 00 90 e8 26 4a ab ‚Äì MAC  MOXA Nport device c0 a8 7f fe ‚Äì IP  MOXA Nport device ( 192.168.127.254 )</code> </pre> <br>  Parece que tudo √© simples e elementar, confunde apenas o valor 12 03 00 80 32 03, respons√°vel pela interpreta√ß√£o de um modelo de dispositivo espec√≠fico. <br><br>  Mas, como esse valor √© verificado em rela√ß√£o a alguma refer√™ncia de refer√™ncia, significa que deve ser armazenado em algum lugar. <br><br>  Depois de estudar um pouco o diret√≥rio do software, descobrimos que no NPort Administrator Suite v1.22 esses valores est√£o armazenados no arquivo C: \ Arquivos de Programas \ NPortAdminSuite \ bin \ dsci.dll <br><br><img src="https://habrastorage.org/webt/fs/sf/8k/fssf8kgx4iaz45n0fzucjonzkla.png"><br><br>  Depois de ficar sentado com o Wireshark e o dispositivo por v√°rios dias, obtemos um log completo de trocas e uma compreens√£o de quais c√≥digos de fun√ß√£o recebem resposta.  Por conveni√™ncia, tudo o que √© encontrado √© descrito no mesmo arquivo pdf, cujo link √© indicado no artigo anterior. <br><br>  Para uma melhor compreens√£o da imagem - lembrarei apenas que o UDP 4800 recebe informa√ß√µes prim√°rias sobre o dispositivo, todos os par√¢metros que requerem configura√ß√£o e instala√ß√£o s√£o configurados por meio de solicita√ß√µes para a porta TCP 4900. <br><br>  Depois de processar corretamente todas as solicita√ß√µes recebidas das portas 4800 e 4900, podemos fingir ser um dispositivo, para que nem o software nativo perceba o problema. <br><br><h4>  Parte 4. Contando os √≠ndios * </h4><br>  Ao analisar o protocolo, tive a sensa√ß√£o de que diferentes partes do protocolo de troca foram escritas por pessoas diferentes, o significado das fun√ß√µes e sua interpreta√ß√£o s√£o muito diferentes. <br><br>  Ent√£o, por exemplo: <br><br>  Os c√≥digos de fun√ß√£o da porta UDP 4800 come√ßam com: <br><br><pre> <code class="plaintext hljs"> 01 00 .. ..  81 00 .. ..  10 00 .. ..  90 00 .. ..  16 00 .. ..  96 00 .. ..  29 00 .. ..  a9 00 .. ..</code> </pre> <br>  Os c√≥digos de fun√ß√£o da porta TCP 4900 come√ßam com: <br><br><pre> <code class="plaintext hljs"> 00 01 .. ..  00 01 .. ..  02 01 .. ..  02 01 .. ..</code> </pre> <br>  e assim por diante <br><br>  Os c√≥digos de fun√ß√£o das portas TCP 966, 967, 968, 969 come√ßam com: <br><br><pre> <code class="plaintext hljs"> 10 .. ..  10 4f 4b  11 .. ..  11 4f 4b</code> </pre> <br>  e assim por diante <br><br>  Ou seja, √© usado um identificador de byte √∫nico da fun√ß√£o e n√£o um byte duplo como antes. <br>  Ent√£o, a prop√≥sito, surgiu um momento engra√ßado.  Nas portas 966, 967, 968, 969, a resposta aos par√¢metros de configura√ß√£o sempre consiste em 3 bytes. <br><br>  O primeiro √© o n√∫mero da fun√ß√£o e os 2 restantes s√£o 4f 4b ou h√° uma olhada na tabela ASCII - ‚ÄúO‚Äù ‚ÄúK‚Äù <br><br>  Bem, tudo bem com ele, v√° em frente. <br><br>  O segundo recurso visto √© um hash de Big e Little Endian dentro da mesma resposta. <br><br>  Exemplo de resposta: <br><br><pre> <code class="plaintext hljs">9a 00 00 24 00 00 00 00 01 52 00 80 9a 52 00 90 e8 3b 89 9c 75 00 04 00 01 00 0f 00 09 00 17 00 36 00 00 00 9a 00 ‚Äì   00 24 ‚Äì     (36) 00 00 00 00 ‚Äì   01 52 00 80 9a 52 ‚Äì  MOXA Nport device 00 90 e8 3b 89 9c - MAC  MOXA Nport device 75 00 - : 1900 +   (1900 + 117 = 2017) 04 00 - :     1 -     01 00 ‚Äì   0f 00 ‚Äì  (15) 09 00 ‚Äì  (9) 17 00 ‚Äì  (23) 36 00 ‚Äì  (36) 00 00 ‚Äì  </code> </pre> <br>  O tamanho do pacote √© codificado de uma maneira, e todos os valores num√©ricos (ano, m√™s, dia ...) de outra.  A partir disso, podemos concluir que o processamento da parte do usu√°rio a partir de 75 00 04 00 ....... foi escrito por outro programador. <br><br>  Para resumir: Pelo menos 3 pessoas diferentes escreveram o protocolo de troca, 1 escreveu o processamento da parte do usu√°rio dos dados e pelo menos 1 escreveu o manipulador da interface WEB.  De acordo com meus c√°lculos, cerca de 5 programadores trabalharam no projeto. <br>  Quanto voc√™ contou? <br><br>  * Nesse caso, o termo "hindu" significa um funcion√°rio que cumpre suas obriga√ß√µes com alimentos e hipotecas, capaz de codificar daqui e antes do almo√ßo, sem se aprofundar nos planos globais da empresa empregadora. <br><br>  PS Este artigo foi escrito em materiais que estavam em desenvolvimento em 2017, muitos dados cont√™m datas precisamente este ano.  Os protocolos foram examinados dentro da estrutura de um rascunho de trabalho, mas desde que a mente venceu o marketing e o assunto n√£o foi al√©m do est√°gio de um √∫nico prot√≥tipo de trabalho.  Publico todos os desenvolvimentos deste projeto em dom√≠nio p√∫blico, pois acredito que essas informa√ß√µes ser√£o √∫teis para a comunidade de desenvolvedores. <br><br>  PPS Artigo original como sempre no meu <a href="http://multimake.ru/moxa-nport-%25D0%25B2%25D0%25B7%25D0%25B3%25D0%25BB%25D1%258F%25D0%25B4-%25D0%25B8%25D0%25B7%25D0%25BD%25D1%2583%25D1%2582%25D1%2580%25D0%25B8/">blog pessoal</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt478642/">https://habr.com/ru/post/pt478642/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt478630/index.html">Pascal toca Go. Implementa√ß√£o de m√©todos e interfaces em um compilador amador</a></li>
<li><a href="../pt478634/index.html">Armadilhas no Gerenciamento de Projetos de Aprendizado de M√°quina</a></li>
<li><a href="../pt478636/index.html">Como as codifica√ß√µes de texto funcionam. De onde v√™m os "crocodilos". Os princ√≠pios de codifica√ß√£o. Generaliza√ß√£o e an√°lise detalhada</a></li>
<li><a href="../pt478638/index.html">db-tree: pesquise e navegue no banco de dados</a></li>
<li><a href="../pt478640/index.html">Carros aut√¥nomos em c√≥digo aberto</a></li>
<li><a href="../pt478646/index.html">JetQuad: Avi√µes a jato com decolagem e pouso verticais</a></li>
<li><a href="../pt478650/index.html">Dawn 3D</a></li>
<li><a href="../pt478652/index.html">Estrutura de pacotes DNS</a></li>
<li><a href="../pt478654/index.html">Contagem estimada de distribui√ß√£o - na maioria das vezes reinventou a classifica√ß√£o</a></li>
<li><a href="../pt478658/index.html">Como acordar tipo? Novo alarme Dawn Plus Light</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>