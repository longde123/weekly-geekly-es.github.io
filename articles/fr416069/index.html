<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äçüéì ü§• üë©üèæ‚Äçü§ù‚Äçüë®üèø Migration de donn√©es ElasticSearch sans perte üèØ üßîüèø ü§∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La conception acad√©mique de l'entrep√¥t de donn√©es recommande de tout garder sous une forme normalis√©e, avec des connexions entre les deux. Ensuite, l'...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migration de donn√©es ElasticSearch sans perte</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416069/"><p><img src="https://habrastorage.org/webt/1e/oc/om/1eocom45kcqgz65q-wneyoqopdg.jpeg"></p><br><p>  La conception acad√©mique de l'entrep√¥t de donn√©es recommande de tout garder sous une forme normalis√©e, avec des connexions entre les deux.  Ensuite, l'annulation des changements dans les math√©matiques relationnelles fournira un r√©f√©rentiel fiable avec le support des transactions.  Atomicit√©, coh√©rence, isolement, durabilit√© - c'est tout.  En d'autres termes, le r√©f√©rentiel est sp√©cialement con√ßu pour mettre √† jour les donn√©es en toute s√©curit√©.  Mais ce n'est pas du tout optimal pour la recherche, surtout avec un geste large √† travers les tables et les champs.  Besoin d'index, de nombreux index.  Les volumes augmentent, l'enregistrement ralentit.  SQL LIKE n'est pas index√© et JOIN GROUP BY l'envoie au planificateur de requ√™tes pour m√©diter. </p><a name="habracut"></a><br><p>  La charge croissante d'une machine l'oblige √† s'√©tendre, verticalement dans le plafond ou horizontalement, en achetant quelques n≈ìuds suppl√©mentaires.  Les exigences de basculement rendent les donn√©es r√©parties sur plusieurs n≈ìuds.  Et l'exigence d'une r√©cup√©ration imm√©diate apr√®s une panne, sans d√©ni de service, vous oblige √† configurer le cluster de machines afin qu'√† tout moment l'une d'entre elles puisse effectuer √† la fois l'√©criture et la lecture.  Autrement dit, √™tre d√©j√† un ma√Ætre, ou devenir lui automatiquement et imm√©diatement. </p><br><p>  Le probl√®me de la recherche rapide a √©t√© r√©solu en installant un deuxi√®me r√©f√©rentiel optimis√© pour l'indexation √† proximit√©.  Recherche plein texte, √† facettes, avec stemming <del>  et blackjack </del>  .  Le deuxi√®me stockage accepte les entr√©es des tables du premier en entr√©e, analyse et construit l'index.  Ainsi, le cluster de stockage de donn√©es a √©t√© compl√©t√© par un autre cluster pour leur recherche.  Avec une configuration ma√Ætre similaire pour correspondre au <em>SLA</em> global.  Tout va bien, les affaires sont ravies, les administrateurs dorment la nuit ... jusqu'√† ce qu'il y ait plus de trois machines dans le cluster ma√Ætre-ma√Ætre. </p><br><h2 id="elastic">  √âlastique </h2><br><p>  Le mouvement <em>NoSQL</em> a consid√©rablement √©largi l'horizon d'√©chelle pour les petites et les grandes donn√©es.  Les n≈ìuds NoSQL du cluster peuvent distribuer des donn√©es entre eux afin que la d√©faillance d'un ou plusieurs d'entre eux n'entra√Æne pas un d√©ni de service pour l'ensemble du cluster.  Le paiement pour la haute disponibilit√© des donn√©es distribu√©es √©tait l'incapacit√© d'assurer leur coh√©rence compl√®te pour l'enregistrement √† un moment donn√©.  Au lieu de cela, NoSQL parle de <em>coh√©rence √©ventuelle</em> .  Autrement dit, on pense qu'un jour toutes les donn√©es se disperseront vers les n≈ìuds du cluster, et elles deviendront coh√©rentes √† long terme. </p><br><p>  Le mod√®le relationnel a donc √©t√© compl√©t√© par le mod√®le non relationnel et a engendr√© de nombreux moteurs de base de donn√©es qui r√©solvent les probl√®mes du triangle <em>CAP</em> avec un certain succ√®s.  Les d√©veloppeurs ont mis √† disposition des outils √† la mode pour cr√©er leur propre couche de <em>persistance</em> id√©ale - pour tous les go√ªts, budgets et profils de charge. </p><br><p>  ElasticSearch est un repr√©sentant de NoSQL en cluster avec une API JSON RESTful sur le moteur Lucene, open source en Java, capable non seulement de construire un index de recherche, mais aussi de stocker le document original.  Une telle feinte permet de repenser le r√¥le d'un SGBD distinct pour le stockage des originaux, voire de l'abandonner.  La fin de l'introduction. </p><br><h2 id="mapping">  Cartographie </h2><br><p>  Le mappage dans ElasticSearch est quelque chose comme un sch√©ma (structure de table, en termes de SQL) qui vous indique exactement comment indexer les documents entrants (enregistrements, en termes de SQL).  La cartographie peut √™tre statique, dynamique ou absente.  Le mappage statique ne se laisse pas modifier.  Dynamique vous permet d'ajouter de nouveaux champs.  Si le mappage n'est pas sp√©cifi√©, ElasticSearch le fera par lui-m√™me, apr√®s avoir re√ßu le premier document pour l'√©criture.  Il analysera la structure des champs, fera des hypoth√®ses sur les types de donn√©es qu'ils contiennent, ignorera les param√®tres par d√©faut et les notera.  Un tel comportement sans circuit √† premi√®re vue semble tr√®s pratique.  Mais en fait, il est plus adapt√© √† l'exp√©rimentation qu'√† des surprises en production. </p><br><p>  Ainsi, les donn√©es sont index√©es, et il s'agit d'un processus √† sens unique.  Une fois cr√©√©, le mappage ne peut pas √™tre modifi√© dynamiquement comme ALTER TABLE en SQL.  Parce que la table SQL stocke le document d'origine auquel vous pouvez attacher l'index de recherche.  Mais dans ElasticSearch, c'est le contraire.  Il est lui-m√™me l'index de recherche auquel vous pouvez attacher le document original.  C'est pourquoi le sch√©ma d'index est statique.  Th√©oriquement, on pourrait soit cr√©er un champ dans la cartographie, soit le supprimer.  En pratique, ElasticSearch vous permet uniquement d'ajouter des champs.  Une tentative de suppression d'un champ ne m√®ne √† rien. </p><br><h2 id="alias">  Alias </h2><br><p>  Alias ‚Äã‚Äã- Il s'agit d'un nom suppl√©mentaire pour l'index ElasticSearch.  Il peut y avoir plusieurs alias pour un index.  Ou un alias pour plusieurs indices.  Ensuite, les indices sont logiquement combin√©s comme s'ils venaient de l'ext√©rieur et ressemblent √† un.  Alias ‚Äã‚Äãest tr√®s pratique pour les services qui communiquent avec l'index tout au long de sa vie.  Par exemple, les produits d'alias peuvent masquer √† la fois <em>products_v2</em> et <em>products_v25</em> , sans avoir √† modifier les noms dans le service.  L'alias est indispensable pour la migration des donn√©es, lorsqu'elles sont d√©j√† transf√©r√©es de l'ancien sch√©ma vers le nouveau, et que vous devez basculer l'application pour qu'elle fonctionne avec le nouvel index.  La commutation d'un alias d'index en index est une op√©ration atomique.  Autrement dit, il est effectu√© en une seule √©tape sans perte. </p><br><h2 id="reindex-api">  API de r√©indexation </h2><br><p>  La disposition des donn√©es, la cartographie, a tendance √† changer de temps en temps.  De nouveaux champs sont ajout√©s, ceux inutiles sont supprim√©s.  Si ElasticSearch joue le r√¥le du seul r√©f√©rentiel, vous avez besoin d'une sorte d'outil pour modifier le mappage √† la vol√©e.  Pour ce faire, il existe une commande sp√©ciale pour transf√©rer des donn√©es d'un index √† un autre, la soi-disant <em>API _reindex</em> .  Il fonctionne avec un mappage pr√™t √† l'emploi ou vide de l'index du destinataire, c√¥t√© serveur, indexant rapidement par lots de 1000 documents √† la fois. </p><br><p>  La r√©indexation peut effectuer une conversion de type de champ simple.  Par exemple, <em>long</em> en <em>texte</em> et retour en <em>long</em> , ou <em>bool√©en</em> en <em>texte</em> et retour en <em>bool√©en</em> .  Mais <em>-9,99</em> en <em>bool√©en</em> ne sait plus comment, <del>  ce n'est pas PHP pour vous </del>  .  D'un autre c√¥t√©, la conversion de type n'est pas s√ªre.  Un service √©crit dans une langue avec une frappe dynamique peut √™tre pardonn√© pour un tel p√©ch√©.  Mais si la r√©indexation ne peut pas convertir le type, le document ne sera tout simplement pas √©crit.  En g√©n√©ral, la migration des donn√©es doit se d√©rouler en 3 √©tapes: ajouter un nouveau champ, lib√©rer un service avec lui, nettoyer l'ancien. </p><br><p>  Un champ est ajout√© comme ceci.  Le sch√©ma d'index source est pris, une nouvelle propri√©t√© est entr√©e, un index vide est cr√©√©.  Puis la r√©indexation commence: </p><br><pre><code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"test"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"dest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"test_clone"</span></span> } }</code> </pre> <br><p>  Le champ est supprim√© de la m√™me mani√®re.  Le sch√©ma d'index source est pris, le champ est supprim√©, un index vide est cr√©√©.  Ensuite, la r√©indexation d√©marre avec une liste des champs √† copier: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"test"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"_source"</span></span>: [<span class="hljs-string"><span class="hljs-string">"field1"</span></span>, <span class="hljs-string"><span class="hljs-string">"field3"</span></span>] }, <span class="hljs-attr"><span class="hljs-attr">"dest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"test_clone"</span></span> } }</code> </pre> <br><p>  Pour plus de commodit√©, les deux cas sont combin√©s en une fonction de clonage dans Kaizen, un client de bureau pour ElasticSearch.  Le clonage peut s'adapter au mappage de l'index de destination.  L'exemple ci-dessous montre comment cr√©er un clone partiel √† partir d'un index avec trois collections (types, en termes d'ElasticSearch) <em>act</em> , <em>line</em> , <em>scene</em> .  Seule la <em>ligne</em> avec deux champs y reste, le mappage statique est activ√© et le champ <em>speech_number</em> du <em>texte</em> devient <em>long</em> . </p><br><p><img src="https://habrastorage.org/webt/rt/ju/dq/rtjudqsh1s-tevki7azjyxctsuy.gif"></p><br><h2 id="migraciya">  La migration </h2><br><p>  L'API de r√©indexation a une caract√©ristique d√©sagr√©able - elle ne sait pas comment surveiller les changements dans l'index source.  Si quelque chose change l√†-bas apr√®s le d√©but de la r√©indexation, les modifications ne sont pas refl√©t√©es dans l'index des destinataires.  Pour r√©soudre ce probl√®me, ElasticSearch FollowUp Plugin a √©t√© d√©velopp√©, qui ajoute des commandes de journalisation.  Le plugin peut surveiller l'index, renvoyant au format JSON les actions effectu√©es sur les documents dans l'ordre chronologique.  L'index, le type, l'identifiant du document et son fonctionnement - INDEX ou DELETE sont m√©moris√©s.  FollowUp Plugin est publi√© sur GitHub et compil√© pour presque toutes les versions d'ElasticSearch. </p><br><p>  Ainsi, pour la migration de donn√©es sans perte, vous aurez besoin de FollowUp install√© sur le n≈ìud o√π la r√©indexation commencera.  Il est suppos√© que l'index a d√©j√† un alias et que toutes les applications fonctionnent avec lui.  Juste avant de r√©indexer, le plugin est activ√©.  Une fois la r√©indexation termin√©e, le plug-in s'arr√™te et l'alias est bascul√© vers le nouvel index.  Ensuite, les actions enregistr√©es sont reproduites sur l'index du destinataire, rattrapant son √©tat.  Malgr√© la vitesse √©lev√©e de r√©indexation, deux types de collisions peuvent se produire pendant la lecture: </p><br><ul><li>  il n'y a plus de document avec un tel <em>_id</em> dans le nouvel index.  Ils ont r√©ussi √† supprimer le document apr√®s avoir bascul√© l'alias vers le nouvel index. </li><li>  dans le nouvel index, il existe un document avec un tel <em>_id</em> , mais avec un num√©ro de version sup√©rieur √† celui de l'index source.  Ils ont r√©ussi √† mettre √† jour le document apr√®s avoir bascul√© l'alias vers le nouvel index. </li></ul><br><p>  Dans ces cas, l'action ne doit pas √™tre reproduite dans l'index de destination.  D'autres modifications sont reproduites. </p><br><p>  Bon codage! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr416069/">https://habr.com/ru/post/fr416069/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr416055/index.html">Affectation et prise en charge du nom de domaine complet du serveur 3QX</a></li>
<li><a href="../fr416059/index.html">Mobio s'entretient avec Daniil Shuleiko (Yandex.Taxi) sur la fusion avec Uber, le march√© des taxis et la concurrence</a></li>
<li><a href="../fr416061/index.html">Tant bien que mal, je vois tout</a></li>
<li><a href="../fr416063/index.html">Les n√©gociations des Russes n'ont nulle part o√π enregistrer</a></li>
<li><a href="../fr416067/index.html">Pr√©sentation de la vuln√©rabilit√© de Mikrotik Winbox. Ou un gros fichier</a></li>
<li><a href="../fr416071/index.html">R√©seaux de neurones, principes fondamentaux de fonctionnement, diversit√© et topologie</a></li>
<li><a href="../fr416073/index.html">Un robot de trading de crypto-monnaie simple</a></li>
<li><a href="../fr416075/index.html">Le FSB veut introduire la responsabilit√© de l'utilisation cach√©e des enregistreurs vocaux et des cam√©ras dans les smartphones [et pas seulement]</a></li>
<li><a href="../fr416077/index.html">PlantUML - Tout ce dont les analystes commerciaux ont besoin pour cr√©er des graphiques dans la documentation du logiciel</a></li>
<li><a href="../fr416079/index.html">Corona Native pour Android - utilisation de code Java personnalis√© dans un jeu √©crit en Corona</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>