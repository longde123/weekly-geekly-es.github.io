<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏩 🙋🏾 👨🏾‍🎨 使用Consul配置Nomad集群并与Gitlab集成 👩🏻‍🎤 👨🏿‍🌾 👨🏻‍💼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="引言 

 最近，Kubernetes的普及迅速增长-越来越多的项目正在国内实施它。 我想谈谈像Nomad这样的协调器：它非常适合已经使用HashiCorp的其他解决方案的项目，例如Vault和Consul，并且项目本身在基础架构方面并不复杂。 本文将提供有关安装Nomad，将两个节点组合到群集中以...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>使用Consul配置Nomad集群并与Gitlab集成</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453322/"><h2> 引言 </h2><br><br> 最近，Kubernetes的普及迅速增长-越来越多的项目正在国内实施它。 我想谈谈像Nomad这样的协调器：它非常适合已经使用HashiCorp的其他解决方案的项目，例如Vault和Consul，并且项目本身在基础架构方面并不复杂。 本文将提供有关安装Nomad，将两个节点组合到群集中以及将Nomad与Gitlab集成的说明。 <br><br><img src="https://habrastorage.org/webt/bu/yn/4v/buyn4vqshurhgc9kavloja-fzsm.png"><br><br><a name="habracut"></a><br><br><h2> 试验台 </h2><br><br> 关于测试平台的一点点：使用了三个虚拟服务器，它们具有2个CPU，4个RAM，50 Gb SSD的特征，并结合在一个通用的本地网络中。 它们的名称和IP地址： <br><br><ol><li>  <b>nomad-livelinux-01</b> ：172.30.0.5 </li><li>  <b>nomad-livelinux-02</b> ：172.30.0.10 </li><li>  <b>consul-livelinux-01</b> ：172.30.0.15 </li></ol><br><br><h2> 游牧民的安装，领事。 创建游牧集群 </h2><br><br> 让我们继续基本安装。 尽管安装很容易，但为了保证文章的完整性，我将对其进行描述：实际上，它是根据草稿和注释创建的，以便在必要时进行快速访问。 <br><br> 在开始练习之前，我们将讨论理论部分，因为在此阶段，了解未来的结构很重要。 <br><br> 我们有两个Nomad节点，我们希望将它们组合成一个集群，并且在将来，我们将需要自动缩放集群-为此，我们需要Consul。 使用此工具，群集和添加新节点变得非常简单：创建的Nomad节点连接到Consul代理，然后连接到现有的Nomad群集。 因此，一开始我们将安装Consul服务器，为Web面板配置基本的http授权（默认情况下未经授权即可访问，并且可以通过外部地址访问），以及在Nomad服务器上的Consul代理本身，之后我们就可以启动Nomad。 <br><br> 安装HashiCorp工具非常简单：实际上，我们只需将二进制文件移至bin目录，配置工具的配置文件并创建其服务文件。 <br><br> 下载Consul二进制文件并将其解压缩到用户的主目录中： <br><br><pre><code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># wget https://releases.hashicorp.com/consul/1.5.0/consul_1.5.0_linux_amd64.zip root@consul-livelinux-01:~# unzip consul_1.5.0_linux_amd64.zip root@consul-livelinux-01:~# mv consul /usr/local/bin/</span></span></code> </pre> <br><br> 现在我们有一个现成的二进制领事文件，用于进一步的配置。 <br><br> 要使用Consul，我们需要使用keygen命令创建一个唯一密钥： <br><br><pre> <code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># consul keygen</span></span></code> </pre><br><br> 让我们继续配置Consul，使用以下结构创建/etc/consul.d/目录： <br><br><pre> <code class="bash hljs">/etc/consul.d/ ├── bootstrap │ └── config.json</code> </pre> <br><br>  bootstrap目录将包含config.json配置文件-在其中，我们将设置Consul设置。 其内容： <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"bootstrap"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"server"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"datacenter"</span></span>: <span class="hljs-string"><span class="hljs-string">"dc1"</span></span>, <span class="hljs-string"><span class="hljs-string">"data_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"/var/consul"</span></span>, <span class="hljs-string"><span class="hljs-string">"encrypt"</span></span>: <span class="hljs-string"><span class="hljs-string">"your-key"</span></span>, <span class="hljs-string"><span class="hljs-string">"log_level"</span></span>: <span class="hljs-string"><span class="hljs-string">"INFO"</span></span>, <span class="hljs-string"><span class="hljs-string">"enable_syslog"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"start_join"</span></span>: [<span class="hljs-string"><span class="hljs-string">"172.30.0.15"</span></span>] }</code> </pre> <br><br> 让我们分别检查主要指令及其含义： <br><br><ul><li>  <b>bootstrap</b> ：是的。 如果新节点已连接，我们将打开它们的自动添加功能。 我注意到我们在这里没有指出预期节点的确切数目。 </li><li>  <b>服务器</b> ：是的。 打开服务器模式。 目前，此虚拟机上的Consul将是唯一的服务器和主服务器，VM Nomad将是客户端。 </li><li>  <b>数据中心</b> ：dc1。 指定数据中心的名称以创建集群。 在客户端和服务器上，它必须相同。 </li><li>  <b>加密</b> ：您的密钥。 密钥也必须唯一，并且在所有客户端和服务器上都必须匹配。 使用consul keygen命令生成。 </li><li>  <b>start_join</b> 。 在此列表中，我们指示将建立连接的IP地址列表。 目前，我们只留下我们自己的地址。 </li></ul><br><br> 在这一点上，我们可以使用命令行启动领事： <br><br><pre> <code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># /usr/local/bin/consul agent -config-dir /etc/consul.d/bootstrap -ui</span></span></code> </pre> <br><br> 这是现在进行调试的好方法，但是，由于显而易见的原因，使用该方法将一直无法使用。 创建用于通过systemd管理Consul的服务文件： <br><br><pre> <code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># nano /etc/systemd/system/consul.service</span></span></code> </pre><br><br>  consul.service文件的内容： <br><br><pre> <code class="bash hljs">[Unit] Description=Consul Startup process After=network.target [Service] Type=simple ExecStart=/bin/bash -c <span class="hljs-string"><span class="hljs-string">'/usr/local/bin/consul agent -config-dir /etc/consul.d/bootstrap -ui'</span></span> TimeoutStartSec=0 [Install] WantedBy=default.target</code> </pre> <br><br> 通过systemctl运行Consul： <br><br><pre> <code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># systemctl start consul</span></span></code> </pre><br><br> 我们检查：应该启动我们的服务，并且通过执行consul Members命令，我们应该看到我们的服务器： <br><br><pre> <code class="bash hljs">root@consul-livelinux:/etc/consul.d<span class="hljs-comment"><span class="hljs-comment"># consul members consul-livelinux 172.30.0.15:8301 alive server 1.5.0 2 dc1 &lt;all&gt;</span></span></code> </pre> <br><br> 下一步：安装Nginx并设置代理，http授权。 通过程序包管理器安装nginx并在/ etc / nginx / sites-enabled目录中创建配置文件consul.conf，其内容如下： <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> consul-auth { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> localhost:<span class="hljs-number"><span class="hljs-number">8500</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> consul.doman.name; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://consul-auth; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">auth_basic_user_file</span></span> /etc/nginx/.htpasswd; <span class="hljs-attribute"><span class="hljs-attribute">auth_basic</span></span> <span class="hljs-string"><span class="hljs-string">"Password-protected Area"</span></span>; } }</code> </pre> <br><br> 不要忘记创建.htpasswd文件并为其生成用户名和密码。 此项是必填项，因此认识我们域的每个人都无法访问Web面板。 但是，在配置Gitlab时，我们将不得不放弃这一点-否则我们将无法将应用程序部署到Nomad。 在我的项目中，Gitlab和Nomad都仅位于灰色网络上，因此没有此类问题。 <br><br> 在其他两台服务器上，根据以下说明安装Consul代理。 对二进制文件重复上述步骤： <br><br><pre> <code class="bash hljs">root@nomad-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># wget https://releases.hashicorp.com/consul/1.5.0/consul_1.5.0_linux_amd64.zip root@nomad-livelinux-01:~# unzip consul_1.5.0_linux_amd64.zip root@nomad-livelinux-01:~# mv consul /usr/local/bin/</span></span></code> </pre> <br><br> 与先前的服务器类似，我们使用以下结构为配置文件/etc/consul.d创建目录： <br><br><pre> <code class="bash hljs">/etc/consul.d/ ├── client │ └── config.json</code> </pre> <br><br>  config.json文件的内容： <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"datacenter"</span></span>: <span class="hljs-string"><span class="hljs-string">"dc1"</span></span>, <span class="hljs-string"><span class="hljs-string">"data_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/consul"</span></span>, <span class="hljs-string"><span class="hljs-string">"log_level"</span></span>: <span class="hljs-string"><span class="hljs-string">"DEBUG"</span></span>, <span class="hljs-string"><span class="hljs-string">"node_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"nomad-livelinux-01"</span></span>, <span class="hljs-string"><span class="hljs-string">"server"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"encrypt"</span></span>: <span class="hljs-string"><span class="hljs-string">"your-private-key"</span></span>, <span class="hljs-string"><span class="hljs-string">"domain"</span></span>: <span class="hljs-string"><span class="hljs-string">"livelinux"</span></span>, <span class="hljs-string"><span class="hljs-string">"addresses"</span></span>: { <span class="hljs-string"><span class="hljs-string">"dns"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"https"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"grpc"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"http"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span> }, <span class="hljs-string"><span class="hljs-string">"bind_addr"</span></span>: <span class="hljs-string"><span class="hljs-string">"172.30.0.5"</span></span>, #    <span class="hljs-string"><span class="hljs-string">"start_join"</span></span>: [<span class="hljs-string"><span class="hljs-string">"172.30.0.15"</span></span>], #     <span class="hljs-string"><span class="hljs-string">"ports"</span></span>: { <span class="hljs-string"><span class="hljs-string">"dns"</span></span>: <span class="hljs-number"><span class="hljs-number">53</span></span> } }</code> </pre><br><br> 我们保存更改并继续配置服务文件，其内容如下： <br><br>  /etc/systemd/system/consul.service： <br><br><pre> <code class="bash hljs">[Unit] Description=<span class="hljs-string"><span class="hljs-string">"HashiCorp Consul - A service mesh solution"</span></span> Documentation=https://www.consul.io/ Requires=network-online.target After=network-online.target [Service] User=root Group=root ExecStart=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/consul agent -config-dir=/etc/consul.d/client ExecReload=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/consul reload KillMode=process Restart=on-failure [Install] WantedBy=multi-user.target</code> </pre> <br><br> 我们在服务器上启动领事。 现在，在启动之后，我们应该在nsul成员中看到已配置的服务。 这将意味着他以客户端身份成功连接到集群。 在第二台服务器上重复同样的操作，然后我们将能够开始安装和配置Nomad。 <br><br>  Nomad的正式文档中有更详细的安装说明。 传统的安装方法有两种：下载二进制文件和从源代码进行编译。 我将选择第一种方法。 <br><br>  <b>注意</b> ：项目发展非常快，经常会出现新的更新。 也许到本文完成时，将发布一个新版本。 因此，我建议阅读之前先检查Nomad的当前版本并下载。 <br><br><pre> <code class="bash hljs">root@nomad-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># wget https://releases.hashicorp.com/nomad/0.9.1/nomad_0.9.1_linux_amd64.zip root@nomad-livelinux-01:~# unzip nomad_0.9.1_linux_amd64.zip root@nomad-livelinux-01:~# mv nomad /usr/local/bin/ root@nomad-livelinux-01:~# nomad -autocomplete-install root@nomad-livelinux-01:~# complete -C /usr/local/bin/nomad nomad root@nomad-livelinux-01:~# mkdir /etc/nomad.d</span></span></code> </pre> <br><br> 解压缩后，我们将得到一个Nomad'a二进制文件，其大小为65 MB-必须将其移动到/ usr / local / bin。 <br><br> 为Nomad创建数据目录并编辑其服务文件（很可能在一开始就不存在）： <br><br><pre> <code class="bash hljs">root@nomad-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># mkdir --parents /opt/nomad root@nomad-livelinux-01:~# nano /etc/systemd/system/nomad.service</span></span></code> </pre> <br><br> 在其中插入以下行： <br><br><pre> <code class="bash hljs">[Unit] Description=Nomad Documentation=https://nomadproject.io/docs/ Wants=network-online.target After=network-online.target [Service] ExecReload=/bin/<span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -HUP <span class="hljs-variable"><span class="hljs-variable">$MAINPID</span></span> ExecStart=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/nomad agent -config /etc/nomad.d KillMode=process KillSignal=SIGINT LimitNOFILE=infinity LimitNPROC=infinity Restart=on-failure RestartSec=2 StartLimitBurst=3 StartLimitIntervalSec=10 TasksMax=infinity [Install] WantedBy=multi-user.target</code> </pre> <br><br> 但是，我们不急于运行nomad-我们尚未创建其配置文件： <br><br><pre> <code class="bash hljs">root@nomad-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># mkdir --parents /etc/nomad.d root@nomad-livelinux-01:~# chmod 700 /etc/nomad.d root@nomad-livelinux-01:~# nano /etc/nomad.d/nomad.hcl root@nomad-livelinux-01:~# nano /etc/nomad.d/server.hcl</span></span></code> </pre><br><br> 最终目录结构如下： <br><br><pre> <code class="bash hljs">/etc/nomad.d/ ├── nomad.hcl └── server.hcl</code> </pre> <br><br>  nomad.hcl文件应包含以下配置： <br><br><pre> <code class="bash hljs">datacenter = <span class="hljs-string"><span class="hljs-string">"dc1"</span></span> data_dir = <span class="hljs-string"><span class="hljs-string">"/opt/nomad"</span></span></code> </pre> <br><br>  server.hcl文件的内容： <br><br><pre> <code class="bash hljs">server { enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> bootstrap_expect = 1 } consul { address = <span class="hljs-string"><span class="hljs-string">"127.0.0.1:8500"</span></span> server_service_name = <span class="hljs-string"><span class="hljs-string">"nomad"</span></span> client_service_name = <span class="hljs-string"><span class="hljs-string">"nomad-client"</span></span> auto_advertise = <span class="hljs-literal"><span class="hljs-literal">true</span></span> server_auto_join = <span class="hljs-literal"><span class="hljs-literal">true</span></span> client_auto_join = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } bind_addr = <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span> advertise { http = <span class="hljs-string"><span class="hljs-string">"172.30.0.5"</span></span> } client { enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }</code> </pre> <br><br> 不要忘记在第二台服务器上更改配置文件-在那您将需要更改http指令的值。 <br><br> 此阶段的最后一个是Nginx的配置，用于代理和设置http授权。  nomad.conf文件的内容： <br><br><pre> <code class="bash hljs">upstream nomad-auth { server 172.30.0.5:4646; } server { server_name nomad.domain.name; location / { proxy_pass http://nomad-auth; proxy_set_header Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; auth_basic_user_file /etc/nginx/.htpasswd; auth_basic <span class="hljs-string"><span class="hljs-string">"Password-protected Area"</span></span>; } }</code> </pre> <br><br> 现在，我们可以通过外部网络访问Web面板。 我们连接并转到服务器页面： <br><br><img src="https://habrastorage.org/webt/en/uq/ck/enuqck8krqstsbt8b6uwbytoy0e.png"><br>  <b>图1.</b> Nomad群集中的服务器列表 <br><br> 两台服务器均成功显示在面板中，这与nomad node status命令的输出相同： <br><br><img src="https://habrastorage.org/webt/c1/gv/82/c1gv82tjvwtw0onqxqv3huchv1w.png"><br>  <b>图2.</b> nomad node status命令的输出 <br><br> 那领事呢？ 让我们看看。 转到领事控制面板，到节点页面： <br><img src="https://habrastorage.org/webt/m5/6w/tj/m56wtjjgkos9ed5e_jy9lidmutg.png"><br>  <b>图3.</b> Consul集群中的节点列表 <br><br> 现在，我们准备了与领事一起工作的Nomad。 在最后阶段，我们将开始最有趣的部分：我们将配置Docker容器从Gitlab到Nomad的交付，并讨论其其他一些独特功能。 <br><br><h2> 创建Gitlab Runner <br></h2><br><br> 为了将Docker映像部署到Nomad，我们将使用内部带有Nomad二进制文件的单独运行程序（在此，顺便说一下，Hashicorp应用程序的另一个功能-分别是唯一的二进制文件）。 将其下载到运行程序目录。 对他来说，创建具有以下内容的最简单的Dockerfile： <br><br><pre> <code class="bash hljs">FROM alpine:3.9 RUN apk add --update --no-cache libc6-compat gettext COPY nomad /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/nomad</code> </pre><br><br> 在同一项目中，创建.gitlab-ci.yml： <br><br><pre> <code class="bash hljs">variables: DOCKER_IMAGE: nomad/nomad-deploy DOCKER_REGISTRY: registry.domain.name stages: - build build: stage: build image: <span class="hljs-variable"><span class="hljs-variable">${DOCKER_REGISTRY}</span></span>/nomad/alpine:3 script: - tag=<span class="hljs-variable"><span class="hljs-variable">${DOCKER_REGISTRY}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${DOCKER_IMAGE}</span></span>:latest - docker build --pull -t <span class="hljs-variable"><span class="hljs-variable">${tag}</span></span> -f Dockerfile . - docker push <span class="hljs-variable"><span class="hljs-variable">${tag}</span></span></code> </pre> <br><br> 结果，我们将在Gitlab注册表中获得Nomad运行器的可访问图像，现在我们可以直接转到项目存储库，创建管道并配置Nomad作业Nomad。 <br><br><h2> 项目设置 <br></h2><br><br> 让我们从Nomad的工作文件开始。 我在本文中的项目将非常原始：它将包含一项任务。  .gitlab-ci的内容如下： <br><br><pre> <code class="bash hljs">variables: NOMAD_ADDR: http://nomad.address.service:4646 DOCKER_REGISTRY: registry.domain.name DOCKER_IMAGE: example/project stages: - build - deploy build: stage: build image: <span class="hljs-variable"><span class="hljs-variable">${DOCKER_REGISTRY}</span></span>/nomad-runner/alpine:3 script: - tag=<span class="hljs-variable"><span class="hljs-variable">${DOCKER_REGISTRY}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${DOCKER_IMAGE}</span></span>:<span class="hljs-variable"><span class="hljs-variable">${CI_COMMIT_SHORT_SHA}</span></span> - docker build --pull -t <span class="hljs-variable"><span class="hljs-variable">${tag}</span></span> -f Dockerfile . - docker push <span class="hljs-variable"><span class="hljs-variable">${tag}</span></span> deploy: stage: deploy image: registry.example.com/nomad/nomad-runner:latest script: - envsubst <span class="hljs-string"><span class="hljs-string">'${CI_COMMIT_SHORT_SHA}'</span></span> &lt; project.nomad &gt; job.nomad - cat job.nomad - nomad validate job.nomad - nomad plan job.nomad || <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ $? -eq 255 ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 255; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"success"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> - nomad run job.nomad environment: name: production allow_failure: <span class="hljs-literal"><span class="hljs-literal">false</span></span> when: manual</code> </pre> <br><br> 此处，部署以手动模式进行，但是您可以对其进行配置以更改项目目录的内容。 管道包括两个阶段：从图像的组装，部署到游牧。 在第一阶段，我们收集docker映像并将其推送到注册表中；在第二阶段，我们在Nomad中启动工作。 <br><br><pre> <code class="bash hljs">job <span class="hljs-string"><span class="hljs-string">"monitoring-status"</span></span> { datacenters = [<span class="hljs-string"><span class="hljs-string">"dc1"</span></span>] migrate { max_parallel = 3 health_check = <span class="hljs-string"><span class="hljs-string">"checks"</span></span> min_healthy_time = <span class="hljs-string"><span class="hljs-string">"15s"</span></span> healthy_deadline = <span class="hljs-string"><span class="hljs-string">"5m"</span></span> } group <span class="hljs-string"><span class="hljs-string">"zhadan.ltd"</span></span> { count = 1 update { max_parallel = 1 min_healthy_time = <span class="hljs-string"><span class="hljs-string">"30s"</span></span> healthy_deadline = <span class="hljs-string"><span class="hljs-string">"5m"</span></span> progress_deadline = <span class="hljs-string"><span class="hljs-string">"10m"</span></span> auto_revert = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } task <span class="hljs-string"><span class="hljs-string">"service-monitoring"</span></span> { driver = <span class="hljs-string"><span class="hljs-string">"docker"</span></span> config { image = <span class="hljs-string"><span class="hljs-string">"registry.domain.name/example/project:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CI_COMMIT_SHORT_SHA}</span></span></span><span class="hljs-string">"</span></span> force_pull = <span class="hljs-literal"><span class="hljs-literal">true</span></span> auth { username = <span class="hljs-string"><span class="hljs-string">"gitlab_user"</span></span> password = <span class="hljs-string"><span class="hljs-string">"gitlab_password"</span></span> } port_map { http = 8000 } } resources { network { port <span class="hljs-string"><span class="hljs-string">"http"</span></span> {} } } } } }</code> </pre> <br><br> 请注意，我有一个私有注册表，要成功使用docker镜像池，我需要登录。 在这种情况下，最好的解决方案是在Vault中输入登录名和密码，然后再与Nomad集成。  Nomad本机支持Vault。 但是首先，在Vault本身中，我们将为Nomad安装必要的策略，您可以下载它们： <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Download the policy and token role $ curl https://nomadproject.io/data/vault/nomad-server-policy.hcl -O -s -L $ curl https://nomadproject.io/data/vault/nomad-cluster-role.json -O -s -L # Write the policy to Vault $ vault policy write nomad-server nomad-server-policy.hcl # Create the token role with Vault $ vault write /auth/token/roles/nomad-cluster @nomad-cluster-role.json</span></span></code> </pre> <br><br> 现在，已经创建了必要的策略，我们将在job.nomad文件的任务块中添加与Vault的集成： <br><br><pre> <code class="bash hljs">vault { enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> address = <span class="hljs-string"><span class="hljs-string">"https://vault.domain.name:8200"</span></span> token = <span class="hljs-string"><span class="hljs-string">"token"</span></span> }</code> </pre> <br><br> 我使用令牌授权，并将其直接写入此处，在运行漫游代理程序时，还可以选择将令牌指定为变量： <br><br><pre> <code class="bash hljs">$ VAULT_TOKEN=&lt;token&gt; nomad agent -config /path/to/config</code> </pre><br><br> 现在我们可以在Vault中使用密钥了。 操作原理很简单：我们在Nomad作业中创建一个文件，该文件将存储变量的值，例如： <br><br><pre> <code class="bash hljs">template { data = &lt;&lt;EOH {{with secret <span class="hljs-string"><span class="hljs-string">"secrets/pipeline-keys"</span></span>}} REGISTRY_LOGIN=<span class="hljs-string"><span class="hljs-string">"{{ .Data.REGISTRY_LOGIN }}"</span></span> REGISTRY_PASSWORD=<span class="hljs-string"><span class="hljs-string">"{{ .Data.REGISTRY_LOGIN }}{{ end }}"</span></span> EOH destination = <span class="hljs-string"><span class="hljs-string">"secrets/service-name.env"</span></span> env = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }</code> </pre> <br><br> 通过这种简单的方法，您可以配置将容器交付到Nomad群集并在将来使用它。 我要说的是，我在某种程度上对Nomad表示同情-它更适合于Kubernetes可能会带来更多困难并且最终无法发挥潜力的小型项目。 此外，Nomad非常适合初学者-易于安装和配置。 但是，在某些项目上进行测试时，我遇到了其较早版本的问题-许多基本功能根本不存在或它们无法正常工作。 尽管如此，我相信Nomad将继续发展，将来将拥有所有必要的功能。 <br><br>  <i>由Ilya Andreev发表，由Alexei Zhadan和Live Linux Team编辑</i> <i><br></i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN453322/">https://habr.com/ru/post/zh-CN453322/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN453310/index.html">使用RxJS库在React组件之间交换数据</a></li>
<li><a href="../zh-CN453312/index.html">基于XML数据的PDF商业电子邮件生成器</a></li>
<li><a href="../zh-CN453314/index.html">DIY Black Mirror-根据聊天记录教机器人</a></li>
<li><a href="../zh-CN453316/index.html">英国芯片制造商ARM停止与华为合作</a></li>
<li><a href="../zh-CN453318/index.html">移动应用程序的推送通知实施中的5个错误</a></li>
<li><a href="../zh-CN453324/index.html">二极管作为整流器</a></li>
<li><a href="../zh-CN453326/index.html">如何自动化IT基础架构管理-讨论三个趋势</a></li>
<li><a href="../zh-CN453328/index.html">在远程站点上十年</a></li>
<li><a href="../zh-CN453330/index.html">如果RAM崩溃该怎么办。 回忆和治疗方法</a></li>
<li><a href="../zh-CN453332/index.html">关于节省硬盘空间的奇怪方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>