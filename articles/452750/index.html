<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍎 🎷 🔯 Nextcloud dentro y fuera de OpenLiteSpeed: configurar proxy inverso 🚶🏾 👩🏾‍🤝‍👨🏼 🍒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¿Cómo configurar OpenLiteSpeed ​​para invertir el proxy en Nextcloud, ubicado en la red interna? 


 Sorprendentemente, ¡una búsqueda en Habré de Open...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nextcloud dentro y fuera de OpenLiteSpeed: configurar proxy inverso</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452750/"><h3>  ¿Cómo configurar OpenLiteSpeed ​​para invertir el proxy en Nextcloud, ubicado en la red interna? </h3><br><p>  Sorprendentemente, ¡una búsqueda en Habré de OpenLiteSpeed ​​no produce nada!  Me apresuro a corregir esta injusticia, porque LSWS es un servidor web digno.  Lo amo por la velocidad y la moderna interfaz de administración web: </p><br><p><img src="https://habrastorage.org/webt/ex/pr/ai/expraidfnnddzqcw-222w5tbbto.png" alt="imagen"></p><br><p>  A pesar de que OpenLiteSpeed ​​es más famoso como un "acelerador" de WordPress, en el artículo de hoy mostraré su aplicación bastante específica.  Es decir, solicitudes de proxy inverso (proxy inverso).  ¿Dices que es más común usar nginx para esto?  Estoy de acuerdo  ¡Pero realmente nos dolió amar LSWS! </p><br><p>  Proxy está bien, pero ¿dónde?  Un servicio igualmente maravilloso es Nextcloud.  Utilizamos Nextcloud para crear "nubes privadas para compartir archivos".  Para cada cliente, asignamos una VM separada con Nextcloud, y no queremos exponerlos "fuera".  En cambio, enviamos solicitudes a través de un proxy inverso común.  Esta solución le permite: </p><br><ol><li>  eliminar el servidor en el que se almacenan los datos del cliente de Internet y </li><li>  guardar direcciones ip </li></ol><br><p>  El esquema se ve así: </p><br><p><img src="https://habrastorage.org/webt/pt/iw/dk/ptiwdkww_5xiebu_7rzjk1q_nn4.png" alt="imagen"></p><br><p>  Está claro que el esquema está simplificado, porque  Organizar una infraestructura de servicios web no es el tema del artículo de hoy. </p><br><p>  También en este artículo omitiré la instalación y la configuración básica de no clauda, ​​especialmente porque hay materiales sobre este tema en Habré.  Pero definitivamente mostraré la configuración, sin la cual Nextcloud no funcionará para el proxy. </p><a name="habracut"></a><br><p>  Dado: Nextcloud está instalado en el host 1 y configurado para funcionar a través de http (sin SSL), solo tiene una interfaz de red local y una dirección IP "gris" 172.16.22.110. </p><br><p>  Configuraremos OpenLiteSpeed ​​en el host 2. Tiene dos interfaces, una externa (se ve en Internet) y una interna con una dirección IP en la red 172.16.22.0/24 </p><br><p>  El nombre DNS cloud.connect.link conduce a la dirección IP de la interfaz externa del host 2 </p><br><p>  Tarea: llegar desde Internet a través del enlace ' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://cloud.connect.link</a> ' (SSL) a Nextcloud en la red interna. </p><br><ul><li>  Instale OpenLiteSpeed ​​en Ubuntu 18.04.2. </li></ul><br><p>  Añadir un repositorio: </p><br><blockquote>  wget -O - <a href="">http://rpms.litespeedtech.com/debian/enable_lst_debain_repo.sh</a> | sudo bash <br>  sudo apt-get update </blockquote><p>  establecer, ejecutar: </p><br><blockquote>  sudo apt-get install openlitespeed <br>  sudo / usr / local / lsws / bin / lswsctrl start </blockquote><br><ul><li>  Minimiza el cortafuegos. <br><blockquote>  sudo ufw permitir ssh <br>  sudo ufw predeterminado permitir saliente <br>  sudo ufw predeterminado denegar entrante <br>  sudo ufw permitir http <br>  sudo ufw permite https <br>  sudo ufw permite desde <em>su host de administración</em> a cualquier puerto 7080 <br>  sudo ufw enable <br></blockquote></li><li>  Configure OpenLiteSpeed ​​como proxy inverso. <br>  Crear directorios para virtualhost. <br><blockquote>  cd / usr / local / lsws / <br>  sudo mkdirc cloud.connect.link <br>  cd cloud.connect.link/ <br>  sudo mkdir {conf, html, logs} <br>  sudo chown lsadm: lsadm ./conf/ <br></blockquote></li></ul><br><p>  Configure el virtualhost desde la interfaz web LSWS. <br>  Gestión de URL abierta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://cloud.connect.link:7080</a> <br>  Nombre de usuario / contraseña predeterminados: admin / 123456 </p><br><p><img src="https://habrastorage.org/webt/cw/1w/he/cw1whegtkiqtmeolcucdy5poqci.png" alt="imagen"></p><br><p>  Agregue un host virtual (Hosts virtuales&gt; Agregar). </p><br><p>  Al agregar, aparecerá un mensaje de error: no hay archivo de configuración.  Esto es normal, se soluciona haciendo clic en Crear. </p><br><p><img src="https://habrastorage.org/webt/yo/_0/-p/yo_0-p7xc0c80x4bdaswadf1fpg.png" alt="imagen"></p><br><p>  En la pestaña General, especifique Document Root (aunque no es necesario, la configuración no despegará sin él).  El nombre de dominio, si no se especifica, se tomará del nombre de host virtual, al que le pusimos el nombre de nuestro dominio. </p><br><p><img src="https://habrastorage.org/webt/eo/7j/m_/eo7jm_yuk5x5plv6cimesnxxbso.png" alt="imagen"></p><br><p>  Ahora es el momento de recordar que no solo tenemos un servidor web, sino un proxy inverso.  La siguiente configuración le dirá a LSWS qué proxy y dónde.  En la configuración del host virtual, abra la pestaña Aplicación externa y agregue una nueva aplicación, como un servidor web: </p><br><p><img src="https://habrastorage.org/webt/ls/_k/9q/ls_k9qnq-b83jduewm-euwucaku.png" alt="imagen"></p><br><p>  Indique el nombre y la dirección.  El nombre puede especificarse arbitrariamente, pero debe recordarse, lo que es útil en los próximos pasos.  La dirección es donde Nextcloud vive en la red interna: </p><br><p><img src="https://habrastorage.org/webt/lc/aj/ah/lcajahhbytgrbchjugfl5nz0hoq.png" alt="imagen"></p><br><p>  En la misma configuración del host virtual, abra la pestaña Contexto y cree un nuevo contexto del tipo Proxy: </p><br><p><img src="https://habrastorage.org/webt/mj/mq/yg/mjmqyg_hy4gsxza_dcjb-sc1ldu.png" alt="imagen"></p><br><p>  Especifique los parámetros: URI = /, servidor web = nextcloud_1 (nombre del paso anterior) </p><br><p><img src="https://habrastorage.org/webt/km/e_/x9/kme_x90yobopk29vt86fymdc7uu.png" alt="imagen"></p><br><p>  Reinicie LSWS.  Esto se hace con un clic desde la interfaz web, ¡milagros!  (El portador del ratón hereditario habla en mí) </p><br><p><img src="https://habrastorage.org/webt/qw/vr/bl/qwvrblflsbimg6ya16ay29m_pus.png" alt="imagen"></p><br><p><img src="https://habrastorage.org/webt/1f/z_/p5/1fz_p5uigm1ef5sdx3vrvptniic.png" alt="imagen"></p><br><ul><li>  Ponemos el certificado, configuramos https. <br>  Omitiremos el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">procedimiento para obtener un certificado</a> , aceptaremos que ya lo tenemos y mentiremos con la clave en el directorio /etc/letsencrypt/live/cloud.connect.link. </li></ul><br><p>  Cree un "oyente" (Oyentes&gt; Agregar), llámelo "https".  Lo señalamos al puerto 443 y observamos que será seguro: </p><br><p><img src="https://habrastorage.org/webt/ou/1q/mf/ou1qmfazgmggv1wwo1alxxtpxl8.png" alt="imagen"></p><br><p>  En la pestaña SSL, especifique la ruta a la clave y al certificado: </p><br><p><img src="https://habrastorage.org/webt/tr/xg/c0/trxgc0tcpnnca9f53yvvpk2_5hq.png" alt="imagen"></p><br><p>  Se ha creado un "oyente", ahora en la sección Asignaciones de host virtual le agregamos nuestro host virtual: </p><br><p><img src="https://habrastorage.org/webt/-0/y9/2b/-0y92bbvfhdefzynyjuoipouwea.png" alt="imagen"></p><br><p>  Si LSWS se conecta a un solo servicio, la configuración puede completarse.  Pero planeamos usarlo para transferir solicitudes a diferentes "autoridades" dependiendo del nombre de dominio.  Y todos los dominios tendrán sus propios certificados.  Por lo tanto, debe ir a la configuración de virtualhost y nuevamente especificar su clave y certificado en la pestaña SSL.  En el futuro, esto debe hacerse para cada nuevo host virtual. </p><br><p><img src="https://habrastorage.org/webt/us/ap/7z/usap7zccpjkyyko7llyawrkkz7g.png" alt="imagen"></p><br><p>  Queda por configurar la reescritura de URL para que las solicitudes http se dirijan a https. </p><br><p>  <i>(Por cierto, ¿cuándo terminará esto? Es hora de que los navegadores y otro software accedan a https de forma predeterminada y no realicen reenvío SSL manualmente si es necesario).</i> <br>  Habilite Habilitar reescribir y escribir Reglas de reescritura: </p><br><blockquote>  RewriteCond% {SERVER_PORT} 80 <br>  RewriteRule ^ (. *) $ <a href="">Https: //% {SERVER_NAME}% {REQUEST_URI</a> } [R = 301, L] </blockquote><p><img src="https://habrastorage.org/webt/ki/rn/xq/kirnxqm_dendpov7gniojwnsk7q.png" alt="imagen"></p><br><p>  Es imposible aplicar las reglas de reescritura con el reinicio agraciado habitual debido a un extraño malentendido.  Por lo tanto, reiniciar LSWS no es elegante, sino grosero y eficiente: </p><br><blockquote>  sudo systemctl restart lsws.service </blockquote><p>  Para que el servidor escuche el puerto 80, cree otro oyente.  Llamémoslo http, especifique el puerto 80 y que no será seguro: </p><br><p><img src="https://habrastorage.org/webt/k3/za/ji/k3zajihurrtkg4ddc8eabk_njuq.png" alt="imagen"></p><br><p>  Por analogía con la configuración de escucha https, conectemos nuestro host virtual. </p><br><p>  Ahora LSWS escuchará el puerto 80 y enviará solicitudes desde él al 443, reescribiendo la url. <br>  En conclusión, recomiendo reducir el nivel de registro de LSWS, que se establece como Debug de forma predeterminada.  En este modo, los registros se multiplican a la velocidad del rayo.  Para la mayoría de los casos, un nivel de Advertencia es suficiente.  Vaya a Configuración del servidor&gt; Registro: </p><br><p><img src="https://habrastorage.org/webt/c5/cb/pl/c5cbplov4zgqtonzcw8x6bb0poy.png" alt="imagen"></p><br><p>  Esto completa la configuración de OpenLiteSpeed ​​como proxy inverso.  Una vez más, reiniciamos LSWS, siga el enlace <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://cloud.connect.link</a> y vea: </p><br><p><img src="https://habrastorage.org/webt/nn/vo/_d/nnvo_dsr_qk_pzkv0j6xoixedve.png" alt="imagen"></p><br><p>  Para que Nextcloud nos permita ingresar, debe agregar el dominio cloud.connect.link a la lista de confiables.  Ve a editar config.php.  Instalé Nextcloud automáticamente al instalar Ubuntu y la configuración está aquí: / var / snap / nextcloud / current / nextcloud / config. </p><br><p>  A la clave Trusted_domains, agregue el parámetro 'cloud.connect.link': </p><br><blockquote>  'Trusted_domains' =&gt; <br>  matriz ( <br>  0 =&gt; '172.16.22.110', <br>  1 =&gt; 'cloud.connect.link', <br>  ), </blockquote><p><img src="https://habrastorage.org/webt/ow/62/kd/ow62kdr0pbvhfqgcrj-04yvicfi.png" alt="imagen"></p><br><p>  Además, en la misma configuración debe especificar la dirección IP de nuestro proxy.  Llamo la atención sobre el hecho de que se debe especificar la dirección que sea visible para el servidor de Nextcloud, es decir,  Interfaz local IP LSWS.  Sin este paso, la interfaz web de Nextcloud funciona, pero las aplicaciones no están autorizadas. </p><br><blockquote>  'Trusted_proxies' =&gt; <br>  matriz ( <br>  0 =&gt; '172.16.22.100', <br>  ), </blockquote><p>  Bueno, después de eso podemos ingresar a la interfaz de autorización: </p><br><p><img src="https://habrastorage.org/webt/ln/wk/ty/lnwktyhkca3giakan3fqnk0v7ji.png" alt="imagen"></p><br><p>  ¡El problema está resuelto!  Ahora cada cliente puede usar de forma segura la "nube de archivos" en su url personal, el servidor con los archivos está separado de Internet, los futuros clientes obtendrán lo mismo y no sufrirá una sola dirección IP adicional. <br>  Además, puede usar el proxy inverso para entregar contenido estático, pero en el caso de Nextcloud esto no dará un aumento notable en la velocidad.  Entonces esto es opcional y opcional. </p><br><p>  Me alegra compartir esta historia, espero que alguien sea útil.  Si conoce métodos más elegantes y efectivos para resolver la tarea, ¡le agradeceré los comentarios! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/452750/">https://habr.com/ru/post/452750/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452740/index.html">Una selección de conjuntos de datos para el aprendizaje automático</a></li>
<li><a href="../452742/index.html">Configurar pruebas automáticas de una aplicación híbrida</a></li>
<li><a href="../452744/index.html">¿Existe una vida completa de un control remoto sin intercambios independientes?</a></li>
<li><a href="../452746/index.html">El libro "El arte de la programación en R. Inmersión en Big Data"</a></li>
<li><a href="../452748/index.html">Principios para desarrollar aplicaciones modernas de NGINX. Parte 1</a></li>
<li><a href="../452752/index.html">BigData hecho en casa. Parte 1. Práctica de Spark Streaming en un clúster de AWS</a></li>
<li><a href="../452754/index.html">El 19% de las imágenes Docker más populares no tienen una contraseña de root</a></li>
<li><a href="../452756/index.html">Creando Tower Defense en Unity: Enemies</a></li>
<li><a href="../452760/index.html">Vitamina D. Beber o no beber, esa es la cuestión. (O una historia sobre cómo pasé un análisis que no me recetaron)</a></li>
<li><a href="../452762/index.html">MVCC-7. Limpieza automática</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>