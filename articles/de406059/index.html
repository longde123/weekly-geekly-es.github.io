<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😥 🎓 👩🏽 DIY KVM IP 3.0 🧑🏿 🧑‍🤝‍🧑 🧐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dies ist die dritte Variante des IP KVM-Themas. Dieses Mal wurde das Konzept vollständig überarbeitet. Beginnen wir mit dem Aufbau von etwas Neuem. Es...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>DIY KVM IP 3.0</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/406059/"> Dies ist die dritte Variante des IP KVM-Themas. Dieses Mal wurde das Konzept vollständig überarbeitet. Beginnen wir mit dem Aufbau von etwas Neuem.  Es wird viele interessante Dinge geben, den Bildschirm nicht verlassen.  Ein weiteres ungewöhnliches Gerät wird erscheinen, wir werden fast alle alten Komponenten verwerfen, zu unserem nativen Arduino zurückkehren und einen kleinen Hacker spielen. <br><br>  Für diejenigen, die gerade beigetreten sind, eine Zusammenfassung der vorherigen Folgen: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Erster Artikel</a> <br>  IP-KVM auf Arduino und Raspberry Pi gesammelt, stellte sich als teuer und mit schlechter Videoqualität heraus. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zweiter Artikel</a> <br>  OrangePI und Atmega16u2, billig gelernt, aber die Bildqualität ist immer noch widerlich. </li></ul><br>  Und schließlich werden in diesem Artikel alle Nachteile der vorherigen behoben.  Besonderes Augenmerk wird auf die maximale Reduzierung der Komponentenkosten gelegt. <br><a name="habracut"></a><br>  <b>Traditionell betrachten wir die Komponenten des zusammengebauten Geräts:</b> <br><br>  <b>1.</b> Unser alter Freund Atmega16u2: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/d38/32f/4a0/d3832f4a098f4cf8abe96103b11496a3.jpg"></div><br>  Dies ist die einzige Komponente, die von früheren Artikeln verschoben wird. <br><br>  <b>2. Das</b> berüchtigte ESP8266, in diesem Fall ESP8266-12e: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/d3/d9/59d3d9e494103245224131.jpeg"></div><br>  Sie können eine andere Version des ESP8266 verwenden, nur müssen Sie die Anzahl und Position der Ports berücksichtigen. <br><br>  <b>3.</b> Und tatsächlich der Held des Anlasses LKV373A <br><br><img src="https://habrastorage.org/webt/59/d3/da/59d3da94466d8417530057.jpeg"><br><br>  Dank dieses Geräts wurde es möglich, Videos über ein lokales Netzwerk mit hoher Lautstärke zu übertragen <br>  Auflösung bis zu Full-HD. <br><br><h3>  Der Aktionsplan lautet wie folgt: </h3><br><ol><li>  Verstecken: Wir suchen nach LKV373A, wo er sich im Netzwerk unter welcher IP-Adresse versteckt hat </li><li>  Hacker-Spiel: Geben Sie die Firmware ein, setzen Sie die Passwörter zurück und konfigurieren Sie LKV373A </li><li>  Neue Freunde finden: ESP8266, Arduino IDE und lustige Bilder </li><li>  Das Finale der Feier.  Wir verbinden alle Komponenten und übertragen Tastenanschläge über Telnet </li></ol><br><h3>  LKV373A Hintergrund </h3><br>  Also fangen wir an!  LKV373A oder HDMI Extender-Gerät zum Aufnehmen von Bildern direkt vom HDMI-Port und zum Senden an das lokale Netzwerk. Diese Geräte werden auch als HDMI-Extender bezeichnet.  Wie von den Herstellern geplant, sollte ein Satz solcher Geräte aus einem Sender (Sender) und einem Empfänger (Empfänger) mit der Bezeichnung TX bzw. RX bestehen.  Sie sollten wahrscheinlich verwendet werden, um dem Hersteller mehr Gewinn zu bringen, nur paarweise.  Aber es gab einen Mann unter dem Spitznamen Danman, hier ist ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Link</a> zu seinem Blog, der daran interessiert war, wie es funktioniert.  Er öffnete Wireshark, schnüffelte den vom TX-Gerät übertragenen Verkehr. Was stellte sich heraus? <br><br>  Der Videostream wird ohne Verschlüsselung übertragen. Mit dem VLC Player können Sie ihn ohne großen Aufwand ansehen.  Aber er hörte hier nicht auf, "fühlte": Er zog das Webinterface, TTL, Telnet und sogar die Firmware mit dem Programmierer.  Er sprach darüber ausführlich in seinem Blog.  Dort wurde auch die Firmware hochgeladen, die uns an erster Stelle interessiert: IPTV_TX_PKG_v4_0_0_0_20160427.PKG.  In dieser Firmware verfügt die Weboberfläche mit erweiterten Einstellungen und nicht wie die Standardeinstellung nur über die Schaltfläche "Aktualisieren".  Darüber hinaus verfügt diese Firmware über ein Telnet mit vielen zu konfigurierenden Befehlen.  Mit dieser Firmware konfigurieren wir den HDMI Extender für unsere Aufgaben neu.  Ich habe die Firmware und alles, was ich brauchte, auf Github gepostet. Hier ist der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Link</a> , wir werden ihn später brauchen, aber jetzt sind wir mit der Theorie fertig.  Lass uns weiter üben. <br><br><h2>  Sender </h2><br><h3>  Wir suchen nach LKV373A im Netzwerk </h3><br>  Ich fiel in die Hände desselben Extenders wie Danman (y).  Alles, was unten beschrieben wird, ist speziell für den HDMI Extender LKV373A Version V3.0 geeignet! <br><br>  Wir verbinden den LKV373A mit dem lokalen Netzwerk und schalten den Strom ein.  Stellen wir nun sicher, dass das Gerät im <code>ping 192.168.1.238</code> Netzwerk sichtbar ist. <br><br>  192.168.1.238 ist die Standard-IP-Adresse.  Wenn der Extender die alte Firmware-Adresse nicht ändert, unabhängig davon, ob sich ein DHCP-Server im Netzwerk befindet oder nicht.  Neuere Firmware-Versionen verwenden IP standardmäßig nur, wenn das Gerät keine Adresse von DHCP erhalten konnte.  Wenn Sie eine Antwort auf Ping erhalten haben, fahren Sie fort.  Wenn nicht, verzweifeln Sie nicht, versuchen Sie, den Extender direkt an den LAN-Port des Computers anzuschließen, und verwenden Sie den Sniffer. <br><br><h3>  Blinkt </h3><br>  HDMI Extender gefunden, fahren Sie mit der Firmware fort.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gehen wir</a> zum <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github</a> und laden alles herunter, was dort ausgelegt ist.  Öffnen Sie nun die Weboberfläche des Extenders über einen Browser und sehen Sie das folgende Bild: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d91fbcc37298629734.png"><br><br>  Klicken Sie auf "Durchsuchen ...", wählen Sie die Firmware aus, eine Datei mit dem Namen IPTV_TX_PKG_v4_0_0_0_20160427.PKG, und klicken Sie auf "Upgrade".  Tadam!  Die Firmware ist fertig. Stellen Sie nun per Telnet eine Verbindung zum LKV373A her, um das Kennwort zurückzusetzen. <br><br>  Der Befehl zum Verbinden sieht ungefähr so ​​aus wie Telnet 192.168.1.238 9999, wobei 9999 der Port ist, zu dem eine Verbindung hergestellt werden soll.  CEP warnt: Die von DHCP erhaltene Adresse kann mit einem Netzwerkscanner gefunden werden. <br><br><h3>  Verbindung über Telnet herstellen </h3><br>  Beim Herstellen der Verbindung sollte die folgende Meldung angezeigt werden: <br><br><pre> <code class="bash hljs">============================== ========IPTV TX Server======== ============================== input&gt;</code> </pre><br>  Wir schreiben eine <code>list</code> .  Als Antwort erhalten wir eine Liste von Befehlen: <br><br><pre> <code class="bash hljs">============================== ========IPTV TX Server======== ============================== input&gt;list set_group_id get_group_id set_dhcp get_dhcp set_uart_baudrate get_uart_baudrate set_static_ip get_static_ip set_mac_address get_mac_address get_lan_status get_hdcp get_video_lock get_ip_config set_session_key set_device_name get_device_name set_video_bitrate get_video_bitrate set_downscale_mode get_downscale_mode set_video_out_mode get_video_out_mode set_streaming_mode get_streaming_mode get_fw_version get_company_id factory_reset reboot list <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> <br>  Verwenden Sie den Befehl <code>factory_reset</code> um alle Einstellungen und das Kennwort <code>factory_reset</code> .  Wir schreiben einen Befehl, drücken die Eingabetaste und erhalten dieses Bild: <br><br><pre> <code class="bash hljs">input&gt;factory_reset Processing factory reset! System will reboot after few seconds! Connection closed by foreign host.</code> </pre><br><h3>  Webschnittstelle </h3><br>  Jetzt können wir das Gerät nach Bedarf konfigurieren.  Gehen wir zum Webinterface.  Wir verwenden das Standard-Login: Admin-Passwort: 123456 und hier ist das "begehrte" Webinterface mit zusätzlichen Einstellungen: <br><br><img src="https://habrastorage.org/webt/59/d4/e7/59d4e71a2b694981418223.png"><br><br>  Die Möglichkeiten in der Weboberfläche haben zwar zugenommen, aber sie reichen für unsere Zwecke immer noch nicht aus.  Besonders fehlen mehr kostenlose Einstellungen für das Streaming, es ist eine fest codierte Liste von IP-Adressen, an die Sie streamen können, bei weitem nicht die bequemste.  Es gibt natürlich einen Multicast, aber es ist besser, ihn dem Fernsehen zu überlassen.  Einschränkungen können umgangen werden, dazu später mehr. <br><br>  Also fanden sie das Gerät im Netzwerk, rollten es zusammen und setzten die Passwörter zurück.  Der Sender ist fast bereit, zum Empfänger überzugehen. <br><br><h2>  Empfänger </h2><br>  Entscheiden wir uns für das Gerät, unter dessen Steuerung wir den Stream übertragen.  Ich glaube nicht, dass Sie die Qual der Wahl erleben werden, es gibt nur zwei Möglichkeiten: <br><br><h4>  Windows </h4><br>  Für Windows habe ich mehrere Player ausprobiert, aber die Ergebnisse waren mittelmäßig.  Beim Aufnehmen und anschließenden Abspielen eines Videostreams wird eine Verzögerung angezeigt, die hauptsächlich vom Player abhängt, der den Stream abspielt.  Bei verschiedenen Spielern lag die Verzögerung zwischen einer Sekunde und fünf oder mehr.  Das Beste ist, dass sich VLC Player unter Windows bewährt hat. <br><br>  Kommen wir zur Sache.  Starten Sie VLC Player, wählen Sie oben im Dropdown-Menü "Medien" im Feld "Netzwerkadresse" die Option "URL öffnen ..." aus, schreiben Sie <code>udp://@:5004</code> , setzen Sie eine Dämmerung in das Kontrollkästchen "Erweiterte Einstellungen anzeigen" und geben Sie den Wert in das Feld "Caching" ein. Dieser Parameter wird individuell festgelegt.  Je kleiner der Wert in diesem Feld ist, desto geringer ist die Verzögerung. Ein zu kleiner Wert kann jedoch zu „Artefakten“ und Bildausfällen führen. Alles hängt von der lokalen Netzwerkinfrastruktur ab.  Die besten Ergebnisse, die ich erzielen konnte, waren eine Verzögerung von etwa einer Sekunde.  Unter Linux waren die Ergebnisse um 200-300 Millisekunden viel besser. <br><br><h4>  Linux </h4><br>  Wie die Praxis zeigt, werden die besten Ergebnisse mit einer Kombination aus Socat- und Mplayer-Programmen erzielt.  Ubuntu ist auf meinem Computer installiert, daher sieht der Befehl zum Installieren von socat folgendermaßen aus: <br><br><pre> <code class="bash hljs">sudo apt-get install socat</code> </pre> <br>  Mplayer ist ähnlich installiert: <br><br><pre> <code class="bash hljs">sudo apt-get install mplayer</code> </pre> <br>  Nun, und folge Danmans Rat: <br><br><pre> <code class="bash hljs">sudo iptables -t raw -A PREROUTING -p udp -m length --length 28 -j DROP</code> </pre> <br>  Dieser Befehl wird benötigt, um die sogenannten "Zero Length UDP Packets" aus dem Stream zu entfernen - Pakete mit der Größe Null, die den Stream "verstopfen". <br><br><h2>  Geh live! </h2><br>  Der Empfänger ist bereit, Sie können die Sendung starten!  Wir geben die Konsole des empfangenden Computers <code>ifconfig</code> oder <code>ipconfig</code> , je nach Betriebssystem, <code>ipconfig</code> uns die IP-Adresse des Empfängers und kehren zur Weboberfläche des Senders zurück.  Wir öffnen die Weboberfläche. Wenn wir sie bereits geschlossen haben, geben Sie den Benutzernamen und das Kennwort ein und schreiben Sie direkt in die Adressleiste des Browsers: <br><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">///dev/info.cgi?action=streaminfo&amp;udp=n&amp;rtp=y&amp;multicast=n&amp;unicast=y&amp;mcastaddr=&amp;port=5004</span></span></code> </pre> <br>  Ersetzen Sie Ihre IP-Adressen und drücken Sie die Eingabetaste.  In dieser Zeile wird der HDMI-Extender so konfiguriert, dass das aufgenommene Video an die von Ihnen gewählte IP-Adresse gesendet und der Multicast ausgeschaltet wird. <br><br>  Wir starten VLC in Windows.  Oder im Linux-Terminal schreiben wir: <br><br><pre> <code class="bash hljs">socat UDP-RECV:5004 - | mplayer –</code> </pre> <br>  Abra Cadabra!  Und hier ist unser oder nicht unser Live-Desktop. <br><br><img src="https://habrastorage.org/webt/59/d3/f3/59d3f3c6a0c3b976110026.png"><br><br>  Mit ein paar Hacker-Methoden haben wir das Gerät gezwungen, das zu tun, was wir brauchten. <br><br>  Gehen Sie nach der sortierten Videoübertragung zur Fernbedienung. <br><br><h2>  Kontrolle übertragen </h2><br><h3>  Komponentenauswahl </h3><br>  Weil  Die Kosten für HDMI Extender sind niedrig, etwa 1800 Rubel, und auch wegen der Kommentare, die, wie sie sagen, etwas teuer sind, habe ich den Slogan vorgebracht: "Geben Sie IP KVM für 2000 Rubel!".  Der Rubel-Wechselkurs wird die Treue dieser Aussage stark beeinflussen, aber lassen Sie uns nicht über traurige Dinge sprechen, ich möchte an eine glänzende Zukunft glauben.  Um das Ziel zu erreichen, brauchen wir sehr billige Elemente, meine Wahl fiel auf den ESP8266 als Controller und trotzdem Atmega (16.08.32) u2 als Aktuator. <br><br>  Sie können natürlich auch andere Kandidaten für die Rolle eines Executive-Geräts (Tastatur) in Betracht ziehen.  Die Firmware, die die Tastatur emuliert, wird in die LUFA-Bibliothek geschrieben.  Diese Bibliothek kann für die gesamte AVR-Familie mit USB-Konnektivität verwendet werden.  Daraus folgt, dass Sie als Tastaturemulator möglicherweise billigere Mikrocontroller erwerben können.  Dies sind Informationen, die berücksichtigt werden müssen, aber jetzt fahren wir fort. <br><br>  Sie können den ESP8266 für ungefähr 90 Rubel, Atmega (16.08.32) u2 für ungefähr 100 Rubel kaufen und sogar billiger, wenn Sie kleine Mengen von 5 oder mehr Stück aufnehmen.  Natürlich werden Verbrauchsmaterialien zum Umreifen von Mikrocontrollern benötigt, aber ihre Kosten sind extrem gering, daher werde ich sie nicht berücksichtigen. <br><br><h2>  ESP8266 </h2><br>  Dieses Wunder der chinesischen Industrie bedarf keiner Einführung, daher möchte ich nur sagen, dass ich in diesem Projekt die Version von ESP8266-12e verwendet habe.  Natürlich können Sie auch andere Versionen verwenden, nur müssen Sie die Position der Ports berücksichtigen, weil  In dieser Version wird einer der ESP8266-Ports zum Einschalten des Atmega (16.08.32) u2 verwendet. Dies wird in der folgenden Abbildung angezeigt. <br><br><h3>  Firmware </h3><br>  Die Firmware für ESP8266 ist in der ArduinoIDE-Umgebung geschrieben. Laden Sie daher die neueste Version von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">der Entwicklerseite</a> herunter.  Als nächstes müssen Sie Unterstützung für ESP8266 hinzufügen - der einfachste Weg finden Sie unter diesem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Link</a> .  Auf derselben Seite finden Sie viele nützliche Informationen, wie z. B. den Stromanschluss und TTL.  Für diejenigen, die nicht auf dem neuesten Stand sind, verwendet der ESP8266 <b>streng 3,3 Volt!</b>  Wenn Sie sich in Ihren eigenen Fähigkeiten nicht sicher sind, ist es besser, eine für USB angepasste Board-Option wie NodeMCU zu verwenden: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d92043a87951368720.jpeg"><br><br>  Wenn alles fertig ist, öffne ArduinoIDE und kopiere meine Skizze: <br><br><div class="spoiler">  <b class="spoiler_title">Skizze</b> <div class="spoiler_text"><pre> <code class="hljs lua">#include &lt;ESP8266WiFi.h&gt; #include &lt;WiFiClient.h&gt; #include &lt;ESP8266WebServer.h&gt; #include &lt;ESP8266mDNS.h&gt; #include &lt;SoftwareSerial.h&gt; #include &lt;HIDKeyboard.h&gt; #define MAX_SRV_CLIENTS <span class="hljs-number"><span class="hljs-number">3</span></span> HIDKeyboard keyboard; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* host = <span class="hljs-string"><span class="hljs-string">"esp8266"</span></span>; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* ssid = <span class="hljs-string"><span class="hljs-string">""</span></span>; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* pass = <span class="hljs-string"><span class="hljs-string">""</span></span>; int rebootdev = <span class="hljs-number"><span class="hljs-number">0</span></span>; int modeswitch = <span class="hljs-number"><span class="hljs-number">0</span></span>; // ,    ESP8266    #define Port1 <span class="hljs-number"><span class="hljs-number">15</span></span> #define Port2 <span class="hljs-number"><span class="hljs-number">14</span></span> #define Port3 <span class="hljs-number"><span class="hljs-number">12</span></span> #define Port4 <span class="hljs-number"><span class="hljs-number">4</span></span> #define Port5 <span class="hljs-number"><span class="hljs-number">5</span></span> //  String ColorB1; String ColorB2; String ColorB3; String ColorB4; String ColorB5; ESP8266WebServer server(<span class="hljs-number"><span class="hljs-number">80</span></span>); WiFiClient serverClients[MAX_SRV_CLIENTS]; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* serverIndex = <span class="hljs-string"><span class="hljs-string">"&lt;form method='POST' action='/update' enctype='multipart/form-data'&gt;&lt;input type='file' name='update'&gt;&lt;input type='submit' value='Update'&gt;&lt;/form&gt;&lt;a href='/'&gt;BACK&lt;/a&gt;"</span></span>;//Update //    void handleRedirect(){ String content = <span class="hljs-string"><span class="hljs-string">"&lt;html&gt;&lt;head&gt;&lt;meta http-equiv='refresh' content='0;/'&gt;&lt;head&gt;&lt;/html&gt;"</span></span>; server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, content); } //  WI-FI void handleLogin(){ String msg = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (server.hasArg(<span class="hljs-string"><span class="hljs-string">"SSID"</span></span>) &amp;&amp; server.hasArg(<span class="hljs-string"><span class="hljs-string">"PASSAP"</span></span>)){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"SSID"</span></span>) != NULL) &amp;&amp; (server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"PASSAP"</span></span>) != NULL)){ String header = <span class="hljs-string"><span class="hljs-string">"HTTP/1.1 301 OK\r\r\nLocation: /\r\nCache-Control: no-cache\r\n\r\n"</span></span>; server.sendContent(header); String web_ssid = server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"SSID"</span></span>); String web_pass = server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"PASSAP"</span></span>); ssid = web_ssid.c_str();//       C pass = web_pass.c_str(); Serial.println(); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"SSID "</span></span>); Serial.println(ssid); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Pass "</span></span>); Serial.println(pass); WiFi.begin(ssid, pass); digitalWrite(LED_BUILTIN, LOW); ESP.reset(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } msg = <span class="hljs-string"><span class="hljs-string">"Wrong ssid/password! try again."</span></span>; Serial.println(<span class="hljs-string"><span class="hljs-string">"Login Failed"</span></span>); } String content = <span class="hljs-string"><span class="hljs-string">"&lt;html&gt;&lt;body&gt;&lt;form action='/' method='POST'&gt;Enter the access point name and password &lt;br&gt;"</span></span>;//  SSID   content += <span class="hljs-string"><span class="hljs-string">"Name AP:&lt;input type='text' name='SSID' placeholder='SSID'&gt;&lt;br&gt;"</span></span>; content += <span class="hljs-string"><span class="hljs-string">"Password:&lt;input type='password' name='PASSAP' placeholder='password'&gt;&lt;br&gt;&lt;br&gt;"</span></span>; content += <span class="hljs-string"><span class="hljs-string">"&lt;input type='submit' name='SUBMIT' value='Connect to WI-FI'&gt;&lt;/form&gt;&lt;b&gt;&lt;font color='red'&gt;"</span></span> + msg + <span class="hljs-string"><span class="hljs-string">"&lt;/font&gt;&lt;/b&gt;&lt;br&gt;"</span></span>; content += <span class="hljs-string"><span class="hljs-string">"Firmware update &lt;a href='/upload'&gt;UPDATE&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;"</span></span>; server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, content); } void handleNotFound(){ String message = <span class="hljs-string"><span class="hljs-string">"File Not Found\n\n"</span></span>; message += <span class="hljs-string"><span class="hljs-string">"URI: "</span></span>; message += server.uri(); message += <span class="hljs-string"><span class="hljs-string">"\nMethod: "</span></span>; message += (server.method() == HTTP_GET)?<span class="hljs-string"><span class="hljs-string">"GET"</span></span>:<span class="hljs-string"><span class="hljs-string">"POST"</span></span>; message += <span class="hljs-string"><span class="hljs-string">"\nArguments: "</span></span>; message += server.args(); message += <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8_t i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;server.args(); i++){ message += <span class="hljs-string"><span class="hljs-string">" "</span></span> + server.argName(i) + <span class="hljs-string"><span class="hljs-string">": "</span></span> + server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(i) + <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } server.send(<span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message); } //  int controlPin(int UsePin){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (UsePin &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>){ int StPort; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(UsePin) == <span class="hljs-number"><span class="hljs-number">1</span></span>) {//      digitalWrite(UsePin, LOW); StPort = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { digitalWrite(UsePin, HIGH); StPort = <span class="hljs-number"><span class="hljs-number">1</span></span>; } digitalWrite(LED_BUILTIN, HIGH);//    Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Port "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(UsePin); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"="</span></span>); Serial.println(StPort); delay(<span class="hljs-number"><span class="hljs-number">500</span></span>); digitalWrite(LED_BUILTIN, LOW); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(StPort); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">-1</span></span>); } //  int clientConnect(int Seconds){ Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"connection "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt;= Seconds; i++){ WiFi.begin(ssid, pass); digitalWrite(LED_BUILTIN, LOW); delay(<span class="hljs-number"><span class="hljs-number">250</span></span>); digitalWrite(LED_BUILTIN, HIGH); delay(<span class="hljs-number"><span class="hljs-number">250</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">" "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WiFi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>() == WL_CONNECTED) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); Serial.println(); } void setup(void){ Serial.begin(<span class="hljs-number"><span class="hljs-number">115200</span></span>); delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); pinMode(LED_BUILTIN, OUTPUT); digitalWrite(LED_BUILTIN, HIGH); //uint8_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">0</span></span>) WiFi.mode(WIFI_STA);//  modeswitch = <span class="hljs-number"><span class="hljs-number">0</span></span>     Serial.println(); Serial.println(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (clientConnect(<span class="hljs-number"><span class="hljs-number">30</span></span>) != <span class="hljs-number"><span class="hljs-number">0</span></span>) modeswitch = <span class="hljs-number"><span class="hljs-number">1</span></span>;//            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">1</span></span>){ Serial.println(<span class="hljs-string"><span class="hljs-string">""</span></span>); Serial.println(<span class="hljs-string"><span class="hljs-string">"WiFi switch AP mode"</span></span>); //WiFi.mode(WIFI_AP_STA);    +  .     WiFi.mode(WIFI_AP); WiFi.softAP(<span class="hljs-string"><span class="hljs-string">"TD"</span></span>, <span class="hljs-string"><span class="hljs-string">"testtest"</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"AP mode ip adress "</span></span>); Serial.println(WiFi.softAPIP()); digitalWrite(LED_BUILTIN, LOW); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch != <span class="hljs-number"><span class="hljs-number">1</span></span>){ WiFiServer server(<span class="hljs-number"><span class="hljs-number">23</span></span>); Serial.println(); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Client mod ip address: "</span></span>); Serial.println(WiFi.localIP()); digitalWrite(LED_BUILTIN, LOW); } MDNS.begin(host); pinMode(Port1, OUTPUT); pinMode(Port2, OUTPUT); pinMode(Port3, OUTPUT); pinMode(Port4, OUTPUT); pinMode(Port5, OUTPUT); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">1</span></span>){ //     server.on(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, handleLogin);//  (SSID)   //  server.on(<span class="hljs-string"><span class="hljs-string">"/upload"</span></span>, HTTP_GET, [](){ server.sendHeader(<span class="hljs-string"><span class="hljs-string">"Connection"</span></span>, <span class="hljs-string"><span class="hljs-string">"close"</span></span>); server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, serverIndex); }); server.on(<span class="hljs-string"><span class="hljs-string">"/update"</span></span>, HTTP_POST, [](){ server.sendHeader(<span class="hljs-string"><span class="hljs-string">"Connection"</span></span>, <span class="hljs-string"><span class="hljs-string">"close"</span></span>); int uperror = Update.hasError(); Serial.printf(<span class="hljs-string"><span class="hljs-string">"UPERR %u\nRebooting...\n"</span></span>,Update.hasError()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (uperror == <span class="hljs-number"><span class="hljs-number">0</span></span>) server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, <span class="hljs-string"><span class="hljs-string">"Firmware update successfully &lt;a href='/'&gt;BACK&lt;/a&gt;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, <span class="hljs-string"><span class="hljs-string">"Update error &lt;a href='/'&gt;BACK&lt;/a&gt;"</span></span>); ESP.restart(); },[](){ HTTPUpload&amp; upload = server.upload(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(upload.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == UPLOAD_FILE_START){ Serial.setDebugOutput(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); WiFiUDP::stopAll(); Serial.printf(<span class="hljs-string"><span class="hljs-string">"Update: %s\n"</span></span>, upload.filename.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (upload.filename == NULL) { Serial.printf(<span class="hljs-string"><span class="hljs-string">"ERROR: zero file size"</span></span>); server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;html&gt; zero file size &lt;a href='/upload'&gt;BACK&lt;/a&gt;&lt;/html&gt;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">-1</span></span>); } uint32_t maxSketchSpace = (ESP.getFreeSketchSpace() - <span class="hljs-number"><span class="hljs-number">0x1000</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xFFFFF000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!Update.begin(maxSketchSpace)){//start with <span class="hljs-built_in"><span class="hljs-built_in">max</span></span> available size Update.printError(Serial); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(upload.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == UPLOAD_FILE_WRITE){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Update.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(upload.buf, upload.currentSize) != upload.currentSize){ Update.printError(Serial); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(upload.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == UPLOAD_FILE_END){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Update.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(<span class="hljs-literal"><span class="hljs-literal">true</span></span>)){ //<span class="hljs-literal"><span class="hljs-literal">true</span></span> to set the size to the current progress Serial.printf(<span class="hljs-string"><span class="hljs-string">"Update Success: %u\nRebooting...\n"</span></span>, upload.totalSize); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Update.printError(Serial); } Serial.setDebugOutput(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span>(); }); //  server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt1"</span></span>, [] { controlPin(Port1); handleRedirect();//    }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt2"</span></span>, [] { controlPin(Port2); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt3"</span></span>, [] { controlPin(Port3); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt4"</span></span>, [] { controlPin(Port4); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt5"</span></span>, [] { controlPin(Port5); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/reboot"</span></span>, [] { rebootdev = <span class="hljs-number"><span class="hljs-number">1</span></span>;//      handleRedirect(); }); server.onNotFound(handleNotFound);//    //server.begin(); MDNS.addService(<span class="hljs-string"><span class="hljs-string">"http"</span></span>, <span class="hljs-string"><span class="hljs-string">"tcp"</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>); Serial.println(); Serial.println(<span class="hljs-string"><span class="hljs-string">"HTTP server started"</span></span>); } server.begin(); } void loop(void){ uint8_t i; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">1</span></span>) server.handleClient(); delay(<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch != <span class="hljs-number"><span class="hljs-number">1</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WiFi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>() != WL_CONNECTED) clientConnect(<span class="hljs-number"><span class="hljs-number">30</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { digitalWrite(<span class="hljs-number"><span class="hljs-number">5</span></span>, HIGH);//  ATMEGA16U2 digitalWrite(LED_BUILTIN, LOW); } } WiFiServer server(<span class="hljs-number"><span class="hljs-number">23</span></span>); server.setNoDelay(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); server.begin(); keyboard.begin(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(WiFi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>() == WL_CONNECTED) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (server.hasClient()){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; MAX_SRV_CLIENTS; i++){ //<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> free/disconnected spot <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!serverClients[i] || !serverClients[i].connected()){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(serverClients[i]) serverClients[i].stop(); serverClients[i] = server.available(); Serial.println(<span class="hljs-string"><span class="hljs-string">"New client: "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(i); continue; } } //no free/disconnected spot so reject WiFiClient serverClient = server.available(); serverClient.stop(); } //check clients <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; MAX_SRV_CLIENTS; i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serverClients[i] &amp;&amp; serverClients[i].connected()){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(serverClients[i].available()){ //get data from the telnet client <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> push it to the UART String bufkey; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(serverClients[i].available()) bufkey += (serverClients[i].<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>());//     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bufkey != <span class="hljs-number"><span class="hljs-number">0</span></span>) { bufkey = bufkey.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>);//  int key = bufkey.toInt();//   switch (key){ case <span class="hljs-number"><span class="hljs-number">277980</span></span>: keyboard.pressSpecialKey(F1); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">277981</span></span>: keyboard.pressSpecialKey(F2); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">277982</span></span>: keyboard.pressSpecialKey(F3); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">277983</span></span>: keyboard.pressSpecialKey(F4); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914953</span></span>: keyboard.pressSpecialKey(F5); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914955</span></span>: keyboard.pressSpecialKey(F6); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914956</span></span>: keyboard.pressSpecialKey(F7); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914957</span></span>: keyboard.pressSpecialKey(F8); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915048</span></span>: keyboard.pressSpecialKey(F9); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915049</span></span>: keyboard.pressSpecialKey(F10); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915051</span></span>: keyboard.pressSpecialKey(F11); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915052</span></span>: keyboard.pressSpecialKey(F12); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">1310</span></span>: keyboard.pressSpecialKey(ENTER); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">130</span></span>: keyboard.pressSpecialKey(ENTER); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27</span></span>: keyboard.pressSpecialKey(ESCAPE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">8</span></span>: keyboard.pressSpecialKey(BACKSPACE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">9</span></span>: keyboard.pressSpecialKey(TAB); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">32</span></span>: keyboard.pressSpecialKey(SPACEBAR); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915012</span></span>: keyboard.pressSpecialKey(INSERT); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914912</span></span>: keyboard.pressSpecialKey(HOME); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915312</span></span>: keyboard.pressSpecialKey(PAGEUP); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915212</span></span>: keyboard.pressSpecialKey(END); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915412</span></span>: keyboard.pressSpecialKey(PAGEDOWN); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279167</span></span>: keyboard.pressSpecialKey(RIGHTARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279168</span></span>: keyboard.pressSpecialKey(LEFTARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279166</span></span>: keyboard.pressSpecialKey(DOWNARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279165</span></span>: keyboard.pressSpecialKey(UPARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">127</span></span>: keyboard.pressSpecialKey(DELETE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915112</span></span>: keyboard.pressSpecialKey(DELETE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">4</span></span>: keyboard.pressSpecialKey((LCTRL | ALT), DELETE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; //CTRL+ALT+DELETE  Ctrl + d case <span class="hljs-number"><span class="hljs-number">6</span></span>: keyboard.pressSpecialKey(ALT, F4); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; //alt+f4  Ctrl + f case <span class="hljs-number"><span class="hljs-number">19</span></span>: keyboard.pressSpecialKey(ALT | SHIFT); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//   Ctrl+s case <span class="hljs-number"><span class="hljs-number">2</span></span>: keyboard.pressSpecialKey(LCTRL | SHIFT); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//   Ctrl+b //    case <span class="hljs-number"><span class="hljs-number">17</span></span>: controlPin(Port1); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+q case <span class="hljs-number"><span class="hljs-number">23</span></span>: controlPin(Port2); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+w case <span class="hljs-number"><span class="hljs-number">5</span></span>: controlPin(Port3); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+e case <span class="hljs-number"><span class="hljs-number">18</span></span>: controlPin(Port4); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+r case <span class="hljs-number"><span class="hljs-number">20</span></span>: controlPin(Port5); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+t default: keyboard.pressKey(key); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//  } keyboard.releaseKey();//  Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">" string: "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(key);//  Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">" KEY: "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(bufkey.toInt()); bufkey = <span class="hljs-string"><span class="hljs-string">'0'</span></span>;//    } } } } //check UART <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Serial.available()){ size_t <span class="hljs-built_in"><span class="hljs-built_in">len</span></span> = Serial.available(); uint8_t sbuf[<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>]; Serial.readBytes(sbuf, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>); //push UART data to all connected telnet clients <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; MAX_SRV_CLIENTS; i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serverClients[i] &amp;&amp; serverClients[i].connected()){ serverClients[i].<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(sbuf, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>); delay(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } } } }</code> </pre><br></div></div><br>  Verbinden Sie die gewünschte Bibliothek: <br><br>  Wählen Sie die Registerkarte "Skizze" → "Bibliothek verbinden" → ".ZIP-Bibliothek hinzufügen". Wählen Sie die Bibliothek "UNO-HIDKeyboard-Library-master (mod) .zip" aus, die vom Github heruntergeladen wurde.  Wir kompilieren und füllen die Firmware aus.  Um die Firmware herunterzuladen, schließen Sie den ESP8266 TTL an und stellen Sie den gewünschten Port in ArduinoIDE ein.  Die Einstellungen sollten ungefähr so ​​aussehen: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d920b385c613386705.png"><br><br>  Um die Firmware herunterzuladen, müssen Sie den GPIO0-Port gegen Masse kurzschließen und den Mikrocontroller neu starten, indem Sie den Reset-Port ebenfalls gegen Masse kurzschließen.  Ich werde nicht im Detail malen, um den Artikel nicht aufzublasen, wird Google Ihnen helfen. <br><br>  Die Logik des ESP8266 lautet wie folgt: Wenn Strom angelegt wird, versucht der Mikrocontroller etwa 30 Sekunden lang, eine Verbindung zu einem Wi-Fi-Zugangspunkt herzustellen: <br><br>  <b>Wenn die Verbindung erfolgreich ist</b> : <b>Öffnet</b> Port 23, mit dem Sie über Telnet eine Verbindung herstellen und Tastenanschläge übertragen können.  Zusätzlich zu den Tasten können Sie Kombinationen übertragen, die auf "Strg + Taste" basieren und bestimmte Kombinationen drücken.  Wenn Sie beispielsweise "Strg + d" übergeben, wird die Kombination STRG + ALT + ENTF auf dem verwalteten Computer gedrückt. <br><br>  Es gibt auch Kombinationen zur Steuerung der ESP8266-Ports. Sie können beispielsweise ein Relais anschließen und das Relais mit der Kombination „Strg + q“ ein- und ausschalten, um den verwalteten Computer aus der Ferne ein- und auszuschalten.  Sie können diese und andere Kombinationen in der Quelle sehen. <br><br>  <b>Wenn dies fehlschlug</b> : ESP8266 wechselt in den Access Point-Modus mit dem Namen „TD“ und dem Kennwort „testtest“ und öffnet eine kleine Weboberfläche unter 192.168.4.1, in der Sie die Einstellungen für die Verbindung über WI-FI konfigurieren können. <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d920802fd033414007.png"><br><br>  Somit kann das Gerät leicht mit einem anderen Zugangspunkt verbunden werden.  Ja, hier ist eine Fliege in der Salbe versteckt. Für den Betrieb unserer IP-KVM benötigen wir sowohl ein LAN-Kabel als auch WLAN.  Dies sind die Kosten für die Billigkeit des Geräts. <br><br>  Wir haben uns mit ESP8266 befasst, mit Atmega16u2 ist alles wie in den vorherigen Artikeln, wir flashen das Flip-Programm, die Firmware ist im Archiv, das vom Github heruntergeladen wurde. <br><br><h2>  Komponentenverbindung </h2><br>  Für den korrekten Anschluss der Komponenten bringe ich die Schaltung an.  Denken Sie daran, dies ist ein bedingtes Schema, es dient der Klarheit und erhebt keinen Anspruch auf Ideal.  Jeder kann sie nach Belieben "einrichten". <br><br><img src="https://habrastorage.org/webt/59/d6/52/59d6521903f44207012758.jpeg"><br><br>  Lassen Sie mich einige Punkte erklären: Der Transistor in der Schaltung wird benötigt, um den Atmega16u2 nach dem Laden des ESP8266 einzuschalten, da beim Einschalten des ESP8266 Debug-Informationen an alle TX-Ports übertragen werden und wenn der Atmega16u2 eingeschaltet und mit dem Computer verbunden ist, ein Datenstrom mit dessen Volumen übertragen wird Der Fahrer kann nicht damit umgehen.  Es ist nicht sicher bekannt, was in diesem Moment passiert, der Treiberpuffer läuft vermutlich über, der Effekt ist äußerst unangenehm: Hunderte von Tasten werden gedrückt, wenn ein Texteditor geöffnet wird, wird ein Haufen Kauderwelsch ausgegossen, und alle Servicetasten bleiben hängen, und infolgedessen wird das Arbeiten mit der Tastatur unmöglich .  Um dies zu vermeiden, muss der Atmega16u2 nach dem Laden des ESP8266 eingeschaltet werden.  In der Firmware wird dieser Moment berücksichtigt. <br><br>  Natürlich gibt es eine Alternative zum Schema, aber dies ist eine Option für die Reichen oder die Faulen.  Übrigens hebt diese Option das oben Gesagte nicht auf: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d920e7d2e067456748.jpeg"><br><br>  Auf dem Bild ist das Arduino UNO ohne Atmega328p-Chip mit dem chinesischen Gegenstück zu NodeMCU verbunden.  Die 3,3-Volt-Leitung ist mit der Leitung mit dem gleichen Spannungspegel am Arduino sowie mit der Masse und dem GPIO2-Pin (ESP8266) mit dem TX-Pin am Arduino verbunden. <br><br><h2>  Endkontrolle </h2><br>  Wir verbinden uns per Telnet mit Port 23 und überprüfen die Leistung.  Sie können dies tun: Unter Windows mit dem <code>telnet [ip- ESP8266]</code> Befehl <code>telnet [ip- ESP8266]</code> . <br><br>  Unter Linux wird es etwas komplizierter: <br><br>  Der <code>telnet [ip- ESP8266]</code> Befehl <code>telnet [ip- ESP8266]</code> dann müssen Sie das Steuerzeichen drücken, die Standardeinstellung ist "Strg +]", das Telnet sollte in den Befehlsmodus wechseln, dann "l" und "Enter" drücken.  Mit diesen Aktionen schalten wir das Telnet in den Symbolmodus. <br><br><pre> <code class="bash hljs">$ telnet 192.168.***.*** Trying 192.168.***.***... Connected to 192.168.***.***. Escape character is <span class="hljs-string"><span class="hljs-string">'^]'</span></span>. ^] telnet&gt; l</code> </pre><br>  Alles ist fertig, wir können den Betrieb des von uns erstellten Geräts überprüfen.  Ich möchte Sie an die möglichen Kombinationen für das Drücken von "Alt + Tab", "Strg + Alt + Entf" usw. erinnern.  kann in der Skizze sehen.  Das ist alles, die dritte KVM DIY IP-Inkarnation ist fertig. <br><br><h2>  Zusammenfassend </h2><br><h3>  Vorteile: </h3><br><ul><li>  Das wahrscheinlich wichtigste Plus ist der Preis, der in 2000 Rubel passt </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Es sollte keine Beschwerden über die Qualität des Videos geben, Sie können problemlos auf Full HD streamen </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Die Möglichkeit, die Funktionalität durch Hinzufügen von bis zu vier Relais oder anderen Aktuatoren zu erweitern. </font></font></li></ul><br><h3>  Nachteile: </h3><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sie müssen eine Verbindung über WLAN und LAN-Kabel herstellen </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bei Verwendung mit VGA ist ein Adapter erforderlich, was sich natürlich auf die Kosten auswirkt </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Im Allgemeinen erwies sich das Gerät als bemerkenswert, natürlich ist es kein Konkurrent zu seriellen IP-KVMs mit all ihren „Extras“, aber es gewinnt viel im Preis. </font><font style="vertical-align: inherit;">Und für den Heimgebrauch, und vielleicht nicht nur, ist es durchaus geeignet. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich möchte diese Gelegenheit nutzen, um dem Benutzer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DaylightIsBurning</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu danken </font><font style="vertical-align: inherit;">! </font><font style="vertical-align: inherit;">Dieser freundliche Mann schlug die richtige Richtung für die Ausgrabung vor. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vielen Dank für Ihre Aufmerksamkeit. </font><font style="vertical-align: inherit;">Bis bald!</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de406059/">https://habr.com/ru/post/de406059/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de406047/index.html">Überisierung von Abschleppwagen</a></li>
<li><a href="../de406049/index.html">Zeige 3D-Grafiken auf PSP an</a></li>
<li><a href="../de406051/index.html">Auf dem Weg zu den Sternen: die Gefahr der Raumfahrt</a></li>
<li><a href="../de406055/index.html">Eine Person, die ein Update des Immunsystems zur Bekämpfung von Krebs erhalten hat</a></li>
<li><a href="../de406057/index.html">Google Lunar X PREIS-Wettbewerbsteams erhalten zusätzliche Zeit</a></li>
<li><a href="../de406061/index.html">Informationssicherheitsspezialist hat den kryptografischen Schutz von Apple Secure Enclave gehackt</a></li>
<li><a href="../de406063/index.html">Was genau passiert, wenn die Bitcoin-Segwit2x-Gabel im November aktiviert wird?</a></li>
<li><a href="../de406065/index.html">Spezialisten für Informationssicherheit: „Ein intelligentes Auto ist alles andere als immer ein sicheres Auto“</a></li>
<li><a href="../de406067/index.html">Intelligente Verträge. Teil 1. Wenn die Zeitung weiß, was Sie ihr gesagt haben und es tut</a></li>
<li><a href="../de406069/index.html">Intelligente Verträge. Teil 2. Vom Hype zur Realität</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>