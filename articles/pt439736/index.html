<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèø‚Äçü§ù‚Äçüßëüèª ‚ôæ üôåüèª Conex√£o VPN IPSec entre MikroTik e Kerio Control üòç üòê üôáüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Par√¢metros iniciais: 



1. A sede da empresa com dois proxies de borda Kerio Control v.9.2.9 build 3171 (atr√°s do Kerio, h√° um switch Cisco 3550 que ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Conex√£o VPN IPSec entre MikroTik e Kerio Control</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439736/"><img src="https://habrastorage.org/webt/zg/b9/cd/zgb9cd1ivkh83waulyxllysswwe.png"><br><br>  Par√¢metros iniciais: <br><br><ol><li>  A sede da empresa com dois proxies de borda Kerio Control v.9.2.9 build 3171 (atr√°s do Kerio, h√° um switch Cisco 3550 que determina a configura√ß√£o da rede local do escrit√≥rio). </li><li>  Cada Kerio possui dois canais com balanceamento de carga at√© o ISP (no diagrama - ISP # 1 e ISP # 2) com IPs brancos est√°ticos. </li><li>  Do lado do escrit√≥rio remoto, o MikroTik 951G-2HnD (OS v.6.43.11) foi instalado. </li><li>  Dois ISPs chegam ao MikroTik (no diagrama s√£o o ISP # 3 e o ISP # 4). </li></ol><br>  No momento da reda√ß√£o deste artigo, tanto na sede quanto na remota, a conex√£o com os provedores era de par tran√ßado. <br><br><h3>  A lista de tarefas: </h3><br><ol><li>  Estabele√ßa uma conex√£o VPN IPSec entre o MikroTik e o Kerio Control, onde o MikroTik ser√° o iniciador. </li><li> Garanta a toler√¢ncia a falhas da conex√£o VPN, ou seja,  Al√©m do fato de o MikroTik precisar monitorar o desempenho de seus ISPs (artigo <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a></b> ), tamb√©m deve monitorar a disponibilidade de cada servidor Kerio e determinar o acesso atrav√©s de qual canal (atrav√©s do qual ISP do Kerio) a conex√£o ser√° feita. </li><li>  Forne√ßa a capacidade de alterar o endere√ßo de rede com o qual o MikroTik se conecta ao Kerio.  Isso se deve ao fato de o Kerio, e n√£o um roteador, estar na sede da "fronteira". </li></ol><a name="habracut"></a><br><br><h3>  O que obtemos na sa√≠da? </h3><br><ol><li>  Quando o MikroTik (scheduleStartup) √© iniciado, um canal para a rede corporativa ser√° organizado (o canal ser√° iniciado pelo MikroTik), permitindo que um usu√°rio remoto trabalhe com recursos corporativos sem iniciar o Kerio Client e sem configurar uma conex√£o VPN adicional usando o sistema operacional; </li><li>  O MikroTik implementar√° o Failover, que alterna automaticamente para um ISP ativo; </li><li>  Voc√™ pode definir prioridades para pontos de conex√£o com a rede corporativa alterando a afilia√ß√£o de pares configurados para se conectar ao Kerio Control a um ou outro Grupo de Modelos de Pol√≠tica no MikroTik; </li><li>  O MikroTik poder√° monitorar automaticamente o desempenho dos servidores Kerio Control e, se a conex√£o com o ponto de prioridade for interrompida, alterne para o canal ao vivo de forma independente; </li><li>  Se seus servidores Kerio Control forem publicados em servidores DNS externos, o MikroTik poder√° rastrear altera√ß√µes em seus endere√ßos IP (por exemplo, se o seu provedor mudar) e fazer altera√ß√µes independentemente em sua configura√ß√£o (scriptSetIPSecSADstAddrFromDNS). </li></ol><br><br>  Devo dizer imediatamente que este artigo n√£o √© um tutorial (em princ√≠pio, eu me familiarizei com roteadores e, em particular, com o MikroTik apenas dois meses (final de 2017) antes da cria√ß√£o da configura√ß√£o) e n√£o aborda as perguntas ‚Äúpor qu√™?‚Äù, Ele estar√° aqui A descri√ß√£o da configura√ß√£o de trabalho do MikroTik, usada em uma empresa real, √© fornecida. <br><br>  <b>Nota:</b> <br><ol><li>  Para manter os coment√°rios no idioma russo ao transferir o c√≥digo de script para o MikroTik, antes de copiar o texto para o buffer e antes de inseri-lo, verifique se o layout do teclado russo est√° ativado; </li><li>  Se voc√™ achar que os scripts de log s√£o sup√©rfluos, pode comentar ou excluir linhas com "aviso de log" e "erro de log"; </li><li>  Voc√™ tamb√©m pode observar "aviso de log" e "erro de log" comentados no c√≥digo, esta √© uma tentativa de adicionar a capacidade de usar o log em ingl√™s ... </li></ol><br><br>  Ent√£o, vamos come√ßar: <br><br>  <b>Par√¢metros b√°sicos:</b> <br><br><ol><li>  A rede da organiza√ß√£o pai (atr√°s do Kerio) √© 192.168.77.0/24 (aqui usamos o endere√ßo da rede em que o Kerio est√° localizado na rede corporativa) </li><li>  Rede de filiais (atr√°s do MikroTik) - 192.168.11.0/24 </li><li>  A rede na qual a rede da filial mapear√° ao conectar-se ao Kerio Control # 1 - 192.168.22.0/24 </li><li>  A rede na qual a rede da filial mapear√° ao conectar-se ao Kerio Control # 2 - 192.168.33.0/24 </li><li>  Endere√ßo IP do pool do ISP # 1 (Kerio # 1) - 11.11.11.111 </li><li>  Endere√ßo IP do pool do ISP # 2 (Kerio # 1) - 22.22.22.111 </li><li>  Endere√ßo IP do pool do ISP # 1 (Kerio # 2) - 11.11.11.222 </li><li>  O endere√ßo IP do pool do ISP # 2 (Kerio # 2) √© 22.22.22.222 </li><li>  Endere√ßo IP do pool do ISP # 3 (MikroTik) - 33.33.33.111 </li><li>  Endere√ßo IP do pool do ISP # 4 (MikroTik) - 44.44.44.111 </li></ol><br>  A primeira coisa a fazer √© ativar o DDNS no MikroTik: <br><br><pre><code class="plaintext hljs">/ip cloud set ddns-enabled=yes</code> </pre> <br>  Devido ao fato de o MikroTik n√£o ter um endere√ßo IP branco est√°tico, o trabalho adicional da configura√ß√£o e dos scripts √© baseado no uso do DDNS. <br><br>  Tamb√©m o IP ---&gt; Cloud √© usado para determinar o endere√ßo IP externo do MikroTik, a partir do qual ele se parece na Internet. <br><br>  Agora vamos configurar o Kerio Control # 1, para que depois n√£o voltemos a ele: <br>  Vamos para a se√ß√£o "Interfaces" e adicionamos a nova interface "VPN tunnel" ... <br><br><div class="spoiler">  <b class="spoiler_title">Configura√ß√£o de t√∫nel no Kerio Control</b> <div class="spoiler_text">  1. No campo nome, atribua um nome √† interface; <br>  2. Coloque o interruptor na posi√ß√£o "Passivo - aceita apenas conex√µes de entrada"; <br>  3. Digite leave "IPSec"; <br>  4. A guia "Autentica√ß√£o": <br><br><ul><li>  4.1 No campo "Chave predefinida:", digite a frase-chave que ser√° usada para conectar; </li><li>  <b>Nota:</b> <br><br>  Eu recomendo categoricamente definir todas as frases-chave em todos os t√∫neis VPN criados em um servidor Kerio espec√≠fico! <br><br>  Isso ocorre pelo fato de o Kerio ter um bug flutuante, que √© expresso a seguir. <br><br>  Imagine que na configura√ß√£o do Kerio, como no meu caso, existem v√°rias interfaces de "t√∫nel da VPN" configuradas para conectar ao MikroTik, que diferem entre si apenas nas configura√ß√µes do campo "Local ID:" (ser√° discutido abaixo). <br><br>  Portanto, ao criar (chamarei assim) um t√∫nel de entrada, independentemente do endere√ßo IP externo que o Kerio contatar o MikroTik, o Kerio (por algum motivo) ativar√° a primeira interface que aparecer, e se o endere√ßo IP especificado nas configura√ß√µes o t√∫nel do lado do Kerio √© diferente daquele ao qual o MikroTik se refere, o t√∫nel n√£o est√° organizado. <br><br>  E no caso em que frases-chave diferentes s√£o indicadas para todos os t√∫neis, esse problema √© interrompido. </li><li>  4.2 No campo ‚ÄúLocal ID:‚Äù, digite o endere√ßo IP do pool de endere√ßos ISP # 1 (no exemplo 11.11.11.111) atribu√≠do √† interface WAN do Kerio Control # 1, √† qual o MikroTik acessar√°; </li><li>  4.3 No campo ‚ÄúRemote ID:‚Äù, digite o FQDN, obtido pelo MikroTik no DDNS (IP ---&gt; Cloud ---&gt; DNS Name).  Essa configura√ß√£o permite que n√£o nos importemos com o modo como o ISP MikroTik acessa o Kerio; </li><li>  4.4 No campo "Cifra de fase 1 (IKE):", selecione aes128-sha1-modp2048 da lista; </li><li>  4.5 No campo "Cifra da fase 2 (ESP):", selecione 3des-sha1-modp2048 da lista; </li><li>  <b>Nota:</b> <br>  Editar as configura√ß√µes padr√£o usadas atrav√©s do bot√£o "Alterar ..."; <br>  Ambas as cifras s√£o selecionadas usando o "m√©todo cient√≠fico de cutucada". </li></ul><br>  5. A guia "Redes remotas": <br><br>  Aqui, inserimos o endere√ßo IP da rede local que o MikroTik usar√° ao se conectar a esse servidor Kerio Control em particular (no exemplo - 192.168.22.0/24). <br>  Importante!  Em todos os outros t√∫neis (no meu caso, √© determinado pelo n√∫mero de ISPs do Kerio) no MikroTik, neste servidor Kerio, o mesmo endere√ßo IP deve ser indicado! <br><br>  Deixe-me lembr√°-lo de que isso se deve √† necessidade de configurar a rota para esta rede a partir da rede da matriz. <br><br>  6. A guia "Redes Locais": <br><br><ul><li>  6.1 Desmarque a caixa "Usar redes locais detectadas automaticamente"; </li><li>  6.2 Defina a caixa de sele√ß√£o "Usar redes personalizadas:" e adicione o endere√ßo de rede "cobrindo" todo o intervalo de endere√ßos usado na rede local atr√°s do Kerio Control √† lista de redes (no exemplo - 192.168.0.0/16). </li></ul><br>  Repetimos todas as etapas acima para o segundo t√∫nel no mesmo servidor Kerio. <br><br>  A segunda configura√ß√£o de t√∫nel ser√° diferente apenas usando uma frase secreta diferente (se√ß√£o 4.1) e um endere√ßo IP externo diferente do pool de endere√ßos do ISP # 2 (se√ß√£o 4.2) (no exemplo, 22.22.22.111). <br><br>  As configura√ß√µes do Kerio Control # 2 s√£o id√™nticas √†s descritas acima, exceto o endere√ßo de rede indicado na guia Redes remotas (p. 5) (no exemplo, 192.168.33.0/24) e, portanto, os endere√ßos IP no campo ID local: Se√ß√£o 4.2), que deve ser selecionada a partir dos endere√ßos IP atribu√≠dos √†s interfaces WAN do Kerio Control # 2 (no exemplo, 11.11.11.222 e 22.22.22.222). <br></div></div><br>  Em seguida, criamos uma regra de permiss√£o para executar ping no Kerio do MikroTik ... <br><br><div class="spoiler">  <b class="spoiler_title">Regra de ping no controle Kerio</b> <div class="spoiler_text">  Vamos para a se√ß√£o "Regras de tr√°fego" e criamos uma nova regra com os seguintes par√¢metros: <br><br><ul><li>  fonte - indica o FQDN que foi recebido pelo nosso MikroTik do DDNS; </li><li>  Destino - Firewall </li><li>  servi√ßo - Ping; </li><li>  Voc√™ tamb√©m pode especificar a vers√£o IP (IPv4), mas isso n√£o √© necess√°rio. </li></ul><br>  N√≥s salvamos a regra com um nome que seja compreens√≠vel para voc√™ e a arrastamos para o topo da lista de regras. <br><br>  Repetimos o mesmo procedimento no segundo servidor Kerio. <br></div></div><br>  N√£o se esque√ßa de registrar as rotas na rede atr√°s do MikroTik em switches ou roteadores no lado da matriz para que a rede da matriz saiba para onde direcionar o tr√°fego (no meu caso, s√£o duas rotas est√°ticas nas redes 192.168.22.0/24 e 192.168.33.0/24). <br><br>  Desde a matriz, fizemos tudo, agora estamos migrando para o MikroTik. <br><br>  Vamos come√ßar criando os objetos de configura√ß√£o b√°sica para organizar e testar o t√∫nel da VPN. <br><br>  O primeiro passo √© criar uma lista de endere√ßos de sub-rede local.  Vamos us√°-lo nas regras do firewall. <br><br><pre> <code class="plaintext hljs">/ip firewall address-list #      MikroTik, # IP-      DHCP add address=192.168.11.0/24 list="Local subnet" #  ,        MikroTik #   VPN-  Kerio Control #1 # (     VPN-  Kerio Control #1, #   " ") add address=192.168.22.0/24 list="Local subnet" #  ,        MikroTik #   VPN-  Kerio Control #2 # (     VPN-  Kerio Control #2, #   " ") add address=192.168.33.0/24 list="Local subnet"</code> </pre> <br>  Em seguida, crie uma regra de permiss√£o para o tr√°fego IKE e coloque-a no topo da lista de regras. <br><br><pre> <code class="plaintext hljs">add action=accept chain=input comment="VPN Allow IKE" dst-port=500 protocol=udp</code> </pre> <br>  Em seguida, adicione duas regras ao filtro de firewall para trabalhar com o tr√°fego VPN ... <br><br><pre> <code class="plaintext hljs">/ip firewall filter add action=accept chain=forward comment="VPN In IpSec" dst-address-list=\ "Local subnet" ipsec-policy=in,ipsec src-address=192.168.0.0/16 \ src-address-list="!Local subnet" add action=accept chain=forward comment="VPN Out" dst-address=192.168.0.0/16 \ dst-address-list="!Local subnet" src-address-list="Local subnet"</code> </pre> <br>  ... e mova-os para uma posi√ß√£o imediatamente <b>acima da regra de queda</b> , que pro√≠be o tr√°fego de entrada de fora da LAN.  Na minha configura√ß√£o padr√£o, foi com o coment√°rio "defconf: solte tudo que n√£o vem da LAN" <br><br>  V√° para o Firewall Mangle e crie as seguintes regras: <br><br><pre> <code class="plaintext hljs">/ip firewall mangle #      , #  ... add action=mark-connection chain=prerouting comment="VPN In" \ new-connection-mark=VPN_conn_in passthrough=no src-address=192.168.0.0/16 \ src-address-list="!Local subnet" # ...   add action=mark-routing chain=output comment="VPN In" connection-mark=\ VPN_conn_in new-routing-mark=VPN_route_in passthrough=yes #     MikroTik      . #     NAT. add action=mark-connection chain=postrouting comment="VPN Out" dst-address=\ 192.168.0.0/16 dst-address-list="!Local subnet" new-connection-mark=\ VPN_conn_out passthrough=no</code> </pre> <br>  Em seguida, observamos no Firewall NAT: <br><br><pre> <code class="plaintext hljs">/ip firewall nat #     MikroTik     #      , #    Kerio- (:  Kerio Control #1 - 192.168.22.0/24,  Kerio Control #2 - 192.168.33.0/24) # ! # comment=KerioVpnNatOut   ! add action=netmap chain=srcnat comment=KerioVpnNatOut connection-mark=\ VPN_conn_out to-addresses=192.168.22.0/24 #     MikroTik     #          MikroTik add action=netmap chain=dstnat comment=KerioVpnNatIn connection-mark=\ VPN_conn_in to-addresses=192.168.11.0/24 #  MikroTik  Kerio- add action=accept chain=srcnat comment=KerioVpnNatPing out-interface-list=WAN protocol=icmp</code> </pre> <br>  <b>Importante!</b>  Essas regras devem ser colocadas acima das regras de mascaramento. <br><br>  Agora vamos para a se√ß√£o IP ---&gt; IPSec, onde precisamos criar uma pol√≠tica, pares, grupos de modelos de pol√≠tica (discutirei seu objetivo posteriormente) e uma proposta para configurar a cifra da fase 2. <br><br><div class="spoiler">  <b class="spoiler_title">proposta ip ipsec</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec proposal add enc-algorithms=3des name=KerioVPNProposal#01 pfs-group=modp2048</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">grupo de pol√≠ticas ip ipsec</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec policy group add name=1 add name=2 add name=3 add name=4</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">ip ipsec peer</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec peer add address=11.11.11.111/32 comment=vs01-i01-01.domain.ru exchange-mode=\ main-l2tp local-address=33.33.33.111 my-id=\ fqdn:mikrotik.sn.mynetname.net policy-template-group=1 profile=\ profile_4 secret=pass1111</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">pol√≠tica ip ipsec</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec policy add comment=KerioVPNPolicy dst-address=192.168.77.0/24 proposal=KerioVPNProposal#01 \ sa-dst-address=11.11.11.111 sa-src-address=33.33.33.111 src-address=\ 192.168.22.0/24 tunnel=yes</code> </pre> <br></div></div><br>  Coment√°rio: <br><br>  1. / proposta ip ipsec - insira os mesmos par√¢metros de criptografia que especificamos ao configurar o Kerio Control no campo "Fase 2 de criptografia (ESP):". <br><br>  <b>Nota:</b> <br><br>  Preste aten√ß√£o no par√¢metro "name = KerioVPNProposal # 01". <br><br>  N√£o √© necess√°rio usar esse nome especificamente, mas se voc√™ decidir usar outro, depois de alter√°-lo, precisar√° verificar e, se necess√°rio, alterar a configura√ß√£o da pol√≠tica IPSec associada, al√©m de alterar o valor atribu√≠do da vari√°vel DefKerioPropName no script scriptCheckActiveVpnServer, que ser√° discutido discurso adicional. <br><br>  (Na verdade, a maioria dos nomes e coment√°rios de objetos na configura√ß√£o descrita √© usada em scripts, portanto, renome√°-los pode causar alguns inconvenientes devido √† necessidade de fazer altera√ß√µes no c√≥digo do script. Tentarei fazer anota√ß√µes apropriadas no texto para facilitar a busca por esses objetos.) <br><br>  2. grupo de pol√≠ticas ipsec / ip <br><br>  A cria√ß√£o de grupos se deve ao fato de que, no futuro, processaremos seus nomes (1, 2, ... n) em scripts e os usaremos para priorizar os endere√ßos IP dos servidores Kerio aos quais acessaremos. <br><br>  Crio quatro grupos ao mesmo tempo.  Eu tenho dois ISPs, com dois IPs externos em cada um do Kerio.  Nesta fase, estamos usando apenas um grupo at√© agora. <br><br>  3. / ip ipsec peer <br><br>  Em pares, especifique: <br><br><ul><li>  Endere√ßo - endere√ßo IP do Kerio, que ser√° contatado com o MikroTik.  O mesmo endere√ßo que inserimos na pol√≠tica / ip ipsec sa-dst-address da pol√≠tica deve ser especificado, apenas com a m√°scara "/ 32"; </li><li>  Endere√ßo Local - Endere√ßo IP do MikroTik, do qual o Kerio ser√° acessado.  O mesmo endere√ßo que inserimos na pol√≠tica ipsec / ip sa-src-address deve ser especificado; </li><li>  Auth.  M√©todo - selecione "chave pr√©-compartilhada" na lista; </li><li>  Modo de troca - selecione main-l2tp na lista; </li><li>  Se definido, desmarque a caixa "Passivo"; </li><li>  Segredo - digite a senha que inserimos quando configuramos a interface VPN no Kerio, na guia "Autentica√ß√£o", no campo "Chave predefinida:"; </li><li>  Grupo de modelos de pol√≠tica - selecione na lista o grupo que criamos anteriormente com o nome "1"; </li><li>  Desmarque NAT Traversal; </li><li>  Meu tipo de ID - selecione o valor "fqdn" na lista; </li><li>  Meu ID - insira o FQDN atribu√≠do pelo MikroTik no DDNS; </li><li>  Na guia "Criptografia", selecione os par√¢metros de criptografia que inserimos quando configuramos a interface VPN no Kerio, na guia "Autentica√ß√£o", no campo "Cifra IKE):"; </li><li>  Coment√°rio ( <b>Aviso! Usado em scripts!</b> ). </li></ul><br>  No coment√°rio, indico o FQDN t√©cnico completo dos meus servidores, publicados nos servidores DNS que atendem √† minha zona externa. <br><br>  Al√©m de usar essa configura√ß√£o, isso me permite manter informa√ß√µes atualizadas sobre os endere√ßos IP externos dos servidores Kerio usados ‚Äã‚Äã(s√≥ preciso alterar o endere√ßo IP no servidor DNS externo e ele ser√° alterado automaticamente para MikroTik (artigo <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a></b> )). <br><br>  Para quem tem pregui√ßa de entender, cito o c√≥digo de trabalho: <br><br><pre> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptSetIPSecSADstAddrFromDNS owner=\ admin policy=read,write</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Listagem de script scriptSetIPSecSADstAddrFromDNS</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">:if ([:len [/system script job find script=SetIPSecSADstAddrFromDNS]]&gt;1) do={ :error } :local DnsNameFromComment :local ResolvedIpFromComment :local ResolvedIpWithMaskFromComment :local IpPeerAddr :foreach IpSecPeerCount in=[/ip ipsec peer find] do={ :set DnsNameFromComment [/ip ipsec peer get $IpSecPeerCount comment] :if ($DnsNameFromComment!="") do={ :do { :set ResolvedIpFromComment [:resolve $DnsNameFromComment] :set ResolvedIpWithMaskFromComment ($ResolvedIpFromComment . "/32") :set IpPeerAddr [/ip ipsec peer get $IpSecPeerCount address] :if ($ResolvedIpWithMaskFromComment!=$IpPeerAddr) do={ :log warning ("[SetIPSecSADstAddrFromDNS]     " . DnsNameFromComment . "  IP-  " . $IpPeerAddr . "  " . $ResolvedIpFromComment) #:log warning ("[SetIPSecSADstAddrFromDNS] In the peer to the server " . DnsNameFromComment . " changed IP address from " . $IpPeerAddr . " on " . $ResolvedIpFromComment) /ip ipsec peer set $IpSecPeerCount address=$ResolvedIpWithMaskFromComment } } on-error={ :set ResolvedIpFromComment "unknown" :log error ("[SetIPSecSADstAddrFromDNS]     " . $DnsNameFromComment) #:log error ("[SetIPSecSADstAddrFromDNS] Cant resolve name " . $DnsNameFromComment) } } } :log warning ("[SetIPSecSADstAddrFromDNS]  IP- VPN- ") #:log warning ("[SetIPSecSADstAddrFromDNS] The IP-addresses of the VPN-servers are checked")</code> </pre><br></div></div><br>  <b>A regra b√°sica que se aplica ao coment√°rio em pares</b> √© que o nome deve come√ßar com qualquer letra e / ou n√∫mero, sem espa√ßos, seguido por um <b>h√≠fen OBRIGAT√ìRIO</b> ("-"), seguido por qualquer n√∫mero de caracteres arbitr√°rios. <br><br>  Eu uso o seguinte formato: <br><br>  vsNN-pNN-NN.domain.ru <br><br>  Onde: <br><br>  vsNN - vpn-server #NN (Esta parte do coment√°rio √© processada em scripts e usada em IP ---&gt; Firewall ---&gt; Address Lists (veja abaixo)); <br>  pNN - ISP #NN; <br>  NN - n√∫mero de s√©rie do endere√ßo IP externo no pool de endere√ßos emitidos para mim pelo provedor no Kerio; <br><br>  4. / ip ipsec policy <br><br>  Na pol√≠tica, definimos: <br><br><ul><li>  Dst.  Endere√ßo - endere√ßo de rede atr√°s do Kerio (endere√ßo dst); </li><li>  Src.  Endere√ßo - o endere√ßo de rede ao qual o MikroTik ir√° mascarar (consulte as configura√ß√µes de IP ---&gt; Firewall ---&gt; NAT abaixo) sua rede local (endere√ßo src).  Este endere√ßo de rede ser√° vis√≠vel do lado do Kerio (n√≥s o especificamos quando configuramos a interface VPN no Kerio, na guia Redes Remotas); </li><li>  Protocolo - 255 (todos); </li><li>  A√ß√£o - criptografar; </li><li>  N√≠vel - requer; </li><li>  Protocolos IPSec - esp; </li><li>  defina o par√¢metro tunnel = yes; </li><li>  SA Src.  Endere√ßo - O endere√ßo IP externo do MikroTik, do qual o Kerio ser√° acessado (sa-src-address); </li><li>  SA Dst.  Endere√ßo - endere√ßo IP do Kerio, para o qual o MikroTik ser√° contatado (sa-dst-address); </li><li>  Proposta - Digite o valor atribu√≠do ao par√¢metro name na se√ß√£o de proposta / ip ipsec (nesta configura√ß√£o - KerioVPNProposal # 01); </li><li>  Coment√°rio ( <b>Aviso! Usado em scripts!</b> ) - KerioVPNPolicy. </li></ul><br>  Se tudo for feito corretamente, depois de salvar a pol√≠tica, o valor "estabelecido" deve aparecer no campo "Estado do PH2", que indica a instala√ß√£o de um canal VPN entre o MikroTik e o Kerio. <br>  Voc√™ pode verificar isso verificando o status da interface VPN no Kerio Control.  L√°, no campo "Informa√ß√µes", em frente √† interface com a qual a conex√£o √© feita, a inscri√ß√£o "Conex√£o com o seu_MikroTik_IP_address √© estabelecida" deve aparecer. <br><br>  Continuamos ... <br><br>  Agora criaremos pares para todos os endere√ßos IP restantes dos servidores Kerio (na minha configura√ß√£o √© necess√°rio criar mais tr√™s pares). <br><br>  Para fazer isso, precisamos repetir todas as etapas indicadas no par√°grafo 3 (/ ip ipsec peer), mas preste aten√ß√£o √†s seguintes altera√ß√µes: <br><br><ul><li>  Endere√ßo - altere o endere√ßo IP do Kerio; </li><li>  Segredo - digite a senha relacionada √† conex√£o que est√° sendo criada (pass2222, pass3333, ... passNNNN); </li><li>  Grupo de modelos de pol√≠tica - selecione o pr√≥ximo grupo da lista (2, 3, ... n). </li></ul><br>  <b>Nota:</b> <br><br>  Em seguida, voc√™ pode alterar a prioridade de seus servidores a qualquer momento, alterando o grupo nas configura√ß√µes de mesmo n√≠vel. <br><br><ul><li>  Coment√°rio - no meu caso, ele muda para outro FQDN do servidor Kerio. </li></ul><br>  Todos os outros par√¢metros s√£o inseridos da mesma forma que no primeiro banquete.  Aqueles que precisar√£o ser alterados s√£o processados ‚Äã‚Äãpor scripts e voc√™ pode copi√°-los inalterados por enquanto. <br><br>  A etapa final da configura√ß√£o antes de conectar os scripts ao trabalho √© fazer o MikroTik funcionar como um reposit√≥rio de constantes, que usaremos nos scripts ... <br>  Adicione duas listas √†s listas de endere√ßos do firewall ( <b>aviso! Usado em scripts!</b> ): <br><br><pre> <code class="plaintext hljs">/ip firewall address-list add address=192.168.22.0/24 list=vs01 add address=192.168.33.0/24 list=vs02</code> </pre> <br>  neles, indicamos os endere√ßos das redes com refer√™ncia aos prefixos de nome do servidor Kerio, nos quais mapearemos o tr√°fego VPN de sa√≠da. <br><br>  Bem, para automatizar o trabalho de toda essa desgra√ßa, adicionamos dois scripts e tr√™s agendas <b>(se voc√™ decidir renomear scripts, n√£o se esque√ßa de fazer as altera√ß√µes apropriadas no c√≥digo)</b> . <br><br><pre> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptFunctionsList owner=admin policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Listagem de script scriptFunctionsList</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">#   IP --&gt; Cloud   DNS- #  : # # $start (true/false); # #  ""  "updated" :global subUpdateCloudDns do={ put ($start); :if ($start=false) do={ set $CloudDnsStatus; #     set $m 1; log warning ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt;  "); #log warning ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; CHECK STARTED"); do { log warning ("[subUpdateCloudDns] ---&gt; DDNS ,  ---&gt; " . $m); [/ip cloud force-update]; delay 30000ms; set $CloudDnsStatus ([/ip cloud get status]); set $m ($m+1); :if ($CloudDnsStatus="updated") do={ log warning ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt; " . $CloudDnsStatus); #log warning ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; " . $CloudDnsStatus); } else={ log error ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt; " . $CloudDnsStatus); #log error ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; " . $CloudDnsStatus); } } while=(($CloudDnsStatus!="updated") and ($m&lt;10)); return ($CloudDnsStatus); } } #    IP --&gt; Cloud #   : # # 0 - ; # 1 - ,   ; # 2 -    :global subCheckCloudDDNS do={ set $CloudDnsActive ([/ip cloud get ddns-enabled]); #  - ( $m=0 ) set $m 0; :if ($CloudDnsActive=yes) do { #  IP---&gt;Cloud  ( $m=1 ) set $m ($m+1); set $CloudDnsStatus ([/ip cloud get status]); #    IP- (  IP---&gt;Cloud    DNS) set $CloudDnsIP ([/ip cloud get public-address]); set $CheckIpAddr ([resolve [/ip cloud get dns-name]]); :if ($CloudDnsIP!=$CheckIpAddr) do={ #  IP  (  MikroTik  )... set $CloudDnsStatus "updating..."; } :if ($CloudDnsStatus="updated") do { #  IP---&gt;Cloud    ( $m=2 ) set $m ($m+1); } } return ($m); } #       #  : # # $ScriptName ( ) :global subRepeatScript do={ put ($ScriptName); :if ($ScriptName!="") do { [/system script run $ScriptName]; } } #     VPN-   # #   IP- VPN-     :global subGetVpnServers do={ #    IP- VPN-        :foreach IpSecPeerId in=[/ip ipsec peer find passive!=yes] do={ set $CheckIpAddr [/ip ipsec peer get $IpSecPeerId address]; :if ($CheckIpAddr!="") do={ set $MaskPos [find $CheckIpAddr "/"]; set $GroupFromPeer ([/ip ipsec peer get $IpSecPeerId policy-template-group]); set $IpFromPeer ([pick $CheckIpAddr 0 $MaskPos]); set $VpnServersList ($VpnServersList, {{$GroupFromPeer; $IpFromPeer}}); } } return ($VpnServersList); } #        # #    ID   :global subDisableIpSecPeers do={ # ...  ,  (passive=false) ... :foreach IpSecPeerId in=[/ip ipsec peer find passive!=yes] do={ log warning ("[IP IPSec Peer] ---&gt;    ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment]); #log warning ("[IP IPSec Peer] ---&gt; processed peer on ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment]); #  address   ... set $CheckIpAddr [/ip ipsec peer get $IpSecPeerId address]; :if ($CheckIpAddr!="") do={ #  address  ,  IP-  ... set $MaskPos ([find $CheckIpAddr "/"]); set $CheckIpAddr ([pick $CheckIpAddr 0 $MaskPos]); # ...   IPSec- :foreach IpSecPolicyId in=[/ip ipsec policy find sa-dst-address=$CheckIpAddr] do={ :if ($IpSecPolicyId!="") do={ :if ([/ip ipsec policy get $IpSecPolicyId disabled]!=yes) do={ [/ip ipsec policy disable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  " . [/ip ipsec policy get $IpSecPolicyId comment] . " "); #log warning ("[IP IPSec Policy] ---&gt; policy " . [/ip ipsec policy get $IpSecPolicyId comment] . " deactivated"); } #    ID     set $IdList ($IdList, $IpSecPolicyId); } } } # :     ,      :if ([/ip ipsec peer get $IpSecPeerId disabled]!=yes) do={ [/ip ipsec peer disable $IpSecPeerId]; log warning ("[IP IPSec Peer] ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment] . " ---&gt; "); #log warning ("[IP IPSec Peer] ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment] . " ---&gt; deactivated"); } } return ($IdList); } #        #  : # # $PeerID (ID   VPN-); # $PolIdList ( ID  $subDisableIpSecPeers); # $CloudIP (IP MikroTik  DDNS); # $SrcIP (src-address    VPN-) :global subEnableIpSecPeers do={ put ($PeerID); put ($PolIdList); put ($CloudIP); :if (($PeerID!="")&amp;&amp;($PeerID!=nil)&amp;&amp;($PolIdList!="")&amp;&amp;($PolIdList!=nil)&amp;&amp;($CloudIP!="")&amp;&amp;($CloudIP!=nil)) do={ #   VPN- set $ActiveVPN [/ip ipsec peer get $PeerID address]; :if ($ActiveVPN!="") do={ #  ,  IP-   set $MaskPos [find $ActiveVPN "/"]; set $ActiveVPN ([pick $ActiveVPN 0 $MaskPos]); } #   ,      :if ([/ip ipsec peer get $PeerID disabled]=yes) do={ delay 5000ms; [/ip ipsec peer enable $PeerID]; log warning ("[IP IPSec Peer] ---&gt;  peer  ---&gt; " . [/ip ipsec peer get $PeerID address]); #log warning ("[IP IPSec Peer] ---&gt; activated peer on ---&gt; " . [/ip ipsec peer get $PeerID address]); } #    ID   PolIdList, ,    Src. Address, SA Src. Address  SA Dst. Address,   :foreach IpSecPolicyId in=$PolIdList do={ :if ($IpSecPolicyId!="") do={ :if ([/ip ipsec policy get $IpSecPolicyId src-address]!=$SrcIP) do={ [/ip ipsec policy set $IpSecPolicyId src-address=$SrcIP]; log warning ("[IP IPSec Policy] ---&gt;  src-address"); #log warning ("[IP IPSec Policy] ---&gt; src-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId sa-src-address]!=$CloudIP) do={ [/ip ipsec policy set $IpSecPolicyId sa-src-address=$CloudIP]; log warning ("[IP IPSec Policy] ---&gt;  sa-src-address"); #log warning ("[IP IPSec Policy] ---&gt; sa-src-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId sa-dst-address]!=$ActiveVPN) do={ [/ip ipsec policy set $IpSecPolicyId sa-dst-address=$ActiveVPN]; log warning ("[IP IPSec Policy] ---&gt;  sa-dst-address"); #log warning ("[IP IPSec Policy] ---&gt; sa-dst-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId disabled]=yes) do={ delay 3000ms; [/ip ipsec policy enable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy activated"); #  DNS- [/ip dns cache flush] } } } } } #      ID  #  : # # $PeerIP (IP    ); # $CloudIP (IP MikroTik  DDNS); # $action (enable/disable/skip) # #    ID,   ,  :global subGetPoliciesByPeer do={ put ($PeerIP); put ($CloudIP); put ($action); :if (($action="")||($action=nil)) do={ set $action "skip"; } :foreach IpSecPolicyId in=[/ip ipsec policy find sa-dst-address=$PeerIP] do={ :if ($IpSecPolicyId!="") do={ #     $action=disable,   :if (([/ip ipsec policy get $IpSecPolicyId disabled]!=yes)&amp;&amp;($action="disable")) do={ [/ip ipsec policy disable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy deactivated"); } #     $CloudIP  sa-src-address!=$CloudIP ( ISP),     sa-src-address :if (($CloudIP!="")&amp;&amp;($CloudIP!=nil)&amp;&amp;([/ip ipsec policy get $IpSecPolicyId sa-src-address]!=$CloudIP)) do={ [/ip ipsec policy disable $IpSecPolicyId]; [/ip ipsec policy set $IpSecPolicyId sa-src-address=$CloudIP]; log warning ("[IP IPSec Policy] ---&gt;   ---&gt;  sa-src-address ---&gt; " . $CloudIP); #log warning ("[IP IPSec Policy] ---&gt; policy deactivated ---&gt; new sa-src-address ---&gt; " . $CloudIP); #   ,  Kerio   delay 30000ms; } #     $action=enable,   :if (([/ip ipsec policy get $IpSecPolicyId disabled]=yes)&amp;&amp;($action="enable")) do={ [/ip ipsec policy enable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy activated"); #  DNS- [/ip dns cache flush] } #    ID     set $IdList ($IdList, $IpSecPolicyId); } } return ($IdList); } #   local-address  #  : # # $PeerID (ID   VPN-); # $CloudIP (IP MikroTik  DDNS) :global subCheckPeerLocalIp do={ put ($PeerID); put ($CloudIP); :if (($PeerID!="")&amp;&amp;($PeerID!=nil)&amp;&amp;($CloudIP!="")&amp;&amp;($CloudIP!=nil)) do={ #   DDNS-IP :if ([/ip ipsec peer get $PeerID local-address]!=$CloudIP) do={ [/ip ipsec peer set $PeerID local-address=$CloudIP]; log warning ("[IP IPSec Peer] ---&gt;  local-address"); #log warning ("[IP IPSec Peer] ---&gt; local-address changed"); } } }</code> </pre> <br></div></div><br><pre> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptCheckActiveVpnServer owner=admin policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon</code> </pre><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listagem de scripts scriptCheckActiveVpnServer</font></font></b> <div class="spoiler_text"><pre> <code class="plaintext hljs">:if ([:len [/system script job find script=scriptCheckActiveVpnServer]]&gt;1) do={ :error } #      scheduleStartup #   ,       :global subCheckCloudDDNS :global subCheckPeerLocalIp :global subDisableIpSecPeers :global subEnableIpSecPeers :global subGetPoliciesByPeer :global subGetVpnServers :global subUpdateCloudDns :local CheckIP :local CheckPeer #     DDNS ( ) :local CloudDnsStatus ([:put [$subCheckCloudDDNS]]) :local Exit false :local DefMikroTikSrcNet 192.168.11.0/24 :local DefKerioDstNet 192.168.77.0/24 :local DefKerioPropName KerioVPNProposal#01 :local DefKerioPolName KerioVPNPolicy :local IpSecPolicyId :local KerioName :local KerioVpnNatRuleName KerioVpnNatOut :local m :local n 1 :local PeerCount 0 :local PeerDisabled :local PingCount 3 :local PingResult :local PoliciesList :local PublicIp :local VpnServersList #   DDNS ,  ,    IP- MikroTik :if ($CloudDnsStatus=0) do={ #  Cloud DDNS  ,         :log error ("[schedule CheckActiveVpnServer] ---&gt;    VPN-   Cloud DDNS! (IP -&gt; Cloud)") # :log error ("[schedule CheckActiveVpnServer] ---&gt; to connect to the VPN server, you need to activate Cloud DDNS! (IP -&gt; Cloud)") :error } :if ($CloudDnsStatus=1) do={ #  Cloud DDNS ,   ,   ( ) :set CloudDnsStatus [:put [$subUpdateCloudDns start=false]] :if ($CloudDnsStatus="updated") do={ :set CloudDnsStatus 2 } } :if ($CloudDnsStatus=2) do { #  Cloud DDNS    ... #  IP  DDNS :set PublicIp [/ip cloud get public-address] #   VPN-  ,    ( ) :set VpnServersList ([:put [$subGetVpnServers]]) #     :foreach VpnIpId in=$VpnServersList do={ :set PeerCount ($PeerCount+1) } #   VPN-    DDNS-IP ( ,   VPN-    ) :while (($Exit!=true)&amp;&amp;$n&lt;=$PeerCount) do={ :foreach VpnIpId in=$VpnServersList do={ #  IP- VPN-    :if (($VpnIpId-&gt;0)=$n) do={ :set CheckIP ($VpnIpId-&gt;1) :if ($CheckIP!="") do={ #    IP :set PingResult ([:put [/ping address=$CheckIP count=$PingCount src-address=$PublicIp]]) :if ($PingResult=$PingCount) do={ :log warning ("[schedule CheckActiveVpnServer] ---&gt; DDNS-IP ---&gt; " . $PublicIp . " ---&gt; VPN-IP ---&gt; " . $CheckIP . " ---&gt; Ping Result ---&gt; " . $PingResult) #  IP ,     IP- :set CheckPeer (:put [/ip ipsec peer find address=($CheckIP . "/32")]) :if ($CheckPeer!="") do={ #   ,     src- (IP ---&gt; Firewall ---&gt; Address Lists),     Kerio #    Kerio    :set KerioName [/ip ipsec peer get $CheckPeer comment] #    (  ,  FQDN  Kerio   KerioName-Parameter1-...-Parameter_n :if ($KerioName!="") do={ #    :set m ([find $KerioName "-"]) #  KerioName    :set KerioName ([pick $KerioName 0 $m]) #    Firewall -&gt; Address List (       : # Name ---&gt; KerioName (eg srv1) # Address ---&gt; DefMikroTikSrcNet (eg 192.168.99.0/24)) :set m [/ip firewall address-list find list=$KerioName] :set DefMikroTikSrcNet ([/ip firewall address-list get $m address]) } # ...          Kerio :set IpSecPolicyId (:put [/ip ipsec policy find comment="$DefKerioPolName"]) #      ,       # (    )         :if ($IpSecPolicyId="") do={ [/ip ipsec policy add disabled=yes dst-address=$DefKerioDstNet proposal=$DefKerioPropName sa-dst-address=$CheckIP sa-src-address=$PublicIp src-address=$DefMikroTikSrcNet tunnel=yes comment=$DefKerioPolName place-before=0] :log warning ("[schedule CheckActiveVpnServer] ---&gt;   " . $DefKerioPolName . " ---&gt;    ") #:log warning ("[schedule CheckActiveVpnServer] ---&gt; created policy " . $DefKerioPolName . " ---&gt; default parameters used") } else={ #   ,     src-address,   . :if ($DefMikroTikSrcNet!=[/ip ipsec policy get $IpSecPolicyId src-address]) do={ [/ip ipsec policy set $IpSecPolicyId src-address=$DefMikroTikSrcNet]; :log warning ("[schedule CheckActiveVpnServer] ---&gt;  " . $DefKerioPolName . "  ---&gt; src-address   ---&gt; " . $DefMikroTikSrcNet) #:log warning ("[schedule CheckActiveVpnServer] ---&gt; policy " . $DefKerioPolName . " changed ---&gt; src-address changed to ---&gt; " . $DefMikroTikSrcNet) } } #   :set m #  NAT-      Kerio  :set m [/ip firewall nat find comment=$KerioVpnNatRuleName] :if ($m!="") do={ #   src-address   ipsec,       Kerio  :if ([/ip firewall nat get $m to-addresses]!=$DefMikroTikSrcNet) do={ [/ip firewall nat set $m to-addresses $DefMikroTikSrcNet] :log warning ("[IP Firewall NAT] ---&gt;    ---&gt; " . $KerioVpnNatRuleName) #:log warning ("[IP Firewall NAT] ---&gt; netmap rule changed ---&gt; " . $KerioVpnNatRuleName) } } # ... local-address      IP MikroTik,    ( ) :put [$subCheckPeerLocalIp PeerID=$CheckPeer CloudIP=$PublicIp] # ...    :set PeerDisabled ([/ip ipsec peer get $CheckPeer disabled]) :if ($PeerDisabled=true) do={ #   ... #       ( ) :set PoliciesList ([:put [$subDisableIpSecPeers]]) #     VPN-   ( ) :put [$subEnableIpSecPeers PeerID=$CheckPeer PolIdList=$PoliciesList CloudIP=$PublicIp SrcIP=$DefMikroTikSrcNet] } else={ #   ... #      ,    ( ) :set PoliciesList ([:put [$subGetPoliciesByPeer PeerIP=$CheckIP CloudIP=$PublicIp SrcIP=$DefMikroTikSrcNet action="enable"]]) } :set Exit true } } else={ :log error ("[schedule CheckActiveVpnServer] ---&gt; DDNS-IP ---&gt; " . $PublicIp . " ---&gt; VPN-IP ---&gt; " . $CheckIP . " ---&gt; Ping Result ---&gt; " . $PingResult) } } } } :set n ($n+1) } }</code> </pre><br></div></div><br><pre> <code class="plaintext hljs">/system scheduler add interval=1h name=scheduleCheckIPSecSADstAddrFromDNS on-event=\ "/system script run scriptSetIPSecSADstAddrFromDNS" policy=read,write \ start-date=oct/30/2017 start-time=00:10:00 add name=scheduleStartup on-event=":global StartupScript true :global RepeatRun false /system script run scriptFunctionsList" policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon \ start-time=startup add interval=5m name=scheduleCheckActiveVpnServer on-event=\ "/system script run scriptCheckActiveVpnServer" policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon \ start-date=nov/29/2017 start-time=00:00:00</code> </pre><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agendar lista de agendamento</font></font></b> <div class="spoiler_text"><pre> <code class="plaintext hljs">:global StartupScript true :global RepeatRun false /system script run scriptFunctionsList</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lista de programa√ß√£o scheduleCheckIPSecSADstAddrFromDNS</font></font></b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/system script run scriptSetIPSecSADstAddrFromDNS</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lista de programa√ß√£o scheduleCheckActiveVpnServer</font></font></b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/system script run scriptCheckActiveVpnServer</code> </pre><br></div></div><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O toque final:</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para que o MikroTik entre em contato corretamente com os servidores DNS da empresa localizados atr√°s do Kerio Control, √© necess√°rio adicionar registros est√°ticos com seus endere√ßos no MikroTik, na se√ß√£o IP ---&gt; DNS ---&gt; Static ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bem, em algum lugar assim! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espero nunca ter cometido um erro e n√£o ter esquecido nada ...</font></font><br><br>  Obrigado pela aten√ß√£o! <br><br>  ps <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hist√≥rico de edi√ß√µes e altera√ß√µes:</font></font></b> <br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Adicionada se√ß√£o ‚ÄúO que obtemos na sa√≠da?:‚Äù; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Um coment√°rio foi adicionado ao endere√ßo de rede da empresa controladora; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Foram alterados os endere√ßos IP das redes dos pools de ISP usados ‚Äã‚Äãna descri√ß√£o da configura√ß√£o; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Adicionado o item "Toque final:"; </font></font></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt439736/">https://habr.com/ru/post/pt439736/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt439726/index.html">Lock-in: verdadeiro ou fic√ß√£o?</a></li>
<li><a href="../pt439728/index.html">Configurar backup e recupera√ß√£o completos e separados do Zimbra OSE sem usar o Zextras</a></li>
<li><a href="../pt439730/index.html">Organiza√ß√£o do redutor atrav√©s de uma classe padr√£o</a></li>
<li><a href="../pt439732/index.html">Lazarus - anima√ß√£o simples usando o componente TImageFragment</a></li>
<li><a href="../pt439734/index.html">Implantando o Kubernetes na √°rea de trabalho em minutos com o MicroK8s</a></li>
<li><a href="../pt439738/index.html">Em busca do bot√£o "Fa√ßa bem". Zyxel na rede de pequenas e m√©dias empresas</a></li>
<li><a href="../pt439742/index.html">Admiss√£o ao programa de mestrado JetBrains na Universidade ITMO</a></li>
<li><a href="../pt439744/index.html">Pesquisadores do MIT projetaram ‚Äúretenas‚Äù que convertem sinais Wi-Fi em eletricidade</a></li>
<li><a href="../pt439746/index.html">Compreendendo as promessas de JavaScript</a></li>
<li><a href="../pt439748/index.html">O resumo de materiais interessantes para o desenvolvedor m√≥vel 285 (de 4 a 10 de fevereiro)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>