<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçâ üôéüèø üèÇüèª Los peligros de optimizaciones incorrectas üîÅ üö≥ üëºüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cuando se trata de optimizar el sistema para obtener el m√°ximo rendimiento, puede ser muy f√°cil cometer errores si aplica imprudentemente las pr√°ctica...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Los peligros de optimizaciones incorrectas</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471906/">  Cuando se trata de optimizar el sistema para obtener el m√°ximo rendimiento, puede ser muy f√°cil cometer errores si aplica imprudentemente las pr√°cticas de otras personas.  Una de estas pr√°cticas es especificar nobarrier al montar sistemas de archivos. <br><br><a name="habracut"></a><h2>  C√≥mo naci√≥ esta nota </h2><br>  Trabajo como ingeniero en Mail.Ru Cloud Solutions y principalmente me ocupo de todo tipo de almacenamiento de bloques "alrededor y alrededor" en el que se encuentran las m√°quinas virtuales de nuestros usuarios, y, en consecuencia, a menudo surgen casos interesantes relacionados con el rendimiento y la estabilidad de las m√°quinas virtuales que se ejecutan en aplicaciones, y especialmente bases de datos. <br><br>  Como regla general, en casi la mitad de los casos durante el "informe" vemos lo mismo: un sistema de archivos montado con la opci√≥n de nobarrier.  Y cuando preguntamos: "¬øpor qu√© escribiste esta opci√≥n?", Casi siempre recibimos una de las opciones de respuesta "Me dijeron que era m√°s r√°pido / le√≠ que era m√°s r√°pido / me prepararon as√≠", despu√©s de lo cual tratamos de explicarlo cort√©s y cuidadosamente. As√≠ que no es necesario.  Por qu√©  Porque este es el primer paso seguro en el camino hacia la p√©rdida de datos. <br><br><h2>  Peque√±a excursi√≥n </h2><br>  Sistema de archivos: la estructura es muy compleja y altamente cargada.  Para garantizar el m√°ximo rendimiento, el almacenamiento en cach√© y la grabaci√≥n paralela se utilizan activamente en el proceso.  En consecuencia, parte de los datos van al cach√© y se descartan siempre que sea posible / necesario o "a pedido".  Una barrera es una operaci√≥n especial para forzar que todas las memorias cach√© se vac√≠en en el disco. <br><br>  Cuando se trata de bases de datos, debemos estar seguros de que la transacci√≥n confirmada al cliente (aplicaci√≥n del cliente) ha sido persistente y no desaparecer√°, por un lado, y por otro lado, los DBMS utilizan activamente su propio almacenamiento en cach√© para lograr el m√°ximo rendimiento, y para garantizar la coherencia, se utiliza el registro en diario: el cambio se escribe en el registro, el registro se "sincroniza" y luego el cambio se escribe en los datos (y cuando se escribe, se almacena en la memoria cach√©).  Cuando el registro est√° lleno, se realiza una sincronizaci√≥n forzada con todos los datos en la memoria cach√© y el registro comienza a llenarse nuevamente. <br><br><h2>  Operaci√≥n de sincronizaci√≥n </h2><br>  Cuando se ejecuta la sincronizaci√≥n, el sistema operativo no solo vac√≠a la memoria cach√© de la p√°gina, sino que por defecto env√≠a un comando para vaciar todas las memorias cach√© de disco (y, posiblemente, lo hace repetidamente), el llamado  <b>rubor</b> .  El funcionamiento de las memorias intermedias de lavado es "costoso" y lleva una cantidad considerable de tiempo, pero es necesario, ya que en los sistemas de archivos el orden de escritura es importante: si se viola, entonces (por ejemplo) puede resultar que durante un reinicio repentino en el archivo habr√° basura en lugar de datos, ya que el dispositivo decidi√≥ reordenar el registro.  Y cuando flush lava a la fuerza todos los cach√©s, esto asegura que primero se escriba lo que est√° antes de flush, y solo luego lo que sucede despu√©s, es decir, se crea una "barrera" que divide las entradas en "antes de la barrera" y "despu√©s de la barrera" (desde aqu√≠ y el nombre "barrera de escritura"), y esto hace posible garantizar que los registros posteriores a la barrera no se aplicar√°n antes que los registros anteriores a la barrera. <br><br><h2>  Efecto Nobarrier </h2><br>  La opci√≥n nobarrier deshabilita el env√≠o de vaciado forzado mientras se ejecuta el sistema de archivos.  Esto lleva al hecho de que los registros se pueden reordenar, y si ocurre una falla, el sistema de archivos (y generalmente los datos en el caso general) pueden ser inconsistentes, recordemos lo que se mencion√≥ en el p√°rrafo anterior sobre el orden de grabaci√≥n. <br><br>  ¬øPor qu√© se incluye esta opci√≥n?  Para los SSD de bajo costo, la operaci√≥n de vaciado es muy costosa; por ejemplo, los SSD de bajo costo (y muchos costosos que se posicionan como "servidores") realizan de 10 a 20 mil operaciones de escritura por segundo sin vaciado, y con el vaciado encendido, caen a 1-2 mil.  En tales casos, nobarrier proporciona un aumento significativo del rendimiento, creando los riesgos para la integridad de los datos descritos anteriormente. <br><br><h2>  Entorno virtual </h2><br>  En el caso de una m√°quina virtual, si, por ejemplo, estamos hablando de la configuraci√≥n cl√°sica de m√°quinas virtuales en un hipervisor Linux, tenemos QEMU, un proceso que en realidad es responsable de emular las E / S para el sistema operativo invitado.  Y lo m√°s importante, si utilizamos discos sin respaldo de archivo en una m√°quina virtual, entonces la cach√© de dicho disco virtual (¬øde repente?) Se encuentra en el espacio del usuario, en el espacio de direcciones del proceso QEMU correspondiente.  Y si este proceso falla, por ejemplo, de acuerdo con SEGFAULT / SIGSEGV, entonces todas sus memorias cach√© morir√°n con √©l.  Un ejemplo de tal controlador de dispositivo de bloque es el controlador RBD (Ceph). <br><br>  E incluso si no usa Ceph pero iSCSI / FC, por ejemplo, el nivel de falla no desaparece, simplemente cambia de QEMU al sistema operativo host (hipervisor).  El hipervisor se cay√≥: su cach√© de p√°gina muri√≥ (esto es cierto para io = 'hilos' en combinaci√≥n con cach√© = 'reescritura' o cach√© = 'inseguro').  Ups <br><br><h2>  s / Cloud / computadora alien√≠gena / g </h2><br>  Cuando su m√°quina virtual se implementa en la nube ... Entonces no sabe c√≥mo est√° configurado el hipervisor, c√≥mo est√° configurada QEMU, qu√© controladores de disco est√°n involucrados, si la cach√© de p√°gina del host funciona, etc., y no puede influir en esto en la gran mayor√≠a de los casos.  E incluso si es su nube, donde sabe todo esto y m√°s o menos lo controla, no es en absoluto un hecho que su hipervisor no se "caiga", enterrando todo el cach√© de datos. <br><br><h2>  Resumen </h2><br>  El uso de nobarrier en la nube significa que es muy probable que ponga sus datos en riesgo.  ¬øEst√° seguro de que desea obtener ganancias de productividad a costa de estos riesgos? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/471906/">https://habr.com/ru/post/471906/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../471886/index.html">VMmanager 6: presentaci√≥n de la caja y comparaci√≥n con la generaci√≥n anterior</a></li>
<li><a href="../471890/index.html">Inferencia variacional: ¬øqu√© es y qu√© come?</a></li>
<li><a href="../471892/index.html">6 historias pr√°cticas de nuestros d√≠as de semana SRE</a></li>
<li><a href="../471896/index.html">El libro de jugadas interior. Funciones de red en el nuevo Ansible Engine 2.9</a></li>
<li><a href="../471904/index.html">Planificador de recursos en HPE InfoSight</a></li>
<li><a href="../471908/index.html">La belleza inesperada de los n√∫meros primos</a></li>
<li><a href="../471912/index.html">Aprender ingl√©s: 7 formas pr√°cticas de ampliar tu vocabulario</a></li>
<li><a href="../471914/index.html">C√≥mo funcionaba el sistema de gr√°ficos Sega Mega Drive: procesador de visualizaci√≥n de video</a></li>
<li><a href="../471918/index.html">SwiftUI: Conocido</a></li>
<li><a href="../471924/index.html">Presentaci√≥n de los m√≥dulos Sass</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>