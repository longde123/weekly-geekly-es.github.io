<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõåüèΩ üôéüèº üë©üèæ‚Äçüè´ C√≥mo conectarse a una VPN corporativa en Linux usando openconnect y vpn-slice üëãüèæ üå∫ ‚§µÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øQuiere usar Linux en el trabajo, pero una VPN corporativa no? Entonces este art√≠culo puede ayudar, aunque esto no es exacto. Quiero advertir de antem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo conectarse a una VPN corporativa en Linux usando openconnect y vpn-slice</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479034/"><p>  ¬øQuiere usar Linux en el trabajo, pero una VPN corporativa no?  Entonces este art√≠culo puede ayudar, aunque esto no es exacto.  Quiero advertir de antemano que entiendo mal los problemas de la administraci√≥n de la red, por lo que es posible que haya hecho todo mal.  Por otro lado, es posible que pueda escribir el manual de manera que sea comprensible para la gente com√∫n, por lo que le aconsejo que lo pruebe. </p><br><p>  El art√≠culo tiene mucha informaci√≥n adicional, pero sin este conocimiento no podr√≠a resolver los problemas que tuve repentinamente con la configuraci√≥n de vpn.  Creo que cualquiera que intente aplicar este manual tendr√° problemas que yo no tuve, y espero que esta informaci√≥n adicional me ayude a resolver estos problemas. </p><br><p>  La mayor√≠a de los comandos utilizados en el manual deben ejecutarse a trav√©s de sudo, que se elimina por brevedad.  Tener en cuenta. </p><br><p>  La mayor√≠a de las direcciones IP se ofuscaron severamente, por lo que si ve una direcci√≥n como 435.435.435.435, deber√≠a haber alguna IP normal espec√≠fica para su caso. </p><br><p>  Tengo Ubuntu 18.04, pero creo que con algunos cambios la gu√≠a se puede aplicar a otras distribuciones.  Sin embargo, en este texto, Linux == Ubuntu. </p><br><h2>  Cisco connect </h2><br><p>  Aquellos que est√°n sentados en Windows o MacOS pueden conectarse a nuestra VPN corporativa a trav√©s de Cisco Connect, que necesita especificar la direcci√≥n de la puerta de enlace e ingresar una contrase√±a cada vez que se conecta, que consta de una parte fija y un c√≥digo generado por Google Authenticator. </p><a name="habracut"></a><br><p>  En el caso de Linux, no fue posible obtener Cisco Connect, pero result√≥ en Google la recomendaci√≥n de usar openconnect, hecho espec√≠ficamente para reemplazar Cisco Connect. </p><br><h2>  Openconnect </h2><br><p>  En teor√≠a, en ubunt hay una interfaz gr√°fica especial para openconnect, pero no funcion√≥ para m√≠.  Quiz√°s sea lo mejor. </p><br><p>  En ubunt openconnect se instala desde el administrador de paquetes. </p><br><pre><code class="plaintext hljs">apt install openconnect</code> </pre> <br><p>  Inmediatamente despu√©s de la instalaci√≥n, puede intentar conectarse a la VPN </p><br><pre> <code class="plaintext hljs">openconnect --user poxvuibr vpn.evilcorp.com</code> </pre> <br><p>  vpn.evilcorp.com es la direcci√≥n VPN ficticia \ <br>  poxvuibr - nombre de usuario ficticio </p><br><p>  openconnect le pedir√° que ingrese una contrase√±a, que, seg√∫n recuerdo, consiste en una parte fija y un c√≥digo de Google Authenticator, y luego intenta conectarse a vpn.  Si result√≥, felicidades, puedes saltarte el medio de forma segura, lo cual es muy doloroso y llegar al punto sobre la conexi√≥n abierta en el fondo.  Si no funciona, puede continuar.  Aunque si result√≥ al conectarse, por ejemplo, desde un Wi-Fi de invitado en el trabajo, es posible alegrarse y temprano, debe intentar repetir el procedimiento desde su casa. </p><br><h2>  Certificado </h2><br><p>  Con alta probabilidad, nada comenzar√°, y el escape de conexi√≥n abierta se ver√° m√°s o menos as√≠: </p><br><pre> <code class="plaintext hljs">POST https://vpn.evilcorp.com/ Connected to 777.777.777.777:443 SSL negotiation with vpn.evilcorp.com Server certificate verify failed: signer not found Certificate from VPN server "vpn.evilcorp.com" failed verification. Reason: signer not found To trust this server in future, perhaps add this to your command line: --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 Enter 'yes' to accept, 'no' to abort; anything else to view: fgets (stdin): Operation now in progress</code> </pre> <br><p>  Por un lado, esto es desagradable, porque no hab√≠a conexi√≥n con la VPN, pero por otro lado, en principio, es comprensible c√≥mo solucionar este problema. </p><br><p>  Luego, el servidor nos envi√≥ un certificado, seg√∫n el cual se puede determinar que la conexi√≥n se realiza con el servidor de la corporaci√≥n nativa, y no con el estafador malicioso, y este certificado es desconocido para el sistema.  Y entonces ella no puede verificar si el servidor real es o no.  Y as√≠, por si acaso, deja de funcionar. </p><br><p>  Para que Openconnect todav√≠a se conecte al servidor, debe indicarle expl√≠citamente qu√© certificado debe provenir del servidor VPN utilizando la clave --servercert </p><br><p>  Y puede averiguar qu√© certificado nos envi√≥ el servidor directamente desde qu√© conexi√≥n abierta imprimi√≥.  Aqu√≠ de esta pieza: </p><br><pre> <code class="plaintext hljs">To trust this server in future, perhaps add this to your command line: --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 Enter 'yes' to accept, 'no' to abort; anything else to view: fgets (stdin): Operation now in progress</code> </pre> <br><p>  Con este comando puedes intentar conectarte nuevamente </p><br><pre> <code class="plaintext hljs">openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr vpn.evilcorp.com</code> </pre> <br><p>  Tal vez est√© funcionando ahora, entonces puedes ir al final.  Pero Ubunta personalmente me mostr√≥ un higo de esta forma </p><br><pre> <code class="plaintext hljs">POST https://vpn.evilcorp.com/ Connected to 777.777.777.777:443 SSL negotiation with vpn.evilcorp.com Server certificate verify failed: signer not found Connected to HTTPS on vpn.evilcorp.com XML POST enabled Please enter your username and password. POST https://vpn.evilcorp.com/ Got CONNECT response: HTTP/1.1 200 OK CSTP connected. DPD 300, Keepalive 30 Set up DTLS failed; using SSL instead Connected as 192.168.333.222, using SSL NOSSSSSHHHHHHHDDDDD 3 NOSSSSSHHHHHHHDDDDD 3 RTNETLINK answers: File exists /etc/resolvconf/update.d/libc: Warning: /etc/resolv.conf is not a symbolic link to /run/resolvconf/resolv.conf</code> </pre> <br><p>  /etc/resolv.conf </p><br><pre> <code class="plaintext hljs"># Generated by NetworkManager search gst.evilcorpguest.com nameserver 127.0.0.53</code> </pre> <br><p>  /run/resolvconf/resolv.conf </p><br><pre> <code class="plaintext hljs"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8) # DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN # 127.0.0.53 is the systemd-resolved stub resolver. # run "systemd-resolve --status" to see details about the actual nameservers. nameserver 192.168.430.534 nameserver 127.0.0.53 search evilcorp.com gst.publicevilcorp.com</code> </pre> <br><p>  habr.com se resolver√°, pero no ser√° posible ingresar all√≠.  Las direcciones como jira.evilcorp.com no se resuelven en absoluto. </p><br><p>  Lo que sucedi√≥ aqu√≠ no est√° claro para m√≠.  Pero el experimento muestra que si agrega la l√≠nea a /etc/resolv.conf </p><br><pre> <code class="plaintext hljs">nameserver 192.168.430.534</code> </pre> <br><p>  entonces las direcciones dentro de la VPN se resolver√°n m√°gicamente y ser√° posible revisarlas, es decir, lo que DNS busca para resolver direcciones se ve en /etc/resolv.conf, y no en otro lugar. </p><br><p>  Que hay una conexi√≥n a la VPN y funciona, puede asegurarse sin cambios en /etc/resolv.conf, para esto es suficiente ingresar en el navegador no el nombre simb√≥lico del recurso de vpn, sino su direcci√≥n IP </p><br><p>  El resultado son dos problemas. </p><br><ul><li>  en la conexi√≥n a VPN su dns no se recoge </li><li>  todo el tr√°fico pasa por vpn, lo que no le permite ir a Internet </li></ul><br><p>  Lo que har√© ahora te lo dir√©, pero primero un poco de automatizaci√≥n. </p><br><h2>  Entrada autom√°tica de la parte fija de la contrase√±a. </h2><br><p>  En el momento actual, lo m√°s probable es que ya haya ingresado la contrase√±a al menos cinco veces y este procedimiento ya lo ha cansado bastante.  En primer lugar, porque la contrase√±a es larga, y en segundo lugar, porque al ingresar, debe mantenerla dentro de un per√≠odo de tiempo fijo </p><br><p>  La soluci√≥n final al problema no se incluy√≥ en el art√≠culo, pero se puede hacer para que la parte fija de la contrase√±a no tenga que ingresarse muchas veces. </p><br><p>  Suponga que la parte fija de la contrase√±a es fixedPassword y parte de Google Authenticator 567 987. La contrase√±a completa de openconnect se puede pasar a trav√©s de la entrada est√°ndar utilizando el argumento --passwd-on-stdin. </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr vpn.evilcorp.com --passwd-on-stdin</code> </pre> <br><p>  Ahora puede volver constantemente al √∫ltimo comando ingresado y cambiar solo una parte de Google Authenticator all√≠. </p><br><h2>  La VPN corporativa no permite el acceso a Internet. </h2><br><p>  En general, no es muy inconveniente cuando para ir a un centro debe usar una computadora separada.  La falta de la capacidad de copiar y pegar con stackoverfow generalmente puede paralizar el trabajo, por lo que hay que hacer algo. </p><br><p>  Es necesario organizarse de alguna manera, de modo que cuando necesite ir al recurso desde la red interna, Linux vaya a vpn, y cuando necesite ir al concentrador, vaya a Internet. </p><br><p>  openconnect despu√©s de iniciar y establecer una conexi√≥n con vpn, ejecuta un script especial, que se encuentra en / usr / share / vpnc-scripts / vpnc-script.  Algunas variables se transfieren al script de entrada, y realiza la configuraci√≥n vpn.  Desafortunadamente, no pude descubrir c√≥mo dividir los flujos de tr√°fico entre la VPN corporativa y el resto de Internet utilizando un script nativo. </p><br><p>  Aparentemente especialmente para personas como yo, se desarroll√≥ la utilidad vpn-slice, que le permite dirigir el tr√°fico a trav√©s de dos canales sin bailar con una pandereta.  Bueno, es decir, tienes que bailar, pero no es necesario un cham√°n. </p><br><h2>  Dividir el tr√°fico con vpn-slice </h2><br><p>  En primer lugar, tendr√° que instalar vpn-slice, deber√° resolverlo usted mismo.  Si hay preguntas en los comentarios, escribir√© una publicaci√≥n separada sobre esto.  Pero este es un programa de Python regular, por lo que no deber√≠a haber dificultades.  Lo configur√© usando virtualenv. </p><br><p>  Y luego necesita usar la utilidad, usando la tecla --script que indica openconnect que en lugar del script est√°ndar necesita usar vpn-slice </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin \ --script "./bin/vpn-slice 192.168.430.0/24 " vpn.evilcorp.com</code> </pre> <br><p>  En --script, se pasa una l√≠nea con el comando a llamar en lugar del script.  ./bin/vpn-slice: ruta al archivo ejecutable vpn-slice 192.168.430.0/24: m√°scara de direcciones que se visitar√°n en vpn.  Aqu√≠, quiero decir que si la direcci√≥n comienza con 192.168.430, entonces el recurso con esta direcci√≥n debe buscarse dentro de vpn </p><br><p>  Ahora la situaci√≥n deber√≠a ser casi normal.  Casi.  Ahora puede iniciar sesi√≥n en el concentrador y puede iniciar sesi√≥n en el recurso corporativo interno por ip, pero no puede iniciar sesi√≥n en el recurso corporativo interno por nombre simb√≥lico.  Si registra la correspondencia del nombre simb√≥lico y la direcci√≥n en los hosts, todo deber√≠a funcionar.  Y trabajar hasta que cambie la ip.  Linux ahora puede ir a Internet o a la red corporativa, dependiendo de la ip.  Pero el DNS no corporativo todav√≠a se usa para determinar la direcci√≥n. </p><br><p>  El problema a√∫n puede manifestarse de esta forma: todo est√° bien en el trabajo y en el hogar puede acceder a los recursos corporativos internos solo por ip.  Esto se debe a que cuando est√° conectado al Wi-Fi corporativo, tambi√©n se usa el DNS corporativo, y en √©l se resuelven las direcciones simb√≥licas de la VPN, aunque todav√≠a es imposible acceder a dicha direcci√≥n sin usar una VPN. </p><br><h2>  Modificaci√≥n autom√°tica del archivo de hosts. </h2><br><p>  Si pregunta cort√©smente vpn-slice, luego de elevar la VPN, puede ir a su DNS, encontrar las direcciones IP de los recursos necesarios all√≠ por sus nombres simb√≥licos e ingresarlos en los hosts.  Una vez que se apaga la VPN, estas direcciones se eliminar√°n de los hosts.  Para hacer esto, pase nombres simb√≥licos a vpn-slice como argumentos.  Ah√≠ tienes. </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Ahora todo deber√≠a funcionar tanto en la oficina como en la playa. </p><br><h2>  Busque direcciones de todos los subdominios en el DNS que le dio la VPN </h2><br><p>  Si hay pocas direcciones dentro de la red, entonces el enfoque de modificar autom√°ticamente el archivo de hosts est√° funcionando bastante bien.  Pero si hay muchos recursos en la red, deber√° agregar constantemente l√≠neas como zoidberg.test.evilcorp.com al script zoidberg, este es el nombre de uno de los bancos de pruebas. </p><br><p>  Pero ahora que tenemos una peque√±a comprensi√≥n de por qu√© esta necesidad puede ser eliminada. </p><br><p>  Si, despu√©s de subir la VPN, mira en / etc / hosts, puedes ver, aqu√≠ hay una l√≠nea </p><br><blockquote>  192.168.430.534 dns0.tun0 # vpn-slice-tun0 AUTOCREADO </blockquote><p>  S√≠, y se agreg√≥ una nueva l√≠nea a resolv.conf.  En resumen, vpn-slice de alguna manera determin√≥ d√≥nde se encuentra el servidor dns para vpn. </p><br><p>  Ahora debemos asegurarnos de que para averiguar la direcci√≥n IP del nombre de dominio que termina en evilcorp.com, Linux fue a dns corporativos, y si se necesita algo m√°s, entonces a los valores predeterminados. </p><br><p>  Busqu√© en Google durante mucho tiempo y descubr√≠ que dicha funcionalidad est√° fuera de la caja.  Esto se refiere a la capacidad de usar el servidor local dns dnsmasq para resolver nombres. </p><br><p>  Es decir, puede hacer que Linux siempre vaya al servidor DNS local para obtener direcciones IP, que a su vez, dependiendo del nombre de dominio, buscar√°n IP en el servidor DNS externo correspondiente. </p><br><p>  Para administrar todo lo relacionado con las redes y las conexiones de red, Ubunt usa NetworkManager, y la interfaz gr√°fica para seleccionar, por ejemplo, una conexi√≥n Wi-Fi est√° al frente. </p><br><p>  Tendremos que subir en su configuraci√≥n. </p><br><ol><li>  Crear archivo en /etc/NetworkManager/dnsmasq.d/evilcorp </li></ol><br><blockquote>  direcci√≥n = /. evilcorp.com/192.168.430.534 </blockquote><p>  Presta atenci√≥n al punto antes de evilcorp.  Indica a dnsmasq que todos los subdominios de evilcorp.com deben buscarse en el dns corporativo. </p><br><ol><li>  Indique a NetworkManager que use dnsmasq para resolver nombres </li></ol><br><p>  La configuraci√≥n del administrador de red se encuentra en /etc/NetworkManager/NetworkManager.conf Debe agregar all√≠: </p><br><blockquote>  [principal] <br>  dns = dnsmasq </blockquote><br><ol><li>  Reiniciar NetworkManager </li></ol><br><pre> <code class="plaintext hljs">service network-manager restart</code> </pre> <br><p>  Ahora, despu√©s de conectarse a una VPN usando un mont√≥n de openconnect y vpn-slice, ip se detectar√° normalmente incluso si no agrega direcciones simb√≥licas a los argumentos de vpnslice. </p><br><h2>  C√≥mo pasar por VPN para separar servicios </h2><br><p>  Despu√©s de que se conect√≥ a vpn, estuve muy contento durante dos d√≠as, y luego result√≥ que si se conecta a VPN no desde la red de la oficina, el correo no funciona.  Un s√≠ntoma familiar, ¬øno? </p><br><p>  Nuestro correo est√° en mail.publicevilcorp.com, lo que significa que no est√° incluido en la regla en dnsmasq y la direcci√≥n del servidor de correo se busca a trav√©s del DNS p√∫blico. </p><br><p>  Bueno, la oficina todav√≠a usa el DNS en el que se encuentra esta direcci√≥n.  Es decir, eso pens√©.  De hecho, despu√©s de agregar una l√≠nea a dnsmasq </p><br><blockquote>  direcci√≥n = / mail.publicevilcorp.com / 192.168.430.534 </blockquote><p>  La situaci√≥n no ha cambiado.  ip se mantuvo igual.  Tuve que ir a trabajar. </p><br><p>  Y solo entonces, cuando profundic√© en la situaci√≥n y resolv√≠ un poco el problema, una persona inteligente me dijo c√≥mo resolverlo.  Era necesario conectarse al servidor de correo no solo as√≠, sino a trav√©s de VPN </p><br><p>  Utilizo vpn-slice para pasar por la VPN a direcciones que comienzan con 192.168.430.  Y en el servidor de correo, no solo la direcci√≥n simb√≥lica no es un subdominio de evilcorp, tambi√©n tiene una direcci√≥n IP que no comienza con 192.168.430.  Y, por supuesto, no deja salir a nadie de la red general. </p><br><p>  Para que Linux pase por la VPN y el servidor de correo, debe agregarlo a vpn-slice.  Supongamos que la direcci√≥n del remitente es 555.555.555.555 </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin --script "./bin/vpn-slice 555.555.555.555 192.168.430.0/24" vpn.evilcorp.com</code> </pre> <br><h2>  Script para generar una VPN con un argumento </h2><br><p>  Todo esto, por supuesto, no es muy conveniente.  S√≠, puede guardar el texto en un archivo y copiarlo y pegarlo en la consola, en lugar de escribir con las manos, pero a√∫n no es lo suficientemente agradable.  Para facilitar el proceso, puede ajustar el comando en un script que se ubicar√° en PATH.  Y luego solo necesita ingresar el c√≥digo obtenido de Google Authenticator </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Si pones el script en connect ~ evilcorp ~ puedes escribir en la consola </p><br><pre> <code class="plaintext hljs">connect_evil_corp 567987</code> </pre> <br><p>  Pero ahora, de todos modos, por alguna raz√≥n, debe mantener abierta la consola en la que OpenConnect se ejecuta </p><br><h2>  Lanzamiento de Openconnect en segundo plano </h2><br><p>  Afortunadamente, los autores de openconnect se encargaron de nosotros y agregaron una clave especial: el fondo del programa, lo que hace que el programa funcione en segundo plano despu√©s del lanzamiento.  Si lo ejecuta de esta manera, luego del inicio puede cerrar la consola </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Ahora no est√° claro a d√≥nde van los registros.  Los registros generalmente no son realmente necesarios para nosotros, pero nunca se sabe.  openconnect puede redirigirlos a syslog, donde se mantendr√°n intactos.  necesita agregar la tecla --syslog al comando </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \</code> </pre> <br><p>  Entonces, resulta que openconnect funciona en alg√∫n lugar en segundo plano y no molesta a nadie, pero no est√° claro c√≥mo detenerlo.  Es decir, puede, por supuesto, filtrar el escape ps con un grep y buscar un proceso en cuyo nombre se encuentre openconnect, pero de alguna manera es triste.  Gracias a los autores que pensaron en esto.  Openconnect tiene la clave --pid-file, con la que puede indicar a openconnect que escriba su ID de proceso en un archivo. </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \ --pid-file ~/vpn-pid</code> </pre> <br><p>  Ahora siempre puedes clavar el proceso con el comando </p><br><pre> <code class="plaintext hljs">kill $(cat ~/vpn-pid)</code> </pre> <br><p>  Si no hay ning√∫n proceso, kill jurar√°, pero no arrojar√° un error.  Si no hay ning√∫n archivo, tampoco suceder√° nada malo, por lo que puede eliminar el proceso de forma segura en la primera l√≠nea del script. </p><br><pre> <code class="plaintext hljs">kill $(cat ~/vpn-pid) #!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \ --pid-file ~/vpn-pid</code> </pre> <br><p>  Ahora puede encender la computadora, abrir la consola y ejecutar el comando, pas√°ndole el c√≥digo de Google Authenticator.  La consola puede ser clavada. </p><br><h1>  Sin vpn-slice.  En lugar de un ep√≠logo </h1><br><p>  Fue muy dif√≠cil entender c√≥mo vivir sin vpn-slice.  Tuve que leer mucho y googlear.  Afortunadamente, cuando pas√© tanto tiempo con el problema, los manuales t√©cnicos e incluso el hombre abierto leyeron como novelas emocionantes. </p><br><p>  Como resultado, descubr√≠ que vpn-slice, como el script nativo, modifica la tabla de enrutamiento para separar las redes. </p><br><h2>  Tabla de enrutamiento </h2><br><p>  En t√©rminos simples, dicha tabla en la primera columna de la cual contiene d√≥nde debe comenzar la direcci√≥n a la que quiere ir Linux, y en la segunda a trav√©s de qu√© adaptador de red ir a esta direcci√≥n.  De hecho, hay m√°s columnas, pero esto no cambia la esencia. </p><br><p>  Para ver la tabla de enrutamiento, debe ejecutar el comando ip route </p><br><pre> <code class="plaintext hljs">default via 192.168.1.1 dev wlp3s0 proto dhcp metric 600 192.168.430.0/24 dev tun0 scope link 192.168.1.0/24 dev wlp3s0 proto kernel scope link src 192.168.1.534 metric 600 192.168.430.534 dev tun0 scope link</code> </pre> <br><p>  Aqu√≠, cada l√≠nea es responsable de d√≥nde ir para enviar un mensaje a alguna direcci√≥n.  La primera es una descripci√≥n de d√≥nde debe comenzar la direcci√≥n.  Para comprender c√≥mo determinar que 192.168.0.0/16 significa que la direcci√≥n debe comenzar con 192.168, debe buscar en Google cu√°l es la m√°scara de la direcci√≥n IP.  Despu√©s de dev es el nombre del adaptador al que se debe enviar el mensaje. </p><br><p>  Para VPN, Linux cre√≥ un adaptador virtual: tun0.  Para que el tr√°fico de todas las direcciones que comienzan con 192.168 lo atraviesen, la l√≠nea responde </p><br><pre> <code class="plaintext hljs">192.168.0.0/16 dev tun0 scope link</code> </pre> <br><p>  Tambi√©n puede ver el estado actual de la tabla de enrutamiento utilizando el comando <strong>route -n</strong> (las direcciones IP son an√≥nimamente talentosas) Este comando produce resultados en una forma diferente y en general est√° en desuso, pero su escape a menudo se encuentra en los manuales en l√≠nea y necesita poder leerlo. </p><br><p>  La direcci√≥n IP de la ruta debe comenzar por la combinaci√≥n de las columnas Destino y Genmask.  Se tienen en cuenta aquellas partes de la direcci√≥n IP a las que corresponden los n√∫meros 255 en Genmask, y aquellas en las que 0 no lo es.  Es decir, la combinaci√≥n de Destination 192.168.0.0 y Genmask 255.255.255.0 significa que si la direcci√≥n comienza con 192.168.0, entonces una solicitud ir√° por esta ruta.  Y si el Destino es 192.168.0.0 pero Genmask es 255.255.0.0, las solicitudes a direcciones que comiencen con 192.168 ir√°n por esta ruta </p><br><p>  Para averiguar qu√© hace realmente vpn-slice, decid√≠ mirar el estado de las tablas antes y despu√©s </p><br><h2>  Antes de encender la VPN, era as√≠ </h2><br><pre> <code class="plaintext hljs">route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0</code> </pre> <br><h2>  Despu√©s de llamar a openconnect sin vpn-slice se volvi√≥ tan </h2><br><pre> <code class="plaintext hljs">route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 0.0.0.0 0.0.0.0 U 0 0 0 tun0 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0 192.168.430.0 0.0.0.0 255.255.255.0 U 0 0 0 tun0 192.168.430.534 0.0.0.0 255.255.255.255 UH 0 0 0 tun0</code> </pre> <br><h2>  Y despu√©s de llamar a openconnect en combinaci√≥n con vpn-slice como este </h2><br><pre> <code class="plaintext hljs">Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0 192.168.430.0 0.0.0.0 255.255.255.0 U 0 0 0 tun0 192.168.430.534 0.0.0.0 255.255.255.255 UH 0 0 0 tun0</code> </pre> <br><p>  Se puede ver que si no usa vpn-slice, openconnect escribe expl√≠citamente que debe pasar por vpn a todas las direcciones, excepto que se indique por separado. </p><br><p>  Aqu√≠: </p><br><pre> <code class="plaintext hljs">0.0.0.0 0.0.0.0 0.0.0.0 U 0 0 0 tun0</code> </pre> <br><p>  Cerca de all√≠, inmediatamente se indic√≥ otra ruta que deber√≠a usarse si la direcci√≥n por la que Linux intenta pasar no coincide con ninguna m√°scara de la tabla. </p><br><pre> <code class="plaintext hljs">0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0</code> </pre> <br><p>  Ya se ha escrito aqu√≠ que, en este caso, debe pasar por el adaptador Wi-Fi est√°ndar. </p><br><p>  Creo que la ruta para la VPN se usa porque es la primera en la tabla de enrutamiento. </p><br><p>  Y, en teor√≠a, si elimina esta ruta predeterminada de la tabla de enrutamiento, junto con dnsmasq openconnect deber√≠a garantizar un funcionamiento normal. </p><br><p>  Lo intent√© </p><br><pre> <code class="plaintext hljs">route del default</code> </pre> <br><p>  Y funcion√≥. </p><br><h2>  Enrutamiento de solicitudes a un servidor de correo sin vpn-slice </h2><br><p>  Pero tambi√©n tengo un servidor de correo con la direcci√≥n 555.555.555.555, que tambi√©n debe pasar por vpn.  La ruta a ella tambi√©n debe agregarse a mano. </p><br><pre> <code class="plaintext hljs">ip route add 555.555.555.555 via dev tun0</code> </pre> <br><p>  Y ahora todas las reglas.  Entonces puede prescindir de vpn-slice, pero ya necesita saber bien lo que est√° haciendo.  Ahora estoy pensando en agregar la eliminaci√≥n de la ruta predeterminada y agregar la ruta para el correo despu√©s de conectarme a vpn a la √∫ltima l√≠nea del script nativo openconnect, solo para reducir el n√∫mero de partes m√≥viles en mi bicicleta. </p><br><p>  Probablemente, alguien con el fin de comprender c√≥mo configurar una VPN tendr√≠a suficiente de este ep√≠logo.  Pero mientras intentaba entender qu√© y c√≥mo hacerlo, le√≠ muchos de esos manuales que funcionan para el autor, pero por alguna raz√≥n no funcionan para m√≠ y decid√≠ agregar aqu√≠ todas las piezas que encontr√©.  Estar√≠a muy feliz con algo as√≠. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/479034/">https://habr.com/ru/post/479034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../479012/index.html">SviMik: "Hay dos opiniones opuestas sobre esto en OSM"</a></li>
<li><a href="../479018/index.html">Docker para el front-end. Parte 2. ¬øQu√© eres?</a></li>
<li><a href="../479020/index.html">La historia de c√≥mo Google Play tach√≥ diez a√±os de mi trabajo en una hora</a></li>
<li><a href="../479022/index.html">Los televisores inteligentes Samsung, LG, Vizio y TCL toman cada segundo "huellas digitales" de la pantalla y las env√≠an al servidor</a></li>
<li><a href="../479026/index.html">Verdadera suma de canales de Internet - OpenMPTCPRouter</a></li>
<li><a href="../479036/index.html">Intel no puede hacer frente a la demanda de procesadores. HP y Dell sufren como resultado</a></li>
<li><a href="../479038/index.html">Transformaci√≥n digital Leroy Merlin: dise√±o de una interfaz para trabajar con llamadas de clientes</a></li>
<li><a href="../479040/index.html">Pruebas de regresi√≥n visual. Reiniciar</a></li>
<li><a href="../479042/index.html">El m√©todo Y es una forma realmente f√°cil de construir un cubo de Rubik</a></li>
<li><a href="../479044/index.html">Mi implementaci√≥n de buffer de anillo en flash NOR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>