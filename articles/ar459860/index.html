<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📺 😠 🏮 تكوين ClickHouse لاختبار التكامل في gitlab-ci 🚫 👩🏼‍✈️ 🏞️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="كان لدينا خدمة على golang ، و kafka ذو موضوع منفصل ، و clickhouse ، و gitlab-ci ، و payline ، و ssh-key الفاسد وهذا كل شيء ، إلى جانب موسم العطلات ، و...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>تكوين ClickHouse لاختبار التكامل في gitlab-ci</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459860/" style=";text-align:right;direction:rtl"> كان لدينا خدمة على golang ، و kafka ذو موضوع منفصل ، و clickhouse ، و gitlab-ci ، و payline ، و ssh-key الفاسد وهذا كل شيء ، إلى جانب موسم العطلات ، والأمطار الرهيبة في المدينة ، وجهاز كمبيوتر محمول مكسور ، والتنبيهات في الليل ، وبيع الساخنة .  ليس أن كل هذا كان ضروريًا لهذا المقال ، ولكن بمجرد إظهار الحياة اليومية المعتادة للاختبار ، ثم انتقل في نيتك إلى النهاية.  الشيء الوحيد الذي أزعجني هو p0.  في العالم لا يوجد شيء أكثر يأسًا ، أو كآبة ، أو كآبة ، أكثر من الفاحص الذي فاته على المنتج.  لكنني علمت أنه قريباً جداً سأغوص فيه. <br><a name="habracut"></a><br><h3 style=";text-align:right;direction:rtl">  لماذا كل هذا؟ </h3><br>  هناك حزمة مشتركة من الخدمات - الخدمة نفسها التي تقوم بشيء ما - وقاعدة بيانات مكتوبة فيها هذه النتائج.  يحدث هذا في بعض الأحيان بشكل مباشر ، أي "قاعدة الخدمة".  في حالتي ، يحدث التسجيل من خلال وسيط ، أي "قائمة انتظار الخدمة - القاعدة". <br><br>  في المجموع ، هناك العديد من العناصر ، وحدود هذه العناصر - إخراج أحدها ومدخلات الآخر - هو المكان الذي تظهر فيه المشاكل.  انهم ببساطة لا يمكن أن تظهر هناك. <br><br>  مثال حي: في الخدمة ، تتم معالجة حقل السعر كـ float32 ، في قاعدة البيانات تم تكوينه على أنه رقم عشري (18 ، 5) ، نحن نطعم القيمة القصوى لـ float32 كحالة اختبار من إخراج الخدمة إلى قاعدة البيانات - أوه ، لا تستجيب قاعدة البيانات.  أو مثال أكثر حزينًا - قاعدة البيانات لا تتعطل ، ولكن لا يوجد خطأ في سجلات البيانات في قاعدة البيانات.  انها مجرد أن قاعدة البيانات لم تعد تصب.  أو يمر التسجيل ، ولكن مع فقد البيانات أو تشويه: يخرج الحقل من الخدمة كـ float64 ، ويتم تسجيله كـ float32. <br><br>  أو أثناء عملية دورة حياة الخدمة ، قرروا أنه من الضروري تغيير نوع هذا الحقل أو هذا الحقل.  تم تنفيذ الحقل منذ فترة طويلة على المنتج ، لكن من الضروري تعديله هنا.  وبالطبع قمنا بتغييره في مكان واحد فقط.  هوبا ، حدث خطأ ما مرة أخرى. <br><br><h3 style=";text-align:right;direction:rtl">  مهمة </h3><br>  لا أريد تتبع كل هذه التغييرات.  أريد أن لا تسقط.  أريد أن يذهب التسجيل إلى اليمين. <br><br>  خروج: اختبارات التكامل! <br><br><h3 style=";text-align:right;direction:rtl">  التنفيذ والصعوبات </h3><br><h4 style=";text-align:right;direction:rtl">  أين تنكسر؟ </h4><br>  هناك بيئة مطورة: غير مستقرة بشكل كبير وعادة ما تستخدم من قبل المطورين كصندوق رمل.  هناك فوضى وخاصية الفوضى من الصعب الخلفية. <br><br>  هناك بيئة اختبار أو موقف qa: يتم ضبطها بشكل أفضل ، حتى أن المطورين يراقبونها ، ولكن إلى أن تركلهم ، لن يحدث شيء.  وغالبا ما يتم تحديث هذه البيئة.  وحتى في كثير من الأحيان ، يتم كسر شيء هناك. <br><br>  وهناك همز - قدس الأقداس: من الأفضل عدم دفع أي شيء كهذا عليه.  اختبارات التكامل تشير إلى احتمال وجود خطأ يجب أن يعثروا عليه قبل وصوله إلى المنتج. <br><br>  فما الذي يجب فعله بالبيئة عندما تكون غير مستقرة أو قتالية؟  هذا صحيح ، اصنع بنفسك! <br><br><h4 style=";text-align:right;direction:rtl">  ماذا تفعل مع القاعدة؟ </h4><br>  يمكن إطلاق قاعدة البيانات بعدة طرق. <br><br>  كما ناقشنا أعلاه ، لن نقوم بالاتصال بالقاعدة الحقيقية لهذه البيئة أو تلك. <br><br>  أولاً ، يمكنك رفع خادم <s>crolick</s> clickhouse-server بالإعدادات اللازمة ، وطرح sql اللازمة عليه والتواصل معه عبر clickhouse-client.  في أول محاولة ناجحة لوضع قاعدة مماثلة ، كان سي حزينًا.  تومض الاختبارات ، لم يخرج الخادم واستمر في العمل.  دعنا نقول فقط ، لا يزال لغزا بالنسبة لي لماذا بدأت حتى.  (هو نفسه ، ليس لدي أي شيء لتفعله حيال ذلك).  أنا لا أوصي بهذا الخيار. <br><br>  خيار مناسب خارج المربع هو استخدام <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">صورة عامل ميناء</a> . <br>  قم بتنزيل النسخة المطلوبة لسيارتك.  يحتاج Clickhouse إلى config.xml مع بدء الإعدادات.  مزيد من التفاصيل <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">هنا</a> <br>  بالنسبة إلى صورة النقر التي تمت إعادة استخدامها ، يلزمك إنشاء dockerfile الصحيح.  نشير فيه إلى أننا نريد نسخ config.xl إلى المجلد ، ونحن نرتب التكوينات الأخرى المطلوبة.  تأكد من نسخ البرامج النصية لنشر قاعدتك. <br><br>  نظرًا لأننا سنصل إلى الصورة من الخارج ، نحتاج إلى فتح المنافذ التي سنتواصل من خلالها مع clicklick.  انقر فوق العمل على 8123 على http و 9000 على tcp. <br><br>  نحصل على dockerfile التالية: <br><br><pre style=";text-align:right;direction:rtl"><code class="plaintext hljs">From yandex/clickhouse-server Expose 8123 Expose 9000 Add config.xml /etc/clickhouse-server/config.xml Add my_init_script.sql /docker-entrypoint-initdb.d/</code> </pre> <br><h4 style=";text-align:right;direction:rtl">  كيفية رمي صورة في ci؟ </h4><br>  للعمل بطريقة أو بأخرى مع صورة عامل النقل في ci ، تحتاج إلى تسميتها بطريقة ما هناك. <br><br>  يمكنك الالتزام وتشغيل الصورة في المستودع الخاص بك وتشغيل عامل التشغيل باستخدام المعلمات الضرورية كجزء من إجراء الاختبارات.  هنا فقط تزن صورة عامل ميناء النقرة تحت 350 ميجابايت.  من غير المناسب الاحتفاظ بهذه الملفات في مكانها الصحيح. <br><br>  بالإضافة إلى ذلك ، إذا كانت هناك حاجة إلى نفس صورة عامل الإرساء في مشاريع مختلفة (على سبيل المثال ، تتم كتابة خدمات مختلفة إلى نفس قاعدة البيانات) ، ثم لا يجب عليك القيام بذلك.  يمكنك استخدام التخزين صورة <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">التسجيل عامل ميناء</a> <br>  نحن نعتقد أنه في مشروعنا موجود بالفعل ويستخدم.  لذلك ، تسجيل الدخول ، وجمع صورة عامل ميناء ودفعها هناك. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">docker build -t my_clickhouse_image . docker login my_registry_path.domain.com docker push my_clickhouse_image</code> </pre><br>  طار وصورتنا في التسجيل.  تأكد من تحديد العلامة أثناء التجميع! <br><br>  القاعدة جاهزة. <br><br>  قراءة المزيد عن التسجيل <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">هنا</a> <br><br><h4 style=";text-align:right;direction:rtl">  ماذا تفعل مع CI؟ </h4><br>  كيف تطلق خدمتك وقاعدة بياناتك في خطوة واحدة؟ <br><br>  كل هذا يتوقف على كيفية بدء الخدمة واستخدامها.  إذا كنت تعمل مع الخدمة كما هو الحال مع صورة عامل ميناء ، وبالفعل .gitlab-ci.yml يعمل فقط معهم ، فكل شيء بسيط. <br>  هناك ضالة طائشة - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">عامل ميناء في الميناء</a> .  يشار إلى أنه يعمل مع خدمة ci الرئيسية ، ويسمح لك باستخدام عامل النقل بالكامل وعدم الضغط على الإطلاق. <br><br>  نقوم بضخ أحدث صورة ، ونضيف خطوة الاختبار المطلوبة إلى المراحل ، ونصف تسلسل الإجراءات لدينا. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">image: docker:stable services: - docker:dind stages: - build … - test-click ... - test - release … test-click: variables: VERY_IMPORTANT_VARIABLE: “its value” before_script: - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY script: - docker pull My_Service_Image - docker pull My_ClickHouse_Image - docker run -FLAGS My_ClickHouse_Image - docker run My_Service_Image /path/to/tests</code> </pre><br>  يوضح عامل الميناء الرسمي أنه لا ينصح باستخدام <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">dind</a> ، ولكن إذا كنت بحاجة حقًا إلى ... <br><br>  في مشروعي ، يجب اختبار الخدمة من خلال إطلاق الثنائي.  هذا هو المكان الذي يبدأ السحر. <br>  للقيام بذلك ، استخدم قاعدة البيانات كخدمة.  تشير وثائق gitlab-ci الرسمية إلى استخدام الحاوية ذات القاعدة <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">كمثال</a> لحالة الاستخدام الأكثر شيوعًا لحاوية الإرساء في ci.  يتم توفير <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">أمثلة على</a> إعدادات mysql و postress و redis.  لكننا لا نبحث عن طرق سهلة ، نحن بحاجة إلى النقر. <br><br>  ربط القاعدة!  تأكد من تحديد الاسم المستعار.  إذا لم يتم تحديد ذلك ، فسيتم تخصيص اسم عشوائي وعنوان IP عشوائي للقاعدة.  وهذا يعني أنه لن يكون من الواضح بالضبط كيفية الوصول إليه.  لن تكون هناك مشكلة من هذا القبيل مع الاسم المستعار - في رمز الاختبار ، ستبدو المكالمة ، على سبيل المثال ، بواسطة <code>http://my_alias_name:8123</code> . <br><br>  للاختبارات ، لا تزال هناك حاجة إلى صورة من قاعدة البيانات ، والتي وضعناها بعناية في السجل.  لتنزيل الصورة ، تحتاج إلى القيام بتسجيل الدخول إلى عامل ميناء وسحب عامل ميناء ، فقط ci لا يعرف ما هو عامل ميناء - تحتاج إلى تثبيته. <br><br>  الكود الناتج للخطوة في gitlab-ci.yml: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Integration tests: Services: - name: my_clickhouse:latest alias: clicktest Stage: tests Variables: Variables_for_my_service: “value” Before_script: - curl -ssl https://get.docker.com/ | sh - docker login -u gitlab-ci-token -p $ci_build_token my_registry_path.domain.com Script: - ./bin/my_service &amp; - go test -v ./tests -tags=integration Dependencies: - build</code> </pre><br><h3 style=";text-align:right;direction:rtl">  ربح </h3><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  لدي مجموعة من قاعدة العمل. </li><li style=";text-align:right;direction:rtl">  كجزء من الاختبار التلقائي ، من السهل الوصول إلى قاعدة البيانات - ببساطة عن طريق الاسم المستعار. </li><li style=";text-align:right;direction:rtl">  أقوم بإعادة تعيين سجلات وإعدادات قاعدة البيانات كجزء من اختبار الإعداد ، وأتصل بالخدمة ، وكتب إلى قاعدة البيانات ، وأتجه إلى قاعدة البيانات ، وأرى أن قاعدة البيانات لم تسقط ، وأرى ما وصل ، وأنا أتحقق.  رمي المزيد من الاختبارات. </li><li style=";text-align:right;direction:rtl">  لا يمكنك اختبار مع الأقلام! </li></ul><br><h3 style=";text-align:right;direction:rtl">  النتائج </h3><br>  يبدو أن بضعة أسطر من الإعداد في gitlab-ci.  بناء صورة عامل ميناء أمر سهل.  تشغيل محليا بسيط.  حصلت على التكامل مع الاختبارات الأولى التي وجدت مشاكل في يوم واحد.  لكن محاولات إطلاقها على ci تحولت إلى أسبوع من الألم واليأس.  والآن ، في أسابيع الألم واليأس للمطورين الذين يضطرون لإصلاح كل شيء قاموا ببرمجته هناك. <br><br><h3 style=";text-align:right;direction:rtl">  ماذا نجحنا في فعله؟ </h3><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  أنشأنا حاوية مع clickhouse. </li><li style=";text-align:right;direction:rtl">  بدأنا الحاوية في التخزين المحلي. </li><li style=";text-align:right;direction:rtl">  لقد تعلمنا سحب هذه الصورة إلى الخطوة ci. </li><li style=";text-align:right;direction:rtl">  بدأت في عداء. </li></ul><br>  إرسال البيانات بسهولة إلى قاعدة البيانات والوصول إليها من الاختبار. <br><br>  الأتمتة هي طريقة بسيطة للتخلص من روتين التكامل الثاقب يدويًا. <br><br>  من المهم الانتباه إلى: تأكد من أن أنواع الإدخال للقاعدة تتوافق مع أنواع مخرجات الرابط السابق.  (والوثائق <s>، إن وجدت</s> ). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar459860/">https://habr.com/ru/post/ar459860/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar459842/index.html">الأقصر</a></li>
<li><a href="../ar459844/index.html">البطريق في النافذة: على إمكانات وآفاق WSL2</a></li>
<li><a href="../ar459850/index.html">تكنولوجيا راديو الهواة: كيف طلبت تركيب لوحة دوائر مطبوعة في مصنع صيني</a></li>
<li><a href="../ar459852/index.html">ممارسة استخدام مكتبة lottie في تطبيق البنك المحمول</a></li>
<li><a href="../ar459858/index.html">استكشاف البرامج الضارة الحديثة سيربيروس لالروبوت</a></li>
<li><a href="../ar459862/index.html">بيركلي DB STL واجهة</a></li>
<li><a href="../ar459866/index.html">حل المشاكل مع pwnable.kr 02 - تصادم. تجزئة الاصطدام</a></li>
<li><a href="../ar459870/index.html">مثال بنية طراز - عرض - تحديث في F #</a></li>
<li><a href="../ar459872/index.html">باتون جيف. قصص مخصصة. فن تطوير البرمجيات رشيقة</a></li>
<li><a href="../ar459874/index.html">لديك شيء تخفيه</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>