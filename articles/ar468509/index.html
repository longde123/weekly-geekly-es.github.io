<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ½ ğŸ¢ ğŸ‘¨ğŸ¿â€ğŸ­ ØªØ·ÙˆÙŠØ± Ù†Ø¸Ø§Ù… ØªØ´ØºÙŠÙ„ Unix-like - Ø¨Ø±Ø§Ù…Ø¬ ØªØ´ØºÙŠÙ„ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø­Ø±Ù (8) â›¹ğŸ¿ ğŸ‘¸ ğŸˆšï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ÙÙŠ Ø§Ù„Ù…Ù‚Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ØŒ Ù‚Ø¯Ù…Ù†Ø§ â€‹â€‹ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù…. Ø§Ù„ÙŠÙˆÙ… Ø­Ø§Ù† Ø§Ù„ÙˆÙ‚Øª Ù„Ù„Ù†Ø¸Ø± ÙÙŠ Ù…ÙˆØ¶ÙˆØ¹ Ø¨Ø±Ø§Ù…Ø¬ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©. 

 Ø¹Ù„Ù‰ ÙˆØ¬Ù‡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø§Ù„ÙŠÙˆÙ… Ø¨ÙƒØªØ§Ø¨Ø© Ø¨Ø±Ù†Ø§Ù…Ø¬ Øª...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ØªØ·ÙˆÙŠØ± Ù†Ø¸Ø§Ù… ØªØ´ØºÙŠÙ„ Unix-like - Ø¨Ø±Ø§Ù…Ø¬ ØªØ´ØºÙŠÙ„ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø­Ø±Ù (8)</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468509/" style=";text-align:right;direction:rtl">  ÙÙŠ Ø§Ù„Ù…Ù‚Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ØŒ Ù‚Ø¯Ù…Ù†Ø§ â€‹â€‹ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù….  Ø§Ù„ÙŠÙˆÙ… Ø­Ø§Ù† Ø§Ù„ÙˆÙ‚Øª Ù„Ù„Ù†Ø¸Ø± ÙÙŠ Ù…ÙˆØ¶ÙˆØ¹ Ø¨Ø±Ø§Ù…Ø¬ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©. <br><br>  Ø¹Ù„Ù‰ ÙˆØ¬Ù‡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø§Ù„ÙŠÙˆÙ… Ø¨ÙƒØªØ§Ø¨Ø© Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ´ØºÙŠÙ„ Ø·Ø±ÙÙŠ ØŒ ÙˆÙ‡Ùˆ Ø¢Ù„ÙŠØ© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¤Ø¬Ù„Ø© Ù„Ù„Ù…Ù‚Ø§Ø·Ø¹Ø§Øª ØŒ ÙˆÙ†Ù†Ø¸Ø± ÙÙŠ Ù…ÙˆØ¶ÙˆØ¹ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ù†ØµÙÙŠ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø§Øª Ø§Ù„Ø¹Ù„ÙŠØ§ ÙˆØ§Ù„Ø³ÙÙ„Ù‰ Ù…Ù† Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø§Øª. <br><br>  Ù†Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² ØŒ Ø«Ù… ØªÙ‚Ø¯ÙŠÙ… Ø¯Ø¹Ù… I / O Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ØŒ ÙˆØ§Ù„Ù†Ø¸Ø± ÙÙŠ Ù‡ÙŠÙƒÙ„ ÙˆÙˆØ¸Ø§Ø¦Ù io_buf Ù„Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† stdio.h. <br><a name="habracut"></a><br><h4 style=";text-align:right;direction:rtl">  Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª </h4><br>  Ø¨Ù†Ø§Ø¡ Ù†Ø¸Ø§Ù… (Ø¬Ø¹Ù„ ØŒ Ù…Ø¬Ù„Ø³ Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠ ØŒ Ø§Ù„ØºØ§Ø²).  Ø§Ù„ØªÙ…Ù‡ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ (Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ØªÙ…Ù‡ÙŠØ¯).  Ø¥Ø·Ù„Ø§Ù‚ (qemu).  Ù…ÙƒØªØ¨Ø© C (strcpy ØŒ memcpy ØŒ strext).  Ù…ÙƒØªØ¨Ø© C (sprintf ØŒ strcpy ØŒ strcmp ØŒ strtok ØŒ va_list ...).  Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙÙŠ ÙˆØ¶Ø¹ kernel ÙˆÙˆØ¶Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….  Ø³Ø¬Ù„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†ÙˆØ§Ø©.  Ø°Ø§ÙƒØ±Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ  Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø·Ø© (kprintf ØŒ kpanic ØŒ kassert).  Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ØŒ Ø§Ù„ÙƒÙˆÙ…Ø© (kmalloc ØŒ kfree).  ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø© (GDT ØŒ IDT ØŒ PIC ØŒ syscall).  Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª.  Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±ÙŠØ© (Ø¯Ù„ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙØ­Ø©).  Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.  Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„.  ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù….  Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (Ø§Ù„Ù‚ØªÙ„ ØŒ Ø§Ù„Ø®Ø±ÙˆØ¬ ØŒ Ù…Ù„Ø§Ø­Ø¸Ø©). <br><br>  <b>Ø¨Ø±Ø§Ù…Ø¬ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©.</b>  <b>Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (ioctl ØŒ fopen ØŒ fread ØŒ fwrite).</b>  <b>Ù…ÙƒØªØ¨Ø© C (fopen ØŒ fclose ØŒ fprintf ØŒ fscanf).</b> <br><br>  Ù†Ø¸Ø§Ù… Ù…Ù„ÙØ§Øª kernel (initrd) ØŒ Ù‚Ø²Ù… ØŒ ÙˆØ¯Ø§Ø®Ù„Ù‡.  Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (exec).  Ø´Ù„ ÙƒØ¨Ø±Ù†Ø§Ù…Ø¬ ÙƒØ§Ù…Ù„ Ù„Ù„Ù†ÙˆØ§Ø©.  ÙˆØ¶Ø¹ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ring3).  Ù‚Ø³Ù… Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø© (tss). <br><br><h4 style=";text-align:right;direction:rtl">  Ø´Ø®ØµÙŠØ© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† </h4><br>  ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ¨Ø¯Ø£ Ù…Ø¹ Ø¸Ù‡ÙˆØ± Ø¬Ù‡Ø§Ø² Ø±Ù…Ø²ÙŠ.  ÙƒÙ…Ø§ ØªØªØ°ÙƒØ± ØŒ ÙÙŠ Linux Device Drivers ØŒ Ø¨Ø¯Ø§ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙƒÙ…Ø§ ÙŠÙ„ÙŠ: <br><br><pre style=";text-align:right;direction:rtl"><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cdev</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">my_cdev</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cdev_alloc</span></span></span><span class="hljs-class">( );</span></span> my_cdev-&gt;ops = &amp;my_fops;</code> </pre> <br>  Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù‡ÙŠ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„ØªÙ†ÙÙŠØ° ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø®Ø§Ù„ / Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„Ù. <br><br>  Ø³Ù†ØªÙ‚Ø¯Ù… Ø¨Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø­Ø¯ ØŒ Ù„ÙƒÙ† Ø§Ù„Ù…Ø¹Ù†Ù‰ Ø³ÙŠÙƒÙˆÙ† Ù…Ù…Ø§Ø«Ù„: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clist_head_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list_head</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* should be at first */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> name[<span class="hljs-number"><span class="hljs-number">8</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* device name */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* base_r; <span class="hljs-comment"><span class="hljs-comment">/* base read address */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* base_w; <span class="hljs-comment"><span class="hljs-comment">/* base write address */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dev_read_cb_t</span></span> read_cb; <span class="hljs-comment"><span class="hljs-comment">/* read handler */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dev_write_cb_t</span></span> write_cb; <span class="hljs-comment"><span class="hljs-comment">/* write handler */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dev_ioctl_cb_t</span></span> ioctl_cb; <span class="hljs-comment"><span class="hljs-comment">/* device specific command handler */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clist_definition_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ih_list</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* low half interrupt handlers */</span></span> };</code> </pre><br>  ÙŠØªÙˆØ§ÙÙ‚ ÙƒÙ„ Ø¬Ù‡Ø§Ø² Ù…Ø¹ Ù†ØµÙ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø§Øª Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø§Øª. <br><br>  ÙÙŠ Ù†Ø¸Ø§Ù… Linux ØŒ ØªØ³Ù…Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ù†ØµÙØ§Øª Ø¨Ø§Ù„Ø¹Ù„ÙˆÙŠØ© ØŒ Ø¹Ù„Ù‰ Ø§Ù„Ø¹ÙƒØ³ ØŒ Ø£Ù‚Ù„ (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ù†Ù‰). <br><br>  Ø´Ø®ØµÙŠØ§ ØŒ Ø¨Ø¯Ø§ Ù„ÙŠ Ø£ÙƒØ«Ø± Ù…Ù†Ø·Ù‚ÙŠØ© ÙˆØªØ°ÙƒØ±Øª Ø¨Ø§Ù„ØµØ¯ÙØ© Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª ÙÙŠ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø¹Ø§ÙƒØ³.  ÙˆØµÙÙ†Ø§ ÙƒÙ„ Ø¹Ù†ØµØ± Ù…Ù† Ø¹Ù†Ø§ØµØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØµÙÙŠÙ† Ø§Ù„Ø³ÙÙ„Ù‰ Ù…Ù† Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹Ø§Øª ÙƒÙ…Ø§ ÙŠÙ„ÙŠ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ih_low_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clist_head_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list_head</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* should be at first */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> number; <span class="hljs-comment"><span class="hljs-comment">/* interrupt number */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ih_low_cb_t</span></span> handler; <span class="hljs-comment"><span class="hljs-comment">/* interrupt handler */</span></span> };</code> </pre><br>  Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ØŒ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø¬Ù‡Ø§Ø²Ù‡ Ù…Ù† Ø®Ù„Ø§Ù„ ÙˆØ¸ÙŠÙØ© dev_register ØŒ Ø¨Ù…Ø¹Ù†Ù‰ Ø¢Ø®Ø± Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ù†ÙŠÙ†: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dev_register</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">dev_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* dev)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clist_head_t</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">entry</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev_t</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* create list entry */</span></span> entry = clist_insert_entry_after(&amp;dev_list, dev_list.head); device = (struct <span class="hljs-keyword"><span class="hljs-keyword">dev_t</span></span>*)entry-&gt;data; <span class="hljs-comment"><span class="hljs-comment">/* fill data */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">strncpy</span></span>(device-&gt;name, dev-&gt;name, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(dev-&gt;name)); device-&gt;base_r = dev-&gt;base_r; device-&gt;base_w = dev-&gt;base_w; device-&gt;read_cb = dev-&gt;read_cb; device-&gt;write_cb = dev-&gt;write_cb; device-&gt;ioctl_cb = dev-&gt;ioctl_cb; device-&gt;ih_list.head = dev-&gt;ih_list.head; device-&gt;ih_list.slot_size = dev-&gt;ih_list.slot_size; }</code> </pre><br>  Ù„ÙƒÙŠ ÙŠØ¹Ù…Ù„ ÙƒÙ„ Ù‡Ø°Ø§ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø£Ùˆ Ø¨Ø£Ø®Ø±Ù‰ ØŒ Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù… rudiment Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª.  ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ØŒ Ø³ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙ†Ø§ ÙÙ‚Ø· Ù…Ù„ÙØ§Øª Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø´Ø®ØµÙŠØ§Øª. <br><br>  Ø£ÙŠ  Ø³ÙŠÙƒÙˆÙ† ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ù…Ø³Ø§ÙˆÙŠØ§Ù‹ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù†ÙŠØ© FILE Ù…Ù† stdio Ù„Ù…Ù„Ù Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„. <br><br>  ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© ØŒ Ø³ÙˆÙ ØªØ·Ø§Ø¨Ù‚ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø².  Ù†Ø­Ø¯Ø¯ Ù…ÙÙ‡ÙˆÙ… ÙˆØ§ØµÙ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ù…ÙƒØªØ¨Ø© C Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†Ø§ (stdio.h). <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">io_buf_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd; <span class="hljs-comment"><span class="hljs-comment">/* file descriptor */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* base; <span class="hljs-comment"><span class="hljs-comment">/* buffer beginning */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* ptr; <span class="hljs-comment"><span class="hljs-comment">/* position in buffer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> is_eof; <span class="hljs-comment"><span class="hljs-comment">/* whether end of file */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* file; <span class="hljs-comment"><span class="hljs-comment">/* file definition */</span></span> }; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FILE struct io_buf_t</span></span></code> </pre><br>  Ù„Ù„Ø¨Ø³Ø§Ø·Ø© ØŒ Ø§Ø³Ù…Ø­ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø¨ØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø­Ù„Ù‚Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ.  ÙŠØªÙ… ÙˆØµÙ Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ…Ø§ ÙŠÙ„ÙŠ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clist_head_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list_head</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* should be at first */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">io_buf_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">io_buf</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* file handler */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> name[<span class="hljs-number"><span class="hljs-number">8</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* file name */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mod_rw; <span class="hljs-comment"><span class="hljs-comment">/* whether read or write */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev_t</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* whether device driver */</span></span> };</code> </pre><br>  Ù„ÙƒÙ„ Ù…Ù„Ù Ù…ÙØªÙˆØ­ ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ®Ø²ÙŠÙ† Ø±Ø§Ø¨Ø· Ù„Ù„Ø¬Ù‡Ø§Ø².  Ù†Ù†ÙØ° Ù‚Ø§Ø¦Ù…Ø© Ø­Ù„Ù‚Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙˆÙ†Ù†ÙØ° Ù…ÙƒØ§Ù„Ù…Ø§Øª Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© / Ø§Ù„ÙƒØªØ§Ø¨Ø© / ioctl. <br><br>  Ø¹Ù†Ø¯ ÙØªØ­ Ø£Ø­Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª ØŒ Ù†Ø­ØªØ§Ø¬ ÙÙ‚Ø· Ø¥Ù„Ù‰ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø© Ù…Ù† Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¥Ù„Ù‰ Ø¨Ù†ÙŠØ© io_buf_t ØŒ ÙˆØ¨Ø§Ù„ØªØ§Ù„ÙŠ ØŒ Ø±Ø¨Ø· Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø¹ Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø². <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> struct io_buf_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file_open</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> mod_rw)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clist_head_t</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">entry</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_t</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev_t</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* try to find already opened file */</span></span> entry = clist_find(&amp;file_list, file_list_by_name_detector, path, mod_rw); file = (struct <span class="hljs-keyword"><span class="hljs-keyword">file_t</span></span>*)entry-&gt;data; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entry != null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &amp;file-&gt;io_buf; } <span class="hljs-comment"><span class="hljs-comment">/* create list entry */</span></span> entry = clist_insert_entry_after(&amp;file_list, file_list.head); file = (struct <span class="hljs-keyword"><span class="hljs-keyword">file_t</span></span>*)entry-&gt;data; <span class="hljs-comment"><span class="hljs-comment">/* whether file is device */</span></span> dev = dev_find_by_name(path); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dev != null) { <span class="hljs-comment"><span class="hljs-comment">/* device */</span></span> file-&gt;dev = dev; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mod_rw == MOD_R) { file-&gt;io_buf.base = dev-&gt;base_r; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mod_rw == MOD_W) { file-&gt;io_buf.base = dev-&gt;base_w; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* fs node */</span></span> file-&gt;dev = null; unreachable(); <span class="hljs-comment"><span class="hljs-comment">/* fs in not implemented yet */</span></span> } <span class="hljs-comment"><span class="hljs-comment">/* fill data */</span></span> file-&gt;mod_rw = mod_rw; file-&gt;io_buf.fd = next_fd++; file-&gt;io_buf.ptr = file-&gt;io_buf.base; file-&gt;io_buf.is_eof = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; file-&gt;io_buf.file = file; <span class="hljs-built_in"><span class="hljs-built_in">strncpy</span></span>(file-&gt;name, path, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(file-&gt;name)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &amp;file-&gt;io_buf; }</code> </pre><br>  ÙŠØªÙ… ØªØ¹Ø±ÙŠÙ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© / Ø§Ù„ÙƒØªØ§Ø¨Ø© / ioctl ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ù…Ø· ÙˆØ§Ø­Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙƒÙ…Ø«Ø§Ù„. <br><br>  Ø³ÙˆÙ ÙŠØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ù†ÙØ³Ù‡ Ø§Ù„Ø°ÙŠ ØªØ¹Ù„Ù…Ù†Ø§Ù‡ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø£Ø®ÙŠØ± Ø¨Ø¨Ø³Ø§Ø·Ø© Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> size_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file_read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">io_buf_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* io_buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* buff, u_int size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_t</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">;</span></span> file = (struct <span class="hljs-keyword"><span class="hljs-keyword">file_t</span></span>*)io_buf-&gt;file; <span class="hljs-comment"><span class="hljs-comment">/* whether file is device */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file-&gt;dev != null) { <span class="hljs-comment"><span class="hljs-comment">/* device */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> file-&gt;dev-&gt;read_cb(&amp;file-&gt;io_buf, buff, size); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* fs node */</span></span> unreachable(); <span class="hljs-comment"><span class="hljs-comment">/* fs in not implemented yet */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  Ø¨Ø§Ø®ØªØµØ§Ø± ØŒ Ø³ÙŠÙ‚ÙˆÙ…ÙˆÙ† Ø¨Ø³Ø­Ø¨ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ø§Øª Ù…Ù† ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¬Ù‡Ø§Ø².  Ø§Ù„Ø¢Ù† Ø³ÙˆÙ Ù†ÙƒØªØ¨ Ø³Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø­Ø·Ø©. <br><br><h4 style=";text-align:right;direction:rtl">  Ø³Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø­Ø·Ø© </h4><br>  Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø®Ø²Ù† Ù…Ø¤Ù‚Øª Ù„Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ø´Ø§Ø´Ø© ÙˆÙ…Ø®Ø²Ù† Ù…Ø¤Ù‚Øª Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ØŒ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø¹Ø¯Ø© Ø¥Ø´Ø§Ø±Ø§Øª Ù„Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„Ø¥Ø®Ø±Ø§Ø¬. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* tty_dev_name = TTY_DEV_NAME; <span class="hljs-comment"><span class="hljs-comment">/* teletype device name */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> tty_output_buff[VIDEO_SCREEN_SIZE]; <span class="hljs-comment"><span class="hljs-comment">/* teletype output buffer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> tty_input_buff[VIDEO_SCREEN_WIDTH]; <span class="hljs-comment"><span class="hljs-comment">/* teletype input buffer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* tty_output_buff_ptr = tty_output_buff; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* tty_input_buff_ptr = tty_input_buff; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> read_line_mode = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* whether read only whole line */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> is_echo = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* whether to put readed symbol to stdout */</span></span></code> </pre><br>  Ù†ÙƒØªØ¨ ÙˆØ¸ÙŠÙØ© Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù‡Ø§Ø².  Ø¥Ù†Ù‡ Ø¨Ø¨Ø³Ø§Ø·Ø© ÙŠØ¹ÙŠØ¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù†ØµÙÙŠÙ† Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù…Ù† Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹Ø§Øª ØŒ ÙˆØ¨Ø¹Ø¯ Ø°Ù„Ùƒ ÙŠØ³Ø¬Ù„ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØºÙ…Ø§Øª. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tty_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clist_head_t</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">entry</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ih_low_t</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ih_low</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(tty_output_buff, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(VIDEO_SCREEN_SIZE)); <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(tty_input_buff, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(VIDEO_SCREEN_WIDTH)); <span class="hljs-comment"><span class="hljs-comment">/* register teletype device */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span>(dev.name, tty_dev_name); dev.base_r = tty_input_buff; dev.base_w = tty_output_buff; dev.read_cb = tty_read; dev.write_cb = tty_write; dev.ioctl_cb = tty_ioctl; dev.ih_list.head = null; <span class="hljs-comment"><span class="hljs-comment">/* add interrupt handlers */</span></span> dev.ih_list.slot_size = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(struct <span class="hljs-keyword"><span class="hljs-keyword">ih_low_t</span></span>); entry = clist_insert_entry_after(&amp;dev.ih_list, dev.ih_list.head); ih_low = (struct <span class="hljs-keyword"><span class="hljs-keyword">ih_low_t</span></span>*)entry-&gt;data; ih_low-&gt;number = INT_KEYBOARD; ih_low-&gt;handler = tty_keyboard_ih_low; dev_register(&amp;dev); }</code> </pre><br>  ÙŠØªÙ… ØªØ¹Ø±ÙŠÙ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø© Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙƒÙ…Ø§ ÙŠÙ„ÙŠ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Key press low half handler */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tty_keyboard_ih_low</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> number, struct </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ih_low_data_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* write character to input buffer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* keycode = data-&gt;data; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index = *keycode; assert(index &lt; <span class="hljs-number"><span class="hljs-number">128</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> ch = keyboard_map[index]; *tty_input_buff_ptr++ = ch; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_echo &amp;&amp; ch != <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* echo character to screen */</span></span> *tty_output_buff_ptr++ = ch; } <span class="hljs-comment"><span class="hljs-comment">/* register deffered execution */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">;</span></span> msg.type = IPC_MSG_TYPE_DQ_SCHED; msg.len = <span class="hljs-number"><span class="hljs-number">4</span></span>; *((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> *)msg.data) = (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)tty_keyboard_ih_high; ksend(TID_DQ, &amp;msg); }</code> </pre><br>  Ù†Ø­Ù† Ù‡Ù†Ø§ Ø¨Ø¨Ø³Ø§Ø·Ø© ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­.  ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ØŒ Ù†Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ù…Ø¤Ø¬Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù†ØµÙÙŠÙ† Ø§Ù„Ø¹Ù„ÙˆÙŠÙŠÙ† Ù…Ù† Ù…Ù‚Ø§Ø·Ø¹Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­.  ÙŠØªÙ… Ø°Ù„Ùƒ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© (IPC) Ø¥Ù„Ù‰ Ù…Ø¤Ø´Ø± ØªØ±Ø§Ø¨Ø· kernel. <br><br>  Ø®ÙŠØ· Ø§Ù„Ù†ÙˆØ§Ø© Ù†ÙØ³Ù‡ Ø¨Ø³ÙŠØ· Ù„Ù„ØºØ§ÙŠØ©: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Deferred queue execution scheduler * This task running in kernel mode */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dq_task</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { kreceive(TID_DQ, &amp;msg); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (msg.type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IPC_MSG_TYPE_DQ_SCHED: <span class="hljs-comment"><span class="hljs-comment">/* do deffered callback execution */</span></span> assert(msg.len == <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">dq_handler_t</span></span> handler = (<span class="hljs-keyword"><span class="hljs-keyword">dq_handler_t</span></span>)*((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>*)msg.data); assert((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)handler &lt; KERNEL_CODE_END_ADDR); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(MSG_DQ_SCHED, handler); handler(msg); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre><br>  Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù†ØµÙÙŠÙ† Ø§Ù„Ø¹Ù„ÙˆÙŠÙŠÙ† Ù…Ù† Ù…Ù‚Ø§Ø·Ø¹Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­.  ÙˆØ§Ù„ØºØ±Ø¶ Ù…Ù†Ù‡ Ù‡Ùˆ ØªÙƒØ±Ø§Ø± Ø´Ø®ØµÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ù†Ø³Ø® Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ Ø¥Ù„Ù‰ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Key press high half handler */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tty_keyboard_ih_high</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">message_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *msg)</span></span></span><span class="hljs-function"> </span></span>{ video_flush(tty_output_buff); }</code> </pre><br>  Ø§Ù„Ø¢Ù† ÙŠØ¨Ù‚Ù‰ Ù„ÙƒØªØ§Ø¨Ø© ÙˆØ¸Ø§Ø¦Ù I / O Ø£Ù†ÙØ³Ù‡Ù… ØŒ ÙˆØ¯Ø¹Ø§ Ù…Ù† Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù„ÙØ§Øª. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Read line from tty to string */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> u_int </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tty_read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">io_buf_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* io_buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* buffer, u_int size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* ptr = buffer; assert((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)io_buf-&gt;ptr &lt;= (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)tty_input_buff_ptr); assert((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)tty_input_buff_ptr &gt;= (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)tty_input_buff); assert(size &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); io_buf-&gt;is_eof = (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)io_buf-&gt;ptr == (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)tty_input_buff_ptr; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (read_line_mode) { io_buf-&gt;is_eof = !<span class="hljs-built_in"><span class="hljs-built_in">strchr</span></span>(io_buf-&gt;ptr, <span class="hljs-string"><span class="hljs-string">'\n'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; size - <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; !io_buf-&gt;is_eof; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> ch = tty_read_ch(io_buf); *ptr++ = ch; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (read_line_mode &amp;&amp; ch == <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)ptr - (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)buffer; } <span class="hljs-comment"><span class="hljs-comment">/* * Write to tty */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tty_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">io_buf_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* io_buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, u_int size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* ptr = data; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; size &amp;&amp; !io_buf-&gt;is_eof; ++i) { tty_write_ch(io_buf, *ptr++); } }</code> </pre><br>  Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø±Ù - Ø§Ù„Ø­Ø±Ù Ù„ÙŠØ³Øª Ø£ÙƒØ«Ø± ØªØ¹Ù‚ÙŠØ¯Ù‹Ø§ ÙˆÙ„Ø§ Ø£Ø¹ØªÙ‚Ø¯ Ø£Ù†Ù‡Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ¹Ù„ÙŠÙ‚. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Write single character to tty */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tty_write_ch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">io_buf_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* io_buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)tty_output_buff_ptr - (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)tty_output_buff + <span class="hljs-number"><span class="hljs-number">1</span></span> &lt; VIDEO_SCREEN_SIZE) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch != <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* regular character */</span></span> *tty_output_buff_ptr++ = ch; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* new line character */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> line_pos = ((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)tty_output_buff_ptr - (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)tty_output_buff) % VIDEO_SCREEN_WIDTH; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; VIDEO_SCREEN_WIDTH - line_pos; ++j) { *tty_output_buff_ptr++ = <span class="hljs-string"><span class="hljs-string">' '</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { tty_output_buff_ptr = video_scroll(tty_output_buff, tty_output_buff_ptr); tty_write_ch(io_buf, ch); } io_buf-&gt;ptr = tty_output_buff_ptr; } <span class="hljs-comment"><span class="hljs-comment">/* * Read single character from tty */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tty_read_ch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">io_buf_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* io_buf)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)io_buf-&gt;ptr &lt; (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)tty_input_buff_ptr) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *io_buf-&gt;ptr++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { io_buf-&gt;is_eof = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; } }</code> </pre><br>  ÙŠØ¨Ù‚Ù‰ ÙÙ‚Ø· Ù„Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ù„ØªÙ†ÙÙŠØ° ioctl. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Teletype specific command */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tty_ioctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">io_buf_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* io_buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> command)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* hello_msg = MSG_KERNEL_NAME; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (command) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IOCTL_INIT: <span class="hljs-comment"><span class="hljs-comment">/* prepare video device */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (io_buf-&gt;base == tty_output_buff) { kmode(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* detach syslog from screen */</span></span> tty_output_buff_ptr = video_clear(io_buf-&gt;base); io_buf-&gt;ptr = tty_output_buff_ptr; tty_write(io_buf, hello_msg, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(hello_msg)); video_flush(io_buf-&gt;base); io_buf-&gt;ptr = tty_output_buff_ptr; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (io_buf-&gt;base == tty_input_buff) { unreachable(); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IOCTL_CLEAR: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (io_buf-&gt;base == tty_output_buff) { <span class="hljs-comment"><span class="hljs-comment">/* fill output buffer with spaces */</span></span> tty_output_buff_ptr = video_clear(io_buf-&gt;base); video_flush(io_buf-&gt;base); io_buf-&gt;ptr = tty_output_buff_ptr; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (io_buf-&gt;base == tty_input_buff) { <span class="hljs-comment"><span class="hljs-comment">/* clear input buffer */</span></span> tty_input_buff_ptr = tty_input_buff; io_buf-&gt;ptr = io_buf-&gt;base; io_buf-&gt;is_eof = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IOCTL_FLUSH: <span class="hljs-comment"><span class="hljs-comment">/* flush buffer to screen */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (io_buf-&gt;base == tty_output_buff) { video_flush(io_buf-&gt;base); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (io_buf-&gt;base == tty_input_buff) { unreachable(); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IOCTL_READ_MODE_LINE: <span class="hljs-comment"><span class="hljs-comment">/* read only whole line */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (io_buf-&gt;base == tty_input_buff) { read_line_mode = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (io_buf-&gt;base == tty_output_buff) { unreachable(); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IOCTL_READ_MODE_ECHO: <span class="hljs-comment"><span class="hljs-comment">/* put readed symbol to stdout */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (io_buf-&gt;base == tty_input_buff) { is_echo = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (io_buf-&gt;base == tty_output_buff) { unreachable(); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: unreachable(); } }</code> </pre><br>  Ù†Ù†ÙØ° Ø§Ù„Ø¢Ù† Ø¥Ø®Ø±Ø§Ø¬ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ù…ÙƒØªØ¨ØªÙ†Ø§ C. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Api - Open file */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> FILE* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fopen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* file, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> mod_rw)</span></span></span><span class="hljs-function"> </span></span>{ FILE* result = null; asm_syscall(SYSCALL_OPEN, file, mod_rw, &amp;result); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-comment"><span class="hljs-comment">/* * Api - Close file */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fclose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FILE* file)</span></span></span><span class="hljs-function"> </span></span>{ asm_syscall(SYSCALL_CLOSE, file); } <span class="hljs-comment"><span class="hljs-comment">/* * Api - Read from file to buffer */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> u_int </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FILE* file, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* buff, u_int size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> asm_syscall(SYSCALL_READ, file, buff, size); } <span class="hljs-comment"><span class="hljs-comment">/* * Api - Write data to file */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fwrite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FILE* file, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, u_int size)</span></span></span><span class="hljs-function"> </span></span>{ asm_syscall(SYSCALL_WRITE, file, data, size); }</code> </pre><br>  Ø­Ø³Ù†Ù‹Ø§ ØŒ Ø¥Ù„ÙŠÙƒ Ø¨Ø¹Ø¶ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±ÙÙŠØ¹Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Api - Print user message */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uvnprintf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* format, u_int n, va_list </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">list</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buff[VIDEO_SCREEN_WIDTH]; vsnprintf(buff, n, format, <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>); uputs(buff); } <span class="hljs-comment"><span class="hljs-comment">/* * Api - Read from file to string */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uscanf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* buff, ...)</span></span></span><span class="hljs-function"> </span></span>{ u_int readed = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { readed = fread(<span class="hljs-built_in"><span class="hljs-built_in">stdin</span></span>, buff, <span class="hljs-number"><span class="hljs-number">255</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (readed == <span class="hljs-number"><span class="hljs-number">0</span></span>); buff[readed - <span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* erase new line character */</span></span> uprintf(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); uflush(); }</code> </pre><br>  Ø­ØªÙ‰ Ù„Ø§ Ù†Ø®Ø¯Ø¹ Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† ØŒ Ø³Ù†Ù‚Ø±Ø£ Ø¯Ø§Ø¦Ù…Ù‹Ø§ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø³Ø·Ø± ÙƒÙ…Ø§ Ù„Ùˆ Ø£Ù† Ø¹Ù„Ø§Ù…Ø©Ùª s Ù‚Ø¯ Ø£Ø¹Ø·ÙŠØª.  ÙƒÙ†Øª ÙƒØ³ÙˆÙ„Ù‹Ø§ Ø¬Ø¯Ù‹Ø§ ÙÙŠ ØªÙ‚Ø¯ÙŠÙ… Ø­Ø§Ù„Ø© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ù„ÙØ§Øª ØŒ Ù„Ø°Ù„Ùƒ Ù†Ø­Ø§ÙˆÙ„ ÙÙ‚Ø· Ù‚Ø±Ø§Ø¡Ø© Ø´ÙŠØ¡ Ù…Ø§ ÙÙŠ Ø­Ù„Ù‚Ø© Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ© Ø­ØªÙ‰ Ù†Ù†Ø¬Ø­. <br><br>  Ù‡Ø°Ø§ ÙƒÙ„ Ø´ÙŠØ¡.  Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¨Ø· Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø¨Ø£Ù…Ø§Ù† Ø¥Ù„Ù‰ Ù†ÙˆØ§Ø©ÙƒÙ…! <br><br><h4 style=";text-align:right;direction:rtl">  Ù…Ø±Ø§Ø¬Ø¹ </h4><br>  Ø´Ø§Ù‡Ø¯ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</a> Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª. <br><br>  â†’ Ø´ÙØ±Ø© Ø§Ù„Ù…ØµØ¯Ø± <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ÙÙŠ Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨ÙˆØ§Ø¨Ø©</a> (ØªØ­ØªØ§Ø¬ ÙØ±Ø¹ Ø§Ù„Ø¯Ø±Ø³ 8) <br><br><h4 style=";text-align:right;direction:rtl">  Ù…Ø±Ø§Ø¬Ø¹ </h4><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  Ø¬ÙŠÙ…Ø³ Ù…ÙˆÙ„ÙˆÙŠ.  Ù„ÙØ© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ UNIX Ø§Ø³ØªÙ†Ø³Ø§Ø®. </li><li style=";text-align:right;direction:rtl">  Ø²ÙˆØ¨ÙƒÙˆÙ.  Ù…Ø¬Ù…Ø¹ Ù„ DOS ØŒ ÙˆÙŠÙ†Ø¯ÙˆØ² ØŒ ÙŠÙˆÙ†ÙŠÙƒØ³ </li><li style=";text-align:right;direction:rtl">  ÙƒÙ„Ø§Ø´ÙŠÙ†ÙƒÙˆÙ.  Ø§Ù„Ù…Ø¬Ù…Ø¹ Ø³Ù‡Ù„! </li><li style=";text-align:right;direction:rtl">  ØªØ§Ù†ÙŠÙ†Ø¨Ø§ÙˆÙ….  Ø£Ù†Ø¸Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„.  Ø§Ù„ØªÙ†ÙÙŠØ° ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±. </li><li style=";text-align:right;direction:rtl">  Ø±ÙˆØ¨Ø±Øª Ù„ÙˆÙ.  Ù†ÙˆØ§Ø© Ù„ÙŠÙ†ÙƒØ³  ÙˆØµÙ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ·ÙˆÙŠØ±. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar468509/">https://habr.com/ru/post/ar468509/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar468491/index.html">Ù„Ø¹Ù†Ø© Ø§Ù„ÙƒØ±Ù…Ø© Ù‡Ø¨Ø±Ø§</a></li>
<li><a href="../ar468493/index.html">Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬ÙˆÙŠ Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¹Ù„ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</a></li>
<li><a href="../ar468497/index.html">3 Ø¯Ù‚Ø§Ø¦Ù‚ ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù…ÙˆÙ‚Øª Ø¨Ø§Ù„ÙØ±Ø´Ø§Ø©</a></li>
<li><a href="../ar468501/index.html">ÙƒÙŠÙ Ø£Ù†Ø´Ø£Øª Ø¹Ø§Ù…Ù„ ØªØµÙÙŠØ© Ù„Ø§ ÙŠÙØ³Ø¯ Ø§Ù„ØµÙˆØ±Ø© Ø­ØªÙ‰ Ø¨Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ù…Ù„ÙŠÙˆÙ†</a></li>
<li><a href="../ar468503/index.html">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù„Ø§ ÙŠØ°Ù‡Ø¨ Ø£Ø¨Ø¹Ø¯ 500 Ù…ÙŠÙ„ - Ø£Ø³Ø¦Ù„Ø© ÙˆØ£Ø¬ÙˆØ¨Ø©</a></li>
<li><a href="../ar468511/index.html">Ù†Ø´Ø± Ø®Ø§Ø¯Ù… Ù…Ù† Ø®Ù„Ø§Ù„ Ø¨ÙˆØ§Ø¨Ø© Ø¯ÙŠ Ù„ÙŠÙ†Ùƒ DFL</a></li>
<li><a href="../ar468515/index.html">Ù†ØµØ§Ø¦Ø­ Ù…ÙÙŠØ¯Ø© Ù„Ù„Ø§Ù†Ø¯Ù…Ø§Ø¬ ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</a></li>
<li><a href="../ar468517/index.html">2. Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ ÙˆØ§Ù„Ø¶Ù…Ø§Ù† Ù„Ø´Ø¨ÙƒØ§Øª Extreme Networks</a></li>
<li><a href="../ar468519/index.html">Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</a></li>
<li><a href="../ar468521/index.html">ÙƒÙŠÙ Ù‚Ù…Ù†Ø§ Ø¨ØªØ¹Ù…ÙŠÙ… Ø£Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>