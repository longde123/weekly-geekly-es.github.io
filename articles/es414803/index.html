<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñêüèª üï∫üèº üë®üèæ‚Äçüöí C√≥mo vimos los pagos de IoT en un hackathon en Hong Kong üßîüèø üëâüèæ üíî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El 10 de junio fue el tercer d√≠a de nuestra aclimataci√≥n en Hong Kong. Y las √∫ltimas 26 horas pasamos casi sin dormir, desarrollando un proyecto proto...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo vimos los pagos de IoT en un hackathon en Hong Kong</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mixbytes/blog/414803/"><p><img src="https://habrastorage.org/webt/fs/nm/lj/fsnmljsf_fjfqn0eqomgc9yyswi.jpeg"></p><br><p>  El 10 de junio fue el tercer d√≠a de nuestra aclimataci√≥n en Hong Kong.  Y las √∫ltimas 26 horas pasamos casi sin dormir, desarrollando un proyecto prototipo bajo el nombre de trabajo SensorPay en la primera etapa del hackathon EOS Global con un premio total de un mill√≥n y medio de d√≥lares.  Se acercaba el momento de la demostraci√≥n del proyecto ante los jueces. </p><br><p>  Si est√° ansioso por saber c√≥mo termin√≥ esta historia, eche un vistazo a la √∫ltima parte de inmediato.  Mientras tanto, comenzaremos a hablar sistem√°ticamente sobre las tecnolog√≠as EOS y c√≥mo surgi√≥ la idea de vincular los pagos de IoT a EOS.  Justo despu√©s de eso, habr√° una descripci√≥n detallada del relleno t√©cnico del proyecto. </p><a name="habracut"></a><br><h1 id="0-predystoriya">  0. Antecedentes </h1><br><p>  EOS es una cadena de bloques de nueva generaci√≥n, algunos incluso lo consideran un asesino de Ethereum.  Si de repente no sabes qu√© es una cadena de bloques o Ethereum, Google te ayudar√°.  Y, sucedi√≥, comenzamos a desenterrar EOS hace aproximadamente un a√±o, incluso mediante el estudio de los productos anteriores de sus autores BitShares y Steem. </p><br><p>  Las ventajas de EOS en comparaci√≥n con Ethereum: el rendimiento de la transacci√≥n es tres √≥rdenes de magnitud mayor;  sistema de permisos desarrollado para contratos inteligentes;  la capacidad de restaurar el acceso perdido y corregir errores en la cadena de bloques;  gesti√≥n de redes onchain.  Debilidades: preocupaciones de centralizaci√≥n, consenso DPoS potencialmente m√°s vulnerable, c√≥digo sin procesar y una curva de aprendizaje m√°s pronunciada para los desarrolladores. </p><br><p>  Como nos ha gustado esta tecnolog√≠a durante mucho tiempo y la consideramos prometedora, no podemos ignorar la serie de hackatones, que cuentan con el respaldo de los autores de EOS.  Solo quer√≠amos estar all√≠, realizar nuestras ideas en este entorno inspirador y compartirlas con una amplia audiencia.  Por supuesto, la oportunidad de ganar buen dinero tambi√©n se convirti√≥ en un motivador agradable adicional. </p><br><p>  Entonces, EOS es la √∫nica soluci√≥n de trabajo para la cadena de bloques p√∫blica que sabemos d√≥nde puede hacer MUCHAS transacciones.  ¬øD√≥nde se requiere?  ¬°Por supuesto en IoT!  De hecho, si cada tostadora se convierte en micropagos, pagar√° por cada pieza de pan al refrigerador (y esto es genial por defecto, como comprender√°), habr√° muchas transacciones.  Sin mencionar todo tipo de otras aplicaciones en medicina, industria y vida cotidiana. </p><br><p>  Unas semanas antes del hackat√≥n, peri√≥dicamente surg√≠an ideas alternativas y se realizaban peque√±as tormentas de ideas.  Comparamos ideas sobre la base de criterios de arbitraje bien conocidos: el uso de capacidades EOS, creatividad, impacto p√∫blico y escalabilidad.  Como resultado, nos decidimos por IoT + EOS, una soluci√≥n que tomar√≠a datos de los sensores y enviar√≠a muchas transacciones de pago a EOS. </p><br><p>  Por cierto, realmente quer√≠amos contar tambi√©n aqu√≠ c√≥mo criamos a nuestro productor de bloques para EOS;  c√≥mo planearon eliminar para √©l el constructor de tokens similares a ERC721 y soporte para funciones constantes;  ¬øC√≥mo presentaron el protocolo Merkle Root ACL?  Pero todo esto no cabe en el art√≠culo, por lo que volveremos a nuestro proyecto principal. </p><br><p><img src="https://habrastorage.org/webt/9j/mu/uk/9jmuukvwx1e6cav3h59txeywaw0.jpeg"></p><br><h1 id="1-podgotovka">  1. Preparaci√≥n </h1><br><h2 id="11-iot">  1.1.  IoT </h2><br><p>  Preparar la parte de IoT del proyecto es elegir el hardware adecuado.  En el papel del lector RFID, se eligi√≥ el RC522 que opera en el bus SPI: es popular y f√°cil de usar. </p><br><p><img src="https://habrastorage.org/webt/tq/xf/qh/tqxfqh4x5vzlaywel57eqszznpu.jpeg"></p><br><p>  Al buscar un contador, nos enfocamos en la presencia de una salida de pulso, ya que le permite leer los datos de manera muy simple: un pulso es X kW‚ãÖh (donde X depende del modelo), como resultado, nos detuvimos en el contador Mercury 201.5. </p><br><p><img src="https://habrastorage.org/webt/z-/63/sc/z-63scf4m94nnbw30prkmy_nfxa.jpeg"></p><br><p>  Lo m√°s dif√≠cil fue decidir sobre el controlador, que deber√≠a recopilar datos de los sensores, formar una transacci√≥n, firmarlo con su clave privada y enviarlo a la red.  En consecuencia, necesit√°bamos un dispositivo con un m√≥dulo de red que pudiera firmar una transacci√≥n usando ECDSA (en este caso, en la curva el√≠ptica secp256k1, ya que se usa en EOS para firmar). </p><br><p>  Inicialmente, la elecci√≥n recay√≥ en el microcontrolador ESP8266, tiene un m√≥dulo Wi-Fi y todas las interfaces necesarias para conectar nuestros sensores.  Al mismo tiempo, es muy compacto.  Pero ninguno de los firmware tiene una implementaci√≥n nativa de primitivas el√≠pticas.  Es posible escribir su propia implementaci√≥n, pero esta no es una tarea para el hackathon.  Como resultado, se eligi√≥ Raspberry Pi 3 B para el prototipo, y la biblioteca eosjs se utiliz√≥ para generar y firmar transacciones. </p><br><p><img src="https://habrastorage.org/webt/ww/jo/dg/wwjodgbxktjubpruvb-srqz_9dq.jpeg"></p><br><h2 id="12-infrastruktura">  1.2.  La infraestructura </h2><br><p>  Un par de d√≠as antes del hackathon, preparamos localmente y en el servidor eos-hackathon.smartz.io un ensamblado EOS ( <a href="">fuente</a> ).  La instalaci√≥n, el ensamblaje y las pruebas de dependencia fueron sorprendentemente f√°ciles para un proyecto tan joven (usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> ).  No hab√≠a suficiente tiempo para otra preparaci√≥n de infraestructura, y ya tuve que lidiar con eso durante el hackathon. </p><br><h2 id="13-arhitektura">  1.3.  Arquitectura </h2><br><p>  En v√≠speras del hackathon, discutimos la arquitectura y aclaramos los detalles del producto.  √çbamos a implementar los siguientes casos principales: pagos por electricidad y pagos por compras marcadas con etiquetas RFID.  Tambi√©n planearon hacer que el producto sea f√°cilmente extensible y usarlo en otras √°reas. </p><br><p><img src="https://habrastorage.org/webt/yh/rh/tm/yhrhtm0ildam8hgnnjnpkf4_l7w.jpeg"></p><br><p>  La idea de la arquitectura es que el proveedor de servicios (Productor) crea un contrato: el punto central de interacci√≥n entre el proveedor y los consumidores.  Cada consumidor tiene su propio saldo, que puede reponerse, los fondos se debitan de √©l en funci√≥n de las se√±ales del sensor.  Todos los datos (usuarios, sensores, estad√≠sticas) se almacenan en el contrato del proveedor. </p><br><p> Las preferencias del usuario est√°n asociadas con el consumidor o las banderas (por ejemplo, una categor√≠a de usuario preferencial): <code>user_meta</code> .  Se pueden conectar varios sensores con el consumidor, para cada uno de ellos se indica un contrato y la configuraci√≥n de facturaci√≥n ( <code>billing_meta</code> ).  Por lo tanto, puede obtener un contrato de facturaci√≥n sin estado inmutable, que se utiliza para una gran cantidad de consumidores;  los datos necesarios aparecer√°n durante la invocaci√≥n del m√©todo de <code>bill(payload, user_meta, billing_meta)</code> .  Adem√°s, se plantea la posibilidad de una l√≥gica de facturaci√≥n diferente, es decir, contratos diferentes: por ejemplo, uno considera la electricidad, el otro, los bienes.  Cada sensor tiene un "puntero" a su contrato de facturaci√≥n. </p><br><p>  Se supone que el consumidor conf√≠a en el fabricante del sensor, pero no necesariamente conf√≠a en el proveedor del servicio.  La interfaz de interacci√≥n con el sensor es extremadamente simple: es una llamada al m√©todo de contrato del proveedor con un par√°metro num√©rico, que se transferir√° a la facturaci√≥n.  El proveedor de servicios inicia a los consumidores, sensores, contratos de facturaci√≥n y sus relaciones en su contrato, utilizando transacciones de control: establecedores primitivos.  Cuando se recibe una transacci√≥n del sensor, se verifican los datos, se generan los datos de facturaci√≥n, se llama a la facturaci√≥n, se registra el pago y se registran las estad√≠sticas. </p><br><p>  Quiz√°s, sobre todo, discutimos los siguientes temas que son importantes para la aplicabilidad del producto en el mundo real: </p><br><ul><li>  ¬øPagos iniciales o pospago?  ¬øRellene su cuenta y √∫sela (como una conexi√≥n celular), o √∫sela y luego pague (como AWS)?  Aqu√≠ no hay una respuesta correcta o incorrecta: diferentes empresas prefieren diferentes modelos.  Para simplificar, decidimos aceptar pagos por adelantado. </li><li>  ¬øDeber√≠a el usuario mantener una cuenta separada para cada proveedor, o todos los cargos provienen de una cuenta?  Nuevamente, no hay una decisi√≥n correcta o incorrecta;  Adem√°s, la respuesta est√° estrechamente relacionada con la respuesta a la pregunta anterior.  Los pagos por adelantado son buenos amigos con las cuentas individuales de los consumidores: se tomaron. </li><li>  ¬øCobra una tarifa en EOS, una ficha de un proveedor de servicios o una moneda estable (vinculada a la moneda fiduciaria)?  Las opciones distintas a la moneda estable, por supuesto, son inconvenientes para el consumidor debido a la volatilidad, y la moneda estable dentro del marco de EOS a√∫n no existe.  En ese momento, ¬°incluso la red EOS principal no estaba all√≠!  Por simplicidad, tomaron una ficha condicional. </li></ul><br><h1 id="2-koding">  2. Codificaci√≥n </h1><br><p>  En primer lugar, especificaron la API y el marco del contrato del proveedor para comenzar simult√°neamente el desarrollo de la interfaz, el c√≥digo del dispositivo, la facturaci√≥n y el contrato principal ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fuente</a> ). </p><br><h2 id="21-iot">  2.1.  IoT </h2><br><p>  El primero en implementar un <a href="">c√≥digo</a> para leer pulsos de un contador.  Para trabajar con GPIO (pines de uso general), se utiliz√≥ la biblioteca onoff JS.  M√°s tarde, se agregaron dos LED al circuito para mayor claridad: el primero parpade√≥ cuando se recibi√≥ una se√±al del contador y el segundo cuando una respuesta sobre una transacci√≥n exitosa vino del nodo EOS.  Del mismo modo, desarrollamos un esquema y un c√≥digo para leer etiquetas RFID, con la √∫nica diferencia: la lectura se realiz√≥ en el bus SPI utilizando la biblioteca MFRC522-python.  Al final result√≥ que, la configuraci√≥n de SPI para la Raspberry Pi 3 es diferente de la configuraci√≥n en modelos de placa anteriores;  Esta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">instrucci√≥n</a> nos ayud√≥ a entender. </p><br><p>  Los dispositivos se alimentaron desde el banco de energ√≠a, que se present√≥ con √©xito a todos los participantes del hackathon, y tuvieron que compartir Internet ellos mismos con el iPhone 5, ya que el wifi del hackathon funcionaba exclusivamente a 5 GHz, esto no funcion√≥ para el Raspberry Pi. </p><br><h2 id="22-infrastruktura-i-utility">  2.2.  Infraestructura y Utilidades </h2><br><p>  Los organizadores aconsejaron tomar la imagen del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">acoplador</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">eos-dev</a> , pero est√°bamos confundidos por la falta de descripci√≥n y documentaci√≥n de la imagen.  En el servidor, continuaron trabajando con el ensamblaje preparado, y localmente, para evitar la instalaci√≥n sistem√°tica de EOS, usaron eos-dev. </p><br><p>  Inmediatamente necesitaba urgentemente la capacidad de construir y probar r√°pidamente.  Ideal: compila y ejecuta un archivo ejecutable localmente.  Sin embargo, era imposible ignorar el hecho de que despu√©s del ensamblaje, la salida requer√≠a WebAssembly y, en el entorno EOS, con el impulso correspondiente, bibliotecas, contratos del sistema.  Las opciones de compilaci√≥n necesarias podr√≠an verse en <a href="">eosiocpp.in</a> , sin embargo, decidimos no jugar a este juego.  El resultado previsto, aunque un poco m√°s lento, es m√°s importante que una soluci√≥n r√°pida con un rastrillo potencial.  Por lo tanto, para el ensamblaje tomamos eoscpp, que est√° en el contenedor eos-dev. </p><br><p>  Result√≥ ser m√°s dif√≠cil con el lanzamiento, tuve que aumentar la cadena de bloques local EOS, y nuevamente no hab√≠a una soluci√≥n preparada.  Solo software.  Entonces apareci√≥ la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">primera versi√≥n de</a> la infraestructura de lanzamiento.  La idea es ocultar los matices de montaje y configuraci√≥n y obtener un conjunto autoconsistente de cuatro a cinco "botones" para acciones t√≠picas.  Menos control, pero menos posibilidades de error, m√°s ahorro de tiempo. </p><br><p>  Los componentes principales de EOS incluyen los nodos, los demonios keosd, la utilidad de consola cleos y el compilador eoscpp: </p><br><ul><li>  nodeos - nodo EOS, daemon - participante de la red, proporciona acceso a la cadena de bloques y opcionalmente produce nuevos bloques; </li><li>  keosd: un demonio para administrar billeteras locales que almacenan pares de claves; </li><li>  cleos proporciona comandos desde la obtenci√≥n de informaci√≥n sobre transacciones hasta el trabajo con claves; se implementa en funci√≥n de llamadas en nodeos y keosd mediante la API HTTP; </li><li>  eoscpp compila contratos en WebAssembly y tambi√©n le permite obtener la interfaz binaria de la aplicaci√≥n basada en el c√≥digo fuente. </li></ul><br><p>  Inmediatamente se hizo evidente que los comandos cleos relacionados con las llamadas keosd no funcionaban.  Dado que se emiti√≥ un error que indicaba la inaccesibilidad de la red keosd, pasamos tiempo diagnosticando problemas de red en la red acoplable.  Sin embargo, strace mostr√≥ que no era la red: cleos acced√≠a a la direcci√≥n incorrecta, siempre a localhost (y en el caso de nuestra infraestructura, diferentes demonios tienen diferentes direcciones de red en una red de acopladores separada).  Se diagnostic√≥ un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">error</a> en cleos: la comprobaci√≥n de la disponibilidad de keosd, que se realiza antes de cualquier comando relacionado con billeteras, tiene en cuenta el puerto pasado en los argumentos, pero no tiene en cuenta la direcci√≥n.  Bajo el hackathon, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cambiamos</a> a la red host en Docker como una soluci√≥n alternativa. </p><br><p>  El siguiente paso fue la utilidad de compilaci√≥n de contratos utilizando el compilador en el contenedor ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">commit</a> ).  Se montaron directorios de entrada y salida.  Y finalmente, la capacidad de subir un contrato a la cadena de bloques y enviar transacciones ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">commit</a> ).  Una vez m√°s: utilidades en un estilo consistente, simples "botones".  Esto puso fin a la infraestructura b√°sica, pero las sorpresas continuaron: nos topamos con el problema de las funciones C para trabajar con memoria (con m√°s detalle a continuaci√≥n). </p><br><p>  En conclusi√≥n, comenzaron a configurar cuentas en un archivo (cada contrato y participante requieren cuentas separadas) junto con pares de claves que se crean autom√°ticamente cuando comienza la cadena de bloques, para que un equipo pueda elevar el entorno de prueba.  Se implement√≥ una copia de este entorno en eos-hackathon.smartz.io. </p><br><h2 id="23-smart-kontrakty">  2.3.  Contratos inteligentes </h2><br><h3 id="231-kontrakt-postavschika-i-billing-elektrichestva">  2.3.1.  Contrato de proveedores y facturaci√≥n de electricidad. </h3><br><p>  Despu√©s del inicio del hackathon, comenzamos a dise√±ar la estructura de los contratos de acuerdo con el esquema anterior.  El sistema constaba de los siguientes contratos: </p><br><ul><li>  <code>supplier</code> - contrato de <code>supplier</code> ; </li><li>  <code>billing_electricity</code> : un contrato para calcular el pago de electricidad por cada tic del medidor. </li></ul><br><p>  En el contrato del <code>supplier</code> , la mayor parte del trabajo se lleva a cabo mediante operaciones CRUD ordinarias: agregando usuarios, tarifas, contadores, aumentando o disminuyendo el saldo del usuario.  Los m√©todos m√°s complejos fueron responsables de recibir datos del medidor, solicitar un contrato para calcular un pago (facturaci√≥n), debitar la cuenta personal de un usuario despu√©s de una devoluci√≥n de llamada de un contrato de facturaci√≥n.  El contrato de facturaci√≥n necesario se determin√≥ en funci√≥n de la tarifa del usuario. </p><br><p>  Despu√©s de la llamada en el contrato de facturaci√≥n, se calcul√≥ el pago y se solicit√≥ el m√©todo para debitar el pago de la cuenta personal del usuario.  Habiendo lanzado la l√≥gica principal, incluso pensamos si est√°bamos haciendo contratos demasiado simples.  Un poco m√°s tarde, despu√©s del despliegue de los contratos en el nodo y sus pruebas, qued√≥ claro que los contratos pueden ser simples, pero hay matices.  :) </p><br><p>  Despu√©s del despliegue, result√≥ que las llamadas contractuales esperadas entre s√≠ no funcionaron.  No hay suficientes derechos.  A diferencia de los contratos inteligentes en Ethereum, donde un contrato se llama desde un contrato en nombre del contrato de llamada, en EOS, toda la cadena comienza con el iniciador de la transacci√≥n.  Cuando se llama a un contrato desde un contrato, se verifica si el iniciador permiti√≥ que el contrato hiciera esto. </p><br><p>  Los mentores sugirieron inmediatamente c√≥mo actuar en un caso simple.  Los derechos se agregan de la siguiente manera (llamando al contrato inteligente del sistema eosio): </p><br><pre> <code class="hljs swift">./cleos push action eosio updateauth '{<span class="hljs-string"><span class="hljs-string">"account"</span></span>:<span class="hljs-string"><span class="hljs-string">"electricity"</span></span>,<span class="hljs-string"><span class="hljs-string">"permission"</span></span>:<span class="hljs-string"><span class="hljs-string">"active"</span></span>,<span class="hljs-string"><span class="hljs-string">"parent"</span></span>:<span class="hljs-string"><span class="hljs-string">"owner"</span></span>,<span class="hljs-string"><span class="hljs-string">"auth"</span></span>:{<span class="hljs-string"><span class="hljs-string">"keys"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"key"</span></span>:<span class="hljs-string"><span class="hljs-string">"EOS7oPdzdvbHcJ4k9iZaDuG4Foh9YsjQffTGniLP28FC8fbpCDgr5"</span></span>,<span class="hljs-string"><span class="hljs-string">"weight"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>}],<span class="hljs-string"><span class="hljs-string">"threshold"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">"accounts"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"permission"</span></span>:{<span class="hljs-string"><span class="hljs-string">"actor"</span></span>:<span class="hljs-string"><span class="hljs-string">"supplier"</span></span>,<span class="hljs-string"><span class="hljs-string">"permission"</span></span>:<span class="hljs-string"><span class="hljs-string">"eosio.code"</span></span>},<span class="hljs-string"><span class="hljs-string">"weight"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>}],<span class="hljs-string"><span class="hljs-string">"waits"</span></span>:[]}}' -p electricity</code> </pre> <br><p>  En este caso, la cuenta de <code>electricity</code> permite que el contrato del <code>supplier</code> llame a otros contratos en su nombre.  Puede leer m√°s sobre los derechos en <a href="">Technical WP EOS</a> .  En nuestro pa√≠s, el contrato del <code>supplier</code> caus√≥ el contrato de <code>billing</code> , y eso, a su vez, volvi√≥ a llamar al <code>supplier</code> .  Agregar por analog√≠a de derechos en este formulario no funcion√≥: </p><br><pre> <code class="hljs swift">./cleos push action eosio updateauth '{<span class="hljs-string"><span class="hljs-string">"account"</span></span>:<span class="hljs-string"><span class="hljs-string">"electricity"</span></span>,<span class="hljs-string"><span class="hljs-string">"permission"</span></span>:<span class="hljs-string"><span class="hljs-string">"active"</span></span>,<span class="hljs-string"><span class="hljs-string">"parent"</span></span>:<span class="hljs-string"><span class="hljs-string">"owner"</span></span>,<span class="hljs-string"><span class="hljs-string">"auth"</span></span>:{<span class="hljs-string"><span class="hljs-string">"keys"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"key"</span></span>:<span class="hljs-string"><span class="hljs-string">"EOS7oPdzdvbHcJ4k9iZaDuG4Foh9YsjQffTGniLP28FC8fbpCDgr5"</span></span>,<span class="hljs-string"><span class="hljs-string">"weight"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>}],<span class="hljs-string"><span class="hljs-string">"threshold"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">"accounts"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"permission"</span></span>:{<span class="hljs-string"><span class="hljs-string">"actor"</span></span>:<span class="hljs-string"><span class="hljs-string">"supplier"</span></span>,<span class="hljs-string"><span class="hljs-string">"permission"</span></span>:<span class="hljs-string"><span class="hljs-string">"eosio.code"</span></span>},<span class="hljs-string"><span class="hljs-string">"weight"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>},{<span class="hljs-string"><span class="hljs-string">"permission"</span></span>:{<span class="hljs-string"><span class="hljs-string">"actor"</span></span>:<span class="hljs-string"><span class="hljs-string">"billelectro"</span></span>,<span class="hljs-string"><span class="hljs-string">"permission"</span></span>:<span class="hljs-string"><span class="hljs-string">"eosio.code"</span></span>},<span class="hljs-string"><span class="hljs-string">"weight"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>}],<span class="hljs-string"><span class="hljs-string">"waits"</span></span>:[]}}' -p electricity</code> </pre> <br><p>  Se emiti√≥ un error: autoridad no v√°lida.  Aqu√≠ los mentores ya no pudieron ayudarnos: dijeron que ellos mismos no hicieron esto.  ¬øY quien lo hizo?  Quiz√°s solo Dan Larimer.  No pudimos encontrar r√°pidamente la causa del error en el c√≥digo EOS y ya hemos comenzado a considerar opciones alternativas, sin una cadena de llamadas.  Se evit√≥ maravillosamente que el mecanismo para llamar a otros contratos en EOS tambi√©n sea diferente del √©ter.  Cuando se llama a otro contrato, esta llamada se pone en cola y solo se completar√° despu√©s de que se complete la llamada actual.  No funcionar√° llamar el contrato y despu√©s de la llamada leer los datos registrados por este contrato. </p><br><p>  M√°s tarde, despu√©s de todo, encontraron en el c√≥digo EOS la raz√≥n del error al establecer los derechos para dos contratos.  Resulta que las cuentas en la lista de derechos deben ordenarse por cuenta: se <em>asegura de que todas las claves sean √∫nicas y est√©n ordenadas y que todos los permisos de la cuenta sean √∫nicos y est√©n ordenados</em> ( <a href="">autoridad.hpp</a> ).  Despu√©s de cambiar el orden de las cuentas, la actualizaci√≥n de los derechos funcion√≥, y nuestro sistema de contratos comenz√≥ a funcionar. </p><br><h3 id="232-problema-c-funkciy-raboty-s-pamyatyu">  2.3.2.  El problema de las funciones C con memoria </h3><br><p>  Es rid√≠culo decirlo, pero al final no pudimos usar las funciones listas para analizar n√∫meros (!) Para leer la configuraci√≥n de facturaci√≥n.  Despu√©s de <code>std::istringstream</code> funci√≥n <code>std::istringstream</code> , lo cual es bastante extra√±o.  Y al usar <code>atof</code> y similares, as√≠ como <code>sscanf</code> - <code>env.realloc</code> ajust√≥.  Por alguna raz√≥n, las funciones mencionadas de trabajar con la memoria de la biblioteca C est√°ndar no se encontraron durante la carga de c√≥digo en los nodos.  Las funciones de C ++ que funcionan con la memoria funcion√≥. </p><br><p>  Por supuesto, al ejecutar el contrato de WebAssembly, no se utiliza un asignador de memoria est√°ndar, sino su propio entorno limitado, que se proporciona a cada transacci√≥n bajo ciertas condiciones.  Adem√°s, el soporte para las funciones C de trabajar con memoria en la parte superior de este entorno limitado se ha implementado durante mucho tiempo, su implementaci√≥n est√° en <a href="">los contratos EOS est√°ndar</a> .  Probablemente algo sali√≥ mal en la etapa de enlace. </p><br><p>  Despu√©s de pasar aproximadamente una hora buscando una salida, incluso con la ayuda de uno de los mentores, decidimos no continuar y hacer una soluci√≥n alternativa: escribir nuestro propio c√≥digo que resuelva el problema de analizar n√∫meros.  El mecanismo EOS de flujo de datos no nos conven√≠a: requer√≠a la capacidad de guardar paquetes de datos de diferentes estructuras en un campo y formarlos a mano (las configuraciones de facturaci√≥n). </p><br><h3 id="233-billing-pokupok">  2.3.3.  Facturaci√≥n de compras </h3><br><p>  En el segundo viento, que fue abierto por los ingenieros de energ√≠a o por el desayuno temprano, escribieron la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">facturaci√≥n</a> de las compras en la tienda.  El esquema general de trabajo es el siguiente: </p><br><ol><li>  El proveedor crea un contrato de facturaci√≥n y lo prescribe en su contrato general. </li><li>  En el punto de venta de la tienda, el proveedor establece marcos que pueden leer RFID, interactuar con EOS y tener sus propias cuentas prescritas en el contrato de facturaci√≥n. </li><li>  Cada producto en la tienda est√° equipado con una etiqueta RFID, todas las etiquetas est√°n registradas en el contrato de facturaci√≥n. </li><li>  El comprador paga los bienes escaneando su RFID, y los bienes se eliminan del contrato de facturaci√≥n. </li><li>  A la salida de la tienda, los marcos tambi√©n leen las compras de RFID.  Si los productos todav√≠a est√°n en la tienda, la transacci√≥n no pasa y el marco debe hacer sonar la alarma (s√≠, de hecho, ni siquiera puede enviar la transacci√≥n, solo lea la tabla). </li></ol><br><p>  No tiene sentido detenerse en el c√≥digo del contrato en s√≠: este es C ++ 14 est√°ndar con algunas construcciones y bibliotecas espec√≠ficas de EOS.  Mejor dicho en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">EOSIO Wiki</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">EOSIO Developer Portal</a> . </p><br><h3 id="234-frontend">  2.3.4.  Frontend </h3><br><p>  La parte frontal del proyecto se implement√≥ usando React.  En lugar de lo habitual, muchos Redux decidieron usar MobX, que acelera significativamente el desarrollo y le permite administrar el estado global sin dolor de cabeza. </p><br><p>  La fase de integraci√≥n de front-blockchain no fue tan fluida como se esperaba.  El paquete <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">eosjs</a> se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">est√°</a> finalizando de manera muy activa, seguido de la billetera EOS para el navegador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Scatter</a> .  En este grupo, esto a menudo causa problemas.  Y no el hecho de que el c√≥digo que funcion√≥ ayer funcionar√° bien hoy.  Pisamos este rastrillo (y no la primera vez).  Una hora de intentar y depurar en un estado somnoliento: el problema est√° resuelto. </p><br><p>  Considere un diagrama simplificado de la interacci√≥n del lado del cliente de la aplicaci√≥n con eos.  Para hacer esto, necesita la biblioteca eosjs y la extensi√≥n del navegador Scatter. </p><br><p>  ¬°Te lo recordamos!  Scatter se actualiza activamente despu√©s de eosjs, no olvide actualizar la biblioteca. </p><br><p>  A continuaci√≥n, un breve vistazo a la lectura y la escritura.  Hay dos formas de comunicarse con contratos inteligentes en EOS: el env√≠o de transacciones (hace que la cadena de bloques se modifique, sin proporcionar valores de retorno) y las tablas de lectura (acci√≥n de solo lectura). </p><br><p>  Considere el c√≥digo de env√≠o de la transacci√≥n: </p><br><pre> <code class="hljs markdown"> sendTransaction(funcName, data) { return this.scatter .suggestNetwork(this.network) .then(() =&gt; this.scatter.getIdentity({ accounts: [<span class="hljs-string"><span class="hljs-string">this.network</span></span>] })) .then((identity) =&gt; { let accountName = this.getAccountName(identity); // wrap eos instance const eos = this.scatter.eos(this.network, Eos, this.configEosInstance); return eos.transaction(accountName, (contract) =&gt; { contract[<span class="hljs-string"><span class="hljs-string">funcName</span></span>](<span class="hljs-link"><span class="hljs-link">data, { authorization: accountName }</span></span>); }); }); }</code> </pre> <br><p>  Argumentos de entrada: nombre y objeto de la funci√≥n, sus valores son argumentos de esta funci√≥n.  Tercera l√≠nea: confirmamos la red a trav√©s de la cual interactuamos con EOS.  Cuarta l√≠nea: obtenemos <code>identity</code> , el par√°metro es un objeto con el campo de <code>accounts</code> (para esta red).  La funci√≥n <code>getAccountName</code> devuelve la primera cuenta de la lista de cuentas recibidas (en el objeto de <code>identity</code> ). </p><br><p>  En este ejemplo, Scatter se usa para firmar una transacci√≥n.  Scatter es un contenedor sobre una instancia de la clase <code>Eos</code> .  En la l√≠nea 9, llamamos al m√©todo <code>eos</code> , sus par√°metros: </p><br><ol><li>  <code>this.network</code> : un objeto con par√°metros de red. </li><li>  <code>Eos</code> es una instancia de eosjs. </li><li>  <code>this.configEosInstance</code> : un objeto con par√°metros para una instancia de Eos (ver dock eosjs). </li></ol><br><p>  El √∫ltimo m√©todo de <code>transaction</code> acepta <code>accountName</code> y <code>callback</code> como entrada, el argumento <code>callback</code> es un contrato ubicado en la cuenta <code>accountName</code> .  En la <code>callback</code> de <code>callback</code> 'e, llamamos al m√©todo del contrato recibido con el objeto, sus claves son los argumentos del m√©todo llamado. </p><br><p>  Considere el m√©todo de lectura de tablas: </p><br><pre> <code class="hljs kotlin"> readTable(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eos = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scatter.eos(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.network, Eos, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.configEosInstance); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eos.getTableRows({ json: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, limit: <span class="hljs-number"><span class="hljs-number">1</span></span>, ...<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, }); }</code> </pre> <br><p>  Aqu√≠ para leer solo necesitamos una instancia de <code>eos</code> . </p><br><p>  Para dise√±ar la interfaz, dejamos caer Materialise, Semantic y Ant, y preparamos estilos nosotros mismos.  En las √∫ltimas horas del hackathon, apareci√≥ una idea para revivir la interfaz de usuario, agregar una visualizaci√≥n del proceso.  Destac√≥ las nuevas filas de la tabla durante dos segundos en verde y obtuvo un efecto genial a la cotizaciones de bolsa.  La mejora aument√≥ significativamente el atractivo del proyecto y se convirti√≥ en la etapa final de la construcci√≥n de la interfaz de usuario. </p><br><h1 id="3-sborka">  3. Asamblea </h1><br><p>  Tres horas antes del final del tiempo, ten√≠amos una Raspberry Pi con el medidor de electricidad Mercury y un lector RFID conectado, as√≠ como una luz indicadora.  Toda la electricidad de la mesa pas√≥ por el Mercurio.  Por cada 0.3125 Wh / h gastados, as√≠ como por cada "compra", Raspberry Pi envi√≥ transacciones a nuestra cadena de bloques, y el proveedor de servicios pudo administrar usuarios, sensores, facturaci√≥n y ver estad√≠sticas de consumo. </p><br><p><img src="https://habrastorage.org/webt/y6/uq/mz/y6uqmz1upvprppiimceoecejewg.jpeg"></p><br><p>  Durante otra hora, nos dedicamos tranquilamente a los controles y agregamos los toques finales.  Dos horas antes del final de los tiempos, recibimos un producto completo con dos casos implementados, ilustrando completamente el concepto, ¬°e incluso sin compromisos en los √∫ltimos minutos! </p><br><h1 id="4-demonstraciya">  4. Demostraci√≥n </h1><br><p>  Las demostraciones de proyectos (tambi√©n conocidos como lanzamientos) consistieron en dos etapas.  En la primera etapa, 69 equipos participantes se dividieron en cuatro grupos, cada uno de ellos fue alimentado por separado frente a dos jueces y sin espectadores.  Los jueces otorgaron calificaciones (cuatro criterios de 5 puntos cada una) y, con base en estas calificaciones, los 10 mejores equipos fueron seleccionados para la segunda etapa.  Estos equipos tuvieron la oportunidad de organizar un proyecto en un gran escenario frente a la audiencia y los ocho jueces. </p><br><p>  Terminamos en el primer grupo, nuestros jueces fueron el CEO y presidente (me pregunto c√≥mo difieren estas posiciones) de Everipedia.  Se asignaron tres minutos para el rendimiento, se controlaron estrictamente por temporizador.  Terminamos nuestro inconsistente, pero llamamos a impresionar el discurso 30 segundos antes de lo previsto.  Los jueces preguntaron algo superficialmente y bastante pronto, y la manifestaci√≥n termin√≥. </p><br><p>  Nosotros, los ingenuos, nos sorprendi√≥ que no prest√°ramos atenci√≥n a la capacidad de trabajo real del producto, y a√∫n m√°s al c√≥digo del juez.  Los problemas de implementaci√≥n t√©cnica no les interesaban ni en lo m√°s m√≠nimo.  Tambi√©n podr√≠amos mostrar las bombillas de Raspberry Pi y la imagen en el frente. </p><br><p>  Hab√≠a una sensaci√≥n de que con la presentaci√≥n del proyecto fracasamos, porque esper√°bamos impresionar con una soluci√≥n real, un prototipo, y no solo una descripci√≥n colorida de un proyecto socialmente significativo y ambicioso.  Todo se jug√≥ como por notas: describimos el problema, el dolor, nuestra soluci√≥n, mostramos c√≥mo funciona y describimos los planes de desarrollo del proyecto.  Conociendo de antemano los m√©todos de juzgar, hubi√©ramos hecho de manera muy diferente. </p><br><p>  Los jueces de las cuatro transmisiones de la primera ronda redujeron sus puntajes e intercambiaron puntos de vista 15 minutos despu√©s del final de los lanzamientos.  Despu√©s del anuncio de los ganadores comenz√≥.  Una atm√≥sfera nerviosa reinaba en la sala: cansados ‚Äã‚Äãdespu√©s del marat√≥n de 26 horas, la gente quer√≠a ganar, hab√≠a muchos equipos fuertes y sab√≠an que pod√≠an reclamar la victoria.  Y lo sab√≠amos, y esperamos los resultados. </p><br><p>  Para evitar que los espectadores se relajen, los resultados se anunciaron en tres partes.  Los primeros cuatro finalistas, luego tres m√°s, luego otros tres.  Entre anuncios y al final - actuaciones.  No entramos en el top 10 y no tuvimos la oportunidad de entrar en el gran escenario.  Dos equipos de habla rusa llegaron a los diez primeros, uno de los cuales finalmente se convirti√≥ en el tercero.  Felicitaciones a los ganadores, se merecen sus premios. </p><br><h1 id="5-zaklyuchenie-i-plany">  5. Conclusi√≥n y planes </h1><br><p>    AngelHack    .     ,   .     ‚Äî  ,  ,      . ,     ,       ,      ‚Äî   . </p><br><p>  26         IoT-   EOS.         ,   . </p><br><p>    ‚Äî      UI (  ‚Äî  -- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Smartz</a> ),     .  - ,     blockchain-ready  ,   , ‚Äî    .  :) </p><br><p><img src="https://habrastorage.org/webt/1i/9q/nq/1i9qnqngvpnjizwpepz4n_b4gkc.gif"></p><br><p>   ,    ,         ¬´¬ª, ¬´¬ª  . .  5           .   ,         100    ,          .            SensorPay   ! </p><br><p>     : </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">Yuvasee</a>  (entrepreneur) <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">algs</a>  (hardware &amp; backend developer) <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">therealal</a>  (architect, backend developer, devops) <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">bolbu</a>  (frontend developer) <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">quantum</a>  (blockchain &amp; backend developer) </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es414803/">https://habr.com/ru/post/es414803/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es414791/index.html">Seminario "Infraestructura virtual para desarrolladores: oportunidades, aplicaciones y servicios", 28 de junio, San Petersburgo</a></li>
<li><a href="../es414793/index.html">¬øC√≥mo funcionan los canales de pago y la red Lightning en Bitcoin?</a></li>
<li><a href="../es414797/index.html">C√≥mo creamos l√≠neas abiertas en Bitrix24</a></li>
<li><a href="../es414799/index.html">LLTR Parte 0: detecci√≥n autom√°tica de topolog√≠a de red y conmutadores no administrados. Misi√≥n imposible?</a></li>
<li><a href="../es414801/index.html">Moscow Vue.js Meetup # 2 en Mail.Ru Group</a></li>
<li><a href="../es414805/index.html">Webinar abierto "M√©todos alternativos de reclutamiento"</a></li>
<li><a href="../es414809/index.html">Swift 4.1: por que Apple renombr√≥ flatMap a compactMap</a></li>
<li><a href="../es414811/index.html">Integra Telegram y Avaya</a></li>
<li><a href="../es414813/index.html">Crear plantillas en el IDE de Jetbrains</a></li>
<li><a href="../es414817/index.html">Ciber abuela, o c√≥mo pirateamos un d√≠a</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>