<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíª üë©‚Äçüé® üåÖ OceanLotus: nouvelle porte d√©rob√©e, anciens sch√©mas üî† üë®üèª‚Äçüè´ ü§õüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le groupe OceanLotus (alias APT32 et APT-C-00) est connu pour ses attaques en Asie de l'Est. L‚Äôann√©e derni√®re, un certain nombre d‚Äô√©tudes sur les trav...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OceanLotus: nouvelle porte d√©rob√©e, anciens sch√©mas</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/eset/blog/421779/">  Le groupe OceanLotus (alias APT32 et APT-C-00) est connu pour ses attaques en Asie de l'Est.  L‚Äôann√©e derni√®re, un certain nombre d‚Äô√©tudes sur les travaux du groupe ont √©t√© publi√©es, y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">compris des</a> documents <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CyberReason</a> , une revue <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FireEye</a> et une description de l‚Äôattaque de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Volexity</a> .  Comme nous pouvons le voir, le groupe met √† jour les portes d√©rob√©es, l'infrastructure et les vecteurs d'infection. <br><br>  OceanLotus continue de cibler les entreprises et les agences gouvernementales en Asie de l'Est.  Selon la t√©l√©m√©trie ESET, les objectifs prioritaires d'OceanLotus sont au Vietnam, au Laos, au Cambodge et aux Philippines. <br><br>  Il y a quelques mois, nous avons d√©couvert et analys√© l'une de leurs derni√®res portes d√©rob√©es.  Il met en ≈ìuvre plusieurs outils qui rendent difficile l'analyse et √©vitent la d√©tection - nous en discuterons dans un article. <br><br><img src="https://habrastorage.org/webt/4f/mf/dz/4fmfdzgqiqskqku5rz7eeprycti.jpeg"><br><br><a name="habracut"></a><h2>  Distribution </h2><br>  Les attaquants utilisent diff√©rentes m√©thodes pour convaincre la victime de lancer un compte-gouttes malveillant. <br><br><h3>  Double extensions et fausses ic√¥nes d'application (Word, PDF, etc.) </h3><br>  Les compte-gouttes sont susceptibles de se propager via des pi√®ces jointes aux e-mails.  Nous avons observ√© les noms de fichiers suivants: <br>  - <code>Mi17 Technical issues - Phonesack Grp.exe</code> (Mi-17 - Mod√®le d'h√©licopt√®re russe) <br>  - <code>Chi tiet don khieu nai gui saigontel.exe</code> (traduit du vietnamien - ¬´d√©tails de la r√©clamation envoy√©e √† Saigontel¬ª, Saigontel - soci√©t√© de t√©l√©communications vietnamienne) <br>  - <code>Updated AF MOD contract - Jan 2018.exe</code> <br>  - <code>remove_pw_Reschedule of CISD Regular Meeting.exe</code> <br>  - <code>Sorchornor_with_PM_-_Sep_2017.exe</code> <br>  - <code>20170905-Evaluation Table.xls.exe</code> <br>  - <code>CV_LeHoangThing.doc.exe</code> (de faux CV ont √©galement √©t√© trouv√©s au Canada) <br><br>  Tous ces fichiers ont quelque chose en commun: lancer un document d'app√¢t prot√©g√© par mot de passe.  Il n'est pas clair si le mot de passe se trouve quelque part dans les donn√©es de la lettre transmise, ou si le document ne doit pas √™tre ouvert. <br><br><h3>  Faux installateurs </h3><br>  Plusieurs faux installateurs se faisant passer pour des installateurs ou des mises √† jour logicielles ont √©t√© rep√©r√©s dans des campagnes de points d'eau.  Un exemple est le programme d'installation de Firefox reconditionn√© d√©crit par 360 Labs sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Freebuf</a> (en chinois). <br><br>  Un autre √©chantillon que nous avons vu s'appelait <code>RobototFontUpdate.exe</code> .  Il s'est probablement propag√© √† travers des sites compromis, mais nous n'en avons pas suffisamment de preuves. <br><br>  Tous les fichiers d√©crits, qu'ils aient √©t√© distribu√©s par courrier ou t√©l√©charg√©s lors de la visite d'un site compromis, livraient le m√™me composant de porte d√©rob√©e.  Dans un article, nous analyserons un √©chantillon de <code>RobototFontUpdate.exe</code> et montrerons comment il parvient √† ex√©cuter une charge utile malveillante sur le syst√®me. <br><br><h2>  Analyse technique </h2><br>  Le processus d'installation et d'ex√©cution d√©pend de l'obfuscation multicouche, √† savoir le chiffrement des composants, la reconstruction des fichiers PE, le chargement de shellcode et les techniques de chargement lat√©ral.  Ce dernier a √©t√© d√©crit dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©c√©dente √©tude Korplug d'</a> ESET. <br><br><h3>  Examen des progr√®s </h3><br>  L'attaque se compose de deux parties: un compte-gouttes et un lanceur.  Chaque √©tape de chaque partie du processus sera expliqu√©e en d√©tail dans la section correspondante.  Les deux diagrammes ci-dessous donnent une br√®ve id√©e de la progression globale du malware. <br><br><img src="https://habrastorage.org/webt/yn/wa/jd/ynwajd8empdclmahz0mzaarmpxk.png"><br>  <i>Figure 1. La progression du compte-gouttes</i> <br><br><img src="https://habrastorage.org/webt/gv/ba/jb/gvbajbzaqzd6tmrjpj95nkov-j8.png"><br>  <i>Figure 2. Progression de la porte d√©rob√©e</i> <br><br>  Presque tous ces composants sont obscurcis.  L'obfuscation est bas√©e sur des commandes de transition de paires conditionnelles compl√©mentaires.  Pour chacune des formes: JZ / JNZ, JP / JNP, JO / JNO et ainsi de suite, chaque paire effectue une transition vers le m√™me objectif.  La s√©quence est entrecoup√©e de code ind√©sirable qui utilise le pointeur de pile mais ne modifie pas la valeur de l'indicateur conditionnel.  Il s'av√®re que la transition se produit dans la m√™me branche.  Cela entra√Æne des probl√®mes lors du processus de d√©compilation en raison de l'utilisation de valeurs de pointeur de pile positives. <br><br><img src="https://habrastorage.org/webt/lh/y6/an/lhy6anvm_1feplhj7depx1udiiu.png"><br>  <i>Figure 3. Transition conditionnelle compl√©mentaire</i> <br><br>  De plus, certains √©l√©ments de base du programme ajoutent une adresse √† la pile, apr√®s quoi ils se terminent par JMP / CALL, tandis que d'autres √©l√©ments de base ajoutent deux adresses et se terminent par la commande RET.  Le second ajout d'√©l√©ment est la fonction appel√©e, et le premier est l'adresse du prochain √©l√©ment de programme de base o√π la transition sera effectu√©e.  Ainsi, les √©l√©ments de base du programme sont cr√©√©s sans objets parents. <br><br><img src="https://habrastorage.org/webt/jc/5j/dw/jc5jdw3rbtwezkp4ylemfursggw.png"><br>  <i>Figure 4. Technique PUSH / JMP</i> <br><br>  Gr√¢ce √† une combinaison de deux techniques d'obscurcissement, de ¬´beaux¬ª graphiques sont obtenus: <br><br><img src="https://habrastorage.org/webt/3l/pe/3x/3lpe3x_ccjdkh9rm0rpxyykztf0.png"><br>  <i>Figure 5. Obscurcir une s√©quence d'ex√©cution</i> <br><br>  Remarquer le code ind√©sirable est assez simple.  Il peut √™tre ignor√© dans l'analyse des √©chantillons, si vous connaissez le sch√©ma d'application. <br><br><h2>  Compte-gouttes </h2><br><h3>  √âtape 1. Document d'app√¢t </h3><br>  Ces derniers mois, OceanLotus a utilis√© plusieurs leurres.  L'un d'eux est un faux logiciel pour mettre √† jour la police TrueType <code>Roboto Slab regular</code> .  Le choix d'une police semble un peu √©trange, car il ne prend pas en charge de nombreuses langues d'Asie de l'Est. <br><br><img src="https://habrastorage.org/webt/2p/p8/sm/2pp8sm8gjt15kzqakmyooah1pk8.jpeg"><br>  <i>Figure 6. Ic√¥ne de mise √† jour de la police RobototFontUpdate</i> <br><br>  Une fois ex√©cut√©, le fichier binaire d√©chiffre ses ressources (XOR, 128 octets, cl√© cod√©e en dur) et restaure les donn√©es d√©chiffr√©es (LZMA).  Fichier RobotoSlab-Regular.ttf l√©gitime <br><br>  (SHA1: <code>912895e6bb9e05af3a1e58a1da417e992a71a324</code> ) est √©crit dans le dossier <code>%temp%</code> et lanc√© √† l'aide de la fonction <code>ShellExecute</code> API Win32. <br><br>  Le code shell d√©crypt√© √† partir des ressources est ex√©cut√©.  Apr√®s ex√©cution, une fausse mise √† jour de police impl√©mente une autre application dont le seul but est de supprimer le compte-gouttes.  Cette application d'effacement est <code>%temp%\[0-9].tmp.exe</code> tant que <code>%temp%\[0-9].tmp.exe</code> . <br><br><h3>  √âtape 2. Code shell </h3><br>  √Ä chaque √©tape, le m√™me shellcode est utilis√©. <br><br>  Le shellcode est un chargeur PE personnalis√©.  Il restaure le fichier ex√©cutable en m√©moire - d√©chiffre toutes les sections et calcule les mouvements et autres retraits n√©cessaires.  Le <code>RtlMoveMemory</code> utilise les trois fonctions de l'API Windows: <code>VirtualAlloc</code> , <code>RtlZeroMemory</code> et <code>RtlZeroMemory</code> . <br><br>  La fonction <code>RtlZeroMemory</code> utilis√©e pour <code>RtlZeroMemory</code> champs dans l'en-t√™te PE.  Le recours √† un vidage automatique de la m√©moire √©chouera, car les en-t√™tes MZ / PE sont corrompus. <br>  Le code shell appelle la fonction de connexion PE d√©chiffr√©e, puis la <code>DLLEntry</code> exportation <code>DLLEntry</code> . <br><br><h3>  √âtape 3. Le vrai compte-gouttes </h3><br> <code>{103004A5-829C-418E-ACE9-A7615D30E125}.dll</code> <br>  Cet ex√©cutable d√©chiffre les ressources √† l'aide de l'algorithme AES en mode CBC via l'API Windows.  La cl√© cod√©e en dur a une taille de 256 bits.  Apr√®s d√©cryptage, les donn√©es compress√©es sont d√©compress√©es (algorithme LZMA). <br><br>  Si le processus est d√©marr√© avec des droits d'administrateur, les logiciels malveillants assurent la persistance en cr√©ant un service.  Sinon, la cl√© de Registre Run classique est utilis√©e ( <code>HKCU\SOFTWARE\Microsoft\ Windows\CurrentVersion\Run;DeviceAssociationService;rastlsc.exe</code> ). <br><br>  Si le code dropper est ex√©cut√© avec des droits d'administrateur, il essaie d'√©crire les fichiers r√©pertori√©s ci-dessous dans le dossier <code>C:\Program Files\Symantec\Symantec Endpoint Protection\12.1.671.4971.104a\DeviceAssociationService\</code> , sinon, les √©crit dans le dossier <code>%APPDATA%\Symantec\Symantec Endpoint Protection\12.1.671.4971.104a\DeviceAssociationService\</code> : <br><br>  - <code>rastlsc.exe</code> (SHA1: <code>2616da1697f7c764ee7fb558887a6a3279861fac</code> , copie de l'application l√©gitime Symantec Network Access Control, <code>dot1xtra.exe</code> ) <br>  - <code>SyLog.bin</code> (SHA1: <code>5689448b4b6260ec9c35f129df8b8f2622c66a45</code> , porte d√©rob√©e crypt√©e) <br>  - <code>rastls.dll</code> (SHA1: <code>82e579bd49d69845133c9aa8585f8bd26736437b</code> , une DLL malveillante que <code>rastlsc.exe</code> ) <br><br>  Le chemin varie d'un √©chantillon √† l'autre, mais la disposition est similaire.  Selon les droits, le logiciel malveillant vide les fichiers dans <code>%ProgramFiles%</code> ou <code>%appdata%</code> .  Nous avons √©galement observ√©: <br><br>  - <code>\Symantec\CNG Key Isolation\</code> <br>  - <code>\Symantec\Connected User Experiences and Telemetry\</code> <br>  - <code>\Symantec\DevQuery Background Discovery Broker Tasks\</code> <br><br>  Ces chemins sont utilis√©s par divers produits Symantec. <br><br>  Apr√®s avoir atteint la persistance et impl√©ment√© le fichier ex√©cutable, un fichier l√©gitime, <br>  <code>rastlsc.exe</code> , est ex√©cut√© √† l'aide de <code>CreateProcessW</code> . <br><br>  Nous avons √©galement observ√© une version ( <code>{BB7BDEC9-B59D-492E-A4AF-4C7B1C9E646B}.dll</code> ) qui ex√©cute <code>rastlsc.exe</code> avec le param√®tre <code>krv</code> .  Nous discuterons plus en d√©tail ci-dessous. <br><br><h2>  Composant de porte d√©rob√©e: remplissage rastlsc.exe </h2><br>  L'√©quipe OceanLotus utilise une technique ancienne et bien connue dans l'un des ex√©cutables des produits Symantec.  L'essentiel est d'utiliser le processus de chargement d'une biblioth√®que d'un fichier .exe l√©gitime et sign√© en √©crivant une biblioth√®que malveillante dans le m√™me dossier.  Cela rendra le comportement malveillant l√©gitime car ces actions sont effectu√©es pendant que l'ex√©cutable approuv√© est en cours d'ex√©cution. <br><br>  Comme mentionn√© ci-dessus, le fichier <code>rastlsc.exe</code> l√©gitime est r√©initialis√© et ex√©cut√©. <br>  Il importe le fichier <code>rastls.dll</code> , qui dans ce cas a un contenu malveillant. <br><br><img src="https://habrastorage.org/webt/jy/ga/ax/jygaaxccovxfilcmjrol9rmoklu.jpeg"><br>  <i>Figure 7. Rastlsc.exe sign√© num√©riquement de Symantec</i> <br><br>  Nous avons √©galement constat√© un remplissage √† l'aide d'autres ex√©cutables l√©gitimes et sign√©s, y compris <code>mcoemcpy.exe</code> de McAfee, qui charge <code>McUtil.dll</code> .  Cette technique √©tait auparavant utilis√©e par PlugX, qui a attir√© l'attention du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vietnam CERT</a> (en vietnamien). <br><br><h3>  √âtape 1. Remplissage de la biblioth√®que, rastls.dll </h3><br>  Le nom interne du fichier dll est <code>{7032F494-0562-4422-9C39-14230E095C52}.dll</code> , mais nous avons vu d'autres versions, par exemple <code>{5248F13C-85F0-42DF-860D-1723EEAA4F90}.dll</code> .  Toutes les fonctions export√©es conduisent √† l'ex√©cution de la m√™me fonction. <br><br><img src="https://habrastorage.org/webt/hg/1h/qm/hg1hqmssbsek8-kl8e7dkbzsotq.jpeg"><br>  <i>Figure 8. Toutes les exportations rasltls.dll conduisent √† une seule fonction</i> <br><br>  Export essaie de lire le fichier <code>SyLog.bin</code> situ√© dans le m√™me dossier.  D'autres versions ont essay√© d'ouvrir le fichier <code>OUTLFLTR.DAT</code> .  Si le fichier existe, il sera d√©crypt√© √† l'aide de l'algorithme AES en mode CBC avec une cl√© de 256 bits cod√©e en dur, puis les donn√©es compress√©es re√ßues seront d√©compress√©es (compression LZMA). <br><br>  La variante <code>McUtil.dll</code> utilise une technique diff√©rente.  √Ä premi√®re vue, la fonction principale ne fait rien de malveillant, mais en fait elle remplace la section <code>.text</code> du fichier l√©gitime <code>mcoemcpy.exe</code> , un fichier binaire.  Il g√©n√®re un shellcode dont la t√¢che est d'appeler une fonction pour lire le shellcode crypt√© de la deuxi√®me √©tape √† partir du fichier <code>mcscentr.adf</code> . <br><br>  Le pseudo-code suivant est utilis√© pour cr√©er du code shell: <br><br> <code>x = False i = 0 <br> buff = genRandom() <br> opc1 = [0x58,0x59,0x5a,0x5b] <br> opc2 = [0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57] <br> opc3 = [0x90,0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48, <br> 0x49,0x4a,0x4b] <br> while i &lt; len(buff): <br> currentChar = buff[i] if currentChar &lt; 0xc8: <br> buff[i] = opc1[currentChar % len(opc1)] <br> else: <br> if x: <br> buff[i] = opc2[currentChar % len(opc2)] <br> else: <br> buff[i] = opc3[currentChar % len(opc3)] x = x == False <br> i+=1</code> <br> <br>  Ci-dessous dans la figure, vous pouvez voir une liste du r√©sultat de l'assembleur: <br><br><img src="https://habrastorage.org/webt/i8/4y/gg/i84yggcraq46pahxx_g5gzha4_y.png"><br>  <i>Figure 9. Shellcode g√©n√©r√©</i> <br><br><h3>  √âtapes 2 √† 4.  Shellcode, lanceur et shellcode √† nouveau </h3><br>  Le <code>{E1E4CBED-5690-4749-819D-24FB660DF55F}.dll</code> d√©crypte et t√©l√©charge la <code>{E1E4CBED-5690-4749-819D-24FB660DF55F}.dll</code> .  La biblioth√®que charge des ressources et essaie de d√©marrer le service DeviceAssociationService.  Les informations d√©crypt√©es contiennent √©galement un shellcode.  Ce dernier d√©crypte la derni√®re √©tape: une porte d√©rob√©e. <br><br>  La variante <code>{92BA1818-0119-4F79-874E-E3BF79C355B8}.dll</code> v√©rifie si <code>rastlsc.exe</code> ex√©cut√© avec <code>krv</code> comme premier param√®tre.  Si tel est le cas, une t√¢che est cr√©√©e et <code>rastlsc.exe</code> est √† nouveau ex√©cut√©, mais sans ce param√®tre. <br><br><h3>  √âtape 5. Porte d√©rob√©e </h3><br> <code>{A96B020F-0000-466F-A96D-A91BBF8EAC96}.dll</code> <br> <br>  Tout d'abord, le malware essaie de t√©l√©charger ses ressources et de les d√©crypter en utilisant l'algorithme RC4.  Les ressources r√©sultantes contiennent des donn√©es utilis√©es pour configurer la porte d√©rob√©e.  Le format de configuration n'est pas difficile √† trouver.  En utilisant la structure Kaitai et son amortisseur de structure, nous obtenons ce qui suit: <br><br><img src="https://habrastorage.org/webt/wv/sq/7r/wvsq7r5rn67px5msvrjogbnoelk.jpeg"><br>  <i>Figure 10. Structure de configuration</i> <br><br>  <b>Remarque</b> : √† l'exception de la ligne domain_encoding_str et de la biblioth√®que httpprov, les donn√©es changent d'un √©chantillon √† l'autre.  Les cl√©s de registre sont presque les m√™mes, mais elles ont un sch√©ma similaire: <code>\HKCU\SOFTWARE\Classes\AppX[a-f0-9]{32}</code> , rien de remarquable. <br><br>  Le programme malveillant re√ßoit les 10 premiers octets du nom d'utilisateur (UTF-16), les code avec la cha√Æne de trois lettres <code>mutex_encoding_str</code> en UTF-16 et le code en hexad√©cimal.  Le r√©sultat est utilis√© comme nom du mutex.  Par exemple, pour un utilisateur dont le nom commence par <code>abc</code> et une cl√© sous la forme de <code>vwx</code> , le mutex sera <code>\Sessions\1\BaseNamedObjects\170015001b</code> . <br><br>  La porte d√©rob√©e comprend un chargeur PE qui charge la biblioth√®que <code>HTTPProv.dll</code> en m√©moire, appelle le point d'entr√©e, puis appelle la fonction d'exportation <code>CreateInstance</code> . <br><br><h3>  La communication </h3><br>  La porte d√©rob√©e utilise le protocole de communication TCP standard sur le port <code>25123</code> .  Pour obtenir l'adresse IP du serveur, la porte d√©rob√©e cr√©e d'abord une requ√™te DNS sp√©cifique. <br><br>  Le programme malveillant s√©lectionne l'un des trois domaines dans la configuration et ajoute un sous-domaine sp√©cial qui est g√©n√©r√© √† l'aide de deux valeurs.  La premi√®re valeur est le nom de l'ordinateur sur une longueur de 16 octets.  Le second est un ID de version √† quatre octets.  Le code Python 2 ci-dessous est un algorithme de codage: <br><br> <code>letters=domain_encoding_str # ‚Äúghijklmnop‚Äù hex_pc_name=pc_name.encode(‚ÄúUTF-16LE‚Äù).encode(‚Äúhex‚Äù) s='' <br> for c in hex_pc_name: <br> if 0x2f &lt; ord(c) &lt; 0x3a: <br> s+=letters[ord(c) - 0x30] <br> else: <br> s+=c</code> <br> <br>  Par exemple, si le nom de l'ordinateur est <code>random-pc</code> et que l'ID de version est 0x0a841523, le domaine suivant est g√©n√©r√©: <br> <code>niggmhggmeggmkggmfggmdggidggngggmjgg.ijhlokga.dwarduong[.]com</code> <br> <br>  L'expression r√©guli√®re suivante peut √™tre utilis√©e pour √©tiqueter le serveur C&amp;C de cette porte d√©rob√©e: <br> <code>[ghijklmnopabcdef]{4-60}\.[ghijklmnopabcdef]{8}\.[az]+\.[az]+</code> <br> <br>  Si l'adresse IP appartient √† un domaine sp√©cifique, le malware essaie d'√©tablir une connexion TCP via le port <code>25123</code> .  Chacun des exemples a trois noms de domaine diff√©rents qui sont utilis√©s pour trouver le serveur C&amp;C. <br><br>  Le processus de communication est crypt√© via RC4 et compress√© √† l'aide de LZMA.  Il est possible de d√©crypter le trafic, car la cl√© est ajout√©e au d√©but des paquets.  Le format est le suivant: <br> <code>[ RC4 (4 )][ ]</code> <br> <br>  Chaque octet cl√© est g√©n√©r√© par la fonction <code>rand</code> .  Apr√®s avoir d√©chiffr√© et d√©ball√© le paquet, les donn√©es ont le format suivant: <br> <code>[dw:][dw:][dw: ][dw: ][dw:] [dw:]</code> <br> <br>  La premi√®re fois que le client se connecte au serveur, l'UUID est transmis, qui est utilis√© comme identifiant de session.  Ce dernier est stock√© dans la cl√© de registre en tant que donn√©es binaires: <code>HKCU\SOFTWARE\Classes\ AppXc52346ec40fb4061ad96be0e6cb7d16a\DefaultIcon</code> <br><br>  Comme nous l'avons dit pr√©c√©demment, la porte d√©rob√©e contient √©galement une biblioth√®que appel√©e <code>HTTPprov</code> .  Il est utilis√© comme moyen alternatif de communiquer avec le serveur.  Le fichier DLL envoie une requ√™te POST via HTTP.  Il prend √©galement en charge HTTPS et les proxys utilisant SOCKS5, SOCKS4a et SOCKS4.  La biblioth√®que est li√©e statiquement √† <code>libcurl</code> . <br><br>  Apr√®s l'initialisation, une entr√©e de registre sera cr√©√©e - une commande pour que la porte d√©rob√©e utilise davantage HTTP pour communiquer avec le serveur de commandes: <code>HKCU\SOFTWARE\Classes\ CLSID{E3517E26-8E93-458D-A6DF-8030BC80528B}</code> . <br><br>  L'application cliente standard est utilis√©e: <code>Mozilla/4.0 ( ; MSIE 8.0; Windows NT 6.0; Trident/4.0)</code> . <br><br>  La principale caract√©ristique de cette biblioth√®que est un algorithme de cryptage sp√©cial pour un identifiant de ressource universel.  La partie ressource de l'URI est cr√©√©e √† l'aide du pseudocode suivant: <br><br> <code>buffEnd = ((DWORD)genRand(4) % 20) + 10 + buff; while (buff &lt; buffEnd){ <br> b=genRand(16); <br> if (b[0] - 0x50 &gt; 0x50) <br> t=0; <br> else <br> *buf++= UPPER(vowels[b[1] % 5]); <br> v=consonants[b[1]%21]); if (!t) <br> v=UPPER(v); <br> *buff++= v; <br> if (v!='h' &amp;&amp; b[2] - 0x50 &lt; 0x50) <br> *buff++= 'h'; <br> *buff++= vowels[b[4] % 5]; <br> if (b[5] &lt; 0x60) <br> *buff++= vowels[b[6] % 5]; <br> *buff++= consonants[b[7] % 21]; <br> if (b[8] &lt; 0x50) <br> *buff++= vowels[b[9] % 5]; <br> *buff++= '-'; <br> }; <br> *buff='\0';</code> <br> <br>  <b>Remarque</b> : pour plus de clart√©, la partie charg√©e de v√©rifier la longueur de la cha√Æne a √©t√© supprim√©e du code. <br><br>  Pour obtenir l'identifiant de la cha√Æne g√©n√©r√©e, deux nombres sont ajout√©s √† l'aide d'un algorithme sp√©cial de v√©rification de somme: <br><br> <code>checksum=crc32(buff) <br> num2=(checksum &gt;&gt; 16) + (checksum &amp; 0xffff) * 2 <br> num1=(num2 ^ 1) &amp; 0xf <br> URL=GENERATED_DOMAIN+ ‚Äú/‚Äù + num1 + ‚Äú/‚Äù + num2 + ‚Äú-‚Äù + buff</code> <br> <br>  En ajoutant le g√©n√©rateur d'URI de la biblioth√®que <code>HTTPprov</code> , nous obtenons l'URL suivante: <br> <code>hXXp://niggmhggmeggmkggmfggmdggidggngggmjgg.ijhlokga.aisicoin[.]com/ 13/139756-Ses-Ufali-L</code> <br> <br><h3>  √âquipes </h3><br>  Apr√®s avoir re√ßu l'identifiant de session SESSIONID, la porte d√©rob√©e cr√©e une empreinte digitale du syst√®me.  Le package est construit comme suit (retrait dans le package - description): <br><br>  <i>0x000</i> - octets: la valeur change dans chaque version <br>  <i>0x001</i> - 0x01: octet cod√© en dur <br>  <i>0x002</i> - bool: privil√®ges √©lev√©s <br>  <i>0x003</i> - dword: ID de version <br>  <i>0x007</i> - cha√Æne (UTF-16), nom d'ordinateur (max. 0x20) <br>  <i>0x027</i> - cha√Æne (UTF-16), nom d'utilisateur <br>  <i>0x079</i> - le r√©sultat d'une requ√™te de registre dans les valeurs <code>HKLM\SOFTWARE\Microsoft\Windows NT\ CurrentVersion</code> : <code>ProductName</code> , <code>CSDVersion</code> , <code>CurrentVersion</code> , <code>ReleaseId</code> , <code>CurrentBuildNumber</code> et le r√©sultat de l'appel √† <code>IsWow64Process (x86|x64)</code> <br>  <i>0x179</i> - le format suivant de la cha√Æne% s (% s);  remplac√© par ( <code>GetVolumeInformationW:VolumeNameBuffer</code> ), <code>VolumePathNames</code> <br>  <i>0x279</i> - Disque physique, contr√¥le d'E / S d'un p√©riph√©rique PhysicalDriveIOControl 0x2D1400 (IOCTL_STORAGE_QUERY_ PROPERTY) (VolSerialNumber) <br>  <i>0x379</i> - wmi <code>SELECT SerialNumber FROM Win32_BaseBoard</code> <br>  <i>0x3f9</i> - R√©cup√®re la date et l'heure actuelles GetSystemTimeAsFileTime <br>  <i>0x400</i> - bool: inconnu <br>  <i>0x401</i> - dword: re√ßu apr√®s d√©cryptage de la ressource <br><br>  Voici un exemple d'empreinte digitale syst√®me: <br><br><img src="https://habrastorage.org/webt/s5/kg/rj/s5kgrj1nop52oeuj-xgop8c7zsa.jpeg"><br>  <i>Figure 11. Empreinte digitale du syst√®me</i> <br><br>  Il s'agit d'une porte d√©rob√©e √† part enti√®re qui offre √† ses op√©rateurs un certain nombre de fonctionnalit√©s: manipulation du fichier, du registre et des processus, t√©l√©chargement de composants suppl√©mentaires, obtention d'une empreinte num√©rique du syst√®me.  Voici les num√©ros et les descriptions des commandes prises en charge: <br><br>  0 - empreinte digitale num√©rique <br>  1 - d√©finit l'ID de session <br>  2 - cr√©er un processus et obtenir un r√©sultat (en utilisant les canaux de programme) <br>  3 - d√©finit le compteur des tentatives de connexion <br>  4 - reporte l'heure du scrutin <br>  5 - lit un fichier ou une cl√© de registre et consid√®re MD5 <br>  6 - cr√©er un processus <br>  7 - cr√©e un fichier, une entr√©e de registre ou un flux en m√©moire <br>  8 - √©crit dans le registre <br>  9 - interroge le registre <br>  10 - recherche des fichiers dans le syst√®me <br>  11 - transf√®re les fichiers vers un autre r√©pertoire <br>  12 - supprime les fichiers du disque <br>  13 - Obtenir une liste des disques balis√©s dans le syst√®me en utilisant la fonction <br> <code>GetLogicalDriveStringW</code> <br>  14 - cr√©e un r√©pertoire <br>  15 - supprime le r√©pertoire <br>  16 - lit le fichier depuis l'offset <br>  17 - appelle le chargeur PE (passer √† la communication via <code>HTTPprov</code> ) <br>  18 - [inconnu] <br>  19 - 0: interrogation de la valeur dans le registre;  1: mise en ≈ìuvre et mise en ≈ìuvre du programme <br>  20 - d√©finit la variable d'environnement <br>  21 - lance le shellcode dans un nouveau thread <br>  22 - retourne la variable d'environnement <br>  23 dans la nouvelle version - red√©marre lui-m√™me si la variable d'environnement APPL n'existe pas <br><br><h2>  Conclusion </h2><br>  OceanLotus reste tr√®s actif et continue de mettre √† jour la bo√Æte √† outils. <br>  Le groupe cherche √† dissimuler ses activit√©s, pour cela les attaquants s√©lectionnent soigneusement les victimes, limitent la propagation des malwares, utilisent plusieurs serveurs afin de ne pas attirer l'attention sur le m√™me domaine ou la m√™me adresse IP.  Le d√©chiffrement du composant mis en ≈ìuvre et la technique de chargement lat√©ral, malgr√© sa grande popularit√©, permettent d'√©viter la d√©tection, puisque le travail des attaquants dans ce cas est d√©guis√© en application l√©gitime. <br><br><h2>  Indicateurs de compromis (IoC) </h2><br><h3>  √âchantillons </h3><br><h4>  Tableau 1: compte-gouttes </h4><br><img src="https://habrastorage.org/webt/4z/vz/kh/4zvzkhbbyci_fp6w6jyedbpn42i.png"><br><br><h4>  Tableau 2: biblioth√®ques </h4><br><img src="https://habrastorage.org/webt/0g/9i/2r/0g9i2rys-bufj_lmi9xqb7orl3g.png"><br><br><h3>  R√©seau </h3><br><h4>  Adresses IP </h4><br> <code>46.183.220.81 <br> 46.183.220.82 <br> 46.183.222.82 <br> 46.183.222.83 <br> 46.183.222.84 <br> 46.183.223.106 <br> 46.183.223.107 <br> 74.121.190.130 <br> 74.121.190.150 <br> 79.143.87.230</code> </div> </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr421779/">https://habr.com/ru/post/fr421779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr421765/index.html">Qu'est-ce qu'une application web en production?</a></li>
<li><a href="../fr421767/index.html">Les mineurs se voient offrir le statut de travailleur ind√©pendant</a></li>
<li><a href="../fr421769/index.html">Le livre "Deep Learning on R"</a></li>
<li><a href="../fr421773/index.html">Alors qu'une √©quipe de techniciens a cr√©√© leur entreprise, la saison 3 (a finalement vol√©!)</a></li>
<li><a href="../fr421775/index.html">R√©seau neuronal form√© pour reconna√Ætre la d√©pression par le discours arbitraire d'une personne sans contexte</a></li>
<li><a href="../fr421783/index.html">Cadre Huex Fun State Management</a></li>
<li><a href="../fr421785/index.html">La Californie est au bord de l'abstraction du carbone dans la production d'√©nergie</a></li>
<li><a href="../fr421787/index.html">D√©veloppement d'architecture de projet, vaisseaux et JavaScript</a></li>
<li><a href="../fr421789/index.html">Faire du backend un "backend" √† nouveau</a></li>
<li><a href="../fr421791/index.html">Probl√®mes √©thiques de l'intelligence artificielle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>