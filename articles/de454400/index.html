<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüöí üï∫üèø üßëüèª‚Äçü§ù‚Äçüßëüèª T√§gliche Berichte zum Status der virtuellen Maschine mit R und PowerShell üëÇüèº ü§∞üèª ‚òùüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Eintrag 


 Guten Tag. Seit einem halben Jahr f√ºhren wir ein Skript (genauer gesagt eine Reihe von Skripten) aus, das Berichte √ºber den Status virtuel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>T√§gliche Berichte zum Status der virtuellen Maschine mit R und PowerShell</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454400/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/px/tu/kg/pxtukg8q2rhe_wcyxiwdbfa9euq.jpeg"></div><br><h4 id="vstuplenie">  Eintrag </h4><br><p>  Guten Tag.  Seit einem halben Jahr f√ºhren wir ein Skript (genauer gesagt eine Reihe von Skripten) aus, das Berichte √ºber den Status virtueller Maschinen (und nicht nur) generiert.  Ich beschloss, die Erstellungserfahrung und den Code selbst zu teilen.  Ich z√§hle auf Kritik und die Tatsache, dass dieses Material f√ºr jemanden n√ºtzlich sein kann. </p><a name="habracut"></a><br><h4 id="formirovanie-potrebnosti">  Brauchen Bildung </h4><br><p>  Wir haben viele virtuelle Maschinen (ungef√§hr 1500 VMs, die √ºber das 3. vCenter verteilt sind).  Neue werden erstellt und alte werden ziemlich oft gel√∂scht.  Um die Reihenfolge zu erhalten, wurden vCenter mehrere benutzerdefinierte Felder hinzugef√ºgt, um VMs in Subsysteme zu unterteilen und anzugeben, ob und von wem und wann sie getestet werden.  Der menschliche Faktor hat dazu gef√ºhrt, dass mehr als die H√§lfte der Autos leere Felder hatten, was die Arbeit erschwerte.  Alle sechs Monate flippte jemand aus und begann mit der Aktualisierung dieser Daten, aber das Ergebnis war anderthalb Wochen lang nicht mehr relevant. <br>  Ich werde sofort klarstellen, dass jeder versteht, dass es Anwendungen zum Erstellen von Maschinen, einen Prozess zum Erstellen dieser Maschinen usw. geben sollte.  usw.  Und w√§hrend all dieser Prozess streng und in Ordnung ist.  Leider ist dies bei uns nicht der Fall, aber dies ist nicht das Thema des Artikels :) </p><br><p>  Im Allgemeinen wurde beschlossen, die √úberpr√ºfung der Richtigkeit des Ausf√ºllens der Felder zu automatisieren. <br>  Wir haben beschlossen, dass ein t√§glicher Brief mit einer Liste falsch gef√ºllter Maschinen f√ºr alle verantwortlichen Ingenieure und ihre Vorgesetzten ein guter Anfang ist. </p><br><p>  Zu diesem Zeitpunkt hatte einer der Kollegen bereits ein PowerShell-Skript implementiert, das jeden Tag nach einem Zeitplan Informationen auf allen Computern aller vCenter-s sammelte und 3 CSV-Dokumente (jeweils in einem eigenen vCenter) erstellte, die auf einer gemeinsam genutzten Festplatte angeordnet waren.  Es wurde beschlossen, dieses Skript als Grundlage zu verwenden und es durch √úberpr√ºfungen in der R-Sprache zu erg√§nzen, mit denen ich einige Erfahrung hatte. </p><br><p>  W√§hrend des Finalisierungsprozesses wurde die L√∂sung mit Informationen per E-Mail, einer Datenbank mit den Haupt- und Verlaufstabellen (dazu sp√§ter mehr) sowie der Analyse von vSphere-Protokollen √ºberwachsen, um die tats√§chlichen Ersteller von vm und den Zeitpunkt ihrer Erstellung zu ermitteln. </p><br><p>  F√ºr die Entwicklung wurden IDE RStudio Desktop und PowerShell ISE verwendet. </p><br><p>  Das Skript wird von einer normalen virtuellen Windows-Maschine gestartet. </p><br><h4 id="opisanie-obschey-logiki">  Beschreibung der allgemeinen Logik. </h4><br><p>  Die allgemeine Logik der Skripte lautet wie folgt. </p><br><ul><li>  Wir sammeln Daten auf virtuellen Maschinen mithilfe des PowerShell-Skripts, das √ºber R aufgerufen wird. Das Ergebnis wird zu einer CSV zusammengefasst.  Die umgekehrte Interaktion zwischen Sprachen erfolgt √§hnlich.  (Es war m√∂glich, Daten in Form von Variablen direkt von R nach PowerShell zu √ºbertragen, aber es ist schwierig, und selbst mit Zwischen-CSV ist es einfacher, Zwischenergebnisse zu debuggen und mit jemandem zu teilen.) </li><li>  Mit R bilden wir g√ºltige Parameter f√ºr die Felder, deren Werte wir √ºberpr√ºfen.  - Wir bilden ein Word-Dokument, das die Werte dieser Felder zum Einf√ºgen in einen Informationsbrief enth√§lt und eine Antwort auf Fragen von Kollegen enth√§lt. "Nicht gut, aber wie soll ich das ausf√ºllen?" </li><li>  Wir laden Daten auf allen VMs von CSV mit R, bilden einen Datenrahmen, entfernen unn√∂tige Felder und erstellen ein Informations-XLSX-Dokument, das zusammenfassende Informationen zu allen VMs enth√§lt, die wir in eine gemeinsam genutzte Ressource hochladen. </li><li>  F√ºr den Datenrahmen f√ºr alle VMs wenden wir alle √úberpr√ºfungen auf die Richtigkeit des Ausf√ºllens der Felder an und bilden eine Tabelle, die nur VMs mit falsch ausgef√ºllten Feldern (und nur diese Felder) enth√§lt. </li><li>  Die resultierende Liste der VMs wird an ein anderes PowerShell-Skript gesendet, das die vCenter-Protokolle auf VM-Erstellungsereignisse √ºberpr√ºft. Auf diese Weise k√∂nnen Sie den gesch√§tzten Erstellungszeitpunkt der VM und den beabsichtigten Ersteller angeben.  Dies ist der Fall, wenn niemand gesteht, wessen Auto.  Dieses Skript funktioniert nicht schnell, insbesondere wenn viele Protokolle vorhanden sind. Wir betrachten daher nur die letzten zwei Wochen und verwenden auch den Workflow, mit dem Sie gleichzeitig nach Informationen auf mehreren VMs suchen k√∂nnen.  Im Beispielskript gibt es detaillierte Kommentare zu diesem Mechanismus.  Das Ergebnis wird zu csv hinzugef√ºgt, das erneut in R geladen wird. </li><li>  Wir bilden ein wundersch√∂n formatiertes xlsx-Dokument, in dem falsch ausgef√ºllte Felder rot hervorgehoben werden, Filter auf einige Spalten angewendet werden und zus√§tzliche Spalten mit den mutma√ülichen Erstellern und dem Zeitpunkt der VM-Erstellung angezeigt werden. </li><li>  Wir bilden eine E-Mail, in der wir ein Dokument mit den g√ºltigen Feldwerten sowie eine Tabelle mit falsch ausgef√ºllten Daten ablegen.  Im Text geben wir die Gesamtzahl der falsch erstellten VMs, einen Link zu einer gemeinsam genutzten Ressource und ein Motivationsimage an.  Wenn es keine falsch best√ºckten VMs gibt, senden wir einen weiteren Brief mit einem freudigeren Motivationsbild. </li><li>  Wir zeichnen Daten auf allen VMs in der SQL Server-Datenbank unter Ber√ºcksichtigung des implementierten Mechanismus historischer Tabellen auf (ein sehr interessanter Mechanismus - √ºber den detaillierter berichtet wird). </li></ul><br><h4 id="sobstvenno-skripty">  Skripte </h4><br><div class="spoiler">  <b class="spoiler_title">Die Hauptdatei mit dem Code f√ºr R.</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     (       ) setwd("C:\\Scripts\\getVm") ####    #### library(tidyverse) library(xlsx) library(mailR) library(rmarkdown) #####         ##### source(file = "const.R", local = T, encoding = "utf-8") #        ,  . if (file.exists(filenameVmCreationRules)) {file.remove(filenameVmCreationRules)} ####       render("VM_name_rules.Rmd", output_format = word_document(), output_file = filenameVmCreationRules) #        ,   if (file.exists(allVmXlsxPath)) {file.remove(allVmXlsxPath)} ####       PowerShell .    csv. system(paste0("powershell -File ", getVmPsPath)) #  df fullXslx_df &lt;- allVmXlsxPath %&gt;% read.csv2(stringsAsFactors = FALSE) #     full_df &lt;- fullXslx_df %&gt;% mutate( #       ,    ,      , isSubsystemCorrect = Subsystem %&gt;% gsub("[[:space:]]", "", .) %&gt;% str_split(., ",") %&gt;% map(function(x) (all(x %in% AllowedValues$Subsystem))) %&gt;% as.logical(), isOwnerCorrect = Owner %in% AllowedValues$Owner, isCategoryCorrect = Category %in% AllowedValues$Category, isCreatorCorrect = (!is.na(Creator) &amp; Creator != ''), isCreation.DateCorrect = map(Creation.Date, IsDate) ) #        ,  . if (file.exists(filenameAll)) {file.remove(filenameAll)} ####  xslx    #### #      full_df %&gt;% write.xlsx(file=filenameAll, sheetName=names[1], col.names=TRUE, row.names=FALSE, append=FALSE) ####  xslx      #### #  df incorrect_df &lt;- full_df %&gt;% select(VM.Name, IP.s, Owner, Subsystem, Creator, Category, Creation.Date, isOwnerCorrect, isSubsystemCorrect, isCategoryCorrect, isCreatorCorrect, vCenter.Name) %&gt;% filter(isSubsystemCorrect == F | isOwnerCorrect == F | isCategoryCorrect == F | isCreatorCorrect == F) #        ,  . if (file.exists(filenameIncVM)) {file.remove(filenameIncVM)} #   VM     csv incorrect_df %&gt;% select(VM.Name) %&gt;% write_csv2(path = filenameIncVM, append = FALSE) #      incorrect_df_filtered &lt;- incorrect_df %&gt;% select(VM.Name, IP.s, Owner, Subsystem, Category, Creator, vCenter.Name, Creation.Date ) #    numberOfRows &lt;- nrow(incorrect_df) ####   #### #        ,  . #   -     if (numberOfRows &gt; 0) { #       ,  . if (file.exists(creatorsFilePath)) {file.remove(creatorsFilePath)} #  PowerShell ,     VM.    csv. system(paste0("powershell -File ", getCreatorsPath)) #     creators_df &lt;- creatorsFilePath %&gt;% read.csv2(stringsAsFactors = FALSE) #     ,       incorrect_df_filtered &lt;- incorrect_df_filtered %&gt;% select(VM.Name, IP.s, Owner, Subsystem, Category, Creator, vCenter.Name, Creation.Date ) %&gt;% left_join(creators_df, by = "VM.Name") %&gt;% rename(` ` = CreatedBy, `  ` = CreatedOn) #    emailBody &lt;- paste0( '&lt;html&gt; &lt;h3&gt; ,  .&lt;/h3&gt; &lt;p&gt;           H:  :&lt;p&gt; &lt;p&gt;\\\\server.ru\\VM\\', sourceFileFormat, '&lt;/p&gt; &lt;p&gt;      &lt;strong&gt; &lt;/strong&gt; .   &lt;strong&gt;', numberOfRows,'&lt;/strong&gt;.&lt;/p&gt; &lt;p&gt;   2  . &lt;strong&gt; &lt;/strong&gt;  &lt;strong&gt;  &lt;/strong&gt;,     vCenter   2 &lt;/p&gt; &lt;p&gt;        .      &lt;/p&gt; &lt;p&gt;&lt;img src="data/meme.jpg"&gt;&lt;/p&gt; &lt;/html&gt;' ) #    if (file.exists(filenameIncorrect)) {file.remove(filenameIncorrect)} #       .. source(file = "email.R", local = T, encoding = "utf-8") ####       #### send.mail(from = emailParams$from, to = emailParams$to, subject = "    ", body = emailBody, encoding = "utf-8", html = TRUE, inline = TRUE, smtp = emailParams$smtpParams, authenticate = TRUE, send = TRUE, attach.files = c(filenameIncorrect, filenameVmCreationRules), debug = FALSE) ####   ,      #### } else { #    emailBody &lt;- paste0( '&lt;html&gt; &lt;h3&gt; ,  &lt;/h3&gt; &lt;p&gt;           H:  :&lt;p&gt; &lt;p&gt;\\\\server.ru\\VM\\', sourceFileFormat, '&lt;/p&gt; &lt;p&gt;,   ,     &lt;/p&gt; &lt;p&gt;&lt;img src="data/meme_correct.jpg"&gt;&lt;/p&gt; &lt;/html&gt;' ) ####      VM #### send.mail(from = emailParams$from, to = emailParams$to, subject = " ", body = emailBody, encoding = "utf-8", html = TRUE, inline = TRUE, smtp = emailParams$smtpParams, authenticate = TRUE, send = TRUE, debug = FALSE) } #######     ##### source(file = "DB.R", local = T, encoding = "utf-8")</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Skript zum Abrufen der VM-Liste in PowerShell</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#       $vCenterNames = @( "vcenter01", "vcenter02", "vcenter03" ) $vCenterUsername = "myusername" $vCenterPassword = "mypassword" $filename = "C:\Scripts\getVm\data\allvm\all-vm-$(get-date -f yyyy-MM-dd).csv" $destinationSMB = "\\server.ru\myfolder$\vm" $IP0="" $IP1="" $IP2="" $IP3="" $IP4="" $IP5="" #    vCenter,    .  ,      (, ) Connect-VIServer -Server $vCenterNames -User $vCenterUsername -Password $vCenterPassword write-host "" #       vCenter- function Get-VMinventory { #       ,   $AllVM = Get-VM | Sort Name $cnt = $AllVM.Count $count = 1 #            foreach ($vm in $AllVM) { $StartTime = $(get-date) $IP0 = $vm.Guest.IPAddress[0] $IP1 = $vm.Guest.IPAddress[1] $IP2 = $vm.Guest.IPAddress[2] $IP3 = $vm.Guest.IPAddress[3] $IP4 = $vm.Guest.IPAddress[4] $IP5 = $vm.Guest.IPAddress[5] If ($IP0 -ne $null) {If ($IP0.Contains(":") -ne 0) {$IP0=""}} If ($IP1 -ne $null) {If ($IP1.Contains(":") -ne 0) {$IP1=""}} If ($IP2 -ne $null) {If ($IP2.Contains(":") -ne 0) {$IP2=""}} If ($IP3 -ne $null) {If ($IP3.Contains(":") -ne 0) {$IP3=""}} If ($IP4 -ne $null) {If ($IP4.Contains(":") -ne 0) {$IP4=""}} If ($IP5 -ne $null) {If ($IP5.Contains(":") -ne 0) {$IP5=""}} $cluster = $vm | Get-Cluster | Select-Object -ExpandProperty name $Bootime = $vm.ExtensionData.Runtime.BootTime $TotalHDDs = $vm.ProvisionedSpaceGB -as [int] $CreationDate = $vm.CustomFields.Item("CreationDate") -as [string] $Creator = $vm.CustomFields.Item("Creator") -as [string] $Category = $vm.CustomFields.Item("Category") -as [string] $Owner = $vm.CustomFields.Item("Owner") -as [string] $Subsystem = $vm.CustomFields.Item("Subsystem") -as [string] $IPS = $vm.CustomFields.Item("IP") -as [string] $vCPU = $vm.NumCpu $CorePerSocket = $vm.ExtensionData.config.hardware.NumCoresPerSocket $Sockets = $vCPU/$CorePerSocket $Id = $vm.Id.Split('-')[2] -as [int] #       $Vmresult = New-Object PSObject $Vmresult | add-member -MemberType NoteProperty -Name "Id" -Value $Id $Vmresult | add-member -MemberType NoteProperty -Name "VM Name" -Value $vm.Name $Vmresult | add-member -MemberType NoteProperty -Name "Cluster" -Value $cluster $Vmresult | add-member -MemberType NoteProperty -Name "Esxi Host" -Value $VM.VMHost $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 1" -Value $IP0 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 2" -Value $IP1 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 3" -Value $IP2 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 4" -Value $IP3 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 5" -Value $IP4 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 6" -Value $IP5 $Vmresult | add-member -MemberType NoteProperty -Name "vCPU" -Value $vCPU $Vmresult | Add-Member -MemberType NoteProperty -Name "CPU Sockets" -Value $Sockets $Vmresult | Add-Member -MemberType NoteProperty -Name "Core per Socket" -Value $CorePerSocket $Vmresult | add-member -MemberType NoteProperty -Name "RAM (GB)" -Value $vm.MemoryGB $Vmresult | add-member -MemberType NoteProperty -Name "Total-HDD (GB)" -Value $TotalHDDs $Vmresult | add-member -MemberType NoteProperty -Name "Power State" -Value $vm.PowerState $Vmresult | add-member -MemberType NoteProperty -Name "OS" -Value $VM.ExtensionData.summary.config.guestfullname $Vmresult | Add-Member -MemberType NoteProperty -Name "Boot Time" -Value $Bootime $Vmresult | add-member -MemberType NoteProperty -Name "VMTools Status" -Value $vm.ExtensionData.Guest.ToolsStatus $Vmresult | add-member -MemberType NoteProperty -Name "VMTools Version" -Value $vm.ExtensionData.Guest.ToolsVersion $Vmresult | add-member -MemberType NoteProperty -Name "VMTools Version Status" -Value $vm.ExtensionData.Guest.ToolsVersionStatus $Vmresult | add-member -MemberType NoteProperty -Name "VMTools Running Status" -Value $vm.ExtensionData.Guest.ToolsRunningStatus $Vmresult | add-member -MemberType NoteProperty -Name "Creation Date" -Value $CreationDate $Vmresult | add-member -MemberType NoteProperty -Name "Creator" -Value $Creator $Vmresult | add-member -MemberType NoteProperty -Name "Category" -Value $Category $Vmresult | add-member -MemberType NoteProperty -Name "Owner" -Value $Owner $Vmresult | add-member -MemberType NoteProperty -Name "Subsystem" -Value $Subsystem $Vmresult | add-member -MemberType NoteProperty -Name "IP's" -Value $IPS $Vmresult | add-member -MemberType NoteProperty -Name "vCenter Name" -Value $vm.Uid.Split('@')[1].Split(':')[0] #           .   ,      . $elapsedTime = $(get-date) - $StartTime $totalTime = "{0:HH:mm:ss}" -f ([datetime]($elapsedTime.Ticks*($cnt - $count))) clear-host Write-Host "Processing" $count "from" $cnt Write-host "Progress:" ([math]::Round($count/$cnt*100, 2)) "%" Write-host "You have about " $totalTime "for cofee" Write-host "" $count++ #  ,   ""       $Vmresult } } #         csv $allVm = Get-VMinventory | Export-CSV -Path $filename -NoTypeInformation -UseCulture -Force #         ,   ,  . try { Copy-Item $filename -Destination $destinationSMB -Force -ErrorAction SilentlyContinue } catch { $error | Export-CSV -Path $filename".error" -NoTypeInformation -UseCulture -Force }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">PowerShell-Skript zum Abrufen der Protokolle der Ersteller virtueller Maschinen und ihrer Erstellungsdaten</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,      VM $VMfilePath = "C:\Scripts\getVm\creators_VM\creators_VM_$(get-date -f yyyy-MM-dd).csv" #   ,      $filePath = "C:\Scripts\getVm\data\creators\creators-$(get-date -f yyyy-MM-dd).csv" #   Workflow GetCreators-Wf { # ,        param([string[]]$VMfilePath) # ,     workflow $vCenterUsername = "myusername" $vCenterPassword = "mypassword" $daysToLook = 14 $start = (get-date).AddDays(-$daysToLook) $finish = get-date # ,     csv  ,       $UnknownUser = "UNKNOWN" $UnknownCreatedTime = "0000-00-00" #      ,      . $vCenterNames = @( "vcenter01", "vcenter02", "vcenter03" ) #   VM  csv     $list = Import-Csv $VMfilePath -UseCulture | select -ExpandProperty VM.Name # ,     ( 5   ) foreach -parallel ($row in $list) { #  ,       ,     $Using InlineScript { #      $StartTime = $(get-date) Write-Host "" Write-Host "Processing $Using:row started at $StartTime" Write-Host "" #    ,         $con = Connect-VIServer -Server $Using:vCenterNames -User $Using:vCenterUsername -Password $Using:vCenterPassword #   vm $vm = Get-VM -Name $Using:row #  2  .     ,  - .   , $Event = $vm | Get-VIEvent -Start $Using:start -Finish $Using:finish -Types Info | Where { $_.Gettype().Name -eq "VmBeingDeployedEvent" -or $_.Gettype().Name -eq "VmCreatedEvent" -or $_.Gettype().Name -eq "VmRegisteredEvent" -or $_.Gettype().Name -eq "VmClonedEvent"} # $Event = $vm | Get-VIEvent -Types Info | Where { $_.Gettype().Name -eq "VmBeingDeployedEvent" -or $_.Gettype().Name -eq "VmCreatedEvent" -or $_.Gettype().Name -eq "VmRegisteredEvent" -or $_.Gettype().Name -eq "VmClonedEvent"} #      ,      - If (($Event | Measure-Object).Count -eq 0){ $User = $Using:UnknownUser $Created = $Using:UnknownCreatedTime $CreatedFormat = $Using:UnknownCreatedTime } Else { If ($Event.Username -eq "" -or $Event.Username -eq $null) { $User = $Using:UnknownUser } Else { $User = $Event.Username } # Else $CreatedFormat = $Event.CreatedTime #     ,      ,   .      . $Created = $Event.CreatedTime.ToString('yyyy-MM-dd') } # Else Write-Host "Creator for $vm is $User. Creating object." #  .  . $Vmresult = New-Object PSObject $Vmresult | add-member -MemberType NoteProperty -Name "VM Name" -Value $vm.Name $Vmresult | add-member -MemberType NoteProperty -Name "CreatedBy" -Value $User $Vmresult | add-member -MemberType NoteProperty -Name "CreatedOn" -Value $CreatedFormat $Vmresult | add-member -MemberType NoteProperty -Name "CreatedOnFormat" -Value $Created #   $Vmresult } # Inline } # ForEach } $Creators = GetCreators-Wf $VMfilePath #     $Creators | select 'VM Name', CreatedBy, CreatedOn | Export-Csv -Path $filePath -NoTypeInformation -UseCulture -Force Write-Host "CSV generetion finisghed at $(get-date). PROFIT"</span></span></code> </pre></div></div><br><p>  Die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">xlsx-</a> Bibliothek verdient besondere Aufmerksamkeit, wodurch es m√∂glich wurde, den Anhang zum Brief klar zu formatieren (wie es das Handbuch mag) und nicht nur eine CSV-Tabelle. </p><br><div class="spoiler">  <b class="spoiler_title">Erstellen eines sch√∂nen XLSX-Dokuments mit einer Liste falsch ausgef√ºllter Maschinen</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#    #   : "xls"  "xlsx" wb&lt;-createWorkbook(type="xlsx") #         TABLE_ROWNAMES_STYLE &lt;- CellStyle(wb) + Font(wb, isBold=TRUE) TABLE_COLNAMES_STYLE &lt;- CellStyle(wb) + Font(wb, isBold=TRUE) + Alignment(wrapText=TRUE, horizontal="ALIGN_CENTER") + Border(color="black", position=c("TOP", "BOTTOM"), pen=c("BORDER_THIN", "BORDER_THICK")) #    sheet &lt;- createSheet(wb, sheetName = names[2]) #   addDataFrame(incorrect_df_filtered, sheet, startRow=1, startColumn=1, row.names=FALSE, byrow=FALSE, colnamesStyle = TABLE_COLNAMES_STYLE, rownamesStyle = TABLE_ROWNAMES_STYLE) #  ,     autoSizeColumn(sheet = sheet, colIndex=c(1:ncol(incorrect_df))) #   addAutoFilter(sheet, cellRange = "C1:G1") #   fo2 &lt;- Fill(foregroundColor="red") cs2 &lt;- CellStyle(wb, fill = fo2, dataFormat = DataFormat("@")) #              rowsOwner &lt;- getRows(sheet, rowIndex = (which(!incorrect_df$isOwnerCorrect) + 1)) cellsOwner &lt;- getCells(rowsOwner, colIndex = which( colnames(incorrect_df_filtered) == "Owner" )) lapply(names(cellsOwner), function(x) setCellStyle(cellsOwner[[x]], cs2)) #              rowsSubsystem &lt;- getRows(sheet, rowIndex = (which(!incorrect_df$isSubsystemCorrect) + 1)) cellsSubsystem &lt;- getCells(rowsSubsystem, colIndex = which( colnames(incorrect_df_filtered) == "Subsystem" )) lapply(names(cellsSubsystem), function(x) setCellStyle(cellsSubsystem[[x]], cs2)) #    rowsCategory &lt;- getRows(sheet, rowIndex = (which(!incorrect_df$isCategoryCorrect) + 1)) cellsCategory &lt;- getCells(rowsCategory, colIndex = which( colnames(incorrect_df_filtered) == "Category" )) lapply(names(cellsCategory), function(x) setCellStyle(cellsCategory[[x]], cs2)) #  rowsCreator &lt;- getRows(sheet, rowIndex = (which(!incorrect_df$isCreatorCorrect) + 1)) cellsCreator &lt;- getCells(rowsCreator, colIndex = which( colnames(incorrect_df_filtered) == "Creator" )) lapply(names(cellsCreator), function(x) setCellStyle(cellsCreator[[x]], cs2)) #   saveWorkbook(wb, filenameIncorrect)</span></span></code> </pre> </div></div><br><p>  Die Ausgabe ist ungef√§hr so: </p><br><img src="https://habrastorage.org/webt/ax/y7/bv/axy7bvclwghyjabvvzuanyb2_ry.jpeg"><br><br>  Es gab auch eine interessante Nuance beim Einrichten von Windows Scheduller.  Es hat nicht geklappt, die richtigen Rechte- und Einstellungsparameter zu ermitteln, damit alles so beginnt, wie es sollte.  Als Ergebnis wurde die R-Bibliothek gefunden, die selbst eine Aufgabe zum Ausf√ºhren des R-Skripts erstellt und die Protokolldatei nicht einmal vergisst.  Dann k√∂nnen Sie die Aufgabe mit Stiften korrigieren. <br><br><br><div class="spoiler">  <b class="spoiler_title">Ein Teil des R-Codes mit zwei Beispielen, der eine Aufgabe im Windows Scheduler erstellt</b> <div class="spoiler_text"><pre> <code class="python hljs">library(taskscheduleR) myscript &lt;- file.path(getwd(), <span class="hljs-string"><span class="hljs-string">"all_vm.R"</span></span>) <span class="hljs-comment"><span class="hljs-comment">##    62  taskscheduler_create(taskname = "getAllVm", rscript = myscript, schedule = "ONCE", starttime = format(Sys.time() + 62, "%H:%M")) ##      09:10 taskscheduler_create(taskname = "getAllVmDaily", rscript = myscript, schedule = "WEEKLY", days = c("MON", "TUE", "WED", "THU", "FRI"), starttime = "02:00") ##   taskscheduler_delete(taskname = "getAllVm") taskscheduler_delete(taskname = "getAllVmDaily") #   ( 4 ) tail(readLines("all_vm.log"), sep ="\n", n = 4)</span></span></code> </pre> </div></div><br><h4 id="otdelno-pro-bd">  Separat √ºber die Datenbank </h4><br><p>  Nach dem Einrichten des Skripts tauchten weitere Fragen auf.  Ich wollte beispielsweise das Datum ermitteln, an dem die VM gel√∂scht wurde und die Protokolle in vCenter bereits abgenutzt waren.  Da das Skript die Dateien jeden Tag in den Ordner legt und sie nicht bereinigt (wir bereinigen sie mit unseren H√§nden, wenn wir uns erinnern), k√∂nnen Sie sich die alten Dateien ansehen und die erste Datei finden, in der diese VM nicht vorhanden ist.  Das ist aber nicht cool. </p><br><p>  Ich wollte eine historische Datenbank erstellen. </p><br><p>  Die MS SQL SERVER-Funktionalit√§t kam zu Hilfe - eine systemversionierte Zeittabelle.  Es wird normalerweise als tempor√§re (nicht tempor√§re) Tabellen √ºbersetzt. </p><br><p>  Sie k√∂nnen ausf√ºhrlich in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">offiziellen Microsoft-Dokumentation</a> lesen. </p><br><p>  Kurz gesagt, wir erstellen eine Tabelle, wir sagen, dass wir sie mit einer Version haben werden, und SQL Server erstellt zwei zus√§tzliche Datums- / Uhrzeitspalten in dieser Tabelle (das Erstellungsdatum des Datensatzes und das Enddatum des Datensatzes) und eine zus√§tzliche Tabelle, in die die √Ñnderungen geschrieben werden.  Als Ergebnis erhalten wir relevante Informationen und k√∂nnen durch einfache Abfragen, von denen Beispiele in der Dokumentation angegeben sind, entweder den Lebenszyklus einer bestimmten virtuellen Maschine oder den Status aller VMs zu einem bestimmten Zeitpunkt anzeigen. </p><br><p>  In Bezug auf die Leistung wird die Schreibtransaktion in die Haupttabelle erst abgeschlossen, wenn die Schreibtransaktion in die tempor√§re Tabelle abgeschlossen ist.  Das hei√üt,  Bei Tabellen mit einer gro√üen Anzahl von Schreibvorg√§ngen sollte diese Funktionalit√§t mit Vorsicht implementiert werden. In unserem Fall ist dies jedoch eine sehr coole Sache. </p><br><p>  Damit der Mechanismus ordnungsgem√§√ü funktioniert, musste ein kleiner Code auf R hinzugef√ºgt werden, der die neue Tabelle mit den Daten aller VMs mit der in der Datenbank gespeicherten vergleicht und nur ge√§nderte Zeilen in diese schreibt.  Der Code ist nicht sehr knifflig, er verwendet die compareDF-Bibliothek, aber ich werde ihn auch unten geben. </p><br><div class="spoiler">  <b class="spoiler_title">R-Code zum Schreiben von Daten in die Datenbank</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   library(odbc) library(compareDF) #   con &lt;- dbConnect(odbc(), Driver = "ODBC Driver 13 for SQL Server", Server = DBParams$server, Database = DBParams$database, UID = DBParams$UID, PWD = DBParams$PWD, Port = 1433) ####    .   - . #### if (!dbExistsTable(con, DBParams$TblName)) { ####   #### create &lt;- dbSendStatement( con, paste0( 'CREATE TABLE ', DBParams$TblName, '( [Id] [int] NOT NULL PRIMARY KEY CLUSTERED, [VM.Name] [varchar](255) NULL, [Cluster] [varchar](255) NULL, [Esxi.Host] [varchar](255) NULL, [IP.Address.1] [varchar](255) NULL, [IP.Address.2] [varchar](255) NULL, [IP.Address.3] [varchar](255) NULL, [IP.Address.4] [varchar](255) NULL, [IP.Address.5] [varchar](255) NULL, [IP.Address.6] [varchar](255) NULL, [vCPU] [int] NULL, [CPU.Sockets] [int] NULL, [Core.per.Socket] [int] NULL, [RAM..GB.] [int] NULL, [Total.HDD..GB.] [int] NULL, [Power.State] [varchar](255) NULL, [OS] [varchar](255) NULL, [Boot.Time] [varchar](255) NULL, [VMTools.Status] [varchar](255) NULL, [VMTools.Version] [int] NULL, [VMTools.Version.Status] [varchar](255) NULL, [VMTools.Running.Status] [varchar](255) NULL, [Creation.Date] [varchar](255) NULL, [Creator] [varchar](255) NULL, [Category] [varchar](255) NULL, [Owner] [varchar](255) NULL, [Subsystem] [varchar](255) NULL, [IP.s] [varchar](255) NULL, [vCenter.Name] [varchar](255) NULL, DateFrom datetime2 GENERATED ALWAYS AS ROW START NOT NULL, DateTo datetime2 GENERATED ALWAYS AS ROW END NOT NULL, PERIOD FOR SYSTEM_TIME (DateFrom, DateTo) ) ON [PRIMARY] WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = ', DBParams$TblHistName,'));' ) ) #    dbClearResult(create) } # if ####     #### #  ,     allVM_db_con &lt;- tbl(con, DBParams$TblName) ####   #### #     (   ) allVM_db &lt;- allVM_db_con %&gt;% select(c(-"DateTo", -"DateFrom")) %&gt;% collect() #     .   Id #       -,   +,   -  + ctable_VM &lt;- fullXslx_df %&gt;% compare_df(allVM_db, c("Id")) ####   #### #  Id ,      remove_Id &lt;- ctable_VM$comparison_df %&gt;% filter(chng_type == "-") %&gt;% select(Id) # ,    (   -     ) if (remove_Id %&gt;% nrow() &gt; 0) { #        delete &lt;- dbSendStatement(con, paste0(' DELETE FROM ', DBParams$TblName, ' WHERE "Id"=? ') # paste ) # send #      dbBind(delete, remove_Id) #    dbClearResult(delete) } # if ####   #### #  ,  ,   . allVM_add &lt;- ctable_VM$comparison_df %&gt;% filter(chng_type == "+") %&gt;% select(-chng_type) # ,   ,      (  -  ) if (allVM_add %&gt;% nrow() &gt; 0) { #       dbWriteTable(con, DBParams$TblName, allVM_add, overwrite = FALSE, append = TRUE) } # if ####     #### dbDisconnect(con)</span></span></code> </pre> </div></div><br><h4 id="itogo">  Insgesamt </h4><br><p>  Infolge der Einf√ºhrung des Skripts wurde die Reihenfolge mehrere Monate lang aufrechterhalten.  Manchmal werden falsch best√ºckte VMs angezeigt, aber das Skript dient als gute Erinnerung und eine seltene VM wird 2 Tage hintereinander in die Liste aufgenommen. </p><br><p>  Es wurde auch eine Reserve f√ºr die Analyse historischer Daten gebildet. </p><br><p>  Es ist klar, dass vieles davon nicht ‚Äûam Knie‚Äú, sondern mit spezieller Software realisiert werden kann, aber die Aufgabe war interessant und, k√∂nnte man sagen, optional. </p><br><p>  R erwies sich erneut als eine wunderbare universelle Sprache, die sich nicht nur perfekt zur L√∂sung statistischer Probleme eignet, sondern auch als hervorragende "Verlegung" zwischen anderen Datenquellen dient. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/g6/bn/1i/g6bn1ijgn9x3_e2nhnjq6jk5bdw.jpeg"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de454400/">https://habr.com/ru/post/de454400/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de454386/index.html">MessageBox f√ºr AvaloniaUI</a></li>
<li><a href="../de454388/index.html">ARA: Algorithmus zum Ermitteln der maximalen Anzahl von Punkten auf einer geraden Linie</a></li>
<li><a href="../de454394/index.html">Minimalistischer vierteiliger MIDI-Player</a></li>
<li><a href="../de454396/index.html">Installieren Sie sdl2 auf Hauptdistributionen</a></li>
<li><a href="../de454398/index.html">Von Kritikern zu Algorithmen: Wie Demokratie und Technokratie in die Musikindustrie kamen</a></li>
<li><a href="../de454402/index.html">Unity State Machine-Architektur zum Organisieren von Einheitenverhalten</a></li>
<li><a href="../de454404/index.html">Schulung Cisco 200-125 CCNA v3.0. Tag 6. F√ºllen Sie die L√ºcken aus (DHCP, TCP, "Handshake", allgemeine Portnummern)</a></li>
<li><a href="../de454406/index.html">Akihabara: Otaku-Nistplatz</a></li>
<li><a href="../de454408/index.html">CortexM3 / M4 (ARM) -Hardware-Bitbanding, Kernelarchitektur, Assembler, C / C ++ 14 und ein Tropfen Metaprogrammierung</a></li>
<li><a href="../de454410/index.html">Neu in PHP 7.4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>