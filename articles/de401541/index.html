<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüîß üî¢ üßìüèø 50 Schattierungen von St√ºmpfen * Hardware-Empfang von PWM-codierten Signalen durch Microchip-Mikrocontroller üë®‚Äçüë®‚Äçüëß‚Äçüë¶ üêÖ üë©üèΩ‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="* NIP - Core Independent Peripherals in Microchip-Mikrocontrollern, auch bekannt als CIP - Core Independent Peripheral. 

 Teil 4 
 Die vorherigen Art...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>50 Schattierungen von St√ºmpfen * Hardware-Empfang von PWM-codierten Signalen durch Microchip-Mikrocontroller</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/401541/"><div style="text-align:center;"><img src="https://habrastorage.org/files/344/eea/f79/344eeaf79b9a424fb5c5272f4506a24f.JPG" width="300"></div><br>  * NIP - Core Independent Peripherals in Microchip-Mikrocontrollern, auch bekannt als CIP - Core Independent Peripheral. <br><br><h1>  Teil 4 </h1><br>  Die vorherigen Artikel [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">1</a> ], [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">2</a> ] und [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">3</a> ] waren den Peripherieger√§ten der Core Independent (NEV) -Mikrochip-Mikrocontroller gewidmet: konfigurierbare Logikzellen, Eingangs- / Ausgangsports mit Strombegrenzungsfunktion und ADCs mit einem Computer; einige Merkmale solcher Peripherieger√§te wurden gezeigt.  Ich m√∂chte Sie daran erinnern, dass Unabh√§ngigkeit nicht vom Typ des PIC-Kerns von Mikrocontrollern (BaseLine, Mid-Range, Enhanced Mid-Range, PIC18, 16-, 32-Bit), sondern vom Betrieb des Kerns, d. H.  unabh√§ngige Ausf√ºhrung von Aufgaben, die der Peripherie des CPU-Zustands zugeordnet sind.  Solche Peripherieger√§te und insbesondere die M√∂glichkeit, sie f√ºr die Zusammenarbeit und Synthese von Hardwarefunktionen zu konfigurieren, sollen den Softwareteil auslagern und den Stromverbrauch senken. <br><br>  In diesem kurzen Artikel m√∂chte ich Beispiele f√ºr die Implementierung des Empfangs von "benutzerdefinierten", nicht standardm√§√üigen Kommunikationsschnittstellen unter Verwendung der vom Kernel unabh√§ngigen Peripherieger√§te zeigen. <br><a name="habracut"></a><br>  Die PWM-Codierung von Informationen ist sehr h√§ufig, wenn diskrete Signale log. 1 und log. 0 durch die Impulsbreite codiert werden.  Erw√§gen Sie die M√∂glichkeit, solche Signale mithilfe der periphere kernunabh√§ngigen PIC-Controller zu empfangen und zu decodieren. <br><br><h2>  PWM-Decodierung des AM2302-Sensorsignals </h2><br>  In DIY-Projekten wird h√§ufig der Temperatur- und Feuchtigkeitssensor DHT22 (AM2302) verwendet.  Der Sensor hat 3 Ausg√§nge, Informationen werden √ºber einen einzigen Draht √ºbertragen.  In Reaktion auf eine Anfrage (niedriger Pegel mit einer Dauer von ungef√§hr 1 ms) antwortet der Sensor mit einem Startbit und dann einer Folge von 40 Bits, wobei die Informationen in der Impulsdauer: log codiert werden.  "0" - Impuls 30mk Sek., Log.  "1" - 70 mk sec (typische Werte).  Die Antwort vom Sensor enth√§lt 5 Bytes: 2 Bytes Feuchtigkeitsdaten, 2 Bytes Temperatur und 1 Kontrollbyte. <br><br><img src="https://habrastorage.org/files/d89/ab5/d3a/d89ab5d3a7204c46aeb299ace4023003.png"><br>  <i>Abb. 1.</i>  <i>Erl√§uterungen zum Prinzip der DHT22-Sensorsignalerzeugung.</i> <br><br>  Das Netzwerk hat viele Beispiele f√ºr die Arbeit mit solchen Sensoren auf Arduino.  Einige Bibliotheksimplementierungen verwenden Konstrukte wie: <br><br><pre><code class="hljs ruby">loopCnt = TIMEOUT; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(PIN) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(--loopCount == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ErrorTimeout; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (loopCnt &lt; cntOne) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> bit =<span class="hljs-number"><span class="hljs-number">1</span></span> ‚Ä¶ } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> bit =<span class="hljs-number"><span class="hljs-number">0</span></span> ‚Ä¶ }</code> </pre> <br>  In solchen Implementierungen sehe ich die folgenden Probleme: <br><br>  - das Programm f√ºr die gesamte Messzeit (&gt; 5 ms) ‚Äûh√§ngt‚Äú im Messcode; <br>  - Das Auftreten eines ausreichend langen Interrupts st√∂rt das Lesen der Daten vom Sensor. <br>  - m√∂gliche Probleme beim Arbeiten mit einer niedrigen Taktfrequenz des Mikrocontrollers; <br><br>  Der Algorithmus des Programms solcher L√∂sungen hat ungef√§hr die folgende Form (siehe Fig. 2) <br><br><img src="https://habrastorage.org/files/c97/8c0/d3f/c978c0d3f5444843aa4caa67c2d62f14.png"><br>  <i>Abb.</i>  <i>2. Ein Algorithmus zum programmgesteuerten Empfangen und Decodieren von Sensorsignalen.</i> <br><br>  Im Folgenden wird eine Variante des Hardware-Empfangs / -Decodierens des Protokolls mit minimalem Software-Overhead betrachtet. <br><br>  Die Idee ist, Taktimpulse vom Bitstrom zu isolieren, gefolgt von der Richtung des urspr√ºnglichen Signals und den Taktimpulsen zum SPI-Hardwaremodul.  In diesem Fall kann das Programm des Mikrocontrollers nur nacheinander 5 Byte Daten vom SPI √ºbernehmen. <br><br>  Ein Teil des KVP ist ein Timer mit der F√§higkeit, Ereignisse auszul√∂sen (√Ñnderungen des Eingangsstatus oder anderer Peripherieger√§te).  Das hei√üt,  Das √Ñndern des Eingangszustands kann einen Timer ausl√∂sen, siehe TMR6-Signal in Abb. 3.  Wenn der Timer den eingestellten Wert erreicht, stoppt seine Z√§hlung und der Timer befindet sich im Zustand TMR6 = PR6 (PR - Periodenregister).  Der Timer-Status kann eine Eingabe f√ºr eine konfigurierbare Logikzelle (CLC, siehe Teil 1) sein. <br><br>  Somit k√∂nnen wir unter Verwendung eines Zeitgebers und von Logikzellen ein Signal erzeugen, das zum Anlegen an den Takteingang des SCK des SPI-Moduls geeignet ist.  Um Informationen zu extrahieren, sollte die Dauer eines solchen Blocks einen Durchschnittswert zwischen der Dauer von Null und Eins haben.  Dann kann SPI das Bit entsprechend dem Zerfall des Blocks fixieren (siehe Fig. 3 SCK-Signal). <br><br>  Das Signal vom Sensor hat falsche Impulse, die aus der Anforderung erzeugt werden, und Startimpulse.  Damit diese Impulse den Betrieb nicht st√∂ren, m√ºssen Sie SPI nur f√ºr die Dauer von Informationsimpulsen aktivieren oder unn√∂tige Impulse abschneiden.  Wir k√∂nnen dieses Problem auch mit CIP l√∂sen. <br><br>  Ein anderer Timer fungiert als Impulsz√§hler beim Umschalten der Rezession: Schreiben Sie die Nummer 2 in das Periodenregister, der Timer z√§hlt die ersten 2 Impulse (siehe Signal TMR4 in Abb. 3) und stoppt die Z√§hlung (siehe EN-Signal in Abb. 3), die durchl√§uft Der Block logischer Zellen erm√∂glicht die Ausgabe der verbleibenden Impulse an den Eingangs-SPI. <br><br><img src="https://habrastorage.org/files/063/871/47f/06387147f53f4a24b875feee752b271b.png"><br>  <i>Abb. 3.</i>  <i>Diagramme zur Erl√§uterung des Empfangs von DHT22-Sensorsignalen.</i> <br><br>  Die logische Funktion der SCK-Signalerzeugung ist in einer logischen Zelle (CLC) implementiert, die vollst√§ndige Schaltung in der UND-ODER-Konfiguration ist in Fig. 4 gezeigt. <br><br>  Der Ausgang der Logikzelle ist mit dem SCK-Eingang verbunden, und das DHT22-Sensorsignal ist mit dem MOSI des SPI-Moduls verbunden.  Alle Verbindungen werden im Mikrocontroller hergestellt (Abb. 5).  Zur √úberwachung und zum Debuggen k√∂nnen Signale an die Ports des Mikrocontrollers ausgegeben werden. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f99/2ab/63f/f992ab63fbc048a1ae5b6dad31748263.png"></div><br>  <i>Abb. 4.</i>  <i>Konfiguration der CLC-Logikzelle im PIC-Mikrocontroller.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b27/d35/f60/b27d35f60fc04de9890ed357bb84309d.png"></div><br>  <i>Abb.</i>  <i>5. Die vollst√§ndige Struktur der Konfiguration der Peripherie.</i> <br><br>  Wenn es den Anschein hat, dass 2 Timer f√ºr die Dekodierung des Protokolls des Sensors eine Verschwendung von Ressourcen darstellen, kann ein Z√§hler von bis zu zwei auf freien logischen Zellen des CLC "gesammelt" werden. <br><br>  Insgesamt l√§uft die Decodierungsaufgabe auf einen sehr einfachen Algorithmus hinaus: Der Mikrocontroller und seine Peripherieger√§te werden bei Bedarf initialisiert, das SPI-Modul eingeschaltet und eine Messanforderung generiert (log. ‚Äû0‚Äú f√ºr ~ 1 ms). <br><br>  Es bleiben Daten aus dem Puffer zu lesen, wenn ein Interrupt von SPI auftritt. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/434/536/fef/434536fef59a4b569a45aa334d9df535.png"></div><br>  <i>Abb. 6.</i>  <i>Der Algorithmus f√ºr die Arbeit mit dem DHT22-Sensor bei Verwendung des Stumpfes.</i> <br><br><img src="https://habrastorage.org/files/966/2d4/798/9662d4798e9f4d289957d2c6ff619898.png"><br>  <i>Abb. 7.</i>  <i>Signale von den Ports des Mikrocontrollers.</i>  <i>Signal SSP1IF - Unterbrechungen beim Empfang eines Bytes durch das SPI-Modul.</i> <br><br>  Abbildung 7 zeigt die Signaldiagramme, wobei: <br><blockquote>  DHT (dat) - Signal auf der Signalleitung des Sensors - Einspeisung in den Eingang des MOSI-Moduls SPI; <br>  TMR6! = RP6 - dedizierte Uhr - an den SCK des SPI-Moduls senden; <br>  SSP1IF - Interrupt-Signal (Datenbereitschaft im SPI-Puffer) - Tats√§chlich zeigt dieses Signal die Last des Mikrocontrollerkerns - Lesen der Ergebnisdaten. </blockquote><br><h2>  Dekodierung anderer PWM-Protokolle </h2><br>  √Ñhnliche "Single-Wire" PWM-Protokolle werden in IR-Fernbedienungen f√ºr Haushaltsger√§te verwendet.  W√§hrend der IR-√úbertragung wird h√§ufig die Codierung durch die Position des Impulses verwendet, wenn die Dauer konstant und die Pause variabel ist.  Diese Option wird auch als "Variable Pause Encoding" bezeichnet.  Tats√§chlich ist dies die gleiche PWM-Codierung, jedoch mit einem invertierten Signal.  Bei Vorhandensein logischer Zellen ist die Inversion kein Problem, au√üerdem invertieren IR-Empf√§nger das empfangene Signal.  In Abb.  Abbildung 8 zeigt die Signale, nachdem der Empf√§nger von zwei verschiedenen Konsolen empfangen wurde. <br><br><img src="https://habrastorage.org/files/6a8/6ca/62e/6a86ca62ec704b029650cfc4cb1d70a8.png"><br><img src="https://habrastorage.org/files/739/1a1/4bb/7391a14bb1764eef9a3d36d4f19c40c9.png"><br>  <i>Abb. 8.</i>  <i>Codierungsoptionen f√ºr IR-Fernbedienungen.</i> <br><br>  Beide Fernbedienungen haben unterschiedliche Protokolle, aber diese Protokolle k√∂nnen auf die oben beschriebene Weise leicht decodiert werden. Das einzige ist, dass der Beginn des Sendens bestimmt werden muss, um die Einbeziehung von SPI zu synchronisieren, da der IR-Empf√§nger Interferenzen abfangen kann. <br><br><img src="https://habrastorage.org/files/205/4b6/99a/2054b699a4244346990f8748f65733df.png"><br><img src="https://habrastorage.org/files/c3b/4f0/49c/c3b4f049ce3b408b9ff8715cdf017579.png"><br>  <i>Abb.</i>  <i>9. Mit SPI dekodierte Signale.</i> <br><br>  Nicht alle IR-Fernbedienungen verf√ºgen √ºber eine PWM-Codierung.  Einige Protokolle, zum Beispiel RC5, haben eine Phasenkodierung (Manchester-Code, "0" wird als 10 und "1" als 01 √ºbertragen) [4].  Die Dekodierung des Manchester-Codes unter Verwendung der Peripherie eines unabh√§ngigen Kernels haben wir bereits weiter oben im ersten Teil betrachtet [1]. <br><br><h2>  Zusammenfassung </h2><br>  Anstelle von fast 100% der CPU-Auslastung des Mikrocontrollers f√ºr die Dekodierung des PWM-Protokolls in der Arduino-Version (ja, ich wei√ü, das Problem kann mithilfe von Erfassungsmodulen oder anderen Peripherieger√§ten effizienter gel√∂st werden) haben wir den Empfang des Informationspakets an die Hardware √ºbertragen.  Die Vorderseite des Eingangssignals startet den Timer, der Status des Timers bestimmt den Ausgang des Blocks logischer Zellen, der Ausgang der logischen Zelle wird dem SPI zugef√ºhrt. <br><br>  Die Verwendung von Peripherieger√§ten unabh√§ngig vom Kern erm√∂glicht die Optimierung der Ressourcennutzung, die √úbertragung einiger Aufgaben auf die Hardware, die Vereinfachung des Codes und die Reduzierung des Verbrauchs. <br><br><h2>  Literatur </h2><br>  1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Konfigurierbare Logikzellen in PIC-Controllern.</a> <br>  2. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">50 Schattierungen von Stumpf.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Eingangs- / Ausgangsanschl√ºsse</a> <br>  3. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">50 Schattierungen von Stumpf.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ADC und ADC mit Microchip-Mikrocontroller-Computer</a> <br>  4. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">sbprojects.com/knowledge/ir/rc5.php</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de401541/">https://habr.com/ru/post/de401541/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de401529/index.html">Fragen Sie Ethan: Kann das Universum als lebendig betrachtet werden?</a></li>
<li><a href="../de401531/index.html">Im Rahmen des Projekts ‚ÄûWissenschaft ist kein Mehl‚Äú wird eine Diskussion zum Thema ‚ÄûSex, Drogen, Rock and Roll: Sucht oder Leben?‚Äú Stattgef√ºhrt.</a></li>
<li><a href="../de401533/index.html">Schwierigkeiten bei der Auswahl einer Budget-Grafikkarte am Beispiel des RX 460</a></li>
<li><a href="../de401535/index.html">Kolonie. Kapitel 4: Die alte Milit√§rbasis</a></li>
<li><a href="../de401539/index.html">NVidia GPU-Stresstest bei Live-Stream-Transcodierung</a></li>
<li><a href="../de401543/index.html">Verwendung von Datens√§tzen aus dem russischen offenen Datenportal data.gov.ru</a></li>
<li><a href="../de401545/index.html">Chef, ich sehe dich. Intel Unite - Professionelles Kommunikationstool</a></li>
<li><a href="../de401549/index.html">Exotische Materiezust√§nde, LCDs und die Zukunft des Wassers</a></li>
<li><a href="../de401551/index.html">Valve entwickelt drei VR-Spiele gleichzeitig und hofft auf technologische Entwicklung</a></li>
<li><a href="../de401555/index.html">Die n√ºtzlichsten Heimroboter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>