<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÅÔ∏è üêà üê∫ D√©veloppement d'op√©rateurs Kubernetes avec Operator Framework ü§ôüèΩ üëò üë©‚Äçüé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comme mentionn√© dans l'article de Radar Technology , Lamoda s'oriente activement vers une architecture de microservices. La plupart de nos services so...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©veloppement d'op√©rateurs Kubernetes avec Operator Framework</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/446648/"><p><img src="https://habrastorage.org/getpro/habr/post_images/352/5c8/f16/3525c8f16510afa2b61b0ff9b8434a02.png" alt="Image"></p><br><p>  Comme mentionn√© dans l'article de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Radar Technology</a> , Lamoda s'oriente activement vers une architecture de microservices.  La plupart de nos services sont packag√©s √† l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Helm</a> et d√©ploy√©s sur Kubernetes.  Cette approche r√©pond pleinement √† nos besoins dans 99% des cas.  Il reste 1% lorsque la fonctionnalit√© Kubernetes standard n'est pas suffisante, par exemple, lorsque vous devez configurer une sauvegarde ou une mise √† jour de service pour un √©v√©nement sp√©cifique.  Pour r√©soudre ce probl√®me, nous utilisons le mod√®le d'op√©rateur.  Dans cette s√©rie d'articles, moi - Grigory Mikhalkin, d√©veloppeur de l'√©quipe R&amp;D de Lamoda - parlerai des le√ßons que j'ai tir√©es de mon exp√©rience dans le d√©veloppement d'op√©rateurs K8 utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Operator Framework</a> . </p><a name="habracut"></a><br><h2 id="chto-takoe-operator">  Qu'est-ce qu'un op√©rateur? </h2><br><p>  Une fa√ßon d'√©tendre les fonctionnalit√©s de Kubernetes consiste √† cr√©er vos propres contr√¥leurs.  Les principales abstractions dans Kubernetes sont les objets et les contr√¥leurs.  Les objets d√©crivent l'√©tat souhait√© du cluster.  Par exemple, un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pod</a> d√©crit quels conteneurs doivent √™tre d√©marr√©s et les param√®tres de d√©marrage, et l'objet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ReplicaSet</a> indique combien de r√©pliques de ce pod doivent √™tre lanc√©es.  Les contr√¥leurs contr√¥lent l'√©tat du cluster en fonction de la description des objets, dans le cas d√©crit ci-dessus, le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ReplicationController</a> prendra en charge le nombre de r√©pliques de pod sp√©cifi√© dans le ReplicaSet.  Avec l'aide de nouveaux contr√¥leurs, vous pouvez impl√©menter une logique suppl√©mentaire, telle que l'envoi de notifications d'√©v√©nements, la r√©cup√©ration apr√®s une panne ou la gestion de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ressources tierces</a> . </p><br><p>  Un op√©rateur est une application kubernetes qui comprend un ou plusieurs contr√¥leurs desservant une ressource tierce.  Le concept a √©t√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">invent√© par l'√©quipe CoreOS</a> en 2016, et r√©cemment, la popularit√© des op√©rateurs a augment√© rapidement.  Vous pouvez essayer de trouver l'op√©rateur souhait√© dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">liste sur kubedex</a> (plus de 100 op√©rateurs publiquement disponibles sont r√©pertori√©s ici), ainsi que sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OperatorHub</a> .  Il existe 3 outils populaires pour le d√©veloppement des op√©rateurs: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kubebuilder</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Operator SDK</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Metacontroller</a> .  Dans Lamoda, nous utilisons le SDK op√©rateur, nous en parlerons donc plus tard. </p><br><h2 id="operator-sdk">  SDK op√©rateur </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f7e/56d/194/f7e56d1948a2f5291ef189e7a03df9be.png" alt="Image"></p><br><p>  Operator SDK fait partie de Operator Framework, qui comprend deux parties plus importantes: Operator Lifecycle Manager et Operator Metering. </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le SDK op√©rateur</a> est un wrapper pour l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ex√©cution</a> du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">contr√¥leur</a> , une biblioth√®que populaire pour d√©velopper des contr√¥leurs (qui, √† son tour, est un wrapper pour le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">client-go</a> ), un g√©n√©rateur de code + un cadre pour √©crire des tests E2E. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Operator Lifecycle Manager</a> - un cadre de gestion des op√©rateurs existants;  r√©sout les situations lorsque l'op√©rateur passe en mode zombie ou qu'une nouvelle version est d√©ploy√©e. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comptage de l'op√©rateur</a> - comme son nom l'indique, il collecte des donn√©es sur le travail de l'op√©rateur et peut √©galement g√©n√©rer des rapports en fonction de ceux-ci. </li></ul><br><h2 id="sozdanie-novogo-proekta">  Cr√©er un nouveau projet </h2><br><p>  Un exemple est un op√©rateur qui surveille un fichier avec des configurations dans le r√©f√©rentiel et, une fois mis √† jour, red√©marre le d√©ploiement du service avec de nouvelles configurations.  L'exemple de code complet est disponible <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4c0/e84/ebc/4c0e84ebcba8cad49b2bea8506f79d32.png" alt="Image"></p><br><p>  Cr√©ez un projet avec un nouvel op√©rateur: </p><br><pre><code class="plaintext hljs">operator-sdk new config-monitor</code> </pre> <br><p>  Le g√©n√©rateur de code cr√©era du code pour l'op√©rateur travaillant dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">espace de noms</a> allou√©.  Cette approche est pr√©f√©rable √† l'acc√®s √† l'ensemble du cluster, car en cas d'erreur les probl√®mes seront isol√©s dans le m√™me espace de noms.  L'op√©rateur √† l' <code>cluster-wide</code> peut √™tre g√©n√©r√© en ajoutant <code>--cluster-scoped</code> .  Les r√©pertoires suivants seront situ√©s √† l'int√©rieur du projet cr√©√©: </p><br><ul><li>  cmd - contient le <code>main package</code> , dans lequel <code>Manager</code> initialis√© et lanc√©; </li><li>  deploy - contient les instructions de l'op√©rateur, du CRD et des objets n√©cessaires √† la configuration de l'op√©rateur RBAC; </li><li>  pkg - voici notre code principal pour les nouveaux objets et contr√¥leurs. </li></ul><br><p>  Il n'y a qu'un seul fichier <a href=""><code>cmd/manager/main.go</code></a> dans <a href=""><code>cmd/manager/main.go</code></a> . </p><br><div class="spoiler">  <b class="spoiler_title">Extrait de code</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">// Become the leader before proceeding err = leader.Become(ctx, "config-monitor-lock") if err != nil { log.Error(err, "") os.Exit(1) } // Create a new Cmd to provide shared dependencies and start components mgr, err := manager.New(cfg, manager.Options{ Namespace: namespace, MetricsBindAddress: fmt.Sprintf("%s:%d", metricsHost, metricsPort), }) ... // Setup Scheme for all resources if err := apis.AddToScheme(mgr.GetScheme()); err != nil { log.Error(err, "") os.Exit(1) } // Setup all Controllers if err := controller.AddToManager(mgr); err != nil { log.Error(err, "") os.Exit(1) } ... // Start the Cmd if err := mgr.Start(signals.SetupSignalHandler()); err != nil { log.Error(err, "Manager exited non-zero") os.Exit(1) }</code> </pre> </div></div><br><p>  Dans la premi√®re ligne: <code>err = leader.Become(ctx, "config-monitor-lock")</code> - un leader est s√©lectionn√©.  Dans la plupart des sc√©narios, une seule instance active d'une instruction sur l'espace de noms / cluster est n√©cessaire.  Par d√©faut, le SDK op√©rateur utilise la strat√©gie <a href="">Leader pour la vie</a> - la premi√®re instance lanc√©e de l'op√©rateur restera leader jusqu'√† ce qu'elle soit supprim√©e du cluster. </p><br><p>  Une fois que cette instance d'op√©rateur a √©t√© nomm√©e leader, un nouveau <code>Manager</code> est initialis√© - <code>mgr, err := manager.New(...)</code> .  Ses responsabilit√©s incluent: </p><br><ul><li>  <code>err := apis.AddToScheme(mgr.GetScheme())</code> - enregistrement de nouveaux sch√©mas de ressources; </li><li>  <code>err := controller.AddToManager(mgr)</code> - enregistrement des contr√¥leurs; </li><li>  <code>err := mgr.Start(signals.SetupSignalHandler())</code> - lance et contr√¥le les contr√¥leurs. </li></ul><br><p>  Pour le moment, nous n'avons ni nouvelles ressources, ni contr√¥leurs pour l'enregistrement.  Vous pouvez ajouter une nouvelle ressource √† l'aide de la commande: </p><br><pre> <code class="plaintext hljs">operator-sdk add api --api-version=services.example.com/v1alpha1 --kind=MonitoredService</code> </pre> <br><p>  Cette commande ajoutera la d√©finition du sch√©ma de ressource <code>MonitoredService</code> au r√©pertoire <code>pkg/apis</code> , ainsi que yaml avec la d√©finition <code>CRD</code> dans <code>deploy/crds</code> .  De tous les fichiers g√©n√©r√©s, vous devez modifier manuellement uniquement la d√©finition de sch√©ma dans <a href=""><code>monitoredservice_types.go</code></a> .  Le type <code>MonitoredServiceSpec</code> d√©finit l'√©tat souhait√© de la ressource: ce que l'utilisateur sp√©cifie dans yaml avec la d√©finition de la ressource.  Dans le contexte de notre op√©rateur, le champ <code>Size</code> d√©termine le nombre souhait√© de r√©pliques, <code>ConfigRepo</code> indique d'o√π les <code>ConfigRepo</code> actuelles peuvent √™tre extraites.  <code>MonitoredServiceStatus</code> d√©termine l'√©tat observ√© de la ressource, par exemple, il stocke les noms des pods appartenant √† cette ressource et les <code>spec</code> actuels. </p><br><p>  Apr√®s avoir modifi√© le sch√©ma, vous devez ex√©cuter la commande: </p><br><pre> <code class="plaintext hljs">operator-sdk generate k8s</code> </pre> <br><p>  Il mettra √† jour la d√©finition de <code>CRD</code> dans <code>deploy/crds</code> . </p><br><p>  Cr√©ons maintenant la partie principale de notre op√©rateur, le contr√¥leur: </p><br><pre> <code class="plaintext hljs">operator-sdk add controller --api-version=services.example.com/v1alpha1 --kind=Monitor</code> </pre> <br><p>  Le fichier <a href=""><code>monitor_controller.go</code></a> appara√Ætra dans le <a href=""><code>monitor_controller.go</code></a> <code>pkg/controller</code> , dans lequel nous ajoutons la logique dont nous avons besoin. </p><br><h2 id="razrabotka-kontrollera">  D√©veloppement du contr√¥leur </h2><br><p>  Le contr√¥leur est l'unit√© de travail principale de l'op√©rateur.  Dans notre cas, il existe deux contr√¥leurs: </p><br><ul><li>  Contr√¥ler le contr√¥leur surveille les changements de configuration du service; </li><li>  Le contr√¥leur de mise √† niveau met √† jour le service et le maintient dans l'√©tat souhait√©. </li></ul><br><p>  √Ä sa base, le contr√¥leur est une boucle de contr√¥le, il surveille la file d'attente avec les √©v√©nements auxquels il est abonn√© et les traite: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/220/2e6/a09/2202e6a0931df3e5b87c4442dd839615.png" alt="Image"></p><br><p>  Un nouveau contr√¥leur est cr√©√© et enregistr√© par le gestionnaire dans la m√©thode <code>add</code> : </p><br><pre> <code class="plaintext hljs">c, err := controller.New("monitor-controller", mgr, controller.Options{Reconciler: r})</code> </pre> <br><p>  En utilisant la m√©thode <code>Watch</code> , nous l'abonnons aux √©v√©nements concernant la cr√©ation d'une nouvelle ressource ou la mise √† jour des <code>Spec</code> d'une ressource <code>MonitoredService</code> existante: </p><br><pre> <code class="plaintext hljs">err = c.Watch(&amp;source.Kind{Type: &amp;servicesv1alpha1.MonitoredService{}}, &amp;handler.EnqueueRequestForObject{}, common.CreateOrUpdateSpecPredicate)</code> </pre> <br><p>  Le type d'√©v√©nement peut √™tre configur√© √† l'aide des param√®tres <code>src</code> et <code>predicates</code> .  <code>src</code> accepte les objets de type <code>Source</code> . </p><br><ul><li>  <code>Informer</code> - interroge p√©riodiquement l' <code>apiserver</code> pour les √©v√©nements qui correspondent au filtre, s'il existe un tel √©v√©nement, le place dans la file d'attente du contr√¥leur.  Dans l' <code>controller-runtime</code> il s'agit d'un wrapper sur le <code>SharedIndexInformer</code> de <code>client-go</code> . </li><li>  <code>Kind</code> est √©galement un wrapper sur <code>SharedIndexInformer</code> , mais, contrairement √† <code>Informer</code> , il cr√©e ind√©pendamment une instance d'indicateur bas√©e sur les param√®tres pass√©s (sch√©ma de la ressource surveill√©e). </li><li>  <code>Channel</code> - accepte l'√©v√©nement <code>chan event.GenericEvent</code> comme param√®tre, les √©v√©nements qui le traversent sont plac√©s dans la file d'attente du contr√¥leur. </li></ul><br><p>  <code>redicates</code> attend des objets qui satisfont l'interface <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>Predicate</code></a> .  En fait, il s'agit d'un filtre suppl√©mentaire pour les √©v√©nements, par exemple, lorsque vous filtrez <code>UpdateEvent</code> vous pouvez voir exactement quelles modifications ont √©t√© apport√©es √† la <code>spec</code> ressource. </p><br><p>  Lorsqu'un √©v√©nement arrive, un <code>EventHandler</code> accepte - le deuxi√®me argument de la m√©thode <code>Watch</code> - qui encapsule l'√©v√©nement dans le format de requ√™te attendu par le <code>Reconciler</code> : </p><br><ul><li>  <code>EnqueueRequestForObject</code> - cr√©e une demande avec le nom et l'espace de noms de l'objet qui a provoqu√© l'√©v√©nement; </li><li>  <code>EnqueueRequestForOwner</code> - cr√©e une demande avec les donn√©es du parent de l'objet.  Cela est n√©cessaire, par exemple, si le <code>Pod</code> contr√¥l√© par les ressources <code>Pod</code> √©t√© supprim√© et que vous devez commencer son remplacement; </li><li>  <code>EnqueueRequestsFromMapFunc</code> - prend en param√®tre la fonction de <code>map</code> qui re√ßoit un √©v√©nement (envelopp√© dans <code>MapObject</code> ) et renvoie une liste de demandes.  <a href="">Un exemple lorsque ce gestionnaire</a> est <a href="">n√©cessaire</a> - il y a un temporisateur, pour chaque tick dont vous devez extraire de nouvelles configurations pour tous les services disponibles. </li></ul><br><p>  Les demandes sont plac√©es dans la file d'attente du contr√¥leur, et l'un des travailleurs (par d√©faut, le contr√¥leur en a une) extrait l'√©v√©nement de la file d'attente et le transmet √† <code>Reconciler</code> . </p><br><p>  <strong>Reconciler</strong> impl√©mente une seule m√©thode - <code>Reconcile</code> , qui contient la logique de base du traitement des √©v√©nements: </p><br><div class="spoiler">  <b class="spoiler_title">m√©thode de r√©conciliation</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">func (r *ReconcileMonitor) Reconcile(request reconcile.Request) (reconcile.Result, error) { reqLogger := log.WithValues("Request.Namespace", request.Namespace, "Request.Name", request.Name) reqLogger.Info("Checking updates in repo for MonitoredService") // fetch the Monitor instance instance := &amp;servicesv1alpha1.MonitoredService{} err := r.client.Get(context.Background(), request.NamespacedName, instance) if err != nil { if errors.IsNotFound(err) { // Request object not found, could have been deleted after reconcile request. // Owned objects are automatically garbage collected. For additional cleanup logic use finalizers. // Return and don't requeue return reconcile.Result{}, nil } // Error reading the object - requeue the request. return reconcile.Result{}, err } // check if service's config was updated // if it was, send event to upgrade controller if podSpec, ok := r.isServiceConfigUpdated(instance); ok { // Update instance Spec instance.Status.PodSpec = *podSpec instance.Status.ConfigChanged = true err = r.client.Status().Update(context.Background(), instance) if err != nil { reqLogger.Error(err, "Failed to update service status", "Service.Namespace", instance.Namespace, "Service.Name", instance.Name) return reconcile.Result{}, err } r.eventsChan &lt;- event.GenericEvent{Meta: &amp;servicesv1alpha1.MonitoredService{}, Object: instance} } return reconcile.Result{}, nil }</code> </pre> </div></div><br><p>  La m√©thode accepte un objet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>Request</code></a> avec le champ <code>NamespacedName</code> , par lequel la ressource peut √™tre extraite du cache: <code>r.client.Get(context.TODO(), request.NamespacedName, instance)</code> .  Dans l'exemple, une demande est <code>ConfigRepo</code> au fichier avec la configuration de service r√©f√©renc√©e par le champ <code>ConfigRepo</code> dans la <code>spec</code> ressource.  Si la configuration est mise √† jour, un nouvel √©v√©nement du type <code>GenericEvent</code> est <code>GenericEvent</code> et envoy√© au canal <code>GenericEvent</code> le contr√¥leur de <code>Upgrade</code> √† niveau. </p><br><p>  Apr√®s avoir trait√© la demande, <code>Reconcile</code> renvoie un objet de type <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>Result</code></a> et <code>error</code> .  Si le champ <code>Result</code> est <code>Requeue: true</code> ou <code>error != nil</code> , le contr√¥leur renverra la demande dans la file d'attente √† l'aide de la m√©thode <code>queue.AddRateLimited</code> .  La demande sera renvoy√©e dans la file d'attente avec un d√©lai, qui est d√©termin√© par <code>RateLimiter</code> .  Par d√©faut, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>ItemExponentialFailureRateLimiter</code></a> utilis√©, ce qui augmente le temps de retard de fa√ßon exponentielle avec une augmentation du nombre de ¬´retours¬ª de requ√™tes.  Si le champ <code>Requeue</code> pas d√©fini et qu'aucune erreur ne s'est produite lors du traitement de la demande, le contr√¥leur appellera la m√©thode <code>Queue.Forget</code> , qui supprimera la demande du cache de <code>RateLimiter</code> (r√©initialisant ainsi le nombre de retours).  √Ä la fin du traitement de la demande, le contr√¥leur le supprime de la file d'attente √† l'aide de la m√©thode <code>Queue.Done</code> . </p><br><h2 id="zapusk-operatora">  Lancement de l'op√©rateur </h2><br><p>  Les composants de l'op√©rateur ont √©t√© d√©crits ci-dessus et une question demeure: comment le d√©marrer.  Vous devez d'abord vous assurer que toutes les ressources n√©cessaires sont install√©es (pour les tests locaux, je recommande la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">configuration</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">minikube</a> ): </p><br><pre> <code class="plaintext hljs"># Setup Service Account kubectl create -f deploy/service_account.yaml # Setup RBAC kubectl create -f deploy/role.yaml kubectl create -f deploy/role_binding.yaml # Setup the CRD kubectl create -f deploy/crds/services_v1alpha1_monitoredservice_crd.yaml # Setup custom resource kubectl create -f deploy/crds/services_v1alpha1_monitoredservice_cr.yaml</code> </pre> <br><p>  Une fois les conditions pr√©alables remplies, il existe deux m√©thodes simples pour ex√©cuter l'instruction √† des fins de test.  Le plus simple est de le d√©marrer en dehors du cluster √† l'aide de la commande: </p><br><pre> <code class="plaintext hljs">operator-sdk up local --namespace=default</code> </pre> <br><p>  La deuxi√®me fa√ßon consiste √† d√©ployer l'op√©rateur dans le cluster.  Vous devez d'abord cr√©er une image Docker avec l'op√©rateur: </p><br><pre> <code class="plaintext hljs">operator-sdk build config-monitor-operator:latest</code> </pre> <br><p>  Dans le fichier <code>deploy/operator.yaml</code> , remplacez <code>REPLACE_IMAGE</code> par <code>config-monitor-operator:latest</code> : </p><br><pre> <code class="plaintext hljs">sed -i "" 's|REPLACE_IMAGE|config-monitor-operator:latest|g' deploy/operator.yaml</code> </pre> <br><p>  Cr√©er un d√©ploiement avec instruction: </p><br><pre> <code class="plaintext hljs">kubectl create -f deploy/operator.yaml</code> </pre> <br><p>  Maintenant, dans la liste des <code>Pod</code> sur le cluster devrait appara√Ætre <code>Pod</code> avec un service de test, et dans le deuxi√®me cas - un autre avec un op√©rateur. </p><br><h2 id="vmesto-zaklyucheniya-ili-best-practices">  Au lieu d'une conclusion ou des meilleures pratiques </h2><br><p>  Les probl√®mes cl√©s du d√©veloppement des op√©rateurs pour le moment sont la faible documentation des outils et le manque de bonnes pratiques √©tablies.  Lorsqu'un nouveau d√©veloppeur commence √† d√©velopper un op√©rateur, il n'a nulle part o√π regarder pratiquement des exemples de mise en ≈ìuvre d'une exigence particuli√®re, donc les erreurs sont in√©vitables.  Voici quelques le√ßons que nous avons tir√©es de nos erreurs: </p><br><ul><li>  S'il y a deux applications li√©es, vous devez √©viter de vouloir les combiner avec un seul op√©rateur.  Sinon, le principe des services de couplage l√¢che est viol√©. </li><li>  Vous devez vous rappeler de la s√©paration des pr√©occupations: vous ne devriez pas essayer d'impl√©menter toute la logique dans un seul contr√¥leur.  Par exemple, il vaut la peine d'√©tendre les fonctions de surveillance des configurations et de cr√©ation / mise √† jour d'une ressource. </li><li>  Le blocage des appels doit √™tre √©vit√© dans la m√©thode <code>Reconcile</code> .  Par exemple, vous pouvez extraire des configurations depuis une source externe, mais si l'op√©ration est plus longue, cr√©ez un goroutine pour cela et renvoyez la demande √† la file d'attente, en indiquant dans la r√©ponse <code>Requeue: true</code> . </li></ul><br><p>  Dans les commentaires, il serait int√©ressant de conna√Ætre votre exp√©rience dans le d√©veloppement d'op√©rateurs.  Et dans la partie suivante, nous parlerons des tests des op√©rateurs. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr446648/">https://habr.com/ru/post/fr446648/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr446634/index.html">SDN Digest - Six √©mulateurs Open Source</a></li>
<li><a href="../fr446638/index.html">Cisco HyperFlex contre concurrents: tester les performances</a></li>
<li><a href="../fr446640/index.html">20 projets, 20 langues, date limite hier. 2e partie</a></li>
<li><a href="../fr446642/index.html">Liste de contr√¥le pour la cr√©ation et la publication d'applications Web</a></li>
<li><a href="../fr446646/index.html">InterSystems IRIS 2019.1 Release</a></li>
<li><a href="../fr446650/index.html">Combien co√ªtent les testeurs et de quoi d√©pendent leurs salaires? Construire le portrait d'un sp√©cialiste en AQ performant</a></li>
<li><a href="../fr446652/index.html">MVCC-4. Instantan√©s de donn√©es</a></li>
<li><a href="../fr446656/index.html">Codage de la parole √† 1600 bits / s avec vocodeur neuronal LPCNet</a></li>
<li><a href="../fr446658/index.html">Entretien avec Andrei Stankevich sur la programmation sportive</a></li>
<li><a href="../fr446662/index.html">Transactions et m√©canismes de contr√¥le</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>