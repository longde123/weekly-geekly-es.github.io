<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦐 🕺🏻 🛀🏿 Python SAX parser vs python DOM parser. Parsim FIAS-rumah 🍋 🍨 🤙🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dalam artikel sebelumnya, kami mempertimbangkan pendekatan untuk membuat csv dari xml pada database yang diterbitkan oleh FIAS. Parsing didasarkan pad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Python SAX parser vs python DOM parser. Parsim FIAS-rumah</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469995/">  Dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel</a> sebelumnya, kami mempertimbangkan pendekatan untuk membuat csv dari xml pada database yang diterbitkan oleh FIAS.  Parsing didasarkan pada parser DOM, yang memuat seluruh file ke dalam memori sebelum diproses, yang menyebabkan kebutuhan untuk membagi file besar mengingat keterbatasan jumlah RAM.  Kali ini disarankan untuk melihat seberapa bagus parser SAX dan membandingkan kecepatannya dengan parser DOM.  File database FIAS terbesar, rumah, berukuran 27,5 GB, akan digunakan sebagai subjek uji. <br><a name="habracut"></a><br><h3>  Entri </h3><br>  Kami dipaksa untuk segera mengganggu publik yang paling dihormati - segera gagal memberi makan file database FIX houses ke parser SAX.  Parser lumpuh dengan kesalahan "tidak terbentuk dengan baik (token tidak valid)".  Dan awalnya ada kecurigaan bahwa file database rusak.  Namun, setelah memotong database menjadi beberapa bagian kecil, ditemukan bahwa keberangkatan disebabkan oleh perubahan kode untuk nomor rumah dan / atau bangunan.  Artinya, tag STRUCNUM atau HOUSENUM datang di rumah-rumah dengan surat yang ditulis dalam penyandian aneh (bukan UTF-8 dan bukan ANSI, di mana dokumen itu sendiri dibentuk): <br><br><img src="https://habrastorage.org/webt/eg/1v/mz/eg1vmzcqzef4jpx2wunge7wwmhq.png"><br><br>  Pada saat yang sama, jika pengodean ini diluruskan dengan menjalankan file melalui fungsi remove_non_ascii, catatan mengambil bentuk: <br><br><img src="https://habrastorage.org/webt/np/vw/xb/npvwxbnf_tzzrx1cuemjrhfpnsc.png"><br><br>  File seperti itu juga tidak diserap oleh parser, karena karakter tambahan. <br><br>  Saya harus mengingat ekspresi reguler dan membersihkan file sebelum memuatnya ke parser. <br>  Pertanyaan: mengapa tidak mungkin untuk membuat database normal, yang ditata untuk pekerjaan memperoleh bayangan retoris. <br><br>  Untuk menyelaraskan kemampuan awal parser, kami menghapus fragmen uji dari inkonsistensi di atas. <br><br>  Kode untuk menghapus file database sebelum memuatnya ke parser: <br><br><div class="spoiler">  <b class="spoiler_title">Kode</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> unidecode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unidecode start = datetime.now() f= open(<span class="hljs-string"><span class="hljs-string">'AS_HOUSE.462.xml'</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>,encoding=<span class="hljs-string"><span class="hljs-string">'ANSI'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove_non_ascii</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> unidecode(unidecode(text)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> f: b=remove_non_ascii(line) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> re.finditer(<span class="hljs-string"><span class="hljs-string">r'\w{5}NUM="\d{1,}\"\w\"'</span></span>,b): print(c[<span class="hljs-number"><span class="hljs-number">0</span></span>]) c1=c[<span class="hljs-number"><span class="hljs-number">0</span></span>][:<span class="hljs-number"><span class="hljs-number">-3</span></span>]+c[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">-2</span></span>] print(c1) b=b.replace(c[<span class="hljs-number"><span class="hljs-number">0</span></span>],c1) <span class="hljs-comment"><span class="hljs-comment">#    #  f1= open('out.xml', 'w',encoding='ANSI') f1.write(b) f1.close() f.close() print(datetime.now()- start)</span></span></code> </pre> <br></div></div><br>  Kode menerjemahkan karakter non_ascii menjadi normal dalam file xml dan kemudian menghapus "" yang tidak perlu atas nama bangunan dan rumah. <br><br><h3>  Parser sax </h3><br>  Untuk memulai, ambil file xml kecil (58,8 MB), kami berencana untuk mendapatkan txt atau csv di output, nyaman untuk diproses lebih lanjut dalam panda atau excel. <br><br><div class="spoiler">  <b class="spoiler_title">Kode</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> xml.sax <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> csv <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime start = datetime.now() <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventHandler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(xml.sax.ContentHandler)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,target)</span></span></span><span class="hljs-function">:</span></span> self.target = target <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,name,attrs)</span></span></span><span class="hljs-function">:</span></span> self.target.send(attrs._attrs.values()) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">characters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,text)</span></span></span><span class="hljs-function">:</span></span> self.target.send(<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">endElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,name)</span></span></span><span class="hljs-function">:</span></span> self.target.send(<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">coroutine</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(func)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*args,**kwargs)</span></span></span><span class="hljs-function">:</span></span> cr = func(*args,**kwargs) cr.__next__() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cr <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> start <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'out.csv'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: <span class="hljs-comment"><span class="hljs-comment"># example use if __name__ == '__main__': @coroutine def printer(): while True: event = (yield) print(event,file=f) xml.sax.parse("out.xml", EventHandler(printer())) print(datetime.now()- start)</span></span></code> </pre><br></div></div><br>  Setelah menjalankan program, kami mendapatkan nilai dari kamus python: <br><br><img src="https://habrastorage.org/webt/ub/zj/jf/ubzjjfrrhad7c2vtnrtcknmq208.png"><br><br>  Waktu pimpin: 5-6 detik. <br><br><h3>  Pengurai DOM </h3><br>  Kami memproses file yang sama dengan terlebih dahulu memuatnya secara keseluruhan ke dalam memori.  Ini persis metode yang digunakan parser DOM. <br><br><div class="spoiler">  <b class="spoiler_title">Kode</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> codecs,os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> xml.etree.ElementTree <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ET <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> csv <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime parser = ET.XMLParser(encoding=<span class="hljs-string"><span class="hljs-string">"ANSI"</span></span>) tree = ET.parse(<span class="hljs-string"><span class="hljs-string">"out.xml"</span></span>,parser=parser) root = tree.getroot() Resident_data = open(<span class="hljs-string"><span class="hljs-string">'AS_HOUSE.0001.csv'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span>,encoding=<span class="hljs-string"><span class="hljs-string">'ANSI'</span></span>) csvwriter = csv.writer(Resident_data) attr_names = [ <span class="hljs-string"><span class="hljs-string">'HOUSEID'</span></span>, <span class="hljs-string"><span class="hljs-string">'HOUSEGUID'</span></span>, <span class="hljs-string"><span class="hljs-string">'AOGUID'</span></span>, <span class="hljs-string"><span class="hljs-string">'HOUSENUM'</span></span>, <span class="hljs-string"><span class="hljs-string">'STRUCNUM'</span></span>, <span class="hljs-string"><span class="hljs-string">'STRSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'ESTSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'STATSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'IFNSFL'</span></span>, <span class="hljs-string"><span class="hljs-string">'IFNSUL'</span></span>, <span class="hljs-string"><span class="hljs-string">'TERRIFNSFL'</span></span>, <span class="hljs-string"><span class="hljs-string">'TERRIFNSUL'</span></span>, <span class="hljs-string"><span class="hljs-string">'OKATO'</span></span>, <span class="hljs-string"><span class="hljs-string">'OKTMO'</span></span>, <span class="hljs-string"><span class="hljs-string">'POSTALCODE'</span></span>, <span class="hljs-string"><span class="hljs-string">'STARTDATE'</span></span>, <span class="hljs-string"><span class="hljs-string">'ENDDATE'</span></span>, <span class="hljs-string"><span class="hljs-string">'UPDATEDATE'</span></span>, <span class="hljs-string"><span class="hljs-string">'COUNTER'</span></span>, <span class="hljs-string"><span class="hljs-string">'NORMDOC'</span></span>, <span class="hljs-string"><span class="hljs-string">'DIVTYPE'</span></span>, <span class="hljs-string"><span class="hljs-string">'REGIONCODE'</span></span> ] start = datetime.now() object = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> member <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> root.findall(<span class="hljs-string"><span class="hljs-string">'House'</span></span>): object = [member.attrib.get(attr_name, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> attr_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attr_names] csvwriter.writerow(object) Resident_data.close() print(datetime.now()- start)</code> </pre> <br></div></div><br>  Pimpin waktu 2-3 detik. <br>  Memenangkan parser DOM? <br><br><h3>  File yang lebih besar </h3><br>  File kecil tidak sepenuhnya mencerminkan kenyataan.  Mari kita ambil file yang lebih besar dari 353 MB (setelah dibersihkan, seperti yang ditunjukkan di atas). <br><br>  Hasil bahu: <br><br>  Pengurai SAX: 0: 00: 32.090836 - 32 dtk <br>  Pengurai DOM: 0: 00: 16.630951 - 16 dtk <br><br>  Perbedaannya adalah 2 kali kecepatan.  Namun, ini tidak mengurangi keunggulan utama SAX parser - kemampuan untuk memproses file besar tanpa terlebih dahulu memuatnya ke dalam memori. <br>  Masih disesalkan bahwa keuntungan ini tidak berlaku untuk basis data FIAS, karena pekerjaan pendahuluan dengan pengkodean diperlukan. <br><br>  File untuk pembersihan awal pengkodean: <br>  - 353 MB dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">arsip</a> . <br><br>  File DB yang dimurnikan untuk pengujian parser: <br>  - 353 MB dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">arsip</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id469995/">https://habr.com/ru/post/id469995/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id469983/index.html">Bagaimana cara membuat strategi untuk mengalahkan penuaan?</a></li>
<li><a href="../id469985/index.html">Mempercepat program untuk prosesor Redd yang disintesis tanpa optimisasi: mengganti jam</a></li>
<li><a href="../id469987/index.html">20 Perusahaan Pengembangan Pasar Terbaik Dari Seluruh Dunia</a></li>
<li><a href="../id469989/index.html">C # Regex dalam contoh</a></li>
<li><a href="../id469991/index.html">Kami memproses pesanan dari toko online menggunakan RabbitMQ dan TypeScript</a></li>
<li><a href="../id469997/index.html">Berita utama apa yang paling mungkin menarik perhatian atau analisis HabraHabr</a></li>
<li><a href="../id470001/index.html">Kiat & trik Linux: server, buka</a></li>
<li><a href="../id470003/index.html">F # 1: Hello World</a></li>
<li><a href="../id470005/index.html">Kontrol komputer jarak jauh melalui browser</a></li>
<li><a href="../id470009/index.html">Sortir foto berdasarkan data dari EXIF ​​+ PHP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>