<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘‚ğŸ½ ğŸ‘… ğŸ”¤ ä½¿ç”¨eBPFï¼ˆRHEL 8 Betaï¼‰è°ƒè¯•ç½‘ç»œ ğŸ•ºğŸ¾ ğŸ¤¹ğŸ½ ğŸ§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æ‰€æœ‰è¿‡å»çš„å‡æœŸï¼ 

 æˆ‘ä»¬å†³å®šåœ¨å‡æœŸåå°†ç¬¬ä¸€ç¯‡æ–‡ç« ä¸“é—¨ä»‹ç»Linuxï¼Œå³æˆ‘ä»¬ç²¾å½©çš„Linux Administratorè¯¾ç¨‹ï¼Œè¯¥è¯¾ç¨‹å±äºæœ€åŠ¨æ€çš„è¯¾ç¨‹ï¼Œå³å…·æœ‰æœ€ç›¸å…³çš„ææ–™å’Œå®è·µã€‚ å¥½å§ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬æä¾›äº†æœ‰è¶£çš„æ–‡ç« å’Œå…¬å¼€è¯¾ ã€‚ 

 å‘è¡¨è€…Matteo Croce 
 åŸå§‹æ ‡é¢˜ï¼š ä½¿ç”¨eBPFï¼ˆRHE...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä½¿ç”¨eBPFï¼ˆRHEL 8 Betaï¼‰è°ƒè¯•ç½‘ç»œ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/436528/">æ‰€æœ‰è¿‡å»çš„å‡æœŸï¼ <br><br> æˆ‘ä»¬å†³å®šåœ¨å‡æœŸåå°†ç¬¬ä¸€ç¯‡æ–‡ç« ä¸“é—¨ä»‹ç»Linuxï¼Œå³æˆ‘ä»¬ç²¾å½©çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Linux Administrator</a>è¯¾ç¨‹ï¼Œè¯¥è¯¾ç¨‹å±äºæœ€åŠ¨æ€çš„è¯¾ç¨‹ï¼Œå³å…·æœ‰æœ€ç›¸å…³çš„ææ–™å’Œå®è·µã€‚ å¥½å§ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬æä¾›äº†æœ‰è¶£çš„æ–‡ç« å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å…¬å¼€è¯¾</a> ã€‚ <br><br>  <i>å‘è¡¨è€…Matteo Croce</i> <i><br></i>  <i>åŸå§‹æ ‡é¢˜ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½¿ç”¨eBPFï¼ˆRHEL 8 Betaï¼‰è¿›è¡Œç½‘ç»œè°ƒè¯•</a></i> <br><br>  <b>å¼•è¨€</b> <br><br> è”ç½‘æ˜¯ä»¤äººå…´å¥‹çš„ä½“éªŒï¼Œä½†å¹¶éæ€»æ˜¯èƒ½é¿å…é—®é¢˜ã€‚ æ•…éšœæ’é™¤å¯èƒ½å¾ˆæ£˜æ‰‹ï¼Œå°±åƒè¯•å›¾é‡ç°â€œç°åœºâ€å‘ç”Ÿçš„é”™è¯¯è¡Œä¸ºä¸€æ ·ã€‚ <br><br> å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€äº›å·¥å…·å¯ä»¥å¸®åŠ©è§£å†³æ­¤é—®é¢˜ï¼šç½‘ç»œåç§°ç©ºé—´ï¼Œè™šæ‹Ÿæœºï¼Œ <code>tc</code>å’Œ<code>netfilter</code> ã€‚ å¯ä»¥ä½¿ç”¨ç½‘ç»œåç§°ç©ºé—´å’Œvethè®¾å¤‡æ¥å¤åˆ¶ç®€å•çš„ç½‘ç»œè®¾ç½®ï¼Œè€Œæ›´å¤æ‚çš„è®¾ç½®åˆ™éœ€è¦å°†è™šæ‹Ÿæœºä¸è½¯ä»¶æ¡¥è¿æ¥ï¼Œå¹¶ä½¿ç”¨æ ‡å‡†çš„ç½‘ç»œå·¥å…·ï¼ˆä¾‹å¦‚<code>iptables</code>æˆ–<code>tc</code> ï¼‰æ¥æ¨¡æ‹Ÿä¸æ­£ç¡®çš„è¡Œä¸ºã€‚ å¦‚æœSSHæœåŠ¡å™¨<code>iptables -A INPUT -p tcp --dport 22 -j REJECT --reject-with icmp-host-unreachable</code>æ—¶ç”Ÿæˆçš„ICMPå“åº”å‡ºç°é—®é¢˜ï¼Œåˆ™åœ¨æ­£ç¡®çš„åç§°ç©ºé—´ä¸­<code>iptables -A INPUT -p tcp --dport 22 -j REJECT --reject-with icmp-host-unreachable</code>å¯ä»¥å¸®åŠ©è§£å†³é—®é¢˜ã€‚ <br><br> æœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">eBPFï¼ˆæ‰©å±•çš„BPFï¼‰ï¼ˆ</a>ä¼¯å…‹åˆ©æ•°æ®åŒ…è¿‡æ»¤å™¨çš„é«˜çº§ç‰ˆæœ¬<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ï¼‰</a>è§£å†³å¤æ‚çš„ç½‘ç»œé—®é¢˜ã€‚  eBPFæ˜¯ä¸€é¡¹ç›¸å¯¹è¾ƒæ–°çš„æŠ€æœ¯ï¼Œè¯¥é¡¹ç›®å°šå¤„äºåˆæœŸé˜¶æ®µï¼Œå› æ­¤æ–‡æ¡£å’ŒSDKå°šæœªå‡†å¤‡å°±ç»ªã€‚ ä½†æ˜¯ï¼Œè®©æˆ‘ä»¬å¸Œæœ›æœ‰æ‰€æ”¹è¿›ï¼Œç‰¹åˆ«æ˜¯å› ä¸ºXDPï¼ˆeXpressæ•°æ®è·¯å¾„ï¼‰æ˜¯éš<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Red Hat Enterprise Linux 8 Betaä¸€èµ·æä¾›çš„</a> ï¼Œæ‚¨å¯ä»¥ç«‹å³ä¸‹è½½å¹¶è¿è¡Œå®ƒã€‚ <br><br>  eBPFä¸èƒ½è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä½†æ˜¯å®ƒä»ç„¶æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ç½‘ç»œè°ƒè¯•å·¥å…·ï¼Œå€¼å¾—å…³æ³¨ã€‚ æˆ‘ç›¸ä¿¡å®ƒå°†åœ¨ç½‘ç»œçš„æœªæ¥ä¸­æ‰®æ¼”éå¸¸é‡è¦çš„è§’è‰²ã€‚ <br><br><img src="https://habrastorage.org/webt/qf/la/jo/qflajolwk-bjp2zwjzpnixmqlma.png"><a name="habracut"></a><br><br>  <b>é—®é¢˜</b> <br><br> æˆ‘è°ƒè¯•äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¼€æ”¾vSwitchï¼ˆOVSï¼‰</a>ç½‘ç»œé—®é¢˜ï¼Œè¯¥é—®é¢˜æ¶‰åŠéå¸¸å¤æ‚çš„å®‰è£…ï¼šä¸€äº›TCPæ•°æ®åŒ…è¢«åˆ†æ•£å¹¶ä»¥é”™è¯¯çš„é¡ºåºä¼ é€’ï¼Œè™šæ‹Ÿæœºçš„å¸¦å®½ä»ç¨³å®šçš„6 Gb / sä¸‹é™åˆ°æ³¢åŠ¨çš„2-4 Gb / sã€‚ åˆ†æè¡¨æ˜ï¼Œæ¯ä¸ªå¸¦æœ‰PSHæ ‡å¿—çš„è¿æ¥çš„ç¬¬ä¸€ä¸ªTCPæ•°æ®åŒ…çš„å‘é€é¡ºåºéƒ½é”™è¯¯ï¼šæ¯ä¸ªè¿æ¥ä»…ç¬¬ä¸€ä¸ªï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ªã€‚ <br><br> æˆ‘å°è¯•åœ¨ä¸¤ä¸ªè™šæ‹Ÿæœºä¸Šé‡ç°æ­¤è®¾ç½®ï¼Œå¹¶ä¸”åœ¨è®¸å¤šå¸®åŠ©æ–‡ç« å’Œæœç´¢æŸ¥è¯¢ä¹‹åï¼Œæˆ‘å‘ç°<code>iptables</code>å’Œ<code>nftables</code>éƒ½ä¸èƒ½æ“çºµTCPæ ‡å¿—ï¼Œè€Œ<code>tc</code>å¯ä»¥æ“çºµï¼Œä½†æ˜¯åªèƒ½é‡å†™æ ‡å¿—å¹¶ä¸­æ–­æ–°è¿æ¥å’ŒTCPä¸€èˆ¬è€Œè¨€ã€‚ <br><br> ç»“åˆä½¿ç”¨<code>iptables</code> ï¼Œ <code>conntrack</code>å’Œ<code>tc</code>å¯èƒ½å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºè¿™å¯¹äºeBPFæ¥è¯´æ˜¯ä¸€é¡¹å‡ºè‰²çš„å·¥ä½œã€‚ <br><br>  <b>ä»€ä¹ˆæ˜¯eBPFï¼Ÿ</b> <br><br>  eBPFæ˜¯ä¼¯å…‹åˆ©åˆ†ç»„è¿‡æ»¤å™¨çš„å¢å¼ºç‰ˆæœ¬ã€‚ å¥¹ä¸ºBPFå¸¦æ¥äº†å¾ˆå¤šæ”¹è¿›ã€‚ ç‰¹åˆ«æ˜¯ï¼Œå®ƒå…è®¸æ‚¨åœ¨å†…å­˜ä¸­å†™å…¥æ•°æ®ï¼Œè€Œä¸ä»…ä»…æ˜¯è¯»å–æ•°æ®ï¼Œå› æ­¤ä¸ä»…å¯ä»¥è¿‡æ»¤è½¯ä»¶åŒ…ï¼Œè¿˜å¯ä»¥å¯¹å…¶è¿›è¡Œç¼–è¾‘ã€‚ <br><br> é€šå¸¸å°†eBPFç®€ç§°ä¸ºBPFï¼Œå¹¶å°†BPFæœ¬èº«ç§°ä¸ºcBPFï¼ˆç»å…¸ï¼ˆç»å…¸ï¼‰BPFï¼‰ï¼Œå› æ­¤æ ¹æ®ä¸Šä¸‹æ–‡ï¼Œå•è¯â€œ BPFâ€å¯ä»¥ç”¨æ¥è¡¨ç¤ºä¸¤ä¸ªç‰ˆæœ¬ï¼šåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æ€»æ˜¯è°ˆè®ºæ‰©å±•ç‰ˆæœ¬ã€‚ <br><br>  â€œå†…å¹•â€ eBPFæœ‰ä¸€ä¸ªéå¸¸ç®€å•çš„è™šæ‹Ÿæœºï¼Œå¯ä»¥æ‰§è¡Œå­—èŠ‚ç çš„å°ç‰‡æ®µå¹¶ç¼–è¾‘ä¸€äº›å†…å­˜ç¼“å†²åŒºã€‚  eBPFä¸­å­˜åœ¨ä¸€äº›é™åˆ¶ï¼Œå¯ä»¥ä¿æŠ¤å…¶å…å—æ¶æ„ä½¿ç”¨ï¼š <br><br><ul><li> ç¦æ­¢å¾ªç¯ï¼Œä»¥ä½¿ç¨‹åºå§‹ç»ˆåœ¨ç‰¹å®šæ—¶é—´ç»ˆæ­¢ã€‚ </li><li> å®ƒåªèƒ½é€šè¿‡å †æ ˆå’Œæš‚å­˜ç¼“å†²åŒºè®¿é—®å†…å­˜ï¼› </li><li> åªèƒ½è°ƒç”¨å…è®¸çš„å†…æ ¸å‡½æ•°ã€‚ </li></ul><br> å¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è°ƒè¯•å’Œè·Ÿè¸ª</a>ä»¥å„ç§æ–¹å¼å°†ç¨‹åºåŠ è½½åˆ°å†…æ ¸ä¸­ã€‚ åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼ŒeBPFå¯¹ä½¿ç”¨ç½‘ç»œå­ç³»ç»Ÿæ„Ÿå…´è¶£ã€‚ ä½¿ç”¨eBPFç¨‹åºæœ‰ä¸¤ç§æ–¹æ³•ï¼š <br><br><ul><li> é€šè¿‡XDPè¿æ¥åˆ°ç‰©ç†æˆ–è™šæ‹Ÿç½‘å¡çš„RXè·¯å¾„çš„èµ·ç‚¹ï¼› </li><li> é€šè¿‡<code>tc</code>è¿æ¥åˆ°è¾“å…¥æˆ–è¾“å‡ºä¸­çš„qdiscã€‚ </li></ul><br> è¦åˆ›å»ºç”¨äºè¿æ¥çš„eBPFç¨‹åºï¼Œåªéœ€ç¼–å†™Cä»£ç å¹¶å°†å…¶è½¬æ¢ä¸ºå­—èŠ‚ç å³å¯ã€‚ ä»¥ä¸‹æ˜¯ä½¿ç”¨XDPçš„ç®€å•ç¤ºä¾‹ï¼š <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">SEC</span></span>("<span class="hljs-selector-tag"><span class="hljs-selector-tag">prog</span></span>") <span class="hljs-selector-tag"><span class="hljs-selector-tag">int</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xdp_main</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">struct</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xdp_md</span></span> *<span class="hljs-selector-tag"><span class="hljs-selector-tag">ctx</span></span>) { void *data_end = (void *)(uintptr_t)ctx-&gt;data_end; void *data = (void *)(uintptr_t)ctx-&gt;data; struct ethhdr *eth = data; struct iphdr *iph = (struct iphdr *)(eth + 1); struct icmphdr *icmph = (struct icmphdr *)(iph + 1); <span class="hljs-comment"><span class="hljs-comment">/* sanity check needed by the eBPF verifier */</span></span> if (icmph + 1 &gt; data_end) return XDP_PASS; <span class="hljs-comment"><span class="hljs-comment">/* matched a pong packet */</span></span> if (eth-&gt;h_proto != ntohs(ETH_P_IP) || iph-&gt;protocol != IPPROTO_ICMP || icmph-&gt;type != ICMP_ECHOREPLY) return XDP_PASS; if (iph-&gt;ttl) { <span class="hljs-comment"><span class="hljs-comment">/* save the old TTL to recalculate the checksum */</span></span> uint16_t *ttlproto = (uint16_t *)&amp;iph-&gt;ttl; uint16_t old_ttlproto = *ttlproto; <span class="hljs-comment"><span class="hljs-comment">/* set the TTL to a pseudorandom number 1 &lt; x &lt; TTL */</span></span> iph-&gt;ttl = bpf_get_prandom_u32() % iph-&gt;ttl + 1; <span class="hljs-comment"><span class="hljs-comment">/* recalculate the checksum; otherwise, the IP stack will drop it */</span></span> csum_replace2(&amp;iph-&gt;check, old_ttlproto, *ttlproto); } <span class="hljs-selector-tag"><span class="hljs-selector-tag">return</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">XDP_PASS</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">char</span></span> _<span class="hljs-selector-tag"><span class="hljs-selector-tag">license</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SEC</span></span>("<span class="hljs-selector-tag"><span class="hljs-selector-tag">license</span></span>") = "<span class="hljs-selector-tag"><span class="hljs-selector-tag">GPL</span></span>";</code> </pre> <br> ä¸Šé¢çš„ä»£ç ç‰‡æ®µï¼Œå…¶ä¸­ä¸<code>include</code>è¡¨è¾¾å¼ï¼Œå¸®åŠ©ç¨‹åºå’Œå¯é€‰ä»£ç ï¼Œæ˜¯ä¸€ä¸ªXDPç¨‹åºï¼Œå¯ä»¥å°†æ¥æ”¶åˆ°çš„ICMPå›å£°å›å¤ï¼ˆå³pongï¼‰çš„TTLæ›´æ”¹ä¸ºéšæœºæ•°ã€‚ ä¸»è¦åŠŸèƒ½è·å¾—<code>xdp_md</code>ç»“æ„ï¼Œå…¶ä¸­åŒ…å«æŒ‡å‘åŒ…çš„å¼€å§‹å’Œç»“å°¾çš„ä¸¤ä¸ªæŒ‡é’ˆã€‚ <br><br> è¦å°†æˆ‘ä»¬çš„ä»£ç ç¼–è¯‘ä¸ºeBPFå­—èŠ‚ç ï¼Œéœ€è¦å…·æœ‰é€‚å½“æ”¯æŒçš„ç¼–è¯‘å™¨ã€‚  Clangæ”¯æŒå®ƒï¼Œå¹¶é€šè¿‡åœ¨ç¼–è¯‘æ—¶å°†bpfæŒ‡å®šä¸ºç›®æ ‡æ¥åˆ›å»ºeBPFå­—èŠ‚ç ï¼š <br><br><pre> <code class="bash hljs">$ clang -O2 -target bpf -c xdp_manglepong.c -o xdp_manglepong.o</code> </pre> <br> ä¸Šé¢çš„å‘½ä»¤åˆ›å»ºçš„æ–‡ä»¶ä¹ä¸€çœ‹ä¼¼ä¹æ˜¯ä¸€ä¸ªæ™®é€šçš„ç›®æ ‡æ–‡ä»¶ï¼Œä½†æ˜¯ä»”ç»†æ£€æŸ¥åå‘ç°ï¼ŒæŒ‡å®šçš„è®¡ç®—æœºç±»å‹æ˜¯Linux eBPFï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»Ÿçš„æœ¬æœºç±»å‹ï¼š <br><br><pre> <code class="bash hljs">$ readelf -h xdp_manglepong.o ELF Header: Magic: 7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 Class: ELF64 Data: 2<span class="hljs-string"><span class="hljs-string">'s complement, little endian Version: 1 (current) OS/ABI: UNIX - System V ABI Version: 0 Type: REL (Relocatable file) Machine: Linux BPF &lt;--- HERE [...]</span></span></code> </pre> <br> æ”¶åˆ°å¸¸è§„ç›®æ ‡æ–‡ä»¶çš„åŒ…è£…åï¼ŒeBPFç¨‹åºå³å¯ä¸‹è½½å¹¶é€šè¿‡XDPè¿æ¥åˆ°è®¾å¤‡ã€‚ å¯ä»¥ä½¿ç”¨<code>iproute2</code>åŒ…ä¸­çš„<code>ip</code>ä½¿ç”¨ä»¥ä¸‹è¯­æ³•æ¥å®Œæˆæ­¤æ“ä½œï¼š <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ip -force link set dev wlan0 xdp object xdp_manglepong.o verbose</span></span></code> </pre> <br> è¯¥å‘½ä»¤æŒ‡å®šç›®æ ‡wlan0æ¥å£ï¼Œå¹¶ä¸”ç”±äºä½¿ç”¨äº†-forceé€‰é¡¹ï¼Œè¯¥å‘½ä»¤å°†è¦†ç›–å·²ç»åŠ è½½çš„ä»»ä½•ç°æœ‰eBPFä»£ç ã€‚ åŠ è½½eBPFå­—èŠ‚ç åï¼Œç³»ç»Ÿçš„è¡Œä¸ºå¦‚ä¸‹ï¼š <br><br><pre> <code class="bash hljs">$ ping -c10 192.168.85.1 PING 192.168.85.1 (192.168.85.1) 56(84) bytes of data. 64 bytes from 192.168.85.1: icmp_seq=1 ttl=41 time=0.929 ms 64 bytes from 192.168.85.1: icmp_seq=2 ttl=7 time=0.954 ms 64 bytes from 192.168.85.1: icmp_seq=3 ttl=17 time=0.944 ms 64 bytes from 192.168.85.1: icmp_seq=4 ttl=64 time=0.948 ms 64 bytes from 192.168.85.1: icmp_seq=5 ttl=9 time=0.803 ms 64 bytes from 192.168.85.1: icmp_seq=6 ttl=22 time=0.780 ms 64 bytes from 192.168.85.1: icmp_seq=7 ttl=32 time=0.847 ms 64 bytes from 192.168.85.1: icmp_seq=8 ttl=50 time=0.750 ms 64 bytes from 192.168.85.1: icmp_seq=9 ttl=24 time=0.744 ms 64 bytes from 192.168.85.1: icmp_seq=10 ttl=42 time=0.791 ms --- 192.168.85.1 ping statistics --- 10 packets transmitted, 10 received, 0% packet loss, time 125ms rtt min/avg/max/mdev = 0.744/0.849/0.954/0.082 ms</code> </pre> <br> æ¯ä¸ªæ•°æ®åŒ…éƒ½ä¼šé€šè¿‡eBPFï¼Œè€ŒeBPFæœ€ç»ˆä¼šè¿›è¡Œä¸€äº›æ›´æ”¹å¹¶å†³å®šæ˜¯ä¸¢å¼ƒæ•°æ®åŒ…è¿˜æ˜¯è·³è¿‡æ•°æ®åŒ…ã€‚ <br><br>  <b>eBPFå¦‚ä½•æä¾›å¸®åŠ©</b> <br><br> å›åˆ°æœ€åˆçš„ç½‘ç»œé—®é¢˜ï¼Œæˆ‘ä»¬è®°å¾—æœ‰å¿…è¦æ ‡è®°å‡ ä¸ªTCPæ ‡å¿—ï¼Œæ¯ä¸ªè¿æ¥ä¸€ä¸ªï¼Œå¹¶ä¸”<code>iptables</code>å’Œ<code>tc</code>éƒ½ä¸èƒ½è¿™æ ·åšã€‚ ç¼–å†™æ­¤æ–¹æ¡ˆçš„ä»£ç ä¸€ç‚¹ä¹Ÿä¸éš¾ï¼šé…ç½®é€šè¿‡OVSæ¡¥è¿æ¥çš„ä¸¤ä¸ªè™šæ‹Ÿæœºï¼Œç„¶åå°†eBPFè¿æ¥åˆ°å…¶ä¸­ä¸€ä¸ªè™šæ‹ŸVMè®¾å¤‡ã€‚ <br><br> å¬èµ·æ¥è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯è¯·è®°ä½XDPä»…æ”¯æŒå¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…ï¼Œå¹¶ä¸”å°†eBPFè¿æ¥åˆ°æ¥æ”¶è™šæ‹Ÿæœºçš„<code>rx</code>è·¯å¾„ä¸ä¼šå¯¹äº¤æ¢æœºäº§ç”Ÿä»»ä½•å½±å“ã€‚ <br><br> è¦è§£å†³æ­¤é—®é¢˜ï¼Œå¿…é¡»ä½¿ç”¨<code>tc</code>åŠ è½½eBPFå¹¶å°†å…¶è¿æ¥åˆ°VMçš„è¾“å‡ºè·¯å¾„ï¼Œå› ä¸º<code>tc</code>å¯ä»¥åŠ è½½eBPFç¨‹åºå¹¶å°†å…¶è¿æ¥åˆ°qdiskã€‚ è¦æ ‡è®°ç¦»å¼€ä¸»æœºçš„æ•°æ®åŒ…ï¼Œå¿…é¡»å°†eBPFè¿æ¥åˆ°è¾“å‡ºqdiskã€‚ <br><br> åŠ è½½eBPFç¨‹åºæ—¶ï¼Œ <code>XDP</code>å’Œ<code>tc</code> APIä¹‹é—´å­˜åœ¨ä¸€äº›å·®å¼‚ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒèŠ‚åç§°ä¸åŒï¼Œä¸»å‡½æ•°è‡ªå˜é‡çš„ç»“æ„ç±»å‹ï¼Œè¿”å›å€¼ä¸åŒã€‚ ä½†è¿™ä¸æ˜¯é—®é¢˜ã€‚ ä»¥ä¸‹æ˜¯åŠ å…¥tcåŠ¨ä½œæ—¶æ ‡è®°TCPçš„ç¨‹åºç‰‡æ®µï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RATIO 10 SEC(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"action"</span></span></span><span class="hljs-meta">) int bpf_main(struct __sk_buff *skb) { void *data = (void *)(uintptr_t)skb-&gt;data; void *data_end = (void *)(uintptr_t)skb-&gt;data_end; struct ethhdr *eth = data; struct iphdr *iph = (struct iphdr *)(eth + 1); struct tcphdr *tcphdr = (struct tcphdr *)(iph + 1); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* sanity check needed by the eBPF verifier */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((void *)(tcphdr + 1) &gt; data_end) return TC_ACT_OK; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* skip non-TCP packets */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (eth-&gt;h_proto != __constant_htons(ETH_P_IP) || iph-&gt;protocol != IPPROTO_TCP) return TC_ACT_OK; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* incompatible flags, or PSH already set */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (tcphdr-&gt;syn || tcphdr-&gt;fin || tcphdr-&gt;rst || tcphdr-&gt;psh) return TC_ACT_OK; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (bpf_get_prandom_u32() % RATIO == 0) tcphdr-&gt;psh = 1; return TC_ACT_OK; } char _license[] SEC(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"license"</span></span></span><span class="hljs-meta">) = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"GPL"</span></span></span><span class="hljs-meta">;</span></span></code> </pre> <br> å¦‚ä¸ŠXDPç¤ºä¾‹æ‰€ç¤ºï¼Œä½¿ç”¨ä»¥ä¸‹ä»£ç å°†ä»£ç ç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼š <br><br><pre> <code class="bash hljs">clang -O2 -target bpf -c tcp_psh.c -o tcp_psh.o</code> </pre> <br> ä½†æ˜¯ä¸‹è½½æ˜¯ä¸åŒçš„ï¼š <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># tc qdisc add dev eth0 clsact # tc filter add dev eth0 egress matchall action bpf object-file tcp_psh.o</span></span></code> </pre> <br> ç°åœ¨ï¼ŒeBPFå·²åŠ è½½åˆ°æ­£ç¡®çš„ä½ç½®ï¼Œå¹¶ä¸”æ ‡è®°äº†ç¦»å¼€VMçš„æ•°æ®åŒ…ã€‚ æ£€æŸ¥ç¬¬äºŒä¸ªè™šæ‹Ÿæœºä¸­æ”¶åˆ°çš„æ•°æ®åŒ…åï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š <br><br><img src="https://habrastorage.org/webt/iz/kd/dq/izkddqprcvumlcgvdxvtzrecbmg.png"><br><br>  <code>tcpdump</code>ç¡®è®¤æ–°çš„eBPFä»£ç æ­£åœ¨è¿è¡Œï¼Œå¹¶ä¸”æ¯10ä¸ªTCPæ•°æ®åŒ…ä¸­å¤§çº¦æœ‰1ä¸ªè®¾ç½®äº†PSHæ ‡å¿—ã€‚ åªéœ€è¦20è¡ŒCä»£ç å³å¯é€‰æ‹©æ€§åœ°æ ‡è®°ç¦»å¼€è™šæ‹Ÿæœºçš„TCPæ•°æ®åŒ…ï¼Œé‡ç°â€œæˆ˜æ–—ä¸­â€å‘ç”Ÿçš„é”™è¯¯ï¼Œå¹¶ä¸”æ‰€æœ‰è¿™äº›éƒ½æ— éœ€é‡æ–°ç¼–è¯‘ç”šè‡³é‡æ–°å¯åŠ¨ï¼ è¿™å¤§å¤§ç®€åŒ–äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Open vSwitchä¿®å¤ç¨‹åº</a>çš„éªŒè¯ï¼Œè€Œå…¶ä»–å·¥å…·åˆ™æ— æ³•å®ç°ã€‚ <br><br>  <b>ç»“è®º</b> <br><br>  eBPFæ˜¯ä¸€é¡¹ç›¸å½“æ–°çš„æŠ€æœ¯ï¼Œç¤¾åŒºå¯¹æ­¤å®æ–½æœ‰æ˜ç¡®çš„çœ‹æ³•ã€‚ è¿˜å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒåŸºäºeBPFçš„é¡¹ç›®ï¼ˆä¾‹å¦‚<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">bpfilter</a> ï¼‰æ­£å˜å¾—è¶Šæ¥è¶Šæµè¡Œï¼Œç»“æœï¼Œè®¸å¤šè®¾å¤‡ä¾›åº”å•†å¼€å§‹ç›´æ¥åœ¨ç½‘å¡ä¸­å®ç°eBPFæ”¯æŒã€‚ <br><br>  eBPFä¸èƒ½è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œå› æ­¤è¯·å‹¿æ»¥ç”¨å®ƒï¼Œä½†å®ƒä»ç„¶æ˜¯ç”¨äºç½‘ç»œè°ƒè¯•çš„éå¸¸å¼ºå¤§çš„å·¥å…·ï¼Œå€¼å¾—å…³æ³¨ã€‚ æˆ‘ç›¸ä¿¡å®ƒå°†åœ¨ç½‘ç»œçš„æœªæ¥ä¸­å‘æŒ¥é‡è¦ä½œç”¨ã€‚ <br><br>  <b>ç»“æŸ</b> <br><br> æˆ‘ä»¬åœ¨è¿™é‡Œç­‰å¾…æ‚¨çš„è¯„è®ºï¼Œæˆ‘ä»¬è¿˜é‚€è¯·æ‚¨è®¿é—®æˆ‘ä»¬çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å…¬å¼€è¯¾ç¨‹</a> ï¼Œå¦‚æœæ‚¨ä¹Ÿå¯ä»¥æå‡ºé—®é¢˜ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN436528/">https://habr.com/ru/post/zh-CN436528/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN436514/index.html">é€šè¿‡PHPä¸ºInstagramåˆ›å»ºæ•…äº‹</a></li>
<li><a href="../zh-CN436518/index.html">HaikuÎ²1-ä½¿/ b / OSå†æ¬¡å‡ºè‰²</a></li>
<li><a href="../zh-CN436520/index.html">æ³„æ¼ä¸ªäººæ•°æ®æ—¶è¯·å‹¿ä½¿ç”¨åœ¨çº¿éªŒè¯æœåŠ¡</a></li>
<li><a href="../zh-CN436522/index.html">ä¸æŒ‡ç¤ºç›¸å</a></li>
<li><a href="../zh-CN436524/index.html">Unixç¼–ç¨‹ç»éªŒ*</a></li>
<li><a href="../zh-CN436530/index.html">Ctrl-Alt-Delï¼šå­¦ä¹ å–œçˆ±æ—§ç‰ˆä»£ç </a></li>
<li><a href="../zh-CN436536/index.html">å¦‚ä½•ç®€åŒ–äº‘åº”ç”¨ç¨‹åºçš„éƒ¨ç½²-å¼•å…¥äº†æ–°çš„å¼€æ”¾è§„èŒƒ</a></li>
<li><a href="../zh-CN436538/index.html">å®‰å…¨è­¦æŠ¥ç³»ç»Ÿçš„æ“ä½œå›°éš¾</a></li>
<li><a href="../zh-CN436542/index.html">ä¼é¹…ï¼Œè™šæ‹ŸåŒ–å’Œ230äº¿ç¾å…ƒï¼šäº‘æŠ€æœ¯å¦‚ä½•ä»¥åŠä¸ºä½•æ°¸è¿œæ”¹å˜ITä¸–ç•Œ</a></li>
<li><a href="../zh-CN436544/index.html">å¸‚åœºå°†å›ç­”ä¸€åˆ‡</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>