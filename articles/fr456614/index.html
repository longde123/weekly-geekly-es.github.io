<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôæ ü¶ë üëºüèº How A Plague Tale: Innocence Frame Renders ‚è∏Ô∏è üñêüèΩ ‚öíÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©face 
 Comme dans mes autres √©tudes, commen√ßons par l'introduction. Aujourd'hui, nous regardons le dernier jeu du d√©veloppeur fran√ßais Asobo Studio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>How A Plague Tale: Innocence Frame Renders</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/456614/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/qi/73/10/qi7310oonn7yulhrcsdmw_rzfsy.png"></div><br><h2>  Pr√©face </h2><br>  Comme dans mes autres √©tudes, commen√ßons par l'introduction.  Aujourd'hui, nous regardons le dernier jeu du d√©veloppeur fran√ßais Asobo Studio.  La premi√®re fois que j'ai vu une vid√©o de ce jeu l'ann√©e derni√®re, quand un coll√®gue a partag√© une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bande-annonce de gameplay de 16 minutes</a> avec moi.  La m√©canique du ¬´rat contre la lumi√®re¬ª a attir√© mon attention, mais je ne voulais pas vraiment jouer √† ce jeu.  Cependant, apr√®s sa sortie, beaucoup ont commenc√© √† dire qu'il semblait avoir √©t√© fait sur le moteur Unreal, mais ce n'est pas le cas.  J'√©tais curieux de voir comment fonctionne le rendu et √† quel point les d√©veloppeurs ont √©t√© inspir√©s par Unreal en g√©n√©ral.  J'√©tais √©galement int√©ress√© par le processus de rendu d'un troupeau de rats, car dans le jeu, il semblait tr√®s convaincant et, de plus, c'est l'un des √©l√©ments cl√©s du gameplay. <br><br>  Quand j'ai commenc√© √† essayer de capturer le jeu, j'ai pens√© que je devais abandonner, car rien ne fonctionnait.  Bien que le jeu utilise DX11, qui est maintenant pris en charge par presque tous les outils d'analyse, je n'ai pu faire fonctionner aucun d'entre eux.  Lorsque j'ai essay√© d'utiliser RenderDoc, le jeu s'est √©cras√© au d√©marrage, et la m√™me chose s'est produite avec PIX.  Je ne sais toujours pas pourquoi cela se produit, mais heureusement, j'ai pu effectuer plusieurs captures √† l'aide de NSight Graphics.  Comme d'habitude, j'ai √©lev√© tous les param√®tres au maximum et j'ai commenc√© √† chercher des trames adapt√©es √† l'analyse. <br><a name="habracut"></a><br><h2>  Rupture de trame </h2><br>  Apr√®s avoir fait quelques captures, j'ai d√©cid√© d'utiliser l'un des tout d√©but du jeu pour l'analyse d'images.  Il n'y a pas beaucoup de diff√©rence entre les poign√©es, et en plus, je peux √©viter les spoilers. <br><br>  Comme d'habitude, commen√ßons par la derni√®re image: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e30/9bc/013/e309bc01336450e755af378e9e07ebf9.png"></div><br>  La premi√®re chose que j'ai remarqu√©e √©tait un √©quilibre compl√®tement diff√©rent dans ce jeu d'√©v√©nements de rendu par rapport √† ce que j'ai vu dans d'autres jeux plus t√¥t.  Il existe de nombreux appels de tirage ici, ce qui est normal, mais √©tonnamment, seuls quelques-uns d'entre eux sont utilis√©s pour le post-traitement.  Dans d'autres jeux, apr√®s le rendu des couleurs pour obtenir le r√©sultat final, le cadre passe par de nombreuses autres √©tapes, mais dans A Plague Tale: Innocence la pile de post-traitement est tr√®s petite et optimis√©e pour seulement quelques √©v√©nements de rendu / informatique. <br><br>  Le jeu commence √† construire un cadre en rendant GBuffer avec six cibles de rendu.  Fait int√©ressant, toutes ces cibles de rendu ont un format entier non sign√© 32 bits (√† l'exception d'un) au lieu des couleurs RGBA8 ou d'autres formats sp√©cifiques √† ces donn√©es.  Cela a √©t√© difficile car j'ai d√ª d√©coder chaque canal manuellement en utilisant la fonction Custom Shader de NSight.  J'ai pass√© beaucoup de temps √† d√©terminer quelles valeurs sont encod√©es dans des cibles 32 bits, mais il est possible que j'ai rat√© quelque chose de toute fa√ßon. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/156/6ce/6fe/1566ce6fe3f539b267b0c3ddc777de78.png"></div><br>  <i>GBuffer 0</i> <br><br>  La premi√®re cible contient des valeurs d'ombrage en 24 bits et d'autres valeurs pour les cheveux en 8 bits. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1b5/0a7/205/1b50a72056766e9cadd8b6a040bb98cd.png"></div><br>  <i>GBuffer 1</i> <br><br>  La deuxi√®me cible ressemble √† une cible RGBA8 traditionnelle avec diff√©rentes valeurs de contr√¥le de mat√©riau dans chaque canal.  Pour autant que je sache, le canal rouge est m√©tallique (il n'est pas enti√®rement clair pourquoi certaines feuilles en sont marqu√©es), le canal vert ressemble √† une valeur de rugosit√© et le canal bleu est le masque du personnage principal.  Aucune des captures que j'ai faites n'utilisait le canal alpha. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2cf/a40/72a/2cfa4072a62ca02ef7de7f9e9b5ed259.png"></div><br>  <i>GBuffer 2</i> <br><br>  La troisi√®me cible ressemble √©galement √† RGBA8 avec alb√©do dans les canaux RVB, et le canal alpha dans chaque capture que j'ai faite √©tait compl√®tement blanc, donc je ne comprends pas tr√®s bien ce que ces donn√©es devraient faire. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5f7/c6d/9e2/5f7c6d9e2b37a7ff18ec87c8389ca0a7.png"></div><br>  <i>GBuffer3</i> <br><br>  La quatri√®me cible est curieuse car sur toutes mes captures elle est presque enti√®rement noire.  Les valeurs ressemblent √† un masque d'une partie de la v√©g√©tation et de tous les cheveux / fourrure.  Cela a peut-√™tre quelque chose √† voir avec la translucidit√©. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/18d/91f/69f/18d91f69f594f6898c21805c9cd9164a.png"></div><br>  <i>GBuffer 4</i> <br><br>  La cinqui√®me cible est probablement une sorte d'encodage normal, parce que je ne les ai vus nulle part ailleurs, et le shader semble √©chantillonner des cartes normales, puis sortir vers cette cible.  Dans cet esprit, je n'ai pas compris comment les visualiser correctement. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/09e/8d2/8da/09e8d28dae99dc5af634a67eaa8e2214.png"></div><br>  <i>Profondeur de GBuffer 5</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cd1/c4b/76c/cd1c4b76c92413c4d6848e2e5ecdcdc8.png"></div><br>  <i>Masque de GBuffer 5</i> <br><br>  Cette derni√®re cible est une exception car elle utilise un format √† virgule flottante 32 bits.  La raison en est qu'il contient la profondeur lin√©aire de l'image et que le bit de signe code un autre masque, masquant √† nouveau les cheveux et une partie de la v√©g√©tation. <br><br>  Une fois la cr√©ation de GBuffer termin√©e, la r√©solution de la carte de profondeur est r√©duite dans le shader de calcul, puis les cartes d'ombre (cartes d'ombre directionnelles en cascade du soleil et cartes de profondeur cubique des sources lumineuses ponctuelles) sont rendues. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/94d/bbb/2dd/94dbbb2dd8220f2494ef81785910ea39.png"></div><br>  <i>Rayons cr√©pusculaires</i> <br><br>  Apr√®s avoir termin√© les cartes d'ombre, vous pouvez calculer l'√©clairage, mais avant cela, les rayons divins sont rendus dans une cible distincte. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d58/f88/abf/d58f88abfc4aee82a95a9404ff5e4f09.png"></div><br>  <i>SSAO</i> <br><br>  Au stade du calcul de l'√©clairage, un shader de calcul est effectu√© pour calculer le SSAO. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c37/717/66d/c3771766d0785d131f15633eb2c52010.png"></div><br>  <i>G√©om√©trie opaque √©clair√©e</i> <br><br>  L'√©clairage est ajout√© √† partir de cartes cubiques et de sources lumineuses locales.  Toutes ces diff√©rentes sources de lumi√®re, combin√©es avec les cibles rendues ci-dessus, forment une image HDR illumin√©e en cons√©quence. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1ec/40b/716/1ec40b716cf2715f98d2c4f6a72bb83c.png"></div><br>  <i>√âl√©ments de rendu proactifs</i> <br><br>  Les √©l√©ments rendus en rendu proactif sont ajout√©s au-dessus de la g√©om√©trie opaque illumin√©e, mais ils ne sont pas particuli√®rement visibles dans cette sc√®ne. <br><br>  Apr√®s l'accumulation de toutes les couleurs, nous avons presque termin√©, il n'y a que quelques op√©rations de post-traitement et l'interface utilisateur. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cdd/73c/ddb/cdd73cddb19f72c7f9e228ee3b65ceef.png"></div><br>  La r√©solution des couleurs est r√©duite dans le nuanceur de calcul, puis augment√©e pour cr√©er un effet de floraison tr√®s beau et doux. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/98b/edb/ed2/98bedbed24528e052b396786b027369d.png"></div><br>  Apr√®s avoir compos√© tous les r√©sultats pr√©c√©dents, ajout√© la salet√© de la cam√©ra, l'√©talonnage des couleurs et enfin la correction d'image tonale, nous obtenons les couleurs de la sc√®ne.  La superposition de l'interface utilisateur nous donne une image depuis le d√©but de l'article. <br><br>  Il convient de mentionner quelques √©l√©ments int√©ressants sur le rendu: <br><br><ul><li>  L'instanciation (duplication de g√©om√©trie) n'est utilis√©e que pour les maillages individuels (il semble que ce soit uniquement pour la v√©g√©tation).  Tous les autres objets sont rendus dans des appels de dessin s√©par√©s. </li><li>  Il semble que les objets soient tri√©s approximativement d'avant en arri√®re, √† quelques exceptions pr√®s. </li><li>  Il semble que les d√©veloppeurs n'aient fait aucun effort pour regrouper les appels de tirage en termes de param√®tres mat√©riels. </li></ul><br><h2>  Les rats </h2><br>  Comme je l'ai dit au d√©but de l'article, l'une des raisons pour lesquelles j'ai voulu explorer ce jeu √©tait √† cause de la fa√ßon de rendre la meute de rats.  La d√©cision m'a d√©√ßu √† certains √©gards: il semble qu'elle ait √©t√© prise par la force brute.  Ici, j'utilise des captures d'√©cran d'une autre sc√®ne du jeu, mais j'esp√®re qu'il n'y a pas de spoilers. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/865/875/0c7/8658750c7c37151679f4ca5c12f196e8.png"></div><br>  Comme avec d'autres objets, les rats ne semblent pas avoir de duplication de g√©om√©trie, √† moins que nous n'atteignions la distance √† laquelle nous passons au dernier niveau de d√©tail du maillage (LOD).  Voyons comment cela fonctionne. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bf5/0bc/b33/bf50bcb334685d1b8e332ec5d386ecca.png"></div><br>  <i>LOD0</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fcf/f8e/9dd/fcff8e9dd94ec9a4537ea781991be2c2.png"></div><br>  <i>LOD1</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/35f/d4b/2f2/35fd4b2f2f4f1a29ea10502b002dc3ce.png"></div><br>  <i>LOD2</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d92/c13/e16/d92c13e16d465a0d900d8cd59d288578.png"></div><br>  <i>LOD3</i> <br><br>  Les rats ont 4 niveaux LOD.  Fait int√©ressant, au troisi√®me niveau, la queue est courb√©e vers le corps, contrairement √† la quatri√®me queue.  Cela signifie probablement que les animations ne sont actives que pour les deux premiers niveaux.  Malheureusement, NSight Graphics ne semble pas avoir suffisamment d'outils pour le tester. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f54/4d5/62f/f544d562f3b2434ffb6f47e665db27fc.png"></div><br>  <i>Pas de duplication (instanciation) de rats.</i> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/20c/89a/9c2/20c89a9c25d0c9039ee691b4e1f5500e.png"></div><br>  <i>Avec duplication.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zw/2f/t1/zw2ft16y68vu84ugwmiblagsfsa.gif"></div><br>  Dans la sc√®ne ci-dessus, le nombre de rats suivant a √©t√© rendu: <br><br><ul><li>  LOD0 - 200 </li><li>  LOD1 - 200 </li><li>  LOD2 - 1258 </li><li>  LOD3 - 3500 (avec duplication de la g√©om√©trie) </li></ul><br>  Cela nous fait comprendre qu'il existe une limite stricte sur le nombre de rats qui peuvent √™tre rendus sur les deux premiers LOD. <br><br>  Dans la capture que j'ai faite, je n'ai pas pu identifier de logique reliant les rats aux LOD individuels.  Parfois, les rats plus proches de la cam√©ra ne sont pas tr√®s d√©taill√©s, et parfois les rats √† peine visibles ont des d√©tails √©lev√©s. <br><br><h2>  En conclusion </h2><br>  Plague Tale: Innocence est tr√®s int√©ressant en termes de rendu.  Ses r√©sultats m'ont sans aucun doute impressionn√©, ils servent tr√®s bien le gameplay.  Comme avec tout moteur propri√©taire, ce serait formidable d'entendre une analyse plus d√©taill√©e de la bouche des d√©veloppeurs eux-m√™mes, surtout parce que je n'ai pas pu confirmer certaines de mes th√©ories.  J'esp√®re que mon article parviendra un jour √† quelqu'un d'Asobo Studio et qu'ils verront que les gens sont int√©ress√©s par cela. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr456614/">https://habr.com/ru/post/fr456614/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr456604/index.html">Comment nous avons automatis√© une grande boutique en ligne et commenc√© √† faire correspondre automatiquement les produits</a></li>
<li><a href="../fr456606/index.html">Nouvelles du monde d'OpenStreetMap n ¬∞ 464 (04/04/2019 - 06/10/2019)</a></li>
<li><a href="../fr456608/index.html">Southbridge √† Chelyabinsk et Bitrix √† Kubernetes</a></li>
<li><a href="../fr456610/index.html">N'appuyez pas et n'approuvez pas</a></li>
<li><a href="../fr456612/index.html">L'une des centaines de fa√ßons de publier plusieurs projets de production sur un seul serveur</a></li>
<li><a href="../fr456616/index.html">3 millions de roubles pour ceux qui savent coder</a></li>
<li><a href="../fr456618/index.html">Larabeer Moscou - 21 juin</a></li>
<li><a href="../fr456622/index.html">Comment cr√©er un OS certifi√© selon la protection de classe I</a></li>
<li><a href="../fr456624/index.html">Outils Python utiles</a></li>
<li><a href="../fr456630/index.html">Pr√©sentation d'Airflow pour g√©rer les Spark Jobs √† ivi: espoirs et b√©quilles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>