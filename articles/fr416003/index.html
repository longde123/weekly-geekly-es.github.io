<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∂üèª üë®üèø üë∑ Rendu de fichier HTML: un chapitre du livre ReactPHP for Beginners de Skyeng üë©‚Äçüëß‚Äçüëß üôâ üßôüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le d√©veloppeur du backend de l'application mobile Skyeng, Sergey Zhuk, continue d'√©crire de bons livres. Cette fois, il a publi√© un manuel en russe po...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rendu de fichier HTML: un chapitre du livre ReactPHP for Beginners de Skyeng</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/skyeng/blog/416003/"><p><img src="https://habrastorage.org/webt/6v/oi/xx/6voixx5vd9au0asabvgmnckfj90.png"></p><br><p>  Le d√©veloppeur du backend de l'application mobile Skyeng, Sergey Zhuk, continue d'√©crire de bons livres.  Cette fois, il a publi√© un manuel en russe pour un public ma√Ætrisant PHP.  J'ai demand√© √† Sergey de partager un chapitre utile et autosuffisant de son livre, et de donner aux lecteurs Habra un code de r√©duction.  Ci-dessous, les deux. </p><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Tout d'abord, disons ce que nous avons arr√™t√© dans les chapitres pr√©c√©dents.</b> <div class="spoiler_text"><p> Nous avons √©crit notre simple serveur HTTP en PHP.  Nous avons le fichier <code>index.php</code> principal - le script qui d√©marre le serveur.  Voici le code de plus haut niveau: nous cr√©ons une boucle d'√©v√©nements, configurons le comportement du serveur HTTP et d√©marrons la boucle: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">React</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Server</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Psr</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>\<span class="hljs-title"><span class="hljs-title">ServerRequestInterface</span></span>; $loop = React\EventLoop\Factory::create(); $router = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Router(); $router-&gt;load(<span class="hljs-string"><span class="hljs-string">'routes.php'</span></span>); $server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Server( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRequestInterface $request)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($router)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $router($request); } ); $socket = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> React\Socket\Server(<span class="hljs-number"><span class="hljs-number">8080</span></span>, $loop); $server-&gt;listen($socket); $loop-&gt;run();</code> </pre> <br><p>  Pour acheminer les demandes, le serveur utilise un routeur: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// src/Router.php use Psr\Http\Message\ServerRequestInterface; use React\Http\Response; class Router { private $routes = []; public function __invoke(ServerRequestInterface $request) { $path = $request-&gt;getUri()-&gt;getPath(); echo "Request for: $path\n"; $handler = $this-&gt;routes[$path] ?? $this-&gt;notFound($path); return $handler($request); } public function load($filename) { $routes = require $filename; foreach ($routes as $path =&gt; $handler) { $this-&gt;add($path, $handler); } } public function add($path, callable $handler) { $this-&gt;routes[$path] = $handler; } private function notFound($path) { return function () use ($path) { return new Response( 404, ['Content-Type' =&gt; 'text/html; charset=UTF-8'], "No request handler found for $path" ); }; } }</span></span></code> </pre> <br><p>  Les routes du fichier <code>routes.php</code> sont charg√©es dans le <code>routes.php</code> .  Maintenant, seuls deux itin√©raires ont √©t√© annonc√©s ici: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">React</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Response</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Psr</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>\<span class="hljs-title"><span class="hljs-title">ServerRequestInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'/'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRequestInterface $request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response( <span class="hljs-number"><span class="hljs-number">200</span></span>, [<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>], <span class="hljs-string"><span class="hljs-string">'Main page'</span></span> ); }, <span class="hljs-string"><span class="hljs-string">'/upload'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRequestInterface $request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response( <span class="hljs-number"><span class="hljs-number">200</span></span>, [<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>], <span class="hljs-string"><span class="hljs-string">'Upload page'</span></span> ); }, ];</code> </pre> <br><p>  Jusqu'√† pr√©sent, tout est simple, et notre application asynchrone tient dans plusieurs fichiers. </p></div></div><br><p>  Nous passons √† des choses plus ¬´utiles¬ª.  Les r√©ponses de quelques mots d'un texte simple que nous avons appris √† tirer dans les chapitres pr√©c√©dents ne semblent pas tr√®s attrayantes.  Nous devons renvoyer quelque chose de r√©el, comme une page HTML. </p><br><p>  Alors, o√π mettons-nous ce HTML?  Bien s√ªr, vous pouvez coder en dur le contenu de la page Web directement dans le fichier routes: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php return [ '/' =&gt; function (ServerRequestInterface $request) { $html = &lt;&lt;&lt;HTML &lt;!DOCTYPE html&gt; &lt;html lang=‚Äùen‚Äù&gt; &lt;head&gt; &lt;meta charset=‚ÄùUTF-8‚Äù&gt; &lt;title&gt;ReactPHP App&lt;/title&gt; &lt;/head&gt; &lt;body&gt; Hello, world &lt;/body&gt; &lt;/html&gt; HTML; return new Response( 200, ['Content-Type' =&gt; 'text/html'], $html ); }, '/upload' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/plain'], 'Upload page' ); }, ];</span></span></code> </pre> <br><p>  Mais ne fais pas √ßa!  Vous ne pouvez pas m√©langer la logique m√©tier (routage) avec la pr√©sentation (page HTML).  Pourquoi?  Imaginez que vous devez changer quelque chose dans le code HTML, par exemple, la couleur du bouton.  Et quel fichier devra √™tre chang√©?  Fichier avec routes <code>router.php</code> ?  √áa a l'air bizarre, non?  Modifiez le routage pour modifier la couleur du bouton ... </p><br><p>  Par cons√©quent, nous laisserons les routes seules et pour les pages HTML, nous cr√©erons un r√©pertoire s√©par√©.  √Ä la racine du projet, ajoutez un nouveau r√©pertoire appel√© pages.  Ensuite, √† l'int√©rieur, nous cr√©ons le fichier <code>index.html</code> .  Ce sera notre page principale.  Voici son contenu: </p><br><pre> <code class="php hljs">&lt;!DOCTYPE html&gt; &lt;html lang=<span class="hljs-string"><span class="hljs-string">"en"</span></span>&gt; &lt;head&gt; &lt;meta charset=<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>&gt; &lt;title&gt;ReactPHP App&lt;/title&gt; &lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"</span></span> &gt; &lt;/head&gt; &lt;body&gt; &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">container</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">action</span></span></span><span class="hljs-class">="/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">upload</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">POST</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">justify</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">content</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">center</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">group</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">label</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">"&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Text</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">label</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textarea</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">control</span></span></span><span class="hljs-class">"&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">button</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">submit</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">primary</span></span></span><span class="hljs-class">"&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Submit</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">button</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">html</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre> <br><p>  La page est assez simple, elle ne contient qu'un seul √©l√©ment - le formulaire.  Le formulaire √† l'int√©rieur a une zone de texte et un bouton pour soumettre.  J'ai √©galement ajout√© des styles Bootstrap pour rendre notre page plus belle. </p><br><h4 id="chtenie-faylov-kak-ne-nado-delat">  Lecture de fichiers.  Comment NE PAS faire </h4><br><p>  L'approche la plus simple consiste √† lire le contenu du fichier √† l'int√©rieur du gestionnaire de demande et √† renvoyer ce contenu en tant que corps de r√©ponse.  Quelque chose comme √ßa: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php return [ '/' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/html'], file_get_contents('pages/index.html') ); }, // ... ];</span></span></code> </pre> <br><p>  Et en passant, cela fonctionnera.  Vous pouvez l'essayer vous-m√™me: red√©marrez le serveur et rechargez la page <code>http://127.0.0.1:8080/</code> dans votre navigateur. </p><br><p><img src="https://habrastorage.org/webt/zq/dc/91/zqdc91cvy7a971jkniyw8hpxgzi.png"></p><br><p>  Alors qu'est-ce qui ne va pas ici?  Et pourquoi ne pas faire √ßa?  En bref, car il y aura des probl√®mes si le syst√®me de fichiers commence √† ralentir. </p><br><h4 id="blokiruyuschie-i-neblokiruyuschie-vyzovy">  Appels bloquants et non bloquants </h4><br><p>  Permettez-moi de vous montrer ce que j'entends par ¬´bloquer¬ª les appels et ce qui peut se produire lorsque l'un des gestionnaires de demandes contient du code de blocage.  Avant de renvoyer l'objet de r√©ponse, ajoutez un appel √† la fonction <code>sleep()</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php return [ '/' =&gt; function (ServerRequestInterface $request) { sleep(10); return new Response( 200, ['Content-Type' =&gt; 'text/html'], file_get_contents('pages/index.html') ); }, '/upload' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/plain'], 'Upload page' ); }, ];</span></span></code> </pre> <br><p>  Cela fera geler le gestionnaire de requ√™tes pendant 10 secondes avant de pouvoir renvoyer une r√©ponse avec le contenu de la page HTML.  Veuillez noter que nous n'avons pas touch√© le gestionnaire pour l'adresse <code>/upload</code> .  En appelant la fonction <code>sleep(10)</code> , j'√©mule l'ex√©cution d'une sorte d'op√©ration de blocage. </p><br><p>  Alors qu'avons-nous?  Lorsque le navigateur demande la page <code>/</code> , le gestionnaire attend 10 secondes, puis renvoie la page HTML.  Lorsque nous ouvrons l'adresse <code>/upload</code> , son gestionnaire doit imm√©diatement renvoyer une r√©ponse avec la cha√Æne 'Upload page'. </p><br><p>  Voyons maintenant ce qui se passe dans la r√©alit√©.  Comme toujours, nous red√©marrons le serveur.  Maintenant, veuillez ouvrir une autre fen√™tre dans votre navigateur.  Dans la barre d'adresse, entrez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://127.0.0.1:8080/upload</a> , mais n'ouvrez pas cette page imm√©diatement.  Laissez cette adresse dans la barre d'adresse pour l'instant.  Ensuite, allez dans la premi√®re fen√™tre du navigateur et ouvrez la page <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://127.0.0.1:8080/</a> .  Pendant le chargement de cette page (rappelez-vous que cela prendra 10 secondes), acc√©dez rapidement √† la deuxi√®me fen√™tre et appuyez sur ¬´Entr√©e¬ª pour charger l'adresse qui a √©t√© laiss√©e dans la barre d'adresse ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://127.0.0.1:8080/upload</a> ) . </p><br><p>  Qu'avons-nous obtenu?  Oui, l'adresse /, comme pr√©vu, prend 10 secondes √† charger.  Mais, √©tonnamment, la deuxi√®me page a pris le m√™me temps √† charger, bien que nous n'y ayons ajout√© aucun appel <code>sleep()</code> .  Une id√©e de pourquoi c'est arriv√©? </p><br><p>  ReactPHP s'ex√©cute dans un seul thread.  Il peut sembler que dans une application asynchrone, les t√¢ches soient ex√©cut√©es en parall√®le, mais en r√©alit√© ce n'est pas le cas.  L'illusion du parall√©lisme est cr√©√©e par un cycle d'√©v√©nements qui bascule constamment entre diverses t√¢ches et les ex√©cute.  Mais √† un certain moment, une seule t√¢che est toujours effectu√©e.  Cela signifie que si l'une de ces t√¢ches prend trop de temps, elle bloquera la boucle d'√©v√©nements, qui ne pourra pas enregistrer de nouveaux √©v√©nements et appeler des gestionnaires pour eux.  Et cela conduit finalement au ¬´gel¬ª de l'ensemble de l'application, elle perdra tout simplement l'asynchronie. </p><br><p>  OK, mais qu'est-ce que cela a √† voir avec l'appel de <code>file_get_contents('pages/index.h')</code> ?  Le probl√®me ici est que nous acc√©dons directement au syst√®me de fichiers.  Par rapport √† d'autres op√©rations, telles que l'utilisation de la m√©moire ou de l'informatique, l'utilisation du syst√®me de fichiers peut √™tre extr√™mement lente.  Par exemple, si le fichier s'av√®re trop volumineux ou si le disque lui-m√™me est lent, la lecture du fichier peut prendre un certain temps et, par cons√©quent, bloquer la boucle d'√©v√©nements. </p><br><p>  Dans le mod√®le synchrone standard, la demande-r√©ponse n'est pas un probl√®me.  Si le client a demand√© un fichier trop lourd, il attendra que ce fichier soit t√©l√©charg√©.  Une telle demande lourde n'affecte pas les autres clients.  Mais dans notre cas, nous avons affaire √† un mod√®le orient√© √©v√©nement asynchrone.  Nous avons lanc√© un serveur HTTP qui doit constamment traiter les demandes entrantes.  Si une demande prend trop de temps, cela affectera tous les autres clients du serveur. </p><br><p>  En r√®gle g√©n√©rale, n'oubliez pas: </p><br><ul><li>  Vous ne pouvez jamais bloquer une boucle d'√©v√©nements. </li></ul><br><p>  Alors, comment lisons-nous le fichier de mani√®re asynchrone?  Et nous arrivons ici √† la deuxi√®me r√®gle: </p><br><ul><li>  Lorsqu'une op√©ration de blocage ne peut √™tre √©vit√©e, elle doit √™tre bifurqu√©e dans le processus enfant et continuer l'ex√©cution asynchrone dans le thread principal. </li></ul><br><p>  Donc, apr√®s avoir appris comment ne pas le faire, discutons de la bonne solution non bloquante. </p><br><h4 id="docherniy-process">  Processus enfant </h4><br><p>  Toutes les communications avec le syst√®me de fichiers dans une application asynchrone doivent √™tre effectu√©es dans des processus enfants.  Pour g√©rer les processus enfants dans une application ReactPHP, nous devons installer un autre composant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Processus enfant¬ª</a> .  Ce composant vous permet d'acc√©der aux fonctions du syst√®me d'exploitation pour ex√©cuter n'importe quelle commande syst√®me √† l'int√©rieur du processus enfant.  Pour installer ce composant, ouvrez un terminal √† la racine du projet et ex√©cutez la commande suivante: </p><br><p> <code>composer require react/child-process</code> </p> <br><h4 id="sovmestimost-s-windows">  <em>Compatibilit√© Windows</em> </h4><br><p>  <em>Dans le syst√®me d'exploitation Windows, les threads STDIN, STDOUT et STDERR se bloquent, ce qui signifie que le composant Processus enfant ne pourra pas fonctionner correctement.</em>  <em>Par cons√©quent, ce composant est principalement con√ßu pour fonctionner uniquement sur les syst√®mes nix.</em>  <em>Si vous essayez de cr√©er un objet de la classe Process sur un syst√®me Windows, une exception sera lev√©e.</em>  <em>Mais le composant peut fonctionner sous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Windows Subsystem for Linux (WSL)</a> .</em>  <em>Si vous avez l'intention d'utiliser ce composant sous Windows, vous devrez installer WSL.</em> </p><br><p>  Nous pouvons maintenant ex√©cuter n'importe quelle commande shell √† l'int√©rieur du processus enfant.  Ouvrez le fichier <code>routes.php</code> , puis changeons le gestionnaire pour <code>/</code> route.  Cr√©ez un objet de la classe <code>React\ChildProcess\Process</code> et en tant que commande, passez-lui <code>ls</code> pour obtenir le contenu du r√©pertoire courant: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php use Psr\Http\Message\ServerRequestInterface; use React\ChildProcess\Process; use React\Http\Response; return [ '/' =&gt; function (ServerRequestInterface $request) { $childProcess = new Process('ls'); return new Response( 200, ['Content-Type' =&gt; 'text/html'], file_get_contents('pages/index.html') ); }, // ... ];</span></span></code> </pre> <br><p>  Ensuite, nous devons d√©marrer le processus en appelant la m√©thode <code>start()</code> .  Le hic est que la m√©thode <code>start()</code> besoin d'un objet de boucle d'√©v√©nement.  Mais dans le fichier <code>routes.php</code> , nous n'avons pas cet objet.  Comment passer la boucle d'√©v√©nements de <code>index.php</code> aux routes directement au gestionnaire de requ√™tes?  La solution √† ce probl√®me est ¬´l'injection de d√©pendance¬ª. </p><br><h4 id="inekciya-zavisimostey">  Injection de d√©pendance </h4><br><p>  Ainsi, l'un de nos itin√©raires a besoin d'une boucle d'√©v√©nements pour fonctionner.  Dans notre application, un seul composant conna√Æt l'existence des routes - la classe <code>Router</code> .  Il s'av√®re qu'il est de sa responsabilit√© de fournir une boucle d'√©v√©nement pour les itin√©raires.  En d'autres termes, le routeur a besoin d'une boucle d'√©v√©nements, ou cela d√©pend de la boucle d'√©v√©nements.  Comment exprimer explicitement cette d√©pendance dans le code?  Comment rendre impossible de cr√©er m√™me un routeur sans lui passer une boucle d'√©v√©nement?  Bien s√ªr, via le constructeur de la classe <code>Router</code> .  Ouvrez <code>Router.php</code> et ajoutez le constructeur √† la classe <code>Router</code> : </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Psr</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>\<span class="hljs-title"><span class="hljs-title">ServerRequestInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">React</span></span>\<span class="hljs-title"><span class="hljs-title">EventLoop</span></span>\<span class="hljs-title"><span class="hljs-title">LoopInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">React</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Response</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Router</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $routes = []; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> LoopInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $loop; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LoopInterface $loop)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;loop = $loop; } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  √Ä l'int√©rieur du constructeur, enregistrez la boucle d'√©v√©nements pass√©e dans la propri√©t√© priv√©e <code>$loop</code> .  Il s'agit d'une injection de d√©pendance lorsque nous fournissons √† la classe les objets dont elle a besoin pour travailler √† l'ext√©rieur. </p><br><p>  Maintenant que nous avons ce nouveau constructeur, nous devons mettre √† jour la cr√©ation du routeur.  Ouvrez le fichier <code>index.php</code> et corrigez la ligne o√π nous cr√©ons l'objet de la classe <code>Router</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// index.php $loop = React\EventLoop\Factory::create(); $router = new Router($loop); $router-&gt;load('routes.php');</span></span></code> </pre> <br><p>  C'est fait.  Revenez √† <code>routes.php</code> .  Comme vous l'avez probablement d√©j√† devin√©, ici nous pouvons utiliser la m√™me id√©e avec l' <strong>injection de d√©pendances</strong> et ajouter une boucle d'√©v√©nement comme deuxi√®me param√®tre √† nos gestionnaires de requ√™tes.  Modifiez le premier rappel et ajoutez le deuxi√®me argument: un objet qui impl√©mente <code>LoopInterface</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php use Psr\Http\Message\ServerRequestInterface; use React\EventLoop\LoopInterface; use React\ChildProcess\Process; use React\Http\Response; return [ '/' =&gt; function (ServerRequestInterface $request, LoopInterface $loop) { $childProcess = new Process('ls'); $childProcess-&gt;start($loop); return new Response( 200, ['Content-Type' =&gt; 'text/html'], file_get_contents('pages/index.html') ); }, '/upload' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/plain'], 'Upload page' ); }, ];</span></span></code> </pre> <br><p>  Ensuite, nous devons passer la boucle d'√©v√©nements √† la m√©thode <code>start()</code> du processus enfant.  Et o√π le gestionnaire obtient-il la boucle d'√©v√©nements?  Et il est d√©j√† stock√© √† l'int√©rieur du routeur dans la propri√©t√© priv√©e <code>$loop</code> .  Nous avons juste besoin de le passer lorsque le gestionnaire est appel√©. </p><br><p>  <code>__invoke()</code> la classe <code>Router</code> et <code>__invoke()</code> jour la m√©thode <code>__invoke()</code> , en ajoutant le deuxi√®me argument √† l'appel du gestionnaire de requ√™tes: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRequestInterface $request)</span></span></span><span class="hljs-function"> </span></span>{ $path = $request-&gt;getUri()-&gt;getPath(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Request for: $path\n"</span></span>; $handler = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;routes[$path] ?? <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;notFound($path); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $handler($request, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;loop); }</code> </pre> <br><p>  C'est tout!  C'est probablement une <strong>injection de d√©pendance</strong> suffisante.  Un assez grand voyage du cycle des √©v√©nements s'est produit, non?  Du fichier <code>index.php</code> √† la classe <code>Router</code> , puis de la classe <code>Router</code> au fichier <code>routes.php</code> √† l'int√©rieur des rappels. </p><br><p>  Donc, pour confirmer que le processus enfant fera sa magie non bloquante, rempla√ßons la <code>ls</code> simple par le <code>ping 8.8.8.8</code> plus lourd <code>ping 8.8.8.8</code> .  Red√©marrez le serveur et essayez √† nouveau d'ouvrir deux pages dans deux fen√™tres diff√©rentes.  D'abord, <code>http://127.0.0.1:8080/</code> , puis <code>/upload</code> .  Les deux pages s'ouvrent rapidement, sans d√©lai, bien que la commande <code>ping</code> soit ex√©cut√©e dans le premier gestionnaire en arri√®re-plan.  En passant, cela signifie que nous pouvons d√©bourser toute op√©ration co√ªteuse (par exemple, le traitement de gros fichiers), sans bloquer l'application principale. </p><br><h4 id="svyazyvaem-docherniy-process-i-otvet-s-pomoschyu-potokov">  Lier le processus enfant et la r√©ponse √† l'aide de threads </h4><br><p>  Revenons √† notre application.  Nous avons donc cr√©√© un processus enfant, l'avons d√©marr√©, mais notre navigateur n'affiche en aucune fa√ßon les r√©sultats d'une op√©ration bifurqu√©e.  Corrigeons-le. </p><br><p>  Comment pouvons-nous communiquer avec le processus enfant?  Dans notre cas, nous avons une <code>ls</code> cours d'ex√©cution qui affiche le contenu du r√©pertoire courant.  Comment pouvons-nous obtenir cette conclusion, puis l'envoyer au corps de la r√©ponse?  La r√©ponse courte est: les fils. </p><br><p>  Parlons un peu des processus.  Toute commande shell que vous ex√©cutez poss√®de trois flux de donn√©es: STDIN, STDOUT et STDERR.  Diffusez vers la sortie et l'entr√©e standard, plus le flux pour les erreurs.  Par exemple, lorsque nous ex√©cutons la <code>ls</code> , le r√©sultat de cette commande est envoy√© directement √† STDOUT (sur l'√©cran du terminal).  Donc, si nous devons obtenir la sortie d'un processus, l'acc√®s au flux de sortie est requis.  Et c'est aussi simple que √ßa.  Lors de la cr√©ation de l'objet de r√©ponse, remplacez l'appel <code>file_get_contents()</code> par <code>$childProcess-&gt;stdout</code> : </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response( <span class="hljs-number"><span class="hljs-number">200</span></span>, [<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>], $childProcess-&gt;stdout );</code> </pre> <br><p>  Tous les processus enfants ont trois propri√©t√©s li√©es aux flux <code>stdio</code> : <code>stdout</code> , <code>stdin</code> et <code>stderr</code> .  Dans notre cas, nous voulons afficher la sortie du processus sur une page Web.  Au lieu d'une cha√Æne dans le constructeur de la classe <code>Response</code> , nous passons un flux comme troisi√®me argument.  La classe <code>Response</code> est suffisamment intelligente pour se rendre compte qu'elle a re√ßu le flux et le traiter en cons√©quence. </p><br><p>  Donc, comme d'habitude, nous red√©marrons le serveur et voyons ce que nous avons fait.  Ouvrons la page <code>http://127.0.0.1:8080/</code> dans le navigateur: vous devriez voir une liste des fichiers du dossier racine du projet. </p><br><p><img src="https://habrastorage.org/webt/mm/ui/za/mmuizadmcw-fzg1cekm0d1jpz3e.png"></p><br><p>  La derni√®re √©tape consiste √† remplacer la <code>ls</code> par quelque chose de plus utile.  Nous avons commenc√© ce chapitre en rendant le fichier <code>pages/index.html</code> √† l'aide de la fonction <code>file_get_contents()</code> .  Maintenant, nous pouvons lire ce fichier de mani√®re absolument asynchrone, sans craindre qu'il bloque notre application.  Remplacez la <code>ls</code> par <code>cat pages/index.html</code> . </p><br><p>  Si vous n'√™tes pas familier avec la <code>cat</code> , elle est utilis√©e pour concat√©ner et sortir des fichiers.  Le plus souvent, cette commande est utilis√©e pour lire un fichier et afficher son contenu sur la sortie standard.  La commande <code>cat pages/index.html</code> lit le fichier <code>cat pages/index.html</code> et imprime son contenu dans STDOUT.  Et nous envoyons d√©j√† <code>stdout</code> comme organe de r√©ponse.  Voici la version finale du fichier <code>routes.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php use Psr\Http\Message\ServerRequestInterface; use React\EventLoop\LoopInterface; use React\ChildProcess\Process; use React\Http\Response; return [ '/' =&gt; function (ServerRequestInterface $request, LoopInterface $loop) { $childProcess = new Process('cat pages/index.html'); $childProcess-&gt;start($loop); return new Response( 200, ['Content-Type' =&gt; 'text/html'], $childProcess-&gt;stdout ); }, '/upload' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/plain'], 'Upload page' ); }, ];</span></span></code> </pre> <br><p>  Par cons√©quent, tout ce code n'√©tait n√©cessaire que pour remplacer un appel √† la fonction <code>file_get_contents()</code> .  Injection de d√©pendances, passage d'un objet de boucle d'√©v√©nements, ajout de processus enfants et utilisation de threads.  Tout cela est juste pour remplacer un appel de fonction.  Cela en valait-il la peine?  R√©ponse: oui, √ßa valait le coup.  Lorsque quelque chose peut bloquer la boucle d'√©v√©nements et que le syst√®me de fichiers peut certainement, assurez-vous qu'il finira par se bloquer, et au moment le plus inopportun. </p><br><p>  La cr√©ation d'un processus enfant √† chaque fois que nous devons acc√©der au syst√®me de fichiers peut sembler une surcharge suppl√©mentaire qui affectera la vitesse et les performances de notre application.  Malheureusement, en PHP, il n'y a pas d'autre moyen de travailler de mani√®re asynchrone avec le syst√®me de fichiers.  Toutes les biblioth√®ques PHP asynchrones utilisent des processus enfants (ou des extensions qui les font abstraction). </p><br><p>  Les lecteurs Habra peuvent acheter l'int√©gralit√© du livre √† prix r√©duit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur ce lien</a> . </p><br><p>  Et nous vous rappelons que nous sommes toujours √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">recherche de d√©veloppeurs sympas</a> !  Venez, nous nous amusons! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr416003/">https://habr.com/ru/post/fr416003/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr415993/index.html">Remot, farine impitoyable</a></li>
<li><a href="../fr415995/index.html">D√©veloppement de CROC de l'int√©rieur: personnes, canards et beaucoup de travail</a></li>
<li><a href="../fr415997/index.html">Logiciel d'apprentissage automatique Python</a></li>
<li><a href="../fr415999/index.html">Qu'est-ce que la bourse Apple et pourquoi est-ce plus qu'un simple ticket WWDC</a></li>
<li><a href="../fr416001/index.html">Messages d'un site en VK - simple et efficace - PHP + CUrl</a></li>
<li><a href="../fr416005/index.html">16 React Tools pour les d√©veloppeurs d'interfaces</a></li>
<li><a href="../fr416007/index.html">√Ä peu pr√®s compliqu√©. Le d√©but de la cr√©ation d'une "maison intelligente" sans fil. Bas√© sur la technologie Linux, les logiciels Z-Wave et MajorDoMo</a></li>
<li><a href="../fr416009/index.html">Essayez les excr√©ments de lapin, c'est vigoureux, √ßa va attraper - extraits en pharmacologie</a></li>
<li><a href="../fr416011/index.html">Mod√®le BIF: code frontal propre et travail pratique avec les donn√©es du serveur</a></li>
<li><a href="../fr416013/index.html">Comment commencer √† investir et √©conomiser de l'argent: les experts de Dow Jones ont nomm√© les cinq principales erreurs des traders d√©butants</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>