<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ù ü§úüèº üïü Auslaufschutzsystem f√ºr eine Waschmaschine üåé ‚õπüèΩ ü§§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Einleitung 
 Ich denke, jedes Haus hat eine Waschmaschine. Normalerweise wird es √ºber einen flexiblen Schlauch an die Wasserversorgung angeschlossen. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Auslaufschutzsystem f√ºr eine Waschmaschine</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472296/"><img src="https://habrastorage.org/webt/7q/2r/xp/7q2rxpr6f9jntwgc-3ai-qwqglo.jpeg"><br><br><h2>  Einleitung </h2><br>  Ich denke, jedes Haus hat eine Waschmaschine.  Normalerweise wird es √ºber einen flexiblen Schlauch an die Wasserversorgung angeschlossen.  Mit einem Schlauch kann jedoch ein gro√ües √Ñrgernis auftreten: Manchmal platzen sie, was zu einer √úberschwemmung sowohl in Ihrer Wohnung als auch in Ihren Nachbarn f√ºhrt.  Daher sind Waschmaschinen √ºber einen speziellen Wasserhahn an die Wasserversorgung angeschlossen, der vor dem Waschen ge√∂ffnet und danach geschlossen werden muss.  Ich wei√ü nichts √ºber dich, aber ich habe diesen Kran an einem √§u√üerst ung√ºnstigen Ort.  Ja, und ich beginne lieber mit dem Waschen, bevor ich zur Arbeit gehe, damit der Schlauch den gr√∂√üten Teil des Tages unter Druck steht und zu einem Zeitpunkt platzen kann, an dem ich nicht zu Hause bin.  Es w√§re toll, wenn sich der Kran zum richtigen Zeitpunkt √∂ffnet und schlie√üt! <br><br>  Die Idee schien mir durchaus f√§hig und ich entschied mich, sie umzusetzen: auf Mikrocontrollern und mit einem motorisierten Ventil. <br><a name="habracut"></a><br>  Zun√§chst formulierte ich die Anforderungen f√ºr das entwickelte System: <br><br><ul><li>  √úberwachung des Waschmaschinenzustands: Wasser zu Beginn des Waschvorgangs √∂ffnen und am Ende schlie√üen; </li><li>  die F√§higkeit, das Ventil manuell zu steuern; </li><li>  Batteriebetrieb und Schlie√üen des Ventils bei Batterieentladung; </li><li>  Vorhandensein eines Leckagesensors: Schlie√üen Sie das Ventil, falls eine Leckage festgestellt wird. </li></ul><br>  Dann fand er heraus, aus welchen Teilen es bestehen wird: einem in der Waschmaschine installierten Monitor und einer Steuerung, die Signale vom Monitor empf√§ngt und ein motorisiertes Ventil steuert.  Die Kommunikation zwischen dem Monitor und der Steuerung erfolgt √ºber einen Einwegfunkkanal. <br><br>  Es scheint, dass dies f√ºr die technische Aufgabe ausreicht.  Fangen wir an! <br><br><h2>  MCU-Auswahl </h2><br>  Da das gesamte System aus zwei Ger√§ten besteht, sollten zwei Mikrocontroller vorhanden sein.  Ich kratzte durch die Eingeweide und fand zwei Atmega8: einen im DIP-Paket und einen im TQFP.  Der in DIP - ging zum Monitor und TQFP - zum Controller.  Sp√§ter stellte sich heraus, dass die √ºberwachsene Controller-Firmware nicht mehr in 8 KB Atmega8 passt, sodass ich auf Atmega328 aktualisieren musste - ein komplettes Analogon, aber jetzt gibt es viermal mehr Speicher f√ºr das Programm. <br>  Eines meiner Motive f√ºr solche Projekte ist √ºbrigens die Entsorgung von elektronischem M√ºll, den ich √ºber viele Jahre angesammelt habe.  Zwar wird der Papierkorb am Ende des Projekts nicht kleiner.  Es wird noch gr√∂√üer! <br><br><h2>  Teil Eins  √úberwachen </h2><br><h3>  Interaktion mit einer Waschmaschine </h3><br>  Das erste Problem: Wie kann man feststellen, was die Waschmaschine jetzt tut?  Zu Beginn des Projekts erschien mir dieser Teil der Aufgabe sehr einfach.  Alles, was getan werden musste, war, die Momente des Beginns und des Endes des Waschens zu bestimmen.  Auf der Vorderseite der Maschine befindet sich eine LED, die aufleuchtet und bei Bedarf erlischt.  Ich hatte erwartet, einen GPIO mit dem Fu√ü des Mikrocontrollers anzul√∂ten, also habe ich f√ºr die Dauer des Debuggens einfach die erforderlichen Ereignisse auf dem Monitor mit der Taste emuliert.  Ich dr√ºckte den Knopf - die LED leuchtete auf, das Waschen begann.  Lass los - das Gegenteil ist der Fall.  Nach dem Parsen der Waschmaschine stellte sich jedoch heraus, dass diese LED Teil der dynamischen Anzeige ist, und leider ist es nicht so einfach festzustellen, ob sie ein- oder ausgeschaltet ist. <br><br>  Als ich das Bedienfeld in meine H√§nde drehte (ein paar Tage), stellte ich fest, dass es auf einem PIC-Controller implementiert war.  Dar√ºber hinaus ist es mit Beinen verbunden, die auf die Hardware I2C reagieren.  Ja, dachte ich, Sie k√∂nnen den I2C-Bus schn√ºffeln und so bestimmen, was Sie jetzt mit der Waschmaschine machen sollen.  Ich habe den I2C-Sniffer-Code f√ºr Atmega im Internet gefunden.  Nat√ºrlich musste ich etwas spielen. <br><br>  Ehrlich gesagt: Ich konnte das Protokoll nicht vollst√§ndig erkennen (und ich habe es nicht zu oft ausprobiert), aber es stellte sich heraus, dass die Muster f√ºr den Beginn und das Ende des Waschens (sowie das Ein- und Ausschalten) ziemlich genau bestimmt wurden.  Ich habe ungef√§hr eine Woche gebraucht. <br><br>  Modell: <b>Candy GC4 1072 D.</b>  Der Computer sendet regelm√§√üig eine Reihe von F√ºnf-Byte-Sequenzen an die Anzeigeeinheit.  Die ersten vier Sequenzen haben das folgende Format: <br><br> <code>12 A7 00 ‚Äì NN ‚Äì X0 X1 X2 X3 X4 X5 X6 X7 ‚Äì CS</code> <br>  Dabei gilt: 12 A7 00 - Header, NN - Sequenznummer, X [0..7] - 8 Datenbytes, CS - Pr√ºfsumme.  Die f√ºnfte Sequenz ist ein M√ºll variabler Gr√∂√üe, dessen Essenz f√ºr mich ein R√§tsel geblieben ist. <br><br>  Ich habe folgende Muster gel√∂st: <br><br>  <b>Einschalten</b> <br><br> <code>12 A7 00 ‚Äì 01 ‚Äì X0 X1 X2 X3 X4 X5 X6 X7 ‚Äì CS <br> 12 A7 00 ‚Äì 02 ‚Äì X0 X1 X2 X3 X4 X5 X6 X7 ‚Äì CS</code> <br>  wobei X [0..7] mindestens eins ungleich 0 ist <br><br>  <b>STARTEN</b> <br><br> <code>12 A7 00 ‚Äì 03 ‚Äì X0 X1 X2 X3 01 01 01 01 ‚Äì CS</code> <br>  wobei X [0..3] eine beliebige Zahl ist <br><br>  <b>STOP</b> <br><br> <code>12 A7 00 ‚Äì 03 ‚Äì X0 X1 X2 X3 00 00 00 00 ‚Äì CS</code> <br>  wobei X [0..3] eine beliebige Zahl ist <br><br>  Es ist zu sehen, dass dies keine strengen Sequenzen sind, n√§mlich Vorlagen, also musste ich mit dem Parser basteln. <br><br>  Die Logik der Arbeit ist ungef√§hr die folgende: Wenn wir die POWER ON-Sequenz erhalten, aber kein START vorhanden ist, beginnen wir mit dem Senden von Paketen mit dem Status 0. Wenn die START-Sequenz angezeigt wird, √§ndern Sie den Status auf 1. In anderen F√§llen kann der Helm nicht gesendet werden. <br><br>  Wir werden √ºber Pakete sprechen und welchen Status es als n√§chstes gibt. <br><br>  Es ist lustig, aber als ich I2C-Pakete ausspionierte, hatte ich keine Gelegenheit, eine Verbindung zum Sniffer-Computer herzustellen.  Ich habe f√ºr diese Raspberry Pi c Powerbank'om verwendet, die ein Aluminiumgeh√§use hatte.  Sobald dieses Geb√§ude mit dem K√∂rper der Waschmaschine in Kontakt kam, wurde ein FI in den Schild gezogen, das Licht ging in der Wohnung aus und ich fing an, mit dem Matyuki nach der Taschenlampe zu suchen.  :) Warum so ein M√ºll passiert ist - ist mir immer noch ein R√§tsel. <br><br><h3>  Radiokanal </h3><br>  Anfangs wollte ich nicht, dass die zus√§tzlichen Dr√§hte von der Waschmaschine kommen.  Das hei√üt, die Verbindung sollte drahtlos sein.  Von hier aus gab es drei m√∂gliche L√∂sungen f√ºr das Problem: WiFi, Bluetooth und das RF-Modul f√ºr Arduino.  Ich habe mich f√ºr Letzteres entschieden, indem ich das FS1000A-Modul ausgew√§hlt habe. <br><br>  Nat√ºrlich wird es auf Habr√© viele Leute geben, die mir diese Wahl vorwerfen.  Sie werden darauf hinweisen, dass es mit Ali-Express m√∂glich ist, ein ESP-Modul mit vollem WLAN kosteng√ºnstig zu erwerben.  Aber ich dachte, dass dies das Projekt sehr komplizieren w√ºrde und beschloss, einfacher zu handeln. <br><br>  Wie Sie wissen, kann das RF-Modul FS1000A nicht direkt an die RS232-Schnittstelle angeschlossen werden: Eine lange Folge von Nullen oder Einsen unterbricht die Empf√§ngersynchronisation.  Die VirtualWire-Bibliothek wurde erstellt, um dieses Problem zu l√∂sen.  Diese Bibliothek ist jedoch f√ºr Arduino geschrieben, und ich programmiere ausschlie√ülich nativ unter Atmega in C. Gl√ºcklicherweise ist der Code f√ºr Arduino reinem C sehr √§hnlich, und mit geringf√ºgigen √Ñnderungen wurde die Bibliothek erfolgreich portiert. <br><br>  Es gab einige Schwierigkeiten: Zuerst wollten die Pakete den Empf√§nger nicht erreichen.  Ich beschuldigte meine krummen H√§nde f√ºr alles, aber durch die direkte Verbindung der Anschl√ºsse der Empf√§nger- und Sendersteuerungen war ich √ºberzeugt, dass alles im Softwareteil funktioniert.  Der aus China bestellte Sender erwies sich als fehlerhaft.  Ich musste ein anderes Kit kaufen.  Dann habe ich den alten repariert und jetzt habe ich zwei S√§tze Sender-Empf√§nger.  Erinnerst du dich, was ich √ºber das Reduzieren von M√ºll geschrieben habe? <br><br>  Die Daten wurden gesendet, aber was genau ist in diesen Daten enthalten?  Das √ºbertragene Paket lautet wie folgt: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> dst; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> src; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_MSG_STATUS_ALIVE _BV(0) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_MSG_STATUS_VALVE _BV(1) uint8_t status; } wmp_msg_t; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_ADDR_MONITOR 0x4d504d57 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_ADDR_CONTROLLER 0x43504d57</span></span></code> </pre><br>  Die ersten beiden Doppelw√∂rter sind die physischen Adressen des Empf√§ngers und des Senders.  In meinem Fall sind sie streng festgelegt: 0x43504d57 - Empf√§nger (Controller) und 0x4d504d57 - Sender (Monitor).  Tats√§chlich sind die ersten 8 Bytes diese Paketsignatur.  Wichtige Informationen werden nur im letzten Byte gefunden - dem Bit-Flag.  Das gesetzte Nullbit dieses Flags bedeutet, dass der Monitor eingeschaltet ist und funktioniert - es sollte immer 1 sein. Das erste Bit ist der Status des Ventils: 0 - das Ventil muss geschlossen sein, 1 - offen.  Das ist alles. <br><br>  Es wird angenommen, dass der Monitor regelm√§√üig Pakete an die Steuerung senden sollte, um seinen Betrieb und die Wartungsfreundlichkeit des Datenkanals zu best√§tigen.  Bei Verlust des Kommunikationskanals muss die Steuerung das Ventil im Notfall schlie√üen. <br><br>  Die VirtualWire-Bibliothek √ºberwacht die Integrit√§t der √ºbertragenen Daten mithilfe von CRC32.  Ich musste keine zus√§tzlichen Anstrengungen in diese Richtung unternehmen.  Sch√∂nheit! <br><br><h3>  Bau </h3><br>  Strukturell besteht der Monitor aus einer kleinen Platine, die auf den Hei√ükleber "Onkel Liao Rotz" in der Frontplatte der Waschmaschine geklebt wird. Die Platine verbindet die Anschl√ºsse mit dem Spalt zwischen Computer und Anzeigetafel.  Die Maschine selbst wurde nicht ver√§ndert: Sie kann jederzeit in den urspr√ºnglichen Zustand versetzt werden. <br><br><h2>  Teil Zwei  Controller </h2><br><h3>  Radiokanal </h3><br>  Hier ist alles einfach: Der Empf√§nger des FS1000A-Kits und der Empf√§nger der VirtualWire-Bibliothek sind installiert.  Das Paket wird analysiert und sein Status wird an die Ausgabe √ºbertragen.  Der VirtualWire-Empf√§nger belegt TIMER1 im Mikrocontroller. <br><br><h3>  Ventilsteuerung </h3><br>  Im chinesischen Online-Shop wurde ein 3/4-Zoll-Motorventil mit 5-Volt-Stromversorgung und an das Kabel angeschlossenen Klemmensensoren ausgew√§hlt.  Dieses Ventil wurde zwischen dem Kugelhahn und dem Schlauch der Waschmaschine installiert.  Zur Steuerung des Ventils wurde am selben chinesischen Standort ein Schrittmotortreiber mit geringer Leistung f√ºr die L9110-Treiber bestellt.  Ich habe es wie folgt an die Steuerung angeschlossen: <br><br><img src="https://habrastorage.org/webt/0a/dr/h9/0adrh9lsveasvy1hpqc6ogngsac.png"><br><br>  Aus Sicht der Software gab es keine besonderen Schwierigkeiten: √úber die Eing√§nge VALVE_CLOSE und VALVE_OPEN bestimmen wir den aktuellen Status des Ventils.  Wenn dieser Status ge√§ndert werden muss, schalten Sie den Motor zum √ñffnen oder Schlie√üen ein und warten Sie, bis am entsprechenden Eingang eine logische 0 erreicht ist. Da das √ñffnen oder Schlie√üen jedoch einige Zeit in Anspruch nimmt, m√∂chte ich in diesem Moment nicht die Kontrolle √ºber alles verlieren Ger√§t.  Daher wurde auf dem Atmega-Timer ein primitiver Planer erstellt und die Steuerung des Ventils auf eine spezielle Aufgabe √ºbertragen.  Gleichzeitig misst das spezielle WatchDog-Softwaremodul die Zeit, die das Ventil zum Schalten ben√∂tigt, und wenn es zu lang ist, wird ein Signal √ºber seine Fehlfunktion generiert.  Sp√§ter wurden andere interessante Dinge an diesen Scheduler geh√§ngt, wie z. B. blinkende LEDs und die Abfrage des Lecksensors.  Aber dazu sp√§ter mehr. <br><br>  Au√üerdem geh√∂ren eine dreifarbige Status-LED und ein manueller Kippschalter mit drei Positionen zum Ventilsteuerkreis.  In der mittleren Position des Kippschalters wird die automatische Steuerung gem√§√ü den Signalen von der Waschmaschine und anderen Sensoren aktiviert.  Bei einer Fehlfunktion des Ventils leuchten die Farben Rot und Gr√ºn abwechselnd auf. <br><br><h3>  LED- und Tonanzeige </h3><br>  Mit LEDs ist alles einfach: Sie haften √ºber Begrenzungswiderst√§nde direkt an den E / A-Ports.  Die Str√∂me dort sind nicht gro√ü und die Anschl√ºsse an Atmega sind ziemlich stark. <br><br>  Aber das Ger√§usch musste basteln.  Erstens habe ich keinen gro√üen und lauten Piezo-Emitter gefunden.  Es scheint, dass solche Menschen in der Natur existieren, aber als ich mich um den Kauf k√ºmmerte, stellte sich heraus, dass die Auswahl √ºberhaupt nicht gro√üartig war.  Das Coolste, was ich geschafft habe, klang sehr leise.  Ich musste im Internet nach Rezepten suchen. <br><br>  Ich entschied mich f√ºr einen Stromkreis mit einem Transistor und einem Spartransformator, der die Schallspannung von 5 V auf 50 V schwingt.  Und dann stellte sich heraus, relativ laut.  Nat√ºrlich nicht bei allen Frequenzen, aber n√§her an der Resonanz. <br><br>  Erst w√§hrend der Erzeugung des Tons nahm die Helligkeit der LEDs (Pfosten mit Strom) leicht ab, aber der Mikrocontroller fror nicht ein und das Steuerprogramm brach nicht.  Ich dachte, dass dies eine Funktion des Debug-Layouts ist und auf der endg√ºltigen Karte alles gut funktioniert.  Ich habe mich geirrt - es wurde nicht besser.  Schlimmer aber auch. <br><br><img src="https://habrastorage.org/webt/w8/ca/pb/w8capblzyb0abagztoygcputhsi.png"><br><br>  Ein weiteres Problem war, dass mir die Timer ausgegangen waren und ich im Hintergrund keinen Ton erzeugen konnte.  Ich musste die Quietschperiode mit Schlaf fragen.  W√§hrend der Klangerzeugung kann Atmega also nichts anderes tun, als dass auch Unterbrechungen deaktiviert werden mussten, sonst ist der Ton nicht klar.  Dies stellte sich jedoch als nicht sehr be√§ngstigend heraus, da sich die Tonausgabe nicht mit anderen kritischen Aufgaben wie der Steuerung eines Ventils oder dem Empfang von Daten √ºber Funk √ºberschnitt. <br><br>  Als n√§chstes w√§hlte ich die Schlafkonstanten so aus, dass sie den Noten entsprachen, und fand mehrere mehr oder weniger harmonische Kombinationen: ‚ÄûDas Ventil ist offen‚Äú, ‚ÄûDas Ventil ist geschlossen‚Äú, ‚ÄûWaschen ist beendet‚Äú und ‚ÄûLeckage‚Äú.  Ich werde Sie sp√§ter separat √ºber das Signal "Waschen beendet" informieren. <br><br><h3>  Lecksucher </h3><br>  Der Lecksucher sollte urspr√ºnglich auf dem eingebauten ADC des Mikrocontrollers ausgef√ºhrt werden.  Experimente haben gezeigt, dass dies eine perfekt funktionierende L√∂sung ist.  Ich habe jedoch festgestellt, dass dem Sensor manchmal ein Kondensator mit Kontakten hinzugef√ºgt wird, damit er angeschlossen wird und wenn irgendwo kein Drahtbruch auftritt.  Sie k√∂nnen das Vorhandensein eines Kondensators √ºberpr√ºfen (und seine Kapazit√§t messen), indem Sie Folgendes verwenden: RC-Kette, Komparator und Takt.  Als Komparator wird ein herk√∂mmlicher GPIO-Eingang verwendet (er ist auch ein logischer Eingang und schaltet bei einer bestimmten Spannung von 0 auf 1), und der Mikrocontroller verf√ºgt √ºber gen√ºgend Stunden. <br><br><img src="https://habrastorage.org/webt/sh/um/rn/shumrnvjljzhpc_m7fdyye9ugwi.png"><br><br>  Es wurde angenommen, dass ich von Zeit zu Zeit das Vorhandensein eines Kondensators in der Leitung √ºberpr√ºfe und dann mithilfe des ADC feststelle, ob sich die Sensorkontakte im Wasser befinden.  Wie sich herausstellte, reicht es aus, nur die Kapazit√§t des Kondensators zu messen: Wenn Sie ihn in Wasser absenken, erh√∂ht sich die Ladezeit und die Entladung nimmt ab.  Dar√ºber hinaus √§ndert sich die Zeit um einen ausreichenden Betrag, so dass sie sicher erkannt werden kann. <br><br>  F√ºr mein System habe ich die Ladezeit gemessen: Wenn der Kondensator nicht angeschlossen ist, ist er Null, wenn er trocken ist, ist er relativ klein, und wenn er sich in Wasser befindet, ist die Ladezeit viel l√§nger.  Die genauen Werte wurden unter Verwendung einer Untertasse mit Wasser und einer Reihe von Experimenten bestimmt. <br><br>  Der Lecksucher verf√ºgt √ºber eine eigene rote Anzeige-LED.  Wird der Sensor nicht erkannt, leuchtet er auf und der Befehl zum Schlie√üen des Ventils wird an die Luft √ºbertragen.  Man muss nur die Kommunikation mit dem Sensor wiederherstellen, die LED erlischt und das Ventil kann ge√∂ffnet werden (wenn sich nat√ºrlich nur die Maschine im Waschzustand befindet).  Eine andere Sache ist, wenn der Sensor Wasser erkennt.  In diesem Fall beginnt die Anzeige zu blinken, es ist ein unangenehmes intermittierendes Ger√§usch zu h√∂ren und das Ventil wird gewaltsam geschlossen.  Vor allem aber verl√§sst der Controller diesen Zustand nie.  Ein Leck wird als schwerer Unfall angesehen, und die Wasserversorgung wird erst wieder aufgenommen, wenn Sie das Ger√§t zwangsweise neu starten. <br><br><h3>  Ern√§hrung </h3><br>  Essen ist f√ºr mich der unverst√§ndlichste Teil in diesem Projekt.  Wenn ich mich ein wenig mit digitalen Schaltkreisen auskenne, dann mit analogen, um es milde auszudr√ºcken - nicht wirklich.  Aber dank der Chinesen: Ich kann fertige Module f√ºr DC-DC-Wandler mit Batterieladecontrollern kaufen und mir basierend darauf etwas Praktikables vorstellen. <br><br>  Von Anfang an war geplant, das Ger√§t autark zu machen, damit im Falle eines Stromausfalls sichergestellt ist, dass das Wasser abgestellt wird.  Au√üerdem hatte ich ein 9-V-Netzteil, das irgendwo angeschlossen werden musste.  Insgesamt war das Einf√ºhrungsergebnis wie folgt: <br><br><ul><li>  9V kommt aus dem Netzwerk; </li><li>  3,4 ~ 3,7 V kommen von der Batterie; </li><li>  Zum Laden des Akkus ben√∂tigen Sie 5V; </li><li>  5 V werden ben√∂tigt, um Logik und Stromkreise mit Strom zu versorgen; </li><li>  Wenn die Netzspannung ausf√§llt, schalten Sie die Batterie ein. </li><li>  Es ist erforderlich, das Batterieladesignal, die Spannung an der Batterie und das Betriebssignal vom Netzwerk an die Steuerung zu √ºbertragen. </li></ul><br>  Das Blockschaltbild stellte sich wie in der Abbildung heraus. <br><br><img src="https://habrastorage.org/webt/7g/ma/5l/7gma5lv_yub5aunjhing_cbnmjw.jpeg"><br><br>  Als Schaltelement werden zwei Schottky-Dioden verwendet.  Der Laderegler verf√ºgt √ºber zwei LEDs: CHARGE und STANDBY.  Das Signal vom ersten wurde an den GPIO-Port des Controllers angeschlossen, damit der Monitor erkennen konnte, dass der Akku geladen wurde.  Au√üerdem wird ein Signal vom ersten DC-DC-Wandler an den Mikrocontroller-Port angelegt, um festzustellen, ob das Ger√§t mit einem Netz oder einer Batterie betrieben wird.  Zur Steuerung des Ladezustands wird die Spannung von der Batterie dem ADC der Steuerung zugef√ºhrt.  Wenn die Spannung zu niedrig ist, schlie√üt der Monitor das Ventil und wechselt in den Standby-Modus: Er reagiert erst auf Befehle, wenn die Netzspannung angezeigt wird. <br><br>  Leider gab es hier einige Pfosten: Aus irgendeinem Grund nimmt der Ventilmotor einen Teil der Energie aus der Batterie auf.  Anscheinend habe ich einen Fehler mit der Leistung des Netzwerk-DC / DC-Wandlers oder mit der Dicke der Stromspuren auf der Platine gemacht.  Infolgedessen: Nach dem √ñffnen oder Schlie√üen des Ventils beginnt die Batterie zu laden. <br><br>  Zur √úberwachung des Stromstatus gibt es eine spezielle zweifarbige LED.  Wenn es gr√ºn ist, arbeitet das Ger√§t im Netzwerk.  Wenn rot - dann von der Batterie.  Wenn es gr√ºn ist, aber rot blinkt, wird der Akku aufgeladen. <br><br><h3>  Arbeitslogik </h3><br>  Nun, wir haben die gesamte Hardware- und Softwareunterst√ºtzung, jetzt m√ºssen wir irgendwie daf√ºr sorgen, dass all dies miteinander interagiert.  Anfangs sah ich die Implementierung der Arbeitslogik in Form einer gro√üen Schleife (was als Hauptschleife bezeichnet wird) mit einer Reihe von Wenns im Inneren. <br><br>  Dabei war ein Taskplaner f√ºr so einfache Aktionen erforderlich: Blinken einer LED, Abfragen eines Lecksensors, Verfolgen der Ventilschaltzeit und Leistungsregelung, die ich an TIMER0 aufgelegt habe.  Der Scheduler selbst hat die der Task zugeordneten Funktionen nicht gestartet, sondern nur das Synchronisationsbit im der Task zugeordneten Deskriptor auf eins gesetzt.  Die Aufgabe wurde noch im Hauptzyklus ausgef√ºhrt, wir haben es geschafft, Tracking-Zeitintervalle loszuwerden, was es sehr einfach machte. <br><br>  Aus dem Zoo ifs, die den Status verschiedener Subsysteme der Steuerung √ºberpr√ºfen und eine Entscheidung treffen: Es war notwendig, das √ñffnen oder Schlie√üen des Ventils zu verweigern.  Es ist sehr schwierig, dies zu debuggen, und es ist sehr leicht, verwirrt zu werden.  Stattdessen gefiel mir die Idee aus D. Hazermans altem Buch: "Wie man selbst einen Roboter baut."  Das Buch schlug vor, dass jedes Modul seine eigenen Steuersignale erzeugt: Vorw√§rts, R√ºckw√§rts, Drehung usw. Als n√§chstes wird aus diesen Signalen nur eines ausgew√§hlt, das aus einem Block mit einer h√∂heren Priorit√§t stammt.  Ich habe ungef√§hr das Gleiche getan. <br><br>  Ich habe die Bl√∂cke wie folgt priorisiert: <br><br><ol><li>  Leckblock </li><li>  Batteriesteuerger√§t </li><li>  Manuelle Ventilsteuereinheit </li><li>  Steuerger√§t f√ºr Funksteuerventil </li><li>  Ventilzeitgeber WatchDog-Block </li></ol><br>  Jeder Block generiert drei Befehle: UNDEFINED, OPEN und CLOSE. <br><br>  Der Leckblock hat die h√∂chste Priorit√§t, aber nicht den Befehl OPEN, aber sein Befehl CLOSE schlie√üt das Ventil definitiv, unabh√§ngig davon, was andere Bl√∂cke sagen.  Die manuelle Steuereinheit kann jedes Signal der Funkkanaleinheit unterbrechen, wodurch Sie das Ventil unabh√§ngig davon steuern k√∂nnen, was die Waschmaschine uns anzeigt.  Gut und so weiter.  Das hei√üt, es ist eine logische hierarchische Struktur entstanden, die leicht zu verstehen und zu debuggen ist. <br><br>  Kommen wir nun zum Signal zur√ºck: "Waschen ist beendet."  Leider hat mein Modell einer Waschmaschine nicht die M√∂glichkeit, mit Hilfe von Ton √ºber das Ende ihrer Arbeit zu informieren: Candy-Ingenieure boten keine solche Gelegenheit.  Andererseits habe ich ein zus√§tzliches Ger√§t, das einen Piezo-Emitter hat und zu jedem Zeitpunkt wei√ü, was die Waschmaschine tut.  Warum l√§sst du ihn nicht das Ende der W√§sche melden?  Lassen Sie uns den Regler laut und unangenehm (bei der Resonanzfrequenz) quietschen, wenn das Ventil das Signal schlie√üt.  F√ºgen Sie ein weiteres Schutzintervall von f√ºnf Minuten hinzu, um dieses Quietschen nicht jedes Mal zu h√∂ren, wenn Sie die Maschine ein- und ausschalten.  Das Ventil ist f√ºnf Minuten lang ge√∂ffnet - das Waschen hat definitiv begonnen. <br><br><h2>  Ergebnisse </h2><br>  Die Entwicklung dauerte ungef√§hr ein Jahr ohne Eile (sehr ohne Eile).  Das Ger√§t arbeitet seit zwei Jahren.  Im Betrieb erwies es sich als recht zufriedenstellend.  Aber nicht ohne M√§ngel.  Lassen Sie uns sie ehrlich auflisten: <br><br><ol><li>  Ich habe etwas mit der Leistung durcheinander gebracht: Der Ventilmotor nimmt einen Teil der Energie aus der Batterie auf. </li><li>  Die Klangerzeugungsschaltung zieht die Versorgungsspannung.  Sie k√∂nnen deutlich sehen, wie sich die Helligkeit der LEDs √§ndert, wenn Ton abgespielt wird. </li><li>  Der Funkkanal ist nicht sehr stabil.  Erstens verschwindet das Signal, wenn eine Person in der N√§he der Waschmaschine steht.  Und zweitens verschlechtert sich das Signal manchmal von selbst.  In diesem Fall m√ºssen Sie den manuellen Kippschalter verwenden, dies geschieht jedoch √§u√üerst selten. </li><li>  Die Monitoreinheit in der Waschmaschine hing ein paar Mal.  Der Controller-Block hing nicht einmal. </li><li>  Der Ton vom Piezo-Emitter war im Inneren des Geh√§uses sehr √ºbert√∂nt.  Ich habe ein Loch in das Koprus gebohrt: es wurde besser, aber nicht wirklich.  Ich musste den Emitter von der Platine l√∂ten und ihn direkt gegen√ºber dem Loch auf das Geh√§use kleben. </li></ol><br>  Generell halte ich die Entwicklung f√ºr erfolgreich und sehr n√ºtzlich.  Ich starte die Maschine am Morgen und gehe ruhig zur Arbeit: Ich wei√ü, dass zum richtigen Zeitpunkt der Wasserhahn abgestellt wird. <br><br>  Archiv mit Projektdateien kann hier heruntergeladen <a href="">werden</a> . <br><br><h3>  Ein paar Bilder. </h3><br><div class="spoiler">  <b class="spoiler_title">Draufsicht mit entfernter Deckel</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/pk/ac/1q/pkac1q7wwkmwbptyd814mobigx4.jpeg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">R√ºckansicht von der Seite der Anschl√ºsse</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/-z/3g/zq/-z3gzqv3s-dwhfuvlco9jkkqbcm.jpeg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Im nat√ºrlichen Lebensraum</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/kc/cv/sx/kccvsxlyr0qtrtirqf_c5hthamq.jpeg"><br></div></div><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/bg/kh/yy/bgkhyyih1i083nb9omlxrqxo9be.jpeg"><br></div></div><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/p5/qu/2y/p5qu2ygeapyr_ivwdguhkjmkcxs.jpeg"><br></div></div><br> <i>  <br> -  ¬´¬ª</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de472296/">https://habr.com/ru/post/de472296/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de472280/index.html">Die Aufgabe, das Vorhandensein einer Handfl√§che auf einem Venenscanner festzustellen</a></li>
<li><a href="../de472288/index.html">9 n√ºtzliche Browser-Erweiterungen f√ºr Entwickler (Liste f√ºr 2020)</a></li>
<li><a href="../de472290/index.html">Strukturen gegen Klassen</a></li>
<li><a href="../de472292/index.html">Blockieren von Inhalten: Die Weltb√ºhne</a></li>
<li><a href="../de472294/index.html">Erstelle Spiele und Videos auf YouTube. Mein Interaktionsexperiment und die Einnahmen daraus</a></li>
<li><a href="../de472298/index.html">Die Verdauung von frischen Materialien aus der Welt des Frontends f√ºr die letzte Woche Nr. 385 (14. - 20. Oktober 2019)</a></li>
<li><a href="../de472300/index.html">Stochastischer Gradientenabstieg (SGD) f√ºr die logarithmische Verlustfunktion (LogLoss) in einem bin√§ren Klassifizierungsproblem</a></li>
<li><a href="../de472304/index.html">Die NASA stellt Ingenieure ein, um humanoide Roboter der n√§chsten Generation zu entwickeln</a></li>
<li><a href="../de472306/index.html">PHP Digest Nr. 166 (7.-21. Oktober 2019)</a></li>
<li><a href="../de472310/index.html">Kundenidentifikation auf Websites ohne Passw√∂rter und Cookies: Anwendung f√ºr Standard</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>