<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêøÔ∏è üßëüèæ‚Äçü§ù‚ÄçüßëüèΩ üë®üèΩ‚Äçüåæ Jouet GAZ-66 sur le panneau de commande. 2e partie ü§πüèº üêÅ ‚õΩÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cette partie, nous parlerons du composant logiciel, de la fa√ßon dont la machine a pris vie. Quel syst√®me d'exploitation a √©t√© utilis√©, quelle lan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Jouet GAZ-66 sur le panneau de commande. 2e partie</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462331/"><p><img src="https://habrastorage.org/webt/ix/tf/mx/ixtfmxmnpt-9rkvbc2kqpdtol2c.jpeg" alt="image"></p><br><p>  Dans cette partie, nous parlerons du composant logiciel, de la fa√ßon dont la machine a pris vie.  Quel syst√®me d'exploitation a √©t√© utilis√©, quelle langue a √©t√© choisie, quels probl√®mes ont √©t√© rencontr√©s. </p><a name="habracut"></a><br><h3 id="1-kak-rabotaet-v-2-h-slovah">  1. Comment √ßa marche en 2 mots </h3><br><p>  Le syst√®me se compose d'un serveur install√© sur une machine √† √©crire et d'un client install√© sur la console.  Le serveur l√®ve le point d'acc√®s <strong>wifi</strong> et attend que le client se connecte.  Le serveur ex√©cute les commandes client et transmet √©galement la vid√©o de la cam√©ra √† celle-ci. </p><br><h3 id="2-os">  2. OS </h3><br><p>  Parlons maintenant des syst√®mes d'exploitation utilis√©s. </p><br><p>  √âtant donn√© que l'ensemble du syst√®me est bas√© sur <strong>Raspberry pi 3</strong> , le syst√®me d'exploitation officiel a √©t√© utilis√©.  Au moment de la cr√©ation, la derni√®re version √©tait <strong>Stretch</strong> , elle √©tait et a √©t√© s√©lectionn√©e pour √™tre utilis√©e sur une machine √† √©crire et une t√©l√©commande.  Mais il s'est av√©r√© qu'il y a un bug (tourment√© pendant une semaine) √† cause duquel il est impossible d'√©lever le point d'acc√®s wifi.  Par cons√©quent, pour augmenter le point d'acc√®s, une version pr√©c√©dente de <strong>Jessie a</strong> √©t√© prise sans probl√®mes. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Article comment √©lever un point d'acc√®s.</a>  Tr√®s d√©taill√©, a tout fait dessus. </p><br><p>  La t√©l√©commande se connecte automatiquement √† la machine lorsqu'elle soul√®ve le point d'acc√®s. <br>  Connexion automatique √† notre point, dans le fichier <strong>/ etc / network / interfaces</strong> ajoutez: </p><br><pre><code class="plaintext hljs">auto wlan0 iface wlan0 inet dhcp wpa-ssid {ssid} wpa-psk {password}</code> </pre> <br><h3 id="2-yazyk">  2. Langue </h3><br><p>  J'ai choisi <strong>python</strong> parce que c'est facile et simple. </p><br><h3 id="3-server">  3. Serveur </h3><br><p>  Par serveur dans cette section, je veux dire un logiciel √©crit par moi pour contr√¥ler la machine et travailler avec la vid√©o. </p><br><p>  Le serveur se compose de 2 parties.  Serveur vid√©o et serveur de gestion. </p><br><h3 id="31-video-server">  3.1 Serveur vid√©o </h3><br><p>  Il y avait 2 options pour travailler avec une cam√©ra vid√©o.  1√®re utilisation <strong>du</strong> module <strong>picamera</strong> et 2√®me utilisation du <strong>logiciel mjpg-streamer</strong> .  Sans y r√©fl√©chir √† deux fois, j'ai d√©cid√© de les utiliser tous les deux, et lequel utiliser dans les param√®tres de configuration. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> conf.conf.VideoServerType == <span class="hljs-string"><span class="hljs-string">'m'</span></span> : cmd = <span class="hljs-string"><span class="hljs-string">"cd /home/pi/projects/mjpg-streamer-experimental &amp;&amp; "</span></span> cmd += <span class="hljs-string"><span class="hljs-string">'./mjpg_streamer -o "./output_http.so -p {0} -w ./www" -i "./input_raspicam.so -x {1} -y {2} -fps 25 -ex auto -awb auto -vs -ISO 10"'</span></span>.format(conf.conf.videoServerPort, conf.conf.VideoWidth, conf.conf.VideoHeight) print(cmd) os.system(cmd) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> picamera.PiCamera(resolution = str(conf.conf.VideoWidth) + <span class="hljs-string"><span class="hljs-string">'x'</span></span> + str(conf.conf.VideoHeight) , framerate = conf.conf.VideoRate) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Camera: output = camera.StreamingOutput() camera.output = output Camera.start_recording(output, format = <span class="hljs-string"><span class="hljs-string">'mjpeg'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: address = (conf.conf.ServerIP, conf.conf.videoServerPort) server = camera.StreamingServer(address, camera.StreamingHandler) server.serve_forever() <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: Camera.stop_recording()</code> </pre> <br><p>  Puisqu'ils prennent les m√™mes param√®tres, ils travaillent √† la m√™me adresse.  Il n'y a aucun probl√®me de communication avec la t√©l√©commande lors du passage de l'un √† l'autre.  La seule chose que je pense que <strong>mjpg-streamer</strong> fonctionne plus rapidement. </p><br><h3 id="32-server-upravleniya">  3.2 Serveur de gestion </h3><br><h4 id="321-vzaimodeystvie-mezhdu-klientom-i-serverom">  3.2.1 Interaction entre le client et le serveur </h4><br><p>  Les commandes d'√©change serveur et client sous forme de cha√Ænes json: </p><br><pre> <code class="python hljs">{<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'val'</span></span>: <span class="hljs-number"><span class="hljs-number">0.0</span></span>} {<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'Y'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'val'</span></span>: <span class="hljs-number"><span class="hljs-number">0.5</span></span>} {<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'turn'</span></span>, <span class="hljs-string"><span class="hljs-string">'x'</span></span>: <span class="hljs-number"><span class="hljs-number">55</span></span>, <span class="hljs-string"><span class="hljs-string">'y'</span></span>: <span class="hljs-number"><span class="hljs-number">32</span></span>}</code> </pre> <br><ul><li>  type - 'distant' ou 'voiture' selon qui envoie la commande (client ou serveur) </li><li>  cmd - une cha√Æne avec le nom du bouton correspondant au nom du bouton sur le <strong>Game HAT</strong> , par exemple: <br><ul><li>  D√©marrer - bouton D√©marrer </li><li>  S√©lectionner - bouton S√©lectionner </li><li>  Bouton Y - Y </li><li>  etc. </li><li>  tourner - la commande pour changer l'√©tat du joystick, est responsable de tourner les roues </li></ul></li><li>  √©tat - Vrai ou faux, selon que le bouton est enfonc√© ou non.  Un √©v√©nement d'√©tat de bouton est distribu√© chaque fois que son √©tat change. </li><li>  val - vitesse et sens de d√©placement du moteur de -1 ... 1, valeur de type <strong>flotteur</strong> .  Param√®tre significatif pour les boutons de mouvement uniquement. </li><li>  x - √©cart du joystick le long de l'axe x de -100 ... 100, valeur de type <strong>int</strong> </li><li>  y - √©cart du joystick le long de l'axe y de -100 ... 100, valeur de type <strong>int</strong> </li></ul><br><p>  Vient ensuite ma honte, de refaire les mains qui n'atteignent pas.  La machine soul√®ve le socket du serveur et attend que le client s'y connecte.  De plus, pour chaque nouvelle connexion, il cr√©e un flux s√©par√©, et chaque nouveau client qui se connectera √† la machine pourra le contr√¥ler)).  Cela ne peut pas √™tre si loin car personne d'autre n'a une telle t√©l√©commande, et je l√®ve mon r√©seau wifi ferm√©. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> TCP_IP = conf.conf.ServerIP TCP_PORT = conf.conf.controlServerPort BUFFER_SIZE = conf.conf.ServerBufferSize self.tcpServer = socket.socket(socket.AF_INET, socket.SOCK_STREAM) self.tcpServer.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number"><span class="hljs-number">1</span></span>) self.tcpServer.bind((TCP_IP, TCP_PORT)) threads = [] <span class="hljs-comment"><span class="hljs-comment">#     . self.tcpServer.listen(1) while True: print("Car server up : Waiting for connections from TCP clients...") (conn, (ip, port)) = self.tcpServer.accept() newthread = ClientThread(conn, ip, port) newthread.start() self.threads.append(newthread)</span></span></code> </pre> <br><h4 id="322-upravlenie-zhelezom">  3.2.2 Gestion du fer </h4><br><p>  Lorsque vous travaillez avec Raspberry, le syst√®me de num√©rotation des broches <strong>GPIO.BCM</strong> a √©t√© utilis√©. </p><br><p>  <strong>La lumi√®re est</strong> contr√¥l√©e via gpio 17, elle est connect√©e √† la 2√®me broche sur <strong>L293</strong> .  Ensuite, √† chaque fois que la commande comprend: </p><br><pre> <code class="python hljs">GPIO.output(self.gpioLight, GPIO.HIGH)</code> </pre> <br><pre> <code class="python hljs">GPIO.output(self.gpioLight, GPIO.LOW)</code> </pre> <br><p>  les commandes correspondantes sont appel√©es. </p><br><p>  <strong>Le servo variateur</strong> est <strong>contr√¥l√©</strong> via la carte <strong>PCA9685</strong> via le bus I2C, nous avons donc besoin de la biblioth√®que appropri√©e pour cela <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Adafruit_PCA9685</a> .  Le PCA9685 est connect√© au servo via 7 broches.  La fr√©quence PWM requise pour travailler avec le servo est de 50 Hz ou une p√©riode de 20 ms. </p><br><p>  Le principe de fonctionnement du servo: </p><br><p><img src="https://habrastorage.org/webt/h2/z-/ns/h2z-nsefbtnvntcwbmmt9qoikjc.jpeg" alt="image"></p><br><p>  Lorsqu'un signal de 1,5 ms est appliqu√©, les roues seront centr√©es.  √Ä 1 ms.  le servo tournera le plus loin possible vers la droite, 2 ms.  √† gauche autant que possible.  Les fus√©es de direction dans les ponts pour de tels virages ne sont pas con√ßues, donc l'angle de rotation a d√ª √™tre s√©lectionn√© exp√©rimentalement. </p><br><p>  Les valeurs qui peuvent √™tre transmises √† la plage d'API Adafruit_PCA9685 vont de 0 √† 4095, 0 aucun signal, 4095 plein.  En cons√©quence, dans cette gamme, il a fallu choisir les valeurs adapt√©es √† mes roues.  Le moyen le plus simple de d√©terminer les valeurs pour des roues exactement d√©finies est de transf√©rer 1,5 ms √† une valeur comprise entre ~ 307. </p><br><p>  La valeur maximale pour la droite est 245, pour la gauche 369. </p><br><p>  Les valeurs provenant du joystick prennent des valeurs de -100 ... 100, donc elles ont d√ª √™tre traduites dans la plage de 245 √† 369. Encore une fois, le centre est le plus facile, si 0 c'est 307. Gauche et droite selon la formule: </p><br><pre> <code class="python hljs">val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero))</code> </pre> <br><ul><li>  HardwareSetting._turnCenter - 307 </li><li>  tour - valeur du joystick de -100 ... 100 </li><li>  HardwareSetting._turnDelta - 62, la diff√©rence entre le centre et l'√©cart maximal sur le c√¥t√© (307 - 245 = 62) </li><li>  HardwareSetting.yZero - 100, la valeur maximale re√ßue du joystick </li></ul><br><p>  Roues droites: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnCenter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  Tournez √† gauche: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnLeft</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, turn)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero)) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  Tournez √† droite: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnRight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, turn)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero)) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  <strong>Le contr√¥le du moteur</strong> s'effectue √©galement via la carte <strong>PCA9685</strong> via le bus I2C, nous utilisons donc <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Adafruit_PCA9685</a> .  Les broches 10 √† 15 du PCA9685 sont connect√©es au L298N (j'utilise 2 canaux dessus pour absorber la puissance).  10 et 11 √† ENA et ENB (je les remplis de PWM pour contr√¥ler la vitesse).  12, 13, 14, 15 √† IN1, IN2, IN3, IN4 - sont responsables du sens de rotation du moteur.  La fr√©quence PWM n'est pas tr√®s importante ici, mais j'utilise √©galement 50 Hertz (ma valeur par d√©faut). </p><br><p>  La machine reste immobile: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW)</code> </pre> <br><p>  Aller de l'avant: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">back</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, speed)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . Args: speed:     0  1. """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH)</code> </pre> <br><p>  Mouvement vers l'arri√®re: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forward</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, speed)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . Args: speed:     0  1. """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW)</code> </pre> <br><h3 id="4-klient">  4. Client </h3><br><h3 id="41-klaviatura">  4.1 Clavier </h3><br><p>  Il y avait certains probl√®mes avec elle, au d√©but, je voulais la rendre mouvement√©e (a pris environ 2 semaines de tourments).  Mais les boutons m√©caniques ont contribu√©, le cliquetis des contacts a conduit √† des d√©faillances constantes et impr√©visibles (les algorithmes de contr√¥le que j'ai invent√©s fonctionnaient imparfaitement).  Ensuite, mon coll√®gue m'a dit comment les claviers sont fabriqu√©s.  Et j'ai d√©cid√© de faire de m√™me, maintenant j'interroge l'√©tat toutes les 0,005 secondes (pourquoi, et qui sait).  Et s'il a chang√©, envoyez la valeur au serveur. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">0.005</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.pins : p = self.pins[pin] status = p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> GPIO.input(pin) == GPIO.HIGH : p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] != status : p[<span class="hljs-string"><span class="hljs-string">'callback'</span></span>](pin) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyboardInterrupt: GPIO.cleanup()</code> </pre><br><h3 id="42-dzhoystik">  4.2 Joystick </h3><br><p>  <strong>La lecture des lectures</strong> a lieu via la carte <strong>ADS1115</strong> via le bus I2C, par cons√©quent, la biblioth√®que appropri√©e est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Adafruit_PCA9685</a> .  Le joystick est √©galement enclin √† claquer des contacts, donc j'en prends des lectures par analogie avec le clavier. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: X = self.adc.read_adc(<span class="hljs-number"><span class="hljs-number">0</span></span>, gain=self.GAIN) / HardwareSetting.valueStep Y = self.adc.read_adc(<span class="hljs-number"><span class="hljs-number">1</span></span>, gain=self.GAIN) / HardwareSetting.valueStep <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> X &gt; HardwareSetting.xZero : X = X - HardwareSetting.xZero <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : X = <span class="hljs-number"><span class="hljs-number">-1</span></span> * (HardwareSetting.xZero - X) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Y &gt; HardwareSetting.yZero : Y = Y - HardwareSetting.yZero <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : Y = <span class="hljs-number"><span class="hljs-number">-1</span></span> * (HardwareSetting.yZero - Y) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(X) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) : X = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(Y) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) : Y = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(self.x - X) &gt;= <span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abs(self.y - Y) &gt;= <span class="hljs-number"><span class="hljs-number">1.0</span></span>) : self.sendCmd(round(X), round(Y)) self.x = X self.y = Y time.sleep(<span class="hljs-number"><span class="hljs-number">0.005</span></span>)</code> </pre> <br><p>  Lorsqu'il est aliment√© √† partir de 3,3 volts, la plage de valeurs que l'ADS1115 donne avec un joystick de 0 √† 26500.  J'apporte cela √† la gamme de -100 ... 100.  Dans ma plage autour de 0, il fluctue toujours, donc si les valeurs ne d√©passent pas 5, alors je consid√®re que c'est 0 (sinon il va inonder).  D√®s que les valeurs changent, envoyez-les √† la machine √† √©crire. </p><br><h3 id="43-podklyuchenie-k-serveru-upravleniya">  4.3 Connexion au serveur de gestion </h3><br><p>  La connexion au serveur est une chose simple: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> : tcpClient = socket.socket(socket.AF_INET, socket.SOCK_STREAM) tcpClient.settimeout(<span class="hljs-number"><span class="hljs-number">2.0</span></span>) tcpClient.connect((conf.conf.ServerIP, conf.conf.controlServerPort)) self.signalDisplayPrint.emit(<span class="hljs-string"><span class="hljs-string">"+"</span></span>) carStatus.statusRemote[<span class="hljs-string"><span class="hljs-string">'network'</span></span>][<span class="hljs-string"><span class="hljs-string">'control'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.tcpClient = tcpClient <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> socket.error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: self.signalDisplayPrint.emit(<span class="hljs-string"><span class="hljs-string">"-"</span></span>) carStatus.statusRemote[<span class="hljs-string"><span class="hljs-string">'network'</span></span>][<span class="hljs-string"><span class="hljs-string">'control'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> time.sleep(conf.conf.timeRecconect) self.tcpClient = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.tcpClient : self.tcpClient.settimeout(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>)</code> </pre> <br><p>  Mais je veux faire attention √† une chose.  Si vous n'utilisez pas de d√©lai d'expiration dans la connexion, il peut se figer et attendre environ deux minutes (cela se produit lorsque le client a d√©marr√© avant le serveur).  J'ai r√©solu cela de la mani√®re suivante, j'ai d√©fini le d√©lai d'expiration de la connexion.  D√®s que la connexion a lieu, je supprime le d√©lai d'expiration. </p><br><p>  Je stocke √©galement l'√©tat de la connexion, afin de savoir si le contr√¥le est perdu et de l'afficher √† l'√©cran. </p><br><h3 id="44-proverka-podklyucheniya-k-wifi">  4.4 V√©rification de la connexion WiFi </h3><br><p>  Je v√©rifie l'√©tat du wifi pour la connexion au serveur.  Et si, que je m'informe √©galement des probl√®mes. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">1.0</span></span>) self.ps = subprocess.Popen([<span class="hljs-string"><span class="hljs-string">'iwgetid'</span></span>], stdout=subprocess.PIPE, stderr=subprocess.STDOUT) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: output = subprocess.check_output((<span class="hljs-string"><span class="hljs-string">'grep'</span></span>, <span class="hljs-string"><span class="hljs-string">'ESSID'</span></span>), stdin=self.ps.stdout) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> re.search(<span class="hljs-string"><span class="hljs-string">r'djvu-car-pi3'</span></span>, str(output)) : self.sendStatus(<span class="hljs-string"><span class="hljs-string">'wifi+'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> subprocess.CalledProcessError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> self.sendStatus(<span class="hljs-string"><span class="hljs-string">'wifi-'</span></span>) self.ps.kill()</code> </pre> <br><h3 id="45-podklyuchenie-k-video-serveru">  4.5 Connexion √† un serveur vid√©o </h3><br><p>  Pour cela, toute la puissance de <strong>Qt5 √©tait n√©cessaire</strong> , d'ailleurs sur la distribution <strong>Stretch,</strong> elle est plus r√©cente et √† mon avis montre mieux.  sur <strong>jessie</strong> j'ai essay√© aussi. </p><br><p>  Pour l'affichage, j'ai utilis√©: </p><br><pre> <code class="python hljs">self.videoWidget = QVideoWidget()</code> </pre> <br><p>  Et il en a d√©duit: </p><br><pre> <code class="python hljs">self.mediaPlayer = QMediaPlayer(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, QMediaPlayer.LowLatency) self.mediaPlayer.setVideoOutput(self.videoWidget)</code> </pre> <br><p>  Connexion √† la vid√©o en streaming: </p><br><pre> <code class="python hljs">self.mediaPlayer.setMedia(QMediaContent(QUrl(<span class="hljs-string"><span class="hljs-string">"http://{}:{}/?action=stream"</span></span>.format(conf.conf.ServerIP, conf.conf.videoServerPort)))) self.mediaPlayer.play()</code> </pre> <br><p>  Encore une fois, je m'excuse pour la tautologie).  Je surveille l'√©tat de la connexion vid√©o pour la connexion au serveur vid√©o.  Et si, que je m'informe √©galement des probl√®mes. </p><br><p>  Voici √† quoi cela ressemble quand tout ne fonctionne pas: </p><br><p><img src="https://habrastorage.org/webt/ea/6a/ug/ea6augn3vrdv3ejjom8v6qrnpvu.jpeg" alt="image"></p><br><ul><li>  <strong>W</strong> - signifie qu'il n'y a pas de connexion avec le wifi </li><li>  <strong>B</strong> - signifie pas de vid√©o </li><li>  <strong>Y</strong> - signifie qu'il n'y a pas de contr√¥le </li></ul><br><p>  Sinon, il n'y a pas de lettres rouges, il y a une vid√©o de la cam√©ra.  Je posterai une photo et une vid√©o avec le travail dans le futur) J'esp√®re que le support pour la cam√©ra viendra dans un proche avenir et je vais enfin le fixer normalement. </p><br><h3 id="5-nastroyka-raspberry-os">  5 Configuration du syst√®me d'exploitation Raspberry </h3><br><p>  Soit dit en passant, le travail avec la cam√©ra et les autres choses n√©cessaires doivent √™tre activ√©s (√† la fois sur le client et sur le serveur).  Apr√®s avoir charg√© l'OS: </p><br><p><img src="https://habrastorage.org/webt/ex/ye/gz/exyegz24x9ec0ee0cdp7qpm5kog.jpeg" alt="image"></p><br><p>  Et allumez presque tout: appareil photo, ssh, i2c, gpio </p><br><p><img src="https://habrastorage.org/webt/ye/fu/z4/yefuz4_ioqh5g1j_f1n1mgwf_cg.png" alt="image"></p><br><h3 id="demonstraciya">  D√©monstration </h3><br><p>  Il n'y a qu'un canal vid√©o (la cam√©ra reste au travail).  Je m'excuse de son absence, je la joindrai lundi. </p><br><img alt="Chapeau de jeu" width="400" src="https://habrastorage.org/webt/5q/yt/ox/5qytoxmp0ojxi7bheduksv8qipg.jpeg"><br><p>  Travail vid√©o: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/D6ZT90L6q00" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3 id="ishodnye-kody">  Code source </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Code source du serveur et du client</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Package de d√©marrage du serveur d√©mon</a> </p><br><h3 id="ssylki">  Les r√©f√©rences </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 1</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3e partie</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr462331/">https://habr.com/ru/post/fr462331/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr462321/index.html">R√©f√©rencement international | Facteurs de classement SEO internationaux</a></li>
<li><a href="../fr462323/index.html">Ob√©sit√© - D√©tendez-vous et impliquez</a></li>
<li><a href="../fr462325/index.html">Web Worker plus facile que vous ne le pensiez</a></li>
<li><a href="../fr462327/index.html">Squeak d'une tumeur canc√©reuse: les scientifiques de NUST ¬´MISiS¬ª ont d√©velopp√© une √©chographie laser pour le diagnostic du cancer</a></li>
<li><a href="../fr462329/index.html">D√©placement du bloc d'alimentation vers l'avant du ch√¢ssis</a></li>
<li><a href="../fr462333/index.html">Cr√©ation d'un chatbot de conversation simple en python</a></li>
<li><a href="../fr462335/index.html">Ne pas lire, relire</a></li>
<li><a href="../fr462337/index.html">Statistiques du site et votre petit r√©f√©rentiel</a></li>
<li><a href="../fr462339/index.html">Comment la formation manuelle est-elle li√©e aux normes internes d'Amazon et comment a-t-elle affect√© la vision du monde de l'entreprise?</a></li>
<li><a href="../fr462347/index.html">Les dix premiers jours sur le chemin d'un hibou √† un l√®ve-t√¥t: sommeil, alimentation, r√©gime et exercice</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>