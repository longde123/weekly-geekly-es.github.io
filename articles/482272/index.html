<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•à üì† ‚èÆÔ∏è Elecci√≥n de un almac√©n de datos para Prometheus: Thanos vs VictoriaMetrics üë©üèª‚Äçüé§ üîÇ üå∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos A continuaci√≥n se muestra una transcripci√≥n del informe con Big Monitoring Meetup 4 . 


 Prometheus es un sistema de monitoreo para vari...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Elecci√≥n de un almac√©n de datos para Prometheus: Thanos vs VictoriaMetrics</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482272/"><p>  Hola a todos  A continuaci√≥n se muestra una transcripci√≥n del <a href="https://www.youtube.com/watch%3Fv%3DHyOXAdQE0Pk" rel="nofollow">informe con Big Monitoring Meetup 4</a> . </p><br><p>  <strong><a href="https://github.com/prometheus" rel="nofollow">Prometheus</a></strong> es un sistema de monitoreo para varios sistemas y servicios, con el cual los administradores del sistema pueden recopilar informaci√≥n sobre los par√°metros actuales de los sistemas y configurar alertas para recibir notificaciones de desviaciones en la operaci√≥n de los sistemas. </p><br><p>  El informe comparar√° <a href="https://github.com/thanos-io/thanos" rel="nofollow">Thanos</a> y <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> , proyectos para el almacenamiento a largo plazo de m√©tricas Prometheus. </p><a name="habracut"></a><br><p><img src="https://habrastorage.org/webt/vm/ha/hd/vmhahdu2edj4dsc6o3lvzaf-noo.png"></p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/HyOXAdQE0Pk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p><img src="https://habrastorage.org/webt/op/ni/ao/opniaodpqcis34bw3f4-twdnsic.png"></p><br><p>  Primero, hablar√© sobre Prometeo.  Este es un sistema de monitoreo que recopila m√©tricas de objetivos dados y las guarda en el almacenamiento local.  Prometheus puede escribir m√©tricas en un repositorio remoto, puede generar alertas y reglas de grabaci√≥n. </p><br><p><img src="https://habrastorage.org/webt/dl/ji/yn/dljiynnywlw3fcjl7oc3m7lgstw.png"></p><br><h3 id="ogranicheniya-prometheus">  Limitaciones de Prometeo: </h3><br><ul><li>  No tiene una vista de consulta global.  Esto es cuando tienes varias instancias independientes de prometeo.  Recopilan m√©tricas.  Y desea realizar una solicitud adem√°s de todas estas m√©tricas recopiladas de diferentes instancias de prometheus.  Prometeo no permite esto. </li><li>  Con prometheus, el rendimiento se limita a un solo servidor.  Prometheus no puede escalar autom√°ticamente a varios servidores.  Solo puede dividir manualmente sus objetivos entre m√∫ltiples Prometheus. </li><li>  El volumen de m√©tricas en Prometheus se limita a un solo servidor por la misma raz√≥n por la que no puede escalar autom√°ticamente a varios servidores. </li><li>  En Prometheus, no es tan f√°cil organizar la seguridad de los datos. </li></ul><br><p><img src="https://habrastorage.org/webt/t3/wi/lf/t3wilf2sbn7ndupjqbe1wgxqrzw.png"></p><br><h3 id="resheniya-etih-problemzadach">  ¬øResolviendo estos problemas / desaf√≠os? </h3><br><p>  Las soluciones son: </p><br><ul><li>  <a href="https://github.com/thanos-io/thanos" rel="nofollow">Thanos</a> </li><li>  <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> </li><li>  <a href="https://github.com/m3db" rel="nofollow">Uber m3</a> </li><li>  <a href="https://github.com/cortexproject/cortex" rel="nofollow">Corteza</a> </li></ul><br><p>  Todas estas soluciones de almacenamiento remoto recopiladas por Prometheus.  Resuelven el problema de almacenamiento remoto de la diapositiva anterior de diferentes maneras.  En esta presentaci√≥n, solo hablar√© sobre las dos primeras soluciones: <a href="https://github.com/thanos-io/thanos" rel="nofollow">Thanos</a> y <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> . </p><br><p>  Por primera vez, la informaci√≥n sobre <a href="https://github.com/thanos-io/thanos" rel="nofollow">Thanos</a> apareci√≥ en <a href="https://improbable.io/blog/thanos-prometheus-at-scale" rel="nofollow">este enlace</a> .  Describe la arquitectura de <a href="https://github.com/thanos-io/thanos" rel="nofollow">Thanos</a> y c√≥mo funciona. </p><br><p><img src="https://habrastorage.org/webt/wg/bq/-b/wgbq-b3pwr1emeewan-q5hszprs.png"></p><br><p>  Thanos toma los datos que Prometheus guard√≥ en el disco local y los copia en S3, en <a href="https://cloud.google.com/storage/" rel="nofollow">GCS</a> o en otro almacenamiento de objetos. </p><br><p><img src="https://habrastorage.org/webt/p7/4g/rj/p74grj159fi9xb58vq-hphcrqyi.png"></p><br><p>  De esta manera, Thanos proporciona una vista de consulta global.  Puede solicitar datos almacenados en el almacenamiento de objetos desde m√∫ltiples instancias de Prometheus. </p><br><p><img src="https://habrastorage.org/webt/aj/3u/wi/aj3uwi8dd4wgy-fyogditn--kek.png"></p><br><p>  Thanos admite PromQL y la <a href="https://prometheus.io/docs/prometheus/latest/querying/api/" rel="nofollow">API de consulta Prometheus</a> . </p><br><p><img src="https://habrastorage.org/webt/sr/t7/ql/srt7qlyoruhbxr5wglfuyhi9jp4.png"></p><br><p>  Thanos usa el c√≥digo de Prometheus para almacenar datos. </p><br><p><img src="https://habrastorage.org/webt/3y/ws/ik/3ywsiklzziqimz1aig7uzieblqw.png"></p><br><p>  Thanos est√° siendo desarrollado por los mismos desarrolladores que Prometheus. </p><br><p>  Sobre <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> .  Aqu√≠ est√° el <a href="https://medium.com/faun/victoriametrics-creating-the-best-remote-storage-for-prometheus-5d92d66787ac" rel="nofollow">enlace</a> donde hablamos por primera vez sobre <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> . </p><br><p><img src="https://habrastorage.org/webt/z9/q2/wv/z9q2wvhshsoqb1ron0jx47djiwc.png"></p><br><p>  VictoriaMetrics recibe datos de varios prometeos a trav√©s del protocolo <a href="https://prometheus.io/docs/practices/remote_write/" rel="nofollow">API de escritura remota</a> compatible con Prometheus. </p><br><p><img src="https://habrastorage.org/webt/pl/xl/ad/plxladg1rdvyudc0wzs5oc2ljsa.png"></p><br><p>  VictoriaMetrics proporciona una vista de consulta global, ya que varias instancias de Prometheus pueden escribir datos en una VictoriaMetrics.  En consecuencia, puede realizar solicitudes para todos estos datos. </p><br><p><img src="https://habrastorage.org/webt/9l/cp/aw/9lcpawp68_pq2mrhzya9okprroy.png"></p><br><p>  VictoriaMetrics tambi√©n es compatible, como Thanos, PromQL y la API de consulta Prometheus. </p><br><p><img src="https://habrastorage.org/webt/d1/t1/ek/d1t1ek9rbq_ftlasl48scoriyq0.png"></p><br><p>  A diferencia de Thanos, el c√≥digo fuente de VictoriaMetrics est√° escrito desde cero y optimizado para la velocidad y los recursos. </p><br><p><img src="https://habrastorage.org/webt/ps/t6/gu/pst6guuoseu2dicx9tra1bvjhry.png"></p><br><p>  VictoriaMetrics, a diferencia de Thanos, se escala tanto vertical como horizontalmente.  Hay una <a href="" rel="nofollow">versi√≥n de nodo √∫nico</a> que se escala verticalmente.  Puede comenzar con un procesador y 1 GB de memoria y crecer gradualmente hasta cientos de procesadores y 1 TB de memoria.  VictoriaMetrics puede usar todos estos recursos.  Su rendimiento aumentar√° aproximadamente 100 veces en comparaci√≥n con un sistema de un solo n√∫cleo. </p><br><p><img src="https://habrastorage.org/webt/tb/s7/t4/tbs7t4unnruaytt7duwambgofne.png"></p><br><p>  La historia de Thanos comenz√≥ en noviembre de 2017, cuando apareci√≥ el primer compromiso p√∫blico.  Antes de esto, Thanos fue desarrollado internamente por <a href="https://improbable.io/" rel="nofollow">improbable.io</a> . </p><br><p><img src="https://habrastorage.org/webt/ik/g7/dg/ikg7dgnmbyiph40zo7v7kyhxrdy.png"></p><br><p>  En junio de 2019, hubo una versi√≥n hist√≥rica 0.5.0, en la que se <a href="https://thanos.io/proposals/201809_gossip-removal.md/" rel="nofollow">elimin√≥ el</a> protocolo de <a href="https://en.wikipedia.org/wiki/Gossip_protocol" rel="nofollow">chismes</a> .  Fue retirado de Thanos porque no hizo lo mejor que pudo.  A menudo, el cl√∫ster de Thanos no funcionaba correctamente, los nodos se conectaban incorrectamente debido al protocolo de chismes.  Por lo tanto, decidieron eliminarlo de all√≠.  Creo que esta es la decisi√≥n correcta. </p><br><p><img src="https://habrastorage.org/webt/5y/bu/cu/5ybucuovkh85tqwsrv3cjre-zmu.png"></p><br><p>  Tambi√©n en junio de 2019, enviaron la solicitud n√∫mero <a href="https://github.com/cncf/toc/pull/256" rel="nofollow">256</a> a la <a href="https://www.cncf.io/" rel="nofollow">Cloud Native Computing Foundation</a> . </p><br><p><img src="https://habrastorage.org/webt/16/rz/x_/16rzx_bswddquoqw4cmw9txobxa.png"></p><br><p>  Y despu√©s de un par de meses, Thanos se uni√≥ a la <a href="https://www.cncf.io/" rel="nofollow">Cloud Native Computing Foundation</a> , que incluye a Prometheus, Kubernetes y otros proyectos populares. </p><br><p><img src="https://habrastorage.org/webt/9c/i2/ic/9ci2ictg_n0xtgdcxtklghw4n2w.png"></p><br><p>  En enero de 2018, comenz√≥ el desarrollo de VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/wi/li/co/wiliconuw5mwhyzizzthqk8a2og.png"></p><br><p>  En septiembre de 2018, primero mencion√© p√∫blicamente VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/gd/th/ka/gdthkaxubi8jzg8gedilcotjdje.png"></p><br><p>  En diciembre de 2018, se public√≥ la versi√≥n de nodo √∫nico. </p><br><p><img src="https://habrastorage.org/webt/ui/r7/23/uir723wmd-l1dwxds6katr8cfco.png"></p><br><p>  En mayo de 2019 <a href="https://blog.usejournal.com/open-sourcing-victoriametrics-f31e34485c2b" rel="nofollow">, se publicaron las</a> fuentes de las versiones Single-node y cluster. </p><br><p><img src="https://habrastorage.org/webt/a7/tk/ug/a7tkughz1ut9dmlfb6ued1irbh8.png"></p><br><p>  En junio de 2019, al igual que Thanos, aplicamos a la fundaci√≥n CNCF en el n√∫mero <a href="https://github.com/cncf/toc/pull/255" rel="nofollow">255</a> .  Solicitamos un d√≠a antes de que Thanos aplicara. </p><br><p><img src="https://habrastorage.org/webt/pk/dm/zr/pkdmzr2xn880osldinx6sb10-ai.png"></p><br><p>  Pero, desafortunadamente, todav√≠a no hemos sido aceptados all√≠.  Necesito ayuda de la comunidad. </p><br><p><img src="https://habrastorage.org/webt/mw/2w/we/mw2wwenfu8tecrrkyrkx-8dhf-8.png"></p><br><p>  Considere las diapositivas m√°s importantes que muestran la arquitectura de Thanos y VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/1w/by/96/1wby96ev7cqhx7-psbem1b-bf-i.png"></p><br><p>  Comencemos con Thanos.  Los componentes amarillos son componentes de Prometeo.  Todo lo dem√°s son los componentes de Thanos.  Comencemos con el componente m√°s importante.  Thanos Sidecar es un componente que se instala junto a cada Prometheus.  Est√° comprometido a cargar datos de Prometheus del almacenamiento local en S3 o en otro Object Storage. </p><br><p>  Tambi√©n existe un componente como Thanos Store Gateway, que puede leer estos datos desde Object Storage a las solicitudes entrantes de Thanos Query.  Thanos Query implementa PromQL y la API Prometheus.  Es decir, desde afuera parece un Prometeo.  Acepta consultas de PromQL, las env√≠a a Thanos Store Gateway, Thanos Store Gateway recupera los datos necesarios del Object Storage y los devuelve. </p><br><p>  Pero hemos almacenado datos en Object Storage sin las √∫ltimas dos horas debido a la peculiaridad de la implementaci√≥n de Thanos Sidecar, que no puede cargar las √∫ltimas dos horas en Object Storage S3, porque durante estas dos horas Prometheus a√∫n no ha creado archivos en el almacenamiento local. </p><br><p>  ¬øC√≥mo decidieron evitar esto?  Thanos Query, adem√°s de las solicitudes de Thanos Store Gateway, env√≠a solicitudes paralelas a cada Thanos Sidecar ubicado junto a Prometheus. </p><br><p>  Y Thanos Sidecar, a su vez, representa solicitudes adicionales en Prometheus y obtiene datos de las √∫ltimas dos horas. </p><br><p>  Adem√°s de estos componentes, tambi√©n hay un componente opcional sin el cual Thanos no se sentir√° bien.  Este es Thanos Compact, que combina archivos peque√±os en Object Storage en archivos m√°s grandes que Thanos Sidecar ha subido aqu√≠.  Thanos Sidecar carga archivos de datos all√≠ en dos horas.  Estos archivos, si no los fusiona en archivos m√°s grandes, entonces su n√∫mero puede crecer significativamente.  Cuantos m√°s archivos de este tipo, m√°s memoria se necesita para Thanos Store Gateway, m√°s recursos se necesitan para transferir datos a trav√©s de la red, metadatos.  Thanos Store Gateway se est√° volviendo ineficiente.  Por lo tanto, definitivamente debe ejecutar Thanos Compact, que combina archivos peque√±os en archivos m√°s grandes para que haya menos archivos y reducir la sobrecarga en Thanos Store Gateway. </p><br><p>  Tambi√©n existe un componente como Thanos Ruler.  Sigue las reglas de alerta de Prometheus y puede calcular las reglas de grabaci√≥n de Prometheus para volver a escribir datos en Object Storage.  Pero este componente no es recomendable, porque  √©l est√° <a href="" rel="nofollow">inclinado a devolver datos incompletos</a> . </p><br><p>  Este es un esquema simple para Thanos. </p><br><p><img src="https://habrastorage.org/webt/os/em/y4/osemy4ys_bkpy-ngxj7jg-gdmom.png"></p><br><p>  Ahora compare con el esquema VictoriaMetrics. </p><br><p>  VictoriaMetrics tiene 2 versiones: versi√≥n de nodo √∫nico y de cl√∫ster.  El nodo √∫nico se ejecuta en una sola computadora.  El nodo √∫nico no tiene estos componentes, solo un binario.  Este binario en la diapositiva se parece a este cuadrado.  Todo lo que est√° dentro del cuadrado es el contenido del archivo binario para la versi√≥n de nodo √∫nico.  No necesitas saber sobre √©l.  Simplemente inicie el binario, y todo funciona para nosotros. </p><br><p>  La versi√≥n del cl√∫ster es m√°s complicada.  En su interior hay tres componentes diferentes: vmselect, vminsert y vmstorage.  Por su nombre, debe quedar claro lo que cada uno de ellos hace.  El componente Insert acepta datos en diferentes formatos: desde la API de escritura remota Prometheus, el protocolo de l√≠nea Influx, el protocolo Graphite y el protocolo OpenTSDB.  El componente Insertar los acepta, los analiza y los distribuye entre los componentes de almacenamiento existentes, donde los datos ya est√°n almacenados.  El componente Seleccionar, a su vez, acepta consultas PromQL.  Implementa <a href="https://medium.com/%40valyala/promql-tutorial-for-beginners-9ab455142085" rel="nofollow">PromQL</a> , as√≠ como la API de consulta de Prometheus, y puede usarse como un reemplazo para Prometheus en Grafana u otros clientes de la API de Prometheus.  Select acepta una solicitud promql, la analiza, lee los datos necesarios para ejecutar esta solicitud desde el nodo de almacenamiento, procesa estos datos y devuelve una respuesta. </p><br><p><img src="https://habrastorage.org/webt/sb/co/mx/sbcomx2usdrwzbyfgqjubvoichg.png"></p><br><p>  Compare la dificultad de instalar Thanos y VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/hv/gw/r6/hvgwr6nk7yh4nog7rpjac4fn0se.png"></p><br><p>  Comencemos con Thanos.  Antes de comenzar a trabajar con Thanos, debe crear un dep√≥sito en Object Storage, como S3 o GCS, para que Thanos Sidecar pueda escribir datos all√≠. </p><br><p><img src="https://habrastorage.org/webt/st/hk/5s/sthk5swss1mkaalb4p3oiebnesq.png"></p><br><p>  Luego, para cada Prometheus necesita instalar Thanos Sidecar.  Antes de eso, debe recordar deshabilitar la compactaci√≥n de datos en Prometheus.  La compactaci√≥n de datos comprime peri√≥dicamente los datos en el almacenamiento local de Prometheus para reducir el consumo de recursos. </p><br><p>  Cuando instala Thanos Sidecar en su Prometheus, debe desactivar esta compactaci√≥n de datos, porque Thanos Sidecar no puede funcionar normalmente cuando la compactaci√≥n de datos est√° activada.  Esto significa que su Prometheus comienza a guardar datos en bloques de dos horas y deja de fusionar estos bloques en bloques m√°s grandes.  En consecuencia, si realiza solicitudes que son m√°s largas que las √∫ltimas dos horas, no funcionar√°n tan eficientemente como podr√≠an si se habilitara la compactaci√≥n de datos. </p><br><p><img src="https://habrastorage.org/webt/gd/as/pw/gdaspwys_r63cegoxqovl9bcmie.png"></p><br><p>  Por lo tanto, Thanos recomienda reducir el tiempo de retenci√≥n de datos en el almacenamiento local a 6-8 horas para reducir esta sobrecarga de una gran cantidad de peque√±os bloques. </p><br><p>  Despu√©s de instalar Thanos Sidecar, debe instalar dos componentes para cada Dep√≥sito de almacenamiento de objetos.  Estos son Thanos Compactor y Thanos Store Gateway. </p><br><p><img src="https://habrastorage.org/webt/cw/4f/yk/cw4fyksvnkmp1tcn-clf-2gzx3q.png"></p><br><p>  Despu√©s de eso, debe instalar Thanos Query y configurarlo para que sepa c√≥mo conectarse a todos los Thanos Store Gateway que tiene, y tambi√©n sabe c√≥mo conectarse a todos los Thanos Sidecar. </p><br><p>  Puede haber un peque√±o problema. </p><br><p><img src="https://habrastorage.org/webt/vf/sc/30/vfsc30z00pvcnupbdym2jztx09k.png"></p><br><p>  Debe configurar una conexi√≥n confiable y segura de Thanos Query a estos componentes.  Y si su Prometheus est√° ubicado en diferentes centros de datos, o en diferentes VPC, entonces est√°n prohibidas las conexiones externas a ellos.  Pero para que Thanos Query funcione, debe configurar de alguna manera la conexi√≥n all√≠, y tiene que encontrar una manera. </p><br><p>  Si tiene muchos de estos centros de datos, entonces, en consecuencia, la confiabilidad de todo el sistema disminuye.  Dado que Thanos Query debe mantenerse constantemente conectado a todos los Sidecar de Thanos ubicados en diferentes centros de datos.  Con cada solicitud entrante, enviar√° solicitudes a todos los Sidecar de Thanos.  Si se interrumpe la conexi√≥n, recibir√° un conjunto de datos incompleto u obtendr√° la respuesta "el cl√∫ster no funciona". </p><br><p><img src="https://habrastorage.org/webt/rb/ka/aw/rbkaawevhardp1d85mhgdejylxg.png"></p><br><p>  En VictoriaMetrics, las cosas son un poco m√°s f√°ciles.  Para la versi√≥n de nodo √∫nico, es suficiente con ejecutar un binario y todo funciona. </p><br><p><img src="https://habrastorage.org/webt/co/ui/ll/couillafhtmobnbutejgs6qvszu.png"></p><br><p>  En una versi√≥n en cl√∫ster, es suficiente ejecutar todos los tres tipos de componentes anteriores en cualquier cantidad que necesite, o usar el <a href="https://github.com/VictoriaMetrics/helm-charts/" rel="nofollow">gr√°fico de tim√≥n</a> para automatizar el lanzamiento de componentes en Kubernetes.  Todav√≠a estamos planeando hacer un operador de Kubernetes.  El gr√°fico de tim√≥n no cubre algunos casos y le permite dispararle a la pierna.  Por ejemplo, le permite reducir la cantidad de nodos de almacenamiento, lo que conducir√° a la p√©rdida de datos. </p><br><p><img src="https://habrastorage.org/webt/jb/ta/0t/jbta0t7qcko6jov_x1ximqkfni0.png"></p><br><p>  Despu√©s de haber lanzado una versi√≥n binaria o de cl√∫ster, solo necesita agregar la <a href="" rel="nofollow">configuraci√≥n para la URL de escritura remota</a> a la configuraci√≥n de Prometheus para que comience a escribir datos en paralelo al almacenamiento local y al almacenamiento remoto.  Como not√≥, esta configuraci√≥n deber√≠a funcionar de manera mucho m√°s confiable en comparaci√≥n con la configuraci√≥n de Thanos.  No necesitamos mantener VictoriaMetrics conectado a todos los Prometheus, porque los Prometheus se conectan a VictoriaMetrics y transmiten los datos. </p><br><p><img src="https://habrastorage.org/webt/u3/3a/if/u33aifuu7myx3vvs0mkbeysfnei.png"></p><br><p>  Considere las escoltas de Thanos y VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/fq/dt/d2/fqdtd27cjx-yktnyozgxoon2pte.png"></p><br><p>  Thanos necesita vigilar Sidecar para que no deje de cargar datos en Object Storage.  Pueden detener esta carga de datos debido a errores de carga, por ejemplo, su conexi√≥n de red con Object Storage se desconecta temporalmente o Object Storage no est√° disponible temporalmente.  Thanos Sidecar en este momento lo notar√°, informar√° un error, puede caerse y luego dejar de funcionar.  Si no lo controla, sus datos ya no se transferir√°n al Almacenamiento de objetos.  Si el tiempo de retenci√≥n pasa (se recomiendan 6-8 horas), perder√° los datos que no cayeron en el Almacenamiento de objetos. </p><br><p><img src="https://habrastorage.org/webt/z7/bm/cx/z7bmcxgwyscnrnnehhtjvuqipho.png"></p><br><p>  Los compactadores Thanos pueden dejar de funcionar debido a la <a href="https://github.com/thanos-io/thanos/issues/1919" rel="nofollow">carrera con Sidecar</a> .  Los compactadores toman datos del Almacenamiento de objetos y los fusionan en grandes cantidades de datos.  Dado que los compactadores no est√°n sincronizados con el Sidecar, esto puede suceder: Sidecar a√∫n no ha terminado de escribir el bloque, Compactor decide que este bloque est√° completamente grabado.  Compactor comienza a leerlo.  No lee el bloque en su totalidad y deja de funcionar.  Ver detalles <a href="https://thanos.io/proposals/201901-read-write-operations-bucket.md/" rel="nofollow">aqu√≠</a> . </p><br><p><img src="https://habrastorage.org/webt/_u/c6/hb/_uc6hbgr_kl9l2an5yl0cs9hfba.png"></p><br><p>  Store Gateway puede proporcionar datos inconsistentes debido a la carrera entre Compactor y Sidecar.  Esto es lo mismo, porque Store Gateway no est√° de ninguna manera sincronizado con Compactor y Sidecar.  En consecuencia, puede ocurrir una condici√≥n de carrera cuando Store Gateway no ve parte de los datos o ve un exceso de datos. </p><br><p><img src="https://habrastorage.org/webt/-y/20/ur/-y20urze7qgwxkrklj8ave_ct3i.png"></p><br><p>  El componente de consulta en Thanos se predetermina a resultados parciales si alg√∫n Sidecar o Gateway de tienda no est√°n disponibles actualmente.  Recibir√° una parte de los datos y ni siquiera sabr√° que no se recibieron todos los datos.  Que funciona as√≠ por defecto.  En una situaci√≥n similar, VictoriaMetrics devuelve los datos marcados como parciales. </p><br><p><img src="https://habrastorage.org/webt/2g/op/wp/2gopwpbh41vviugdebarsjuql4w.png"></p><br><p>  A diferencia de Thanos, VictoriaMetrics rara vez pierde datos.  Incluso si se interrumpe la conexi√≥n de Prometheus a VictoriaMetrics, esto no es un problema, ya que Prometheus contin√∫a registrando datos nuevos entrantes en Write Ahead Log, que tiene un tama√±o de 2 horas.  Si se vuelve a conectar a VictoriaMetrics en dos horas, los datos no se perder√°n.  Prometheus <a href="https://grafana.com/blog/2019/03/25/whats-new-in-prometheus-2.8-wal-based-remote-write/" rel="nofollow">puede agregar datos despu√©s de volver a conectarse a VictoriaMetrics</a> . </p><br><p><img src="https://habrastorage.org/webt/kg/nl/mv/kgnlmvkqxfagsjhodoybpwzl7am.png"></p><br><p>  A diferencia de Thanos, que solo escribe datos en el almacenamiento de objetos despu√©s de dos horas, Prometheus replica autom√°ticamente los datos a trav√©s del protocolo de escritura remota en el almacenamiento remoto, como VictoriaMetrics.  No tiene miedo de perder el almacenamiento local en Prometheus.  Si de repente perdi√≥ el almacenamiento local, en el peor de los casos perder√° los √∫ltimos segundos de datos que no tuvieron tiempo de escribir en el almacenamiento remoto. </p><br><p><img src="https://habrastorage.org/webt/ba/xj/90/baxj90beqmojti9xkubodbkbvdw.png"></p><br><p>  Kubernetes gestiona autom√°ticamente el cl√∫ster, a diferencia de Thanos.  Todos los componentes de Thanos son dif√≠ciles de colocar en un solo cl√∫ster de Kubernetes, a diferencia de los componentes del cl√∫ster VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/gz/lb/6l/gzlb6lg2dkrabcovqcohvovd-mk.png"></p><br><p>  VictoriaMetrics tiene una actualizaci√≥n muy simple a la nueva versi√≥n.  Simplemente detenga VictoriaMetrics, actualice los binarios y ejecute.  Al detenerse a trav√©s de una se√±al SIGINT, todos los binarios de VictoriaMetrics se apagan con gracia.  Guardan correctamente los datos necesarios, cierran correctamente las conexiones entrantes para no perder nada.  Por lo tanto, no perder√° nada al actualizar. </p><br><p><img src="https://habrastorage.org/webt/qz/yf/8c/qzyf8cvpqlimwabno0zx7v5_rxw.png"></p><br><p>  VictoriaMetrics tiene una forma muy simple de expandir un cl√∫ster.  Simplemente agregue los componentes necesarios y contin√∫e trabajando. </p><br><p><img src="https://habrastorage.org/webt/hl/le/sj/hllesjwiv-f1wosgssd7wp6aclo.png"></p><br><p>  Sobre las trampas en Thanos y Victoria Metrics. </p><br><p><img src="https://habrastorage.org/webt/xs/ec/b0/xsecb0yy15vimtsl9k9quqplyiw.png"></p><br><p>  Thanos tiene las siguientes trampas.  Prometheus deber√≠a almacenar datos de las √∫ltimas dos horas.  Si se pierden, los perder√° por completo, ya que a√∫n no han logrado registrarse en Object Storage, como S3. </p><br><p><img src="https://habrastorage.org/webt/fg/xo/yo/fgxoyo1q8mihcdy7m_yyio_pyum.png"></p><br><p>  El componente Store Gateway y el componente compactador pueden requerir mucha memoria para funcionar con el almacenamiento de objetos grandes si se almacenan all√≠ muchos archivos peque√±os.  Cuanto mayor sea el n√∫mero y el volumen de archivos, se necesitar√° m√°s Store Gateway y memoria del compactador para almacenar la metainformaci√≥n.  Thanos tiene muchos problemas sobre <a href="https://github.com/thanos-io/thanos/issues/448" rel="nofollow">Store Gateway y la ca√≠da del compactador con datos grabados promedio</a> . </p><br><p><img src="https://habrastorage.org/webt/-n/k3/rg/-nk3rgph8ghszyegz1j8jx89bio.png"></p><br><p>  Se afirma que Thanos puede escalar indefinidamente por la cantidad de su Prometeo.  Esto en realidad no es cierto.  Como todas las solicitudes pasan por el componente Consulta, que debe sondear simult√°neamente todos los componentes de Store Gateway y todos los componentes de Sidecar, extraiga los datos de all√≠ y luego preprocese.  Obviamente, la velocidad de consulta est√° limitada por el enlace d√©bil m√°s lento, el Gateway de tienda m√°s lento o el Sidecar m√°s lento. </p><br><p>  Estos componentes pueden estar cargados de manera desigual.  Por ejemplo, tiene un Prometheus que recopila millones de m√©tricas por segundo.  Y est√° Prometheus, que recopila miles de m√©tricas por segundo.  Prometheus, que recopila millones de m√©tricas por segundo, carga el servidor en el que se ejecuta mucho m√°s.  En consecuencia, Sidecar es m√°s lento all√≠.  En general, todo funciona lentamente all√≠.  Y el componente Consulta extraer√° datos muy lentamente desde all√≠.  En consecuencia, el rendimiento de todo su cl√∫ster estar√° limitado por este Sidecar lento. </p><br><p><img src="https://habrastorage.org/webt/mg/an/ra/mganracsmhkyz1_1aq014v_6cfc.png"></p><br><p>  De forma predeterminada, Thanos devuelve datos parciales si algunos Sidecar y Store Gateway no est√°n disponibles.  Por ejemplo, si tiene un Sidecar disperso por todo el mundo en diferentes centros de datos, entonces la probabilidad de una desconexi√≥n y la falta de disponibilidad de componentes aumenta enormemente.  En consecuencia, en la mayor√≠a de los casos, recibir√° datos parciales sin siquiera saberlo. </p><br><p><img src="https://habrastorage.org/webt/1t/m2/j7/1tm2j75o5cpscbevahbz4m0wusk.png"></p><br><p>  VictoriaMetrics tambi√©n tiene dificultades.  El primer escollo es una opci√≥n que limita la cantidad de RAM utilizada para el cach√© VictoriaMetrics.  Por defecto, es igual al 60% de la RAM en la m√°quina donde se ejecuta VictoriaMetrics, o el 60% de la RAM de pod VictoriaMetrics en Kubernetes. </p><br><p>  Si cambia incorrectamente este valor, puede arruinar el rendimiento de VictoriaMetrics.  Por ejemplo, si establece el valor demasiado bajo, es posible que los datos ya no quepan en el cach√© VictoriaMetrics.  Debido a esto, tendr√° que hacer un trabajo extra y cargar el procesador con el disco.  Si hace que esta opci√≥n sea demasiado grande, aumenta, en primer lugar, la probabilidad de que VictoriaMetrics se bloquee con un error de falta de memoria y, en segundo lugar, esto llevar√° a que quede muy poca memoria operativa en el sistema operativo memoria para el cach√© de archivos.  Y VictoriaMetrics se basa en un cach√© de archivos para el rendimiento.  Si no es suficiente, la carga en el disco puede aumentar considerablemente.  Por lo tanto, un consejo: no cambie el par√°metro a menos que sea absolutamente necesario. </p><br><p><img src="https://habrastorage.org/webt/3q/eo/25/3qeo25x5juqpyquhllrhpt9eh34.png"></p><br><p>  La segunda opci√≥n.  Este es el per√≠odo de retenci√≥n: el per√≠odo establecido de forma predeterminada en 1 mes.  Este es el momento en que VictoriaMetrics almacena datos.  Despu√©s de este per√≠odo, VictoriaMetrics elimina los datos. </p><br><p>  Muchos ejecutan VictoriaMetrics sin este par√°metro, registran datos durante un mes.  Y luego preguntan: ¬øpor qu√© desaparecieron los datos del mes anterior?  Porque el Per√≠odo de retenci√≥n es de 1 mes por defecto.  Por lo tanto, debe conocer y establecer el per√≠odo de retenci√≥n correcto. </p><br><p><img src="https://habrastorage.org/webt/n1/5a/jm/n15ajmeqozq7zfzc0uv3imzfebw.png"></p><br><p>  Pasemos por oportunidades √∫nicas. </p><br><p><img src="https://habrastorage.org/webt/k8/b7/br/k8b7brhqxwy1fa1vdurx0yolgra.png"></p><br><p>  Thanos tiene una funci√≥n como el muestreo descendente: intervalos de 5 minutos y horas, que a menudo <a href="https://github.com/thanos-io/thanos/issues%3Futf8%3D%25E2%259C%2593%26q%3Dis%253Aissue%2Bis%253Aopen%2Bdownsampling" rel="nofollow">no funcionan correctamente</a> .  Si lo buscas en Google y miras su problema en Github, hay muchos problemas relacionados con este muestreo, que a veces no funciona correctamente o no funciona como los usuarios esperan. </p><br><p><img src="https://habrastorage.org/webt/iv/nq/4v/ivnq4vtxkkwf_1hs40ttkyhd1ie.png"></p><br><p>  Thanos tiene deduplicaci√≥n de datos para pares Prometheus HA.  Cuando dos Prometheus'a recopilan las mismas m√©tricas del mismo objetivo 'y Thanos las coloca en Almacenamiento de objetos. Thanos     ,    VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/wn/rv/jh/wnrvjhzqrcx6_o9hoojijeivb8o.png"></p><br><p>  Thanos  alert ,     Thanos.   <a href="" rel="nofollow">    production</a> . </p><br><p><img src="https://habrastorage.org/webt/ti/qp/ci/tiqpcidg_t_ahj9lornrey8_rda.png"></p><br><p>  Thanos ,    Thanos   Prometheus ‚Äî . Thanos  Prometheus      .    Thanos  Prometheus   . </p><br><p><img src="https://habrastorage.org/webt/en/vo/o-/envoo-2amya3w4xo2c5lg-pa1bo.png"></p><br><p>  VictoriaMetrics    ‚Äî MetricsQL.   VictoriaMetrics  PromQL,       big monitoring metup. </p><br><p><img src="https://habrastorage.org/webt/yk/xq/hi/ykxqhipgapygdv7ra2c6rmaitnk.png"></p><br><p> VictoriaMetrics       . VictoriaMetrics       Prometheus,     Influx, OpenTSDB  Graphite. </p><br><p><img src="https://habrastorage.org/webt/0k/zy/jp/0kzyjptb5sbscny1ffsdh2irqau.png"></p><br><p>  VictoriaMetrics         Thanos  Prometheus. </p><br><p>    ,     2-5          Prometheus  Thanos. </p><br><p><img src="https://habrastorage.org/webt/2y/xz/yg/2yxzygpbfnqt3ldibpggeo35rpw.png"></p><br><p>    VictoriaMetrics ‚Äî    . </p><br><p><img src="https://habrastorage.org/webt/kk/jd/hy/kkjdhy-zae6bc_3uqu6yp3q1gwy.png"></p><br><p>    . </p><br><p><img src="https://habrastorage.org/webt/79/yz/yw/79yzywujo1uxm6zc5rti6ebjzpq.png"></p><br><p>    Thanos  ,      object storage,   . </p><br><p>     object storage,         ($10   ).      object storage,          ,       AWS ‚Äî  .    ,    $10  $230  1.    ,        Thanos . </p><br><p><img src="https://habrastorage.org/webt/eg/--/mv/eg--mv_wpjcv4m-tojp8l9r60ea.png"></p><br><p>  Thanos      Compact, Store Gateway, Query ,    ,     . </p><br><p><img src="https://habrastorage.org/webt/pz/0v/np/pz0vnpflfebkxmaqi3sbbucktz0.png"></p><br><p>  VictoriaMetrics  .     GCE HDD ,   $40  1.  VictoriaMetrics   HDD ,    SSD,      . VictoriaMetrics   HDD. </p><br><p><img src="https://habrastorage.org/webt/dr/6q/lz/dr6qlzowqew8et2zpev1wkrq4cs.png"></p><br><p> VictoriaMetrics necesita servidores para componentes: ya sea Single-nod o para componentes de cl√∫ster, que, a diferencia de los componentes de Thanos, requieren mucha menos CPU, RAM, ser√° m√°s barato en consecuencia. </p><br><p><img src="https://habrastorage.org/webt/ja/72/cr/ja72crhogqpdixrt8jzj-komdcq.png"></p><br><p>  Ejemplos de implementaci√≥n. </p><br><p><img src="https://habrastorage.org/webt/od/ji/fw/odjifwunkpjdwuqq-hbpwswu_cy.png"></p><br><p>  El ejemplo de implementaci√≥n de Thanos es Gitlab.  Gitlab es totalmente alimentado por Thanos.  Pero no es tan suave.  Si observa sus <a href="https://gitlab.com/gitlab-com/gl-infra/infrastructure/issues/8647" rel="nofollow">problemas</a> , puede ver que constantemente tienen alg√∫n tipo de <a href="https://gitlab.com/gitlab-com/gl-infra/infrastructure/issues/8413" rel="nofollow">problemas operativos con Thanos</a> : no hay suficiente memoria para los componentes de Store Gateway o Query.  Constantemente tienen que aumentar la cantidad de memoria. </p><br><p>  Debido a esto, los costos de resolver estos problemas aumentan. </p><br><p>  La segunda implementaci√≥n, que puede ser m√°s exitosa, es la compa√±√≠a Improbable, que comenz√≥ el desarrollo de Thanos.  Publicaron la fuente de Thanos.  Improbable es una empresa que desarrolla motores de juego. </p><br><p><img src="https://habrastorage.org/webt/t4/yh/y4/t4yhy4gyfrimyzyfopgdwk1ixyc.png"></p><br><p>  Los ejemplos p√∫blicos de implementaci√≥n de VictoriaMetrics son: </p><br><ul><li>  creador de sitios wix.com </li><li>  Adidas presenta VictoriaMetrics e incluso realiz√≥ una presentaci√≥n en la √∫ltima PromCon 2019 </li><li>  TrafficStars - red publicitaria </li><li>  Seznam.cz es un popular motor de b√∫squeda checo. </li></ul><br><p>  Y luego fui al nombre de la compa√±√≠a, que no puedo nombrar ahora.  No estuvieron de acuerdo. </p><br><ul><li>  Uno de los principales desarrolladores de juegos.  M√°s grande que ellos Improbable. </li><li>  Un importante desarrollador de software gr√°fico. </li><li>  Gran banco ruso. </li><li>  Fabricante europeo de turbinas e√≥licas que ha probado con √©xito VictoriaMetrics.  Este fabricante implementa VictoriaMetrics para monitorear los datos de las turbinas e√≥licas a una velocidad de 50 muestras por segundo por sensor.  Cada turbina e√≥lica tiene varios cientos de sensores.  Tienen varios cientos de aerogeneradores. </li><li>  Aerol√≠neas rusas que quieren presentar VictoriaMetrics, pero a√∫n no pueden.  Estamos en la etapa de contrato con ellos. </li></ul><br><p><img src="https://habrastorage.org/webt/lw/0f/r3/lw0fr3hdyce3yw6n0i3ywjnpxhs.png">  Conclusiones </p><br><p>  VictoriaMetrics y Thanos resuelven problemas similares, pero de diferentes maneras: </p><br><ul><li>  Vista de consulta global </li><li>  escala horizontal </li><li>  retenci√≥n arbitraria </li></ul><br><p><img src="https://habrastorage.org/webt/pv/-b/ob/pv-bobndxjkjrcukph5xm3sa-98.png"></p><br><p>  Gracias </p><br><p>  Te esperamos en nuestro <a href="https://t.me/VictoriaMetrics_ru1" rel="nofollow">canal de telegramas</a> . </p><br><p><img src="https://habrastorage.org/webt/gu/0s/w5/gu0sw56ppge1icdy-ensv-wl3f4.png"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/482272/">https://habr.com/ru/post/482272/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../482258/index.html">C√≥mo funcionan las redes neuronales y por qu√© comenzaron a traer mucho dinero</a></li>
<li><a href="../482260/index.html">TelegramBot. La funcionalidad b√°sica. Pegatinas y emoticones. (Parte 3)</a></li>
<li><a href="../482262/index.html">C√≥mo iniciar sesi√≥n en Talend Open Studio</a></li>
<li><a href="../482264/index.html">Brasil, magia oscura, Mortal Kombat, Marte y 15,000 personas. Resultados del a√±o de Ontiko</a></li>
<li><a href="../482268/index.html">Megaestructuras del futuro: la esfera Dyson, el motor estelar y la "bomba de agujero negro"</a></li>
<li><a href="../482274/index.html">5 razones por las que debe dejar de usar System.Drawing en ASP.NET</a></li>
<li><a href="../482276/index.html">GOST R 57580. De las tendencias a la automatizaci√≥n eficiente</a></li>
<li><a href="../482280/index.html">¬øC√≥mo se hace el cosplay? Traje de traje avanzado de Isaac Clarke de Dead Space 2</a></li>
<li><a href="../482282/index.html">El final de la era ARMv7 o un poco sobre portar juegos</a></li>
<li><a href="../482284/index.html">"50 tonos de marr√≥n" o "¬øC√≥mo llegamos a esto?"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>