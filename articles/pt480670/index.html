<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîõ üè∫ üåû PM2: abordar a quest√£o do gerenciamento de processos com sabedoria üßîüèæ üï∫üèª üìß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° algumas horas, iniciei um debate sobre o fato de o Node.JS ser muito lento para grandes projetos e preferir Golang, Rust, PHP etc. O principal argu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PM2: abordar a quest√£o do gerenciamento de processos com sabedoria</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480670/"> H√° algumas horas, iniciei um debate sobre o fato de o Node.JS ser muito lento para grandes projetos e preferir Golang, Rust, PHP etc.  O principal argumento do lado oposto nessa disputa foi o fato de o JavaScript ser de thread √∫nico.  Alegadamente, ao desenvolver um aplicativo, a produtividade simplesmente repousa contra esse encadeamento √∫nico e nada pode mais ser feito - apenas reescreva-o em outro idioma.  No entanto, as coisas s√£o um pouco melhores com o NodeJS do que parece √† primeira vista.  Antes de nos aprofundarmos neste t√≥pico, quero declarar que respeito o direito de cada desenvolvedor de usar a linguagem de programa√ß√£o que ele gostava e que ele considera prefer√≠vel em uma tarefa espec√≠fica. <br><br>  Tendo pesquisado por uma palavra-chave "PM2" em Habr, n√£o encontrei nenhum artigo dedicado a esse gerente de processos.  Apenas refer√™ncias √∫nicas em artigos de outros usu√°rios.  Fiquei empolgado (fortemente informado) com a id√©ia de atualizar e esclarecer esse canto escuro do desenvolvimento de back-end no Node.JS (que muitas pessoas conhecem, sim, eu sei).  Pe√ßo a todos os interessados ‚Äã‚Äãem gato. <br><br><a name="habracut"></a><br><br><h2>  Algumas palavras sobre o pr√≥prio PM2 </h2><br><br>  O PM2 √© um gerenciador de processos de c√≥digo aberto licenciado sob a licen√ßa AGPL-3.0.  No momento da reda√ß√£o deste artigo, ele possui ~ 350k downloads semanais, de acordo com o NPM.  Ele √© usado principalmente em ambientes em que voc√™ precisa executar um aplicativo no NodeJS e esquec√™-lo (voc√™ tamb√©m pode us√°-lo com outros idiomas, mas mais adiante), o que permite agrupar o aplicativo e distribuir de forma flex√≠vel a carga entre os n√∫cleos do processador.  Um pequeno recorte do <a href="https://github.com/Unitech/pm2" rel="nofollow">reposit√≥rio PM2 no GitHub</a> : <br><br><blockquote>  O PM2 √© um gerenciador de processos de produ√ß√£o para aplicativos Node.js. com um balanceador de carga interno.  Ele permite manter os aplicativos ativos para sempre, recarreg√°-los sem tempo de inatividade e facilitar tarefas comuns de administra√ß√£o do sistema. </blockquote><br><br>  Ao desenvolver, muitos rec√©m-chegados encontram um problema quando, depois de "distribuir" o aplicativo para o servidor de produ√ß√£o, n√£o sabem como inici√°-lo "para sempre".  Eles escrevem <code>set NODE_ENV=production &amp;&amp; node app.js</code> no console SSH, est√° tudo bem, o aplicativo funciona.  Feche o console e o aplicativo n√£o funcionar√° mais.  Pergunta sobre o StackOverflow - <a href="https://stackoverflow.com/questions/12701259/how-to-make-a-node-js-application-run-permanently" rel="nofollow">Como executar o aplicativo node.js permanentemente?</a>  obteve mais de 237 mil visualiza√ß√µes em todos os tempos. <br><br>  O PM2 resolve esse problema com um comando: <br><br><pre> <code class="bash hljs">pm2 start app.js</code> </pre> <br><br>  Este comando ‚Äúdemoniza‚Äù (do ingl√™s ‚Äúdaemonize‚Äù) o processo do NodeJS, monitora o consumo de mem√≥ria e considera a carga do processador. <br><br><h2>  De volta aos nossos carneiros </h2><br><br>  √Ä medida que a carga no back-end aumenta, torna-se necess√°rio dimension√°-lo - vertical e horizontal - para quem √© mais conveniente nas circunst√¢ncias.  Como sabemos, um processo pode usar v√°rios n√∫cleos de processador, mas somente se houver v√°rios threads dentro do processo.  Nos aplicativos NodeJS, o fluxo √© um.  O PM2 √© capaz de ajudar nessa situa√ß√£o e distribuir a carga entre v√°rios n√∫cleos do processador.  Ainda com apenas um comando: <br><br><pre> <code class="plaintext hljs">pm2 start app.js -i max</code> </pre> <br><br>  Nesse caso, o par√¢metro <i>max</i> corresponde ao n√∫mero de n√∫cleos do processador.  I.e.  Ser√£o criados 8 processos separados para o processador de 8 n√∫cleos.  Voc√™ tamb√©m pode definir <i>-1 em</i> vez de <i>max</i> e <i>, em</i> seguida, o n√∫mero de processos corresponder√° ao <i>n√∫mero de</i> n√∫cleos <i>menos 1</i> .  Todo o charme √© que as conex√µes HTTP (S) / Websocket / TCP / UDP ser√£o distribu√≠das igualmente entre esses processos.  Por que n√£o escala horizontal?  Voc√™ pode ler mais sobre clustering no PM2 aqui - <a href="https://pm2.keymetrics.io/docs/usage/cluster-mode/" rel="nofollow">Modo de cluster do PM2</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a46/084/b81/a46084b8119afc457b9d0692678fe7f9.png" alt="cluster_mode"><br><br>  Voc√™ pode executar quantos processos quiser, mas ainda assim √© recomend√°vel seguir a recomenda√ß√£o "um processo por n√∫cleo". <br><br><h3>  Respeito pela mem√≥ria </h3><br>  Ao desenvolver em PHP, uma vez encontrei um problema.  Devido √† inexperi√™ncia, ele inconscientemente colocou um bug no mecanismo do sistema, devido ao qual, sob certas condi√ß√µes, os processos come√ßaram a consumir muita RAM.  Al√©m disso, o processador foi carregado, por causa do qual a m√°quina virtual acabou de desligar e eu n√£o tive acesso a ela. <br>  Como os desenvolvedores de PHP sabem, no PHP-FPM voc√™ pode especificar o tipo de distribui√ß√£o de processos (se voc√™ n√£o soubesse de repente, no PHP-FPM um novo processo √© criado para cada nova solicita√ß√£o) - est√°tico, quando os limites m√≠nimo e m√°ximo s√£o definidos e din√¢mico - aloca√ß√£o de quanto tantos processos grandes quanto necess√°rio.  O que acontecer√° no PM2 se voc√™ iniciar 8 processos e todos come√ßarem a consumir muita mem√≥ria?  E o PM2 √© capaz de resolver esse problema - com apenas um par√¢metro na linha de comando: <br><br><pre> <code class="plaintext hljs"># Set memory threshold for app reload pm2 start app.js -i max --max-memory-restart &lt;200MB&gt;</code> </pre><br><br>  Cada vez que o limite de mem√≥ria √© atingido, o PM2 reiniciar√° automaticamente o processo.  Distribuir mem√≥ria √© mais f√°cil do que processos, n√£o √©?  8 processos * 200 megabytes = 1,6 gigabytes.  Matem√°tica de segunda classe. <br><br>  Al√©m de reiniciar o processo, voc√™ tamb√©m pode configurar a reinicializa√ß√£o ap√≥s um N intervalo de tempo.  Ainda n√£o descobri em que casos isso pode ser √∫til, mas sinta-se √† vontade para apontar alguns exemplos nos coment√°rios :) <br><br><h3>  E se eu reiniciar a m√°quina virtual? </h3><br>  Surpresa-surpresa!  O PM2 tamb√©m resolve esse problema para voc√™.  Ainda com n√£o mais de um √∫nico comando no console: <br><br><pre> <code class="plaintext hljs">pm2 startup</code> </pre> <br><br>  O PM2 gerar√° um script que aumentar√° todos os processos necess√°rios quando o sistema operacional for iniciado.  No entanto, voc√™ deve estar vigilante - ao atualizar a vers√£o do Node.JS, tudo pode quebrar.  Para evitar isso, ap√≥s o upgrade para a nova vers√£o do Node.JS, execute <code>pm2 unstartup</code> e <code>pm2 startup</code> .  Voc√™ pode ler mais sobre isso no link - <a href="https://pm2.keymetrics.io/docs/usage/startup/" rel="nofollow">PM2 Startup Script Generator</a> . <br><br><h3>  √â necess√°rio reiniciar os clusters manualmente ao fazer altera√ß√µes? </h3><br>  Claro que n√£o!  Bem, mais precisamente, voc√™, √© claro, pode reiniciar o aplicativo manualmente, mas por qu√™?  Automatize tudo o que puder e que a for√ßa venha com voc√™! <br><br><pre> <code class="plaintext hljs">pm2 start env.js --watch --ignore-watch="node_modules"</code> </pre> <br><br>  Voc√™ pode usar isso ao mesclar uma ramifica√ß√£o principal em um reposit√≥rio local com uma ramifica√ß√£o principal de um reposit√≥rio remoto.  No meu projeto paralelo, isso √© feito simplesmente - <code>git pull origin master &amp;&amp; npm run build</code> .  Ao alterar os arquivos nas pastas <i>servidor / compila√ß√£o</i> e <i>cliente / compila√ß√£o</i> , os processos ser√£o reiniciados automaticamente.  Entendo que esse √© um recurso muito simples e nem merece ser mencionado neste texto.  Vou diluir isso com algo s√©rio e escrever que, se voc√™ usar cluster, todos os processos ser√£o reiniciados por sua vez.  Sim, para que pelo menos um deles esteja sempre dispon√≠vel.  Esta √© uma implanta√ß√£o com tempo de inatividade zero! <br><br>  E voc√™ n√£o pode reiniciar processos.  H√° recarga para isso (algo semelhante ao nginx reload): <br><br><pre> <code class="plaintext hljs">pm2 reload all</code> </pre> <br><br><h3>  Muitas equipes!  Em geral, eu prefiro configura√ß√µes </h3><br>  Eu j√° estou entediado em criar frases engra√ßadas, ent√£o √© simples e banal: existe um arquivo do ecossistema.  Os formatos suportados s√£o JSON, YAML e JS.  Por exemplo, quando voc√™ precisa monitorar arquivos nas pastas do <i>servidor</i> e do <i>cliente</i> : <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">apps</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">script</span></span>: <span class="hljs-string"><span class="hljs-string">"app.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">watch</span></span>: [<span class="hljs-string"><span class="hljs-string">"server"</span></span>, <span class="hljs-string"><span class="hljs-string">"client"</span></span>], <span class="hljs-attr"><span class="hljs-attr">env_production</span></span> : { <span class="hljs-string"><span class="hljs-string">"NODE_ENV"</span></span>: <span class="hljs-string"><span class="hljs-string">"production"</span></span> } }] }</code> </pre><br><br>  Para obter mais informa√ß√µes, consulte o link - <a href="https://pm2.keymetrics.io/docs/usage/application-declaration/" rel="nofollow">Declara√ß√£o de aplicativo do PM2</a> . <br><br><h3>  E at√© o monitoramento √©! </h3><br>  E n√£o um.  Escolha o que voc√™ mais gosta.  Voc√™ pode monitorar no console com o comando: <br><br><pre> <code class="plaintext hljs">pm2 monit</code> </pre> <br><br><img src="https://habrastorage.org/webt/8l/y-/c9/8ly-c9ljx5qjvxscgu1nagmycrg.png"><br><br>  Ou use a vers√£o completa de monitoramento baseado na Web: <br><br><img src="https://habrastorage.org/webt/0q/u4/mt/0qu4mtcxqhdqd9ysabk5xelvzns.png"><br><br>  Voc√™, √© claro, n√£o vai acreditar em mim, mas √© instalado e iniciado com <b>um</b> comando: <br><br><pre> <code class="plaintext hljs">pm2 plus</code> </pre> <br><br><h3>  E muito, muito mais ... </h3><br>  Suporte declarado ao Heroku e Docker, incremento autom√°tico de porta com a capacidade de transferir para <code>process.env</code> (quando voc√™ precisa executar cada processo em uma porta separada), o lan√ßamento de v√°rias inst√¢ncias do PM2 no mesmo sistema operacional, a presen√ßa de uma API de software e a capacidade de executar scripts demon√≠acos do Bash e Python! <br><br>  Provavelmente perdi algo mais importante ou interessante, que voc√™ sempre pode me lembrar nos coment√°rios.  Espero que voc√™ tenha aprendido algo novo com este artigo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt480670/">https://habr.com/ru/post/pt480670/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt480654/index.html">Ser√° que Julia venceu o Python assim como o Python fez o Java</a></li>
<li><a href="../pt480658/index.html">1C - Bem e mal. Coloca√ß√£o de pontos em holivar em torno de 1C</a></li>
<li><a href="../pt480660/index.html">Visualizar atratores estranhos em Plotly √© uma obra-prima</a></li>
<li><a href="../pt480664/index.html">Projeto ELISA: Linux em sistemas cr√≠ticos de seguran√ßa</a></li>
<li><a href="../pt480668/index.html">WTF por hora</a></li>
<li><a href="../pt480672/index.html">O paradoxo de Einstein - Podolsky - Rosen nos dedos e ... o que o √©ter tem a ver com isso</a></li>
<li><a href="../pt480674/index.html">Testando servidores virtuais da DigitalOcean, Vultr, Linode e Hetzner. Baixas humanas: 0.0</a></li>
<li><a href="../pt480680/index.html">Estrat√©gia de defesa NGINX e pedido a Igor Sysoev</a></li>
<li><a href="../pt480682/index.html">Intel RealSense LiDAR L515 - Outro novo RealSense</a></li>
<li><a href="../pt480684/index.html">DIY StarWars Snowflakes (atualize 2019)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>