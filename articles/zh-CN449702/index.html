<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸš’ ğŸ¦ƒ ğŸ‘‰ğŸ» å†æ¬¡åœ¨èˆå°ä¸Šèµ¢å¾—SSHå’Œsudoå›½é™…æ¯”èµ›çš„å† å†›ã€‚ åœ¨è£èª‰æŒ‡æŒ¥æ´»åŠ¨ç›®å½•çš„æŒ‡å¯¼ä¸‹ ğŸ“» ğŸš… ğŸ‘©â€ğŸ«</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä»å†å²ä¸Šçœ‹ï¼Œsudoæƒé™ç”±/etc/sudoers.då’Œvisudoä¸­æ–‡ä»¶çš„å†…å®¹æ¥æ§åˆ¶ ï¼Œå¹¶ä¸”ä½¿ç”¨ã€œ/ .ssh / authorized_keys è¿›è¡Œå¯†é’¥æˆæƒ ã€‚ ä½†æ˜¯ï¼Œéšç€åŸºç¡€è®¾æ–½çš„å‘å±•ï¼Œäººä»¬å¸Œæœ›é›†ä¸­ç®¡ç†è¿™äº›æƒåˆ©ã€‚ è¿„ä»Šä¸ºæ­¢ï¼Œå¯èƒ½æœ‰å‡ ç§è§£å†³æ–¹æ¡ˆï¼š 



- é…ç½®ç®¡ç†ç³»ç»Ÿ-Chef ï¼Œ Pup...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å†æ¬¡åœ¨èˆå°ä¸Šèµ¢å¾—SSHå’Œsudoå›½é™…æ¯”èµ›çš„å† å†›ã€‚ åœ¨è£èª‰æŒ‡æŒ¥æ´»åŠ¨ç›®å½•çš„æŒ‡å¯¼ä¸‹</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449702/"> ä»å†å²ä¸Šçœ‹ï¼Œsudoæƒé™ç”±<i>/etc/sudoers.d</i>å’Œ<i>visudo</i>ä¸­æ–‡ä»¶çš„å†…å®¹æ¥<i>æ§åˆ¶</i> ï¼Œå¹¶ä¸”ä½¿ç”¨<i>ã€œ/ .ssh / authorized_keys</i> <i>è¿›è¡Œ</i>å¯†é’¥<i>æˆæƒ</i> ã€‚ ä½†æ˜¯ï¼Œéšç€åŸºç¡€è®¾æ–½çš„å‘å±•ï¼Œäººä»¬å¸Œæœ›é›†ä¸­ç®¡ç†è¿™äº›æƒåˆ©ã€‚ è¿„ä»Šä¸ºæ­¢ï¼Œå¯èƒ½æœ‰å‡ ç§è§£å†³æ–¹æ¡ˆï¼š <br><br><ul><li> é…ç½®ç®¡ç†ç³»ç»Ÿ<i>-Chef</i> ï¼Œ <i>Puppet</i> ï¼Œ <i>Ansible</i> ï¼Œ <i>ç›</i> </li><li>  <i>æ´»åŠ¨ç›®å½•</i> + <i>sssd</i> </li><li> è„šæœ¬å’Œæ‰‹åŠ¨ç¼–è¾‘æ–‡ä»¶å½¢å¼çš„å„ç§å˜å½¢ </li></ul><br> ä»¥æˆ‘çš„ä¸»è§‚è§‚ç‚¹ï¼Œé›†ä¸­ç®¡ç†çš„æœ€ä½³é€‰æ‹©ä»ç„¶æ˜¯ä¸€å †<i>Active Directory</i> + <i>sssd</i> ã€‚ è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯ï¼š <br><br><ul><li> çœŸæ­£æ˜¯ä¸€ä¸ªé›†ä¸­çš„ç”¨æˆ·ç›®å½•ã€‚ </li><li> åˆ†é…<b>sudo</b>æƒé™æ˜¯å…³äºå°†ç”¨æˆ·æ·»åŠ åˆ°ç‰¹å®šçš„å®‰å…¨ç»„ã€‚ </li><li> å¯¹äºå„ç§Linuxç³»ç»Ÿï¼Œåœ¨ä½¿ç”¨é…ç½®ç³»ç»Ÿæ—¶ï¼Œæœ‰å¿…è¦å¼•å…¥å…¶ä»–æ£€æŸ¥æ¥ç¡®å®šOSã€‚ </li></ul><br> ä»Šå¤©çš„å¥—ä»¶å°†ä¸“ç”¨äº<i>Active Directory</i> + <i>sssdæ†ç»‘åŒ…ï¼Œ</i>ç”¨äºç®¡ç†<b>sudo</b>æƒé™å¹¶å°†<b>ssh</b>å¯†é’¥å­˜å‚¨åœ¨å•ä¸ªå­˜å‚¨åº“ä¸­ã€‚ <br> å› æ­¤ï¼Œå¬ä¼—åœ¨ç´§å¼ çš„æ²‰é»˜ä¸­åƒµä½äº†ï¼ŒæŒ‡æŒ¥åˆä¸¾èµ·äº†é­”æ–ï¼Œä¹å›¢åšå¥½äº†å‡†å¤‡ã€‚ <br> èµ°å§ <br><a name="habracut"></a><br> é‰´äºï¼š <br><br><ul><li>  Windows Server 2012 R2ä¸Šçš„Active Directory <b>åŸŸtestopf.local</b> ã€‚ </li><li> è¿è¡ŒCentos 7çš„Linuxä¸»æœº </li><li> ä½¿ç”¨<b>sssd</b>é…ç½®çš„æˆæƒ </li></ul><br> ä¸¤ç§è§£å†³æ–¹æ¡ˆéƒ½å¯¹<i>Active Directoryæ¶æ„</i>è¿›è¡Œäº†æ›´æ”¹ï¼Œå› æ­¤æˆ‘ä»¬åœ¨æµ‹è¯•ç¯å¢ƒä¸­æ£€æŸ¥æ‰€æœ‰å†…å®¹ï¼Œç„¶åæ‰å¯¹å·¥ä½œçš„åŸºç¡€ç»“æ„è¿›è¡Œæ›´æ”¹ã€‚ æˆ‘è¦æŒ‡å‡º-æ‰€æœ‰æ›´æ”¹éƒ½æ˜¯åŸºäºç‚¹çš„ï¼Œå®é™…ä¸Šï¼Œä»…æ·»åŠ å¿…è¦çš„å±æ€§å’Œç±»ã€‚ <br><br><h3> æ­¥éª¤1ï¼šé€šè¿‡<i>Active Directory</i>ç®¡ç†<b>sudo</b>è§’è‰²ã€‚ </h3><br> è¦æ‰©å±•<i>Active Directoryæ¶æ„ï¼Œ</i>æ‚¨éœ€è¦ç«‹å³ä¸‹è½½æœ€æ–°çš„<a href="">sudo</a>ç‰ˆæœ¬-1.8.27ã€‚ è§£å‹ç¼©ï¼Œå°†<i>schema.ActiveDirectory</i>æ–‡ä»¶ä»./docç›®å½•å¤åˆ¶åˆ°åŸŸæ§åˆ¶å™¨ã€‚ ä»å…·æœ‰å¤åˆ¶æ–‡ä»¶çš„ç›®å½•ä¸­çš„ç®¡ç†å‘˜æƒé™çš„å‘½ä»¤è¡Œè¿è¡Œï¼š <br><br> <code>ldifde -i -f schema.ActiveDirectory -c dc=X dc=testopf,dc=local</code> <br>  ï¼ˆä¸è¦å¿˜è®°æ›¿æ¢æ‚¨çš„ä»·å€¼è§‚ï¼‰ <br><br> æ‰“å¼€<b>adsiedit.msc</b>å¹¶è¿æ¥åˆ°é»˜è®¤ä¸Šä¸‹æ–‡ï¼š <br><br> åœ¨åŸŸçš„æ ¹ç›®å½•ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ª<b>sudoers</b>å•å…ƒã€‚  ï¼ˆèµ„äº§é˜¶çº§é¡½å›ºåœ°æŒ‡å‡ºï¼Œ <i>sssd</i>å®ˆæŠ¤ç¨‹åºæ­£æ˜¯åœ¨æ­¤ç»†åˆ†ä¸­æœç´¢<i>sudoRole</i>å¯¹è±¡ã€‚ä½†æ˜¯ï¼Œåœ¨æ‰“å¼€è¯¦ç»†çš„è°ƒè¯•å¹¶æ£€æŸ¥äº†æ—¥å¿—ä¹‹åï¼Œå‘ç°æœç´¢æ˜¯åœ¨æ•´ä¸ªç›®å½•æ ‘ä¸­è¿›è¡Œçš„ã€‚ï¼‰ <br><br> åœ¨å±äº<b>sudoRole</b>ç±»çš„å•å…ƒä¸­åˆ›å»ºç¬¬ä¸€ä¸ªå¯¹è±¡ã€‚ è¯¥åç§°å¯ä»¥ç»å¯¹ä»»æ„é€‰æ‹©ï¼Œå› ä¸ºå®ƒä»…ç”¨äºæ–¹ä¾¿è¯†åˆ«ã€‚ <br><br> åœ¨æ¨¡å¼æ‰©å±•ä¸­å¯èƒ½çš„å¯ç”¨å±æ€§ä¸­ï¼Œä¸»è¦å±æ€§æœ‰ï¼š <br><br><ul><li>  <b>sudoCommand-</b>ç¡®å®šå…è®¸å“ªäº›å‘½ä»¤åœ¨ä¸»æœºä¸Šè¿è¡Œã€‚ </li><li>  <b>sudoHost-</b>ç¡®å®šæ­¤è§’è‰²é€‚ç”¨äºå“ªäº›ä¸»æœºã€‚ å¯ä»¥å°†å…¶è®¾ç½®ä¸º<b>ALL</b> ï¼Œä¹Ÿå¯ä»¥å°†å…¶è®¾ç½®ä¸ºå•ä¸ªä¸»æœºçš„åç§°ã€‚ ä¹Ÿå¯ä»¥ä½¿ç”¨å£ç½©ã€‚ </li><li>  <b>sudoUser-</b>æŒ‡ç¤ºå…è®¸å“ªäº›ç”¨æˆ·æ‰§è¡Œ<i>sudo</i> ã€‚ <br> å¦‚æœæŒ‡å®šäº†å®‰å…¨ç»„ï¼Œè¯·åœ¨åç§°å¼€å¤´æ·»åŠ â€œï¼…â€ç¬¦å·ã€‚ å¦‚æœç¾¤ç»„åç§°ä¸­æœ‰ç©ºæ ¼ï¼Œåˆ™æ— éœ€æ‹…å¿ƒã€‚ ä»æ—¥å¿—æ¥çœ‹ï¼Œ <i>sssd</i>æœºåˆ¶æ‰¿æ‹…ç€è½¬ä¹‰ç©ºé—´çš„ä»»åŠ¡ã€‚ </li></ul><br><img src="https://habrastorage.org/webt/2x/fo/x6/2xfox6jwkxmqxem1oehtssukimi.png"><br>  <i>å›¾1.ç›®å½•æ ¹ç›®å½•ä¸­sudoerså•å…ƒä¸­çš„sudoRoleå¯¹è±¡</i> <br><br><img src="https://habrastorage.org/webt/oh/2q/un/oh2qunltygcljciuwna5uaqfako.png"><br>  <i>å›¾2. sudoRoleå¯¹è±¡ä¸­æŒ‡å®šçš„å®‰å…¨ç»„ä¸­çš„æˆå‘˜èµ„æ ¼ã€‚</i> <br><br> åœ¨Linuxç«¯å®Œæˆä»¥ä¸‹é…ç½®ã€‚ <br><br> åœ¨<b>/etc/nsswitch.conf</b>æ–‡ä»¶ä¸­ï¼Œå°†è¯¥è¡Œæ·»åŠ åˆ°æ–‡ä»¶æœ«å°¾ï¼š <br><br><pre> <code class="bash hljs">sudoers: files sss</code> </pre> <br> åœ¨<b>[sssd]</b>éƒ¨åˆ†çš„<b>/etc/sssd/sssd.conf</b>æ–‡ä»¶ä¸­ï¼Œå°†<b>sudo</b>æ·»åŠ åˆ°æœåŠ¡ä¸­ <br><br><pre> <code class="bash hljs">cat /etc/sssd/sssd.conf | grep services services = nss, pam, sudo</code> </pre><br> å®Œæˆæ‰€æœ‰æ“ä½œåï¼Œæ‚¨éœ€è¦æ¸…é™¤sssdå®ˆæŠ¤ç¨‹åºç¼“å­˜ã€‚ æ¯6ä¸ªå°æ—¶ä¼šè¿›è¡Œä¸€æ¬¡è‡ªåŠ¨æ›´æ–°ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆç°åœ¨æˆ‘ä»¬è¦ç­‰å¾…é‚£ä¹ˆå¤šæ—¶é—´ã€‚ <br><br><pre> <code class="bash hljs">sss_cache -E</code> </pre> <br> é€šå¸¸ï¼Œæ¸…é™¤ç¼“å­˜æ— æµäºäº‹ã€‚ ç„¶åæˆ‘ä»¬åœæ­¢æœåŠ¡ï¼Œæ¸…æ´åº•åº§ï¼Œç„¶åå¼€å§‹æœåŠ¡ã€‚ <br><br><pre> <code class="bash hljs">service sssd stop rm -rf /var/lib/sss/db/* service sssd start</code> </pre><br> æˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªç”¨æˆ·ä¸‹è¿›è¡Œè¿æ¥ï¼Œå¹¶æ£€æŸ¥å…¶æ˜¯å¦å¯ä»¥ä»sudoä¸‹è®¿é—®ï¼š <br><br><pre> <code class="bash hljs">su user1 [user1@testsshad <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>]$ id uid=1109801141(user1) gid=1109800513(domain users) groups=1109800513(domain users),1109801132(admins_) [user1@testsshad <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>]$ sudo -l [sudo] password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user1: Matching Defaults entries <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user1 on testsshad: !visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin, env_reset, env_keep=<span class="hljs-string"><span class="hljs-string">"COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS"</span></span>, env_keep+=<span class="hljs-string"><span class="hljs-string">"MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE"</span></span>, env_keep+=<span class="hljs-string"><span class="hljs-string">"LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES"</span></span>, env_keep+=<span class="hljs-string"><span class="hljs-string">"LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE"</span></span>, env_keep+=<span class="hljs-string"><span class="hljs-string">"LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY"</span></span>, secure_path=/sbin\:/bin\:/usr/sbin\:/usr/bin User user1 may run the following commands on testsshad: (root) /usr/bin/ls, /usr/bin/cat</code> </pre> <br> æˆ‘ä»¬å¯¹ç¬¬äºŒä¸ªç”¨æˆ·ä¹Ÿæ˜¯å¦‚æ­¤ï¼š <br><br><pre> <code class="bash hljs">su user2 [user2@testsshad <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>]$ id uid=1109801142(user2) gid=1109800513(domain users) groups=1109800513(domain users),1109801138(sudo_root) [user2@testsshad <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>]$ sudo -l Matching Defaults entries <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user2 on testsshad: !visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin, env_reset, env_keep=<span class="hljs-string"><span class="hljs-string">"COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS"</span></span>, env_keep+=<span class="hljs-string"><span class="hljs-string">"MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE"</span></span>, env_keep+=<span class="hljs-string"><span class="hljs-string">"LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES"</span></span>, env_keep+=<span class="hljs-string"><span class="hljs-string">"LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE"</span></span>, env_keep+=<span class="hljs-string"><span class="hljs-string">"LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY"</span></span>, secure_path=/sbin\:/bin\:/usr/sbin\:/usr/bin User user2 may run the following commands on testsshad: (root) ALL</code> </pre><br> è¿™ç§æ–¹æ³•ä½¿æ‚¨å¯ä»¥é›†ä¸­å®šä¹‰ä¸åŒç”¨æˆ·ç»„çš„sudoè§’è‰²ã€‚ <br><br><h3> åœ¨Active Directoryä¸­å­˜å‚¨å’Œä½¿ç”¨sshå¯†é’¥ </h3><br> é€šè¿‡å¯¹è¯¥æ–¹æ¡ˆè¿›è¡Œè¾ƒå°çš„æ‰©å±•ï¼Œå¯ä»¥å°†sshå¯†é’¥å­˜å‚¨åœ¨Active Directoryç”¨æˆ·å±æ€§ä¸­ï¼Œå¹¶å°†å…¶ç”¨äºLinuxä¸»æœºä¸Šçš„æˆæƒã€‚ <br><br> å¿…é¡»é…ç½®é€šè¿‡sssdçš„æˆæƒã€‚ <br><br> ä½¿ç”¨PowerShellè„šæœ¬æ·»åŠ æ‰€éœ€çš„å±æ€§ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">AddsshPublicKeyAttribute.ps1</b> <div class="spoiler_text"> å‡½æ•°New-AttributeID { <br>  $å‰ç¼€=â€œ 1.2.840.113556.1.8000.2554â€ <br>  $ GUID = [System.Guid] :: NewGuidï¼ˆï¼‰ã€‚ToStringï¼ˆï¼‰ <br>  $é›¶ä»¶= @ï¼ˆï¼‰ <br>  $éƒ¨åˆ†+ = [UInt64] ::è§£æï¼ˆ$ guid.SubStringï¼ˆ0.4ï¼‰ï¼Œâ€œ AllowHexSpecifierâ€ï¼‰ <br>  $éƒ¨åˆ†+ = [UInt64] ::è§£æï¼ˆ$ guid.SubStringï¼ˆ4,4ï¼‰ï¼Œâ€œ AllowHexSpecifierâ€ï¼‰ <br>  $éƒ¨åˆ†+ = [UInt64] ::è§£æï¼ˆ$ guid.SubStringï¼ˆ9,4ï¼‰ï¼Œâ€œ AllowHexSpecifierâ€ï¼‰ <br>  $éƒ¨åˆ†+ = [UInt64] ::è§£æï¼ˆ$ guid.SubStringï¼ˆ14,4ï¼‰ï¼Œâ€œ AllowHexSpecifierâ€ï¼‰ <br>  $éƒ¨åˆ†+ = [UInt64] ::è§£æï¼ˆ$ guid.SubStringï¼ˆ19,4ï¼‰ï¼Œâ€œ AllowHexSpecifierâ€ï¼‰ <br>  $éƒ¨åˆ†+ = [UInt64] ::è§£æï¼ˆ$ guid.SubStringï¼ˆ24.6ï¼‰ï¼Œâ€œ AllowHexSpecifierâ€ï¼‰ <br>  $éƒ¨åˆ†+ = [UInt64] ::è§£æï¼ˆ$ guid.SubStringï¼ˆ30.6ï¼‰ï¼Œâ€œ AllowHexSpecifierâ€ï¼‰ <br>  $ oid = [String] ::æ ¼å¼ï¼ˆâ€œ {0}ã€‚{1}ã€‚{2}ã€‚{3}ã€‚{4}ã€‚{5}ã€‚{6}ã€‚{7}â€ï¼Œ$å‰ç¼€ï¼Œ$ä»½[ 0]ï¼Œ <br>  $é›¶ä»¶[1]ï¼Œ$é›¶ä»¶[2]ï¼Œ$é›¶ä»¶[3]ï¼Œ$é›¶ä»¶[4]ï¼Œ$é›¶ä»¶[5]ï¼Œ$é›¶ä»¶[6]ï¼‰ <br>  $ oid <br>  } <br>  $ schemaPath =ï¼ˆGet-ADRootDSEï¼‰.schemaNamingContext <br>  $ oid =æ–°å±æ€§ID <br>  $å±æ€§= @ { <br>  lDAPDisplayName ='sshPublicKey'; <br>  attributeId = $ oid; <br>  oMSyntax = 22; <br>  attributeSyntax =â€œ 2.5.5.5â€; <br>  isSingleValued = $ true; <br>  adminDescription ='ç”¨äºSSHç™»å½•çš„ç”¨æˆ·å…¬å…±å¯†é’¥'; <br>  } <br><br>  New-ADObject -Name sshPublicKey -Type attributeSchema -Path $ schemapath -OtherAttributes $å±æ€§ <br>  $ userSchema = get-adobject -SearchBase $ schemapath -Filter'name -eqâ€œ userâ€' <br>  $ userSchema |  Set-ADObject -Add @ {mayContain ='sshPublicKey'} <br></div></div><br> æ·»åŠ å±æ€§åï¼Œé‡æ–°å¯åŠ¨Active DirectoryåŸŸæœåŠ¡ã€‚ <br> æˆ‘ä»¬ä¼ é€’ç»™Active Directoryçš„ç”¨æˆ·ã€‚ ä¸ºäº†æ‚¨çš„æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä¼šä¸ºsshè¿æ¥ç”Ÿæˆä¸€ä¸ªå¯†é’¥å¯¹ã€‚ <br><br> å¯åŠ¨PuttyGenï¼Œå•å‡»â€œç”Ÿæˆâ€æŒ‰é’®ï¼Œç„¶ååœ¨ç©ºç™½åŒºåŸŸå†…ç–¯ç‹‚åœ°å•å‡»é¼ æ ‡ã€‚ <br><br> å®Œæˆè¯¥è¿‡ç¨‹åï¼Œæˆ‘ä»¬å¯ä»¥ä¿å­˜å…¬é’¥å’Œç§é’¥ï¼Œåœ¨Active Directoryç”¨æˆ·å±æ€§ä¸­å¡«å†™å…¬é’¥å¹¶äº«å—è¯¥è¿‡ç¨‹ã€‚ ä½†æ˜¯ï¼Œå¿…é¡»ä»â€œ <b>ç”¨äºç²˜è´´åˆ°OpenSSHauthorized_keysæ–‡ä»¶çš„å…¬å…±å¯†é’¥ï¼š</b> â€çª—å£ä¸­ä½¿ç”¨<b>å…¬å…±å¯†é’¥</b> ã€‚ <br><br><img src="https://habrastorage.org/webt/af/bu/o5/afbuo5avt0mvyunloxwcfceygaa.png"><br><br> å°†å¯†é’¥æ·»åŠ åˆ°ç”¨æˆ·å±æ€§ã€‚ <br><br> é€‰é¡¹1-GUIï¼š <br><br><img src="https://habrastorage.org/webt/cq/ak/7h/cqak7h5xn68tythynzu6fmgloeq.png"><br><br> é€‰é¡¹2-PowerShellï¼š <br><br> <code>get-aduser user1 | set-aduser -add @{sshPublicKey = 'AAAAB...XAVnX9ZRJJ0p/Q=='}</code> <br> <br> ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº†ï¼šå¡«å……äº†sshPublicKeyå±æ€§çš„ç”¨æˆ·ï¼Œé…ç½®äº†å¯†é’¥æˆæƒçš„Puttyå®¢æˆ·ç«¯ã€‚ è¿˜æœ‰ä¸€ç‚¹ï¼Œå¦‚ä½•ä½¿sshdå®ˆæŠ¤ç¨‹åºä»ç”¨æˆ·å±æ€§ä¸­æå–æˆ‘ä»¬éœ€è¦çš„å…¬é’¥ã€‚ åœ¨èµ„äº§é˜¶çº§äº’è”ç½‘çš„å¼€æ”¾ç©ºé—´ä¸­å‘ç°çš„ä¸€ä¸ªå°è„šæœ¬æˆåŠŸåœ°è§£å†³äº†è¿™ä¸€é—®é¢˜ã€‚ <br><br><pre> <code class="bash hljs">cat /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/fetchSSHKeysFromLDAP <span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ldapsearch -h testmdt.testopf.local -xb "dc=testopf,dc=local" '(sAMAccountName='"${1%@*}"')' -D Administrator@testopf.local -w superSecretPassword 'sshPublicKey' | sed -n '/^ /{H;d};/sshPublicKey:/x;$g;s/\n *//g;s/sshPublicKey: //gp'</span></span></code> </pre> <br> æˆ‘ä»¬ä¸ºrootè®¾ç½®äº†0500æƒé™ã€‚ <br><br><pre> <code class="bash hljs">chmod 0500 /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/fetchSSHKeysFromLDAP</code> </pre> <br> åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œç®¡ç†å‘˜å¸æˆ·ç”¨äºç»‘å®šåˆ°ç›®å½•ã€‚ åœ¨æˆ˜æ–—æ¡ä»¶ä¸‹ï¼Œåº”è¯¥æœ‰ä¸€ä¸ªå•ç‹¬çš„å¸æˆ·ï¼Œå…¶æƒé™æœ€å°‘ã€‚ <br><br> å°½ç®¡è®¾ç½®äº†æƒé™ï¼Œä½†æˆ‘ä¸ªäººå¯¹è„šæœ¬ä¸­çº¯æ ¼å¼çš„å¯†ç æ„Ÿåˆ°å›°æƒ‘ã€‚ <br><br> è§£å†³æ–¹æ¡ˆé€‰é¡¹ï¼š <br><br><ul><li> æˆ‘å°†å¯†ç ä¿å­˜åœ¨ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¸­ï¼š <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n Supersecretpassword &gt; /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/secretpass</code> </pre> </li><li> æˆ‘åœ¨æ ¹ç›®å½•çš„0500æ–‡ä»¶ä¸Šè®¾ç½®äº†æƒé™ <br><br><pre> <code class="bash hljs">chmod 0500 /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/secretpass</code> </pre> </li><li> æˆ‘æ›´æ”¹äº†ldapsearchçš„å¯åŠ¨å‚æ•°ï¼š <i>-w superSecretPassword</i>å‚æ•°<i>æ›´æ”¹</i>ä¸º<i>-y / usr / local / etc / secretpass</i> </li></ul><br> å½“ä»Šå¥—ä»¶ä¸­çš„æœ€åä¸€ä¸ªå’Œå¼¦æ˜¯ç¼–è¾‘sshd_config <br><br><pre> <code class="bash hljs">cat /etc/ssh/sshd_config | egrep -v -E <span class="hljs-string"><span class="hljs-string">"#|^$"</span></span> | grep -E <span class="hljs-string"><span class="hljs-string">"AuthorizedKeysCommand|PubkeyAuthe"</span></span> PubkeyAuthentication yes AuthorizedKeysCommand /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/fetchSSHKeysFromLDAP AuthorizedKeysCommandUser root</code> </pre><br> ç»“æœï¼Œæˆ‘ä»¬åœ¨sshå®¢æˆ·ç«¯ä¸­é…ç½®äº†å¯†é’¥èº«ä»½éªŒè¯ï¼Œå¾—åˆ°ä»¥ä¸‹åºåˆ—ï¼š <br><br><ol><li> ç”¨æˆ·è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œå¹¶æŒ‡å‡ºä»–çš„ç”¨æˆ·åã€‚ </li><li>  sshdå®ˆæŠ¤ç¨‹åºé€šè¿‡è„šæœ¬ä»Active Directoryä¸­çš„ç”¨æˆ·å±æ€§ä¸­æå–å…¬é’¥çš„å€¼å¹¶æˆæƒå¯†é’¥ã€‚ </li><li>  sssdå®ˆæŠ¤ç¨‹åºè¿›ä¸€æ­¥æ ¹æ®ç»„æˆå‘˜èº«ä»½å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ã€‚ æ³¨æ„ï¼ å¦‚æœæœªé…ç½®ï¼Œåˆ™ä»»ä½•åŸŸç”¨æˆ·éƒ½å¯ä»¥è®¿é—®ä¸»æœºã€‚ </li><li> å°è¯•sudoæ—¶ï¼Œsssdå®ˆæŠ¤ç¨‹åºåœ¨Active Directoryç›®å½•ä¸­æœç´¢è§’è‰²ã€‚ å¦‚æœæœ‰è§’è‰²ï¼Œåˆ™æ£€æŸ¥ç»„çš„å±æ€§å’Œç”¨æˆ·æˆå‘˜èµ„æ ¼ï¼ˆå¦‚æœsudoRolesé…ç½®ä¸ºä½¿ç”¨ç”¨æˆ·ç»„ï¼‰ </li></ol><br><h3> æ€»ç»“ </h3><br> å› æ­¤ï¼Œå¯†é’¥å­˜å‚¨åœ¨Active Directoryç”¨æˆ·å±æ€§ï¼Œsudoæƒé™ä¸­-ç±»ä¼¼åœ°ï¼Œé€šè¿‡æ£€æŸ¥Active Directoryç»„ä¸­çš„æˆå‘˜èº«ä»½æ¥æ‰§è¡ŒåŸŸå¸æˆ·å¯¹Linuxä¸»æœºçš„è®¿é—®ã€‚ <br><br> æŒ‡æŒ¥æ£’çš„æœ€åä¸€æ³¢-å¤§å…å†»ç»“åœ¨æ•¬ç•çš„å¯‚é™ä¸­ã€‚ <br><br> ä¹¦é¢ä½¿ç”¨çš„èµ„æºï¼š <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é€šè¿‡Active Directoryçš„Sudo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é€šè¿‡Active Directoryçš„SSHå¯†é’¥</a> </li><li>  <a href="">Powershellè„šæœ¬ï¼Œå‘Active Directoryæ¶æ„æ·»åŠ å±æ€§</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">sudoç¨³å®šå‘å¸ƒ</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN449702/">https://habr.com/ru/post/zh-CN449702/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN449686/index.html">è°ˆè®ºOFFZONE 2019çš„ä¸»è¦å‘è¨€äººä¹‹ä¸€</a></li>
<li><a href="../zh-CN449688/index.html">æµ‹è¯•sendBeaconè®¾ç½®ä»¥å‘é€æ•°æ®</a></li>
<li><a href="../zh-CN449690/index.html">åœ¨è±æ°çš„ç§˜å¯†å®éªŒå®¤å†…</a></li>
<li><a href="../zh-CN449696/index.html">å‚åŠ RAMè¶…é¢‘ç«èµ›-HyperX Memory OC Competition 2019</a></li>
<li><a href="../zh-CN449700/index.html">ä¸ºä»€ä¹ˆäº¤é€šçªç„¶å˜æˆäº¤é€šæ‹¥å µ</a></li>
<li><a href="../zh-CN449704/index.html">MVCC-5ã€‚ é¡µå†…æ¸…æ´å’ŒHOT</a></li>
<li><a href="../zh-CN449706/index.html">ä½¿ç”¨KOMPAS-3D APIâ†’ç¬¬15è¯¾â†’åŸºäºæ®µè½çš„å¤åˆè¡Œ</a></li>
<li><a href="../zh-CN449708/index.html">Citymobil-åœ¨åˆåˆ›ä¼ä¸šä¸šåŠ¡å¢é•¿ä¸­æé«˜å¯ç”¨æ€§çš„æ‰‹å†Œã€‚ ç¬¬ä¸‰éƒ¨åˆ†</a></li>
<li><a href="../zh-CN449712/index.html">æ¯å‘¨æ–°é—»ï¼šç¡¬ç›˜éœ€æ±‚ä¸‹é™ï¼Œä¸»æƒäº’è”ç½‘æ³•å¾‹è·å¾—æ‰¹å‡†ï¼Œä¿„ç½—æ–¯5Gè®¾å¤‡ç”Ÿäº§</a></li>
<li><a href="../zh-CN449714/index.html">é›¶å¹¶ä¸æ€»æ˜¯é›¶</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>