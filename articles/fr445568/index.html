<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👙 👈🏻 👨🏻‍💻 Surveillance et gestion à distance des périphériques Linux / OpenWrt / Lede via le port 80 ... 🐵 🤦🏻 🏸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour à tous, c'est ma première expérience sur Habré. Je veux écrire sur la façon de gérer un équipement réseau non standard dans un réseau externe....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Surveillance et gestion à distance des périphériques Linux / OpenWrt / Lede via le port 80 ...</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445568/">  Bonjour à tous, c'est ma première expérience sur Habré.  Je veux écrire sur la façon de gérer un équipement réseau non standard dans un réseau externe.  Qu'est-ce que cela signifie non standard: dans la plupart des cas, pour contrôler l'équipement d'un réseau externe, vous devez: <br><br><ul><li>  L'adresse IP publique.  Eh bien, ou si l'équipement est situé derrière le NAT de quelqu'un, alors l'adresse IP publique et le port "retransmis". </li><li>  Le tunnel (PPTP / OpenVPN / L2TP + IPSec, etc.) vers le nœud central par lequel il serait accessible. </li></ul><br>  Par conséquent, vous aurez besoin de mon vélo lorsque les méthodes standard ne vous conviennent pas, par exemple: <a name="habracut"></a><br><ol><li>  L'équipement est situé derrière le NAT et, à part le http habituel (port 80), tout est fermé.  La situation est tout à fait normale pour les grands réseaux d'entreprises fédérales.  Enregistrez les ports - ils peuvent, mais pas immédiatement, pas rapidement et pas pour vous. </li><li>  Canal de communication instable et / ou «étroit».  Basse vitesse, perte constante.  Douleur et frustration en essayant d'organiser un tunnel. </li><li>  Un canal de communication coûteux, où chaque mégaoctet compte.  Par exemple, les communications par satellite.  Plus de gros retards et une bande "étroite". </li><li>  La situation où vous devez "jongler" avec un grand nombre de petits routeurs, sur lesquels, d'une part, OpenWrt / Lede est installé pour étendre les capacités, et d'autre part, les ressources (mémoire) du routeur sont loin d'être suffisantes. </li></ol><br><div class="spoiler">  <b class="spoiler_title">Notez le nombre de fois</b> <div class="spoiler_text">  Et qu'est-ce qui empêche l'installation d'une clé USB du routeur et l'extension de la mémoire du routeur? <br><br>  Le plus souvent, les exigences relatives au coût de la solution dans son ensemble, mais parfois le facteur de forme joue également un rôle clé.  Par exemple, TP-Link ML3020 est sur l'objet, son seul port USB est utilisé pour un modem 2G / 3G, tout cela est enveloppé dans un fil avec un petit boîtier en plastique et placé quelque part haut, haut (sur le mât), loin, loin (dans à 30 km de la station de base la plus proche d'un opérateur mobile).  Oui, vous pouvez brancher un concentrateur USB et augmenter le nombre de ports, mais l'expérience a montré que cela est lourd et peu fiable. <br></div></div><br>  J'ai donc essayé de vous décrire ma situation typique: «quelque part loin, très loin, il y a un routeur très important, solitaire et petit qui tourne sous Linux.  Il est important de savoir au moins une fois par jour qu'il est «vivant» et, si nécessaire, des commandes lui ont été envoyées, par exemple, «soleil, redémarre!» <br><br>  Passons à l'implémentation: <br><br>  1) Côté routeur, cron toutes les 5/10/1440 minutes, ou chaque fois que vous devez envoyer une requête http au serveur à l'aide de wget, enregistrez le résultat de la requête dans un fichier, rendez le fichier exécutable et exécutez-le. <br><br>  Ma ligne en cron ressemble à ceci: <br><br>  Fichier / etc / crontabs / root: <br><br><pre><code class="bash hljs">*/5 * * * * wget <span class="hljs-string"><span class="hljs-string">"http://xn--80abgfbdwanb2akugdrd3a2e5gsbj.xn--p1ai/a.php?u=user&amp;p=password"</span></span> -O /tmp/wa.sh &amp;&amp; chmod 777 /tmp/wa.sh &amp;&amp; /tmp/wa.sh</code> </pre> <br>  où: <br>  xn - 80abgfbdwanb2akugdrd3a2e5gsbj.xn - p1ai - le domaine de mon serveur.  Je noterai tout de suite: oui, vous pouvez également spécifier une adresse IP de serveur spécifique, nous l'avons déjà fait, alors que notre état, dans une explosion de lutte juste, ne me semblait plus - n'a pas bloqué l'accès à la part du lion des «nuages» de DigitalOcean et d'Amazon.  Dans le cas de l'utilisation d'un domaine symbolique, lorsqu'un tel incident se produit, vous pouvez soulever calmement le cloud de sauvegarde, y rediriger le domaine et restaurer la surveillance des appareils. <br><br>  a.php - le nom du script côté serveur.  Oui, je sais qu'il est faux de nommer les variables et les noms de fichiers avec une seule lettre ... Je suggère que nous économisions quelques octets lors de l'envoi d'une demande :) <br>  u - nom d'utilisateur, connexion au matériel <br>  p - mot de passe <br>  «-O /tmp/wa.sh» est le fichier sur le routeur distant où la réponse du serveur sera enregistrée, par exemple, la commande de redémarrage. <br><br><div class="spoiler">  <b class="spoiler_title">Remarque numéro deux:</b> <div class="spoiler_text">  Ahhh, pourquoi utilisons-nous wget, pas curl, car grâce à curl, vous pouvez envoyer des requêtes https et non GET, mais POST?  Ahhh, parce que comme dans la vieille blague "NE se glisse dans la cabane!".  Curl comprend des bibliothèques de chiffrement d'environ 2 Mo, et grâce à cela, vous pourrez assembler une image pour un petit TP-LINK ML3020 par exemple.  Et avec wget, s'il vous plaît. <br></div></div><br>  2) Côté serveur (j'ai Ubuntu) nous utiliserons Zabbix.  Pourquoi: je veux que ce soit beau (avec des graphiques) et pratique (envoyer des commandes via le menu contextuel).  Zabbix a une si belle chose qu'un agent zabbix.  Par l'intermédiaire de l'agent, nous appellerons le script php sur le serveur, qui renverra des informations indiquant si notre routeur a été enregistré dans le délai requis.  Pour stocker des informations sur l'heure d'enregistrement, des commandes pour les appareils, j'utilise MySQL, une table d'utilisateurs distincte avec approximativement les champs suivants: <br><br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`users`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">25</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`passwd`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">25</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`description`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`category`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`status`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`last_time`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, //    <span class="hljs-string"><span class="hljs-string">`last_ip`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, // IP   <span class="hljs-string"><span class="hljs-string">`last_port`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, //    <span class="hljs-string"><span class="hljs-string">`task`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, //     <span class="hljs-string"><span class="hljs-string">`reg_task`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, // <span class="hljs-string"><span class="hljs-string">""</span></span> ,          <span class="hljs-string"><span class="hljs-string">`last_task`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, //   <span class="hljs-string"><span class="hljs-string">`response`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, //     <span class="hljs-string"><span class="hljs-string">`seq`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8;</code> </pre> <br>  Toutes les sources peuvent être extraites du référentiel Git à l' <a href="">adresse</a> : <a href="">https://github.com/BazDen/iotnet.online.git</a> <br>  Maintenant les scripts PHP hébergés côté serveur (pour plus de commodité, vous pouvez les mettre dans le dossier / usr / share / zabbix /): <br><br>  Fichier A.php: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//   :  ,       //   message ?    ,         $user=$_REQUEST['u']; $password=$_REQUEST['p']; $message=$_REQUEST['m']; //      (MySQL) $conn=new mysqli("localhost","db_login","db_password","DB_name"); if (mysqli_connect_errno()) { exit(); } $conn-&gt;set_charset("utf8"); //         $sql_users=$conn-&gt;prepare("SELECT task, reg_task, response, last_time FROM users WHERE id=? AND passwd=? AND status='active';"); $sql_users-&gt;bind_param('ss', $user, $password); $sql_users-&gt;bind_result($task, $reg_task, $response, $last_time); $sql_users-&gt;execute(); $sql_users-&gt;store_result(); if (($sql_users-&gt;num_rows)==1){ $sql_users-&gt;fetch(); //       echo $task; echo "\n"; echo $reg_task; //           $response_history="[".date("Ymd H:i")."] ".$message; //  ,    ,     ,  -   $last_ip=$_SERVER["REMOTE_ADDR"]; $last_port=$_SERVER["REMOTE_PORT"]; $ts_last_conn_time=$last_time; $sql_users=$conn-&gt;prepare("UPDATE users SET task='', seq=1 WHERE (id=?);"); $sql_users-&gt;bind_param('s', $user); $sql_users-&gt;execute(); if (strlen($message)&gt;1){ $sql_users=$conn-&gt;prepare("UPDATE users SET response=?, seq=1 WHERE (id=?);"); $sql_users-&gt;bind_param('ss', $response_history, $user); $sql_users-&gt;execute(); } //      ,      .    $ts_now=time(); $sql_users=$conn-&gt;prepare("UPDATE users SET last_time=?, last_ip=?, last_port=? WHERE (id=?);"); $sql_users-&gt;bind_param('ssss', $ts_now, $last_ip, $last_port, $user); $sql_users-&gt;execute(); } //         ,    "",   ...    reboot.... //    ?     ,      " ". else { echo "reboot"; } $sql_users-&gt;close(); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br>  Fichier Agent.php (c'est le script de l'agent zabbix appelé): <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//   Zabbix.      users   "1"        // user  password -    $user = $argv[1]; $password = $argv[2]; //      $conn=new mysqli("localhost","db_user","db_password","db_name"); if (mysqli_connect_errno()) { exit(); } $conn-&gt;set_charset("utf8"); $sql_users=$conn-&gt;prepare("SELECT seq FROM users WHERE id=? AND passwd=? AND status='active';"); $sql_users-&gt;bind_param('ss', $user, $password); $sql_users-&gt;bind_result($seq); $sql_users-&gt;execute(); $sql_users-&gt;store_result(); //      seq.        "1" if (($sql_users-&gt;num_rows)==1){ $sql_users-&gt;fetch(); echo $seq; } //  $seq. $sql_users=$conn-&gt;prepare("UPDATE users SET seq=0 WHERE id=? AND passwd=? AND status='active';"); $sql_users-&gt;bind_param('ss', $user, $password); $sql_users-&gt;execute(); $sql_users-&gt;close(); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br>  Eh bien, la dernière étape: prescrire un agent et ajouter des horaires. <br><br>  Si vous n'avez pas encore installé l'agent zabbix, alors: <br><br><pre> <code class="bash hljs">apt-get install zabbix-agent</code> </pre> <br>  Modification du fichier /etc/zabbix/zabbix_agentd.conf. <br><br>  Ajoutez la ligne: <br><br><pre> <code class="bash hljs">UserParameter=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,php /usr/share/zabbix/agent.php user password</code> </pre> <br>  où: <br>  test est le nom de notre agent <br>  "Php /usr/share/zabbix/agent.php mot de passe utilisateur" - le script appelé avec les données d'enregistrement de l'appareil. <br><br>  Ajout de graphiques: ouvrez l'interface Web zabbix, sélectionnez dans le menu: <br>  Paramètres -&gt; Hôtes -&gt; Créer un hôte.  Il suffit de spécifier le nom d'hôte, son groupe, l'interface d'agent par défaut: <br><br><img src="https://habrastorage.org/webt/o9/wd/6l/o9wd6lh0n7fj_n2quv4da-xq_va.jpeg"><br><br>  Nous devons maintenant ajouter un élément de données pour cet hôte.  Faites attention à deux champs: la "clé" est exactement le paramètre que nous avons spécifié dans le fichier /etc/zabbix/zabbix_agentd.conf (dans notre cas, il s'agit de test), et l '"intervalle de mise à jour" - je fixe 5 minutes, car et l'équipement est enregistré sur le serveur toutes les cinq minutes. <br><br><img src="https://habrastorage.org/webt/b7/s1/v4/b7s1v4jxbgybkk7set7jkj0dhcs.jpeg"><br><br>  Eh bien, ajoutez le calendrier.  Je recommande de choisir «Remplir» comme style de dessin. <br><br><img src="https://habrastorage.org/webt/7h/xc/yc/7hxcycdggiqe7pmj8u2ow58ufvm.jpeg"><br><br>  La sortie est quelque chose de très concis, par exemple comme ceci: <br><br><img src="https://habrastorage.org/webt/8c/qp/dq/8cqpdqirv7jldbqyhhmu61p9czk.jpeg"><br><br>  À la question raisonnable: «Cela en valait-il la peine?», Je répondrai: eh bien, bien sûr, voir les «raisons de créer un vélo» au début de l'article. <br><br>  Si ma première expérience graphomane suscitera l'intérêt des lecteurs, alors dans les articles suivants je veux décrire comment envoyer des commandes à un équipement distant.  Il a également été possible de mettre en œuvre l'intégralité du schéma pour les appareils basés sur RouterOS (Mikrotiks). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr445568/">https://habr.com/ru/post/fr445568/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr445556/index.html">Turbines à vapeur: comment la vapeur chaude se transforme en électricité</a></li>
<li><a href="../fr445558/index.html">OpenShift 4.0 - se préparer pour l'hyper saut</a></li>
<li><a href="../fr445560/index.html">Cryptographie en Java. Classe KeyPair</a></li>
<li><a href="../fr445562/index.html">Bloomberg: McDonald's achètera un développeur de menu de technologie de personnalisation pour 300 millions de dollars</a></li>
<li><a href="../fr445566/index.html">Publication d'un projet de loi sur les profils numériques des Russes</a></li>
<li><a href="../fr445570/index.html">Le condensé des événements pour les professionnels des RH dans le domaine des TI pour avril 2019</a></li>
<li><a href="../fr445572/index.html">Le gouvernement américain prévoit d'envoyer des gens sur la lune dans 5 ans</a></li>
<li><a href="../fr445580/index.html">Une liste exhaustive des différences entre VB.NET et C #. 2e partie</a></li>
<li><a href="../fr445582/index.html">Systèmes CRM: protection ou menace?</a></li>
<li><a href="../fr445584/index.html">OS1: un noyau primitif sur Rust pour x86. Partie 2. VGA, GDT, IDT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>