<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐸 👰🏼 👧🏽 Stateful Backups in Kubernetes 🎩 🔩 🛅</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wie jeder sicher weiß, fand die DevOpsConfRussia2018 zuletzt am 1. und 2. Oktober in Moskau im „Infraspace“ statt. Für diejenigen, die sich nicht wohl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Stateful Backups in Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/426543/"><p>  Wie jeder sicher weiß, fand die <b>DevOpsConfRussia2018</b> zuletzt am 1. und 2. Oktober in Moskau im „Infraspace“ statt.  Für diejenigen, die sich nicht <b>wohl fühlen</b> , ist <b>DevOpsConf</b> eine professionelle Konferenz zur Integration von Entwicklungs-, Test- und Betriebsprozessen. </p><br><p>  Auch unser Unternehmen hat an dieser Konferenz teilgenommen.  Wir waren seine Partner, vertraten das Unternehmen an unserem Stand und hielten auch ein kleines Treffen ab.  Dies war übrigens unsere erste Teilnahme an dieser Art von Aktivität.  Die erste Konferenz, der erste Mitap, die erste Erfahrung. </p><br><p>  Worüber haben wir gesprochen?  Mitap befasste sich mit dem Thema „Backups in Kubernetes“. </p><br><p>  Viele, die diesen Namen wahrscheinlich hören, werden sagen: „Warum zurück zu Kubernetes?  Es muss nicht gesichert werden, es ist zustandslos. “ </p><br><p><img src="https://habrastorage.org/webt/t7/qd/uy/t7qduyxlblaljfdfs_tduggq0w8.png"></p><a name="habracut"></a><br><h3>  Einführung ... </h3><br><p>  Beginnen wir mit einem kleinen Hintergrund.  Warum wurde es notwendig, dieses Thema zu behandeln und warum wird es benötigt? </p><br><p>  2016 haben wir eine Technologie wie Kubernetes kennengelernt und begonnen, sie aktiv auf unsere Projekte anzuwenden.  Dies sind natürlich hauptsächlich Projekte mit Microservice-Architektur, und dies erfordert wiederum die Verwendung einer großen Anzahl unterschiedlicher Software. </p><br><p>  Bei dem ersten Projekt, bei dem wir Kubernetes verwendeten, hatten wir eine Frage zur Sicherung der dort befindlichen Stateful-Dienste, die manchmal aus irgendeinem Grund in k8s fallen. </p><br><p>  Wir begannen zu studieren und nach bestehenden Praktiken zu suchen, um dieses Problem zu lösen.  Kommunizieren Sie mit unseren Kollegen und Kameraden: "Und wie wird dieser Prozess von ihnen durchgeführt und aufgebaut?" </p><br><p>  Nach dem Gespräch stellten wir fest, dass dies alles mit unterschiedlichen Methoden, Mitteln und mit einer großen Anzahl von Krücken geschieht.  Wir haben jedoch auch <u>im Rahmen eines Projekts</u> keinen einheitlichen Ansatz verfolgt. </p><br><p>  Warum ist das so wichtig?  Da unser Unternehmen Projekte auf der Basis von k8s betreut, mussten wir lediglich eine strukturierte Methodik zur Lösung dieses Problems entwickeln. </p><br><p>  Stellen Sie sich vor, Sie arbeiten mit einem bestimmten Projekt in Coober.  Es enthält einige Stateful-Dienste, und Sie müssen deren Daten sichern.  Im Prinzip kann man hier ein paar Krücken machen und es vergessen.  Aber was ist, wenn Sie bereits zwei Projekte auf k8s haben?  Und das zweite Projekt verwendet in seiner Arbeit völlig andere Dienste.  Und wenn es schon fünf Projekte gibt?  Zehn?  Oder mehr als zwanzig? </p><br><p>  Das Anlegen von Krücken ist natürlich schon schwierig und unpraktisch.  Wir brauchen einen einheitlichen Ansatz, der bei der Arbeit mit vielen Projekten in Kuba und gleichzeitig verwendet werden kann, damit das Ingenieurteam in wenigen Minuten einfach und buchstäblich die erforderlichen Änderungen an den Sicherungen dieser Projekte vornehmen kann. </p><br><p>  Im Rahmen dieses Artikels werden wir nur darüber sprechen, welches Tool und welche Praxis wir verwenden, um dieses Problem in unserem Unternehmen zu lösen. </p><br><h3>  Wie machen wir das? </h3><br><h6>  Nxs-Backup was ist das? </h6><br><p>  Für Backups verwenden wir unser eigenes Open Source-Tool - nxs-backup.  Wir werden nicht auf die Details eingehen, was er kann.  Weitere Details finden Sie unter folgendem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Link</a> . </p><br><p>  Fahren wir nun mit der Implementierung von Backups in k8s fort.  Wie und was genau wurde von uns gemacht. </p><br><h3>  Was ist ein Backup? </h3><br><p> Schauen wir uns ein Beispiel für ein Backup unserer eigenen Redmine an.  Darin werden wir die MySQL-Datenbank und Benutzerprojektdateien sichern. </p><br><h3>  Wie machen wir das? </h3><br><h6>  1 CronJob == 1 Service </h6><br><p>  Auf normalen Servern und Clustern auf Hardware werden fast alle Sicherungstools meist über reguläres Cron gestartet.  In k8s verwenden wir zu diesem Zweck CronJobs, d. H. Wir erstellen 1 CronJob für 1 Dienst, den wir sichern werden.  Alle diese CronJobs befinden sich im selben Namespace wie der Dienst selbst. </p><br><p>  Beginnen wir mit der MySQL-Datenbank.  Um MySQL zu sichern, benötigen wir wie bei fast jedem anderen Dienst 4 Elemente: </p><br><ul><li>  ConfigMap (nxs-backup.conf) </li><li>  ConfigMap (mysql.conf für nxs-backup) </li><li>  Geheim (Zugriffe auf den Dienst werden hier gespeichert, in diesem Fall MySQL).  Normalerweise ist dieses Element bereits für den Dienst definiert und kann wiederverwendet werden. </li><li>  CronJob (für jeden Dienst seinen eigenen) </li></ul><br><p>  Lass uns in Ordnung gehen. </p><br><h6>  nxs-backup.conf </h6><br><pre><code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>-conf <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: nxs-backup.conf: |- <span class="hljs-keyword"><span class="hljs-keyword">main</span></span>: server_name: Nixys k8s cluster admin_mail: admins@nixys.ru client_mail: - <span class="hljs-string"><span class="hljs-string">''</span></span> mail_from: <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>@nixys.ru level_message: <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> block_io_read: <span class="hljs-string"><span class="hljs-string">''</span></span> block_io_write: <span class="hljs-string"><span class="hljs-string">''</span></span> blkio_weight: <span class="hljs-string"><span class="hljs-string">''</span></span> general_path_to_all_tmp_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> cpu_shares: <span class="hljs-string"><span class="hljs-string">''</span></span> log_file: /dev/stdout jobs: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> [conf.d<span class="hljs-comment"><span class="hljs-comment">/*.conf]</span></span></code> </pre> <br><p>  Hier legen wir die grundlegenden Parameter fest, die an unser Werkzeug übergeben werden und die für dessen Betrieb erforderlich sind.  Dies ist der Name des Servers, eine E-Mail für Benachrichtigungen, eine Einschränkung des Ressourcenverbrauchs und andere Parameter. </p><br><p>  Konfigurationen können im j2-Format angegeben werden, wodurch Umgebungsvariablen verwendet werden können. </p><br><h6>  mysql.conf </h6><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: mysql-conf data: service.conf.j2: |- - job: mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: {{ db_host }} db_port: {{ db_port }} socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: {{ db_user }} db_password: {{ db_password }} target: - redmine_db gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Diese Datei beschreibt die Sicherungslogik für den entsprechenden Dienst, in unserem Fall MySQL. </p><br><p>  Hier können Sie angeben: </p><br><ul><li>  Wie heißt Job (Feld: Job) </li><li>  Auftragstyp (Feld: Typ) </li><li>  Das temporäre Verzeichnis, das zum Sammeln von Sicherungen benötigt wird (Feld: tmp_dir) </li><li>  MySQL-Verbindungsoptionen (Feld: Verbinden) </li><li>  Zu sichernde Datenbank (Feld: Ziel) </li><li>  Der Slave muss vor dem Sammeln gestoppt werden (Feld: is_slave) </li><li>  Zusätzliche Schlüssel für mysqldump (Feld: extra_keys) </li><li>  Speicher Speicher, d. H. In welchem ​​Speicher speichern wir eine Kopie (Feld: Speicher) </li><li>  Das Verzeichnis, in dem wir unsere Kopien speichern (Feld: backup_dir) </li><li>  Speicherschema (Feld: Speicher) </li></ul><br><p>  In unserem Beispiel ist der Speichertyp auf lokal festgelegt, d. H. Wir sammeln und speichern Sicherungen lokal in einem bestimmten Verzeichnis des gestarteten Pods. </p><br><p>  In Analogie zu dieser Konfigurationsdatei können Sie hier dieselben Konfigurationsdateien für Redis, PostgreSQL oder einen anderen erforderlichen Dienst angeben, sofern dies von unserem Tool unterstützt wird.  Die Tatsache, dass es unterstützt, finden Sie unter dem zuvor angegebenen Link. </p><br><h6>  Geheime MySQL </h6><br><pre> <code class="hljs powershell">apiVersion: v1 kind: Secret metadata: name: app<span class="hljs-literal"><span class="hljs-literal">-config</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: db_name: <span class="hljs-string"><span class="hljs-string">""</span></span> db_host: <span class="hljs-string"><span class="hljs-string">""</span></span> db_user: <span class="hljs-string"><span class="hljs-string">""</span></span> db_password: <span class="hljs-string"><span class="hljs-string">""</span></span> secret_token: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_address: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_domain: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_ssl: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_enable_starttls_auto: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_port: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_auth_type: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_login: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_password: <span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> <br><p>  Wir behalten den geheimen Zugriff, um eine Verbindung zu MySQL selbst und dem Mailserver herzustellen.  Sie können entweder in einem separaten Geheimnis gespeichert werden oder natürlich das vorhandene nutzen, falls es eines gibt.  Nichts interessantes hier.  Unser Geheimnis enthält auch das secret_token, das für den Betrieb unserer Redmine notwendig ist. </p><br><h6>  CronJob MySQL </h6><br><pre> <code class="hljs pgsql">apiVersion: batch/v1beta1 kind: CronJob metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql spec: schedule: "00 00 * * *" jobTemplate: spec: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>: - nxs-node5 containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-backup image: nixyslab/nxs-backup:latest env: - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_HOST valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_host - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_PORT <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'3306'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_user - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_PASSWORD valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_ADDR valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_address - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_PORT valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_port - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_USE_TLS <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'YES'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_login - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_PASS valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_FROM_LINE_OVERRIDE <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'NO'</span></span> volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf mountPath: /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nxs-backup/service.conf.j2 subPath: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf mountPath: /etc/nxs-backup/nxs-backup.conf subPath: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir mountPath: /var/nxs-backup imagePullPolicy: <span class="hljs-keyword"><span class="hljs-keyword">Always</span></span> volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf items: - key: service.conf.j2 <span class="hljs-type"><span class="hljs-type">path</span></span>: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf items: - key: nxs-backup.conf <span class="hljs-type"><span class="hljs-type">path</span></span>: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir hostPath: <span class="hljs-type"><span class="hljs-type">path</span></span>: /var/backups/k8s <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Directory restartPolicy: OnFailure</code> </pre> <br><p>  Vielleicht ist dieses Element das interessanteste.  Um den richtigen CronJob zu kompilieren, müssen Sie zunächst festlegen, wo die gesammelten Backups gespeichert werden. </p><br><p>  Dafür haben wir einen separaten Server mit der notwendigen Anzahl an Ressourcen.  In diesem Beispiel wird ein separater Clusterknoten, nxs-node5, zum Sammeln von Sicherungen zugewiesen.  Die Einschränkung beim Starten von CronJob auf den von uns benötigten Knoten wird durch die Anweisung nodeAffinity festgelegt. </p><br><p>  Beim Start von CronJob wird das entsprechende Verzeichnis über hostPath vom Host-System aus damit verbunden, in dem Sicherungskopien gespeichert werden. </p><br><p>  Als nächstes werden ConfigMaps mit dem spezifischen CronJob verbunden, der die Konfiguration für nxs-backup enthält, nämlich die Dateien nxs-backup.conf und mysql.conf, über die wir gerade gesprochen haben. </p><br><p>  Anschließend werden alle erforderlichen Umgebungsvariablen festgelegt, die direkt im Manifest definiert oder aus Secret'ov abgerufen werden. </p><br><p>  Daher werden die Variablen in den Container übertragen und über docker-entrypoint.sh in ConfigMaps an den von uns benötigten Stellen durch die erforderlichen Werte ersetzt.  Für MySQL ist dies db_host, db_user, db_password.  In diesem Fall übergeben wir den Port einfach als Wert im CronJob-Manifest, da er keine wertvollen Informationen enthält. </p><br><p>  Nun, mit MySQL scheint alles klar zu sein.  Nun wollen wir sehen, was zum Sichern von Redmine-Anwendungsdateien erforderlich ist. </p><br><h6>  desc_files.conf </h6><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: desc-files-conf data: service.conf.j2: |- - job: desc-files type: desc_files tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/files/<span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>/dump_tmp sources: - target: - /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/files gzip: yes storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/files/<span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Dies ist eine Konfigurationsdatei, die die Sicherungslogik für Dateien beschreibt.  Auch hier gibt es nichts Ungewöhnliches, mit Ausnahme der Berechtigungsdaten werden dieselben Parameter wie für MySQL eingestellt, da dies einfach nicht der Fall ist.  Obwohl dies der Fall sein kann, wenn Protokolle für die Datenübertragung beteiligt sind: ssh, ftp, webdav, s3 und andere.  Wir werden diese Option etwas später in Betracht ziehen. </p><br><h6>  CronJob desc_files </h6><br><pre> <code class="hljs pgsql">apiVersion: batch/v1beta1 kind: CronJob metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files spec: schedule: "00 00 * * *" jobTemplate: spec: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>: - nxs-node5 containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-backup image: nixyslab/nxs-backup:latest env: - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_ADDR valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_address - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_PORT valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_port - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_USE_TLS <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'YES'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_login - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_PASS valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_FROM_LINE_OVERRIDE <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'NO'</span></span> volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf mountPath: /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nxs-backup/service.conf.j2 subPath: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf mountPath: /etc/nxs-backup/nxs-backup.conf subPath: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: target-dir mountPath: /var/www/files - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir mountPath: /var/nxs-backup imagePullPolicy: <span class="hljs-keyword"><span class="hljs-keyword">Always</span></span> volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf items: - key: service.conf.j2 <span class="hljs-type"><span class="hljs-type">path</span></span>: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf items: - key: nxs-backup.conf <span class="hljs-type"><span class="hljs-type">path</span></span>: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir hostPath: <span class="hljs-type"><span class="hljs-type">path</span></span>: /var/backups/k8s <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Directory - <span class="hljs-type"><span class="hljs-type">name</span></span>: target-dir persistentVolumeClaim: claimName: redmine-app-files restartPolicy: OnFailure</code> </pre> <br><p>  Auch in Bezug auf MySQL nichts Neues.  Aber hier ist eine zusätzliche PV (Zielverzeichnis) gemountet, die wir sichern werden - / var / www / files.  Ansonsten ist alles gleich, wir speichern Kopien lokal auf dem Knoten, den wir benötigen, für den CronJob zugewiesen ist. </p><br><h6>  Zusammenfassung </h6><br><p>  Für jeden Service, den wir sichern möchten, erstellen wir einen separaten CronJob mit allen erforderlichen verwandten Elementen: ConfigMaps und Secrets.  In Analogie zu den betrachteten Beispielen können wir jeden ähnlichen Dienst im Cluster sichern. </p><br><p>  Ich denke, basierend auf diesen beiden Beispielen hat jeder eine Vorstellung davon, wie wir die staatlichen Dienste in Kuba unterstützen.  Ich denke, es macht keinen Sinn, dieselben Beispiele für andere Dienste im Detail zu analysieren, da sie im Grunde alle gleich sind und geringfügige Unterschiede aufweisen. </p><br><p>  Eigentlich wollten wir dies erreichen, nämlich einen <u>einheitlichen Ansatz</u> für den Aufbau des Sicherungsprozesses.  Und damit dieser Ansatz auf eine Vielzahl unterschiedlicher Projekte auf Basis von k8s angewendet werden kann. </p><br><h3>  Wo lagern wir es? </h3><br><p>  In allen oben beschriebenen Beispielen speichern wir Kopien im lokalen Verzeichnis des Knotens, auf dem der Container ausgeführt wird.  Aber niemand stört sich daran, Persistent Volume als funktionierenden externen Speicher anzuschließen und dort Kopien zu sammeln.  Oder Sie können sie nur mit dem gewünschten Protokoll mit einem Remote-Speicher synchronisieren, ohne sie lokal zu speichern.  Das heißt, es gibt viele Variationen.  Zuerst lokal sammeln, dann synchronisieren.  Oder nur auf einem Remote-Speicher usw. zu sammeln und zu speichern.  Die Konfiguration ist sehr flexibel. </p><br><h6>  mysql.conf + s3 </h6><br><p>  Das folgende Beispiel zeigt die MySQL-Sicherungskonfigurationsdatei, in der Kopien lokal auf dem Knoten gespeichert werden, auf dem CronJob ausgeführt wird, und auch in s3 synchronisiert werden. </p><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: mysql-conf data: service.conf.j2: |- - job: mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: {{ db_host }} db_port: {{ db_port }} socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: {{ db_user }} db_password: {{ db_password }} target: - redmine_db gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">' --opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: s3 <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump bucket_name: {{ bucket_name }} access_key_id: {{ access_key_id }} secret_access_key: {{ secret_access_key }} s3fs_opts: {{ s3fs_opts }} <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> weeks: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Wenn es nicht ausreicht, Kopien lokal zu speichern, können Sie sie mit dem entsprechenden Protokoll mit jedem Remotespeicher synchronisieren.  Die Anzahl der Speicherplätze kann beliebig sein. </p><br><p>  In diesem Fall müssen Sie jedoch noch einige zusätzliche Änderungen vornehmen, nämlich: </p><br><ul><li>  Verbinden Sie die entsprechende ConfigMap mit dem für die Autorisierung mit AWS S3 erforderlichen Inhalt im j2-Format </li><li>  Erstellen Sie ein geeignetes Geheimnis zum Speichern von Autorisierungszugriffen </li><li>  Stellen Sie die erforderlichen Umgebungsvariablen aus Secret oben ein </li><li>  Passen Sie docker-entrypoint.sh an, um die entsprechenden Variablen in ConfigMap zu ersetzen </li><li>  Erstellen Sie das Docker-Image neu und fügen Sie Dienstprogramme für die Arbeit mit AWS S3 hinzu </li></ul><br><p>  Dieser Prozess ist zwar alles andere als perfekt, aber wir arbeiten daran.  Daher werden wir in naher Zukunft nxs-backup die Möglichkeit hinzufügen, Parameter in der Konfigurationsdatei mithilfe von Umgebungsvariablen zu definieren, was die Arbeit mit der Einstiegspunktdatei erheblich vereinfacht und den Zeitaufwand für das Hinzufügen von Sicherungsunterstützung für neue Dienste minimiert. </p><br><h3>  Fazit </h3><br><p>  Das ist wahrscheinlich alles. </p><br><p>  Mit dem Ansatz, über den wir gerade gesprochen haben, können wir zunächst Stateful-Projektdienste für k8s strukturieren und als Vorlage sichern.  Das heißt, dies ist eine vorgefertigte Lösung und vor allem die Praxis, die Sie in Ihren Projekten anwenden können, ohne Zeit und Mühe bei der Suche und Aktualisierung vorhandener Open Source-Lösungen zu verschwenden. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de426543/">https://habr.com/ru/post/de426543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de426527/index.html">Gutes Zeug, schlechtes Zeug</a></li>
<li><a href="../de426531/index.html">Dell G3 15 (3579): Ein Gaming-Laptop für ein minimales Budget</a></li>
<li><a href="../de426533/index.html">Noise Security Bit-Episode 0x21 (Fiktion und Realität: Hintertüren in Hardware und Firmware)</a></li>
<li><a href="../de426537/index.html">Das Buch "App von Grund auf neu"</a></li>
<li><a href="../de426541/index.html">Paul Allen, Mitbegründer von Microsoft, verstarb im Alter von 65 Jahren</a></li>
<li><a href="../de426545/index.html">Joker 2018 Boni: kostenloses Online-Streaming, Bofs, Party und Tisch</a></li>
<li><a href="../de426547/index.html">Da der Schöpfer von Android versucht, das erste "Anti-Smartphone" herauszubringen</a></li>
<li><a href="../de426549/index.html">Eine neue Art von Software für Produktmanager</a></li>
<li><a href="../de426551/index.html">Trekz Air - wie Knochenleitungskopfhörer tatsächlich klingen</a></li>
<li><a href="../de426553/index.html">Bannerwerbung in iOS-Anwendung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>