<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëü üè• üîº La t√©cnica de desarrollar servidores altamente confiables en Go üö± üöö üàØÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="De vez en cuando, los programadores web enfrentan tareas que incluso pueden asustar a los profesionales. Estamos hablando de desarrollar aplicaciones ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>La t√©cnica de desarrollar servidores altamente confiables en Go</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/413681/">  De vez en cuando, los programadores web enfrentan tareas que incluso pueden asustar a los profesionales.  Estamos hablando de desarrollar aplicaciones de servidor que no tienen derecho a cometer errores, de proyectos en los que el costo de la falla es extremadamente alto.  El autor del material, cuya traducci√≥n publicamos hoy, hablar√° sobre c√≥mo abordar tales tareas. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/2r/ma/ty/2rmaty9ihtz7cjzhhvzqgm5e7ia.jpeg"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">¬øQu√© nivel de fiabilidad necesita su proyecto?</font> </h2><br>  Antes de profundizar en los detalles del desarrollo de aplicaciones de servidor altamente confiables, debe preguntarse si su proyecto realmente necesita el nivel de confiabilidad m√°s alto posible.  El proceso de desarrollar sistemas dise√±ados para escenarios de trabajo en los que el error es similar a una cat√°strofe universal puede ser irrazonablemente complicado para la mayor√≠a de los proyectos en los que las consecuencias de posibles errores no son particularmente atemorizantes. <br><br>  Si el costo del error no resulta ser extremadamente alto, un enfoque es aceptable, en cuya implementaci√≥n el desarrollador hace los esfuerzos m√°s razonables para garantizar la operatividad del proyecto, y si surgen problemas, simplemente los entiende.  Las herramientas de monitoreo modernas y los procesos continuos de implementaci√≥n de software le permiten identificar r√°pidamente problemas de producci√≥n y solucionarlos casi instant√°neamente.  En muchos casos, esto es suficiente. <br><br>  En el proyecto en el que estoy trabajando hoy, esto no es as√≠.  Estamos hablando de la implementaci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">blockchain</a> , una infraestructura de servidor distribuido para la ejecuci√≥n segura de c√≥digo en un entorno con un bajo nivel de confianza, mientras se logra el consenso.  Una aplicaci√≥n de esta tecnolog√≠a son las monedas digitales.  Este es un ejemplo cl√°sico de un sistema con un costo de error extremadamente alto.  En este caso, los desarrolladores del proyecto realmente necesitan hacerlo muy, muy confiable. <br><br>  Sin embargo, en algunos otros proyectos, incluso si no est√°n relacionados con las finanzas, la b√∫squeda de la mayor confiabilidad del c√≥digo tiene sentido.  El costo de dar servicio a una base de c√≥digo que se rompe con frecuencia puede alcanzar r√°pidamente valores astron√≥micos.  La capacidad de identificar problemas en las primeras etapas del proceso de desarrollo, cuando el costo de solucionarlos a√∫n es bajo, parece una recompensa muy real por la inversi√≥n oportuna de tiempo y esfuerzo en la metodolog√≠a de desarrollo de sistemas altamente confiables. <br><br><h2>  <font color="#3AC1EF">¬øQuiz√°s la soluci√≥n es TDD?</font> </h2><br>  El desarrollo a trav√©s de pruebas ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Test Driven Development</a> , TDD) a menudo se considera la mejor cura para un c√≥digo incorrecto.  TDD es una metodolog√≠a de desarrollo purista, en la aplicaci√≥n de qu√© pruebas se escriben primero, y solo despu√©s: c√≥digo que se agrega al proyecto solo cuando las pruebas que lo verifican dejan de generar errores.  Este proceso garantiza una cobertura del 100% del c√≥digo con pruebas y a menudo da la ilusi√≥n de que el c√≥digo se prueba en todas las variantes posibles de su uso. <br><br>  Sin embargo, esto no es as√≠.  TDD es una excelente metodolog√≠a que funciona bien en algunas √°reas, pero para desarrollar c√≥digo verdaderamente confiable, simplemente no es suficiente.  Peor a√∫n, TDD inspira al desarrollador con falsa confianza y la aplicaci√≥n de esta metodolog√≠a puede llevar al hecho de que simplemente, por flojera, no escribir√° pruebas para verificar fallas en el sistema en situaciones cuya ocurrencia, desde el punto de vista del sentido com√∫n, es casi imposible.  Hablaremos de esto m√°s tarde. <br><br><h2>  <font color="#3AC1EF">Las pruebas son la clave de la fiabilidad.</font> </h2><br>  En realidad, no importa si crea pruebas antes de escribir el c√≥digo, o despu√©s, si usa una metodolog√≠a de desarrollo como TDD o no.  Lo principal es el hecho de tener pruebas.  Las pruebas son la mejor fortificaci√≥n defensiva que protege su c√≥digo de problemas de producci√≥n. <br><br>  Dado que vamos a ejecutar nuestras pruebas con mucha frecuencia, idealmente despu√©s de agregar cada nueva l√≠nea al c√≥digo, es necesario que las pruebas est√©n automatizadas.  Nuestra confianza en la calidad del c√≥digo no debe basarse de ninguna manera en sus verificaciones manuales.  El caso es que las personas tienden a cometer errores.  La atenci√≥n al detalle de una persona se debilita despu√©s de haber completado la misma tarea desalentadora muchas veces seguidas. <br><br>  Las pruebas deben ser r√°pidas.  Muy rapido <br><br>  Si lleva m√°s de unos segundos completar el conjunto de pruebas, los desarrolladores probablemente ser√°n flojos y agregar√°n c√≥digo al proyecto sin probarlo.  La velocidad es una de las mayores fortalezas de Go.  El kit de herramientas de desarrollo en este lenguaje es uno de los m√°s r√°pidos entre los existentes.  La compilaci√≥n, reconstrucci√≥n y prueba de proyectos se realiza en segundos. <br><br>  Las pruebas, adem√°s, son una de las fuerzas impulsoras importantes de los proyectos de c√≥digo abierto.  Por ejemplo, esto se aplica a todo lo relacionado con la tecnolog√≠a blockchain.  El c√≥digo abierto aqu√≠ es casi una religi√≥n.  El c√≥digo base para ganar confianza en quienes lo usar√°n debe estar abierto.  Esto permite, por ejemplo, realizar su auditor√≠a, crea una atm√≥sfera de descentralizaci√≥n, en la que no hay ciertas entidades que controlan el proyecto. <br><br>  No tiene sentido esperar una contribuci√≥n significativa al proyecto de c√≥digo abierto de desarrolladores externos si este proyecto no incluye pruebas de calidad.  Los participantes externos del proyecto necesitan mecanismos para verificar r√°pidamente la compatibilidad de lo que escribieron con lo que ya se agreg√≥ al proyecto.  El conjunto completo de pruebas, de hecho, debe realizarse autom√°ticamente al recibir cada solicitud para agregar un nuevo c√≥digo al proyecto.  Si algo que se supone que debe agregarse al proyecto mediante una solicitud de este tipo rompe algo, la prueba debe informarlo de inmediato. <br><br>  La cobertura completa de la base del c√≥digo con pruebas es una m√©trica enga√±osa pero importante.  El objetivo de lograr una cobertura del c√≥digo del 100% con las pruebas puede parecer excesivo, pero si lo piensa, resulta que si el c√≥digo no est√° completamente cubierto por las pruebas, una parte del c√≥digo se env√≠a a producci√≥n sin verificaci√≥n, que nunca antes se hab√≠a ejecutado. <br><br>  La cobertura completa del c√≥digo con las pruebas no significa necesariamente que haya suficientes pruebas en el proyecto, y no significa que estas sean pruebas que brinden absolutamente todas las opciones para usar el c√≥digo.  Con confianza, solo podemos decir que si el proyecto no est√° cubierto al 100% en las pruebas, el desarrollador no puede estar seguro de la fiabilidad absoluta del c√≥digo, ya que algunas partes del c√≥digo nunca se prueban. <br><br>  A pesar de lo anterior, hay situaciones en las que hay demasiadas pruebas.  Idealmente, cada error posible deber√≠a conducir al fracaso de una prueba.  Si el n√∫mero de pruebas es excesivo, es decir, diferentes pruebas verifican los mismos fragmentos de c√≥digo, luego modificar el c√≥digo existente y cambiar el comportamiento del sistema existente conducir√° al hecho de que para que las pruebas existentes se correspondan con el nuevo c√≥digo, tomar√° demasiado tiempo procesarlas. . <br><br><h2>  <font color="#3AC1EF">¬øPor qu√© Go es una excelente opci√≥n para proyectos altamente confiables?</font> </h2><br>  Go es un lenguaje est√°tico escrito.  Los tipos son un contrato entre varias piezas de c√≥digo que se ejecutan juntas.  Sin la verificaci√≥n autom√°tica de tipos durante el proceso de ensamblaje del proyecto, si necesita cumplir con reglas estrictas para cubrir el c√≥digo con las pruebas, tendr√≠amos que implementar pruebas que verifiquen estos "contratos" por nuestra cuenta.  Esto, por ejemplo, ocurre en proyectos de servidor y cliente basados ‚Äã‚Äãen JavaScript.  Escribir pruebas complejas destinadas solo a verificar tipos significa mucho trabajo adicional, que, en el caso de Go, se puede evitar. <br><br>  Go es un lenguaje simple y dogm√°tico.  Como sabes, Go incluye muchas ideas tradicionales para lenguajes de programaci√≥n, como la herencia cl√°sica de OOP.  La complejidad es el peor enemigo del c√≥digo confiable.  Los problemas tienden a esconderse en las articulaciones de estructuras complejas.  Esto se expresa en el hecho de que, aunque las opciones t√≠picas para usar un determinado dise√±o son f√°ciles de probar, existen casos extra√±os en los que el desarrollador de la prueba ni siquiera puede pensar.  El proyecto, al final, derribar√° solo uno de estos casos.  En este sentido, el dogmatismo tambi√©n es √∫til.  En Go, a menudo solo hay una forma de realizar una acci√≥n.  Esto puede parecer un factor que frena el esp√≠ritu libre del programador, pero cuando algo se puede hacer de una sola manera, es dif√≠cil hacer algo mal. <br><br>  Ir es conciso pero expresivo.  El c√≥digo legible es m√°s f√°cil de analizar y auditar.  Si el c√≥digo es demasiado detallado, su prop√≥sito principal puede ahogarse en el "ruido" de las construcciones auxiliares.  Si el c√≥digo es demasiado conciso, los programas en √©l pueden ser dif√≠ciles de leer y comprender.  Go mantiene un equilibrio entre concisi√≥n y expresividad.  Por ejemplo, no hay muchas construcciones auxiliares en √©l, como en lenguajes como Java o C ++.  Al mismo tiempo, las construcciones Go, que se relacionan, por ejemplo, con √°reas como el manejo de errores, son muy claras y bastante detalladas, lo que simplifica el trabajo del programador y lo ayuda a asegurarse, por ejemplo, de que haya verificado todo lo posible. <br><br>  Go tiene mecanismos claros de manejo de errores y recuperaci√≥n despu√©s de fallas.  Los mecanismos de manejo de errores de tiempo de ejecuci√≥n bien ajustados son la piedra angular de un c√≥digo altamente confiable.  Go tiene reglas estrictas para devolver y distribuir errores.  En entornos como Node.js, mezclar enfoques para controlar el flujo de un programa, como devoluciones de llamada, promesas y funciones asincr√≥nicas, a menudo conduce a errores no controlados, como el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">rechazo no controlado de una promesa</a> .  Restaurar el programa despu√©s de eventos similares es casi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">imposible</a> . <br><br>  Go tiene una extensa biblioteca est√°ndar.  Las dependencias son un riesgo, especialmente cuando su origen son proyectos en los que no se presta suficiente atenci√≥n a la confiabilidad del c√≥digo.  Una aplicaci√≥n de servidor que entra en producci√≥n contiene todas las dependencias.  Adem√°s, si algo sale mal, el desarrollador de la aplicaci√≥n final ser√° responsable de esto, y no el que cre√≥ una de las bibliotecas utilizadas por √©l.  Como resultado, en entornos donde los proyectos escritos para los cuales est√°n abrumados con peque√±as dependencias, es m√°s dif√≠cil crear aplicaciones confiables. <br><br>  Las dependencias tambi√©n son un riesgo de seguridad, ya que el nivel de vulnerabilidad de un proyecto corresponde al nivel de vulnerabilidad de su <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dependencia</a> m√°s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">insegura</a> .  La extensa biblioteca est√°ndar Go es mantenida por sus desarrolladores en muy buenas condiciones, su existencia reduce la necesidad de dependencias externas. <br><br>  Alta velocidad de desarrollo.  Una caracter√≠stica clave de entornos como Node.js es su ciclo de desarrollo extremadamente corto.  Escribir c√≥digo lleva menos tiempo, como resultado, el programador se vuelve m√°s productivo. <br><br>  Go tambi√©n tiene una alta velocidad de desarrollo.  Un conjunto de herramientas para construir proyectos es lo suficientemente r√°pido como para poder ver instant√°neamente el c√≥digo en acci√≥n.  El tiempo de compilaci√≥n es extremadamente corto; como resultado, la ejecuci√≥n del c√≥digo en Go se percibe como si no se hubiera compilado, sino interpretado.  Adem√°s, el lenguaje tiene suficientes abstracciones, como un sistema de recolecci√≥n de basura, que permite a los desarrolladores dirigir los esfuerzos para implementar la funcionalidad de su proyecto y no resolver tareas auxiliares. <br><br><h2>  <font color="#3AC1EF">Experimento pr√°ctico</font> </h2><br>  Ahora que hemos expresado suficientes puntos generales, es hora de echar un vistazo al c√≥digo.  Necesitamos un ejemplo que sea lo suficientemente simple como para que, mientras lo estudiamos, podamos centrarnos en la metodolog√≠a de desarrollo, pero al mismo tiempo, debe ser lo suficientemente avanzado como para que, al explorarlo, tengamos algo de qu√© hablar.  Decid√≠ que ser√≠a m√°s f√°cil tomar algo de lo que hago a diario.  Por lo tanto, propongo analizar la creaci√≥n de un servidor que procese algo parecido a las transacciones financieras.  Los usuarios de este servidor podr√°n verificar los saldos de cuenta asociados con sus cuentas.  Adem√°s, podr√°n transferir fondos de una cuenta a otra. <br><br>  Intentaremos no complicar este ejemplo.  Nuestro sistema tendr√° un servidor.  No nos pondremos en contacto con los sistemas de autenticaci√≥n y criptograf√≠a.  Estas son partes integrales de los proyectos de trabajo.  Pero debemos centrarnos en el n√∫cleo de dicho proyecto, para mostrar c√≥mo hacerlo lo m√°s confiable posible. <br><br><h3>  <font color="#3AC1EF">‚ñçDividir un proyecto complejo en partes convenientes para administrar</font> </h3><br>  La complejidad es el peor enemigo de la fiabilidad.  Uno de los mejores enfoques cuando se trabaja con sistemas complejos es aplicar el principio conocido de "divide y vencer√°s".  La tarea debe dividirse en peque√±as subtareas y resolver cada una de ellas por separado.  ¬øDe qu√© lado abordar la partici√≥n de nuestra tarea?  Seguiremos el principio de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">responsabilidad compartida</a> .  Cada parte de nuestro proyecto debe tener su propia √°rea de responsabilidad. <br><br>  Esta idea encaja perfectamente con la popular arquitectura de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">microservicios</a> .  Nuestro servidor consistir√° en servicios separados.  Cada servicio tendr√° un √°rea de responsabilidad claramente definida y una interfaz claramente descrita para interactuar con otros servicios. <br><br>  Despu√©s de estructurar el servidor de esta manera, podremos tomar decisiones sobre c√≥mo deber√≠a funcionar cada uno de los servicios.  Todos los servicios se pueden realizar juntos, en el mismo proceso, desde cada uno de ellos puede hacer un servidor separado y establecer su interacci√≥n usando RPC, puede separar los servicios y ejecutar cada uno de ellos en una computadora separada. <br><br>  No volveremos a complicar la tarea, elegiremos la opci√≥n m√°s simple.  Es decir, todos los servicios se ejecutar√°n en el mismo proceso, intercambiar√°n informaci√≥n directamente, como las bibliotecas.  Si es necesario, en el futuro esta soluci√≥n arquitect√≥nica se puede revisar y cambiar f√°cilmente. <br><br>  Entonces, ¬øqu√© servicios necesitamos?  Nuestro servidor es quiz√°s demasiado simple para dividirlo en partes, pero, con fines educativos, sin embargo, lo dividiremos.  Necesitamos responder a las solicitudes HTTP del cliente destinadas a verificar saldos y ejecutar transacciones.  Uno de los servicios puede funcionar con una interfaz HTTP para clientes.  <code>PublicApi</code> .  Otro servicio tendr√° informaci√≥n sobre el estado del sistema: el balance.  <code>StateStorage</code> .  El tercer servicio combinar√° los dos descritos anteriormente e implementar√° la l√≥gica de los "contratos" destinados a cambiar los saldos.  La tarea del tercer servicio ser√° la ejecuci√≥n de los contratos.  <code>VirtualMachine</code> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a2/a04/79b/8a2a0479b551df5fd2a3c46e67bb46a7.png"></div><br>  <i><font color="#999999">Arquitectura del servidor de aplicaciones</font></i> <br><br>  Coloque el c√≥digo de estos servicios en las carpetas del proyecto <code>/services/publicapi</code> , <code>/services/virtualmachine</code> y <code>/services/statestorage</code> . <br><br><h3>  <font color="#3AC1EF">‚ñç Definici√≥n clara de las responsabilidades del servicio</font> </h3><br>  Durante la implementaci√≥n de los servicios, queremos poder trabajar con cada uno de ellos individualmente.  Incluso es posible dividir el desarrollo de estos servicios entre diferentes programadores.  Como los servicios son interdependientes y queremos paralelizar su desarrollo, debemos comenzar a trabajar con una definici√≥n clara de las interfaces que utilizan para interactuar entre s√≠.  Con estas interfaces, podemos probar los servicios de forma aut√≥noma al preparar stubs para todo lo que est√° fuera de cada uno de ellos. <br><br>  ¬øC√≥mo describir la interfaz?  Una de las opciones es documentar todo, pero la documentaci√≥n tiene la propiedad de volverse obsoleta, en el proceso de trabajar en un proyecto, las diferencias comienzan a acumularse entre la documentaci√≥n y el c√≥digo.  Adem√°s, podemos usar las declaraciones de la interfaz Go.  Esta es una opci√≥n interesante, pero es mejor describir la interfaz para que esta descripci√≥n no dependa de un lenguaje de programaci√≥n espec√≠fico.  Esto ser√° √∫til para nosotros en una situaci√≥n muy real, si en el proceso de trabajar en un proyecto se decide implementar algunos de sus servicios en otros idiomas, cuyas capacidades son m√°s adecuadas para resolver sus problemas. <br><br>  Una opci√≥n para describir interfaces es usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">protobuf</a> .  Este es un lenguaje simple y un protocolo independiente del lenguaje para describir mensajes y puntos finales de servicio. <br><br>  Comencemos con la interfaz para el servicio <code>StateStorage</code> .  Presentaremos el estado de la aplicaci√≥n en forma de una estructura de vista de valor clave.  Aqu√≠ est√° el c√≥digo para el archivo <code>statestorage.proto</code> : <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">package</span></span> statestorage; <span class="hljs-attribute"><span class="hljs-attribute">service</span></span> StateStorage { <span class="hljs-attribute"><span class="hljs-attribute">rpc</span></span> WriteKey (WriteKeyInput) returns (WriteKeyOutput); <span class="hljs-attribute"><span class="hljs-attribute">rpc</span></span> ReadKey (ReadKeyInput) returns (ReadKeyOutput); } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> WriteKeyInput { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> key = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> value = <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> WriteKeyOutput { } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> ReadKeyInput { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> key = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> ReadKeyOutput { <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> value = <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br>  Aunque los clientes usan HTTP a trav√©s del servicio <code>PublicApi</code> , tampoco interfiere con la interfaz clara descrita por el mismo medio que el anterior (el archivo <code>publicapi.proto</code> ): <br><br><pre> <code class="hljs pgsql">syntax = "proto3"; package publicapi; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "protocol/transactions.proto"; service PublicApi { rpc Transfer (TransferInput) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (TransferOutput); rpc GetBalance (GetBalanceInput) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (GetBalanceOutput); } message TransferInput { protocol.<span class="hljs-keyword"><span class="hljs-keyword">Transaction</span></span> <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; } message TransferOutput { string success = <span class="hljs-number"><span class="hljs-number">1</span></span>; int32 result = <span class="hljs-number"><span class="hljs-number">2</span></span>; } message GetBalanceInput { protocol.Address <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; } message GetBalanceOutput { string success = <span class="hljs-number"><span class="hljs-number">1</span></span>; int32 result = <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br>  Ahora necesitamos describir las estructuras de datos de <code>Transaction</code> y <code>Address</code> (archivo <code>transactions.proto</code> ): <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">package</span></span> protocol; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Address { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> username = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Transaction { <span class="hljs-attribute"><span class="hljs-attribute">Address</span></span> from = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">Address</span></span> to = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> amount = <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre> <br>  En el proyecto, las protodescripciones de los servicios se colocan en la carpeta <code>/types/services</code> , y las descripciones de las estructuras de datos de prop√≥sito general se encuentran en la carpeta <code>/types/protocol</code> . <br><br>  Una vez que las descripciones de la interfaz est√°n listas, se pueden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">compilar</a> en el c√≥digo Go. <br><br>  Las ventajas de este enfoque son que el c√≥digo que no coincide con la descripci√≥n de la interfaz simplemente no aparece en los resultados de la compilaci√≥n.  El uso de m√©todos alternativos requerir√≠a que escribamos pruebas especiales para verificar que el c√≥digo coincida con las descripciones de la interfaz. <br><br>  Las definiciones completas, los archivos Go generados y las instrucciones de compilaci√≥n se pueden encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .  Esto es posible gracias a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Square Engineering</a> y su desarrollo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">goprotowrap</a> . <br><br>  Tenga en cuenta que en nuestro proyecto la capa de transporte RPC no est√° implementada y el intercambio de datos entre servicios se parece a las llamadas de la biblioteca ordinaria.  Cuando estamos listos para distribuir servicios en diferentes servidores, podemos agregar una capa de transporte como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gRPC</a> al sistema. <br><br><h3>  <font color="#3AC1EF">‚ñç Tipos de pruebas utilizadas en el proyecto</font> </h3><br>  Dado que las pruebas son la clave para un c√≥digo altamente confiable, sugiero que primero hablemos sobre qu√© pruebas escribiremos para nuestro proyecto. <br><br><h4>  Pruebas unitarias </h4><br>  Las pruebas unitarias son el n√∫cleo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">de la pir√°mide de pruebas</a> .  Probaremos cada m√≥dulo de forma aislada.  ¬øQu√© es un m√≥dulo?  En Go, podemos percibir los m√≥dulos como archivos separados en un paquete.  Por ejemplo, si tenemos el archivo <code>/services/publicapi/handlers.go</code> , <code>/services/publicapi/handlers.go</code> la prueba de la unidad en el mismo paquete en <code>/services/publicapi/handlers_test.go</code> . <br><br>  Es mejor colocar pruebas unitarias en el mismo paquete que el c√≥digo de prueba, lo que permite que las pruebas tengan acceso a variables y funciones no exportadas. <br><br><h4>  Pruebas de servicio </h4><br>  El siguiente tipo de prueba se conoce por varios nombres.  Estas son las llamadas pruebas de servicio, integraci√≥n o componentes.  Su esencia es tomar varios m√≥dulos y probar su trabajo conjunto.  Estas pruebas son un nivel m√°s alto que las pruebas unitarias en la pir√°mide de prueba.  En nuestro caso, utilizaremos pruebas de integraci√≥n para probar todo el servicio.  Estas pruebas determinan las especificaciones para el servicio.  Por ejemplo, las pruebas para el servicio <code>StateStorage</code> se colocar√°n en la carpeta <code>/services/statestorage/spec</code> . <br><br>  Es mejor colocar estas pruebas en un paquete que difiera de aquel en el que se encuentra el c√≥digo probado para que el acceso a las capacidades de este c√≥digo se lleve a cabo solo a trav√©s de las interfaces exportadas. <br><br><h4>  Pruebas de punta a punta </h4><br>  Estas pruebas est√°n en la parte superior de la pir√°mide de pruebas, con su ayuda para verificar todo el sistema y todos sus servicios.  Dichas pruebas describen la especificaci√≥n e2e de extremo a extremo para el sistema, por lo que las <code>/e2e/spec</code> en la <code>/e2e/spec</code> . <br><br>  Las pruebas de extremo a extremo, as√≠ como las pruebas de servicio, deben colocarse en un paquete diferente al que se encuentra el c√≥digo probado para que el sistema pueda operarse solo a trav√©s de interfaces exportadas. <br><br>  ¬øQu√© pruebas se deben escribir primero?  ¬øComenzar con la base de la "pir√°mide" y avanzar?  ¬øO empezar arriba y bajar?  Cualquiera de estos enfoques tiene derecho a la vida.  Los beneficios de un enfoque de arriba hacia abajo est√°n en la creaci√≥n de la especificaci√≥n primero para todo el sistema.  Por lo general, es m√°s f√°cil discutir al comienzo del trabajo sobre las caracter√≠sticas del sistema en su conjunto.  Incluso si dividimos el sistema en servicios separados incorrectamente, las especificaciones del sistema permanecer√°n sin cambios.  Esto, adem√°s, nos ayudar√° a comprender que algo, en un nivel inferior, se hace incorrectamente. <br><br>  La desventaja del enfoque de arriba hacia abajo es que las pruebas de extremo a extremo son aquellas que se utilizan despu√©s de todas las dem√°s, cuando se crea todo el sistema que se est√° desarrollando.  Esto significa que generar√°n errores durante mucho tiempo.  Al escribir pruebas para nuestro proyecto, utilizaremos este mismo enfoque. <br><br><h3>  <font color="#3AC1EF">‚ñç Desarrollo de pruebas</font> </h3><br><h4>  Desarrollo de prueba de punta a punta </h4><br>  Antes de crear pruebas, debemos decidir si las escribiremos sin usar herramientas auxiliares o usar alg√∫n tipo de marco.  Confiar en el marco, usarlo como una dependencia de desarrollo, es menos peligroso que confiar en el marco en el c√≥digo que entra en producci√≥n.  En nuestro caso, dado que la biblioteca Go est√°ndar no tiene soporte decente para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">BDD</a> , y este formato es excelente para describir especificaciones, elegiremos una opci√≥n de trabajo que incluya el uso de un marco. <br><br>  Hay muchos marcos excelentes que dan lo que necesitamos.  Entre ellos est√°n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GoConvey</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ginkgo</a> . <br><br>  Personalmente, me gusta usar una combinaci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ginkgo</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Gomega</a> (nombres terribles, pero qu√© hacer) que usan construcciones sint√°cticas como <code>Describe()</code> y <code>It()</code> . <br><br>  ¬øC√≥mo ser√°n nuestras pruebas?  Por ejemplo, aqu√≠ hay una prueba para el mecanismo de verificaci√≥n de saldo del usuario (archivo <code>sanity.go</code> ): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> spec <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = Describe(<span class="hljs-string"><span class="hljs-string">"Sanity"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( node services.Node ) BeforeEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { node = services.NewNode() node.Start() }) AfterEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { node.Stop() }) It(<span class="hljs-string"><span class="hljs-string">"should show balances with GET /api/balance"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { resp, err := http.Get(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/balance?from=user1"</span></span>) Expect(err).ToNot(HaveOccurred()) Expect(resp.StatusCode).To(Equal(http.StatusOK)) Expect(ResponseBodyAsString(resp)).To(Equal(<span class="hljs-string"><span class="hljs-string">"0"</span></span>)) }) })</code> </pre> <br>  Dado que el servidor es accesible desde el mundo exterior a trav√©s de HTTP, trabajaremos con su API web utilizando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://golang.org/pkg/net/">http.Get</a> .  ¬øQu√© pasa con las pruebas transaccionales?  Aqu√≠ est√° el c√≥digo para la prueba correspondiente: <br><br><pre> <code class="hljs lisp">It(<span class="hljs-string"><span class="hljs-string">"should transfer funds with POST /api/transfer"</span></span>, func() { resp, err <span class="hljs-symbol"><span class="hljs-symbol">:=</span></span> http.Get(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/transfer?from=user1&amp;to=user2&amp;amount=17"</span></span>) Expect(<span class="hljs-name"><span class="hljs-name">err</span></span>).ToNot(<span class="hljs-name"><span class="hljs-name">HaveOccurred</span></span>()) Expect(<span class="hljs-name"><span class="hljs-name">resp</span></span>.StatusCode).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-name"><span class="hljs-name">http</span></span>.StatusOK)) Expect(<span class="hljs-name"><span class="hljs-name">ResponseBodyAsString</span></span>(<span class="hljs-name"><span class="hljs-name">resp</span></span>)).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-string"><span class="hljs-string">"-17"</span></span>)) resp, err = http.Post(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/balance?from=user2"</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) Expect(<span class="hljs-name"><span class="hljs-name">err</span></span>).ToNot(<span class="hljs-name"><span class="hljs-name">HaveOccurred</span></span>()) Expect(<span class="hljs-name"><span class="hljs-name">resp</span></span>.StatusCode).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-name"><span class="hljs-name">http</span></span>.StatusOK)) Expect(<span class="hljs-name"><span class="hljs-name">ResponseBodyAsString</span></span>(<span class="hljs-name"><span class="hljs-name">resp</span></span>)).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-string"><span class="hljs-string">"17"</span></span>)) })</code> </pre><br>  El c√≥digo de prueba describe perfectamente su esencia, incluso puede reemplazar la documentaci√≥n.  Como puede ver, admitimos la presencia de saldos de cuenta de usuario negativos.  Esta es una caracter√≠stica de nuestro proyecto.  Si estuviera prohibido, esta decisi√≥n se reflejar√≠a en la prueba. <br><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu√≠ est√° el</a> c√≥digo de prueba completo <br><br><h4>  Desarrollo de prueba de servicio </h4><br>  Ahora, despu√©s de desarrollar pruebas de extremo a extremo, bajamos por la pir√°mide de pruebas y procedemos a crear pruebas de servicio.  Dichas pruebas se desarrollan para cada servicio individual.  Elegimos un servicio que depende de otro servicio, ya que este caso es m√°s interesante que desarrollar pruebas para un servicio independiente. <br><br>  Comencemos con el servicio <code>VirtualMachine</code> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu√≠</a> puede encontrar la interfaz con protodescripciones para este servicio.  Como el servicio <code>StateStorage</code> basa en el servicio <code>StateStorage</code> y realiza llamadas a √©l, necesitaremos crear un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">objeto simulado</a> para el servicio <code>StateStorage</code> para probar el servicio <code>VirtualMachine</code> de forma aislada.  El objeto de c√≥digo auxiliar nos permite controlar <code>StateStorage</code> respuestas de <code>StateStorage</code> durante las pruebas. <br><br>  ¬øC√≥mo implementar un objeto stub en Go?  Esto se puede hacer exclusivamente por medio del lenguaje, sin herramientas auxiliares, o puede recurrir a la biblioteca apropiada, que, adem√°s, permitir√° trabajar con las declaraciones en el proceso de prueba.  Para este prop√≥sito, prefiero usar la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">go-mock</a> . <br><br>  <code>/services/statestorage/mock.go</code> el c√≥digo auxiliar en el archivo <code>/services/statestorage/mock.go</code> .  Es mejor colocar objetos de c√≥digo auxiliar en el mismo lugar que las entidades que imitan para darles acceso a funciones y variables no exportadas.  El ap√©ndice en esta etapa es una implementaci√≥n esquem√°tica del servicio, pero, a medida que el servicio se desarrolla, es posible que necesitemos desarrollar la implementaci√≥n del ap√©ndice.  Aqu√≠ est√° el c√≥digo para el objeto de c√≥digo auxiliar (archivo <code>mock.go</code> ): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> statestorage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> MockService <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { mock.Mock } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { s.Called() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { s.Called() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s.Called().Bool(<span class="hljs-number"><span class="hljs-number">0</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(input *statestorage.WriteKeyInput)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*statestorage.WriteKeyOutput, error)</span></span></span></span> { ret := s.Called(input) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret.Get(<span class="hljs-number"><span class="hljs-number">0</span></span>).(*statestorage.WriteKeyOutput), ret.Error(<span class="hljs-number"><span class="hljs-number">1</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(input *statestorage.ReadKeyInput)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*statestorage.ReadKeyOutput, error)</span></span></span></span> { ret := s.Called(input) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret.Get(<span class="hljs-number"><span class="hljs-number">0</span></span>).(*statestorage.ReadKeyOutput), ret.Error(<span class="hljs-number"><span class="hljs-number">1</span></span>) }</code> </pre> <br>  Si brinda el desarrollo de servicios individuales a diferentes programadores, tiene sentido crear primero talones y pasarlos al equipo. <br><br>  Volvamos al desarrollo de una prueba de servicio para <code>VirtualMachine</code> .  ¬øQu√© escenario debo verificar aqu√≠?  Es mejor centrarse en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la interfaz de</a> servicio y las pruebas de dise√±o para cada punto final.  Implementamos una prueba para el punto final <code>CallContract()</code> con un argumento que representa el m√©todo <code>"GetBalance"</code> .  Aqu√≠ est√° el c√≥digo correspondiente (archivo <code>contracts.go</code> ): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> spec <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = Describe(<span class="hljs-string"><span class="hljs-string">"Contracts"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( service uut.Service stateStorage *_statestorage.MockService ) BeforeEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { service = uut.NewService() stateStorage = &amp;_statestorage.MockService{} service.Start(stateStorage) }) AfterEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { service.Stop() }) It(<span class="hljs-string"><span class="hljs-string">"should support 'GetBalance' contract method"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { stateStorage.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, &amp;statestorage.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}).Return(&amp;statestorage.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">100</span></span>}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) addr := protocol.Address{Username: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>} out, err := service.CallContract(&amp;virtualmachine.CallContractInput{Method: <span class="hljs-string"><span class="hljs-string">"GetBalance"</span></span>, Arg: &amp;addr}) Expect(err).ToNot(HaveOccurred()) Expect(out.Result).To(BeEquivalentTo(<span class="hljs-number"><span class="hljs-number">100</span></span>)) Expect(stateStorage).To(ExecuteAsPlanned()) }) })</code> </pre><br>  Tenga en cuenta que el servicio que estamos probando, <code>VirtualMachine</code> , obtiene un puntero a su dependencia, <code>StateStorage</code> , en el m√©todo <code>Start()</code> trav√©s de un mecanismo de inyecci√≥n de dependencia simple.  Aqu√≠ es donde pasamos la instancia del objeto stub.  Adem√°s, preste atenci√≥n a la l√≠nea <code>stateStorage.When("ReadKey", &amp;statestorage.ReadKeyInput{Key‚Ä¶</code> , donde le decimos al objeto auxiliar c√≥mo debe comportarse al acceder a √©l. Cuando se <code>ReadKey</code> m√©todo <code>ReadKey</code> , debe devolver un valor 100. Luego, en la l√≠nea <code>Expect(stateStorage).To(ExecuteAsPlanned())</code> , verificamos que este comando se llame exactamente una vez. <br><br>  Pruebas similares se convierten en especificaciones para el servicio.  El conjunto completo de pruebas para el servicio <code>VirtualMachine</code> se puede encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .  Las suites de prueba para otros servicios de nuestro proyecto se pueden encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br><h4>  Desarrollo de pruebas unitarias </h4><br>  Quiz√°s la implementaci√≥n del contrato para el m√©todo <code>"GetBalance"</code> sea ‚Äã‚Äãdemasiado simple, as√≠ <code>"GetBalance"</code> hablemos de implementar un m√©todo de <code>"Transfer"</code> un poco m√°s complejo.  El contrato para transferir fondos de una cuenta a otra representada por este m√©todo necesita leer datos sobre los saldos del remitente y el destinatario de los fondos, calcular nuevos saldos y registrar lo que sucedi√≥ en el estado de la solicitud.  La prueba de servicio para todo esto es muy similar a la que acabamos de implementar (archivo <code>transactions.go</code> ): <br><br><pre> <code class="hljs lisp">It(<span class="hljs-string"><span class="hljs-string">"should support 'Transfer' transaction method"</span></span>, func() { stateStorage.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">100</span></span>}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) stateStorage.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">50</span></span>}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) stateStorage.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">90</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.WriteKeyOutput{}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) stateStorage.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">60</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.WriteKeyOutput{}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-literal"><span class="hljs-literal">t</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:=</span></span> protocol.Transaction{From: <span class="hljs-symbol"><span class="hljs-symbol">&amp;protocol</span></span>.Address{Username: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}, To: <span class="hljs-symbol"><span class="hljs-symbol">&amp;protocol</span></span>.Address{Username: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>}, Amount: <span class="hljs-number"><span class="hljs-number">10</span></span>} out, err <span class="hljs-symbol"><span class="hljs-symbol">:=</span></span> service.ProcessTransaction(<span class="hljs-name"><span class="hljs-name">&amp;virtualmachine</span></span>.ProcessTransactionInput{Method: <span class="hljs-string"><span class="hljs-string">"Transfer"</span></span>, Arg: <span class="hljs-symbol"><span class="hljs-symbol">&amp;t</span></span>}) Expect(<span class="hljs-name"><span class="hljs-name">err</span></span>).ToNot(<span class="hljs-name"><span class="hljs-name">HaveOccurred</span></span>()) Expect(<span class="hljs-name"><span class="hljs-name">out</span></span>.Result).To(<span class="hljs-name"><span class="hljs-name">BeEquivalentTo</span></span>(<span class="hljs-number"><span class="hljs-number">90</span></span>)) Expect(<span class="hljs-name"><span class="hljs-name">stateStorage</span></span>).To(<span class="hljs-name"><span class="hljs-name">ExecuteAsPlanned</span></span>()) })</code> </pre> <br>  En el proceso de trabajar en el proyecto, finalmente llegamos a crear sus mecanismos internos y creamos un m√≥dulo ubicado en el archivo <code>processor.go</code> , que contiene la implementaci√≥n del contrato.  Aqu√≠ est√° la versi√≥n original (archivo <code>processor.go</code> ): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> virtualmachine <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *service)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processTransfer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fromUsername </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, toUsername </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, amount </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int32</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int32</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { fromBalance, err := s.stateStorage.ReadKey(&amp;statestorage.ReadKeyInput{Key: fromUsername}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } toBalance, err := s.stateStorage.ReadKey(&amp;statestorage.ReadKeyInput{Key: toUsername}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } _, err = s.stateStorage.WriteKey(&amp;statestorage.WriteKeyInput{Key: fromUsername, Value: fromBalance.Value - amount}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } _, err = s.stateStorage.WriteKey(&amp;statestorage.WriteKeyInput{Key: toUsername, Value: toBalance.Value + amount}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fromBalance.Value - amount, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre><br>  Este dise√±o satisface la prueba de servicio, pero en nuestro caso, la prueba de integraci√≥n contiene solo una prueba del escenario b√°sico.  ¬øQu√© pasa con los casos l√≠mite y las posibles fallas?  Como puede ver, cualquiera de las llamadas que hacemos a <code>StateStorage</code> puede fallar.  Si se requiere una cobertura del 100% del c√≥digo con las pruebas, debemos verificar todas estas situaciones.  La prueba unitaria es excelente para implementar tales pruebas. <br><br>  Dado que vamos a llamar a la funci√≥n varias veces con diferentes datos de entrada y simular los par√°metros para llegar a todas las ramas del c√≥digo, para que este proceso sea m√°s eficiente, podemos recurrir a pruebas basadas en tablas.  Ir tiende a evitar marcos de prueba de unidad ex√≥ticos.  Podemos rechazar el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ginkgo</a> , pero probablemente deber√≠amos abandonar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Gomega</a> .  Como resultado, las comprobaciones realizadas aqu√≠ ser√°n similares a las que realizamos en las pruebas anteriores.  Aqu√≠ est√° el c√≥digo de prueba (archivo <code>processor_test.go</code> ): <br><br><pre> <code class="hljs lua"><span class="hljs-built_in"><span class="hljs-built_in">package</span></span> virtualmachine import ... var transferTable = []struct{ to <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> //  ,    read1Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       read2Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       write1Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       write2Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> int32 //   errs bool //        }{ {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>}, } func TestTransfer(t *testing.T) { Œ© := NewGomegaWithT(t) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, tt := range transferTable { s := NewService() ss := &amp;_statestorage.MockService{} s.Start(ss) ss.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, &amp;statestorage.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}).Return(&amp;statestorage.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">100</span></span>}, tt.read1Err) ss.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, &amp;statestorage.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>}).Return(&amp;statestorage.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">50</span></span>}, tt.read2Err) ss.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, &amp;statestorage.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">90</span></span>}).Return(&amp;statestorage.WriteKeyOutput{}, tt.write1Err) ss.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, &amp;statestorage.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">60</span></span>}).Return(&amp;statestorage.WriteKeyOutput{}, tt.write2Err) <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>, err := s.(*service).processTransfer(<span class="hljs-string"><span class="hljs-string">"user1"</span></span>, tt.to, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tt.errs { Œ©.Expect(err).To(HaveOccurred()) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Œ©.Expect(err).ToNot(HaveOccurred()) Œ©.Expect(<span class="hljs-built_in"><span class="hljs-built_in">output</span></span>).To(BeEquivalentTo(tt.<span class="hljs-built_in"><span class="hljs-built_in">output</span></span>)) } } }</code> </pre> <br>     ¬´Œ©¬ª ‚Äî  ,    ‚Äî    (     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Gomega</a> ).          . <br><br>        ,        TDD,          ,     ,     .       <code>processTransfer()</code>         . <br><br>       <code>VirtualMachine</code>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> . <br><br>    100%   .    ,    .             . <br><br>   ,        ?   .        , ,    ,     . <br><br><h3> <font color="#3AC1EF">‚ñç  -</font> </h3><br>              .         ?  HTTP-  Go     (goroutine).     ,  ‚Äî        ,     . ,      ,  ,   . <br><br>           -               . ,   ,   ,          ,        .  -     <code>/e2e/stress</code> .   - ( <code>stress.go</code> ): <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> stress import ... const NUM_TRANSACTIONS = <span class="hljs-number"><span class="hljs-number">20000</span></span> const NUM_USERS = <span class="hljs-number"><span class="hljs-number">100</span></span> const TRANSACTIONS_PER_BATCH = <span class="hljs-number"><span class="hljs-number">200</span></span> const BATCHES_PER_SEC = <span class="hljs-number"><span class="hljs-number">40</span></span> var <span class="hljs-number"><span class="hljs-number">_</span></span> = Describe(<span class="hljs-string"><span class="hljs-string">"Transaction Stress Test"</span></span>, func() { var ( node services.Node ) BeforeEach(func() { node = services.NewNode() node.Start() }) AfterEach(func() { node.Stop() }) It(<span class="hljs-string"><span class="hljs-string">"should handle lots and lots of transactions"</span></span>, func() { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  HTTP-     transport := http.Transport{ IdleConnTimeout: time.Second*<span class="hljs-number"><span class="hljs-number">20</span></span>, MaxIdleConns: TRANSACTIONS_PER_BATCH*<span class="hljs-number"><span class="hljs-number">10</span></span>, MaxIdleConnsPerHost: TRANSACTIONS_PER_BATCH*<span class="hljs-number"><span class="hljs-number">10</span></span>, } client := &amp;http.Client{Transport: &amp;transport} //      ledger := <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[string]int32{} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NUM_USERS; i++ { ledger[fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"user%d"</span></span>, i+<span class="hljs-number"><span class="hljs-number">1</span></span>)] = <span class="hljs-number"><span class="hljs-number">0</span></span> } //     HTTP   rand.Seed(<span class="hljs-number"><span class="hljs-number">42</span></span>) done := make(chan error, TRANSACTIONS_PER_BATCH) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NUM_TRANSACTIONS / TRANSACTIONS_PER_BATCH; i++ { log.Printf(<span class="hljs-string"><span class="hljs-string">"Sending %d transactions... (batch %d out of %d)"</span></span>, TRANSACTIONS_PER_BATCH, i+<span class="hljs-number"><span class="hljs-number">1</span></span>, NUM_TRANSACTIONS / TRANSACTIONS_PER_BATCH) time.Sleep(time.Second / BATCHES_PER_SEC) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j := <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; TRANSACTIONS_PER_BATCH; j++ { from := randomizeUser() to := randomizeUser() amount := randomizeAmount() ledger[from] -= amount ledger[to] += amount go sendTransaction(client, from, to, amount, &amp;done) } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j := <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; TRANSACTIONS_PER_BATCH; j++ { err := &lt;- done Expect(err).ToNot(HaveOccurred()) } } //   <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NUM_USERS; i++ { user := fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"user%d"</span></span>, i+<span class="hljs-number"><span class="hljs-number">1</span></span>) resp, err := client.Get(fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/balance?from=%s"</span></span>, user)) Expect(err).ToNot(HaveOccurred()) Expect(resp.StatusCode).To(Equal(http.StatusOK)) Expect(ResponseBodyAsString(resp)).To(Equal(fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"%d"</span></span>, ledger[user]))) } }) }) func randomizeUser() string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"user%d"</span></span>, rand.Intn(NUM_USERS)+<span class="hljs-number"><span class="hljs-number">1</span></span>) } func randomizeAmount() int32 { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rand.Int31n(<span class="hljs-number"><span class="hljs-number">1000</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span> } func sendTransaction(client *http.Client, from string, to string, amount int32, done *chan error) { url := fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/transfer?from=%s&amp;to=%s&amp;amount=%d"</span></span>, from, to, amount) resp, err := client.Post(url, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, nil) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err == nil { ioutil.ReadAll(resp.Body) resp.Body.Close() } *done &lt;- err }</code> </pre> <br>    ,  -   .           (       <code>rand.Seed(42)</code> )  ,    .         .     ,            ,  ‚Äî ,     . <br><br>    -  HTTP   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>          TCP- (     ,     ,           ).  ,  ,              200     <code>IdleConnection</code>    TCP-   .       ,      100. <br><br>  ‚Ä¶   : <br><br><pre> <code class="hljs go">fatal error: concurrent <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> writes goroutine <span class="hljs-number"><span class="hljs-number">539</span></span> [running]: runtime.throw(<span class="hljs-number"><span class="hljs-number">0x147bf</span></span>60, <span class="hljs-number"><span class="hljs-number">0x15</span></span>) /usr/local/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/runtime/<span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">616</span></span> +<span class="hljs-number"><span class="hljs-number">0x81</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc4207159d</span></span>8 sp=<span class="hljs-number"><span class="hljs-number">0xc4207159b8</span></span> pc=<span class="hljs-number"><span class="hljs-number">0x102ca01</span></span> runtime.mapassign_faststr(<span class="hljs-number"><span class="hljs-number">0x13f</span></span>5140, <span class="hljs-number"><span class="hljs-number">0xc4201ca0c0</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4203a8097</span></span>, <span class="hljs-number"><span class="hljs-number">0x6</span></span>, <span class="hljs-number"><span class="hljs-number">0x1012001</span></span>) /usr/local/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/runtime/hashmap_fast.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">703</span></span> +<span class="hljs-number"><span class="hljs-number">0x3e9</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc420715a48</span></span> sp=<span class="hljs-number"><span class="hljs-number">0xc4207159d</span></span>8 pc=<span class="hljs-number"><span class="hljs-number">0x100d</span></span>879 services/statestorage.(*service).WriteKey(<span class="hljs-number"><span class="hljs-number">0xc42000c060</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4209e6800</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4206491a0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>) services/statestorage/methods.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> +<span class="hljs-number"><span class="hljs-number">0x10c</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc420715a88</span></span> sp=<span class="hljs-number"><span class="hljs-number">0xc420715a48</span></span> pc=<span class="hljs-number"><span class="hljs-number">0x138339c</span></span> services/virtualmachine.(*service).processTransfer(<span class="hljs-number"><span class="hljs-number">0xc4201ca090</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4203a8097</span></span>, <span class="hljs-number"><span class="hljs-number">0x6</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4203a80a1</span></span>, <span class="hljs-number"><span class="hljs-number">0x6</span></span>, <span class="hljs-number"><span class="hljs-number">0x2a4</span></span>, <span class="hljs-number"><span class="hljs-number">0xc420715b30</span></span>, <span class="hljs-number"><span class="hljs-number">0x1012928</span></span>, <span class="hljs-number"><span class="hljs-number">0x40</span></span>) services/virtualmachine/processor.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> +<span class="hljs-number"><span class="hljs-number">0x16e</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc420715ad</span></span>0 sp=<span class="hljs-number"><span class="hljs-number">0xc420715a88</span></span> pc=<span class="hljs-number"><span class="hljs-number">0x13840ee</span></span> services/virtualmachine.(*service).ProcessTransaction(<span class="hljs-number"><span class="hljs-number">0xc4201ca090</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4209e67c0</span></span>, <span class="hljs-number"><span class="hljs-number">0x30</span></span>, <span class="hljs-number"><span class="hljs-number">0x1433660</span></span>, <span class="hljs-number"><span class="hljs-number">0x12a1d</span></span>01) Ginkgo ran <span class="hljs-number"><span class="hljs-number">1</span></span> suite in <span class="hljs-number"><span class="hljs-number">1.288879763s</span></span> Test Suite Failed</code> </pre> <br>  ?   <code>StateStorage</code>       ( <code>map</code> ),   . ,     ,            .     ,           <code>map</code>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sync.map</a> .     . <br><br>     <a href="">processTransfer()</a> .         ,   ‚Äî      .         , ,         ,        ,     .     ,          <code>processTransfer()</code> . <a href=""></a>  . <br><br>    ,   . ,    ,     . <br><br><pre> <code class="hljs go">e2e/stress/transactions.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span> Expected &lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;: <span class="hljs-number"><span class="hljs-number">-7498</span></span> to equal &lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;: <span class="hljs-number"><span class="hljs-number">-7551</span></span> e2e/stress/transactions.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">82</span></span> ------------------------------ Ginkgo ran <span class="hljs-number"><span class="hljs-number">1</span></span> suite in <span class="hljs-number"><span class="hljs-number">5.251593179s</span></span> Test Suite Failed</code> </pre> <br>       ,    . ,   ,          ( ,           ).    ,   <a href=""></a> ,    . <br><br>  ‚Äî  .    TDD         .   ?           ,       100%?!   ,    ‚Äî      .    <code>processTransfer()</code>      ,       ,    . <br><br>             .  ,       <a href=""></a>   ,   . <a href=""></a>    . <br><br><h2>  <font color="#3AC1EF">Resumen</font> </h2><br> , ,  ,     -,      ,      ,  ?     ?   ‚Äî . <br><br>       ,     -.  ,  ¬´¬ª  <code>processTransfer()</code>      .  ,  ,    <a href=""></a> .         ,   ‚Äî .    ,      -       .     ,        ,        . <br><br>     . ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> .  ,     <code>StateStorage</code>   <code>WriteKey</code> ,     , , ,     <code>WriteKeys</code>    ,         ,       . <br><br>   ,        :          .            ¬´ ¬ª.       -,        ,  ,     ,    ,      .   ‚Äî     .     ,   ,    ‚Äî      . <br><br>       ,       ‚Äî   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>  GitHub.          .  ,   ,    , , ,     ,      . <br><br>  <b>Estimados lectores!</b>        ? <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es413681/">https://habr.com/ru/post/es413681/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es413669/index.html">Samsung IT School: ense√±ando a los estudiantes c√≥mo desarrollar aplicaciones m√≥viles</a></li>
<li><a href="../es413673/index.html">Sobre el tema del rendimiento de versiones antiguas y nuevas de un nodo</a></li>
<li><a href="../es413675/index.html">Joker 2018: Club de desarrolladores Java an√≥nimos</a></li>
<li><a href="../es413677/index.html">Lanzamiento de ROS en el robot de autoequilibrio EduMIP</a></li>
<li><a href="../es413679/index.html">Angular 6. PWA M√≥dulos de carga lenta. Despliegue autom√°tico en Firebase</a></li>
<li><a href="../es413683/index.html">ILV ha desbloqueado 7 millones de direcciones IP. Permanecer bloqueado 4 millones</a></li>
<li><a href="../es413689/index.html">Debian + Postfix + Dovecot + Multidomain + SSL + IPv6 + OpenVPN + Multi-interfaces + SpamAssassin-learn + Bind</a></li>
<li><a href="../es413691/index.html">Inicio</a></li>
<li><a href="../es413693/index.html">Hecho a mano: teclado programable para el comercio en l√≠nea h√°galo usted mismo</a></li>
<li><a href="../es413695/index.html">Seguridad de mensajer√≠a: por qu√© almacenar mensajes en blockchain podr√≠a ser una buena idea</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>