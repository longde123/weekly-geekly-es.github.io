<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143967986-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-143967986-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëáüèø üë©‚Äçüë©‚Äçüëß‚Äçüëß üîê Second wind Pandora DXL 3000 or how I screwed my own telemetry üßëüèø‚Äçü§ù‚Äçüßëüèª üë∏üèø üë©üèª‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Perhaps the familiar situation led me to develop my own telemetry - it worked, but it stopped. One evening, the car alarm unit ceased to perceive the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Second wind Pandora DXL 3000 or how I screwed my own telemetry</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479216/">  Perhaps the familiar situation led me to develop my own telemetry - it worked, but it stopped.  One evening, the car alarm unit ceased to perceive the keychain.  I understood that first you need to try to rebind the keychain, for which it was necessary to perform a simple procedure, clearly following the instructions from the installation manual.  The execution of the procedure became impossible, since the car alarm was in armed mode, which could be disabled by the Valet button by entering the service code. <br><br>  I never tried to remember the service code, and even more so the master code.  I tried unsuccessfully to recall several codes for memory.  Within a few minutes I had to steal my car.  The trill from the siren in my ears then stood for a long time, since the siren was installed in the passenger compartment.  I don‚Äôt remember why I placed the siren exactly there - either out of my own laziness, or saw some sense in this.  You know, from a personal experienced feeling, this can lead to severe confusion for an unprepared villain.  To my deep regret, I had to dismantle the unit.  I began to figure out what to do next and what to do about it.  Who cares what happened in the end, I ask for a cat. <br><a name="habracut"></a><br>  I had several hypotheses: <br><br><ol><li>  Failures in the operation of the antenna module. </li><li>  Non-volatile memory failure in the main block.  As a result, data about key fobs and their synchronization could be damaged. </li><li>  Failure of non-volatile memory of the transmitter.  The consequences are similar to paragraph 2. </li><li>  Signal jamming in preparation for theft. </li></ol><br>  I checked the option with the presence of a signal jammer as soon as I moved to a safe place.  Car alarms also did not respond to the key fob. <br><br>  I turned to the dealer about the availability of those.  the ability to reset service codes.  I was told that there was no such opportunity and you would have to purchase a new kit for several thousand rubles.  Yes, and it will be better if you install all this business with us - they said, giving away several thousand more.  This answer did not surprise me at all, IMHO, of course!  It is better for the dealer to sell a new kit than to carry out service.  Then all of a sudden I felt how my mood improved dramatically, the thought arose to sort things out on my own, finding out along the way whether codes could be reset or not.  In general, it is precisely such moments that prompt alternatives, reverse, development, and DIY.  I challenged myself. <br><br>  I did not start at all with digging in blocks, but with an alternative.  While Pandora was lying in the closet, I tried to make my own module.  I figured that if you develop your own car alarm module, it will be immediately cool, reliable, flexible and absolutely not difficult.  What can I say, all this was sheer enthusiasm.  I spent several weeks writing the firmware and prototyping the module.  The process was completely creative.  So, all of a sudden, an idea came to me and I realized it with pleasure.  For example, already at the stage of a working prototype with the necessary reels, transistors and GSM, I suddenly wanted to add more GPS and Bluetooth.  Well, why pull the cat by the tail?  Let the module be cool right away, as I initially figured out, and I had to change the microcontroller to a bold one, since ATMega328 has only one UART port.  To get something common from AVR and with three UARTs seemed to me an unrealistic undertaking.  I did not like the option of implementing software UART, for the simple reason that the hardware is more reliable.  I remember how STM32 already flashed with might and main in various articles on electronics and was available to order on AliExpress.  Without hesitation, I wrote myself a pair of STM32F103, since it was a real 32-bit microcontroller with a large amount of memory and rich peripherals, and even more so with the necessary number of UART.  I had no experience of programming STM32 at that time, but this only arose the interest of learning something new. <br><br>  In anticipation of the arrival of microcontrollers, it was decided to postpone the prototype and not just wait, but check the hypotheses that remained. <br><br>  Winter was approaching, and the car without ‚Äúsupervision‚Äù somehow did not inspire comfort.  Everything continued until once I looked under the cover of the car alarm unit.  Inside I discovered ATMega324!  My joy knew no bounds, as it was an AVR, which means you could work with it properly.  The first thing I did was to check the UART and SPI wiring.  ATMega324 has 2 UART ports.  One UART is connected to the shift register, and the second to the antenna module connector.  The SPI circuits led me to an unsoldered block (in the photo near the quartz in the lower left corner of the board). <br><br><img src="https://habrastorage.org/webt/1t/u9/el/1tu9el_7ehmsadjvf5nd8qhwrjg.jpeg"><br><br>  Quickly soldered the block and connected the programmer.  Reading firmware and EEPROM resulted in empty dumps.  Of course, the developer could not allow such a puncture.  Checked the exchange between the unit and the antenna module.  The TX line was clear at the time of the alarm.  This could mean that the number of trinkets in memory is 0. The antenna module was not at all talkative.  It also turned out that the microcontroller controls the power of the antenna module through a transistor switch.  The input voltage was detected at the output of the key, and according to the instructions it should be + 5V.  All this seemed a little strange to me.  Maybe for this reason the antenna module was silent?  I did not have any options for testing hypotheses.  What about the fuse bits?  Such a surprise!  Firmware is allowed in firmware via the SPI interface.  Well, now how to sit still exactly?  That's right - write your firmware!  It was such a hardcore option, because in addition to the firmware itself, I also had to ring the board. <br><br>  Protective varnish interfered with the process, but armed with probes with a sharp tip, things went much better.  It turned out that the varnish layer did not peel off, but gently pierced in the right places.  The ringing board took two evenings. <br><br><div class="spoiler">  <b class="spoiler_title">Microcontroller port pinout</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><th>  Pin number </th><th>  CPU pin </th><th>  Documentation Connector </th><th>  Connector Output Number </th><th>  Purpose according to the documentation of the installation card </th></tr><tr><td>  9 </td><td>  PD0 (RXD0 / PCINT24) </td><td>  X1 </td><td>  RX / CALL </td><td>  Antenna RX signal and CALL BUTTON button input </td></tr><tr><td>  10 </td><td>  PD1 (TXD0 / PCINT25) </td><td>  X1 </td><td>  TX </td><td>  TX antenna signal </td></tr><tr><td>  eleven </td><td>  PD2 -&gt; 6C595 RCK pin </td><td></td><td></td><td></td></tr><tr><td>  12 </td><td>  PD3 -&gt; 6C595 SER IN pin </td><td></td><td></td><td></td></tr><tr><td>  thirteen </td><td>  PD4 -&gt; 6C595 SRCK pin </td><td></td><td></td><td></td></tr><tr><td>  14 </td><td>  PD5 </td><td>  X5 </td><td>  COM </td><td>  IButton Button Input </td></tr><tr><td>  fifteen </td><td>  PD6 </td><td>  X4, X4a </td><td>  Dq </td><td>  DQ signal from engine and interior temperature sensors </td></tr><tr><td>  16 </td><td>  PD7 </td><td>  X7 </td><td></td><td>  Main Level Trigger Input </td></tr><tr><td>  3 </td><td>  PB7 / SCK -&gt; 6C595 CLR </td><td></td><td></td><td></td></tr><tr><td>  2 </td><td>  PB6 </td><td>  X8 </td><td>  5 </td><td>  CH5 output (300mA) - </td></tr><tr><td>  1 </td><td>  PB5 </td><td>  X8 </td><td>  2 </td><td>  Output CH4 (1A) - </td></tr><tr><td>  PB4 </td><td>  X8 </td><td>  3 </td><td></td><td>  CH2 output (500mA) - </td></tr><tr><td>  43 </td><td>  PB3 </td><td>  X8 </td><td>  20 </td><td>  Signal input from tachometer, injector, generator </td></tr><tr><td>  42 </td><td>  PB2 </td><td>  X8 </td><td>  4 </td><td>  CH3 output (300mA) - </td></tr><tr><td>  41 </td><td>  PB1 </td><td>  X8 </td><td>  13, 14 </td><td>  Left turn light <br>  Right Turn Lamp <br></td></tr><tr><td>  40 </td><td>  PB0 </td><td>  X8 </td><td>  18 </td><td>  Relay CH1 (15 A) <br>  15, 16 -&gt; 18 <br></td></tr><tr><td>  37 </td><td>  PA0 </td><td></td><td></td><td>  Accelerometer (X axis) </td></tr><tr><td>  36 </td><td>  PA1 </td><td></td><td></td><td>  Accelerometer (Y axis) </td></tr><tr><td>  35 </td><td>  PA2 </td><td>  X3 </td><td>  COM </td><td>  Valet / voltage measurement button </td></tr><tr><td>  34 </td><td>  PA3 </td><td></td><td></td><td></td></tr><tr><td>  33 </td><td>  PA4 </td><td>  X8 </td><td>  8 </td><td>  Trunk Limit Switch (¬±) </td></tr><tr><td>  32 </td><td>  PA5 </td><td>  X8 </td><td>  eleven </td><td>  Door limit switch (¬±) </td></tr><tr><td>  31 </td><td>  PA6 </td><td>  X8 </td><td>  19 </td><td>  Input from neutral / handbrake sensor (¬±) </td></tr><tr><td>  thirty </td><td>  PA7 </td><td>  X8 </td><td>  7 </td><td>  Input from oil sensor, lamp charge (¬±) </td></tr><tr><td>  19 </td><td>  PC0 </td><td>  X7 </td><td></td><td>  Pre Level Trigger Input </td></tr><tr><td>  20 </td><td>  PC1 </td><td>  X6 </td><td>  1 </td><td>  Red indicator </td></tr><tr><td>  21 </td><td>  PC2 </td><td>  X6 </td><td>  2 </td><td>  Green indicator </td></tr><tr><td>  22 </td><td>  PC3 </td><td>  X1 </td><td>  + 12V </td><td>  Antenna power </td></tr><tr><td>  23 </td><td>  Pc4 </td><td>  X8 </td><td>  21 </td><td>  Input from the brake pedal button </td></tr><tr><td>  24 </td><td>  PC5 </td><td>  X8 </td><td>  10 </td><td>  Ignition input </td></tr><tr><td>  25 </td><td>  PC6 </td><td></td><td></td><td></td></tr><tr><td>  26 </td><td>  Pc7 </td><td>  X8 </td><td>  17 </td><td>  Siren </td></tr></tbody></table></div><br><br></div></div><br><br>  I wrote a test firmware, flashed it, clicked with reels - great!  The antenna module and keyfob were already useless.  So if you can write the firmware for the car alarm unit, using all its ready-made circuitry and connection points in the car, it remains to solve the problem with the communication channel.  I thought, what if you leave GSM and GPS in your project, throw out Bluetooth and screw it all to Pandora car alarms?  Well, of course, this is the best option!  Firstly, it was not necessary to prepare a complex board, the Pandora circuitry solved many problems, but I just needed to make an expansion module that would be connected instead of the standard antenna module.  As you can understand, the waiting period for microcontrollers from China has not passed noticeably. <br><br>  To connect all the modules to each other, I etched the board.  She is very simple.  In it, the finished GPS, GSM modules and the car alarm unit are connected to the UART ports of the STM32 microcontroller. <br><br><img src="https://habrastorage.org/webt/tt/ec/wt/ttecwtsyfttz4b_mosb3ryydgeq.jpeg"><br><br>  The filling of the module is located in the case of the power supply unit from the laptop. <br><br><img src="https://habrastorage.org/webt/k3/dz/qw/k3dzqwjwabwqdcc6e0mywrx9lri.jpeg"><br><br>  The DC-DC converter did not want to be placed inside the enclosure and had to find a more spacious enclosure.  As a result, the pencil case from the front of the SUPRA radio with a convenient snap-on mechanism was very suitable for the case. <br><br><img src="https://habrastorage.org/webt/q0/st/sp/q0stspdrfsjnsqkxhxypr_79hi0.jpeg"><br><br>  The board was coated with polyurethane varnish. <br><br>  Components.  Everything is simple here: <br><br>  DC-DC Converter LM2596 <br>  GSM modem SIM800L (power 3.6-4.4) <br>  GPS module NEO-6M (power 3.4-3.8) <br>  A piece of PCB. <br><br>  The required voltage for the modules forms a DC-DC converter.  Its output voltage is set to 3.7 volts.  The adjustment screw is coated with varnish to prevent it from shifting from vibrations. <br><br>  I thought which peripherals I needed to support in the first place and I got the following list: <br><br><ol><li>  Interior and engine temperature sensors. </li><li>  Accelerometer </li><li>  Voltmeter on-board network. </li><li>  Door limit switch input. </li><li>  Trunk limit switch input. </li><li>  Brake pedal limit switch input. </li><li>  The output to the ignition. </li><li>  Repeater relay output. </li><li>  Exit to the immobilizer lineman. </li><li>  Output to the interlock relay. </li><li>  Exit to the siren. </li></ol><br>  Conscious refusal of support: <br><br><ol><li>  Exit to the central locking relay.  The car is not wired to the door of the central lock. </li><li>  The tachometer input, as it simply does not make sense to connect to a hybrid car. </li><li>  The input of the hood limit switch, as it is missing from the vehicle. </li></ol><br>  Algorithms and functions that were implemented: <br><br><ol><li>  Storing settings in EEPROM. </li><li>  Starting the engine using START-STOP technology. </li><li>  Activation of a keyless crawler with analog control (iDatalink). </li><li>  Remote engine start. </li><li>  Undervoltage control on the battery. </li><li>  Monitoring engine voltage. </li><li>  Arming / disarming (zone perimeter control). </li><li>  Control of limit switches for doors and trunk. </li><li>  Siren support. </li><li>  Support for signal lights (turn signal). </li><li>  Support silent mode. </li><li>  Support for external expansion card (telemetry module). </li><li>  Connection and transfer of states to the server. </li><li>  System management DTMF codes, in the absence of communication with the server. </li><li>  List of trusted numbers. </li></ol><br>  Feedback is implemented by calling to a trusted phone number from which the security mode was set. <br><br>  System management was implemented through the Telegram bot: <br><br><img src="https://habrastorage.org/webt/ox/s5/k1/oxs5k1bqjhtcsev0qruogung8wa.png" alt="image"><br><br>  The bot also sends messages about critical conditions, such as: <br><br><ol><li>  Low battery voltage. </li><li>  Battery voltage restored. </li><li>  Low engine temperature. </li><li>  High engine temperature. </li></ol><br>  In fact, home-made is already 3 years old and during this period I found out that: <br><br><ol><li>  The homemade product was at the maximum uptime of about 80 days, then the device rebooted, since the GSM modem stopped even receiving calls. </li><li>  Stable operation in negative and high temperatures (from -40 to +40). </li><li>  Need to do digital bus support. </li></ol><br>  The possibility of flashing the Pandora DXL 3000 on the SPI bus is a vulnerability because it allows you to download software that can activate the outputs of the keyless immobilizer crawler and deactivate locks. <br><br>  In general, the work done has given me tremendous experience.  I studied the circuitry of car alarms, saw how to do it compactly and simply, and learned how to program STM32 microcontrollers.  As a result, I made a product that I use myself.  I was inspired and continued to develop the second version.  The second version will be able to connect to digital buses to simplify and reduce the number of connection points, as well as implement a bypass standard immobilizer without external crawlers on IMMO-IMI chains. <br><br>  Oh yes, all this time the system worked and continues to work on the family car Toyota Prius in the 20 body, which is rich in digital tires.  Debugging support for the BEAN bus is in full swing. <br><br>  <b>PS:</b> The second version was developed and is being tested on a 2007 Toyota Camry. <br><br>  As a result, I see my project as an opportunity to create an open system for automotive telemetry. <br><br>  Thanks for attention! </div></div><p>Source: <a href="https://habr.com/ru/post/479216/">https://habr.com/ru/post/479216/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../479196/index.html">Most supercomputers run Linux - discuss the situation</a></li>
<li><a href="../479200/index.html">Fractal image compression</a></li>
<li><a href="../479202/index.html">C ++ and Numerical Methods: Approximate Newton-Cotes Integration</a></li>
<li><a href="../479210/index.html">What will happen to purchases in foreign online stores from January 1, 2020</a></li>
<li><a href="../479214/index.html">A selection of upcoming free events for developers in Moscow # 2</a></li>
<li><a href="../479218/index.html">How to make a bot that turns a photo into a comic book: step-by-step instructions for dummies</a></li>
<li><a href="../479220/index.html">Nano-neuron - 7 simple JavaScript functions showing how the machine can "learn"</a></li>
<li><a href="../479222/index.html">The digest of interesting materials for the mobile # 325 developer (on December 2 - 8)</a></li>
<li><a href="../479226/index.html">Habr-analysis: what users order as a gift from Habr</a></li>
<li><a href="../479232/index.html">MQ JMS application development on Spring Boot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter54458986 = new Ya.Metrika({
                  id:54458986,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/54458986" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-143967986-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=IU0EG0jaqnehka2lu5TyzAcchrZXI4Yb1QXKQvJxpqE&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>