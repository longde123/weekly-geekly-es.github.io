<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•õ üë®‚Äçüîß üë®‚Äçüë©‚Äçüë¶ C√≥mo agregamos entradas al mapa y redujimos el tama√±o de las bases en un 10% üë©üèæ‚Äçüî¨ üïØÔ∏è üßöüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A finales del mes pasado, 2GIS comenz√≥ a mostrar porches. Hemos estado mostrando las entradas a las organizaciones desde 2013, y las entradas parecen ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo agregamos entradas al mapa y redujimos el tama√±o de las bases en un 10%</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/415263/"><img src="https://habrastorage.org/webt/en/6k/fp/en6kfpoagwhj42loeubjzo0rzo0.jpeg"><br><br>  A finales del mes pasado, 2GIS comenz√≥ a mostrar porches.  Hemos estado mostrando las entradas a las organizaciones desde 2013, y las entradas parecen ser las mismas entradas.  Entonces, ¬øpor qu√© justo ahora?  Todos los productos y procesos internos est√°n listos, todo lo que necesita hacer es agregar un poco m√°s y corregir la pantalla en la interfaz de usuario. <br><br>  Adem√°s de la respuesta est√°ndar "Hubo otras prioridades", tambi√©n hay una no bastante est√°ndar: "No es tan simple".  Este art√≠culo trata sobre las dificultades y c√≥mo las resolvimos. <br><a name="habracut"></a><br>  En primer lugar, la entrada no es la entrada.  Por lo tanto, en una entrada puede conducir varias entradas, generalmente desde diferentes lados del edificio.  La definici√≥n de "bloque (de varios niveles) de apartamentos con una entrada com√∫n" tambi√©n es incorrecta.  Sucede que una entrada conduce al primer piso de la entrada, y la otra, al segundo y subsiguientes pisos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zz/w7/pr/zzw7prchtb-1ictjkzvrfd6c_-8.png" alt="Entrada con dos entradas."></div><br>  En segundo lugar, quiero buscar entradas. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yb/ty/ut/ybtyutk7jllplorjkmqiywob1ha.png" alt="Entradas en los resultados de b√∫squeda"></div><br>  Esta es una oportunidad muy buscada, ya que las entradas est√°n lejos de estar siempre ubicadas de manera obvia. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/fm/j7/41/fmj741efgjyhdj29y3udi2lsjym.png" alt="Casa con la numeraci√≥n de entrada no m√°s obvia"></div><br>  Adem√°s de los n√∫meros de entrada, tambi√©n hay nombres (generalmente de una sola letra). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ef/wk/2d/efwk2d9a_gsaw5vokxqoyiqzuzm.png" alt="Las letras en los nombres de los p√≥rticos."></div><br>  O incluso como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en Kaliningrado</a> : se asigna una direcci√≥n separada exactamente a la escalera. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rw/iz/4w/rwiz4wywzkk_nnjll6xzrpy5k1o.png" alt="Numeraci√≥n independiente de entradas en Kaliningrado"></div><br>  En tercer lugar, decidimos que si √≠bamos a buscar entradas, ¬øpor qu√© no apoyar inmediatamente la b√∫squeda por n√∫mero de apartamento?  Decidieron, y recogieron las gamas de apartamentos, sin embargo, hasta ahora sin una fijaci√≥n al piso.  Al igual que con las entradas, los apartamentos pueden tener no solo nombres num√©ricos (la mayor√≠a de las veces hay variantes con la letra "a"), y los rangos est√°n lejos de ser siempre continuos.  En las antiguas casas de San Petersburgo, la numeraci√≥n es bastante extra√±a: los apartamentos 1 y 3 pueden estar en la misma entrada, y el apartamento 2 puede estar en la parte opuesta del edificio. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m2/se/uh/m2seuh3ovc_5ob8b1ulcdlru8x8.jpeg" alt="Entrada t√≠pica del viejo Petersburgo"></div><br><div class="spoiler">  <b class="spoiler_title">Digresi√≥n de letras sobre la validaci√≥n de datos</b> <div class="spoiler_text">  No intente hacer que la validaci√≥n de los datos recopilados sea muy inteligente: en la capital del norte hay casos en los que puede ingresar a un apartamento desde varias entradas, y en algunos asentamientos europeos la direcci√≥n contiene, adem√°s de la casa, el nombre de la entrada y el n√∫mero de apartamento en esta entrada.  Peter tambi√©n agrada con un edificio con dos octavas entradas. <br></div></div><br>  Cuarto, quiero mostrar siempre las entradas en el mapa, y no solo cuando estudiamos la informaci√≥n de una casa o entrada en particular. <br><br>  Y, finalmente, hay muchas entradas: seg√∫n la estimaci√≥n actual, hay alrededor de cien mil de ellas solo en Mosc√∫.  La primera evaluaci√≥n "en los dedos" dio algunas cifras astron√≥micas: cometimos un error una vez cada seis veces en el lado m√°s grande. <br><br>  <b>Conclusiones:</b> <br><br><ul><li>  Necesitamos una entidad adicional, que tenga su propio nombre, que contenga una lista de rangos de apartamentos y a la que se puedan adjuntar las entradas al edificio. </li><li>  Buscaremos esta entidad y le mostraremos una tarjeta de informaci√≥n separada. </li><li>  Nos vemos obligados una vez m√°s a aumentar el tama√±o de los datos descargados por la aplicaci√≥n m√≥vil, o mostrar estos datos solo si hay una conexi√≥n de red, o encontrar algo con el formato. </li></ul><br><h3>  Llegando a la soluci√≥n </h3><br>  Los primeros dos puntos requieren cambios en los productos internos y externos, pero esta es una rutina.  Este √∫ltimo es un asunto completamente diferente.  Como no nos gusta molestar a los usuarios, establecemos una restricci√≥n: los datos deben estar disponibles sin conexi√≥n, y agregarlos no debe aumentar el tama√±o de las bases de datos. <br><br>  Como?  Por un lado, debe reducir el tama√±o actual de los datos, por otro lado, puede encontrar un formato para almacenar informaci√≥n sobre las entradas, de modo que la cantidad de datos adicionales sea m√≠nima. <br><br><h3>  Reduce el volumen de datos </h3><br>  Hay dos formas de reducirlo: <br><br><ul><li>  Mire cuidadosamente los datos almacenados e intente encontrar algo de lo que podamos prescindir. </li><li>  Piense si es posible almacenar datos de manera m√°s eficiente de lo que lo estamos haciendo ahora. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Evoluci√≥n del formato de almacenamiento de datos antes de la era de los porches</b> <div class="spoiler_text"><h4>  La primera y m√°s f√°cil opci√≥n </h4><br>  La forma tradicional de guardar datos complejos es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">normalizarlos</a> , colocarlos en una base de datos de tablas y crear <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">√≠ndices</a> auxiliares.  Una vez, 2GIS hizo exactamente eso, excepto para reducir el tama√±o, los contenidos de cada tabla se ordenaron de manera que con la mayor frecuencia posible los valores de las celdas coincidieran con los valores de la fila anterior.  Almacenamos las columnas de forma independiente y colapsamos secuencias de valores id√©nticos. <br><br>  Un ejemplo muy simplificado de optimizar el almacenamiento de una mesa con edificios: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bh/jw/gy/bhjwgyi3kccb_sx2l4zho_pqlsy.png" alt="Un ejemplo de almacenamiento optimizado de tablas"></div><br>  La normalizaci√≥n le permite reducir la redundancia, pero tambi√©n hay un lado negativo: para formar un elemento de la interfaz de usuario para alg√∫n objeto, debe realizar varias consultas para acceder a una gran cantidad de tablas.  Sin embargo, en ese momento, estas tablas se usaron no solo para obtener datos para mostrar, sino para casi todas las tareas, incluida la b√∫squeda de texto y varios tipos de b√∫squeda de viajes.  Para todas estas tareas, los datos normalizados simplemente nos permitieron reducir la cantidad de informaci√≥n procesada. <br><br>  Los datos para representar el mapa ya ten√≠an su propio formato binario y se almacenaban en un bloque separado.  Gradualmente, creamos formatos binarios separados para acelerar la b√∫squeda de direcciones y b√∫squedas de texto.  Solo quedaba informaci√≥n en la base de datos, que se usaba para mostrar tarjetas de objetos, as√≠ como para enlaces de algunos objetos con otros. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yd/4k/jh/yd4kjhjwh0pjpbj8bqmvksnqngk.png" alt="Tarjetas y comunicaciones"></div><br><h4>  Simplifica el trabajo </h4><br>  ¬øC√≥mo puede simplificar el trabajo con datos?  Reciba todos los datos necesarios para dibujar una tarjeta de una vez por el identificador del objeto.  Dado que la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">versi√≥n en l√≠nea</a> ya recibe todos los datos de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">API</a> para una solicitud en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">formato JSON</a> , al mismo tiempo puede combinar los formatos utilizados por todos nuestros productos. <br><br>  Tanto los json para mostrar tarjetas como las comunicaciones deben recibirse para un n√∫mero limitado de objetos, desde el poder de varias decenas a la vez.  Pero hay escenarios en los que los atributos individuales deben obtenerse a la vez para muestras grandes, hasta cientos de miles.  Es m√°s l√≥gico separar tales atributos en una entidad separada con un formato de almacenamiento separado: propiedades.  Las propiedades pueden ser de tipo y almacenarse de manera m√°s eficiente en formato binario. <br><br>  Un enfoque ingenuo para almacenar json es usar una base de datos clave-valor.  Tomemos a Mosc√∫ como ejemplo, como el mayor de nuestros proyectos.  Incluso en la forma m√°s simple posible: para cada objeto que se almacena json, 8 bytes de identificador y un car√°cter delimitador, el directorio tomar√° 1.9 GiB.  El tama√±o resultante es casi seis veces mayor que la opci√≥n descrita anteriormente, y esto a√∫n no tiene v√≠nculos ni propiedades. <br><br>  Inflamos deliberadamente objetos llen√°ndolos con informaci√≥n sobre todo lo que podr√≠a ser necesario para mostrar sus tarjetas, pero a√∫n debe almacenar nombres de campos, comillas, comas y corchetes. <br><br><h4>  Comprimir datos </h4><br>  La normalizaci√≥n no es la √∫nica forma de eliminar la redundancia.  La segunda forma popular es la compresi√≥n.  El archivo lzma de nuestro archivo incre√≠blemente grueso toma solo 55 MiB. <br><br>  Por supuesto, no podemos usar este formato directamente, porque para acceder a un objeto arbitrario necesitamos desempaquetar todos los datos almacenados anteriormente, y los archivos lzma no se desempaquetan muy r√°pidamente. <br><br>  ¬øC√≥mo podemos obtener acceso aleatorio r√°pido, por un lado, y por otro lado, al comprimir los datos, reducir el tama√±o del espacio requerido?  La respuesta es usar paginaci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ag/lk/jr/aglkjrbolu5w7cclmf-_cuqsjly.png" alt="Formato de almacenamiento binario"></div><br>  Ahora que los datos est√°n paginados, podemos comprimir cada uno individualmente.  Para acceder a un lugar arbitrario, necesitamos descomprimir y escanear la p√°gina, pero esto es mucho m√°s r√°pido que desempacar y escanear todo el archivo. <br><br>  En este formato, todos los datos se almacenan: json'y, relaciones y propiedades.  Queda por asociar estos datos con los identificadores de los objetos.  Para cada identificador, necesitamos almacenar uno o m√°s pares <i>&lt;n√∫mero de almacenamiento, n√∫mero de datos en el almacenamiento&gt;</i> . <br><br><img src="https://habrastorage.org/webt/7b/db/tz/7bdbtzgxk03-5c189bv4sesw7b8.png" alt="Formato simplificado de relaciones entre el identificador de objeto y los datos en almacenamientos"><br>  Todos los n√∫meros de serie, desplazamientos y tama√±os se almacenan en un formato comprimido similar al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">UTF-8</a> , donde los valores peque√±os ocupan solo un byte.  Esto nos permite reducir el tama√±o de los enlaces simplemente ordenando el contenido de los repositorios binarios para reducir la frecuencia de ocurrencia. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/od/9w/zv/od9wzvyv9ql8ps8g2gmmyq8njmo.png" alt="Ordenar y reducir"></div><br>  Algunas propiedades tienen muchos valores de frecuencia y, por lo tanto, la clasificaci√≥n proporciona una gran ganancia de tama√±o.  Por otro lado, debido a ello, el n√∫mero de serie de los datos no puede coincidir para todos los almacenamientos. <br><br>  Adem√°s, lejos de todos los objetos tienen datos en todos los almacenamientos y, por lo tanto, almacenar n√∫meros de almacenamiento es m√°s eficiente que hacer referencia a objetos vac√≠os. <br><br><h4>  Acelerar la recuperaci√≥n de datos </h4><br>  El formato descrito tiene un problema.  Para encontrar el n√∫mero del objeto que almacena los √≠ndices para el identificador especificado, necesitamos ejecutar una b√∫squeda binaria dentro de los datos del primer objeto.  Para hacer esto, necesita cargar 10.9 MiB en la memoria o hacer 21 lecturas adicionales.  Ambas soluciones no son adecuadas para nosotros y, por lo tanto, reducimos el n√∫mero de lecturas almacenando datos en un √°rbol. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8b/cx/to/8bcxto_pgnqn7drgqi5hkiae_su.png" alt="Formato del √°rbol para b√∫squeda r√°pida de datos por identificador"></div><br>  Agrupamos datos en 32 objetos, y en los niveles intermedios almacenamos 128 de los primeros identificadores de nodos anidados.  Agregamos tres niveles del √°rbol y redujimos el n√∫mero de lecturas adicionales a cuatro (pero, de hecho, teniendo en cuenta el almacenamiento en cach√© de los nodos del √°rbol previamente le√≠dos, incluso a 1-3).  Precio: un poco menos de 400 KiB. <br><br>  En esta etapa, somos bastante eficientes para almacenar relaciones y propiedades, pero Json ocupa mucho espacio.  Esto es entendible.  Cuanto mayor sea el tama√±o de la p√°gina, m√°s objetos llegar√°n all√≠ y mejor ser√° el algoritmo de compresi√≥n capaz de determinar qu√© informaci√≥n es redundante.  Pero, por otro lado, cuanto m√°s trabajo tenemos que hacer para leer un solo objeto.  Json son objetos bastante grandes y, por lo tanto, hay muy pocos en una p√°gina.  Por lo tanto, debe ayudar al algoritmo a hacer su trabajo mejor. <br><br><h4>  Romper json en partes </h4><br>  En primer lugar, muchos objetos tienen esquemas de datos coincidentes; solo difieren los valores de los atributos.  En segundo lugar, muchos valores de atributos son iguales incluso para objetos con diferentes esquemas.  Separaremos los esquemas y los valores de los atributos en almacenamientos separados, y almacenaremos json en la forma: un enlace a un esquema + enlaces a valores de atributos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pq/n8/ef/pqn8ef7v2wv7bkkvbgguql2vggq.png" alt="La divisi√≥n de json en esquema y datos"></div><br>  En nuestro esquema de datos, el n√∫mero de nombres de atributos es limitado.  Entonces podemos ponerlos en un archivo separado y almacenar el n√∫mero en su lugar.  Tambi√©n haremos algunos cambios m√°s, teniendo en cuenta que los json siempre son objetos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/i_/ak/gqi_akxdvngmmjmgjrg60y-5luu.png" alt="Formato real para guardar esquemas de objetos json"></div><br>  S√≠, esencialmente exprimimos nuestros datos nosotros mismos, reduciendo el alcance para que el algoritmo funcione.  Pero, por otro lado, ralentizamos bastante el acceso a los datos, y el algoritmo todav√≠a ayuda, comprimiendo valores similares almacenados cerca. <br><br>  Establecimos el tama√±o de la p√°gina en 1 KiB y resulta que mientras optimizamos el formato para que, por un lado, la lectura no fuera muy lenta y, por otro, los datos se empaquetaran lo mejor posible, nosotros ... ya pasamos por alto las "tablas optimizadas" tanto en tama√±o como en tama√±o. para facilitar su uso.  ¬°Pero no por nada que todo esto fue!  La ganancia m√°xima debe ser de la compresi√≥n de los valores de atributos, propiedades y esquemas.  Incitamos a zlib y verificamos que, en el contexto del resto del trabajo, leer datos de la base de datos lleva poco tiempo.  Satisfechos con el resultado, cambiamos a otras tareas. <br></div></div><br><h3>  Deshazte de lo innecesario </h3><br>  Comenzamos a reducir buscando datos de los que pueda deshacerse.  Resulta que durante la existencia del formato, hemos aprendido a prescindir de la conexi√≥n m√°s grande.  ¬°Esto es el 10% del tama√±o! <br><br>  El c√≥digo para estos datos todav√≠a estaba vinculado, pero los cambios necesarios son bastante triviales.  Pero las aplicaciones ya lanzadas no se pueden cambiar f√°cilmente.  Nos esforzamos por mantener el mayor tiempo posible no solo hacia atr√°s, sino tambi√©n la compatibilidad directa.  Y si el primero es familiar para todos, entonces muchos felizmente no pensar√°n en el segundo.  Nos vemos obligados a admitirlo debido a la larga cola de usuarios que, por diversas razones, han desactivado las actualizaciones autom√°ticas y no tienen prisa por cambiar a una nueva versi√≥n de la aplicaci√≥n. <br><br><div class="spoiler">  <b class="spoiler_title">Distribuci√≥n de usuarios por versi√≥n</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ms/ld/kq/msldkqhkepk1gsouayqmglu36zo.png" alt="Distribuci√≥n de usuarios por versi√≥n"></div><br>  En la parte superior est√° la distribuci√≥n de usuarios por las √∫ltimas versiones de la aplicaci√≥n de Android.  La parte inferior es iOS. <br><br>  Es f√°cil notar que los usuarios de dispositivos iOS se actualizan mucho m√°s f√°cilmente, pero incluso entre ellos hay muchos usuarios de versiones anteriores. <br></div></div><br>  Tambi√©n estamos lanzando nuevos datos para la versi√≥n congelada para Windows Phone.  Y aunque los usuarios de WP8 representan solo una peque√±a fracci√≥n de nuestra audiencia, en n√∫meros absolutos esto es casi 200,000 por mes. <br><br>  Hace tiempo que tenemos un mecanismo que nos permite producir varios formatos de datos y determina autom√°ticamente qu√© versiones deber√≠an obtener qu√©.  La oportunidad es buena, pero a√∫n necesita aprender a descargar estos formatos.  La primera gran tarea fue implementar un servicio que reciba todos los datos y filtre el nuevo para el antiguo formato de base de datos y el viejo para el nuevo. <br><br>  Una buena ventaja del trabajo realizado es la reducci√≥n del tama√±o de las actualizaciones mensuales, ya que la conexi√≥n remota ha cambiado mucho de mes a mes, lo que aumenta el tama√±o de las diferencias. <br><br>  Si observa los datos restantes, en total puede exprimir el mismo 10%, sin embargo, el precio ser√° incomparablemente m√°s alto.  Hasta ahora hemos decidido no tocar. <br><br><h3>  Optimizar el formato de almacenamiento actual </h3><br>  Como se escribi√≥ anteriormente, creamos 1 p√°ginas KiB y empacamos no todos los repositorios binarios. <br><br>  Lo primero que hacemos es tratar de empaquetar tambi√©n p√°ginas con enlaces, y verificar que la diferencia en la velocidad de recepci√≥n de datos est√© en la regi√≥n del error. <br><br>  El siguiente elemento es elegir el tama√±o de p√°gina √≥ptimo.  Cuanto mayor es el tama√±o de la p√°gina, m√°s eficientemente se comprimen los datos, pero m√°s lento se obtienen los datos.  Y si al aumentar el tama√±o de la p√°gina el tiempo y los costos de memoria crecen linealmente, la ganancia se vuelve cada vez menos notable.  Despu√©s de las pruebas, decidimos aumentar el tama√±o a 8 KiB. <br><br><div class="spoiler">  <b class="spoiler_title">El efecto del tama√±o de p√°gina en grandes selecciones</b> <div class="spoiler_text">  Si se espera que la ampliaci√≥n de la p√°gina ralentice las selecciones peque√±as, entonces las grandes, de cientos de elementos, incluso se aceleran.  Esto significa que, en el buen sentido, debe elegir diferentes tama√±os de almacenamiento dependiendo de los casos de uso de los datos almacenados en ellos. <br></div></div><br>  En total, ¬°solo estos dos puntos pueden reducir la base en un 18%! <br><br><h3>  Cambiar el formato de compresi√≥n </h3><br>  zlib, por supuesto, es un cl√°sico, pero <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">zstd</a> proporciona una mayor velocidad de descompresi√≥n con una mayor relaci√≥n de compresi√≥n.  Adem√°s, zstd le permite primero construir un √∫nico diccionario para todos los datos disponibles, y luego guardarlo una vez y comprimirlo con todas las p√°ginas.  Por lo tanto, ralentizamos decentemente el proceso de creaci√≥n de un archivo con una base de datos, pero exprimimos un 8% adicional. <br><br><h3>  A√±adir porches </h3><br><h4>  Manera f√°cil </h4><br>  La forma m√°s f√°cil es hacer que cada entrada sea un objeto separado, indexarlos por separado (de acuerdo con estimaciones aproximadas + 10% del tama√±o del √≠ndice) y almacenar por separado su geometr√≠a en los datos para dibujar el mapa. <br><br>  Este m√©todo inflar√° la base en un total de 3%.  En las etapas anteriores, ganamos m√°s que suficiente para calmarnos y trabajar con las entradas de acuerdo con el esquema habitual, pero ... en el momento del inicio del trabajo, no est√°bamos seguros de esto, y el trabajo en un formato alternativo era en paralelo. <br><br><div class="spoiler">  <b class="spoiler_title">Evaluaci√≥n detallada, para los interesados.</b> <div class="spoiler_text">  Tratemos de evaluar el aumento en el tama√±o del paquete con la base de datos para cada objeto: <br><br>  8 bytes - identificador, <br>  6 bytes: n√∫meros de almacenamientos usados ‚Äã‚Äã(datos + cinco propiedades; las propiedades se extraen de los datos principales y se almacenan en forma binaria, ya que a menudo se necesitan para una gran cantidad de objetos a la vez), <br>  3 bytes - √≠ndice en el almac√©n de datos, <br>  2 bytes: datos de desplazamiento del objeto, <br>  5 bytes - valores de datos - 2 bytes por circuito, 3 bytes en promedio para la informaci√≥n del departamento (creemos que habr√° muchos duplicados y los datos en s√≠ se almacenan una vez), <br>  6 bytes: coordenadas de datos de desplazamiento (otras propiedades tienen muchos valores duplicados y colapsar√°n), <br>  8 bytes: valores de coordenadas. <br><br>  Total 38 bytes por objeto.  En el caso de Mosc√∫, esto es 4.5 MiB por m√°s de 124 mil entradas recolectadas. <br><br>  Luego, necesitamos almacenar tambi√©n la conexi√≥n entre la casa y las entradas, es de 2.5 bytes para cada edificio de apartamentos y 8 bytes para cada entrada.  1 m√°s MiB. <br><br>  Ahora consideramos cu√°nto tomar√° todo esto en el mapa. <br><br>  Primero, debemos almacenar la geometr√≠a.  Para las polil√≠neas, el primer punto siempre toma 8 bytes, y todos los siguientes se almacenan como diferencias de la precisi√≥n requerida.  Aqu√≠ estamos satisfechos con la precisi√≥n de dec√≠metros.  La mayor√≠a de las entradas consisten en dos puntos que no est√°n muy lejos el uno del otro y, por lo tanto, se puede suponer que la geometr√≠a misma ocupar√° 10 bytes.  Total 1.2 MiB. <br><br>  Tambi√©n necesitamos asociar el identificador de entrada y el objeto con su geometr√≠a.  Un √≠ndice es el mismo almacenamiento binario que todo lo dem√°s, solo se almacenan el destino de comunicaci√≥n (1 byte), el n√∫mero de capa (1 byte) y el n√∫mero de objeto (3 bytes).  M√°s 8 bytes por identificador, as√≠ como un √°rbol de b√∫squeda r√°pida.  Total otros 1.5 MiB. <br><br>  Como se dijo al comienzo del art√≠culo, queremos mostrar constantemente las entradas en el mapa, y la forma m√°s f√°cil de hacerlo es descargar otra capa con puntos, pero ... tambi√©n puede reutilizar la capa con geometr√≠as, creando un nuevo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">s√≠mbolo</a> que mostrar√° la imagen que necesitamos en el √∫ltimo punto de la polil√≠nea. <br><br>  El 10% del √≠ndice de b√∫squeda es 5.9 MiB.  Resumiendo todo, obtenemos 14.2 MiB, que es solo un poco m√°s del 3%. <br></div></div><br><h4>  Opci√≥n actual </h4><br>  En lugar de indexar las entradas e inflar el √≠ndice de b√∫squeda, buscamos casas, pero adicionalmente marcamos las palabras de consulta y seleccionamos las direcciones (relevantes para buscar entradas en Kaliningrado), entradas y / o apartamentos.  Por lo tanto, a la salida tenemos el identificador de la casa y los campos de texto escritos, por los cuales debemos encontrar la escalera que necesitamos. <br><br><div class="spoiler">  <b class="spoiler_title">Nota</b> <div class="spoiler_text">  Este es un punto controvertido.  Por un lado, nos permite reducir el tama√±o de la base de datos y, por otro, impone restricciones en el formato de entrada: las entradas no estar√°n en muchas solicitudes que se procesar√≠an correctamente mediante una b√∫squeda honesta. <br></div></div><br>  Adem√°s, en lugar de descargar objetos individuales, incluimos toda la informaci√≥n sobre las entradas directamente en los datos del edificio. <br>  Y finalmente, transferimos parte de las geometr√≠as al directorio. <br><br>  Vale la pena revelar esto √∫ltimo con m√°s detalle. <br><br>  En primer lugar, notamos que la mayor√≠a de las entradas son dos puntos y tienen la misma longitud.  Dichas entradas se pueden almacenar en forma de un punto + direcci√≥n, es decir.  Ahorre 1 byte por entrada. <br><br>  En segundo lugar, suponemos que la mayor√≠a de las casas en las ciudades modernas son t√≠picas, por lo tanto, los desplazamientos de los puntos de sus entradas en relaci√≥n con el punto central de la casa coincidir√°n hasta un giro. <br><br>  Ya tenemos los puntos centrales de los edificios.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© sucede si agregamos una nueva propiedad para el edificio, su "direcci√≥n" entera, y para cada entrada dos m√°s, compensaciones enteras en dec√≠metros a lo largo y perpendiculares a la l√≠nea de direcci√≥n? </font><font style="vertical-align: inherit;">Teniendo en cuenta c√≥mo almacenamos json con informaci√≥n, la geometr√≠a de entrada en promedio ocupar√° poco m√°s de dos bytes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una ventaja adicional es que, dado que la geometr√≠a est√° en el directorio, ya no necesitamos almacenar la correspondencia entre el identificador de entrada y el n√∫mero de objeto en la capa del mapa.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menos: el c√≥digo se ha vuelto m√°s complicado. Anteriormente acabamos de decirle al mapa "mostrar tales y tales objetos", y ahora al mostrar las entradas extraemos estos datos de json y agregamos objetos din√°micos al mapa. Aqu√≠ no todo da mucho miedo. En el momento de mostrar las teclas de flecha de las entradas json, ya tenemos los objetos correspondientes, es decir, no es necesario ir a la base de datos adicionalmente. Con los puntos de entrada mostrados, todo es un poco peor: ahora tenemos que determinar en el fondo qu√© casas son visibles, extraer los datos de estas casas de la base de datos, desmontar json y, si hay entradas, crear objetos din√°micos para ellas.</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Nota</b> <div class="spoiler_text">  .              ,     ,     0,2% (972   ). <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como ya hemos escrito c√≥digo adicional para mostrar las entradas a las entradas, nada nos impide comenzar a almacenar entradas de dos puntos en la organizaci√≥n en el directorio. </font><font style="vertical-align: inherit;">La ganancia en este caso ser√° peque√±a, pero gratuita. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øCu√°nto nos dio? </font><font style="vertical-align: inherit;">3% convertido en 0.5%. </font><font style="vertical-align: inherit;">Podr√≠amos haber hecho a√∫n menos, pero dejamos identificadores en los datos (que est√°n comprimidos bastante mal) para simplificar el procesamiento de mensajes de usuario sobre entradas inexactas.</font></font><br><br><h3>  Resultado </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agregamos una gran cantidad de entradas, mientras redujimos el tama√±o del archivo con los datos del mapa en un 0.5% y redujimos en un 26.6% el tama√±o del archivo con los datos del directorio. </font><font style="vertical-align: inherit;">Este √∫ltimo sigue siendo el m√°s grande de nuestros archivos, pero es solo uno de los cuatro archivos "pesados", por lo que el cambio general result√≥ ser m√°s modesto: 10.1%.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/s8/p-/_v/s8p-_vjsi9mgzymzwusfn4vsz6g.png" alt="Cambiar el tama√±o de la base de Mosc√∫ con el tiempo"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las entradas a√∫n no est√°n recogidas. </font><font style="vertical-align: inherit;">El tama√±o de las bases crecer√° un poco con el tiempo (seg√∫n las estimaciones actuales, el mismo Mosc√∫ aumentar√° en un 0,4%), pero en cualquier caso, el objetivo es liberar las entradas sin aumentar el tama√±o, m√°s de lo que se logr√≥.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Que sigue </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si hablamos de mejoras en los alimentos, vamos a apoyar las entradas y apartamentos en los consejos de b√∫squeda, as√≠ como en la b√∫squeda de los puntos de inicio y finalizaci√≥n de la b√∫squeda de direcciones. </font><font style="vertical-align: inherit;">Tambi√©n pensamos en mostrar entradas importantes a los edificios (principalmente en centros comerciales) de la misma manera que los porches. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En los planes t√©cnicos, hay una verificaci√≥n de varias ideas que pueden conducir a una mayor reducci√≥n en el tama√±o del archivo con datos de referencia, y debe observar cuidadosamente otros archivos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y, por supuesto, corregiremos los errores que tenemos hasta ahora.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un pensamiento m√°s: use JSON sabiamente </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> De lo anterior, la conclusi√≥n sugiere que no se puede pensar demasiado en formatos binarios y solo usar JSON. </font></font> Esto no es del todo cierto.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto funciona para nosotros, porque al mismo tiempo necesitamos recibir varias decenas de objetos de la fuerza. </font><font style="vertical-align: inherit;">Adem√°s, utilizamos rapidjson, y es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muy inteligente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y consume poca memoria. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambi√©n vale la pena restringir la transferencia de datos JSON de C ++ a UI, escritos en otro idioma. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primero, debes convertirlo en una cuerda. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En segundo lugar, los analizadores disponibles en la parte de la interfaz de usuario volver√°n a montar esta l√≠nea y lo har√°n mucho m√°s lento. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es mejor obtener todos los datos de JSON por su cuenta y lanzar interfaces simples adaptadas para mostrar elementos espec√≠ficos en el lado de la interfaz de usuario.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es415263/">https://habr.com/ru/post/es415263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es415253/index.html">Las fotograf√≠as del siglo XIX fueron restauradas utilizando la tecnolog√≠a del siglo XXI.</a></li>
<li><a href="../es415255/index.html">Roskosmos anunci√≥ la terminaci√≥n de los vuelos de misiles Proton</a></li>
<li><a href="../es415257/index.html">8 formas de mejorar la visualizaci√≥n de datos</a></li>
<li><a href="../es415259/index.html">select / poll / epoll: diferencia pr√°ctica</a></li>
<li><a href="../es415261/index.html">Artista VFX en desarrollo de juegos: caracter√≠sticas, carrera, desarrollo</a></li>
<li><a href="../es415265/index.html">Buscando un sucesor del KL-7: RACE y AROFLEX</a></li>
<li><a href="../es415269/index.html">C√≥mo funciona JS: √°rboles de sintaxis abstracta, an√°lisis y su optimizaci√≥n</a></li>
<li><a href="../es415271/index.html">C√≥mo los gr√°ficos de Gantt simplifican la gesti√≥n de proyectos</a></li>
<li><a href="../es415273/index.html">Aprender los conceptos b√°sicos de la programaci√≥n.</a></li>
<li><a href="../es415275/index.html">El libro "C # 7 y .NET Core. Desarrollo multiplataforma para profesionales. 3a edici√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>