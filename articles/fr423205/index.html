<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÉè ü§üüèæ üòê Projet de stockage sur MS SQL Server, int√©gration avec 1C 7.7 et automatisation du d√©veloppement en SSDT üë®üèº‚Äçüíª üéÄ üë©‚Äçüë¶‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le temps presse et bient√¥t il ne restera presque plus rien de ce d√©veloppement, mais je n'avais toujours pas le temps de le d√©crire. 



 Il s'agira d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Projet de stockage sur MS SQL Server, int√©gration avec 1C 7.7 et automatisation du d√©veloppement en SSDT</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423205/">  Le temps presse et bient√¥t il ne restera presque plus rien de ce d√©veloppement, mais je n'avais toujours pas le temps de le d√©crire. <br><br><img src="https://habrastorage.org/webt/fi/5s/if/fi5siftwc5fvceqqsjgxfnqubum.png"><br><br>  Il s'agira d'une entreprise au niveau f√©d√©ral avec un grand nombre de succursales et de sous-succursales.  Mais, comme d'habitude, tout a commenc√© il y a longtemps avec un petit magasin.  Au fil des ans, un d√©veloppement assez rapide et spontan√© a eu lieu, des succursales, des divisions et d'autres bureaux sont apparus, et l'infrastructure informatique n'a pas re√ßu l'attention requise √† cette √©poque, ce qui est √©galement fr√©quent.  Bien s√ªr, 1C77 a √©t√© utilis√© partout, sans aucune marge de r√©plication et de mise √† l'√©chelle.Par cons√©quent, vous savez, √† la fin, nous sommes arriv√©s √† la conclusion qu'une pieuvre Frankenstein a √©t√© g√©n√©r√©e avec des tentacules attach√©es avec du ruban √©lectrique - dans chaque branche, il y avait un mutant autonome qui √©changeait avec une base centrale dans le mode ¬´√† hauteur du genou¬ª, seulement quelques ouvrages de r√©f√©rence, sans lesquels, eh bien, c'√©tait impossible du tout, et le reste est autonome.  Pendant un certain temps, ils se sont content√©s de copies (des dizaines d'entre eux!) Des bases de succursales du bureau central, mais les donn√©es en elles ont tra√Æn√© pendant plusieurs jours. <br><br>  La r√©alit√©, cependant, n√©cessite d'obtenir des informations plus rapidement et de mani√®re flexible, et il faut faire autre chose avec cela.  Le transfert d'un syst√®me comptable √† un autre √† une telle √©chelle reste un mar√©cage.  Par cons√©quent, il a √©t√© d√©cid√© de cr√©er un entrep√¥t de donn√©es (DX), dans lequel les informations proviendraient de diff√©rentes bases de donn√©es, afin que d'autres services et le syst√®me analytique sous forme de cubes, de rapports SSRS et de fuites puissent recevoir des donn√©es de ce CD. <br><br>  Pour l'avenir, je dirai que la transition vers un nouveau syst√®me comptable est presque termin√©e et que la plupart des projets d√©crits ici seront supprim√©s dans un proche avenir car inutiles.  D√©sol√©, bien s√ªr, mais rien ne peut √™tre fait. <br><br>  Ce qui suit est un long article, mais avant de commencer la lecture, permettez-moi de noter qu'en aucun cas je ne passe cette d√©cision comme une norme, mais peut-√™tre que quelqu'un y trouvera quelque chose d'utile. <br><a name="habracut"></a><br>  Je vais commencer par une approche g√©n√©rale du projet, pour lequel SSDT a √©t√© choisi comme environnement de d√©veloppement, avec la publication ult√©rieure du projet dans Git.  Je pense qu'aujourd'hui, il existe suffisamment d'articles et de tutoriels qui d√©crivent les points forts de cet outil.  Mais il y a quelques points dont le probl√®me se situe en dehors de cet environnement. <br><br><h4>  Stockage des √©num√©rations et des versions de base de donn√©es </h4><br>  En ce qui concerne les versions et les √©num√©rations, les exigences du projet signifiaient: <br><br><ul><li>  Commodit√© de modification et de suivi des modifications de la version de la base de donn√©es dans le projet </li><li>  Commodit√© de visualiser la version de la base de donn√©es via SSMS pour les administrateurs </li><li>  Sauvegarde de l'historique des changements de version dans la base de donn√©es elle-m√™me (qui et quand le d√©ploiement a √©t√© effectu√©) </li><li>  Stockage des √©num√©rations dans un projet </li><li>  Facilit√© de modification et de suivi des modifications des transferts </li><li>  Verrou de d√©ploiement de base de donn√©es au-dessus d'un existant s'il n'y avait pas de version incr√©mentielle </li><li>  L'installation d'une nouvelle version, l'enregistrement de l'historique, les transferts et la restructuration doivent √™tre effectu√©s en une seule transaction et compl√®tement annul√©s en cas d'√©chec √† n'importe quelle √©tape </li></ul><br>  Parce que  les transferts contiennent souvent de la logique et sont des valeurs de base, sans lesquelles l'ajout d'enregistrements √† d'autres tables devient impossible (en raison des cl√©s √©trang√®res FK), ils font essentiellement partie de la structure de la base de donn√©es, avec les m√©tadonn√©es.  Par cons√©quent, une modification d'un √©l√©ment d'√©num√©ration entra√Æne un incr√©ment de la version de la base de donn√©es et, avec cette version, les enregistrements doivent √™tre garantis pour √™tre mis √† jour pendant le d√©ploiement. <br><br>  Je pense que tous les avantages de bloquer le d√©ploiement sans incr√©menter la version sont √©vidents, dont l'incapacit√© √† r√©ex√©cuter le script de publication s'il a d√©j√† √©t√© ex√©cut√© avec succ√®s plus t√¥t. <br><br>  Bien que le r√©seau de base de donn√©es soit souvent propos√© pour n'utiliser que la version principale (sans fractions), nous avons d√©cid√© d'utiliser des versions au format XY, o√π Y est le correctif lorsqu'une faute de frappe a √©t√© corrig√©e dans la description du tableau, de la colonne, du nom de l'√©l√©ment de liste ou de quelque chose d'autre petit, comme l'ajout d'un commentaire √† une proc√©dure stock√©e, etc.  Dans tous les autres cas, la version principale s'accumule. <br><br>  Peut-√™tre que pour quelqu'un il n'y a rien de <i>tel</i> et tout est √©vident.  Mais en temps voulu, j'ai pris beaucoup de nerfs et d'√©nergie sur les conflits internes sur la fa√ßon de stocker les transferts dans le projet de base de donn√©es, de sorte que ce soit du feng shui ( <i>conform√©ment √† mon id√©e</i> ) et qu'il √©tait pratique de travailler avec eux, tout en minimisant la probabilit√© d'erreurs. <br><br>  Avec les transferts, en g√©n√©ral, tout est simple - nous cr√©ons un fichier PostDeploy dans le projet et y √©crivons du code pour remplir les tables.  Avec des fusions ou des trankates - c'est comme √ßa que vous l'aimez.  Nous avons pr√©f√©r√© clignoter, en v√©rifiant si le nombre d'enregistrements dans la table cible d√©passe le nombre d'enregistrements qui se trouvent dans la source (projet).  S'il d√©passe, alors une exception est lev√©e pour attirer l'attention dessus, car c'est √©trange.  Pourquoi y a-t-il moins d'enregistrements dans la source?  Parce que l'on est superflu?  Pourquoi tout d'un coup?  Et si la base de donn√©es a d√©j√† des liens vers elle?  Bien que nous utilisions des cl√©s √©trang√®res (FK), qui ne vous permettront pas de supprimer l'enregistrement, s'il existe des liens vers celui-ci, nous pr√©f√©rons toujours laisser cette option.  En cons√©quence, PostDeploy s'est transform√© en une feuille illisible, car pour chaque table √† remplir, en plus des valeurs elles-m√™mes, il existe √©galement un code de v√©rification, une fusion, etc. <br><br>  Cependant, si vous utilisez PostDeploy en mode SQLCMD, il devient possible d'extraire des blocs de code dans des fichiers s√©par√©s.Par cons√©quent, il ne reste qu'une liste structur√©e de noms de fichiers pour remplir les √©num√©rations dans PostDeploy. <br><br>  Il existe certaines nuances avec les versions de base de donn√©es.  Internet a longtemps d√©battu de l'endroit o√π stocker la version de la base de donn√©es, √† quoi elle devrait ressembler et, en g√©n√©ral, si elle doit √™tre stock√©e quelque part?  Supposons que nous d√©cidions d'en avoir besoin, √† quel endroit du projet le stocker?  Quelque part dans le joker d'un script PostDeploy, ou le mettre dans une variable qui est d√©clar√©e dans la premi√®re ligne du script? <br><br>  √Ä mon avis, ni l'un ni l'autre.  C'est plus pratique quand il est stock√© dans un fichier s√©par√© et qu'il n'y a plus rien. <br><br>  Quelqu'un dira - il y a dacpac dans les propri√©t√©s du projet et vous pouvez y d√©finir la version.  Bien s√ªr, vous pouvez m√™me extraire cette version dans votre script, comme d√©crit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> , mais cela n'est pas pratique - pour changer la version de la base de donn√©es, vous devez aller quelque part loin, cliquer sur un tas de boutons.  Je ne comprends pas la logique de Microsoft - ils l'ont cach√© dans un coin √©loign√©, avec des param√®tres de base de donn√©es tels que le tri, le niveau de compatibilit√©, etc., parce que la version de la base de donn√©es change aussi "souvent" que les param√®tres de tri, non?  Lorsqu'il y a un d√©veloppement constant, la version s'accumule √† chaque nouveau d√©ploiement, eh bien, la commodit√© du suivi des modifications joue √©galement un r√¥le important, car lorsqu'un fichier modifi√© avec un nom convivial est allum√©, c'est une chose, et lorsque le fichier de projet .sqlproj est allum√©, dans lequel il y a de nombreuses lignes au format XML , et parmi eux quelque part au centre de la ligne, un chiffre modifi√© est mis en surbrillance, en quelque sorte pas tr√®s. <br><br><img src="https://habrastorage.org/webt/bg/i3/48/bgi3485rgezdefuaami2weappqy.png"><br><br>  C'est mieux <br><br><img src="https://habrastorage.org/webt/ro/9y/ld/ro9yldaaeoqcmubpi42adq-so50.png"><br><br>  Cependant, ce ne sont peut-√™tre que mes cafards et vous ne devriez pas y faire attention. <br><br>  Maintenant, la question est: o√π stocker cette version d√©j√† dans la base de donn√©es d√©ploy√©e.  Encore une fois, il semble que dacpac le fasse magnifiquement - il √©crit tout sur les plaques syst√®me, mais pour voir la version, vous devez ex√©cuter la demande (ou peut-il en √™tre autrement, mais je ne sais pas comment les cuisiner? Il semble que dans les anciennes versions de SSMS il y avait une interface pour cela, et maintenant non) <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> msdb.dbo.sysdac_instances_internal</code> </pre> <br>  pour l'administrateur (et pas seulement) ce n'est pas tr√®s pratique.  Il est beaucoup plus logique que la version soit affich√©e directement dans les propri√©t√©s de la base de donn√©es elle-m√™me. <br><br><img src="https://habrastorage.org/webt/ed/ax/le/edaxle3ic1lfwvaeuhhhphmrulo.png"><br><br>  Ou pas? <br><br>  Pour ce faire, vous devez ajouter un fichier au projet, inclus dans la build, d√©crivant les propri√©t√©s avanc√©es <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeployerName'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeploymentDate'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DBVersion'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>;</code> </pre> <br>  Oui, ils sont vides et √ßa a l'air moche dans un script de publication, mais vous ne pouvez pas vous en passer.  S'ils ne sont pas d√©crits dans le projet et qu'ils seront dans la base de donn√©es, le studio essaiera de les supprimer √† chaque d√©ploiement.  (Il y a eu de nombreuses tentatives pour contourner cela succinctement et sans options de d√©ploiement inutiles, mais en vain) <br><br>  Nous allons d√©finir leurs valeurs dans le script PostDeploy. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @username <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) = suser_sname() ,@curdatetime <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>(),<span class="hljs-string"><span class="hljs-string">'dd.MM.yyyy HH:mm:ss'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_updateextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeployerName'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = @username; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_updateextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DBVersion'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DBVersion)]; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_updateextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeploymentDate'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = @curdatetime;</code> </pre> <br>  <code>sp_updateextendedproperty</code> sans aucune v√©rification, car au moment o√π le bloc a √©t√© d√©marr√© √† partir de PostDeploy, toutes les propri√©t√©s √©taient d√©j√† cr√©√©es si elles n'√©taient pas l√†. <br><br>  Eh bien, ce serait bien de garder l'historique, au sujet de qui et quand d√©ployait la base de donn√©es. <br><br>  Le d√©ploiement des modifications de m√©tadonn√©es peut √™tre effectu√© dans la transaction √† l'aide d'outils standard en cochant la <b>case Activer les scripts de transaction</b> dans la fen√™tre <b>Options de publication avanc√©es</b> .  Mais cet indicateur n'affecte pas les d√©ploiements (pr√© / post) et ils continuent de s'ex√©cuter sans transaction.  Bien s√ªr, rien n'emp√™che la transaction de d√©marrer au d√©but du script PostDeploy, mais ce sera une transaction distincte des m√©tadonn√©es, et nous avons la t√¢che d'annuler les modifications de m√©tadonn√©es si une exception s'est produite dans PostDeploy. <br><br>  La solution est simple: d√©marrez la transaction dans PreDeploy, validez-la dans PostDeploy et n'utilisez aucune coche dans les param√®tres de publication √† ces fins. <br><br>  Afin de stocker facilement la version de la base de donn√©es dans le projet et de l'enregistrer aux endroits souhait√©s pendant le d√©ploiement, vous pouvez recourir aux variables SQLCMD.  Cependant, je ne veux pas stocker la version quelque part dans le joker du code, je veux qu'elle soit √† la surface. <br><br><img src="https://habrastorage.org/webt/yg/qm/o9/ygqmo9wf5pnwnyx7kfnumsflps8.png"><br><br>  Afin de placer la version de la base de donn√©es dans un fichier s√©par√© et d'en g√©rer la version au niveau du projet, nous ajoutons le bloc suivant √† .sqlproj: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BeforeBuild"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\Properties\DBVersion"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskParameter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Lines"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PropertyName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExtDBVersion"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WriteLinesToFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\\SetPreDepVarsTmp.sql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Lines</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">":setvar DBVersion $(ExtDBVersion)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Overwrite</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Il s'agit d'une instruction pour MSBuild de lire une ligne √† partir d'un fichier avant de cr√©er et de cr√©er un fichier temporaire bas√© sur les donn√©es lues.  MSBuild cr√©era un fichier temporaire <code>SetPreDepVarsTmp.sql</code> , qui <code>:setvar DBVersion $(ExtDBVersion)</code> ligne <code>:setvar DBVersion $(ExtDBVersion)</code> , o√π <code>$(ExtDBVersion)</code> est la valeur lue dans notre fichier qui stocke la version de la base de donn√©es. <br><br>  Apr√®s de telles manipulations, vous pouvez vous r√©f√©rer √† ce fichier temporaire √† partir du script PreDeploy et y d√©marrer la transaction globale: <br><br><pre> <code class="sql hljs">:r .\SetPreDepVarsTmp.sql go :r ".\BeginTransaction.sql"</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Version interm√©diaire</b> <div class="spoiler_text">  Initialement, le fichier ExtendedProperties.sql a re√ßu des valeurs non vides, mais des valeurs de variables <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeployerName'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DeployerName)]; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeploymentDate'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DeploymentDate)]; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DBVersion'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DBVersion)];</code> </pre> <br>  Les variables, √† leur tour, ont √©t√© enregistr√©es dans le fichier SetPreDepVarsTmp.sql automatiquement par MSBuild comme ceci: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentDateTime</span></span></span><span class="hljs-tag">&gt;</span></span>$([System.DateTime]::Now.ToString(dd.MM.yyyy HH:mm:ss))<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentDateTime</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NewLine</span></span></span><span class="hljs-tag">&gt;</span></span> -- <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NewLine</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BeforeBuild"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\DBVersion"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskParameter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Lines"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PropertyName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExtDBVersion"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WriteLinesToFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\SetPreDepVarsTmp.sql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Lines</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">":setvar DBVersion $(ExtDBVersion)$(NewLine):setvar DeploymentDate "</span></span></span><span class="hljs-tag">$(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">CurrentDateTime</span></span></span><span class="hljs-tag">)"$(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NewLine</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:setvar</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DeploymentUser</span></span></span><span class="hljs-tag"> $(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">UserDomain</span></span></span><span class="hljs-tag">)\$(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">UserName</span></span></span><span class="hljs-tag">)" </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Overwrite</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Avec cette approche, vous n'avez pas besoin de r√©installer ces propri√©t√©s dans PostDeploy, mais le probl√®me est que SetPreDepVarsTmp.sql contenait des valeurs statiques et si le script de publication a √©t√© g√©n√©r√© maintenant, mais d√©ploy√© apr√®s une heure, ou pire encore, le lendemain (le d√©veloppeur l'a v√©rifi√© pendant longtemps) visuellement, par exemple), la date de publication sp√©cifi√©e dans les propri√©t√©s sera diff√©rente de la date de publication r√©elle et ne co√Øncidera pas avec la date de l'historique. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Contenu du fichier BeginTransaction.sql</b> <div class="spoiler_text">  En substance, il s'agit simplement d'un copier-coller √† partir du bloc de d√©marrage de transaction standard que le studio g√©n√®re lorsque la <b>case √†</b> cocher <b>Activer les scripts de transaction</b> est <b>coch√©e</b> , mais nous l'utilisons √† notre mani√®re.  Dans le script, seul le nom de la table temporaire est pass√© de <code>#tmpErrors</code> √† <code>#tmpErrorsManual</code> afin qu'il n'y ait pas de conflit de nom si quelqu'un active la case √† cocher. <br><br><pre> <code class="sql hljs">IF (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> OBJECT_ID(<span class="hljs-string"><span class="hljs-string">'tempdb..#tmpErrors'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpErrorsManual GO CREATE TABLE #tmpErrorsManual (Error int) GO SET XACT_ABORT ON GO SET TRANSACTION ISOLATION LEVEL READ COMMITTED GO BEGIN TRANSACTION GO</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Script PostDeploy</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @TableName <span class="hljs-built_in"><span class="hljs-built_in">VarChar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-comment"><span class="hljs-comment">--        if $(SkipEnumDeploy) = 0 begin PRINT N' ...' :r ..\\EnumTable1.sql end --   PRINT N'  ...'; declare @username varchar(256) = suser_sname() , @curdatetime varchar(20) = format(getdate(),'dd.MM.yyyy HH:mm:ss') if $(DBVersion) &gt; (select isnull( MAX( DBVersion),0) from zDBVersionHistory) begin insert into zDBVersionHistory( DBVersion, DeploymentDate, DeployerName) values ($(DBVersion),@curdatetime,@username) EXECUTE sp_updateextendedproperty @name = N'DeployerName', @value = @username; EXECUTE sp_updateextendedproperty @name = N'DBVersion', @value = [$(DBVersion)]; EXECUTE sp_updateextendedproperty @name = N'DeploymentDate', @value = @curdatetime; end else begin RaisError ( N':          ,  .      ,        DBVersion          .' , 16 , 1 ) WITH SETERROR; end GO :r ".\CaptureTransactionError.sql" :r ".\CommitTransaction.sql"</span></span></code> </pre> <br>  La variable SkipEnumDeploy, comme elle est d√©j√† devenue claire, vous permet d'ignorer l'√©tape de mise √† jour des listes; cela peut √™tre utile pour des changements cosm√©tiques mineurs.  Bien que, du point de vue de la religion, cela puisse ne pas √™tre vrai, cela est certainement utile au stade du d√©veloppement. <br></div></div><br>  Les fichiers <code>CaptureTransactionError.sql</code> et <code>CommitTransaction.sql</code> <code>CaptureTransactionError.sql</code> √©galement <code>CaptureTransactionError.sql</code> - <code>CaptureTransactionError.sql</code> (avec des modifications mineures) √† partir de l'algorithme de transaction standard que le studio g√©n√®re lorsque l'indicateur ci-dessus est d√©fini, et que nous jouons maintenant par nous-m√™mes. <br><br><div class="spoiler">  <b class="spoiler_title">Content CaptureTransactionError.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs">IF @@ERROR &lt;&gt; 0 AND @@TRANCOUNT &gt; 0 <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @@TRANCOUNT = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpErrorsManual (Error) VALUES (1); BEGIN TRANSACTION; END</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Contenu CommitTransaction.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs">IF EXISTS (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpErrorsManual) ROLLBACK TRANSACTION GO DROP TABLE #tmpErrorsManual GO IF @@TRANCOUNT&gt;0 BEGIN PRINT N'     .' COMMIT TRANSACTION END ELSE RaisError ( N'    .' , 16 , 1 );</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Contenu EnumTable1.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TableName = N<span class="hljs-string"><span class="hljs-string">'Table1'</span></span> PRINT N<span class="hljs-string"><span class="hljs-string">'  '</span></span>+@TableName+<span class="hljs-string"><span class="hljs-string">'...'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> try <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpEnums; select * into #tmpEnums from (values ( 0, ' 1') , ( 1, ' 2') , ( 2, ' 3') ) as tmp ( Id , Title ) set nocount off --         If ((select count(*) from Table1) &gt; (select count(*) from #tmpEnums)) begin RaisError ( N':      ,   .' , 0 , 1 ) WITH SETERROR; end set Identity_insert Table1 on Merge Table1 as target Using ( select * from #tmpEnums except select * from dbo.Table1 ) as source on target.Id = source.Id when matched then update set target.Title = source.Title when not matched by target then insert ( Id , Title ) values ( source.Id , source.Title ); set Identity_insert Table1 off drop table if exists #tmpEnums; END TRY begin catch IF @@trancount &gt; 0 ROLLBACK TRANSACTION set @Error_Message = Error_Message(); RaisError ( N': %s.' , 0 , 1 , @Error_Message ) WITH SETERROR; end catch :r "..\\CaptureTransactionError.sql"</span></span></code> </pre> <br></div></div><br>  Lors du d√©ploiement de <code>Publish</code> script aura la structure suivante <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- PreDeploy ----:setvar DBVersion "10.6" --   ,     DBVersion ----   --    ,           -- PostDeploy ----  ----   ----  </span></span></code> </pre> <br><br>  Id√©alement, bien s√ªr, j'aimerais que la version soit affich√©e au moment de la publication <br><img src="https://habrastorage.org/webt/8a/9w/o2/8a9wo2o5lemfglm1ru1kt5yntdm.png"><br><br>  Mais vous ne pouvez pas extraire la valeur du fichier dans cette fen√™tre, bien que MSBuild la lise et la place dans la propri√©t√© ExtDBVersion √† l'aide d'instructions suppl√©mentaires dans le fichier .sqlproj, comme dans l'exemple ci-dessus, mais la construction <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SqlCmdVariable</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DBVersion"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultValue</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultValue</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Value</span></span></span><span class="hljs-tag">&gt;</span></span>$(ExtDBVersion)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SqlCmdVariable</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  ne roule pas. <br><br>  Les d√©veloppeurs de la suite dans leur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">journal Web</a> √©crivent comment cela est fait.  Selon leur version, la magie r√©side dans l'instruction <code>SqlCommandVariableOverride</code> , qui est simple - ajoutez quelques lignes au fichier de projet .sqlproj <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SqlCommandVariableOverride</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DBVersion=$(ExtDBVersion)"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  et c'est fait.  Bien essay√©, mais non.  Peut-√™tre que lorsque ce billet de blog a √©t√© publi√©, tout a fonctionn√©, mais depuis lors, dans ces √âtats-Unis, vous avez eu trois √©lections pr√©sidentielles et personne ne sait quelles instructions pourraient cesser de fonctionner demain. <br><br><img src="https://habrastorage.org/webt/xv/d9/li/xvd9liiwyjicnv5icr9d1utjnxs.jpeg"><br><br>  Et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici,</a> un camarade a essay√© toutes les options, mais aucune n'a d√©coll√©. <br><br>  Par cons√©quent, prenez la version de dacpac, ou stockez-la dans PostDeploy, ou dans un fichier s√©par√©, ou _________ (entrez votre version). <br><br><h4>  Int√©gration avec 1C </h4><br>  Le premier probl√®me √©tait que 1C77 n'a pas de serveur d'application ou autre d√©mon qui lui permet d'interagir avec lui sans lancer la plateforme.  Ceux qui ont travaill√© avec 1C77 savent qu'elle n'a pas de mode console complet.  Vous pouvez ex√©cuter la plate-forme avec des param√®tres et m√™me faire quelque chose en fonction d'eux, mais il y a tr√®s peu de param√®tres de console et leur objectif √©tait diff√©rent.  Mais m√™me avec leur aide, vous pouvez nakolkhozit une moissonneuse-batteuse enti√®re.  Cependant, il peut s'envoler de fa√ßon impr√©visible, il peut faire appara√Ætre une fen√™tre modale et attendre que quelqu'un clique sur OK et d'autres charmes.  Et, peut-√™tre, le plus gros probl√®me - la vitesse de la plate-forme laisse beaucoup √† d√©sirer ... Par cons√©quent, il n'y a qu'une seule solution - les requ√™tes directes vers la base de donn√©es 1C.  Compte tenu de la structure, vous ne pouvez pas simplement prendre et √©crire ces requ√™tes, mais l'avantage est qu'il y a toute une communaut√© qui a d√©velopp√© √† un moment un merveilleux outil - 1C ++ (1cpp.dll), ce qui est incroyable pour eux MERCI!  La biblioth√®que vous permet d'√©crire des requ√™tes en termes de 1C, qui se transforment alors en vrais noms de tables et de champs.  Si quelqu'un ne le sait pas, alors la demande peut √™tre √©crite en utilisant un pseudo-nom et cela ressemblera √† ceci <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> $.</code> </pre> <br>  Une telle demande est compr√©hensible pour les humains, mais il n'y a pas de telle table et champ sur le serveur, il existe d'autres noms, donc 1C ++ le transformera en <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> SP5278 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> SC2235</code> </pre> <br>  et une telle demande est d√©j√† comprise par le serveur.  Tout le monde est heureux, personne ne jure - ni une personne, ni un serveur.  Ici, il semble que le probl√®me soit r√©solu. <br><br>  Le deuxi√®me probl√®me r√©sidait dans le plan des configurations: une configuration √©tait utilis√©e dans les succursales, une autre dans le bureau central et la troisi√®me dans les succursales!  Classe? !! 1 Je le pense aussi.  De plus, ils ne sont pas un h√©ritage typique ni m√™me typique, mais enti√®rement √©crits √† partir de z√©ro pendant les Vikings et, malheureusement, ce ne sont pas les meilleurs architectes qui ont jet√© les bases de ces configurations ... Le document d'impl√©mentation, par exemple, a un ensemble de d√©tails diff√©rent dans chaque configuration.  Mais non seulement les noms de certains champs diff√®rent, ce qui est beaucoup plus amusant lorsque les noms des d√©tails sont les m√™mes, mais la signification des donn√©es qui y sont stock√©es est DIFF√âRENTE. <br><br><img src="https://habrastorage.org/webt/hs/jx/sv/hsjxsv_f7qy4xlgpwjiw7uir0ko.jpeg"><br><br>  Dans les configurations, presque aucun registre n'est utilis√©, tout est construit sur les subtilit√©s des documents.  Par cons√©quent, parfois, je devais √©crire une feuille enti√®re sur une transaction propre, avec un tas de cas et de jointures, pour r√©p√©ter la logique d'une proc√©dure de la configuration, qui affiche des informations dans le champ de texte du formulaire. <br><br>  Nous devons rendre hommage √† l'√©quipe de d√©veloppement, qui pendant toutes ces ann√©es a soutenu ce qu'elle a h√©rit√© des "impl√©menteurs", c'est un travail √©norme - pour soutenir cela et m√™me optimiser quelque chose.  Jusqu'√† ce que vous voyiez - vous ne comprenez pas, je ne croyais pas moi-m√™me au d√©but que tout pouvait √™tre si compliqu√©.  Demandez - pourquoi ne pas r√©√©crire √† partir de z√©ro?  Manque banal de ressources.  L'entreprise se d√©veloppait si rapidement que, malgr√© une grande √©quipe de programmeurs, ils ne pouvaient tout simplement pas r√©pondre aux besoins de l'entreprise, sans parler de la r√©√©criture de l'ensemble du concept. <br><br>  Nous continuons l'histoire des demandes.  De toute √©vidence, tous les blocs d'extraction de donn√©es se sont transform√©s en stockages afin qu'ils puissent plus tard √™tre lanc√©s c√¥t√© serveur en contournant la plate-forme 1C.  La r√®gle √©tait la suivante: un stockage est responsable de la r√©cup√©ration d'une entit√©.  Parce que  La liste de souhaits au d√©but a d√©j√† beaucoup accumul√©, car elle est devenue douloureuse au fil des ans, puis des dizaines de fichiers de stockage se sont r√©v√©l√©s. <br><br>  Le troisi√®me probl√®me est de savoir comment augmenter la vitesse et la qualit√© du d√©veloppement, et comment alors supporter tout ce monstre?  Ecrire une demande pour 1C ++ et copier-coller le r√©sultat de sa conversion en stockage?  C'est tr√®s g√™nant et fastidieux, en outre, il y a une forte probabilit√© d'erreurs - copiez la mauvaise ou la mauvaise ou ne s√©lectionnez pas la derni√®re ligne de la requ√™te et copiez sans elle.  Cela est particuli√®rement vrai lorsqu'il s'agit de diriger des requ√™tes 1C, car il n'y a pas de pseudo-nom comme <i>Directory.</i> Nomenclature. Article, seuls les vrais noms <i>SC2235.SP5278</i> et donc de copier une demande depuis le r√©pertoire des marchandises vers un magasin qui r√©cup√®re les clients est tr√®s simple.  Bien s√ªr, la demande tombera tr√®s probablement en raison de l'inad√©quation des types et du nombre de champs dans la table de destination, mais il existe des plaques identiques, telles que les √©num√©rations, o√π seules deux colonnes sont ID et Nom.  En g√©n√©ral, il ne reste plus qu'√† appliquer une sorte d'automatisation.  Eh bien, assez de paroles, passons aux choses s√©rieuses! <br><br>  Je voulais que le processus de d√©veloppement du stockage se r√©sume √† quelque chose comme ceci: <br><br><ol><li>  Nous corrigeons la requ√™te SQL avec des pseudo-noms et l'enregistrons </li><li>  Nous appuyons sur un <b>bouton magique</b> et √† la sortie nous recevons la proc√©dure stock√©e corrig√©e sur le SQL converti, claire pour le serveur </li></ol><br><h4>  Quelques d√©tails </h4><br>  Pour r√©soudre le troisi√®me probl√®me, un traitement externe (.ert) a √©t√© √©crit.  Il existe un certain nombre de proc√©dures de traitement, chacune contenant le texte de la requ√™te pour extraire une entit√© √† l'aide d'un pseudo-nom, comme <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> $.</code> </pre> <br>  Sur le formulaire de traitement, il y a un champ pour afficher le r√©sultat d'une proc√©dure particuli√®re, c'est-√†-dire  demande convertie en un formulaire compr√©hensible par le serveur afin que vous puissiez l'essayer rapidement.  De plus, un <b>bloc de d√©bogage est</b> toujours ajout√© √† cette demande, avec la d√©claration des variables, les noms des bases de donn√©es de test, des serveurs, etc.  Il ne reste plus qu'√† copier-coller dans SSMS et appuyer sur F5.  Vous pouvez, bien s√ªr, ex√©cuter cette demande √† partir du traitement lui-m√™me, mais le plan de demande et tout cela, eh bien, vous comprenez ... En g√©n√©ral, c'est ainsi que le d√©bogage se fait.  Parce que  Il existe plusieurs configurations; lors du traitement, il est possible de convertir les m√™mes textes de requ√™te avec des pseudo-noms d'objets en requ√™tes finales pour diff√©rentes configurations.  En effet, dans une confe, la r√©f√©rence de la nomenclature est SC123, et dans une autre - SC321.  Mais 1C ++ vous permet de charger diff√©rentes configurations lors de l'ex√©cution et de g√©n√©rer une sortie individuelle pour chacune d'entre elles conform√©ment au dictionnaire. <br><br>  Ensuite, le mode d'ex√©cution par lots a √©t√© ajout√© au traitement, lorsqu'il d√©marre automatiquement chacune des proc√©dures pour chaque configuration, et la sortie de chacune d'entre elles est √©crite dans des fichiers .sql (ci-apr√®s les fichiers de base).  Ainsi, nous obtenons un tas de combinaisons de fichiers de base, qui devraient ensuite se transformer automatiquement en proc√©dures stock√©es √† l'aide de VS.  Il est √† noter que les fichiers de base incluent <b>un bloc de d√©bogage</b> . <br><br>  Il semblerait, pourquoi ne pas conclure imm√©diatement les fichiers finaux des proc√©dures stock√©es et tout garder dans ce traitement?  Le fait est que pour certains tests, il est n√©cessaire d'ex√©cuter des versions de d√©bogage de requ√™tes par lots dans lesquelles toutes les variables sont d√©clar√©es, en plus je voulais que les noms de proc√©dures stock√©es soient g√©r√©s √† partir de VS, en contournant 1C, car c'est logique, n'est-ce pas? <br><br>  Soit dit en passant, les fichiers de base sont √©galement stock√©s dans le projet, eh bien, les fichiers des proc√©dures stock√©es pr√™tes √† l'emploi, bien s√ªr.  √Ä tout moment, sans d√©marrer 1C, vous pouvez ouvrir le fichier de base dans SSMS et l'ex√©cuter sans vous soucier des d√©clarations de variables. <br><br>  Lors du traitement, toutes les proc√©dures avec demandes sont √©galement des mod√®les, ayant le m√™me ensemble de param√®tres, mais dans telle ou telle proc√©dure, seuls les param√®tres n√©cessaires sont utilis√©s.  Dans certains, tout est en jeu, et dans certains, deux suffisent.  Par cons√©quent, l'ajout d'une nouvelle proc√©dure revient √† copier le mod√®le et √† remplir les param√®tres avec les requ√™tes elles-m√™mes. <br><br>  Le code de l'une des proc√©dures de traitement, qui se transformera ensuite en proc√©dure stock√©e <br><img src="https://habrastorage.org/webt/ci/ev/sb/cievsb9urq5miainrvoqu9mkig0.png"><br><br>  La requ√™te finale va quelque chose comme ceci: <br><pre> <code class="1c hljs">++<span class="hljs-string"><span class="hljs-string">"("</span></span>+OPENQUERY()+<span class="hljs-string"><span class="hljs-string">")"</span></span>+ </code> </pre> <br>  Apparence du traitement <br><img src="https://habrastorage.org/webt/yv/n4/in/yvn4injz09-m8ljnqhbediqvmqy.png"><br><br>  Lors du changement de configuration, la liste des √©l√©ments disponibles (n√©cessaires) pour d√©charger les √©l√©ments dans la liste des donn√©es change.  Si possible, le code de proc√©dure dans 1C √©tait autant que possible unifi√©.  Si des contreparties sont extraites et que ces r√©pertoires sont incoh√©rents dans diff√©rentes configurations, alors il y a diff√©rents cas √† l'int√©rieur de la proc√©dure de g√©n√©ration, tels que: ce bloc est fix√© pour tout le monde, celui-ci n'est ajout√© √† la demande finale que pour un tel confon, et il y en a un pour l'autre.  Il s'av√®re que dans les proc√©dures stock√©es pour une entit√© mais dans des configurations diff√©rentes, elles peuvent diff√©rer non seulement par les noms de table, mais par des blocs entiers de jointures pr√©sents dans l'un et absents dans l'autre.  L'ensemble des champs de sortie, bien s√ªr, est le m√™me et correspond √† la table r√©ceptrice ou au conteneur du package SSIS, certains champs sont encombr√©s de stubs pour les configurations dans lesquelles ces d√©tails ne sont pas en principe. <br><br>  <b>Bouton magique</b> <br><br>  Visual Studio dispose d'outils tels que MSbuild et les impressionnants mod√®les T4.  Par cons√©quent, en tant que bouton magique, un script a √©t√© √©crit en C # pour T4, qui: <br><br><ol><li>  Enregistre une configuration vide dans le registre (sinon 1C affichera une fen√™tre modale avec une suggestion pour enregistrer une conf et attendre les actions de l'utilisateur) </li><li>  Cr√©e une base de donn√©es vide pour ce konf sur le serveur SQL, car sans lui 1C donnera une erreur </li><li>  Lance 1C et via OLE lui dit d'ex√©cuter le traitement (le m√™me .ert), en transf√©rant √©galement un GUID unique √† 1C </li><li>  La sortie est une s√©rie de fichiers avec des demandes pr√™tes √† l'emploi (converties) et un fichier marqueur, dans lequel le GUID re√ßu au d√©marrage est √©crit </li><li>  L'enregistrement de la conf est supprim√© du registre et une base de donn√©es vide temporaire est supprim√©e du serveur </li><li>  V√©rifie le contenu du fichier de jeton.  Si le fichier marqueur contient le GUID que nous avons pass√© √† 1C lors de son d√©marrage, cela signifie qu'il a fonctionn√© jusqu'√† la fin, n'a pas plant√©, etc., puis passez √† l'√©tape suivante, ou nous affichons une erreur </li><li>  Nous cr√©ons des stockages. </li><li>  Nous d√©compilons le fichier .ert avec gcomp pour obtenir les textes du module et les formulaires de traitement, enfin, nous les convertissons en Unicode, pour les envoyer ensuite √† Git et les afficher correctement l√†-bas.  Pour ceux qui n'ont pas travaill√© avec 1C: le fichier .ert est un binaire et le studio, avec le git, souffle que le fichier .ert a √©t√© modifi√©, mais on ne sait pas exactement ce qui a chang√©, peut-√™tre que quelqu'un a d√©plac√© le bouton d'un pixel vers la gauche (ce qui inacceptable sans justification) </li></ol><br><br>     T4       ,     (   ,    )        .      ,          .         ,     ,       ,      ,         - ‚Äî   1. <br><br>  ,  ,    ,        ,        ,          .      ‚Äî   1,     1,  -   . <br><br>      :       ? <br><br><ol><li>     / ; </li><li>    VS     ,     ; </li><li>   4; </li><li> <s>.</s>  C'est fait. </li></ol><br><div class="spoiler"> <b class="spoiler_title">?</b> <div class="spoiler_text">  Parce que               ,       ,    .sqlproj,  <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \1.sql"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \2.sql"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \3.sql"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Sur <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Content</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \*.sql"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>       ¬´     ¬ª.   ,  ,   ,     :) <br><br>     , ,    (, )     .           ( ),         , -   - -       ,             . <br></div></div><br>         ,      .      . , ,      ,      ,       ,       (    ),      . ,    (   ,      )  ,        ,  ,          .           ,   . ,     ,      ,     ,   ,     (   ,          1, ,    MD ). <br><br>      ,         <i>OPENQUERY</i> ,     1   ,     ,       ,       ,         <i>EXEC</i> . <i>OPENQUERY</i>    ,      ,   ,   . <br><br>  177 (  )   SQL2000,   varchar(max)  ,  varchar(8000),     9, ‚Ä¶ ,          EXEC(@SQL1+@SQL2).    ,       SQL2016,     SQL2000.     ,     ,    . <br><br><div class="spoiler"> <b class="spoiler_title">      </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> @<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName.dbo.$. <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> @<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName.dbo.$. <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> xxx = <span class="hljs-string"><span class="hljs-string">'hello!'</span></span> ^<span class="hljs-comment"><span class="hljs-comment">--       8 , ,        ,       ,   .          ,             .. ... join ... ) join ...</span></span></code> </pre> </div></div><br><br><div class="spoiler"> <b class="spoiler_title">     </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [dbo].[SP1] @LinkedServerName <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">24</span></span>) ,@<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">24</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Declare</span></span> @TSQL0 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">8000</span></span>), @TSQL1 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">8000</span></span>), @TSQL2 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">8000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TSQL0=<span class="hljs-string"><span class="hljs-string">' select ... from OPENQUERY('</span></span>+@LinkedName+<span class="hljs-string"><span class="hljs-string">','' select ... from '</span></span>+@<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName+<span class="hljs-string"><span class="hljs-string">'.dbo.DH123. join '</span></span>+@<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName+<span class="hljs-string"><span class="hljs-string">'.SC123. ... where '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TSQL1=<span class="hljs-string"><span class="hljs-string">' xxx = ''''hello!'''' join ... join ... )'' join ... '''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TSQL2=<span class="hljs-string"><span class="hljs-string">' ... EXEC(@TSQL0+@TSQL1+@TSQL2) END</span></span></code> </pre> <br></div></div><br>     ‚Äî     .       (, )   ,       , ,     ,      ,      ,   OPENQUERY  8 . <br><br> .ert             ,        ..  ,     . <br><br>          ,    . <br><br><h4> ETL </h4><br> ,       (  ).      (Stage).   ,  ETL    SSIS , ,   ,     ,      .      .                    (  ),            . <br><br>                 ,     (   ) ,   ,        (..   ),            ,        . <br><br>          ,     ,      . ,     .     zabbix. <br><br>             . <br><br>  Parce que    1     ,        ,            .      ,   ,   <code>truncate</code>  . <br><br> ,       (  )       -,  ¬´ 1-¬ª     . <br><br>     SSIS  <br><br><img src="https://habrastorage.org/webt/al/nl/u_/alnlu_3yriilaxfcwlhq_mcf_ce.png"><br><br>      <br><br><img src="https://habrastorage.org/webt/rh/eh/c8/rhehc8b9jtn6qf6polrfqjiduuk.png"><br><br><h4>  ,   </h4><br>         SSIS     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> SQL Server</a> (SQL Server Destination),     ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> OLE DB</a> (OLE DB Destination). <br><br>      ,       ,     ,             .    ,        ,   . (,     ) <br><br>       .           ,    ,      ,        (/  ). <br>                      . <br><br>          ,         (  ).  C'est-√†-dire       ,        .      ,        ,         .    -        ‚Äî          .            . <br><br>                  ,         (.. )   . <br><br>       ,     ,          . <br><br><h4>  PS </h4><br>     ,     ,      ,    ,   .   ‚Äî   ,    .           -  ,       ,   . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr423205/">https://habr.com/ru/post/fr423205/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr423191/index.html">Lancement des √©l√©ments des plateformes offshore. Partie 1</a></li>
<li><a href="../fr423193/index.html">Configurer les notifications Web Push √† l'aide de pywebpush √©tape par √©tape</a></li>
<li><a href="../fr423195/index.html">Nouveaut√©s de JPA 2.2</a></li>
<li><a href="../fr423197/index.html">LOLWUT: une ≈ìuvre d'art dans une √©quipe db</a></li>
<li><a href="../fr423203/index.html">Un chef d'√©quipe cool sera responsable du service</a></li>
<li><a href="../fr423207/index.html">Comment effectuer une mise √† jour automatique d'un client de jeu en ligne</a></li>
<li><a href="../fr423209/index.html">Killer Form 2? Pr√©sentation de l'imprimante 3D dentaire MoonRay S100</a></li>
<li><a href="../fr423211/index.html">Comit√© de la Douma d'√âtat: les go√ªts et les restitutions resteront p√©nalement responsables</a></li>
<li><a href="../fr423213/index.html">Comme dans le vieux russe, il y aura "c'est un test"</a></li>
<li><a href="../fr423215/index.html">O√π est mon argent, mec: de quoi Steam est silencieux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>