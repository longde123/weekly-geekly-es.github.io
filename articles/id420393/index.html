<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🌾 👨🏿‍🏭 🤱🏽 PHP, YII2 dan pembentukan file excel besar 👨🏼 👩🏿‍🏭 🌦️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mulai 
 Satu sistem akuntansi dan pelaporan yang didukung oleh perusahaan kami mulai tumbuh sangat cepat dalam jumlah data yang disimpan. Sistem ini d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP, YII2 dan pembentukan file excel besar</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420393/"><h3>  Mulai </h3><br>  Satu sistem akuntansi dan pelaporan yang didukung oleh perusahaan kami mulai tumbuh sangat cepat dalam jumlah data yang disimpan.  Sistem ini ditulis dalam PHP menggunakan kerangka kerja Yii2.  Awalnya, laporan dibuat melalui pustaka PhpSpreadsheet, yang menggantikan PhpExcel yang sudah lama ditinggalkan. <br><br>  Di antara berbagai jenis pelaporan, ada satu yang sangat besar - pada kenyataannya, set lengkap semua data yang disimpan dalam database harus diunggah ke satu tabel excel.  Pada tahap awal, tidak ada masalah, tetapi ketika volume mulai melebihi ratusan ribu catatan, skrip pembongkaran formasi mulai jatuh pada batas waktu habis. <a name="habracut"></a>  Untuk memulainya, kami menaikkan batas ini dan mulai mencari cara untuk menyelesaikan masalah.  Tetapi solusi sementara tidak bertahan lama - masalah dengan batas waktu berubah menjadi masalah dengan batas memori.  Mereka melemparkan "RAM" ke server dan menghapus memory_limit untuk operasi khusus ini.  Segera, pengguna mulai mengeluh tentang kesalahan runtime lagi.  Saya harus menghapus batas waktu untuk laporan lengkap.  Tapi duduk dan menonton selusin menit di layar dengan indikator memuat tidak terlalu menyenangkan.  Selain itu, kadang-kadang diperlukan laporan "di sini dan sekarang", dan setiap menit yang dihabiskan untuk pembentukannya ternyata sangat kritis.  Eksperimen dengan pengaturan lingkungan dihentikan, menggaruk bagian belakang kepala dan mulai mengoptimalkan kode. <br><br><h3>  Cari solusinya </h3><br>  Hal pertama yang dilakukan adalah bahwa skrip pelaporan ditempatkan di proses latar belakang, dan pengguna memantau kemajuan melalui "bilah kemajuan".  Eksekusi pekerjaan latar belakang diimplementasikan melalui mekanisme antrian menggunakan Redis untuk penyimpanan.  Bekerja dalam sistem tidak berhenti, Anda dapat melakukan tugas-tugas lain dan secara berkala kembali ke halaman laporan untuk melihat apakah file sudah siap.  Segera setelah file terbentuk, pengguna ditawari tautan unduhan.  Tapi, seperti yang disebutkan di atas, kadang-kadang file itu diperlukan "segera", dan peningkatan kegunaan tidak menyelesaikan masalah ini.  Sementara itu, jumlah data terus bertambah dan waktu yang dibutuhkan untuk membangun file mencapai 79 menit!  Ini sepenuhnya tidak dapat diterima, terutama mengingat bahwa pelaporan adalah salah satu dasar dari fungsionalitas sistem ini.  Tidak, semua bagian lainnya bekerja seperti jarum jam, tetapi lalat di salep ini merusak kesan keseluruhan. <br><br><h3>  Hasil pertama </h3><br>  Kami duduk lagi untuk analisis kode.  Hal pertama yang diuji adalah proses pemilihan data dari database.  Tetapi kueri telah dioptimalkan dengan cara semaksimal mungkin.  Meskipun permintaan terlama adalah sampel yang mengerikan dengan lima atau enam panggilan ke FIAS mengerikan, itu berhasil dalam 2-5 detik.  Titik lemah bukan dia, tetapi pembentukan file "exelnik".  Upaya telah mulai mengoptimalkan proses ini.  Mulai dari caching di redis, hingga penyimpangan, seperti pembentukan "excel" kecil yang terpisah di stream paralel, diikuti dengan menempelkan ke satu file.  Tetapi hasilnya selalu sama: masalah dari waktu ke waktu berubah menjadi masalah dengan memori dan sebaliknya.  Tidak ada jalan tengah, hanya mengalir dari satu ekstrem ke yang lain.  Setelah sejumlah data, konsumsi sumber daya perpustakaan mulai tumbuh secara eksponensial dan tidak mungkin untuk mengalahkannya.  PhpSpreadsheet - tidak cocok untuk file besar.  Akibatnya, diputuskan untuk mengubah perpustakaan.  Sebagai pilihan - menulis analog Anda sendiri untuk pembentukan file-file ex. <br><br><h3>  Analisis dan pemilihan alat </h3><br>  Mereka tidak terburu-buru menulis sepeda, tetapi untuk memulainya, mereka menganalisis solusi yang ada.  Dari opsi yang memungkinkan, hanya kotak / semburan yang menarik.  Menulis ulang modul dengan cepat menggunakan perpustakaan ini.  Hasilnya, laporan lengkap diperoleh dalam 145 detik.  Biarkan saya mengingatkan Anda bahwa tes terbaru dengan PhpSpreadsheet adalah 79 menit, dan di sini 2,5 menit!  Pengujian yang dilakukan: menambah jumlah data sebanyak 2 kali.  Laporan dihasilkan dalam 172 detik.  Perbedaannya luar biasa.  Tentu saja, perpustakaan tidak memiliki semua fungsi yang sama dengan PhpSpreadsheet, tetapi dalam hal ini seperangkat alat minimum sudah cukup, karena kecepatan sangat penting. <br><br><h3>  Ekstensi untuk Yii2 </h3><br>  Keputusan akhir dibingkai sebagai perpanjangan untuk Yii2.  Mungkin seseorang akan berguna.  Ekstensi ini memungkinkan Anda untuk mengunggah dataset apa pun dari GridView untuk unggul sambil mempertahankan pemfilteran dan penyortiran.  Ini menggunakan yii / antrian dan kotak / semburan sebagai dependensi.  Masuk akal untuk menggunakan ekstensi untuk membentuk file yang sangat besar, yah, setidaknya 50.000 baris =) Saat ini, modul, yang telah menjadi dasar untuk ekstensi, terkenal menangani dengan beban hampir 600.000 baris. <br><br>  Tautan ke github: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Ekstensi Yii2 ExcelReport</a> <br><br>  Terima kasih atas perhatian anda! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id420393/">https://habr.com/ru/post/id420393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id420383/index.html">"Yandex.Money tidak menarik minat Anda untuk memasukkan aplikasi Anda."</a></li>
<li><a href="../id420385/index.html">Pengujian integrasi berbasis wadah</a></li>
<li><a href="../id420387/index.html">Tiga Rubik's Cube yang cerdas: Xiaomi, Roobo dan GoCube</a></li>
<li><a href="../id420389/index.html">Penerapan pola "Pengamat-Pelanggan" menggunakan panggilan balik JNI di Android (NDK)</a></li>
<li><a href="../id420391/index.html">Pertengahan 2018 gaji IT</a></li>
<li><a href="../id420395/index.html">Tablet "gratis" untuk tahanan - sama sekali tidak gratis</a></li>
<li><a href="../id420397/index.html">Para ilmuwan telah menemukan cara untuk membalikkan proses penuaan sel</a></li>
<li><a href="../id420405/index.html">Meneliti Proses Penjualan TI</a></li>
<li><a href="../id420407/index.html">C bukan bahasa tingkat rendah</a></li>
<li><a href="../id420409/index.html">Pelajari OpenGL. Pelajaran 5.7 - HDR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>