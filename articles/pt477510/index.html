<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💖 ✍🏼 👨🏻‍🔬 Backup e recuperação automáticos de listas de endereços dinâmicas no Mikrotik 🧕🏻 🔗 🐫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O RouterOS no Mikrotik não se lembra dos elementos dinâmicos das listas de endereços e, no caso de uma reinicialização ou perda de energia, apenas ele...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Backup e recuperação automáticos de listas de endereços dinâmicas no Mikrotik</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477510/"> O RouterOS no Mikrotik não se lembra dos elementos dinâmicos das listas de endereços e, no caso de uma reinicialização ou perda de energia, apenas elementos estáticos permanecerão nas listas.  Por exemplo, você tem uma regra que captura spammers ou scanners de portas e proíbe seus endereços IP por um mês.  Normalmente, esses endereços são salvos como entradas dinâmicas nas listas, mas não são salvos durante a reinicialização, o que significa que é fácil perder o banco de dados "rabanete", coletado por alguns meses de operação contínua do gateway. <br><a name="habracut"></a><br>  Para que esse esquema funcione, você precisa de um servidor FTP (eu tenho o Windows, mas o arquivo em lotes é refeito facilmente para nixes) com uma conta que tenha permissões de leitura / gravação.  O mecanismo é baseado na interação dos seguintes elementos: os scripts backupDynList_to_FTP e BackupDynListFromFTP no gateway e o script convertmtik.bat no servidor FTP.  É necessário um servidor de terceiros para descarregar a memória interna do Mikrotik (as listas podem ser muito grandes e a memória não volátil não é grande para todos) e para processar o arquivo com meios mais poderosos de trabalhar com texto do que a linguagem de script interna que o mikrotik possui.  A chamada de função DynListExport é usada para ignorar o limite do sistema no tamanho da lista.  A necessidade de converter a lista se deve ao fato de que se o mesmo elemento (por exemplo, um registro estático) já estiver presente no banco de dados, ocorrerá um erro durante a importação e a importação será interrompida.  Para evitar isso, sempre que um registro estático é adicionado, o manipulador de erros é redefinido e, no caso de uma correspondência, o registro simplesmente não é adicionado e o processo de importação avança. <br><br>  O script BackupDynList_to_FTP é executado a cada hora (00:00), coleta todos os dados sobre registros dinâmicos (que têm pelo menos meia hora de vida) em todas as listas no arquivo iplist_dyn.src e envia esse arquivo para o ftp.  No servidor, a cada hora com um turno de meia hora do primeiro script (00:30), o arquivo em lote convertmtik.bat é executado, que converte o script original recebido do gateway em um script protegido contra erros de coincidência e o salva com o nome iplist_dyn_done.src <br><br>  Agora, no caso de uma queda ou reinicialização do gateway, no momento do lançamento, os dados sobre registros dinâmicos desaparecem automaticamente, mas 60 segundos após o lançamento, o script BackupDynListFromFTP baixa o iplist_dyn_done.src do FTP e o executa, restaurando as listas. <br><br>  O ativador Hourly_Dynlist_Backup_on_FTP (/ sys sheduler) é executado no início de cada hora: <br><br><pre><code class="dos hljs">/system script run BackupDynList_to_FTP</code> </pre> <br>  Script BackupDynList_to_FTP (não esqueça de alterar o endereço FTP, nome de usuário e senha): <br><br><pre> <code class="dos hljs">/system script environment remove [ <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> where name="DynListExport" ]; :global DynListExport <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :foreach i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>=[/ip firewall address–list <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> where dynamic=yes and timeout&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>d00h30m] <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :local list [/ip firewall address–list get $i list]; :local address [/ip firewall address–list get $i address]; :local timeout [/ip firewall address–list get $i timeout]; :local comment [/ip firewall address–list get $i comment]; :put "/ip firewall address–list add list=$list address=$address timeout=$timeout comment=\"$comment\";"}; } :log info "Starting Backup to FTP Script..." :global iplistfile ("iplist_dyn.rsc") :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([/file <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> name=$iplistfile]!= "") <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={/file <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> $iplistfile}; /execute script="\$DynListExport" file=$iplistfile :delay <span class="hljs-number"><span class="hljs-number">60</span></span>s /tool fetch address="_FTP_" port=<span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span>=ftp src–<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>="iplist_dyn.rsc.txt" user= password= dst–<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>="iplist_dyn.src" upload=yes :delay <span class="hljs-number"><span class="hljs-number">20</span></span>s /file <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> $iplistfile :log info "Finished Backup to FTP!"</code> </pre> <br>  O Activator BackupDynList_from_FTP (/ sys sheduler) é executado no momento em que o gateway é iniciado (inicialização): <br><br><pre> <code class="dos hljs">{:delay <span class="hljs-number"><span class="hljs-number">60</span></span>s}; /system script run BackupDynListFromFTP</code> </pre> <br>  Script BackupDynListFromFTP (não esqueça de alterar o endereço FTP, nome de usuário e senha): <br><br><pre> <code class="dos hljs">:local BackupFile "iplist_dyn_done.src" /file remove [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> name=$BackupFile] /tool fetch address="_FTP_" port=<span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span>=ftp src–<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>="$BackupFile" user= password= /import file–name=$BackupFile {:delay <span class="hljs-number"><span class="hljs-number">30</span></span>s}; /file remove [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> name=$BackupFile] /log info "$BackupFile imported"</code> </pre> <br>  Script do servidor Convertmtik.bat - usa a porta SED do utilitário Linux para seu trabalho, por exemplo, do gnuwin32, que deve ser registrado no caminho no servidor: <br><br><pre> <code class="dos hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> # ––––––––––––––––––––––––––––––––––––––––––––––––––––– — &gt; iplist_dyn_done.src <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> # <span class="hljs-variable"><span class="hljs-variable">%date%</span></span> <span class="hljs-variable"><span class="hljs-variable">%time%</span></span> &gt;&gt; iplist_dyn_done.src <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> # ––––––––––––––––––––––––––––––––––––––––––––––––––––– — &gt;&gt; iplist_dyn_done.src <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> /ip firewall address–list &gt; iplist_dyn_done.src sed –e "s/;//" –e "s/\/ip firewall address–list //" –e "s/.*/:<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { &amp; } on–error={}/" iplist_dyn.src &gt;&gt; iplist_dyn_done.src</code> </pre> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt477510/">https://habr.com/ru/post/pt477510/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt477500/index.html">Modelo de Aplicativo (Avalanche - framework de aplicativos para Java)</a></li>
<li><a href="../pt477502/index.html">Trabalho remoto de um empregador saudável</a></li>
<li><a href="../pt477504/index.html">Melhores práticas de desenvolvimento de aplicativos a seguir em 2020</a></li>
<li><a href="../pt477506/index.html">Desenvolvimento de uma aplicação móvel sem servidor</a></li>
<li><a href="../pt477508/index.html">Detectores de radar: mais algumas palavras sobre ética e muitas sobre leis</a></li>
<li><a href="../pt477512/index.html">Batalha de L2TP, RRAS vs SoftEther</a></li>
<li><a href="../pt477514/index.html">Automatização de teste de hardware de sistemas embarcados</a></li>
<li><a href="../pt477518/index.html">Microarquitetura óssea como base para materiais ultraleves e duráveis</a></li>
<li><a href="../pt477520/index.html">Conheça <detalhes></a></li>
<li><a href="../pt477522/index.html">Desafio Tetris aceito</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>