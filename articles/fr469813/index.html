<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëèüèΩ ‚úãüèø üè™ Op√©ration TA505: comment nous avons analys√© les nouveaux outils des cr√©ateurs du cheval de Troie Dridex, Locky ransomware et Neutrino botnet üßíüèº üî∫ üíÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La g√©ographie des attentats du groupe TA505 pour 2019 

 Notre √©quipe d'analystes Threat Intelligence de PT Expert Security Center surveille les cyber...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Op√©ration TA505: comment nous avons analys√© les nouveaux outils des cr√©ateurs du cheval de Troie Dridex, Locky ransomware et Neutrino botnet</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/469813/"><img src="https://habrastorage.org/webt/pe/vr/pg/pevrpgqqlgbp6qmkcpyoc_mmato.jpeg"><br><br>  <i>La g√©ographie des attentats du groupe TA505 pour 2019</i> <br><br>  Notre √©quipe d'analystes Threat Intelligence de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PT Expert Security Center</a> surveille les cybercriminels depuis TA505 depuis six mois.  Le domaine d'int√©r√™t des assaillants est d'ordre financier et les objectifs se situent dans des dizaines de pays sur diff√©rents continents. <a name="habracut"></a><br><br><h2>  Pour quel groupe TA505 est connu </h2><br>  Ce groupe d'attaquants a une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">histoire riche</a> : depuis 2014, il r√©pertorie le cheval de Troie bancaire Dridex, le botnet Neutrino, ainsi que toute une s√©rie de cryptographes - Locky, Jaff, GlobeImposter, etc. <br><br>  L'activit√© du groupe a √©t√© enregistr√©e dans le monde entier - de l'Am√©rique du Nord √† l'Asie centrale.  Remarque: nous avons enregistr√© des cas isol√©s de groupements TA505 malveillants en Russie, mais il y a tout lieu de croire que les assaillants n'avaient pas de cibles dans notre pays, et les envois √©taient de nature al√©atoire. <br><br>  Malgr√© la motivation financi√®re pr√©dominante du groupe, parmi ses objectifs au cours des six derniers mois, il y a eu des instituts de recherche, des organisations du secteur de l'√©nergie, des soins de sant√©, des compagnies a√©riennes et m√™me le secteur public. <br><br><img src="https://habrastorage.org/webt/l9/mn/-c/l9mn-cadrlkmy1jnapnfgmm6wd8.jpeg"><br><br>  <i>R√©partition des attaques TA505 par industrie pour 2019</i> <br><br>  Vous trouverez ci-dessous un exemple d'e-mail de phishing contenant des logiciels malveillants d√©velopp√© par le groupe et cibl√©, √† en juger par son adresse e-mail, au minist√®re britannique des Affaires √©trang√®res. <br><br><img src="https://habrastorage.org/webt/fy/ea/5m/fyea5mnfm5fhgxs0-_l15bbxxy0.jpeg"><br><br>  Depuis le printemps 2018, le groupe utilise l'outil d'acc√®s √† distance FlawedAmmyy et depuis la fin de l'ann√©e, il utilise la nouvelle porte d√©rob√©e ServHelper.  TA505 - l'un des rares √† pouvoir se vanter d'une activit√© vigoureuse pendant longtemps.  De plus, √† chaque nouvelle vague d'attaques, ils apportent des changements int√©ressants √† leurs outils. <br><br><img src="https://habrastorage.org/webt/0r/8h/-z/0r8h-zydxxkqwl0ob50jhxfgh8o.jpeg"><br><br>  <i>Dynamique de d√©couverte du groupe TA505 par mois pour 2019</i> <br><br>  Bien s√ªr, une activit√© aussi bruyante ne passe pas inaper√ßue: il existe de nombreuses publications de nos coll√®gues de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Proofpoint</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Trend Micro</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Yoroi</a> et pas seulement sur les techniques malveillantes et les logiciels malveillants.  Cependant, de nombreux d√©tails int√©ressants sont ignor√©s: <br><br><ul><li>  identificateur de groupe PE packer; </li><li>  une variante de la porte d√©rob√©e ServHelper, dans laquelle l'accent n'est pas mis sur sa propre fonctionnalit√©, mais sur l'impl√©mentation pr√™te √† l'emploi et bien connue de NetsupportManager; </li><li>  infrastructure de r√©seau: bureaux d'enregistrement, h√©bergeurs caract√©ristiques, y compris les intersections avec l'infrastructure du groupe Buhtrap; </li><li>  d'autres groupes VPO non d√©crits pr√©c√©demment. </li></ul><br>  Cet article est le premier d'une s√©rie de nos articles sur TA505. <br><br><h2>  Premi√®re partie  Rencontre par forfait </h2><br>  √Ä la mi-juin 2019, nous avons remarqu√© que les prochains t√©l√©chargeurs de logiciels malveillants FlawedAmmy sont consid√©rablement diff√©rents des versions pr√©c√©dentes: par exemple, la repr√©sentation visuelle du code du programme dans l'√©diteur hexad√©cimal a chang√©, et est m√™me devenue une caract√©ristique de plusieurs √©chantillons pr√©lev√©s: <br><br><img src="https://habrastorage.org/webt/k6/7l/wn/k67lwnebhvicltujro7n_6fo_pu.jpeg"><br><br>  <i>Repr√©sentation ASCII du code de programme</i> <br><br>  Une analyse rapide du code a montr√© que nous avons devant nous un packer inconnu de fichiers ex√©cutables.  Plus tard, il s'est av√©r√© que ce packer couvrait non seulement les chargeurs susmentionn√©s, mais √©galement d'autres √©chantillons du groupe HPE, y compris la charge utile.  Nous avons ensuite d√©cid√© d'√©tudier en d√©tail la logique de d√©compression afin d'extraire automatiquement l'objet cible. <br><br><h3>  Couche 1. XOR torsad√© </h3><br>  La partie cl√© du d√©balleur est pr√©c√©d√©e d'une abondance d'instructions inutiles.  Les auteurs de virus ont souvent recours √† une telle technique pour confondre les √©mulateurs de produits antivirus.  Toutes les choses int√©ressantes commencent par l'allocation de m√©moire pour un tampon de taille 0xD20 en utilisant la fonction WinAPI VirtualAllocEx.  La m√©moire est allou√©e avec les autorisations PAGE_EXECUTE_READWRITE, ce qui vous permet d'√©crire et d'ex√©cuter du code. <br><br><img src="https://habrastorage.org/webt/av/98/-t/av98-tw9eejhg79lgqusz9wizya.jpeg"><br><br>  <i>D√©but du contenu du d√©compresseur</i> <br><br>  La section des donn√©es du fichier √† l'√©tude contient un tableau de donn√©es qui passe par la proc√©dure de d√©cryptage, et le r√©sultat est √©crit dans la m√©moire allou√©e.  Algorithme de d√©chiffrement: <br><br><ul><li>  interpr√©ter 4 octets comme un entier, </li><li>  soustraire le num√©ro de s√©rie </li><li>  effectuer une op√©ration XOR avec une constante donn√©e, </li><li>  effectuer un d√©calage cyclique au niveau du bit vers la gauche de 7 unit√©s, </li><li>  effectuer √† nouveau l'op√©ration XOR avec la constante donn√©e. </li></ul><br><img src="https://habrastorage.org/webt/nz/fq/1w/nzfq1w5puluzqikeibh8ucintau.jpeg"><br><br>  <i>D√©codage de la premi√®re couche</i> <br>  Nous d√©signons cet algorithme par l'abr√©viation <b>SUB-XOR-ROL7-XOR</b> pour y faire r√©f√©rence plus loin. <br>  Apr√®s la proc√©dure de d√©cryptage, les variables sont initialis√©es s√©quentiellement.  Cela peut √™tre repr√©sent√© comme remplissant une structure en C au format suivant: <br><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZOZ</span></span></span><span class="hljs-class"> {</span></span> HMODULE hkernel32; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *aEncodedBlob; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nEncodedBlobSize; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nBlobMagic; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nBlobSize; };</code> </pre> <br>  o√π: <br><br><ul><li>  <i>hkernel32</i> - descripteur de biblioth√®que kernel32.dll; </li><li>  <i>aEncodedBlob</i> - pointeur vers le bloc de donn√©es encod√©, nous l'avons mentionn√© lorsque nous avons fait r√©f√©rence √† la similitude visuelle des √©chantillons ci-dessus; </li></ul><br><img src="https://habrastorage.org/webt/tw/gf/fc/twgffcvlsjw2mfo6rdeyjof2lju.jpeg"><br><br>  <i>Bloc de donn√©es cod√©</i> <br><br><ul><li>  <i>nEncodedBlobSize</i> - taille de 4 octets du bloc de donn√©es cod√©; </li><li>  <i>nBlobMagic</i> - <i>Constante de</i> 4 octets devant le bloc de donn√©es, sur laquelle nous reviendrons plus tard; </li><li>  <i>nBlobSize</i> - taille de 4 octets du bloc de donn√©es d√©cod√©; </li></ul><br>  Nous avons appel√© la structure <b>ZOZ</b> (c'est "505" sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">leetspeak</a> ). <br><br><img src="https://habrastorage.org/webt/zv/le/sm/zvlesmivdy2wt26l0-p2nixbnjk.jpeg"><br><br>  <i>Remplir la structure ZOZ</i> <br><br>  √Ä la suite des actions d√©crites, l'ex√©cution du code sera redirig√©e vers le tampon d√©crypt√© (maintenant, il ne fait aucun doute que les donn√©es d√©crypt√©es sont du code ex√©cutable), et le pointeur vers la structure remplie sera transmis en tant que param√®tre de fonction: <br><br><img src="https://habrastorage.org/webt/zp/a4/jm/zpa4jmn9rtfvnrnnbhbw31autc0.jpeg"><br><br>  <i>Appel du code d√©chiffr√© avec la structure " <b>ZOZ</b> " <b>pass√©</b> en argument</i> <br><br><img src="https://habrastorage.org/webt/30/iu/8_/30iu8_lgix9_bg7kvo72dmp2oca.jpeg"><br><br>  <i>Morceau de code d√©chiffr√© d√©mont√©</i> <br><br><h3>  Couche 2. Plus c'est petit, mieux c'est </h3><br>  Apr√®s avoir transf√©r√© le contr√¥le √† l'√©l√©ment de code d√©chiffr√©, la premi√®re √©tape consiste √† d√©terminer les adresses des fonctions WinAPI GetProcAddress, VirtualQuery, VirtualAlloc, VirtualProtect, VirtualFree et LoadLibraryA.  Cette liste se retrouve souvent dans le travail des codes shell: apr√®s tout, ils doivent pr√©parer et remplir correctement la m√©moire pour le lancement ult√©rieur de la charge utile. <br><br>  Une fois les proc√©dures pr√©liminaires termin√©es, le bloc de donn√©es cod√© transmis est tronqu√©: sur cinq octets, les deux premiers sont supprim√©s et les trois autres sont enregistr√©s: <br><br><img src="https://habrastorage.org/webt/vl/5a/jf/vl5ajfnndn3od-62hput6y5ihgm.jpeg"><br><br>  <i>R√©duction du bloc de donn√©es cod√©es</i> <br><br>  Ensuite, la proc√©dure de d√©cryptage, que nous avons appel√©e <b>SUB-XOR-ROL7-XOR, est effectu√©e</b> .  Dans ce cas, en tant que constante pour l'op√©ration XOR, une autre valeur nBlobMagic est utilis√©e, qui a √©t√© transmise dans la structure <b>ZOZ</b> . <br><br><img src="https://habrastorage.org/webt/bt/4c/w2/bt4cw2dondbm1m04erjff1hfqec.jpeg"><br><br>  <i>R√©utilisation de SUB-XOR-ROL7-XOR</i> <br><br>  Apr√®s cela, le tableau r√©sultant est transf√©r√© vers une fonction dans laquelle une s√©rie de transformations plus complexes a lieu.  Par les valeurs caract√©ristiques des constantes, il est facile d'√©tablir qu'il s'agit de la <a href="">mise en ≈ìuvre du</a> populaire PE-wrapper FSG (Fast Small Good).  Il est curieux que la version originale du packer FSG comprime PE en sections, et l'impl√©mentation de l'algorithme dans notre cas fonctionne avec PE dans son ensemble. <br><br><img src="https://habrastorage.org/webt/qy/fu/qy/qyfuqyq6uoa7nktub3-f8xluxnc.jpeg"><br><br>  <i>Impl√©mentation de FSG Packer</i> <br><br>  √Ä ce stade, le fichier cible PE d√©compress√© est pr√™t pour une analyse plus approfondie.  Le reste du shellcode √©crasera le PE d'origine dans l'espace d'adressage avec la version d√©compress√©e et l'ex√©cutera correctement.  Il est int√©ressant de noter que dans le processus d'ajustement du point d'entr√©e d'un module charg√©, les structures sont manipul√©es en PEB.  La raison pour laquelle les attaquants ont d√©cid√© de transmettre le descripteur kernel32 √† partir de la logique de la premi√®re couche au lieu de le r√©cup√©rer √† l'aide des m√™mes structures PEB est inconnue. <br><br><img src="https://habrastorage.org/webt/0n/zr/zy/0nzrzyvv4vwyqzoc4rnnhz3trxu.jpeg"><br><br>  <i>√âcraser la valeur du point d'entr√©e du module charg√© dans PEB</i> <br><br><h2>  Conclusion </h2><br>  Ainsi, l'algorithme de d√©compression de la charge utile: <br><br><ul><li>  d√©codage de code shell √† l'aide de SUB-XOR-ROL7-XOR, </li><li>  remplir la structure ZOZ et appeler le shellcode, </li><li>  r√©duction de cinq √† trois de la charge utile, </li><li>  d√©codage de la charge utile √† l'aide de SUB-XOR-ROL7-XOR, </li><li>  packer de d√©compression FSG. </li></ul><br>  Au cours de l'√©volution des logiciels malveillants, la logique a chang√©: par exemple, le nombre de d√©calages cycliques de l'algorithme SUB-XOR-ROL7-XOR (sept dans le cas consid√©r√©) a chang√© de cinq, neuf, la version packer pour la plate-forme x64 a √©t√© publi√©e, etc. Le packer cybercriminel unique est excellent √©pigraphe aux narrations futures sur les outils et les caract√©ristiques du TA505. <br><br>  Dans les articles suivants, nous parlerons de la fa√ßon dont les outils TA505 se sont d√©velopp√©s et modifi√©s au cours des derni√®res attaques, de l'interaction des participants avec d'autres cyber-groupes, et nous √©tudierons les mod√®les de malwares pr√©c√©demment non examin√©s. <br><br>  <b>Auteurs</b> : Alexey Vishnyakov et Stanislav Rakovsky, Positive Technologies <br><br><h2>  CIO </h2><br>  <code>b635c11efdf4dc2119fa002f73a9df7b</code> - <code>b635c11efdf4dc2119fa002f73a9df7b</code> emball√© <code>b635c11efdf4dc2119fa002f73a9df7b</code> <br>  <code>71b183a44f755ca170fc2e29b05b64d5</code> - <code>71b183a44f755ca170fc2e29b05b64d5</code> d√©marrage non <code>71b183a44f755ca170fc2e29b05b64d5</code> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr469813/">https://habr.com/ru/post/fr469813/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr469803/index.html">Comment concevoir la le√ßon parfaite</a></li>
<li><a href="../fr469805/index.html">L'√©volution de la revue de sprint dans l'√©quipe Agile</a></li>
<li><a href="../fr469807/index.html">Oui, nous pouvons tout supprimer, non, nous ne lisons pas votre SMS</a></li>
<li><a href="../fr469809/index.html">C'est arriv√©! Lampes LED bon march√© avec CRI 90+</a></li>
<li><a href="../fr469811/index.html">Bonne police</a></li>
<li><a href="../fr469817/index.html">¬´Mauvaises herbes inqui√©tantes¬ª dans les batteries: les scientifiques de NUST ¬´MISiS¬ª ont test√© le panais de vache comme √©lectrode d'un supercondensateur</a></li>
<li><a href="../fr469827/index.html">Les gens sont terriblement illogiques: comportement irrationnel dans les march√©s publics</a></li>
<li><a href="../fr469829/index.html">Comment j'ai cr√©√© plus de 100 applications Open Source √† l'aide d'outils d'automatisation</a></li>
<li><a href="../fr469831/index.html">Dobroshrift</a></li>
<li><a href="../fr469835/index.html">R√™ves sovi√©tiques de l'avenir, partie 2. Maintenant avec Sepulki</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>