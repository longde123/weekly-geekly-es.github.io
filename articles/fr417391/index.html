<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏻‍✈️ 🔂 🍌 Extension Web multi-navigateur pour les scripts personnalisés Partie 4 🗝️ 🏞️ 🕉️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je complète une série de publications dans lesquelles je voulais parler de mon expérience dans l'écriture d'une extension web pour l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Extension Web multi-navigateur pour les scripts personnalisés Partie 4</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417391/"> Dans cet article, je complète une série de publications dans lesquelles je voulais parler de mon expérience dans l'écriture d'une extension web pour les navigateurs.  J'avais déjà de l'expérience dans la création d'une extension Web, qui a été installée par environ 100000 utilisateurs de Chrome, qui fonctionnait de manière autonome, mais dans cette série d'articles, j'ai décidé de me plonger dans le processus de développement de l'extension Web en l'intégrant étroitement avec le côté serveur. <br><br><img width="65" src="https://habrastorage.org/getpro/habr/post_images/188/09a/2d6/18809a2d60126c22c85f0dbb38c188dc.png" alt="image"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/474/b37/7c9/474b377c9fd5df452ee6b2ae849c2891.png" alt="image"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/804/cc0/c91/804cc0c91bd30f83537540bd6aca22df.png" alt="image"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/94e/097/462/94e097462cb7f3af3b482312f6fd2ee9.png" alt="image"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/4bf/d73/6f6/4bfd736f6830e4396071afedad261bfd.png" alt="image"><br><a name="habracut"></a><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 2</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 3</a> <br><br><h1>  Tâches planifiées </h1><br>  L'extension Web vous permet de configurer un script personnalisé pour exécuter automatiquement son code une fois le chargement de la page terminé.  Cela est pratique, par exemple, lorsque vous disposez d'une liste de pages du même type pour analyser et recevoir des données de l'exécution de script.  Ou si vous devez supprimer les publicités gênantes sur n'importe quelle page sur Internet, un code pour suivre vos actions sur une ressource Web, changer l'arrière-plan de la page en sombre, etc. <br><br>  Dans ce cas, il est souvent nécessaire de recevoir des données de la page en mode horaire quotidien.  Par exemple, si le site a des taux de change et qu'une demande directe par URL protège l'argument haché.  En tant que telle copie, vous pouvez consulter le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">site Web de la Banque centrale d'Europe</a> .  Dans ce cas, pour obtenir les taux de change actuels, vous devez connaître l'URL hachée pour obtenir les données correctes au format XML. <br><br>  À l'aide de l'extension Web, vous pouvez définir la fréquence requise pour recevoir des données via un script pour demander des taux de change.  L'extension Web accepte une chaîne au format des couronnes en entrée, par conséquent, pour obtenir des taux de change en mode quotidien, vous devez spécifier * * / 1 * * *. <br><br>  D'un point de vue technique, la partie serveur démarre Puppeteer avec l'ajout d'un script utilisateur à la page du navigateur Chromium.  Dans ce cas, nous sommes confrontés au problème de l'arrêt intentionnel du processus Chromium au fil du temps, car une augmentation du nombre de processus affectera négativement les performances globales du côté serveur.  Si vous prévoyez d'exécuter le script utilisateur en mode périodique pour résoudre le problème ci-dessus, vous devez envoyer une demande du script utilisateur à Puppeteer pour terminer le processus Chromium. <br><br>  Après de longs tests du processus d'implémentation du planificateur de tâches, il a été décidé de suivre la sortie de la console de script.  Ainsi, pour arrêter le processus Chromium, le script utilisateur doit avoir une commande pour arrêter le processus dans la section de code requise: <br><br><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'script is ended'</span></span>);</code> </pre> <br>  À l'aide de cette commande, un script utilisateur peut fermer le processus du serveur Chromium généré par Puppeteer.  Ceci est implémenté en suivant l'événement «console» de Puppeteer: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//initialize browser and page page.on('console', async msg =&gt; { for (let i = 0; i &lt; msg.args().length; ++i) { if(await msg.args()[i].jsonValue() == 'script is ended') { await browser.close(); } } });</span></span></code> </pre><br>  Si le script utilisateur ne dispose pas d'une telle commande, pour terminer le processus d'exécution en mode planificateur de tâches, vous devez forcer la minuterie à se terminer.  Ceci est implémenté de manière simple en utilisant setTimeout: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> timeLimitCron = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> timeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(browser) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.close(); } clearTimeout(timeout); }, timeLimitCron * <span class="hljs-number"><span class="hljs-number">1000</span></span> ); <span class="hljs-comment"><span class="hljs-comment">//time limit for cron, then forced closing, default 30 seconds</span></span></code> </pre><br>  Étant donné que le planificateur de tâches s'exécute côté serveur et que l'utilisateur doit souvent utiliser une adresse IP spécifique, une option d'utilisation d'un serveur proxy a été ajoutée. <br><br><img src="https://habrastorage.org/webt/s2/sb/ko/s2sbko8uyscf31aksmaulyn7hus.png"><br><br>  L'utilisateur peut également télécharger le dernier journal des messages à partir de la console Puppeteer.  Par exemple, il est pratique pour vérifier le bon fonctionnement du serveur proxy. <br><br><h1>  Raccourcis clavier </h1><br>  Au cours des tests et des tests sur le terrain, il s'est avéré que pour certains types de scripts, il est utile d'avoir des touches de raccourci pour leur exécution sur les ressources Web.  Un exemple d'un tel script est Redability.js.  Ce script crée une «vue claire» pour lire le contenu du site.  Autrement dit, la bibliothèque js analyse la structure de la page avec le contenu et vous permet d'obtenir avec une forte probabilité le titre, l'auteur et le contenu de la page.  Après cela, le script utilisateur peut remplacer le html de la ressource Web et permettre à l'utilisateur de lire en «forme pure», sans balisage inutile, publicité, etc. <br><br>  Initialement, l'exécution d'un script utilisateur n'était possible qu'à partir d'une extension Web contextuelle en cliquant sur le bouton «Exécuter».  Cette logique d'interaction avec l'interface est souvent justifiée par des considérations de sécurité.  Mais dans l'exemple ci-dessus, il ne vous permet pas d'amener facilement le contenu d'une ressource Web à une «forme pure». <br><br>  Comme décrit ci-dessus, l'extension Web vous permet de travailler avec le DOM via content.js, mais l'objet fenêtre ne peut pas être utilisé, par exemple, pour stocker des paramètres, car il ne s'agit pas d'un objet fenêtre d'un onglet ouvert.  Cette condition limite le fonctionnement de l'extension Web en tant qu'objet de suivi des frappes. <br><br>  Dans le problème à résoudre, il est nécessaire de transférer les touches de raccourci de l'interface d'extension Web vers le côté serveur pour le stockage.  Ensuite, chaque fois que vous chargez une page de ressources Web, obtenez une liste de «touches de raccourci» et chargez un script utilisateur après avoir cliqué sur la bonne combinaison.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hotkeys.js est</a> utilisé comme bibliothèque pour travailler avec des touches de raccourci. <br><br>  Après avoir reçu la liste des touches de raccourci du côté serveur, le code suivant est exécuté: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hotKeysMap = {<span class="hljs-attr"><span class="hljs-attr">keys</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">id</span></span>: []}; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data.response.data) { hotKeysMap.keys.push(data.response.data[i][<span class="hljs-string"><span class="hljs-string">'hotkeys'</span></span>]); hotKeysMap.id.push(data.response.data[i][<span class="hljs-string"><span class="hljs-string">"_id"</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(hotKeysMap.keys) { getScript(<span class="hljs-string"><span class="hljs-string">"hotkeys.js"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> script = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"script"</span></span>); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"class"</span></span>, <span class="hljs-string"><span class="hljs-string">"gCore-hotKeys"</span></span>); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"data-endpoint"</span></span>, event.data.endPoint); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"data-token"</span></span>, event.data.token); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"data-userid"</span></span>, event.data.userId); script.innerHTML = <span class="hljs-string"><span class="hljs-string">"GChotKeys = JSON.parse(\""</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(hotKeysMap).replace(<span class="hljs-regexp"><span class="hljs-regexp">/"/g</span></span>, <span class="hljs-string"><span class="hljs-string">"\\\""</span></span>) + <span class="hljs-string"><span class="hljs-string">"\");\n"</span></span> + <span class="hljs-string"><span class="hljs-string">"hotkeys(GChotKeys.keys.join(','), function(event, handler) {"</span></span> + <span class="hljs-string"><span class="hljs-string">" event.preventDefault();"</span></span> + <span class="hljs-string"><span class="hljs-string">" localStorage.setItem('runHotKeysScript', GChotKeys.id[GChotKeys.keys.indexOf(handler.key)]);"</span></span> + <span class="hljs-string"><span class="hljs-string">"});"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.body.appendChild(script); }); }</code> </pre> <br>  La fonction getScript génère du code html pour la balise de script et l'écrit sur la page de ressources Web.  Ainsi, nous avons sur chaque page la possibilité de suivre les frappes.  Nous devons également transmettre un tableau de raccourcis correspondant à l'ID du script à exécuter.  Ceci est implémenté en ajoutant du code html pour la balise de script, dont le contenu lance une variable globale pour stocker le tableau correspondant au format JSON. <br><br>  Il a déjà été mentionné ci-dessus qu'il y a un problème de communication entre la page ouverte de la ressource Web et le script d'extension de contenu extension.js de l'extension Web, qui est utilisé pour manipuler le DOM.  Dans ce cas, vous pouvez recourir à une technique simple pour vérifier la valeur dans localStorage, qui est un objet commun pour les deux points d'interaction mentionnés ci-dessus. <br><br>  Dans content.js, vous pouvez simplement vérifier la valeur localStorage une fois par seconde et effectuer les mêmes manipulations DOM que lorsque vous cliquez sur le bouton "Exécuter" dans l'extension web pop-up. <br><br><pre> <code class="javascript hljs">setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'runHotKeysScript'</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">// run user script localStorage.removeItem('runHotKeysScript'); } }, 1000);</span></span></code> </pre><br>  Ainsi, la technique des «touches de raccourci» est implémentée, ce qui vous permet de lancer rapidement des scripts utilisateur en utilisant la puissance de la bibliothèque interne pour résoudre des problèmes pratiques. <br><br><h1>  Conclusion </h1><br>  Au cours de la mise en œuvre de ce projet, les tâches pratiques d'écriture de l'intégration entre la partie serveur basée sur meteor.js et l'extension Web multi-navigateur ont été résolues.  Les principales pierres d'achoppement étaient SCP et les processus d'interaction entre les trois composants de la partie client - la page ouverte dans le navigateur, les scripts content.js et background.js. <br><br>  J'espère que mon expérience facilitera l'écriture d'extensions Web multi-navigateurs plus spécialisées. <br><br>  À l'avenir, il est prévu de localiser l'extension Web et d'écrire des scripts utiles à la communauté.  Si le lecteur a une idée ou souhaite aider à écrire de tels scripts utilisateur, veuillez alors écrire dans des messages privés. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr417391/">https://habr.com/ru/post/fr417391/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr417377/index.html">Pourquoi vous ne devriez pas utiliser Google Cloud</a></li>
<li><a href="../fr417379/index.html">Nouveau moteur-fusée à propergol solide pour Vega-C et Ariane 6</a></li>
<li><a href="../fr417383/index.html">JavaScript ES6: faiblesses</a></li>
<li><a href="../fr417385/index.html">Comment j'ai déménagé ... chez moi, ou ma réponse à l'auteur de l'article sur "la farine impitoyable"</a></li>
<li><a href="../fr417389/index.html">Effet d'objectif à décalage d'inclinaison</a></li>
<li><a href="../fr417393/index.html">Comment nous avons créé un système qui attribue des remises aux clients en fonction des caractéristiques individuelles</a></li>
<li><a href="../fr417395/index.html">Tests de bout en bout: quoi, pourquoi, pourquoi</a></li>
<li><a href="../fr417397/index.html">Quel langage de programmation apprendre en 2018 et pourquoi?</a></li>
<li><a href="../fr417399/index.html">Bienvenue à bord: présentation de nouveaux développeurs à l'équipe</a></li>
<li><a href="../fr417401/index.html">Enfin, nous choisissons un multimètre économique avec de bonnes fonctionnalités</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>