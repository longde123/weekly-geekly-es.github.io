<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë´ üöπ üê© Golang API Framework üßëüèΩ‚Äçü§ù‚ÄçüßëüèΩ üè∞ üî≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="W√§hrend ich Golang kennenlernte, beschloss ich, den Rahmen f√ºr die Anwendung festzulegen, mit dem ich in Zukunft bequem arbeiten kann. Das Ergebnis wa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Golang API Framework</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455302/"><p>  W√§hrend ich Golang kennenlernte, beschloss ich, den Rahmen f√ºr die Anwendung festzulegen, mit dem ich in Zukunft bequem arbeiten kann.  Das Ergebnis war meiner Meinung nach ein gutes Werkst√ºck, das ich teilen und gleichzeitig die Momente diskutieren wollte, die w√§hrend der Erstellung des Rahmens entstanden sind. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/599/73a/8a9/59973a8a925f690405c0f171fdd53048.jpg" alt="Bild"></p><br><p>  Im Prinzip deutet das Design der Go-Sprache darauf hin, dass keine umfangreichen Anwendungen erforderlich sind (ich meine das Fehlen von Generika und einen nicht sehr leistungsf√§higen Fehlerbehandlungsmechanismus).  Wir wissen jedoch immer noch, dass die Gr√∂√üe der Anwendungen normalerweise nicht abnimmt, sondern h√§ufiger im Gegenteil.  Daher ist es besser, sofort ein Framework zu erstellen, in dem neue Funktionen verkn√ºpft werden k√∂nnen, ohne die Codeunterst√ºtzung zu beeintr√§chtigen. </p><a name="habracut"></a><br><p>  Ich habe versucht, weniger Code in den Artikel einzuf√ºgen, stattdessen habe ich Links zu bestimmten Codezeilen auf Github hinzugef√ºgt, in der Hoffnung, dass es bequemer w√§re, das gesamte Bild zu sehen. </p><br><p>  Zuerst skizzierte ich einen Plan f√ºr das, was in der Anwendung enthalten sein sollte.  Da ich in dem Artikel √ºber jedes Element einzeln sprechen werde, werde ich zuerst das Hauptelement aus dieser Liste als Inhalt angeben. </p><br><ul><li>  W√§hlen Sie den Paketmanager </li><li> W√§hlen Sie ein Framework zum Erstellen einer API </li><li>  W√§hlen Sie das Werkzeug f√ºr die Abh√§ngigkeitsinjektion (DI). </li><li>  Webanforderungsrouten </li><li>  JSON / XML-Antworten gem√§√ü Anforderungsheadern </li><li>  ORM </li><li>  Migrationen </li><li>  Erstellen Sie Basisklassen f√ºr Modellebenen Service-&gt; Repository-&gt; Entit√§t </li><li>  Grundlegendes CRUD-Repository </li><li>  Grundlegender CRUD-Service </li><li>  Grundlegender CRUD-Controller </li><li>  Validierung anfordern </li><li>  Konfigurationen und Umgebungsvariablen </li><li>  Konsolenbefehle </li><li>  Protokollierung </li><li>  Logger-Integration mit Sentry oder einem anderen Warnsystem </li><li>  Alarm f√ºr Fehler einstellen </li><li>  Unit-Tests mit Neudefinition von Diensten durch DI </li><li>  Prozent- und Testabdeckungscode-Karte </li><li>  Prahlerei </li><li>  Docker komponieren </li></ul><br><h2 id="menedzher-paketov">  Paketmanager </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nachdem ich die</a> Beschreibungen f√ºr verschiedene Implementierungen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gelesen hatte</a> , entschied <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ich</a> mich f√ºr den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gouverneur</a> und war im Moment mit der Wahl zufrieden.  Der Grund ist einfach: Sie k√∂nnen Abh√§ngigkeiten mit der Anwendung im Verzeichnis installieren und Informationen zu Paketen und deren Versionen speichern. </p><br><p>  Informationen zu Paketen und ihren Versionen werden in einer vendor.json- <a href="">Datei gespeichert</a> .  Auch bei diesem Ansatz gibt es ein Minus.  Wenn Sie ein Paket mit seinen Abh√§ngigkeiten hinzuf√ºgen, werden neben Informationen zum Paket auch Informationen zu seinen Abh√§ngigkeiten in die Datei aufgenommen.  Die Datei w√§chst schnell und es ist nicht mehr m√∂glich, eindeutig zu bestimmen, welche Abh√§ngigkeiten die Hauptabh√§ngigkeiten und welche Ableitungen sind. </p><br><p>  In PHP Composer oder in npm werden die Hauptabh√§ngigkeiten in einer Datei beschrieben, und alle Haupt- und abgeleiteten Abh√§ngigkeiten und ihre Versionen werden automatisch in der Sperrdatei aufgezeichnet.  Dieser Ansatz ist meiner Meinung nach bequemer.  Aber f√ºr den Moment hat mir die Implementierung des Gouverneurs gereicht. </p><br><h2 id="freymvork">  Framework </h2><br><p>  Aus dem Framework brauche ich nicht viel, einen praktischen Router, die Validierung von Anfragen.  All dies wurde im beliebten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gin gefunden</a> .  Er blieb stehen. </p><br><h2 id="dependency-injection">  Abh√§ngigkeitsinjektion </h2><br><p>  Mit DI musste ich ein wenig leiden.  Zuerst w√§hlte Dig.  Und anfangs war alles super.  Beschriebene Dienste, Dig baut bequemerweise weitere Abh√§ngigkeiten auf.  Dann stellte sich jedoch heraus, dass Dienste beispielsweise beim Testen nicht neu definiert werden k√∂nnen.  Daher kam ich am Ende zu dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Schluss,</a> dass ich einen einfachen Servicebeh√§lter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">sarulabs / di genommen habe</a> . </p><br><p>  Ich musste es nur gabeln, weil es Ihnen sofort erlaubt, Dienste hinzuzuf√ºgen, und verbietet, sie neu zu definieren.  Und beim Schreiben von Autotests ist es meiner Meinung nach bequemer, den Container wie in der Anwendung zu initialisieren und dann einige der Dienste neu zu definieren und stattdessen Stubs anzugeben.  In Fork f√ºgte er eine Methode hinzu, um die Beschreibung des Dienstes zu √ºberschreiben. </p><br><p> Aber am Ende musste ich sowohl im Fall von Dig als auch im Fall des Service-Containers die Tests in ein separates Paket packen.  Andernfalls stellt sich heraus, dass die Tests separat in Paketen ausgef√ºhrt werden ( <code>go test model/service</code> ), aber aufgrund der auftretenden zyklischen Abh√§ngigkeiten nicht sofort f√ºr die gesamte Anwendung gestartet werden ( <code>go test ./...</code> ). </p><br><h2 id="otvety-v-formate-jsonxml-v-sootvetstvii-s-zagolovkami-zaprosa">  JSON / XML-Antworten gem√§√ü Anforderungsheadern </h2><br><p>  In Gin habe ich dies nicht gefunden, daher habe ich dem Basis-Controller eine <a href="">Methode</a> hinzugef√ºgt, die abh√§ngig vom Anforderungsheader eine Antwort generiert. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c BaseController)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context *gin.Context, obj </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{}, code </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> context.GetHeader(<span class="hljs-string"><span class="hljs-string">"Accept"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"application/xml"</span></span>: context.XML(code, obj) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: context.JSON(code, obj) } }</code> </pre><br><h2 id="orm">  ORM </h2><br><p>  Mit ORM f√ºhlte sich die lange Qual der Wahl nicht an.  Es gab viel zur Auswahl.  Aber gem√§√ü der Beschreibung der Funktionen mochte ich GORM, das zum Zeitpunkt der Auswahl eines der beliebtesten ist.  Das am h√§ufigsten verwendete DBMS wird unterst√ºtzt.  Zumindest PostgreSQL und MySQL sind definitiv da.  Es enth√§lt auch Methoden zum Verwalten des Basisschemas, die Sie beim Erstellen von Migrationen verwenden k√∂nnen. </p><br><h2 id="migracii">  Migrationen </h2><br><p>  F√ºr Migrationen habe ich mich f√ºr das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gorm-Goose-</a> Paket entschieden.  Ich habe ein separates Paket global abgelegt und die Migration dorthin gestartet.  Eine solche Implementierung war zun√§chst peinlich, da die Verbindung zur Datenbank in einer separaten <a href="">Datei db / dbconf.yml beschrieben werden musste</a> .  Dann stellte sich jedoch heraus, dass die darin enthaltene Verbindungszeichenfolge so beschrieben werden kann, dass der Wert der Umgebungsvariablen entnommen wird. </p><br><pre> <code class="plaintext hljs">development: driver: postgres open: $DB_URL</code> </pre> <br><p>  Und das ist ganz praktisch.  Zumindest mit Docker-Compose musste ich die <a href="">Verbindungszeichenfolge</a> nicht duplizieren. </p><br><p>  Gorm-Goose unterst√ºtzt auch Migrations-Rollbacks, was ich sehr n√ºtzlich finde. </p><br><h2 id="bazovyy-crud-repozitoriy">  Grundlegendes CRUD-Repository </h2><br><p>  Ich bevorzuge alles, was sich auf Ressourcen bezieht, in einer separaten Repository-Schicht zu platzieren.  Meiner Meinung nach ist bei diesem Ansatz der Gesch√§ftslogikcode sauberer.  In diesem Fall wei√ü der Gesch√§ftslogikcode nur, dass er mit den Daten arbeiten muss, die er aus dem Repository entnimmt.  Und was im Repository passiert, ist die Gesch√§ftslogik nicht wichtig.  Das Repository kann mit einer relationalen Datenbank, einem KV-Speicher, einer Festplatte oder m√∂glicherweise mit der API eines anderen Dienstes arbeiten.  Der Gesch√§ftslogikcode ist in all diesen F√§llen derselbe. </p><br><p>  Das CRUD-Repository implementiert die folgende <a href="">Schnittstelle</a> </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> CrudRepositoryInterface <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { BaseRepositoryInterface GetModel() (entity.InterfaceEntity) Find(id <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) (entity.InterfaceEntity, error) List(parameters ListParametersInterface) (entity.InterfaceEntity, error) Create(item entity.InterfaceEntity) entity.InterfaceEntity Update(item entity.InterfaceEntity) entity.InterfaceEntity Delete(id <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) error }</code> </pre> <br><p>  Das hei√üt, CRUD implementiert die <code>GetModel()</code> <code>Create()</code> , <code>Find()</code> , <code>List()</code> , <code>Update()</code> , <code>Delete()</code> und die Methode <code>GetModel()</code> . </p><br><p>  √úber <a href="">GetModel ()</a> .  Es gibt ein grundlegendes <code>CrudRepository</code> Repository, das grundlegende CRUD-Operationen implementiert.  In den Repositorys, in die es eingebettet ist, reicht es aus, anzugeben, mit welchem ‚Äã‚ÄãModell sie arbeiten sollen.  Dazu muss die <code>GetModel()</code> -Methode ein GORM-Modell zur√ºckgeben.  Dann mussten wir das Ergebnis von <code>GetModel()</code> Verwendung von Reflektion in CRUD-Methoden verwenden. </p><br><p>  <a href="">Zum Beispiel</a> </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c CrudRepository)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(entity.InterfaceEntity, error)</span></span></span></span> { item := reflect.New(reflect.TypeOf(c.GetModel()).Elem()).Interface() err := c.db.First(item, id).Error <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> item, err }</code> </pre> <br><p>  Das hei√üt, in diesem Fall war es notwendig, die statische Typisierung zugunsten der dynamischen Typisierung aufzugeben.  In solchen Momenten ist der Mangel an Generika in der Sprache besonders zu sp√ºren. </p><br><p>  Damit die Repositorys, die mit bestimmten Modellen arbeiten, ihre eigenen Regeln zum Filtern von Listen in der <code>List()</code> -Methode implementieren, habe ich zuerst die sp√§te Bindung implementiert, sodass die f√ºr die Erstellung der Auswahlabfrage verantwortliche Methode aus der <code>List()</code> -Methode aufgerufen wird.  Und diese Methode k√∂nnte in einem bestimmten Repository implementiert werden.  Es ist schwierig, die Denkmuster, die bei der Arbeit mit anderen Sprachen entstanden sind, irgendwie aufzugeben.  Aber als er dies mit einem frischen Blick betrachtete und die ‚ÄûEleganz‚Äú des gew√§hlten Pfades sch√§tzte, √ºberarbeitete er ihn zu einem Ansatz, der n√§her an Go liegt.  Dazu wird einfach in <code>CrudRepository</code> √ºber die Schnittstelle <a href="">ein Abfrage-Builder</a> deklariert, der bereits <a href=""><code>  List()</code></a> . </p><br><pre> <code class="go hljs">listQueryBuilder ListQueryBuilderInterface</code> </pre><br><p>  Es wird ziemlich lustig.  Die Beschr√§nkung der Sprache auf sp√§tes Binden, was zun√§chst als Fehler erscheint, f√∂rdert eine klarere Trennung des Codes. </p><br><h2 id="bazovyy-crud-servis">  Grundlegender CRUD-Service </h2><br><p>  Hier gibt es nichts Interessantes, da das Framework keine Gesch√§ftslogik enth√§lt.  Aufrufe von CRUD-Methoden an das Repository werden einfach <a href="">weitergeleitet</a> . </p><br><p>  In der Serviceschicht muss Gesch√§ftslogik implementiert werden. </p><br><h2 id="bazovyy-crud-kontroller">  Grundlegender CRUD-Controller </h2><br><p>  Der Controller implementiert <a href="">CRUD-Methoden</a> .  Sie verarbeiten die Parameter aus der Anforderung, die Steuerung wird an die entsprechende Dienstmethode √ºbertragen, und basierend auf der Antwort des Dienstes wird eine Antwort an den Client gebildet. </p><br><p>  Mit dem Controller hatte ich die gleiche Geschichte wie mit dem Repository in Bezug auf Filterlisten.  Infolgedessen habe ich die Implementierung mit hausgemachter <a href="">Sp√§tbindung √ºberarbeitet</a> und einen <a href="">Hydrator</a> hinzugef√ºgt, der basierend auf den Anforderungsparametern eine Struktur mit Parametern zum Filtern der Liste bildet. </p><br><p>  In dem mit dem CRUD-Controller gelieferten Hydrator werden nur die Paginierungsparameter verarbeitet.  In den spezifischen Reglern, in die der CRUD-Regler integriert ist, kann der <a href="">Hydrator</a> neu <a href="">definiert werden</a> . </p><br><h2 id="validaciya-zaprosov">  Validierung anfordern </h2><br><p>  Die Validierung wird von Gin durchgef√ºhrt.  Wenn Sie beispielsweise einen Datensatz hinzuf√ºgen ( <code>Create()</code> -Methode), reicht es aus, <a href="">die</a> Elemente der Entit√§tsstruktur zu <a href="">dekorieren</a> </p><br><pre> <code class="go hljs">Name <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`binding:"required"`</span></span></code> </pre> <br><p>  Die <a href=""><code>ShouldBindJSON()</code></a> -Methode des Frameworks √ºberpr√ºft die Anforderungsparameter auf √úbereinstimmung mit den im Dekorator beschriebenen Anforderungen. </p><br><h2 id="konfigi-i-peremennye-okruzheniya">  Konfigurationen und Umgebungsvariablen </h2><br><p>  Die Implementierung von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Viper</a> hat mir sehr gut gefallen, besonders in Verbindung mit Cobra. </p><br><p>  Lesen der Konfiguration, die ich <a href="">in main.go beschrieben habe.</a>  Grundlegende Parameter, die keine Geheimnisse enthalten, werden <a href="">in der Datei base.env beschrieben</a> .  Sie k√∂nnen sie in der .env-Datei √ºberschreiben, die zu .gitignore hinzugef√ºgt wird.  In .env k√∂nnen Sie geheime Werte f√ºr die Umgebung beschreiben. </p><br><p>  Umgebungsvariablen haben eine h√∂here Priorit√§t. </p><br><h2 id="konsolnye-komandy">  Konsolenbefehle </h2><br><p>  F√ºr die Beschreibung der Konsolenbefehle habe ich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Cobra gew√§hlt</a> .  Dann ist es gut, Cobra zusammen mit Viper zu verwenden.  Wir k√∂nnen <a href="">den Befehl beschreiben</a> </p><br><pre> <code class="go hljs">serverCmd.PersistentFlags().StringVar(&amp;serverPort, <span class="hljs-string"><span class="hljs-string">"port"</span></span>, defaultServerPort, <span class="hljs-string"><span class="hljs-string">"Server port"</span></span>)</code> </pre> <br><p>  <a href="">Binden Sie die Umgebungsvariable</a> an den Wert des Befehlsparameters </p><br><pre> <code class="go hljs">viper.BindPFlag(<span class="hljs-string"><span class="hljs-string">"SERVER_PORT"</span></span>, serverCmd.PersistentFlags().Lookup(<span class="hljs-string"><span class="hljs-string">"port"</span></span>))</code> </pre> <br><p>  Tats√§chlich ist die gesamte Anwendung dieses Frameworks eine Konsole.  Der Webserver wird mit einem der Serverkonsolenbefehle gestartet. </p><br><pre> <code class="bash hljs">gin -i run server</code> </pre> <br><h2 id="logirovanie">  Protokollierung </h2><br><p>  Ich habe das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">logrus-</a> Paket f√ºr die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Protokollierung ausgew√§hlt</a> , da es alles enth√§lt, was ich normalerweise ben√∂tige: Festlegen der Protokollierungsstufen, Protokollieren, Hinzuf√ºgen von Hooks, z. B. zum Senden von Protokollen an das Warnsystem. </p><br><h2 id="integraciya-loggera-s-sistemoy-alertinga">  Logger-Integration mit dem Warnsystem </h2><br><p>  Ich habe mich f√ºr Sentry entschieden, weil sich dank der einfachen Integration in logrus: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">logrus_sentry</a> alles als recht einfach <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">herausstellte</a> .  Ich habe die <a href="">Parameter</a> mit der URL zu Sentry <code>SENTRY_DSN</code> und dem Timeout f√ºr das Senden an Sentry <code>SENTRY_TIMEOUT</code> .  Es stellte sich heraus, dass das Zeitlimit standardm√§√üig klein ist, wenn nicht falsch, 300 ms, und viele Nachrichten nicht zugestellt wurden. </p><br><h2 id="nastroyka-alertinga-dlya-oshibok">  Alarm f√ºr Fehler einstellen </h2><br><p>  Ich habe die Panikverarbeitung separat f√ºr den <a href="">Webserver</a> und f√ºr <a href="">Konsolenbefehle durchgef√ºhrt</a> . </p><br><h2 id="yunit-testy-s-pereopredeleniem-servisov-cherez-di">  Unit-Tests mit Neudefinition von Diensten durch DI </h2><br><p>  Wie oben erw√§hnt, musste f√ºr Unit-Tests ein separates Paket zugewiesen werden.  Da die ausgew√§hlte Bibliothek zum Erstellen eines Dienstcontainers keine Neudefinition von Diensten zulie√ü, wurde in fork eine Methode zum Neudefinieren der Beschreibung von Diensten hinzugef√ºgt.  Aus diesem Grund k√∂nnen Sie im <a href="">Komponententest</a> dieselbe Beschreibung der Dienste wie in der Anwendung verwenden </p><br><pre> <code class="go hljs">dic.InitBuilder()</code> </pre> <br><p>  Und <a href="">definieren Sie</a> auf diese Weise nur einige Servicebeschreibungen in Stubs neu </p><br><pre> <code class="go hljs">dic.Builder.Set(di.Def{ Name: dic.UserRepository, Build: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctn di.Container)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{}, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NewUserRepositoryMock(), <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }, })</code> </pre> <br><p>  Als N√§chstes k√∂nnen Sie <a href="">einen Container erstellen</a> und die erforderlichen Dienste im Test verwenden: </p><br><pre> <code class="go hljs">dic.Container = dic.Builder.Build() userService := dic.Container.Get(dic.UserService).(service.UserServiceInterface)</code> </pre> <br><p>  Daher werden wir userService testen, der anstelle des realen Repositorys den bereitgestellten Stub verwendet. </p><br><p>  Prozent- und Testabdeckungscode-Karte <br>  Ich war mit dem Standard-Go-Test-Dienstprogramm v√∂llig zufrieden. </p><br><p>  Sie k√∂nnen Tests einzeln ausf√ºhren </p><br><pre> <code class="bash hljs">go <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/unit/user_service_test.go -v</code> </pre> <br><p>  Sie k√∂nnen alle Tests gleichzeitig ausf√ºhren </p><br><pre> <code class="bash hljs">go <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> ./... -v</code> </pre> <br><p>  Sie k√∂nnen eine Abdeckungskarte erstellen und den Prozentsatz der Abdeckung berechnen </p><br><pre> <code class="bash hljs">go <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> ./... -v -coverpkg=./... -coverprofile=coverage.out</code> </pre> <br><p>  Und sehen Sie sich eine Karte der Codeabdeckung mit Tests in einem Browser an </p><br><pre> <code class="bash hljs">go tool cover -html=coverage.out</code> </pre> <br><h2 id="swagger">  Prahlerei </h2><br><p>  F√ºr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gin</a> gibt es ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gin-Swagger-</a> Projekt, mit dem sowohl Spezifikationen f√ºr Swagger als auch darauf basierende Dokumentationen erstellt werden k√∂nnen.  Wie sich herausstellte, m√ºssen jedoch Kommentare zu bestimmten Funktionen der Steuerung angegeben werden, um Spezifikationen f√ºr bestimmte Vorg√§nge zu generieren.  Dies stellte sich f√ºr mich als nicht sehr praktisch heraus, da ich den CRUD-Operationscode nicht in jedem Controller duplizieren wollte.  Stattdessen bettete ich in bestimmten Controllern einfach einen CRUD-Controller wie oben beschrieben ein.  Ich wollte auch daf√ºr keine Stub-Funktionen erstellen. </p><br><p>  Daher bin ich zu dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Schluss gekommen,</a> dass die Spezifikation mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">goswagger</a> generiert <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wird</a> , da in diesem Fall die Operationen <a href="">beschrieben werden k√∂nnen, ohne an bestimmte Funktionen gebunden zu sein</a> . </p><br><pre> <code class="bash hljs">swagger generate spec -o doc/swagger.yml</code> </pre> <br><p>  √úbrigens, mit goswagger k√∂nnen Sie sogar vom Gegenteil ausgehen und den Webserver-Code basierend auf der Swagger-Spezifikation generieren.  Bei diesem Ansatz gab es jedoch Schwierigkeiten bei der Verwendung von ORM, und ich gab es schlie√ülich auf. </p><br><p>  Die Dokumentation wird mit Gin-Swagger erstellt. Hierzu wird eine vorgenerierte Spezifikationsdatei <a href="">angezeigt</a> . </p><br><h2 id="docker-compose">  Docker komponieren </h2><br><p>  Im Framework habe ich eine Beschreibung von zwei Containern hinzugef√ºgt - <a href="">f√ºr den Code und f√ºr die Basis</a> .  Zu Beginn des Containers mit dem Code warten wir, bis der Container mit der Basis vollst√§ndig gestartet ist.  Und bei jedem Start rollen wir bei Bedarf Migrationen.  Die Parameter f√ºr die Verbindung zur Datenbank f√ºr Migrationen sind, wie oben erw√§hnt, in <a href="">dbconf.yml beschrieben</a> , wo die <a href="">Umgebungsvariable</a> zum √úbertragen der Einstellungen f√ºr die Verbindung zur Datenbank verwendet werden konnte. </p><br><p>  Vielen Dank f√ºr Ihre Aufmerksamkeit.  Dabei musste ich mich an die Merkmale der Sprache anpassen.  Es w√ºrde mich interessieren, die Meinung von Kollegen zu erfahren, die mehr Zeit mit Go verbracht haben.  Sicherlich k√∂nnten einige Momente eleganter gestaltet werden, daher freue ich mich √ºber n√ºtzliche Kritik.  Link zum Frame: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/zubroide/go-api-boilerplate</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de455302/">https://habr.com/ru/post/de455302/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de455284/index.html">Alexey Savvateev und die Spieltheorie: "Wie hoch ist die Wahrscheinlichkeit, dass eine Atombombe in den n√§chsten f√ºnf Jahren abgeworfen wird?"</a></li>
<li><a href="../de455286/index.html">Z√§hne der Weisheit: k√∂nnen nicht entfernt werden</a></li>
<li><a href="../de455288/index.html">Nachrichten der Woche: Werbeblocker f√ºr Unternehmen mit Chrome-, FSB- und Yandex-Verschl√ºsselungsschl√ºsseln, Kommunikation wird immer teurer</a></li>
<li><a href="../de455290/index.html">Der vollst√§ndige Leitfaden zu Prometheus im Jahr 2019</a></li>
<li><a href="../de455292/index.html">So erh√∂hen Sie die Laufzeit von Ger√§ten mit eigener Stromversorgung um das Vierfache</a></li>
<li><a href="../de455306/index.html">Antworten auf Ihre Fragen, warum Sie einen Verlag ben√∂tigen, um ein Buch zu ver√∂ffentlichen</a></li>
<li><a href="../de455308/index.html">Vielversprechender Ort</a></li>
<li><a href="../de455310/index.html">Angriffe auf Bypass-Kan√§le: Jetzt werden nicht nur PCs, sondern auch Smartphones angegriffen (analytische √úberpr√ºfung)</a></li>
<li><a href="../de455312/index.html">Ein-Bit-Volladdierer auf ungew√∂hnlichen Chips</a></li>
<li><a href="../de455316/index.html">Wir modifizieren den Bluetooth-Stack, um den Klang von Kopfh√∂rern ohne Codecs AAC, aptX und LDAC zu verbessern</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>