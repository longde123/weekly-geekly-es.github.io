<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õëÔ∏è üèûÔ∏è üõ´ Mais uma vez sobre o ImmutableList em Java üë©üèΩ‚Äçüé§ ‚öîÔ∏è üïµüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No meu artigo anterior, ‚Äú Cloaking around ImmutableList in Java ‚Äù, propus uma solu√ß√£o para o problema da aus√™ncia de listas imut√°veis ‚Äã‚Äãem Java, que n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mais uma vez sobre o ImmutableList em Java</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471344/"><p>  No meu artigo anterior, ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Cloaking around ImmutableList in Java</a> ‚Äù, propus uma solu√ß√£o para o problema da aus√™ncia de listas imut√°veis ‚Äã‚Äãem Java, que n√£o √© corrigido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">, nem agora nem nunca</a> , em Java. </p><br><p>  A solu√ß√£o foi elaborada apenas no n√≠vel de ‚Äúexiste uma ideia‚Äù e a implementa√ß√£o no c√≥digo foi torta; portanto, tudo foi percebido um pouco c√©tico.  Neste artigo, proponho uma solu√ß√£o modificada.  A l√≥gica de uso e a API s√£o trazidas para um n√≠vel aceit√°vel.  A implementa√ß√£o no c√≥digo est√° no n√≠vel beta. </p><a name="habracut"></a><br><h2 id="postanovka-zadachi">  Declara√ß√£o do problema </h2><br><p> Usaremos as defini√ß√µes do artigo original.  Em particular, isso significa que <code>ImmutableList</code> √© uma lista imut√°vel de refer√™ncias a alguns objetos.  Se esses objetos n√£o forem imut√°veis, a lista tamb√©m n√£o ser√° um objeto imut√°vel, apesar do nome.  Na pr√°tica, √© improv√°vel que isso prejudique algu√©m, mas, para evitar expectativas injustificadas, √© necess√°rio mencionar. </p><br><p>  Tamb√©m est√° claro que a imutabilidade da lista pode ser "hackeada" por meio de reflex√µes ou criando suas pr√≥prias classes no mesmo pacote, seguido de subir nos campos protegidos da lista, ou algo semelhante. </p><br><p>  Ao contr√°rio do artigo original, n√£o vamos aderir ao princ√≠pio de "tudo ou nada": o autor parece acreditar que se o problema n√£o puder ser resolvido no n√≠vel do JDK, nada dever√° ser feito.  (Na verdade, h√° outra pergunta: "n√£o pode ser resolvida" ou "os autores de Java n√£o desejavam resolv√™-la". Parece-me que ainda seria poss√≠vel adicionando interfaces, classes e m√©todos adicionais para aproximar as cole√ß√µes existentes. apar√™ncia desejada, embora menos bonita do que se voc√™ tivesse pensado nisso imediatamente, mas agora n√£o √© sobre isso.) </p><br><p>  Criaremos uma biblioteca que pode coexistir com sucesso com cole√ß√µes existentes em Java. </p><br><p>  As principais id√©ias da biblioteca: </p><br><ul><li>  Existem <code>MutableList</code> <code>ImmutableList</code> e <code>MutableList</code> .  Ao transmitir tipos, √© imposs√≠vel obter um do outro. </li><li>  Em nosso projeto, que queremos melhorar usando a biblioteca, substitu√≠mos todas as <code>List</code> s por uma dessas duas interfaces.  Se em algum momento voc√™ n√£o puder ficar sem a <code>List</code> , na primeira oportunidade, converteremos a <code>List</code> de / para uma das duas interfaces.  O mesmo se aplica aos momentos de recebimento / transmiss√£o de dados para bibliotecas de terceiros usando a <code>List</code> . </li><li>  Convers√µes m√∫tuas entre <code>ImmutableList</code> , <code>MutableList</code> , <code>List</code> devem ser executadas o mais r√°pido poss√≠vel (ou seja, sem copiar listas, se poss√≠vel).  Sem convers√µes de ida e volta "baratas", toda a id√©ia come√ßa a parecer duvidosa. </li></ul><br><p>  Note-se que apenas as listas s√£o consideradas, pois no momento somente elas s√£o implementadas na biblioteca.  Mas nada impede que a biblioteca complemente com <code>Set</code> e <code>Map</code> s. </p><br><h2 id="api">  API </h2><br><h3 id="immutablelist">  ImmutableList </h3><br><p>  <code>ImmutableList</code> √© o sucessor de <code>ReadOnlyList</code> (que, como no artigo anterior, √© uma interface de <code>List</code> copiada da qual todos os m√©todos de muta√ß√£o s√£o lan√ßados).  M√©todos adicionados: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">List&lt;E&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">MutableList&lt;E&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mutable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">contentEquals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Iterable&lt;? extends E&gt; iterable)</span></span></span></span>;</code> </pre> <br><p>  O m√©todo <code>toList</code> fornece a capacidade de transmitir um <code>ImmutableList</code> para partes de c√≥digo que aguardam uma <code>List</code> .  Um wrapper √© retornado no qual todos os m√©todos de modifica√ß√£o retornam <code>UnsupportedOperationException</code> e os m√©todos restantes s√£o redirecionados para o <code>ImmutableList</code> original. </p><br><p>  O m√©todo <code>mutable</code> converte um <code>ImmutableList</code> em um <code>MutableList</code> .  Um wrapper √© retornado no qual todos os m√©todos s√£o redirecionados para o <code>ImmutableList</code> original at√© a primeira altera√ß√£o.  Antes da altera√ß√£o, o wrapper √© desatado do <code>ImmutableList</code> original, copiando seu conte√∫do para o <code>ArrayList</code> interno, para o qual todas as opera√ß√µes s√£o redirecionadas. </p><br><p>  O m√©todo <code>contentEquals</code> destina-se a comparar o conte√∫do da lista com o conte√∫do de uma <code>Iterable</code> arbitr√°ria passada (√© claro, essa opera√ß√£o √© significativa apenas para as implementa√ß√µes <code>Iterable</code> que possuem uma ordem distinta de elementos). </p><br><p>  Observe que em nossa implementa√ß√£o do <code>ReadOnlyList</code> , os <code>listIterator</code> <code>iterator</code> e <code>listIterator</code> retornam o padr√£o <code>java.util.Iterator</code> / <code>java.util.ListIterator</code> .  Esses iteradores cont√™m m√©todos de modifica√ß√£o que precisar√£o ser suprimidos lan√ßando uma <code>UnsupportedOperationException</code> .  Seria prefer√≠vel criar nosso <code>ReadOnlyIterator</code> , mas nesse caso n√£o pudemos escrever <code>for (Object item : immutableList)</code> , o que estragaria imediatamente todo o prazer de usar a biblioteca. </p><br><h3 id="mutablelist">  MutableList </h3><br><p>  <code>MutableList</code> √© o descendente da <code>List</code> regular.  M√©todos adicionados: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">ImmutableList&lt;E&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">snapshot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">releaseSnapshot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">contentEquals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Iterable&lt;? extends E&gt; iterable)</span></span></span></span>;</code> </pre> <br><p>  O m√©todo de <code>snapshot</code> foi projetado para obter um "instant√¢neo" do estado atual de <code>MutableList</code> como um <code>ImmutableList</code> .  O "instant√¢neo" √© salvo dentro do <code>MutableList</code> e, se o estado n√£o tiver sido alterado no momento da pr√≥xima chamada de m√©todo, a mesma inst√¢ncia do <code>ImmutableList</code> .  O "instant√¢neo" armazenado dentro √© descartado na primeira vez que qualquer m√©todo de modifica√ß√£o √© chamado ou quando <code>releaseSnapshot</code> chamado.  O m√©todo <code>releaseSnapshot</code> pode ser usado para economizar mem√≥ria, se voc√™ tiver certeza de que ningu√©m precisar√° de um "instant√¢neo", mas os m√©todos de modifica√ß√£o n√£o ser√£o chamados em breve. </p><br><h3 id="mutabor">  Mutabor </h3><br><p>  A classe <code>Mutabor</code> fornece um conjunto de m√©todos est√°ticos que s√£o os "pontos de entrada" para a biblioteca. </p><br><p>  Sim, o projeto agora √© chamado de "mutabor" (√© consoante com "mut√°vel", e na tradu√ß√£o significa "eu vou transformar", o que est√° de acordo com a id√©ia de "transformar" rapidamente alguns tipos de cole√ß√µes em outros). </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;E&gt; <span class="hljs-function"><span class="hljs-function">ImmutableList&lt;E&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyToImmutableList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(E[] original)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;E&gt; <span class="hljs-function"><span class="hljs-function">ImmutableList&lt;E&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyToImmutableList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;? extends E&gt; original)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;E&gt; <span class="hljs-function"><span class="hljs-function">ImmutableList&lt;E&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertToImmutableList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;? extends E&gt; original)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;E&gt; <span class="hljs-function"><span class="hljs-function">MutableList&lt;E&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyToMutableList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;? extends E&gt; original)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;E&gt; <span class="hljs-function"><span class="hljs-function">MutableList&lt;E&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertToMutableList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;E&gt; original)</span></span></span></span>;</code> </pre> <br><p>  <code>copyTo*</code> m√©todos <code>copyTo*</code> projetados para criar cole√ß√µes apropriadas, copiando os dados fornecidos.  Os m√©todos <code>convertTo*</code> uma convers√£o r√°pida da cole√ß√£o transferida para o tipo desejado e, se n√£o foi poss√≠vel converter rapidamente, eles executam c√≥pias lentas.  Se a convers√£o r√°pida foi bem-sucedida, a cole√ß√£o original √© limpa e sup√µe-se que ela n√£o ser√° usada no futuro (embora possa, mas isso dificilmente faz sentido). </p><br><p>  As chamadas para os construtores dos <code>ImmutableList</code> implementa√ß√£o <code>ImmutableList</code> / <code>MutableList</code> ocultas.  Sup√µe-se que o usu√°rio lide apenas com interfaces, ele n√£o cria esses objetos e usa os m√©todos descritos acima para transformar cole√ß√µes. </p><br><h2 id="detali-realizacii">  Detalhes da implementa√ß√£o </h2><br><h3 id="immutablelistimpl">  ImmutableListImpl </h3><br><p>  Encapsula uma matriz de objetos.  A implementa√ß√£o corresponde aproximadamente √† implementa√ß√£o <code>ArrayList</code> , da qual todos os m√©todos de modifica√ß√£o e verifica√ß√µes de modifica√ß√£o simult√¢nea s√£o lan√ßados. </p><br><p>  A implementa√ß√£o dos <code>contentEquals</code> <code>toList</code> e <code>contentEquals</code> tamb√©m <code>contentEquals</code> bastante trivial.  O m√©todo <code>toList</code> retorna um wrapper que redireciona as chamadas para um determinado <code>ImmutableList</code> ; a c√≥pia lenta dos dados n√£o ocorre. </p><br><p>  O m√©todo <code>mutable</code> retorna um <code>MutableListImpl</code> criado com base neste <code>ImmutableList</code> .  A c√≥pia de dados n√£o ocorre at√© que qualquer m√©todo de modifica√ß√£o seja chamado no <code>MutableList</code> recebido. </p><br><h3 id="mutablelistimpl">  MutableListImpl </h3><br><p>  Encapsula links para <code>ImmutableList</code> e <code>List</code> .  Ao criar um objeto, apenas um desses dois links √© sempre preenchido, o outro permanece <code>null</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ImmutableList&lt;E&gt; immutable; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;E&gt; list;</code> </pre> <br><p>  Os m√©todos imut√°veis ‚Äã‚Äãredirecionam as chamadas para <code>ImmutableList</code> se n√£o for <code>null</code> , e para <code>List</code> caso contr√°rio. </p><br><p>  Os m√©todos de modifica√ß√£o redirecionam as chamadas para a <code>List</code> , ap√≥s a inicializa√ß√£o: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (list == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(immutable.toList()); } immutable = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre> <br><p>  O m√©todo de <code>snapshot</code> fica assim: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ImmutableList&lt;E&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">snapshot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (immutable != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> immutable; } immutable = InternalUtils.convertToImmutableList(list); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (immutable != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//    //   ,  . //     immutable     . list = null; return immutable; } immutable = InternalUtils.copyToImmutableList(list); return immutable; }</span></span></code> </pre> <br><p>  A implementa√ß√£o dos <code>contentEquals</code> <code>releaseSnapshot</code> e <code>contentEquals</code> trivial. </p><br><p>  Essa abordagem permite minimizar o n√∫mero de c√≥pias de dados durante o uso "comum", substituindo as c√≥pias por convers√µes r√°pidas. </p><br><h3 id="bystroe-preobrazovanie-spiskov">  Convers√£o r√°pida de lista </h3><br><p>  Convers√µes r√°pidas s√£o poss√≠veis para as classes <code>ArrayList</code> ou <code>Arrays$ArrayList</code> (o resultado do m√©todo <code>Arrays.asList()</code> ).  Na pr√°tica, na grande maioria dos casos, s√£o precisamente essas classes que se deparam. </p><br><p>  Dentro dessas classes, h√° uma matriz de elementos.  A ess√™ncia de uma convers√£o r√°pida √© obter uma refer√™ncia a essa matriz por meio de reflex√µes (este √© um campo privado) e substitu√≠-la por uma refer√™ncia a uma matriz vazia.  Isso garante que a √∫nica refer√™ncia √† matriz permane√ßa com o nosso objeto, e a matriz permane√ßa inalterada. </p><br><p>  Na vers√£o anterior da biblioteca, convers√µes r√°pidas de tipos de cole√ß√£o eram realizadas chamando o construtor.  Ao mesmo tempo, o objeto de cole√ß√£o original se deteriorou (tornou-se inadequado para uso posterior), o que voc√™ n√£o espera inconscientemente do designer.  Agora, um m√©todo est√°tico especial √© usado para a convers√£o, e a cole√ß√£o original n√£o estraga, mas √© simplesmente limpa.  Assim, um comportamento incomum assustador foi eliminado. </p><br><h3 id="problemy-s-equals--hashcode">  Problemas com equals / hashCode </h3><br><p>  As cole√ß√µes Java usam uma abordagem muito estranha para implementar m√©todos <code>equals</code> e <code>hashCode</code> . </p><br><p>  A compara√ß√£o √© realizada de acordo com o conte√∫do, que parece l√≥gico, mas a classe da lista em si n√£o √© levada em considera√ß√£o.  Portanto, por exemplo, <code>ArrayList</code> e <code>LinkedList</code> com o mesmo conte√∫do ser√£o <code>equals</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Aqui est√° a implementa√ß√£o equals / hashCode de AbstractList (da qual ArrayList √© herdada)</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o == <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(o <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> List)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; ListIterator&lt;E&gt; e1 = listIterator(); ListIterator e2 = ((List) o).listIterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (e1.hasNext() &amp;&amp; e2.hasNext()) { E o1 = e1.next(); Object o2 = e2.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(o1==<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? o2==<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : o1.equals(o2))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !(e1.hasNext() || e2.hasNext()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> hashCode = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (E e : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) hashCode = <span class="hljs-number"><span class="hljs-number">31</span></span>*hashCode + (e==<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-number"><span class="hljs-number">0</span></span> : e.hashCode()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hashCode; }</code> </pre> </div></div><br><p>  Portanto, agora √© absolutamente necess√°rio que todas as implementa√ß√µes da <code>List</code> tenham uma implementa√ß√£o <code>equals</code> (e, como resultado, <code>hashCode</code> ).  Caso contr√°rio, voc√™ poder√° obter situa√ß√µes em que <code>a.equals(b) &amp;&amp; !b.equals(a)</code> , o que n√£o √© bom.  Uma situa√ß√£o semelhante √© com <code>Set</code> e <code>Map</code> . </p><br><p>  Quando aplicado √† biblioteca, isso significa que a implementa√ß√£o de <code>equals</code> e <code>hashCode</code> para <code>MutableList</code> predefinida e, em tal implementa√ß√£o, <code>ImmutableList</code> e <code>MutableList</code> com o mesmo conte√∫do n√£o podem ser <code>equals</code> (j√° que <code>ImmutableList</code> n√£o <code>ImmutableList</code> uma <code>List</code> ).  Portanto, os m√©todos <code>contentEquals</code> foram adicionados para comparar o conte√∫do. </p><br><p>  A implementa√ß√£o dos m√©todos <code>equals</code> e <code>hashCode</code> para <code>ImmutableList</code> feita completamente semelhante √† vers√£o de <code>AbstractList</code> , mas com a substitui√ß√£o de <code>List</code> por <code>ReadOnlyList</code> . </p><br><h2 id="itogo">  Total </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">As fontes e os testes da biblioteca s√£o postados por refer√™ncia</a> na forma de um projeto maven. </p><br><p>  Caso algu√©m queira usar a biblioteca, ele criou um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">grupo em contato</a> para receber "feedback". </p><br><p>  O uso da biblioteca √© bastante √≥bvio, aqui est√° um pequeno exemplo: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myBusinessProcess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ List&lt;Entity&gt; tempFromDb = queryEntitiesFromDatabase(<span class="hljs-string"><span class="hljs-string">"SELECT * FROM my_table"</span></span>); ImmutableList&lt;Entity&gt; fromDb = Mutabor.convertToImmutableList(tempFromDb); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fromDb.isEmpty() || !someChecksPassed(fromDb)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//... MutableList&lt;Entity&gt; list = fromDb.mutable(); //time to change list.remove(1); ImmutableList&lt;Entity&gt; processed = list.snapshot(); //time to change ended //... if (!callSideLibraryExpectsListParameter(processed.toList())) { return false; } for (Entity entity : processed) { outputToUI(entity); } return true; }</span></span></code> </pre> <br><p>  Boa sorte a todos!  Envie relat√≥rios de erros! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt471344/">https://habr.com/ru/post/pt471344/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt471332/index.html">Hist√≥rias do computador lunar. Parte 3</a></li>
<li><a href="../pt471334/index.html">Para memorizar, mas n√£o para empinar - aprendendo ‚Äúpor cart√µes‚Äù</a></li>
<li><a href="../pt471336/index.html">Holivar. Hist√≥ria do Runet. Parte 6. Fechaduras: Lurk, Tape, 282nd e caminho chin√™s</a></li>
<li><a href="../pt471340/index.html">Drimsim vs Mate 20 Pro Round! Mas para quem?</a></li>
<li><a href="../pt471342/index.html">Stylish Avalonia</a></li>
<li><a href="../pt471348/index.html">Aplicativos TypeScript de pilha completa</a></li>
<li><a href="../pt471350/index.html">Engenharia reversa de amplificadores operacionais de baixo ru√≠do de um computador anal√≥gico em 1969</a></li>
<li><a href="../pt471352/index.html">Escrevendo apresenta√ß√µes no LaTeX</a></li>
<li><a href="../pt471358/index.html">Como escrever um contrato inteligente com Python ontologia? Parte 4: API nativa</a></li>
<li><a href="../pt471360/index.html">M√©todo de duplica√ß√£o. 11 exemplos do design do ICE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>